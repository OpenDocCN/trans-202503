- en: '[3](nsp-enoka501485-0007.xhtml#rch03)'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '[3](nsp-enoka501485-0007.xhtml#rch03)'
- en: Filtering Network Traffic with Firewalls
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用防火墙过滤网络流量
- en: '![Chapter opening icon](images/nsp-enoka501485-ct.jpg)'
  id: totrans-2
  prefs: []
  type: TYPE_IMG
  zh: '![章节开头图标](images/nsp-enoka501485-ct.jpg)'
- en: A *firewall* monitors and filters incoming and outgoing network traffic. There’s
    a general misconception that the firewall is always the last line of defense;
    in reality, a perimeter firewall should be the first obstacle adversaries encounter
    when they try to penetrate any network, large or small. Every time a web browser
    accesses a website, a messaging program sends a message, or your email client
    sends and receives email, the traffic generated should pass through at least one
    firewall along its journey.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: '*防火墙*监控并过滤进出网络的流量。人们常常误以为防火墙总是最后一道防线；实际上，边界防火墙应当是攻击者试图突破任何网络时首先遇到的障碍，不论该网络大小。每当网页浏览器访问网站、消息程序发送信息或你的电子邮件客户端发送和接收邮件时，生成的流量应至少通过一个防火墙。'
- en: 'In this chapter, you’ll explore two firewall solutions: iptables and pfSense.
    In Linux, iptables is a common firewall often used as a *host firewall* (that
    is, a firewall that allows or denies traffic on a specific endpoint). pfSense,
    which can be implemented either as an open source software firewall or as a hardware
    firewall using the appliances sold by Netgate, is used as a perimeter or boundary
    firewall responsible for filtering traffic for entire networks or network segments.'
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将介绍两种防火墙解决方案：iptables和pfSense。在Linux中，iptables是一种常见的防火墙，通常用作*主机防火墙*（即，允许或拒绝特定端点上的流量的防火墙）。pfSense可以作为开源软件防火墙或通过Netgate销售的设备作为硬件防火墙来实施，用作边界防火墙，负责过滤整个网络或网络段的流量。
- en: '[Types of Firewalls](nsp-enoka501485-0007.xhtml#rah0501)'
  id: totrans-5
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: '[防火墙类型](nsp-enoka501485-0007.xhtml#rah0501)'
- en: A *hardware firewall* can be physically and logically placed in a network. A
    *software firewall*, installed as an application on an endpoint, requires more
    configuration of both the firewall and its connected devices to filter traffic
    effectively. By using one or both of these, you’re able to effectively reduce
    your *attack surface*, which comprises the points where an adversary can try to
    infiltrate, compromise, or exploit your network. Ideally, attack surfaces should
    be as small as possible.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: '*硬件防火墙*可以在网络中物理和逻辑地放置。*软件防火墙*作为应用程序安装在终端上，需要对防火墙及其连接的设备进行更多配置，以有效地过滤流量。通过使用这两者中的一个或两个，你可以有效地减少你的*攻击面*，即攻击者可以尝试渗透、危害或利用你的网络的点。理想情况下，攻击面应该尽可能小。'
- en: A *perimeter firewall*, installed between your private network and other networks
    like the internet, can be either software- or hardware-based. Perimeter firewalls
    are placed at the physical and logical border of the network, making it the first
    thing with which traffic bound for your internal network from the public internet
    communicates, as well as the last thing in your network that traffic bound for
    the internet passes through, as shown in [Figure 3-1](nsp-enoka501485-0012.xhtml#fig0301).
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: '*边界防火墙*安装在你的私人网络与其他网络（如互联网）之间，可以是软件或硬件基础的。边界防火墙被放置在网络的物理和逻辑边界上，使其成为面向公众互联网时，进出你内部网络的流量的第一个接触点，也是出发到互联网的流量在网络中最后通过的设备，如[图3-1](nsp-enoka501485-0012.xhtml#fig0301)所示。'
- en: '![A perimeter firewall is placed in between the Laptop and the Internet.](images/nsp-enoka501485-fig0301.jpg)'
  id: totrans-8
  prefs: []
  type: TYPE_IMG
  zh: '![边界防火墙位于笔记本和互联网之间。](images/nsp-enoka501485-fig0301.jpg)'
- en: 'Figure 3-1: A perimeter firewall'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 图3-1：边界防火墙
- en: Firewalls allow or deny (block) traffic based on a *ruleset* containing a configured
    list of rules. The way those rules are applied to traffic depends on the type
    of firewall you’re using. The most common type, a *packet-filtering firewall*,
    inspects each packet of data attempting to make it into (or out of) your internal
    network and then checks that packet against its ruleset. If the packet contents
    match a rule in the firewall ruleset, the firewall will either allow or deny that
    traffic, depending on what that rule indicates it should do.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 防火墙根据包含已配置规则列表的*规则集*允许或拒绝（阻止）流量。规则应用于流量的方式取决于你使用的防火墙类型。最常见的类型是*包过滤防火墙*，它会检查每个尝试进入（或离开）内部网络的数据包，然后将该数据包与规则集进行匹配。如果数据包的内容与防火墙规则集中某个规则相符，防火墙将根据该规则的指示，决定是否允许或拒绝该流量。
- en: There are also stateful and stateless firewalls. A *stateful* firewall tracks
    all inbound and outbound connections and monitors each connection as a unique
    conversation between two endpoints. This method provides the firewall with context
    about any given connection and allows more granular control of traffic. By contrast,
    a *stateless* firewall doesn’t record information about each connection. Both
    iptables and pfSense are stateful firewalls.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 还有有状态和无状态防火墙。*有状态*防火墙跟踪所有进出连接，并将每个连接视为两个端点之间的独特会话。这种方法为防火墙提供了有关特定连接的上下文，并允许对流量进行更精细的控制。相反，*无状态*防火墙不会记录关于每个连接的信息。iptables和pfSense都是有状态防火墙。
- en: Almost all operating systems come with a built-in software firewall, known as
    a *host-based firewall*, that filters traffic specific to that host. Most Windows
    and Mac devices ship with an out-of-the-box host-based firewall whose basic ruleset
    is functional, if not exhaustive. By design, this firewall works as is for ordinary
    purposes; users don’t need to configure their own firewall, lessening confusion
    as well as the need for technical support from computer manufacturers. On Linux
    devices, you’ll have to configure a firewall—you’ll see how to do this in the
    next section.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 几乎所有操作系统都附带内置的软件防火墙，称为*基于主机的防火墙*，用于过滤特定于该主机的流量。大多数Windows和Mac设备出厂时都配备了开箱即用的基于主机的防火墙，其基本规则集是可用的，尽管可能不全面。该防火墙按设计在普通情况下就能正常工作；用户无需自行配置防火墙，从而减少了混淆和对计算机制造商技术支持的需求。在Linux设备上，您需要配置防火墙——您将在下一节中了解如何做到这一点。
- en: It’s best to use both a host firewall and a perimeter firewall and to configure
    them correctly for your network to add multiple layers of defense.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 最好同时使用主机防火墙和边界防火墙，并正确配置它们，以便为您的网络添加多层防护。
- en: '[iptables](nsp-enoka501485-0007.xhtml#rah0502)'
  id: totrans-14
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: '[iptables](nsp-enoka501485-0007.xhtml#rah0502)'
- en: Linux’s iptables utility offers incredible flexibility in filtering traffic
    entering, traversing, or leaving a network. The firewall organizes its rules in
    *policy chains*, lists of rules that analyze and match packets based on their
    contents. Each rule determines what the firewall will do with a packet that matches
    its definition—it might allow, reject, or drop the packet. When a packet is allowed,
    it passes through the firewall unhindered. When dropped, the firewall discards
    the packet and sends no response back to the sender. If a packet is rejected,
    the firewall discards the packet and sends a rejection message back to the sender,
    providing context about your network and the firewall you’re using.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: Linux的iptables工具在过滤进入、穿越或离开网络的流量方面提供了极大的灵活性。防火墙通过*策略链*组织其规则，这些规则列表根据数据包的内容进行分析和匹配。每个规则决定了防火墙如何处理匹配其定义的数据包——它可能允许、拒绝或丢弃数据包。当数据包被允许时，它会顺利通过防火墙。当数据包被丢弃时，防火墙会丢弃该数据包，并且不会向发送者返回任何响应。如果数据包被拒绝，防火墙会丢弃数据包，并向发送者返回拒绝消息，提供有关您的网络和所使用的防火墙的上下文信息。
- en: 'There are three main types of policy chain: *input chains*, *output chains*,
    and *forward chains*. Input chains determine whether to allow certain traffic
    into the network from an external source, such as a *virtual private network (VPN)*
    connection from a remote location. A VPN is a method for logically—rather than
    physically—connecting to disparate networks, usually for remote access from one
    network to the other. VPNs are covered in greater detail in [Chapter 5](nsp-enoka501485-0014.xhtml#ch05).'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 策略链有三种主要类型：*输入链*、*输出链*和*转发链*。输入链决定是否允许来自外部源的某些流量进入网络，例如来自远程位置的*虚拟私人网络（VPN）*连接。VPN是一种逻辑上——而非物理上——连接不同网络的方法，通常用于从一个网络远程访问另一个网络。VPN将在[第5章](nsp-enoka501485-0014.xhtml#ch05)中详细介绍。
- en: Output chains indicate whether the firewall should allow certain outbound traffic
    to an external network. For example, *Internet Control Message Protocol (ICMP)*
    is primarily used to diagnose network communication issues. ICMP ping packets
    are outbound traffic that pass through the output chain. A ping is a query from
    one device to another, usually to determine whether a connection can be made between
    the two. You’d need to allow the ping packets to travel from your device, through
    your firewall, and across several other devices on the public internet, to finally
    reach their destination. If your output chain blocks ICMP traffic, your device
    would be unable to ping anything, as the firewall would block or drop those packets.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 输出链指示防火墙是否应允许某些外向流量进入外部网络。例如，*互联网控制消息协议（ICMP）*主要用于诊断网络通信问题。ICMP ping数据包是通过输出链传输的外向流量。ping是一种设备间的查询，通常用于判断两者之间是否能建立连接。你需要允许ping数据包从设备出发，穿越防火墙，并通过其他若干设备，最终到达目标。如果你的输出链阻止了ICMP流量，那么你的设备将无法ping任何设备，因为防火墙会阻止或丢弃这些数据包。
- en: In most cases, your stateful firewall rules should allow both new and established
    connections. For example, if you create an output chain to allow your device to
    ping Google, you need to tell the firewall to allow inbound traffic related to
    established connections. Otherwise, your device will send a ping out to Google
    that passes through your firewall, but the response from Google would get blocked
    by your firewall.
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 在大多数情况下，你的状态防火墙规则应当允许新连接和已建立连接。例如，如果你创建一个输出链来允许你的设备ping谷歌，你需要告诉防火墙允许与已建立连接相关的入站流量。否则，你的设备会向谷歌发送ping请求，这个请求会通过防火墙，但谷歌的响应会被防火墙阻止。
- en: Forward chains forward the traffic your firewall receives to another network.
    In a small office or home network, host-based firewalls rarely use forward chains,
    unless the firewall is configured to serve as a router. A perimeter firewall would
    use the forward chain to route traffic from your internal network to the external
    network, or from one network segment to another, likely using network address
    translation (NAT), as discussed in [Chapter 1](nsp-enoka501485-0010.xhtml#ch01).
    However, a configuration of this type is more complicated than necessary for small
    networks and would better fit an enterprise network.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 转发链将防火墙接收到的流量转发到另一个网络。在小型办公室或家庭网络中，基于主机的防火墙很少使用转发链，除非防火墙被配置为充当路由器。边界防火墙会使用转发链将流量从内部网络路由到外部网络，或者从一个网络段路由到另一个网络段，通常使用网络地址转换（NAT），如[第1章](nsp-enoka501485-0010.xhtml#ch01)所讨论。然而，这种配置对于小型网络来说比必要的要复杂，更适合企业网络。
- en: By using these policy chains, you’ll be able to control the traffic traversing
    your network at a very granular level. In the following chapters, you’ll create
    several Linux servers, each of which would benefit from its own host-based firewall.
    I recommend configuring iptables on each of these servers using the following
    instructions.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 通过使用这些策略链，你将能够在非常细粒度的层面控制穿越你网络的流量。在接下来的章节中，你将创建几个Linux服务器，每个服务器都将受益于其独立的基于主机的防火墙。我建议按照以下说明在这些服务器上配置iptables。
- en: Note iptables isn’t capable of securing IPv6 networks and traffic. If you plan
    to use IPv6 in your network, you’ll need to use ip6tables in addition to iptables.
    Unless you have a strong use case for IPv6 in your network, I recommend disabling
    IPv6 completely. Disabling IPv6 is covered in [Chapter 4](nsp-enoka501485-0013.xhtml#ch04).
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，iptables无法保护IPv6网络和流量。如果你打算在你的网络中使用IPv6，你需要额外使用ip6tables来配合iptables。除非你的网络中有强烈的IPv6使用需求，否则我建议你完全禁用IPv6。禁用IPv6的步骤在[第4章](nsp-enoka501485-0013.xhtml#ch04)中有介绍。
- en: '[#12: Installing iptables](nsp-enoka501485-0007.xhtml#rhd0501)'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: '[#12: 安装iptables](nsp-enoka501485-0007.xhtml#rhd0501)'
- en: If you’ve already built a standard Ubuntu server following the steps from [Chapter
    1](nsp-enoka501485-0010.xhtml#ch01), you can start configuring its iptables firewall.
    Once you’ve mastered the basics, use that knowledge to configure iptables on all
    your Linux endpoints. Otherwise, go back and create your Ubuntu system now.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你已经按照[第1章](nsp-enoka501485-0010.xhtml#ch01)的步骤构建了一个标准的Ubuntu服务器，你可以开始配置它的iptables防火墙。一旦掌握了基础，你可以将这些知识用来在所有Linux终端上配置iptables。否则，现在就回去创建你的Ubuntu系统吧。
- en: 'Recent versions of Ubuntu have iptables installed by default, so log in via
    SSH as a standard, non-root user, and check for iptables by running a version
    check:'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 最新版本的Ubuntu默认安装了iptables，因此请以标准非root用户身份通过SSH登录，并通过运行版本检查来查看是否已安装iptables：
- en: '[PRE0]'
  id: totrans-25
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: If iptables is installed, the server should return version information, as shown
    here. Your version may be different.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 如果已安装iptables，服务器应该会返回版本信息，如下所示。你的版本可能会有所不同。
- en: 'If iptables isn’t installed, you’ll receive an error, in which case, install
    iptables:'
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 如果没有安装iptables，你将会收到一个错误提示，此时需要安装iptables：
- en: '[PRE1]'
  id: totrans-28
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: Once it’s installed, run the same version check to confirm that the installation
    succeeded.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 安装完成后，运行相同的版本检查以确认安装成功。
- en: 'Next, install `iptables-persistent`, a tool that allows you to save your firewall
    configurations and automatically reload them after a reboot of the server:'
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，安装`iptables-persistent`，这是一个可以保存防火墙配置并在服务器重启后自动加载配置的工具：
- en: '[PRE2]'
  id: totrans-31
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: An installation wizard should take over your terminal window. You’ll be shown
    the file in which your server will save the firewall rules (the default file is
    */etc/iptables/rules.v4*) and told that rules from this file will load at system
    startup. Also, you’ll need to save any changes to firewall rules manually beyond
    this installation process. Select **Yes** to save any current firewall rules.
    If you don’t install this component, you’ll have to reconfigure your firewall
    every time you restart the server.
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 一个安装向导应该会接管你的终端窗口。你将看到一个文件，显示服务器将保存防火墙规则的地方（默认文件是*/etc/iptables/rules.v4*），并且会告知该文件中的规则将在系统启动时加载。同时，你需要在此安装过程之外手动保存任何防火墙规则的更改。选择**Yes**以保存当前的防火墙规则。如果你不安装此组件，每次重启服务器时都需要重新配置防火墙。
- en: 'You can now check the current policy chains like so:'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你可以像这样检查当前的策略链：
- en: '[PRE3]'
  id: totrans-34
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: In the output, `policy ACCEPT` indicates that, by default, iptables accepts
    all traffic for input, output, and forwarding. This default behavior is desirable
    because it’ll work without any user configuration. However, it’s an insecure solution,
    so let’s modify it.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 在输出中，`policy ACCEPT`表示默认情况下，iptables接受所有输入、输出和转发流量。这个默认行为是可取的，因为它在没有用户配置的情况下就能工作。然而，它是一个不安全的解决方案，因此我们需要对其进行修改。
- en: '[iptables Firewall Rules](nsp-enoka501485-0007.xhtml#rbh0501)'
  id: totrans-36
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '[iptables 防火墙规则](nsp-enoka501485-0007.xhtml#rbh0501)'
- en: When creating iptables rules, keep in mind that order matters. As traffic reaches
    your firewall, iptables checks its rules one after the other *in the order they
    appear*. If the traffic matches a rule, iptables won’t check any further rules—if
    the first rule in your list of 50 denies all traffic, the firewall will interpret
    this rule, reject the traffic, and stop processing, which effectively isolates
    your device entirely. Alternatively, if you have the same 50 rules but the first
    rule allows all traffic, all traffic will be allowed to pass through the firewall.
    You should avoid both of those situations.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 在创建iptables规则时，请记住顺序非常重要。当流量到达防火墙时，iptables会按顺序检查规则，*按照它们出现的顺序*。如果流量与某个规则匹配，iptables就不会再检查其他规则——如果你的50条规则中的第一条规则拒绝所有流量，那么防火墙会解释这条规则，拒绝流量并停止处理，从而有效地将你的设备完全隔离。相反，如果你有相同的50条规则，但第一条规则允许所有流量，那么所有流量都会通过防火墙。你应该避免这两种情况。
- en: 'To understand how to construct an iptables firewall rule, take a look at this
    example:'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 要理解如何构建iptables防火墙规则，看看这个示例：
- en: '[PRE4]'
  id: totrans-39
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Immediately after `sudo`, iptables is invoked to begin the rule definition.
    The next argument determines whether the rule will be appended to (`-A`), deleted
    from (`-D`), or inserted into (`-I`) the specified policy chain. You can also
    specify `-R` in this position when replacing or updating an existing rule. The
    `INPUT` indicates that a rule in the input chain is being modified. You also can
    specify `OUTPUT`, `FORWARD`, or other policy chains.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 在`sudo`命令之后，调用iptables开始定义规则。下一个参数决定了规则是附加到（`-A`）、删除（`-D`）还是插入（`-I`）指定的策略链。你还可以在这个位置指定`-R`来替换或更新现有规则。`INPUT`表示正在修改输入链中的规则。你还可以指定`OUTPUT`、`FORWARD`或其他策略链。
- en: 'In most cases, iptables needs to know the protocol and port to which the rules
    relate. In this example, `-p tcp` indicates the rule will apply only to TCP traffic,
    and `--dport 22` tells iptables that the rule applies to packets with a destination
    port of 22\. Both of those settings are optional. You can specify multiple ports
    with this syntax: `--match multiport --dports` `port1,port2,port3`.'
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 在大多数情况下，iptables需要知道规则所涉及的协议和端口。在此示例中，`-p tcp`表示规则仅适用于TCP流量，`--dport 22`告诉iptables该规则适用于目标端口为22的数据包。两者都是可选的。你可以使用以下语法指定多个端口：`--match
    multiport --dports` `port1,port2,port3`。
- en: Note *Transmission Control Protocol (TCP)* is a *reliable* transmission protocol,
    designed to ensure successful delivery of packets over a network. If a computer
    experiences packet loss during communication that’s using TCP, those lost packets
    will be retransmitted, ensuring all of the data sent is eventually received by
    the destination host. *User Datagram Protocol (UDP)* is an *unreliable* protocol
    and does not ensure successful transmission of data or retransmit lost packets.
    UDP is used when some packet loss is acceptable and usually results in a faster
    connection. TCP is used when reliability matters, and every packet must be transmitted
    successfully.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 注意，*传输控制协议（TCP）*是一个*可靠*的传输协议，旨在确保数据包在网络上的成功传输。如果计算机在使用TCP进行通信时发生数据包丢失，丢失的数据包将被重新传输，确保所有发送的数据最终都能被目标主机接收。*用户数据报协议（UDP）*是一个*不可靠*的协议，不保证数据的成功传输，也不会重新传输丢失的数据包。UDP用于一些可以接受丢包的场景，通常会导致更快的连接速度。而TCP则在可靠性至关重要时使用，每个数据包都必须成功传输。
- en: 'The iptables firewall offers multiple matching modules, and you can specify
    the module to use with the `-m` argument. In this example, `conntrack`, a tool
    that allows stateful packet inspection, is used (also optional). Some other tools
    include `connbytes`, which creates rules based on the amount of traffic transferred,
    and `connrate`, which matches on the transfer rate of the traffic. See the iptables
    man page for more details: [https://linux.die.net/man/8/iptables/](https://linux.die.net/man/8/iptables/).'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: iptables防火墙提供了多个匹配模块，你可以使用`-m`参数来指定要使用的模块。在这个例子中，使用了`conntrack`，一个允许有状态数据包检查的工具（也是可选的）。其他一些工具包括`connbytes`，它根据传输的流量大小来创建规则，以及`connrate`，它根据流量的传输速率进行匹配。有关更多详细信息，请参阅iptables手册：[https://linux.die.net/man/8/iptables/](https://linux.die.net/man/8/iptables/)。
- en: Next, `--ctstate` tells iptables to allow and track traffic for the types of
    connections that follow—in this case, `NEW` and `ESTABLISHED`. Many values are
    available for connection state, but the most frequently used are `NEW`, `ESTABLISHED`,
    `RELATED`, and `INVALID`. New and established states are self-explanatory; the
    packets are part of new or established traffic flows. Related packets don’t necessarily
    match an established connection, but they are expected by the firewall because
    an existing connection necessitates it (that is, it’s expected based on the firewall’s
    existing context). Invalid packets are any packets that don’t match the criteria
    for any other states.
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，`--ctstate`告诉iptables允许并跟踪以下连接类型的流量——在这种情况下是`NEW`和`ESTABLISHED`。连接状态有许多可用值，但最常用的是`NEW`、`ESTABLISHED`、`RELATED`和`INVALID`。新建和已建立的状态是不言自明的；数据包属于新的或已建立的流量流。相关数据包不一定匹配已建立的连接，但它们是防火墙所期望的，因为现有连接需要它（即根据防火墙现有的上下文进行预期）。无效的数据包是任何不符合其他状态标准的数据包。
- en: Finally, iptables will interpret `-j` and whatever follows it as the action
    to jump to (perform) when this rule is matched. Most commonly, it will be either
    `ACCEPT` to allow traffic matching this rule; `DROP`, or `REJECT`, to deny or
    block the traffic; or `LOG` to log the traffic to a logfile (more details on that
    later).
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，iptables将把`-j`及其后面的内容视为匹配此规则时要执行的动作。最常见的动作是`ACCEPT`，允许匹配此规则的流量；`DROP`或`REJECT`，拒绝或阻止流量；或`LOG`，将流量记录到日志文件中（稍后会详细介绍）。
- en: Now that you understand the fundamentals of iptables rules, you’ll configure
    your firewall to allow and deny traffic.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你已经理解了iptables规则的基础知识，接下来你将配置防火墙以允许和拒绝流量。
- en: '[Configuring iptables](nsp-enoka501485-0007.xhtml#rbh0502)'
  id: totrans-47
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '[配置iptables](nsp-enoka501485-0007.xhtml#rbh0502)'
- en: 'When configuring iptables, first add rules to drop invalid traffic:'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: 配置iptables时，首先添加规则以丢弃无效流量：
- en: '[PRE5]'
  id: totrans-49
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'Then, add rules to accept traffic related to existing connections, as well
    as established connections and the loopback address to avoid any issues later
    (a *loopback address* is an internal address that computers use for testing and
    diagnosing network issues):'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，添加规则以接受与现有连接相关的流量，以及已建立连接和回环地址，以避免之后出现问题（*回环地址*是计算机用来测试和诊断网络问题的内部地址）：
- en: '[PRE6]'
  id: totrans-51
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: This allows the firewall to accept traffic matching a known connection or related
    to a connection in progress and discard any unexpected packets (which can protect
    your network from unsolicited or malicious network scanning activity).
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 这允许防火墙接受与已知连接匹配或与正在进行的连接相关的流量，并丢弃任何意外的数据包（这可以保护你的网络免受未经请求或恶意的网络扫描活动）。
- en: 'Once you’ve run these commands to enter the rules into the policy chains, rerun
    the list command to ensure they’ve been accepted:'
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦运行这些命令将规则输入到策略链中，请重新运行列出命令以确保它们已被接受：
- en: '[PRE7]'
  id: totrans-54
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Notice the rules have been added under the `INPUT` and `OUTPUT` chains. The
    `FORWARD` chain remains empty.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，规则已经被添加到`INPUT`和`OUTPUT`链下。`FORWARD`链保持为空。
- en: 'Next, ensure that your firewall allows SSH traffic. You can do this in two
    ways: by broadly allowing SSH or by allowing SSH only from a subset of devices
    in your network. To allow SSH traffic originating from all devices in your network,
    use the following command:'
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，确保您的防火墙允许SSH流量。您可以通过两种方式实现：广泛地允许SSH，或者仅允许来自您网络中部分设备的SSH流量。要允许来自您网络中所有设备的SSH流量，可以使用以下命令：
- en: '[PRE8]'
  id: totrans-57
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: Creating broad rules can be helpful when connecting to or from multiple devices
    using SSH within your network. However, allowing the uninhibited use of programs
    and leaving protocols completely open is not the most secure solution. You should
    allow services like SSH only to and from specific IP addresses or ranges, as allowing
    remote access or file transfer between your endpoints and any other device is
    risky.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 创建广泛的规则在通过SSH连接到或从多个设备连接时很有帮助。然而，允许程序的无限制使用并完全开放协议并不是最安全的解决方案。您应该仅允许来自特定IP地址或范围的SSH等服务，因为允许远程访问或文件传输在您的端点与任何其他设备之间是有风险的。
- en: 'You can reduce your attack surface by specifying a source IP address or range
    (for example, 192.168.1.25) in your input chain with the `-s` `source` option,
    so if you’re configuring iptables on a virtual machine, you might choose to allow
    connections from a single host for management purposes and deny access to all
    other endpoints in your network:'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以通过在输入链中使用`-s` `source`选项指定源IP地址或范围（例如，192.168.1.25）来减少攻击面，因此，如果您在虚拟机上配置iptables，您可能会选择仅允许来自单个主机的管理连接，并拒绝网络中所有其他端点的访问：
- en: '[PRE9]'
  id: totrans-60
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: We append this rule to the `INPUT` policy chain using `-A`, destination port `22`,
    and protocol `TCP`. For `NEW` connections, iptables will `ACCEPT` traffic matching
    this rule. The port can be one of your choosing; just be sure that your SSH configuration
    matches your firewall rule. If the rule allows SSH on port 22 but your SSH configuration
    allows connections on port 2222, the firewall will block your SSH connections.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 我们使用`-A`将此规则追加到`INPUT`策略链中，目标端口`22`，协议`TCP`。对于`NEW`连接，iptables将`ACCEPT`符合此规则的流量。端口可以是您选择的任何端口；只需确保您的SSH配置与防火墙规则匹配。如果规则允许在端口22上使用SSH，但您的SSH配置允许在端口2222上进行连接，防火墙将阻止您的SSH连接。
- en: 'If you make a mistake, delete the rule by running the same command, substituting
    the `-D` option in place of `-A`:'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您犯了错误，通过运行相同的命令并将`-D`选项替换为`-A`来删除规则：
- en: '[PRE10]'
  id: totrans-63
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'Alternatively, you can delete all the rules you’ve specified for any of your
    policy chains by using the `-F` `chain`, or `--flush` `chain`, parameter:'
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 另外，您可以使用`-F` `chain`或`--flush` `chain`参数删除您为任何策略链指定的所有规则：
- en: '[PRE11]'
  id: totrans-65
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'With this basic set of rules, now you can tell iptables what to do with all
    other traffic (that you don’t want entering or leaving your server or network).
    Once you’ve created rules to allow the specific traffic you want or need the firewall
    to allow, you can most likely block, deny, or drop everything else. You should
    do this after you’ve configured your firewall rules; otherwise, you might interrupt
    your connection and be unable to reconnect via SSH. Using the `-P` argument sets
    the default behavior of your policy chains and lets iptables know what to do with
    traffic that doesn’t match your rules. To achieve this, set the policy chains’
    default behaviors to `DROP` this traffic:'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 使用这组基本规则，您现在可以告诉iptables如何处理所有其他流量（您不希望进入或离开您的服务器或网络）。一旦创建了允许特定流量的规则，您可以很可能阻止、拒绝或丢弃其他所有流量。您应该在配置防火墙规则后执行此操作；否则，您可能会中断连接并无法通过SSH重新连接。使用`-P`参数设置策略链的默认行为，并让iptables知道如何处理与规则不匹配的流量。为此，设置策略链的默认行为为`DROP`这些流量：
- en: '[PRE12]'
  id: totrans-67
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Using `-P` in this way is different from `-A` and `-I` used previously, because
    it doesn’t affect the firewall rules themselves; instead, it deals with the overarching
    policies that govern traffic in your network. Where `-A` and `-I` append or insert
    rules for your firewall, respectively, `-P` configures the firewall behavior one
    level higher.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: 以这种方式使用`-P`不同于之前使用的`-A`和`-I`，因为它不会影响防火墙规则本身；相反，它处理管理网络流量的整体策略。`-A`和`-I`分别用于追加或插入防火墙规则，而`-P`则在更高一级配置防火墙行为。
- en: 'At this point, checking your iptables chains should return:'
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 此时，检查你的 iptables 链应该返回：
- en: Chain INPUT (policy DROP)
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 链 INPUT（策略 DROP）
- en: target     prot opt source               destination
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: target     prot opt source               destination
- en: DROP       all  --  anywhere             anywhere             state INVALID
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: DROP       all  --  anywhere             anywhere             state INVALID
- en: ACCEPT     all  --  anywhere             anywhere             state RELATED,ESTABLISHED
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: ACCEPT     all  --  anywhere             anywhere             state RELATED,ESTABLISHED
- en: ACCEPT     all  --  anywhere             anywhere
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: ACCEPT     all  --  anywhere             anywhere
- en: ACCEPT     tcp  -- 192.168.1.25          anywhere             tcp dpt:22 ctstate
    NEW
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: ACCEPT     tcp  --  192.168.1.25         anywhere             tcp dpt:22 ctstate
    NEW
- en: Chain FORWARD (policy DROP)
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 链 FORWARD（策略 DROP）
- en: target     prot opt source               destination
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: target     prot opt source               destination
- en: Chain OUTPUT (policy DROP)
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 链 OUTPUT（策略 DROP）
- en: target     prot opt source               destination
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: target     prot opt source               destination
- en: DROP       all  --  anywhere             anywhere             state INVALID
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: DROP       all  --  anywhere             anywhere             state INVALID
- en: ACCEPT     all  --  anywhere             anywhere             state RELATED,ESTABLISHED
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: ACCEPT     all  --  anywhere             anywhere             state RELATED,ESTABLISHED
- en: 'Notice that the policy for all three chains has changed from `ACCEPT` to `DROP`,
    indicating the default behavior for each chain is to drop traffic that doesn’t
    match any of the rules you’ve created. You should also be able to identify the
    rules you’ve added to the chains by comparing this output to the previous output
    listing the iptables rules. You may receive an error that DNS is failing, because
    the firewall is now blocking everything not explicitly allowed, including DNS
    (which runs on port 53). Resolve this issue by adding the following new rules:'
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，所有三个链的策略已经从 `ACCEPT` 更改为 `DROP`，这表明每个链的默认行为是丢弃不匹配任何规则的流量。你还应该能够通过将这个输出与之前列出
    iptables 规则的输出进行比较，来识别你添加到链中的规则。你可能会收到 DNS 失败的错误，因为防火墙现在阻止了所有未明确允许的内容，包括 DNS（它运行在端口
    53）。通过添加以下新规则来解决这个问题：
- en: $ `sudo iptables -A OUTPUT -p udp --dport 53 -m conntrack --ctstate NEW -j ACCEPT`
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: $ `sudo iptables -A OUTPUT -p udp --dport 53 -m conntrack --ctstate NEW -j ACCEPT`
- en: $ `sudo iptables -A OUTPUT -p tcp --dport 53 -m conntrack --ctstate NEW -j ACCEPT`
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: $ `sudo iptables -A OUTPUT -p tcp --dport 53 -m conntrack --ctstate NEW -j ACCEPT`
- en: These commands append rules to the output chain, allowing this server to make
    outbound requests for domain name resolution on UDP and TCP port 53\. With the
    addition of these rules, the server can resolve domain names.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 这些命令将规则附加到输出链，允许此服务器在 UDP 和 TCP 端口 53 上进行域名解析的出站请求。通过添加这些规则，服务器可以解析域名。
- en: 'Test your firewall by trying to ping the server from another device in your
    network; you should receive an error, as ICMP isn’t allowed through the firewall.
    Likewise, if you try to ping anything from the server itself, you should receive
    a similar error:'
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 通过尝试从网络中的另一台设备 ping 服务器来测试你的防火墙；你应该会收到一个错误，因为 ICMP 被防火墙禁止。类似地，如果你尝试从服务器本身 ping
    任何内容，你也应该收到类似的错误：
- en: '[PRE13]'
  id: totrans-87
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'ICMP can be such a useful troubleshooting tool that you might decide to allow
    ping through your iptables firewall. To do so, add the following rules:'
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: ICMP 可以是一个非常有用的故障排除工具，你可能会决定允许通过 iptables 防火墙进行 ping 操作。要做到这一点，请添加以下规则：
- en: '[PRE14]'
  id: totrans-89
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'You may discover that you need to open additional ports in the firewall. For
    example, if you have a proxy installed or if you build one after reading [Chapter
    6](nsp-enoka501485-0015.xhtml#ch06), you’ll need to open the proxy port (3128)
    in your firewall:'
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能会发现需要在防火墙中打开额外的端口。例如，如果你安装了代理，或者在阅读完[第6章](nsp-enoka501485-0015.xhtml#ch06)后构建了一个，你需要在防火墙中打开代理端口（3128）：
- en: $ `sudo iptables -A OUTPUT -p tcp --dport 3128 -m conntrack --ctstate NEW -j
    ACCEPT`
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: $ `sudo iptables -A OUTPUT -p tcp --dport 3128 -m conntrack --ctstate NEW -j
    ACCEPT`
- en: In most cases, you should block web browsing in general from servers—there are
    few, if any, legitimate reasons to use servers for this type of activity. Ideally,
    from both an administrative and a security standpoint, servers should be single-purpose.
    Allowing any additional service—especially browsing the internet—on a server results
    in a larger attack surface and creates potential vulnerabilities in your network.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 在大多数情况下，你应该从服务器中禁止网页浏览——几乎没有正当理由使用服务器进行此类活动。理想情况下，从管理和安全角度来看，服务器应为单一用途。允许任何额外的服务——特别是浏览互联网——会导致更大的攻击面，并在你的网络中创建潜在的漏洞。
- en: 'If you decide to allow this traffic from your server(s) so the server can retrieve
    software updates, create output rules for ports 80 and 443, the default ports
    for HTTP and HTTPS traffic, respectively:'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你决定允许来自服务器的此类流量，以便服务器可以获取软件更新，创建针对端口80和443的输出规则，这两个端口分别是HTTP和HTTPS流量的默认端口：
- en: '`$` `sudo iptables -A OUTPUT -p tcp --dport 80 -m conntrack --ctstate NEW,ESTABLISHED
    -j ACCEPT`'
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: '`$` `sudo iptables -A OUTPUT -p tcp --dport 80 -m conntrack --ctstate NEW,ESTABLISHED
    -j ACCEPT`'
- en: '`$` `sudo iptables -A OUTPUT -p tcp --dport 443 -m conntrack --ctstate NEW,ESTABLISHED
    -j ACCEPT`'
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: '`$` `sudo iptables -A OUTPUT -p tcp --dport 443 -m conntrack --ctstate NEW,ESTABLISHED
    -j ACCEPT`'
- en: The only difference between the HTTP and HTTPS rules is the port number.
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: HTTP和HTTPS规则之间唯一的区别是端口号。
- en: 'Every time you add a rule, you should test it. The easiest way to do so, in
    this case, will be to first test your ability to browse the internet by using
    a web browser on the server (if you have the GUI installed) or by using `curl`
    in the bash terminal. Start by installing `curl`:'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 每次添加规则后，你都应该进行测试。此时，最简单的测试方法是先使用服务器上的浏览器（如果安装了GUI）或者在bash终端中使用`curl`测试是否能上网。首先安装`curl`：
- en: '[PRE15]'
  id: totrans-98
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'If you don’t have rules allowing HTTP and HTTPS, the install command will fail,
    as updates are typically done over HTTP. However, if you do have those rules in
    place, `curl` should have installed successfully, so you can now ensure ports
    80 and 443 are open:'
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 如果没有允许HTTP和HTTPS的规则，安装命令将会失败，因为更新通常是通过HTTP进行的。不过，如果已经配置了这些规则，`curl`应该已经成功安装，你现在可以确保端口80和443已开放：
- en: '[PRE16]'
  id: totrans-100
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: The address [http://icanhazip.com/](http://icanhazip.com/) is a public service
    provider that will return your current public IP address when queried with `curl`.
    If you’re shown your current public IP address, your firewall is configured correctly.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 地址[http://icanhazip.com/](http://icanhazip.com/)是一个公共服务提供商，当通过`curl`查询时，它会返回你当前的公共IP地址。如果显示了当前的公共IP地址，那么说明防火墙配置正确。
- en: If you receive an error, one of your rules may have a problem. Check for typos,
    and if all else fails, delete your rules and start again using the `-D` or `-F`
    parameters discussed earlier. Once the firewall is correctly configured, feel
    free to add further rules as you deem necessary.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你收到错误，可能是某个规则存在问题。检查拼写，如果仍然无法解决，请删除规则并使用之前讨论过的`-D`或`-F`参数重新开始。一旦防火墙配置正确，可以根据需要添加更多规则。
- en: One particular set of rules to add are those that block traffic to specific
    IP addresses. Since most public websites can have multiple IP addresses, however,
    blocking a site using iptables isn’t the best option, as you’d have to create
    rules for each unique IP address. In most cases, you’d be better off using a proxy,
    which we’ll cover in [Chapter 6](nsp-enoka501485-0015.xhtml#ch06).
  id: totrans-103
  prefs: []
  type: TYPE_NORMAL
  zh: 一个特别要添加的规则集是那些阻止流量到特定IP地址的规则。然而，由于大多数公共网站可能有多个IP地址，使用iptables屏蔽一个网站并不是最好的选择，因为你需要为每个唯一的IP地址创建规则。在大多数情况下，使用代理会更好，我们将在[第6章](nsp-enoka501485-0015.xhtml#ch06)中介绍。
- en: 'If you want to use iptables to block sites—say, for example, to block all traffic
    to and from [https://www.squirreldirectory.com/](https://www.squirreldirectory.com/),
    which currently resides at IP address 206.189.69.35—you would add the following
    rules to your `INPUT` and `OUTPUT` chains:'
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想使用iptables屏蔽某些网站—比如，屏蔽所有流量到[https://www.squirreldirectory.com/](https://www.squirreldirectory.com/)，该网站目前位于IP地址206.189.69.35，你需要将以下规则添加到`INPUT`和`OUTPUT`链中：
- en: '[PRE17]'
  id: totrans-105
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: Typically, you’d add this type of rule to allow or deny traffic from a static,
    private IP address that isn’t expected to change, and use a proxy for public IP
    addresses or URLs.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 通常，你会添加这种类型的规则来允许或拒绝来自静态、私有IP地址的流量，该IP地址预期不会更改，并使用代理处理公共IP地址或URL。
- en: '[Logging iptables Behavior](nsp-enoka501485-0007.xhtml#rbh0503)'
  id: totrans-107
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '[记录iptables行为](nsp-enoka501485-0007.xhtml#rbh0503)'
- en: You’ve now installed and configured the iptables firewall, but you haven’t told
    it to log anything, so it produces no records of its behavior, which can make
    it difficult to troubleshoot issues or determine whether blocked traffic should
    have been blocked.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 你现在已经安装并配置了iptables防火墙，但你没有告诉它记录任何内容，所以它不会产生任何行为记录，这可能使得故障排除或确定是否应阻止某些流量变得困难。
- en: 'First, create a new, custom policy chain. Note that this configuration is an
    example of where rule order is critical. You can name the chain whatever you like,
    but here, we’ll call it `LOGGING`:'
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，创建一个新的自定义策略链。请注意，此配置示例中规则的顺序非常关键。你可以随意命名链，但在这里，我们将其命名为`LOGGING`：
- en: '[PRE18]'
  id: totrans-110
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: The `-N` parameter is used to create new chains.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: '`-N`参数用于创建新链。'
- en: 'Next, add a rule at the end of each of the `INPUT` and `OUTPUT` chains that
    tells iptables to send any traffic that hasn’t yet matched a rule to the new `LOGGING`
    chain:'
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，在`INPUT`和`OUTPUT`链的末尾添加一条规则，告诉iptables将所有尚未匹配规则的流量发送到新的`LOGGING`链：
- en: '[PRE19]'
  id: totrans-113
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'Then, tell iptables to log only once per minute for each type of dropped packet:'
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，告诉iptables每分钟只记录每种丢弃的数据包一次：
- en: '[PRE20]'
  id: totrans-115
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: This limit is optional, and you can set it to any period, such as `1/second`,
    `1/minute`, `1/hour`, or `1/day`. Limiting the number of log entries reduces both
    the noise within and the size of the logfiles. Add a prefix (`"FW-Dropped: "`)
    to the log information so the firewall log entries are easy to identify. Setting the
    logging level to `4` will log up to warning-level events, indicating an event
    that has a material effect on the server or the firewall. Increasing the number
    results in more events with lower severity being logged, which is useful when
    troubleshooting. Log levels 1 to 3 will log only events or errors with higher
    than warning-level severity.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: '这个限制是可选的，你可以将其设置为任何时间段，比如`1/second`、`1/minute`、`1/hour`或`1/day`。限制日志条目的数量可以减少日志中的噪声以及日志文件的大小。为日志信息添加前缀（`"FW-Dropped:
    "`），这样防火墙日志条目就容易识别。将日志级别设置为`4`会记录警告级别及以上的事件，表示对服务器或防火墙有实质性影响的事件。增加数字会记录更多较低严重性的事件，这在故障排除时非常有用。日志级别1到3只会记录警告级别以上的事件或错误。'
- en: 'Finally, the following command indicates to the firewall that, once logged,
    the packets should be dropped:'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，以下命令告诉防火墙，在记录后应该丢弃数据包：
- en: '[PRE21]'
  id: totrans-118
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: Your firewall will now log all the dropped packets both inbound to and outbound
    from the server. By default, those logs will be kept in */var/log/messages*.
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，你的防火墙将记录所有丢弃的数据包，包括从服务器的入站和出站流量。默认情况下，这些日志将保存在*/var/log/messages*中。
- en: 'The last step is to save your firewall configuration. Remember that iptables
    configurations are temporary by default and won’t survive a reboot, which is why
    we installed `iptables-persistent` in [Project 12](nsp-enoka501485-0012.xhtml#hd0501).
    To save your configuration, run the following command (`netfilter` is the command
    used by `iptables-persistent` for this purpose):'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 最后一步是保存防火墙配置。请记住，iptables配置默认是临时的，重启后会丢失，这就是我们在[项目12](nsp-enoka501485-0012.xhtml#hd0501)中安装`iptables-persistent`的原因。要保存配置，请运行以下命令（`netfilter`是`iptables-persistent`用于此目的的命令）：
- en: $ `sudo netfilter-persistent save`
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: $ `sudo netfilter-persistent save`
- en: 'run-parts: executing /usr/share/netfilter-persistent/plugins.d/15-ip4tables
    save'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 'run-parts: 执行 /usr/share/netfilter-persistent/plugins.d/15-ip4tables save'
- en: 'run-parts: executing /usr/share/netfilter-persistent/plugins.d/25-ip6tables
    save'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 'run-parts: 执行 /usr/share/netfilter-persistent/plugins.d/25-ip6tables save'
- en: With that, the firewall is ready to go.
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 这样，防火墙就准备好了。
- en: You may consider adding temporary rules to your firewall, but remember the adage
    that “nothing is more permanent than a temporary firewall rule” (Austin Scott).
    In the case of adding a temporary rule to allow a user to download a file from
    the internet, for example, it would be better to find a different workaround,
    like using another host. If a rule like this is created and left in the firewall
    configuration, it creates a vulnerability and reduces the security offered by
    the firewall. Avoid temporary rules whenever possible.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以考虑在防火墙中添加临时规则，但请记住那句谚语：“没有什么比临时防火墙规则更持久”（Austin Scott）。例如，在防火墙中添加临时规则以允许用户从互联网下载文件时，最好找到其他替代方法，比如使用另一台主机。如果这样的规则被创建并留在防火墙配置中，它会造成一个漏洞，降低防火墙的安全性。尽量避免使用临时规则。
- en: '[pfSense](nsp-enoka501485-0007.xhtml#rah0503)'
  id: totrans-126
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: '[pfSense](nsp-enoka501485-0007.xhtml#rah0503)'
- en: In addition to a firewall securing each endpoint in your network with iptables,
    you should implement a firewall like pfSense to secure your entire network at
    its border. Together, these firewalls add layers to your defense-in-depth strategy,
    making the job of any adversary more difficult with each level of complexity.
    You should place a perimeter firewall at the physical edge of your network—that
    is, as close to the internet as possible relative to the other endpoints in your
    network. For most, that position will be directly behind the modem/router or network
    boundary point that connects your network to your internet service provider. It
    is possible to achieve this logically, using virtual machines and the correct
    routing configuration. However, the best and most secure way to set up a perimeter
    firewall is to use a physical device.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 除了使用 iptables 防火墙保护你网络中的每个端点外，你还应实施像 pfSense 这样的防火墙，来保护网络边界。通过这两层防火墙，你的防御深度策略得到了加强，每一层的复杂性都让任何攻击者的任务变得更加困难。你应当将边界防火墙放置在网络的物理边缘——也就是尽可能接近互联网的位置，相对于网络中的其他端点而言。对于大多数人来说，这个位置将直接位于调制解调器/路由器或连接你网络和互联网服务提供商的网络边界点后面。通过虚拟机和正确的路由配置，也有可能从逻辑上实现这一点。然而，设置边界防火墙的最佳和最安全的方式是使用物理设备。
- en: Like iptables, the pfSense firewall is stateful. However, where iptables works
    as a feature installed on top of a base operating system like Ubuntu, pfSense
    is a fully fledged operating system. It’s based on FreeBSD, an open source version
    of Unix (an operating system similar to Linux that uses its own kernel) that has
    user-friendly features like a web management interface and can be deployed as
    either a virtual machine or a physical appliance.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 与 iptables 类似，pfSense 防火墙是有状态的。然而，iptables 是作为一个功能安装在像 Ubuntu 这样的基本操作系统之上，而
    pfSense 是一个完全成熟的操作系统。它基于 FreeBSD，这是一个开源的 Unix 版本（一个类似于 Linux 的操作系统，使用自己的内核），具有像
    Web 管理界面等用户友好的特性，并且可以作为虚拟机或物理设备部署。
- en: You have a few options when it comes to creating a physical firewall. The first
    is to build a device that suits this purpose from a computer with a small footprint,
    like the Intel Next Unit of Computing (NUC). However, for the same cost or far
    less, Netgate sells pfSense appliances that are easy to configure and basically
    ready to go out of the box.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 在创建物理防火墙时，你有几个选择。第一个是从小型计算机（如英特尔的下一代计算单元 NUC）构建一个适合此目的的设备。然而，对于相同的价格或更低的价格，Netgate
    销售易于配置并且几乎开箱即用的 pfSense 设备。
- en: For the sake of simplicity (and security), we’ll discuss using a prebuilt device.
    This book will not cover building a device from scratch because the risk of misconfiguration
    is too high, especially when an inexpensive, secure solution is readily available.
    The Netgate 2100 Base pfSense+ costs around $400 at the time of writing. It’s
    powerful enough to be capable of most anything you can throw at it, short of a
    full-blown enterprise network. The SG-3100 is a step up from the entry-level 1100
    pfSense+ and is more fully featured. It also has higher bandwidth and is capable
    of greater throughput, so it’s the ideal choice for smaller networks.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 为了简便（和安全考虑），我们将讨论使用预构建的设备。本文不会涉及从零开始构建设备，因为配置错误的风险太高，尤其是当有价格低廉且安全的解决方案现成可用时。撰写本文时，Netgate
    2100 Base pfSense+ 的价格大约为 400 美元。它足够强大，可以应对你所需要的大部分任务，但不包括大规模的企业网络。SG-3100 比入门级的
    1100 pfSense+ 更强大，功能也更全面。它具有更高的带宽和更大的吞吐量，因此它是小型网络的理想选择。
- en: '[#13: Installing the pfSense Firewall](nsp-enoka501485-0007.xhtml#rhd0502)'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: '[#13: 安装 pfSense 防火墙](nsp-enoka501485-0007.xhtml#rhd0502)'
- en: Upon receiving your pfSense device, remove it from the box and plug it into
    power. Connect an Ethernet cable from the WAN port on the device to any port on
    your cable, DSL modem, or network boundary point device. Connect another Ethernet
    cable from the LAN1 port to the Ethernet port on your computer.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 收到 pfSense 设备后，将其从盒子中取出并连接电源。用一根以太网电缆将设备上的 WAN 端口连接到你的电缆、DSL 调制解调器或网络边界设备的任意端口。再用一根以太网电缆将
    LAN1 端口连接到计算机上的以太网端口。
- en: To access the pfSense configuration page from your computer, browse to 192.168.1.1,
    the default IP address of the SG-3100\. If that doesn’t work, you may need to
    disconnect your computer from your regular network and manually set its IP address
    to 192.168.1.2 (or any other address in the 192.168.1.*x* range, except the pfSense
    IP of 192.168.1.1) using the following instructions. This is necessary only for
    the initial configuration of the device and should need to be done only once on
    the computer you use to set up the pfSense appliance.
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 要从计算机访问pfSense配置页面，请浏览到192.168.1.1，这是SG-3100的默认IP地址。如果无法连接，您可能需要断开计算机与常规网络的连接，并手动将其IP地址设置为192.168.1.2（或任何其他在192.168.1.*x*范围内的地址，除了pfSense的IP地址192.168.1.1），按照以下说明进行设置。这仅在设备的初始配置时需要完成，并且只需要在您用来设置pfSense设备的计算机上执行一次。
- en: macOS
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: macOS
- en: 1\. Open **System Preferences**.
  id: totrans-135
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开**系统偏好设置**。
- en: 2\. Click **Network**.
  id: totrans-136
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**网络**。
- en: 3\. Select the Ethernet connection between your pfSense device and your computer,
    and then set the Configure IPv4 drop-down box to **Manually**.
  id: totrans-137
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择连接在pfSense设备和计算机之间的以太网连接，然后将配置IPv4下拉框设置为**手动**。
- en: 4\. Enter **192.168.1.2** into the IP Address field, set Subnet Mask to **255.255.255.0**,
    and enter **192.168.1.1** into the Router field.
  id: totrans-138
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在IP地址字段中输入**192.168.1.2**，将子网掩码设置为**255.255.255.0**，并在路由器字段中输入**192.168.1.1**。
- en: 5\. Click **Apply**.
  id: totrans-139
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**应用**。
- en: 6\. Open your web browser and browse to 192.168.1.1\. You should be presented
    with the pfSense login page.
  id: totrans-140
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开您的网页浏览器并访问192.168.1.1。您应该会看到pfSense登录页面。
- en: Windows
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: Windows
- en: 1\. Open **Network and Internet Settings**.
  id: totrans-142
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开**网络和互联网设置**。
- en: 2\. Click **Change Adapter Options**.
  id: totrans-143
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**更改适配器选项**。
- en: 3\. Open the Ethernet connection between your pfSense device and your computer,
    and then click **Properties▸Internet Protocol Version ▸ (TCP/IP)▸Properties**.
  id: totrans-144
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开pfSense设备和计算机之间的以太网连接，然后点击**属性▸互联网协议版本▸(TCP/IP)▸属性**。
- en: 4\. Select the **Use the following IP address** radio button.
  id: totrans-145
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择**使用以下IP地址**单选按钮。
- en: 5\. Enter **192.168.1.2** into the IP Address field, set Subnet Mask to **255.255.255.0**,
    and enter **192.168.1.1** into the Default Gateway field.
  id: totrans-146
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在IP地址字段中输入**192.168.1.2**，将子网掩码设置为**255.255.255.0**，并在默认网关字段中输入**192.168.1.1**。
- en: 6\. Click **OK** and close the remaining windows.
  id: totrans-147
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**确定**并关闭剩余的窗口。
- en: 7\. Open your web browser and browse to 192.168.1.1\. You should be presented
    with the pfSense login page.
  id: totrans-148
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开您的网页浏览器并访问192.168.1.1。您应该会看到pfSense登录页面。
- en: Linux
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: Linux
- en: 1\. Open **Settings**.
  id: totrans-150
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开**设置**。
- en: 2\. Click **Network**.
  id: totrans-151
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**网络**。
- en: 3\. On the Ethernet connection between your pfSense device and your computer,
    click the configure **Cog**.
  id: totrans-152
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在pfSense设备和计算机之间的以太网连接上，点击配置**齿轮图标**。
- en: 4\. Select the **IPv4** tab.
  id: totrans-153
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择**IPv4**标签。
- en: 5\. Select the **Manual** radio button.
  id: totrans-154
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择**手动**单选按钮。
- en: 6\. Enter **192.168.1.2** into the IP Address field, set Netmask to **255.255.255.0**,
    and enter **192.168.1.1** into the Gateway field.
  id: totrans-155
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在IP地址字段中输入**192.168.1.2**，将网络掩码设置为**255.255.255.0**，并在网关字段中输入**192.168.1.1**。
- en: 7\. Click **Apply** and close the Settings windows.
  id: totrans-156
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**应用**并关闭设置窗口。
- en: 8\. Open your web browser and browse to 192.168.1.1\. You should be presented
    with the pfSense login page.
  id: totrans-157
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 打开您的网页浏览器并访问192.168.1.1。您应该会看到pfSense登录页面。
- en: Note If you receive a warning message indicating the site is not private or
    is unsafe, click through to the login page. This warning appears because there’s
    no SSL certificate configured, and you can ignore it for now. However, be wary
    of errors like this elsewhere; generally, an SSL certificate error (especially
    on the internet) is a serious warning that the page you’re trying to access is
    insecure.
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：如果您收到警告消息，表示该站点不安全或不私密，请点击继续到登录页面。此警告出现是因为没有配置SSL证书，您现在可以忽略它。不过，请留意类似的错误；通常，SSL证书错误（尤其是在互联网上）是一个严重的警告，表示您正在尝试访问的页面不安全。
- en: 'On the pfSense login page, log in with the credentials provided when you received
    your device. Once you’re logged in, accept the end-user license agreement (EULA)
    if one is presented. Take a moment to review the system information, and then
    click the **System** menu at the top of the page and start the **Setup Wizard**.
    Use the following steps to finish setting up pfSense:'
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 在pfSense登录页面，使用收到设备时提供的凭证进行登录。如果显示了最终用户许可协议（EULA），请接受它。花点时间查看系统信息，然后点击页面顶部的**系统**菜单并启动**设置向导**。使用以下步骤完成pfSense的设置：
- en: 1\. At the welcome screen, click **Next**.
  id: totrans-160
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在欢迎屏幕上点击**下一步**。
- en: 2\. If the Support screen is displayed, click **Next**.
  id: totrans-161
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 2\. 如果显示了支持屏幕，点击**下一步**。
- en: 3\. On the General Information screen, choose a hostname for the device, or
    leave it as the default, pfSense.
  id: totrans-162
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 3\. 在常规信息屏幕上，为设备选择一个主机名，或者保持默认值 pfSense。
- en: 4\. If you have a domain configured in your environment, enter it in the Domain
    field.
  id: totrans-163
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 4\. 如果您在环境中配置了域，请在“域”字段中输入它。
- en: 5\. Ignore the DNS settings for now and click **Next**.
  id: totrans-164
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 5\. 现在暂时忽略 DNS 设置，点击**下一步**。
- en: 6\. On the Time Server Information screen, accept the default Time server hostname,
    unless you have a time server in your environment, in which case enter its details
    here.
  id: totrans-165
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 6\. 在时间服务器信息屏幕上，接受默认的时间服务器主机名，除非您在环境中有时间服务器，在这种情况下，请在此输入其详细信息。
- en: 7\. Be sure to select the correct time zone, and then click **Next**.
  id: totrans-166
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 7\. 确保选择正确的时区，然后点击**下一步**。
- en: You should now see the Configure WAN Interface page. You can use this page to
    configure your pfSense appliance to connect to your internet service provider.
    We’ll cover the most common configuration here, called *PPPoE*, that will most
    likely match the settings in your current modem/router. If not, contact your internet
    service provider for the correct configuration details for your connection.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 现在您应该看到“配置 WAN 接口”页面。您可以使用此页面配置您的 pfSense 设备与互联网服务提供商连接。我们将在这里介绍最常见的配置，称为*PPPoE*，这可能与您当前的调制解调器/路由器设置相匹配。如果不匹配，请联系您的互联网服务提供商以获取正确的连接配置详情。
- en: 8\. In the SelectedType box, select **PPPoE**.
  id: totrans-168
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 8\. 在“选择类型”框中，选择**PPPoE**。
- en: 9\. Skip the General configuration options to accept the default settings.
  id: totrans-169
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 9\. 跳过常规配置选项，接受默认设置。
- en: 10\. Static IP Configuration and DHCP client configuration should be grayed
    out, so move on to PPPoE configuration.
  id: totrans-170
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 10\. 静态 IP 配置和 DHCP 客户端配置应被禁用，因此请继续进行 PPPoE 配置。
- en: 11\. Enter the username and password provided to you by your internet service
    provider.
  id: totrans-171
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 11\. 输入由您的互联网服务提供商提供的用户名和密码。
- en: 12\. Accept all other settings as default and click **Next**.
  id: totrans-172
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 12\. 接受所有其他默认设置并点击**下一步**。
- en: 13\. Set the LAN IP address of the pfSense appliance. You can choose to keep
    the IP addressing scheme you identified in [Chapter 1](nsp-enoka501485-0010.xhtml#ch01)
    by giving this device the first IP in the address range (192.168.1.1 in the case
    of an address scheme of 192.168.0.0/16), or you can change it by specifying a
    different LAN IP address on this page. If you’d like addresses in the 10.0.0.0/8
    range, specify 10.0.0.1, and so on. Then click **Next**.
  id: totrans-173
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 13\. 设置 pfSense 设备的 LAN IP 地址。您可以选择保持在[第1章](nsp-enoka501485-0010.xhtml#ch01)中确定的
    IP 地址方案，给此设备分配地址范围中的第一个 IP（例如，在 192.168.0.0/16 地址方案中是 192.168.1.1），或者您也可以通过在此页面上指定不同的
    LAN IP 地址来更改它。如果您希望使用 10.0.0.0/8 范围的地址，可以指定 10.0.0.1，以此类推。然后点击**下一步**。
- en: 14\. Change the administrator password. Be sure to select a strong passphrase
    at least 12 characters in length or longer, and save it in a password safe (we’ll
    discuss this further in [Chapter 11](nsp-enoka501485-0020.xhtml#ch11)). Once done,
    click **Next▸Reload▸Finish**.
  id: totrans-174
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 14\. 更改管理员密码。请务必选择一个至少12个字符或更长的强密码，并将其保存在密码管理工具中（我们将在[第11章](nsp-enoka501485-0020.xhtml#ch11)中进一步讨论）。完成后，点击**下一步▸重新加载▸完成**。
- en: Your initial configuration is now complete. Assuming the device has been able
    to connect to your internet service provider with your credentials, you should
    be able to browse the internet. If not, you may have to do some troubleshooting.
    The best place for troubleshooting any issues is in the System Logs page within
    the Status menu at the top of the web interface. With any luck, any issues will
    become evident once you’ve looked over the logs. If you’re sure you entered all
    of the configuration details correctly, reach out to your internet service provider
    to ensure your settings are correct.
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 您的初始配置现已完成。假设设备已经凭借您的凭证成功连接到您的互联网服务提供商，您应该能够浏览互联网。如果无法连接，可能需要进行故障排除。进行故障排除的最佳地方是在
    Web 界面顶部的“状态”菜单中的系统日志页面。运气好的话，查看日志后，任何问题都会显现出来。如果您确认输入了所有配置详情，联系您的互联网服务提供商以确保您的设置正确。
- en: '[Hardening pfSense](nsp-enoka501485-0007.xhtml#rbh0504)'
  id: totrans-176
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '[加固 pfSense](nsp-enoka501485-0007.xhtml#rbh0504)'
- en: Your firewall is now configured and running, and it should already do a brilliant
    job of rejecting unsolicited traffic attempting to enter your network. However,
    you can take additional steps to ensure your device and network are even more
    secure.
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 您的防火墙现在已配置并正在运行，它应该能够有效地拒绝未经请求的流量进入您的网络。然而，您可以采取额外的措施，确保您的设备和网络更加安全。
- en: While logged in to your pfSense device, click **System▸Advanced**.
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 登录到您的pfSense设备后，点击**系统▸高级**。
- en: '![A screenshot showing the Advanced tab user interface where you can enter
    the SSL/TSL Certificate and TCP port.](images/nsp-enoka501485-fig0302.jpg)'
  id: totrans-179
  prefs: []
  type: TYPE_IMG
  zh: '![显示高级选项卡用户界面的截图，您可以在此输入SSL/TSL证书和TCP端口。](images/nsp-enoka501485-fig0302.jpg)'
- en: 'Figure 3-2: Advanced pfSense menu'
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 图3-2：高级 pfSense 菜单
- en: In the Advanced menu tabs, you can change the protocols, ports, and proxy settings
    that pfSense uses, among other things. Click **Save** before leaving a tab if
    you change any settings.
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 在高级菜单选项卡中，您可以更改pfSense使用的协议、端口和代理设置等。如果更改任何设置，请在离开选项卡之前点击**保存**。
- en: In the Admin Access tab shown in [Figure 3-2](nsp-enoka501485-0012.xhtml#fig0302),
    set webConfigurator Protocol to **HTTPS** to ensure a secure, encrypted connection
    to the device. It’s always preferable to use HTTPS instead of the unencrypted
    HTTP protocol because the added encryption ensures that, even if the network traffic
    is intercepted by an adversary, the adversary can’t decrypt it.
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 在[图3-2](nsp-enoka501485-0012.xhtml#fig0302)所示的管理员访问选项卡中，将webConfigurator协议设置为**HTTPS**，以确保与设备的安全加密连接。总是优先使用HTTPS而不是未加密的HTTP协议，因为添加的加密确保即使网络流量被攻击者拦截，攻击者也无法解密它。
- en: In the next section of the Admin Access page (not shown in [Figure 3-2](nsp-enoka501485-0012.xhtml#fig0302)),
    you can change the SSH options. I recommend not allowing SSH access to the device
    all the time—that would be similar to leaving your front door unlocked at night.
    If you allow SSH access only while you’re actively using it, adversaries are able
    to attempt to access your network this way only while the service is available.
    Having the service turned off 99 percent of the time means attackers have only
    1 percent of the time to attempt to breach the network. Disable this option unless
    you’re actively connecting to the device via SSH. Once these settings have been
    updated, click **Save**.
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 在管理员访问页面的下一部分（未在[图3-2](nsp-enoka501485-0012.xhtml#fig0302)中显示），您可以更改SSH选项。我建议不要一直允许SSH访问设备——那就像晚上把前门锁忘了。如果您只在主动使用时才允许SSH访问，那么只有在该服务可用时，攻击者才能尝试访问您的网络。大部分时间禁用该服务意味着攻击者只有1%的时间可以尝试入侵网络。除非您正在通过SSH连接设备，否则请禁用此选项。更新这些设置后，点击**保存**。
- en: On the Networking tab, you can enable or disable IPv6 traffic. If you’re not
    actively using IPv6, disable it here to reduce your attack surface. Doing so should
    make the remaining settings on this page moot.
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: 在网络选项卡中，您可以启用或禁用IPv6流量。如果您没有积极使用IPv6，请在此处禁用它，以减少攻击面。这样做应该会让页面上的其他设置变得不重要。
- en: If you’re using a proxy for your web traffic, enter your proxy details in the
    Miscellaneous tab. If you’re planning to build your own proxy server using the
    steps detailed in [Chapter 6](nsp-enoka501485-0015.xhtml#ch06), revisit this chapter
    and enter the proxy details at that stage.
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您使用代理服务器来处理网页流量，请在杂项选项卡中输入您的代理详细信息。如果您计划按照[第6章](nsp-enoka501485-0015.xhtml#ch06)中详细的步骤构建自己的代理服务器，请返回此章节，并在那个阶段输入代理详细信息。
- en: '[pfSense Firewall Rules](nsp-enoka501485-0007.xhtml#rbh0505)'
  id: totrans-186
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '[pfSense 防火墙规则](nsp-enoka501485-0007.xhtml#rbh0505)'
- en: 'The default pfSense firewall rules will block traffic from both RFC1918 private
    network connections and *bogon networks* from entering your network from the internet.
    RFC1918 addresses, discussed in [Chapter 1](nsp-enoka501485-0010.xhtml#ch01),
    are IP address ranges reserved for private, internal network use only, meaning
    addresses in these ranges should not appear on the public internet. They include
    the following ranges: 192.168.0.0/16, 10.0.0.0/8, and 172.16.0.0/12\. If any of
    these happen to appear on the internet, your firewall should find this suspicious
    and discard that traffic. Similarly, bogon networks or bogon addresses are those
    that are public but haven’t been assigned to anyone by IANA. If an as-yet-unassigned
    address or address range is sending your network traffic, this is also suspicious,
    and the firewall should discard it.'
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 默认的 pfSense 防火墙规则会阻止来自RFC1918私有网络连接和*bogon网络*的流量进入您的网络。RFC1918地址在[第1章](nsp-enoka501485-0010.xhtml#ch01)中讨论，是仅供私有内部网络使用的IP地址范围，意味着这些范围内的地址不应出现在公共互联网中。它们包括以下范围：192.168.0.0/16、10.0.0.0/8和172.16.0.0/12。如果这些地址出现在互联网上，您的防火墙应视为可疑并丢弃这些流量。同样，bogon网络或bogon地址是那些公共的但尚未由IANA分配给任何人的地址。如果尚未分配的地址或地址范围发送网络流量，这也是可疑的，防火墙应丢弃这些流量。
- en: While the default firewall rules are a good start, you should add a few rules
    manually to provide a higher level of security. For example, you shouldn’t allow
    services such as *Server Message Block (SMB)*, the service that allows Windows
    computers to share files across a network, to send or receive outbound or inbound
    traffic from your network to the internet or receive inbound traffic from the
    internet.
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管默认的防火墙规则是一个不错的起点，但你应该手动添加一些规则，以提供更高的安全性。例如，你不应该允许像*服务器消息块（SMB）*这样的服务，它允许Windows计算机在网络上共享文件，发送或接收来自你网络到互联网的出站或入站流量，或者从互联网接收入站流量。
- en: Note The WannaCry ransomware of May 2017 spread using an SMB vulnerability known
    as EternalBlue; blocking SMB at your perimeter firewall significantly reduces
    your risk of exposure to this vulnerability and the risk of other vulnerabilities
    like it being used to compromise your network.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 注意：2017年5月的WannaCry勒索病毒通过一个名为EternalBlue的SMB漏洞传播；在你的边界防火墙阻止SMB流量能显著减少你暴露于此漏洞的风险，并降低其他类似漏洞被用来危害你网络的风险。
- en: 'To add a rule that blocks SMB traffic, follow these steps:'
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 要添加一个阻止SMB流量的规则，请按照以下步骤操作：
- en: 1\. In pfSense, at the top of the page, click **Firewall▸Rules**.
  id: totrans-191
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 1\. 在pfSense中，在页面顶部点击**防火墙▸规则**。
- en: 2\. Click **LAN▸Add** to begin adding a rule.
  id: totrans-192
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 2\. 点击**LAN▸添加**开始添加规则。
- en: 3\. Set the action to either **block** (drop the packets) or **reject** (drop
    the packets and notify the sender).
  id: totrans-193
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 3\. 将动作设置为**阻止**（丢弃数据包）或**拒绝**（丢弃数据包并通知发送者）。
- en: 4\. Set Address Family to **IPv4** and Protocol to **TCP**.
  id: totrans-194
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 4\. 将地址族设置为**IPv4**，协议设置为**TCP**。
- en: 5\. Set Source to **Any**, Destination to **Any**, and Destination Port Range
    (to and from) to **(other) 445**.
  id: totrans-195
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 5\. 将源设置为**任何**，目标设置为**任何**，目标端口范围（到和从）设置为**(其他) 445**。
- en: 6\. Ensure the **Log** box is ticked to log any dropped packets, and then click **Save**.
  id: totrans-196
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 6\. 确保勾选**日志**框以记录任何丢弃的数据包，然后点击**保存**。
- en: Once you’re done, your firewall should no longer allow SMB traffic to pass your
    network boundary. Follow this same process for ports 137, 138, and 139, as these
    services (NetBIOS Name Resolution, NetBIOS Datagram Service, and NetBIOS Session
    Service) should never be allowed to cross the network boundary either, as all
    of these protocols are used for processes internal to a local network.
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: 完成后，你的防火墙不再允许SMB流量通过网络边界。按照相同的步骤操作端口137、138和139，因为这些服务（NetBIOS名称解析、NetBIOS数据报服务和NetBIOS会话服务）也不应允许跨越网络边界，因为所有这些协议都是用于本地网络内部的过程。
- en: '[#14: Testing Your Firewall](nsp-enoka501485-0007.xhtml#rhd0503)'
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: '[#14: 测试你的防火墙](nsp-enoka501485-0007.xhtml#rhd0503)'
- en: With one or more of these rules in place, test the firewall to ensure the blocked
    traffic is actually being blocked. The best tool for this purpose is *Nmap*, which
    is used for network scanning or network mapping. It’s available in GUI form on
    Windows, Linux, and Mac (called *Zenmap*) and also as a command line tool. Installing
    the GUI version will make it available on the command line, so download and install
    the latest version from [https://www.nmap.org/](https://www.nmap.org/).
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 设置一个或多个规则后，测试防火墙以确保被阻止的流量确实被拦截。最好的工具是*Nmap*，它用于网络扫描或网络映射。在Windows、Linux和Mac上都有GUI版本（称为*Zenmap*），也可以作为命令行工具使用。安装GUI版本后，它也会在命令行上可用，因此请从[https://www.nmap.org/](https://www.nmap.org/)下载并安装最新版本。
- en: 'Otherwise, you can install it using the command line on Ubuntu:'
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 否则，你可以在Ubuntu上通过命令行安装：
- en: '[PRE22]'
  id: totrans-201
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'Once you’ve installed Nmap, use the following command to scan port 445 from
    the command line, which we’ve told the firewall to block:'
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: 安装完Nmap后，使用以下命令从命令行扫描445端口，这是我们告诉防火墙要阻止的端口：
- en: '[PRE23]'
  id: totrans-203
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: You can use the same command in the Zenmap GUI—just exclude `sudo`. This command
    will perform a port scan from your device, which is behind your firewall, on the
    [http://scanme.nmap.org/](http://scanme.nmap.org/) website, a public web page
    available for testing purposes from the creators of Nmap.
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在Zenmap GUI中使用相同的命令—只需排除`sudo`。此命令将从你设备的防火墙后面执行端口扫描，扫描目标网站[http://scanme.nmap.org/](http://scanme.nmap.org/)，这是一个由Nmap创建者提供的公共网页，用于测试目的。
- en: 'The command breaks down like this: `nmap` is the name of the program. The `-p
    445` argument specifies the port or ports to be scanned, which can be either a
    comma-separated list (such as `-p 445,137,138,22`), a specific port as shown,
    or a port range like `-p1-1024`. The `-A` argument tells Nmap to try to identify
    the service and operating system on each scanned port, and `scanme.nmap.org` is
    the website or system to scan. If the results come back and the `STATE` shown
    for the port is `filtered`, the firewall has blocked the traffic, and the firewall
    rules are working. If the `STATE` shows `closed`, the firewall is allowing the
    traffic through, and the website itself, rather than the firewall, was returning
    a response saying the port is closed. If you receive this result, your firewall
    rule either isn’t configured or isn’t working.'
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: 该命令分解如下：`nmap` 是程序的名称。`-p 445` 参数指定要扫描的端口，可以是逗号分隔的端口列表（如 `-p 445,137,138,22`）、特定端口（如所示）或端口范围（如
    `-p1-1024`）。`-A` 参数告诉 Nmap 尝试识别每个扫描端口上的服务和操作系统，而 `scanme.nmap.org` 是要扫描的网站或系统。如果结果返回并且端口的
    `STATE` 显示为 `filtered`，则说明防火墙已阻止该流量，防火墙规则正常工作。如果 `STATE` 显示为 `closed`，则表示防火墙允许流量通过，且是网站本身而不是防火墙返回的响应，表示端口已关闭。如果收到此结果，则说明你的防火墙规则没有配置或没有生效。
- en: Once your rules are working, go to the firewall logs to see the blocked packets.
    In pfSense, at the top of the page, click **Status▸System Logs▸Firewall** to see
    the last 500 entries in the firewall log, as shown in [Figure 3-3](nsp-enoka501485-0012.xhtml#fig0303).
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦你的规则生效，进入防火墙日志查看被阻止的数据包。在 pfSense 中，点击页面顶部的**状态▸系统日志▸防火墙**，可以查看防火墙日志中的最后 500
    条记录，如[图 3-3](nsp-enoka501485-0012.xhtml#fig0303)所示。
- en: '![The pfSense Firewall Log includes the following information for each entry:
    Action, Time, Interface, Rule, Source, Destination, and Protocol.](images/nsp-enoka501485-fig0303.jpg)'
  id: totrans-207
  prefs: []
  type: TYPE_IMG
  zh: '![pfSense 防火墙日志包含每条记录的以下信息：动作、时间、接口、规则、源、目的地和协议。](images/nsp-enoka501485-fig0303.jpg)'
- en: 'Figure 3-3: pfSense firewall log'
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3-3：pfSense 防火墙日志
- en: In all likelihood, you’ll see a lot of blocked traffic. At this stage, it’s
    difficult to know what this blocked traffic could be. As an example, one of the
    entries at the top of my log shows a blocked connection from the IP address 80.82.77.245
    on port 46732.
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 很可能，你会看到大量被阻止的流量。在这个阶段，很难知道这些被阻止的流量是什么。举个例子，我日志顶部的一个条目显示了来自 IP 地址 80.82.77.245
    的连接在端口 46732 被阻止。
- en: Upon further investigation, it appears as though this is a service that performs
    regular network scans of public IP addresses for “research purposes.” That said,
    it could be anything; how do I know whether this “research” is legitimate or an
    adversary attempting to find holes in my firewall to penetrate my network? In
    most cases, it’s impossible to know, but at least my firewall is actively blocking
    this activity, and I can find it in the firewall logs if I need to review it and
    act on it. We’ll discuss what you can do with this information in greater detail
    in [Chapter 10](nsp-enoka501485-0019.xhtml#ch10), which covers network security
    monitoring.
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: 经过进一步调查，似乎这是一个为“研究目的”定期扫描公共 IP 地址的服务。也就是说，它可能是什么都不确定；我怎么知道这个“研究”是否合法，还是有敌人试图找到我防火墙中的漏洞来渗透我的网络呢？在大多数情况下，无法知道，但至少我的防火墙在积极地阻止这种活动，如果需要，我可以在防火墙日志中找到它，回顾并采取行动。我们将在[第
    10 章](nsp-enoka501485-0019.xhtml#ch10)中详细讨论如何处理这些信息，内容包括网络安全监控。
- en: '[Summary](nsp-enoka501485-0007.xhtml#rah0504)'
  id: totrans-211
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: '[总结](nsp-enoka501485-0007.xhtml#rah0504)'
- en: Your network and hosts are demonstrably more secure for having host- and network-based
    firewalls in place. In the projects for this chapter, you’ve created rules and
    rulesets to make it significantly more difficult for an adversary trying to infiltrate
    your network, and even more challenging to do so undetected.
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: 你的网络和主机由于有主机和网络级别的防火墙而显著更加安全。在本章的项目中，你已经创建了规则和规则集，使得敌人更难渗透你的网络，甚至更难做到不被发现。
- en: While this chapter has armed you with the fundamentals and a greater understanding
    of firewalls, it’s in your best interest to further research the ports and protocols
    you’d like to allow or deny within, as well as into and out of, your network.
    Every network will be different and have different requirements.
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然本章已经为你提供了防火墙的基础知识和更深的理解，但为了你的利益，建议进一步研究你希望在网络内、进出网络时允许或拒绝的端口和协议。每个网络都会有所不同，具有不同的需求。
