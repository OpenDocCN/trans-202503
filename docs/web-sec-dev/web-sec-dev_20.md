# 第十八章：**总结**

![image](img/common01.jpg)

到此为止，我们已经走到了书的结尾！我们覆盖了很多内容，但现在你应该感觉已经准备好以安全、可靠的方式构建网站。

让我们用一个简短的回顾来结束。本章介绍了 21 条网络安全法则，帮助你记住每章的关键教训。遵循这些简单步骤，你被黑客攻击的可能性将接近于零。

**自动化你的发布过程**

能够通过单个命令行调用构建你的代码。将代码保存在源代码控制中，并决定一个分支策略。将配置与代码分离，以便轻松构建测试环境。使用测试环境在每次发布前验证功能。自动化代码的部署到各个环境。确保你的发布过程是可靠的、可重现的和可回滚的。始终知道每个环境中运行的是哪个版本的代码，并能够以简单的方式回滚到先前的版本。

**进行（彻底的）代码审查**

确保每个代码更改在批准发布之前都经过至少一个非原作者团队成员的审查。确保团队成员有时间对代码更改进行批判性评估，并理解审查代码与编写代码同样重要。

**测试你的代码（直到无聊）**

编写单元测试以确保你代码库中关键部分的正确性，并将它们作为构建过程的一部分运行。每次修改代码时，都在持续集成服务器上运行单元测试。测量单元测试运行时执行的代码库百分比，并始终努力提高这个覆盖率数字。编写测试以在修复 bug *之前* 复现软件 bug。测试直到恐惧变成无聊！

**预防恶意输入**

HTTP 请求的所有部分都可能被黑客篡改，所以要做好准备。通过使用参数化语句构造数据库和操作系统的查询，这样可以防止注入攻击。

**中和文件上传**

如果用户可以向你的网站上传文件，确保这些文件不能被执行。理想情况下，将文件上传到内容分发网络（CDN）。如果需要更细粒度的文件权限，将它们托管在内容管理系统（CMS）中。作为最后手段，将上传的文件保存在单独的磁盘分区，并确保它们不以可执行权限写入磁盘。

**编写 HTML 时转义内容**

攻击者将试图通过将恶意 JavaScript 注入你的网页，或通过将 JavaScript 藏在数据库或 HTTP 参数中来进行攻击。确保写入网页的任何动态内容都进行了转义——用安全的实体编码替换 HTML 控制字符。这适用于客户端和服务器端！如果可能，通过使用 `Content-Security-Policy` 响应头禁用内联 JavaScript 的执行。

**对来自其他网站的 HTTP 请求保持怀疑**

来自其他域的 HTTP 请求可能是恶意的——例如，攻击者可能已经诱使您的某个用户点击了一个伪装的链接。确保向您的网站发送的`GET`请求不会有副作用：它们应仅用于检索资源。确保其他类型的请求（如用于发起登录的`POST`请求）来自您的网站，通过在 HTML 表单和任何由 JavaScript 发起的 HTTP 请求中加入反伪造 cookie 来实现。通过向`Set-Cookie`HTTP 响应头添加`SameSite`属性，剥离来自您网站域外请求的 cookie。

**对密码进行哈希和加盐**

如果您在数据库中存储密码，请使用强大的一次性哈希函数（如`bcrypt`）对其进行加密后再保存。通过添加盐值来为每个哈希增加随机性。

**不要泄露用户身份**

唯一应该知道用户是否注册了您网站的人是用户自己。确保登录表单和密码重置页面不会允许黑客挖掘您的网站以获取用户列表：保持错误和信息消息的通用性，无论用户名是否存在。

**保护您的 cookie**

如果攻击者能够窃取您的 cookie，他们就可以劫持用户身份。为您的`Set-Cookie`响应头添加`HttpOnly`关键字，以防止恶意 JavaScript 读取 cookie。添加`Secure`关键字，确保 cookie 只通过 HTTPS 发送。

**保护敏感资源（即使您没有链接到它们）**

在返回敏感资源的 HTTP 请求之前，检查用户是否有权限访问该资源——即使该资源没有出现在搜索页面或没有从其他地方链接到。

**避免使用直接的文件引用**

避免在 HTTP 请求中传递和评估文件路径。使用您网站服务器内建的 URL 解析来评估资源路径，或者通过不透明的标识符引用文件。

**不要泄露信息**

尽量减少攻击者能够了解您技术栈的信息。关闭 HTTP 响应中的任何`Server`头部，确保`Set-Cookie`头中的会话参数名称是通用的。避免在 URL 中出现明显的文件后缀。确保在生产环境中关闭详细的客户端错误报告。在构建过程中，对您使用的 JavaScript 库进行混淆处理。

**正确使用加密**

为您的域名购买安全证书并将其与您的私钥一起安装到 Web 服务器上。将所有流量重定向到 HTTPS，并为`Set-Cookie`响应头添加`Secure`关键字，确保 cookie 不会通过未加密的 HTTP 发送。定期更新您的 Web 服务器，以保持加密标准的最新。

**保护您的依赖项（和服务）**

使用包管理器在构建过程中导入第三方代码，并将每个包固定到特定的版本号。保持对所用包的安全公告的关注，并定期更新它们。安全地存储配置—不要存储在源代码控制中！对于您托管的任何广告，使用 SafeFrame 标准。

**防止 XML 解析器的攻击**

关闭 XML 解析器中对内联文档类型声明的处理。

**安全地发送电子邮件**

通过在您的域名记录中使用发件人策略框架（SPF）记录，白名单指定哪些服务器被允许从您的域发送电子邮件。允许邮件接收者验证您发送的电子邮件的`发件人`地址，并通过使用域名密钥识别邮件（DKIM）检测试图篡改电子邮件的行为。

**检查您的重定向（如果有的话）**

如果您将用户重定向到存储在 HTTP 请求中的 URL—例如，用户登录后—请确保该 URL 是您域名内的本地地址，而不是外部网站。否则，这些开放重定向将被用来伪装恶意邮件中的链接。

**不要允许您的网站被框架嵌套**

除非有特定需求，否则不要允许将您的网站嵌套在`<iframe>`中。通过将`Content-Security-Policy: frame-ancestors 'none'`添加到您的 HTTP 响应中，禁用框架。

**锁定您的权限**

遵循最小权限原则—确保每个进程和软件组件以所需的最小权限运行。考虑如果攻击者侵入您系统的任何部分，他们可能会尝试做什么，并减轻危害。确保您的 Web 服务器进程不是以根操作系统账户运行。限制 Web 服务器可以访问的磁盘目录。防止 Web 服务器发起不必要的网络请求。让您的 Web 服务器以一个具有有限权限的账户连接到数据库。

**检测并为流量激增做好准备**

使用实时监控来检测网站的高流量。通过使用 CDN、客户端 cookie、缓存和异步处理来构建可扩展性。能够轻松地扩展托管网站的服务器数量。如果恶意流量成为问题，可以部署防火墙或入侵防御系统，或者考虑注册分布式拒绝服务（DDoS）保护。
