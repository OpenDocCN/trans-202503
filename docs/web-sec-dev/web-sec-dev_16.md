# 第十四章：**第三方代码**

![image](img/common01.jpg)

如今没有人会从头开始编写软件，尤其是 web 开发人员。支持你网站的大部分代码——从操作系统到 web 服务器，再到你使用的编程语言库——都是由其他人编写的。那么，你该如何管理别人代码中的漏洞呢？

黑客通常针对流行软件组件中的已知漏洞，因此确保第三方代码的安全至关重要。例如，黑客扫描互联网上的不安全 WordPress 实例比挑选一个特定的网站并尝试找出其潜在漏洞要高效得多。因此，保持最新的安全补丁非常重要，以避免被恶意扫描程序发现。

本章讨论了三种确保第三方代码安全的方法。你将了解如何跟进关于你*依赖项*（你使用的软件组件）的安全通告。接下来，你将深入了解如何*配置*这些依赖项，以确保它们不会无意中留下黑客可以利用的后门。最后，你将看到与第三方*服务*相关的安全风险——这些代码运行在他人的服务器上，要么被你的 web 服务器调用，要么通过 JavaScript 导入加载到你的网页中。特别是，你将关注通过广告网络部署恶意软件的普遍策略——即所谓的*恶意广告*——并检查如果你的网站包含广告，如何保护你的用户。

### 确保依赖项的安全

2014 年 4 月，OpenSSL 的作者，实施大多数 Linux 版本（以及其他操作系统）TLS 的开源 C 库，披露了 Heartbleed 漏洞的存在：利用缓冲区过度读取，攻击者可以从使用该易受攻击库的服务器中读取任意内存块，从而窃取加密密钥、用户名、密码以及其他敏感数据。互联网上最流行的两个 web 服务器——Apache 和 Nginx——都使用 OpenSSL 来保护通信，安全公司 AVG 的研究人员估计，超过五十万个网站在一夜之间暴露出漏洞。由于受影响网站数量庞大，Heartbleed 漏洞被称为有史以来最危险的漏洞。

修复了漏洞的新版本 OpenSSL 在漏洞披露的同一天发布，但未修复的 web 服务器在此后几个月仍然在互联网上很常见。这是一个运行未修补 web 服务器的危险时期：黑客有足够的时间寻找最有效的漏洞利用方法，而且随着易受攻击网站数量的减少，剩余的 web 服务器成了更可能的攻击目标。

所有网站都使用第三方代码，所有第三方库——即使是由安全专家编写的库，如 OpenSSL——也可能存在安全问题。如果你想领先于这些漏洞，你需要在漏洞公开后立即了解并及时修补软件。这涉及三个方面：准确知道你正在运行的依赖项，能够快速更新依赖项，并时刻关注依赖项的安全问题。我们将逐一讨论每个方面。

#### *了解你正在运行的代码*

确保你的依赖项的第一步是知道它们是什么。这听起来可能很显而易见，但现代软件栈复杂且多层次，使得在软件开发生命周期的开发阶段很容易添加新的库，而这些库之后可能会被遗忘。你应该使用许多工具来组织你的依赖项。

##### 依赖管理工具

大多数编程语言都带有一个*依赖管理器*，允许开发团队在配置文件中指定第三方依赖项。这些软件库将在构建过程中按需下载。依赖管理器使得获取新的依赖项以及在新环境中重建软件栈变得简单——例如，当你部署到服务器时。

为了确保你知道每个依赖项的版本，你应该养成在依赖列表中为每个依赖项指定明确的*版本号*的习惯。在依赖管理系统中提供的包都托管在互联网的远程仓库中。当包的作者发布新版本时，它们会以新版本号被添加到仓库中。默认情况下，大多数依赖管理器在你首次在新环境中运行构建时会获取每个依赖项的最新版本。这种默认行为在初期开发时是合理的，但等到你发布代码时，依赖配置文件应当明确列出版本号。安全通告将披露哪些版本的依赖项存在漏洞，因此固定你在每个环境中运行的版本将告诉你需要修补的内容。

还要注意，你声明的依赖项可能本身也有依赖项——而你的依赖管理器将会帮助你自动获取这些库。因此，我们提到*依赖树*，因为每个依赖项都有其他依赖项作为分支。评估安全风险时，确保考虑*整个*依赖树。你的依赖管理器可以在命令行中输出整个树（包括依赖项的依赖项）。列表 14-1 展示了一个 Node.js 项目的依赖树，说明了`@blueprintjs/core`库将`popper.js`库作为子依赖项。

```
my_project@0.0.0 /usr/code/my_project
├─┬ @blueprintjs/core@3.10.0
│ ├─┬ @blueprintjs/icons@3.4.0
│ │ ├── classnames@2.2.6 deduped
│ │ └── tslib@1.9.3 deduped
│ ├── @types/dom4@2.0.1
│ ├── classnames@2.2.6 deduped
│ ├── dom4@2.1.4
│ ├── normalize.css@8.0.1
│ ├── popper.js@1.14.6
│ ├── react-popper@1.3.3 deduped
```

*Listing 14-1：命令 npm list 显示 Node Package Manager 中的整个依赖树。*

##### 操作系统补丁

除了跟踪编程语言的依赖项外，你还需要跟踪操作系统级别上部署的软件包。操作系统供应商（例如，Red Hat 和 Microsoft）经常发布安全补丁，因此你应该跟踪在任何给定环境中使用的每个操作系统库的版本，并有一个及时升级服务器的策略。如果你在数据中心运行物理服务器，你的公司可能有专门的系统管理员来处理此事。如果你在云端（例如，在 Amazon EC2 上）运行软件，应该定期更新操作系统的版本作为部署的一部分。使用 Docker 进行容器化也是跟踪操作系统依赖项的一个好方法，因为 Docker 配置文件会明确列出容器实例化时要安装的软件。

##### 完整性检查

最后一个考虑因素：你需要确保你*认为*自己正在运行的代码就是你*实际*运行的代码。依赖管理工具和补丁工具在这里会有所帮助。它们通过使用*校验和*—在依赖项上传到仓库时计算的数字指纹，并且在下载并使用依赖项时重新计算并验证—来确保软件组件未被篡改。你应该力求在将 JavaScript 代码和其他资源部署到浏览器时提供相同的保障。

现代浏览器允许你通过在 HTML 中的 `<script>` 和 `<style>` 标签中添加 *子资源完整性检查* 来实现这一点。你的构建过程应该为你打算在客户端导入的每个资源文件生成一个校验和，并将该校验和分配给每个导入标签的 `integrity` 属性。Listing 14-2 显示了如何使用 `openssl` 工具生成校验和。

```
cat FILENAME.js | openssl dgst -sha384 -binary | openssl base64 -A
```

*Listing 14-2：在 Unix 中生成校验和，将 JavaScript 文件* FILENAME.js *通过管道传输到 openssl 以生成摘要并将其编码为 Base64。*

浏览器将在执行导入的代码之前，将脚本与预期的校验和进行比较，并验证是否匹配。这使得黑客更难在获得服务器访问权限后用恶意代码替换 JavaScript 文件，因为他们还必须获得并修改生成 `<script>` 标签的代码，如 Listing 14-3 中所示。

```
<script src="https://example.com/example-framework.js"
        integrity="sha384-oqVuAfXRKap7fdgcCY5uykM6+R9GqQ8K/uxy9rx7HNQlG"
        crossorigin="anonymous"></script>
```

*Listing 14-3：通过计算文件的校验和并将其添加到导入脚本的 HTML 标签的完整性属性中，确保导入的 JavaScript 文件的完整性。*

#### *能够快速部署新版本*

应对安全问题需要你能够迅速部署补丁，这就意味着你需要有一个有序且脚本化的发布流程。第五章已经讲解了大部分内容：你的发布流程应该是可靠的、可复现的，并且可以回滚的，发布应该与源代码控制系统中的代码分支挂钩。你的依赖管理器使用的配置文件应该保存在源代码控制中，这样你就可以跟踪每个发布中部署了哪些版本的依赖。

你经常会单独部署第三方组件的安全补丁——升级*依赖*版本，而不需要发布任何自己的代码变更。即使发布仅包含第三方代码变更，你仍然需要对你的网站进行*回归测试*：换句话说，要确保升级后的依赖不会破坏网站上的任何现有功能。如果你的单元测试覆盖面广，回归测试就会变成一种形式化的操作。你的代码库中执行的代码行越多，你需要手动测试的工作就越少。在编写良好的单元测试上投入一些时间，将使得部署安全补丁更加迅速和简便。

#### *保持警觉，关注安全问题*

通过精心管理的依赖关系和可靠的发布流程，你就能确保你使用的第三方代码是安全的。最后一步是确保在安全问题披露时能够及时了解。感谢互联网，你有很多方法来跟进这些问题。

##### 社交媒体

安全公告会通过社交媒体和新闻网站迅速传播，例如 Twitter、Reddit 和 Hacker News (*[`news.ycombinator.com/`](https://news.ycombinator.com/)*), 所以这些网站是获取安全新闻的好途径。大型软件漏洞会在诸如* [`www.reddit.com/r/programming/`](https://www.reddit.com/r/programming/)* 和 */r/technology* 等 subreddit 中讨论，通常还会登上 Hacker News 的首页。

如果你有时间在 Twitter 上关注技术专家和软件作者，安全问题常常是当天的讨论话题。这也是跟进软件世界新发展的好方式。

##### 邮件列表和博客

编程语言通常会有邮件列表和频道，发布重要新闻。例如，Python 软件基金会每周发布新闻通讯，并且有自己的 Slack 频道。确保订阅与你的技术栈相关的所有信息。

有大量关于信息安全的博客。可以查看 Brian Krebs (*[`krebsonsecurity.com/`](https://krebsonsecurity.com/)*) 和 Bruce Schneier (*[`www.schneier.com/`](https://www.schneier.com/)*)，他们对当前安全问题有深入的评论。

##### 官方公告

注意来自托管服务商和软件供应商的安全警报。当像 Heartbleed 这样的重大安全问题发生时，托管公司会与客户合作并指导他们完成修补过程。如果你使用微软技术，微软会每周二发布新的安全补丁（*补丁星期二*），因此请确保订阅其新闻通讯。

##### 软件工具

除了保持对外界动向的关注，自动化工具还可以检查你的依赖项是否存在已知的漏洞。Node.js 在这方面处于领先地位，因为*Node 包管理器（NPM）*现在包含了`npm audit`命令，可以用来将你的依赖版本与开源漏洞数据库进行交叉检查。Ruby 的类似工具是`bundler-audit` gem；对于 Java 和 .NET，开放 Web 应用程序安全项目（OWASP）发布了一款命令行工具，名为`dependency-check`。将这些工具纳入到构建流程中，每当你的代码构建时，它们会提醒你潜在的漏洞，并帮助你评估每个漏洞的风险。

你的源代码库也可以提供帮助。GitHub 会自动扫描其网站上托管的代码，并在发现脆弱的依赖时发出安全警报。

#### *知道何时升级*

需要注意的是，并非所有的安全问题都需要优先处理！不断升级你的依赖项可能非常耗时，尤其是因为许多安全问题可能已被你系统中的其他因素所缓解。大公司通常有正式的流程来审核安全警报、评估优先级并选择适当的措施。只要你的团队已经评估了相关风险，完全可以在下一个预定的发布版本中加入次要的安全升级。

### 配置安全

软件的安全性取决于它的配置是否安全。特别是第三方软件，若你安装了一个新的数据库并使用默认的用户账户和密码进行运行，很快就会遇到问题。黑客经常扫描互联网，寻找使用默认设置的运行软件，因为他们知道许多站点所有者在安装软件时会忽略自定义配置。

如果你在使用未加固的配置运行软件，你可能会把这一点公之于众。信息安全咨询公司 Offensive Security 维护着谷歌黑客数据库，其中列出了你可以通过简单的谷歌搜索找到的不安全软件。谷歌搜索蜘蛛会彻底地索引网页，并提供一套强大的工具，以根据这些信息优化搜索。例如，搜索*index of /etc/certs*会列出数百万个公开其数字证书目录的网页服务器——这是一个严重的安全漏洞！

使用安全配置部署依赖项是防止被黑客攻击的关键。安全配置要求你用强密码设置服务，安全存储配置信息，并限制攻击者在获取环境某一部分的访问权限后能够造成的损害。让我们来看一下如何实现。

#### *禁用默认凭据*

许多软件包都带有默认的登录凭据，以便第一次使用的用户能够快速启动和运行。确保在将软件部署到测试或生产环境之前禁用这些凭据。例如，如果你的数据库、Web 服务器或内容管理系统部署时有一个`admin`帐户，它将很快被扫描互联网上漏洞软件的机器人检测到。

#### *禁用开放目录列表*

Web 服务器通常会过度共享。例如，较旧版本的 Apache web 服务器将 URL 路径映射到文件，并且如果 URL 中省略了文件名，它会友好地列出目录中包含的文件。*开放目录列表*邀请黑客探索你的文件系统，使他们能够搜索敏感数据文件和安全密钥。确保在 Web 服务器配置中禁用目录列表。清单 14-4 展示了如何在 Apache web 服务器中执行此操作。

```
<Directory /var/www/>
   Options Indexes FollowSymLinks
   AllowOverride None
   Require all granted
</Directory>
```

*清单 14-4：移除关键字 Indexes，以防止此 Apache 配置文件生成开放目录列表。*

#### *保护你的配置信息*

你的 Web 服务器配置可能包含敏感信息，如数据库凭据和 API 密钥。许多开发团队将配置文件存储在源代码控制中，以便简化部署。然而，考虑一下如果黑客获得了对源代码控制系统的访问权限，他们可能会做什么：这种类型的敏感信息正是黑客首先会搜索的内容。数据库凭据、API 密钥、私密加密密钥、证书以及其他敏感配置细节需要*外部存储*，而不是存放在源代码控制中。

一种常见的方法是在操作系统级别通过环境变量记录敏感配置，并在启动时让配置代码从这些环境变量中初始化自己。这些环境变量可以通过保存在服务器上的配置文件进行初始化。

另一种方法是使用专用的配置存储。亚马逊 Web Services（AWS）允许你在其 Systems Manager 参数存储中安全地存储配置。微软的服务器通常将凭据存储在 Active Directory 中，从而允许精细的权限控制。将配置存储在数据库表中也是一个选择，但你应该考虑，如果攻击者获得了数据库的访问权限，他们可能会如何升级攻击。（你的 Web 服务器还必须在加载其余配置之前访问数据库凭据！）

保护配置文件信息的一个可靠方法是将其以加密形式存储，使用如 AES-128 之类的算法进行加密。这意味着黑客必须同时破解你的配置数据*和*解密密钥，才能窃取你的凭据。只需记住，解密密钥应存储在与配置文件不同的位置，否则安全性将大打折扣。

#### *加固测试环境*

预生产环境通常安装与生产环境相同的软件，但安全性较差。如果你的测试环境包含敏感数据——例如，如果你曾经将生产环境的数据复制到测试环境中——你需要将测试环境配置为与生产环境一样安全。至关重要的是，生产和非生产环境不应共享凭据或 API 密钥；如果黑客成功攻破你的测试服务器，限制他们能造成的损害是非常重要的。

#### *保护管理前端*

一些软件组件带有通过互联网访问的管理工具。管理界面是黑客最喜欢的攻击目标之一。例如，你可能经常遇到恶意机器人，通过检测是否存在*/wp-login.php*页面来探测不安全的 WordPress 实例。

如果你不打算使用这些管理前端，请在配置中禁用它们。如果你打算使用它们，请确保删除任何默认的登录凭据，并且如果可能的话，限制可以访问它们的 IP 范围。请查阅你的软件堆栈文档，或在 Stack Overflow 上做一个快速搜索（*[`stackoverflow.com/`](https://stackoverflow.com/)）以了解如何操作。

现在你已经学会了如何保护在自己服务器上运行的第三方代码，让我们来看一下如何安全地与运行在其他人服务器上的代码进行集成。

### 保护你使用的服务

第三方服务在现代网站开发中被广泛使用。你可能会使用 Facebook 登录进行身份验证，使用 Google AdSense 在你的网站上投放广告，使用 Akamai 托管静态内容，使用 SendGrid 发送事务性电子邮件，使用 Stripe 处理支付。

将这些服务集成到你的网站中，通常意味着要在服务提供商处创建一个账户，获得秘密访问凭据，并修改你的网站代码以利用该服务。这里有两个安全考虑因素。首先，黑客通常会尝试窃取你的访问凭据，以便访问这些服务的账户。这将允许他们获取关于你用户的信息，或者在支付处理器的情况下，甚至发起金融交易。其次，每个第三方服务都是你网站的潜在攻击向量，因为黑客会试图破坏服务提供商，以便访问广泛的目标。

让我们从第一个考虑因素开始：学习如何安全存储你的访问凭证。

#### *保护你的 API 密钥*

许多第三方服务在你注册时会为你发放一个应用程序接口（API）密钥，你的代码在与 API 交互时必须将该密钥作为访问令牌提供。API 密钥需要安全存储。通常，这意味着将 API 密钥安全地存储在服务器的配置中，正如上一节所讨论的那样。

一些 API 发放 *两个* API 密钥：一个 *公钥* 可以安全地传递给浏览器，用于从 JavaScript 发起 API 调用；一个 *私钥* 必须保存在服务器上，用于从服务器端发起更敏感操作的私有 API 调用。公钥的权限较少。审计你的代码，确保这些密钥没有被混淆！你不想不小心将具有更高权限的私钥发送给客户端。即使是像将你的配置变量命名为 `SECRET_KEY` 这样的简单做法，也能提醒你的开发团队注意风险。

其他服务允许你生成一个可以传递给客户端的临时访问令牌。通常，这些令牌只能使用一次，或者在有限的时间窗口内使用，以防止恶意用户滥用。这些访问令牌可以防止 *重放攻击*，即攻击者通过重新发送 HTTP 请求来尝试重复某个操作（例如，重复支付）。确保你的代码仅在用户已经完成身份验证后生成访问令牌，否则攻击者可能会按需生成新的访问令牌。

#### *保护你的 Webhook*

大多数 API 集成涉及从你的 Web 服务器或浏览器发起 HTTPS 调用到服务提供商的 API。当服务提供商需要发起相反方向的调用（例如，向你发送通知）时，它可能要求你实现一个 *Webhook*。这是你网站上的一个简单“反向 API”，当事件发生时，服务提供商会向其发送 HTTPS 请求。例如，当用户打开你发送的电子邮件或你的支付处理程序发起支付时，你可能会收到 Webhook 调用。

由于 Webhook 是公开的 URL，任何人都可以调用它，而不仅仅是服务提供商。如果服务提供商支持在 Webhook 调用中发送凭证，你应该在处理 Webhook 调用之前验证这些凭证是否正确。

如果 Webhook 调用纯粹是信息性的且不包含敏感数据，它可以在没有凭证的情况下发送。在这种情况下，攻击者可以轻松伪造这样的 Webhook 调用。准备在进行进一步处理之前，通过回调服务提供商的 API 来验证通知。

#### *保护由第三方提供的内容*

黑客最喜欢的一种手段是通过其他人的域名提供恶意内容；受害者可能会因为他们信任的网站而产生虚假的安全感。用户已经习惯于信任浏览器中的锁形图标，因此，如果黑客能够找到一种方式，在大公司的安全证书下部署恶意软件，他们就能欺骗更多受害者下载它。

许多网站使用内容分发网络（CDN）或基于云的存储（如 Amazon S3）来提供频繁访问的内容。当网页开发人员与这种类型的服务集成时，他们通常会通过更改 DNS 将流量从他们的域名引导到该服务，例如将*subdomain.example.com*这样的子域流量重定向到服务。这使得第三方提供的内容可以使用站点的安全证书进行加密。

黑客经常尝试*子域接管*，通过扫描互联网寻找指向未初始化或已停用服务 IP 地址的子域 DNS 条目。然后，他们会注册服务提供商并*占用*列出的其中一个 IP 地址。这将使他们能够通过使用受害者的域名创建指向其恶意内容的链接。

如果您的网站提供由 CDN 或基于云的存储托管的内容，您需要确保您的 DNS 条目指向的仅是有效的 IP 地址。在更改 DNS 之前，请确保已验证服务在您的控制下正常运行，并且如果更换服务提供商，请及时撤销 DNS 更改。

现在您知道了如何保护与服务提供商的集成，让我们来看看另一个方向的威胁。

### 作为攻击向量的服务

第三方服务可能成为对您的网站发起恶意攻击的一个向量*。*这一点在您集成客户端服务时尤为重要，因为从第三方域导入的任何 JavaScript 都带有安全风险。

以 Google Analytics 为例。当您将 Google Analytics 工具添加到您的网站时，您需要注册一个 Google 帐户以获取跟踪 ID，然后在您希望跟踪用户活动的页面上导入外部 JavaScript，如示例 14-5 所示。

```
<script src="https://www.googletagmanager.com/gtag/js?id=GA_TRACKING_ID"></script>
```

*示例 14-5：将 Google Analytics 添加到网页的配方*

导入的代码可以读取页面 DOM 中的任何内容，包括用户输入的敏感数据。它还可能以误导的方式更改 DOM；例如，诱使用户输入他们的凭证。在添加客户端服务时，必须考虑到这些风险。恶意代码可以由第三方服务本身提供，或者由攻击者劫持该服务后提供。（如果您想知道：Google Analytics 从未被攻击者攻破。我这里只是将其作为一个示例！）

不幸的是，在考虑如何运行从第三方导入的客户端代码时，浏览器的安全模型目前并不十分复杂。浏览器中的 JavaScript 代码在*沙盒*中运行，这意味着它与底层操作系统隔离，无法访问磁盘上的文件，但从*不同*来源导入的 JavaScript 文件却都在同一个沙盒中运行。

即将发布的 Web 组件规范（* [`www.webcomponents.org/`](https://www.webcomponents.org/) *），目前由 HTML 标准委员会开发，定义了代码和页面元素的更精细的权限。尽管这些细节正在最终确定并实现，但你仍然应该在网站上实施合理的安全预防措施。让我们通过探讨如何保护你的客户端集成，来看一下通过第三方渠道进行攻击的最常见方式：*恶意广告*。

#### *警惕恶意广告*

广告是现代网络的重要组成部分：互联网上的大部分内容都是通过广告收入来资助的，且公司每年在在线广告上的支出超过 1000 亿美元。广告通常是由第三方广告平台放置在网站上的。网站所有者（在在线广告界被称为*发布者*）会订阅广告平台，然后标出他们网站上广告应该出现的位置。广告平台将在网站加载时填充这些区域，使用直接在每个页面中导入的 JavaScript。

主要广告平台如 Google AdSense 使用分析工具来识别发布者托管的内容类型和访问网站的人的类型，从而决定投放的广告类型。发布者有时直接与广告商打交道，或者将广告位放在*广告交换平台*上，通过该平台，广告买家可以购买*广告块*。（广告买家可能会购买 1000 次广告展示，针对特定人群，例如*访问运动鞋网站的 18-25 岁男性*。）

作为发布者，你对你所承载的广告有一定的控制权，但通常不能事先批准每一条广告。例如，Google AdSense 允许发布者屏蔽某些广告类别或特定网站域名，或在广告开始展示给用户后拒绝特定广告。

这构成了一个安全风险，因为黑客经常利用广告平台作为攻击向量。恶意广告——*恶意广告*——使攻击者能够同时通过恶意软件攻击多个网站。恶意广告是互联网上日益严重的威胁，可能会让发布者和广告网络尴尬，并使用户成为受害者。

#### *避免恶意软件传播*

广告中的恶意软件通常通过*漏洞利用工具包*传播，这些工具包在传递实际的恶意代码（即*有效载荷*）之前，会判断特定的浏览器和操作系统是否存在漏洞：*有效载荷*可能包括重定向或锁定浏览器的脚本、通过插件漏洞传播的病毒或勒索病毒，甚至是通过浏览器挖矿加密货币的 JavaScript 代码。

漏洞利用工具包的作者与安全研究人员之间处于军备竞赛中。为了避免被检测到，漏洞利用工具包托管在动态生成的 URL 上，并通过仅偶尔触发来避免自动扫描。甚至有观察到漏洞利用工具包试图通过检测它们是否在虚拟机中运行来阻止恶意软件分析（恶意软件研究人员通常使用虚拟机来隔离有害代码进行分析）。

如果你的用户因为你网站上的广告而遭遇恶意软件攻击，你就把他们置于了危险之中。你可以通过确保只与可信的广告平台合作、在网页中使用安全的框架来展示广告，并不断留意恶意广告来保护他们。

#### *使用信誉良好的广告平台*

大多数情况下，防范恶意广告是广告平台的责任。它们与广告购买者建立了联系，只有它们能够全面监控这些广告商，从而发现恶意行为者。

谷歌（迄今为止）是广告领域最大的参与者。谷歌允许较小的出版商通过自助广告平台 AdSense 将其网站实现货币化。较大的出版商可以访问 AdX，这是一个允许出版商指定广告合作伙伴并设置自己价格的平台。两个平台都接受第三方广告网络的广告。

谷歌在防范恶意广告方面表现得非常敏锐，因为它们的收入很大一部分依赖于广告平台。为了利用这一点，你应该在选择广告平台时优先考虑 AdSense 或 AdX。

然而，谷歌出于声誉原因选择不与某些类型的网站合作。例如，如果你托管成人主题或暴力内容，你很难通过 AdSense 的审核。在这种情况下，你可能不得不与一个资源较少、对防范恶意软件的兴趣较小的较小广告平台合作。在选择平台之前，请做好研究。

#### *使用 SafeFrame*

隔离网页中的第三方内容最有效的方法是将该内容托管在`<iframe>`标签内。加载在 iframe（*内联框架*）中的 JavaScript 代码无法访问包含页面的 DOM。HTML5 通过向`<iframe>`标签添加`sandbox`属性提供了更精细的控制。此属性允许框架指定，例如，包含的内容是否可以提交`POST`请求或打开新窗口。

广告行业已采用一种名为*SafeFrame*的标准，它允许发布者指定广告必须在 iframe 中运行。SafeFrame 标准使用`<iframe>`标签，并添加了一个 JavaScript API，使广告商能够克服 iframe 的一些固有限制。该 API 允许广告脚本在框架可见时获得通知，并对大小变化作出响应，例如。

你的广告平台将提供一个选项，允许你*仅*展示符合 SafeFrame 标准的广告，你应该选择该选项。这将阻止任何恶意广告脚本，这些脚本试图干扰网页的渲染过程。

#### *定制你的广告偏好*

大多数广告平台允许你自定义展示给用户的广告内容类型。如果你使用 Google AdSense，确保你只展示来自 Google 认证广告网络的内容。黑客已经知晓通过购买过期域名，运营较小、已经停用的广告网络来投放恶意软件。

还要清点你展示的广告类别。你可能希望屏蔽快速致富计划和多级营销活动的广告，以及任何自称为可下载工具的广告。

#### *审查并报告可疑广告*

定期查看你的网站上展示的广告，方法是通过广告平台仪表板进行查看。（记住：广告是根据访客量身定制的，因此仅在浏览器中访问你的网站，并不能显示所有正在展示的广告。）报告并屏蔽任何可疑的广告。最好记录用户离开你网站时的外部链接，这样你就能追踪到你托管的广告是否将用户引导到可疑网站。

### 摘要

第三方代码中的漏洞是你网站的一大威胁。使用依赖管理工具来跟踪你使用的第三方依赖项，将你的依赖清单放在源代码控制下，并指定明确的依赖版本。确保你的构建和部署流程是脚本化的，这样当发布安全通告时，你可以轻松地升级依赖项。（这也包括操作系统的补丁。）保持关注社交媒体和新闻网站，了解何时发布安全通告。使用审计工具检测依赖树中存在漏洞的软件组件。在网页中导入 JavaScript 时，使用`integrity`属性，以便浏览器可以验证这些文件的完整性。

确保你没有使用不安全的配置；黑客通过简单的 Google 搜索可以发现不安全的软件组件。禁用系统的任何默认凭证，并在你的 Web 服务器配置中禁用开放目录列表。将敏感的配置信息（例如数据库访问凭证或 API 密钥）从源代码控制中移除；相反，应该将其保存在专用的配置存储中，并在启动时加载。特别要注意保护测试环境和管理前端的配置，因为它们是黑客常见的攻击目标。

小心不要将敏感的 API 密钥或访问令牌传递给客户端。确保任何 Webhook 防范伪造攻击。如果你通过自己的域名提供来自其他位置的内容—例如，通过内容分发网络或云存储托管—确保攻击者无法在这些系统上放置恶意软件，并通过你的安全证书将其提供给用户。

了解你在网站上托管的广告可能带来的恶意软件风险。使用信誉良好的广告网络，并充分利用其允许的所有基于 SafeFrame 的安全设置。定期检查你网站上发布的广告，报告任何可疑广告并将其列入黑名单。

在下一章中，你将了解与 XML 解析相关的漏洞。XML 是现代互联网中无处不在的一部分，也是黑客常用来攻击你系统的目标。
