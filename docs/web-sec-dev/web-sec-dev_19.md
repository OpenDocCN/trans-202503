# 第十七章：**拒绝服务攻击**

![image](img/common01.jpg)

2016 年 10 月 21 日，互联网用户醒来后发现他们许多喜爱的网站无法访问：Twitter、Spotify、Netflix、GitHub、Amazon 等许多网站似乎都无法连接。根本原因是对一个 DNS 提供商的攻击。大量的 DNS 查询请求使得受欢迎的 DNS 提供商 Dyn 瘫痪。直到大部分的一天过去——期间发生了两波巨大的 DNS 查询请求——服务才完全恢复。

这次中断的规模和影响前所未有。（唯一一次可比的事件发生在一只鲨鱼咬断了一条海底互联网电缆，导致整个越南一度无法联网。）然而，这只是拒绝服务（DoS）攻击日益常见且日益危险的最新体现。

拒绝服务攻击不同于本书中讨论的大多数漏洞类型，因为该攻击的目的不是要攻陷系统或网站：其目的仅仅是使其无法为其他用户提供服务。通常，这是通过向网站发送大量流量来实现的，直到所有服务器资源被耗尽。本章将分析一些常见的拒绝服务攻击技术，并提出防御它们的各种方法。

### 拒绝服务攻击类型

响应一个网络请求通常比发送一个请求需要更多的处理能力。例如，当一个 Web 服务器处理一个 HTTP 请求时，它必须解析请求、运行数据库查询、将数据写入日志，并构建返回的 HTML 内容。用户代理只需生成包含三部分信息的请求：HTTP 动词、发送的 IP 地址和 URL。黑客利用这种不对称性，通过发送大量网络请求来压垮服务器，使其无法响应合法用户的请求。

黑客们已经发现了在网络堆栈的各个层面发起拒绝服务攻击的方法，而不仅仅是通过 HTTP。鉴于他们过去的成功，未来可能会发现更多的方法。让我们来看看攻击者工具包中的一些工具。

#### *互联网控制消息协议攻击*

*互联网控制消息协议（ICMP）* 被服务器、路由器和命令行工具用于检查网络地址是否在线。这个协议非常简单：请求会发送到一个 IP 地址，如果响应的服务器在线，它会返回确认信息。假如你曾使用过`ping`工具来检查服务器是否可达，那么你就曾在背后使用了 ICMP 协议。

ICMP 是最简单的互联网协议，因此不可避免地，它是第一个被恶意使用的协议。*Ping 洪水*试图通过发送源源不断的 ICMP 请求来压倒服务器，且只需几行代码即可发起。稍微复杂一些的攻击是 *死神 Ping* 攻击，它发送损坏的 ICMP 数据包，试图使服务器崩溃。这种攻击利用了旧版软件在接收 ICMP 数据包时未正确进行边界检查的漏洞。

#### *传输控制协议攻击*

大多数基于 ICMP 的攻击可以通过现代网络接口来化解，因此攻击者已将目标转移到更高层的网络协议栈，即 TCP，后者是大多数互联网通信的基础。

TCP 会话从 TCP 客户端向服务器发送一个 `SYN`（同步）消息开始，服务器随后应该回复一个 `SYN-ACK`（同步确认）响应。然后，客户端通过向服务器发送最后一个 `ACK` 消息来完成握手。通过用 `SYN` 消息淹没服务器——即 *SYN 洪水*——而不完成 TCP 握手，黑客工具会使服务器留下大量“半开”连接，从而耗尽合法客户端的连接池。接着，当合法客户端尝试连接时，服务器会拒绝连接。

#### *应用层攻击*

针对 Web 服务器的应用层攻击滥用 HTTP 协议。*Slowloris* 攻击通过向服务器打开多个 HTTP 连接，并通过定期发送部分 HTTP 请求保持这些连接，从而耗尽服务器的连接池。*R-U-Dead-Yet? (RUDY)* 攻击向服务器发送永无止境的 `POST` 请求，并带有任意长的 `Content-Length` 头部值，以使服务器忙于读取无意义的数据。

黑客还发现了通过利用特定 HTTP 端点将 Web 服务器下线的方法。上传 *zip bomb*——扩展时会呈指数增长的损坏归档文件——到文件上传功能中，可以耗尽服务器的可用磁盘空间。任何执行反序列化——将 HTTP 请求的内容转换为内存中的代码对象——的 URL 也可能是潜在的漏洞。此类攻击的一个例子是 XML bomb，如你在第十五章中看到的那样。

#### *反射和放大攻击*

启动有效的拒绝服务攻击的一个难点是找到足够的计算能力来生成恶意流量。黑客通过使用第三方服务来生成流量，从而克服这一限制。通过向第三方发送恶意请求，并伪造返回地址为他们的目标受害者，黑客*反射*响应到他们的目标，可能会压垮响应流量的服务器。反射攻击还会掩盖攻击的原始来源，使得追踪变得更加困难。如果第三方服务的回复比初始请求更大或更多，较大的响应将*放大*攻击的威力。

迄今为止最大的一次拒绝服务攻击是通过反射实现的。2018 年，一名攻击者成功生成了每秒 1.3TB 的数据，并将其指向 GitHub 网站。黑客通过定位大量不安全的 Memcached 服务器，并向它们发送带有 GitHub 服务器 IP 地址的*用户数据报协议（UDP）*请求来实现这一点。每个响应大约是原始请求的 50 倍，实际上将攻击者的计算能力放大了相同的倍数。

#### *分布式拒绝服务攻击*

如果拒绝服务攻击是从单一 IP 地址发起的，那么将该 IP 的流量列入黑名单并停止攻击是相对容易的。现代的拒绝服务攻击，如 2018 年针对 GitHub 的攻击，来自多个协作源——即*分布式拒绝服务（DDoS）*攻击。除了利用反射，这些攻击通常是从*僵尸网络*发起的，僵尸网络是由恶意软件控制的各种计算机和互联网连接设备组成的网络，攻击者可以控制这些设备。如今，许多类型的设备都连接到互联网——恒温器、冰箱、汽车、门铃、发刷——而且这些设备容易出现安全漏洞，成为这些僵尸程序的藏身之地。

#### *无意的拒绝服务攻击*

并非所有的互联网流量激增都是恶意的。网站突然变得热门，短时间内吸引大量访问者，导致网站瘫痪，这是很常见的情况，因为这些网站并没有设计来应对如此高的流量。Reddit 的*死亡之拥*常常会使得较小的网站在其登上社交新闻网站的首页时被迫下线。

### 拒绝服务攻击缓解

防御一次重大拒绝服务攻击既昂贵又耗时。幸运的是，你不太可能成为像 2016 年使 Dyn 公司瘫痪那样规模的攻击的目标。此类攻击需要广泛的计划，只有少数敌人能够实施。你不太可能在你的食谱博客上看到每秒数 TB 的数据流量！

然而，较小的拒绝服务攻击结合勒索请求*确实*发生，因此进行一些防护措施是非常值得的。以下部分描述了一些你应考虑使用的对策：防火墙和入侵防御系统、DDoS 防护服务以及高度可扩展的网站技术。

#### *防火墙和入侵防御系统*

所有现代服务器操作系统都配备了*防火墙*——一种基于预定安全规则，监控和控制进出网络流量的软件。防火墙使你能够确定哪些端口应该允许传入流量，并通过*访问控制规则*过滤掉来自特定 IP 地址的流量。防火墙被放置在组织网络的边界，用于在流量进入内部服务器之前过滤掉不良流量。现代防火墙能够阻止大多数基于 ICMP 的攻击，并可用于将单个 IP 地址列入黑名单，这是一种有效的方式来阻止来自单一来源的流量。

*应用防火墙* 在网络堆栈的更高层运行，充当代理，扫描 HTTP 及其他互联网流量，在流量进入网络其他部分之前进行检查。应用防火墙扫描传入流量，检测是否存在损坏或恶意请求，并拒绝匹配恶意签名的任何内容。由于签名由供应商持续更新，这种方法能够阻止许多类型的黑客攻击（例如，SQL 注入攻击尝试），并有效减轻拒绝服务攻击。此外，除了像 ModSecurity 这样的开源实现外，还有商业应用防火墙供应商（例如，Norton 和 Barracuda Networks），其中一些提供基于硬件的解决方案。

*入侵防御系统（IPS）* 对保护网络采取更全面的方法：除了实施防火墙和匹配签名外，它们还会寻找网络流量中的统计异常，并扫描硬盘上的文件，查找不寻常的变化。IPS 通常需要较大的投资，但能够提供非常有效的保护。

#### *分布式拒绝服务保护服务*

在复杂的拒绝服务攻击中，网络数据包通常与常规数据包无法区分。流量是有效的；只有流量的意图和量才是恶意的。这意味着防火墙无法筛选出这些数据包。

许多公司提供分布式拒绝服务攻击的保护，通常费用较高。当你与 DDoS 解决方案供应商集成时，你将所有传入流量通过其数据中心，这里会扫描并拦截任何看起来恶意的流量。由于解决方案供应商对全球恶意互联网活动有全面的了解，并且拥有大量可用带宽，它可以使用启发式方法防止任何有害流量到达你。

DDoS 保护通常由 CDN 提供，因为它们拥有地理上分布的数据中心，并且通常已经为客户托管静态内容。如果大部分请求已经由托管在 CDN 上的内容处理，那么将剩余的流量通过其数据中心路由也不会花费太多额外的精力。

#### *构建可扩展性*

在许多情况下，遭受拒绝服务攻击的情形与网站同时有很多访客是无法区分的。通过准备应对大流量的激增，你可以有效防止许多拒绝服务攻击。构建可扩展性是一个庞大的话题——这方面已经写了许多书籍，且它是一个活跃的研究领域。你应该关注的一些最有效的方法包括：转移静态内容，缓存数据库查询，使用异步处理长时间运行的任务，以及部署多个 Web 服务器。

CDN 将提供静态内容（如图片和字体文件）的负担转移给第三方。使用 CDN 显著提高了网站的响应速度，并减少了服务器的负载。CDN 易于集成，对大多数网站来说具有成本效益，并且能显著减少 Web 服务器需要处理的网络请求量。

一旦将静态内容转移出去，数据库访问调用通常会成为下一个瓶颈。有效的*缓存*可以防止数据库在流量激增时过载。缓存的数据可以存储在磁盘、内存中，或者在像 Redis 或 Memcached 这样的共享内存缓存中。甚至浏览器也可以帮助缓存：在资源（例如图片）上设置`Cache-Control`头，告诉浏览器存储资源的本地副本，并在可配置的未来日期之前不再请求它。

将长时间运行的任务转移到*作业队列*中，将帮助你的 Web 服务器在流量激增时迅速响应。这是一种 Web 架构方法，它将长时间运行的任务（例如生成大文件或发送电子邮件）移到后台的*工作进程*中。这些工作进程与 Web 服务器分开部署，Web 服务器创建任务并将它们放入队列中。工作进程从队列中取出任务并逐个处理，任务完成后通知 Web 服务器。可以查看 Netflix 技术博客（*[`medium.com/@NetflixTechBlog/`](https://medium.com/@NetflixTechBlog/)）*，该博客展示了基于这种原则构建的大规模可扩展系统。

最后，你应该有一个部署策略，允许你相对快速地扩展 Web 服务器的数量，以便在繁忙时期提升计算能力。像 Amazon Web Services (AWS) 这样的基础设施即服务 (IaaS) 提供商让你可以轻松地在负载均衡器后多次部署相同的服务器镜像。像 Heroku 这样的平台使得在其 Web 仪表板上移动滑块就能做到这一点！你的托管服务提供商会有某种方法来监控流量量，像 Google Analytics 这样的工具可以用来追踪你网站上有多少会话是何时开启的。然后，当监控阈值被触发时，你只需要增加服务器数量即可。

### 总结

攻击者利用拒绝服务攻击通过大量流量将网站淹没，使其无法为合法用户提供服务。拒绝服务攻击可以发生在网络栈的任何层次，并且可以通过第三方服务进行反射或放大。通常，它们作为来自攻击者控制的僵尸网络的分布式攻击发起。

简单的拒绝服务攻击可以通过合理的防火墙设置来化解。应用防火墙和入侵防御系统有助于防范更为复杂的攻击。最全面（因此也是最昂贵）的保护来自分布式拒绝服务攻击解决方案提供商，它们会在恶意流量到达你的网络之前将其过滤掉。

各种类型的拒绝服务攻击——包括意外的攻击，当你突然看到大量新访客时——都可以通过构建能够良好扩展的网站来缓解。内容分发网络减轻了从你的网站提供静态内容的负担，且有效的缓存能够防止数据库成为瓶颈。将长时间运行的进程移至任务队列，将使你的 Web 服务器能够高效运行并达到满负荷。积极的流量监控以及轻松扩展 Web 服务器数量的能力，将为你在繁忙时期做好充分准备。

这本书中你将要查看的所有个体漏洞已经讲解完毕！最后一章总结了本书中涉及的主要安全原则，并回顾了各个漏洞以及如何防范它们。
