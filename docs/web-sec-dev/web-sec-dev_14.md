# 第十二章：**信息泄露**

![image](img/common01.jpg)

黑客经常利用公开的安全漏洞，尤其是 *零日漏洞*——那些在过去 24 小时内被公开的安全缺陷。当某人发布了一个软件组件的零日漏洞后，黑客会立即扫描运行该漏洞软件的 web 服务器，以便利用这一安全漏洞。为了保护自己免受此类威胁，你应该确保 web 服务器不会泄露关于你所运行的软件栈的信息。如果你无意中暴露了服务器技术，你就是在给自己做靶子。

本章将介绍 web 服务器泄露关于你技术选择的一些常见方式，并提供如何缓解这些风险的方法。

### 缓解措施 1：禁用明显的服务器响应头

确保禁用 web 服务器配置中任何会暴露服务器技术、语言和版本的 HTTP 响应头。默认情况下，web 服务器通常会在每个响应中返回一个 `Server` 响应头，描述服务器端正在运行的软件。这对 web 服务器供应商来说是很好的广告，但浏览器并不会使用它。它只是告诉攻击者可以探测哪些漏洞。确保你的 web 服务器配置禁用此 `Server` 响应头。（或者，如果你想捉弄一下，可以让它报告错误的 web 服务器技术！）

### 缓解措施 2：使用干净的 URL

在设计网站时，避免 URL 中出现明显的文件后缀，比如 *.php*、*.asp* 和 *.jsp*。实现 *干净的 URL* ——不会泄露实现细节的 URL。带有文件扩展名的 URL 在旧版 web 服务器中比较常见，它们会明确引用模板文件名。确保避免使用这些扩展名。

### 缓解措施 3：使用通用的 Cookie 参数

web 服务器用来存储会话状态的 cookie 名称通常会泄露你的服务器端技术。例如，Java web 服务器通常将会话 ID 存储在一个名为 `JSESSIONID` 的 cookie 中。攻击者可以检查这些类型的会话 cookie 名称来识别服务器，如 列表 12-1 所示。

```
❶ if response.get_cookies.match(/JSESSIONID=(.*);(.*)/i)
   jsessionid = $1
   post_data  = "j_username=#{username}&j_password=#{password}"

   response = send_request_cgi({
                'uri'          => '/admin/j_security_check',
                'method'       => 'POST',
                'content-type' => 'application/x-www-form-urlencoded',
                'cookie'       => "JSESSIONID=#{jsessionid}",
                'data'         => post_data,
              })
```

*列表 12-1：黑客工具 Metasploit 尝试检测并入侵 Apache Tomcat 服务器*

请注意，Metasploit 代码检查了会话 cookie 的名称 ❶。

确保你的 web 服务器在 cookies 中不返回任何关于你技术栈的线索。修改配置，使用通用的会话 cookie 名称（例如，`session`）。

### 缓解措施 4：禁用客户端错误报告

大多数 web 服务器支持*客户端错误报告*，这允许服务器在错误页面的 HTML 中打印堆栈跟踪和路由信息。客户端错误报告在调试测试环境中的错误时非常有用。然而，堆栈跟踪和错误日志也会告诉攻击者你正在使用哪些模块或库，帮助他们挑选出可能的安全漏洞作为攻击目标。发生在数据访问层的错误甚至可能暴露数据库结构的细节，这会带来严重的安全隐患！

你*必须*在生产环境中禁用客户端错误报告。你应该保持用户看到的错误页面完全通用。最多，用户应该知道发生了一个意外错误，并且有人正在处理这个问题。详细的错误报告应保存在生产日志和错误报告工具中，这些工具只有管理员可以访问。

查阅你 web 服务器的文档，了解如何禁用客户端错误报告。列表 12-2 展示了如何在 Rails 配置文件中禁用此功能。

```
  # Full error reports are disabled.
  config.consider_all_requests_local = false
```

*列表 12-2：确保你的生产配置文件（通常存储在* config/environments/production.rb *中，适用于 Ruby on Rails）禁用客户端错误报告。*

### 缓解措施 5：压缩或混淆你的 JavaScript 文件

许多 web 开发者在部署 JavaScript 代码之前使用*压缩工具*对其进行预处理，这种工具可以将 JavaScript 代码转换为功能等效但高度压缩的 JavaScript 文件。压缩工具会删除所有多余的字符（如空格），并将一些代码语句替换为更短的语义相同的语句。相关的工具是*混淆器*，它将方法和函数名替换为简短且无意义的标记，而不改变代码的行为，从而故意使代码变得不易读。流行的 UglifyJS 工具集成了这两种功能，可以通过命令行直接调用，语法为`uglifyjs [输入文件]`，使其轻松融入到构建过程中。

开发者通常出于性能考虑，对 JavaScript 代码进行压缩或混淆，因为较小的 JavaScript 文件可以更快地加载到浏览器中。这种预处理还具有一个积极的副作用，即使攻击者更难检测出你正在使用哪些 JavaScript 库。研究人员或攻击者定期发现流行的 JavaScript 库中存在安全漏洞，这些漏洞可能允许跨站脚本攻击。让攻击者更难发现你使用的库，将为你争取更多的喘息空间，尤其是在漏洞被发现时。

### 缓解措施 6：清理你的客户端文件

进行代码审查并使用静态分析工具以确保敏感数据不会出现在评论中，或者死代码不会被传递到客户端，这是非常重要的。开发者容易在 HTML 文件、模板文件或 JavaScript 文件中留下过多的信息，因为我们常常忘记这些文件最终会被传送到浏览器。虽然压缩 JavaScript 代码可能会去除注释，但你需要在代码审查时在模板文件和手写的 HTML 文件中找到敏感注释并将其删除。

黑客工具使得攻击者能够轻松爬取你的网站，提取你不小心留下的任何评论——黑客常常使用这种技术扫描评论中不小心泄露的私密 IP 地址。当黑客试图攻击你的网站时，这通常是他们的第一步。

### 保持对安全公告的关注

即使你已经锁定了所有的安全设置，经验丰富的黑客仍然能够根据你所使用的技术做出合理的猜测。Web 服务器在响应特定边缘情况时有一些明显的行为，例如故意损坏的 HTTP 请求或带有不寻常 HTTP 动词的请求。黑客可以利用这些独特的服务器技术指纹来识别服务器端的技术栈。即使你在防止信息泄漏方面遵循了最佳实践，仍然需要保持对你使用的技术的安全公告的关注，并及时部署补丁。

### 总结

你应该确保你的 Web 服务器不会泄露关于你使用的软件堆栈的信息，因为黑客会利用这些信息来寻找攻击你网站的方法。确保你的配置禁用明显的头部信息，并在 HTTP 响应中使用通用的会话 cookie 名称。使用干净的 URL，避免包含文件名扩展名。压缩或混淆 JavaScript 代码，这样就更难判断你使用了哪些第三方库。在生产站点中关闭详细的客户端错误报告。确保清理你的模板文件和 HTML 中的评论，避免泄露过多信息。最后，保持对安全公告的关注，以便及时部署补丁。

在下一章，你将学习如何通过加密来保护你网站的流量。
