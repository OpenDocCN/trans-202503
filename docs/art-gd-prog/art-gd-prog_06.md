# 6

网络通信

![](img/chapterart.png)

## 草图 48：打开一个网页

一个网页其实只是一个文本文件，其中包含足够详细的页面描述，以便在屏幕上绘制它。一个名为浏览器的程序读取并渲染该文件，生成可视页面。文件本身存储在互联网上某台计算机上，为了显示它，我们必须先将其上传到用户的计算机。浏览器安排执行这一操作，但文件必须有一个独特的名字来标识它——这个名字在*整个世界*范围内唯一，因为互联网是一个全球网络。这个独特的名字被称为统一资源定位符（Uniform Resource Locator，简称 URL）。大多数人称之为网页地址，一个例子是 [`www.microsoft.com`](https://www.microsoft.com)。

URL 包含了如何找到网页的方向，它相当于一个文件名。显示页面是一个复杂的操作，浏览器是非常复杂的软件系统。

Processing 使用名为 `link()` 的函数来打开和显示网页，该函数接受一个 URL 作为参数。这个函数将 URL 传递给计算机上的默认浏览器，浏览器会打开并显示该页面。因此，下面的调用将会在浏览器中打开 Microsoft 页面：

```
link ("https://www.microsoft.com"); 
```

如果浏览器已经打开，它可能会打开一个新标签页。

### 示例 A

这个草图按照之前的描述打开了 Microsoft 页面。当鼠标按钮按下并且光标位于显示窗口内时，它会打开该页面。

### 示例 B

这个草图是示例 A 和草图 37 的结合体。用户输入一个 URL，草图根据输入的字符构建一个字符串。当用户按下 ENTER 键时，草图将 URL 传递给 `link()` 函数，浏览器将打开并显示对应的页面。

当用户输入一个字符时，通常会把它放入变量 `key` 中，然后将其添加到字符串中。然而，某些键不会产生字符，比如方向键或 Shift 键。在 Processing 中，大写字母涉及两次按键操作：SHIFT 键和字符键。Processing 系统将这些视为编码键，并以不同的方式处理它们。如果 `key` 变量的值为 `CODED`，那么按下的就是这些特殊键之一，而 `keyCode` 变量表示按下了哪个键。例如，值 `UP` 表示按下了向上箭头键。

在这个草图中，我们将忽略所有编码键，因为 SHIFT 键用于输入大写字母和一些标点符号（比如冒号“:”，），但不应当视为一个按键操作。`keyPressed()` 函数通过以下代码来忽略编码键：

```
if (key == CODED) return;
```

## 草图 49：从网页加载图像

由于网页本质上只是一个文本文件，正如你在草图 48 中看到的，它应该是可以被读取并查看其中的内容。例如，它应该能够识别网页访问的任何声音文件（例如 MP3 文件），或者网页中将包含哪些图片（如 *.jpg*、*.gif*、*.png* 等）。这个草图将定位网页中引用的图片文件，并将它们显示在显示窗口中。

首先要做的是读取网页。它包含 HTML，这是一种描述文档的语言，读取它其实很简单：Processing 允许像使用文件名一样在 `loadStrings()` 函数中使用 URL。你可以通过直接将 URL 传递给 `loadStrings()` 来将 Mink Hollow Media 网页作为文本文件读取：

```
String webin[] = loadStrings("https://minkhollowmedia.ca");
```

或者，正如在这个草图中所做的那样，使用 `loadStrings(url+"/"+file)`，其中 `url` 是网页地址，`file` 是我们想要的文件名 1。此时，网页作为一组字符串存储在数组 `webin` 中，每行对应文件中的一行。

HTML 使用一种叫做 `img` 标签来在页面中显示图片：

```
<img src="imagename.jpg">
```

图片的文件名位于文本 `src="` 后面，因此草图应该在 `webin` 中的字符串内查找这一字符序列。如果找到，接下来的字符直到结束的双引号 (`"`) 为止即为文件名。我们可以使用 `indexOf()` 函数 2 在一个字符串中查找另一个字符串：

```
i = s.indexOf ("src=", j);
```

在这个例子中，`indexOf()` 在字符串 `s` 中查找字符串 `"src="`，从字符索引 `j` 开始。它返回找到该字符串位置的索引，如果未找到则返回 -1。如果找到该字符串，我们会调用 `getName()` 函数 3 来提取字符串中的文件名。`getName()` 函数读取并保存字符，直到遇到终止的双引号，并将文件名作为字符串 4 返回。这个字符串会作为文件名传递给 `loadImage()`，如果能够加载到该文件名的图片，则会显示出来。

有许多合法的方式可以指定文件名，这段代码也尝试了另一种方法：它会获取 URL，并加上斜杠 (`/`) 和文件名 1 来查看是否有效。某些图片通过这种方法可能无法定位，而一些非图片文件（如 JavaScript、视频和音频文件）则可以提取出来。它们无法作为图片显示，控制台会出现错误信息。

## 草图 50: 客户端/服务器通信

很多计算机网络通信都是基于所谓的客户端/服务器模型。它也可以叫做监听者/发言者模型或接收者/发送者模型，因为它实际上就是有一个计算机或进程通过网络发送信息（服务器），而另一个计算机或多个计算机接收这些数据（客户端）。

客户端/服务器软件应该这样工作：服务器首先向世界宣布它是活跃的并正在发送数据。它必须拥有一个可以唯一标识它的地址，并且必须开始发送数据（例如字节）。客户端通过使用服务器的地址来识别它想要获取数据的服务器。如果该地址代表的是一个活跃的服务器，客户端就开始从服务器读取数据。服务器必须指示新数据何时可用，如果客户端请求数据而没有收到任何数据，客户端将等待直到数据出现。

这个例子有一个服务器发送字符数据，客户端接收并显示这些数据，分别通过两个不同的草图实现。服务器不断发送消息“这是一条来自 J Parker 的消息”；客户端从服务器读取字符，将其组成一个字符串，并在显示窗口中显示该字符串。

Processing 本身没有构建客户端/服务器系统的原生功能，但有一个库可以实现此功能。Processing 使用外部库来处理许多事务，包括视频、音频以及各种特定接口。对于这个例子，我们需要在客户端和服务器草图 1 的开头导入网络库，使用这一行代码：

```
import processing.net.*; 
```

在服务器代码中，第一步是创建一个`Server`（属于网络库的一部分），并将其分配给名为`sender`的变量，然后指定端口（在此案例中为 5000 端口），这只是一个数字。端口就像电视频道，用于发送或接收数据，重要的是确保没有其他软件在使用该端口。服务器通过调用`write`函数 2 逐个字符地从字符串中将数据发送到外部世界。

```
sender = new Server(this, 5000);
`--snip--`
sender.write(nextChar);
```

`nextChar`是消息中的一个字符。

客户端草图首先尝试连接到服务器。客户端必须知道服务器的 IP 地址，它是服务器的唯一标识符（此处为`***.***.***.***`）。客户端通过构造函数使用相同的端口 3 连接到服务器：

```
me  = new Client(this, "***.***.***.***", 5000);
```

客户端使用`readChar()`函数 4 逐个读取字符：

```
nextChar = (char)me.readChar ();
```

在这个例子中，你必须先启动服务器并找出它的 IP 地址。你可以使用在运行服务器草图的计算机上的`ipconfig`程序来查找 IP 地址。然后，你可以在网络上的另一台计算机上启动客户端。
