# 前言

![](img/chapterart.png)

安全行业很复杂。我对这个领域保持着一种爱恨交织的关系，这在很大程度上归因于它变化无常和短暂的特性。你可能会花费数月甚至数年时间，在某个特定的安全领域（比如，使用 PowerShell 进行权限提升和横向移动）磨练自己的技能，但当你发现自己处于一个全 Linux 或 macOS 环境中时，你可能会感到完全没用。

等你学会如何转储 macOS 钥匙串中的秘密并击败 Gatekeeper 时，新的 Windows 10 版本已经发布，带来了新的检测措施，这使得每一个 PowerShell 攻击几乎变得无用。你又不得不回到绘图板前：寻找博客、参加会议、研究以升级你的工具并设计新的攻击路径。

冷静地考虑，这场鼠标赛跑看起来简直是彻底的疯狂。

当然，你也可以通过潜入一家公司网络来安慰自己的自尊，尤其是那些视 Windows XP/2003 为珍贵的濒危物种，誓言不惜一切代价保护它们的公司，但潮流正在赶上你。你内心深知，是时候向更广阔的海岸前进了。

毕竟，黑客技术的本质就是如此。不得不舍弃一个最爱的技巧时的沮丧，只有掌握一种全新的技术带来的兴奋感，才能与之媲美。

我们将 *黑客技术* 粗略地定义为一组技巧和窍门，旨在从系统或过程中获得意想不到的结果。然而，这些技巧有着日益加速的过期日期。作为一名安全专家或爱好者，你的目标是寻找并收集尽可能多的有用技巧。你永远不知道哪根长矛会阻止公牛的冲锋。

在我的其他书籍中，我大多聚焦于与 Windows 相关的攻击，因为大多数财富 500 强公司将其环境的大部分设计围绕 Active Directory。它曾是管理数千个用户、服务器和应用程序的首选解决方案。

然而，时代精神正在变化。如今，想要从零开始建立基础设施的公司，将不再在距离城市 20 英里处的共享数据中心里部署 Windows 域控制器在裸机上。说真的，给我一个仍然想管理硬件过时问题和包含 30 个不同防火墙、交换机、路由器和负载均衡器的 ESXi 集群的系统管理员。快把那根绳子递给我，关上门吧！

既然一切都可以在云环境中几秒钟内设置好，那为什么还要费心呢？数据库、Docker 容器和 Active Directory 都只需点击一下，而且还有免费试用期来为你的会计师提供额外的诱惑。当然，虽然初期的低票价费用会迅速膨胀，随着服务器的扩展而增加，但大多数初创公司会很乐意处理这些问题。这意味着业务在增长。

在这本书中，我决定摒弃你在那些老旧公司中找到的传统架构。让我们看看攻击者如何攻破一个现代且值得一试的对手：一个在一个有养育和韧性云环境中扎根的公司，并通过 DevOps 实践推动其增长。

超越那些毫无头绪的管理层和贪婪猎头吹嘘的流行词汇，当这些新范式成功实践时，它们对架构决策和应用设计的深远影响，迫使你自然需要一套新的技巧和方法来寻找和发现漏洞。在经典环境中可能被忽视或轻视的漏洞，在云环境中却突然具有致命的潜力。忘掉 SQL 注入吧。一旦你知道某台机器托管在 Amazon Web Services（AWS）上，你就应该转向另一类漏洞。

攻击者曾经从一台机器跳到另一台机器，悄悄越过防火墙规则，潜入内部数据库、Active Directory 等地方。这一过程通常涉及网络扫描、流量隧道等。在云环境中，你可以从世界上任何一个 IP 地址操控基础设施的核心元素。如果防火墙阻止了对某台机器的访问？凭借正确的凭证，你可以通过一个简单的 API 调用从中国丢弃那个特定规则，并从菲律宾访问那台“内部”机器。

这并不是说机器跳跃完全消失了。当然，我们仍然需要相当程度的网络技巧来获取那些保存业务数据的宝贵终端访问权限，但目标有所转变，从控制机器转向控制基础设施本身。

考虑一下 DevOps——这是技术公司倡导的另一组原则，大致定义为任何自动化软件开发、提升代码交付和可靠性的技术或组织措施。DevOps 的范围包括从将基础设施定义为代码，到容器化和自动化监控等方方面面。这种 DevOps 文化的一个重要结果是，公司对改变其基础设施和应用程序越来越不怕。忘掉典型的 IT 箴言：“如果它能正常工作，就不要改变。”当你每周将应用程序部署到生产环境五次时，你最好对根据自己的需求随时改变它感到舒适。

当你将应用程序与其运行的系统解耦时，你可以更灵活地升级你的系统。当你有端到端的集成测试时，你就可以轻松地修补代码中的关键部分，且副作用最小。当你拥有定义为代码的基础设施时，你可以防止影子 IT，并对基础设施中的每一台机器进行严格监督——这是许多大公司梦寐以求的奢侈品。

这种前沿的 DevOps 实践潮流打破了我们过去依赖的假设，用以寻找公司网络中的漏洞。黑客通过进入设计系统的人的思维，乘着虚假假设和匆忙决定的浪潮。在这种情况下，如果我们仍然固守旧有的系统设计和运行方式，作为黑客的我们又该如何做到这一点呢？

当然，这个新时代的计算并非都是独角兽撒着彩虹屎。1970 年代犯下的巨大错误仍在这个十年里被忠实地——如果不是说是宗教般地——重复着。难道不荒谬吗，在当今这个充满威胁的世界里，安全仍然被视为“可有可无”，而不是初始最小可行产品（MVP）的核心特性？我不是在说那些即将破产的物联网公司，而是说那些大科技产品，比如 Kubernetes、Chef、Spark 等等。那些发表如下言论的人应该被用钢勺慢慢地反复打到倒下为止：

> “Spark 默认情况下安全功能是关闭的。这可能意味着你默认就容易受到攻击。”

但我有些跑题了。我的意思是，DevOps 和向云端的转变正在带来极大的变化，我们的黑客直觉可能需要做一些小的调整，才能保持在正确的轨道上。

这就是点燃并驱动我写这本书的顿悟。

## 本书的工作原理

这不是一本典型的技术书籍。它不会有传统意义上的教程。我们将扮演黑客的角色，我们的目标是（虚构的）政治咨询公司 Gretsch Politico。我将带你走进黑客的一天（或几天），从头到尾：从建立一个合适的匿名基础设施，到进行一些初步侦察，再到最终渗透并利用目标。书中提到的公司和名字大多是虚构的，除了像 Twitter 和 Kubernetes 这样的显而易见的例子。所以，虽然你可以从中适应并尝试（我鼓励你这样做），但你不会完全按每一步的展示方式操作。例如，我们最终将入侵 Gretsch Politico 首席执行官 Alexandra Styx 的电子邮件。无论是公司还是 Styx 本人都不存在。

在我们的旅程中，我们会遇到许多死胡同和障碍，但我会向你展示如何利用即使是最微薄的成果，也能为你开辟另一条道路。这就是现实世界中安全的运作方式。并不是每条路都会通向成功，但只要足够坚持一点创意，再加上一点运气，你会偶然发现一些有趣的发现。

为了保持我们的第四面墙，从现在开始我们将把我们的目标视作与你我一样具体的存在。

让我们谈谈这次黑客冒险的目标。Gretsch Politico Consulting 是一家帮助未来当选官员进行政治竞选的公司。Gretsch Politico（我们也称之为 GP）声称拥有数百万个数据点和复杂的建模档案，能够有效地与关键受众互动。正如他们在网站上所说的，“选举常常取决于最后几个关键选民。我们的数据管理和微观定向服务帮助你在正确的时间接触到正确的人。”

用外行话来说：“我们拥有数百万人的喜好和厌恶的大型数据库，可以推动任何必要的内容来服务你的政治议程。”

是不是看起来更清晰，但也更吓人了？

我希望我是在编造这些东西，但可悲的是，几乎所有所谓的民主选举现在都在以这种方式运作，所以我们不妨将它作为本书黑客场景的训练场。

## 模糊计划

我不想在比赛前透露太多，但简单概述一下，这本书分为四个部分。第一部分“抓住我，如果你能”帮助你建立一个强大的黑客基础设施——一个能够保证在线匿名性和恢复力的基础设施。我们将装备一套自定义脚本、容器和指挥与控制（C2）服务器，并以自动化的方式构建一个后端攻击基础设施，以达到最大效率。

带着我们的武器，第二部分“更加努力”列出了你需要执行的基本侦察工作，以便理解你的目标并发现那些有价值的漏洞。

在第三部分“全方位沉浸”中，我们进入一个荒芜短暂的环境，利用它从一个应用程序转向另一个，从一个账户转向另一个，直到我们完全掌控目标的基础设施。

最后，在第四部分“内在敌人”中，我们将所有内容整合起来，通过巧妙地梳理数 TB 的数据，利用目标之间隐藏的联系来收获我们的成果。

我们不会针对每个技术或工具都深入探讨，否则本书将永无止境。相反，在每一章的结尾，我都会提供一些资源供你在闲暇时查阅。
