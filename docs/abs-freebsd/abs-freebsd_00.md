## 引言

![image](img/common01.jpg)

欢迎来到*Absolute FreeBSD*！本书是系统管理员的综合指南，适合那些希望构建、配置和管理 FreeBSD 服务器的人。对于那些希望在桌面、嵌入式设备、服务器农场等设备上运行 FreeBSD 的人来说，本书也同样有用。完成本书后，您应该能够使用 FreeBSD 提供网络服务。您还应该了解如何管理、修补和维护您的 FreeBSD 系统，并对网络、系统安全和软件管理有基本的了解。我们将讨论 FreeBSD 11 和 12 版本，这些是本书发布时最新的版本；然而，本书的大部分内容同样适用于早期和更高版本。

### **什么是 FreeBSD？**

*FreeBSD* 是一种自由可用的类 Unix 操作系统，在互联网服务提供商、家电和嵌入式系统中非常流行，适用于任何对普通硬件可靠性要求极高的场合。就在上周的某一天，FreeBSD 奇迹般地出现在互联网上，完全形成，直接从其英雄创造者的高远智慧中挤压出来。开玩笑的——事实上，真相更为令人印象深刻。FreeBSD 是近四十年持续开发、研究和改进的结果。FreeBSD 的故事始于 1979 年，与 BSD 有关。

#### ***BSD：FreeBSD 的祖先***

多年前，AT&T 需要大量定制的软件来支持其业务运行。然而，由于不能在计算机行业中竞争，AT&T 不能出售其软件。因此，AT&T 以低廉的价格将各种软件和其源代码授权给大学。大学通过使用这些软件代替价格高昂的商业软件节省了开支，而有机会接触这些技术的大学生可以查看源代码，了解其工作原理。作为回报，AT&T 获得了曝光、一些零花钱，以及一代计算机科学家，他们从 AT&T 的技术中汲取了经验。每个人都从中受益。根据这种授权计划分发的最著名软件是 Unix。

与现代操作系统相比，最初的 Unix 存在许多问题。然而，成千上万的学生有机会接触其源代码，而且成百上千的教师需要为学生提供有趣的项目。如果某个程序表现异常，或者操作系统本身出现问题，那么那些每天使用系统的人具备修复它的工具和动机。他们的努力迅速改善了 Unix，并创造了许多我们现在认为理所当然的功能。学生们增加了控制正在运行的进程的能力，也就是 *作业控制*。Unix S51K 文件系统让系统管理员像精疲力竭的幼儿一样哭泣，因此他们用快速文件系统（FFS）替换了它，而 FFS 的特性已经扩展到每一个现代文件系统。多年来，许多小型的、有用的程序被编写出来，逐渐取代了 Unix 中的整块功能。

加利福尼亚大学伯克利分校的计算机系统研究小组（CSRG）参与了这些改进，并且还充当了 Unix 代码改进的中央清算中心。CSRG 收集了其他大学的修改，评估它们，打包后免费分发给任何持有有效 AT&T UNIX 许可证的人。CSRG 还与国防高级研究计划局（DARPA）签订合同，以实现 Unix 中的各种功能，比如 TCP/IP。最终，所有的软件集合被称为 *伯克利软件分发版*，或 *BSD*。

BSD 用户拿到软件后，进一步改进了它，然后将他们的改进反馈到 BSD 中。今天，我们认为这是一个开放源代码项目运行的相当标准的方式，但在 1979 年，这种方式是革命性的。BSD 也相当成功；如果你查看旧的 BSD 系统上的版权声明，你会看到这个：

```
Copyright 1979, 1980, 1983, 1986, 1988, 1989, 1991, 1992, 1993, 1994
        The Regents of the University of California. All rights reserved.
```

没错，15 年的工作——在软件开发中，这是一生的时间。还有哪些软件不仅依然在使用，而且在工作开始 15 年后，仍在积极开发？事实上，BSD 经历了如此多的增强和改进，以至于 CSRG 发现，随着时间的推移，它几乎用 CSRG 及其贡献者创建的代码替代了原始的 Unix 代码。你需要仔细找，才能发现任何原始的 AT&T 代码。

最终，CSRG 的资金逐渐减少，显然 BSD 项目将会结束。经过加利福尼亚大学内部的一些政治斗争后，1992 年，BSD 代码在所谓的 *BSD 许可证* 下公开发布给大众。

#### ***BSD 许可证***

BSD 代码可以供任何人使用，依据的是可能是软件开发历史上最宽松的许可证。该许可证可以总结为以下几点：

+   不要声称你写了这个。

+   如果它崩溃了，不要怪我们。

+   不要利用我们的名字来推广你的产品。

这意味着你几乎可以用 BSD 代码做任何你想做的事情。（原 BSD 许可证确实要求如果软件产品包含 BSD 授权的代码，用户必须被通知，但这个要求后来被取消了。）甚至没有要求你与原作者共享你的修改！人们可以自由地将 BSD 纳入专有产品、开源产品或免费产品——甚至可以将它打印在穿孔卡片上，铺满整个草坪。你想制作 10,000 份 BSD 光盘并分发给朋友？随便。BSD 许可证有时被称为*复制中心*许可证，而不是*版权*，意思是*把这个拿到复印中心，自己复印几份*。毫不奇怪，像 Sun Microsystems 这样的公司立即抓住了这个机会：它是免费的、有效的，而且很多新毕业生都有使用这项技术的经验——其中包括 Sun 的创始人之一比尔·乔伊。有一家公司 BSDi，就是专门为了利用 BSD Unix 而成立的。

#### ***AT&T/CSRG/BSDi 铁笼大战***

在 AT&T，UNIX 的工作持续进行，即便 CSRG 也在其自得其乐地进行着。AT&T 将 BSD Unix 发行版的部分内容与其 UNIX 系统集成，并将修改后的结果重新授权给提供这些改进的大学。这对 AT&T 来说运作良好，直到公司被拆分，拆分后的公司被允许在计算机软件行业竞争。AT&T 拥有一项特别有价值的资产：一款经过成千上万的人调试过的高端操作系统。这个操作系统具有许多有用的功能，如多种小而强大的命令、现代文件系统、作业控制和 TCP/IP。AT&T 成立了一家子公司——Unix Systems Laboratories（USL），并开始愉快地向企业销售 Unix，并收取非常高的费用，同时保持与大学的关系，这也是最初赋予它如此先进操作系统的原因。

伯克利大学在 1992 年公开发布 BSD 代码时，遭到了 USL 的强烈反对。几乎立即，USL 将大学和那些利用该软件的软件公司起诉了，特别是 BSDi。加利福尼亚大学声称，CSRG 是从与 AT&T 无关的成千上万的第三方贡献者那里编译了 BSD，因此这属于 CSRG 的知识产权，可以自行处置。

这场诉讼促使许多人拿起一份 BSD，看看究竟是什么引发了如此多的争议，而另一些人则开始在其基础上构建产品。其中之一就是 386BSD，最终成为 FreeBSD 1.0 的核心。

1994 年，在经历了两年的法律争斗后，加利福尼亚大学的律师证明，AT&T UNIX 的大部分内容实际上完全来自 BSD，而不是相反。更糟的是，AT&T 实际上违反了 BSD 许可证，通过去除 CSRG 版权信息的方式剥夺了它所吸收的文件的版权。（只有非常特别的公司才能违反世界上最慷慨的软件许可证！）最终，争议的焦点仅在于六个文件，为了解决这些悬而未决的问题，USL 将其中的一些文件捐赠给了 BSD，同时将一些保留为专有信息。

一旦尘埃落定，新的 BSD Unix 版本作为 BSD 4.4-Lite 发布到了世界上。随后的更新版 BSD 4.4-Lite2 是当前 FreeBSD 的“祖父”，也是今天所有 BSD 变体的先祖。

#### ***FreeBSD 的诞生***

BSD 的一个早期成果是 386BSD，这是一个旨在运行在廉价的 386 处理器上的 BSD 版本。^(1) 386BSD 项目成功地将 BSD 移植到了英特尔的 386 处理器上，但项目停滞了。经过一段时间的忽视，一群 386BSD 用户决定独立发展，创建 FreeBSD，以便保持操作系统的更新。（大约在同一时期，其他几个小组也开始从 386BSD 分支出来，其中只有 NetBSD 至今仍然存在。）

386BSD 和 FreeBSD 1 源自 1992 年发布的 BSD 版本，这是 AT&T 愤怒的源头。由于这场诉讼，所有使用原始 BSD 的用户都被要求基于 BSD 4.4-Lite2 进行后续工作。BSD 4.4-Lite2 并不是一个完整的操作系统——尤其是那些 AT&T 保留为专有的文件对系统的正常运行至关重要。（毕竟，如果这些文件不重要，AT&T 根本就不会去管它们！）FreeBSD 开发团队紧急工作，替换了这些丢失的文件，很快就发布了 FreeBSD 2.0。从那时起，开发工作一直在持续进行。

如今，FreeBSD 被一些最重要、最具影响力的互联网公司广泛应用。Netflix 的内容传输系统完全运行在 FreeBSD 上。IBM、Dell/EMC、Juniper、NetApp、Sony 等众多硬件公司在嵌入式系统中使用 FreeBSD，除非有人告诉你，否则你根本不会察觉。事实上，如果一个公司需要处理大量的互联网带宽，那么它很可能在使用 FreeBSD 或其 BSD 系列的某个变种。

FreeBSD 还广泛应用于各种嵌入式和专用设备中。你有 PlayStation 4 吗？恭喜，你正在运行 FreeBSD。不过，我听说在这些设备上获取 root shell 比较困难。

就像雾霾、蜘蛛和玉米糖浆一样，FreeBSD 无处不在；你之所以看不见它，是因为 FreeBSD 就是这么好用。FreeBSD 稳定性的关键在于其开发团队和用户社区——它们实际上是同一个东西。

### **FreeBSD 开发**

有句老话说，管理程序员就像是在赶猫。尽管 FreeBSD 开发团队分散在全球各地，且讲着数十种语言，但大多数情况下，成员们作为 FreeBSD 社区的一部分，能够很好地协作。他们更像是一群狮子，而不是一群家猫。与其他一些项目不同，FreeBSD 的所有开发工作都在公开进行。负责 FreeBSD 进展的有三个群体：提交者、贡献者和用户。

#### ***提交者***

FreeBSD 大约有 500 名开发者，或称提交者。*提交者*拥有 FreeBSD 主源代码库的读写权限，可以开发、调试或增强系统的任何部分。（“提交者”一词来源于他们能够*提交*代码更改。）由于这些提交可能会以微妙或明显的方式破坏操作系统，提交者肩负着沉重的责任。提交者负责保持 FreeBSD 的正常运行，或者至少在加入新功能和评估贡献者的补丁时，不会破坏系统。大多数开发者是志愿者；只有少数人是被支付报酬来做这项艰苦工作的，而且这些人通常与其他工作有关。例如，英特尔雇佣提交者来确保 FreeBSD 正确支持其网络卡。由于 FreeBSD 在互联网的重负载群体中有着很高的知名度，因此英特尔需要确保其卡片在 FreeBSD 上正常工作。

要将自己融入 FreeBSD 开发的“蜂巢”中，可以考虑订阅邮件列表* FreeBSD-hackers@FreeBSD.org*，其中包含了大部分的技术讨论。有些技术讨论被分拆到更具体的邮件列表中——例如，网络实现的细节会在* FreeBSD-net@FreeBSD.org*中讨论。

每隔几年，提交者团队会选举少数成员组成核心团队，或者称为*Core*。Core 的工作既至关重要，又常常被低估和误解。理论上，Core 负责 FreeBSD 的整体管理，但实际上，它几乎不涉及其他事务，主要职责是解决提交者之间的个性冲突和程序冲突。Core 还负责批准新的提交者，并将 FreeBSD 的许多部分的责任委托给个人或团队。例如，它将端口和软件包系统的管理权限委托给端口管理团队。Core 不会为 FreeBSD 设定架构方向，也不会规定流程或程序；这些都由提交者们决定，他们必须集体达成一致。然而，Core 会提出建议、劝导、调解并激励大家。

Core 团队也经历了管理中的最艰难部分。公司管理的几个关键职能包括监督、激励和处理人员之间的问题。监督由成千上万的用户提供，他们在任何东西出故障或表现异常时都会大声抱怨，而 FreeBSD 的提交者则是自我激励的。管理中的棘手部分是解决两人之间的争执，这正是 Core 团队需要处理的部分。说“我是 Core 成员”所获得的地位，并不足以弥补需要管理两位才华横溢的开发人员之间偶尔的争吵，尤其是当他们已经互相惹恼的时候。幸运的是，这种争议很少，并且通常能很快解决。

#### ***贡献者***

除了提交者团队，FreeBSD 还有成千上万的贡献者。*贡献者*不需要担心破坏主操作系统源代码库；他们提交补丁供提交者考虑。提交者会评估贡献者的提交内容，决定接受什么，拒绝什么。提交许多高质量补丁的贡献者通常会被邀请成为提交者。

举个例子，我曾花了好几年时间在 FreeBSD 项目中贡献代码，随心所欲地提交补丁。每当我觉得自己浪费了生命时，我会去看看 FreeBSD 的网站，看到我的工作被提交者接受并分发给成千上万的人。在我将这本书的第一版提交给出版社后，我在空闲时间向 FreeBSD FAQ 提交补丁。最终，FreeBSD 文档项目的成员联系了我，并邀请我成为提交者。作为奖励，我得到了一个电子邮件地址，并有机会再次在成千上万的人面前出丑，证明了“好事不常有”的道理。

如果我从未做出任何贡献，我可能仍然是个用户。其实，这也没什么不对。

#### ***用户***

*用户*是那些运行 FreeBSD 系统的人。实际估算 FreeBSD 用户的数量几乎是不可能的。尽管像 BSDstats 项目（*[`www.bsdstats.org/`](http://www.bsdstats.org/)）这样的组织付出了努力，但这些项目是自愿参与的。它们只衡量那些已安装 FreeBSD 并安装了将其系统添加到统计中的软件的人。大多数用户免费下载安装了完整的 FreeBSD，并且从未注册、升级或加入邮件列表。我们无法知道全球有多少 FreeBSD 用户。

由于 FreeBSD 目前是最受欢迎的开源 BSD 系统，这意味着使用 FreeBSD 的机器数量相当庞大。而且，由于一台 FreeBSD 服务器能够处理成千上万个互联网域名，很多网站将 FreeBSD 作为其支持的操作系统。这意味着今天世界上有成千上万，甚至可能是百万计的 FreeBSD 系统管理员。

### **其他 BSD 系统**

FreeBSD 可能是最受欢迎的 BSD，但它并不是唯一的。BSD 4.4-Lite2 衍生出了几个不同的项目，每个项目都有自己的焦点和目标。这些项目又衍生出一些后代，其中有几个至今仍在蓬勃发展。

#### ***NetBSD***

NetBSD 在许多方面与 FreeBSD 相似，NetBSD 和 FreeBSD 共享开发人员和代码。NetBSD 的主要目标是提供一个安全可靠的操作系统，可以以最小的努力移植到任何硬件平台。因此，NetBSD 能够在 Vixen、PocketPC 设备以及高端 SPARC 和 Alpha 服务器上运行。我曾在我的 HP Jornada 手持电脑上运行 NetBSD。^(2)

#### ***OpenBSD***

OpenBSD 于 1996 年从 NetBSD 分支出来，目标是成为最安全的 BSD。OpenBSD 是第一个支持硬件加速加密的操作系统，且其开发者为他们的默认安装在数年内几乎免受远程攻击而感到自豪。OpenBSD 团队为世界贡献了几项宝贵的软件，包括 LibreSSL TLS 库和 OpenSSH 套件，几乎每个从 Linux 到 Microsoft 的系统都在使用这些工具。

#### ***DragonFly BSD***

DragonFly BSD 于 2003 年从 FreeBSD 4 分支出来。它的发展方向与 FreeBSD 不同，采用了一个新的内核消息系统。DragonFly BSD 拥有非常高的性能，其 HAMMER 文件系统支持快照和精细化历史管理。欲了解更多信息，请访问* [`www.dragonflybsd.org/`](http://www.dragonflybsd.org/)*。

#### ***macOS***

Apple 的 macOS？没错，Apple 持续将大量 FreeBSD 的代码块集成到其 macOS 中。如果你在寻找一个稳定的操作系统，既有友好的界面又有强大的内核，macOS 无疑适合你。虽然 FreeBSD 为计算机专业人士提供了一个极好的桌面环境，但我不会把它推荐给普通用户。然而，我毫不犹豫地会把 macOS 推荐给那些随机的用户，而且我会觉得自己做了正确的选择。但 macOS 包含了很多对互联网服务器完全没有必要的东西，并且只在 Apple 硬件上运行，因此我不推荐它作为一个经济实用的通用服务器。

#### ***FreeBSD 的后代***

一些项目基于 FreeBSD 开发了其他项目或产品。屡获殊荣的 FreeNAS 将一台普通系统转变为网络文件服务器。pfSense 项目将你的系统转变为带有漂亮网页管理界面的防火墙。TrueOS 在支持资源密集型高级功能（如 ZFS）的同时，还为 FreeBSD 增添了一个友好的界面，而 GhostBSD 则在硬件计算能力较弱的设备上提供了一个友好的界面。类似的其他项目不时出现，虽然并非所有都成功，但我敢肯定，在这本书出版时，我们会看到一两个更为成熟的项目加入这一群体。

### **其他 Unix 系统**

其他一些操作系统或多或少地从原始 Unix 派生或模仿。这个列表并不全面，但我会简要提到其中的一些亮点。

#### ***Solaris***

最著名的 Unix 可能是 Oracle Solaris。Solaris 运行在支持数十个处理器和大量磁盘的高端硬件上。（是的，*gobs*是一个技术术语，意思是*比你可能需要的任何数量都多，而且我非常清楚你需要的磁盘比我认为你需要的要多*。）Solaris，尤其是早期版本的 Solaris，具有强大的 BSD 根基。许多企业级应用程序都在 Solaris 上运行。Solaris 主要运行在 Sun 制造的 SPARC 硬件平台上，这使得 Sun 能够支持一些有趣的功能，如热插拔内存和主板。

Oracle 公司在 2009 年收购 Sun Microsystems 时获得了 Solaris。Oracle 于 2016 年停止了 Solaris 的开发。尽管 Solaris 系统仍然有广泛的安装基础，并且你仍然可以从 Oracle 获得 Solaris，但截至今天，Oracle Solaris 已经没有未来了。

#### ***illumos***

在甲骨文（Oracle）收购 Sun Microsystems 之前，Sun 公司将 Solaris 的大部分代码开源，并且赞助了 OpenSolaris 项目以改进该代码库。OpenSolaris 成功运行了多年，直到 Oracle 关闭了源代码访问并收回了所有 OpenSolaris 资源。

不过，OpenSolaris 的代码仍然是可以访问的。OpenSolaris 社区将 OpenSolaris 分叉成了 illumos (*[`illumos.org/`](http://illumos.org/)*)。如果你怀念 Solaris，你仍然可以使用一个免费的、现代的、类似 Solaris 的操作系统。FreeBSD 包括了 OpenSolaris 中的两个重要特性：Zetabyte 文件系统（ZFS）和 DTrace，一个全系统追踪系统。

#### ***AIX***

另一个 Unix 的竞争者是 IBM 的 AIX。AIX 的主要特点是其日志文件系统，它会记录所有磁盘事务并在发生时进行处理，从而允许在崩溃后快速恢复。多年来，它也是 IBM 的标准 Unix 系统，而任何由 IBM 支持的系统都会随处可见。AIX 最初是基于 BSD 的，但 AT&T 几乎对一切都进行了修改，因此今天你几乎找不到 BSD 的痕迹了。

#### ***Linux***

Linux 是 Unix 的一个近亲，从头开始编写。Linux 在很多方面类似于 FreeBSD，尽管 FreeBSD 有着更悠久的历史，并且比 Linux 更适合商业使用。Linux 要求任何分发 Linux 的用户必须将自己所做的更改提供给最终用户，而 BSD 则没有这样的限制。当然，一位 Linux 爱好者会说，“FreeBSD 更容易被商业化开发者利用，而 Linux 则不是。”Linux 开发者相信共享精神，而 BSD 开发者则提供无条件赠送的礼物给大家。这一切都取决于你认为什么更重要。

许多新的 Unix 用户对 BSD 和 Linux 阵营之间的冲突有一定的看法。然而，如果你深入了解，你会发现这些操作系统的大多数开发者都以友好和开放的方式进行交流与合作。只是少数极端的用户和开发者制造了摩擦，类似于不同足球队的球迷暴徒或不同*星际迷航*系列的粉丝。^(3)

#### ***其他 Unix 系统***

许多 Unix 系统已经消失，其他的一些则继续挣扎。过去的竞争者包括 Silicon Graphics 的 IRIX、Hewlett-Packard 的 HP/UX、Tru64 Unix 和自杀性的 SCO Group 的 UnixWare。进一步挖掘，你会发现一些较老的遗弃产品，包括 Apple 的 A/UX 和 Microsoft 的 Xenix。（没错，微软曾是一个获得许可的 Unix 供应商，那时恐龙还在紧张地看着天空，而我爸还在为部落仪式狩猎猛犸象。）许多高端应用程序被设计成最好运行在某个特定的 Unix 版本上。所有现代 Unix 系统都从这些老旧操作系统中吸取了经验教训，今天的 Unix 系统和类 Unix 系统非常相似。

**为什么是类 Unix？**

需要注意的一点是，FreeBSD、Linux 等操作系统被称为*类 Unix*，而不是*Unix*。*Unix*一词是 The Open Group 的商标。要获得“Unix”这一称号，操作系统的供应商必须证明其操作系统符合当前版本的单一 Unix 规范。虽然 FreeBSD 一般符合该标准，但持续的测试和再认证需要费用，而 FreeBSD 项目没有多余的资金。被认证为 Unix 还需要有人签署文件，声明他或她不仅对 FreeBSD 符合单一 Unix 规范负责，而且承诺将来会修复任何发现的标准偏差。FreeBSD 的开发模式使得这一点更加困难——尽管会发现漏洞并修复偏差，但没有人能签署一份保证 100%符合标准的文件。

### **FreeBSD 的优势**

经过这些介绍，是什么让 FreeBSD 与众不同？

#### ***可移植性***

FreeBSD 项目的目标是提供一个可以自由分发、稳定且安全的操作系统，运行在最常见的计算机硬件上。人们还将 FreeBSD 移植到了多种不太流行的平台上。

最受支持的 FreeBSD 平台是由 AMD 开发的常见 64 位硬件，几乎所有人都在使用，甚至 Intel 也在模仿。FreeBSD 还完全支持较旧的 32 位计算机，如 486 和各种型号的奔腾。 本书使用 64 位商用硬件，或称*amd64*，作为参考平台。

FreeBSD 在其他几种硬件架构上也能运行良好，但这些架构目前还不完全支持，包括 32 位 ARM 处理器和 PowerPC。虽然这些平台并非被忽视，但它们并没有像 x86 和 amd64 那样得到同等的关注。然而，64 位 ARM 平台预计将在本书发布后不久成为一级支持平台。

你还可以将 FreeBSD 安装到某些较旧的架构上，如 64 位 SPARC。这些平台曾经得到了很好的支持，但现在正逐渐退出市场。

#### ***性能***

由于 FreeBSD 在 486 处理器上运行良好，因此在现代计算机上表现极为出色。拥有一个不需要 8 个核心和 12 GB 内存来运行用户界面的操作系统是相当不错的。因此，你可以真正将硬件资源用于完成实际工作，而不是那些你不关心的任务。如果你选择运行一个漂亮的图形界面，带有各种旋转的小饰品和花哨的铃声，FreeBSD 会支持你，而且如果你选择其他方式，它也不会给你带来惩罚。FreeBSD 还会在最新的 *n* -CPU 硬件上为你提供支持。

#### ***简化的软件管理***

FreeBSD 还通过软件包系统和 Ports 集合简化了软件管理。传统上，在类似 Unix 的系统上运行软件需要大量的专业知识。软件包和 Ports 大大简化了这一过程，通过自动化和记录数千个软件包的安装、卸载和配置过程。

我们将在第十五章讨论软件包，在第十六章讨论 Ports。

#### ***可定制的构建***

FreeBSD 提供了一个无痛的升级程序，但它也允许你根据硬件精确定制操作系统。像苹果这样的公司也在做这件事，但他们控制着硬件和软件；FreeBSD 在普通硬件上完成了同样的操作。

#### ***高级文件系统***

*文件系统*是信息如何存储在物理磁盘上的方式——它将文件 *我的简历* 映射为硬盘上的一系列零和一。FreeBSD 包含两种广泛支持的文件系统，UFS（第十一章）和 ZFS（第十二章）。UFS 已经存在了几十年，并且非常耐用。ZFS 虽然较年轻，但包括了如网络复制和自我修复等功能。

### **谁应该使用 FreeBSD？**

虽然 FreeBSD 可以用作强大的桌面或开发机器，但它的历史显示出明显的网络服务偏向：网页、邮件、文件和辅助应用程序。FreeBSD 因其在互联网服务器方面的优势而最为人知，作为任何网络服务的底层平台，它是一个非常出色的选择。如果像 Netflix 这样的主要公司依赖 FreeBSD 提供可靠的服务，它同样会为你提供稳定的表现。

如果你打算在桌面上运行 FreeBSD（或任何 Unix），你需要了解你的计算机如何工作。如果你需要简单的点击操作，FreeBSD 可能不是最佳选择。如果这是你的目标，建议你购买一台 Mac，这样你可以在需要时使用 Unix 的强大功能，而其余时间不必为此担心。不过，如果你想学习 FreeBSD，那么在桌面上运行它是最好的方法——我们稍后会讨论这一点。

### **谁应该运行另一个 BSD 系统？**

NetBSD 和 OpenBSD 是 FreeBSD 最接近的竞争者。与商业世界的竞争者不同，这种竞争大多是友好的。FreeBSD、NetBSD 和 OpenBSD 自由地共享代码和开发人员；有些人甚至在多个操作系统中维护相同的子系统。

如果你想使用旧的或不常见的硬件，NetBSD 是一个不错的选择。几年间，我曾在一台古老的 SGI 工作站上运行 NetBSD，将它作为域名系统（DNS）和文件服务器使用。它运行得非常好，直到硬件最终冒出一股烟雾并停止工作。

OpenBSD 实现了令人印象深刻的多种安全功能。部分工具最终会被整合到 FreeBSD 中，但这需要几个月甚至几年时间。然而，有些工具永远无法在 FreeBSD 中复制。如果你有真实的安全担忧，并且可以在没有 FreeBSD 提供的功能集的情况下使用类 Unix 系统，可以考虑 OpenBSD。你可以阅读我的书籍《Absolute OpenBSD》（No Starch Press，2013），了解更多介绍。

如果你只是想尝试看看有哪些 BSD 系统，任何一个 BSD 都可以！

### **谁应该运行专有操作系统？**

尽管开源操作系统在不断蚕食市场份额，像 macOS、Windows、AIX 等操作系统仍然非常流行。高端企业通常紧紧依赖于商业操作系统。虽然这种情况正在慢慢变化，但在这些环境中，你可能还是不得不依赖商业操作系统。不过，偶尔加入一台 FreeBSD 机器来处理基本服务，比如监控和部门文件服务，可以大大简化工作，并且成本更低。像 Dell/EMC/Isilon 这样的公司就通过使用 FreeBSD 而非商业操作系统建立了整个业务。

当然，如果你需要的某个软件仅能在专有操作系统上运行，那么你的选择就非常明确了。尽管如此，始终向供应商询问是否有 FreeBSD 版本；你可能会感到惊喜。

### **如何阅读本书**

许多计算机书籍厚重得足以让一头牛晕倒，前提是你有足够的力量将它们抬得足够高。而且，它们的内容要么是百科全书式的广泛覆盖，要么是详细到让人难以真正读完的程度。当你被告知点击“确定”或接受许可协议时，真的需要参考截图吗？你上次真的坐下来阅读百科全书是什么时候？

*Absolute FreeBSD* 有些不同。它是设计为一次性从头到尾阅读的。你可以跳着读，但每一章都建立在前面的内容基础上。虽然这本书不小，但比许多流行的计算机书籍要小。读完一遍之后，它可以作为一个不错的参考书。

如果你是计算机书籍的常客，欢迎随意插入一些通常的建议，比如“每次阅读一章以达到最佳学习效果”等等。我不会宠爱你——如果你拿起这本书，说明你要么有两颗脑细胞能互相碰撞，要么你正在拜访一个有这两颗脑细胞的人。（如果是后者，希望你的主人足够聪明，在你学到足够多的知识，变得有点危险之前，就把这本书拿走。）

### **你必须知道什么？**

本书面向的是新的 Unix 管理员。三十年前，普通的 Unix 管理员有内核编程经验，并且正在攻读计算机科学硕士学位。即使是十年前，他们已经是熟练的 Unix 用户，拥有一定的编程技能，并且大多拥有计算机科学学士学位。如今，类 Unix 操作系统已经可以免费获取，计算机比食物还便宜，甚至 12 岁的孩子也能运行 Unix，阅读源代码，并学到足以让年长者感到自愧不如的知识。因此，我并不指望你在启动系统之前就掌握大量 Unix 知识。

为了充分发挥本书的潜力，你需要熟悉一些基本任务，比如如何更改目录、列出目录中的文件，以及如何使用用户名和密码登录。如果你不熟悉基本命令和 Unix shell，建议你从 Evi Nemeth 等人所著的《*UNIX 系统管理手册*》（Prentice Hall PTR，2017）这本书开始。为了方便新的系统管理员，我提供了产生所需结果的确切命令。如果你更喜欢通过示例学习，你应该在这里找到所有需要的内容。

你还需要了解一些计算机硬件知识——不需要太多，适量即可。了解如何识别 SATA 数据线是有帮助的。你对这些知识的需求取决于你所使用的硬件，但如果你有足够兴趣拿起这本书并读到这里，你大概已经了解得足够多了。

### **对于新手系统管理员**

如果你是 Unix 新手，学习的最好方式就是亲自实践。不是的，我不是建议你和罗威尔一起吃饭。如果你经营一家狗粮公司，你肯定希望生产一种你自己的狗会开心吃的产品。如果你的狗对你最新的配方嗤之以鼻，那你就有问题了。这里的重点是，如果你使用某个工具或创造某样东西，你应该亲自去使用它。同样的道理也适用于任何类 Unix 操作系统，包括 FreeBSD。

#### ***Desktop FreeBSD***

如果你真心想学习 FreeBSD，我建议你把主计算机上的操作系统抹掉，改为运行 FreeBSD。不是像 TrueOS 或 GhostBSD 这样的桌面导向的 FreeBSD 衍生版本：直接运行原版 FreeBSD。是的，我知道，现在这种“狗粮”听起来不那么糟糕了。但学习操作系统就像学习一门语言；完全沉浸式学习是最迅速、最有效的学习方式。这就是我当时做的，今天我可以让一个类似 Unix 的系统做我想做的任何事。我已经在一台 FreeBSD 笔记本上写了整本书，使用开源文本编辑器 XEmacs 和 LibreOffice.org 办公套件。我还使用 FreeBSD 看电影，刻录并听 MP3，平衡我的银行账户，处理我的电子邮件，浏览网页。实验室里的桌面上运行着十二个动画的 BSD 守护进程，它们在窗口管理器周围跑来跑去，我偶尔会停下来，用鼠标点击它们。如果这不算一个“愚蠢桌面技巧”，那我就不知道什么算了。^(4)

许多 Unix 系统管理员现在都来自 Windows 背景。他们在自己的小世界里忙碌着，这时他们的经理突然出现，说：“你能再处理一个系统吗？我很高兴听到这个消息！顺便告诉你，它是一个 Unix 系统。”然后消失在管理层的空气中。一旦这位新 Unix 管理员决定不辞职，去开始一份新鲜而激动人心的鲸鱼尸检技术员的工作，她就小心翼翼地尝试操作系统。她了解到，`ls` 类似于 `dir`，`cd` 在两个平台上都是相同的。她可以通过死记硬背、阅读和经验来学习命令。她无法学到的是，来自这种背景的她，如何理解 Unix 机器是如何*思考*的。Unix 不会根据你来调整，你必须适应它。Windows 和 macOS 也需要类似的调整，但它们将这些调整隐藏在华丽的外表之下。考虑到这一点，让我们花些时间来学习如何思考 Unix。

#### ***如何思考 Unix***

现在，大多数 Unix 系统自带相当不错的图形用户界面（GUI），但它们仅仅是装饰。无论桌面看起来多么华丽，真正的工作还是发生在命令行上。Unix 的命令行实际上是 Unix 的优势之一，正是它赋予了系统无与伦比的灵活性。

Unix 的基本哲学是 *许多小工具，每个工具都能很好地完成一项任务*。我的邮件服务器的本地程序目录（*/usr/local/bin*）里有 262 个程序。我安装了其中的每一个，要么是直接安装，要么是间接安装。大多数程序都是小巧简单的，只执行一项任务。这种小工具的集合使得 Unix 极其灵活和可扩展。许多商业软件包尝试做所有事情；它们拥有各种各样的功能，但核心功能的表现通常平庸。记住，曾经你需要是一个程序员才能使用 Unix 系统，更不用说运行它了。程序员不介意自己构建工具。Unix 的管道概念鼓励了这一点。

##### **管道**

习惯了图形界面环境（如 Windows 和 macOS）的人可能不太熟悉 Unix 如何处理输入和输出。他们习惯了点击某个东西并看到一个确认消息、错误、什么都没有，或者（更常见的是）一个漂亮的蓝色屏幕，上面用一种叫做 *Geek* 的语言解释为什么系统崩溃了。Unix 做事情有些不同。

Unix 程序有三种通信渠道，或称 *管道*：标准输入、标准输出和标准错误。一旦你理解了这些管道是如何工作的，你就离理解整个系统更进一步了。

*标准输入* 是信息的来源。当你在控制台输入命令时，标准输入就是来自键盘的数据。如果一个程序正在监听网络，那么标准输入就是网络。许多程序可以重新安排标准输入，以接受来自网络、文件、另一个程序、键盘或任何其他来源的数据。

*标准输出* 是程序的输出显示的地方。通常这是控制台（屏幕）。网络程序通常将它们的输出返回到网络。程序可能将输出发送到文件、另一个程序、网络或计算机可以访问的任何其他地方。

最后，*标准错误* 是程序发送错误信息的地方。通常，控制台程序将错误信息返回给控制台；其他程序则将错误记录在文件中。如果你错误地设置了程序，它可能会丢弃所有错误信息。

这三种管道可以任意排列，这个概念可能是新 Unix 用户和管理员面临的最大障碍。例如，如果你不喜欢在终端上显示的错误信息，你可以将它们重定向到文件。如果你不想重复输入很多信息，你可以把信息放入文件中（以便重用），然后将文件内容导入命令的标准输入。或者，更好的是，你可以运行一个命令生成这些信息并将其放入文件中，或者直接将第一个命令的输出通过管道发送到第二个命令，而根本不需要使用文件。

##### **小程序、管道和命令行**

如果将这些输入/输出管道及各种工具推向其逻辑极限，它们看起来可能令人不知所措。当我在最初的 Unix 培训课程中看到一个系统管理员输入类似以下的内容时，我曾认真考虑过要不要换个职业。

```
$ tail -f /var/log/messages | grep -v popper | grep -v named &
```

一行行难以理解的文本开始在屏幕上滚动，而且源源不断。而更糟糕的是，我的导师还在输入，胡言乱语不停地冒出来！如果你来自一个点选式计算环境，那么像这样的长串命令绝对会让你感到害怕。那些奇怪的词是什么意思？还有一个和符号？你让我学*什么*？

把学习使用命令行当作学习一门语言来理解。当学习一门语言时，我们从简单的单词开始。随着词汇量的增加，我们也学会了如何将这些单词连在一起。我们了解到，按特定顺序排列单词是有意义的，而不同的顺序则毫无意义。你三岁时说话肯定不那么流利——给自己一点时间，你会做到的。

小巧简单的程序和管道提供了几乎无限的灵活性。你有没有曾经希望能将一个程序中的某个功能应用到另一个程序中？通过使用各种小程序并按照自己的需求安排输入和输出，你可以让 Unix 系统以任何你想要的方式运行。最终，如果你不能像这样通过 `| sort -rnk 6 | less` 来运行一个命令的输出，你会感觉自己被束缚住了。^(5)

##### **万物皆文件**

你在 Unix 环境中呆得久了，肯定会听到“万物皆文件”。程序、账户信息和系统配置都存储在文件中。Unix 没有 Windows 风格的注册表；如果你备份了这些文件，你就备份了整个系统。

更重要的是，系统将硬件识别为文件！你的 CD-ROM 驱动器是一个文件，*/dev/cd0*。串口以像 */dev/cuaa0* 这样的文件形式出现。甚至虚拟设备，如数据包嗅探器和硬盘分区，也是文件。

当你遇到问题时，请记住这一点：万物皆文件，或者至少某处的文件里有它。你要做的就是找到它！

### **第三版说明**

*Absolute BSD*（No Starch Press，2002 年）是我的第一本技术书，它写作时，各种 BSD 操作系统有更多的相似之处，尽管它们并不愿意承认。第二版 *Absolute FreeBSD*（No Starch Press，2007 年）在 BSD 系统分歧之后出版，详细介绍了过去五年 FreeBSD 的进展。随着又一个十年的发展，FreeBSD 已经进化到能够与最好的商业操作系统竞争的程度。你将会发现多种顶级的文件系统。磁盘管理也发生了变化，以适应新的分区方法。虚拟化如今已经成为现实，FreeBSD 既可以作为客户端也可以作为主机来支持虚拟化。

这种发展推动了本书的变化。

我们不会讨论如何配置邮件、DNS 或 Web 服务器。这些任务现在有比以往更多的软件选择。已经有整本书专门讲述这些选择及其使用方法。我也写过其中一些书。为了腾出空间介绍 FreeBSD 特定的内容，如 ZFS 和 Jail，这些话题被删减了。

其中一些新功能非常复杂。对 ZFS 的完整覆盖将填满整本书——我知道，因为我也写过那些书。FreeBSD 支持许多专用文件系统，每一个对需要它们的人都极为有用，而对不需要的人则完全无关紧要。与其写一本没人会读的巨著，我选择覆盖每个 FreeBSD 系统管理员*必须*知道的内容。如果你对某个特定话题的更深入内容感兴趣，它也可以提供。

一些子系统正在进行大规模的修订。我本可以等到每个 FreeBSD 子系统都有稳定接口后再写这本书，但那时书可能永远也出版不出来。写这本书时，bhyve 开发者正在积极地重构整个配置系统。在选择是简单略过一个话题还是提供完全错误的材料时，我选择跳过对 bhyve 的详细介绍。我希望在这本书出版之前能够删除这一段内容。

我已无情地删除了本版中的过时信息。例如，现代硬盘驱动器通常不需要担心写入缓存。如果你发现你记得使用的一些建议在本书中没有出现，请查阅 FreeBSD 的信息资源，看看这些建议是否仍然适用。

### **本书内容**

*Absolute FreeBSD* 第 3 版包含以下章节。

**第一章：获取更多帮助**

本章讨论了 FreeBSD 项目及其热心支持者为用户提供的信息资源。没有一本书可以涵盖所有内容，但知道如何使用互联网上的 FreeBSD 资源可以帮助填补你在这里找到的任何空白。

**第二章：安装前须知**

安装 FreeBSD 并不难。然而，如果在安装过程中做出错误选择，你将得到一个不适合你需求的系统。避免重新安装的最佳方法是事先考虑你的需求，并做出所有决策，这样实际安装时就不需要再动脑筋。

**第三章：安装**

本章概述了使用不同的分区方案和文件系统安装 FreeBSD。

**第四章：启动我吧！启动过程**

本章介绍了 FreeBSD 启动过程以及如何使你的系统在不同配置下启动、停止和重启。

**第五章：在你弄坏其他东西之前，先读这本书！（备份与恢复）**

在这里，我们讨论如何在系统级别和按文件级别备份数据，以及如何进行更改以便能够轻松撤销。

**第六章：内核游戏**

本章描述了配置 FreeBSD 内核。与其他一些操作系统不同，FreeBSD 要求你根据自己的需求来调整内核。这给了你巨大的灵活性，并且让你能够优化硬件的潜力。

**第七章：网络**

在这里，我们讨论了支撑现代互联网的 TCP/IP 协议，包括第 4 版和第 6 版。

**第八章：配置网络**

FreeBSD 不仅能疯狂快速地处理数据包，它还支持虚拟局域网、链路聚合等功能。我们将在这里配置这些功能。

**第九章：保护你的系统**

本章教你如何让你的计算机抵抗攻击者和入侵者。

**第十章：磁盘、分区与 GEOM**

本章介绍了在 FreeBSD 中使用硬盘的一些细节。使用现代硬件意味着需要理解多个分区方案、磁盘对齐以及 FreeBSD 的磁盘管理基础设施。

**第十一章：Unix 文件系统**

UFS 已经是 FreeBSD 的标准文件系统数十年了，UFS 的概念贯穿整个操作系统。无论你是否打算使用 UFS，都必须了解其基本要素。

**第十二章：Z 文件系统**

ZFS 是一种较新的文件系统，在大型系统中非常流行。如果你需要管理大量数据，你会需要 ZFS。

**第十三章：外部文件系统**

每个系统管理员都需要通过网络挂载磁盘或使用 ISO 文件，而无需将其烧录到 CD 上。本章将带你完成这些任务，并介绍 FreeBSD 特有的文件系统，如 devfs。

**第十四章：探索 /etc**

本章介绍了 FreeBSD 中的多个配置文件以及它们的工作方式。

**第十五章：让你的系统更有用**

在这里，我描述了 FreeBSD 用来管理附加软件的包管理系统。

**第十六章：使用端口定制软件**

有时预构建的软件包无法满足你所有的需求。你可以利用 FreeBSD 的包构建系统来创建你自己的软件包，定制以满足你的特定需求。

**第十七章：高级软件管理**

本章讨论了在 FreeBSD 系统上运行软件的一些细节。

**第十八章：升级 FreeBSD**

本章教你如何使用 FreeBSD 的升级过程。升级系统是所有操作系统中最卓越且最流畅的之一。

**第十九章：高级安全功能**

在这里，我们讨论了一些 FreeBSD 中更有趣的安全功能。

**第二十章：小型系统服务**

在这里，我们讨论了一些你需要管理的小程序，以便正确使用 FreeBSD。

**第二十一章：系统性能与监控**

本章介绍了 FreeBSD 的一些性能测试和故障排除工具，并展示了如何解读结果。我们还讨论了日志记录和 FreeBSD 的 SNMP 实现。

**第二十二章：监狱**

FreeBSD 拥有一个类似于 Linux 和 Solaris 容器的进程隔离子系统，叫做 *jails*。我们将介绍 jail 系统，以及如何利用它提高系统安全性。

**第二十三章：FreeBSD 的边缘**

本章将教你一些关于 FreeBSD 的有趣技巧，例如如何在没有磁盘或使用小磁盘的情况下运行系统，以及一些适合云环境的功能，比如 libxo。

**第二十四章：问题报告与崩溃**

本章将教你如何处理 FreeBSD 系统出现故障的罕见情况，如何调试问题，以及如何创建一个有用的问题报告。

你还会找到一份注释书目、后记以及一份非常棒的专业编制索引。

好的，前言就到这里。接下来继续！
