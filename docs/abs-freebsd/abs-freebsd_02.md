## 安装前

![image](img/common01.jpg)

仅仅让 FreeBSD 在您的计算机上运行是不够的，无论第一次安装时多么让您满足。确保您的安装是*成功的*同样重要。一个成功的安装应该是能够达到预期目的的。服务器与桌面计算机有着非常不同的需求，服务器的预期功能可能会完全改变安装需求。在安装 FreeBSD 之前做好充分的规划，可以使安装过程轻松很多。另一方面，由于您每次安装仅进行一次，您将得到的重复安装经验会少得多。如果您的主要目标是通过反复练习来掌握安装程序，请跳过这段“提前规划”的内容，直接阅读下一章。

我假设您希望在实际环境中运行 FreeBSD，进行实际工作。这种环境可能是您的笔记本电脑—虽然您可能会争辩说您的笔记本电脑不是生产系统，但我挑战您在没有备份的情况下清除所有数据，然后再告诉我它不是生产系统。如果您是在一个打算进行破坏性测试的系统上安装，并且您对其命运完全无所谓，我仍然建议您遵循最佳实践，以便养成良好的习惯。

请先考虑您需要的硬件或您已有的硬件。然后决定如何最佳使用这些硬件，应该使用哪种文件系统，以及如何安排磁盘。只有在此之后，您才应该继续下载和安装 FreeBSD。

不过，在您开始安装之前，让我们先了解一下在您整个 FreeBSD 使用过程中会遇到的一些概念：默认文件和通用配置语言（UCL）。

但是，首先，您必须了解 FreeBSD 的默认配置文件系统。

### 默认文件

FreeBSD 将配置文件分为默认文件和自定义文件。*默认文件*包含变量赋值，并不打算进行编辑；相反，它们设计为可以被同名的其他文件覆盖。

默认配置文件保存在名为 *default* 的目录中。例如，启动加载器的配置文件是 */boot/loader.conf*，默认配置文件是 */boot/defaults/loader.conf*。如果您想查看完整的加载器变量列表，请查看默认配置文件。

在升级过程中，安装程序会替换默认配置文件，但不会修改您的本地配置文件。这种分离方式确保了您的本地更改保持不变，同时允许将新值添加到系统中。FreeBSD 每次发布都会增加新功能，其开发者会尽力确保对这些文件的更改是向后兼容的。这意味着您不必逐个检查升级后的配置并手动合并更改；最多，您只需查看新的默认文件，以便发现新的配置机会和系统功能。

loader 配置文件是这些文件的一个很好的例子。*/boot/defaults/loader.conf* 文件包含多个条目，类似于这样：

```
verbose_loading="NO"            # Set to YES for verbose loader output
```

变量 `verbose_loading` 的默认值为 `NO`。要更改此设置，请不要编辑 */boot/defaults/loader.conf*，而是将该行添加到 */boot/loader.conf* 并在那里修改。你的 */boot/loader.conf* 条目会覆盖默认设置，并且你的本地配置只包含你的本地更改。系统管理员可以轻松查看做了哪些更改，以及该系统与原始配置有何不同。

我鼓励你将配置文件保存在版本控制系统中。如果你有像 Ansible 这样的全球配置管理系统，那就更好了。如果没有这样的系统，使用 svn(1) 或广受喜爱或讨厌的 git(1) 作为集中式存储库也可以。即使是像 rcs(1) 这样的本地版本控制系统，也能在某一天救你一命。

**不要复制默认配置！**

一个常见的错误是将默认配置复制到覆盖文件中，然后直接在那里进行修改。这样的复制会导致系统某些部分出现重大问题。你可能在一两个地方勉强能过得去，但最终它会给你带来麻烦。例如，将 */etc/defaults/rc.conf* 复制到 */etc/rc.conf* 会导致系统无法启动。你已经被警告过了。

默认配置机制在整个 FreeBSD 中都会出现，尤其是在核心系统配置中。

### 使用 UCL 配置

*通用配置语言*，或 *UCL*，是用于管理 Unix 风格配置文件的通用库。FreeBSD 使用 UCL 来处理核心功能，例如打包系统。

任何位于 UCL 中的文件可以采用几种格式之一，例如大多数 Unix 程序使用的传统变量 = 设置格式、YAML 或 JSON。如果你之前配置过任何 Unix 软件，UCL 不会是问题。

本书中将展示 UCL 风格配置的例子。此时你不需要了解 UCL 的详细信息，只需知道 UCL 是 FreeBSD 中的一种配置方式。

### FreeBSD 硬件

FreeBSD 支持大量硬件，包括为每种架构设计的不同架构和设备。该项目的目标之一是支持最广泛可用的硬件，硬件清单包含的设备远不止“个人电脑”。今天完全支持的*Tier 1*硬件包括 32 位和 64 位版本的英特尔风格处理器。

大多数现代硬件使用英特尔经典 32 位架构的 64 位扩展。这些扩展由 AMD 创建，因此该平台被称为*amd64*。过去十年内大多数硬件都采用了 amd64 标准。虽然 amd64 硬件可以启动 FreeBSD 的 32 位和 64 位版本，但 32 位版本包含了一些绕过措施来支持硬件特性和扩展的地址空间。在 64 位硬件上运行 64 位 FreeBSD。

传统的 32 位 IBM 兼容 PC 主导了计算领域数十年。FreeBSD 通过*i386*平台支持该硬件。^(1) 仅在纯 32 位硬件上使用 FreeBSD 的 i386 版本。FreeBSD 对一些其他硬件平台提供有限支持，称其为*Tier 2 架构*。其中一些架构逐渐变得越来越流行，例如 ARM。FreeBSD 支持 32 位和 64 位 ARM CPU，分别对应*arm*和*arm64*平台。对 64 位 ARM 硬件的支持正在迅速提升，预计 ARM64 很快会成为 Tier 1 平台。其他硬件平台正在逐渐退出，并且在被从源代码树中移除之前已经降级为 Tier 2 平台。此外，你还可以在 PowerPC（*ppc*）和 64 位 Sparc（*sparc64*）硬件上运行 FreeBSD，虽然这些硬件从未进入 Tier 1 平台。Tier 2 平台可以接受 FreeBSD 的前沿版本出现临时故障。Tier 2 平台可能会有，也可能没有可用的软件包。

你还会发现*Tier 3*平台，它们是高度实验性的。RISCV 硬件属于 Tier 3。

*Tier 4*包括几乎没有支持的平台。其中一些平台已经过时，正处于退出阶段。虽然代码仍然存在，并且理论上可以被复兴，但没有人愿意做这项工作。其他平台可能正在开发中，但还没有完全成熟。每个达到更高 Tier 的平台都会经过 Tier 4 这个阶段。

FreeBSD 支持为每种架构设计的许多网络卡、硬盘控制器和其他外设。由于许多架构使用相似的接口和硬件，因此这并不像你想象的那么具有挑战性：SATA 在任何地方都是 SATA，Intel 以太网卡也不会因为你把它插入 arm64 机器就变魔术一样。

虽然 FreeBSD 在古老的硬件上运行得很好，但该硬件必须处于可接受的状态。如果你的 Pentium IV 因为内存有问题而崩溃，安装 FreeBSD 也无法阻止崩溃。

FreeBSD 支持大多数 RAID 控制器，并包括管理大多数 RAID 控制器的软件。然而，我建议使用 UFS 文件系统的用户选择 FreeBSD 的 RAID 选项，而不是硬件 RAID 控制器。RAID 控制器是在存储冗余管理如此占用计算资源的时代诞生的，那时管理冗余几乎完全占用了主机的处理器。如今的计算硬件能够轻松管理 RAID。此外，RAID 控制器在硬盘上使用自定义格式。通常，只有相同型号的 RAID 控制器才能读取这些磁盘。RAID 控制器的意外故障可能会让你在可疑的网络拍卖中搜索旧控制器。而且，如果你觉得这些控制器新买时价格高，等到它们使用五年后再买，那时愿意买的人只有那些急需该型号的人！FreeBSD 提供几种不同的软件 RAID 选项，这些磁盘可以用任何类似硬件读取。

如果你使用的是 ZFS，关于 RAID 控制器的警告就变成了“直接不要用”。ZFS 期望能够直接访问磁盘。使用 RAID 控制器会禁用 ZFS 的自我修复和错误校正功能。如果你必须使用 RAID 控制器，请禁用 RAID 并让它作为存储控制器使用。虽然许多 RAID 卡声称可以作为 RAID 控制器使用，但大多数实际上只是提供一堆单盘 RAID 容器。在部署 ZFS 之前，确保你的 RAID 控制器可以切换到仅磁盘（JBOD）模式或主机总线适配器（HBA）模式。

本书使用 amd64 作为参考平台。所有内容应该也可以在 32 位 i386 主机上运行，但目前 amd64 是全球标准，因此我们将使用它。测试系统包括几台 iXsystems 存储服务器和各种虚拟机。^(2)

#### *专有硬件*

一些硬件厂商认为，保持其硬件接口的保密能够防止竞争对手复制他们的设计并打入他们的市场。然而，这种策略已经一再被证明是糟糕的，特别是在大量通用零件涌入市场后，这些保密的硬件厂商基本上被淹没了。不过，仍有一些厂商固守他们的保密策略。我们称这类设备为 *专有硬件*。

为一款硬件开发设备驱动程序而没有其接口规范是相当困难的。有些硬件在没有完整文档的情况下也能得到很好的支持，并且足够常见，以至于值得在缺少文档的情况下进行努力。

如果一个 FreeBSD 开发者拥有一款硬件、该硬件的文档并且对这款硬件感兴趣，他可能会为其实现支持。如果没有，那款硬件就无法在 FreeBSD 上工作。在大多数情况下，不受支持的专有硬件可以轻松地被更便宜、更开放的选项所替代。

一些厂商为其硬件提供封闭源的二进制驱动程序，以内核模块的形式提供（参见 第六章）。记住，虽然 FreeBSD 将内核称为模块化的，但这意味着你可以选择加载哪些部分，哪些部分不加载。一旦加载了内核模块，该模块便可以完全访问整个内核。视频驱动程序的内核模块完全有可能破坏你的文件系统。我强烈建议你尽可能避免使用二进制驱动程序，并避免使用需要此类驱动程序的硬件。

**我的硬件是否受支持？**

确定硬件是否受支持的最简单方法是启动 FreeBSD。如果你还没有物理访问该硬件，请查看 *[`www.FreeBSD.org/`](https://www.FreeBSD.org/)* 上你选择的版本的发行说明。

#### *硬件要求*

曾几何时，主机的最低硬件要求是一个大问题。FreeBSD 1.0 只支持非常特定的硬盘控制器和以太网适配器，并且需要几兆字节的内存。在那个时候，无法运行 FreeBSD 的硬件依然在广泛使用。

大多数硬件要求已经成为过去。任何生产过的 amd64 系统都能运行 FreeBSD。任何在本千年内制造的服务器级 i386 系统都能运行 FreeBSD。是的，一台配备 18GB SCSI-2 硬盘和 128MB 内存的 Pentium 提供的性能平平，但如果你想要更好的性能，尽量不要使用那样的硬件。

仅仅因为某个硬件应该能够工作，并不意味着它一定能工作。“便宜”并不等同于“廉价”。被支持的劣质硬件依然是劣质的。在购买硬件之前，最好先做些研究。

FreeBSD 可以在虚拟机管理程序（如 VMware、VirtualBox、Xen 和 KVM）上运行良好。合法的云服务提供商提供 FreeBSD 镜像和 ISO 文件。FreeBSD 也可以顺利运行在集成的 bhyve(8)虚拟机管理程序和 OpenBSD 的 vmm(8)上。你可以在 128MB RAM 和 1GB 磁盘的情况下进行基础安装，尽管为了更深入的实验，你可能需要更多的资源。

#### *BIOS 与 EFI*

上世纪 80 年代，IBM 发明了*基本输入输出系统（BIOS）*，用于处理低级硬件任务，比如寻找操作系统。然而，BIOS 有内建的限制，使其在现代硬件上表现不佳。现代的 BIOS 替代品是*可扩展固件接口（EFI）*，它比 BIOS 更灵活、更强大。FreeBSD 可以顺利从 EFI 启动，使用 EFI 还能让 FreeBSD 做一些有趣的事情，比如全盘加密。

如果你的硬件支持 EFI，就使用 EFI。只有在 FreeBSD 暴露出你硬件的 EFI 实现中的错误时，才回退到 BIOS 模式，在这种情况下我建议你提交一个 bug 报告（参见第二十四章）。需要注意的是，硬件设置工具可能会把 BIOS 模式称作“传统启动”或“古老垃圾”之类的名称。

### 磁盘和文件系统

安装系统时，最关键的部分可能就是如何分配磁盘空间以及使用哪个文件系统。FreeBSD 的基本安装大约需要半个 GB 的磁盘空间，但文件系统的选择在很大程度上决定了系统的行为。

#### *FreeBSD 文件系统*

FreeBSD 支持两种主要的文件系统，UFS 和 ZFS。你应该使用哪种呢？这完全取决于你打算如何使用你的系统。在启动安装媒体之前做出决定，你需要了解每种文件系统的基本知识。

FreeBSD 的 *Unix 文件系统（UFS）* 是直接继承自 4.4 BSD 随附的文件系统，已经持续开发了几十年。UFS 的其中一位原创作者至今仍活跃在 FreeBSD 社区，持续改进文件系统，并为新一代开发者提供支持和指导。UFS 作为原始的 FreeBSD 文件系统，已经将其影响扩展到操作系统的各个方面。许多其他 FreeBSD 文件系统通过为 UFS 创建的基础设施，连接到内核的虚拟内存系统。UFS 设计用于有效处理最常见的情况，同时可靠地支持不常见的配置。FreeBSD 配备了针对现代硬件广泛优化的 UFS，但如果你愿意，也可以选择优化一个分区，用于处理万亿个小文件或几个 1TB 的大文件。

*ZFS*（不是缩写）由 Solaris 于 2005 年推出，并在 2007 年集成到 FreeBSD 中。它的年轻似乎是一个劣势，但它结合了许多已经使用了很长时间的技术和概念。ZFS 计算每个数据块或元数据的校验和，并可以用它进行错误修正。存储是池化的，这意味着你可以在不重新创建文件系统的情况下，动态地向现有的 ZFS 文件系统添加更多磁盘。ZFS 有许多很酷的功能，比如高效的内建复制功能，以及能够实时创建和删除数据集（分区）。

虽然 ZFS 是在十多年前编写的，但它是为未来的硬件而设计的。所有这些酷功能都带来了性能成本，ZFS 可能会占用大量内存。虽然 32 位系统可以使用 ZFS，但不推荐这样做。我不建议在内存少于 4GB 的主机上运行 ZFS，并且拒绝在少于 2GB 内存的主机上运行它。UFS 更适合小型和嵌入式系统，而不是 ZFS。

ZFS 是虚拟化服务器的一个优秀存储系统，但对于使用磁盘映像的虚拟机来说，未必是最佳选择。许多虚拟机没有足够的内存来有效地运行 ZFS。此外，我也曾看到过多个基于 KVM 的虚拟化系统无法迁移基于 ZFS 的虚拟机。如果你打算在虚拟化客户端上使用 ZFS，务必确保你的虚拟化系统支持恢复和迁移 ZFS 磁盘映像，再安装一大堆主机。

有些人坚持认为 ZFS 需要 ECC RAM。ECC RAM 是非常好的，如果可以的话，你应该选择它。然而，没有 ECC 的 ZFS 并不比带 ECC 的 UFS *更差*。ECC 提供了一层完整性检查，类似于 ZFS。如果主机的非 ECC 内存被宇宙射线击中，ZFS 会将损坏的数据写入磁盘——就像你使用 UFS 一样。

最后，ZFS 假设你是在以 ZFS 的方式进行操作。ZFS 是一个结合了文件系统和卷管理的系统，它要求对原始磁盘的访问。切记，*绝不要*在 ZFS 中使用 RAID 控制器；使用 RAID 卷作为磁盘会干扰 ZFS 的自我修复功能。许多 RAID 控制器声称提供原始磁盘，但实际上它们提供的是单磁盘 RAID 容器。^(3)

UFS 也并不完美。断电或系统崩溃可能会损坏 UFS 文件系统。修复该文件系统需要时间和系统内存。大致来说，修复每一个 terabyte 的 UFS 文件系统需要 700MB 的内存。如果你在一个拥有 6GB 内存的系统上创建一个 7TB 的文件系统，FreeBSD 将无法自动修复它。

总结一下，在一台现代的 amd64 笔记本电脑或服务器上，我推荐使用 ZFS。测试 ZFS 是否能与您的虚拟化系统兼容。如果可以使用，请将 ZFS 用于具有 4GB 或更大内存的 64 位虚拟机。对于 i386 硬件或内存少于 4GB 的 64 位主机，使用 UFS。

如果你正在运行一个高负载、高流量的应用程序和数据库，在继续之前，建议在生产硬件上同时测试 UFS 和 ZFS，以查看哪种在你的应用程序中表现更好。可以尝试不同的磁盘配置、ZFS 池类型以及 GEOM RAID 方法。有些应用程序在 UFS 上运行得比在 ZFS 上更好。例如，Netflix 就是通过 FreeBSD 主机提供其所有内容，这些主机上拥有大量存储，格式化为 UFS。在安装大容量存储服务器之前，请查看第十二章以获取更多 ZFS 部署的相关考虑。

所有这些建议都服从一个铁律：选择最适合你环境的文件系统。

#### *文件系统加密*

磁盘加密已成为许多环境中的重要功能。一个丢失笔记本电脑的用户并不想丢失他的数据。某些组织要求对静态或非活动磁盘上的关键数据进行加密。你不能在已安装的系统上事后对磁盘进行加密。

FreeBSD 支持两种磁盘加密系统：*基于 GEOM 的磁盘加密（GBDE）* 和 *GELI*。gbde(8) 加密系统专为那些加密数据的存在可能威胁到用户生命的情况设计。它是为了保护一个被枪指着头的用户而设计的。幸运的是，这种使用场景比较少见；本书不涉及此内容。

geli(8) 加密系统则针对更常见的风险提供保护。如果你的笔记本电脑被盗，GELI 会防止小偷读取硬盘。^(4) 如果你将公司的财务记录存储在 GELI 加密的分区中，服务技术员在服务过程中是无法读取这些数据的。第二十三章将更详细地介绍 GELI。

许多组织要求包含财务数据或知识产权的磁盘在退役时必须无法读取。你可以将这样的磁盘送去粉碎，但在安装时对磁盘进行加密同样有效。当你销毁加密密钥时，磁盘将变得不可读取。

我建议要么加密整个系统，要么不加密任何部分。部分加密的磁盘会给技术高超的入侵者留下机会，破坏你的系统并绕过加密。

在继续之前，决定是否需要加密。

#### *磁盘分区方法*

磁盘*分区*让你可以将一个磁盘或磁盘阵列划分为多个逻辑单元。即使是普通消费者级别的操作系统（比如你在本地大型商店里看到的 Windows 笔记本）也通常会在硬盘上设置多个分区。*分区方案*是组织磁盘上分区的系统。

计算技术总是在不断变化中，现在我们正处在一个特别令人头疼的磁盘分区变革中。旧的、较小的硬件使用主引导记录（MBR）分区，且始终限制在 2TB 或更小的磁盘上。新的、更大的硬件则使用更灵活、通常更好的 GUID 分区表（GPT）方案。FreeBSD 使用 gpart(8) 管理这两种类型的分区。

在安装时应该使用哪个分区方案？在任何支持 GPT 的系统上都使用 GPT，不管磁盘的大小。只有在系统无法支持 GPT 的情况下，才使用 MBR。（你可以使用 gptboot(8) 和 gptzfsboot(8) 将 GPT 支持强加到仅支持 MBR 的磁盘上，但这应该留到第二次或第三次安装时使用。）

我遇到过不止一个支持 GPT 的系统，但它们有硬件限制，无法使用大于 2TB 的磁盘。虽然在这样的系统上使用 MBR 似乎很合理，但请记住，GPT 要灵活得多。即使你是一位拥有几十年 MBR 经验的系统管理员，也请学习并使用 GPT。

#### *使用 UFS 进行分区*

如果你决定为主机使用 UFS，你需要考虑文件系统分区。由于 FreeBSD 支持多种磁盘大小，安装程序不会尝试预测你希望如何分区系统。请在安装之前决定如何分区磁盘。

至少，要将操作系统与数据分开。如果此主机用于用户帐户，创建一个单独的 */home* 分区。如果你在运行数据库，创建一个数据库的分区。Web 服务器应该有一个用于 Web 数据的分区，可能还需要一个用于日志的分区。

作为一名老派的 Unix 用户，我通常会创建独立的 */usr*、*/usr/local*、*/var*、*/var/log* 和 */home* 分区，以及一个根分区（*/*）和一个交换空间分区，再加上一个用于服务器应用数据的独立分区。不过，我被告知我是个死板的人，认为对抗恶意进程和用户填满硬盘的担忧已经过时了。^5

现代 FreeBSD 的基础安装大约需要半个 GB 的空间。与当今的硬盘相比，这是微不足道的。在一块运行在真实硬件上的现代硬盘上，分配 20GB 给操作系统和相关程序应该是足够的。

然而，如果你在现代硬件上运行 FreeBSD，你可能更倾向于使用 ZFS 而不是 UFS。

#### *多个操作系统*

在石器时代（大约 2001 年），能够在单个 6GB 的硬盘上安装四个操作系统让我感到非常兴奋。这是唯一一种在桌面上运行多个操作系统而不需要更换硬盘的方法。

仍然可以进行多重引导安装，但虚拟化要好得多。你不必关闭主操作系统就能访问其他操作系统。bhyve(8) 虚拟机管理程序允许你在 FreeBSD 上运行其他操作系统，包括微软的 Windows。其他操作系统也有虚拟机管理程序，允许你在它们上面运行 FreeBSD。

#### *多个硬盘*

如果主机中有多个硬盘，你几乎肯定应该使用它们来创建某种存储冗余。如果你使用 ZFS，可以使用镜像或某种 RAID-Z（见 第十二章）。如果使用 UFS，FreeBSD 支持软件 RAID。不过，当你有一堆硬盘时，事情就变得有点复杂。

经验法则仍然是将操作系统与应用程序数据分开。如果你有 30 块硬盘，可以将其中两块镜像用于操作系统安装，其余硬盘用于存储数据。像所有经验法则一样，这个观点是有争议的。但没有哪个系统管理员会告诉你，这绝对是个糟糕的主意。

如果你有多个硬盘，考虑一下哪些数据通过哪个硬盘控制器传输。如果硬盘控制器故障，系统会发生什么？如果你的两个操作系统硬盘都连接在同一个控制器上，而该控制器出现故障，你的主机将会宕机。将每个硬盘连接到不同的控制器上可以提供冗余。理想情况下，应该将镜像操作系统硬盘连接到不同的硬盘控制器上。

此外，请记住，SATA 硬盘控制器会将其所有的数据传输量分配给连接到它们的所有硬盘。如果你有两个硬盘连接在一个 SATA 控制器上，每个硬盘的工作速度大约是单独连接在同一通道上时的一半。端口倍增器虽然增加了硬盘数量，但会大幅降低每个硬盘的性能。

#### *交换空间*

当 FreeBSD（以及其他任何现代操作系统）用尽所有物理 RAM 时，它可以将长时间闲置的内存信息转移到交换空间中。如今，即使是笔记本电脑也配备了 32GB 的 RAM，已经很难想象主机会出现内存不足的情况，但永远不要低估一个程序吞噬 RAM 的能力。虚拟系统可能会分配非常少的 RAM。

那么，你需要多少交换空间呢？这是一个系统管理员之间长期争论的问题。简短的答案是：“这取决于。”它取决于什么？*一切*。长期以来的经验法则认为，主机的交换空间应该是物理内存的两倍，但今天这不仅过时，而且是危险的。当一个进程开始灾难性地分配内存时——比如由于无限循环导致的 bug——一旦系统用尽虚拟内存，内核就会杀死该进程。一个拥有 32GB RAM 和 64GB 交换空间的系统，拥有 96GB 的虚拟内存。i386 平台将每个进程的内存使用限制为 512MB，这意味着内核会很快终止这种失控的进程。像 amd64 这样的 64 位系统拥有广阔的虚拟内存空间。一个在磁盘和内存之间不停交换几 GB 内存的系统将非常缓慢。现代主机应该只有足够的交换空间来完成其任务。

多个硬盘可以通过将交换空间分配到不同磁盘控制器的磁盘之间，提高交换空间的效率。不过，请记住，崩溃转储必须完全适配到单个交换分区。FreeBSD 会压缩崩溃转储，以便它们占用更少的空间，但即便如此，多个小交换分区也可能适得其反。如果你有大量硬盘，最好不要将应用程序磁盘用于交换空间；将交换空间限制在操作系统磁盘上。

现代系统上交换空间的主要用途是为内存转储提供一个存储位置，以防系统发生崩溃和 panic。FreeBSD 使用内核小型转储，因此它们只转储内核内存。小型转储比完全转储小得多：一个 8GB 内存的主机的平均小型转储大小大约为 250MB。每 10GB 内存配置 1GB 交换空间对于大多数情况应该足够了。

然而，如果你遇到了一个真正难以解决的问题，你可能需要将整个内存内容转储到交换空间中。如果我在设置一个重要的生产系统，我总是会创建一个比主机最大可能虚拟内存空间更大的未使用分区，并告诉主机将内核转储到该分区。如果我的笔记本电脑遇到类似问题，我只需插入一个闪存驱动器，并配置系统将转储到它上面。

### 获取 FreeBSD

现在你已经做出所有决定，你需要一个 FreeBSD 的副本。如果这是你第一次安装 FreeBSD，请访问 *[`www.FreeBSD.org/`](https://www.FreeBSD.org/)*，并查找页面顶部的“获取 FreeBSD”部分。在那里，你将看到支持的发布版本列表，其中通常包括两个推荐用于生产的版本。有时是一个，有时是三个，但通常是两个。

#### *FreeBSD 版本*

两个生产版本？这是什么疯狂的事情？

FreeBSD 开发在多个轨道上进行，正如我将在第十八章中讨论的那样。一些轨道并行存在，处于不同的支持状态。每个轨道都会接收 bug 修复和增量改进。较新的轨道会获得新特性。

当我写这篇文章时，FreeBSD.org 列出了两个生产版本，分别是 11.0 和 10.4。版本 11.0 是最新发布的版本，但它也是一个 .0 版本。它是这个分支的第一次发布，包含最新功能，但也最有可能包含未知的错误。版本 10.4 稍微旧一些，缺少 11.0 中的一些功能，但它是该分支的第四个版本。虽然不能保证没有错误，但很多人在生产环境中已经运行了几个月或几年，所有明显的问题都已修复。

每个 FreeBSD 版本最终都会达到*生命周期终止（EoL）*，并停止支持。安全团队会停止发布补丁，新的软件包也将不再提供。较旧的版本会先于较新的版本达到生命周期终止。如果你今天安装 FreeBSD 10.4，你将来需要升级到 11，但届时你将升级到的版本就不是 .0 版本了。

FreeBSD 平均同时发布两个生产版本。这不是一个不可违背的规则，而是观察到的现象。大约在 12.0 版本发布时，10.x 分支将达到生命周期终止（EoL）。

我个人会运行 FreeBSD .0 版本，但由于之前曾在其他操作系统上遭遇过问题，我对那些坚决拒绝 .0 版本的用户表示理解。如果你以前没有使用过 FreeBSD，我建议安装最新的生产版。它包含了最新的设备驱动程序和功能。

跟随下载链接，选择并下载你需要的版本。

#### *选择安装镜像*

你可以选择几种不同格式的 FreeBSD 安装介质。所有安装介质都有压缩版（使用 xz(1)）和未压缩版。如果你能够方便地解压 *.xz* 文件，建议下载压缩版本。这既节省了带宽，也减少了下载时间。任何现代操作系统都可以原生支持 *.xz* 文件，或者可以通过附加软件来处理此任务。

FreeBSD 提供两种类型的安装介质。第一种只包含足够启动 FreeBSD 安装程序并连接网络的内容。安装程序随后会从 FreeBSD 镜像站点下载操作系统文件。然而，如果你打算对同一版本的 FreeBSD 进行多次安装，那么下载包含操作系统文件的安装程序会更合适。

安装程序提供光盘格式（*.iso*）和闪存格式（*.img*）。选择适合你系统的格式。如果你是在安装虚拟机，ISO 格式可能是最简单的选择。

**FREEBSD 镜像**

旧文档常常强调选择一个好的镜像站点对安装的重要性。忽略这些内容。FreeBSD 软件分发站点 *ftp.freebsd.org/* 是一个全球性的镜像服务器集合。当您获取安装介质、软件包或任何其他 FreeBSD 材料时，系统会自动将您指向最近的镜像站点。如果您想使用特定的镜像站点而不是 GeoDNS 自动选择的站点，可以从 FreeBSD 手册的附录 A 中按名称选择（该内容在第一章中有讨论）。

每个安装镜像的文件名都以 *FreeBSD*、版本号和平台名称开始。如果您正在为 amd64 硬件下载 FreeBSD 12.0，安装镜像的文件名将以 *FreeBSD-12.0-RELEASE-amd64* 开头。紧接着，文件名会标明安装类型。

文件扩展名是一个帮助您轻松找到所需文件的工具：

+   以 *bootonly.iso* 结尾的文件是启动 FreeBSD 安装程序的 ISO 镜像。使用这些文件意味着通过网络下载 FreeBSD。

+   以 *disc1.iso* 结尾的文件是包含完整 FreeBSD 安装程序的 ISO 镜像。此镜像包含操作系统文件。

+   以 *mini-memstick.img* 结尾的文件是用于闪存驱动器的。它们启动 FreeBSD 安装程序，但通过网络下载操作系统文件。

+   以 *memstick.img* 结尾的文件是包含完整 FreeBSD 安装的闪存驱动器镜像。

FreeBSD 还提供更大的 DVD 镜像。这些镜像包含了整个 FreeBSD 系统和大量的软件包。它们适用于那些没有互联网连接的人。请记住，所有 FreeBSD 项目的带宽都是由社区捐赠的；除非您确实需要，否则请不要下载巨大的 DVD 镜像。

一旦您有了安装镜像，您需要将其放入实际的启动介质中。使用操作系统内置的工具将镜像刻录到物理磁盘上。虽然 Windows 现在包括 CD 刻录作为内置功能，但不支持闪存磁盘镜像。FreeBSD 项目推荐使用适用于 Windows 的 Image Writer (*[`sourceforge.net/projects/win32diskimager/`](https://sourceforge.net/projects/win32diskimager/)*)，这是一个非常不错的选择。打开程序，选择您的闪存驱动器和镜像文件，然后点击 **开始**。

### 网络安装

如果您的安装介质仅能启动安装程序，并且需要通过网络获取 FreeBSD 分发文件，则在安装程序运行时需要配置网络。如果您的网络使用 DHCP，安装程序应该会自动获取网络配置。如果不是，您的 FreeBSD 主机需要一个有效的网络配置。在启动安装程序之前，请收集以下信息：

+   有效的 IP 地址和子网掩码

+   您网络的默认网关

+   名称服务器的 IP 地址

如果您必须使用代理服务器才能访问互联网，您还需要其配置。

拥有这些信息后，您就可以开始安装 FreeBSD。
