## 第一章：**1 内存提取的基础**

在我们深入讨论从锁定的微控制器中提取固件的漏洞利用之前，让我们先回顾一下基本内容。我们将简要地浏览可能有效的许多方法，然后在后续章节中详细学习这些攻击。

首先，收集关于芯片、其调试机制和启动加载程序的所有可用文档非常重要。

对于公开文档的芯片，你需要获取数据手册、系列指南、一些参考设计和一个可用的交叉编译器。只有首先了解芯片在工厂中是如何被编程的，才能找到那些会将固件转储出来的 bug。

或许我应该稍微解释一下这些术语。数据手册是芯片的简短描述，通常不到一百页，介绍了你需要构建电路板的内容。系列指南有不同的名称：程序员指南、集成指南、用户指南，或者供应商那一周愿意使用的名称。它们通常描述一整个相关部件的系列，并且会指向更多的文档。参考设计包括原理图、源代码和 CAD 文件，芯片供应商鼓励工程师复制这些内容，以便将他们的芯片嵌入到成品中。

对于未公开文档或未标识的芯片，你只能利用你能获得的少量线索，比如相关芯片的设计或从开发者那里泄漏的文档。运气好的话，这些线索可能会引导你找到有用的内容。在逆向工程 Tytera MD380 的专有无线电芯片 HR C5000 时，曾通过 `DocIn.com` 找到了一份中文的机密开发者指南。^(1) 在逆向工程现代的 Tamiagotchi 玩具时，Natalie Silvanovich 浏览了成百上千张芯片焊接照片，识别出一个未标识的微控制器是 General Plus GPLB52X，然后找到了其数据手册。^(2) 虽然 Freestyle Libre 血糖监测仪中的 RF430TAL152 RFID 芯片没有公开文档，但公开文档中的 RF430FRL152 除了 ROM 内容等细节外几乎完全相同。^(3)

很容易直接跳到攻击芯片，而不先作为开发者使用芯片，但你会发现这本书几乎每个漏洞利用都从理解目标的细微差别开始。对于任何新的芯片，花时间绘制出其内存映射，使用调试器探索未锁定的芯片，并真正理解芯片是如何使用的。如果有可能，请不要跳过在目标上编译并运行 Hello World 这一步！

### **JTAG**

对于调试和故障分析，大多数芯片在硬件中实现了某种变种的 JTAG 协议。经典的变种使用四条信号线：TDI、TDO、TCK 和 TMS。第五条信号线 TRST 有时会包括在内，并且存在多种两线变种，以便更容易布线，例如 cJTAG、单线调试（SWD）和间谍双线（spy-bi-wire）。

这些线路各有其目的。TDI 和 TDO 是串行输入和输出信号，由 TCK 信号时钟控制。TMS 选择模式，让调试器将目标状态机在不同寄存器之间切换。所有这些细节都被调试器的硬件和软件抽象化，直到你需要编写自己的代码时，才需要深入了解这些内容。

如果你幸运的话，你有一颗解锁的芯片，只需连接一个 JTAG 适配器，并使用调试器将完整的闪存范围导出到磁盘。开发人员通常会为了故障分析的原因而将设备保持解锁状态，这样他们可以更容易地提高生产良率并保持装配线的正常运作。有些设备甚至不支持锁定，这些设备总是很容易读取！

如果你运气不佳，JTAG 端口将被完全或部分禁用，以防止读取，这通常是通过熔丝或非易失性内存标志来配置的。

完全 JTAG 锁定通常可以通过某种故障注入方式绕过，其中芯片的电气、光电或电磁要求被短暂违反，从而绕过保护机制。例如，许多 STM32 芯片的完全锁定可以通过重置后的电源电压波动降级为部分锁定。^(4) 许多 MSP430 芯片在遭遇闪光灯时会从完全锁定状态变为解锁状态。^(5)

部分 JTAG 锁定稍微复杂一点，主要是因为它们种类繁多。通常，部分锁定允许进行某种形式的调试，用于故障分析，同时对闪存施加限制。STM32F0 的部分保护在 JTAG 连接后会断开闪存与数据总线的连接，但它发生的时机稍微晚了一些，因此你可以通过反复重新连接来转储内存，从而提取出单个 32 位字。^(6) 同样，STM32F1 的部分保护可以通过意识到中断处理程序是通过指令总线获取的这一点来打破，因此通过使用向量表偏移寄存器（VTOR）重新定位表，就可以在单步调试时触发中断并观察寄存器，从而泄漏闪存中的字。^(7)

### **ROM 引导加载程序**

许多微控制器配备了掩膜 ROM。这些 ROM 的内容和格式差异巨大，但如果存在，通常至少包含一个引导加载程序，也可能包含一些便捷功能，就像旧款 IBM PC 的 BIOS 一样。这些 ROM 的位来自制造时的光刻掩膜，通常你可以拍摄它们的照片来查看并解码这些位。

就像我们试图从闪存中提取的应用程序代码一样，ROM 代码也可以被反编译和逆向工程。如果这段代码中存在可利用的漏洞，修复它可能是困难的或不可能的，导致整个芯片系列的固件被转储。

以 STM32F2 和 STM32F4 的 ROM 为例，包含了三个引导加载程序，使得芯片可以从 USB、串口和 CAN 总线启动。这三个引导加载程序包含了三种不同的 JTAG 锁定功能的重新实现，而且 USB 设备固件更新（DFU）引导加载程序中的软件漏洞允许从任意地址执行代码，从而能够提取所有受保护设备的固件。^(8)

在大批量生产的芯片中，你可能会发现定制的 ROM 镜像。这些镜像与消费型号的芯片不完全相同，但通常是从相同的代码中分叉出来的，这可以在成功提取固件之前提供一些线索。^(9) 因为 ROM 中的某些位在显微镜下是可见的，我们可以借助一定的耐心和软件工具，直接读取这些位。^(10)

### **闪存引导加载程序**

我们已经讨论过来自芯片制造商的 ROM 中的引导加载程序，但许多设备制造商会添加他们自己的引导加载程序，可能是从头编写，或者是从参考设计中分叉出来的。

以 Tytera MD380 为例，它是一款双向无线电，其固件被提取并修改，以为业余无线电社区添加新功能。它的 STM32F405 包括了上述提到的 ROM 引导加载程序，但还包含第二个闪存引导加载程序，具有 DFU 协议的自定义变种。这个闪存引导加载程序允许读取和写入无线电的 SPI 闪存芯片的明文数据，而内部闪存区域则只能进行写入，且仅限于加密固件更新。此引导加载程序中的未初始化指针允许提取前 48kB 的内存，其中包含引导加载程序。

通过修改这个引导加载程序使芯片保持解锁状态，可以通过 JTAG 随意提取明文固件！^(11)

无论你的目标是什么，方法是什么，最终的目标都是从受保护的芯片中提取代码。掌握了正确的技巧，并且深入理解保护机制的工作原理，几乎任何芯片都能被专注的逆向工程师攻破。
