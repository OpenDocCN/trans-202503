## 第二十八章：GHIDRA 对于 IDA 用户

![Image](img/com.jpg)

如果你是一个有经验的 IDA Pro 用户，想要尝试 Ghidra，无论是出于好奇心还是更永久的过渡，你可能已经熟悉本书中介绍的许多概念。本附录旨在将 IDA 的术语和用法映射到 Ghidra 中的类似功能，而不提供 Ghidra 功能的使用指导。对于本书中提到的任何 Ghidra 特性的具体使用，请参考相关章节，这些章节将详细讨论这些特性。

我们不会试图比较这两款工具的性能，也不会主张某一款工具优于另一款。你选择使用哪一款可能受价格或某一款工具提供的特定功能的影响，而另一款工具没有相同功能。接下来将从 IDA 用户的角度，带你快速浏览本书中的主题。

### 基础知识

在你开始这段旅程时，你可能会发现携带一本指南来帮助你学习一整套新的快捷键非常有用。*Ghidra 备忘单*（*[`ghidra-sre.org/CheatSheet.html`](https://ghidra-sre.org/CheatSheet.html)）是一本有用的三折页，列出了常见的用户操作及其相关的快捷键和/或工具按钮。不久后，我们将介绍如何重新映射快捷键，以防你怀念你信赖的 IDA 常用功能。

#### *数据库创建*

而 IDA 将一个二进制文件导入到一个数据库中，且天生是单用户的，Ghidra 则是面向项目的，可以在一个项目中包含多个文件，并支持多个用户协作反向工程，共同在同一个项目上工作。IDA 数据库的概念最接近 Ghidra 项目中的单个*程序*。Ghidra 的用户界面分为两个主要部分：*项目*和*CodeBrowser*。

你与 Ghidra 的首次互动是创建项目（共享或非共享），并通过项目窗口将“程序”（二进制文件）导入这些项目。当你使用 IDA 打开一个新二进制文件，并最终创建一个新数据库时，你和 IDA 将执行以下操作：

1.  (IDA) 查询所有可用的加载器，以了解哪些加载器识别新选择的文件。

1.  (IDA) 显示加载文件对话框，列出可接受的加载器、处理器模块和分析选项。

1.  (用户) 选择应当用于将文件内容加载到新数据库中的加载器模块，或接受 IDA 的默认选择。

1.  (用户) 选择应当在反汇编数据库内容时使用的处理器模块，或接受 IDA 的默认选择（该选择可能由加载器模块决定）。

1.  (用户) 选择在创建初始数据库时应使用的任何分析选项，或接受 IDA 的默认选择。你也可以选择在此时完全禁用分析。

1.  (用户) 点击**确定**确认你的选择。

1.  (IDA) 所选的加载器模块将使用来自原始文件的字节内容填充数据库。IDA 加载器通常不会将整个文件加载到数据库中，并且通常无法从新数据库中的内容重新创建原始文件。

1.  (IDA) 如果启用了分析，所选的处理器模块将用于将加载器识别的代码以及任何选定的分析器进行反汇编（IDA 将分析器称为 *内核选项*）。

1.  (IDA) 结果数据库将在 IDA 的用户界面中显示。

Ghidra 有类似的步骤；然而，该过程分为两个不同的阶段：导入和分析。Ghidra 的导入过程通常从项目窗口开始，包括以下步骤：

1.  (Ghidra) 查询所有可用的加载器，了解哪些加载器识别新选择的文件。

1.  (Ghidra) 显示导入对话框，呈现可接受的格式（大致是加载器）和语言（大致是处理器模块）列表。

1.  (User) 选择将文件导入当前项目的格式，或接受 Ghidra 的默认选择。

1.  (User) 选择用于反汇编程序内容的语言，或接受 Ghidra 的默认选择。

1.  (User) 通过点击 **确定** 来确认您的选择。

1.  (Ghidra) 与所选格式关联的加载器将来自原始文件的字节内容加载到当前项目中的新“程序”中。加载器创建程序段并处理二进制文件的符号、导入和导出表，但不会执行任何涉及反汇编的分析。Ghidra 加载器通常将整个文件加载到您的 Ghidra 项目中，尽管文件的某些部分可能不会在 CodeBrowser 中显示。

尽管此过程与 IDA 数据库创建类似，但缺少一些步骤。使用 Ghidra 时，分析发生在 CodeBrowser 中。一旦成功导入文件，双击项目视图中的该文件即可在 Ghidra 的 CodeBrowser 中打开该文件。首次打开程序时，Ghidra 执行以下步骤：

1.  (Ghidra) 打开 CodeBrowser 并显示导入过程的结果，询问您是否希望分析该文件。

1.  (User) 决定是否分析该文件。如果您选择不分析该文件，您将进入 CodeBrowser，可以浏览字节内容，但不会有反汇编。在这种情况下，您可以随时选择 **分析** ▸ **自动分析** 来分析该文件。无论哪种情况，当您决定分析文件时，Ghidra 会显示与当前文件格式和语言设置兼容的“分析器”列表。您可以选择要运行的分析器，然后在允许 Ghidra 执行初始分析之前修改分析器使用的任何选项。

1.  (Ghidra) 执行所有选定的分析器，并将用户带入 CodeBrowser，以便开始处理已完全分析的程序。

有关导入和分析阶段的更多信息，请参阅本书中的相关章节。IDA 没有类似于 Project view 的功能，也没有任何协作反向分析功能，除了共享的 Lumina 数据库之外。Project view 在第四章中介绍。共享项目和对协作反向工程的支持在第十一章中讨论。CodeBrowser 在第四章中介绍，更多深入内容从第五章开始，直到本书的其余部分。

CodeBrowser 是 Ghidra 的*工具*，是你分析程序的主要界面。因此，它是最类似于 IDA 用户界面的 Ghidra 组件，因此我们将花一些时间将 IDA 的用户界面元素与它们在 CodeBrowser 中的等效项进行比较。

#### *基础窗口和导航*

在默认配置中，CodeBrowser 是一个容器，包含多个显示程序功能信息的特殊窗口。关于 CodeBrowser 的详细讨论从第五章开始，并继续涵盖相关数据展示，直到第十章。

##### 列表视图

CodeBrowser 的核心是 Ghidra 列表窗口，它提供了类似于 IDA 文本模式的经典反汇编。要自定义列表的格式，浏览器字段格式化器允许你修改、重新排列和删除单个列表元素。与 IDA 一样，在列表窗口中的导航主要通过双击*标签*（IDA 名称）来实现，跳转到与标签关联的地址。右键点击时，上下文敏感菜单提供了与标签相关的常用操作，包括重命名和重新输入。

与 IDA 类似，列表中的每个函数都有一个头部注释，列出了函数的原型，提供了函数局部变量的摘要，并显示了指向该函数的交叉引用。Ghidra 相当于 IDA 的堆栈视图的功能只能通过右键点击函数头部并选择 函数 ▸ 编辑堆栈帧 来访问。

如果你喜欢 IDA 高亮显示你点击的字符串的所有出现位置（如寄存器名称或指令助记符），你可能会失望地发现这在 Ghidra 中不是默认行为。要启用此功能，请访问 编辑 ▸ 工具选项 ▸ 列表字段 ▸ 光标文本高亮，并将鼠标按钮从中键更改为左键。另一个你可能喜欢或讨厌的功能是标记寄存器变量引用，它会使 Ghidra 自动重命名用于存放函数传入参数的寄存器。要禁用此功能并让 Ghidra 使用寄存器名称指令操作数，请导航到 编辑 ▸ 工具选项 ▸ 列表字段 ▸ 操作数字段，并取消选中标记寄存器变量引用。

最后，如果你希望 Ghidra 在肌肉记忆让你使用最喜欢的 IDA 快捷键序列时能够“做正确的事”，你将需要花时间在 编辑 ▸ 工具选项 ▸ 键绑定 中重新分配默认的 Ghidra 快捷键，以匹配你在 IDA 中使用的快捷键序列。对于 IDA 用户来说，这是一个非常常见的任务，第三方键绑定文件已被发布，用于自动重新分配你最喜爱的快捷键序列。^(1)

##### 图形视图

Ghidra 的列表窗口是一个仅显示文本的视图。如果你更喜欢在 IDA 的图形视图中工作，你将需要在 Ghidra 中打开一个单独的函数图窗口。像 IDA 的图形视图一样，Ghidra 的函数图窗口每次只能显示一个函数，并且你可以像在列表窗口中一样操作函数图窗口中的项目。

默认情况下，Ghidra 的图形布局算法可能会将边缘路由到基本块节点后面，这可能会使追踪边缘变得更加困难。你可以通过访问 编辑 ▸ 工具选项 ▸ 函数图 ▸ 嵌套代码布局 并勾选 "绕过顶点路由边缘" 来禁用此行为。

##### 反编译器

Ghidra 为所有受支持的处理器提供反编译功能。默认情况下，反编译窗口会显示在列表窗口的右侧，并且每当你的光标位于列表视图中的某个函数时，它将显示反编译后的 C 源代码。如果你想在生成的 C 源代码中添加并查看行尾注释，你需要在 编辑 ▸ 工具选项 ▸ 反编译器 ▸ 显示 中勾选 "显示行尾注释"。在同一选项卡中，你还会找到 "禁用类型转换打印"，这可以通过显著减少结果代码的杂乱程度来提高可读性。

反编译器也倾向于对它生成的代码进行积极优化。如果你发现自己在阅读某个函数的反汇编版本时，感觉反编译版本中缺少了某些行为，反编译器可能已删除它认为是无用代码的部分。要在反编译器窗口中显示这些代码，请导航至 编辑 ▸ 工具选项 ▸ 反编译器 ▸ 分析，并取消选择 "消除死代码"。反编译器将在 第十九章 中进一步讨论。

##### 符号树

CodeBrowser 的符号树窗口提供了程序中所有符号的层次视图。符号树包含六个顶级文件夹，代表程序中可能存在的六种符号类。点击任何符号树文件夹中的名称将使列表窗口导航到相应的地址：

**导入** *导入* 文件夹适用于动态链接的二进制文件，并提供程序引用的外部函数和库的列表。这与 IDA 的导入标签最为相似。

**导出** *导出* 文件夹列出了程序中任何对外可见的符号。这些符号通常与 `nm` 工具输出的符号类似。

**函数** 该文件夹包含程序列表中每个函数的条目。

**标签** 该文件夹包含程序中任何附加的非本地标签的条目。

**类** 该文件夹包含 Ghidra 找到运行时类型识别（RTTI）的任何 C++ 类的名称。

**命名空间** 该文件夹包含 Ghidra 在程序分析过程中创建的每个命名空间的条目。有关 Ghidra 命名空间的更多信息，请参见 Ghidra 帮助。

##### 数据类型管理器

数据类型管理器维护着 Ghidra 关于数据结构和函数原型的所有知识。数据类型管理器中的每个文件夹大致相当于 IDA 类型库 (*.til*)。数据类型管理器承担了 IDA 的结构体、枚举、局部类型和类型库窗口的角色，详细内容请参见第八章。

### 脚本

Ghidra 是用 Java 实现的，其本地脚本语言是 Java。除了常规脚本外，Ghidra 的主要 Java 扩展包括分析器、插件和加载器。Ghidra 的分析器和插件共同承担了 IDA 插件的角色，而 Ghidra 的加载器则基本上与 IDA 的加载器承担相同的角色。Ghidra 支持处理器模块的概念；然而，Ghidra 的处理器是使用一种名为 SLEIGH 的规范语言定义的。

Ghidra 包含一个用于常规脚本任务的基础脚本编辑器，以及一个 Eclipse 插件，以方便创建更复杂的 Ghidra 脚本和扩展。通过 Jython 支持使用 Python。Ghidra API 实现为一个类层次结构，表示二进制文件的特性作为 Java 对象，并提供了方便的类以便轻松访问一些最常用的 API 类。Ghidra 脚本在第十四章和第十五章中进行了讨论，扩展内容则在第十五章、第十七章和第十八章中进行讨论。

### 摘要

Ghidra 的功能显然与 IDA 非常相似。在某些情况下，Ghidra 的显示方式与 IDA 相似，以至于唯一可能让你慢下来的是新的热键、工具按钮和菜单。在其他情况下，信息的呈现方式与 IDA 有所不同，你的学习曲线将更陡峭。无论如何，无论你是利用 Ghidra 的自定义功能使其像 IDA 一样工作，还是花时间学习一种新的工作方式，你可能会发现 Ghidra 能够满足你大部分的逆向工程需求，甚至在某些情况下打开了全新的工作方式。
