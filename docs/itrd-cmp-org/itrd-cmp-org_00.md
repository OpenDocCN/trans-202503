## 前言

![图片](img/pg23_Image_2.jpg)

本书从程序员的角度介绍了计算机硬件是如何工作的概念。硬件由一组*机器指令*控制。这些指令控制硬件的方式被称为*指令集架构（ISA）*。程序员的工作是设计这些指令的序列，使硬件执行操作来解决问题。

几乎所有计算机程序都是用高级语言编写的。部分语言是通用的，其他语言则针对特定应用。但它们的共同目的是为程序员提供一组编程结构，这些结构更适合用人类的方式来解决问题，而不是直接与 ISA 和硬件细节打交道。

### **本书适合谁阅读**

你是否曾想过，当你用高级语言编写程序时，“幕后”发生了什么？你知道计算机可以编程来做决策，但它们是如何做到的呢？你可能知道数据是以位存储的，但当存储一个十进制数字时，这意味着什么？我在本书中的目标是回答这些问题以及更多关于计算机如何工作的疑问。我们将同时探讨硬件组件和用于控制硬件的机器级指令。

我假设你知道如何用高级语言进行编程的基础知识，但你不需要是专家程序员。在讨论硬件组件后，我们将学习并编写大量的*汇编语言*程序，这是一种直接转化为机器指令的语言。

编写汇编语言是一个繁琐、容易出错、耗时的过程，因此应尽量避免。对于大多数树莓派上的编程项目，最佳语言是 Python，它随树莓派操作系统一起提供，并且在电子项目上有很好的支持。Python 非常适合让我们远离编写汇编语言的繁琐。然而，我们在这里的目标是研究编程概念，而不是创建应用程序，所以我们主要使用 C 作为高级语言。

### **关于本书**

我在编写本书时遵循的指南是：

+   如果学习建立在你已经知道的概念上，那么学习就会更容易。

+   现实世界中的硬件和软件为学习理论概念提供了一个更有趣的平台。

+   用于学习的工具应该是廉价且易于获得的。

#### ***本书中的编程***

本书基于 AArch64 架构，这是 ARM 架构的 64 位版本。它同时支持 64 位的 A64 和 32 位的 A32 指令集。

本书中的所有编程都使用在 64 位 Raspberry Pi OS 下运行的 GNU 编程环境完成。所有程序都在我的 Raspberry Pi 3 和 Raspberry Pi 5 上进行了测试。第二十章包括一节关于在 Raspberry Pi 5 上进行通用输入/输出（GPIO）引脚汇编语言编程的内容，这与早期的 Raspberry Pi 模型有显著不同。

由于 Python 能很好地将我们与计算机的指令集架构（ISA）隔离，我们使用 C 作为我们的高级语言，部分 C++ 内容出现在第十八章。GNU 编程工具使我们能够轻松地看到 C 和 C++ 如何使用 ISA。如果你不懂 C/C++，也不用担心；我们的 C/C++ 编程非常简单，我会在过程中向你解释所需的知识。

学习汇编语言时有一个重要问题：在应用程序中使用键盘和终端屏幕。通过键盘输入和屏幕输出的编程非常复杂，远超初学者的水平。GNU 编程环境包括 C 标准库。为了符合本书的“现实世界”标准，我们将使用该库中的函数，这些函数可以从汇编语言中轻松调用，用于在我们的应用程序中操作键盘和屏幕。

#### ***为什么要阅读本书？***

鉴于有许多优秀的高级语言可以让你编写程序，而无需关心机器指令如何控制硬件，你可能会想知道为什么要学习本书中的内容。所有高级语言最终都会被转换为控制硬件的机器指令。理解硬件的工作原理以及指令如何控制硬件，有助于你理解计算机的能力和局限性。我相信这种理解能够让你成为一个更好的程序员，即使你使用的是高级语言。

当然，学习汇编语言还有许多其他原因。如果你的兴趣在于*系统编程*——编写操作系统的部分功能、编写编译器，甚至设计另一种更高级的语言——这些工作通常需要在汇编语言层面上有所了解。如果你的主要兴趣在硬件方面，我认为理解程序如何使用硬件是很重要的。

在*嵌入式系统*编程中也有许多具有挑战性的机会，嵌入式系统是指计算机有专门任务的系统。这些系统是我们日常生活中的重要组成部分：比如手机、家电、汽车、暖通空调系统、医疗设备等。嵌入式系统是物联网（IoT）技术的核心组件。编程这些系统通常需要理解计算机如何在汇编语言层面与各种硬件设备交互。

最后，如果你已经了解其他处理器的汇编语言，本书将作为你阅读 ARM 手册的入门书。

#### ***章节组织***

本书大致分为三部分，分别侧重于数学与逻辑、硬件和软件。数学与逻辑部分旨在为您提供讨论概念所需的语言。硬件部分是对构建计算机所用组件的介绍。

前两部分提供了讨论软件如何控制硬件的背景。我们将查看 C 编程语言中的每个基本编程结构，书的最后部分会涉及一些 C++内容。然后，我们将研究编译器如何将 C/C++代码翻译为汇编语言。我还将向您展示程序员如何直接在汇编语言中编写相同的结构。

**第一章：设置舞台**   介绍计算机的三个基本子系统及其连接方式。本章还讨论了设置本书中使用的编程工具。

**第二章：数据存储格式**   展示了如何使用二进制和十六进制数字系统存储无符号整数，以及如何使用 ASCII 码存储字符。在本章中，我们将编写第一个 C 程序，并使用`gdb`调试器来探索这些概念。

**第三章：计算机算术**   介绍无符号和有符号整数的加法和减法，并解释使用固定数量的位表示整数的限制。

**第四章：布尔代数**   介绍了布尔代数运算符和函数，并讨论了使用代数工具和卡诺图进行函数最小化。

**第五章：逻辑门**   以电子学的介绍为开篇，随后讨论了逻辑门及其如何使用互补金属氧化物半导体（CMOS）晶体管构建。

**第六章：组合逻辑电路**   讨论了没有记忆功能的逻辑电路，包括加法器、解码器、多路复用器和可编程逻辑设备。

**第七章：时序逻辑电路**   讨论了保持记忆的时钟逻辑电路和非时钟逻辑电路，以及使用状态转换表和状态图进行电路设计。

**第八章：内存**   介绍了内存层次结构（云存储、大容量存储、主内存、缓存和 CPU 寄存器），并讨论了用于寄存器、SRAM 和 DRAM 的内存硬件设计。

**第九章：中央处理单元**   概述了 CPU 子系统。本章还解释了指令执行周期和主要的 A64 寄存器，并展示了如何在`gdb`调试器中查看寄存器内容。

**第十章：汇编语言编程**   介绍了最小的 C 函数，既有编译器生成的汇编语言，也有直接用汇编语言编写的版本。本章涵盖了汇编指令和第一个指令的使用。我举了一个例子，展示如何使用`gdb`的文本用户界面作为学习工具。

**第十一章：主函数内部**  描述了如何在寄存器中传递参数、位置无关代码以及如何使用调用栈传递返回地址和自动局部变量。

**第十二章：指令细节**  探讨了指令如何在位级别进行编码。本章还讨论了指令所需地址是如何计算的，以及汇编器和链接器程序的算法。

**第十三章：控制流结构**  介绍了如何在汇编语言中实现程序流控制，包括 `while`、`do-while`、`for`、`if-else` 和 `switch` 结构。

**第十四章：子函数内部**  描述了函数如何访问外部变量（全局变量、按值传递、按指针传递和按引用传递），并总结了栈帧的结构。

**第十五章：子函数的特殊用途**  展示了递归是如何工作的。本章讨论了如何使用汇编语言访问高层语言中无法直接访问的 CPU 硬件特性，通过单独的函数或内联汇编来实现。

**第十六章：位运算、乘法和除法指令**  描述了位掩码、位移操作以及乘法和除法指令。

**第十七章：数据结构**  解释了如何在汇编语言层面实现和访问数组和记录（`struct`）。

**第十八章：面向对象编程**  展示了如何在 C++ 中将 `struct` 用作对象。

**第十九章：分数数字**  描述了定点数和浮点数、IEEE 754 标准以及一些 A64 浮点指令。

**第二十章：输入/输出**  比较了 I/O 与内存和总线时序，描述了内存映射 I/O，并展示了如何在树莓派上编程 GPIO，既有 C 语言实现，也有汇编语言实现。本章还简要介绍了轮询 I/O 编程，并讨论了中断驱动和直接内存访问 I/O。

**第二十一章：异常与中断**  简要描述了 AArch64 如何处理异常和中断。本章包括了使用 `svc` 指令进行系统调用的示例，而不依赖 C 运行时环境。

### **本书的高效使用方法**

我已将本书的内容按照一种方式组织，你应该能够通过遵循几个简单的指南高效地学习这些材料。

许多章节的结尾都有“你的练习”环节，给你提供了练习与章节正文材料相关内容的机会。这些练习是为了帮助你练习，而不是测试。我已经在网上提供了大多数问题的答案和我的解法，网址是 *[`rgplantz.github.io`](https://rgplantz.github.io)*。如果你是使用这本书的讲师，抱歉，你得自己出题！许多练习都有相对明显的扩展，讲师可以用它们来创建课堂作业。

为了高效利用这些练习，我推荐一个迭代的过程：

1.  尝试自己解决问题。花点时间，但不要让自己卡住太久。

1.  如果答案没有立即浮现，查看我的解法。在某些情况下，我会在提供完整解法之前给出提示。

1.  返回到第一步，带着一些关于经验丰富的汇编语言程序员如何接近问题解决方案的知识。

我强烈建议你自己输入代码。这一动手操作将帮助你更快地掌握材料。如果没有其他好处，至少它迫使你阅读代码中的每一个字符。从我的在线解法中复制粘贴代码并没有什么好处；坦白说，本书中的所有程序在现实世界中并没有实际用途。代码是提供给你自己练习的，因此请以此心态来使用它。

这种动手实践的方法同样适用于前几章中的数学内容，其中包括在不同数字进制之间进行转换。任何一款好的计算器都能轻松完成这项任务，但实际的转换并不是重点。重点是学习数据值如何通过位模式表示，使用纸和笔进行计算将帮助你感受这些模式。

我们将在第一章开始，先概述计算机的主要子系统。接着，我将描述如何在我的两台树莓派（3 型和 5 型）上设置编程环境，以便创建和运行本书中的程序。
