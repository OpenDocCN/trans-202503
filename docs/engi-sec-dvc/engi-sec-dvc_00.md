## 前言

![Image](img/common.jpg)

互联网连接、数字商业模式、数据驱动服务、远程访问和数据分析——这些都为几乎每个行业带来了各种各样的需求和挑战。简单来说，大多数现代产品都需要某种类型的计算机集成在其中。更具体地说，它们通常需要一个*嵌入式系统*，这意味着一个包括处理单元、内存和输入/输出接口的电子系统，这些组件嵌入到更大的机械或电子系统中。

嵌入式系统的应用领域非常广泛。它们被用于工业自动化、交通运输和关键基础设施系统中的控制器、传感器和执行器中。路由器、交换机和基站等通信和网络硬件也以它们为基础。在消费市场中，典型的嵌入式系统产品包括智能洗衣机、智能取暖系统和游戏主机。即便是我们用来进行银行交易和门禁控制的塑料卡片，也可以视为一种嵌入式系统。

与个人电脑（PC）和服务器系统相比，这些设备往往面临一些限制，例如需要降低制造成本或运行在低到中等计算能力的硬件上，此外输入和输出能力也相对有限。嵌入式系统通常用于非常特定的领域，有时是关键领域，并且它们通常与用户交互较少，甚至没有交互。此外，这些设备由来自不同产品、制造商和行业的各种硬件、固件和操作系统构成。

除了这些限制之外，在方程中加入安全要求并不会让嵌入式系统工程师的工作变得更轻松。为这些设备开发安全措施、它们特定的应用环境以及受限的资源都使得架构师和开发人员面临挑战性任务。仿佛这些问题还不够，许多情况下，嵌入式系统还要面对物理攻击者，相比于远程访问云服务或网页服务等攻击模型，物理攻击是一种更强大的攻击模式。

### **嵌入式系统安全现状**

如果我们看看不同的应用领域和行业，嵌入式系统的安全措施现状差异巨大。例如，智能卡解决方案在 1990 年代就曾面临欺诈案件。如果人们能够绕过加密和混淆算法，他们就可以免费观看付费电视。此外，如果攻击者成功克隆了这些智能卡，他们可以以更低的价格出售，从而导致原始服务提供商的收入损失。由于商业模式面临压力，这些公司的安全意识相对较高，并且优先投资和开发智能卡安全措施。

嵌入式系统在娱乐领域的另一个应用也展现了类似的模式：游戏主机。主机制造商的自然兴趣是只能在他们的设备上播放原版游戏媒体。如果攻击者成功运行了克隆的光盘，商业模式将遭受损害。随着逆向工程社区对游戏主机的分析兴趣增加，这例如促成了安德鲁·黄（Andrew Huang）在 2003 年出版的著名书籍《Hacking the Xbox》（《破解 Xbox》），行业也开始加强安全机制。因此，游戏主机在嵌入式系统安全方面达到了一个稳固的状态，攻击者需要投入大量的资源、专业知识和复杂的工具，才能成功绕过保护措施。

然而，在嵌入式系统的其他应用领域，组件并没有如此成熟的安全特性。2016 年，随着*Mirai*恶意软件的发现，这一点变得非常明显。该恶意软件利用了数十万个物联网（IoT）设备，主要是 IP 摄像头和家庭路由器，将它们转变为僵尸网络，执行大规模的分布式拒绝服务（DDoS）攻击，针对网站进行攻击。此外，2020 年被称为*Ripple20*和*Amnesia:33*的漏洞集合，暴露了嵌入式系统中 TCP/IP 协议栈的各种弱点。据估计，超过 1500 万个设备受到了影响，涵盖从医疗到建筑自动化，再到工业控制系统（ICS）的各个领域。

奇怪的是，用于工业自动化和关键基础设施的设备，尽管其稳健性和可靠性至关重要，也存在着长期的安全待办事项清单。尽管 2010 年的*Stuxnet*事件报告曾为工业自动化制造商敲响警钟，但 10 多年后的今天，市场上仍然存在大量未得到充分保护的设备。2022 年，一组针对运营技术（OT）组件的漏洞被以*OT:ICEFALL*的名称发布。作者将这些安全工程上的失败归咎于*设计时不安全*，因为被分析的产品甚至没有基本的安全控制。

### **新兴需求、法律与标准**

听起来可能有些奇怪，但如果没有这些事件、漏洞和攻击，安全意识可能仅停留在边缘层面。然而，由于我们在过去 20 年里已经看到许多类似问题，同时在线连接性、数字服务和数据分析对公司变得越来越重要，网络安全“突然”成为了一项要求——例如，在采购过程中。

这并不意味着客户立刻展现出深刻且全面的安全知识，但他们越来越要求进行风险分析、采取保护措施，或满足产品制造商必须遵守的一系列（随机的）标准。从我在工业领域的经验来看，这有时会促使客户和制造商之间进行沟通，以在安全的实际需求和相关成本之间找到妥协，这对双方来说可能是一场合理且富有成效的讨论。

另一方面，政府越来越关注制定国家法律并签署国际协议，推动每个市场上销售的产品应当满足基本的安全要求。在欧洲，2019 年的《网络安全法案》（CSA）旨在为所有在欧盟销售的产品和服务建立安全认证框架，而 2024 年的《网络韧性法案》（CRA）则规范了具有数字元素的产品的网络安全要求。欧洲标准 ETSI EN 303 645 已定义了基准安全要求，特别是针对消费类物联网产品。在大西洋彼岸，拜登于 2021 年 5 月发布的第 14028 号行政命令采取了类似的政策，旨在提升物联网设备和软件解决方案的网络安全性。美国国家标准与技术研究院（NIST）已经提供了关于这些产品的网络安全标签的建议。

与此同时，多个行业的联盟正在尝试就各自领域的共同安全标准达成一致。一个显著的例子是国际电工委员会（IEC）标准 62443，专注于工业控制系统（ICS）安全和工业物联网（IIoT）。该标准结合了操作员、系统集成商和组件制造商的安全要求，提供了对工业系统统一且相互关联的安全视角。关于安全设备工程，IEC 62443 的第 4-1 部分和第 4-2 部分最为相关：第 4-1 部分涵盖了安全开发过程的实践，第 4-2 部分则涉及技术产品安全要求。

### **谁应该阅读本书？**

如果你是参与客户讨论的嵌入式系统架构师，如前所述，本书将为你提供必要的知识，帮助你与合作伙伴进行平等的辩论。

如果你是负责实施安全功能的嵌入式系统工程师或物联网开发人员，并且想了解这些功能背后的逻辑及典型障碍，本书将为你准备好迎接未来的挑战。

如果你参与产品需求工程过程，或者在日常工作中进行嵌入式系统测试，本书将帮助你理解某些安全功能的价值，以及为什么开发团队的同事可能不愿意实现这些功能。

如果你是学生，想知道为什么许多保护措施在 IoT 产品中不能理所当然地采取，本书将证实你有正确的心态，并让你明白嵌入式系统安全是一项重要但有时繁琐的任务。

如果几分钟前有人对你大喊，“我们需要立即实现这个该死的设备安全！现在！！！”，深呼吸，取消所有预约，认真阅读本书。之后，你就准备好进行一次友好、客观的“安全”讨论。

### **本书涵盖了哪些内容？**

本书的内容基于我在过去 15 年中在嵌入式系统安全领域的实践经验和研究洞察。

在**第一部分：基础知识**中，你将学习与提供安全开发生命周期相关的基础知识，以及如何使用加密技术。

**第一章：安全开发过程**    涵盖了在产品开发过程中遵循设计安全原则所需的基本要素。

**第二章：加密技术**    总结了与实际安全工程相关的加密技术要点。

**第二部分：设备安全构建模块** 详细介绍了嵌入式系统安全的基本物理和逻辑构建模块。

**第三章：随机数生成器**    深入探讨了随机性的神奇领域，强调其在安全中的重要性，并提供了生成和评估随机数据的实用建议。

**第四章：加密实现**    讨论了加密算法的实现选项及其对性能等属性的影响。

**第五章：机密数据存储与安全内存**    专注于以安全、机密的方式存储小型和大型数据。

**第六章：安全设备身份**    关注嵌入式系统的唯一身份的生成与管理。

**第七章：安全通信**    展示了用于通信渠道的先进保护措施，并回答了有关在嵌入式系统中实现这些措施的常见问题。

**第三部分：先进的设备安全概念**    专注于与安全 IoT 设备相关的全面保护概念。

**第八章：安全启动与系统完整性**    涵盖了嵌入式系统启动过程中，敏感操作阶段的安全考虑。

**第九章：安全固件更新**    描述了在考虑安全的情况下，提供产品软件更新的复杂性。

**第十章：强固的设备架构**    讨论了在受到攻击时如何继续运行关键进程的问题。

**第十一章：访问控制与管理** 考虑了设备上用户和进程的限制及其实际后果。

**第十二章：系统监控** 通过探索使你能够检测和分析嵌入式系统中的异常或攻击的措施，完成本书的内容。

阅读本书时，请记住，你的目标不仅是吸收尽可能多的技术知识，还要理解*何时*以及*为什么*设备安全措施是有意义的。

### **关于本书中的案例研究**

本书中的几个章节包含了实际的案例研究。它们的目的*不是*作为可以轻松复制粘贴到自己设备上的示例，甚至不能用于生产性开发。那需要更高层次的细节，超出了本书的范围，而且相关的安全见解会在实现问题的海洋中消失。

一些案例研究展示了理论与混乱的现实世界之间的差距。另一些则展示了不同实现选项的优缺点，还有一些案例研究提供了一个特定的应用背景，帮助你理解前面提到的思想和概念。

如前所述，嵌入式系统是一类多样的设备，它们的处理器、内存和接口也各不相同。为了提供一个合理的演示设备——既不高端，也不太小巧和受限——我选择了一个中等性能的硬件平台，它还包括可以在实际案例研究中分析的基于硬件的安全措施：来自意法半导体（STMicroelectronics，简称 ST）的 STM32MP157F-DK2 评估板。（顺便提一下，我与 ST 没有任何关联。）

当谈到中高性能嵌入式系统的操作系统时，Linux 是自然的选择。它广泛应用于汽车、洗碗机、可编程逻辑控制器（PLC）、电视、能源监控系统，也在本书中的案例研究中得到了使用。具体来说，我使用了 ST 的 OpenSTLinux 发行版，配备 Linux 5.15 内核。
