# 目录

1.  标题页

1.  版权

1.  献词

1.  关于作者和技术审阅员

1.  前言

1.  致谢

1.  简介

    1.  本书适合谁阅读？

    1.  本书内容

    1.  本书中使用的 PowerShell 约定

    1.  联系我们

1.  第一部分：Windows 操作系统概述

    1.  1\. 设置 PowerShell 测试环境

        1.  选择 PowerShell 版本

        1.  配置 PowerShell

        1.  PowerShell 语言概述

            1.  理解类型、变量和表达式

            1.  执行命令

            1.  发现命令和获取帮助

            1.  定义函数

            1.  显示和操作对象

            1.  过滤、排序和分组对象

            1.  导出数据

        1.  总结

    1.  第二部分：Windows 内核

        1.  Windows 内核执行程序

        1.  安全参考监视器

        1.  对象管理器

            1.  对象类型

            1.  对象管理器命名空间

            1.  系统调用

            1.  NTSTATUS 代码

            1.  对象句柄

            1.  查询和设置信息系统调用

        1.  输入/输出管理器

        1.  进程和线程管理器

        1.  内存管理器

            1.  NtVirtualMemory 命令

            1.  段对象

        1.  代码完整性

        1.  高级本地过程调用

        1.  配置管理器

        1.  实例

            1.  按名称查找打开的句柄

            1.  查找共享对象

            1.  修改映射段

            1.  查找可写和可执行内存

        1.  总结

    1.  3\. 用户模式应用程序

        1.  Win32 和用户模式 Windows API

            1.  加载新库

            1.  查看导入的 API

            1.  搜索 DLL

        1.  Win32 GUI

            1.  GUI 内核资源

            1.  窗口消息

            1.  控制台会话

        1.  比较 Win32 API 和系统调用

        1.  Win32 注册表路径

            1.  打开密钥

            1.  列出注册表的内容

        1.  DOS 设备路径

            1.  路径类型

            1.  最大路径长度

        1.  进程创建

            1.  命令行解析

            1.  Shell API

        1.  系统进程

            1.  会话管理器

            1.  Windows 登录进程

            1.  本地安全机构子系统

            1.  服务控制管理器

        1.  示例

            1.  查找导入特定 API 的可执行文件

            1.  查找隐藏的注册表键或值

        1.  总结

1.  第二部分：Windows 安全参考监视器

    1.  4. 安全访问令牌

        1.  主令牌

        1.  冒充令牌

            1.  安全质量服务

            1.  显式令牌冒充

        1.  在令牌类型之间转换

        1.  伪令牌句柄

        1.  令牌组

            1.  启用、默认启用与强制

            1.  登录 ID

            1.  所有者

            1.  仅用于拒绝

            1.  完整性与完整性启用

            1.  资源

            1.  设备组

        1.  特权

        1.  沙箱令牌

            1.  受限令牌

            1.  写限制令牌

            1.  应用容器与低盒子令牌

        1.  什么是管理员用户？

        1.  用户帐户控制

            1.  链接令牌与提升类型

            1.  UI 访问

            1.  虚拟化

        1.  安全属性

        1.  创建令牌

        1.  令牌分配

            1.  分配主令牌

            1.  分配冒充令牌

        1.  示例

            1.  查找 UI 访问进程

            1.  查找令牌句柄以进行冒充

            1.  移除管理员特权

        1.  总结

    1.  5\. 安全描述符

        1.  安全描述符的结构

        1.  SID 结构

        1.  绝对和相对安全描述符

        1.  访问控制列表头和条目

            1.  头部

            1.  ACE 列表

        1.  构建和操作安全描述符

            1.  创建新安全描述符

            1.  排序 ACE

            1.  格式化安全描述符

            1.  转换为和从相对安全描述符

        1.  安全描述符定义语言

        1.  工作示例

            1.  手动解析二进制 SID

            1.  枚举 SID

        1.  总结

    1.  6\. 读取和分配安全描述符

        1.  读取安全描述符

        1.  分配安全描述符

            1.  在资源创建过程中分配安全描述符

            1.  为现有资源分配安全描述符

        1.  Win32 安全 API

        1.  服务器安全描述符和复合 ACE

        1.  继承行为总结

        1.  工作示例

            1.  查找对象管理器资源所有者

            1.  更改资源所有权

        1.  总结

    1.  7\. 访问检查过程

        1.  运行访问检查

            1.  内核模式访问检查

            1.  用户模式访问检查

            1.  Get-NtGrantedAccess PowerShell 命令

        1.  PowerShell 中的访问检查过程

            1.  定义访问检查函数

            1.  执行强制访问检查

            1.  执行令牌访问检查

            1.  执行自主访问检查

        1.  沙箱

            1.  受限令牌

            1.  低框令牌

        1.  企业访问检查

            1.  对象类型访问检查

            1.  中央访问策略

        1.  工作示例

            1.  使用 Get-PSGrantedAccess 命令

            1.  计算资源的授权访问

        1.  总结

    1.  8. 其他访问检查用例

        1.  遍历检查

            1.  SeChangeNotifyPrivilege 权限

            1.  有限检查

        1.  处理重复访问检查

        1.  沙箱令牌检查

        1.  自动化访问检查

        1.  已完成的示例

            1.  简化对象的访问检查

            1.  查找可写的区段对象

        1.  总结

    1.  9. 安全审计

        1.  安全事件日志

            1.  配置系统审计策略

            1.  配置每用户审计策略

        1.  审计策略安全性

            1.  配置资源 SACL

            1.  配置全局 SACL

        1.  已完成的示例

            1.  验证审计访问安全性

            1.  查找带有审计 ACE 的资源

        1.  总结

1.  第三部分：本地安全机构与身份验证

    1.  10. Windows 身份验证

        1.  域身份验证

            1.  本地身份验证

            1.  企业网络域

            1.  域森林

        1.  本地域配置

            1.  用户数据库

            1.  LSA 策略数据库

        1.  远程 LSA 服务

            1.  SAM 远程服务

            1.  域策略远程服务

        1.  SAM 和 SECURITY 数据库

            1.  通过注册表访问 SAM 数据库

            1.  检查 SECURITY 数据库

        1.  已完成的示例

            1.  RID 循环

            1.  强制用户密码更改

            1.  提取所有本地用户哈希值

        1.  总结

    1.  11. Active Directory

        1.  Active Directory 简史

        1.  使用 PowerShell 探索 Active Directory 域

            1.  远程服务器管理工具

            1.  基本森林和域信息

            1.  用户

            1.  组

            1.  计算机

        1.  对象和区别名称

            1.  枚举目录对象

            1.  访问其他域中的对象

        1.  架构

            1.  检查架构

            1.  访问安全属性

        1.  安全描述符

            1.  查询目录对象的安全描述符

            1.  将安全描述符分配给新目录对象

            1.  将安全描述符分配给现有对象

            1.  检查安全描述符的继承安全性

        1.  访问检查

            1.  创建对象

            1.  删除对象

            1.  列出对象

            1.  读取和写入属性

            1.  检查多个属性

            1.  分析属性集

            1.  检查控制访问权限

            1.  分析验证写入的访问权限

            1.  访问 SELF SID

            1.  执行额外的安全检查

        1.  声明和中央访问策略

        1.  组策略

        1.  示例操作

            1.  构建授权上下文

            1.  收集对象信息

            1.  运行访问检查

        1.  总结

    1.  12\. 交互式认证

        1.  创建用户的桌面

        1.  LsaLogonUser API

            1.  本地认证

            1.  域认证

            1.  登录和控制台会话

            1.  令牌创建

        1.  使用 PowerShell 中的 LsaLogonUser API

        1.  使用令牌创建新进程

        1.  服务登录类型

        1.  示例操作

            1.  测试特权和登录帐户权限

            1.  在不同控制台会话中创建进程

            1.  认证虚拟帐户

        1.  总结

    1.  13\. 网络认证

        1.  NTLM 网络认证

            1.  使用 PowerShell 进行 NTLM 认证

            1.  密码衍生过程

            1.  透传认证

            1.  本地环回认证

            1.  替代客户端凭据

        1.  NTLM 中继攻击

            1.  攻击概述

            1.  活动服务器挑战

            1.  签名与封装

            1.  目标名称

            1.  通道绑定

        1.  示例

            1.  概述

            1.  代码模块

            1.  服务器实现

            1.  客户端实现

            1.  NTLM 认证测试

        1.  总结

    1.  14\. Kerberos

        1.  与 Kerberos 进行交互式认证

            1.  初始用户认证

            1.  网络服务认证

        1.  在 PowerShell 中执行 Kerberos 认证

        1.  解密 AP-REQ 消息

        1.  解密 AP-REP 消息

        1.  跨域认证

        1.  Kerberos 委托

            1.  不受限委托

            1.  受限委托

        1.  用户到用户的 Kerberos 认证

        1.  示例

            1.  查询 Kerberos 票证缓存

            1.  简单的 Kerberoasting

        1.  总结

    1.  15\. 协商认证与其他安全包

        1.  安全缓冲区

            1.  在认证上下文中使用缓冲区

            1.  使用缓冲区进行签名与封装

        1.  协商协议

        1.  不常见的安全包

            1.  安全通道

            1.  CredSSP

        1.  远程凭据保护与受限管理员模式

        1.  凭据管理器

        1.  附加请求属性标志

            1.  匿名会话

            1.  身份令牌

        1.  使用低盒令牌进行网络认证

            1.  使用企业认证能力进行认证

            1.  对已知 Web 代理进行认证

            1.  使用显式凭据进行认证

        1.  认证审计事件日志

        1.  示例

            1.  识别认证失败的原因

            1.  使用安全通道提取服务器的 TLS 证书

        1.  总结

        1.  最终思考

1.  A: 为测试建立 Windows 域网络

    1.  域网络

    1.  安装和配置 Windows Hyper-V

    1.  创建虚拟机

        1.  PRIMARYDC 服务器

        1.  GRAPHITE 工作站

        1.  SALESDC 服务器

1.  B: SDDL SID 别名映射

1.  索引

# 图表列表

1.  图 1-1: 使用 ShowWindow 参数显示 Get-Help 信息的对话框

1.  图 1-2: 以网格视图显示进程对象

1.  图 2-1: Windows 内核执行模块

1.  图 2-2: 安全参考监视器的组件

1.  图 2-3: NT 状态码结构

1.  图 2-4: 句柄表查找过程

1.  图 2-5: 访问掩码结构

1.  图 2-6: 区段编辑器 GUI

1.  图 3-1: Win32 API 模块

1.  图 3-2: Win32 GUI 模块

1.  图 3-3: regedit 工具的主视图

1.  图 4-1: Token 查看器列出所有可访问的进程及其令牌。

1.  图 4-2: 进程的 Token 对象详细视图

1.  图 4-3: 提升权限的 UAC 同意对话框

1.  图 4-4: SeIsTokenAssignableToProcess 主令牌分配标准

1.  图 4-5: SeTokenCanImpersonate 伪装令牌检查

1.  图 5-1: 内存中的 SID 结构

1.  图 5-2: 选择安全描述符格式

1.  图 5-3: 绝对安全描述符的结构

1.  图 5-4: 相对安全描述符的结构

1.  图 5-5: ACL 结构的顶层概览

1.  图 5-6: ACL 头部结构

1.  图 5-7: ACE 结构

1.  图 5-8: 显示安全描述符的 GUI

1.  图 5-9: 相对安全描述符十六进制输出中主要结构的概述

1.  图 6-1: 当父安全描述符和创建者安全描述符都设置时的自动继承行为

1.  图 7-1: 调用 NtCreateMutant 系统调用时线程的 PreviousMode 值

1.  图 7-2：在调用 ZwCreateMutant 后，线程的 PreviousMode 值被设置为 KernelMode

1.  图 7-3：访问检查过程

1.  图 7-4：Active Directory 样式的属性

1.  图 7-5：授予对属性集 1 访问权限后的对象类型树

1.  图 7-6：拒绝对属性 Z 的访问后的对象类型树

1.  图 7-7：文件服务器上的中央访问策略

1.  图 8-1：访问 OBJ 所需的遍历检查

1.  图 8-2：QRS 阻止的遍历检查

1.  图 9-1：显示高级审计策略的安全策略编辑器

1.  图 10-1：独立计算机上的本地域

1.  图 10-2：单一企业网络域

1.  图 10-3：域森林

1.  图 10-4：具有信任关系的多个林

1.  图 10-5：本地域配置数据库

1.  图 10-6：LSA 的远程服务和对象

1.  图 11-1：一个示例 Windows 林

1.  图 11-2：Active Directory 服务器结构

1.  图 11-3：组、用户和计算机类的模式层次结构

1.  图 11-4：用户对象及其 accountExpires 和 pwdLastSet 属性的对象类型树

1.  图 11-5：属性集对象类型树

1.  图 11-6：组策略配置

1.  图 12-1：交互式桌面创建概述

1.  图 12-2：使用 LsaLogonUser 的本地认证过程

1.  图 12-3：使用 LsaLogonUser 的域认证过程

1.  图 12-4：控制台和登录会话

1.  图 13-1：NTLM 认证协议概述

1.  图 13-2：NTLM 透传认证概述

1.  图 13-3：NTLM 中继攻击示例

1.  图 13-4：网络协议概述

1.  图 14-1：Kerberos 认证概述

1.  图 14-2：AS-REP 消息格式

1.  图 14-3：TGS-REQ 消息格式

1.  图 14-4：TGS-REP 消息格式

1.  图 14-5：Kerberos 认证到网络服务

1.  图 14-6：跨域 Kerberos 身份验证概述

1.  图 14-7：GRAPHITE 计算机账户的委派标签

1.  图 14-8：无约束委派过程

1.  图 14-9：受限 Kerberos-only 委派概述

1.  图 14-10：受限委派与身份验证协议过渡的概述

1.  图 14-11：使用 Kerberos 的用户对用户身份验证

1.  图 15-1：TLS 记录结构

1.  图 15-2：原始远程桌面实现

1.  图 15-3：使用网络级身份验证的远程桌面连接

1.  图 15-4：输入并保存您的凭证

1.  图 15-5：使用保存的凭证的连接对话框

1.  图 A-1：域网络配置

# 表格列表

1.  表 1-1：常见基本 PowerShell 类型及 .NET 类型和示例

1.  表 1-2：常见操作符

1.  表 1-3：字符串字符转义

1.  表 1-4：Where-Object 的常用操作符

1.  表 2-1：API 前缀与子系统映射

1.  表 2-2：知名对象目录及描述

1.  表 2-3：对象属性标志及描述

1.  表 2-4：NT 状态严重性代码

1.  表 2-5：常见状态设施值

1.  表 3-1：预定义注册表句柄及其本机等效项

1.  表 3-2：Win32 路径类型

1.  表 3-3：常用 Shell 动词

1.  表 4-1：固定登录会话的身份验证标识符和用户 SID

1.  表 4-2：SDK 和 PowerShell 格式中的组属性

1.  表 4-3：预定义的完整性级别值

1.  表 4-4：遗留功能 SID

1.  表 4-5：安全属性类型

1.  表 4-6：安全属性标志

1.  表 5-1：有效的控制标志

1.  表 5-2：知名授权机构

1.  表 5-3：支持的 ACE 类型、最小 ACL 修订和位置

1.  表 5-4：ACE 标志

1.  表 5-5：强制策略值

1.  表 5-6：知名 SID 及其别名

1.  表 5-7：映射到安全描述符控制标志的 ACL 标志字符串

1.  表 5-8：类型字符串到 ACE 类型的映射

1.  表 5-9：标志字符串到 ACE 标志的映射

1.  表 5-10：访问字符串到访问掩码的映射

1.  表 5-11：文件和注册表键类型的访问字符串

1.  表 5-12：Active Directory 中使用的著名 ObjectType GUID

1.  表 5-13：不同条件表达式类型的示例值

1.  表 5-14：条件表达式的单目运算符

1.  表 5-15：条件表达式的中缀运算符

1.  表 5-16：安全属性 SDDL 类型字符串

1.  表 5-17：强制标签访问字符串

1.  表 5-18：强制标签完整性级别 SID

1.  表 6-1：SecurityInformation 标志及其所需访问权限

1.  表 6-2：新突变对象的示例参数

1.  表 6-3：自动继承标志

1.  表 6-4：父 ACE 标志和继承 ACE 上设置的标志

1.  表 6-5：启用完整性级别自动继承标志的类型

1.  表 6-6：是否根据 InheritedObjectType 继承 ACE

1.  表 6-7：创建安全描述符时的 SecurityInformation 标志及其所需访问权限

1.  表 6-8：DACL 继承规则总结

1.  表 10-1：帐户登录权限

1.  表 12-1：常见的登录类型

1.  表 12-2：登录类型及其关联的允许和拒绝帐户权限

1.  表 12-3：域加入系统上的交互式令牌添加的组

1.  表 12-4：每种登录类型添加到令牌中的 SID

1.  表 12-5：映射到令牌类型的登录类型

1.  表 12-6：服务登录类型的用户名和 SID

1.  表 13-1：选择 NTLM 标志

1.  表 14-1：Windows 上的常见 Kerberos 加密类型

1.  表 14-2：断言身份的 SID

1.  表 A-1：虚拟机名称和 IP 地址

1.  表 A-2：根域的默认用户

1.  表 B-1：SDDL SID 别名到 SID 的支持映射

# 指南

1.  封面

1.  封面

1.  版权

1.  献词

1.  前言

1.  致谢

1.  简介

1.  第 I 部：Windows 操作系统概述

1.  1\. 设置 PowerShell 测试环境

1.  索引

1.  内容开始

# 打印版的分页符

1.  封面

1.  xi

1.  xii

1.  xiii

1.  xiv

1.  xv

1.  xvi

1.  xvii

1.  xviii

1.  iii

1.  iv

1.  v

1.  vii

1.  xix

1.  xx

1.  xxi

1.  xxii

1.  xxiii

1.  xxiv

1.  xxv

1.  xxvi

1.  xxvii

1.  xxviii

1.  1

1.  3

1.  4

1.  5

1.  6

1.  7

1.  8

1.  9

1.  10

1.  11

1.  12

1.  13

1.  14

1.  15

1.  16

1.  17

1.  18

1.  19

1.  20

1.  21

1.  23

1.  24

1.  25

1.  26

1.  27

1.  28

1.  29

1.  30

1.  31

1.  32

1.  33

1.  34

1.  35

1.  36

1.  37

1.  38

1.  39

1.  40

1.  41

1.  42

1.  43

1.  44

1.  45

1.  46

1.  47

1.  48

1.  49

1.  50

1.  51

1.  52

1.  53

1.  54

1.  55

1.  56

1.  57

1.  58

1.  59

1.  60

1.  61

1.  63

1.  64

1.  65

1.  66

1.  67

1.  68

1.  69

1.  70

1.  71

1.  72

1.  73

1.  74

1.  75

1.  76

1.  77

1.  78

1.  79

1.  80

1.  81

1.  82

1.  83

1.  84

1.  85

1.  86

1.  87

1.  88

1.  89

1.  90

1.  91

1.  92

1.  93

1.  94

1.  95

1.  96

1.  97

1.  99

1.  100

1.  101

1.  102

1.  103

1.  104

1.  105

1.  106

1.  107

1.  108

1.  109

1.  110

1.  111

1.  112

1.  113

1.  114

1.  115

1.  116

1.  117

1.  118

1.  119

1.  120

1.  121

1.  122

1.  123

1.  124

1.  125

1.  126

1.  127

1.  128

1.  129

1.  130

1.  131

1.  132

1.  133

1.  134

1.  135

1.  136

1.  137

1.  138

1.  139

1.  140

1.  141

1.  143

1.  144

1.  145

1.  146

1.  147

1.  148

1.  149

1.  150

1.  151

1.  152

1.  153

1.  154

1.  155

1.  156

1.  157

1.  158

1.  159

1.  160

1.  161

1.  162

1.  163

1.  164

1.  165

1.  166

1.  167

1.  168

1.  169

1.  170

1.  171

1.  172

1.  173

1.  174

1.  175

1.  176

1.  177

1.  178

1.  179

1.  180

1.  181

1.  182

1.  183

1.  184

1.  185

1.  186

1.  187

1.  188

1.  189

1.  190

1.  191

1.  192

1.  193

1.  194

1.  195

1.  196

1.  197

1.  198

1.  199

1.  200

1.  201

1.  202

1.  203

1.  204

1.  205

1.  206

1.  207

1.  208

1.  209

1.  210

1.  211

1.  212

1.  213

1.  214

1.  215

1.  216

1.  217

1.  218

1.  219

1.  220

1.  221

1.  222

1.  223

1.  224

1.  225

1.  226

1.  227

1.  228

1.  229

1.  230

1.  231

1.  232

1.  233

1.  234

1.  235

1.  236

1.  237

1.  238

1.  239

1.  240

1.  241

1.  242

1.  243

1.  244

1.  245

1.  246

1.  247

1.  248

1.  249

1.  250

1.  251

1.  252

1.  253

1.  254

1.  255

1.  256

1.  257

1.  258

1.  259

1.  260

1.  261

1.  262

1.  263

1.  265

1.  266

1.  267

1.  268

1.  269

1.  270

1.  271

1.  272

1.  273

1.  274

1.  275

1.  276

1.  277

1.  278

1.  279

1.  280

1.  281

1.  282

1.  283

1.  284

1.  285

1.  286

1.  287

1.  288

1.  289

1.  290

1.  291

1.  292

1.  293

1.  294

1.  295

1.  297

1.  299

1.  300

1.  301

1.  302

1.  303

1.  304

1.  305

1.  306

1.  307

1.  308

1.  309

1.  310

1.  311

1.  312

1.  313

1.  314

1.  315

1.  316

1.  317

1.  318

1.  319

1.  320

1.  321

1.  322

1.  323

1.  324

1.  325

1.  326

1.  327

1.  328

1.  329

1.  330

1.  331

1.  332

1.  333

1.  334

1.  335

1.  336

1.  337

1.  338

1.  339

1.  340

1.  341

1.  342

1.  343

1.  344

1.  345

1.  346

1.  347

1.  348

1.  349

1.  350

1.  351

1.  352

1.  353

1.  354

1.  355

1.  356

1.  357

1.  358

1.  359

1.  360

1.  361

1.  362

1.  363

1.  364

1.  365

1.  366

1.  367

1.  368

1.  369

1.  370

1.  371

1.  372

1.  373

1.  374

1.  375

1.  376

1.  377

1.  378

1.  379

1.  380

1.  381

1.  382

1.  383

1.  384

1.  385

1.  386

1.  387

1.  388

1.  389

1.  390

1.  391

1.  392

1.  393

1.  394

1.  395

1.  396

1.  397

1.  398

1.  399

1.  400

1.  401

1.  402

1.  403

1.  404

1.  405

1.  406

1.  407

1.  408

1.  409

1.  410

1.  411

1.  412

1.  413

1.  414

1.  415

1.  416

1.  417

1.  418

1.  419

1.  421

1.  422

1.  423

1.  424

1.  425

1.  426

1.  427

1.  428

1.  429

1.  430

1.  431

1.  432

1.  433

1.  434

1.  435

1.  436

1.  437

1.  438

1.  439

1.  440

1.  441

1.  442

1.  443

1.  444

1.  445

1.  446

1.  447

1.  448

1.  449

1.  450

1.  451

1.  452

1.  453

1.  454

1.  455

1.  457

1.  458

1.  459

1.  460

1.  461

1.  462

1.  463

1.  464

1.  465

1.  466

1.  467

1.  468

1.  469

1.  470

1.  471

1.  472

1.  473

1.  474

1.  475

1.  476

1.  477

1.  478

1.  479

1.  480

1.  481

1.  482

1.  483

1.  484

1.  485

1.  486

1.  487

1.  488

1.  489

1.  490

1.  491

1.  492

1.  493

1.  494

1.  495

1.  496

1.  497

1.  499

1.  500

1.  501

1.  502

1.  503

1.  504

1.  505

1.  506

1.  507

1.  508

1.  509

1.  510

1.  511

1.  512

1.  513

1.  514

1.  515

1.  516

1.  517

1.  518

1.  519

1.  520

1.  521

1.  522

1.  523

1.  524

1.  525

1.  526

1.  527

1.  528

1.  529

1.  530

1.  531

1.  532

1.  533

1.  535

1.  536

1.  537

1.  538

1.  539

1.  540

1.  541

1.  542

1.  543

1.  544

1.  545

1.  547

1.  548

1.  549

1.  551

1.  552

1.  553

1.  554

1.  555

1.  556

1.  557

1.  558

1.  559

1.  560

1.  561

1.  562

1.  563

1.  564

1.  565

1.  566

1.  567

1.  568

1.  569

1.  570

1.  571

1.  572
