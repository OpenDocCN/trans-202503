## **介绍**

有关 iOS 安全模型、越狱、在基础操作系统中寻找代码执行漏洞及其他安全相关特性的文献已经有很多。其他研究则侧重于从法医角度审视 iOS，包括如何从物理设备或备份中提取数据作为刑事调查的一部分。这些信息都很有用，但本书的目标是填补 iOS 文献中最大的空白：应用程序。

公众对编写 iOS 安全应用程序或对 iOS 应用程序进行安全评估的关注较少。因此，iOS 应用程序中的尴尬安全漏洞导致了敏感数据的暴露、身份验证机制的绕过以及用户隐私的滥用（无论是故意的还是偶然的）。人们正在使用 iOS 应用程序处理越来越重要的任务，并将大量敏感信息托付给它们，iOS 应用程序的安全性也需要随之成熟。

因此，我的目标是使本书尽可能接近于 iOS 应用程序安全开发的权威著作。iOS 的变化速度很快，但我尽力使内容尽可能准确，并提供工具帮助你检查和适应未来 API 的变化。

不同版本的 iOS 也有不同的漏洞。由于苹果已“停止支持”某些设备（例如 iPad 1），开发者可能仍希望其应用程序能够在这些设备上运行，因此本书涵盖了 iOS 5.*x*到 9.0（在撰写时的最新版本）中存在的漏洞，并在适用的情况下，讨论了每个版本特有的风险和缓解措施。

### **本书的读者**

首先，这是一本关于安全的书。如果你是一个开发者或安全专家，正在寻找一本关于 iOS 应用程序如何在保护用户方面失败的常见方式（以及你或客户修补这些漏洞的选项）的指南，那么你来对地方了。

如果你至少有一点 iOS 开发经验，或者对 iOS 应用程序如何在幕后运作有一些了解，那么你能从本书中获得最大的收益。但即便没有这些知识，只要你是一个经验丰富的程序员或渗透测试员，不怕根据需要深入研究苹果的文档，你也应该能够应付。我在第二章中提供了一个关于 Objective-C 及其最常用 API Cocoa Touch 的快速导览，如果你需要一些高层次的基础知识或对语言的回顾，可以从这里开始。

### **本书内容**

自 2008 年以来，我一直在进行各种 iOS 应用程序的安全评审和渗透测试，并积累了大量关于现实世界开发者在编写 iOS 应用程序时遇到的陷阱和错误的知识。本书将这些知识提炼出来，旨在同时吸引那些希望学习安全开发实践的 iOS 开发者和希望学习如何识别 iOS 安全问题的安全专家。

#### ***本书结构概述***

在 **第一部分：iOS 基础知识** 中，你将深入了解 iOS 的背景、其安全历史以及基本的应用程序结构。

• **第一章：iOS 安全模型** 简要介绍了 iOS 安全模型，让你了解该平台的基本安全保护措施，以及它们能提供什么和不能提供什么。

• **第二章：懒人版 Objective-C** 讲解了 Objective-C 与其他编程语言的不同之处，并简要介绍了其术语和设计模式。对于有经验的 Objective-C 程序员来说，这可能并不是什么新知识，但对初学者以及第一次接触 iOS 的人来说，这些内容应该会非常有价值。

• **第三章：iOS 应用结构** 概述了 iOS 应用的结构和打包方式，并探讨了可能泄露敏感信息的本地存储机制。

在 **第二部分：安全测试** 中，你将学习如何设置你的安全测试环境，无论是在开发还是渗透测试中使用。我还会分享一些设置 Xcode 项目的小技巧，帮助你充分利用可用的安全机制。

• **第四章：构建你的测试平台** 提供了开始使用工具和配置所需的所有信息，以帮助你审核和测试 iOS 应用程序。这包括关于使用模拟器、配置代理、绕过 TLS 验证以及分析应用行为的信息。

• **第五章：使用 lldb 和工具进行调试** 更深入地讲解了如何使用 lldb 和 Xcode 内建工具监控应用程序行为，并将其调整为符合你需求的方式。这将帮助你分析代码中的更复杂问题，同时为你提供一个测试工具，可以进行故障注入等操作。

• **第六章：黑盒测试** 深入探讨了你需要的工具和技术，以成功分析没有源代码的应用程序。这包括基本的逆向工程、二进制修改、程序复制以及使用 lldb 的远程实例在设备上进行调试。

在 **第三部分：Cocoa API 的安全问题** 中，你将了解 Cocoa Touch API 中常见的安全陷阱。

• **第七章：iOS 网络** 讨论了 iOS 中网络和传输层安全（TLS）的工作原理，包括认证、证书固定以及 TLS 连接处理中的常见错误。

• **第八章：进程间通信** 介绍了进程间通信机制，包括 URL 方案和较新的 Universal Links 机制。

• **第九章：面向 iOS 的 Web 应用** 介绍了 Web 应用如何与 iOS 原生应用集成，包括与 Web 视图的配合使用或利用 JavaScript/Cocoa 桥接，如 Cordova。

• **第十章：数据泄露** 讨论了敏感数据如何以各种方式不小心泄露到本地存储、其他应用程序或通过网络传播。

• **第十一章：C 语言遗留问题与负担** 概述了在 iOS 应用中仍然存在的 C 语言缺陷：栈和堆损坏、格式化字符串缺陷、使用已释放内存以及这些经典缺陷在 Objective-C 中的变体。

• **第十二章：注入攻击** 涵盖了诸如 SQL 注入、跨站脚本攻击、XML 注入和谓词注入等攻击方式，特别是它们在 iOS 应用中的表现。

最后，**第 IV 部分：保护数据安全** 涵盖了与隐私和加密相关的问题。

• **第十三章：加密与认证** 讨论了加密最佳实践，包括如何正确使用钥匙串、数据保护 API 和 CommonCrypto 框架提供的其他加密原语。

• **第十四章：移动隐私问题** 通过讨论用户隐私问题结束本书，包括收集超出需求的数据对应用程序创建者和用户的影响。

到本书结束时，你应该能够快速抓取一个应用程序，无论是否有源代码，并迅速找出安全漏洞。你还应该能够编写安全可靠的应用程序，在更广泛的世界中使用。

#### ***本书遵循的规范***

由于 Objective-C 是一种相当冗长的语言，拥有许多极长的类和方法名称，我在源代码列表中对行进行了换行，以最大程度地提高可读性。这可能并不代表你实际希望格式化代码的方式。在某些情况下，换行不可避免地让代码看起来不太美观——如果换行让代码看起来不清晰，可以尝试将其粘贴到 Xcode 中，让 Xcode 自动重新格式化。

正如我在第二章中详细说明的，我更倾向于使用传统的 Objective-C 中缀表示法，而不是点表示法。我还将大括号放在与方法声明同一行，原因类似：我年纪大了。

Objective-C 类和方法名称将以`等宽字体`显示。C 函数也将以`等宽字体`显示。为了简洁和清晰，路径 */Users/<your username>/Library/Developer/CoreSimulator/* 将被称作 *$SIMPATH*。

#### ***关于 Swift 的说明***

尽管相对较新的 Swift 语言引起了很多关注，但你会发现我在本书中没有涵盖它。背后有几个原因。

首先，我还没有实际遇到过用 Swift 编写的生产环境应用程序。Objective-C 仍然是 iOS 应用程序中最流行的语言，我们将在未来多年继续处理用它编写的代码。

其次，Swift 确实存在更少的问题。由于它不是基于 C 的，编写更安全的代码更容易，而且它不会引入新的安全漏洞（至少目前没有发现）。

第三，由于 Swift 使用与 Objective-C 相同的 API，您可能遇到的 Cocoa Touch API 中的安全陷阱，在这两种语言中基本上是相同的。本书中讲解的大部分内容都适用于 Objective-C 和 Swift。

此外，Swift 不使用中缀表示法和方括号，这让我既伤心又困惑。

### **移动安全承诺与威胁**

当我第一次开始接触移动应用程序时，我诚实地质疑是否需要一个独立的移动应用程序安全类别。在我看来，移动应用程序在漏洞方面和桌面应用程序是一样的：堆栈和堆溢出、格式字符串漏洞、使用后释放（use-after-free）和其他代码执行问题。尽管在 iOS 中这些问题依然可能发生，但移动设备的安全焦点已扩展到隐私、数据盗窃和恶意进程间通信等方面。

在阅读本书中我所涵盖的 iOS 安全细节时，请记住，用户希望应用程序避免做出某些会危及其安全的行为。即使一个应用程序避免了明显的风险行为，仍然有许多威胁需要考虑，在加强应用程序防御时要特别留意。这一部分讨论了应用程序对用户做出的安全承诺以及可能迫使应用程序违背这些承诺的攻击类型。

#### ***移动应用程序不应该能够做的事情***

从早期桌面操作系统的设计错误中汲取经验，主要的移动操作系统在设计时就考虑了应用程序隔离。这与桌面应用程序不同，后者用户运行的任何应用程序或多或少都可以访问该用户的所有数据，甚至控制整个机器。

由于在进程隔离和移动操作系统领域的改进，用户的期望也发生了变化。一般来说，移动应用程序（包括您的应用程序）不应该做几件关键的事情。

##### **导致其他应用程序出现不当行为**

应用程序不应能够崩溃或干扰其他应用程序。在过去的年代，不仅其他应用程序通常可以读取、修改或销毁数据，它们还可以通过这些数据使整个操作系统崩溃。随着时间的推移，桌面进程隔离有所改进，但主要目标是增加系统稳定性，而不是解决安全或隐私问题。

移动操作系统在此基础上有所改进，但在满足用户互操作性需求的同时，完全的进程隔离仍然不可能。应用程序之间的边界总是会有些许漏洞。开发者需要确保他们的应用程序不会出现不当行为，并采取一切谨慎措施来保护数据，防止恶意应用程序的干扰。

##### **拒绝为用户提供服务**

鉴于 iOS 历史上主要用于手机，因此确保应用程序不能做出阻止用户进行紧急呼叫的行为至关重要。在许多地方，这是法律要求，也是防止攻击者（以及用户）篡改底层操作系统的原因。

##### **窃取用户数据**

应用程序不应能够读取其他应用程序或基础操作系统的数据并将其传递给第三方。它也不应在未经用户允许的情况下访问敏感的用户数据。操作系统应防止应用程序直接读取其他应用程序的数据存储，但要防止通过其他渠道窃取数据，开发人员需要注意应用程序通过哪些进程间通信（IPC）机制发送或接收数据。

##### **让用户不期望的费用**

应用程序不应在未经用户批准的情况下产生费用。在野外发现的许多移动恶意软件利用发送短信的功能，将用户订阅到第三方服务，从而将费用通过用户的手机运营商转嫁给用户。应用内购买应清晰告知用户，并要求明确批准。

#### ***本书中的移动安全威胁分类***

为了帮助理解移动设备的安全威胁及其防范措施，记住一些攻击类型也是非常有用的。这有助于我们现实地分析威胁，并帮助分析各种攻击及其防御的真正影响。

##### **取证攻击**

取证攻击者通常会获取一个设备或其备份，意图提取其中的机密数据。大多数情况下，这涉及到对设备上物理存储的检查。由于手机或平板电脑的盗窃相对容易，且比偷窃其他计算设备更常见，因此更多的关注集中在取证领域。

取证攻击可以由机会主义攻击者或有技能的攻击者对特定个人发起。对于机会主义攻击者，提取信息可能像偷走一部没有 PIN 码保护的手机那样简单；这使得他们可以窃取图片、笔记和手机上正常可以访问的其他数据。它也可能帮助攻击者突破使用手机令牌或短信配合两步验证的服务。

一名技术娴熟的取证攻击者可能是一个不法员工、公司、政府机构、执法人员，或者是一个动机强烈的敲诈者。这类攻击者掌握了执行临时越狱、破解简单密码、并检查设备文件系统中数据的技巧，包括系统级别和应用级别的数据。这能让攻击者不仅获取通过用户界面呈现的数据，还能获取底层缓存信息，其中可能包括截图、按键记录、网页请求中缓存的敏感信息等。

我将在第十章中介绍很多对取证攻击者有用的数据，并在第十三章中讨论一些进一步的防护措施。

##### **代码执行攻击**

远程代码执行攻击涉及通过在设备上执行代码来妥协设备或其数据，而无需物理接触设备。这可以通过多种渠道发生：网络、二维码或 NFC、解析恶意构造的文件，甚至是敌对硬件外设。需要注意的是，在设备上获得代码执行权限后，许多用于暴露用户秘密的取证攻击就变得可能。我将在第十一章中讨论几种常见的低级编程缺陷导致的代码执行攻击子类型。

##### **基于 Web 的攻击**

基于 Web 的远程代码执行攻击主要使用恶意构造的 HTML 和 JavaScript 来误导用户或窃取数据。远程攻击者要么操作一个恶意网站，要么接管一个合法网站，或者简单地向公共论坛发布恶意构造的内容。

这些攻击可以用来窃取本地数据存储中的数据，例如 HTML5 数据库存储或 localStorage，修改或窃取存储在 SQLite 数据库中的数据，读取会话 cookie，或植入伪造的登录表单以窃取用户凭证。我将在第九章和第十二章中讨论更多关于 Web 应用相关的问题。

##### **基于网络的攻击**

基于网络的代码执行攻击试图通过在网络上注入某种类型的可执行代码来控制应用程序或整个系统。这可以是修改进入设备的网络流量，或通过代码执行漏洞利用系统服务或内核。如果漏洞攻击的是具有较高权限的进程，攻击者不仅可以访问特定应用的数据，还可以访问设备存储中的所有数据。攻击者还可以监控设备活动并植入后门以便后续访问。我将在第七章中专门讨论与网络相关的 API。

##### **依赖物理接近的攻击**

物理代码执行攻击通常是利用 NFC 或 USB 接口等通信方式对设备进行攻击的漏洞。这些类型的攻击曾用于越狱，但也可以通过短暂的物理交互来妥协设备。这些攻击中的许多是针对操作系统本身的，但我将在第十四章中讨论一些与物理接近相关的问题。

### **iOS 安全测试员的注意事项**

我坚信，渗透测试应该尽可能在源代码的帮助下进行。尽管这并不代表大多数外部攻击者的立场，但它能最大限度地提高在有限时间内发现重要漏洞的能力。现实中的攻击者有足够的时间来分析你的应用程序，且 Objective-C 非常适合逆向工程。只要有时间，他们能弄清楚如何做。然而，大多数渗透测试受到时间和资金的限制，因此通常不应以模拟真实攻击者为目标。

本书涵盖了白盒（即源代码辅助）和黑盒方法，但重点将放在源代码辅助渗透测试上，因为这种方法能更快地发现更多的漏洞，并帮助学习标准的 Cocoa 库。我在本书中描述的许多技术都适用于这两种方法。

话虽如此，iOS 开发人员来自不同的学科，每个人的技能背景都会影响到应用程序中那些未被注意到的安全问题。无论你是在测试别人的应用程序，还是试图在自己的应用程序中发现漏洞，在测试过程中都要考虑不同的开发背景。

一些 iOS 开发人员来自 C 或 C++背景，既然我们都倾向于使用自己熟悉的东西，你会发现他们的代码库通常使用 C/C++ API，而非 Cocoa 等价的 API。如果你知道被测试的应用程序是由前 C/C++程序员创建的，你可能会发现第十一章是一本有用的参考书，因为它讨论了在纯 C/C++代码中常见的问题。

对于一些新程序员来说，Objective-C 实际上是他们的第一门编程语言。他们通常没有学过那么多原生 C API，因此理想情况下，你会发现这类问题较少。此外，还有一些经验丰富的 NeXTStep 程序员，他们已经转到 OS X 或 iOS 开发，拥有一套关于 NeXTStep/Cocoa API 的智慧库，但在移动开发方面经验较少。如果你或你的客户是这种情况，你会发现第三部分的章节最有帮助。

具有 Java 背景的程序员可能会试图将 Java 设计模式强行应用到一个应用程序中，不断地抽象功能。另一方面，被征召来编写移动应用程序的 Web 开发者，可能会试图将尽可能多的代码包装到一个 Web 应用程序中，编写依赖 WebKit 查看应用内容的最小应用程序。你可以查看第九章，其中讲解了一些与 WebKit 相关的陷阱。

拥有我提到的最后几种技能的开发人员不太可能使用低级 API，而这有助于防止经典的 C 语言缺陷。然而，他们在使用这些低级 API 时往往不容易发现错误，因此，如果他们使用了这些 API，你需要特别留意。

当然，这些背景没有哪个一定比其他背景更适合安全开发——高层次和低层次的 API 都可能被滥用。但当你了解现有技能如何影响 iOS 应用的编写时，你就更接近发现并解决安全问题的第一步。

我的背景是渗透测试员，我觉得这和做艺术评论家很相似：我*能*写代码，但大部分时间都在查看别人写的代码，并告诉他们哪里有问题。就像在艺术界一样，大部分代码其实都挺糟糕的。然而，与艺术界不同的是，代码问题通常可以通过修补程序解决。我的希望是，在读完本书后，你能识别出糟糕的 iOS 代码，并知道如何开始修补漏洞。
