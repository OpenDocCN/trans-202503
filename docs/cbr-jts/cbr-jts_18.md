# 第十八章：隐秘通信

当忍者进入敌人城堡后，若需要与将军沟通，忍者必须让他的盟友知道他的位置。安排好时间和地点来完成这一点是至关重要的。

> 为了夜袭成功，先派忍者前往敌方位置进行侦察，了解敌情，才能下达指令。
> 
> —百首义盛 #12

由于忍者首先是间谍专家，他们必须安全地传递包含侦察报告、攻击计划和其他关键信息的秘密消息，以帮助他们的领主和盟友做出明智的战术和战略决策。同样，领主、将军和其他忍者也需要秘密地告知潜入的忍者何时放火或执行其他战术。这些消息必须让接收的忍者易于解码，但对其他人来说却无法辨认。

*万善集海*、*忍秘传*和*军法事要集*卷轴都描述了忍者用来与其他忍者、友军或雇主在潜入敌方领土后进行沟通的秘密方法。有些方法极其简单。*万善集海*描述了将消息隐藏在鱼肚子里，甚至藏在人体内（请发挥你的想象力），这些“携带者”可以轻松穿越边境而不引起怀疑。常见的选择有僧侣和乞丐。同一卷轴中讨论的伪装技巧包括将信息切割成几块，并通过不同的信使发送每一块，接收者将其重新拼接，以及用橘子汁、铁锈水、清酒或蓖麻油制作的墨水，这些墨水在纸上干后不可见，但通过火焰可以显现。忍者甚至开发了*忍者五十音*——一种非忍者无法破译的自定义字母表，并通过碎片化的词语或字符创造出只有目标接收者才能理解的上下文模糊性。^(1)

一种流行的——且直接的方法——是发送秘密信息的*耶布米*，其方式是看似正常的箭矢，其实箭杆上卷有一卷秘密卷轴，并且箭羽上有标记，以识别接收者。考虑到封建日本的物流现实，忍者不能总是确保能够在预定的时间和地点射出*耶布米*箭，因此他们发明了一种箭矢“握手”信号，对外人来说，这可能看起来像是一次小规模冲突。如果一方看到特定数量的箭矢迅速射向同一位置，他们则回射一定数量的箭矢，目标是落在射手的前方。这个信号和反信号建立了友好联系。忍者随后可以射出*耶布米*箭，箭矢会被捡起并送达预定目标。^(2) 这种通讯方法变得如此普遍，以至于《军法事要书》警告敌人可能通过箭矢发送欺骗性信件；因此，接收者应使用本书前面描述的语言技巧仔细检查*yabumi*消息。^(3)

对于长距离信号传递或当发送卷轴不可行时，忍者设计了旗帜、火焰、烟雾和灯光信号（*hikyakubi*）。当这些方法都不可行时，他们使用了秘密的鼓声、锣声和海螺声。一声响亮、独特的信号装置爆炸声告诉忍者准备接收秘密通讯。这种信号模式在渗透前的 1 到 6 天内达成一致，以避免混淆。在初始的*hikyakubi*信号之后，消息通过鼓、锣或海螺信号传递。^(4)

在本章中，我们将探讨忍者的隐秘通讯方法如何与现代恶意软件的指挥与控制通讯非常相似。我们将讨论为何指挥与控制通讯是必需的，以及它们在威胁活动中的作用。我们将简要讨论现代对手用于隐秘进行这种通讯的各种技术。我们还将探索针对这种技术的各种防御措施以及使用它的挑战。最后，我们将列出一大批安全最佳实践，用以防范指挥与控制通讯。忍者卷轴未提供如何阻止隐秘通讯的指导，这表明可能没有有效的解决方案。

## 指挥与控制通讯

恶意软件通常无法完全独立和自主。如果能做到这一点，恶意软件将异常庞大、复杂、可疑，并且容易被防御者发现。实际上，大多数恶意软件在威胁活动期间需要来自其控制者的战术指导，因此，威胁行为者使用一种称为*命令与控制*（缩写为 C2、CnC 或 C&C）的方法与恶意软件、后门、植入物和受控系统进行通信。操作员通过 C2 通信向受损系统发送命令，促使其执行诸如下载数据、更新配置甚至自我删除等操作。C2 植入物还可以通过发送统计数据或有价值的文件、请求新命令，或者回报系统在线的状态以及位置和当前状态来发起通信。网络威胁行为者通常在渗透前一至六周建立 C2 基础设施，例如域名、IP 和网站。

C2 功能广为人知，许多防火墙、IDS/IPS 和其他安全设备与控制措施能够阻止对手直接与目标系统通信或相反。为了绕过这些控制，威胁行为者不断开发更先进的 C2 技术、战术和程序（TTPs）。例如，C2 数据可以嵌入到 ping 负载中，或者隐藏在托管在公共网站上的图片中的命令里。对手曾经在 Twitter 动态和受信网站的评论中使用 C2。他们还通过 C2 在受损系统上建立代理和电子邮件中继；然后，他们通过已知的协议和安全网站进行通信，这些网站未被安全控制和设备阻止。插入受损系统的手机可能会感染恶意软件，该恶意软件在 USB 连接时通过手机塔“呼叫”C2，从而绕过防火墙和其他网络防御，并在手机充电时促进感染主机与 C2 之间的通信。一些 C2 通信方法使用闪烁的 LED 灯（像信号火炬）、变化的 CPU 温度（像烟雾信号）、硬盘或 PC 扬声器的声音（像信号鼓）以及利用电磁波谱来绕过空气隔离与附近机器进行通信。

威胁行为者通过混淆、加密和其他保密技术对 C2 通信进行层叠，以便在不透露命令证据的情况下与受损系统保持联系。对手可能通过以下方式避免被检测：

+   限制每天传输的数据量，使得每日传输量看起来不异常（例如，每天最多 100MB，以掩盖在两周内下载 1.5TB）

+   仅在活跃用户时间发送或接收信标，以便与合法用户流量混合（例如，不在周日或假日的清晨频繁发送信标）

+   定期切换到新的、随机的或动态的 C2 点，以避免统计异常

+   定期生成伪合法流量以避免行为分析的审查

+   禁用或删除活动日志，以避免取证分析

高级 C2（指挥与控制）战术、技术和程序（TTPs）可能特别危险，几乎无法被检测到，也很难阻止。考虑一下一个 Windows IT 管理员的例子，他们已经实施了如此严格的防火墙控制，以至于唯一能访问的站点是*technet.microsoft.com*，这是微软为 IT 专业人员提供的官方技术门户网站。仅允许 HTTPS 协议，防病毒软件已更新并在运行，操作系统也已经完全打上补丁。没有外部程序，如电子邮件、Skype 或 iTunes 在运行，只有管理员需要使用的微软 TechNet 网站。听起来这似乎很安全，但要考虑到中国 APT17（也被称为 Deputy Dog 或 Aurora Panda）将隐藏的 IP 地址编码在发布在微软 TechNet 页面上的评论中——这些评论与一个名为 BLACKCOFFEE 的远程访问木马通信，后者驻留在被攻陷的系统中。^(5) 如果有人检查了代理流量、行为分析、异常启发式、IDS 签名、防病毒软件或防火墙警报，什么显著的迹象都不会表明恶意通信正在发生。

针对复杂的 C2 的高级防御工作通常包括将系统与外界隔离（空气隔离），但近年来，新的 C2 通信技术已经得到发展。一个例子是使用带有 rootkit 或被攻陷固件和恶意软件的 USB 设备，一旦插入系统，就会与被攻陷系统上的植入物进行通信，收集打包的数据，并巧妙地上传以便外泄到外部 C2 服务器。

## 控制通信

许多组织通常订阅多个威胁指标源，这些源不断提供恶意的 URL、IP 地址和域名，这些地址和域名被观察到作为 C2 服务器工作。然后，组织会在其防火墙和安全设备中发出警报和/或阻止这些威胁。这是防御 C2 的一种良好起点，但新 URL、IP 和域名的源源不断地出现，使得威胁行为者可以采用新的身份并避开威胁指标源。因此，需要采取新旧方法来应对 C2，其中一些方法如下所示。

1.  *遵循最佳实践。* 虽然完全阻止所有 C2 通信可能不切实际，甚至是不可能的，但通过实施网络安全最佳实践，你可以阻止基础或中级的 C2。具体来说，了解你的网络、设置边界和流量控制、建立白名单并授权猎杀小组主动阻止或拦截 C2 通信。不要在最佳实践上走捷径，而是要致力于做扎实的安全工作。记录、测试和验证你的最佳实践，并请独立的第三方评估人员提供额外的措施和验证。投资于提升安全性，同时保持并改善你现有的最佳实践基础设施。

1.  *实施带有“远程查看”控制的分段策略。* 网络分段和隔离意味着建立多个网络和机器，例如内联网机器和一个与之隔离的非机密互联网机器。分段应防止 C2 通信跨越边界。遗憾的是，用户通常会将其内联网机器临时接入互联网以下载文档或库，或者进行其他安全协议的违规行为。解决此类问题的一种方法是配置内联网机器，使其远程查看另一台连接到互联网的隔离机器。该隔离的互联网机器对用户既不可物理访问，也不可直接访问；他们只能发出命令并查看屏幕，但无法从隔离的互联网机器中接收到实际的原始信息。远程查看机器实际上就像一台显示另一台计算机的电视监视器。因此，C2 通信、恶意软件和漏洞无法通过视频信号跳跃进入造成损害。

## 推荐的安全控制和缓解措施

在相关情况下，提出的建议将与 NIST 800-53 标准中的适用安全控制一起呈现。每项建议都应考虑 C2 的概念进行评估。

1.  在系统、网络边界和网络出口点实施保护措施，寻找网络中数据外泄的迹象。这可能意味着阻止加密隧道，防止您的传感器无法拦截，同时还要寻找未经授权的协议、数据格式、水印、敏感数据标签以及离开您网络的大文件或数据流的证据。 [AC-4: 信息流控制 | (4) 内容检查加密信息；SC-7: 边界保护 | (10) 防止数据外泄；SI-4: 系统监控 | (10) 加密通信的可见性]

1.  建立多个网络，并在互联网与内联网资源之间进行隔离和分段。限制关键内部系统与互联网的连接。 [AC-4: 信息流控制 | (21) 信息流的物理与逻辑分隔；CA-3: 系统互联 | (1) 非机密国家安全系统连接 | (2) 机密国家安全系统连接 | (5) 限制外部系统连接；SC-7: 边界保护 | (1) 物理隔离子网 | (11) 限制进入通信流量 | (22) 用于连接不同安全域的子网]

1.  限制对任何包含关键信息的系统的远程访问。 [AC-17: 远程访问]

1.  实施限制和配置控制，以检测和防止未经授权的无线通信。 [AC-18: 无线访问 | (2) 监控未经授权的连接；PE-19: 信息泄漏；SC-31: 隐蔽通道分析；SC-40: 无线链路保护；SI-4: 系统监控 | (15) 无线到有线通信]

1.  训练你的安全团队和员工识别 C2 通信。[AT-3: 基于角色的培训 | (4) 可疑通信和异常系统行为；SI-4: 系统监控 | (11) 分析通信流量异常 | (13) 分析流量和事件模式 | (18) 分析流量和隐蔽外泄]

1.  阻止任何未经授权的软件在你的系统上运行，这些软件可能是 C2 后门或植入物。[CM-7: 最小功能 | (5) 授权软件–白名单]

1.  保护绕过安全控制和边界的直接物理连接到系统；这些包括交换机机柜、以太网墙插座和计算机接口。[PE-6: 监控物理访问；SC-7: 边界保护 | (14) 防止未经授权的物理连接 | (19) 阻止来自非组织配置主机的通信]

1.  要求检查和扫描进入或离开贵组织的可移动媒体，以防止员工通过交付和移除外部媒体手动执行 C2 通信。[PE-16: 交付和移除]

1.  实施白名单，以拒绝与任何未获批准作为例外的资源或地址的通信。许多 C2 站点是全新的域名，贵组织没有合法使用的历史。[SC-7: 边界保护 | (5) 默认拒绝—例外允许]

## 汇报

在本章中，我们回顾了忍者用来接收和发送命令给盟友的各种通信方法。我们描述了各种现代 C2 方法及其对应的忍者方法。然而，我们仅仅触及了表面，因为最复杂的 C2 技术可能尚未被发现。就像忍者最好的隐蔽通信方法从未被记录下来一样，我们可能永远无法了解最先进 C2 技术背后的天才和创造力。我们讨论了几种最佳实践，包括白名单和加密检查，作为减轻对手 C2 的方式，但这一问题的理想解决方案仍待发现。

在下一章，我们将讨论忍者的呼号。这些是通过留下独特的标记或信息与盟友在敌方领土内进行通信的方法。类似于死信箱，呼号从不超出环境边界，因此传统的 C2 通信阻止或检测方法通常无法对其起作用。
