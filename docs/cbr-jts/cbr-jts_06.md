# 第六章：渗透时段

在等待到牛时，忍者意识到守卫已经睡着了；一切都死一般的寂静，火也熄灭了，四周一片黑暗。

> 对于忍者来说，了解正确的时机至关重要。理想的时机总是敌人疲惫或放松警惕的时候。
> 
> —吉盛百首 #5

在策划盗窃、间谍活动、破坏、暗杀或其他攻击时，忍者并不受到体育精神或公平竞赛的束缚。相反，他们会仔细考虑“最合适的时机和有利的位置”^(1) 来发动攻击。*书忍记*强调了在目标分心、疲惫、容易仓促判断、饮酒狂欢或疲劳时等待渗透的重要性；*吉盛百首*诗歌 63 指出，人的疲劳“可能是严重失误的原因。”^(2) 忍者是善于观察这些行为的，他们往往会在敌人砍伐树木、专注于布置阵地、在战斗后感到疲惫或换岗时进行渗透。^(3)

在研究敌人的行为时，忍者发现可预测的人类日常习惯为攻击提供了机会窗口。卷轴将一天分为两个小时一段，建议在那些与醒来、吃饭和睡觉时间相一致的时段进行渗透。具体的时段取决于攻击的类型。例如，夜间攻击最好选择在猪时（9:00 pm–11:00 pm）、鼠时（11:00 pm–1:00 am）和兔时（5:00 am–7:00 am），这些都是中国生肖中的动物时段。^(4)

此外，*万川集海*指出，一些将军相信通过中国占星学预测的“吉日”。在这些日期，攻击被认为是注定会成功的。如果忍者能识别出相信这些迷信的敌方指挥官，他们可以利用这些信息——例如，根据指挥官认为是吉日或不吉日的日期来预测敌军的行动。说到可预测的行为模式，很多事情并没有改变。在这一章中，我们将讨论如何将网络攻击者针对时间安排事件的行为模式作为目标。

## 理解时间与机会

因为人们仍然按照类似封建时代日本的日程作息：起床、工作、吃饭、放松和睡觉，所以卷轴中提到的渗透时段与现代工作日的员工分心、疲惫或因工作压力而疏忽的时段紧密相连——换句话说，就是他们最容易受到攻击的时刻。考虑一下卷轴中提到的时间段，结合网络和信息系统的活动及使用模式：

1.  兔时（5:00 am–7:00 am）用户起床并首次登录。自动和手动系统启动，导致事件日志和系统日志激增。

1.  马时段（中午 11:00–下午 1:00）许多用户会休息吃午餐，这意味着他们会登出系统或因闲置超时而自动退出。他们也可能出于个人原因上网浏览—查看新闻、购物、查看个人邮件、发布社交媒体动态，或执行其他可能触发异常检测系统的活动。

1.  鸡时段（下午 5:00–7:00）用户找到工作中的停顿点。他们保存文件，可能匆忙完成任务，从而大大增加了工作和网络安全警觉性失误的风险。例如，一个工作人员可能会不假思索地打开一封看似紧急的邮件附件。用户集体登出账户和系统，但有些账户则被遗弃，直到超时断开连接。

1.  野猪时段（晚上 9:00–11:00）大多数用户已经下班。无论他们是在家、外出社交，还是准备上床睡觉，他们可能不会把工作账户和系统的安全放在心上。拥有夜间 SOC（安全运营中心）人员的组织通常会在此时交接班，这为攻击者提供了一个在用户登录间隙或 SOC 人员准备开始工作时发起攻击的窗口。时间越晚，用户—即便是习惯熬夜的人—也可能变得困倦或放松警惕，因为一切看似安静。

1.  老鼠时段（晚上 11:00–凌晨 1:00）网络和系统进行备份或其他定期维护，产生了网络传感器和 SIEM 的噪音。SOC 人员可能已经完成了每日的安全和维护任务，正沉浸在项目工作中。

1.  虎时段（凌晨 3:00–5:00）批处理任务，包括处理日志文件、运行诊断和启动软件构建，通常会在此时执行。除了 SOC 人员外，大多数用户正处于睡眠周期的深度阶段，账户也没有活动。

1.  幸运日 也有一些特定的日子、星期或月份，敌人更可能瞄准系统和用户。虽然大多数组织领导者不会基于“幸运日”来安排活动，但威胁行为者肯定会注意到定期安排的升级或维护，此时组织会将防御措施下线，三天假期和公司假期也常常是系统和账户疏于检查的时候。如果没有考虑到潜在的威胁，这些时段的网络流量和系统日志中的异常可能会被忽视，导致攻击者得以进行攻击、侦察或指挥与控制（C2）通信、传播恶意软件或执行数据外泄。

## 开发基于时间的安全控制和异常检测器

你可以借助忍者的渗透时间框架，开发考虑网络在不同时间的基线状态、偏离基线的情况和业务需求的基于时间的安全控制。实施基于时间的安全通常通过三个步骤实现：

1.  确定每小时的活动基线。

1.  培训人员监控活动，并在他们的值班时间内非常熟悉典型的活动模式。

1.  评估每小时的业务需求。基于这一评估，创建业务逻辑和安全公理，以进一步减轻威胁并检测异常。

首先，考虑将网络和系统日志分为一小时或两小时的时间段。回顾网络和系统的历史趋势和活动水平，建立基准，这是进行威胁狩猎和识别网络卫生问题的关键指标。特别注意发生过攻击的时间段，以及那些根据组织的情况、威胁建模和经验可能定期容易受到攻击的时段。

一旦所有数据被划分并建立了基线，培训分析员、系统管理员和安全专业人员，使他们非常熟悉你网络的活动模式。他们还应了解组织日常工作流程所带来的安全漏洞。忍者的卷轴指示守卫要仔细检查每一个不规则和不协调的情况。例如，他们应注意到渔夫比平时晚到，或者在奇怪的时间听到不熟悉的鸟鸣。让安全人员同样关注不协调的情况，可能促使他们对异常事件进行二次检查，这可能揭示出安全事件。培养这种深度专业知识可能需要安排安全人员监控一个部门——例如一个被认为是可能攻击目标的单一系统——并与之变得非常熟悉，然后在他们的八小时值班期间，查看该系统的所有日志和事件，时间框架为两小时。这一策略与大多数 SOC（安全运营中心）“随时监控一切”的心态截然不同——这种心态会导致警报疲劳、过载和职业倦怠。它还应能缓解许多自动化异常检测系统的问题，这些系统需要人工对每个异常进行跟踪，并提供反馈和调查。这些系统很快就会让每天或每周检查异常的安全人员感到不堪重负，数据也变得难以理解。

请注意，安全日志并非短暂如夜晚的声音，而是可以供未来分析使用。一个高明的对手可能会篡改或删除安全日志，过滤网络探针和传感器的流量，或者以其他方式破坏用于记录其入侵和警报安全的系统。然而，这些行为应该足以扰乱系统的正常行为，使得一位敏锐的安全分析员能够察觉。

接下来，你需要问自己两个问题：

+   你的用户和系统在什么时间活跃？

+   对手可能在什么时间活跃？

了解用户何时登录和操作你的系统，可以帮助你战略性地限制访问，使外部或内部威胁更难在你最脆弱的时段渗透。例如，如果一个系统在晚上 8:00 到早上 8:00 之间没有使用，就在这些时间关闭该系统。如果用户在周六没有业务需要访问他们的系统，那么禁用周六所有用户对这些系统的访问。定期在特定时间禁用系统还有助于训练 SOC 工作人员在特定时段检测异常，因为届时会有更少的警报和系统需要检查。NIST 标准建议实施这样的访问控制，但许多组织更倾向于在紧急情况下优先考虑某些场景，以提高操作的便利性，尽管这些情况发生的可能性非常低。

## 推荐的安全控制和缓解措施

在相关情况下，建议提供适用的 NIST 800-53 标准中的安全控制。每项建议都应考虑渗透的时间因素进行评估。（请注意，应用这些技术时要求日志和警报具有时间戳，并且所有系统的时间保持同步。参见 AU-8: 时间戳。）

1.  评估你的运营时间并进行威胁建模。你在什么时间最容易受到攻击？你可以做些什么来训练员工做好准备？[NIST SP 800-154: 数据中心系统威胁建模指南]^(6)

1.  根据用户的业务和操作需求，在账户上实施基于时间的权限控制。例如，限制某些用户在晚上 7:00 后发送或接收工作电子邮件的能力。[AC-2: 账户管理 | (6) 动态权限管理]

1.  限制在特定时间内登录或使用特定账户的能力。例如，当有人尝试在晚上 9:00 至 11:00 之间对一个非活动账户进行未授权操作时，立即提醒用户验证其身份。如果用户未响应或身份验证失败，通知 SOC。[AC-2: 账户管理 | (11) 使用条件]

1.  利用启发式分析系统，在设定的时间内检测异常的系统访问或使用模式。用户应自愿记录并提供他们“典型使用”模式的见解，以帮助建模他们在工作日中的预期行为。[AC-2: 账户管理 | (12) 账户监控非典型使用]

1.  要求系统所有者和用户记录系统预期使用的时间以及何时可以关闭系统。[AC-3: 访问执行 | (5) 安全相关信息]

1.  缩短对手可以操作的时间框架。定义一个战略性企业政策，规定敏感或专有信息仅在特定时间内访问——例如，工作日的上午 11:00 至下午 3:00 之间。[AC-17: 远程访问 | (9) 断开/禁用访问]

1.  在账户持有人成功或未能登录时通知他们，包括上次登录的时间和日期。跟踪这些信息有助于用户在账户被入侵时提醒安全运营中心（SOC），并告知 SOC 未授权访问发生的时间。[AC-9：上次登录（访问）通知 | （4）附加登录信息]

1.  在确定了操作时间后，配置用户设备和系统，在指定时间自动锁定，终止所有会话。[AC-11：会话锁定]

1.  制定一项政策，传达允许对基础设施和系统进行更改的时间和日期。这有助于 SOC 在逐小时评估网络和配置更改时。[AU-12：审计生成 | （1）系统范围和时间审计相关性轨迹；CM-5：变更访问限制]

## 事后报告

在本章中，你了解了基于中国生肖的传统日本时间、中国占星术对占卜的影响，以及忍者如何利用这些知识抓住机会渗透或超越目标。你还考虑了网络活动如何随着一天中的时间变化而变化，以及如何通过基于时间的控制来减少攻击机会。你熟悉了忍者的安全标准。具体来说，你学到了安保人员需要注意到扫描区域中最小的不一致之处——任何可能表明敌人存在的迹象。此外，你还回顾了如何将这些概念应用到你的威胁狩猎、安全操作流程和异常检测系统中的指导。

在下一章中，我们将回顾时间机密性的应用，保持时间对恶意软件的保密，这可能使防御者能够采取特定的检测和防御措施。
