# 第十六章：活捉

使用良好的判断力来判断目标是否真的不注意，或者他们是否在施展诡计诱捕忍者。

> 如果你在夜间巡逻时发现可疑人物，你应该动用所有资源将其活捉。
> 
> —吉盛百首 #74

尽管忍者在日常工作中会遭遇致命暴力，*万川集海*建议捕捉敌人，特别是可疑的忍者，应该活捉而不是立即杀死。通过搜查和审讯被捕的忍者，忍者可以发现袭击者已经做了什么或正在计划做什么，确定入侵者的雇主是谁，学习到有价值的秘密和技艺，这些都能极大地帮助守卫防御忍者攻击，并帮助领主了解战略威胁。此外，被捕的敌人可能是伪装的同袍，直到深入审讯后才会明晰这一事实。^(1) *忍秘传*要求将嫌疑忍者手脚捆绑并置于绳索上。*忍秘传*还建议使用工具，如带刺的口塞，以防止被捕者说话，因为一个熟练的忍者可能会警告盟友，劝说捕捉者释放自己，甚至咬断舌头自杀。^(2)

这些卷轴承认，活捉一名敌方忍者并非易事。*万川集海*的其中一种更直接的技巧是用辣椒粉浸泡的棉球装填火枪——一种类似古代催泪瓦斯或胡椒喷雾的武器。当近距离射击时，这种投射物会对目标的眼睛和鼻子造成剧烈刺激，使其更容易被捕捉。卷轴中还描述了更多间接战术，如*伏死守*伏击和陷阱。例如，*万川集海*中的虎坑陷阱（*mogari* 或 *koraku*）最初是为了捕捉老虎而设计的（如名字所示），但后来被改造用来捕捉忍者。在这个陷阱中，障碍物将入侵者引导通过一系列隐蔽的陷阱。虽然盟友会知道一条信任的路径，但独自夜间潜入的忍者则不会，这使得他们更容易落入陷阱。其他使用的方法包括*吊立提*，即“假悬挂墙段”，它们看起来像真正的墙壁，但由楔子和假柱子构成。当忍者试图攀爬这些假墙时，墙体会倒塌，给忍者带来惊讶，并可能导致伤害，从而使得他们容易被捕捉。^(3)

*Bansenshūkai* 还建议采取防守措施以防被捕，提出了识别和避免 *fushi-kamari* 埋伏的方法。忍者被建议在森林、田野、山谷、沟壑等地察看是否有鸟类、其他动物甚至草丛中的不寻常行为，这些可能暗示着陷阱的存在。假人和不寻常的气味也能暴露埋伏的痕迹。^(4) 在敌方领土中，忍者可以使用多种躲避战术，包括：

1.  **鹌鹑藏身（*****uzura-gakure*****)** 忍者会蜷缩成球，专心使自己看不见、听不见、不作反应，这样敌人就不容易发现他们。即使被守卫用长矛或剑戳到，他们也不会作出反应。

1.  **狸犬退（**tanuki-noki**）** 在步行逃跑时，忍者会故意被更快的追击者“抓住”。当两者之间的距离缩小时，忍者会突然倒地，将剑指向追击者的腰部，在对方反应过来之前将其刺杀。

1.  **百雷阵退（**hyakurai-ju**）** 忍者会在目标附近放置鞭炮，要么设置延迟引线，要么安排同伴点燃。鞭炮的声音能够分散敌人的追击注意力。

1.  **狐藏身（**kitsune-gakure**）** 忍者通过垂直移动逃脱。忍者不会试图从 A 点逃到 B 点，而是爬上高树或躲进护城河，改变追击的维度。这种战术常常让敌人感到困惑，因为敌人通常不会想到抬头或低头寻找目标。^(5)

其他逃脱方法包括模仿——模仿狗或其他动物以迷惑追击者——以及假对话——通过误导敌人的语言，使忍者有机会逃脱。^(6) 例如，一个知道自己被跟踪的忍者可能假装没有听到追击者的声音，低声与一个虚构的同伴交谈，以便警觉的守卫能听到。如果忍者说：“我们悄悄地去主人的卧室，把他杀掉，”守卫们很可能会派人去主人的卧室，从而让忍者能朝另一个方向逃脱。

当然，忍者避免被捕的最佳方法是没有留下任何能让调查者怀疑的证据。卷轴强调了在执行任务时保持无痕的重要性，以便目标没有理由怀疑忍者的存在。卷轴中有大量关于秘密行动的指导，文字生动形象。*Yoshimori Hyakushu* #53 说道：“如果你必须在下雪天作为忍者潜入，首先要注意的是你的脚步声。”^(7)

可惜的是，捕获活跃威胁并非许多组织的首要任务。当一些组织在系统上发现威胁时，他们往往做出与忍者卷轴中建议的完全相反的反应：他们立即拔掉机器电源，擦除所有数据，重新格式化驱动器，并安装操作系统的新版本。虽然这种“抹除并忘记”的反应能消除威胁，但它也剥夺了捕获威胁的任何机会，更别提调查它或分析它的目标、已完成的任务及其方式了。

在本章中，我们将讨论能够捕捉和与“活跃”的网络威胁互动的重要性。我们将回顾现有的取证/捕捉方法，以及威胁行为者可能试图规避它们的方式。我们将考虑通过老虎陷阱和蜜罐伏击等方法捕捉“活跃”的网络威胁——这些技巧灵感来源于古代的忍者。此外，我们还将涉及忍者回避战术的现代应用（例如，鹌鹑藏匿和狐狸藏匿），这些战术已被持续性威胁所使用。最后，我们将介绍忍者卷轴中关于捕获和审讯的许多指导——这些指导涉及如何正确控制威胁，以使其无法警告盟友或自我销毁。

## 实时分析

在网络安全中，计算机取证影像提供了必要的威胁情报。取证影像通常是在安全事件（如恶意软件感染）或使用违规（如设备上下载儿童色情内容）后制作的，影像的制作方式是为了保存证据而不破坏正在调查系统的数据完整性。取证影像中的证据可以帮助安全专家了解威胁是什么，以及它如何利用漏洞。随后，随着时间的推移，这些信息可以为开发签名、保障措施和主动拦截措施提供必要的信息。例如，确定攻击者试图窃取某个关键系统上的特定知识产权，可以告知防御者保护该系统的数据。如果取证结果显示攻击成功并且敏感数据被泄露，组织可以利用这些信息来确定其战略业务响应。如果威胁未能成功，组织则可以为可能的后续攻击做准备。取证指示还可能揭示威胁的责任方，从而进一步决定响应策略。组织的战略应该考虑威胁的严重性——例如，攻击者是外国政府、不满的员工，还是仅仅为了出名进行恶作剧的黑客。

收集设备数据进行分析涉及*实时捕获*（也称为*实时分析*或*实时采集*）和*成像*（也称为*法医成像*或*镜像*）。组织使用蜜罐和其他虚拟环境诱捕并与攻击者进行互动。此类系统通常被配置为吸引黑客或易于恶意软件访问，以便当威胁渗透系统时，隐藏的日志记录和监控控制能够捕捉威胁的所有行为及其方式，以及其他可观察的数据。不幸的是，许多攻击者已经意识到这些蜜罐，并进行测试以确定自己是否处于一个旨在收集情报的模拟环境中。如果他们的怀疑得到证实，攻击者将采取不同的行为或停止操作，从而破坏安全团队的努力。网络访问控制（NAC）设备还可以通过动态切换系统到被感染的 VLAN 中来阻止实时威胁，在此期间系统保持在线和“实时”，而防御者则进行响应。

法医鉴定通常不会在实时捕获中进行。相反，法医分析师查看的是静态的、无生命的或已死亡的数据，这些数据可能丢失了某些信息或威胁的独特细节。这在无文件恶意软件中尤为常见，这类恶意软件驻留在内存中，或存在于特定的恶意配置或工件中，例如路由表缓存中的那些。由于以下多个原因，实时分析通常不被执行：

+   专业技术要求

+   必须绕过要求断开、拔掉、隔离或屏蔽被感染系统的组织政策

+   缺乏能够进行现场实时分析的法医资源

+   在调查过程中员工无法访问重要系统

也许最重要的是，如果实时分析处理不当，威胁可能会察觉到系统中的法医成像软件，并决定隐藏、删除自己、执行反法医对抗措施，或对系统进行破坏性攻击。

为了绕过法医捕获技术，威胁会分阶段部署。在初期阶段，即侦察阶段，威胁会检查捕获技术的存在，仅在验证它可以安全地在环境中运行后才加载恶意软件和工具。对于威胁行为者来说，这种预防措施是必要的。如果成功捕获并进行法医分析，威胁的工具和技术可以与其他组织和防御者共享，帮助他们从攻击中学习、修补漏洞或开发对策。执法机关甚至可能使用法医捕获战术来追踪或提供针对威胁行为者的证据。

最近，精密的攻击者已横向渗透到计算机和网络领域，这些领域标准的取证成像、捕捉和分析工具无法检查。这些攻击者的创新包括安装硬盘固件，创建一个隐藏的、加密的文件系统；将恶意软件嵌入 BIOS 存储；利用本地微芯片存储在正常工作内存之外进行操作；以及修改网络设备（如路由器、交换机、智能打印机等传统上不被取证成像检查的设备）上的低级模块和代码。有些威胁通过渗透原始制造商（天然被信任且不考虑进行取证分析）来模仿核心操作系统或受信任的安全组件。另一些则通过删除取证证据、转移到一个不经常重置的系统内存中（如域控制器），然后等待相关系统的取证审查减弱后，再返回原目标。

## 面对实时威胁

组织常常发现自己在处理一个活跃的安全事件时，唯一经过取证成像工具培训的人员正好不在办公室。有时需要几天时间才能将隔离的机器送到该人员进行检查，而此时攻击已经不再是当前威胁的实时表现。这种无法与威胁保持同等速度甚至更快的应对能力，使得防御人员沦为取证清道夫——在威胁行为者已经达成目标后，收集证据并清理感染的人。为了捕捉活跃的威胁并进行彻底审问，必须主动建立应对能力、陷阱和埋伏。

1.  *建立取证能力。* 致力于并投资于建立一支专门的团队，配备必要的设备、经验、认证和授权来进行计算机取证工作。创建包含写入阻止器、安全硬盘以及其他专业软件和设备的取证工具包。确保所有用于捕捉和分析的系统都具备适当的取证代理，以便团队能够立即识别、定位、隔离并进行数据采集。确保所有员工理解如何帮助取证团队识别和定位受影响的系统，并保存证据。如果自上次进行取证调查已超过一个月，应该与取证团队一起开展复训课程或演练。最重要的是，当取证报告完成时，仔细阅读报告以发现安全事件的根本原因，并采取主动措施修复被利用的漏洞。

1.  *执行蜜罐伏击*。在适当的情况下，授权你的团队进行威胁行为者的伏击，而不仅仅是追踪他们的足迹或将其引入蜜罐。积极地捕捉和伏击威胁需要与你的云服务托管商、互联网服务提供商（ISP）、注册商、VPN 服务提供商、互联网犯罪投诉中心（IC3）、金融服务机构、执法机关、私人安全公司及商业公司建立密切合作关系。支持创建对威胁行为者敌对的网络领土的目标，在这里，你与合作伙伴的联合力量可以伏击威胁行为者、组织或行动，捕获证据、恶意软件、工具和漏洞。

1.  *设置虎落陷阱*。考虑在你的网络中可能成为目标的地方设置虎落陷阱，例如域控制器。市场上存在一个机会，即开发一种具有蜜罐功能的操作生产系统，如果执行错误操作，系统将触发。这是因为威胁行为者通常在试图绕过安全控制时，会从一个系统转移到另一个系统，或在系统和网络之间横向移动，因此可能可以建立虚假的或带有陷阱的跳转箱，这些跳转箱看起来像是通向其他网络的路径，但实际上却是用来困住威胁的。以这种方式部署这些陷阱，使得错误操作会导致系统冻结、锁定或隔离攻击，从而允许防御人员检查、互动或进行现场取证捕获威胁。通过冻结 CPU 时钟、使硬盘仅在缓冲模式下操作，或者使用虚拟机监控器来捕捉并记录活动来实现。提供培训，确保系统管理员和其他 IT 专业人员能够在不陷入陷阱的情况下远程访问合法路径。

## 推荐的安全控制措施和缓解措施

在相关的情况下，推荐的措施会展示出符合 NIST 800-53 标准的安全控制措施。每项措施应以现场捕获的概念为依据进行评估。

1.  如果没有授权或能力对外部系统和组件进行取证调查，请限制在组织内部使用外部系统和组件。[AC-20: 使用外部系统 | (3) 非组织拥有的系统和组件]

1.  使用外部传感器和安全信息与事件管理系统（SIEM），并且这些系统无法轻易访问时，实施自动化机制以全面收集现场数据、PCAP、syslog 以及进行取证分析所需的其他数据。[AU-2: 审计事件；AU-5: 对审计处理失败的响应 | (2) 实时警报；IR-4: 事件处理 | (1) 自动化事件处理流程；SA-9: 外部系统服务 | (5) 处理、存储和服务位置；SC-7: 边界保护 | (13) 安全工具、机制和支持组件的隔离]

1.  如果您决定实施非持久性措施来防御威胁——例如定期重建或重新映像所有系统以销毁任何未经授权的访问——请考虑在重新映像或拆除之前进行取证采集，以保留威胁证据。[AU-11: 审计记录保留 | (1) 长期检索能力；MP-6: 媒体清除 | (8) 远程清除或擦除信息；SI-14: 非持久性；SI-18: 信息处置]

1.  在您的组织中实施、记录并执行基准系统配置，以便取证分析员更容易判断哪些信息可能已被威胁篡改。[CM-2: 基准配置 | (7) 为高风险区域配置系统和组件；SC-34: 不可修改的可执行程序]

1.  为您的取证团队提供培训和模拟演练，以便在发生安全事件时能够有效响应。[IR-2: 事件响应培训 | (1) 模拟事件]

1.  建立一个具有实时取证采集和调查能力及授权的取证分析团队。[IR-10: 集成信息安全分析团队]

1.  使用防护措施验证取证系统、软件和硬件未被篡改。[SA-12: 供应链风险管理 | (10) 验证为真实且未被篡改 | (14) 身份识别与可追溯性]

## 事后分析

在本章中，我们回顾了捕获和审问敌方忍者的忍者技巧，以及用来规避被捕的战术。我们讨论了收集更多取证证据如何给威胁者提供更多机会来向调查人员提供虚假的数据点——以及为什么与活跃威胁互动可能更有利。我们还讨论了围绕取证能力的最佳实践，以便能够识别威胁，并探讨了应对威胁的高级技巧，例如埋伏和陷阱。

在下一章，我们将讨论忍者武器库中最具破坏力的攻击方式：火攻。
