# 8

工具

记住，如果你使用忍者工具，一定要在风声呼啸时使用，以掩盖任何声音，并始终把它取回。

> 无论你携带多少工具作为忍者，记住，最重要的是，你的食物应该始终挂在腰间*。*
> 
> —吉森百首 #21

尽管好莱坞的描绘通常显示忍者挥舞飞镖或武士刀，真实的忍者却开发了种类繁多且极具个性的工具和武器，他们被教导要非常小心地选择合适的工具来完成任务。^(1) 三部忍者卷轴都花了大量篇幅来描述秘密工具，其中许多工具在当时是创新性的技术。*《万川集海》*中仅包含了五卷关于工具的内容。它指出，最佳的工具不仅可以用于多种用途，而且要安静、不笨重。^(2) *《正忍记》*建议忍者们限制携带工具的数量，因为任何一件设备如果显得不合时宜，可能会引起怀疑。^(3) 该卷还建议忍者去寻找并破坏目标的工具和武器；这些工具对忍者的能力至关重要。^(4)

当然，忍者并不是从任何大型忍者用品商店获得他们的工具。相反，根据卷轴的指导，他们从容易购买、找到或制造的物品中制作了有效的工具。这种方法有几个优势。这些日常物品可以在不引起太多怀疑的情况下携带^(5)，甚至可以作为忍者伪装的辅助道具。例如，包括丰臣秀吉和织田信长在内的几位统治者曾下令进行刀剑搜查——对平民的所有刀剑及其他武器进行大规模没收——以减少反叛者攻击统治军的能力。^(6) 在这种情况下，任何穿着剑或其他武器的非武士都会被没收武器。为了绕过这一战术，忍者悄悄地改造了常见的农具作为武器，因为没有法令禁止在公共场合携带锋利的农具。在训练有素的忍者手中，普通的农具变成了致命武器。

尽管这些工具极具实用性，*《万川集海》*指出，使用工具的核心原则不仅仅是运用它们，更是要对它们的目的有一种开悟般的、禅宗式的理解。^(7) 忍者们深入思考并频繁训练他们的工具，不断重新想象这些工具在实战中的用途。因此，忍者们定期改进现有工具，发明新工具，并将这些知识传授给其他盟友忍者。^(8)

在本章中，我们将探讨工具。我们将讨论工具的双重性质——同一工具根据操作员的不同，可能做出好事或坏事。这种二元*in-yo*，或称*阴阳*的概念，是理解黑客如何使用数字工具的有用模型。例如，考虑一个旨在帮助用户的工具，如何可能被用于恶意目的。

除了具有好坏潜力外，每个工具还可以被重新利用或以不同的方式应用。花点时间想一想，用锤子可以做的十几种事情。像这样的简单思维练习可以帮助你更深入地理解锤子到底是什么，锤子如何得到改进，或者如何发明一种全新的锤子来完成一些新颖的任务。这些相同的创造性技能也可以应用于重新编码数字工具和软件工具。在最高水平的掌握中，这种创造性重塑相当于大师级铁匠的工作。铁匠可以锻造新的工具、机器和系统，从而改变他们对自己手艺的思考方式；打开新的建造可能性；并增强他们开发新武器、防御和工具的能力。

为了明确，工具的对抗性使用可能是我们永远无法完全逃避的威胁。话虽如此，在本章中，我将描述有关工具的安全最佳实践，以及一些可能缓解攻击的增强控制措施。

## 土地生存

在网络安全领域，*工具*是任何帮助手动或自动执行任务的仪器。如果这听起来像一个涵盖面广泛的定义，那是因为它确实如此。工具可以是物理工具，例如 BadUSB、Wi-Fi 嗅探器和开锁器，也可以是软件工具，如平台、漏洞、代码、脚本和可执行文件。整个计算机系统本身就是一种工具。一个工具可以有合法的用途，但在黑客手中，它可以变成武器。例如，考虑管理员用来执行远程维护的 SSH 客户端，攻击者可以利用它进行反向 SSH 隧道攻击，从而攻击系统并绕过防火墙。

就像忍者一样，网络对手在实现目标时极度依赖工具，他们不断开发、定制、打磨和测试自己的工具，以应对野外现有技术的挑战。高级威胁组织雇佣全职专门的工具和能力开发人员来维护和改进他们的工具集。作为回应，进取的网络防御者致力于逆向工程这些定制工具，以便构建对策、实施有效的安全策略和检测签名、在沙盒环境中测试恶意工具的能力，并创建能够识别和拦截危险工具的应用白名单。在某些情况下，新防御措施应用得如此出色，以至于对手无法下载或安装他们的工具到目标系统，因为基于主机的安全系统会立即将这些工具隔离、阻止访问，并向安全人员发出警报。

由于基于主机的安全系统能够检测和阻止专用工具和恶意软件，现在许多对手都采取了一种名为“借用现有资源”的渗透策略。采用这种方法，攻击者首先收集目标系统上已经在使用的软件和工具的信息。然后，他们仅使用这些应用程序来构建攻击，因为主机系统的防御不会认为这些应用程序是有害的。“借用现有资源”攻击可以使用受害者计算机磁盘上的任何文件，包括任务调度程序、网页浏览器和 Windows 管理工具（WMI）命令行工具，以及脚本引擎如 cmd/bat、JavaScript、Lua、Python 和 VBScript。就像忍者利用目标环境中常见的物品，如农具，他们知道这些物品随手可得且易于融入一样，黑客通过利用目标机器上已有的资源，可以将日常的用户和管理员工具、应用程序以及操作系统文件变成他们的工具。

在 Windows 机器上，一个常见的易受利用的工具是微软强大的 PowerShell 框架。即使是微软也承认，威胁行为者经常将 PowerShell 作为攻击目标，用以渗透系统、执行未经授权的操作，进而危害组织的系统。因此，微软提供了安全和缓解功能，例如特权访问管理（PAM）来实施“刚好足够的管理”（JEA），并结合即时（JIT）管理。不幸的是，JEA/JIT 将 PowerShell 的普及性转变为对人类 IT 管理员来说的一个访问控制噩梦。为什么？我就不细说更技术性的细节了。试想一下，一个技术人员被召来排除故障，但只能带上一把螺丝刀，并且只能在下午 1:00 到 2:00 之间使用这把螺丝刀。

使用访问控制措施来锁定工具，只有当 IT 团队愿意大幅限制其自身效率时才有效。即便如此，当这些日常工具存在于目标系统上时，依然存在固有的危险——网络安全专家已经观察到，威胁行为者能够轻松地将工具从本地锁定中解锁。网络安全的一个事实是：只要这些复杂的工具存在，滥用它们的潜力也就存在。

## 工具安全

拥有工具的悖论在于，你需要它们来操作，但对手也同样需要。应对这一挑战的一种方法是将工具的数量、功能、访问权限和可用性减少到最低限度。虽然这种策略会使你在自己环境中的操作变得稍微困难，但如果有足够的安全控制，它应该会让潜在的对手更加*困难*。这种方法的一个缺点是，你削弱了远程管理环境的能力的恢复性和鲁棒性。因此，如果对手通过移除或破坏重要工具来突破防护，你的保护措施可能会破坏你管理和修复系统的能力。为了保障工具的安全，以下步骤是一个很好的起点：

1.  *确定基准。* 对员工进行角色基础的调查，并在组织内所有系统上进行软件清单审核。记录每个工具的用户、版本号和系统位置的详细列表，包括所有软件/应用程序、脚本、库、系统和角色。这包括操作系统和系统文件，如下所示：

    | *sc.exe* | *find.exe* | *sdelete.exe* | *runasuser.exe* |
    | --- | --- | --- | --- |
    | *net.exe* | *curl.exe* | *psexec.exe* | *rdpclip.exe* |
    | *powershell.exe* | *netstat.exe* | *wce.exe* | *vnc.exe* |
    | *ipconfig.exe* | *systeminfo.exe* | *winscanx.exe* | *teamviewer.exe* |
    | *netsh.exe* | *wget.exe* | *wscript.exe* | *nc.exe* |
    | *tasklist.exe* | *gpresult.exe* | *cscript.exe* | *ammyy.exe* |
    | *rar.exe* | *whoami.exe* | *robocopy.exe* | *csvde.exe* |
    | *wmic.exe* | *query.exe* | *certutil.exe* | *lazagne.exe* |

1.  *审查你的发现并评估需求。* 评估每个工具，确定哪些用户需要它，以及它如何、在哪里和何时使用。针对每个工具，进行风险评估，确定如果对手获得访问权限，可能带来的影响。记录如何限制工具的功能以增强安全性，同时在业务操作上做出可辩解的妥协——例如，禁用 Microsoft Word 和 Excel 中的宏。

1.  *实施限制*。限制不必要的风险工具的可用性、访问权限和授权。记录任何例外情况，并计划每季度重新审视这些例外，要求用户请求续期批准。你甚至可以设置临时访问权限，在一段时间后自动撤销或删除工具。建立已批准工具的白名单，以便任何未识别或未授权的工具会自动被阻止传送到你的系统中。考虑将所有系统上的 USB、媒体、Thunderbolt、FireWire、控制台和外部端口物理锁定，解锁和使用这些端口需要书面批准。

## 推荐的安全控制和缓解措施

在相关的地方，建议中呈现了适用的 NIST 800-53 标准中的安全控制。每一项都应根据工具的概念进行评估。

1.  评估你执行“最小功能原则”的技术能力，通过禁用、删除和限制访问环境中不必要的软件和系统功能。[CM-7: 最小功能]

1.  定期审查每个角色和系统使用的功能、工具和软件，确定它们是否必要，或者是否可以移除或禁用。建立一个系统来注册、跟踪和管理这些工具。[CM-7: 最小功能 | (1) 定期审查 | (3) 注册合规]

1.  在记录用户或系统可能使用的每个工具后，限制用户将这些工具用于其在组织中角色之外的功能。[CM-7: 最小功能 | (2) 防止程序执行]

1.  实施软件、应用程序和其他工具的白名单或黑名单（或两者）。[CM-7: 最小功能 | (4) 未授权软件/黑名单 | (5) 授权软件/白名单]

1.  对硬件和软件工具实施物理和网络边界限制。例如，将敏感工具限制在隔离的管理网络文件服务器中或便携式锁定媒体设备中，只有在需要时并结合 JEA/JIT 访问控制时才能访问。[MA-3: 维护工具 | (1) 检查工具 | (3) 防止未授权移除 | (4) 限制工具使用；SC-7: 边界保护 | (13) 安全工具/机制/支持组件的隔离]

1.  评估所有已安装的软件，以确定哪些导入、API、功能调用和钩子是由已知安全的应用程序使用的。考虑使用恶意代码保护来阻止任何使用这些实现或其他正常软件不使用的工具。考虑你的选项，以限制、禁用和移除不用于业务操作的操作系统功能、模块、组件和库。[SA-15: 开发过程、标准和工具 | (5) 攻击面；SI-3: 恶意代码保护 | (10) 恶意代码分析]

## 简报

在本章中，你了解了工具——它们有多强大以及为什么保持工具的安全性如此重要。你学习了“依赖本地资源”的概念，以及如何使系统既具备防御能力又能正常运行的复杂性。你可能还开始思考工具与恶意软件之间的区别，以及如何编写程序来识别这两者之间的差异。毒箭的思维训练挑战了你，要智胜入侵你所控制环境的敌人。

在接下来的章节中，我们将讨论忍者侦察员使用的不同技巧——嗅觉、视觉和听觉——以及我们从中能学到什么，特别是如何将不同类型的数字传感器应用于我们的网络环境中。
