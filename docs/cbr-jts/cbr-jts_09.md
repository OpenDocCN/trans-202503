# 第九章：传感器

无论是白天还是黑夜，都应派遣侦察员进行远距离观察。

> 即使忍者没有出色的体能，记住最重要的是具备敏锐的观察力*。*
> 
> —吉守百首 #11

除了在城门和哨位驻守守卫，*万川集海*还建议通过在道路、路径和其他进攻路线的隐秘位置安置侦察员来防守城堡。防守指挥官应在城堡的外围不等距离地安排侦察员。^(1) 这些侦察员履行了三种角色之一：

+   嗅觉侦察员（*kagi*）

+   听觉侦察员（*monogiki*）

+   外部步兵侦察员（*togiki*）

嗅觉和听觉侦察员，使用训练有素的狗和狗主，隐藏在遮蔽的观察岗位——他们无法看到外面，但敌人也无法看到里面。侦察员集中精力嗅觉或聆听渗透迹象。这些技术在夜间尤为有效，因为嗅觉和听觉侦察员无需光线即可工作。^(2)

外部步兵侦察员通过在敌方领土的边缘进行扫荡，隐藏在敌人的地面上并监视向自己营地的移动，或通过绊线、噪音甚至身体接触来发现入侵者。*万川集海*称*外部步兵侦察员*（*togiki*）应该是忍者，因为他们必须精通隐匿和观察，具备超凡的直觉，知道敌人会从哪个方向攻击，并能成功发现并对抗敌方忍者。^(3)

除了人类（和动物）侦察员，*万川集海*建议使用主动和被动侦测技术来识别敌方渗透者。主动方面，忍者可能会将*猿火*（猴火，或“绳上的火”^(4))放入或横越黑暗区域，如护城河、壕沟或城墙底部，迅速且动态地照亮这些地方，这是固定灯笼无法做到的。被动方面，忍者会建立侦测系统，例如，通过将细沙填满一个宽但浅的壕沟，然后将沙子耙成复杂的图案。如果敌人绕过外部防御，他们会留下脚印，警告守卫城堡已经被突破。沙中的脚印还可能告诉敏锐的忍者敌人来自哪个方向，以及他们是否以相同的方式离开——这些都是有价值的情报，有助于消除眼前的威胁并加强未来的防御。^(5)

在本章中，我们将探讨网络中常用的不同类型的安全传感器，并比较现代部署与忍者历史上使用传感器的方式。我们将重点讨论传感器的布置以及传感器对策技术，借鉴忍者的经验，提升我们的网络安全防御。我们还将提出基于古代侦察传感器的现代传感器。

## 使用传感器识别和检测威胁

在网络术语中，*传感器*一词涵盖了多种检测系统和仪器。最常见的传感器是安装在 tap、T 分裂、span 或镜像端口上的监控设备，它复制活动以供观察、记录和分析。在这种配置下，传感器会嗅探并捕捉原始数据包（PCAPs）在网络上传输，然后处理和分析这些数据包，以提醒安全人员注意可疑事件。传感器还可以“在线”部署，意味着数据包会通过一个可以延迟、阻止或修改数据包信息的设备，实际上是防止攻击，而不仅仅是发出警告。次级传感器，如 Wi-Fi 传感器，检测外部或其他未经授权的信号和连接，而物理安全传感器，如摄像头，监控对敏感数据中心、服务器机架和交换机机房的访问。从更广泛的角度来看，某些软件端点代理也充当传感器，因为它们会收集主机系统上的事件、动作和活动，并将其报告给指挥与控制（C2）系统，进行分析并在必要时发出警报。

组织通常会将传感器专门配置为检测某些类型的流量，例如，通过配置电子邮件网关安全设备来防范钓鱼攻击或垃圾邮件，通过入侵防御/检测系统来检测网络攻击，通过防火墙来防止未经授权的 IP 和端口访问，通过代理来防范可疑网站，以及通过数据丢失防护系统来避免数据泄露。基于传感器的网络安全设备通常安装在网络的主要出口点，通常位于非军事区（DMZ）。因为标准做法是将传感器安装在尽可能靠近网络的地方，以最大化它们所监控的流量，所以如果攻击者躲避网关处的传感器或绕过主要出口进入网络，他们就有可能在没有安全传感器检查的情况下在网络内自由行动。

尽管存在这一安全隐患，但大多数组织不太可能大幅增加其系统中传感器的数量，因为购买大量额外的传感器—以及与此相关的额外工作，如许可、安装、更新、维护和监控—在财务上是不可行的。不幸的是，许多组织仅仅认为如果主要出口传感器未能发现威胁，那么增加更多相同类型的传感器也不会更有效。这种判断错误使他们的系统面临风险。

## 更好的传感器

传感器的一个主要问题是它们几乎总是需要一个人来监控，并根据它们传递的信息采取行动。这个问题因安全传感器和可用分析平台的局限性而更加复杂。可以这样理解现代安全传感器：一座建筑内散布着许多微型麦克风和摄像头，但这些麦克风和摄像头被困在小小的吸管里——这些吸管使得它们的捕捉范围非常狭窄。现在，想象一下，试图在只能透过一根吸管看时拼凑一个正在发生的入侵事件。不仅如此，每根吸管还在不断积累成千上万小时的数据，需要存储、处理和分析。这种令人沮丧的情况通常通过使用签名、算法或机器学习来缓解——这些工具有助于识别异常和恶意活动。然而，这些自动化系统并不完美。它们经常产生误报，或者产生如此大量的合法警报，以至于感觉与没有传感器没有什么区别。为了解决这些问题，我们可以借鉴忍者的策略：我们可以识别敌人可能采取的路径，并沿这些路径隐藏多种传感器，提前警告攻击的发生。在考虑提升贵公司传感器的性能时，请参考以下建议：

1.  *建模你的网络并识别弱点*。创建一个网络图和信息流模型，描述你的环境——包括每个系统及其用途、系统如何连接、信息进入和离开网络的方式、接收到的信息类型、哪些传感器（如果有的话）检查信息，以及出口点。识别缺少传感器的区域和你认为已经得到适当监控的地方。预测威胁行为者将尝试渗透你网络的位置。请记住，创建一份全面的地图可能需要几个月，并且需要全公司各个部门的帮助。即使你的最终地图不完美，但即便是一个不完全的地图也总比没有地图要好。

1.  *进行红队和渗透测试*。聘请一个红队来尝试渗透你的网络。考虑采用“紫队”方法进行此项活动，在这种方式下，网络防御者（蓝队）与红队在同一个房间内实时观察，并可以暂停演习以提出问题。在攻击前、攻击中和攻击后查询安全传感器，看看它们是否检测到或报告了任何内容。这些信息应该非常有启发性。允许你的蓝队考虑不同传感器布置如何能更快、更准确地检测到红队的行为。讨论架构防御变化、传感器调优及测试中提出的其他解决方案。

1.  *检测并阻止加密流量。* 阻止所有无法被传感器拦截和检查的加密流量。同时，采取适当措施，去除机器使用未经授权加密的能力。让红队测试你检测加密流量攻击的能力。大多数传感器无法检查加密流量；因此，许多组织允许使用无法通过根证书破解的非对称加密，如椭圆曲线 Diffie-Hellman（ECDH）。允许未经破译的加密流量离开组织而不经过 DLP 检查，便像城堡守卫审查每一位素面朝天的人进出城门，却允许任何戴着面具的人毫无阻碍地通过。

1.  *开发“嗅探”和“监听”传感器。* 探索创造能够秘密检测某些类型威胁活动的传感器的机会。例如，配置一个外部物理传感器，监测系统的 CPU 活动或电力消耗，并根据性能是否与已知命令或登录用户活动相关联，来检测未经授权的访问或使用——例如被加密货币挖矿者利用。

1.  *实现被动传感器。* 在永远不应使用的交换机和服务器上建立被动接口。同时，配置传感器在接口被激活时本地检测并发出警报，表明网络中可能存在对手。就像一个填满沙子的浅沟槽一样，这类系统可以用来检测网络设备间不该发生的横向移动。

1.  *安装* togiki *传感器。* 将面向内部的传感器放置在网络外部，以检测渗透。例如，在 ISP 的配合下，将传感器配置在网络边界外，以监控其他传感器可能无法检测到的进出流量。将传感器放置在设备的 T 型分接点上，并与主机传感器配合使用，然后通过差异对比设备，确定两个传感器是否报告相同的活动。这种方法有助于识别受损的终端传感器和网络接口驱动程序。

## 推荐的安全控制和缓解措施

在相关情况下，推荐措施会结合 NIST 800-53 标准中的适用安全控制进行呈现。每一项建议都应从传感器的角度进行评估。

1.  实施数据包嗅探器、完整网络 PCAP 和其他自动化传感器，以支持事件处理、维护和信息流控制。[AC-4: 信息流控制 | (14) 安全策略过滤器约束；IR-4: 事件处理；MA-3: 维护工具]

1.  为了保护物理访问并检测篡改行为，在电缆夹克锁上安装传感器，安装监控数据中心和服务器访问的摄像头，安装水漏传感器以检测可能威胁电气设备的泄漏，以及在通信线路上安装窃听传感器。[PE-4: 传输访问控制；PE-6: 物理访问监控；PE-15: 水灾保护]

1.  为员工提供意识培训计划——包括非 IT 员工——使他们能够作为人类传感器检测威胁活动。为员工提供一种清晰、简便且易于访问的方式来报告可疑活动。[PM-16: 威胁意识计划]

1.  拦截加密通信，并允许你的传感器对未加密的数据包进行深度检查。[AC-4: 信息流强制执行；(4) 内容检查加密信息；SC-8: 传输机密性和完整性]

1.  实施能够分析数据包并采取防范措施（如阻止或过滤）的传感器。[SC-5: 拒绝服务保护；SC-7: 边界保护 | (10) 防止外泄 | (17) 自动执行协议格式]

1.  禁止在非感应系统上激活滥用传感器，以防止未经授权访问的对手获取敏感信息。[SC-42: 传感器能力与数据]

1.  与你的 ISP 合作，将受信任的互联网连接（TIC）传感器放置在你的网络边界外。[AC-17: 远程访问 | (3) 管理访问控制点]

1.  记录所有内部系统连接；它们的接口；它们处理、存储和传输的信息；以及系统之间的传感器放置。[CA-9: 内部系统连接]

1.  进行渗透测试和红队演习，以测试和验证传感器的放置和能力。[CA-8: 渗透测试；RA-6: 技术监视反制措施调查]

## 简报

在本章中，我们讨论了古代日本用于检测敌方忍者的嗅觉、听觉和外部感知侦察。我们还了解了城堡守卫部署的主动和被动传感器，以捕捉入侵者。然后，我们讨论了今天使用的各种安全传感器——帮助防御者了解周围网络中发生的事情的传感器。我们涵盖了有关传感器的一些后勤问题，如传感器放置、误报和传感器管理。最后，我们谈到了如何应用古代忍者技术来识别网络系统中的入侵者。

接下来，我们将讨论忍者用于绕过城堡防御的不同类型的桥梁和梯子——这一概念在传感器方面具有一定的重要性。例如，假设你的城堡被护城河保护，而你已经在吊桥上放置了所有的传感器。如果敌方忍者能够悄无声息地架起一座不使用吊桥的桥梁，他们也有效地绕过了你的传感器——使其变得毫无作用。我们将探讨这个桥接概念在网络安全中几乎是完全相同的，以及解决这个问题的难度。
