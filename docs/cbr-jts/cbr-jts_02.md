# 第二章：特别守卫

即使是拥有强大防御工事的城堡，也应当加以守卫，特别要注意凹陷的角落。

> 忍者在潜入城堡或营地时应牢记自然防御严密且难以突破的方向、树林和盲点。
> 
> —吉盛百首 #10

忍者在历史上是非常熟练的渗透者。古代卷轴描述了如何迅速识别并残酷地利用敌人防御工事中的薄弱点。卷轴还强调，忍者应当运用更高层次的思维，在建设自己的防御时创造性地应用他们的知识。*万川集海*建议负责守卫营地或城堡的指挥官要特别注意识别、检查并严密守护那些忍者最有可能尝试突破的区域，例如城堡石墙的凹陷角落、垃圾处理区、水管、以及附近的树林或灌木丛。^(1)

## 理解攻击向量

将城堡的墙壁视为*攻击面*，而城堡墙壁中的薄弱点（例如，水管或墙中不合理摆放的石块，这些石块提供了攻击者的立足点）则为*攻击向量*。*攻击面*指的是敌方有机会攻击的所有软件、网络和系统。攻击面中的任何一点都可能成为攻击向量，或者说攻击者用来获取访问权限的手段。在网络安全中，通常建议缩小攻击面。也就是说，虽然缩小城堡的面积可以减少需要防守的攻击面，但它并不能减轻敌人可能造成的损害，也无法防止任何给定的攻击向量被利用。尽管如此，减少攻击面还是能让守卫目标变得更容易。

*万川集海*关于隐秘渗透的卷册列出了一些本意良好的防御技巧、武器和思维模式，这些实际上可能让营地暴露于风险之中。它敦促指挥官考虑他们环境中的一切是否可能被敌人用来对付自己。例如，卷轴指示渗透者寻找*忍者返*，即敌人围绕营地设置的刺来阻止潜在攻击者。^(2) 由于防守者将这些刺放置在他们认为脆弱的地方，因此这些刺的存在告诉敌方忍者防御薄弱之处；防守者实际上是在公开自己的脆弱。忍者知道他们可以移除这些刺——这通常很容易做到，因为这些刺几乎总是作为事后补充放置的——并通过目标周围最薄弱的地方突破防线。^(3)

一个典型的“事后加固”安全例子可以在微软 Windows 的 PowerShell 中找到。每个新版本的 PowerShell 在.NET 框架之上增加的众多安全功能并没有解决该产品的核心缺陷，事实上，它们使得威胁行为者能够创建一整套工具和武器，用以渗透支持 PowerShell 的系统。这是任何希望更深入研究*忍返*的安全研究人员的一个极好案例。

日本仍然屹立的古老城堡通常不会装饰尖刺，但它们确实往往有太小的水管，使人无法通过，周围的植被被清除，外墙也没有凹陷的角落——所有这些都表明，皇帝们从忍者那里获得灵感，随着时间的推移，采取了措施消除这些弱点。然而，虽然消除弱点是理想的，因为这样就不需要看守，但这并非总是可能的。

在本章中，我们将讨论守卫的概念及其在网络安全五大职能中的拟议位置。然后，我们将讨论如何通过威胁建模识别可能需要守卫的脆弱区域。

## 守卫的概念

*守卫*是通过观察环境、发现威胁并采取预防措施来对资产进行保护控制的行为。例如，城堡的领主发现城堡墙上的一个相当大的排水管是一个弱点。领主保留了这个管道，因为它在允许水排出方面发挥着重要作用，但要求有卫兵站在附近，防止攻击者利用这个管道作为进入手段。

通常，组织倾向于让网络安全人员对弱系统、网络盲点或需要特别小心守卫的脆弱攻击向量一无所知。一些组织认为发现网络安全缺陷完全是网络安全人员的责任。许多利益相关者根本没有首先识别出这些攻击向量，或者如果没有现成的商业解决方案，或者没有广泛接受的防范措施能够轻松应用，他们就简单忽视这些弱点，希望它们不会被利用。

在某些情况下，管理层指示安保人员*不要*进行基本的日志记录、扫描或对遗留系统进行修补，因为担心触碰这些系统会干扰业务运营。在更具政治性的组织中，除非通过正式的文档过程确认，否则常常不会将威胁视为有效的关注点。试想一下，如果发现一座城堡缺少西墙，你将这一明显的漏洞报告给国王，但国王却因卫兵在官方报告中没有提到此事而忽视你的担忧。

## 在网络安全框架中的守卫

*美国国家标准与技术研究院（NIST）网络安全框架*^(4)旨在防止这些常见错误，并通过五个核心的网络安全功能来提高组织对网络威胁的抵御能力：识别、保护、检测、响应和恢复。这些功能通过使用常见的信息安全工具和流程，帮助识别网络和系统中的漏洞。

例如，大多数组织通过对其网络中的系统进行漏洞扫描或应用扫描来开始识别弱点——这就是*识别*功能。有效且可靠的扫描可以识别出明显的安全问题，如未打补丁的软件、具有空白密码的活跃账户、默认的工厂凭据、未加参数化的输入，以及对互联网开放的 SSH 端口。接下来是*保护*功能。在发现一个不安全的系统后，扫描工具记录问题，然后安全人员通过修补、配置更改或长期的架构、安全系统或软件实施来修复或缓解漏洞。

如果安全人员无法保护已识别为攻击通道的系统，我认为他们应该通过人工控制来*守卫*该系统。然而，NIST 框架中缺少守卫功能。相反，我们直接进入*检测*功能：安全人员通过监控和调查异常事件来试图发现对手。一旦安全人员发现渗透，他们才会执行*响应*功能，通过遏制威胁、消除威胁并报告来进行应对。

最后是*恢复*功能：将系统和数据恢复到可操作状态，并提高它们抵御未来攻击的能力。

尽管对强大的安全配置至关重要，这些保障措施仍然是预防性、保护性或响应性的功能。网络安全行业很少将“守卫”概念应用于信息系统，因为让人工防御者手动检查和批准每一封邮件、网页、文件或数据包的进出，就像门卫监控人或包裹进入大楼一样，是不切实际的。

例如，拥有 1GB 网络连接的计算机每秒可以处理超过 100,000 个数据包，这远远超过任何人类能够检查的数量。与其依赖人工监视，防御者通常会大量依赖自动化的安全控制，或者干脆接受/忽视风险作为业务的一部分。然而，在现代数字网络中，防守仍然是可行的，前提是防守仅仅被应用于那些需要特别关注和小心的区域，比如最可能的攻击通道。这就是为什么进行威胁建模以识别这些区域对你的组织会非常有帮助的原因。

## 威胁建模

网络安全中最接近守卫的行动是*威胁狩猎*，即积极地在日志、取证数据和其他可观察的证据中寻找潜在的入侵迹象。很少有组织进行威胁狩猎，即使在进行的组织中，猎人的工作也是发现，而不是守卫。

然而，网络防御者必须超越传统框架，持续地设想网络和信息系统可能遭受的攻击方式，并实施必要的防御措施。为此，防御者可以使用威胁建模来实施信息流控制，并设计防护措施以应对威胁，而不仅仅是对其做出反应。

威胁建模通常只有在网络安全成熟的组织中进行，它涉及到记录一个*数据流图（DFD）*，该图描述了系统内部数据和过程的流动。数据流图通常以流程图的形式记录，但也可以通过详细的网络图来粗略表示。数据流图可以作为对攻击面进行结构化分析的工具，帮助你在已记录的信息系统参数内思考攻击场景。它不需要漏洞扫描、红队验证攻击场景，或合规框架的验证，组织也不必等到发生安全事件后才证明威胁模型，从而采取措施防范漏洞。

了解现代网络安全中类似于“城堡石墙的凹角、垃圾处理区、水管以及附近的树林或灌木丛”的环境，可以帮助你识别可能需要特别防护的攻击路径。

例如，作为他们夜间职责的一部分，保安会拉动办公室每个门把手，以确保门是锁着的。如果发现某扇门未锁，他们会将门锁上，确保钥匙安全，并提交一份安全事件工单。

后来发现，安全事件发生是因为门钥匙被复制或盗窃，因此该组织在门上增加了第二级认证控制（例如数字键盘或徽章读取器），更换了锁芯，并发放了新钥匙。这些新的预防性安全控制措施满足了合规审计员的要求，未锁门的报告工单也已关闭。首席信息安全官（CISO）甚至雇佣了红队，对新的门锁机制进行了小范围的物理渗透测试，红队确认由于增强的安全措施，他们未能获得访问权限。

然而，一旦我们进行威胁建模练习，就会发现有可能将可移动的天花板瓷砖推开，然后翻越办公室墙壁，完全绕过新的安全措施。为了解决这个问题，我们可以增加控制措施，比如在天花板爬行空间安装安全摄像头或运动探测器，或者安装坚固的、防隧道化的天花板和地板。甚至可以雇佣并培训守卫，寻找被扰动的天花板瓷砖、地板上的天花板颗粒或墙上的脚印。针对这一威胁的防范需要守卫在房间内驻守，或者站在天花板爬行空间内，拥有保护房间免受入侵者侵害的权力和工具。

实施这些对策的可行性较低——你可能连提出这一建议都可能被经理嘲笑。很容易理解为什么组织更倾向于接受或忽视某些威胁，而不是尝试抵御它们，这也可能是为什么 NIST 网络安全框架没有包括守卫功能。然而，如果通过详细的威胁建模进行深思熟虑，并以创造性和谨慎的方式加以实施，这种以守卫为中心的思维方式可以加强信息系统和网络的安全性。

一个适合实现守卫功能的场景示例是在*跳跃盒子*中。跳跃盒子是跨越两个或多个网络边界的系统，允许管理员从一个网络远程登录到跳跃盒子，并“跳跃”到另一个网络以访问它。传统的网络安全框架建议通过修补所有已知漏洞、使用各种防火墙规则限制访问、并监控审计日志中异常事件（如未授权访问）来强化跳跃盒子系统。然而，这些技术控制措施常常受到攻击或被绕过。另一方面，守卫可以物理断开内部网络电缆与其他网络的连接，并在与管理员确认他们获得批准后，直接连接该网络以执行远程命令。守卫还可以实时监控机器上的操作，并在观察到恶意或未授权行为时随时强制终止会话。以这种方式实现守卫功能可能意味着雇佣一个人类守卫坐在数据中心，保护这些敏感系统的物理访问和远程访问。

## 使用威胁建模来发现潜在的攻击路径

识别攻击向量的基本步骤是遵循威胁建模的指导方针，从创建 DFD 开始。一旦从 DFD 中识别出潜在的攻击向量，忍者卷轴建议检查这些向量，确定可以实施哪些技术安全控制来保护它们。然后，作为最后的手段，使用防护措施来保护这些区域。你可以使用前一章创建的网络地图来帮助创建 DFD，或者将其作为粗略的替代方案。

1.  *建模你的信息系统。* 与组织的网络、安全、开发、业务和其他 IT 系统的负责人和专家合作，创建一个准确的数据流图（DFD）。它不需要使用统一建模语言（UML）或其他高级概念——它只需要准确表示你的系统及其中的信息。请注意，大型复杂系统可能需要一个团队超过六个月的时间来绘制图表。

1.  *STRIDE 与防护。* STRIDE 是微软开发的威胁建模方法论，用于描述信息系统中可能出现的问题。该缩写来自攻击者可能违反系统的六个属性：

    | **S**身份伪造 | = | 身份验证 |
    | --- | --- | --- |
    | **T**篡改数据 | = | 完整性 |
    | **R**否认/可否认性 | = | 不可否认性 |
    | **I**信息泄露 | = | 保密性 |
    | **D**服务拒绝 | = | 可用性 |
    | **E**权限提升 | = | 授权 |

    使用 STRIDE 时，你将回顾你的数据流图（DFD），在每一个数据输入、数据处理、数据输出或其他数据流/规则的点上，假设对手可能如何威胁这些环节。例如，如果系统需要通过指纹验证用户身份才允许访问，你可能会考虑对手如何伪造指纹来冒充其他用户。同样，你可以思考他们如何篡改指纹数据库，将自己的指纹插入其中，或者探索攻击者使指纹扫描器瘫痪，从而通过更弱的身份验证过程获得未授权访问的场景。

    在学习了这个框架之后，你可以利用它挑战任何不准确描述你系统的假想威胁模型，或是没有描述可行威胁如何影响特定组件、表面或通道的场景。这可能需要邀请技术领域的专家参加威胁建模会议。

    假设，例如，一个组织的威胁建模会议产生了以下场景：“恶意软件威胁破坏了内部数据库的完整性。”

    该威胁没有得到正确建模。除其他关键信息外，场景没有描述恶意软件是如何被传输和安装的。也没有描述恶意软件如何破坏数据库的完整性：它是加密、删除还是损坏数据？它没有描述哪些攻击途径允许威胁影响系统，也没有考虑当前的信息流和控制措施，也没有提供现实的对策。例如，如果我们确定最可能的方式是通过恶意 USB 驱动器感染内部业务数据库，那么安全部门可能需要制定政策，详细说明员工如何使用 USB 驱动器，或者安装摄像头以监控 USB 端口的访问。组织可能会决定授予安全部门启用或禁用 USB 设备的权限，指定哪些驱动器可以与 USB 接口连接，控制 USB 端口的信息流动和方向，要求在授权访问请求者之前检查 USB 驱动器上的文件，通过硬件或软件锁控制访问，甚至将 USB 端口用热熔胶封闭。通过彻底的威胁建模得出的这些措施，能让安全人员针对特定威胁进行特别的防范，而不是仅仅接受风险或局限于保护和检测功能。

1.  *不要宣传附加的安全措施*。威胁建模是一个迭代的、无限的过程，旨在评估新威胁并制定防护对策。在你急于保护系统的过程中，避免使用*忍者返击*式的安全控制——这些防御措施可能适得其反，引起攻击者对你系统漏洞的关注。由于时间、资源或操作限制，你可能只采取了半途而废的措施，这些措施可能会被有动机的、技术高超的威胁行为者轻易突破。例如，USB 端口上的热熔胶可以通过异丙醇去除。在可能的情况下，评估一种以安全为先的防御方法的可行性。

    在 USB 威胁的示例中，USB 与操作系统内核下方的硬件抽象层（HAL）进行交互。它无法通过软件和政策控制完全保护或缓解，因为这些控制措施存在于内核之上，并且可能被绕过。因此，更完整的解决方案可能是实施一种主板和机箱配置，使得 USB 端口根本不存在。相比之下，USB 端口上的热熔胶会向有动机的威胁行为者展示你没有正确处理 USB 的安全问题，如果他们能把胶粘取下，这将很可能成为他们成功攻击的途径——就像古代忍者拔出钉在管道和墙壁上的尖刺一样。

## 推荐的安全控制和缓解措施

在相关情况下，每个建议都将附带一个适用的来自 NIST 800-53 标准的安全控制，并应通过特殊防护的角度进行评估。

1.  审查审计员、红队评估、漏洞扫描和事件报告的结果，以找出在环境中无法轻易修补或通过控制措施缓解的漏洞（即那些需要特殊防护的漏洞）。[CA-2: 安全评估；CA-8: 渗透测试；IR-6: 事件报告 | (2) 与事件相关的漏洞；RA-5: 漏洞扫描]

1.  对你的环境进行威胁建模，以识别漏洞。然后确定哪些漏洞可以通过设计将其从环境中消除。探索防护安全功能的概念，并将这些控制措施应用于那些无法轻易消除的威胁。[SA-8: 安全工程原则；SA-14: 关键性分析；SA-15: 开发过程、标准和工具 | (4) 威胁建模/漏洞分析；SA-17: 开发人员安全架构和设计]

1.  为了威慑、保护并确保对威胁的快速响应，雇佣实时安全人员作为防护员，并将其整合到业务运营的易受攻击区域中。[IR-10: 集成信息安全分析团队]

## 汇报

本章帮助你思考网络环境中对手可能会针对的渗透目标。你还了解了通过信息系统和流程之间的直接人工互动进行防护的概念。你可能已经利用了上一章的网络图，或者创建了自己的数据流图（DFD）来表示你的环境，以识别可能的攻击向量和可以通过防护措施缓解的潜在 STRIDE 威胁。

在下一章，我们将探讨古代忍者使用的“排外”安全概念，这可能会阻止对手在你的环境中找到任何共同点或立足点，甚至无法开始其攻击向量过程。
