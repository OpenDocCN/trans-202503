# 第七章：代码审查

大多数团队要求在合并代码之前进行审查。高质量代码审查的文化帮助各个经验层级的工程师成长，并促进对代码库的共同理解。糟糕的代码审查文化会抑制创新，减缓开发进度，并导致怨恨。

团队会期望你参与代码审查——既要进行审查，也要接受审查。代码审查可能会引发冒充者综合症和达克效应——这些现象我们在第二章讨论过。审查焦虑和过度自信是自然的，但当你掌握了正确的上下文和技能后，可以克服它们。

本章解释了为什么代码审查很有用，以及如何成为一名优秀的审查者和被审查者。我们将展示如何让你的代码接受审查，以及如何回应反馈。然后，我们将转换角色，展示如何成为一名优秀的审查者。

## 为什么要审查代码？

一次执行良好的代码审查是非常宝贵的。它有明显的表面效益——审查可以捕捉到错误并保持代码的清晰——但代码审查的价值超出了人类代替自动化测试和代码检查工具的功能。良好的审查可以作为一种教学工具，传播意识，记录实现决策，并为安全和合规提供更改记录。

代码审查是团队的教学和学习工具。你可以从自己代码审查的反馈中学习。审查者会指出你可能没有注意到的有用库和编码实践。你还可以通过阅读更资深队友的代码审查请求来学习代码库，并学习如何编写生产级代码（关于编写生产代码的更多内容，请参见第四章）。代码审查也是了解团队编码风格的一个简单方式。

审查代码库的更改确保了不仅仅一个人熟悉每一行生产代码。对代码库的共同理解有助于团队更加有凝聚力地发展代码。让别人知道你在改变什么，意味着在问题发生时，团队不只依赖你一个人。如果出现问题，值班工程师将能够获得有关代码更改的更多上下文。这种共享知识意味着你可以放心地休假，而不必担心支持你的代码。

审查评论的记录也作为文档，解释为什么代码是以这种方式编写的。代码为什么要以某种方式编写并不总是显而易见的。代码审查充当了实现决策的档案。拥有过去的代码审查记录可以为开发人员提供书面的历史资料。

审查可能甚至是出于安全和合规目的而要求的。安全和合规政策通常会规定代码审查作为防止单个开发人员恶意修改代码库的手段。

这些代码评审的好处仅在所有参与者都能在“高信任”环境中工作时才有效，在这种环境中，评审者有意提供有价值的反馈，而被评审者也愿意接受意见。执行不当的评审会变成有害的障碍。草率的反馈没有价值，反而会拖慢开发者的速度。缓慢的反馈周期可能导致代码更改停滞不前。如果没有正确的文化，开发者可能会陷入恶性争执，这可能会破坏团队。评审不是一个证明你有多聪明的机会，也不是一个走过场的官僚障碍。

## 获取你的代码评审

代码更改被准备、提交、评审，最终批准并合并。开发者首先准备好代码以进行提交。一旦代码准备就绪，他们提交更改并创建“评审请求”，然后评审者会收到通知。如果有反馈，就会进行反复讨论并做出更改。评审通过后，代码会被批准并合并到代码库中。

### 准备你的评审

精心准备的评审请求使开发者更容易理解你正在做什么并提供建设性反馈。请遵循第三章中提供的版本控制系统（VCS）指导：保持单个代码更改的小规模，将功能和重构工作分成不同的评审，并编写描述性提交信息。包括注释和测试。不要对提交的代码过于依赖；在评审过程中，它可能会发生变化，有时甚至是显著的变化。

包括标题和描述，添加评审人，并链接到你的评审请求所解决的问题。标题和描述不同于提交信息。请求的标题和描述应包括关于如何测试变更的背景、其他资源的链接以及未解决问题或实现细节的说明。以下是一个示例：

```
Reviewers: agupta, csmith, jshu, ui-ux
Title: [UI-1343] Fix missing link in menu header
Description:
# Summary
The main menu header is missing a link for the About Us menu option. Clicking the menu button does nothing right now. Fixed by adding a proper href.
Added a Selenium test to verify the change.
# Checklist
This PR:
- [x] Adds new tests
- [ ] Modifies public-facing APIs
- [ ] Includes a design document
```

这个请求示例遵循了多个最佳实践。单个评审者和整个 UI/UX 团队都被添加到评审中。标题引用了正在修复的问题（UI-1343）。使用标准格式化约定来引用问题，可以使集成自动将问题跟踪器与代码评审关联起来。这在后续引用旧问题时非常有用。

评审中的描述也填写了与代码库一起提供的代码评审模板。某些代码库有描述模板，为评审者提供有关更改的重要背景。例如，修改公共接口的更改可能需要额外的审查。

### 通过草稿评审降低风险

许多开发者通过编写代码来思考。草稿更改是思考并提出更改的一种好方法，它不需要投入太多时间来编写测试、完善代码和添加文档。你可以通过提交*草稿审查*来检查你所做的事情：这是一种非正式的审查请求，旨在从队友那里快速获得反馈，从而显著降低你走错方向的风险。

为了避免混淆，明确代码审查是否为草稿或进行中的工作（WIP）。许多团队会对草稿有约定；通常“DRAFT”或“WIP”会加在代码审查标题前。一些代码审查平台对这个有所支持；例如，GitHub 有“草稿拉取请求”。一旦你的草稿看起来在正确的轨道上，你可以通过完成实现、测试和文档，并进行优化，将其从“草稿”状态中转出。同样，明确你的代码何时准备好进行非草稿审查，然后按照前面一节所述准备审查请求。

### 不要提交审查以触发测试

大型项目通常伴随着复杂的测试工具。作为新开发者，弄清楚如何运行所有相关测试可能会很困难。一些开发者通过提交代码审查来触发持续集成（CI）系统来绕过这个问题。这是一个不好的做法。

提交代码审查作为触发测试执行的方式是浪费的。你的审查会填满测试队列，这将阻塞那些在合并前确实需要运行测试的审查。你的队友可能会误以为你的审查请求是他们应该查看的内容。持续集成（CI）将运行完整的测试套件，而你可能只需要运行与你更改相关的测试。

投入时间学习如何在本地运行你的测试。调试失败的测试在本地比在 CI 环境中更容易；你无法在远程机器上附加调试器或轻松获取调试信息。设置你的本地测试环境并学习如何仅执行你关心的测试。让你的编码和测试周期变得更快，这样你就能立刻知道你的更改是否破坏了什么。虽然这是前期的成本，但从长远来看，它会节省你时间（而且对你的队友更友好）。

### 进行大规模代码更改的走查

在进行大规模更改时，进行代码走查。走查是面对面的会议，开发者共享屏幕并带领队友了解正在进行的更改。走查是激发想法和让团队熟悉更改的好方法。

提前传阅相关的设计文档和代码，并要求队友在演示会议前查看。给他们足够的时间——不要安排在一个小时后再进行演示。

在进行代码讲解时，首先介绍一下变更的背景。可能需要快速浏览一下设计文档。接着，分享你的屏幕，在你讲解的同时，导航到你 IDE 中的代码。讲解最好的方式是从头开始，按代码的执行流程进行逐步演示——包括页面加载、API 调用或应用启动，一直到执行结束。解释任何新模型或抽象的主要概念，它们的使用方式以及它们如何融入整体应用中。

不要试图让你的团队成员在讲解过程中对代码进行实际的审查。与会者应该把评论留到正式审查时再提出。讲解的目的是帮助团队理解为什么提出这个变更，并为他们提供一个良好的思维模型，帮助他们自己详细地进行代码审查。

### 不要执着

接收到关于代码的批评意见可能会让人感到不适。保持一定的情感距离——审查的是代码，而不是你，甚至这并不完全是你的代码；未来代码将属于整个团队。收到很多建议并不意味着你通过了测试失败，而是审阅者正在与代码互动，并思考如何改进它。如果你是团队中经验较少的开发人员，收到大量评论是完全正常的。

审阅者可能会要求做一些看起来不重要或者可以稍后处理的修改，他们可能有不同的优先级和时间安排。尽量保持开放的心态，理解他们的出发点。要接纳反馈，并且做好根据反馈修改代码的准备。

### 练习共情，但不要容忍粗鲁

每个人的沟通方式不同，但粗鲁行为是不容忍的。记住，一个人的“简洁明了”可能是另一个人的“生硬和粗鲁”。给予审阅者一些宽容，但如果他们的评论偏离主题或显得粗鲁，一定要让他们知道。如果讨论拖延或让你感觉“不对劲”，面对面的讨论有助于澄清问题并找到解决方案。如果你感到不舒服，可以和你的经理沟通。

如果你不同意某个建议，尝试解决这种分歧。首先审视自己的反应。你是本能地在保护自己的代码，因为它是你写的吗？还是因为你认为你的方式确实更好？清晰地解释你的观点。如果你仍然无法达成一致，询问你的经理下一步应该怎么做。团队在处理代码审查冲突时的方式不同；有些团队倾向于听从提交者的意见，有些则听从技术负责人，还有些团队则依赖小组中的多数意见。遵循团队的惯例。

### 积极主动

不要害怕请求别人审查你的代码。审查者通常会被大量的代码审查和工单通知轰炸，因此在高效项目中，审查可能会被遗漏。如果你没有得到反馈，跟团队沟通一下（但不要过于强迫）。当你收到评论时，要及时回应。你不希望你的代码审查拖延好几周。每个人的记忆都会衰退；你回应得越快，得到的反馈也会越快。

在收到批准后及时合并变更。让代码审查悬而未决是不礼貌的。其他人可能在等待你的变更，或者在你合并后可能想更改代码。如果你等待太久，你的代码可能需要重新基准并修复。在极端情况下，重新基准可能会破坏代码的逻辑，从而需要进行另一次代码审查。

## 审查代码

优秀的审查者会将审查请求分成几个阶段。首先对请求进行分类，确定其紧急性和复杂性，并为审查变更预留时间。开始审查时，先阅读代码并提出问题，以理解变更的背景。然后，提供反馈并推动审查结论的达成。将此方法与一些最佳实践相结合，将大大提高你的审查质量。

### 分类审查请求

作为审查者的工作从你收到审查通知开始。首先对审查请求进行分类。一些变更是关键的，需要立即审查。然而，大多数变更则不那么紧急。如果紧急性不明确，可以询问提交者。变更的大小和复杂性也需要考虑。如果变更小且简单，快速审查有助于解除同事的阻碍。较大的变更则需要更多时间。

高效团队可能会有大量的代码审查。你不需要审查每一个变更。专注于那些你可以从中学习的变更，以及那些涉及你熟悉的代码的变更。

### 为审查预留时间

代码审查类似于运维工作（详见第九章）；它们的大小和频率具有一定的不确定性。每次收到审查请求时，不要放下你正在做的所有事情。如果不加以控制，审查中断可能会破坏你的生产力。

在日历中为代码审查预留时间。安排审查时间使你可以继续处理其他任务，因为你知道稍后会有专注的审查时间。这也能保持审查的高质量——你不会因为急于返回其他任务而感到压力。

大型审查可能需要额外的计划。如果你收到的审查需要一个小时或更长时间才能完成，创建一个问题来跟踪审查本身。与经理合作，在迭代规划会议中分配专门的时间（见第十二章关于敏捷开发的内容）。

### 理解变更

不要一开始就留下评论；先阅读并提出问题。如果审查者能真正花时间理解所提议的变更，代码审查会更有价值。力求理解为什么要做这项变更，代码之前是如何工作的，变更后代码又会如何表现。考虑 API 设计、数据结构及其他关键决策的长期影响。

理解变更的动机有助于解释实现决策，甚至你可能会发现这项变更其实并不必要。对比变更前后的代码，也有助于你检查代码的正确性，并激发替代的实现思路。

### 给出全面的反馈

对变更的正确性、实现、可维护性、可读性和安全性给出反馈。指出违反风格指南、难以阅读或令人困惑的代码。阅读测试并查找漏洞，以验证代码的正确性。

问问自己，如果是你来实现这些变化，会如何着手，激发出替代的思路并讨论权衡。若修改了公共 API，考虑这可能如何影响兼容性和变更的发布计划（有关此主题，见第八章）。考虑将来程序员如何误用或误解这段代码，及如何改进代码以防止这种情况发生。

思考一下有哪些库和服务可以帮助处理这些变化。建议参考第十一章讨论的模式，以保持代码的可维护性。查找 OWASP 十大安全风险（[`owasp.org/www-project-top-ten/`](https://owasp.org/www-project-top-ten/)）的漏洞，比如 SQL 注入攻击、敏感数据泄露和跨站脚本漏洞。

不要过于简略——写评论时，要像你和别人并排审查代码时一样表达。评论应该礼貌，包含“做了什么”和“为什么做”：

```
Check that `port` is >= zero and raise an InvalidArgumentException if not. Ports can’t be negative.
```

### 认可做得好的地方

在审查代码时，专注于发现问题是很自然的，但代码审查并不全是负面的。也要评论那些做得好的地方！如果从阅读代码中学到了新东西，告诉作者。如果重构清理了代码中的问题区域，或者新增的测试让未来的修改风险更小，要用积极鼓励的评论认可这些改进。即使是你不喜欢的代码变更，也可能有值得表扬的地方——至少可以认可它的意图和努力。

> 这是一个有趣的变更。我完全理解为什么想将队列代码迁移到第三方库，但我对添加新依赖有些抗拒；现有的代码简单，且能完成它需要做的事情。如果我误解了动机，请一定指出；我很愿意进一步讨论。

### 区分问题、建议和细节挑剔

不是所有的审查评论都具有相同的优先级。主要问题需要更多关注，而中立的建议和表面的挑剔可以稍微忽略。

不要回避风格上的反馈，但要明确表明你是在挑剔。通常会在评论前加上“nit”作为前缀：

```
Nit: Double space.
Nit: Here and throughout, use snake_case for methods and PascalCase for classes.
Nit: Method name is weird to me. What about maybeRetry(int threshold)?
```

如果同样的风格问题反复出现，不要再三强调；指出第一次出现的情况，并表明这是需要统一修复的地方。没有人喜欢被反复告知同样的事情，而且也没必要这么做。

如果你发现自己经常挑剔风格，问问自己项目是否设置了足够的代码风格检查工具。理想情况下，工具应该为你完成这项工作。如果你发现你的审查大多是挑剔而很少有实质性的评论，那就放慢速度，深入阅读。指出有用的修饰性更改是审查的一部分，但这不是主要目标。有关代码风格检查和代码清理工具的更多内容，请参见第三章。

如果你认为某些建议会更好，但并不是批准所必需的，可以通过在反馈前添加“可选”、“随意”或“非阻塞”等词汇来提出建议。区分那些你真正希望看到的更改和仅仅是建议的地方；否则，提交者可能不会明确理解。

### 不要草率审批审查

你会感受到审批审查而不真正查看它的压力。紧急更改、同事的压力、看似微不足道的更改或过大的更改都会促使你签字同意。共情可能会促使你快速完成审查——你知道等待审查的感觉有多糟糕。

抵制草率审批审查的诱惑。草率审批审查是有害的。团队成员会认为你知道更改的内容及其应用原因；以后你可能会被追究责任。提交者会认为你已经查看并批准了他们的工作。如果你无法合理地优先处理审查，干脆不要审查该更改。

草率审批请求的诱惑可能是代码更改太大，无法在一次请求中处理的信号。不要害怕让团队成员将大规模的代码审查拆分成更小的顺序部分。开发者很容易开始工作，最终做出几千行的更改。期望在一次审查中充分审查巨大的代码更改是不现实的。如果你觉得代码走查会更高效，你也可以请求进行走查。

### 不要仅限于基于网页的审查工具

代码审查通常是在像 GitHub 拉取请求界面这样的专用 UI 中进行的。别忘了，代码审查只是代码。你仍然可以检出或下载提议的更改，并在本地进行测试。

本地代码检出让你可以在 IDE 中检查提议的更改。在网页界面中，较大的更改很难浏览。IDE 和基于桌面的审查工具可以让你更轻松地浏览这些更改。

本地代码也是可以运行的。你可以创建自己的测试来验证代码是否按预期工作。调试器可以附加到运行中的代码上，帮助你更好地理解代码的行为。你甚至可以触发失败场景，以更好地说明审查中的评论。

### 别忘了审查测试

审查者常常忽略测试，特别是在代码更改较大时。测试应该像其他代码一样被审查。通常，开始审查时阅读测试很有帮助；它们展示了代码的使用方式以及预期的效果。

确保检查测试的可维护性和代码的整洁性。查找不良的测试模式：执行顺序、缺乏隔离性以及远程系统调用。查看第六章，了解完整的测试最佳实践和需注意的违规行为。

### 推动审查结果的得出

不要成为导致改进停滞不前的原因。帮助审查提交者迅速通过代码审核。不要坚持完美，不要扩大更改范围，清楚地描述哪些评论至关重要，且不要让分歧加剧。

坚持质量，但不要成为无法逾越的障碍。Google 的“工程实践文档”（[`google.github.io/eng-practices/`](https://google.github.io/eng-practices/)）讨论了在审查代码更改（CL，Google 内部术语，用于指代提议的代码更改）时的这种矛盾：

> 一般来说，审查者应该倾向于批准一个 CL，一旦它处于明确改进正在开发的系统整体代码健康状态的状态，即使该 CL 不是完美的。

尊重所做更改的范围。在阅读时，你可能会发现改进相邻代码的方法，并有新的功能构想；但不要坚持将这些更改作为现有审查的一部分。可以开设票据来改进代码，并将工作留到后续。保持范围的紧凑将提高效率，并使更改保持增量式。

你可以通过将审查标记为“请求修改”或“已批准”来结束审查。如果你留下了很多评论，审查总结会很有帮助。如果你请求修改，请明确哪些修改是为了满足你的批准要求。以下是一个示例：

```
Change looks good. Few minor nits, but my main request is to fix the port handling. The code there looks brittle. See my comment for details.
```

如果你和作者之间在代码更改上有重大分歧，并且无法解决，主动提议将问题提交给其他专家，以帮助解决分歧。

## 做与不做

| **做** | **不要做** |
| --- | --- |
| **做** 在请求审查之前，确保所有测试和代码检查工具通过。 | **不要** 仅仅为了让 CI 系统运行而提出审查请求。 |
| **做** 为代码审查预留时间，并像对待其他工作一样优先安排它们。 | **不要** 只是走个过场做代码审查。 |
| **做** 如果评论看起来粗鲁、不具建设性或不合适，请大胆发声。 | **不要** 过度依赖你的代码或对反馈产生个人情绪。 |
| **做** 通过提供适当的上下文来帮助审查者理解更改。 | **不要** 在了解更改的全貌之前审查代码细节。 |
| **做** 在进行审查时，超越表面风格问题的层次进行思考。 | **不要** 过度挑剔细节问题。 |
| **做** 使用你所有的工具，而不仅仅是代码审查界面，来理解复杂的更改。 | **不要** 让完美成为良好的敌人。 |
| **做**复审测试。 |  |

## 提升技能

Google 的《代码复审开发者指南》可以在[`google.github.io/eng-practices/review/`](https://google.github.io/eng-practices/review/)找到，是一个很好的公司代码复审文化示例。请记住，这份指南是专门为 Google 编写的。你所在公司的风险容忍度、对自动化质量检查的投资以及对速度或一致性的偏好可能会导致不同的复审哲学。

在一天的工作结束时，代码复审是一种特殊的反馈给予与接收形式。Douglas Stone 和 Sheila Heen（企鹅出版集团，2014）所著的《*感谢反馈：接受反馈的科学与艺术*》是一本非常好的资源，它将帮助你成为更好的复审者和更好的被复审者。
