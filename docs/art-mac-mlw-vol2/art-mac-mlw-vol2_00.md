

# 前言



![](img/opener.jpg)

不幸的是，我们正生活在 Mac 恶意软件的黄金时代。Mac 电脑的销量年年攀升，^(1) 而行业报告预测，Mac 将成为企业环境中的主导平台。^(2) 随着苹果在全球电脑市场的份额不断增长，Mac 已经成为机会主义黑客和恶意软件作者越来越有吸引力的目标。一些研究甚至发现，Mac 系统上的威胁和恶意软件平均多于 Windows 系统。^(3)

在保护 Mac 电脑及其用户时，分析恶意软件（*《Mac 恶意软件艺术》* 第一卷的主题）只是战斗的一半。首先检测恶意代码是另一部分，可能甚至更重要。检测恶意代码有多种方法，每种方法都有其优缺点。在检测的光谱一端，我们可以利用恶意软件特征库。通过扫描二进制文件中恶意字节的序列，我们可以高效地识别已知的威胁。然而，这样做无法检测到新型恶意软件或变种。这一缺点是令人烦恼的。为了解释为什么，考虑一下名为 FruitFly 的恶意软件。它由一位程序员精心设计，并以高度定向的方式进行部署，长达十多年都未被发现，因为没有任何防病毒程序包含其检测特征。这款恶意软件通过 Mac 的麦克风和摄像头窃听毫无戒备的受害者，导致了现实生活中的严重后果。^(4)

在检测的光谱另一端是*基于行为的启发式检测*，它关注恶意程序的行为或对系统的影响。为了理解这种方法，想想你上次生病时的情况。也许你一开始只是流鼻涕、头痛、喉咙痛或肚子疼。尽管你可能不知道是哪种病原体感染了你，但你身体的症状表明你已经不再是正常、健康的自己。我们可以用类似的策略来通用且启发式地检测数字病原体：通过寻找症状和异常现象。

即使是新型且隐秘的恶意软件样本，在与系统互动时也会产生可观察的事件。有些，如产生一个新持久化的未签名进程，可能很容易被检测到。其他一些，如悄悄植入一个木马化的动态库或一个隐蔽的外泄通道，则更加微妙。无论如何，如果我们能通过编程检测到这些行为，我们应该能够判断系统是否被感染，并通过识别出相关进程来确定感染源。

本书侧重于基于启发式的方法，这是应对日益频繁针对 macOS 的复杂和前所未见的威胁的唯一途径。我们将编写能够检测异常的代码，然后定位恶意入侵系统的软件。在这个过程中，我们将深入探讨 macOS 操作系统，涉及的主题包括私有框架、反向工程专有系统组件等。

当然，基于启发式的检测方法也有一些缺点。虽然它应该能够识别系统中的任何恶意项，但它可能无法识别具体的恶意软件类型。例如，它应该能够注意到一个未经授权的程序偷偷访问麦克风或摄像头，但它不会知道负责该进程的是否是恶意软件 FruitFly。这是一个重大的缺点吗？我认为不是，因为负责感染的恶意软件可能本来就未知，而且你始终可以部署一个基于签名的检测引擎来覆盖已知的基础问题。

另一个挑战是基于启发式的检测可能会受到误报的影响。例如，恶意软件作者通常利用可执行的打包程序来混淆他们的恶意作品，但合法的软件开发者也可能如此。因此，任何基于启发式的检测方法在试图将某个项目分类为恶意时，都不应该只依赖单一的启发式规则。相反，检测应该始终寻找多个异常行为，并利用减少误报的方法，比如代码签名信息，才会将某些项目标记为可疑或可能是恶意的。如果条件允许，你可以让人工来验证任何被标记的项目。

## 本书内容概览

本书的核心内容是描述如何编写代码来检测 macOS 恶意软件。全书分为三部分。

就像医生通过做检查和收集数据来做出诊断一样，恶意软件检测器也必须如此。在第一部分：数据收集中，我们讨论了收集检测感染症状所需数据快照的程序化方法。我们将从简单的开始，描述列举和查询系统中运行进程的方法。在后续章节中，我们将深入探讨更高级的概念，例如直接解析二进制文件、提取和验证代码签名信息以及通过与专有系统组件交互来发现持久性。在相关部分，我们将展示恶意软件示例的代码片段。本部分的章节如下：

> **第一章：检查进程** 由于大多数 Mac 恶意软件样本作为独立进程运行，因此检查每个运行中进程的各种信息和元数据是发现感染的一个很好的起点。
> 
> **第二章: 解析二进制文件** 在 macOS 系统上，任何进程的背后都有一个通用或 Mach-O 二进制文件。本章将展示如何解析这些二进制文件，以揭示其中的异常。
> 
> **第三章: 代码签名** 任何基于启发式检测的方法都容易出现误报。通过提取和验证代码签名信息，正如本章所示，我们可以减少误报，同时提高任何恶意软件检测工具的有效性。
> 
> **第四章: 网络状态与统计** 本章描述了通过编程方式捕获主机网络状态和网络统计信息的方式。大多数 Mac 恶意软件会访问网络，而这些快照应该能够揭示未经授权的网络访问。
> 
> **第五章: 持久性** 恶意软件会保持持久性，以便在系统重启后仍然存活。持久性会对主机进行修改，本章重点讲解如何通过编程方式检测这些变化。

虽然第一部分讲解了如何获取数据快照，第二部分: 系统监控则介绍了持续监控系统以发现感染症状的方法。例如，我们将讨论一些框架和应用程序接口（API），它们可以帮助我们监控系统日志，并创建强大的文件、进程和网络监控工具。本部分包括以下章节：

> **第六章: 日志监控** 系统或*通用*日志包含大量数据，可以揭示大部分感染情况。苹果并未提供公开 API 用于接收流式日志消息，因此本章深入探讨了你可以在自己工具中使用的私有框架和 API。
> 
> **第七章: 网络监控** 本章专门讲解苹果的*NetworkExtension*框架，其 API 提供了构建强大网络监控工具的能力，这些工具可以揭示任何使用主机网络的恶意软件。
> 
> **第八章: 终端安全** 如果你在 macOS 上构建全面的恶意软件检测工具，你应该利用强大的终端安全框架及其 API。本章介绍了终端安全。
> 
> **第九章: 静音和授权事件** 本章涵盖了更高级的终端安全主题，包括授权事件、静音等内容。

2015 年，我创立了 Objective-See，现在它是一个非营利组织，提供免费的开源 macOS 安全工具。第三部分: 工具开发深入介绍了 Objective-See 的几款最受欢迎的工具。这些工具能够通用地检测多种 macOS 恶意软件，利用了第一部分和第二部分中讨论的许多方法。一旦你理解了它们的设计和内部结构，你就能顺利地构建自己的恶意软件检测工具。本书的最后，我们将把这些工具与多种复杂的 macOS 恶意软件进行对比。对于每一个样本，我们会讨论其感染路径、持久性方法和功能，然后突出工具如何发现这些症状。本部分的各章内容如下：

> **第十章: 持久性枚举器** 谁在那儿？大多数 Mac 恶意软件能在系统重启后持续存在，因此能够枚举所有持久性软件的工具应该能够揭示任何持续安装的恶意软件。本章将介绍这样一个工具：KnockKnock。
> 
> **第十一章: 持久性监视器** 受其兄弟工具 KnockKnock 启发，BlockBlock 利用端点安全技术，通过实时监控持久性事件来检测恶意软件。
> 
> **第十二章: 麦克风和摄像头监视器** 一些最狡猾的 Mac 恶意软件通过摄像头监视受害者，或通过麦克风监听他们。本章聚焦于 OverSight，它利用核心音频和媒体 API 以及日志子系统来检测恶意软件访问这些设备的行为。
> 
> **第十三章: DNS 监视器** 恶意软件试图连接到远程域名——例如，用于任务处理或数据外泄——将会生成 DNS 流量。本章展示了 DNSMonitor 如何利用苹果的*NetworkExtension*框架监控并阻止 macOS 主机上任何未经授权的 DNS 流量。
> 
> **第十四章: 案例研究** 提出关于安全工具有效性的说法是一回事，支持这些说法又是另一回事。在本章的最后，我们将把我们的安全工具与几种特别复杂和隐蔽的恶意软件样本进行对比，看看它们的表现如何。

## 本书适合谁阅读？

如果你理解网络安全基础、恶意软件基础和编程知识，你会从本书中获益最多。不过这些并不是必备条件，我会解释所有重要的概念。你还会发现阅读我的另一本书，*《Mac 恶意软件的艺术》*（第一卷，No Starch Press，2022），对你有帮助，因为它会介绍一些我们这里不会再涉及的 macOS 恶意软件基础知识。除此之外，我写这本书时特别考虑到了以下读者群体：

> **学生** 作为一名计算机科学专业的本科生，我对理解和检测计算机病毒有着浓厚的兴趣，并渴望拥有一本像这样的书。如果你正在攻读技术学位，并希望了解更多关于恶意软件检测的方法，或许是为了增强或补充你的学业，那么这本书适合你。
> 
> **恶意软件分析师** 我的恶意软件分析师生涯始于国家安全局，在那里我研究了针对美国军事系统的 Windows 恶意软件和漏洞利用。当我离开该机构时，我开始研究 macOS 威胁，但发现这一领域缺乏资源。本书旨在填补这一空白。如果你是 Windows 或 Linux 恶意软件分析师（甚至是希望提升技能的 Mac 恶意软件分析师），本书应能为你提供如何检测针对 macOS 系统的威胁的见解。
> 
> **Mac 系统管理员** 过去基于 Windows 的同质化企业环境已基本消失。如今，Mac 在企业中已变得普遍，催生了专门的 Mac 系统管理员以及（不幸的是）专注于运行 macOS 系统的企业恶意软件作者。如果你是 Mac 系统管理员，理解如何检测针对你所要防御的系统的威胁是至关重要的。本书旨在提供这样的理解（以及更多内容）。
> 
> **开发人员** 本书的核心内容是提出编写能够通用检测 Mac 恶意软件的代码的方法。如果你的工作是为 macOS 编写安全相关工具，那么本书对你会很有帮助。

即使你不是程序员，你可能会觉得关于程序化恶意软件检测的书籍值得一读。恶意软件检测远不仅仅是编写代码。我们将深入探讨 macOS 内部机制，涉及逆向工程话题，并讨论各种恶意软件样本，包括它们的能力和功能。

## 代码与恶意软件样本

你可以在[*https://github.com/objective-see*](https://github.com/objective-see)访问本书中讨论的所有代码示例、恶意软件样本和工具。TAOMM 仓库按章节组织代码示例，Malware 仓库包含每个恶意软件样本的加密版。使用密码*infect3d*解密样本。

警告

*TAOMM 仓库中的代码主要用于示范目的，优先考虑简洁性而非其他方面，如全面的错误检查。因此，不应照搬这些代码，例如在部署的安全产品中使用。请注意，Malware 仓库中的集合包含活跃的恶意软件。请不要感染自己！(如果你感染了，至少别怪我。)*

本书旨在展示与语言无关的算法和方法，但本书中的大部分代码是用 Objective-C 编写的。我选择不使用 Swift——这是一个非常适合编写 Apple 应用的语言，因为它在安全工具的上下文中会带来一些特定的挑战。例如，本书经常使用私有框架，这在 Objective-C 中很容易访问，但在 Swift 中需要额外的组件，例如桥接头文件。同样，使用暴露接口和 API 的 C 语言框架（如至关重要的 Endpoint Security）在 Objective-C 中非常直接。而在 Swift 中访问这些接口时，通常需要大量的类型转换和对 OpaquePointer 与 UnsafeMutablePointer 值的解包。

我在 macOS 14 上编写了所有代码，并在 macOS 的最新版本（包括 13、14 和 15）上进行了测试。在相关的地方，我会讨论跨版本的编程方法差异（例如，当一个旧的 API 被更现代的版本取代时）。这些讨论将帮助你编写与多个操作系统版本兼容的工具，并确保你继续支持旧版本。为了发现操作系统未来更新时可能出现的新技术，可以查看 Objective-See GitHub 上的存储库，获取本书中讨论的大部分开源安全工具的最新版本。

为了帮助你将每章中呈现的更大程序的不同部分拼凑在一起，我已为本书中的代码清单编号，使用了顺序编号（如清单 1-1、清单 1-2 等）。恶意软件示例和命令行示例没有清单编号。

## 开发环境

在你开始之前，我建议安装 Xcode，这是 Apple 的集成开发环境（IDE），也是在 macOS 上创建安全工具的事实标准产品。Xcode 可以在官方的 Mac App Store 上免费下载，它提供了一个用户友好的平台用于开发软件。我使用 Xcode 编写并编译了本书中的所有代码示例和工具，因此我建议你对这个工具有基本的了解。虽然这里不提供 Xcode 使用的详细指南，但网上有许多优秀的免费教程可以参考。

### 代码签名要求

说到编译代码：如果你曾在 macOS 上从事软件开发，你可能会遇到与 Apple 的代码签名要求相关的挑战，甚至更糟的是，关于权限的挑战。出于安全原因，Apple 在允许程序运行之前会检查程序的代码签名信息。（我们在第三章中更详细地讨论了代码签名。）

幸运的是，macOS 允许以临时方式对代码进行签名，这意味着如果你正在开发将在本地运行的安全工具，你不需要支付 99 美元购买 Apple 的开发者 ID。在 Xcode 中，在“签名与功能”下，勾选**自动管理签名**选项，并确保签名证书设置为**本地运行签名**。

### 权限

利用系统扩展或端点安全的工具需要特殊的权限，例如*com.apple.developer.endpoint-security.client*，才能运行。在第三部分中，我们将介绍如何从 Apple 获取这些权限，以构建可分发的工具。不过，获取权限需要付费的开发者 ID 账户。

对于本地开发和测试，你可以通过禁用系统完整性保护（SIP）来绕过权限要求。^(5) Apple 提供了禁用 SIP 的文档，方法是将 Mac 启动到恢复模式，执行命令 `csrutil disable`。^(6)

你还需要禁用 Apple 移动文件完整性（AMFI）；否则，未完全签名和未认证的授权二进制文件将无法运行。禁用 SIP 后，你可以通过终端以 root 权限执行以下命令来禁用 AMFI：

```
nvram boot-args="amfi_get_out_of_my_way=1"
```

使用 `nvram -p` 来确认启动参数是否正确设置。最后，重新启动。

需要强调的是，禁用这些 macOS 安全机制会大大降低系统的安全性。因此，最好仅在虚拟机中或在专用的开发测试机器上执行此操作。要在恢复模式下重新启用 SIP，运行 `csrutil enable`，要重新启用 AMFI，删除启动参数，通过运行 `nvram -d boot-args`。

## 安全地分析恶意软件

本书展示了许多检测 Mac 恶意软件的编程技巧。在本书的最后一章，你甚至可以跟着我们一起，利用我们的工具对各种恶意软件样本进行分析。如果你计划运行书中的代码片段，或构建并测试自己的工具来对抗这些恶意软件，一定要非常小心地处理这些样本。

一种恶意软件分析方法是使用独立计算机作为专用分析机器。你应该以最简化的方式设置这台机器，禁用如文件共享等服务。在网络配置方面，大多数恶意软件需要互联网访问才能完全发挥功能（例如，通信与指挥控制服务器进行任务处理），因此你应该以某种方式将机器连接到网络。至少，我建议通过 VPN 路由网络流量，以隐藏你的地理位置，防止攻击者追踪。

然而，利用独立计算机进行分析也有一些缺点，包括成本和复杂性。如果你希望将分析系统恢复到一个干净的基准状态（例如，重新运行一个样本或分析一个新样本），后者的缺点尤其明显。虽然你可以重新安装操作系统，或者如果使用 Apple 文件系统（APFS），返回到基准快照，但这两者都需要消耗时间。

为了应对这些缺点，你可以改为利用虚拟机来进行分析。像 VMware 和 Parallels 等公司提供了 macOS 系统的虚拟化选项。这个想法很简单：虚拟化操作系统的新实例，将其与你的基础环境隔离开来，最重要的是，可以通过点击按钮将其恢复到原始状态。要安装新的虚拟机，请按照每个供应商提供的说明操作。通常，这包括下载操作系统安装程序或更新程序，将其拖放到虚拟化程序中，然后完成其余的设置。

> 注意

*不幸的是，Apple Silicon 系统在虚拟化 macOS 时存在一些限制。像 Parallels 这样的供应商提供了与 Apple Silicon 兼容的预构建虚拟机，但目前尚不支持快照等功能。*

在进行任何分析之前，确保禁用虚拟机与基础系统之间的任何共享。例如，如果你运行了一个勒索软件样本，却发现它也加密了你主机系统上的任何共享文件，那将是相当不幸的。虚拟机还提供了网络选项，如仅主机和桥接。前者只允许与主机进行网络连接，这在各种分析情况下可能会非常有用，例如当你设置本地命令与控制服务器时。

我注意到，将虚拟机恢复到其原始状态的能力可以大大加快恶意软件分析，因为这样可以让你回到分析过程的早期阶段。你在开始分析之前应该始终拍摄一个快照，这样在完成分析后，你可以将虚拟机恢复到一个已知的干净状态。在分析过程中，你也应当明智地使用快照。例如，在允许恶意软件执行某些核心逻辑之前，立即拍摄一个快照。如果恶意软件未能执行预期的操作（可能是因为它检测到你的分析工具并提前退出），或者如果你的分析工具未能收集到所需的数据，只需恢复到快照，进行必要的环境或工具调整，然后重新允许恶意软件执行。在专用分析计算机或不支持快照的虚拟机上，APFS 快照可能是你的最佳选择。

虚拟机分析方法的主要缺点是恶意软件可能包含阻止虚拟机的逻辑。如果恶意软件能成功检测到自己正在被虚拟化，它通常会退出以避免继续分析。有关识别和克服此类逻辑的方法，请参见《Mac 恶意软件艺术》第一卷的第九章。

若要获取更多关于设置分析环境的信息，包括配置隔离虚拟机的具体步骤，请参阅 Phil Stokes 的*如何在不被感染的情况下逆向分析 macOS 恶意软件*。^(7)

## 额外资源

若要进一步阅读，推荐以下资源。

### 书籍

以下列表包含了一些我最喜欢的书籍，涵盖了逆向工程、macOS 内部结构以及一般恶意软件分析等主题。虽然其中有几本书比较旧，但核心的逆向和分析内容应该是永恒的。

+   **蓝狐：ARM 汇编内部结构与逆向工程** 由 Maria Markstedter 著（Wiley, 2023）

+   **x86 软件逆向工程、破解与对策** 由 Stephanie 和 Christopher Domas 著（Wiley, 2024）

+   Jonathan Levin 的*macOS/iOS（*OS）内部结构*三部曲（Technologeeks Press, 2017）

+   **计算机病毒研究与防御艺术** 由 Péter Ször 著（Addison-Wesley Professional, 2005）

+   **逆向工程：逆向工程的秘密** 由 Eldad Eilam 著（Wiley, 2005）

+   **OS X 事件响应：脚本和分析** 由 Jaron Bradley 著（Syngress, 2016）

### 网站

曾几何时，关于 Mac 恶意软件分析的资料在网上极为稀缺。如今，情况已大有改观。多个网站收集了这一主题的信息，像我自己在 Objective-See 网站上的博客也专注于 Mac 安全相关话题。以下是我最喜欢的一些资源，尽管这并不是一份详尽无遗的清单：

+   [*https://<wbr>papers<wbr>.put<wbr>.as*](https://papers.put.as): 一个相当详尽的关于 macOS 安全主题和恶意软件分析的论文和演讲档案。

+   [*https://<wbr>themittenmac<wbr>.com*](https://themittenmac.com): 知名 macOS 安全研究员和作者 Jaron Bradley 的个人网站，包含 macOS 的事件响应工具和威胁狩猎知识。

+   [*https://<wbr>objective<wbr>-see<wbr>.org<wbr>/blog<wbr>.html*](https://objective-see.org/blog.htm:): 我的博客，过去十年来发布了我和其他安全研究人员在 macOS 恶意软件、漏洞利用等方面的研究成果。

## 注释

1.    1.  “根据 IDC 跟踪器，2022 年第三季度全球 PC 出货量再下降 15.0%”，*商业新闻*，2022 年 10 月 9 日，[*https://www.businesswire.com/news/home/20221009005049/en/Worldwide-PC-Shipments-Decline-Another-15.0-in-the-Third-Quarter-of-2022-According-to-IDC-Tracker*](https://www.businesswire.com/news/home/20221009005049/en/Worldwide-PC-Shipments-Decline-Another-15.0-in-the-Third-Quarter-of-2022-According-to-IDC-Tracker).

1.  2.  “Jamf 第三季度数据确认 Mac 在企业中的快速普及”，*Computer World*，2022 年 11 月 11 日，[*https://www.computerworld.com/article/3679730/jamf-q3-data-confirms-rapid-mac-adoption-across-the-enterprise.html*](https://www.computerworld.com/article/3679730/jamf-q3-data-confirms-rapid-mac-adoption-across-the-enterprise.html).

1.    3.  “Malwarebytes 发现 Mac 威胁首次超越 Windows，成为最新恶意软件报告中的主角”，*Malwarebytes*，2020 年 2 月 11 日，[*https://www.malwarebytes.com/press/2020/02/11/malwarebytes-finds-mac-threats-outpace-windows-for-the-first-time-in-latest-state-of-malware-report*](https://www.malwarebytes.com/press/2020/02/11/malwarebytes-finds-mac-threats-outpace-windows-for-the-first-time-in-latest-state-of-malware-report).

1.    4.  美国司法部公共事务办公室，“俄亥俄州计算机程序员因感染数千台计算机恶意软件并获得受害人通信和个人信息而被起诉”，新闻稿第 18-21 号，2018 年 1 月 10 日，[*https://www.justice.gov/opa/pr/ohio-computer-programmer-indicted-infecting-thousands-computers-malicious-software-and*](https://www.justice.gov/opa/pr/ohio-computer-programmer-indicted-infecting-thousands-computers-malicious-software-and).

1.    5.  “系统扩展和 DriverKit”，Apple，访问日期：2024 年 5 月 25 日，[*https://developer.apple.com/system-extensions/*](https://developer.apple.com/system-extensions/).

1.    6.  “禁用和启用系统完整性保护”，Apple，访问日期：2024 年 5 月 25 日，[*https://developer.apple.com/documentation/security/disabling_and_enabling_system_integrity_protection?language=objc*](https://developer.apple.com/documentation/security/disabling_and_enabling_system_integrity_protection?language=objc).

1.    7.  Phil Stokes，*如何在 macOS 上反转恶意软件而不被感染*，2019 年 8 月 14 日，[*https://<wbr>go<wbr>.sentinelone<wbr>.com<wbr>/rs<wbr>/327<wbr>-MNM<wbr>-087<wbr>/images<wbr>/reverse<wbr>_mw<wbr>_final<wbr>_9<wbr>.pdf*](https://go.sentinelone.com/rs/327-MNM-087/images/reverse_mw_final_9.pdf)。
