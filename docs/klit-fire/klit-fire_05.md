# 第五章：构建与保护动力

本书主要关注大型项目。当我讨论升级时，我指的不是运行包管理器来安装最新版本的依赖包。当我提到弃用时，我不是在讨论为你的 API 进行版本控制。本书中的大部分建议无论项目规模如何都适用，但它主要是针对大型项目的。

第三章讨论了围绕遗留系统所带来的工程挑战发展策略。在那一章中，我描述了不同类型方法的形态和性质，并讲解了如何从整体角度看待这种挑战。本章则从组织角度描述了一种类似的方式：如何制定一个能够推动动力、保持团队专注和乐观的计划，即使工作变得艰难。

大型遗留系统现代化项目的有趣之处在于，技术人员似乎突然间开始倾向于那些他们知道在其他情况下无效的策略。很少有现代软件工程师会放弃敏捷开发，去花费数月时间规划架构的具体样貌，并试图一次性构建一个完整的产品。然而，当被要求进行旧系统现代化时，突然间每个人都开始将其分解成相互依赖的连续阶段。

面对遗留问题，敏捷方法并没有得到广泛宣传。市面上有很多书籍描述如何构建软件。也有一些书籍介绍如何维护软件，甚至更少有书籍讲解如何处理当软件被遗弃或最初构建时出现问题时，重建软件所面临的挑战。

事实上，重建一个系统时有效的方法与当初建立它时所使用的方法并没有太大不同。你需要保持小范围，并且不断迭代你的成功。这个做法看起来可能不必要，因为旧系统及其历史已经为你定义了所有的需求。假设仅仅因为一个现有系统可以运行，你就完全理解了这些需求，这是一个严重的错误。建立新系统的一个优势是团队对未知因素有更清晰的认识。现有系统可能会成为干扰。软件团队把它的全功能实现当作最小可行产品（MVP），不管那个现有系统有多大或多复杂。简而言之，信息量过大，难以管理。人们会感到不知所措，变得沮丧、丧失士气。项目停滞不前，这也加固了“现代化工作不可能完成”的观念。

## 动力构建者：可衡量问题的乐趣

当现有系统在背景中存在时，有几种不同的方法可以限制范围。最直接的方法是从现有系统的功能阵列中定义一个 MVP（最小可行产品）。将其简化成一个更轻量的版本，作为第一版，然后逐步添加回功能。尽管这种方法合理，但它需要纪律性和强有力的领导力。现有系统的所有用户自然会认为他们使用的功能是最关键的，并会游说尽早将其安排到第一版。这一过程很快就会变得政治化。

相反，我更倾向于通过定义一个可以衡量的问题来限制范围。构建现代化基础设施不是一个目标。不同的人自然会就应该执行哪些标准和最佳实践以及应该执行多么严格产生分歧。很少有现实中的系统完全符合理想标准；总是至少有一两处地方使用了非标准的方法来使某个特定功能或集成得以工作。每个人都知道这些妥协的存在，并且它们可能以某种形式或另一种形式在新系统中继续存在，但组织不太可能就何时以及在哪些地方引入这些妥协达成共识。

但是，如果所有的工作都围绕一个可以衡量和监控的关键问题来构建，那么这些对话会变得更容易。你从寻找尽可能多的机会开始，以改善这个问题，并按预计影响的大小进行优先排序。当在方法或技术上出现分歧时，决策的标准变成了“哪个能更进一步推动进展？”

继承的现代化项目进行得更顺利时，当贡献者感到可以自主工作，并且能够根据挑战和意外的出现进行调整，因为他们明白优先事项是什么。需要向高级团队汇报的决策越多——无论是副总裁、企业架构师，还是首席执行官——延迟和瓶颈就越多。失去的动力越大，人们就越不相信成功是可能的。当人们不再相信成功是可能的，他们就会停止全力以赴地工作。可衡量的问题赋予团队成员做决策的权力。大家已经达成一致，指标 X 需要改进；任何为改善指标 X 而采取的行动无需向上层报告。

可衡量的问题创造了明确表述的目标。有了目标，你就可以定义期望项目带来什么样的价值，以及这些价值将最有利于谁。现代化会让客户的体验更快吗？它能提高扩展性，帮助你签下更大的客户吗？它会拯救人们的生命吗？或者，它只是意味着某人可以进行一次会议演讲或撰写一篇关于从技术 A 切换到技术 B 的文章？

### 可衡量问题的结构

想要以整体方式处理架构是很自然的。我们的思维喜欢秩序和模式，一切都井然有序、深思熟虑的整洁感。但系统就像房子；它们永远不会保持完全干净太久。使用某样东西本身就迫使它发生变化。你会有更少的内存和存储，硬件会衰退，而且你增加了新功能，这意味着更多的代码行。

优秀的现代化工作需要抑制一开始就创建优雅而全面架构的冲动。你可以拥有一个整洁有序的系统，但你不会通过一开始就按照这种方式设计它来实现这一点。相反，你需要通过迭代来构建它。

可衡量的问题将引导你的团队完成现代化工作。当遗留系统刚推出时，它的规模和运维团队都很小。随着系统的增长，内部政治也随之增长。在某些情况下，整个业务单元的诞生或重组是为了跟随技术模式的发展。让所有这些人达成一致并朝同一个方向前进是非常困难的。可衡量问题的优势在于它是客观且不可辩驳的，因此，它有助于团队在现有系统遗留下来的内部政治中找到导航方向。人们可能会对可衡量的问题是否是正确的解决问题方向产生分歧，但这将把调解分歧的责任从工程团队转移到最初批准将现代化活动聚焦于该可衡量问题的高级管理者身上。

可衡量问题的最后一个好处是，正面结果与功能发布无关。当团队尝试从现有系统创建最小可行产品（MVP）时，组织会迫使他们尽快实现与现有系统的功能对等。成功或失败变得与发布挂钩，这促使了减少投入和技术债务的发生。

很可能，组织的业务方面并不理解现有系统的问题所在。推出他们已经拥有的功能不是他们会庆祝的事情。为了推动现代化工作取得进展，必须清晰地传达现代化如何改善现状。定义一个可衡量的问题向业务方面解释现有系统如何能够更好。一旦指标和标准被定义，任何给定的行动要么朝着积极方向发展，要么不会。错误更容易被识别、定义和纠正。组织中的每个人都可以通过查看指标来了解情况。

那么，如何识别一个好的可衡量问题呢？

最简单的候选问题是那些能反映组织的业务或使命目标的问题。如果你在考虑重构系统，却无法将这项工作与某种业务目标联系起来，那你可能根本不该做这件事。

当我在政府工作时，我看到的最鼓舞人心的项目之一是努力现代化移民系统，以便达到奥巴马政府设定的难民重新安置的挑战目标。即便只是涉及难民的子系统，整个系统也庞大复杂。工程师们被它的范围以及它偶尔遇到的问题所压倒。

但这个项目的挑战不是让整个系统变得更好；而是让整个系统处理特定类型的应用程序更加高效。以这种方式定义目标为努力创造了更清晰的范围。团队首先分析了应用处理中的瓶颈，然后开始精准地针对这些领域，寻求仅做逐步改进。关于优先级的讨论集中在哪些变化可能会增加处理的应用程序数量——这些数字是团队中的任何人都可以查看和参考的。当他们朝着这个具体目标努力时，团队放弃了许多急需的基础设施变更机会，因为这样做无法在需要的地方产生结果。

初看之下，这种方法可能显得不明智甚至不负责任，但大规模努力的头号杀手并不是技术失败，而是失去动力。要在长期的架构重建挑战中取得成功，团队需要建立一个反馈循环，不断基于并促进他们的成功记录。当显而易见的是，难民团队不仅会达到这个挑战目标——一个许多人认为不可能的数字——而且他们实际上会超额完成，超过几千人时，其他更有条件做出那些急需的基础设施改变的团队也开始以新的动力投入工作。不要忽视现代化项目通常是长期的，且通常涉及协调多个团队。战略性地狭隘一些以展示价值并建立动力并不是坏主意。

好的可衡量问题必须聚焦于你们工程师关心的问题。拯救免于 ISIS 的难民数量是一个容易激起人们关注的目标。很可能，你无法说你的数据库迁移能做到这一点，但工程师们对其他事情充满热情。与他们交谈，找出那些事情是什么。

## 动力杀手：团队无法达成一致

当我从一个个人贡献者转变为领导工程团队时，我在技术讨论中的角色发生了变化。当我专注于促进富有成效的对话，而不是争夺决策者角色时，我看到更好的结果。你有没有曾经参加过一个感觉像是在原地打转的会议？那种大家似乎在竞争，看谁能预测出最隐晦的潜在失败的会议？那种过去的决策被重新审议，最后每个人都不确定下一步该做什么的会议？促进技术对话比当决策者更为重要，因为无效且令人沮丧的会议会让团队士气低落。

由于大型系统通常比较复杂，失控的会议可能会使得关于支撑它们的技术的决策偏离轨道。可衡量的问题帮助人们优先考虑要改进的内容以及改进的顺序，但当涉及到具体的实施细节时，并不总是能够预测哪些选项会产生最大的影响。理智的人会有不同意见，但无意义的争论需要在造成过多损害之前化解。

### 步骤 1：定义范围

处理不良决策会议的最佳方式是从一开始就防止它们发生，方法是定义并执行会议范围。我通常会在会议开始时列出预期的结果、我会满意的结果，以及这个决策的范围外内容。我甚至可能会把这些信息写在白板上，或放入 PowerPoint 幻灯片中以供参考。我们想在这次会议中达成什么目标？如果我们卡住了，哪些结果是可以接受的？有时团队无法达成一致，因为存在真正的阻碍因素——比如一个需要更多研究的灰色区域。如果发生这种情况，我们能做出什么最小的决定，同时还能让会议看起来是有成效的？

一旦会议确定了范围，我会定义出那些我们应该一致认为不属于该范围的领域。通常，超出范围的问题是既不构成阻碍也不依赖于其他问题的决策。这些困难的问题似乎通常与会议范围内的议题有关，因此在有疑问时，团队需要能够清晰地表述出我们范围内的决策是如何受到提出的问题影响的。例如，我曾经有一个工程团队，负责创建一个无缝的平台，工程师可以在上面运行命令，平台会自动完成构建、配置和部署等繁重工作。与此同时，组织也在考虑逐步淘汰一种编程语言，转而采用另一种编程语言。为了实现第一个目标，我们需要就工具架构做出一些决策。我们是构建一组独立的工具，还是构建一个可以扩展功能的单一工具？无论我们选择什么设计模式，都可以在两种语言中同样完成，因此关于编程语言的任何争论都不会使我们更接近决定会议讨论的主题。关于编程语言的讨论是超出范围的。尽管这个问题最终会影响我们选择的设计模式的实现，但在选择设计模式时，它既不是阻碍因素，也不是依赖因素。

在与我的工程师们一起工作时，我设定了一个期望：为了进行富有成效、自由流畅的辩论，我们需要能够迅速且轻松地将评论和问题分为范围内和范围外的内容。我把这种技巧称为“真实但不相关”，因为我通常可以将会议中的信息分为三个类别：真实的、虚假的和真实但不相关的。不相关只是说超出范围的一种更简洁的表达方式。

将会议中的评论看作真实、虚假或真实但不相关的目的，并不是为了阻止人们提出不相关的细节。当我们仅仅把贡献看作真实或虚假时，我们给个人施加了压力，迫使他们为了保全面子而为他们不相关的事实的有效性辩护。通过鼓励大家将评论视为在范围内或范围外，我们实际上是在说，发言的工程师提出了一个有效的观点，应该在不同的讨论中考虑。

与此同时，相关性往往是任何一个人都很难判断的。你不希望工程师因为担心提出超出范围的内容而自我审查。他们可能会错误地认为某些问题超出了范围，因为他们掌握的信息不完全。如果他们因为将真正但不相关的问题与失败挂钩而没有提出问题，他们可能会忽略实际存在的问题。一次伟大的会议并不是没有人提到任何超出范围的内容，而是能够迅速由团队识别并处理这些超出范围的评论，而不会让它们偏离话题。

### 第 2 步：检查优化策略冲突

即使在范围定义清晰的情况下，工程师们仍然可能会发生冲突。当两个有能力的工程师无法就某个决策达成一致时，一个快速的技巧是问问自己，每个工程师在他们建议的方法中优化的是什么。记住，技术有很多权衡，优化一个特性会削弱另一个重要特性。例如，安全性与可用性、耦合性与复杂性、容错性与一致性等等。如果两位工程师实在无法达成共识，通常是因为他们对这两个极端之间的理想优化点有不同的看法。

在模糊不清且基于价值的情境中寻找绝对真理是痛苦的。有时，最有帮助的是明确指出争议的根源实际上是关于优化什么，而不是单纯的技术正确性。每个优化的影响是什么？过度优化某一方向的负面影响能否得到缓解？

### 第 3 步：进行时间限定实验

如果争议在范围内，并且不是由于优化策略冲突导致的，那么解决的最佳方式是进行时间限定的实验。找到一种方法，在小范围的样本中尝试每种方法，并设定一个明确的评估日期和具体的成功标准。成为实验的高手对于几乎任何组织来说都是非常宝贵的。这是迭代的基础——你建立某个东西，收集它的性能数据，修改它以提高性能，然后重新开始这个周期。这就是有效技术的构建方式，所以工程团队应该习惯使用它来做出艰难的决策。

## 动力杀手：失败的历史

你现在正在进行的现代化工作很可能不是第一次尝试。那些能够成功维持技术的公司通常不需要进行大规模的现代化项目。它们通过逐步变革和定期维护来保持技术的更新。如果你所在的团队只是负责清理技术债务并迁移到更合适的技术平台，那么这意味着现有组织未能适应变化。

你的具体情况可能有着比单纯忽视常规维护更深层次的失败历史。这真的是第一次现代化项目吗？如果不是，每一次以前的尝试都可能在组织中留下了创伤，你需要考虑这些因素。一个项目经历的失败越多，建立成功所需的动力就越困难。

现代化工作中的首批交付成果必须考虑到这种失败的历史。人们对遗留系统的现代化项目感到悲观和缺乏灵感，并不是因为他们不关心或者没有意识到现代化的重要性。通常，他们之所以有这种感觉，是因为在经历了多次失败后，他们确信成功是不可能的。

与此同时，我至今没有遇到一个工程团队，他们不愿意相信自己能够达到更好的状态。当你证明成功是可能的时，改变人们对失败不可避免的看法是相当容易的。

受启发并充满动力的工程团队能更顺利、更高效地推进现代化进程，因此，请围绕提前创造价值来设计你的现代化战略。哪些变化能够产生最直接的积极影响？

我曾为一个面临拆解其单体架构的重大挑战的组织工作。该组织希望构建一个标准化平台，产品工程团队可以利用它轻松地将服务部署到生产环境中——这是一个合理的目标——但产品本身却是三个单体架构堆叠在一个虚拟机上。如果你愿意的话，这可以被看作是“单体中的单体”。在当时该架构的构建符合业务需求，但在随后的几年中，组织经历了爆炸式的增长。等我加入时，那个架构已经不再适用了。

这个组织面临两个问题。首先，平台建设和单体拆解相互制约。产品团队不想在能够部署到平台之前将单体拆解为服务。可以理解的是，他们不想把某个东西放到发布管道中，结果平台到来时还得再迁移。另一方面，平台组在没有产品团队设定的需求之前无法构建平台。他们必须能够根据真实服务的实际需求来构建平台，而这些服务因为尚未从单体架构中拆解出来，所以并不存在。

第二个问题是，组织之前其实已经尝试过这两个过程，但每次都失败了，且失败了不止一次。他们曾尝试构建平台，并且迁移了一些小型、无关紧要的服务，这些服务拆解后不需要太多的重设计。根据我的估算，他们至少尝试了三次，每次都因失去动力而未能完成。

组织曾多次尝试拆解单体架构。每一次都被任务的复杂性所压倒。拆解单体架构很少，仅仅是把一些代码复制粘贴到不同的代码库中。当软件被设计为紧密耦合时，工程师通常会利用这种紧密耦合的优势，基于这种便捷的耦合关系进行构建。在这种情况下，这意味着他们的测试套件中大多数是端到端测试，而非单元测试。这也意味着多个组件访问同一个数据存储，并共同承担相同的信息责任。当他们将紧耦合的单体架构转变为解耦服务时，测试将失败，并且需要制定一种保持服务之间数据一致性的计划。

面对他们的第四次尝试，乐观情绪相当低落。每个人都希望这个项目能够成功，但没有人愿意成为第一个投入大量工作却在努力再次失败时只剩下空手的团队。

平台团队的知名工程师被要求提出一个计划。他们花了数周时间收集数据并采访团队，最终提出了以下折衷方案：他们将把三个单体应用推到自己的发布渠道上，配备自己的虚拟机，从而确保平台能够支持产品所需的一切，而不需要产品团队立刻拆分任何东西。

这个计划的问题在于，它并没有真正改善任何事情。现在，不再是一个有负责人和有序计划决定何时将代码推送到每个区域和环境的发布周期，而是组织将有三个发布周期，而没有人负责它们。每次部署都必须在多个团队之间精心协调，以确保变化不会意外地早早或晚些时候影响某个单体应用的生产环境。

它也不会降低成本。商业云服务提供商按照每个虚拟机的使用时间收费。三组独立的虚拟机意味着提议的计划会轻松使组织的托管费用翻倍甚至三倍。

我甚至不确定它是否能够顺利启动。我的团队一直在努力重新设计一个看似完全独立的服务，打算将其放上平台，但我们发现各种奇怪的地方，组件在出乎意料的方式下集成在一起。

将三个单体应用放在不同发布渠道上的价值是什么？

当我提出这个问题时，工程师们以为我在问拆分单体应用的价值是什么。经过几次对话，我才让他们明白，我并不是在质疑他们的目标，而是在质疑他们的出发点。从将虚拟机数量三倍化开始，会使得产品团队的更新变得更加复杂，并且不必要地增加支出。如果组织在拆分单体应用的过程中第一次经历了让工作变得更加困难和昂贵的情况，为什么还要继续投资这一过程呢？

关于遗留系统现代化的难题，不是技术问题，而是人际问题。技术通常是相当直接的。要保持人们的专注和动力，完成这一任务可能需要几个月甚至几年的时间，这很难做到。为了做到这一点，你需要立即提供显著的价值，尽快让人们克服天生的怀疑态度并支持你。概念验证中最重要的词是*证明*。你需要向人们证明成功是可能的，并且值得去做。

一个组织失败得越多，它就越需要证明现代化能带来价值的证据。当有过失败的历史时，第一步必须提供足够的价值，以建立起成功所需的动力。这样做的明显问题是，它意味着有一个自然的上限。怀疑主义达到如此之高的程度时，任何单一的第一步都无法提供足够的价值来证明项目能够成功。

那么接下来呢？

## 动力建设者：激发紧迫感

如果你发现自己处于这种情况，首先需要做一些尽职调查。第一个问题是，这次迁移到底是否带来了任何实际的价值？还是我们仅仅因为眼前有一种崭新的技术就去迁移？毕竟，单体系统并不全是坏的。许多成功的公司仍然在运行单体系统。

如果你相信迁移确实能带来价值，接下来你需要问自己的是，领导层是否会承诺优先考虑这一点？有时你可能会运气好，变革是有硬性截止日期的，并且错过了会有实际后果。^(1)

但如果领导层没有优先考虑此事，并且如果你相信迁移确实有商业价值，但又被反复失败的怀疑主义所困扰，那么你需要的就是一场危机。毕竟，价值是相对的。当一切顺利，钱进账时，工程师们可以容忍各种过错。而当形势不佳时，几乎任何变化所带来的价值感知都会增加。应对危机会改变组织内部对风险的权衡。

在我政府工作的时期，我们经常会达到价值规模的上限。有些系统非常陈旧，现代化的努力几乎是代代相传。拥有一场危机成了我团队运作的一个重要组成部分——以至于我们可能会拖延几周或几个月才与某个机构沟通，就为了看看是否会冒出一个我们可以借机处理的危机。

偶尔，我会走得更远，寻找一场危机来引起关注。这通常不需要太多努力。任何超过五年的系统都会至少有几个重大问题。这并不意味着撒谎，也不意味着在不存在问题的地方制造问题。相反，这是讲故事的艺术——把一些未被报道的问题提出来，突出其潜在风险。这些问题*确实*是问题，我对它们潜在影响的分析总是诚实的，但其中一些问题完全可以在几个月或几年内未被发现，甚至没有引发任何事件。

我最喜欢从安全性开始，然后是系统稳定性。理解这些问题出错的影响和后果并不需要太多的技术知识。也有一些领域，即使是最优秀的技术团队也会时不时遇到困难，因此如果你在这两个方面寻找潜在的危机，通常不会空手而归。

## 保护进展：对重大决策的配额限制

既然你已经完成了评估情况并围绕它组织工作的所有任务，你就不希望让组织本身削弱这些努力。人们本意是好的，但任何形式的变革都有风险，接受风险是困难的。别担心，你可以为组织变革创造一个让人们同意而非拒绝的氛围。

首先，你需要学会以一种方式来谈论你正在做的事情，最大限度地减少需要做出的重大决策数量，尤其是那些包括过程变更或需要多个利益相关者签字并经过多轮审批才能改变的决策。

需要咨询许多利益相关者的决策显然难以管理且痛苦。人们自然会想避免这些决策。因此，你的提案看起来包含的重大决策越多，人们就越有可能想要放慢进度或推迟一个季度。

你可能认为通过为项目起个花哨的名字、预测预算并事先解决人员配置问题是在认真工作，确实是这样！但你也在让项目看起来像是一系列重大的决策，对于那些没有日常处理遗留系统痛苦的受众来说，这看起来太冒险。考虑针对不同受众以不同的方式谈论同一个项目。有些受众会欣赏详细的计划，而另一些受众则会更倾向于高层次的方案。

在你需要减少为了推进工作必须做出的重大决策时，请注意以下几点：

1.  现有的项目、计划或技术——这些是最典型的“差一错”的例子。借助已经批准的解决方案可以避免你自己去寻求这些批准。

1.  有利的法规 你可以通过让重大决策看起来已经做出，从而消除这一决策，但你也可以通过让组织看似没有选择的方式来消除重大决策。合规性，尤其是与安全相关的合规性，是一个值得关注的领域，因为这些规则通常伴随着必须在特定时间完成的截止日期，否则组织将失去认证、资金，甚至可能失去客户。

1.  模糊的审批过程 "请求宽恕，而非许可" 是初创公司圈子里流行的说法，但说实话，如果你能让人相信你是在诚意行事，那么最好请求宽恕。如果你绕过了一个记录清晰且广为人知的审批过程，结果往往不如当流程模糊或不存在时那样有利。

## 保护进展：计算机会成本

增值不仅仅是技术结果的体现。往往，商业结果提供了更清晰的优先级路径。商业结果可能是利润，但如果你在一个以使命为驱动的组织工作，商业结果也可能是服务的人数或观察到的影响。在进行一个多年的现代化项目时，得到业务方的支持至关重要。你不能指望他们理解技术成果，因此你应该知道如何通过计算机会成本来阐明商业成果的价值。

对于那些不熟悉这一概念的人，*机会成本*是指由于选择了其他机会而未进行某项活动，从而导致的资金损失。通常，机会成本通过未实现的预期利润来表达，但在遗留系统的背景下，我们通常会将机会成本理解为节省的资金。

机会成本更适合作为思想实验，而不是实际计算。如果我们能够准确计算出每种可能的方式升级现有系统（或者与不做升级、仅增加新特性相比）将花费多少时间和金钱，那么维护遗留系统就会变得容易。但机会成本的价值在于促使人们交流他们的假设，并为为什么组织应该做我们想要做的事情提供论据。为了提供价值，机会成本的估算不必准确，只需要为给定决策的权衡提供有洞察力的背景。

计算机会成本不仅仅是为了做出更有利可图的决策。它为团队提供了数据，以向各方利益相关者证明现代化活动的合理性。只有当技术明显失败时，投资技术健康才对所有人有意义，而到那时，问题已经变得更加严重，解决起来也更为困难。高层管理通常对任何清理活动持怀疑态度——担心它会不必要地拖慢组织的速度。

我在 Auth0 的第一个大项目是处理我们的通知系统。Auth0 当时仅为测试和开发目的维护着一个共享的电子邮件服务器。然而，客户们偶尔会忽视在进入生产阶段时，尽管有许多免费的选项可用，还是未能迁移到专用的服务提供商。当客户达到限制时，我们会将他们的邮件放入重试队列，以便稍后发送。

我们曾错误地假设客户会逐步超过配额，这是由自然流量增长造成的。如果真是这样，随着时间的推移，重试邮件是有意义的。少量邮件延迟，随着延迟变得越来越普遍，就会促使客户转向专用服务商。事实上，客户更有可能因某些活动突然突破配额限制，这些活动会触发向所有用户发送邮件——一次可能是数百甚至数千封邮件。

这就导致了一个情况：重试队列会被填满，直到 20 个工作人员需要花费数小时的处理时间才能清理邮件。这影响了所有用户的服务性能，并触发了值班人员的提醒——这一切仅仅是因为一堆大多数时候根本没人真正想要送达的邮件。

我们决定改变速率限制的工作方式，改为当超出限制时，共享服务商不再重试邮件，而是直接丢弃它们。这是一项艰巨的迁移工作，我们不仅需要改变速率限制的算法，还需要更换最初执行速率限制的技术。我们现有的速率限制解决方案正在被另一个解决方案替代。我们需要改变架构，并为升级速度较慢的本地客户制定一种向后兼容的策略，而这些客户的升级速度比云客户要慢。

这一切都需要大量的工作，而我们投入其中的动力非常个人化：当重试队列填满时，会向我们团队的某个成员发送提醒，让他们去解决这个问题。这既令人烦恼又具有干扰性。更加令人沮丧的是，解决此问题的官方方案是将重试队列中的所有邮件都丢弃掉。让人不禁觉得，要求一个人凌晨 3 点起床去做一件本该由计算机自动完成的事，简直毫无意义。

我们直到变更进行到一半时才意识到，避免发送成百上千封无意义的邮件能为我们节省多少资金。我们从为我们运行共享邮件服务器的公司每月收到一定数量的邮件。当我们超过这个限制时，我们与该服务商的账户会自动购买 50,000 封额外邮件，费用为 20 美元，并会发送提醒通知我们已经完成了购买。当我们开始实施这个变更时，我们每天大约会收到 10 个此类提醒，意味着额外花费了 200 美元的邮件费用。单次事件的费用可能从 1,000 美元到 2,000 美元不等。

当这些变更生效时，我们通过简单地取消那些客户本不想发送的邮件，就为公司节省了数万美元。这整个项目可以说是一个巨大的成功，但节省的成本给了我们政治资本，可以用来证明我们为什么没有花时间增加新功能，并为以后类似的维护工作争取支持。

在计算机会成本时可能会有些棘手，因为潜在的机会似乎是无穷无尽的。记住，机会成本是思维实验和修辞工具。你不需要列出团队可能正在做的所有事情的成本，只需要列出那些能够支持你想要做的事情的活动。这意味着要突出高优先级活动可能比组织预期的要贵，并且用通俗易懂的语言描述按照你希望的方式做事能带来多少价值。

在寻找适当的机会进行比较时，可以考虑以下三个大类中的活动。

### 不添加新特性的成本

这个成本通常是通过估算新特性带来的利润或影响来计算的。在小型组织中，这个成本更大，因为开发团队可能没有足够大，无法拆分成不同的部门。推出一个新特性会占用更多比例的总员工，这意味着他们无法进行现代化工作或参与其他项目。

在大多数组织中，推迟对遗留系统进行维护以优先考虑新特性和产品的压力是常态。虽然总是觉得组织如果能够度过当前的挑战，事情会平静下来并且清理工作可以开始，但实际上从没有一个合适的时机。为了避免无休止的拖延，尽量将新特性与目标状态对齐。例如，如果从单体架构迁移到服务架构，你可能想通过新特性来确定第一个需要拆分的服务。

### 不解决其他问题的成本

遗留系统通常不仅仅有一个问题。现代化过程中的每一步都是在选择用相同的时间和精力来解决的不同问题。我已经描述了选择修复什么以及何时修复的各种方法。机会成本实际上是关于如何向上层管理推销策略。如果组织已经定义了*服务水平目标*(SLOs)*，或者有*服务水平协议*(SLAs)*，那么这将更容易。SLOs 和 SLAs 都将性能水平与消费者价值挂钩。SLAs 甚至可能会规定当性能低于某个特定水平时，客户可以获得的具体赔偿金额。

服务水平目标（SLOs）和服务水平协议（SLAs）帮助团队根据问题对用户造成的痛苦程度来优先修复问题。即使你确信不需要证明何时以及如何进行现代化，它们也是一个很好的工具。但是如果你确实需要为你的策略辩护，你应该能够研究历史数据并预测在什么条件下，某个系统或系统的某个部分可能会违反其 SLO。通常，这受到规模的强烈影响，因此这是一个利用业务方雄心壮志的好机会：看看业务期望的增长水平，并基于这一增长水平如何影响 SLO 来计算机会成本。

### 不弃用而选择其他解决方案的成本

这是一个特别难以计算的成本，因为弃用并不是一次性完成的。在迁移或现代化的过程中，组织很可能会同时维护旧解决方案和现代化解决方案，尤其是当新解决方案需要部署代码更改时。因此，除了购买或开发新解决方案的成本外，还需要考虑弃用旧解决方案的成本。这个成本会影响多少团队？在进行这些更改时，他们不能做哪些工作？旧解决方案和新解决方案的长期维护负担如何？根据新解决方案是托管的/软件即服务（SaaS）还是仅仅是一个新的定制工具，考虑的因素可能会有很大不同。
