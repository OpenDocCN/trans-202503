# 第一章：口腔卫生：嵌入式安全简介

![](img/chapterart.png)

嵌入式设备的种类繁多，这使得研究它们变得非常有趣，但同样的多样性也可能让你对又一种新的形状、封装或奇怪的集成电路（IC）感到困惑，并且不知道它与安全性之间的关系是什么。本章从各种硬件组件和它们上运行的软件类型开始。接着我们讨论攻击者、各种攻击、资产和安全目标，以及防御措施，概述安全威胁是如何建模的。我们描述了创建攻击树的基础知识，既可以用于防御目的（寻找防御措施的机会），也可以用于进攻目的（推理出最容易的攻击方式）。最后，我们以关于硬件领域协调披露的思考作为结尾。

## 硬件组件

让我们从查看你可能会遇到的嵌入式设备的物理实现相关部分开始。我们将涉及你在首次打开设备时会看到的主要部分。

嵌入式设备内部有一个*印刷电路板（PCB）*，通常包括以下硬件组件：处理器、易失性存储器、非易失性存储器、模拟组件和外部接口（见图 1-1）。

![f01001](img/f01001.png)

图 1-1：嵌入式设备的典型 PCB

计算的魔力发生在*处理器（中央处理单元，*CPU*)中。在图 1-1 中，处理器嵌入在*系统芯片（SoC）*的中央 1 位置。通常，处理器执行主软件和操作系统（OS），而 SoC 包含额外的硬件外设。

*易失性存储器* 2 通常以动态 RAM（DRAM）芯片的形式在分立封装中实现，它是处理器在运行时使用的存储器；当设备断电时，它的内容会丢失。DRAM 存储器的工作频率接近处理器频率，并且需要宽总线以跟上处理器的速度。

在图 1-1 中，*非易失性存储器* 3 是嵌入式设备存储在设备断电后仍需保持的数据的地方。这种存储方式可以是 EEPROM、闪存，甚至是 SD 卡和硬盘。非易失性存储器通常包含启动代码以及存储的应用程序和保存的数据。

尽管*模拟组件*（如电阻器、电容器和电感器）本身在安全性方面并不特别有趣，但它们是*旁路分析*和*故障注入攻击*的起点，我们将在本书中详细讨论这些内容。在典型的 PCB 中，模拟组件通常是那些看起来不像芯片的小黑色、棕色和蓝色部件，它们的标签可能以“C”、“R”或“L”开头。

*外部接口*为 SoC 提供了与外界连接的方式。这些接口可以连接到其他商用现成（COTS）芯片，作为 PCB 系统互联的一部分。例如，这包括高速度的总线接口到 DRAM 或闪存芯片，以及低速接口，如 I2C 和 SPI 连接到传感器。外部接口还可以作为 PCB 上的连接器和针脚头暴露出来；例如，USB 和 PCI Express（PCIe）是连接外部设备的高速接口的例子。这是所有通信发生的地方；例如，与互联网、本地调试接口或传感器和执行器的通信。（有关与设备接口的更多细节，请参见第二章。）

微型化使得 SoC 能够拥有更多的*知识产权（IP）块*。图 1-2 显示了一个英特尔 Skylake SoC 的例子。

![f01002](img/f01002.png)

图 1-2：英特尔 Skylake SoC（Fritzchens Fritz 公共领域）

这个芯片包含多个核心，包括主要的中央处理单元（CPU）核心、英特尔融合安全与管理引擎（CSME）、图形处理单元（GPU）等。SoC 内部总线比外部总线更难访问，这使得 SoC 在黑客攻击中的起点并不方便。SoC 可能包含以下 IP 块：

**多个（微）处理器和外围设备**

例如，一个应用处理器、一个加密引擎、一个视频加速器和 I2C 接口驱动程序。

**易失性内存**

以堆叠在 SoC 上的 DRAM IC、SRAM 或寄存器组的形式存在。

**非易失性内存**

以芯片内只读存储器（ROM）、一次性可编程（OTP）熔丝、EEPROM 和闪存的形式存在。OTP 熔丝通常会编码关键的芯片配置数据，例如身份信息、生命周期阶段以及反回滚版本信息。

**内部总线**

虽然技术上只是一些微小的导线，SoC 内不同组件之间的互联实际上是一个重要的安全问题。可以把这个互联看作是 SoC 中两个节点之间的网络。作为网络，内部总线可能会受到伪装、嗅探、注入以及所有形式的中间人攻击的威胁。高级 SoC 包括多级访问控制，以确保 SoC 中的各个组件彼此“防火墙”隔离。

这些组件每一个都是*攻击面*的一部分，是攻击者的起点，因此具有一定的关注度。在第二章，我们将更深入地研究这些外部接口，在第三章，我们将探讨如何查找关于各种芯片和组件的信息。

## 软件组件

软件是 CPU 指令和数据的结构化集合，由处理器执行。就我们而言，软件是否存储在 ROM、闪存或 SD 卡上并不重要——虽然可能会让我们年长的读者失望的是，我们不会讨论穿孔卡。嵌入式设备可以包含以下一些（或没有）类型的软件。

### 初始启动代码

初始启动代码是处理器在首次通电时执行的一组指令。初始启动代码由处理器制造商生成并存储在 ROM 中。*启动 ROM 代码* 的主要功能是准备主处理器执行后续代码。通常，它允许引导加载程序在现场执行，包括用于认证引导加载程序或支持备用引导加载程序源（例如通过 USB）的例程。它还用于制造过程中的支持，包括个性化、故障分析、调试和自检。启动 ROM 中可用的功能通常通过*保险丝*进行配置，保险丝是集成在硅中的一次性可编程位，它在处理器离开制造设施时提供永久禁用某些启动 ROM 功能的选项。

启动 ROM 具有与常规代码不同的属性：它是不可变的，它是系统上运行的第一段代码，且必须能够访问完整的 CPU/SoC，以支持制造、调试和芯片故障分析。开发 ROM 代码需要非常小心。由于它是不可变的，通常无法修补在制造后发现的 ROM 漏洞（尽管某些芯片支持通过保险丝进行*ROM* *修补*）。启动 ROM 在任何网络功能激活之前执行，因此利用任何漏洞需要物理访问。在启动阶段被利用的漏洞通常会导致直接访问整个系统。

考虑到制造商在可靠性和声誉方面的高风险，一般来说，启动 ROM 代码通常较小、简洁且经过良好验证（至少应该是这样）。

### 引导加载程序

*引导加载程序* 在启动 ROM 执行后初始化系统。它通常存储在非易失性但可变的存储介质上，因此可以在现场更新。PCB 的原始设备制造商（OEM）生成引导加载程序，使其能够初始化 PCB 级组件。它还可以选择性地锁定一些安全功能，除了其加载和认证操作系统或*受信执行环境（TEE）*的主要任务外。此外，引导加载程序还可能提供设备配置或调试的功能。作为设备上第一个可变的代码，引导加载程序是一个有吸引力的攻击目标。安全性较差的设备可能拥有不认证引导加载程序的启动 ROM，从而允许攻击者轻松替换引导加载程序代码。

引导加载程序通过数字签名进行身份验证，这些签名通常通过将公钥（或公钥的哈希值）嵌入引导 ROM 或保险丝中来验证。由于这个公钥很难被修改，因此它被认为是*信任根*。制造商使用与公钥关联的私钥对引导加载程序进行签名，因此引导 ROM 代码可以验证并信任制造商是其生产者。一旦引导加载程序被信任，它可以进一步嵌入下一阶段代码的公钥，并提供对下一阶段代码真实性的信任。这个*信任链*可以一直扩展到运行在操作系统上的应用程序（见图 1-3）。

![f01003](img/f01003.png)

图 1-3：信任链—引导加载程序阶段与验证

从理论上讲，创建这个信任链似乎非常安全，但该方案容易受到多种攻击的威胁，包括利用验证漏洞、故障注入、时间攻击等。请参阅 Jasper 在 2019 年 Hardwear.io USA 大会上的讲座《十大安全启动错误》，该讲座可以在 YouTube 上观看([`www.youtube.com/watch?v=B9J8qjuxysQ/`](https://www.youtube.com/watch?v=B9J8qjuxysQ/))，以了解十大错误概述。

### 受信执行环境操作系统与受信应用程序

在撰写本文时，TEE 在较小的嵌入式设备中是一种罕见的特性，但在基于如 Android 等系统的手机和平板电脑中非常常见。其理念是通过将整个 SoC 划分为“安全”和“不安全”世界来创建一个“虚拟”安全 SoC。这意味着 SoC 上的每个组件要么仅在安全世界中活动，要么仅在不安全世界中活动，或者能够在两者之间动态切换。例如，一个 SoC 开发人员可能会选择将加密引擎放在安全世界中，将网络硬件放在不安全世界中，并允许主处理器在两者之间切换。这可以使系统在安全世界中加密网络数据包，然后通过不安全世界——即“普通世界”——进行传输，从而确保加密密钥永远不会到达主操作系统或处理器上的用户应用程序。

在手机和平板电脑上，TEE 包括其自己的操作系统，可以访问所有安全世界组件。*丰富执行环境（REE）*包括“普通世界”操作系统，例如 Linux 或 iOS 内核和用户应用程序。

目标是将所有不安全且复杂的操作，如用户应用程序，保留在不安全世界中，而将所有安全操作，如银行应用程序，保留在安全世界中。这些安全应用程序被称为*受信应用程序（TAs）*。TEE 内核是一个攻击目标，一旦被攻破，通常会提供对安全世界和不安全世界的完全访问。

### 固件镜像

固件是运行在 CPU 或外设上的低级软件。设备中的简单外设通常完全基于硬件，但更复杂的外设可能包含运行固件的微控制器。例如，大多数 Wi-Fi 芯片需要在上电后加载固件“二进制块”。对于运行 Linux 的设备，查看*/lib/firmware* 目录可以看到运行 PC 外设时涉及的固件数量。与任何软件一样，固件可能非常复杂，因此容易受到攻击。

### 主要操作系统内核和应用程序

嵌入式系统中的主要操作系统可以是通用操作系统，如 Linux，或者是实时操作系统，如 VxWorks 或 FreeRTOS。智能卡可能包含运行 Java Card 应用程序的专有操作系统。这些操作系统可以提供安全功能（例如，加密服务）并实现*进程隔离*，这意味着如果一个进程被攻破，另一个进程可能仍然保持安全。

操作系统为软件开发者提供了便利，他们可以依赖现有的广泛功能，但对于较小的设备来说，这可能不是一个可行的选项。非常小的设备可能没有操作系统内核，而只运行一个*裸机*程序来管理它们。这通常意味着没有进程隔离，因此一旦某个功能被攻破，整个设备都会受到影响。

## 硬件威胁建模

威胁建模是任何系统防御中的重要任务之一。防御系统的资源是有限的，因此分析如何最佳地使用这些资源以最小化攻击机会至关重要。这是通向“足够好”安全性的道路。

在进行威胁建模时，我们大致做以下几步：从防御角度出发，识别系统的重要资产，并问自己这些资产应如何被保护。另一方面，从攻击角度出发，我们可以识别潜在的攻击者、他们的目标以及他们可能选择尝试的攻击方式。这些考虑有助于了解应该保护什么以及如何保护最有价值的资产。

威胁建模的标准参考书是 Adam Shostack 的《*威胁建模：设计安全性*》（Wiley，2014）。威胁建模这一广泛领域非常引人入胜，因为它涵盖了从开发环境到制造、供应链、运输以及运营生命周期的安全性。在这里，我们将讨论威胁建模的基本方面，并将其应用于嵌入式设备安全，重点关注设备本身。

### 什么是安全？

*牛津英语词典*将安全定义为“免受危险或威胁的状态”。这个相当二元的定义暗示，唯一安全的系统要么是没人愿意攻击的系统，要么是能够防御所有威胁的系统。前者，我们称之为*砖头*，因为它无法再启动；后者，我们称之为*独角兽*，因为独角兽并不存在。没有完美的安全性，因此你可以认为任何防御都不值得付出努力。这种态度被称为*安全虚无主义*。然而，这种态度忽视了一个重要的事实，即每一次攻击都伴随着*成本-收益*的权衡。

我们都明白金钱方面的成本和收益。对于攻击者来说，成本通常与购买或租赁实施攻击所需的设备有关。收益则表现为欺诈性购买、被盗汽车、勒索软件赎金以及老虎机现金提取，仅举几例。

然而，执行攻击的成本和收益并不仅限于金钱。一个显而易见的非金钱成本是时间；一个不太明显的成本是攻击者的挫败感。例如，一个为了娱乐而进行黑客攻击的攻击者可能会在面对挫折时简单地转向另一个目标。这里肯定有一个防御的教训。有关这个想法的更多内容，请参见 Chris Domas 在 DEF CON 23 上的演讲：“Repsych：反向工程中的心理战”。非金钱的收益包括获取个人身份信息和从会议出版物或成功破坏中获得的名声（尽管这些收益也可能变现）。

在本书中，我们认为如果攻击的成本高于收益，则一个系统是“足够安全”的。一个系统的设计可能并不坚不可摧，但它应该足够坚固，以至于没有人能够将整个攻击过程推进到成功。总之，威胁建模是确定如何在特定设备或系统中达到“足够安全”状态的过程。接下来，我们来看看几个影响攻击收益和成本的方面。

#### 穿越时间的攻击

美国国家安全局（NSA）有句名言：“攻击总是越来越好，而不是变得更差。”换句话说，攻击随着时间的推移变得更便宜、更强大。这个原理尤其适用于较长的时间尺度，因为公众对目标的了解增加、计算能力的成本下降以及黑客硬件的易得性。芯片从初步设计到最终生产可能需要几年时间，接着至少需要一年时间将芯片集成到设备中，导致芯片在商业环境中投入使用时通常需要三到五年的时间。这个芯片可能需要在几年内保持正常工作（例如物联网产品），或者十年（如电子护照），甚至二十年（如汽车和医疗环境）。因此，设计师需要考虑未来 5 到 25 年内可能发生的任何攻击。这显然是不可能的，因此通常需要推迟软件修复以缓解无法修补的硬件问题。换句话说，25 年前，智能卡可能很难被破解，但通过本书的学习后，25 年的智能卡应该几乎没有任何抵抗力来提取其密钥。

成本差异也出现在较短的时间尺度上，从初始攻击到重复攻击之间的差距。*识别阶段*涉及识别漏洞。紧接着是*利用阶段*，即利用已识别的漏洞来攻击目标。在（可扩展的）软件漏洞的情况下，识别成本可能很高，但利用成本几乎为零，因为攻击可以自动化。而对于硬件攻击，利用成本仍然可能很高。

在效益方面，攻击通常具有一个有限的有效期。在今天破解 Commodore 64 的复制保护几乎没有任何经济价值。你最喜欢的体育比赛的视频流只有在比赛进行时和结果未揭晓之前才具有高价值。比赛结束后的第二天，其价值显著降低。

#### 攻击的可扩展性

软件和硬件攻击的识别阶段和利用阶段在成本和效益上有显著区别。硬件利用阶段的成本可能与识别阶段相当，而软件攻击则不常见这种情况。例如，设计得很安全的智能卡支付系统使用了多样化的密钥，使得在一张卡上找到密钥并不能让你了解另一张卡的密钥。如果卡片安全性足够强，攻击者需要数周或数月的时间和昂贵的设备才能在每张卡上进行几千美元的欺诈性购买。为了获得下一个几千美元，他们必须为每张新卡重复这一过程。如果卡片这么强，显然对于以经济利益为动机的攻击者而言没有商业可行性；这种攻击的可扩展性很差。

另一方面，考虑一下 Xbox 360 改装芯片。图 1-4 显示了 Xenium ICE 改装芯片，左侧是白色 PCB。

![f01004](img/f01004.png)

图 1-4：Xenium ICE 改装芯片在 Xbox 中的应用，用于绕过代码验证（图片来源：Helohe，CC BY 2.5 许可证）

图 1-4 中左侧的 Xenium ICE 改装芯片被焊接到 Xbox 主板上，以执行攻击。该板通过自动化故障注入攻击加载任意固件。这种硬件攻击非常容易执行，以至于销售改装芯片本身就可以成为一项商业活动；因此，我们称其为“具有良好的扩展性”（第十三章提供了该攻击的详细描述）。

硬件攻击者受益于规模经济，但前提是利用成本必须非常低。一个例子是硬件攻击提取可以大规模使用的秘密，比如恢复隐藏在硬件中的主固件更新密钥，从而访问大量固件。另一个例子是一次性操作提取启动 ROM 或固件代码，这样可以暴露出可反复利用的系统漏洞。

最后，对于一些硬件攻击而言，规模并不重要。例如，黑客攻击一次就足以获得未加密的数字版权管理（DRM）系统视频副本，然后进行盗版，就像发射一次核导弹或解密总统的税务申报表一样。

### 攻击树

*攻击树*可视化了攻击者从攻击面到破坏资产能力的步骤，帮助我们系统地分析攻击策略。我们在攻击树中考虑的四个要素是攻击者、攻击、资产（安全目标）和对策（见图 1-5）。

![f01005](img/f01005.png)

图 1-5：威胁建模要素之间的关系

## 攻击者画像

画像攻击者非常重要，因为攻击者有动机、资源和限制。你可以说僵尸网络或蠕虫是没有动机的非人类玩家，但蠕虫的初始启动是由一个人按下回车键时的喜悦、愤怒或贪婪预期驱动的。

攻击者画像在很大程度上取决于特定设备所需的攻击类型。攻击本身决定了所需的设备和费用；这两个因素在一定程度上帮助画像攻击者。例如，政府想要解锁一部手机，这是一个代价高昂、动机强烈的攻击，动机可能是间谍活动或国家安全。

以下是一些常见的攻击场景，以及相应攻击者的动机、特征和能力：

**犯罪企业**

经济利益主要驱动着犯罪企业攻击。最大化利润需要规模化。正如之前所讨论的，硬件攻击可能是可扩展攻击的根源，这就需要一个设备齐全的硬件攻击实验室。例如，考虑对付费电视行业的攻击，海盗们有着合理的商业案例，能够 justify 数百万美元的设备投入。

**行业竞争**

在这个安全场景中，攻击者的动机可以从*竞争分析*（一个无害的委婉说法，用来形容逆向工程，看看竞争对手在做什么），到调查知识产权侵权，再到收集创意和灵感以改进自己的相关产品。通过破坏竞争对手的品牌形象进行间接破坏也是一种类似的手段。这类攻击者不一定是个人，可能是某个团队的一部分，受雇于（可能是地下的）或外部聘请的公司，他们拥有所需的硬件工具。

**国家级攻击者**

恶意破坏、间谍活动和反恐是常见的动机。国家级攻击者可能拥有所有必要的工具、知识和时间。引用詹姆斯·米肯斯的著名话语，如果摩萨德（以色列国家情报局）盯上了你，不管你采取什么反制措施，“你仍然会被摩萨德盯上。”

**道德黑客**

道德黑客可能构成威胁，但其风险有所不同。他们可能拥有硬件技能，并能访问家中的基本工具，或者在本地大学拥有昂贵的工具，使他们的装备和恶意攻击者一样强大。道德黑客被吸引去解决他们认为能带来改变的问题。他们可以是业余爱好者，驱动他们的是对事物工作原理的理解，或者是那些努力成为最好或者因其能力而著名的人。他们也可能是通过技能谋生的研究人员，或者是强烈支持或反对某些事业的爱国者或抗议者。道德黑客不一定没有风险。曾有一家智能锁制造商向我们抱怨，他们公司的一大担忧是最终成为道德黑客活动中的一个例子，他们认为这会影响品牌的信任度。实际上，大多数罪犯会使用砖块来“破解”锁具，所以锁具客户遭遇黑客攻击的风险很小，但“别担心，他们会用砖块而不是电脑”这种宣传口号，在公关活动中并不奏效。

**外行攻击者**

这种攻击者通常是个人或小团体，他们通过伤害其他个人、公司或基础设施来报复某些原因。然而，他们不一定具备足够的技术能力。其目标可能是通过敲诈或出售商业机密获得经济利益，或者仅仅是为了伤害他人。由于知识和预算的限制，这类攻击者成功进行硬件攻击的可能性通常较低。（对于所有外行人来说，请不要私信我们询问如何破解你前任的 Facebook 账号。）

确定潜在的攻击者并非易事，这取决于设备的类型。通常，当考虑到具体的产品而非产品的组件时，更容易识别攻击者类型。例如，黑客通过互联网攻击某品牌的 IoT 咖啡机，使其泡出较弱的咖啡，这一威胁可以与上述不同类型的攻击者相关联。随着设备供应链层次的提高，攻击者画像变得更加复杂。IoT 设备中的某个组件可能是由 IP 供应商提供的*高级加密标准（AES）*加速器。这个加速器集成在 SoC 中，再集成到 PCB 上，最终制造成设备。那么 AES 加速器的 IP 供应商如何识别使用该加速器的 1,001 种不同设备上的威胁呢？供应商需要更多地关注攻击类型，而不是攻击者（例如，通过实施抵御侧信道攻击的措施）。

在设计设备时，我们强烈建议你向组件供应商询问他们防范了哪些类型的攻击。没有这些知识的威胁建模无法做到彻底，更重要的是，如果不向供应商询问，他们也不会有动力改进他们的安全措施。

## 攻击类型

硬件攻击显然是针对硬件的，例如打开*联合测试行动组（JTAG）*调试端口，但它们也可能针对软件，例如绕过密码验证。本书不涉及软件对软件的攻击，但它确实涉及使用软件攻击硬件。

如前所述，攻击面是攻击者的起点——硬件和软件的直接可访问部分。考虑攻击面时，我们通常假设对设备有完全的物理访问权限。然而，处于 Wi-Fi 范围内（*近距离范围*）或通过任何网络连接（*远程*）也可以是攻击的起点。

攻击面可能从 PCB 开始，而一个更熟练的攻击者可能会通过去除封装和微探针技术将攻击面扩展到芯片，如本章后续所述。

### 硬件上的软件攻击

硬件上的软件攻击使用各种软件控制硬件或监控硬件。硬件上的软件攻击有两类子攻击：故障注入和侧信道攻击。

#### 故障注入

*故障注入*是将硬件推至导致处理错误的极限的做法。单独的故障注入并不是攻击；是故障的效果被利用后才会变成攻击。攻击者试图利用这些人为产生的错误。例如，他们可以通过绕过安全检查获得特权访问。故障注入并利用该故障效果的做法称为*故障攻击*。

*DRAM 击打*是一种著名的故障注入技术，其中 DRAM 内存芯片以一种不自然的访问模式轰击三个相邻的行。通过反复激活外部的两行，中心的*受害行*会发生位翻转。*Rowhammer 攻击*通过引发 DRAM 位翻转来利用受害行，导致这些行成为页表。*页表*是操作系统维护的结构，限制应用程序的内存访问。通过更改这些页表中的访问控制位或物理内存地址，应用程序可以访问通常无法访问的内存，这很容易导致特权提升。诀窍是调整内存布局，使得包含页表的受害行位于攻击者控制的行之间，然后从高级软件激活这些行。这种方法已在 x86 和 ARM 处理器上得到了验证，从低级软件到 JavaScript 都可以实现。有关更多信息，请参见 Victor van der Veen 等人所著的《Drammer: Deterministic Rowhammer Attacks on Mobile Platforms》。

*CPU 超频*是另一种故障注入技术。超频 CPU 会导致一种暂时性故障，称为*时序故障*。这种故障可能表现为 CPU 寄存器中的位错误。*CLKSCREW*就是一个 CPU 超频攻击的例子。由于手机上的软件可以控制 CPU 频率以及核心电压，通过降低电压并短暂提高 CPU 频率，攻击者可以诱使 CPU 发生故障。通过正确地把握时机，攻击者可以在 RSA 签名验证中制造故障，从而加载不正确签名的任意代码。更多信息，请参见 Adrian Tang 等人所著的《CLKSCREW: Exposing the Perils of Security-Oblivious Energy Management》。

你可以在任何软件能够迫使硬件超出正常操作参数的地方找到这些漏洞。我们预计未来会继续出现更多变种。

#### 辅助通道攻击

软件时序与处理器完成软件任务所需的墙钟时间有关。通常，任务越复杂，需要的时间越长。例如，排序 1000 个数字比排序 100 个数字需要更多的时间。攻击者利用软件执行时间作为攻击手段并不意外。在现代嵌入式系统中，攻击者很容易测量执行时间，甚至精确到一个时钟周期的分辨率！这就导致了*时序攻击*，攻击者试图将软件执行时间与内部秘密信息的值关联起来。

例如，C 语言中的`strcmp`函数用于判断两个字符串是否相同。它逐个比较字符，从前到后，当遇到不同的字符时，就会终止。在使用`strcmp`将输入的密码与存储的密码进行比较时，`strcmp`的执行时长泄露了密码的一些信息，因为它会在找到攻击者提供的密码与保护设备的密码之间的第一个不匹配字符时终止。因此，`strcmp`的执行时间泄露了密码中最初正确字符的数量。（我们在第八章中详细介绍了这种攻击，并在第十四章中描述了正确实现这种比较的方法。）

*RAMBleed*是另一种可以通过软件发起的侧信道攻击，Kwong 等人在《RAMBleed：在不访问内存的情况下读取内存中的比特》一文中展示了这种攻击。它利用了类似 Rowhammer 的漏洞来从 DRAM 中读取比特。在 RAMBleed 攻击中，翻转发生在攻击者的行中，基于受害者行中的数据。通过这种方式，攻击者可以观察到另一个进程的内存内容。

#### 微架构攻击

现在你已经理解了时序攻击的原理，请考虑以下内容。现代 CPU 之所以快速，是因为多年来已经识别并实施了大量优化。例如，缓存是基于这样一个前提：最近访问的内存位置很可能会再次被访问。因此，这些内存位置的数据会物理上更靠近 CPU，以便更快地访问。另一个优化的例子源自这样一个见解：将一个数字*N*与 0 或 1 相乘的结果是显而易见的，因此不需要进行完整的乘法计算，因为答案始终是 0 或*N*。这些优化是*微架构*的一部分，微架构是指指令集的硬件实现。

然而，优化速度和安全性常常是对立的。如果某些与机密值相关的优化被启用，可能会泄露数据中的某些值。例如，如果某个未知的*K*值的*N*次*K*乘法有时比其他时候更快，那么在速度较快的情况下，*K*值可能是 0 或 1。或者，如果某个内存区域被缓存，它的访问速度会更快，因此快速访问意味着该区域最近被访问过。

恶名昭彰的*Spectre*攻击源自 2018 年，利用了一种称为*预测执行*的巧妙优化。计算是否应该执行条件分支需要时间。预测执行并不等待分支条件被计算出来，而是猜测分支条件并像猜测正确一样执行下一条指令。如果猜测正确，执行就继续进行；如果猜测错误，执行将被回滚。然而，这种预测执行仍然会影响 CPU 缓存的状态。Spectre 迫使 CPU 执行一种预测操作，影响缓存的方式依赖于某些秘密值，然后使用缓存定时攻击恢复该秘密。正如 Paul Kocher 等人在《Spectre 攻击：利用预测执行》中所展示的那样，我们可以在一些现有或自制的程序中使用这个技巧，转储受害进程的整个进程内存。更大的问题是，处理器在过去几十年中一直以这种方式进行速度优化，并且还有许多类似的优化可能被利用。

### PCB 级攻击

PCB 通常是设备的初始攻击面，因此攻击者必须尽可能多地从 PCB 设计中获取信息。设计提供了有关在哪里接入 PCB 的线索，或者揭示了更好的攻击点。例如，要重新编程设备的固件（可能完全控制设备），攻击者首先需要在 PCB 上识别固件编程端口。

对于 PCB 级攻击，访问许多设备所需的工具只是一把螺丝刀。一些设备实现了物理防篡改和篡改响应，例如通过 FIPS（联邦信息处理标准）140 级 3 或 4 认证的设备或支付终端。虽然这本身是一个有趣的运动，但绕过防篡改措施并接触到电子设备超出了本书的范围。

一个 PCB 级攻击的例子是利用通过*跳线*将某些引脚拉高或拉低来配置 SoC 选项。这些跳线在 PCB 上以 0Ω（零欧姆）电阻的形式显示（见图 1-6）。这些 SoC 选项可能包括启用调试、无签名检查启动或其他与安全相关的设置。

![f01006](img/f01006.png)

图 1-6：零欧姆电阻（R29 和 R31）

添加或移除跳线以改变配置非常简单。尽管现代多层 PCB 和表面贴装设备使得修改更加复杂，但只需要一只稳健的手、一台显微镜、一把镊子、一只热风枪，最重要的是耐心，就能完成这项任务。

PCB 级别的另一个有用攻击是读取 PCB 上的闪存芯片，通常它包含设备中运行的大部分软件，揭示了一个宝贵的信息宝库。虽然一些闪存设备是只读的，但大多数允许你对其进行写入关键更改，从而移除或限制安全功能。闪存芯片可能通过某种访问控制机制强制执行只读权限，而这种机制可能容易受到故障注入攻击。

对于设计时考虑到安全性的系统，闪存的更改应该导致系统无法启动，因为闪存镜像需要包含有效的数字签名。有时，闪存镜像是被打乱或加密的；前者可以被逆向（我们曾看到过简单的异或运算），后者需要获取密钥。

我们将在第三章中更详细地讨论 PCB 逆向工程，并在讨论与真实目标接口时讨论时钟和电源的控制。

### 逻辑攻击

*逻辑攻击*是在逻辑接口层面上进行的（例如，通过现有的 I/O 端口进行通信）。与 PCB 级别的攻击不同，逻辑攻击不在物理层面上工作。逻辑攻击针对嵌入式设备的软件或固件，并试图在不进行物理入侵的情况下突破安全性。你可以把它比作通过发现设备的所有者（软件）习惯于将后门（接口）保持解锁而闯入房屋（设备），因此无需破解锁具。

著名的逻辑攻击围绕着内存损坏和代码注入展开，但逻辑攻击的范围要广得多。例如，如果调试控制台仍然可用，并且连接在电子锁的隐藏串行端口上，发送“解锁”命令可能会触发锁定打开。或者，如果设备在低功耗状态下关闭一些对策，注入低电池信号可以禁用这些安全措施。逻辑攻击针对设计错误、配置错误、实现错误或可以被滥用的功能，从而突破系统的安全性。

#### 调试和追踪

在 CPU 的设计和制造过程中，内置的最强大控制机制之一是硬件调试和追踪功能。这通常在*联合测试行动小组（JTAG）*或*串行线调试（SWD）*接口之上实现。图 1-7 显示了一个暴露的 JTAG 头。

请注意，在安全设备上，保险丝、PCB 带或某些专有的秘密代码或挑战/响应机制可以关闭调试和追踪功能。可能只有在较不安全的设备上移除 JTAG 头（关于 JTAG 的更多内容将在后续章节中讨论）。

![f01007](img/f01007.png)

图 1-7：带有暴露 JTAG 头的 PCB。通常，它不像这个例子中那样标签明确！

#### 模糊测试设备

*模糊测试*是一种借鉴自软件安全领域的技术，旨在专门识别代码中的安全问题。模糊测试的典型目标是寻找崩溃点，以便利用漏洞进行代码注入。*愚蠢模糊测试*即向目标发送随机数据并观察其行为。健壮和安全的目标在这种攻击下通常会保持稳定，但不够健壮或不够安全的目标可能会表现出异常行为或崩溃。崩溃转储或调试器检查可以准确定位崩溃源和可利用性。*智能模糊测试*则专注于协议、数据结构、典型的崩溃引发值或代码结构，更有效地生成*边界情况*（通常不应发生的情况），这些情况可能会导致目标崩溃。*基于生成的模糊测试*从头开始创建输入，而*基于变异的模糊测试*则修改现有输入。*基于覆盖率的模糊测试*使用额外的数据（例如，关于特定输入执行时哪些程序部分被触及的覆盖信息）来帮助你发现更深层次的 bug。

你也可以将模糊测试应用于设备，尽管与对软件进行模糊测试相比，这会面临更加具有挑战性的情况。对于设备模糊测试，通常很难获取软件覆盖信息，因为你可能对运行在设备上的软件控制较少。通过外部接口进行模糊测试而没有进一步控制设备的能力，会导致无法获取覆盖信息，在某些情况下，这样做会使得确认是否发生了损坏变得困难。最后，模糊测试在能够以高速进行时最为有效。在软件模糊测试中，通常每秒可以进行成千上万甚至百万次测试。在嵌入式设备上实现这样的性能并非易事。*固件重托管*是一种技术，它将设备的固件放入可以在 PC 上运行的仿真环境中。这解决了设备内模糊测试中的大多数问题，代价是需要创建一个有效的仿真环境。

#### 闪存镜像分析

大多数设备包含与主 CPU 外部连接的闪存芯片。如果设备支持软件升级，通常可以在互联网上找到固件镜像。一旦你获得了镜像文件，就可以使用各种闪存镜像分析工具，如*binwalk*，帮助识别镜像中的各个部分，包括代码段、数据段、文件系统以及数字签名。

最后，拆解和反编译各种软件镜像对于确定潜在的漏洞非常重要。关于设备固件的静态分析（如符号执行）也有一些初步的有趣工作。请参阅 Nilo Redini 等人撰写的《BootStomp: 移动设备引导程序安全性研究》。

### 非侵入性攻击

非侵入性攻击不会物理修改芯片。侧信道攻击利用系统某些可测量的行为来泄露秘密（例如，通过测量设备的功耗来提取 AES 密钥）。故障攻击通过故障注入进入硬件来绕过安全机制；例如，一个强大的电磁（EM）脉冲可以禁用密码验证测试，使其接受任何密码。（本书第四章和第五章专门讨论这些主题。）

### 芯片侵入性攻击

这一类攻击以封装或封装内的硅为目标，因此操作的尺度非常微小——即电线和门级。进行这些操作需要比我们目前讨论的更加复杂、先进且昂贵的技术和设备。这些攻击超出了本书的范围，但我们可以简要了解高级攻击者可以做些什么。

#### 去封装、去包装和重新连接

*去封装*是通过化学战手段去除一些集成电路（IC）封装材料的过程，通常是将烟雾状的硝酸或硫酸滴在芯片封装上，直到其溶解。结果是封装上留下一个孔，可以通过这个孔检查微芯片本身，如果操作得当，芯片仍然可以正常工作。

在*去封装*过程中，你将整个封装浸入酸中，之后芯片的整个内部被暴露出来。你需要重新连接芯片，以恢复其功能，这意味着需要重新连接通常将芯片与封装引脚连接的小金属线（见图 1-8）。

![f01008](img/f01008.png)

图 1-8：去封装的芯片，显示了暴露的连接线（Travis Goodspeed，CC BY 2.0 许可）

尽管芯片在过程中可能会损坏，但已损坏的芯片对于成像和光学逆向工程是可以使用的。然而，对于大多数攻击，芯片必须是活的。

#### 微观成像与逆向工程

一旦芯片暴露出来，第一步是识别芯片的较大功能模块，特别是找到感兴趣的模块。图 1-2 展示了其中的一些结构。芯片上的最大模块通常是内存，比如用于 CPU 缓存或紧耦合内存的静态 RAM（SRAM），以及用于启动代码的 ROM。任何长而几乎直的线条都是连接 CPU 和外设的总线。仅仅了解相对尺寸以及各种结构的外观，就能开始逆向工程芯片。

当芯片去封装时，如图 1-8 所示，你只能看到顶层金属层。要逆向工程整个芯片，你还需要*剥层*，即通过打磨掉芯片的金属层以暴露其下层。

图 1-9 显示了一个*互补金属氧化物半导体（CMOS）*芯片的横截面，这是大多数现代芯片的构建方式。如你所见，一些层和铜金属的通孔最终连接了晶体管（多晶硅/基板）。最底层的金属用于创建*标准单元*，这些单元是通过多个晶体管创建逻辑门（与、异或等）的元素。顶层金属通常用于电源和时钟布线。

![f01009](img/f01009.png)

图 1-9：CMOS 的横截面

图 1-10 显示了典型芯片内部不同层的照片。

![f01010](img/f01010.png)

图 1-10：CMOS 芯片内部的不同层（图片由 Christopher Tarnovsky 提供，邮箱：[semiconductor.guru@gmail.com](http://mailto:semiconductor.guru@gmail.com)）

良好的芯片成像可以让你从图像或启动 ROM 的二进制转储中重建网表。*网表*本质上是对所有逻辑门连接方式的描述，涵盖了设计中的所有数字逻辑。网表和启动 ROM 转储都可以帮助攻击者找到代码或芯片设计中的弱点。Chris Gerlinsky 的《来自矩阵的比特：光学 ROM 提取》和 Olivier Thomas 的《集成电路攻防安全》，分别在 Hardwear.io 2019 大会上展示，提供了该主题的良好介绍。

#### 扫描电子显微镜成像

*扫描电子显微镜（SEM）*使用电子束对目标进行光栅扫描，并通过电子探测器测量扫描目标的图像，分辨率优于 1 纳米，允许你成像单个晶体管和电线。与显微镜成像一样，你可以从图像中创建网表。

#### 光学故障注入与光学发射分析

一旦芯片表面可见，就可以“与光子玩乐”。由于一种叫做*热载流子发光*的效应，开关晶体管偶尔会发射光子。使用像业余天文爱好者常用的红外敏感*电荷耦合器件（CCD）*传感器，或者如果你想要更先进的设备，可以使用*雪崩光电二极管（APD）*，你可以检测到活跃的光子区域，这有助于反向工程过程（更具体地说是侧信道分析），例如将秘密密钥与光子测量相关联。见 Alexander Schlösser 等人的《AES 的简单光子发射分析：为我们普通人提供的光子侧信道分析》。

除了使用光子观察过程外，你还可以通过改变门的导电性来注入故障，这被称为*光学故障注入*（有关更多细节，请参见第五章和附录 A）。

#### 集中离子束编辑与微探针

*聚焦离子束（FIB）*，发音为“fib”，使用离子束在纳米级别上切削芯片部分或向芯片上沉积材料，使攻击者能够切断芯片线路、重定向芯片线路，或为微探测创建探针垫。FIB 编辑需要时间和技术（以及昂贵的 FIB 设备），但正如你所想象的那样，若攻击者能够定位它们，这种编辑能够绕过许多硬件安全机制。图 Figure 1-11 中的数字展示了 FIB 为了访问下层金属层而创建的孔。这些孔周围的“帽子”结构是为了绕过主动屏蔽对策而创建的。

*微探测*是一种用来测量或向芯片线路注入电流的技术，对于较大特征尺寸的芯片，可能不需要 FIB 探针垫。执行这些攻击的技能是必要的，虽然一旦攻击者具备了进行此类攻击的资源，在这个层次上保持安全是异常困难的。

![f01011](img/f01011.png)

图 1-11：多个 FIB 编辑以促进微探测（图片由 Christopher Tarnovsky 提供， [semiconductor.guru@gmail.com](http://mailto:semiconductor.guru@gmail.com)）

我们已经在这里讨论了多种与嵌入式系统相关的攻击。请记住，任何单一攻击都足以危及系统。然而，攻击的成本和技能差异非常大，因此一定要明白你所需要的安全目标是什么。抵抗一个拥有百万美元预算的攻击者和抵抗一个拥有 25 美元及这本书副本的攻击者，是完全不同的挑战。

## 资产与安全目标

在考虑设计进产品中的资产时，应该问自己：“我真正关心的资产是什么？”攻击者也会问同样的问题。资产的防守者可能会对这个看似简单的问题给出一系列不同的回答。公司的 CEO 可能会关注品牌形象和财务健康。首席隐私官关注消费者私密信息的机密性，而常驻的密码学家则对秘密密钥材料感到极度敏感。所有这些回答都是相互关联的。如果密钥被暴露，客户隐私可能会受到影响，进而影响品牌形象，最终威胁到整个公司的财务健康。然而，在每个层次上，保护机制是不同的。

一个资产也代表了攻击者的价值。到底什么是有价值的，取决于攻击者的动机。它可能是一个漏洞，使得攻击者可以将代码执行漏洞卖给其他攻击者。所需的资产可能是信用卡信息或受害者的支付密钥。企业世界中的动机可能是恶意地针对竞争对手的品牌。

在进行威胁建模时，需要分析攻击者和防御者的角度。就本书而言，我们仅限于分析设备上的技术资产，因此我们假设我们的资产是表示为目标设备上某个比特序列的内容，这些内容需要保持保密并保护完整性。*保密性*是指保持资产对攻击者隐藏的特性，而*完整性*是指不允许攻击者修改资产的特性。

作为一个安全爱好者，你可能会好奇为什么我们没有提到可用性。*可用性*是指保持系统响应和功能性的特性，这对于数据中心和处理安全的系统（如工业控制系统和自动驾驶汽车）尤其重要，因为在这些系统中，功能中断是不能发生的。

只有在设备无法被物理访问的情况下（例如通过网络和互联网进行访问），防御资产可用性才有意义。使这类服务不可用是拒绝服务攻击的目的，旨在使网站瘫痪。对于嵌入式设备来说，妥协可用性是微不足道的：只需将其关闭，敲击它，或把它炸掉。

*安全目标*是指你希望如何保护所定义的资产，防范哪些类型的攻击和攻击者，以及保护多久。定义安全目标有助于将设计重点集中在应对预期威胁的策略上。由于许多可能的情景，必然会发生权衡，尽管我们意识到没有一刀切的解决方案，但接下来我们将给出一些常见的示例。

尽管不太常见，但设备强项和弱点的规格说明是供应商安全成熟度的明显标志。

### 二进制代码的保密性和完整性

通常，对于二进制代码，主要目标是保护完整性，确保设备上运行的代码就是作者意图的代码。完整性保护限制了代码的修改，但也带来了双刃剑的效果。强大的完整性保护可能会将设备锁定，使其所有者无法使用，限制可运行的代码。一整个黑客社区试图绕过这些机制，在游戏机上运行他们自己的代码。另一方面，完整性保护确实有意外的好处，可以防止恶意软件感染引导链、游戏盗版或政府安装后门。

保密性作为一种安全目标的目的是使复制知识产权（例如数字内容）或寻找固件中的漏洞变得更加困难。后者还使得真正的安全研究人员更难发现和报告漏洞，同时也使攻击者更难利用这些漏洞。（有关这一复杂困境的更多内容，请参见第 33 页的“披露安全问题”部分。）

### 密钥的保密性和完整性

加密学将数据保护问题转化为密钥保护问题。实际上，密钥通常比完整的数据块更容易保护。在威胁建模中，需要注意的是，现在有两个资产：明文数据和密钥本身。因此，将密钥的机密性作为目标，通常与所保护数据的机密性密切相关。

例如，当公钥存储在设备上进行身份验证检查时，完整性非常重要：如果攻击者能够将原始公钥替换为自己的密钥，他们就可以签署任何数据，使其通过设备上的签名验证。然而，完整性并非总是密钥的目标；例如，如果密钥的目的是解密存储的数据块，那么修改密钥只会导致无法执行解密操作。

另一个有趣的方面是如何将密钥安全地注入设备或在制造阶段生成密钥。一个选项是加密或签名密钥本身，但这又涉及到另一个密钥。这就像是“乌龟背上的乌龟”，一直往下延伸。在系统的某个地方存在一个*信任根*，一个我们必须信任的密钥或机制。

一种典型的解决方案是在初始密钥生成或密钥注入过程中信任制造过程。例如，*受信任平台模块（TPM）*规范 v2.0 要求一个*背书主种子（EPS）*。这个 EPS 是每个 TPM 的唯一标识符，用于推导一些主密钥材料。根据规范，这个 EPS 必须在制造过程中注入 TPM 或在 TPM 上创建。

这种做法确实限制了密钥材料的暴露，但它在制造设施中为密钥材料创建了一个关键的集中收集点。尤其是密钥注入系统必须得到良好的保护，以避免泄露此系统配置的*所有*部件的密钥。最佳做法是进行设备上的密钥生成，这样制造设施就不会访问所有密钥，同时采用秘密分割，确保制造过程中不同阶段注入或生成不同部分的密钥材料。

### 远程启动验证

*启动认证*是通过加密方式验证系统是否确实从真实的固件映像启动的能力。*远程启动认证*是指能够远程进行此验证的能力。认证涉及两方：*证明者*旨在向*验证者*证明系统的某些*度量*未被篡改。例如，您可以使用远程启动认证来允许或拒绝设备访问企业网络，或决定是否为设备提供在线服务。在后一种情况下，设备是证明者，在线服务是验证者，而度量则是启动过程中使用的配置数据和（固件）映像的哈希值。为了证明这些度量未被篡改，它们会在启动阶段使用私钥进行数字签名。验证者可以将签名与允许或阻止列表进行比对，并应具备验证用于创建签名的私钥的方法。验证者能够检测篡改行为，并确保远程设备没有运行过时且可能存在漏洞的启动映像。

和往常一样，这会带来一些实际问题。首先，验证者必须能够以某种方式信任证明者的签名密钥——例如，通过信任一个包含证明者公钥的证书，该证书由某个可信的权威机构签署。在最理想的情况下，这个权威机构已经能够在制造过程中建立起信任，如前文所述。第二，启动映像和数据的覆盖范围越广，现场的配置就会越多。这意味着允许所有*已知良好*配置变得不可行，因此必须转而阻止*已知不良*配置。然而，确定*已知不良*配置并非易事，通常只有在检测到修改并进行分析之后才能完成。

请注意，启动认证仅保护被哈希以验证真实性的启动时组件。它并不防范运行时攻击，如代码注入。

### 个人身份信息的机密性与完整性

*个人身份信息（PII）*是能够识别个体的数据。显而易见的数据包括姓名、手机号码、地址和信用卡号码，但不太显而易见的数据可能是可穿戴设备中记录的加速度计数据。当安装在设备上的应用程序外泄这些信息时，PII 的机密性就成为问题。例如，描述一个人步态的加速度计数据可以用来识别此人：请参见 Hoang Minh Thang 等人撰写的《使用手机加速度计进行步态识别》。手机电池消耗数据可以根据手机与基站的距离，通过分析手机的电池消耗模式来定位某人的位置，具体请参见 Yan Michalevsky 等人撰写的《PowerSpy：基于移动设备功耗分析的定位追踪》。

医疗领域对 PII 也有相关法规。1996 年的《健康保险可携带性与责任法案 (HIPAA)》是美国的一部法律，重点关注医疗信息的隐私保护，并适用于处理患者 PII 的任何系统。HIPAA 对技术安全有相对不具体的要求。

PII 数据的完整性至关重要，以避免冒充。在银行智能卡中，密钥材料与账户关联，因此也与身份关联。EMVCo（一个信用卡联盟）有非常明确的技术要求，与 HIPAA 不同。例如，密钥材料必须能够防御逻辑攻击、旁道攻击和故障攻击，并且这种保护需要通过经认证实验室进行实际攻击来证明。

### 传感器数据的完整性和保密性

你刚刚学习了传感器数据如何与 PII 相关。完整性必须很重要，因为设备需要准确地感知和记录其环境。当系统使用传感器输入控制执行器时，这一点尤为重要。一个很好的（尽管存在争议的）例子是，美国 RQ-170 无人机被迫在伊朗着陆，据信是因为其 GPS 信号被伪造，使其误以为自己正在阿富汗的美国基地着陆。

当设备使用某种形式的人工智能进行决策时，决策的完整性会受到名为 *对抗机器学习* 的研究领域的挑战。一个例子是通过人为修改停车标志的图片来利用神经网络分类器的弱点。对人类来说，这种修改是不可察觉的，但当使用标准的图像识别算法时，这张图片可能会变得完全无法识别，而事实上它应该是可以识别的。虽然神经网络的识别可能会受到阻碍，但现代的自动驾驶汽车有一个包含标志位置的数据库，它们可以回退使用，因此在这种特定情况下，这不应该构成安全问题。Nicolas Papernot 等人在《实用的黑箱攻击：对机器学习的攻击》一文中提供了更多细节。

### 内容保密保护

内容保护归结为确保人们为其消费的媒体内容付费，并且他们遵守一些许可限制，如日期和地理位置，使用 *数字版权/限制管理（DRM）*。DRM 主要依赖于加密数据流，以便在设备之间传输内容，并且依赖于设备内部的访问控制逻辑来拒绝软件访问明文内容。对于移动设备，大多数保护要求集中在软件攻击上，而对于机顶盒，保护要求则包括旁道攻击和故障攻击。因此，机顶盒被认为更难攻破，并且用于更高价值的内容。

### 安全性和韧性

*安全性* 是指不对他人（例如人类）造成伤害的特性，而 *韧性* 是指在发生（非恶意）故障时保持运行的能力。例如，卫星中的微控制器将会受到强烈辐射的影响，这种辐射会导致所谓的 *单粒子翻转（SEU）*。SEU 会翻转芯片状态中的比特，可能导致其决策出现错误。韧性解决方案是检测这种错误并进行修正，或者检测并重置到已知的良好状态。这种韧性不一定是安全的；它给了试图进行故障注入的攻击者无限的尝试机会，因为系统会持续接受滥用。

同样，在传感器检测到恶意活动时，立即关闭自动驾驶车辆的控制单元并不安全，尤其是在高速公路行驶时。首先，任何检测器都可能产生误报；其次，这样做可能允许攻击者利用传感器危害所有乘客。与所有目标一样，这个问题使产品开发者面临安全与安全性/韧性之间的权衡。韧性和安全性不同于安全性，有时它们与安全性相冲突。对攻击者来说，这意味着由于出于保护安全或增强韧性的良好意图，可能会给他们提供机会去破坏设备。

## 对策

我们将 *对策* 定义为任何（技术性的）手段，旨在减少攻击成功或影响的概率。对策有三个功能：保护、检测和响应。（我们将在第十四章进一步讨论一些对策。）

### 保护

这一类对策旨在避免或减轻攻击。一个例子是加密闪存的内容，防止窥探。如果密钥隐藏得很好，它能提供几乎无法破解的保护。其他保护措施则提供部分保护。如果单条 CPU 指令的损坏会导致可利用的故障，通过随机化关键指令的时序（跨越五个时钟周期），攻击者仍有 20% 的概率能击中它。某些保护措施可能会被完全绕过，因为它们仅对特定类型的攻击提供保护（例如，侧信道对策并不防止代码注入）。

### 检测

这一类对策需要硬件检测电路或软件中的检测逻辑。例如，你可以监测芯片的电源供应，观察电压峰值或下降，这些可能表明发生了电压故障攻击。你也可以使用软件来检测异常状态。例如，持续分析网络流量或应用日志的系统可以检测攻击。其他常见的异常检测技术包括验证所谓的堆栈金丝雀、检测已被访问的保护页、查找没有匹配的 case 的 switch 语句，以及检测内部变量的循环冗余校验（CRC）错误，等等。

### 响应

检测没有响应是没有太大意义的。响应的类型取决于设备的使用场景。对于像支付智能卡这样的高安全性设备，检测到攻击时擦除所有设备的机密信息（实际上是自我施加拒绝服务攻击）是明智的做法。而在必须继续运行的安全关键系统中，这种做法就不太适合。在这些情况下，回拨电话或回退到受限但安全的模式是更合适的响应。对于人为攻击者，另一个被低估但有效的响应是让他们失去生存意志（例如，通过重置设备并逐渐延长启动时间）。

防御措施对于构建安全系统至关重要，特别是在硬件方面，物理攻击可能完全无法防护时，增加检测与响应通常能够提升难度，超过攻击者愿意付出的代价，甚至超出他们能够做到的范围。

## 一个攻击树示例

现在我们已经描述了有效威胁建模所需的四个要素，让我们从一个例子开始，在这个例子中，我们作为攻击者，希望通过破解物联网牙刷来提取机密信息，并（仅仅为了好玩）将刷牙速度提高到 9 位牙医中 10 位都不赞成的程度（但最后一位牙医却乐于接受这种挑战）。

在我们的示例攻击树中，如图 1-12 所示，包含以下内容：

+   圆形框表示攻击者所处的状态或攻击者已攻破的资产（“名词”）。

+   方框表示攻击者已成功执行的攻击（“动词”）。

+   实心箭头表示前述状态与攻击之间的因果流动。

+   虚线箭头表示通过某些防御措施已被缓解的攻击。

+   多条传入箭头表示“任何一条箭头都可以导致此结果”。

+   “和”三角形表示所有传入的箭头必须满足。

攻击树中的数字标记了牙刷攻击的各个阶段。作为攻击者，我们拥有对一把物联网牙刷的物理访问权限（1）。我们的任务是向牙刷上安装一个 telnet 后门，以确定设备上存在的个人身份信息（PII）（8），并且让牙刷以超高速运行（11）。

![f01012](img/f01012.png)

图 1-12：物联网牙刷攻击树

小写字母表示攻击，罗马数字表示缓解措施。我们做的第一件事是将闪存拆下来并读取内容——所有 16MB 的内容（a）。然而，我们发现该镜像没有可读的字符串。经过一些熵分析后，内容似乎是加密或压缩的，但由于没有头部信息标识压缩格式，我们假设该内容如攻击（2）和缓解措施（i）所示，是加密的。为了进行解密，我们需要加密密钥。它似乎并未存储在闪存中，这是缓解措施（ii）所示的情况，因此它很可能存储在 ROM 或熔丝中。由于我们无法访问扫描电子显微镜，因此无法“从硅片中读取它们”。

相反，我们决定进行功率分析。我们连接一个功率探测器和示波器，并在系统启动时获取功率跟踪数据。跟踪图显示大约有一百万个小峰值。通过从闪存读取数据得知图像为 16MB，我们推测每个峰值对应 16 字节的加密数据。我们假设这是一种 AES-128 加密，可能使用常见的*电子密码本（ECB）*或*密码块链接（CBC）*模式。*ECB*是一种每个块独立解密的模式，而*CBC*则是一种后续块的解密依赖于前面块的模式。由于我们知道固件镜像的密文，我们可以基于测量到的峰值尝试进行功率分析攻击。在对跟踪数据进行大量预处理并进行差分功率分析（DPA）攻击（b）后，我们成功识别出了一个可能的密钥候选项。（别担心，你会在本书后续章节中了解什么是 DPA。）使用 ECB 解密得到的内容是垃圾数据，但 CBC 模式下我们得到了几个可读字符串，在攻击（c）阶段；看起来我们在阶段（3）找到了正确的密钥，并在阶段（4）成功解密了图像！

从解密后的镜像中，我们可以使用传统的软件逆向工程（g）技术来识别各个代码块的功能、数据存储位置、执行器如何驱动，以及从安全角度来看，如何寻找代码中的漏洞（9）。进一步地，我们在阶段（d）修改解密后的镜像，加入一个后门，使我们可以远程通过 Telnet 进入牙刷（5）。

我们重新加密图像并在攻击(d)中闪存它，结果发现牙刷无法启动。我们遇到的很可能是固件签名验证问题。如果没有用来签署图像的私钥，我们无法运行经过修改的图像，这是由于缓解措施(iii)的存在。一种常见的对抗这种反制措施的攻击是电压故障注入。通过故障注入，我们的目标是破坏负责决定是否接受或拒绝固件图像的那条指令。通常这是一个比较操作，使用从`rsa_signature_verify()`函数返回的布尔结果。由于这段代码是实现于 ROM 中，我们无法通过逆向工程获取有关实现的详细信息。因此，我们尝试一个老技巧——在未修改的图像启动时获取侧信道追踪，并将其与攻击(e)中启动修改后图像的侧信道追踪进行对比。追踪差异的地方很可能是引导代码决定是否接受固件图像的时刻，位于阶段(6)。我们在这一瞬间生成一个故障，尝试修改决策。

我们加载恶意图像，并在攻击的 5 微秒窗口内随机某一点将电压降低几百纳秒（见图(f)），大约是在我们确定决策已作出时的瞬间。经过几小时的反复攻击，我们终于运气好，牙刷成功加载了我们的恶意图像，进入了阶段(7)。现在，经过修改的代码允许我们 telnet 登录，我们达到了阶段(8)，在这里我们可以远程控制刷牙操作并监视任何刷牙使用情况。而在最后一个有趣的阶段(11)，我们将速度调至极限！

这显然是一个愚蠢的例子，因为获取的信息和访问权限可能不足以对一个严肃的攻击者产生足够的价值；进行侧信道和故障攻击需要物理接触，并且设备所有者进行重置会导致服务拒绝。然而，这是一次启发性的练习，玩这些玩具场景总是值得的。

在绘制攻击树时，很容易失控，导致树变得非常庞大。记住，攻击者可能只会尝试一些最简单的攻击（这个工具可以帮助识别这些攻击）。请专注于相关攻击，这些攻击可以通过在威胁建模中提前分析攻击者和攻击能力来确定。

### 身份识别与利用

牙刷攻击路径集中在攻击的*识别* *阶段*，通过找到密钥、逆向固件、修改镜像并发现故障注入点来进行。记住，利用阶段是通过访问多个设备来扩展攻击。当在另一个设备上重复攻击时，可以重用识别阶段获得的许多信息。后续的攻击结果只需要在第（5）阶段的攻击（d）中刷写一个镜像，在第（6）阶段知道故障注入点，并通过攻击（f）产生故障。利用的努力总是低于识别的努力。在某些创建攻击树的形式中，每个箭头都会注释攻击的成本和努力，但在这里我们避免过多涉及定量风险建模。

### 可扩展性

牙刷攻击并不可扩展，因为利用阶段需要物理访问。对于 PII 或远程激活，通常只有在可以大规模实施的情况下，攻击者才会对此感兴趣。

然而，假设在我们的逆向工程攻击（g）中，第（9）阶段成功识别出一个漏洞，我们在第（10）阶段创建了一个利用工具。我们发现该漏洞通过开放的 TCP 端口可访问，因此攻击（j）可以远程利用这个漏洞。这立即改变了攻击的整个规模。通过在识别阶段使用硬件攻击，我们在利用阶段（12）可以仅依赖远程软件攻击。现在，我们可以攻击任何牙刷，获取任何人的刷牙习惯，并在全球范围内刺激牙龈。真是活在一个令人兴奋的时代。

### 分析攻击树

攻击树有助于可视化攻击路径，以便团队讨论、识别可以构建额外对策的节点，并分析现有对策的有效性。例如，可以很容易地看到，通过固件镜像加密（i）减缓了攻击者，迫使其使用侧信道攻击（b），这种方式比直接读取内存更加困难。同样，固件镜像签名（iii）的防护措施也迫使攻击者使用故障注入攻击（f）。

然而，主要的风险仍然是通过利用（j）进行的可扩展攻击路径，这种攻击当前没有得到缓解。显然，应该修补漏洞，引入防止利用的对策，并设置网络限制，禁止任何人远程直接连接到牙刷。

### 硬件攻击路径评分

除了可视化攻击路径以进行分析外，我们还可以加入一些量化因素，来评估哪些攻击对攻击者来说更容易或更便宜。在这一部分，我们介绍了几种行业标准的评级系统。

*通用漏洞评分系统（CVSS）*试图为漏洞的严重性打分，通常用于组织中网络化计算机的情境。它假设漏洞已知，并尝试评估如果该漏洞被利用会造成多大影响。*通用弱点评分系统（CWSS）*量化了系统中的弱点，但这些弱点不一定是漏洞，也不一定是在网络化计算机的情境中。最后，*联合解释库（JIL）*用于在通用准则（CC）认证方案中评分（硬件）攻击路径。

所有这些评分方法都有各种参数和每个参数的分数，所有这些参数和分数共同构成了一个最终的总分，以帮助比较不同的漏洞或攻击路径。这些评分方法的一个优点是，它们通过分数代替了关于参数的模糊讨论，分数的意义仅限于评分方法的目标上下文。表 1-1 提供了三个评分标准的概述及其适用范围。

表 1-1：攻击评分系统概览

|  | **通用漏洞评分系统** | **通用弱点评分系统** | **通用准则联合解释库** |
| --- | --- | --- | --- |
| **目的** | 帮助组织进行漏洞管理流程 | 优先解决软件弱点，满足政府、学术界和工业界的需求 | 评分攻击以通过/未通过 CC 评估 |
| **影响** | 区分机密性/完整性/可用性 | 技术影响 0.0–1.0，获得的权限（层级） | 不适用 |
| **资产** **价值** | 不适用 | 业务影响 0.0–1.0 | 不适用 |
| **识别** **成本** | 假设识别已经完成 | 被发现的可能性 | 识别阶段的评分，包括时间流逝、专业知识、知识、访问权限、设备和开放样本 |
| **利用** **成本** | 各种因素；没有硬件方面 | 各种因素；没有硬件方面 | 利用阶段评分 |
| **攻击** **向量** | 四个级别，从物理到远程 | 级别 0.0–1.0，从物理到互联网 | 假设攻击者物理在场 |
| **外部** **缓解措施** | “修改”类别包括缓解措施 | 外部控制效果 | 无外部缓解措施 |
| **可扩展性** | 并不完全是，有些相关方面 | 并不完全是，有些相关方面 | 低利用成本可能意味着可扩展性 |

在防御情境下，你可以使用评分来判断攻击发生后的影响，以决定如何应对攻击。例如，如果在某个软件中发现了漏洞，CVSS 评分可以帮助决定是推出紧急修补程序（及其相关费用），还是将修复程序推迟到下一个主要版本，如果漏洞较小的话。

你还可以在防御性上下文中使用评分来判断需要哪些对策。在通用标准智能卡认证的背景下，JIL 评分实际上成为了安全目标的一个关键部分——芯片必须抵御被评为最高 30 分的攻击，才能被认为对高攻击潜力的攻击者具有抵抗力。SOG-IS 文档《攻击潜力在智能卡中的应用》解释了这种评分，并涉及了一些硬件攻击。为了给你一个评分的概念，如果使用双激光束系统进行激光故障注入，需要几周时间才能提取出一个秘密密钥，这种攻击的评分为 30 分或以下。如果使用侧信道攻击需要六个月才能提取密钥，那么就不需要实施对策，因为这种攻击的评分为 31 分或更高。

CWSS 旨在对系统中的弱点进行评分，以便在它们被利用之前进行评估。这是一个在开发过程中非常有用的评分方法，因为它有助于为弱点的修复措施分配优先级。大家都知道，每个修复都需要付出成本，而且试图修复所有漏洞是不切实际的，因此对弱点进行评分可以让开发人员集中精力解决最重要的问题。

在现实中，大多数攻击者也会进行某种评分，以最小化攻击成本并最大化攻击的影响。尽管攻击者在这些话题上并没有发布太多内容，但 Dino Dai Zovi 在 2011 年 SOURCE 波士顿会议上做了一场名为“攻击者数学 101”的精彩演讲，尝试为攻击者成本设定一些界限。

这些评分是有限的、模糊的、不精确的、主观的，并且不具备特定市场背景，但它们为讨论攻击或漏洞提供了一个良好的起点。如果你正在为嵌入式系统进行威胁建模，我们建议从 JIL 开始，它主要关注硬件攻击。当涉及软件攻击时，使用 CWSS，因为这些是评分方法的应用背景。使用 CWSS 时，你可以去掉无关的方面，调整其他方面，比如业务影响，以评估资产的价值或可扩展性。此外，确保你对整个攻击路径进行评分，从攻击者的起点一直到对资产的影响，这样你就能在不同评分之间做出一致的比较。三种评分方法都无法很好地处理可扩展性问题：对百万台系统的攻击可能只会比对单台系统的攻击产生稍微更差的评分。其他限制也毫无疑问地存在，但目前没有更好的行业标准。

在各种安全认证方案中，都有隐性或显性的安全目标。例如，前面提到的，对于智能卡，只有 30 个 JIL 点或更低的攻击才被认为是相关的。比如 Tarnovsky 在 2010 年黑帽大会 DC 演讲中展示的攻击“解构一个‘安全’处理器”超过了 30 个点，因此不被认为是安全目标的一部分。对于 FIPS 140-2 来说，任何不在特定攻击列表中的攻击都不被认为是相关的。例如，侧信道攻击可以在一天内攻破 FIPS 140-2 认证的加密引擎，而 FIPS 140-2 的安全目标仍然认为它是安全的。每次使用具有安全证书的设备时，都要确保该证书的安全目标与您的目标一致。

## 安全问题的披露

安全问题披露是一个备受争议的话题，我们并不打算在几段话中解决这个问题。我们希望在讨论硬件安全问题时为辩论增添一些色彩。硬件和软件始终会存在安全问题。对于软件，您可能能够分发新版本或补丁。而修复硬件因各种原因而成本高昂。

我们认为披露的目标是公共安全和安保，而不是制造商的商业利益或研究人员的名利。这意味着披露必须从长远来看为公众服务。披露是迫使制造商修复漏洞的工具，同时也让公众了解某产品的风险。完全披露的一个不受欢迎的副作用是，一大批攻击者将在修复广泛发布之前利用该漏洞。

对于硬件漏洞，通常在生产后该漏洞无法修复，尽管发布软件补丁可以缓解此问题。在这种情况下，类似于软件披露的 90 天披露期可能也适用。对于纯硬件的修复，我们尚不清楚有类似的惯例（尽管我们见过软件惯例的应用）。

在硬件中，通常无法通过软件更新绕过漏洞，而且补丁几乎不可能分发和安装。一位有良好意图的制造商可以在下一个版本中修复漏洞，但现场的产品仍然会受到威胁。在这种情况下，披露的唯一好处是公众的知情；缺点是直到有漏洞修复产品替换或停产前，会有很长的时间间隔。另一种选择是部分披露。例如，制造商可以说明风险和产品，但不披露如何利用漏洞的具体细节。（这种策略在软件领域并不奏效，因为即便是非具体的披露，漏洞也通常很快被发现。）

当漏洞无法修补，并且可能直接影响健康和安全时，复杂性会增加。考虑一个攻击，它可以远程关闭每一个心脏起搏器。如果披露这种情况，肯定会让患者对安装心脏起搏器产生恐惧，导致更多人因心脏病发作而死亡。另一方面，这将促使供应商在下一版本中提高安全性，减少具有致命后果的攻击风险。对于自动驾驶汽车、物联网牙刷、SCADA 系统以及其他所有应用和设备，都会出现独特的权衡。特别是当漏洞存在于一种芯片上，而这种芯片被广泛应用于各种产品时，挑战会更大。

我们并不是说我们能提供所有情况下的“魔法答案”，但我们鼓励每个人认真考虑要采取什么样的披露方式。制造商应以系统最终会被攻破为前提来设计系统，并围绕这一前提制定安全场景。不幸的是，这种做法并不普遍，特别是在市场推出时间和低成本主导的情况下。

## 概述

本章概述了一些嵌入式安全基础知识。我们描述了在分析设备时，您无疑会遇到的软硬件组件，并讨论了“安全”在哲学上的含义。为了正确分析安全问题，我们介绍了威胁模型的四个组成部分：攻击者、各种（硬件）攻击、系统的资产和安全目标，最后是您可以实施的反制措施类型。我们还描述了用于创建、分析和评估攻击的工具，使用攻击树和行业标准评级系统。最后，我们探讨了硬件漏洞的披露这一棘手的话题。

通过掌握这些知识，我们的下一步将是开始对设备进行探测，这也是我们在下一章要做的事情。
