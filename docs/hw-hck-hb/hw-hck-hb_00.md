# 前言

![](img/chapterart.png)

曾几何时，在一个不远的宇宙里，计算机是巨大的机器，充满了大房间，需要小型团队来操作。随着技术的不断进步，将计算机放入小空间变得越来越可行。大约在 1965 年，阿波罗导航计算机足够小，可以被带入太空，并为宇航员提供计算功能以及对阿波罗模块的控制。这台计算机可以被认为是最早的嵌入式系统之一。如今，绝大多数生产的处理器芯片都是嵌入式的——用于手机、汽车、医疗设备、关键基础设施和“智能”设备。甚至你的笔记本电脑也有大量这样的芯片。换句话说，每个人的生活都受这些小芯片的影响，这意味着理解它们的安全性至关重要。

那么，什么样的设备才能被称为*嵌入式*设备呢？嵌入式设备是足够小的计算机，可以被集成到它们控制的设备结构中。这些计算机通常以微处理器的形式存在，通常包括内存和用于控制嵌入其中设备的接口。*嵌入式*一词强调它们被用在某些物体内部的深层位置。有时候，嵌入式设备小到足以装进信用卡的厚度，提供管理交易所需的智能。嵌入式设备的设计目标是使其几乎对用户不可察觉，用户只能有限或没有访问其内部结构的权限，也无法修改其软件。

这些设备到底是做什么的？嵌入式设备被广泛应用于各种场景。它们可以在智能电视中托管完整的安卓操作系统（OS），或者出现在汽车的电子控制单元（ECU）中，运行实时操作系统。它们可以以 Windows 98 PC 的形式出现在磁共振成像（MRI）扫描仪中。工业环境中的可编程逻辑控制器（PLC）也使用它们，甚至在互联网连接的牙刷中提供控制和通信功能。

限制设备内部结构访问的原因通常与保修、安全性和法规合规性有关。当然，这种不可接触性使得逆向工程变得更加有趣、复杂和吸引人。嵌入式系统具有多种不同的电路板设计、处理器和操作系统，因此有很多可以探索的内容，逆向工程的挑战也很广泛。本书旨在通过提供对系统及其组件设计的理解，帮助读者应对这些挑战。它通过探索名为电力侧信道攻击和故障攻击的分析方法，推动了嵌入式系统安全的极限。

许多实时嵌入式系统确保设备的安全使用，或者可能具有触发器，如果在其预期工作环境之外被激活，可能会造成损害。我们鼓励你在实验室里玩二手的 ECU，但我们不鼓励你在驾驶汽车时玩 ECU！玩得开心，小心点，别伤到自己或他人。

在本书中，你将学习如何从单纯欣赏手中的设备，进而了解其安全优缺点。本书展示了这个过程的每个步骤，并提供足够的理论背景，以帮助你理解该过程，重点展示如何亲自进行实际实验。我们涵盖了整个过程，因此你将学到的不仅仅是学术文献和其他资料中的内容，而是那些同样重要且相关的知识，例如如何识别印刷电路板（PCB）上的元件。我们希望你会喜欢！

## 嵌入式设备的外观

嵌入式设备的设计功能适应于其所嵌入的设备。在开发过程中，安全性、功能性、可靠性、体积、功耗、上市时间、成本，甚至安全性等方面常常需要做出取舍。实施的多样性使得大多数设计具有独特性，以满足特定应用的要求。例如，在汽车电子控制单元中，对安全性的关注可能意味着多个冗余的中央处理单元（CPU）核心同时计算相同的刹车执行器响应，以便最终仲裁者可以验证它们的独立决策。

安全有时是嵌入式设备的首要功能，例如信用卡。尽管金融安全至关重要，但由于卡片本身必须保持价格可承受，因此会进行成本权衡。新产品的上市时间可能是一个重要的考虑因素，因为公司需要在竞争对手夺取市场主导地位之前进入市场。以互联网连接的牙刷为例，安全性可能被视为低优先级，并在最终设计中退居次要地位。

随着廉价现成硬件的普及，嵌入式系统的开发趋向于不再使用定制部件。专用集成电路（ASIC）正被通用微控制器取代。定制操作系统的实现被 FreeRTOS、裸机 Linux 内核，甚至完整的 Android 堆栈所取代。现代硬件的强大性能使得一些嵌入式设备相当于平板电脑、手机，甚至完整的 PC。

本书旨在适用于你将遇到的大多数嵌入式系统。我们建议你从一个简单的微控制器开发板开始；任何价格在 100 美元以下、最好支持 Linux 的开发板都可以。这将帮助你在转向更复杂的设备或你了解较少或控制较少的设备之前，掌握基本知识。

## 嵌入式设备的破解方式

假设你有一个设备，其安全要求是不允许第三方代码，但你的目标是无论如何都要在其上运行代码。在考虑进行黑客攻击时，无论出于什么原因，设备的功能和技术实现都会影响攻击的方式。例如，如果设备包含一个完整的 Linux 操作系统并具有开放的网络接口，可能只需通过已知的默认 root 账户密码登录，即可获得完全访问权限。然后，你可以在其上运行你的代码。然而，如果设备有一个执行固件签名验证的微控制器并且所有调试端口都已禁用，这种方法将无法奏效。

为了达到相同的目标，不同的设备需要采用不同的方法。你必须小心地将你的目标与设备的硬件实现相匹配。在本书中，我们通过绘制攻击树来处理这一需求，这是一种进行轻量级威胁建模的方式，有助于可视化并理解达到目标的最佳路径。

## 什么是硬件攻击？

我们主要关注硬件攻击以及执行它们所需了解的内容，而不是软件攻击，后者在其他地方已有广泛的讨论。首先，让我们澄清一些术语。我们的目标是提供有用的定义，并避免深入讨论所有的例外情况。

设备包括软件和硬件。就我们的目的而言，我们将*软件*视为由位组成，将*硬件*视为由原子组成。我们认为*固件*（嵌入式设备中的代码）与软件相同。

在谈论硬件攻击时，很容易将*使用*硬件的攻击与*针对*硬件的攻击混淆。当我们意识到也有软件目标和软件攻击时，这变得更加复杂。以下是描述各种组合的一些例子：

+   我们可以通过扰动供电电压来攻击设备的环形振荡器（硬件目标）（硬件攻击）。

+   我们可以在 CPU 上注入电压故障（硬件攻击），进而影响正在执行的程序（软件目标）。

+   我们可以通过在 CPU 上运行 Rowhammer 代码（软件攻击）来翻转内存中的位（硬件目标）。

+   为了完整性，我们可以对网络守护进程（软件目标）执行缓冲区溢出（软件攻击）。

在本书中，我们讨论的是硬件攻击，因此目标可能是软件或硬件。请记住，硬件攻击通常比软件攻击更难执行，因为软件攻击需要的物理干预较少。然而，当设备可能抵御软件攻击时，硬件攻击可能会成为成功的、更便宜（并且在我们看来，绝对更有趣）选择。远程攻击（设备不在手边时）仅限于通过网络接口访问，而如果硬件可以物理接触，则可以执行所有类型的攻击。

总结来说，嵌入式设备有很多不同类型，每个设备都有自己的功能、权衡、安保目标和实现方式。正是这种多样性，使得本书将教授一系列硬件攻击策略。

## 谁该阅读本书？

在本书中，我们假设你扮演的是一个攻击者的角色，目的是通过破坏安全来做些好事。我们还假设你能够使用一些相对便宜的硬件，比如简单的示波器和焊接设备，并且你有一台安装了 Python 的计算机。

我们不会假设你有激光设备、粒子加速器或其他超出业余爱好者预算范围的物品。如果你确实有机会接触到这些设备，可能在本地大学实验室中，你应该能够从本书中获得更多的收获。关于嵌入式设备目标，我们假设你能物理接触到它们，并且你有兴趣访问存储在设备中的资产。最重要的是，我们假设你对学习新技术感兴趣，拥有反向工程的思维方式，并且已经准备好深入研究！

## 关于本书

下面是你在本书中将找到的内容简要概述：

**第一章：口腔卫生：嵌入式安全简介**

重点介绍了嵌入式系统的各种实现架构和一些威胁建模，并讨论了各种攻击方式。

**第二章：伸手触摸我，触摸你：硬件外设接口**

讨论了各种端口和通信协议，包括理解信号和测量所需的电气基础知识。

**第三章：勘察现场：识别组件和收集信息**

描述了如何收集关于目标的信息，解读数据表和原理图，识别 PCB 上的组件，并提取和分析固件镜像。

**第四章：瓷器店里的公牛：故障注入介绍**

介绍了故障攻击背后的思想，包括如何识别故障注入点、准备目标、创建故障注入设置，并集中精力调整有效参数。

**第五章：不要舔探针：如何注入故障**

讨论了时钟、电压、电磁、激光和人体偏置等方面。

故障注入，以及进行这些操作所需的工具，你需要自己制造或购买的工具。

**第六章：测试台时间：故障注入实验室**

提供了三个实用的故障注入实验，适合在家中进行。

**第七章：标记位置：Trezor One 钱包内存转储**

以 Trezor One 钱包为例，展示如何利用故障注入从一个易受攻击的固件版本中提取密钥。

**第八章：我掌握着电力：功率分析介绍**

介绍了时序攻击和简单的功率分析，并展示了如何利用这些方法提取密码和加密密钥。

**第九章：测试台时间：简单功率分析**

带你从搭建基础硬件设置开始，直到完成 SPA 攻击所需的一切，全部在家用实验室中实现。

**第十章：差异化处理：差分功率分析**

解释了差分功率分析，并展示了功率消耗中的微小波动如何导致密码学密钥的提取。

**第十一章：深入探讨：高级功率分析**

提供了一系列技术手段，帮助你提升功率分析能力：从实用的测量技巧到跟踪设置过滤、信号分析、处理和可视化。

**第十二章：测试时间：差分功率分析**

以一个带有特殊引导程序的物理目标为例，使用不同的功率分析技术破解各种秘密。

**第十三章：不是开玩笑：真实案例**

总结了在真实目标上执行的多个已发布的故障和侧信道攻击。

**第十四章：想想孩子们：对策、认证与安全字节**

讨论了多种能够减轻本书中提到的风险的对策，并涉及设备认证以及接下来该做什么。

**附录 A：用光你的信用卡：搭建测试实验室**

通过精彩的揭秘让你垂涎欲滴，展示了你可能需要的所有工具，甚至更多。

**附录 B：你们的基地已经归我们所有：常见引脚排列**

提供了一个备忘单，列出了你常遇到的几种流行引脚排列。
