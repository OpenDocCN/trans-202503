# 第八章：端点分析

![](img/chapterart.png)

现在你已经发现了一些 API，是时候开始使用并测试你找到的端点了。本章将介绍如何与端点交互，测试它们的漏洞，甚至可能在早期就获得一些小小的胜利。

所谓的“早期胜利”，是指在测试的这个阶段可能会发现的关键漏洞或数据泄露。API 是一种特殊的目标，因为你可能不需要高级技能就能绕过防火墙和端点安全；相反，你可能只需要知道如何按其设计使用一个端点。

我们将首先学习如何从 API 文档、规范和反向工程中发现 API 多种请求的格式，并利用这些资源构建 Postman 集合，以便在每个请求中进行分析。然后，我们将通过一个简单的过程开始你的 API 测试，并讨论如何发现你的第一个漏洞，比如信息泄露、安全配置错误、过度的数据暴露和业务逻辑缺陷。

## 查找请求信息

如果你习惯于攻击 Web 应用程序，那么你对 API 漏洞的追踪应该会有些熟悉。主要的区别是你不再有明显的 GUI 提示，如搜索栏、登录框和上传文件的按钮。API 黑客攻击依赖于那些出现在 GUI 中的项的后端操作——也就是带有查询参数的 GET 请求，以及大多数的 POST/PUT/UPDATE/DELETE 请求。

在你创建请求之前，你需要了解其端点、请求参数、必要的头部、身份验证要求和管理功能。文档通常会指引我们找到这些元素。因此，作为一名 API 黑客，你需要学会如何阅读和使用 API 文档，并且知道如何找到它。如果你能找到 API 的规范，更好的是，你可以将其直接导入 Postman，以自动创建请求。

当你执行黑盒 API 测试且文档完全不可用时，你将不得不自己反向工程 API 请求。你需要彻底进行模糊测试，探索 API 的端点、参数和头部要求，以便绘制出 API 的结构及其功能。

### 在文档中查找信息

正如你现在所知道的，API 的文档是由 API 提供者发布的供 API 使用者参考的一套说明。由于公共和合作伙伴 API 的设计目的是为了自助服务，公共用户或合作伙伴应该能够找到文档，理解如何使用 API，并且无需提供者的帮助即可完成。文档通常会位于如下目录下：

1.  *https://example.com/docs*

1.  *https://example.com/api/docs*

1.  *https://docs.example.com*

1.  *https://dev.example.com/docs*

1.  *https://developer.example.com/docs*

1.  *https://api.example.com/docs*

1.  *https://example.com/developers/documentation*

当文档不可公开获取时，尝试创建一个帐户并在验证身份后搜索文档。如果仍然找不到文档，我在 GitHub 上提供了一些 API 单词列表，帮助你通过一种叫做*目录暴力破解*的模糊技术发现 API 文档（[`github.com/hAPI-hacker/Hacking-APIs`](https://github.com/hAPI-hacker/Hacking-APIs)）。你可以使用`subdomains_list`和`dir_list`来暴力破解 Web 应用的子域名和域名，并有可能找到托管在网站上的 API 文档。在侦察和 Web 应用扫描过程中，很有可能会发现文档。

如果一个组织的文档确实被严格限制，你仍然有一些选择。首先，尝试使用你的 Google 黑客技能在搜索引擎和其他侦察工具中查找它。其次，使用 Wayback Machine（[`web.archive.org/`](https://web.archive.org/)）。如果目标曾公开发布过其 API 文档并随后撤回，可能会有该文档的存档。虽然存档文档很可能已经过时，但它应该能给你一些关于身份验证要求、命名方案和端点位置的线索。第三，当允许时，尝试社交工程技术来诱使组织分享其文档。这些技巧超出了本书的范围，但你可以通过短信钓鱼、语音钓鱼和网络钓鱼等手段，创造性地欺骗开发人员、销售部门以及合作伙伴来获取 API 文档的访问权限。假装是一个新客户，试图与目标 API 合作。

尽管 API 文档比较直白，但仍有一些要注意的元素。*概述*通常是 API 文档的第一部分。通常位于文档的开头，概述部分会提供如何连接和使用 API 的高层次介绍。此外，它还可能包含有关身份验证和速率限制的信息。

审查文档的*功能*，或者你可以使用给定 API 执行的操作。这些操作通常由 HTTP 方法（GET、PUT、POST、DELETE）和端点的组合来表示。每个组织的 API 都会有所不同，但你可以预期会找到与用户帐户管理、上传和下载数据的选项、不同的请求信息方式等相关的功能。

在向端点发出请求时，请确保注意请求的*要求*。要求可能包括某种身份验证、参数、路径变量、头部和请求体中的信息。API 文档应告诉你它需要什么，并说明这些信息属于请求的哪一部分。如果文档提供了示例，请利用它们帮助你。通常，你可以将示例值替换为你正在寻找的值。表 7-1 描述了这些示例中常用的一些约定。

表 7-1：API 文档约定

| **约定** | **示例** | **含义** |
| --- | --- | --- |

| `:` 或 `{}` | */user/:id* */user/{id}*

*/user/2727*

*/account/:username*

*/account/{username}*

*/account/scuttleph1sh* | 冒号或花括号被一些 API 用来表示路径变量。换句话说，“:id”代表一个 ID 号的变量，而“{username}”代表你试图访问的账户用户名。 |

| `[]` | */api/v1/user**?**find**=[name]* | 方括号表示输入是可选的。 |
| --- | --- | --- |
| `&#124;&#124;` | “蓝色”&#124;&#124; “绿色”&#124;&#124; “红色” | 双竖线表示可以使用的不同可能值。 |
| `< >` | <find-function> | 尖括号表示 DomString，它是一个 16 位字符串。 |

例如，以下是来自脆弱 Pixi API 文档的 GET 请求：

```
❶ GET          ❷/api/picture/{picture_id}/likes    `get a list of likes by user`

❸ Parameters

Name                                Description

x-access-token *
string                              Users JWT Token
`(header)`

picture_id *                        in URL string

number
`(path)`
```

你可以看到，方法是 GET ❶，端点是*/api/picture/{picture_id}/likes* ❷，唯一的要求是`x-access-token`头部和`picture_id`变量需要在路径中更新 ❸。现在你知道了，为了测试这个端点，你需要弄清楚如何获得 JSON Web Token（JWT）以及`picture_id`应该是什么格式。

然后，你可以将这些指令插入到 API 浏览器中，例如 Postman（见图 7-1）。如你所见，除了`x-access-token`之外的所有头部都会被 Postman 自动生成。

在这里，我通过身份验证登录到网页，并在图片下找到了`picture_id`。我利用文档查找了 API 注册流程，生成了 JWT。然后，我将 JWT 保存为变量`hapi_token`；在本章中，我们将使用变量。保存了 token 作为变量后，你可以通过将变量名包围在花括号中来调用它：`{{hapi_token}}`。（请注意，如果你正在处理多个集合，你可能会希望使用环境变量。）将它们组合起来，形成了一个成功的 API 请求。你可以看到，提供者回应了“200 OK”，以及请求的信息。

![Postman 截图，显示已勾选的头部列表，并包含这些字段的自动生成请求](img/F07001.png)

图 7-1：完全构造的请求，指向 Pixi 端点*/api/{picture_id}/likes*

在请求格式不正确的情况下，提供方通常会告知您哪里出了问题。例如，如果您在没有 `x-access-token` 的情况下请求相同的端点，Pixi 会返回以下信息：

```
{
    "success": **false,**
    "message": "No token provided."
}
```

您应该能够理解响应并进行必要的调整。如果您尝试复制粘贴端点，但没有替换 `{picture_id}` 变量，提供方会返回状态码 200 OK，并且响应体是一个带方括号（`[]`）的空内容。如果响应令您困惑，请返回文档并将您的请求与要求进行比较。

### 导入 API 规范

如果您的目标有规范，格式如 OpenAPI（Swagger）、RAML 或 API Blueprint，或者是 Postman 集合，找到它会比找到文档更有用。提供了规范后，您可以简单地将其导入 Postman，并查看构成集合的请求，以及它们的端点、头信息、参数和一些必需的变量。

规范的查找应当和它们的 API 文档一样容易或困难。它们通常看起来像图 7-2 中的页面。规范通常是纯文本格式，通常是 JSON 格式，但也可能是 YAML、RAML 或 XML 格式。如果 URL 路径没有明确标明规范类型，可以扫描文件的开头，查找描述符，例如 `"swagger":"2.0"`，以确定规范及其版本。

![包含大量未格式化的 JSON 数据的 Pixi 网页截图](img/F07002.png)

图 7-2：Pixi Swagger 定义页面

要导入规范，首先启动 Postman。在工作区集合部分，点击**导入**，选择**链接**，然后添加规范的位置（见图 7-3）。

![Postman 菜单项截图，包含一个“输入 URL”字段和一个继续按钮](img/F07003.png)

图 7-3：Postman 中的导入链接功能

点击**继续**，在最后的窗口中，选择**导入**。Postman 会检测规范并将文件导入为一个集合。集合导入到 Postman 后，您可以在此处查看其功能（见图 7-4）。

![Postman Collections 标签页截图，显示 Pixi App API 的目录结构，包括子文件夹和 POST、GET 请求列表。](img/F07004.png)

图 7-4：导入的 Pixi 应用集合

在导入新集合后，确保检查集合变量。你可以通过选择集合顶部的三个水平圆圈并选择**编辑**来显示集合编辑器。在这里，你可以选择集合编辑器中的变量选项卡来查看变量。你可以根据需要调整变量，并向该集合添加任何新变量。在图 7-5 中，你可以看到我已经将 `hapi_token` JWT 变量添加到我的 Pixi App 集合中。

![Postman 变量选项卡的截图，显示两个变量，baseUrl 和 hapi_token，已选中](img/F07005.png)

图 7-5：Postman 集合变量编辑器

一旦完成更新，使用右上角的**保存**按钮保存你的更改。像这样将 API 规范导入到 Postman 可以节省你手动添加所有端点、请求方法、头信息和要求的几个小时。

### 反向工程 API

在没有文档和规范的情况下，你需要根据与 API 的交互进行反向工程。我们将在第七章中更详细地讲解这个过程。映射一个具有多个端点和一些方法的 API，可能会迅速变成一个需要攻克的庞大项目。为了管理这个过程，可以在一个集合下构建请求，从而彻底测试 API。Postman 可以帮助你跟踪所有这些请求。

使用 Postman 反向工程 API 有两种方法。一种方法是手动构建每个请求。虽然这可能有点繁琐，但它可以让你捕获你关心的精确请求。另一种方法是通过 Postman 代理 Web 流量，然后使用它捕获一系列请求。这一过程使得在 Postman 中构建请求变得更加容易，但你需要删除或忽略无关的请求。最后，如果你获得了有效的认证头，例如令牌、API 密钥或其他认证值，可以将其添加到 Kiterunner 中，以帮助映射 API 端点。

#### 手动构建 Postman 集合

要在 Postman 中手动构建自己的集合，请在我的工作区下选择**新建**，如图 7-6 右上角所示。

![Postman “我的工作区”选项卡，右上角有新建和导入按钮](img/F07006.png)

图 7-6：Postman 的工作区部分

在“Create New”窗口中，创建一个新集合，然后设置一个 `baseURL` 变量，包含目标的 URL。创建 `baseURL` 变量（或使用已存在的变量）将帮助你快速在整个集合中修改 URL。API 可能非常庞大，修改许多请求中的小细节可能会很耗时。例如，假设你想测试一个有数百个独立请求的 API 的不同路径版本（如 *v1/v2/v3*）。使用变量替换 URL 意味着你只需要更新该变量，就能改变所有使用该变量的请求路径。

现在，每次你发现一个 API 请求时，都可以将其添加到集合中（见 图 7-7）。

![Postman 界面截图，显示右键点击菜单项“Reqres Testing”，并在弹出菜单中选择“Add Request”](img/F07007.png)

图 7-7：新建 Postman 集合中的 Add Request 选项

选择集合选项按钮（三个水平圆圈），然后选择 **Add Request**。如果你想进一步组织请求，可以创建文件夹将请求归类。当你构建完集合后，可以像使用文档一样使用它。

#### 通过代理构建 Postman 集合

逆向工程 API 的第二种方法是通过 Postman 代理网页浏览器流量，并清理请求，确保仅保留与 API 相关的请求。让我们通过将浏览器流量代理到 Postman 来逆向工程 crAPI API。

首先，打开 Postman 并为 crAPI 创建一个集合。在 Postman 界面右上角有一个信号按钮，你可以选择它来打开“Capture requests and cookies”窗口（见 图 7-8）。

![Postman “Capture Requests and Cookies” 窗口，显示“Capture requests”已设置为开启，端口设置为 5555，请求被保存到 crAPI 集合](img/F07008.png)

图 7-8：Postman 捕获请求和 Cookies 窗口

确保端口号与在 FoxyProxy 中配置的端口一致。在第四章中，我们将其设置为端口 5555。将请求保存到你的 crAPI 集合中。最后，将“Capture Requests”设置为 **On**。现在，导航到 crAPI 网页应用并设置 FoxyProxy 将流量转发到 Postman。

当你开始使用该网页应用时，每个请求都会通过 Postman 发送并添加到选定的集合中。使用网页应用的每个功能，包括注册新账号、身份验证、执行密码重置、点击每个链接、更新个人资料、使用社区论坛和访问商店。彻底使用完网页应用后，停止代理并查看在 Postman 中创建的 crAPI 集合。

以这种方式构建集合的一个缺点是，你将捕获到一些与 API 无关的请求。你需要删除这些请求并整理集合。Postman 允许你创建文件夹来分组相似的请求，并且你可以根据需要重命名任何请求。在 图 7-9 中，你可以看到我按不同的端点对请求进行了分组。

![Postman 中的 crAPI 请求截图，按社区、身份和工作坊文件夹进行分组](img/F07009.png)

图 7-9：一个组织良好的 crAPI 集合

## 将 API 认证要求添加到 Postman 中

一旦你在 Postman 中编译了基本的请求信息，接下来查找 API 的认证要求。大多数有认证要求的 API 都会提供获取访问权限的流程，通常是通过 POST 请求发送凭据，或者通过 OAuth，或者使用与 API 分开的方式，比如电子邮件，来获取令牌。良好的文档应该能清楚地说明认证过程。在下一章中，我们将专门花时间测试 API 认证流程。目前，我们将利用 API 认证要求来按预期使用 API。

作为一个典型的认证过程示例，让我们注册并认证到 Pixi API。Pixi 的 Swagger 文档告诉我们，我们需要向 */api/register* 端点发送一个包含 `user` 和 `pass` 参数的请求，以获得 JWT。如果你已经导入了集合，你应该能够在 Postman 中找到并选择“创建认证令牌”请求（见 图 7-10）。

![Postman 中的 POST 请求截图，其中“token”头的值为长的高亮字符串](img/F07010.png)

图 7-10：成功的 Pixi API 注册请求

预配置的请求包含一些你可能不知道的参数，而这些参数并不是认证所必需的。与其使用预配置的信息，我选择了 `x-www-form-urlencoded` 选项，并仅使用必要的参数（`user` 和 `pass`）。然后我添加了 `user` 和 `pass` 这两个键，并填写了 图 7-10 中显示的值。这个过程导致了成功的注册，状态码为 200 OK，并返回了一个令牌。

保存成功的认证请求是个好主意，这样你就能在需要时重复使用它们，因为令牌可能会快速过期。此外，API 安全控制可能会检测到恶意活动并撤销你的令牌。只要你的帐户没有被封锁，你应该能够生成另一个令牌并继续测试。此外，确保将令牌保存为集合或环境变量。这样，你就可以在后续请求中快速引用它，而不必每次都复制那个巨大的字符串。

当你获取到认证令牌或 API 密钥后，接下来应该做的事是将它添加到 Kiterunner 中。在第六章中，我们作为未认证用户使用 Kiterunner 绘制目标的攻击面，但向工具中添加认证头将大大提升你的结果。不仅如此，Kiterunner 会为你提供有效端点的列表，还会显示有趣的 HTTP 方法和参数。

在以下示例中，我们使用在 Pixi 注册过程中提供的 `x-access-token`。将完整的授权头添加到你的 Kiterunner 扫描中，使用 `-H` 选项：

```
$ **kr scan http://192.168.50.35:8090 -w ~/api/wordlists/data/kiterunner/routes-large.kite -H 'x-access-token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjp7Il9pZCI6NDUsImVtYWlsIjoiaGFwaUBoYWNrZXIuY29tIiwicGFzc3dvcmQiOiJQYXNzd29yZDEhIiwibmFtZSI6Im15c2VsZmNyeSIsInBpYyI6Imh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS91aWZhY2VzL2ZhY2VzL3R3aXR0ZXIvZ2FicmllbHJvc3Nlci8xMjguanBnIiwiaXNfYWRtaW4iOmZhbHNlLCJhY2NvdW50X2JhbGFuY2UiOjUwLCJhbGxfcGljdHVyZXMiOltdfSwiaWF0IjoxNjMxNDE2OTYwfQ._qoC_kgv6qlbPLFuH07-DXRUm9wHgBn_GD7QWYwvzFk'**
This scan will result in identifying the following endpoints:
GET     200 [    217,    1,   1] http://192.168.50.35:8090/api/user/info
GET     200 [ 101471, 1871,   1] http://192.168.50.35:8090/api/pictures/
GET     200 [    217,    1,   1] http://192.168.50.35:8090/api/user/info/
GET     200 [ 101471, 1871,   1] http://192.168.50.35:8090/api/pictures
```

向 Kiterunner 请求添加授权头应该能提高你的扫描结果，因为它将允许扫描器访问原本无法访问的端点。

## 功能分析

一旦你将 API 的信息加载到 Postman 中，你应该开始寻找问题。本节将介绍一种初步测试 API 端点功能的方法。你将从按预期使用 API 开始。在这个过程中，你需要关注响应、它们的状态码和错误信息。特别是，你要寻找作为攻击者可能感兴趣的功能，尤其是如果有信息泄露、数据暴露过度和其他容易利用的漏洞的迹象。寻找那些可能提供敏感信息的端点、允许你与资源交互的请求、允许你注入有效载荷的 API 区域，以及管理操作。除此之外，寻找任何允许你上传自己的有效载荷并与资源交互的端点。

为了简化这个过程，我建议通过 Burp Suite 代理 Kiterunner 的结果，这样你就可以重放感兴趣的请求。在之前的章节中，我向你展示了 Kiterunner 的重放功能，它让你能够查看单独的 API 请求和响应。要通过其他工具代理重放，你需要指定代理接收器的地址：

```
$ **kr kb replay -w ~/api/wordlists/data/kiterunner/routes-large.kite --proxy=http://127.0.0.1:8080 "GET     403 [     48,    3,   1] http://192.168.50.35:8090/api/picture/detail.php 0cf6889d2fba4be08930547f145649ffead29edb"**
```

这个请求使用了 Kiterunner 的重放选项，正如 `kb replay` 所指定的那样。`-w` 选项指定了使用的字典，而 `proxy` 指定了 Burp Suite 代理。命令的其余部分是原始的 Kiterunner 输出。在 图 7-11 中，你可以看到 Kiterunner 的重放请求成功被 Burp Suite 捕获。

![Burp Suite 中 GET 请求的截图](img/F07011.png)

图 7-11：通过 Burp Suite 截获的 Kiterunner 请求

现在你可以分析这些请求，并使用 Burp Suite 重复所有在 Kiterunner 中捕获到的有趣结果。

### 测试预期用途

首先按照预期使用 API 端点。你可以从浏览器开始这个过程，但浏览器并不是为了与 API 交互而设计的，所以你可能想切换到 Postman。使用 API 文档查看如何构建请求，应该包含哪些头信息，添加哪些参数，以及如何进行身份验证。然后发送请求。调整你的请求，直到从服务提供商处收到成功的响应。

在继续进行时，问问自己以下问题：

+   我可以采取什么操作？

+   我可以与其他用户账户进行交互吗？

+   有哪些资源可用？

+   当我创建一个新资源时，如何识别该资源？

+   我可以上传文件吗？我可以编辑文件吗？

如果你手动与 API 交互，则不需要进行每一个可能的请求，但可以进行一些请求。当然，如果你在 Postman 中构建了一个集合，你可以轻松地进行所有可能的请求，并查看你从服务提供商那里收到的响应。

例如，向 Pixi 的 */api/user/info* 端点发送请求，看看你从应用程序收到什么响应（见 图 7-12）。

为了向此端点发出请求，你必须使用 GET 方法。将 *{{baseUrl}}/api/user/info* 端点添加到 URL 字段。然后将 `x-access-token` 添加到请求头中。如你所见，我已将 JWT 设置为变量 `{{hapi_token}}`。如果成功，你应该会收到 200 OK 状态码，显示在响应上方。

![Postman 中请求的截图，选择了 x-access-token 变量](img/F07012.png)

图 7-12：将 `x-access-token` 设置为 JWT 的变量

### 执行特权操作

如果你已经获得了 API 文档的访问权限，文档中列出的任何管理操作都应该引起你的注意。特权操作通常会带来额外的功能、信息和控制。例如，管理员请求可能让你有能力创建和删除用户，搜索敏感用户信息，启用和禁用账户，将用户添加到组中，管理令牌，访问日志等。幸运的是，由于 API 的自助性质，管理员 API 文档信息通常对所有人开放。

如果安全控制到位，管理操作应该有授权要求，但永远不要假设它们真的有。我建议将这些操作分几个阶段进行测试：首先作为未认证用户，其次作为低权限用户，最后作为管理员用户。当你按照文档进行管理员请求，但没有任何授权要求时，如果有安全控制，应该会收到某种未经授权的响应。

你可能需要找到一种方法来获取管理员权限。在 Pixi 的案例中，图 7-13 中的文档明确告诉我们，我们需要一个 `x-access-token` 才能对 */api/admin/users/search* 端点执行 GET 请求。当你测试这个管理员端点时，你会发现 Pixi 已经采取了基本的安全控制措施，防止未授权用户使用管理员端点。

![Pixi 管理员端点文档截图](img/F07013.png)

图 7-13：Pixi 管理员端点的要求

确保最基本的安全控制到位是一个有用的做法。更重要的是，受保护的管理员端点为我们接下来的测试步骤设立了目标；我们现在知道，为了使用此功能，我们需要获得一个管理员 JWT。

### 分析 API 响应

由于大多数 API 是为了自助服务而设计的，开发者通常会在 API 响应中留下某些提示，以便在事情进展不顺利时帮助我们。作为 API 黑客，你需要掌握的最基本技能之一就是分析你收到的响应。这通常是通过发起请求并查看响应状态码、头部信息以及响应体中的内容来完成的。

首先检查你是否收到了预期的响应。API 文档有时会提供你可能收到的响应示例。然而，一旦你开始以非预期的方式使用 API，你将无法知道自己会得到什么响应，这就是为什么在进入攻击模式之前，先按照 API 设计的方式使用它会更有帮助。培养对正常行为和异常行为的敏感度会使漏洞变得更加明显。

目前，你的漏洞搜索正式开始了。既然你已经在与 API 进行交互，你应该能够找到信息泄露、安全配置错误、过度的数据暴露以及业务逻辑漏洞，而且这一切不需要太高的技术技巧。现在是时候引入黑客攻击中最重要的要素：对抗性思维。接下来的部分，我将告诉你应该寻找什么。

## 查找信息泄露

信息泄露通常是我们测试的燃料。任何帮助我们利用 API 的信息都可以视为信息泄露，无论是有趣的状态码、头部信息还是用户数据。在发起请求时，你应该检查响应中的软件信息、用户名、电子邮件地址、电话号码、密码要求、账户号码、合作公司名称，以及目标声明为有用的任何信息。

头部信息可能会无意中泄露应用程序不必要的更多信息。有些头部信息，例如 `X-powered-by`，基本没有作用，而且常常暴露后台信息。当然，仅凭这些信息不能直接导致利用，但它可以帮助我们知道应该制作什么样的有效负载，并揭示潜在的应用弱点。

状态码也可以泄露有用的信息。如果你通过暴力破解不同端点的路径并收到状态码为 404 Not Found 和 401 Unauthorized 的响应，你就可以将 API 的端点映射出来，作为一个未授权用户。这种简单的信息泄露如果出现在带有不同查询参数的请求中，情况会变得更加糟糕。假设你能够使用查询参数，比如客户的电话号码、账户号码和电子邮件地址。然后，你可以暴力破解这些项目，将 404 视为不存在的值，将 401 视为存在的值。现在，可能不需要太多的想象力就能看出，这种信息如何对你有所帮助。你可以进行密码喷洒；测试密码重发机制，或者进行钓鱼、语音钓鱼和短信钓鱼。你也有可能将查询参数配对，利用独特的状态码提取个人身份信息。

API 文档本身可能也是一种信息泄露风险。例如，它通常是业务逻辑漏洞的一个极好信息来源，正如第三章所讨论的那样。此外，管理 API 文档通常会告诉你管理员端点、所需的参数，以及获取指定参数的方法。这些信息可以用来帮助你进行授权攻击（例如 BOLA 和 BFLA），这些内容将在后续章节中讨论。

当你开始利用 API 漏洞时，务必记录下 API 提供者给你提供的哪些头信息、独特的状态码、文档或其他线索。

## 查找安全配置错误

安全配置错误包括多种不同的项。在你测试的这个阶段，寻找冗长的错误信息、较差的传输加密和其他有问题的配置。这些问题中的每一个都可以在以后利用 API 时派上用场。

### 冗长的错误信息

错误信息旨在帮助提供方和消费方的开发人员理解发生了什么错误。例如，如果 API 要求你 POST 用户名和密码以获取 API 令牌，检查提供方如何回应已存在和不存在的用户名。对于不存在的用户名，常见的回应方式是错误信息“用户不存在，请提供有效的用户名。”当用户名存在但密码错误时，你可能会收到错误信息“密码无效。”这种小小的错误响应差异是一种信息泄露，你可以利用它暴力破解用户名，进而在后续攻击中使用。

### 较差的传输加密

在野外发现没有传输加密的 API 是罕见的。我仅在提供商认为其 API 只包含不敏感的公共信息时遇到过这种情况。在这种情况下，挑战在于你是否能够通过使用 API 发现任何敏感信息。在所有其他情况下，请务必检查 API 是否具有有效的传输加密。如果 API 传输任何敏感信息，应该使用 HTTPS。

为了攻击具有传输安全漏洞的 API，你需要执行*中间人（MITM）*攻击，拦截提供商和消费者之间的流量。因为 HTTP 发送的是未加密的流量，你将能够读取拦截到的请求和响应。即使在提供商端使用了 HTTPS，也要检查消费者是否能发起 HTTP 请求并将其令牌以明文形式共享。

使用像 Wireshark 这样的工具来捕获网络流量，查找通过你所连接的网络传输的明文 API 请求。在图 7-14 中，消费者已向 HTTPS 保护的*reqres.in*发出了 HTTP 请求。如你所见，路径中的 API 令牌是明文的。

![Wireshark 截图，显示一个 GET 请求，其中 URL 中包含用户令牌](img/F07014.png)

图 7-14：Wireshark 捕获的 HTTP 请求中的用户令牌

### 配置问题

调试页面是一种安全配置错误，可能暴露大量有用信息。我遇到过许多启用了调试功能的 API。在新开发的 API 和测试环境中，发现这种配置错误的机会更大。例如，在图 7-15 中，你不仅可以看到 404 错误的默认着陆页和该提供商的所有端点，还可以看到应用程序是由 Django 驱动的。

![显示 404 错误的网页截图，列出 API 端点，并显示一条消息：“你看到这个错误是因为在 Django 设置文件中将 DEBUG = True。”](img/F07015.png)

图 7-15：Tiredful API 的调试页面

这个发现可能会促使你研究在启用 Django 调试模式时可能会发生的恶意操作。

## 发现过度数据暴露

如第三章所述，过度的数据暴露是一种漏洞，发生在 API 提供商发送比 API 消费者请求更多的信息时。这是因为开发者设计 API 时依赖于消费者过滤结果。

在大规模测试数据暴露过多时，最好使用像 Postman 的 Collection Runner 这样的工具，它可以帮助你快速发出许多请求，并提供一种便捷的方式来查看结果。如果提供商回应的内容超过了你所需的信息，那么你可能发现了一个漏洞。

当然，并不是每一个多余的数据字节都应视为漏洞；你应该关注那些在攻击中可能有用的多余信息。真正的过度数据暴露漏洞通常是显而易见的，因为提供的数据量极大。想象一个端点能够搜索用户名。如果你查询一个用户名并收到了该用户名加上用户最后登录的时间戳，这是多余的数据，但几乎没有用处。现在，如果你查询用户名并且得到了该用户名、用户的全名、电子邮件和生日，你就找到了一个漏洞。例如，假设对*https://secure.example.com/api/users/hapi_hacker*发出的 GET 请求本应返回有关 hapi_hacker 账户的信息，但响应如下：

```
{
 "user": {
"id": 1124,
"admin": false,
"username": hapi_hacker,
"multifactor": false
}
"sales_assoc": {
       "email": "admin@example.com",
        "admin": true,
        "username": super_sales_admin,
        "multifactor": false
}
```

如你所见，曾请求过 hapi_hacker 账户，但响应中却包含了管理员账户和安全设置。响应不仅提供了管理员的电子邮件地址和用户名，还告诉你该管理员是否启用了多因素认证。这种漏洞相当常见，并且对于获取私人信息非常有用。此外，如果一个端点和方法存在过多的数据暴露漏洞，你可以肯定，其他地方也会有类似的问题。

## 发现业务逻辑缺陷

OWASP 提供了关于测试业务逻辑漏洞的建议（[`owasp.org/www-community/vulnerabilities/Business_logic_vulnerability`](https://owasp.org/www-community/vulnerabilities/Business_logic_vulnerability)）：

> 你需要评估可能利用该问题的威胁代理，以及是否能够被检测到。同样，这需要对业务有深刻的理解。这些漏洞本身通常非常容易被发现和利用，无需任何特殊工具或技术，因为它们是应用程序的支持部分。

换句话说，由于业务逻辑漏洞是每个业务及其逻辑特有的，因此很难预见你将发现哪些具体的漏洞。发现并利用这些漏洞通常只是将 API 的功能反过来用于攻击 API 提供者。

业务逻辑缺陷可能会在你查看 API 文档时就被发现，例如发现文档中指出了如何不使用该应用程序。（第三章列出了那些应该立刻引起你漏洞警觉的描述类型。）当你发现这些时，你的下一步应该显而易见：做文档中不推荐的事情！考虑以下示例：

+   *如果文档告诉你不要执行 X 操作*，那就执行 X 操作。

+   *如果文档告诉你某种格式的数据未进行验证*，上传一个反向 shell 有效负载并尝试找到执行它的方法。测试可以上传的文件大小。如果缺乏速率限制且文件大小未被验证，那么你已经发现了一个严重的商业逻辑漏洞，这将导致拒绝服务攻击。

+   *如果文档告诉你所有文件格式都可以接受*，上传文件并测试所有文件扩展名。你可以找到一个名为 *file-ext* 的文件扩展名列表供此目的使用（[`github.com/hAPI-hacker/Hacking-APIs/tree/main/Wordlists`](https://github.com/hAPI-hacker/Hacking-APIs/tree/main/Wordlists)）。如果你能够上传这些文件，下一步是检查是否能够执行它们。

除了依赖文档中的线索之外，还需要考虑给定端点的功能，以确定恶意人员如何利用这些功能为自己谋利。商业逻辑漏洞的挑战性在于它们是每个业务特有的。识别这些特性作为漏洞需要戴上你的“邪恶天才帽”，并发挥你的想象力。

## 总结

在本章中，你学会了如何查找有关 API 请求的信息，以便将其加载到 Postman 中并开始测试。接着，你学会了如何按预期使用 API，并分析响应中的常见漏洞。你可以使用所描述的技术开始对 API 进行漏洞测试。有时，所有需要做的就是以对抗性心态使用 API，便能发现关键问题。在下一章中，我们将攻击 API 的认证机制。

## 实验 #4：构建 crAPI 集合并发现过度数据暴露

在第六章中，我们发现了 crAPI API 的存在。现在我们将利用本章所学开始分析 crAPI 的端点。在本实验中，我们将注册一个账户，登录 crAPI 并分析该应用的各种功能。在第八章中，我们将攻击 API 的认证过程。现在，我将引导你完成从浏览网页应用到分析 API 端点的自然流程。我们将从头开始构建请求集合，然后逐步找到一个具有严重影响的过度数据暴露漏洞。

在 Kali 机器的网页浏览器中，导航至 crAPI 网络应用程序。在我的情况下，易受攻击的应用位于 192.168.195.130，但你的地址可能不同。注册一个 crAPI 网络应用账户。crAPI 注册页面要求填写所有字段，并具有密码复杂度要求（见图 7-16）。

![crAPI 注册页面截图](img/F07016.png)

图 7-16：crAPI 账户注册页面

由于我们对该应用程序使用的 API 一无所知，我们将通过 Burp Suite 代理请求，以查看图形界面下发生了什么。设置好您的代理并点击 **Signup** 启动请求。您应该会看到该应用程序向 */identity/api/auth/signup* 端点提交了一个 POST 请求（见 图 7-17）。

请注意，请求包含一个 JSON 有效载荷，其中包含您在注册表单中提供的所有答案。

![Burp Suite 中的 POST 请求截图](img/F07017.png)

图 7-17：拦截的 crAPI 身份验证请求

现在我们已经发现了第一个 crAPI API 请求，我们将开始构建 Postman 集合。在集合下点击 **Options** 按钮，然后添加一个新请求。确保您在 Postman 中构建的请求与您拦截的请求相匹配：向 */identity/api/auth/signup* 端点发送 POST 请求，正文为 JSON 对象（见 图 7-18）。

![Postman 中 POST 请求正文的截图](img/F07018.png)

图 7-18：Postman 中的 crAPI 注册请求

测试请求以确保它已正确构建，因为在这一点上，实际上可能有很多错误。例如，您的端点或正文可能包含拼写错误，您可能忘记将请求方法从 GET 更改为 POST，或者您可能没有匹配原始请求的头部。验证是否正确复制请求的唯一方法是发送请求，查看服务提供商如何响应，并在需要时进行故障排除。以下是排除第一个请求错误的几个提示：

+   如果收到状态码 415 Unsupported Media Type，您需要更新 `Content-Type` 头，使其值为 *application/json*。

+   crAPI 应用程序不允许使用相同的电话号码或电子邮件创建两个账户，因此如果您已经在图形界面中注册，您可能需要在请求正文中更改这些值。

当您收到状态 200 OK 响应时，您就知道请求已经准备好。收到成功响应后，务必保存您的请求！

现在我们已经将注册请求保存到我们的 crAPI 集合中，登录到 Web 应用程序查看还有哪些 API 构件可以发现。使用您注册时的电子邮件和密码代理登录请求。当您提交成功的登录请求时，您应该会收到来自应用程序的 Bearer token（见 图 7-19）。您需要在接下来的所有认证请求中包含这个 Bearer token。

![Burp Suite 中拦截的 HTTP 响应截图，突出显示了正文中的 Authorization 字段](img/F07019.png)

图 7-19：成功登录到 crAPI 后拦截的请求

将这个 Bearer token 添加到您的集合中，作为授权方法或变量。我将其作为授权方法保存，类型设置为 Bearer Token，如 图 7-20 所示。

![Postman “编辑集合”标签页的截图，其中在授权菜单项中保存了一个 Bearer Token](img/F07020.png)

图 7-20：Postman 集合编辑器

继续在浏览器中使用该应用程序，代理其流量，并将你发现的请求保存到集合中。尝试使用应用程序的不同部分，例如仪表盘、商店和社区等。务必寻找我们在本章讨论过的有趣功能。

有一个特别的端点应该引起你的注意，仅仅因为它涉及到其他 crAPI 用户：论坛。在浏览器中按预期使用 crAPI 论坛并拦截请求。向论坛提交评论将生成一个 POST 请求。将该 POST 请求保存到集合中。现在，将用于填充社区论坛的请求发送到 */community/api/v2/community/posts/recent* 端点。在列表 7-1 中的 JSON 响应正文中注意到什么重要信息了吗？

```
 "id": "fyRGJWyeEjKexxyYpQcRdZ",
        "title": "test",
        "content": "test",
        "author": {
            "nickname": "hapi hacker",
            "email": "a@b.com",
            "vehicleid": "493f426c-a820-402e-8be8-bbfc52999e7c",
            "profile_pic_url": "",
            "created_at": "2021-02-14T21:38:07.126Z"
        },
        "comments": [],
        "authorid": 6,
        "CreatedAt": "2021-02-14T21:38:07.126Z"
    },
    {
        "id": "CLnAGQPR4qDCwLPgTSTAQU",
        "title": "Title 3",
        "content": "Hello world 3",
        "author": {
            "nickname": "Robot",
            "email": "robot001@example.com",
            "vehicleid": "76442a32-f32f-4d7d-ae05-3e8c995f68ce",
            "profile_pic_url": "",
            "created_at": "2021-02-14T19:02:42.907Z"
        },
        "comments": [],
        "authorid": 3,
        "CreatedAt": "2021-02-14T19:02:42.907Z"
     }
```

列表 7-1：从 */community/api/v2/community/posts/recent* 端点接收到的 JSON 响应示例

你不仅收到了你帖子对应的 JSON 对象，还收到了论坛中每个帖子的相关信息。这些对象包含了比所需更多的信息，包括敏感信息，如用户 ID、电子邮件地址和车辆 ID。如果你已经做到这一点，恭喜你；这意味着你发现了一个过度数据暴露的漏洞。做得好！crAPI 还存在许多其他漏洞，接下来的章节中我们将利用这些发现帮助定位更多严重的漏洞。
