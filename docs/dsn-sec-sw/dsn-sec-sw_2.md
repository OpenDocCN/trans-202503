# 第二部分

设计

# 安全设计

> 过载、杂乱和混乱不是信息的特征，而是设计的失败。
> 
> —Edward Tufte

![](img/chapterart.png)

一旦你对安全原则、模式和缓解措施有了深入理解，将安全性集成到软件设计中变得相对简单。随着你识别出设计中的威胁，你可以根据需要应用这些工具，并探索能够有机降低风险的更好设计方案。

本章重点讨论安全软件设计。它是第七章的补充，后者讲述了安全设计评审。这两个主题是同一活动的不同视角。软件设计师应当在整个设计过程中考虑本章讨论的概念，并应用这些方法；他们不应将系统的安全性留给评审员来事后修补。反过来，评审员应当从威胁与缓解的角度审视设计，作为额外的安全评估层。安全设计过程是整合性的，而安全设计评审则是分析性的——两者协同使用，能够产生更好的设计，并将安全性内嵌其中。

软件设计是一门艺术，本章仅聚焦于安全性方面。无论你是按照正式流程进行设计，还是在脑中完成设计，你都不需要改变工作方式来融入这里提出的理念。威胁建模和安全视角不需要主导设计，但它们应当为设计提供参考。

这里描述的安全设计实践遵循了大型企业的典型流程，但你可以根据自己的工作方式调整这些技术。较小的组织通常会运作得更加非正式，设计师和评审员可能是同一个人。所呈现的技术采用了普适的方法，能够轻松适应你喜欢的任何软件设计方式。

## 在设计中集成安全性

> 我认为概念完整性是系统设计中最重要的考虑因素。
> 
> —Fred Brooks（摘自 *《神话般的人月》*）

设计阶段为将安全原则和模式融入软件项目提供了一个黄金机会。在这一初期阶段，你可以轻松探索各种替代方案，在投入实施并被过去的决策所束缚之前。

在设计阶段，开发人员应当创建*设计文档*，以捕捉软件项目的主要高层次特征，类似于建筑结构的蓝图图纸。我强烈建议投入精力来记录你的设计，因为这有助于确保严谨性，并且创建了一个有价值的成果，使他人能够理解你所做的决策——尤其是在平衡威胁与缓解措施以及所涉及的权衡时。

设计文档通常包括*功能描述*（从外部视角看软件是如何工作的）和*技术规格*（从内部视角看它是如何工作的）。更正式的设计在以下情况下尤其有价值：当存在竞争的利益相关者时；当需要协调更大的工作时；当设计必须符合正式的需求规格或严格的兼容性要求时；当面临困难的权衡时，等等。

当你查看一个潜在的软件设计时，戴上你的“安全帽”。然后，在编码开始之前，你可以进行威胁建模、识别攻击面、绘制数据流图等。如果提议的设计在结构上使得确保系统安全变得具有挑战性，那么现在是考虑那些固有更安全的替代方案的最佳时机。你还应该在设计文档中指出重要的安全缓解措施，以便实施者提前看到这些需求。

更有经验的设计师会从一开始就将安全性纳入设计。如果这看起来让人畏惧，完全可以从一个“功能完整”的草图设计开始，然后再重点关注安全性进行第二轮修改，但这样会增加很多工作量。如果能够在早期发现问题，进行重大更改会更容易，从而避免事后重做的浪费。尽早探索新架构并玩转基本要求，而不是拖到后期那时才开始，那时修改会更加困难。正如 Josh Bloch 曾幽默地说：“一周的编码有时可以节省一个小时的思考。”

### 使设计假设明确化

在 1980 年代中期，我为一家设计并构建计算机的公司工作，那时这台计算机是一个强大的计算机：包括硬件和软件。在多年的开发工作后，当操作系统最终加载到原型硬件上时，两支团队的工作终于结合在一起...但结果是立刻失败。原来，硬件团队大多来自 IBM，使用的是大端字节序架构，而软件团队大多来自 HP，传统上使用的是小端字节序，因此“位 0”在硬件上表示高位，在软件上表示低位。在多年的规划、会议和原型制作过程中，大家只是默认了他们所来自公司文化中的字节序。（当然，最终是软件团队在弄清楚这一点后不得不做出必要的更改。）

未成文的假设可能会削弱安全设计审查的有效性，因此设计师应尽力记录这些假设（而审查者应询问任何不明确的地方）。一个良好的记录这些显式假设的地方是设计文档中的“背景”部分，放在设计正文之前。

记录假设的一种思路是预见到可能出现的严重误解，这样你就不会再听到有人说，“但我以为. . .” 以下是一些常见的假设清单，它们对于文档化非常重要，但在设计中容易被遗漏：

+   预算、资源和时间限制，限制了设计空间

+   系统是否可能成为攻击目标

+   不可谈判的要求，如与遗留系统的兼容性

+   对系统必须执行的安全级别的期望

+   数据的敏感性及其需要安全保护的重要性

+   对系统未来更改的预期需求

+   系统必须达到的特定性能或效率基准

假设的明确化对安全性至关重要，因为误解通常是导致接口设计薄弱或组件之间交互不匹配的根本原因，攻击者可以利用这一点。此外，它还确保设计审查员对项目有一个清晰、一致的视图。

在企业内部或任何一组相关项目中，许多假设在一组设计中会保持一致，在这种情况下，您可以在共享文档中编制一份提供共同背景的清单。各个设计随后只需参考这个共同基础，并详细说明假设变化的任何例外情况。例如，计费系统可能需要遵守比其他企业应用程序更高的安全标准，并需要符合特定的金融监管要求，例如针对信用卡处理组件的要求。

### 定义范围

如果对审查范围存在不确定性，就不可能对设计的安全性进行良好的审查。明确审查范围对于回答第二章中的“四个问题”中的第一个问题也至关重要：“我们在做什么？”为了理解这一点，可以考虑一个新的客户计费系统的设计。这个设计是否包括用于收集可计费小时报告的网页应用，还是这是一个独立的设计？那么，它依赖的现有数据库呢——这些系统的安全性是否在审查范围内？审查是否应包括您将用于向企业会计系统报告的新的基于 Web 的 API 设计？

通常，设计师会做出战略性决策，定义范围，决定要处理多少内容。当范围由他人定义时，设计师必须理解规定的范围及其原因。您可以将设计的范围定义为在进程中运行的代码、在框图中表示的系统的特定组件、库中的代码、源代码库中的划分，或任何其他最合适的方式，只要它对所有相关方来说都清晰明确。前面提到的计费系统设计可能应该包括新的 API，因为它是相同设计的扩展。相反，现有的数据库可能不在范围内，只要它们没有以根本新的方式使用，并且已经进行了足够的安全审查。

如果设计范围模糊，评审人员可能会假设某些重要的安全方面不在范围内，而设计者可能未意识到这一问题。由于遗漏，它可能会被忽视。例如，几乎所有的软件设计都涉及某种数据存储。除非数据是可丢弃的，这种情况很少见，否则保持良好的备份是应对各种威胁（无论是恶意还是意外）导致完整性丧失的明显缓解措施。设计者经常忽略这种不言而喻的点，但如果没有明确的设计范围声明，每个人可能都认为其他人定期为生产系统中的所有存储进行备份，结果这个任务就被忽视了——直到第一次失败发生时，痛苦的教训才被吸取。

不要让将设计生态系统的一部分排除在范围之外，导致它被忽视。当你继承一个遗留系统时，你首先需要关注的是其最敏感的部分，那些对安全至关重要的部分，或者可能是最明显的攻击目标。然后，审慎地审查系统的其他部分，尤其是构成独立组件的部分，直到你覆盖了所有内容。

你可以通过定义一个狭窄的范围来处理设计迭代、冲刺和现有系统的重大修订，该范围对应着重新设计发生的地方。一旦你为新的设计工作划定了边界，设计中会有一些明确的前提条件，它们超出了该范围，而你可以自由地在内部重新做一切。现有的设计文档使这项工作变得更加轻松和可靠，而更新的设计应推动对文档的变更跟踪。

重设计超出预定范围是常见的，通常也是一件好事，当这种情况发生时，你应该根据需要调整范围。例如，一个增量设计更改可能需要修改现有的接口或数据格式，如果更改涉及处理更敏感的数据，你可能需要根据新的安全假设在接口的另一端进行更改。

很少有软件设计是孤立存在的；它们依赖于现有的系统、流程和组件。确保设计与其依赖项协同工作至关重要。特别是，匹配安全期望是关键，因为你不能用不安全的组件构建一个安全的应用程序。并且需要注意，安全/不安全并不是一个二元选择；它是一个连续体，其中假设和期望需要对齐。阅读同类系统和依赖项的安全设计评审报告，以验证你的安全期望。

### 设置安全要求

安全需求主要来源于四个问题中的第二个：“可能出错的地方是什么？”C-I-A 三位一体是一个有用的起点：描述保护私人数据免受未经授权披露的需求（保密性），确保数据安全并进行备份的重要性（完整性），以及系统需要多大程度的鲁棒性和可靠性（可用性）。许多软件系统的安全需求是直接明了的，但仍然值得详细列出，以确保完整性并传达优先级。对你来说可能显而易见的事情，对其他人来说可能并非如此，因此明确所需的安全立场是一个好主意。

一个需要注意的极端情况是，当安全性不重要——或者至少，有人认为它不重要时。这是一个需要特别指出的重要假设，因为团队中的其他人可能认为安全性确实很重要（你可以想象在这种期望不匹配的情况下，最终会出现什么情况）。如果你正在设计一个处理人工虚拟数据的原型，你可以跳过安全审核，但需要记录下来，以免代码后来被重新使用并涉及个人信息。另一个低安全性应用的例子可能是多个研究小组共享的天气数据收集：温度和其他大气条件是任何人都可以测量的，且公开这些数据是无害的。

在另一个极端，安全关键的软件应给予额外的关注，并仔细列举其与安全相关的需求。这些将为威胁建模、安全审查和测试提供焦点，确保最高水平的质量。请参见样本设计文档（附录 A），了解安全需求如何影响设计的基本示例。受到复杂法规约束的大型系统可能有严格规定的安全要求，以确保高水平的合规性，但这是一个专业化的任务，超出了我们讨论的范围。

对于具有关键或特殊安全需求的软件设计，请考虑以下一般指南：

+   将安全需求表达为最终目标，而不是规定“如何实现”。

+   考虑所有利益相关者的需求，特别是在这些需求可能发生冲突的情况下，需要找到一个良好的平衡点。

+   确认关键缓解措施的可接受成本和权衡。

+   当有不寻常的需求时，解释它们的动机以及目标。

+   设置可实现的安全目标，而不是完美的强制要求。

以下极端示例展示了具有显著安全需求的系统要求声明可能是什么样的：

**在国家安全局，为了保护国家最机密的秘密**

系统管理员将能访问大量极为机密的文件，考虑到这对国家安全构成的威胁，我们必须将内部攻击的风险降到最低。具体来说，能够冒充具有广泛访问权限的高级官员的管理员，可能会窃取大量文件，并通过伪造多个独立访问事件的记录，掩盖其行踪，给人一种由不同主体进行的多次独立访问的印象。（有非官方的报道指出，爱德华·斯诺登在窃取 NSA 内部文件时使用了这种技术。）

**大型金融机构的认证服务器**

服务器的私有加密密钥一旦被泄露，将完全破坏我们所有面向互联网的系统的安全性。尽管内部攻击的可能性较低，但操作人员必须*不能*拥有合理的否认能力。要求可能包括将密钥存储在防篡改硬件设备中，并保存在物理上有防护的地点，同时密钥的创建和更换过程必须经过正式仪式，并且所有访问必须由至少两名可信人员共同参与。（注意：这包括“如何做”，作为最直接的方式来说明信任分配及物理和逻辑安全的重叠结合。）

**一项昂贵的科学实验的数据完整性**

我们计划只进行一次这个实验，而且为此所需的资金可能多年都不会再有，因此我们无法承受失去仪器收集到的信息的风险。流数据必须立即复制，并冗余存储在不同的存储介质上，同时通过两条独立的网络传输到物理分离的远程存储系统，以提供额外的备份。

### 威胁建模

提高软件架构安全性的最佳方法之一是将威胁建模纳入设计过程。设计软件涉及创意性地平衡竞争的需求和策略，反复决定系统的某些方面，有时还需要倒退一步以推动整体愿景的实现。通过威胁建模的视角来看待这一过程，可以揭示设计中的权衡，因此它具有巨大的潜力，能引导设计师朝着正确的方向前进——但要准确找到如何实现更好的结果，需要一定的试错过程。

首先，有一种将威胁建模集成到软件设计中的简化方法。这涉及到构思一系列潜在的设计方案，逐个进行威胁建模，用某种总结性评估对它们进行评分，然后选择最好的方案。在实践中，这些以安全为中心的评估会影响其他重要因素，包括可用性、性能和开发成本。但由于涉及到制作多个设计方案并逐一进行威胁建模的工作量过大，设计师通常需要凭直觉判断哪些权衡提供了有前景的可能性，然后通过分析它们的差异来比较设计替代方案，而不是从头开始重新评估每一个。

在软件系统设计的早期阶段，务必注意信任边界和攻击面，因为这些对于建立一个适合安全的架构至关重要。敏感信息的数据流应尽可能远离拓扑结构中最暴露的部分。例如，考虑一个需要离线访问客户联系信息的外勤销售人员应用，以便他们在外出拜访时进行销售电话。如果将整个客户数据库放入每个移动设备中，将会带来极大的暴露风险，但如果销售人员前往没有良好网络连接的偏远地区，这可能是必要的。威胁建模将突显这一风险，促使你评估替代方案。也许只需要数据库的区域性子集，随着销售代表的位置变化或根据旅行安排动态更新；或者，销售人员可以获得每个客户的代码，配合独特的 PIN 号码，通过转接服务拨打电话，这样就不需要访问客户的电话号码了。

设计师在构建软件时，应将*基本威胁模型*视为一种基准，从中衡量替代设计。我所指的，是对理想化设计中固有的安全风险的模型，无论它是如何构建的。例如，如果一个客户端/服务器系统正在收集客户端的个人身份信息（PII），那么这些信息在客户端、传输过程中或在处理数据的服务器上暴露的安全风险是不可避免的。没有任何设计上的“魔法”能够消除这些风险，尽管它们通常需要适当的缓解措施。

当固有的安全风险较高时，设计师应尽可能考虑替代方案。继续以 PII 为例，是否真有必要为所有用例收集所有（或任何）这些信息？如果没有，那么支持一些避免从源头收集某些信息的子用例，可能会非常值得。

一个重要的威胁模型引导设计的方式是通过突出设计决策中可能引入的额外风险。例如，选择为敏感数据添加缓存层以提高响应时间，可能会带来额外的风险。额外存储数据（可能是攻击者会针对的资产）必然增加新的风险，尤其是当缓存存储接近攻击面时。这说明设计的变化总是会改变威胁模型——无论是更好还是更糟——理解安全影响后，设计人员可以明智地权衡替代方案的优缺点。

最终，好的软件设计依赖于主观判断。这些判断平衡了涉及的各种因素，以找到一个如果不是最好的，至少是令人满意的结果。尽管安全性很重要，但它不是唯一的考虑因素，因此困难的决策是不可避免的。多年来，我发现，尽管有时它可能会让人害怕，但保持开放心态讨论妥协远比宣称安全问题至上来得更有效。

当最大化安全的成本较低时，推动这种做法很容易——但情况并不总是如此。当妥协是必要时，以下是一些值得牢记的好策略：

+   设计时要考虑灵活性，以便后续能够轻松添加安全保护（也就是说，不要把自己困在不安全的角落里）。

+   如果有特定的攻击特别需要关注，可以对系统进行监控，以便于发现滥用的尝试。

+   当可用性与安全性冲突时，探索用户界面替代方案。同时，在现实情况下对可用性进行原型设计和测量；有时可用性问题是想象出来的，实际上并没有表现出来。

+   通过潜在场景（源自威胁模型）解释安全风险，这些场景说明了某些设计的主要潜在缺点，并利用这些场景展示不实施缓解措施的成本。

## 构建缓解措施

在定义了软件系统的范围和安全需求，回答了四个问题中的前两个之后，是时候考虑第三个问题：“我们该怎么做？”这个问题引导设计人员将所需的保护和缓解措施融入设计中。在接下来的子章节中，我们将探讨如何针对接口和数据这两个在软件设计中最常见的主题进行缓解措施的设计。接下来的讨论和示例仅触及设计缓解措施的表面。前三章中的所有想法可以根据具体设计的需求进行应用。

### 设计接口

接口定义了系统的边界，划定了设计或其组成组件的限制。它们可能包括系统调用、库、网络（客户端/服务器或点对点）、进程间和内进程 API、共享数据结构以及常见数据存储中的更多内容。复杂的接口，如安全通信协议，通常需要单独的设计。

定义设计范围内的所有接口，确保你清楚了解共享接口的组件的安全责任。记录输入是否得到可靠验证，或者应将其视为不可信数据。如果存在信任边界，说明如何处理身份验证和授权以跨越该边界。

外部组件的接口（设计范围外的组件）应遵循这些组件的现有设计规范。如果没有相关信息可用，要么记录你的假设，要么考虑采取防御策略来弥补不确定性。例如，如果无法确认输入是否被验证，则假定其为不可信输入。

设计安全接口时，首先需要明确描述它们的工作方式，包括必要的安全属性（即 C-I-A、金标准或隐私要求）。审查接口的安全性相当于验证它们是否能够正常工作，并保持对潜在威胁的强大抵抗力。除非设计师明确安全要求，否则安全审查员（以及后续使用该接口的开发者）将不得不猜测设计师的意图，如果低估或高估了要求，可能会引起混淆。

有时，你不得不使用那些在设计时未考虑安全性或对你的要求安全性不足的现有组件——或者你根本不知道这些组件的安全性。如果你别无选择，请将其标记为问题，并尽可能做一些研究，了解有关这些组件安全性的信息（这可能包括尝试攻击测试样本）。在某些情况下，另一个选择是包装接口以增加安全保护。例如，给定一个容易泄露数据的存储组件，你可以设计一个额外的软件层，提供加密和解密，确保该组件仅存储加密数据，即使泄露也不会造成危害。

### 数据处理设计

数据处理是几乎所有设计的核心，因此确保数据安全是一个重要步骤。确保数据安全处理的一个良好起点是概述你的数据保护目标。当某一特定数据子集需要额外保护时，要明确指出，并确保在整个设计中一致处理。例如，在在线购物应用中，对信用卡信息应用额外的保护措施。

限制敏感数据流动的需求。这是一个在设计阶段显著减少风险暴露的关键机会（参见第四章中的“最少信息”模式），通常在后续的实施阶段难以做到。减少数据传输需求的一种方法是将数据与一个不透明的标识符关联，然后将标识符作为句柄，在必要时将其转换为实际数据。例如，在附录 A 中的示例设计中，你可以使用这种标识符来记录交易，从而将客户细节隔离在系统日志之外。在需要调查日志条目的少数情况下，审计员可以查找相关细节。

确定公共信息或任何其他不受保密要求约束的数据。这是数据处理要求的一个重要例外，允许在合适的情况下放宽保护措施。在应用这种方法时，记住数据是具有上下文敏感性的，因此公开的数据与其他信息结合时可能变得敏感。例如，大多数企业的地址和其首席执行官的名字通常是公共信息。然而，哪些命名的人在场时应当保持私密。

在没有明确决定的情况下，始终将个人信息视为敏感信息，只有在有特定用途时才收集此类数据。无限期存储敏感数据会产生无尽的保护义务。你可以通过在可能的情况下销毁不再使用的信息来避免这种情况（例如，在若干年没有使用后）。设计应当预见到在不再需要时最终删除私密数据的需求，并明确哪些条件将触发删除，包括备份副本的删除。

## 将隐私融入设计

未能保护私人信息经常成为新闻头条。我相信，将信息隐私考虑融入软件设计是公司提升表现的重要方式。隐私问题涉及数据保护的人类影响，不仅包括法律和监管问题，还涉及客户期望和未经授权的披露可能带来的影响。要做到这一点，既需要专业的知识，也需要主观判断。但问题的部分关键在于授予第三方使用数据的权限，这需要允许访问。从这个角度看，良好的软件设计可以建立控制措施，以尽量减少失误。

作为起点，设计师应该熟悉所有适用的隐私政策，并了解这些政策与设计的关系。提出问题，并最好从隐私政策的拥有者那里获得书面答复，以确保要求明确。这包括任何可能适用于通过合作伙伴获取的数据的第三方隐私政策义务。这些隐私政策规范数据的收集、使用、存储和共享，因此如果这些活动发生在设计中，政策条款就意味着需要遵守的要求。如果面向公众的隐私政策内容简略，考虑开发一个内部版本来描述必要的细节。

隐私失误通常发生在人员或流程误解政策中的承诺，或根本没有考虑这些承诺时。数据安全保护为设计中内建限制提供了机会，以确保合规性。首先考虑隐私政策作出的明确承诺，然后确保设计在可能的情况下执行这些承诺。例如，如果政策声明“我们不会共享你的数据”，那么除非采取其他措施确保配置错误不会暴露数据，否则应该谨慎使用便于共享的云存储服务。

审计是隐私管理的重要工具，即使仅仅是为了可靠地记录对敏感数据的适当访问。通过对访问的仔细监控，可以及早发现并修正问题访问和使用。在泄露发生后，如果没有记录谁访问了相关数据，那么就很难有效应对。

在可能的情况下，设计明确的隐私保护措施。在无法判断隐私合规性的情况下，请让负责隐私政策的官员在设计上签字。一些常见的将隐私整合到软件设计中的技巧包括：

+   确定新类型数据的收集，并确保其隐私政策的合规性。

+   确认政策允许你出于预定目的使用数据。

+   如果设计可能允许无限制的数据使用，考虑将访问权限仅限于那些熟悉隐私政策限制并能够审核合规性的员工。

+   如果政策限制数据保留的期限，设计一个确保及时删除的系统。

+   随着设计的发展，如果数据库中的某个字段不再使用，考虑将其删除，以减少泄露的风险。

+   考虑为数据共享建立审批流程，以确保接收方已获得管理层批准。

## 规划完整的软件生命周期

许多软件设计隐含地假设系统会永远存在，忽略了所有软件都有生命周期有限的现实。从系统的首次发布和部署，到更新和维护，再到最终的退役，系统生命周期的许多方面都具有重要的安全隐患，往往在后期容易被忽视。无论任何软件设计多么出色，无论它是取得成功还是失败，它都会随着环境的变化而经历变化。这些变化的影响最好是在设计过程中预见并加以解决，或者至少记录下来以备后续参考。在企业内部，许多这些问题是通用的，一般性处理应该能涵盖大多数系统，具体的例外则应在个别设计中做出说明。

当新的设计正在创建时，很难想象系统生命周期的终结，但大多数影响应该是清晰的，任何设计至少应考虑数据的长期处理方式。特定的法律或商业原因可能要求你保留数据一段时间，但当数据不再需要时，你应该将其销毁，包括备份副本。一些系统在接近生命周期末期时需要经历特定阶段，良好的设计可以通过从一开始就有合适的结构和配置选项来简化这一过程。例如，一个采购系统可能停止接受订单，但仍需要继续提供数据用于薪资和记录保存目的，可能需要再保留一年，然后将交易记录归档以长期保存。

## 做出权衡

在没有简单选择的情况下进行权衡取舍需要大量的工程判断，同时要权衡许多其他因素。实施更多的安全缓解措施可以减少风险，但只限于复杂性导致更多漏洞的前提下——你应该始终警惕开发投入增加而回报递减的现象。本书将一再建议设计人员在相互竞争的优先级之间做出妥协，但这说起来容易做起来难。本节将介绍一些用于做出这些重要平衡的经验法则。

预见最坏的情况：如果无法保护某个系统资产的机密性、完整性或可用性，情况会有多糟糕？对于每种情境，都有不同程度的灾难需要考虑：数据可能受到多大程度的影响？在什么情况下，系统不可用的时间段会变成严重问题？主要的缓解措施通常会限制最坏情况的发生；例如，按小时备份应该能确保最多只有一个小时的交易数据面临丢失的风险。需要注意的是，在最坏情况下，机密性的丧失尤其难以界定，因为一旦数据被窃取，通常无法想象有任何方法能够撤销信息泄露（2017 年 Equifax 数据泄露事件就是一个典型例子）。

大多数设计工作发生在企业或项目社区内，其中所需的安全级别通常在不同项目之间保持一致。对于某些特定的设计，可能需要偏离常规——要求更高或更低的安全级别——这种假设非常值得在设计前言中指出。一些例子可以帮助阐明这一点。一个在线商店网站应当考虑为处理信用卡支付的软件设定更高的安全标准，因为它是明显的攻击目标，并且由于其巨大的财务责任，受到特殊要求的约束。另一方面，一个网页设计公司可能会展示一个展示其设计案例的网站；由于该网站仅供信息展示，从不收集实际用户数据，因此其安全性要求合理地较低。

设计阶段是平衡软件中竞争需求的最佳时机。坦白说，安全性往往很难在面对时间表截止、预算和人力限制、遗留兼容性问题以及通常冗长的功能需求清单时，作为首要优先事项来全面支持——换句话说，几乎总是如此。设计人员最处于考虑多种替代方案（包括激进方案）并做出基础性更改的最佳位置，而这些改变后来再做将是不可行的。

在这些理想化原则与构建实际系统的务实需求之间找到正确的平衡，是安全软件设计的核心。完美的安全性从来不是目标，额外缓解措施的效益也是有限的。确切的平衡点往往难以确定，但那些能够明确这些权衡的设计更有可能找到一个合理的折衷方案。

## 设计的简洁性

> 简单即是终极的精致。
> 
> —列奥纳多·达·芬奇

讽刺的是，正如达·芬奇的名言所暗示的，要想设计出一个简单的方案，往往需要大量的思考和努力。早期的天文学家为天体力学开发了各种复杂的计算，直到哥白尼通过将太阳作为中心参考点，而非地球，简化了模型，进而使牛顿能够通过推导重力定律来大大简化计算。我最喜欢的精彩软件设计例子是*nix 操作系统的核心，其中很多部分至今仍在使用。追求创造出一个简洁美观的设计，即使很少实现，往往直接有助于提升安全性。

在软件设计中，简洁有许多不同的表现形式，但没有简单的公式可以发现最简洁、最优雅的设计。在第四章中讨论的几个模式倡导简洁，如设计经济性和最小共同机制。每当安全性依赖于将某些复杂的决策或机制做到完美时，务必小心：看看是否有更简单的方式达到相同的目的。

当复杂的功能与安全机制相互作用时，结果往往会变得非常复杂。一项研究得出结论，1979 年三里岛核电站事故没有特定原因，而是由于系统的极度复杂性，包括其许多冗余的安全措施。安全性可能会妨碍你正在做的事情，而与此同时，确保一切安全变得更加棘手。这里的解决方案通常是将安全性与功能分离，创建一个分层模型，通常是将安全性放在“外部”作为保护壳，所有功能则单独存在于“内部”。然而，当你设计一个硬壳和“软内芯”时，确保这种分离就变得至关重要。设计一个围绕城堡的安全护城河相对容易，但在软件中，很容易无意间打开一条通往内部的路径，从而绕过外部保护层。

# 安全设计评审

> 一次好的、富有同情心的评审总是一个令人惊喜的发现。
> 
> —乔伊斯·卡罗尔·欧茨

![](img/chapterart.png)

将安全性嵌入软件的最佳方式之一是以“安全帽”身份单独审查设计。本章解释了如何在*安全设计评审*（*SDR*）中应用上一章讨论的安全性和隐私设计概念。可以将这个过程类比为建筑师设计建筑物后，工程师审查设计以确保其安全可靠。设计师和评审者都需要了解结构工程和建筑规范，通过共同合作，他们可以实现更高的质量和信任水平。

理想情况下，安全评审员是没有参与设计工作的人员，这样可以保持距离和客观性，同时也是熟悉软件运行环境及其使用方式的人员。然而，这并不是硬性要求；对于不太熟悉设计的评审员来说，他们可能会问更多问题，但也能做得很好。

分享这些方法并鼓励更多的软件专业人员亲自进行 SDR（安全设计评审）是我写这本书的核心目标之一。你几乎可以肯定地在自己熟悉的、工作中使用的软件系统上进行更好的 SDR，而不是那些有更多安全经验但不熟悉这些系统的人。本书提供了帮助你完成这项任务的指南，我希望通过这样做，它能在某种程度上为提高软件安全水平做出小小的贡献。

## SDR 后勤

在介绍 SDR 的方法论之前，了解一些基本的背景和基本的后勤安排是很重要的。SDR 的目的是为了什么？如果我们要进行 SDR，它应该在设计流程的哪个阶段进行？最后，我会给出一些关于准备工作的小建议，特别是文档的重要性。

### 为什么要进行 SDR？

做过几百次 SDR 后，我可以报告说，它从来不会让人觉得浪费时间。SDR 只占总设计时间的极小一部分，要么可以发现重要的改进来增强安全性，要么能提供强有力的保证，确保设计能够正确处理安全问题。简单直接的设计很快就能评审，而对于较大的设计，评审过程提供了一个有用的框架，帮助识别和验证主要的安全隐患。即使是评审一个表面上看似已经涵盖所有安全要点的设计，确认这一点也是一种良好的尽职调查。当然，当 SDR 发现重大问题时，这项工作就变得极为值得，因为在实施阶段发现这些问题会很困难，而事后解决它们的成本则非常高。

此外，SDR 还可以带来有价值的新见解，从而导致与安全无关的设计变更。SDR 提供了一个很好的机会，可以让不同的视角参与进来（如用户体验、客户支持、市场营销、法律等），每个人都能思考那些容易被忽视的话题，例如滥用的潜力和意外后果。

### 何时进行 SDR

计划在设计（或设计迭代）完成且稳定时进行 SDR，通常是在功能评审之后，但在设计最终确定之前，因为可能会需要做出更改。我强烈建议不要在功能评审中同时处理安全问题，因为思维方式和关注点差异太大。另外，确保每个人——不仅仅是评审者——都能专注于安全问题非常重要，而在功能评审和安全评审混合时，这一点就很难做到，因为大家的注意力往往集中在设计的工作原理上。

复杂或安全关键的设计通常会受益于一个额外的初步 SDR，在设计开始成型但尚未完全完成时，提前获取对主要威胁和总体策略的反馈。初步 SDR 可以更为非正式，预览特定的安全关注点（你预计在这些地方深入挖掘）并从高层次讨论安全权衡。优秀的软件设计师应该始终在设计过程中考虑并解决安全和隐私问题。明确来说，设计师*绝不*应忽视安全问题，指望 SDR 来解决这些问题。他们应该始终对自己设计的安全性负责，安全审查者则在支持角色中协助确保他们做得足够彻底。反过来，安全审查者也不应当居高临下地讲授，而应当清晰且有说服力地向设计师呈现他们的发现，而不做评判。

### 文档至关重要

有效的 SDR 依赖于最新的文档，以便各方对正在审查的设计有准确、一致的理解。非正式的口头传达式 SDR 总比没有好，但重要的细节很容易被遗漏或误传，而没有书面记录的情况下，宝贵的成果也容易丢失。就个人而言，我总是更倾向于在会议前预览设计文档，这样我可以提前开始研究设计，而不是在会议中浪费时间去了解我们正在处理的内容。

根据我的经验，设计文档的质量在交付一个优秀的 SDR 中是不可或缺的帮助。当然，实际操作中可能并没有完备的文档，而从第 122 页开始的案例研究讨论了如何处理这种情况。例如，任何设计文档模糊地指出“安全地存储客户数据”都应当引起极大的警惕，除非它进一步说明这是什么意思以及如何做到这一点。没有具体细节的笼统说法几乎总是表现出幼稚和对安全缺乏扎实理解的迹象。

## SDR 过程

以下对 SDR 过程的解释描述了我在一家大型软件公司如何进行这些过程的，该公司有正式的、强制性的审查流程。话虽如此，软件设计有着无数种不同的实践方式，你可以将相同的策略和分析方法应用于不太正式的组织。

从一个清晰完整的书面设计开始，SDR 包括六个阶段：

1.  *学习*设计和支持文档，以便对项目有一个基本的理解。

1.  *询问*设计并提出关于基本威胁的澄清问题。

1.  *识别*设计中最为安全关键的部分，以便重点关注。

1.  *合作*与设计师一起识别风险并讨论缓解措施。

1.  *撰写*调查结果和建议的总结报告。

1.  *跟进*后续的设计更改，以确认问题已解决，然后再签字确认。

对于小型设计，你通常可以在一个会议中完成大部分工作；对于较大的设计，按阶段分解工作，一些阶段可能需要多次会议才能完成。专门与设计团队会面的会议是理想的，但如果有必要，审阅者可以独立工作，然后通过电子邮件或其他方式与设计团队交换笔记和问题。

每个人的风格都不同。有些审阅者喜欢直接深入，进行“马拉松式”的工作。我个人更倾向于（并推荐）分几天逐步进行，这样我可以有机会“过夜思考”，这通常是我最好的思考时刻。

以下是 SDR 过程的逐步讲解，解释了每个阶段，并列出了有用的技巧。你在执行 SDR 时可以参考每个阶段的要点，按照流程进行。

### 1. 学习

研究设计和支持文档，以便为审阅做好准备，从而获得对软件的基本理解。除了安全知识外，审阅者理想情况下还应具备领域特定的专业知识。如果没有这方面的知识，尽量在过程中多了解一些，并保持好奇心。大多数安全决策都会涉及权衡，因此单纯地追求更多的安全可能会做得过头，甚至有可能在过程中毁掉设计。为了理解过多的安全如何适得其反，可以想象一座只为减少火灾风险而设计的房子。它完全由混凝土建成，只有一扇厚重的钢门，没有窗户，这样的房子不仅成本高昂，而且丑陋，没人愿意住在里面。

在这个准备阶段：

+   首先，阅读文档，了解设计的高层次概况。

+   接下来，戴上你的“安全帽”，以威胁意识的心态重新审视设计。

+   记笔记，记录你的想法和观察，以备将来参考。

+   标记潜在问题，但在这个阶段进行深入的安全分析为时过早。

### 2. 询问

向设计师提出澄清性问题，了解系统的基本威胁。对于容易理解的简单设计，或者当设计师提供了非常完善的文档时，你可能可以跳过这一步。将其视为一个机会，在继续进行之前确认你对设计的理解，并解决任何模糊不清或未解答的问题。审阅者并不需要对设计了如指掌才能有效工作——那是设计师的工作——但你需要对设计的总体框架以及主要组件如何交互有一个扎实的了解。

这是一个在深入之前填补空白的机会。以下是一些建议：

+   确保设计文档清晰完整。

+   如果有遗漏或需要修正的地方，帮助在文档中修复它们。

+   理解设计到足以能进行交流，但不一定要达到专家级别。

+   询问团队成员他们最担心的是什么；如果他们没有安全方面的担忧，问一些后续问题以了解为什么没有。

作为安全审查员，你提出的问题不必仅限于设计文档中的内容。了解同行系统对于评估它们对设计安全性的影响非常有帮助。遗漏的细节往往最难发现。例如，如果设计隐式地存储数据，但没有提供如何处理这些数据的任何细节，应该询问存储方式及其安全性。

### 3. 识别

识别设计中关键的安全部分，并重点进行分析。基于基本原则，以安全视角进行思考：考虑 C-I-A、黄金标准、资产、攻击面和信任边界。虽然这些部分需要特别关注，但此时的安全审查应聚焦于整体设计，而不是完全忽视其他部分。话虽如此，对于与安全关系不大或几乎没有关系的设计部分，可以跳过。

在这个探索阶段，你应该：

+   审查接口、存储和通信——这些通常是重点关注的地方。

+   从最暴露的攻击面向最有价值的资产进行深入分析，就像攻击者会做的那样。

+   评估设计在多大程度上明确考虑了安全性。

+   如有必要，指出关键保护措施，并确保它们在设计中作为重要特性被明确标出。

### 4. 合作

与设计者合作，传达发现并讨论替代方案。理想情况下，设计者和审查员应该会面讨论，一一解决问题。这是一个学习过程：设计者获得对设计的新视角，同时学习安全知识；审查员则深入理解设计、设计者的意图，并加深对安全挑战和最佳缓解方案的理解。共同的目标是使设计整体变得更好；虽然安全是审查的重点，但并非唯一考虑因素。不必当场做出关于更改的最终决定，但最终需要达成一致，确定哪些设计更改值得考虑。

以下是有效合作的一些指南：

+   作为审查员，在需要的地方提供关于风险和缓解措施的安全视角。即使设计本身已经安全，这也能起到加强良好安全实践的作用。

+   考虑绘制一个场景，说明安全更改如何在未来带来收益，帮助说服设计者采取缓解措施的必要性。

+   当可能时，提供多种解决方案，并帮助设计者了解这些替代方案的优缺点。

+   接受设计者拥有最终决定权，因为他们对设计负有最终责任。

+   记录思想交流的过程，包括哪些内容会或不会被纳入设计。

扩展“最后决定”：在实践中，这一平衡将取决于组织及其文化、适用的行业标准、可能的监管要求和其他因素。在大型或高度规范化的组织中，最后决定可能涉及多个方签字，包括架构委员会、标准合规官、可用性评估人员和执行利益相关者。当需要多方批准时，设计师必须平衡相互冲突的利益，因此安全评审员应特别关注这一动态，并尽可能灵活。

### 5\. 写作

撰写关于评审结果和建议的*评估* *报告*。结果是安全评审员对设计安全性的评估。报告应着重于可能需要考虑的设计变更，以及对现有设计安全性的分析。设计师已同意的任何变更应明确标出，并且需在后续进行验证。可以考虑为建议的变更提供优先级排名，例如这个简单的三层方案：

+   *Must*是最强的排名，意味着应该没有选择，且通常暗示紧急性。

+   *Ought*是中等排名：我用它来表示我作为评审员倾向于“Must”，但这也是可以讨论的。

+   *Should*是针对可选推荐变更的最弱排名。

在设计阶段，给出更精确的排名较为困难，但如果你想尝试，13 章提供了关于如何系统地为安全漏洞分配更细化排名的指导，这些方法可以很容易地用于此目的。

SDRs 变化较大，因此我从未使用标准化的评估报告模板，而是编写描述发现结果的叙述。我喜欢根据自己在评审过程中做的粗略笔记来工作，报告的最终形式自然地演变。如果你能可靠地记住所有细节，可能会想在评审会议后再写报告。

以下提示也可作为写作的框架：

+   以具体的设计变更为中心组织报告，解决安全风险问题。

+   将大部分精力和文字投入到最高优先级问题上，对于较低优先级问题则相应减少。

+   提出替代方案和策略，但不要试图替设计师做他们的工作。

+   使用优先级排名来确定发现问题和建议的优先顺序。

+   聚焦于安全性，但也可以提供独立的意见供设计师参考。在 SDR 范围之外，保持更多的尊重，不要挑剔，避免稀释安全性信息。

将设计师和评审人员的角色分开很重要，但实际上如何分配角色会根据每个人的职责和协作能力有很大的差异。在评估报告中，避免做设计工作，而是为需要的修改提供明确的指导，以便设计师知道该做什么。如果当前评审的结果导致了重要的设计重做，可以提供审阅和反馈。作为一个经验法则，一个好的评审人员能帮助设计师看到安全威胁及其潜在后果，并提出缓解策略，而不是强加具体的设计变更。过于苛刻的评审人员往往会发现他们的建议无效，即使它是正确的，而且他们有可能迫使设计师做出自己并不完全理解或不认为必要的改变。

如果这种严格的写报告方式感觉过于繁琐，你可以减少报告的编写工作，但很有可能你或其他参与软件开发的人以后会希望将这些细节记录下来，以供日后参考。至少，我建议花时间向团队发送一封电子邮件总结，以留存记录。即使是一个简短的报告，也不应仅仅说“看起来不错！”，而应该用实质性的总结来支持这一点。如果设计涵盖了所有的安全要点，可以提到一些安全所依赖的最重要的设计特征，以突出它们的重要性。如果设计中安全性不是重点（例如，我曾审查过一个不收集任何私人信息的资讯网站），应当概述得出这一结论的原因。

这些报告的风格、长度和细节程度会根据组织文化、可用时间、利益相关者人数以及许多其他因素有很大的不同。当作为评审人员时，你与软件设计师紧密合作时，可能可以将所需的条款直接纳入设计文档，而不是在报告中列举需要改进的问题。即使是小型非正式项目，指定设计师和评审人员的角色也是值得的，这样可以有多个视角来审视工作，并确保安全问题得以充分考虑。然而，即使是独立设计，也能从设计师带着安全思维重新审视自己的工作中获得新视角的益处。

### 6\. 后续跟进

跟进由于安全评审而进行的设计变更，以确认这些变更是否得到正确解决。当合作顺利时，我通常只检查文档更新是否完成，而不查看实现细节（根据我的经验，这种方法从未出错）。在其他情况下，并根据你的判断，评审者可能需要更加警觉。评审完成后，确认所有必要的更改都已完成，并签署评审意见。在项目缺陷追踪系统中指定 SDR 是可靠跟踪进展的好方法。否则，如果你更喜欢，也可以使用更正式或不那么正式的过程。以下是这一最终阶段的一些建议：

+   对于重大的安全设计变更，你可能需要与设计师合作，以确保变更正确地实施。

+   在意见分歧的情况下，评审者应陈述双方立场，并指出未采纳的具体建议，将其标记为一个未解决的问题。（第 121 页的“管理分歧”详细讨论了这个话题。）

在最佳情况下，设计师会把评审者视为安全资源，并在需要时继续进行合作。

## 评估设计安全性

现在我们已经涵盖了 SDR 过程，本节将深入探讨进行评审时的思维过程。到目前为止，本书中的材料为你提供了进行 SDR 所需的概念和工具。基础原则、威胁建模、设计技术、模式、缓解措施、加密工具——这些都为构建一个安全的设计奠定了基础。

### 使用四个问题作为指导

第二章用于威胁建模的四个问题是帮助你进行有效 SDR 的绝佳指南。显式的威胁建模如果你有时间并愿意投入精力是非常好的，但如果没有时间，使用这四个问题作为基准也是将威胁视角融入评审的好方法。后面的子章节将提供更详细的解释，但从最高层次来说，以下是这些问题如何映射到 SDR 的：

1.  *我们在做什么？*

    评审者应该理解设计的高层目标，以此作为评审的背景。*实现目标的最安全方式是什么？*

1.  *可能会出什么问题？*

    这就是“安全帽”思维的应用，以及如何应用威胁建模的地方。*设计是否未能预见到或低估了一个关键威胁？*

1.  *我们该怎么做？*

    回顾你在设计中发现的保护措施和缓解措施。*我们能以更好的方式应对重要的威胁吗？*

1.  *我们做得好吗？*

    评估设计中的缓解措施是否足够，是否需要进一步完善，或是否有任何遗漏。*设计有多安全，如果不够，如何提升其安全性？*

在编写 SDR 时，你可以使用“四个问题”作为提示。如果你已经阅读了设计文档，并注意到关注的领域，但尚不完全确定需要寻找什么内容，可以依次检查四个问题，特别是第 2 和第 3 个问题，并考虑它们如何适用于设计的具体部分。从那里，你的评估自然会转向第 4 个问题。如果答案不是“我们做得很好”，那么这很可能是一个值得讨论的主题，或者是你应当在评估报告中包含的内容。

#### 我们正在做什么？

这个问题有几种具体的方式帮助你保持正轨。首先，了解设计的目的非常重要，这样你可以自信地提出削减那些带来风险但实际上不必要的部分。相反，当你提出更改时，你不希望破坏实际上是必须的功能。或许最重要的是，你可能能够提出一种替代方案，以避免风险较大的功能并采取新的方向。

例如，在隐私领域，如果你在审查一个收集所有员工个人信息的薪资系统，你可能会发现健康问题特别敏感。如果相关数据项确实多余，那么从设计中删除它是正确的选择。然而，如果它对业务功能至关重要，你可以提出一些方法来严格保护这些数据的泄露（例如，早期加密，或在短时间内删除数据）。

#### 可能出错的地方？

审查应该确认设计者已经预见到系统面临的重要威胁。而且，仅仅知道这些威胁是不够的；设计者必须实际上创建一个能够应对这些威胁的设计。

某些威胁可能是可接受的，并且可以不加以缓解，在这种情况下，审查员的工作是评估这个决定。但是，重要的是要确保设计者意识到这个威胁，并选择省略缓解措施。如果设计中没有明确说明他们正在这么做，请在 SDR 中备注，以便再次确认这是故意的。同时，注明接受的风险并解释为什么它是可以容忍的。例如，你可以写道：“传输中的未加密数据构成了窃听威胁。然而，我们认为这个风险是可以接受的，因为数据中心已得到物理保护，且没有泄露个人身份信息或商业机密数据的潜在风险。”

尝试预见未来可能会使接受风险的决策失效的变化。以刚才提到的例子为基础，你可以补充道：“如果系统迁移到第三方数据中心，我们应当重新审视这个物理网络访问风险的决策。”

#### 我们将如何处理它？

安全保护机制和缓解措施应该在设计中显而易见，审阅者在研究设计时通常会专注于这方面。审阅者通常将大部分时间花在最后两个问题上：识别设计的安全性以及评估其安全性。处理这个任务的一种方法是将威胁与缓解措施匹配，看看是否覆盖了所有基础。指出由此问题引发的问题并确认设计是否令人满意，是 SDR 最重要的贡献之一。

如果设计未能有效缓解安全风险，那么你应该列出缺少的内容。为了使反馈有用，你需要解释具体哪些威胁没有得到解决，以及为什么它们很重要，并可能提供一组粗略的选项来应对每个问题。出于多种原因，我建议不要在 SDR 中提出具体的解决方案。然而，非正式地提供帮助并与设计师合作，考虑替代方案或详细阐述设计更改是非常好的。例如，你的反馈可以是：“监控 API 不应该公开暴露，因为它透露了我们网站的使用水平，这可能会给竞争对手带来优势。我建议要求使用访问密钥来认证对 RESTful API 的请求。”

当设计确实为某个特定威胁提供了缓解措施时，评估其有效性，并考虑是否可能有更好的替代方案。有时候，设计师通过从头开始构建安全机制来“重新发明轮子”：一个好的反馈是建议使用标准库来代替。如果设计是安全的，但这需要付出很大的性能代价，如果可能的话，提出另一种方式。例如，指出冗余的安全机制，如加密通过加密的 HTTPS 连接发送的数据，并描述如何简化设计。

#### 我们做得好吗？

最后一个问题归结到关键点：你认为这个设计安全吗？称职的设计师应该已经考虑了安全问题，因此，SDR 的价值在于确保他们已经看到了整个局面并预见了主要威胁。根据我的经验，SDR 能够迅速识别问题和机会，或者至少提出一些值得现在考虑的有趣权衡决策（因为之后你就无法轻松做出更改了）。

我建议在报告的顶部用一句话总结你对整个设计的整体评价。以下是一些可能的例子：

+   我发现当前设计已经足够安全，并没有建议的更改。

+   设计是安全的，但我有一些建议可以使其更加安全。

+   我对当前设计有一些担忧，并提出了一些建议，以增强其安全性。

在总结之后，如果有多个需要修复的不足部分，逐一列出并逐条解释。如果你能够将弱点归因于设计的某个具体部分，这将使设计师更容易找到问题，清晰地看到并采取必要的补救措施。

当然，没有设计是完美的，所以在评判一个设计存在不足时，明确你所依据的标准非常重要。这很难抽象地表达，因此一个好的方法是指出具体的威胁、漏洞和后果，以支持你的观点。最好将评估以与类似产品的安全性进行对比；例如，“我们的主要竞争对手声称自己能够抵御勒索病毒攻击，这是其主要卖点，但由于该设计将库存数据库保存在员工还用来上网的计算机上，这使得它特别容易受到此类攻击。”

### 挖掘的重点在哪里

在大型设计中深入每个角落是不可行的，因此审查员需要尽可能快速地关注那些对安全至关重要的关键区域。我鼓励安全审查员在决定将精力集中在哪些设计部分时，遵循自己的直觉。首先通读设计，并根据直觉标记出感兴趣的区域。接着，回到最有问题的区域，更加仔细地研究，并收集需要提问的问题，让潜在的威胁和“四个问题”成为你的指南。这些线索中，有些比其他的更有成效。如果你开始走上一条无效的路径，通常会很快意识到，从而可以将精力重新集中到其他地方。

对于与安全和隐私无关的设计部分，可以快速浏览，吸收足够的内容以对所有组件有一个基本了解。如果你把自己锁在家外，你会知道去检查是否有开着的窗户或未锁的门：没有人会花时间一寸寸地检查整个外部。同样，最有效的方式是集中精力关注设计中你发现的任何弱点，或者密切关注设计如何保护最重要的资产。

留意攻击面并给予足够的关注。攻击面越容易接触到——匿名的互联网暴露是最糟糕的经典情况——它们越可能成为潜在的攻击源。保护重要资源的信任边界，尤其是当这些资源可以从攻击面访问时，是设计中审查员应当特别强调的主要通用特征。有时，可以将宝贵的资产更好地与外部组件隔离开，但往往暴露是不可避免的。这些就是审查员在整个过程中需要寻找并评估的因素。

### 隐私审查

根据你的技能和组织责任，你可能希望在 SDR 范围内处理信息隐私，或者单独处理。SDR 中的隐私反馈应聚焦于适用的隐私政策，以及它们如何与设计范围内的数据收集、使用、存储和共享相关。

一种有效的技巧是浏览隐私政策并记录与设计相关的段落，然后寻找防止违规的方法。正如前一章所描述的，技术重点是确保设计符合政策要求。对于需要更多专业知识的问题，获取隐私专家和法律人员的签字批准。

### 审查更新

一旦发布，软件似乎拥有了自己的生命，随着时间的推移，变化是不可避免的。特别是在敏捷开发或其他迭代开发实践中，设计变更是一个持续的过程。设计文档很容易在过程中被忽视，几年后可能会丢失或变得无关紧要。然而，软件设计的变更可能影响其安全性特性，因此进行增量 SDR 更新以确保设计保持安全是明智之举。

设计文档应是活文档，记录软件架构形式的演变。版本化文档是设计如何成熟（或者在某些情况下变得复杂）的重要记录。你可以使用这些相同的文档作为指南，专注于自上次 SDR 以来的具体变更集（设计差异），以更新文档。当设计的安全关键区域发生变化（或接近变化）时，审查员通常应该跟进，确保设计文档中没有遗漏任何小但重要的细节，这些细节可能会产生重大影响。如果增量审查确实发现了重要内容，将其加入现有的评估报告中，使其现在能够完整地呈现情况。如果没有发现，更新报告以注明它覆盖的设计版本即可。

低估“简单变更”的影响是引发安全灾难的常见诱因，重新审查设计是主动有效评估此类影响的好方法。如果设计变更如此微小，以至于不需要审查，那么审查员也可以立刻确认没有安全影响。对于任何非琐碎的设计变更，我建议不要跳过 SDR 更新，因为忽视这个重要的保障措施可能带来风险。

## 管理分歧

> 无论你做什么，生活中要与你那些会与你争论的聪明人相伴。
> 
> —约翰·伍登

我从多年推广安全性的经验中得到的一个重要教训——虽然事后看来显而易见，但我通过艰难的方式学到的——是良好的沟通技巧对于成功进行 SDR 至关重要。分析当然是技术性的，但对设计进行批评需要良好的沟通和协作，因此人际因素也很关键。安全专家，无论是内部人员还是外包人员，往往会得到（是否应得的另说）他们过于挑剔、永远不满足的外号。这种看法在微妙地毒化互动时，不仅让工作变得困难，还对每个人的努力效果产生负面影响。我们必须意识到这一因素，以便做得更好。

### 巧妙沟通

SDR 本质上是对抗性的，因为它们主要是指出设计中的风险和潜在缺陷，而这些设计通常是人们投入了大量精力的。一旦发现，设计缺陷往往会在事后看起来非常明显，审查者很容易将其归咎为疏忽，甚至是无能——但以这种方式沟通*永远*不会有助于解决问题。相反，应该将出现的问题视为教学机会。一旦设计者理解了问题，他们通常会引导讨论进入审查者可能错过的其他有益领域。有人指出自己设计中的漏洞是学习安全性最有效的方式。

一个 SDR（安全设计审查员）如果在讲解如何将安全性最大化的同时，冷酷无情地拆解一个薄弱的设计，并且只是一味地进行单方面的讲座，往往不会达到预期效果（如果你站在接受方的立场上，应该很容易理解为什么）。虽然这种情况不幸有时确实会发生，但我认为这并不一定是因为审查者刻薄，而是因为在关注需要的技术性改动时，很容易忘记保持尊重的语气。为了维持良好的合作关系，并加强每个人都在同一个团队、带着多样的视角共同努力达成正确平衡的信念，做出额外的努力是值得的。体育教练们也常常走在这条微妙的界线上，指出他们看到的弱点（对手也许会利用这些弱点），而不会要求太多，目的是帮助他们的队伍完成必要的工作，打出最好的比赛。正如马克·库班所说：“善良比刻薄更有远见。”

与人相处，同时传达可能不受欢迎的消息，当然是理想的，但这往往比说起来容易做。由于这是一本技术软件书籍，我不会提供如何赢得朋友和影响开发人员的自助建议。但人类因素足够重要——或者更准确地说，忽视它足以潜在地破坏工作——因此值得重点提及。我的基本指导原则很简单：要意识到自己传递信息的方式，并考虑他人如何接收这些信息以及可能的反应。为了展示这种方式如何在 SDR 中运作，我提供了一个真实的故事和一套我已逐渐依赖的技巧。

### 案例研究：一次困难的评审

我最难忘的一个 SDR 是一个极好的示范，展示了软技能的重要性。它始于我发起的一封痛苦的电子邮件交换，目的是获取文档并询问一些基本问题。这次交换使得团队负责人立即清楚地意识到，SDR 在他们看来完全是浪费时间。更糟糕的是，由于他们之前不知道这个产品发布的要求，它突然成为了一个不受欢迎的新障碍，阻碍了他们一直在努力推进的发布。这个故事的第一个关键教训是，重要的是要认识到其他参与者对过程的看法，无论对错，并相应地做出调整。

我最终获得的文档我觉得很粗糙、不完整，而且相当过时。直接用这些话指出这一点会无益且进一步恶化关系。第二个关键点是，为了促进改进，绕过问题并有效处理 SDR，采用以下策略更具生产力：

+   提出修复或添加建议，包括每个建议背后的安全理由。

+   在可行的情况下，主动提出帮助审查文档、建议修改或其他任何可以促进过程的事情（但不至于代替他们的工作）。

+   将初步的 SDR 反馈呈现为“我的观点”，而不是要求。

+   使用“三明治”方法：先给出正面评价，再指出需要改进的地方，然后以正面的方式结束（例如说明这些改动如何有帮助）。

+   如果你的反馈内容很多，先询问如何最好地传达它。（不要让他们吃惊于一封有 97 个要点的邮件，或者突然提交大量的 bug。）

+   探索你注意到的所有线索，但将反馈限制在最重要的几点。（不要做完美主义者。）

+   一个好的经验法则是，如果缺失的信息对许多读者来说普遍有用，那么值得记录；但如果它仅仅是针对你的需求，那么就应该用更不正式的方式提问。（如有必要，可以在评估报告中包含问题的细节。）

与其抱怨或评判文档质量，不如寻找创造性的方法来了解软件，比如使用内部原型（如果有的话），或浏览代码和代码评审。请求观察常规团队会议可以是一个了解设计的好方法，而不会占用任何人的时间。

通过电子邮件时，我觉得他们有些粗鲁，但当我们终于见面时，我才明白那只是一个压力山大的首席开发人员。为了不完全依赖首席，我找到了另一位压力较小的团队成员，他很乐意回答我的问题。为了节省准备 SDR 会议的时间，我只追问那些需要提前解决的问题，其他问题留到会议上，当时我有了一个固定的听众。

准备 SDR 会议是一项平衡的工作。你不应该毫无准备就去开会，因为团队可能不喜欢必须重新描述一切，特别是在已经提供了文档的情况下。提前，尽量识别你不熟悉的主要组件和依赖关系，并至少了解足够的内容以便在会议中提问。在准备过程中，一个好的做法是记下问题和疑问，然后将它们分类：

+   在你与他们会面之前，可以提前提出的问题，以便准备深入探讨安全性

+   你可以自己找到答案的问题

+   最适合在会议上探讨的话题

+   你将在评估报告中包含的无需讨论的观察

当我们最终召开会议时，首席工程师明显不满，因为现在 SDR 成了推出产品的主要障碍。第一次会议有些波动，但我们取得了不错的进展，大家都保持专注。经过几次会议（每次会议逐渐变得更轻松和更简短），我批准了设计。我们在第一次会议上就同意了一些更改，但确认细节并召开会议以最终确定它们，对于大家来说都是一种重要的保障。如果你不花时间确认设计中需要的更改是否已经完成，很容易让误解漏掉。

说服忙碌的人相信你通过占用他们的时间在帮助他们，永远都不容易，*仅仅告诉*他们通常不起作用。然而，即使是小的提升安全性的机会，*并展示*这些如何贡献于最终产品，是达到互利结果的好方法。

到 SDR 完成时，产品团队对安全性有了更深的理解——也因此更了解了他们自己的产品。最终，他们确实看到了评审的价值，并承认产品因此得到了改善。更好的是，对于第二版，团队主动联系了我，我们顺利完成了更新的 SDR，成绩斐然。

### 升级的分歧

当设计师和审阅者未能达成共识时，他们应该同意各自保留不同意见。如果问题较小，审阅者可以在评估报告中简单记录分歧点，并尊重设计师的意见。在这种情况下，应明确指出分歧，可能会在一个名为“建议被拒绝”的章节中解释所建议的设计变更以及推荐的理由，并说明不进行更改的潜在后果。然而，如果对重大决策存在严重分歧，审阅者应当将问题上报。

在这种情况下，设计师和审阅者都应该写出各自的立场，首先尝试确定一些他们一致同意的共同起点，并交换草稿以便每个人都能了解双方的观点。他们各自的立场会合并成一份备忘录，解释风险、提出的结果及其成本。此备忘录是评估报告的补充，作为会议的基础，或作为管理层决定如何继续的指南。最终决策的结果以及升级备忘录应纳入评估报告。

多年来进行安全审查时，我从未遇到过需要升级问题的情况，但也曾有几次接近此种情形。强烈的分歧几乎总是源自于基本假设上的深刻分歧，一旦识别出这些分歧，通常会导致问题的解决。这种差异往往源于对软件使用方式的隐性假设，或对其将处理的数据的假设。实际上，如何使用软件是极难控制的，随着时间的推移，使用场景通常会发生变化，因此通常采取安全的做法是最明智的选择。

另一种主要的脱节原因是设计师未能意识到数据的机密性或完整性问题，通常是因为他们缺乏必要的终端用户视角或没有考虑到可能的全部使用场景。另一个需要考虑的重要因素是：假设我们在发布后改变主意，在那时进行更改会有多困难？没有人想在事后说“我早就说过”，但将相反的条件写下来通常是做出正确选择的最佳方式。

## 练习，练习，再练习

为了巩固你在本章学到的内容，并真正将其内化，我强烈建议读者迈出这一步，找一个软件设计，进行 SDR。如果目前你感兴趣的领域内没有现成的软件设计，可以选择任何现有的设计并进行审阅练习。如果你选择的软件没有正式的书面设计，可以先自己创建一个粗略的设计表示（不需要是完整或精细的文档，甚至一个框图也可以），然后进行审阅。通常，最好从一个适中的设计开始，这样你不会感到力不从心，或者从一个大型系统中选取一个组件进行审阅。读到这里应该为你开始实践做了充分准备。如果你还不够自信来分享你的评估报告，可以先为自己的使用进行快速审阅。

随着你掌握 SDR 的关键技能，你可以将它们应用到任何遇到的软件中。研究大量设计是学习软件设计艺术的好方法——既能看到大师们是如何做的，也能发现别人所犯的错误——并且以这种方式进行实践是锻炼技能的绝佳练习。

一个特别简单的起步方式是审阅附录 A 中的样本设计文档。文中已突出显示了安全条款，以提供一个现实的例子，帮助你识别设计中应该注意的部分。阅读设计文档，注意其中标注的部分，然后设想如果这些安全细节缺失，你该如何识别并补充它们。为了更大的挑战，可以寻找其他方法使设计更加安全（我并不声称或期望它是一个完美无缺的理想设计！）。

通过每次进行 SDR，你将提高自己的熟练度。即使你没有发现任何明显的漏洞，你也会加深对设计的理解，并提升你的安全技能。确实，亟需安全关注的软件不在少数，所以我邀请你开始实践。我相信你会惊讶于自己掌握这一宝贵技能的速度。
