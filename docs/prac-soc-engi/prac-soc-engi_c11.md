# 技术邮件控制

![](img/chapterart.png)

到目前为止，我们已经进行了网络钓鱼攻击演练，并学习了如何训练用户识别它们。我们还讨论了当用户即使在我们训练后依然成为社交工程攻击的受害者时，应该如何应对。本章将介绍技术邮件控制的实施，以帮助为组织提供安全保障，并减轻一些用户的负担。

此外，我们还将讨论可以过滤和管理电子邮件的邮件设备和服务。但在深入这些内容之前，让我们先看看与电子邮件控制的技术方面相关的实际标准。

## 标准

随着电子邮件的发展，用于保护电子邮件的技术也在不断发展。正如信息安全领域的任何事物一样，随着这些技术的进步，攻击模式也在不断变化，成为了一场持续的猫鼠游戏。随着时间的推移，安全专业人员提出、讨论并批准了各种标准。说到保护电子邮件，有三个主要标准：*域名密钥标识邮件（DKIM）*、*发件人策略框架（SPF）*和*基于域的消息认证、报告和符合性（DMARC）*。我们将在本节中讨论这三个标准。

这三种标准的作用是什么？一个常见的误解是，它们保护你的电子邮件免受来袭的网络钓鱼或欺骗性伪装攻击。在某种程度上，它们确实有这样的作用，但更准确地说，这些标准是在保护你的*声誉*：如果你发送的电子邮件实施了这些标准，并且收件人域已配置为检查相关记录，他们可以检测到试图伪装你域名的行为。虽然这可能看起来与直觉相反且似乎没有效果，但请继续阅读本章剩余部分，看看这如何帮助你。

简而言之，SPF 检查主机或 IP 地址是否在发件人列表中，DKIM 发送数字签名，而 DMARC 实施 SPF 和 DKIM，并检查对齐性。DMARC 还建立了报告机制。SPF 被认为是最基础的安全标准。需要注意的是，收件方必须将其邮件服务器配置为检查发件人关于标准的指导，并实际执行相关操作。

### “发件人”字段

要理解这些标准如何工作，你需要了解电子邮件中各种类型的发件人字段。除了 Reply-to 字段，电子邮件还有 From 和 MailFrom 字段。*From*字段，也叫*5322.From*，显示发件人信息。*MailFrom*字段，或*5321.MailFrom*，是实际发送电子邮件的服务。例如，如果我使用 MailChimp 发送电子邮件，我的电子邮件地址将出现在 5322.From 字段，而 MailChimp 的服务器和地址则会出现在 5321.MailFrom 字段。

这些字段后面的数字来自于它们所在的 RFC 文件。这里有一种更容易理解的方法：5321.MailFrom 字段相当于通过邮政服务邮寄的信封上的回邮地址，而 5322.From 字段相当于信封内信件顶部的回邮地址。

现在让我们按时间顺序介绍这三个标准，首先从 DKIM 开始。

### 域名密钥识别邮件（Domain Keys Identified Mail）

DKIM 于 2011 年成为互联网标准。它旨在通过要求发送方加密签名邮件的部分内容（包括 5322.From 字段）来验证电子邮件并防止伪造。考虑到攻击者很可能无法访问用于数字签名的私钥，邮件接收者可以迅速识别伪造尝试。

*DKIM 头部*，是电子邮件消息中包含的一个字段，指定了在哪里可以找到用于验证签名的公钥。公钥通过 DNS TXT 记录存储，使用你可以在电子邮件消息中找到的 DNS 域（`d=`）和选择器（`s=`）标签。DKIM 公钥是该框架中唯一可供公众查看的部分，但找到它依赖于知道选择器，只有在你收到了该域名的电子邮件（或成功进行暴力破解）时，你才能知道这个选择器。

DKIM 的过程如下。首先，你编写一封电子邮件。在邮件发送时，与 DKIM 条目关联的私钥会创建两个数字签名，以证明电子邮件的真实性。一个签名用于 DKIM 头部，另一个签名用于邮件正文。每封电子邮件都有一对唯一的签名。这些签名会放入邮件头部并与邮件一起发送。一旦接收到邮件，如果接收方的邮件服务器已配置 DKIM，服务器会通过使用发布到 DNS 记录中的公钥来验证邮件的真实性。如果该密钥能够成功解密邮件，则该邮件是真实的，并且没有被篡改。

话虽如此，DKIM 并不常用于身份验证。相反，我们主要用它来验证邮件的真实性，并用于后面章节中讨论的所谓 DMARC 对齐。“基于域的消息认证、报告和一致性”即是这一部分内容。DKIM 的一个缺点是只有发送方和接收方都实现了它，才能有效。此外，即使你的组织内部实施了 DKIM，它也只能保护你的用户免受外部攻击者伪造其他内部员工的行为，这对你的声誉有好处，但在安全性方面效果有限。毕竟，攻击者可能会伪造一个可信的第三方。不过，如前所述，接收方必须将其邮件服务器配置为检查 DKIM 身份验证，这通常是通过实施 DMARC 来完成的。如果没有 DMARC，身份验证失败仍然会传递给接收方。

DKIM 最早在 RFC 6376 中引入。后来，RFC 8301 对其进行了修订，增加了关于 DKIM 可以使用的加密类型的以下规范：

> 此规范目前定义了两种算法：rsa-sha1 和 rsa-sha256。签名者必须使用 rsa-sha256 进行签名。验证者必须能够使用 rsa-sha256 进行验证。rsa-sha1 不得用于签名或验证。

2018 年，另一个关于 DKIM 的 RFC 发布；RFC 8463 增加了一种新的签名算法，ed25519，它使用 SHA-256 和 Edwards 曲线数字签名算法（EdDSA）代替 RSA 密钥。

#### 实施 DKIM

为了使 DKIM 有效，你必须不仅在 DNS 服务器中配置它，还要在邮件服务器上配置。否则，它充其量只是一个威慑手段。让我们来看看如何在 Google Workspace 托管的域上配置 DKIM。其他邮件服务器也有类似的功能。

普通的 Gmail 使用 Google 的默认 DKIM 密钥，Workspace 中没有配置 DKIM 的域名也使用此密钥。如果一个 Gmail 账户托管在*gmail.com*上，你无法为其设置自己的 DKIM，但可以为使用 Workspace 的域名设置。根据 Google 的支持文档，如果用户没有设置自己的 DKIM 公钥，Google 将使用以下默认公钥：`d=*.gappssmtp.com`。

让我们设置自己的私钥。首先，以超级管理员身份进入你的 Workspace 管理员控制台。进入控制台后，点击**验证电子邮件**，如图 11-1 所示。

![<<Google 管理员控制台的“Gmail 设置”页面，包括用户设置、实验室、主机、默认路由、验证电子邮件（红框标出）和管理隔离。>>](img/f11001.png)

图 11-1：选择“验证电子邮件”选项

现在你应该能看到 DKIM 身份验证选项，并被提示选择一个域名来配置 DKIM 以支持（图 11-2）。

![<<Google 管理员控制台的“验证电子邮件”页面列出了 DKIM 身份验证选项，包括域名选择。"生成新记录"和"停止验证"按钮显示在页面上。>>](img/f11002.png)

图 11-2：开始 DKIM 配置

一旦你选择了生成新记录，你需要选择密钥长度和选择器（图 11-3）。请注意，某些托管提供商和 DNS 平台不支持 2048 位密钥长度。根据 Google 的说法，如果是这种情况，请退回到 1024 位密钥。

![<<"生成新记录"框显示了 DKIM 密钥位长度（2048）和前缀选择器（google）的选项选择。>>](img/f11003.png)

图 11-3：生成 DKIM 记录和 RSA 密钥

在这里，根据需要选择域名并点击**生成新记录**。这将创建密钥（在图 11-4 中已被屏蔽）。打开一个新窗口，将其复制并粘贴到 DNS 中。完成后，点击**开始验证**。

![<<谷歌管理员控制台的“验证电子邮件”页面。红框内显示了选择的域名（theosintion.com）、DNS 主机名/TXT 记录名（部分被作者屏蔽）以及 TXT 记录值（部分被作者屏蔽）。>>](img/f11004.png)

图 11-4：Google Workspace 中的 DKIM 记录

在此阶段，进入 cPanel，这是许多主机提供商使用的常见域名管理工具。cPanel 应该包含一个 DNS 区域编辑器，并有一个框可以让你将公钥输入到 TXT 记录中（图 11-5）。

![<<DNS 区域编辑器显示了选择域名、创建新记录和管理 DNS 记录的字段，其中包括类型、名称和值。名称和值的信息部分被作者屏蔽。>>](img/f11005.png)

图 11-5：添加 DNS TXT 记录

请注意，这些面板可能会限制你输入的字符数为 255 个：这对于行业标准推荐的 2,048 位长的密钥来说太短了。（当我遇到这种情况时，我联系了支持部门并要求他们代为手动输入信息，虽然他们不情愿，但最终还是做了。）

一旦你保存了密钥，记录的传播可能需要最多 48 小时。传播完成后，你需要在仪表板上点击“开始认证”来验证它。传播通常需要 24 到 48 小时，但有时也可能需要长达 72 小时，这取决于基础设施和提供商。

另一个重要的考虑因素将在下一节中进一步讨论：你必须验证你的主机和 DNS 提供商是否支持连接 DNS 条目，否则无法使用超过 1,024 位 RSA 密钥。基本上，某些提供商对 DNS 单个条目中可以输入的字符数有限制。如果提供商不支持连接，DNS 将其解释为两个无关的 TXT 条目，从而无法实现其目的，你的 DMARC 实施也将无法对齐。

对于在其他邮件提供商上设置 DKIM，如 Exchange、Office 365 和 Sendmail，你可以在 [`email-security.seosint.xyz/`](http://email-security.seosint.xyz/) 找到多个教程的链接。

#### DKIM 的不足之处

DKIM 中使用的加密算法曾存在一些漏洞。直到 2018 年，DKIM 允许使用 SHA-1 算法进行签名和验证。然而，安全界从 2010 年就已知 SHA-1 不安全，甚至在 DKIM 标准出台之前。阿姆斯特丹 CWI 的研究人员和谷歌此后成功对该协议进行了碰撞攻击，至此加密和安全界的大多数成员都弃用了 SHA-1。碰撞攻击使得攻击者能够通过两个不匹配的文件的哈希值生成相同的哈希，从而使其看起来像是匹配的。所有主要的网络浏览器厂商宣布将在 2017 年停止接受 SHA-1 证书。

确实，在 DKIM 操作过程中的精确位置制造碰撞仍然需要大量计算能力，因此只有像国家级机构或大型科技公司等复杂且资金充足的组织，才有能力执行这样的攻击。毕竟，谷歌是产生 SHA-1 碰撞的两方之一（并且不太可能谷歌会试图向您的组织发送未经授权的邮件）。但如果您有自主权，建议使用更安全的 SHA-256。

其次，RSA 存在漏洞，它作为 DKIM 标准的公钥基础设施。如前所述，谷歌的 DKIM 工具支持两种 1,024 位和 2,048 位 RSA。2,048 位 RSA 是当前行业的最低标准。由于自 RSA 引入以来数学、计算和加密学方面的进展，是否认为 RSA 安全存在显著争议。几位学者和研究人员声称能够破解 RSA 或削弱 RSA 加密系统。削弱加密系统是一种通过识别所使用的大素数并进行因式分解来降低其强度的方法。

使用 1,024 位 RSA 在理论上肯定是一个漏洞，而使用 2,048 位 RSA 被不鼓励但并不禁止。从实际角度来看，除非拥有巨大的计算资源或访问量子计算设施，否则无论是 1,024 位 RSA 还是 2,048 位 RSA 都无法在不到两百万年的时间里在单一系统上破解。DKIM 的后续版本增加了 Ed25519-SHA256 作为被接受的算法，尽管它尚未得到广泛采用。

DKIM 的最终弱点不是漏洞，而是一个缺陷。DKIM 实现起来非常出色，可以保护组织的声誉——但前提是接收方的邮件服务器配置为检查 DKIM 签名，并对声称来自启用 DKIM 的域的邮件采取行动；否则，您的组织声誉仍然可能受到损害。

### 发件人政策框架

与 DKIM 类似，发件人政策框架（SPF）也通过使用 DNS TXT 记录来防止欺骗。在这些 TXT 记录中，SPF 定义了允许从邮件环境内或代表某个域发送邮件的域、主机列表、域名和 IP 地址。

虽然有些来源将 SPF 描述为验证发件人，但更恰当的描述是将其作为验证框架；如果配置为如此，接收方将检查来自 5322 和 5321 字段的发件人信息，以授权发件人，正如 SPF 记录中所定义的。如果记录配置为 *硬失败*，则邮件将失败；如果配置为 *软失败*，则邮件将成功。

为了了解这如何运作，假设有人伪造了一个域名的电子邮件。收件人检查 SPF 记录，并注意到发送域名配置了硬失败；而且，发送者没有在记录中列出。此外，SPF 策略设置为通过。在这种情况下，邮件将无法到达其目的地。如果没有 SPF 记录，或者策略设置为 `none` 或配置为软失败，邮件将成功送达。

由于 SPF 不需要加密，SPF 和 DKIM 是互补的，而不是竞争关系。SPF 基于逻辑，通过将传入的值与列表进行比较。主机、域名或 IP 地址要么在记录中，要么不在。DKIM 则采用逻辑和加密的结合形式，通过数字签名。你可以在 RFC 7208 中阅读更多关于 SPF 的信息，SPF 在 2014 年被引入。

#### 实现 SPF

让我们在 Google Workspace 中实现 SPF。首先，确定任何服务提供商，例如 Google 或 Outlook，以及允许代表你的组织发送邮件的关联域名。（你可以在 MX 记录中指定这些域名。）如果你正在运行内部邮件服务器，例如 Exchange，还需要确定授权代表组织发送邮件的网络块。

然后，为这些域名和 IP 地址选择适合各种情况的策略：

1.  通过（`+`）允许所有邮件通过（不推荐，除非用于短期故障排除）

1.  无策略（`?`），中立 实际上意味着 *没有策略*

1.  软失败（`~`）介于失败和中立之间；通常这些邮件会被接受，但会被标记

1.  硬失败（`-`）拒绝邮件

作为备选方案，你可以配置类似 `+all`（不推荐，因为它会允许所有邮件），`+mx`（允许来自 MX 记录中列出的主机的邮件；如果使用 Google 或 Office 365 等云邮件服务，不推荐使用），或者 `+nostarch.com`（这将允许来自 *nostarch.com* 的邮件）。

一旦你有了这些信息，你就可以准备创建记录。首先，进入你托管提供商的 DNS 编辑器，并创建一个新的 TXT 记录。或者，编辑任何已经包含 `v=spf1` 的现有 TXT 记录，如下所示：

```
dig walmart.com txt

; <<>> DiG 9.11.3-1ubuntu1.13-Ubuntu <<>> walmart.com txt
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 6907
;; flags: qr rd ra; QUERY: 1, ANSWER: 15, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
; walmart.com.                   IN      TXT

;; ANSWER SECTION:
walmart.com.            300     IN      TXT     "v=spf1 
include:_netblocks.walmart.com include:_smartcomm.walmart.com 
include:_vspf1.walmart.com include:_vspf2.walmart.com 
include:_vspf3.walmart.com ip4:161.170.248.0/24 ip4:161.170.244.0/24 
ip4:161.170.241.16/30 ip4:161.170.245.0/24 ip4:161.170.249.0/24" " ~all"
`--snip--`
;; Query time: 127 msec
;; SERVER: 127.0.0.53#53(127.0.0.53)
;; WHEN: Tue Sep 08 05:42:49 UTC 2020
;; MSG SIZE  rcvd: 1502 
```

将生存时间（TTL）值设置为默认的 14,400。*TTL 值*是 DNS 递归解析器缓存 SPF 记录的时间，之后会拉取新的记录（如果它已更改）。一些内容，如关键资产和负载均衡器，最好使用非常小的 TTL。建议像 MX 记录这种不需要频繁更改或已经具备冗余的资产，使用较大的 TTL 值。这是为了应对像快速变化的域名（fast flux）或动态 DNS 记录等技术，这些技术通常用于复杂的钓鱼攻击和针对社交媒体网站的攻击。

然后将 TXT 记录命名为组织的域名。对于实际文本，输入 `v=spf1`，后跟之前讨论的机制和策略。要定义这些机制，你需要了解允许的五种字段类型：

1.  `ip4` IPv4 地址或 CIDR 范围

1.  `ip6` IPv6 地址

1.  `mx` 发送者在 DNS 中的 MX 记录

1.  `a` DNS 中主机的地址记录

1.  `include` 引用其他域的策略

现在，构建要输入 DNS 的字符串。假设你将允许使用*nostarch.com*的 MX 记录的主机，除了 MailChimp 和一个私人、不可路由的 IP 地址范围外，还有一个硬失败。要输入 DNS 的文本将是这样的：

```
v=spf1 +mx include:192.168.1.22 include:192.168.2.0/24 include:servers.mcsv.net -all
```

你也可以用另一种方式写这个记录。在第四章中，你了解到 No Starch 使用 Google Workspace，因此你可以将`+mx`部分替换为 Google 的服务器（可以在 Workspace 仪表盘中找到）。为了保持这一行简洁，你将移除 MailChimp SPF 的`include`机制。替代的条目将是这样的：

```
v=spf1 include:_spf.google.com include:192.168.1.22 include:192.168.2.0/24 -all
```

一旦你将其粘贴到 DNS 记录中，允许最多 72 小时才能传播。互联网中各个 DNS 服务器需要时间来复制更新的信息。这段时间主要取决于 TTL（生存时间）值，TTL 指示服务器在刷新前缓存信息的时间。根据我的经验，SPF 几乎可以立即生效，不像 DKIM 那样。无论你是否使用 Google 作为邮件提供商，你仍然可以使用 Google Admin Toolbox Check MX 网站来验证所提供的信息。你可以在[`toolbox.googleapps.com/apps/checkmx/`](https://toolbox.googleapps.com/apps/checkmx/)找到该工具箱。你可以在[`email-security.seosint.xyz/`](http://email-security.seosint.xyz/)找到有关在其他平台上配置 SPF 的说明。

#### SPF 的缺点

记得在第四章中提到，SPF 允许攻击者枚举一个组织拥有或使用的域、IP 地址和 IP 地址范围。攻击者还可能通过检查 TXT 记录中的`-all`（硬失败）、`~all`（软失败）或`~?`（中立）部分来判断目标是否配置了硬失败或软失败。这些信息可能会影响他们是否决定伪造你组织的域名，或者是否占用类似的域名。一个细心的社会工程师甚至可能在其钓鱼域上配置 DKIM 和 SPF，以绕过任何组织可能已实施的检查，前提是他们实际上执行了任何政策。

SPF 还可以提醒攻击者你与其他组织的工作关系。如果其他域需要获得代表你发送电子邮件的权限，你可能需要为它们创建 SPF 记录。需要权限代表组织发送电子邮件的域名示例包括像 MailChimp、Mailgun 或 Constant Contact 这样的邮件列表。还需要考虑其他代表组织发送电子邮件的提供商，如 GoToMeeting 或类似的协作平台。

SPF 的最终方面不是漏洞，而是一个不足之处。像 DKIM 一样，SPF 是值得实现的，它可以保护组织的声誉，但前提是接收方邮件服务器已配置为检查 SPF 记录并强制执行定义的策略。然而，如果未进行此操作，可能会损害组织的声誉。

### 基于域的消息认证、报告与一致性

DMARC 利用现有的 SPF 和 DKIM 实现，创建了一个更加稳健的解决方案，以防止欺骗、商业邮件泄露和声誉损害。DMARC 于 2015 年作为互联网标准首次发布（RFC 7489），旨在克服 SPF 和 DKIM 的局限性：它实现了这两个早期标准，但还会将成功与失败报告给发送域。DMARC 检查邮件的*对齐*，即 5322.From 字段是否与认证的域名匹配。换句话说，它验证邮件中声明来自 info@nostarch.com 的*From* 字段，是否确实来源于该域。邮件可以通过 SPF 和 DKIM，但在对齐方面失败。

当通信使用 DMARC 时，会发生以下情况。首先，用户撰写一封电子邮件。发送邮件的服务器将 DKIM 头部信息插入邮件中，然后将其发送给收件人。从那里开始，为了让邮件通过实施强制 DMARC 策略的组织，必须满足两个条件。首先，邮件必须通过 DKIM 签名检查（5322.From，使用 DNS 中包含的公钥进行验证）。其次，邮件必须通过 SPF 检查（5322.From）和 TXT 记录。根据这些检查的结果，DMARC 记录将指定服务器应该接受或拒绝该邮件。如果检查失败，会进行报告。邮件会经过收件人所采取的任何处理或过滤器，如果一切通过，邮件将进入收件人的收件箱。

DMARC 被广泛使用。多个合规框架要求使用 DMARC，包括美国联邦机构，根据国土安全部的《绑定操作指令 18-01》。如果你跟进过供应商的市场宣传资料，你可能会记得 2017 年大量供应商利用该指令推销 DMARC 和电子邮件安全工具。但这些实现没有强制执行的策略或技术配置，无法在最小化人工干预的情况下执行操作，这些实现是毫无价值的。此外，收件人必须实际检查记录并强制执行他们的策略。

有两份 RFC 用于更新 DMARC：RFC 8553，解决了在节点名称中使用下划线的问题；以及 RFC 8616，解决了在 SPF、DKIM 和 DMARC 中使用 ASCII 字符时未涵盖国际使用字符的问题。

#### 实现 DMARC

在实现 DMARC 之前，你必须先实现 SPF 和 DKIM。然后，你需要收集信息以便填入 TXT 记录。你可以在 RFC 7489 第 6.3 节中找到完整的记录格式定义，但至少需要以下信息：

1.  DMARC 的版本（`v`） 当前使用的 DMARC 版本。目前为 1，表示为`v=DMARC1`。

1.  策略（`p`） 要应用于特定域的策略。

1.  子域名策略（`sp`） 仅适用于发送域的子域名的策略，例如来自 info@us.nostarch.com 的邮件，但不包括来自 info@nostarch.com 的邮件。如果没有`sp`字段或限定符，组织将执行主`p`字段的策略。

1.  应用该策略的“坏邮件”百分比（`pct`） 一个介于 0 到 100 之间的数字，决定将该策略应用于域名所有者的邮件的百分比。

1.  `rua`标签 该标签指定接收报告的电子邮件地址。OSINT 收集器可以读取并利用这些信息，因此建议使用别名。

除版本外，DMARC 记录中的所有字段都需要限定符。例如，`policy`字段接受`none`、`quarantine`或`reject`。`none`限定符不执行任何操作，`quarantine`将邮件重定向到垃圾邮件文件夹或发送给管理员，`reject`则会拒绝邮件。

你还可以添加法医报告选项以及转发法医报告的地址。法医失败报告标签（`fo`）决定哪些事件会生成法医报告。它有四个选项：`0`，当所有机制失败时生成失败报告；`1`，当任何机制失败时生成失败报告；`d`，当 DKIM 失败时生成 DKIM 失败报告，不管对齐情况；`s`，当 SPF 失败时生成 SPF 失败报告，不管对齐情况。`ruf`标签指定接收法医报告的电子邮件地址。和`rua`标签一样，OSINT 收集器可以读取并利用这些信息，因此建议使用别名。

另外两个字段，`adkim`和`aspf`，决定所有者是否要求对齐模式，这决定了如果电子邮件未通过 SPF 或 DKIM 时应采取的措施。两者都有`r`（宽松）和`s`（严格）两种可能的值。宽松模式只要求域名完全匹配，而严格模式要求完全精确匹配才能通过。两者都是可选的，默认设置为宽松模式。

这可能看起来信息量很大。为了应用这些内容，让我们为*nostarch.com*配置一个 DMARC 记录：

```
v=DMARC1; p=quarantine;pct=95; rua=mailto:dmarc@nostarch.com; fo=1; ruf=mailto:soc@nostarch.com;
```

该记录为域名设置了一个隔离策略。它适用于 95%的邮件，任何失败都会触发法医报告，法医报告将发送到 soc@nostarch.com。你将设置接收一般 DMARC 报告的电子邮件地址为 dmarc@nostarch.com*。*

一旦你草拟好这个内容，你需要将其添加到*nostarch.com*的 DNS 区域文件中的 TXT 记录，名称为*dmarc*，TTL 值为`14400`。

#### DMARC 的不足之处

除了 SPF 中存在的相同信息泄露问题，以及你的邮件收件人可能不会检查 SPF 或 DKIM 外，DMARC 本身并不会引入重大问题或漏洞。

也就是说，仅仅创建 DMARC 的 DNS TXT 记录并不能立即确保您的安全。例如，您可能很容易配置错误您的 DMARC 实现。在初始配置 DMARC 时，避免拒绝电子邮件，因为这会删除人工审核邮件有效性的能力，并可能导致业务中断或邮件传递错误。

缓解这一问题很简单：首先将初始的 DMARC 策略设置为`none`，并审核 100%的电子邮件（`p=none; pct=100;`）。随着时间的推移，逐步降低`pct`字段，直到您对报告和性能感到满意。一旦达到了理想的水平，您可以将审核百分比更改为一个可管理但现实的值。我建议企业设置为 60%到 85%，具体取决于您的资源。然后更新 DMARC TXT 记录以反映这一点（`p=quarantine; pct=75;`）。

请记住，试图通过电子邮件获取您组织访问权限的攻击者可能会利用工具来增强其合法性，因此不要仅仅依赖 SPF、DKIM 和 DMARC。例如，如果一个攻击者通过配置了 SPF、DKIM 和 DMARC 的其他组织进行了攻击，并且通过合法渠道向您的组织发送电子邮件，那么它将通过与这三个标准相关的所有检查。

DMARC 未解决的另一个威胁向量是加密。这三个标准并未提供加密电子邮件的方式。当然，DKIM 使用了加密技术，但仅仅是用于签名电子邮件。接下来的部分将介绍如何解决这一问题。

## 机会性 TLS

在最初设计时，SMTP、POP 和 IMAP 邮件协议并不包括加密。随着攻击的发展，研究人员创建了*机会性传输层安全性（TLS）*来加密它们。您有时会看到它被昵称为*STARTTLS*，这是用于启动该服务的命令。

以下是 STARTTLS 的工作原理。首先，发送服务器像往常一样连接到接收服务器。然后，它请求扩展 SMTP，允许图片和附件。从这里，发送方询问接收服务器是否支持 STARTTLS。如果回答是“是”，连接将重新启动并使用双方主机达成协议的 SSL 或 TLS 协议版本来加密电子邮件。如果回答是否定的，电子邮件将不加密地继续发送。另一种变体，称为*强制 TLS*，如果连接没有得到加密，邮件将无法发送。由于无法协商加密而导致邮件被阻止的可能性，强制 TLS 的使用并不广泛。

STARTTLS 的最大问题在于它是*机会性的*，这意味着只有在可用时才使用加密。如果没有可用的加密或加密支持，邮件将以明文方式发送。STARTTLS 的另一个问题是加密握手本身发生在明文中，这使得潜在攻击者能够通过中间人攻击窃取会话信息或篡改邮件内容。你可以在*STRIPTLS 攻击*中看到这两个问题被利用，攻击者要么禁用实际的 STARTTLS 命令，要么让 TLS 看起来不可用。通过配置 SMTP 要求传出连接使用 TLS，可以减轻 STRIPTLS 的影响，但如果配置错误 TLS 或接收方未配置为接收 TLS 邮件/阻止该端口，可能会丧失发送邮件服务。

另一个减轻 STRIPTLS 的方案是域名系统安全扩展（DNSSEC）下的一个子功能，称为基于 DNS 的命名实体认证（DANE）。实现 DANE 需要组织创建一个 DNS 记录，指引所有在特定端口或协议上的通信，通过在 DNS 中放置公钥来协商会话。这也可能被滥用或作为开放源情报（OSINT）的一部分收集，就像任何公开的 DNS 记录一样，攻击者可以查询 DNS 记录并从中推断信息。虽然这种缓解方案本身很容易实现，但总体来说，DNSSEC 并不简单，因此我们尚未看到其广泛应用。

与 DANE 开发的时间相近，另一种解决相同问题的方案（STRIPTLS）也在草拟中：SMTP MTA 严格传输安全（MTA-STS）。

## MTA-STS

*SMTP MTA 严格传输安全（MTA-STS）* 是另一种实现 TLS 来保障电子邮件通信安全的方法。在这种方法中，双方使用 DNS TXT 记录以及上传到发送域预定义的、公开可访问的子域的特定目录中的文件，来协商 TLS 握手。

该标准仅适用于邮件服务器之间的 SMTP 流量。客户端与服务器之间的通信通过 HTTP 严格传输安全（HSTS）来实现。由于实现 MTA-STS 的复杂性，我不会在这里详细讲解过程。你可以在 [`email-security.seosint.xyz/`](http://email-security.seosint.xyz/) 查找教程链接。

## TLS-RPT

*SMTP TLS 报告（TLS-RPT）* 是一种收集有关 TLS 协商失败统计信息的方法，及相关域。可以将其视为类似 DMARC，如果 MTA-STS 是 DKIM 元素的话。你可以使用这些信息进行故障排除或威胁情报分析。

设置 TLS-RPT 相对简单，只需在 DNS 中添加一个包含 `_smtp._tls.``domain.tld` 的 TXT 记录，并在邮件正文中包含报告地址。如果加密方式（DANE 或 MTA-STS）出现错误，报告邮箱将收到通知。以下是 *nostarch.com* 的示例：

```
_smtp._tls.nostarch.com  300 
"v=TLSRPTv1;rua=mailto:soc@nostarch.com"
```

第一行是字段名和 TTL。第二行是值。在这里，我们已将 TTL 设置为 300，并将报告发送到 [soc@nostarch.com](http://mailto:soc@nostarch.com)。

## 电子邮件过滤技术

实现电子邮件安全的最后一步是使用过滤技术。通常，这意味着聘请供应商或服务提供商在你收到邮件之前接收它们。供应商会扫描它们，查找在所有客户端中观察到的模式，并检查 SPF、DKIM 和 DMARC（如果已配置）。电子邮件过滤并不完美，但确实减少了技术人员的负担。不过，请记住，聘请供应商可能需要你更改公共 DNS 记录，而你可以通过前面讨论过的 OSINT 技术发现这些关系。

市面上有许多配置和产品。在选择供应商时，考虑他们每分钟或每秒钟处理的电子邮件量。还要决定是否希望通过软件、硬件设备或云服务来维护电子邮件过滤。每种选择都有独特的挑战，尤其是在实施、支持、可用性和报告方面，而且每种方式都提供不同的功能。电子邮件过滤在云实例中可能更容易实施，因为这些实例可以最好地保护电子邮件的可用性。然而，任何需要配置的决定，特别是超出 DNS 记录的配置，可能会带来失败、干扰或不良安全性的问题。如果你选择使用云服务提供商，你还将依赖于服务水平协议（SLA）以及与你供应商的合同。尽管如此，它们确实简化了流程；你只需更新 DNS 区域文件中的 MX 记录并选择适当的选项。

一些供应商还会为你维护和管理你的 SPF、DKIM 和 DMARC 实现。权衡可能导致系统中断的风险与使用该系统所能获得的收益。供应商是否提供其威胁情报？这是否是供应商的专业服务？合同内容包含什么？

## 其他保护措施

作为安全专业人员，我们必须构建我们的系统，使其不仅能应对日常使用，还能承受滥用，并能在足够长的时间内容纳这些行为，让我们可以检测并响应。这是 Winn Schwartau 的书《基于时间的安全》（Impact PR, 1999）中的核心观点，*基于时间的安全*。

在防止钓鱼攻击时，考虑实施超出单纯电子邮件控制的措施。虽然我们在本章中不讨论这些措施，但要实施恶意软件防护，无论是杀毒软件、终端检测与响应（EDR）还是其他任何反恶意软件产品。大多数恶意软件通过电子邮件进入网络，当用户从成功的钓鱼邮件中下载它时。

另外两种技术可以防止钓鱼攻击造成灾难性后果：文件完整性监控（FIM）和数据丢失防护（DLP）系统。FIM 监控一组文件是否被修改。你可以编写一个简单的 FIM 解决方案，对每个文件进行加密哈希计算并将其存储在某个地方。然后，它会验证文件是否未被更改，如果更改了，还会检查更改是否被授权。这对于检测已进入网络的恶意行为者非常重要。如果文件内容未经授权发生了变化，可能意味着新应用程序正在运行或被安装、勒索软件的存在，或者有人篡改了重要文件。

数据丢失防护（DLP）旨在防止用户将文件通过电子邮件发送到组织外部，上传到公共互联网和文件共享网站（如 Google Drive、Box 和 Dropbox），以及将数据保存到未经授权的 USB 设备上（如果有的话）。许多 DLP 解决方案还具备防止用户共享敏感或受监管数据的能力，例如支付卡行业（PCI）数据、个人健康信息（PHI）和个人身份信息（PII）。这很重要，因为它可以防止用户泄露商业机密、知识产权和重要资产。它还消除了用户将 USB 驱动器插入工作站的许多理由，从而减少了成功的诱饵攻击的可能性。

## 结论

在本章中，你采取了一些措施使你的组织变得更加安全。你了解了三种旨在遏制电子邮件欺骗的安全标准，以及每种标准的不足之处。（如果你像我一样，可能已经对字母*RFC*产生了特别的厌恶。）

运用本章中的信息，你可以将这些概念和标准应用到你的组织中，构建多层防御。你可能需要向管理层解释，SPF、DKIM 和 DMARC 不是防止钓鱼攻击的绝对解决方案，即使它们已经到位，组织也应该考虑安装更多的控制措施，例如电子邮件过滤解决方案。

在组织选择最符合合规需求和预算的电子邮件过滤解决方案后，花时间正确实施该解决方案。然后，通过钓鱼模拟进行测试。如果模拟被拦截，那就太好了。接下来，你可以将其从隔离区释放出来，测试用户。如果模拟攻击成功通过，与你的供应商合作，找出原因并解决问题。
