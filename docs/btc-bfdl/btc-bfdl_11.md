## 第十一章：A

**HELLO MONEY! 一个简单的 JavaScript 程序**

使比特币如此令人兴奋的一个因素是*任何人*都可以编写计算机程序，直接链接到比特币网络并执行金融交易。本附录将解释如何编写一个简单的 JavaScript 程序，监控一个钱包并指示何时比特币已被发送到该钱包。在附录 B 中，我们将用 Java 创建一些更高级的程序，扩展这一思想。

### “简单” 的含义

编写操控比特币资金的程序是简单的。然而，当我们走过这个过程时，你可能会发现它并不那么简单。

但试想一下，如果我们使用传统的电子商务系统来构建我们的应用程序或服务。大致上，这些步骤将是这样的：

1\. 注册你的企业以获取 DUNS^(1) 编号。

2\. 在你的银行开设一个企业账户。

3\. 让你的账户通过商户服务供应商（如 Intuit、PayPal、Stripe、Apple 等）进行验证。

4\. 通过供应商使用你的 DUNS 编号注册账户以获取访问密钥。

5\. 从供应商处获取专有库软件（你可能需要定期更新此库以维护你的软件）。

6\. 将你的客户重定向到一个特殊的供应商授权支付。

7\. 编写你的代码。

8\. 让支付提供商审核你的完成的应用程序。

这里是使基于比特币的电子商务系统启动并运行所需的主要步骤：

1\. 编写你的代码。

只需要完成这一项任务，这就是我们在用比特币编程时所说的*简单*。

### 编写比特币软件的三种方法

要编写启用比特币的软件，你可以使用三种不同的方法：

1\. 使用商户服务。

2\. 连接到本地比特币钱包程序（通常是基于中本聪初始代码的原始比特币钱包应用程序，名为 bitcoind）。

3\. 创建一个程序，将其直接插入比特币网络。

使用方法 #1，你将通过互联网连接到一个 Web API。这个 API 将由一个第三方公司提供，用于管理你的比特币。提供这些 API 用于发送和接收比特币的公司通常被称为*商户服务*。

例如，如果你的网站销售小工具，并且你希望人们用比特币购买你的商品，使用商户服务可能是一个简单、快速让你的网站开始工作的方式。商户服务的另一个好处是，它可能还提供自动将比特币与其他货币之间进行转换的服务，作为交易的一部分。许多公司提供这些 API，BitPay 是一个常见的选择。你也可以在比特币基金会官方网站上找到更多公司的详细列表。^(2)

然而，这种方法也有一些缺点。首先，这些供应商的 API 可以说违背了比特币的精神，因为使用 API 中介意味着你要依赖外部方；认真对待比特币的人更愿意保持对自己资金的百分之百控制。其次，这些 API 大多仅为常见用例设计，因此不允许我们想要在本书中推广的灵活性和创新型应用开发。第三，这些 API 的设计经常变动，这使得提供最新信息变得困难。由于这些原因，本书不会花太多时间讨论供应商 API。

方法 #2 涉及连接到本地比特币钱包，并基本上让钱包在自动驾驶模式下运行。两款基于中本聪原始代码的比特币钱包程序——Bitcoin Core 和 bitcoind——可以通过一种名为 JSON-RPC 的特殊协议进行远程控制，正如我们稍后将讨论的那样。由于这两款程序是比特币钱包的黄金标准，因此将它们用于自定义程序非常具有吸引力。为自动化 Bitcoin Core 和 bitcoind 编写的程序易于理解，并且在所有流行的编程语言中都有相应的库，简化了它们的使用。你可以在 JavaScript、Ruby、PHP、Python 等多种语言中使用这种方法。不幸的是，使用本地比特币钱包程序并从自己的代码中控制它的主要缺点是，这一过程往往笨重且低效，正如你将在第一个编程示例中看到的那样。

**注意**

*Bitcoin Core 和 bitcoind 共享相同的代码。这个公共代码被称为* 比特币参考客户端， *或简称* 比特币。 *它是比特币协议的首次实现，最终被分为两个变种：Bitcoin Core 提供友好的图形界面 (UI)，而 bitcoind 是一个更加简化的版本，采用文本界面。*

方法 #3 涉及直接进入比特币网络，将你的比特币启用程序直接嵌入到比特币网络中。你可以使用 Java、C++、Go 等语言，或者任何提供完整比特币客户端库的语言来实现这一点。与方法 #2 相比，这种方法更加稳健且资源消耗较少，但它在技术上更加复杂。

然而，如果你是一个相信比特币精神的程序员，能够编写一个真正的*比特币网络第一公民*应用——一个真正参与比特币系统的比特币节点——是一个令人鼓舞的动力。原因在于，绝对没有任何限制会束缚你的应用（只要你的应用遵守网络规则）。在附录 B 中，我们将编写一些使用这种方法的程序。

### 比特币编程的一般安全注意事项

我们需要在这里提到的一个重要免责声明是，在本附录中，我们将编写仅发送和接收少量硬币的程序。所讨论的技术和示例对于学习比特币编程的基本概念非常有用，*但绝不适合编写操作大量资金的程序*。如果你计划编写严肃的比特币应用程序，你需要做以下几点：

1\. 从本章中的示例程序学习基本概念。

2\. 利用这些知识学习和理解本章中使用的比特币库的底层源代码。

3\. 关注开发者和其他库用户使用的论坛，及时了解使用这些库时涉及的安全风险。

最重要的是，要意识到我们在示例中使用的是社区维护的源代码；如果一个聪明的黑帽黑客^(3)设法将恶意代码插入到官方库的存储库中，*他或她可以窃取你所有的钱*。即使你完全理解库的代码，你也面临着危及资金安全的风险。例如，当你从互联网上下载这个库代码时，黑帽黑客有很多机会执行中间人攻击^(4)，并将恶意代码插入到被篡改的库版本中，这个版本会被整合到你的程序中。结果，黑客可以窃取你所有的钱。

此外，正如前几章所提到的，黑客可以通过许多与比特币编程无关的方式窃取你的比特币。如果比特币的当前流行程度持续下去，我们怀疑几年后大多数计算机病毒都会包含立即清空任何找到的比特币钱包的代码。

关键是你需要了解如果计划创建更高级的比特币程序，你的钱可能面临的严重风险；只有在全面且深入理解比特币技术的基础上，你才能安全地保护你的资金，这种理解应该超越本章所给出的介绍。请谨慎行事！

### 关于比特币安全的积极提醒

现在，在你经历了防止资金损失的一些警示之后，我们将指出一些事实，让你对比特币安全有信心：

• 核心比特币网络迄今为止保持了几乎完美的安全记录。使用比特币时大多数安全风险来自用户在自己电脑上执行的不小心操作，这些风险本可以避免。

• 尽管我们在本章讨论了这些风险，但有成熟的编程实践可以缓解所有这些风险。如果你学习本书，遵循安全软件开发的一般准则，并保持更新关于比特币开发论坛上讨论的最新安全问题，你将能够编写安全的比特币软件。

• 在你学习编写使用比特币的程序时，确保使用一台不包含大量比特币的比特币钱包的计算机。通过这样做，你可以在学习编写比特币软件时避免任何危险：如果你把比特币存放在其他地方，你就不可能在开发机器上不小心丢失比特币（或被盗）。

### 用 JavaScript 编写你的第一个比特币程序

按照惯例，程序员学习新技术时编写的第一个程序是*Hello World* 程序：这是最简单的程序，它只是在屏幕上打印出消息*Hello World!*。本质上，它向初学者表明，初始代码似乎正常工作。

然而，我们需要编写的比特币程序必须执行两个主要任务：接收资金和发送资金。在本章中，我们将专注于接收资金，并编写一个名为*Hello Money!*的程序。在附录 B 中，我们将编写一个*Bye-Bye Money*程序来发送资金。

#### *为什么使用 JavaScript？*

JavaScript 可以说是当今最著名的编程语言，因为大多数为 Web 构建软件的开发者迟早都必须学习它（它是唯一能在标准网页浏览器中原生运行的语言）。然而，我们创建的 JavaScript 代码并不能在网页浏览器中运行：这是因为网页浏览器有强大的保护机制，称为*跨域限制*，它们防止与外部程序和网站的通信。这些限制限制了在网页浏览器中使用 JavaScript 的功能，使得与任何外部钱包进行交互变得困难（这也不足为奇，因为你肯定不希望通过访问恶意网站而让钱包被清空）。

然而，目前你也可以在服务器上运行 JavaScript，就像常见的使用 Node.js 库一样。在服务器上运行时，不受这些限制的影响，我们可以编写在控制台中运行并与 Bitcoin Core 和 bitcoind 交互的简单程序。

#### *比特币核心与 Bitcoind*

如前所述，本章描述的编程技术将适用于任何比特币钱包应用，无论是 Bitcoin Core 还是 bitcoind。两者之间唯一实质性的区别是 Bitcoin Core 有一个图形用户界面；基本上，它就是附加了前端的 bitcoind。由于图形界面的友好性，我们将在本章的示例中使用 Bitcoin Core。然而，bitcoind 稍微消耗的资源较少，更容易通过终端控制台在计算机服务器上运行。因此，如果你实际部署一个使用本章概念的已完成程序，最好使用 bitcoind。

### 为 JavaScript 比特币编程准备你的机器

在开始编程之前，你需要一些工具来准备你的机器，所以让我们现在就安装它们。本教程提供的说明假定你使用的是 Windows 开发环境；如果你使用的是 Mac 或 Linux 平台，请跳到 第 219 页的 “For Mac Hackers” 或 “For Linux Folks” 部分。

#### *安装 Node.js*

你首先需要从 *[`nodejs.org/`](http://nodejs.org/)* 网站下载 Node.js 的安装程序。当你运行 Node.js 安装程序时，它还会安装我们接下来将依赖的 Node 包管理器（npm）。

#### *安装 node-bitcoin*

现在你需要一个 JavaScript 库，它可以连接到 Bitcoin Core 和 bitcoind。我们将使用 node-bitcoin 库。要安装 node-bitcoin，请打开命令提示符并输入 `**npm install bitcoin**`。这个命令将调用（先前安装的）Node 包管理器，它会在一个简单的步骤中下载库中的所有内容。

#### *启动 Bitcoin Core*

如果你还没有下载 Bitcoin Core，可以从其官方网站 *[`bitcoin.org/en/download`](http://bitcoin.org/en/download)* 下载。

接下来，你需要以服务器模式启动 Bitcoin Core。钱包应用程序将打开一个额外的套接字，我们将使用这个套接字从 JavaScript 程序连接到钱包。要在 Mac 和 Linux 机器上执行此操作，请从控制台进入 Bitcoin Core 安装目录并运行 `**./Bitcoin-Qt -server**`。在 Windows 机器上，打开命令提示符，进入 *C:\Program Files (x86)\Bitcoin* 目录，并输入 `**bitcoin-qt.exe -server**`。

第一次以服务器模式运行 Bitcoin Core 时，它会要求你在特定位置创建一个名为 *bitcoin.conf* 的文件，并在该文件中添加一个用户 ID 和密码。按照提示操作，因为稍后我们将使用这个用户 ID 和密码。然后，重新启动 Bitcoin Core。

如果你已经安装了 Bitcoin Core（之前叫 Bitcoin-Qt），但这是你第一次跟随本教程，那么你需要找到之前创建的 *bitcoin.conf* 文件。对于 Windows 用户，你可以尝试查找 *C:\Users\<username>\AppData\Roaming\Bitcoin\bitcoin.conf*。对于 Mac 用户，尝试 * /Users/<username>/Library/ApplicationSupport/Bitcoin/bitcoin.conf*。对于 Linux 用户，尝试 */home/<username>/.bitcoin/bitcoin.conf*。

**注意**

*Windows 用户注意：如果你尝试使用 Windows 记事本创建* bitcoin.conf *文件，请注意，记事本（非常“贴心”地）会在文件名后添加一个 .*txt *扩展名，而 Windows（同样“贴心”地）会完全隐藏这个扩展名以保护你（这是为什么如今大多数黑客都尽量避免使用 Windows 的一个典型例子）。为了解决这个问题，在保存对话框中输入文件名时，把* bitcoin.conf *放在引号中。*

此时，像往常一样，对于一个比特币钱包，比特币核心会花费几个小时下载区块链，直到它准备好进行下一步操作——这是一个适合进行长时间午休的完美时机！

#### *针对 Mac 黑客*

如果你使用的是 Mac 并且熟悉使用终端，你可以运行特定命令自动搜索、下载并安装所需的程序。

在 Mac 上，下载 homebrew，一个命令行工具，将为你处理整个过程：

```
# Get homebrew and if you haven't already
ruby -e "$(curl -fsSL https://raw.github.com/Homebrew/homebrew/go/install)"
brew tap phinze/homebrew-cask
brew install brew-cask

# Get node.js and bitcoin stuff
brew cask install bitcoin
brew install nodejs npm
npm install bitcoin

# Run bitcoin-qt in server mode
~/Applications/Bitcoin-Qt.app/Contents/MacOS/./Bitcoin-Qt -server

```

#### *针对 Linux 用户*

如果你使用的是像 Ubuntu 这样的 Debian Linux 版本，你只需使用 PPA 功能来安装库：

```
sudo add-apt-repository ppa:bitcoin/bitcoin
sudo apt-get update
sudo apt-get install nodejs npm bitcoin-qt
npm install bitcoin
bitcoin-qt -server

```

在一个工作正常的比特币核心服务器上，我们现在可以开始编程了。

### 你好，钱！

好的，让我们写第一个比特币应用程序。只需将以下完整程序输入到名为*hellomoney.js*的文件中：

```
var bitcoin = require("bitcoin");

var client = new bitcoin.Client({
    host: 'localhost',
    port: 8332,
    user: 'myUsername',
    pass: 'myPassword'
});

var previousBalance = 0;

function mainLoop() {
    client.getBalance('*', 0, function (err, balance) {
        if (err) {
            console.log(err);
        } else if (balance > previousBalance) {
            console.log("Hello Money! New balance: " + balance);
            previousBalance = balance;
        } else {
            console.log("Nothing's changed.");
        }
    });
}

setInterval(mainLoop(), 5000);

```

在开始运行应用程序之前，让我们逐行分析代码的作用。

#### *第一部分：初始化与比特币核心的连接*

```
var bitcoin = require("bitcoin");➊

var client = new bitcoin.Client(➋
   {
      host: 'localhost',
      port: 8332,
      user: 'myUsername',➌
      pass: 'myPassword'➍
   });

var previousBalance = 0;➎

```

第一行表示我们正在使用 node-bitcoin 库 ➊。接下来，我们建立了与我们设置的比特币核心服务器的连接 ➋。因为我们将在安装了比特币核心的同一台机器上运行应用程序，所以我们的主机设置为`'localhost'`。默认情况下，比特币服务器将在端口 8332 上运行。

**重要：** 在接下来的两行 ➌➍ 中，输入你在*bitcoin.conf*文件中输入的用户 ID 和密码。*将这里显示的占位符替换为你自己的。* 然后，我们创建一个变量来跟踪程序中的前一个余额 ➎，初始值为零。

#### *第二部分：主循环*

现在，我们将编写一个循环，检查我们钱包中的余额，并在余额发生变化时向我们报告。基本步骤如下：

1. 向比特币核心请求当前余额。

2. 如果余额高于之前的余额，打印一条消息，并将前一个余额更新为当前余额。

3. 设置一个定时器，每五秒钟重新执行整个过程一次。

以下`mainLoop`函数执行了之前的步骤：

```
function mainLoop() {
    client.getBalance('*', 0, function (err, balance) {➊
        if (err) {
            console.log(err);➋
        } else if (balance > previousBalance) {➌
            console.log("Hello Money! New balance: " + balance);➍
            previousBalance = balance;➎
        } else {
            console.log("Nothing's changed.");
        }
    });
}

setInterval(mainLoop, 5000);➏

```

首先，函数向比特币核心请求余额 ➊。在此过程中，我们创建一个*回调函数*，其内容为`function(err,balance) {}`。回调函数会在未来某个时间被调用。在这种情况下，当我们从比特币核心收到结果余额时，它会被调用。

**注意**

*如果你以前从未使用过 Node.js，可能需要一些时间来学习如何理解这种编程惯用法。Node.js 的哲学是，当程序需要等待外部进程（在此情况下是比特币核心程序）时，它要求你创建回调函数，而不是在等待结果的过程中让程序完全停止。这叫做*异步编程*，它使得程序在等待数据到达时可以做其他任务。*

当余额可用时，我们首先检查是否发生了错误，并在发生错误时显示出来 ➋。接着，我们检查新余额是否大于之前的余额 ➌。如果是，我们打印一条消息 ➍ 并更新之前的余额 ➎。最后，我们创建一个定时器，每隔 5000 毫秒通过 `setInterval` 函数反复调用 `mainLoop` ➏。

#### *比特币核心 JSON-RPC API*

`mainLoop` 函数通过与 Bitcoin Core *交互* 来运作。这个交互协议采用 JSON-RPC 格式，即 JavaScript 对象表示法 – 远程过程调用。简单来说，JSON-RPC 描述了一种结构，允许两台计算机（或单台计算机上的两个程序）以便于计算机程序员集成到代码中的方式相互发送消息。

在我们的小型应用中，我们仅使用一个命令与 Bitcoin Core 进行通信——`client.getBalance` 函数。但实际上有更多的命令可以让你操作比特币地址、修改钱包、分析交易，并完成你希望在比特币程序中进行的大多数其他任务。要了解 JSON-RPC 接口中可用的函数，可以访问官方 API 函数列表，链接为 *[`en.bitcoin.it/wiki/Original_Bitcoin_client/API_calls_list`](https://en.bitcoin.it/wiki/Original_Bitcoin_client/API_calls_list)*。

### 运行 Hello Money! 程序

为了试用我们全新的 `Hello Money!` 程序，在包含 *hellomoney.js* 的目录中打开终端并运行以下命令：

```
> node hellomoney.js

```

接下来，只需从另一个钱包向由 Bitcoin Core 管理的钱包发送 0.001 比特币。为此，你需要使用一个公共地址，你可以通过点击 Bitcoin Core 中的“接收”来找到该地址。根据我们编写应用的方式，只有在比特币区块链上收到确认后，应用才会统计到你钱包中的资金。（在下一节中，我们将编写一个 `Hello Money!` 程序，它能够在资金到达时立即检测到，而不需要确认。）

由于确认通常需要约 10 分钟，因此你需要稍等片刻才能看到以下内容：

```
> node hellomoney.js
Hello Money! New balance: 0.001

```

恭喜！你已经编写了一个可以监控比特币钱包并检测到资金被发送到其中的程序。如果你接着发送更多的资金，应用将会创建消息来报告这些新存款。

### 使用 JSON-RPC 编写比特币程序的限制

通过使用 JSON-RPC，我们能迅速编写一个 JavaScript 程序，能够报告比特币钱包中收到的资金。然而，如果你是经验丰富的程序员（或对比特币协议有深入理解），你会发现我们示例应用存在许多问题。

一个问题是，应用程序使用*轮询*来检测钱是否到达。轮询不断地通过每五秒钟询问一次比特币核心的状态。这一过程就像是不断问：“你有钱了吗？现在有钱了吗？现在呢？”正如你想象的那样，反复问同样的问题效率极低。

如果你正在编写生产级的应用程序，那么最好使用*推送*方式。推送的方式是指定我们的应用程序在等待资金，并希望在资金到达时得到通知。但由于我们与比特币核心的连接方式，启用推送是相当困难的。毕竟，比特币核心主要是作为一个钱包应用程序，通常不需要推送到外部程序。通过 JSON-RPC 自动化比特币核心有点像是一个黑客手段，因此我们可能会遇到一些限制，例如需要使用低效的轮询。

**注意**

*在比特币核心和 bitcoind 的更新版本中，一个叫做* walletNotify *的功能支持推送，但它的工作方式相当复杂——复杂到我们建议你避免使用它。相反，我们建议你使用 BitcoinJ 来代替比特币核心进行推送，正如我们在附录 B 中将要讨论的那样。*

我们的应用程序的另一个问题是，我们只是检查一个粗略的*余额*数值来判断什么时候钱被发送到了我们的钱包。然而，比特币区块链有时会触发一些情况，导致钱包的余额出现意外的剧烈波动，从而可能使我们的应用程序产生不正确的结果。

例如，假设我们的钱包收到了带有一个确认的款项，但区块链突然分叉，取消了与这笔钱相关联的交易，导致钱包突然失去大部分已确认的款项。然后，在同一个五秒钟的窗口内，有人又向我们发送了更多的钱。在这种情况下，钱包中的余额实际上可能会*减少*，即使我们收到了新钱，而且*Hello Money!*消息也永远不会被触发。

这是一个非常罕见的场景，但如果你正在编写一个操作大量资金的应用程序，那么这种错误行为是不可容忍的。解决这个问题的方法是使用`client.listTransactions`（而不是`client.getBalance`）。然后查看这些交易，判断在过去五秒内是否有新的交易涉及将钱发送到钱包，这正是我们的应用程序要寻找的内容。然而，这对于我们简单的`Hello Money!`程序来说太复杂了。

另一个问题是，比特币核心（和 bitcoind）需要大量的区块链数据和计算资源来运行，尽管我们的简单应用程序并不需要这些大部分的计算能力。有没有办法减少这些资源需求？正如你将在附录 B 中看到的那样，我们可以通过编写一个直接运行在比特币网络上的程序来实现这一点。
