# 前言

![](img/opener-img.png)

今天，我们已接受网络妥协是不可避免的现实。我们的安全格局已将焦点转向尽早发现已被妥协主机上的对手活动，并以精确度来进行有效响应。如果你从事安全工作，你几乎肯定接触过某种类型的端点安全产品，无论是传统的防病毒软件、数据丢失防护软件、用户活动监控，还是本书所讨论的端点检测与响应（EDR）。每种产品都有其独特的目的，但如今没有一种产品比 EDR 更为普遍。

*EDR 代理* 是一组软件组件，用于创建、获取、处理并传输有关系统活动的数据到一个中央节点，中央节点的任务是确定行为者的意图（例如判断其行为是恶意的还是良性的）。EDR 涉及现代安全组织的几乎所有方面。安全运营中心（SOC）分析师从他们的 EDR 收到警报，EDR 使用由检测工程师创建的检测策略。其他工程师则负责维护和部署这些代理和服务器。甚至有一些公司专门通过管理客户的 EDR 来盈利。

是时候停止将 EDR 当作神秘的黑盒来看待了，这些黑盒吸入“东西”并输出警报。通过本书，攻防安全从业者都可以深入理解 EDR 的工作原理，从而识别目标环境中已部署产品的覆盖漏洞，构建更强大的工具，评估他们在目标上执行的每个操作的风险，并更好地建议客户如何弥补这些漏洞。

## 本书适合谁阅读

本书适合任何有兴趣理解端点检测的读者。在攻防两方面，它都能提供帮助。对于进攻方，它可以指导研究人员、能力开发人员和红队操作员，他们可以利用本书中讨论的 EDR 内部原理和规避策略来制定自己的攻击策略。对于防守方，相同的信息则有不同的用途。理解你的 EDR 如何工作，将帮助你在调查警报、构建新的检测、理解盲点以及购买产品时做出明智的决策。

也就是说，如果你在寻找一种逐步指导如何规避你特定操作环境中部署的 EDR 的方法，本书不适合你。虽然我们讨论了与大多数端点安全代理使用的广泛技术相关的规避方法，但我们是以与供应商无关的方式进行讨论的。所有 EDR 代理通常处理相似的数据，因为操作系统标准化了其数据收集方法。这意味着我们可以将注意力集中在这一共同核心上：用于构建检测的那些信息。理解这些信息可以帮助我们澄清供应商为何做出某些设计决策。

最后，本书专门针对 Windows 操作系统。虽然你会越来越多地发现专门为 Linux 和 macOS 开发的 EDR，但它们仍然无法与 Windows 代理所占的市场份额相提并论。由于我们在攻击或防御网络时更有可能遇到部署在 Windows 上的 EDR，因此我们将专注于深入了解这些代理的工作原理。

## 本书内容

每一章都涵盖了特定的 EDR 传感器或用于收集某种数据的组件。我们首先介绍开发者常用的组件实现方式，然后讨论它收集的数据类型。最后，我们回顾了常见的规避技术及其为何有效。

**第一章: EDR 架构**   介绍了 EDR 代理的设计、各种组件及其一般功能。

**第二章: 函数钩子 DLL**   讨论了 EDR 如何拦截用户模式函数的调用，以便监视可能表明系统中存在恶意软件的调用。

**第三章: 进程和线程创建通知**   通过介绍 EDR 用于监控系统中进程创建和线程创建事件的主要技术，并讨论操作系统可以为代理提供的大量数据，开启了我们进入内核的旅程。

**第四章: 对象通知**   通过讨论 EDR 如何在请求进程句柄时接收到通知，继续深入探讨内核模式驱动程序。

**第五章: 图像加载和注册表通知**   通过讲解 EDR 如何监控 DLL 等文件加载到进程中，并如何利用这些通知将函数钩子 DLL 注入到新进程中，结束了内核模式部分的讨论。本章还讨论了与注册表交互时生成的遥测数据，以及如何利用这些数据检测攻击者的活动。

**第六章: 文件系统迷你过滤驱动程序**   提供了关于 EDR 如何监控文件系统操作（如新文件创建）的见解，以及它如何利用这些信息检测试图隐藏其存在的恶意软件。

**第七章: 网络过滤驱动程序**   讨论了 EDR 如何使用 Windows 过滤平台（WFP）监控主机上的网络流量，并检测诸如命令与控制信标等活动。

**第八章: Windows 事件追踪**   深入探讨了 Windows 本地的强大用户模式日志技术，EDR 可以利用它从操作系统的各个角落消费事件，这些地方通常很难访问。

**第九章：扫描器**   讨论了 EDR 组件，负责判断某些内容是否包含恶意软件，无论是一个写入磁盘的文件，还是一段虚拟内存。

**第十章：反恶意软件扫描接口**   介绍了一种 Microsoft 集成到许多脚本语言、编程语言和应用程序中的扫描技术，用于检测旧版扫描器无法检测的问题。

**第十一章：早期启动反恶意软件驱动程序**   讨论了 EDR 如何部署一种特殊类型的驱动程序，以便检测在启动过程中早期运行的恶意软件，可能在 EDR 启动之前就已经运行。

**第十二章：Microsoft-Windows-Threat-Intelligence**   在前一章的基础上，讨论了部署 ELAM 驱动程序的一个最有价值的原因：获得 Microsoft-Windows-Threat-Intelligence ETW 提供程序的访问权限，该提供程序能够检测其他提供程序无法发现的问题。

**第十三章：案例研究：一个检测意识攻击**   通过走查一个模拟的红队操作，将前几章获得的信息付诸实践，红队的主要目标是保持不被检测到。

**附录：辅助资源**   讨论了一些小众传感器，虽然我们不常看到它们被部署，但它们仍然能为 EDR 带来巨大的价值。

## 先决知识

这是一本深度技术性的书籍，为了最大程度地从中获益，我强烈建议你熟悉以下概念。首先，了解基本的渗透测试技巧将帮助你更好地理解 EDR 为什么会尝试检测系统上的特定操作。许多资源可以教授你这些信息，但一些免费的资源包括 Bad Sector Labs 的*《安全周报》*博客系列，Mantvydas Baranauskas 的博客 *红队笔记*，以及 SpecterOps 博客。

我们将花费相当多的时间深入探讨 Windows 操作系统的细节。因此，你可能会觉得了解 Windows 内部结构和 Win32 API 的基础知识是值得的。探讨本书中所涵盖概念的最佳资源是*《Windows 内部结构：系统架构、进程、线程、内存管理与更多，第一部分》*（第 7 版），由 Pavel Yosifovich、Alex Ionescu、Mark E. Russinovich 和 David A. Solomon 编写（微软出版社，2017 年），以及微软的 Win32 API 文档，你可以在[*https://<wbr>learn<wbr>.microsoft<wbr>.com<wbr>/en<wbr>-us<wbr>/windows<wbr>/win32<wbr>/api*](https://learn.microsoft.com/en-us/windows/win32/api)找到该文档。

因为我们会深入分析源代码和调试器输出，你可能也需要了解 C 编程语言和 x86 汇编语言。不过，这并不是必需的，因为我们会逐步讲解每个代码示例，重点突出关键内容。如果你有兴趣深入了解这些主题，可以找到很多优秀的在线和印刷资源，例如[*https://www.learn-c.org*](https://www.learn-c.org) 和 Randall Hyde 编写的《64 位汇编语言艺术》第 1 卷（No Starch Press，2021）。

对工具如*WinDbg*（Windows 调试器）、*Ghidra*（反汇编器和反编译器）、*PowerShell*（脚本语言）以及*SysInternals Suite*（特别是工具 Process Monitor 和 Process Explorer）有一定经验将对你有所帮助。虽然我们在书中会演示如何使用这些工具，但有时它们可能比较复杂。如果你想快速了解这些工具的使用，可以参考微软的《Windows 调试入门》系列文章、Chris Eagle 和 Kara Nance 编写的《Ghidra 书》（No Starch Press，2020）、微软的《PowerShell 脚本入门》课程，以及 Mark E. Russinovich 和 Aaron Margosis 编写的《使用 Windows Sysinternals 工具进行故障排除》第 2 版（Microsoft Press，2016）。

## 设置

如果你想测试本书中讨论的技术，可能需要配置一个实验室环境。我推荐以下由两台虚拟机组成的设置：

+   一台运行 Windows 10 或更高版本的虚拟机，并安装以下软件：Visual Studio 2019 或更高版本（配置为桌面 C++开发环境）、Windows 驱动程序开发工具包（WDK）、WinDbg（可在微软商店获取）、Ghidra 以及 SysInternals Suite。

+   一台运行任何操作系统或发行版的虚拟机，可用作命令和控制服务器。你可以使用 Cobalt Strike、Mythic、Covenant 或任何其他命令和控制框架，只要它能够生成代理 shellcode 并在目标系统上执行工具。

理想情况下，你应该禁用两个系统上的防病毒软件和 EDR，以防它们干扰你的测试。此外，如果你计划使用真实的恶意软件样本，建议创建一个沙箱环境，以减少运行样本时可能出现的任何不良影响。
