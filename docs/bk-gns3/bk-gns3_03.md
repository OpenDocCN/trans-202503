# 第三章 配置

安装 GNS3 只是创建项目的第一步；第二步是配置。幸运的是，GNS3 配置变得前所未有的简单，你只需要执行几个任务。在本章中，我将介绍一些基本的 GNS3 配置选项，帮助你通过 Dynamips 启动和运行 IOS 路由器。

# 获取 IOS 镜像

GNS3 提供的虚拟 Dynamips 路由器是仿真硬件设备。就像一个刚格式化的 PC 硬盘一样，你的虚拟路由器正在耐心等待你安装操作系统，以便它们能够执行一些有用的任务。它们需要的是 Cisco IOS！

在你启动路由器之前，你需要在 GNS3 中安装并配置至少一个 Cisco IOS 镜像文件，尽管获取镜像文件是你自己的事。IOS 是 Cisco 系统的知识产权，通常不对公众开放。此外，由于 GNS3 开发者与 Cisco 没有任何关联，他们也不能合法地提供给你 IOS 镜像（所以请不要问）。

获取 IOS 镜像文件的最简单方法是从你拥有的 Cisco 路由器中复制一个镜像。采用这种方法的好处是你并没有窃取镜像；你已经拥有了一个为你的路由器授权的 IOS 镜像。缺点是 GNS3 仅支持 Cisco 生产的数百个路由器中的少数几个型号，而你的路由器可能不在其列。 （参见附录 B，查看与 GNS3 兼容的 Cisco 路由器和硬件配置的完整列表。）

要从路由器复制 IOS 镜像文件到工作站，登录到路由器并使用 Cisco `copy` 命令将镜像文件从路由器的闪存复制到 FTP 服务器。如果你不知道 IOS 镜像文件的名称，可以在路由器上使用 `show flash` 命令。在以下示例中，IOS 镜像文件名为 *c7200-ios-version.bin*；我的 FTP 服务器运行在 IP 地址为 192.168.1.25 的 PC 上，我的 FTP 用户名和密码分别是 *jason* 和 *mypass*。

```
# copy flash:c7200-ios-version.bin ftp://jason:mypass@192.168.1.25
```

当命令从路由器执行时，镜像文件将通过提供的凭据从路由器的闪存复制到运行在 192.168.1.25 上的 FTP 服务器。

如果你想使用 TFTP，可以从 Jounin 网站下载免费的 TFTP 服务器（*[`tftpd32.jounin.net/`](http://tftpd32.jounin.net/)*）。安装并启动服务器后，使用以下 `tftp` 命令将文件从你的路由器复制到 TFTP 服务器：

```
# copy flash:c7200-ios-version.bin tftp
Address or name of remote host []? **192.168.1.25**
Destination filename [c7200-ios-version.bin]? **<enter>**
```

在 `Destination filename [c7200-ios-version.bin]` 后按 ENTER 键以完成复制。

另一方面，如果你没有 Cisco 路由器，还有一些不太推荐的方式可以找到 IOS 镜像文件，你肯定能通过简单的互联网搜索找到。虽然像 Cisco 和 Juniper 这样的公司过去对这种行为睁一只眼闭一只眼（只要软件仅用于教育目的），但你可能不想使用盗版的 Cisco IOS。这些镜像可能运行得很好，但始终存在它们可能包含恶意软件或已经被以不可预见的方式篡改的风险。

最后，如果你在一家大型公司工作，而这家公司恰好是 Cisco 合作伙伴，你应该能够使用你的合作伙伴凭证登录 Cisco 网站，获取你需要的任何 IOS 镜像。请注意，这种行为可能成为将你送上公司“断头台”的理由，因此在使用公司账户之前，务必先获得许可。

无论你如何获得 IOS 镜像，都只能使用 GNS3 支持的路由器型号设计的镜像文件，而且某些型号的 IOS 版本可能比其他版本更适用。如果你发现 Dynamips 路由器表现得不太稳定，尝试更换 IOS 版本，因为这通常能解决问题。

### 注意

*一般来说，避免使用 c26xx 镜像，因为它们似乎是最不稳定的！*

选择正确的路由器和 IOS 镜像对创建稳定的项目至关重要。推荐的 IOS 版本为 c36xx、c37xx 和 c7200（但不是 c7200p），因为这些版本是 Dynamips 和 GNS3 中最稳定的版本。还需考虑 IOS 版本号。虽然较新的 IOS 版本提供了最新的功能和特性，但旧版本通常会使用更少的 PC 资源，如处理器性能和内存。如果你正在为 CCNA 学习创建简单的项目，可能希望使用 12.2 或 12.3 版本的旧 IOS 来节省资源，但如果你正在为 CCIE 学习，你可能需要安装最新的 IOS 版本。

# 设置你的第一个 IOS 路由器

一旦你拥有了 IOS 镜像文件，开始使用虚拟路由器之前，你需要做一些准备工作。首先，验证 Dynamips 的路径（这对于 Linux 特定）。接下来，将你的 IOS 镜像复制到一个文件夹中，然后将这些镜像添加到 GNS3 中。最后，为每个已添加到 GNS3 的 IOS 镜像设置 Idle-PC 值。我现在将带你逐步完成这些操作。

## 配置 Dynamips

在 Windows 和 OS X 上，偏好设置应该已为你设置好，但在 Linux 上，你需要确认 Dynamips 应用程序的路径是否正确。前往**编辑** ▸ **偏好设置**，选择**Dynamips**，并点击**常规设置**标签，如图 3-1 所示。

请确保“Dynamips 路径”字段指向 */usr/local/bin/dynamips*。如果你将 Dynamips 应用安装在其他目录中，请将路径设置为该目录。

![Dynamips 偏好设置，常规设置标签](img/httpatomoreillycomsourcenostarchimages2208887.png.jpg)

图 3-1. Dynamips 首选项，一般设置标签

接下来，点击**高级设置**标签，显示图 3-2 中的设置。

![Dynamips 首选项，高级设置标签](img/httpatomoreillycomsourcenostarchimages2208889.png.jpg)

图 3-2. Dynamips 首选项，高级设置标签

Dynamips 的高级设置选项主要与 Dynamips 的稳定性和内存使用相关。一般来说，你不应更改这些设置，但我会讨论这些选项，以便你自己决定。

内存使用优化设置旨在节省你电脑的内存。Dynamips 为每个路由器使用的内存越少，你就能在项目中添加更多路由器。启用“虚拟 IOS 支持”选项通过分配一块共享内存区域供多个路由器使用（只要它们运行相同的 IOS 镜像），从而减少你电脑的内存消耗。这也是在一个项目中多次使用相同路由器型号的一个好理由；使用不同型号且 IOS 版本不同的路由器会占用更多的电脑内存。启用“mmap 支持”选项允许路由器内存的内容写入硬盘上的文件，类似于缓存或交换文件。启用“稀疏内存支持”选项可以减少路由器使用的虚拟内存，从而让你每个 Dynamips 进程中运行更多路由器实例。

## 将 IOS 镜像添加到 GNS3

在开始使用 IOS 路由器创建项目之前，至少需要将一个 IOS 镜像添加到 GNS3 中。要添加 IOS 镜像，请在 Windows 和 Linux 系统中选择**编辑** ▸ **首选项**，或者在 OS X 系统中选择**GNS3** ▸ **首选项**。从左侧面板展开**Dynamips**，然后点击**IOS 路由器**，如图 3-3 所示。

![IOS 路由器首选项](img/httpatomoreillycomsourcenostarchimages2208891.png.jpg)

图 3-3. IOS 路由器首选项

点击**新建**开始向导，然后点击**浏览**按钮定位你的镜像文件。选择镜像文件后，你将被问是否希望解压该 IOS 镜像，如图 3-4 所示。

![决定是否解压 IOS 镜像](img/httpatomoreillycomsourcenostarchimages2208893.png.jpg)

图 3-4. 决定是否解压 IOS 镜像

最好让 GNS3 解压你的镜像文件，否则每次加载路由器时，路由器都需要解压镜像文件。提前解压镜像文件会让路由器启动更快。解压完成后，点击**下一步**，GNS3 将尝试识别你的 IOS 镜像所对应的路由器平台，如图 3-5 所示。

![名称和平台屏幕](img/httpatomoreillycomsourcenostarchimages2208895.png.jpg)

图 3-5. 名称和平台屏幕

GNS3 已经确定我的镜像文件属于 c3745 路由器平台，并自动将其命名为*c3745*。如果你认为这个名称不正确，可以使用平台下拉菜单选择另一个平台，但根据我的经验，GNS3 在这方面做得很好。你可以在名称字段中输入任何你喜欢的名称来更改路由器的名称。

一般来说，从这里你可以通过点击所有配置设置来配置一个基本的路由器模型，但向导在此过程中提供了定制路由器内存和其他功能的机会。现在，点击**下一步**继续。你应该会看到内存屏幕，如图 3-6 所示。

![IOS 内存屏幕](img/httpatomoreillycomsourcenostarchimages2208897.png.jpg)

图 3-6. IOS 内存屏幕

路由器在默认内存设置下应该运行良好。但如果你不确定，可以点击**检查最小 RAM 要求**，GNS3 会启动一个网页浏览器并带你进入思科特性导航器网页，网址是*[`www.cisco.com/`](http://www.cisco.com/)*。在这里，你可以搜索你的 IOS 镜像的具体内存要求。然后在默认 RAM 字段中输入该值。完成后，点击**下一步**，你将看到网络适配器屏幕，如图 3-7 所示。

![网络适配器屏幕](img/httpatomoreillycomsourcenostarchimages2208899.png.jpg)

图 3-7. 网络适配器屏幕

默认设置会将路由器配置为与同型号的真实思科路由器提供的标准选项相同。如果你想添加更多的接口，可以使用旁边的下拉菜单选择所需的网络模块。插槽选项将仅限于真实思科路由器的实际可用选项。完成后，点击**下一步**并选择你想安装的任何 WIC 模块。然后再次点击**下一步**，以显示 Idle-PC 屏幕，如图 3-8 所示。

![Idle-PC 屏幕](img/httpatomoreillycomsourcenostarchimages2208901.png.jpg)

图 3-8. Idle-PC 屏幕

如果你在 GNS3 中启动路由器而没有设置 Idle-PC，电脑的 CPU 使用率会迅速飙升到 100%，并且一直保持在那里。发生这种情况是因为 Dynamips 尚不清楚你的虚拟路由器是否正在执行需要系统资源的任务，因此它会过度补偿，分配所有可用的资源给它。直到解决这个问题，GNS3 会运行缓慢，并且如果 CPU 使用率长时间保持在 100%，你的 PC 处理器可能会过热。

你可以通过让 GNS3 查找 IOS 程序代码中的空闲循环位置来轻松解决此问题（空闲循环会导致 CPU 飙升）；这个计算结果称为*Idle-PC 值*。当正确的 Idle-PC 值应用时，Dynamips 应该会定期让路由器在执行这些空闲循环时进入*休眠*，这大大减少了 CPU 使用率。如果你不关心所有细节，只需记住，Idle-PC 值就是防止 Dynamips 让你的处理器吃掉午餐的关键。

若要让 GNS3 自动查找一个值，请点击**Idle-PC 查找器**按钮，GNS3 将尝试搜索一个值。如果 GNS3 找到合适的值，那么操作完成；点击**完成**即可。如果未成功找到，保持字段为空并点击**下一步**以保存没有 Idle-PC 配置的路由器。

## 设置手动 Idle-PC 值

如果 GNS3 无法自动找到 Idle-PC 值，你需要手动查找一个。每个 IOS 镜像只需要计算一次 Idle-PC 值。GNS3 会将此设置应用到使用该镜像文件的*所有*虚拟路由器。关闭首选项窗口，然后将路由器从设备工具栏拖到 GNS3 工作区，如图 3-9 所示。

![将路由器添加到空白工作区](img/httpatomoreillycomsourcenostarchimages2208903.png.jpg)

图 3-9. 将路由器添加到空白工作区

接下来，通过右键点击路由器图标并选择**启动**来启动路由器；然后通过立即右键点击路由器并选择**控制台**来验证 IOS 是否正确加载。一个 Cisco 控制台窗口应该会打开并显示路由器的启动消息。如果路由器启动正确，你就可以开始 Idle-PC 计算；如果没有，请确保分配给路由器的型号和默认 RAM 设置正确，或者尝试不同的 IOS 镜像。

如果你正在运行 Linux 且在选择控制台后没有显示 Cisco 控制台，请检查你的 GNS3 控制台设置。前往**编辑** ▸ **首选项**，点击**常规**，然后选择**控制台应用程序**标签，如图 3-10 所示。

使用预配置命令下拉菜单，选择你的 Linux 终端类型，然后点击**设置、应用**，再点击**确定**。

当路由器启动时，计算机的 CPU 使用率会迅速飙升至 100%。监视你的 CPU 使用率，以便在设置完 Idle-PC 值后，验证 CPU 使用率是否已恢复正常。在 Windows 上，按 CTRL-ALT-DEL 然后点击**任务管理器**查看 CPU 使用率。在 OS X 上，从“应用程序/实用工具”文件夹打开“活动监视器”程序，然后点击*CPU*。在 Linux 系统上，可以使用系统监视器或在终端输入**`top`**命令。

![使用 Ubuntu Linux 选择控制台应用程序](img/httpatomoreillycomsourcenostarchimages2208905.png.jpg)

图 3-10. 使用 Ubuntu Linux 选择控制台应用程序

要开始计算值，右键点击你的路由器并从菜单中选择**Idle-PC**，如图 3-11 所示。

GNS3 现在应该会计算 Idle-PC 值并提供一个或多个可选择的值。这可能需要一分钟时间，因此请耐心等待它在 Idle-PC 值窗口中显示结果，如图 3-12 所示。

如果某个值旁边有星号（*），则说明 GNS3 已经确定该值为最佳值，你应该选择它。点击**应用**来选择该值，并重新检查你的 CPU 使用情况。

有时，GNS3 可能会错误计算该值，导致处理器使用率仍然很高。如果发生这种情况，请尝试使用下拉菜单中的其他值，并再次点击**应用**以选择新值。如果没有显示星号，你将需要通过简单的反复试验找到一个有效的值。完成后，点击**确定**以保存该值。

![手动计算 Idle-PC 值](img/httpatomoreillycomsourcenostarchimages2208907.png.jpg)

图 3-11. 手动计算 Idle-PC 值

![Idle-PC 值](img/httpatomoreillycomsourcenostarchimages2208909.png.jpg)

图 3-12. Idle-PC 值

在应用了有效的 Idle-PC 值后，你就可以开始创建项目了！

# 最后的思考

现在你已经为路由器分配了一个或多个 IOS 镜像文件，并在 GNS3 中配置了基本选项，接下来你可以开始使用路由器了。你可以从路由器设备工具栏中选择任何显示的虚拟路由器，试试看。拖动几个路由器到工作区，启动它们，输入一些 IOS 命令。

就像真实的 Cisco 路由器一样，你的 Dynamips 虚拟路由器的限制由它们所运行的 IOS 版本决定。如果你发现路由器缺少某个 IOS 命令，或者某个命令的语法与预期不符，你可能需要尝试不同的 IOS 版本。如果你正在为 CCNA 或 CCNP 考试学习，这不应该是问题，因为这些认证要求的命令和功能集相对简单。如果你正在为 CCIE 或其他高级 Cisco 认证学习，可能需要最新的 IOS，以支持更强大的功能集。如果不确定，可以访问 Cisco 网站，查看特定路由器型号或 IOS 支持的功能和能力。Cisco 的 Feature Navigator 网页是一个很棒的工具，可以让你按功能、技术、软件、镜像或产品代码搜索 IOS 信息，并允许你比较软件版本。

现在你已经为路由器分配了 IOS 镜像并在 GNS3 中配置了基本选项，接下来我们开始创建项目吧！
