# 前言

![](img/chapterart.png)

欢迎来到*《I*^(*2*)*C 之书*》。本书提供了设计和编程使用互连电路总线（IIC、I2C 或 I²C）的系统所需的资源，I²C 是一种用于将各种集成电路（IC）连接到计算机系统中的串行协议。本书将教你如何通过添加 I²C 外设来扩展嵌入式系统设计，且仅需极少的接线和软件。

引用 [`i2c.info`](https://i2c.info) 的内容，I²C 只使用两根线即可轻松地将微控制器、A/D 和 D/A 转换器、数字 I/O、存储器等设备连接到嵌入式系统中。尽管最初由飞利浦（现为 NXP 半导体）开发，但现在大多数主要的 IC 制造商都支持 I²C。I²C 之所以受欢迎，是因为它普及——大多数嵌入式系统所用的 CPU 都支持 I²C——并且其外设 IC 价格低廉。它广泛应用于像 Arduino 和 Raspberry Pi 这样的爱好级系统，以及大多数用于嵌入式系统的专业单板计算机（SBC）中。

I²C 总线在由“创客”用于个人项目的爱好级嵌入式系统中尤为重要，这些系统通常使用类似 Arduino Uno、Teensy 4.*x* 或 Raspberry Pi 等市售的单板计算机（SBC）作为系统的“大脑”。这些 SBC 通常具有有限的 I/O 能力或其他限制，因此可能需要添加外设 IC 来实现特定设计。I²C 总线是扩展这些系统的最流行和常见方式之一，因为它易于使用、方便且廉价。此外，市面上有成百上千种具有广泛功能的独立 IC 设备，可以直接连接到 I²C 总线。再加上庞大的开源代码库（特别是针对 Arduino 设备的代码），使用 I²C 总线扩展小型系统几乎变得轻而易举。

尽管面向专业嵌入式系统的高端定制 SBC 通常包括爱好级 SBC 所缺少的许多外设，但 I²C 总线仍然是设计此类系统的一种成本效益高的方式。通常，性能要求不高的外设通过 I²C 总线与 SBC 上的 CPU 连接。

由于 I²C 总线的普遍存在，现如今如果不至少对 I²C 总线有一些基本了解，就很难从事嵌入式系统的开发。不幸的是，大多数程序员都被期望通过搜索互联网、拼凑设计和编程信息来弄清楚如何使用 I²C 总线。本书解决了这个问题，收集了所有需要的资源，将它们整合成一本全面的书籍，帮助读者完全理解如何使用 I²C 总线设计和编程系统。

## 预期与前提条件

使用 I²C 外设需要一定的硬件和软件专业知识。理论上，一个没有软件经验的电子工程师可以设计一些硬件，然后交给一个没有硬件经验的软件工程师，两人合作可以完成某些工作。然而，本书并不是为这种团队而写的。相反，它是为那些不怕直接与硬件打交道的软件工程师，或那些不怕坐下来用文本编辑器编写软件的硬件工程师所准备的。

*《I*^(*2*)*C* 的书* 假设你能够阅读原理图，并将 COTS SBC（如 Arduino、Pi 或其他商用 SBC）通过面包板或原型板上的点对点布线连接到各种外设。你应该能够熟练使用万用表、示波器、逻辑分析仪等工具来检查和调试这些电路。

本书还假设你熟悉 C/C++ 编程语言，并能够在上述单板计算机（SBC）上创建、测试和调试适当大小的程序。虽然 I²C 代码可以用多种不同的语言编写（包括汇编语言、Java 和 Python），但 C/C++ 是嵌入式系统的通用语言。几乎每个商用现成单板计算机（COTS SBC）的开发软件都支持使用 C/C++，因此本书假设读者已经掌握了这门语言。

本书中的大多数示例使用了 Arduino 库，因为它广泛应用且易于使用。因此，假设读者至少对 Arduino 系统有基本的了解。树莓派的示例显然使用树莓派操作系统（Linux）和 Pi OS I²C 库代码；本书提供了这些库文档的链接。对于其他系统（例如，运行在 NetBurner 模块上的 µC/OS 或运行在 STM32 模块上的 MBED），本书假设读者没有先前的知识，并提供必要的信息或相关文档的链接。

嵌入式系统编程的软件工具通常运行在 Windows、macOS 或 Linux 上。你应该熟悉运行这些工具的特定系统（例如，C/C++ 编译器），并能够在自己的系统上运行这些工具，包括学习如何使用、安装和配置这些工具及其相关文档。必要时，本书会描述如何找到这些工具及其文档；然而，本书的重点是 I²C 总线，而不是如何运行 C/C++ 编译器和集成开发环境（IDE），因此它留给你自己去了解这些工具。

## 本书中的源代码

本书包含大量的 C/C++ 源代码，代码形式有三种：代码片段、模块和完整程序。

*代码片段*是程序的片段，提供这些片段是为了说明某个观点或提供某种编程技巧的示例。它们不是独立的，你不能使用 C/C++ 编译器编译它们。以下是一个典型的代码片段示例：

```
while( inputPin() == 0 )
{
   .
   .
   .
}
```

这个示例中的竖直省略号表示可以替代的任意代码。

*模块*是可以编译但不能独立运行的小型 C/C++ 代码块。模块通常包含某些其他程序将调用的函数。以下是一个典型的示例：

```
// inputPin function

int inputPin( void )
{
    int p = readPort( 0x48 )
    return p & 1;
}
```

本书中完整的程序称为 *listings*，我通过 listing 编号或文件名来引用它们。例如，以下是 Arduino “闪烁”程序的示例 listing，来自文件 *Listing1-1.ino*。文件名表示它是第一章中的第一个 listing，我在周围的文本中将其称为 Listing 1-1，并在代码本身的注释中标明文件名：

```
// Listing1-1.ino
//
// An Arduino ″Blink″ program.

int led = 13;

void setup()
{
    pinMode( led, OUTPUT );
}

void loop() 
{
  digitalWrite( led, HIGH );   // Turn on the LED
  delay( 500 );                // Wait for 1/2 second
  digitalWrite( led, LOW );    // Turn off the LED
  delay( 500 );                // Wait for a second
}
```

请注意，*Listing1-1.ino* 文件名格式仅适用于我自己编写的代码。其他源代码保持其原始文件名。例如，我提到的第十六章中 TinyWire 库的代码是 *attiny84_Periph.ino*。某些非 Arduino 系统（例如 Pi OS 和 MBED）使用标准的 *main.cpp* 文件名作为主程序；本书通常会将这些程序放在一个名为 *Listingx-x* 的子目录中，并将整个目录称为“listing”。本书中的许多 listing 足够长，我已经将它们分成多个部分，并在各部分之间加上文本注释。在这种情况下，我会在每个部分的开头放置类似 `// Listing10-1.ino (cont.)` 的注释，以保持连续性。

所有 listing 和模块的电子版本都可以在我的网站 [`bookofi2c.randallhyde.com`](https://bookofi2c.randallhyde.com) 上获取，可以单独下载或作为一个包含所有 listing 和其他支持信息（包括勘误表、电子章节等）的 ZIP 文件下载。

除非另有说明，本书中出现的所有源代码都受到 Creative Commons 4.0 许可证的保护。根据 Creative Commons 许可证，你可以自由地将这些代码用于你自己的项目。更多详情请参见 [`creativecommons.org/licenses/by/4.0`](https://creativecommons.org/licenses/by/4.0)。

## 排版与学究主义

计算机书籍往往有滥用英语语言的习惯，而这本书也不例外。每当源代码片段出现在英文句子中间时，编程语言的语法规则和英语的语法规则之间通常会发生冲突。在本节中，我将描述我在区分英语语法规则与编程语言语法规则时的选择，以及其他一些约定。

首先，本书使用等宽字体来表示任何作为程序源文件一部分的文本。这包括变量和过程函数名称、程序输出以及用户对程序的输入。因此，当你看到像`get`这样的词时，你知道本书是在描述程序中的标识符，而不是命令你去获取某样东西。

有一些逻辑操作的名称也有常见的英语含义。这些逻辑操作是 AND、OR 和 NOT。当作为逻辑函数使用这些术语时，本书使用全大写字母以帮助区分可能会让人困惑的英语语句。当这些术语作为英语使用时，本书使用标准排版字体。第四个逻辑运算符，异或（XOR），通常不会出现在英语语句中，但本书仍然将其大写。

通常情况下，我总是尽量在第一次使用任何缩略语或简称时进行定义。如果我很久没有使用这个术语了，我通常会在下一次使用时重新定义它。我在本书中增加了一个术语表，定义了大部分出现的缩略语（和其他技术术语）。

最后，硬核电气工程师通常在描述一组电子信号时使用*buss*一词，尤其是在描述总线条时。然而，我使用*bus*和*buses*的拼写，因为它们在讨论 I²C 总线的文献中更为常见。

## 关于术语的说明

在 2020 年，几家主要电子公司和开放源代码硬件协会（OSHWA）的其他成员提议更改各种 SPI 总线术语的名称，以消除一些人认为在道德上有问题的术语。电子行业长期以来一直使用*master*（主设备）和*slave*（从设备）来描述系统中各种设备的操作层次结构。这些名称没有技术上的正当理由；它们甚至无法精确地描述设备之间的关系，因此即使没有其他问题，使用更合适的术语也是值得推崇的。

尽管这是一本关于 I²C 总线的书，而不是 SPI 总线，但 I²C 可能是下一个需要修改的术语（正如 SparkFun 在[`www.sparkfun.com/spi_signal_names`](https://www.sparkfun.com/spi_signal_names)所提到的）。虽然 I²C 总线没有使用*master*或*slave*的引脚名称，但术语*master*、*slave*、*multimaster*和*multislave*在 I²C 文献中很常见。根据 OSHWA 的 SPI 总线指南，本书采用了以下更具描述性且不具冒犯性的术语：

+   *Master 变为*controller**

**   *Multimaster 变为*multicontroller**   *Slave 变为*peripheral**   *Multislave 变为*multiperipheral**

**当然，*控制器*和*外设*各自有其特定含义，并不总是与 I²C 总线控制器或外设设备对应。然而，本书的上下文会明确表明我所指的意义。虽然大量历史文档仍使用*主机*和*从机*这两个术语，但你可以在脑中简单地将*主机*/*控制器*和*从机*/*外设*相互转换。为了避免与这些历史文档产生混淆，本书仅在引用使用这些术语的外部文档时使用*主机*和*从机*。**

## 组织结构

本书组织结构分为四个部分，除此之外还有附录和在线章节：

**第一部分：低级协议和硬件**

1.  本部分描述了 I²C 的信号和硬件。尽管你不一定需要了解这些信息就能设计基于 I²C 总线的系统或编写代码来编程外设，但这些知识在调试使用 I²C 总线的硬件和软件时非常有用。第一部分还包括了 I²C 总线的软件实现，专为那些更倾向于代码而非电气规格的软件工程师准备，同时还包含了一个关于分析和调试 I²C 总线事务的章节。最后，本部分通过讨论 I²C 总线的各种实际扩展来结束。

**第二部分：硬件实现**

1.  本部分描述了几个 I²C 总线的实际应用，特别是回顾了以下硬件的 I²C 实现：

+   Arduino 系统（及兼容系统）

+   Teensy 3.*x* 和 4.*x* SBC I²C 实现

+   Raspberry Pi、BeagleBone Black、PINE64、ROCKPro64、Onion 及其他 Linux 系统

+   STM32/Nucleo-144/Nucleo-64 I²C 实现

+   NetBurner MOD54415 I²C 实现

1.  第二部分还描述了以下 I²C 总线实现：

+   Adafruit Feather 总线

+   SparkFun Qwiic 总线

+   Seeed Studio Grove 总线

**第三部分：I²C 总线编程**

1.  本部分讨论了在 I²C 总线上编程设备的相关内容。包括了各种通用编程技术，如实时操作系统 I²C 编程，并提供了针对 Arduino、Raspberry Pi、Teensy、MBED 和 NetBurner 的具体实际编程示例。第三部分还描述了如何使用裸机编程技术实现 I²C——这种技术直接在硬件层面工作，而不是调用库代码。

**第四部分：I²C 外设编程示例**

1.  本部分提供了一些常见实际 I²C 外设 IC 的编程示例，包括 MCP23017 GPIO 扩展器、ADS1115 16 位 A/D 转换器、MCP4725 D/A 转换器和 TCA9548A I²C 多路复用器。第四部分还描述了如何将 SparkFun Atto84 模块用作自定义 I²C 外设。

**附录**

1.  附录 A 是 Adafruit I²C 地址汇编的快照，列出了数百种市售 I²C 外设 IC 的地址。

1.  附录 B 包含在线内容的概述。无论我向本书添加多少页，它都将显得不完全，因为市场上有太多 I²C 控制器和外设。此外，在本书出版后，肯定会有新的外设出现。为了解决这个难题（并降低你购买本书的价格），额外的章节可以在 [`bookofi2c.randallhyde.com`](https://bookofi2c.randallhyde.com) 在线访问。

1.  在线内容将涵盖（其中包括）以下主题：

+   MCP4728 四通道 DAC

+   Maxim DS3502 数字电位计

+   DS3231 精密实时时钟

+   MCP9600 热电偶放大器

+   I²C 显示器

+   SX1509 GPIO 接口

+   PCA9685 PCM/伺服接口

+   INA169 和 INA218 电流传感器

+   MPR121 电容式触摸接口

+   Raspberry Pi Pico SBC

+   Espressif ESP32（以及 ESP8266）SBC

**术语表**

1.  本书中出现的术语和缩写列表。

1.  除了在线章节外，网站还将提供帮助，指导如何构建本书中出现的电路，并提供有关编程 I²C 外设的其他信息。它还将包含本书中所有电子项目的零件清单。我的目标是随着新的（重要的）外设和控制器的出现，不断更新这些信息，这些新设备利用 I²C 总线。**
