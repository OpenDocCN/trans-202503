## 第一章：渗透测试概述

*渗透测试*，或称为*pentesting*（不要与测试圆珠笔或钢笔混淆），涉及模拟真实攻击以评估潜在安全漏洞的风险。在一次渗透测试中（与漏洞评估不同），测试人员不仅发现攻击者可能利用的漏洞，还会尽可能利用这些漏洞，评估攻击者成功利用漏洞后可能获得的权限。

时不时地，新闻报道会披露某大公司遭遇网络攻击的事件。通常，攻击者并没有使用最新的零日漏洞（软件发布者尚未修补的漏洞）。许多拥有庞大安全预算的大公司也会因其网站存在 SQL 注入漏洞、员工遭受社会工程学攻击、面向互联网服务的弱密码等问题而受到攻击。换句话说，公司正在通过本可以修复的安全漏洞泄露专有数据，暴露客户的个人信息。在一次渗透测试中，我们会在攻击者之前发现这些问题，并推荐如何修复它们，避免未来出现漏洞。

渗透测试的范围因客户而异，任务也会有所不同。一些客户的安全态势非常优秀，而另一些客户则可能存在漏洞，使得攻击者能够突破外围防护，获取内部系统的访问权限。

你可能还会被要求评估一个或多个定制的 Web 应用程序。你可能会执行社会工程学和客户端攻击，以获得客户内部网络的访问权限。一些渗透测试要求你像一个内部人员一样行事——一个已经突破外围防护的恶意员工或攻击者——进行*内部渗透测试*。有些客户会要求进行*外部渗透测试*，即模拟通过互联网发起的攻击。而有些客户可能希望你评估他们办公室无线网络的安全性。在某些情况下，你甚至可能会审计客户的物理安全控制。

## 渗透测试的阶段

渗透测试从*前期接洽*阶段开始，这一阶段涉及与客户讨论他们对渗透测试的目标，制定测试范围（测试的范围和参数）等内容。当渗透测试人员和客户就范围、报告格式及其他事项达成一致后，实际测试工作就可以开始了。

在*信息收集*阶段，渗透测试人员会搜索客户的公开信息，并识别潜在的连接系统方式。在*威胁建模*阶段，测试人员利用这些信息来确定每个发现的价值，以及如果这些发现使攻击者能够突破系统，客户将面临的影响。这一评估帮助渗透测试人员制定行动计划和攻击方法。

在渗透测试者开始攻击系统之前，他或她会执行*漏洞分析*。在这个阶段，渗透测试者会尝试发现可以在*利用*阶段被利用的系统漏洞。一次成功的漏洞利用可能会进入*后利用*阶段，在这一阶段，利用的结果被用来找到更多的信息、敏感数据、访问其他系统等。

最后，在*报告*阶段，渗透测试者会为高层管理和技术从业人员总结测试结果。

### 注意事项

有关渗透测试的更多信息，可以从渗透测试执行标准（PTES）开始，访问 *[`www.pentest-standard.org/`](http://www.pentest-standard.org/)*。

### 预 engagement

在渗透测试开始之前，渗透测试人员会与客户进行预 engagement 互动，以确保双方对渗透测试的目标达成一致。渗透测试人员与期望仅进行简单漏洞扫描的客户之间的误解，可能会导致尴尬的局面，因为渗透测试比简单的漏洞扫描要侵入性强得多。

预 engagement 阶段是你应该花时间了解客户的渗透测试业务目标的时刻。如果这是他们的第一次渗透测试，是什么促使他们找渗透测试人员？他们最担心的暴露风险是什么？他们是否有任何需要小心测试的脆弱设备？（我遇到过各种设备，从风车到连接患者的医疗设备都在网络中。）

询问客户的业务。对他们来说，最重要的是什么？例如，对于一家顶级在线供应商，几小时的停机时间可能意味着数千美元的收入损失。对于一家地方银行，在线银行网站停机几个小时可能会让一些客户感到不满，但这种停机远不如信用卡数据库被攻破那样具有破坏性。对于一家信息安全供应商来说，攻击者在其主页上发布粗鲁的信息，可能会导致声誉受损，并且逐步引发重大收入损失。

在渗透测试的预 engagement 阶段，其他重要的讨论和达成一致的事项包括以下内容：

**范围**

+   哪些 IP 地址或主机在测试范围内，哪些不在范围内？客户允许你执行哪些操作？你是否可以使用漏洞并可能导致服务崩溃，还是应该将评估限制为仅检测可能的漏洞？客户是否理解，即便是一个简单的端口扫描也可能导致服务器或路由器崩溃？你是否被允许执行社交工程攻击？

**测试窗口**

+   客户可能希望你只在特定时间或某些日期进行测试。

**联系信息**

+   如果你发现严重问题，应该联系谁？客户是否希望你 24 小时内联系某个人？他们是否希望你使用加密邮件？

**一张“免罪卡”**

+   确保你获得了进行渗透测试的授权。如果目标不属于公司（例如，由第三方托管），请确保验证客户已经获得第三方的正式批准来执行渗透测试。无论如何，确保你的合同中包含一项声明，以限制在出现意外情况时的责任，并获得书面许可来进行测试。

**付款条款**

+   你将如何以及何时获得付款，金额是多少？

最后，在你的合同中加入保密协议条款。客户会很感激你书面承诺将渗透测试及其发现内容保密。

### 信息收集

接下来是信息收集阶段。在此阶段，你分析公开可得的各种信息源，这个过程被称为收集*开放源代码情报（OSINT）*。你还将开始使用像端口扫描器这样的工具，来了解互联网上或内部网络上有哪些系统存在，以及运行着哪些软件。我们将在第五章中更详细地探讨信息收集。

### 威胁建模

基于在信息收集阶段获得的知识，我们进入威胁建模阶段。在这里，我们像攻击者一样思考，并根据我们收集到的信息制定攻击计划。例如，如果客户开发了专有软件，攻击者通过访问他们的内部开发系统（源代码开发和测试的地方），并将公司的商业机密出售给竞争对手，可能会给公司带来巨大损失。根据我们在信息收集过程中发现的数据，我们制定渗透客户系统的策略。

### 漏洞分析

接下来，渗透测试人员开始积极发现漏洞，以确定他们的利用策略可能有多成功。失败的利用可能导致服务崩溃、触发入侵检测警报，或破坏成功利用的机会。在这一阶段，渗透测试人员通常会运行漏洞扫描器，利用漏洞数据库和一系列主动检查来推测客户系统中可能存在的漏洞。但尽管漏洞扫描器是强大的工具，它们无法完全替代批判性思维，因此我们也会在这一阶段进行手动分析，并亲自验证结果。我们将在第六章中更详细地探讨各种漏洞识别工具和技术。

### 利用

接下来是有趣的部分：利用。在这里，我们会针对已发现的漏洞（有时使用像 Metasploit 这样的工具）进行攻击，试图访问客户的系统。正如你将看到的，某些漏洞会非常容易被利用，例如使用默认密码登录。我们将在第八章中探讨利用过程。

### 后期利用

有人说，渗透测试真正开始的时刻是在后期利用阶段。你成功入侵了系统，但这次入侵对客户真正意味着什么？如果你入侵了一个没有打补丁的老旧系统，而该系统不在域内或与高价值目标网络不相连，而且该系统不包含攻击者感兴趣的信息，那么该漏洞的风险就远低于你能够攻击到的域控制器或客户的开发系统。

在后期利用阶段，我们收集关于被攻击系统的信息，寻找有趣的文件，必要时尝试提升权限，等等。例如，我们可能会导出密码哈希值，看看是否能够反向破解它们或用它们访问其他系统。我们也可能尝试利用已被攻击的机器，通过*跳板*攻击之前无法接触的系统。我们将在第十三章中进一步讨论后期利用。

### 报告

渗透测试的最后阶段是报告阶段。在这一阶段，我们将我们的发现以有意义的方式传达给客户。我们告诉他们哪些做得对，哪些地方需要改进安全态势，如何入侵，发现了什么，如何修复问题，等等。

撰写一份好的渗透测试报告是一门艺术，需要不断的练习才能掌握。你需要清楚地传达你的发现，无论是给负责修复漏洞的 IT 人员，还是签署变更的高层管理人员，或者是外部审计员。例如，如果一个非技术人员读到“然后我用了 MS08-067 来获得一个 shell”，他或她可能会想，“你是说像海贝壳一样吗？”更好的沟通方式是提到你能够访问或更改的私人数据。像“我能读取你的电子邮件”这样的说法几乎能引起每个人的共鸣。

渗透测试报告应包括执行摘要和技术报告，以下章节将进一步讨论。

#### 执行摘要

执行摘要描述了测试的目标，并提供了发现的高层概述。预期的读者是负责安全程序的高层管理人员。你的执行摘要应包括以下内容：

+   ****背景****。对测试目的的描述，以及对高层管理人员可能不熟悉的术语的定义，例如*漏洞*和*对策*。

+   ****总体态势****。对测试有效性的概述，发现的问题（例如利用 MS08-067 微软漏洞），以及导致漏洞的常见问题，例如缺乏补丁管理。

+   ****风险概况****。与类似组织相比，组织安全态势的整体排名，可以采用高、低、中等等衡量标准。你还应该包括对排名的解释。

+   ****总体发现****。识别问题的总体概述，以及已部署反制措施的有效性统计和度量。

+   ****建议总结****。渗透测试中发现的问题的修复任务的高级概述。

+   ****战略路线图****。为客户提供短期和长期的安全改进目标。例如，你可能会建议他们立即应用某些补丁来解决短期问题，但如果没有长期的补丁管理计划，客户在新补丁发布后仍然会面临同样的问题。

#### 技术报告

本报告部分提供了测试的技术细节。应包括以下内容：

+   ****引言****。包括范围、联系人等细节的清单。

+   ****信息收集****。信息收集阶段的发现细节，特别是客户的互联网足迹。

+   ****漏洞评估****。漏洞分析阶段的测试发现细节。

+   ****利用/漏洞验证****。测试中利用阶段的发现细节。

+   ****后期利用****。测试后期利用阶段的发现细节。

+   ****风险/暴露****。发现的风险的定量描述。本节估算如果攻击者利用已识别的漏洞，可能造成的损失。

+   ****结论****。测试的最终概述。

## 总结

本章简要回顾了渗透测试的各个阶段，包括前期准备、信息收集、威胁建模、漏洞分析、利用、后期利用和报告。熟悉这些阶段对于你开始渗透测试的职业生涯至关重要，你将随着本书的进展了解更多相关内容。
