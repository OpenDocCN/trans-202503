# 第十二章：媒体

当软件工程师谈论媒体时，他们通常指的是*多媒体*，即音频和视频。这些技术彼此非常不同，并且都需要深入的领域专业知识。因此，工程师通常只专注于其中一种，而不是两者都做。然而，音频和视频工程师通常会被集合到同一个“媒体”团队中。也许是因为它们都需要设备提供强大的性能和内存——并且在软件中进行极端的优化——才能确保为用户可靠地工作。

## 戴夫·斯帕克斯与铃声

戴夫·斯帕克斯一生只上过一门编程课，那就是他高中二年级时的 Fortran 课程。在那门课上，编写程序的方式是将代码输入穿孔卡片，然后用橡皮筋包裹起来，快递到区办公室，程序在那里执行。几天后，学生们会收到程序的打印输出结果。^(1)

戴夫对教室后面那台老旧的 Monrobot XI 系统更感兴趣，这是一台大约 1960 年左右的机器，使用旋转磁鼓进行存储。他学会了如何在那台老系统上编写机器代码，在这个过程中几乎没通过 Fortran 课程。

他的编程生涯始于高中毕业后，那时他在 RadioShack 工作。有一天，雷·杜尔比^(2)来到商店寻求帮助；他想要一款程序，将自己的股票数据下载到电子表格中。经理指着戴夫说，他可以帮忙。写完一个程序并收取 50 美元后，戴夫成为了一名职业程序员。

在 2000 年代初，运营商要求手机支持各种铃声格式。更复杂的是，不同运营商使用不同的格式，因此手机制造商必须支持多种格式，以便能够将设备销往不同的市场。

雅马哈提供了一款专用的合成器芯片，能够处理这些要求，每部手机的成本为几美元。制造商总是寻找降低成本的方法，于是 Sonivox 公司推出了一种基于软件的解决方案，每部手机只卖一美元。

戴夫·斯帕克斯当时负责 Sonivox 的那个产品，当安迪·鲁宾打来电话时。

随着 Android 计划开源操作系统，安迪的需求与 Sonivox 的典型客户不同；他不仅想要这个产品，还希望发布源代码，从而有效地消除未来的销售机会。戴夫记得这笔交易时说：“这将来会开源。这里有一大笔钱。”

这笔交易发生在 2007 年初。3 月，戴夫来到了 Google，并与 Ficus Kirkpatrick 一起花了几个小时将那款软件集成到系统中。突然，Android 可以播放铃声了。

几个月后，安迪打电话给还在 Sonivox 的戴夫，邀请他加入 Android 团队建立媒体团队。戴夫于 2007 年 8 月加入了 Android。

## 马尔科·内利森与音频

在 Ficus 使 Sonivox 软件能够支持铃声后，他还成功让一首 MP3 铃声播放起来：“Crazy”——Gnarls Barkley 的歌。Joe Onorato 解释道：“mp3 播放是非常繁琐的工作。等他把那个功能搞定后，我们需要一个铃声。他提交了‘Crazy’的 MP3 文件，那就成了最终的铃声。”

随着所有 Android 手机在每个电话中播放相同的铃声，这首歌让每个人都快受不了了……你明白的。

团队需要帮助将铃声系统普及化，因此他们雇佣了一个已经从事音频软件开发多年的专家：Marco Nelissen。

在荷兰上高中时，Marco 的父母给他买了一台 Commodore 64。最初他只是玩游戏，但很快他就开始在上面编程，学习 BASIC 语言，然后是汇编语言。他写了文本编辑器，接着开始玩多媒体应用程序，包括一个名为 SoundTracker Pro 的音乐序列应用程序。^(3)

大学毕业后，他继续从事多媒体工作，首先在一家为 Philips CD-i 平台编写软件的公司工作，随后加入了 Be 公司。像许多 Be 的同事一样，他在 Be 被 Palm 收购后加入了 Palm。Marco 在 PalmSource 待得比大多数团队成员都长，因为大多数人早在 2006 年初就已经加入了 Google，开始在 Android 项目中工作。Marco 最终于 2007 年 1 月加入了 Android 团队。

Marco 深入研究了 Android 的音频功能。他的第一个项目是增加日益重要的选择不同铃声的功能。“不是我不喜欢那首歌，而是当你听到每隔几分钟别人电话响起时都听到同样的声音，实在是让人烦。”

他继续从事声音和多媒体方面的工作。他为模拟器（团队用于调试软件的工具）增加了音频功能，并最终编写了 Android 的第一个音乐应用程序。他还为 Eclair（Android 2.1）版本编写了几个首批动态壁纸（声音和音乐可视化效果），这些壁纸与 Nexus One 一同发布。

## AudioFlinger

另一个需要解决的音频问题是 G1 的音频问题。该设备的原 HTC 音频驱动程序有很多 BUG，甚至像在已经播放的声音上同时播放第二个声音这样简单的操作都会导致设备重启。Android 团队无法访问该驱动程序的源代码，因此他们通过在驱动程序之上增加一个名为 AudioFlinger 的层来规避这个问题。

Mathias 根据自己编写 SurfaceFlinger 的经验想出了这个名字。SurfaceFlinger 解决了图形方面的一个相关问题，许多应用程序生成像素数据缓冲区，SurfaceFlinger 将这些缓冲区显示在屏幕上。类似地，AudioFlinger 将系统中的多个音频流合并成一个流，然后发送到驱动程序，而不会（这是关键部分）导致设备重启。Mathias 与 Marco、Arve 和 Ficus 合作，成功地为 G1 实现了它。它本应只是该平台针对特定设备的临时解决方案，但正如软件中常见的情况一样，它在超出其有效性之后仍然存在，直到最终被重写，以便系统能够更直接地与没有这些历史问题的驱动程序进行通信。

## 没人喜欢的视频代码

处理视频很复杂。首先，视频需要编解码器^(4)来加载和保存视频文件。视频软件还需要能够播放由编解码器加载的内容。一旦这些工作都完成，你还需要对其进行优化，以便快速完成，因为无法流畅播放的视频就不再是“视频”，而更像是“让人沮丧”。

与此同时，软件需要能够与硬件进行通信，这很棘手，因为专用视频硬件在不同设备之间可能差异很大。

由于团队规模如此之小，实施视频所需的一切会非常困难。所以 Andy 决定购买必要的技术，而不是自己编写。他让 Ficus Kirkpatrick 查看一些选项，但让他专注于一家名为 PacketVideo 的公司。当时，PacketVideo 许可了一个完整的软件套件，可以实现 Android 所需要的所有功能。

交易即将达成；Ficus 的调查更像是一次理智检查，而非深入分析。Ficus 记得，“Andy 告诉我，无论如何他都会做这笔交易。”像团队其他成员一样，他当时忙于其他事情，看起来这笔交易是板上钉钉的结论，所以他没有花太多时间去评估情况：“我当时觉得这无关紧要。我认为代码不好，但没有提出异议。”

他简要调查了其他选项。他否决了一个替代方案，因为他们的代码状态。那家公司过于专注于让他们的产品在 Windows 上运行，以至于在软件中埋入了假设，使其无法在任何其他操作系统上使用（比如 Linux，这是 Android 所需要的）。相比之下，PacketVideo 是一个更好的选择。“它可能是我看过的所有媒体框架中最不糟糕的。”

Andy 提出的交易对 PacketVideo 来说很尴尬；他提出的方案是将他们业务的核心部分交出去。这家公司通过许可他们的视频软件赚钱。Android 不仅需要他们代码的功能，还需要代码本身。Android 计划将平台的所有代码开源，包括 PacketVideo 的代码。所以 Andy 提出的交易是，Android 将拿走他们的软件并公开发布，实质上摧毁了他们未来的任何许可可能性，因为任何潜在客户都可以直接复制 Android 代码。Ficus 说：“Andy 向他们推销的说法是，‘你们的业务将从许可转向专业服务。我们会给你们一些钱，以帮助你们过渡。’”

交易达成了（在 Tom Moss^(5))的帮助下），代码已经集成，而 Android 团队却……不高兴。^(6) Ficus 记得说：“代码不是很好，优化起来真的很困难。”

Mathias Agopian 同意了。“从技术角度来看，这是个灾难。PacketVideo 在纸面上看起来真的很不错：大量的编解码器、播放、录制、视频、音频。从纸面上看，问题解决了。但我们花了许多许多年修复，最终重写了一切。”

Ficus 继续说道：“可能我唯一的好贡献就是拒绝发布他们的 API，只发布了极其简单的 MediaPlayer/MediaRecorder [API]。这是一个低复杂度、低能力的 API，它使得很多内部工作得以重构。”也就是说，通过只向应用开发者提供简单且通用的视频功能，而不是直接暴露更先进的 PacketVideo 功能，Ficus 确保了视频实现的细节可以在之后发生变化，当团队有更多时间处理这个问题时。

事实上，最终确实发生了这种情况。几年后，这一层系统被完全重写，成为了一个名为*stagefright*的组件。Andreas Huber，当时媒体团队的一名工程师，一直在稳步重写 PacketVideo 代码的部分内容。最终他意识到旧代码再也没有被调用，于是他删除了它，PacketVideo 的代码也就此消失了。
