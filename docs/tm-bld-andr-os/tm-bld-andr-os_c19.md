# 第十九章：应用程序

## 移动应用生态系统

对于安卓用户来说，数百万个可用的应用程序在保持平台的相关性方面至关重要。毕竟，应用程序是用户在智能手机上花费最多时间的地方。

如果现在有人推出一种新的设备或平台，而没有任何应用商店（更别提一个用户密集的商店），那根本行不通。当 RIM 推出 BlackBerry 10 时，他们为智能手机推出的最终操作系统^(1)，添加了一个兼容模式，允许用户安装并运行安卓应用程序。他们这样做是因为认识到，BlackBerry 的应用生态系统（尽管公司和其手机已经存在多年）无法提供安卓和 iOS 应用商店中那么广泛和多样化的应用程序。

但即使有大量的应用市场，平台上仍然必须有一组核心应用，特别是来自谷歌和苹果这样的公司，这些应用让用户能够访问他们期望从这些公司获得的服务和功能。

当安卓刚推出时，*并没有*其他应用的生态系统。所以安卓团队构建了随设备一起发布的核心应用集，并为用户提供了引人注目的功能。

今天，这些谷歌应用程序（Gmail、Maps、Search、YouTube 等）由拥有这些产品的团队开发。因此，不是安卓团队编写 YouTube 应用程序，而是 YouTube 部门编写核心的 YouTube 服务和基础设施、网页版应用程序、安卓应用程序，以及与更大产品相连的其他客户端应用程序。

但在早期，其他产品团队都无法完成这项工作。这些其他团队都有足够的工作要做，没时间为这个新且未经验证的平台开发应用程序。而且，安卓平台和 API 不断变化，一直到 1.0 版本发布之前也是如此。当一个成熟的产品为何要承担编写应用程序的工作和烦恼呢^(2)，如果它们必须不断根据 API 变化而重新调整？

因此，安卓团队的工程师承担了编写这些初始版本核心应用程序的工作。这些是个人，而非团队，因为很少有超过一到两个人参与这些初始应用程序的开发（这些应用程序现在由更大的团队维护和开发）。例如，安卓的初始 Gmail 客户端主要由 Cédric Beust 编写，Mike Cleron 则提供了一些性能方面的帮助。

## Cédric Beust 和 Gmail

> 我知道我们做对了事情，第一次成功地获得推送通知时。
> 
> —Cédric Beust

安卓版 Gmail 的根基来源于其他平台的版本，因为它的主要作者是 Cédric Beust。

2004 年，Cédric 加入了 Google，并且像许多有服务器端经验的新工程师一样，最终进入了广告组工作。经过一年的时间，他开始寻找新的挑战，并发现有一个小团队在研究移动技术。这个团队的工作是让 Google 的应用和服务能够在那个时代的各种移动设备上运行。Cédric 加入了这个团队，并开始了 Gmail 的开发工作。他最终组建并领导了一个约二十人的团队，开发了 J2ME 版的 Gmail 应用。

在那个时代，像今天的两个主要平台（iOS 和 Android）并不存在普及的移动“平台”。相反，当时有许多厂商特定的平台，覆盖了市场的特定细分领域，比如微软的 Windows CE 和 RIM 的 BlackBerry OS。还有 J2ME，它声称可以跨越多种设备运行，使用相同的编程语言（Java）和某种形式的 J2ME 库。因此，一个公司试图覆盖整个生态系统中的各种设备时，会发现 J2ME 的概念非常诱人。但 J2ME 的实际情况是……相当困难的。

Cédric 说：“我们开始考虑如何在 J2ME 上实现 Gmail。我们很快意识到这真的是个糟糕的主意。它几乎存在于所有设备中……但每个厂商，甚至同一个型号的设备，都有不同版本的 J2ME。它们的限制各不相同。并不是所有设备都实现了相同的配置文件。有些设备有蓝牙，其他没有。没有任何约束、合规之类的东西。任何手机都可以声称自己符合 J2ME 标准，却根本不支持我们所需要的半数功能。所以我们当时非常困扰。”

但 Cédric 的团队最终成功推出了一个版本的 Gmail，这个版本忠实于 Gmail 在网页上的核心体验，能够在这些尺寸更小、功能更受限的设备上运行。“我们在约 300 款不同的设备上推出了 J2ME 版 Gmail，并且 UI 设计也相当不错。有些设备比其他设备更麻烦，但总体来说，我们成功了。”^(3)

在 Android 被 Google 收购后不久，Andy Rubin 联系了 Cédric。作为移动 Gmail 团队的负责人，Cédric 是帮助为新兴的 Android 平台编写 Gmail 的合适人选。他当时已经有兴趣，但当 Andy 描述了这个项目的动态时，他完全被吸引了。Andy 的团队由一群底层内核专家组成，其中许多人有将受限的移动设备推向市场的经验。^(4) 他们正在创建一个基于 Java 编程语言的平台（Cédric 是这个语言的爱好者和专家），并且他们需要有编写应用程序的专业知识。“听说这些人很开放，并且我们需要用 Java 来编写，这对我来说更加有趣和吸引人。”

Cédric，像许多早期的安卓工程师一样，拥有相关的经验和观点，并且强烈希望在安卓上做对的事情。“我了解那种痛苦，并且清楚我不想再发生什么。调试 J2ME 时，你无法连接调试器，只能通过在状态栏上`println()`^(5)来查看自己在代码中的位置。这简直是噩梦。所以我知道我到底想修复什么。”

当他开始时，安卓上正在开发的两款应用是 Gmail 和日历。

现在，应用程序与其产品组的开发更为紧密是有道理的。但在当时，让应用由安卓团队的工程师开发对应用本身和安卓平台都非常有用。首先，平台和所有的 API 都在不断变化，应用必须能够应对这些变化。此外，在许多情况下，应用开发人员需要平台做出变更才能支持他们的需求。像 Cédric 这样的应用开发人员主要负责应用程序，但在必要时，他们也会帮助核心平台和安卓 API 的开发，特别是应用驱动的平台变化。

“我和 Mike [Cleron] 一起工作，做布局系统、视图系统，如何处理所有原始的布局 API 和算法，双遍算法。我和 Dianne [Hackborn] 以及其他人一起合作，也涉及到 Intents^(6)。我记得我们曾在房间里花了好几个小时，试图弄清楚如何命名这些我们现在叫做*Intents*的东西。我们花了好几个小时讨论‘车棚涂漆’^(7)，试图找出最合适的词。最终我们想出了‘Intent’。”^(8)

“我们都为它背后的总体理念感到兴奋：我们如何让一个应用能够调用另一个应用，而不需要知道那个应用是否已安装？我们会说，‘有人能处理这个吗？’如果能处理，就行。我们都很兴奋。”

所有这些工作都发生在平台不断发展的同时，团队也在不断壮大。“我还参与了人员的招聘。我们需要 Java 工程师。我们现在就需要一百个 Java 工程师。所以当时的招聘、面试非常疯狂，同时也写了大量的代码。然后又扔掉了很多代码，因为我写的很多代码是调用的 API，这些 API 一周后就被修改、移除或者更改了。”

应用开发人员在基于一个正在并行开发的平台编写代码时，必须执行一场复杂的舞蹈。该平台的许多功能和 API 处于变化之中，而应用所需的许多功能根本不存在。^(9) 必须有人实现这些功能，才能让应用做它们需要做的事情。在 Android 上，这通过小团队在平台和应用程序的各个部分进行大量工作来实现。罗曼·盖伊说：“团队很小。进行这些更改的速度相当快；我们所有人都能访问整个源代码树。我记得在 1.0 发布之前，我对视图系统做了很大的改动，以清理 API。你做一个 CL，涉及 800 个文件，并在修改时修复所有应用。所以这不完全是应用需要这样做，尽管也是这样。每个人都在出力。”

Gmail 需要处理的一个硬性约束是性能问题。最初，Gmail 应用是以每条消息都有自己的 WebView 来编写的。^(10) 实际上，每条消息都是一个单独的网页，这会带来许多开销，而这些开销在用户看到的屏幕文本中并不明显。罗曼说：“但这对设备来说太吃力了。所以迈克重写了这一切。”

当时 Android 工程团队的负责人 Steve Horowitz 谈到了 Gmail 的性能问题。“Cédric 在架构上采取的方法在某些时候是有效的。老实说，部分原因可能仅仅是当时视图系统的能力限制。你能堆叠多少个视图来创建那些线程？”

“所以迈克不得不来解开这些问题，并重新做一遍，这样整个线程就不再是一个独立的视图，而是渲染到一个视图中。为了让它能正常工作，Gmail 的架构进行了根本性的重构。”

与此同时，使用 WebView 的要求给团队带来了额外的压力。使用 WebView 是有道理的，因为电子邮件消息需要网页功能。尽管许多电子邮件消息显示的是纯文本，但这些文本可能包含各种变化，并且格式也各不相同，因此能够显示该消息的 HTML（网页）版本是必要的。

因此，团队依赖于由浏览器团队开发的 WebView 组件。但 Gmail 消息中嵌入的 HTML 并不是普通的 HTML。它是一个内容类型的子集，并且对如何显示这些内容有一定的期望。要使其在 Android 上正常运行，就需要理解 Gmail 在后端的处理方式，并让浏览器（和 WebView）团队能够显示这种 HTML 的奇异变体。

在为 Gmail 开发时也有很多值得开心的事。那时开发安卓应用程序的一个重要动力是，这个平台拥有其他地方没有的功能。工程师们能够创造出比以前更强大的应用体验。

“我知道我们做对了什么，是第一次能够收到推送通知时的感觉。我们不确定是否能做到，是否能保持连接并让服务器告诉我们，‘你有新的邮件。’对于 J2ME，我们没有这个功能；你需要不断地刷新。但在某个时刻，我能够发送一封邮件，看到我的手机有反应。我做的第一件事就是跑去斯蒂夫·霍洛维茨的办公室展示给他看。他的下巴都掉下来了。他知道我们在做这个，但他不知道我们是否能做到。”

罗曼·盖伊说，“我喜欢第一款安卓手机，1.0 版，最喜欢的一点是我们有了邮件和聊天的推送通知，这在当时非常重要，因为 iPhone 没有这个功能。我记得我的手机比我的桌面电脑更快收到邮件。我的手机会发出提示音，几秒钟或几分钟后，我的桌面才会显示新邮件。”

尽管塞德里克负责 Gmail 的安卓端，但整个应用程序的大部分功能依赖于与 Gmail 后台通信的机制。这项工作是在安卓服务团队中完成的。
