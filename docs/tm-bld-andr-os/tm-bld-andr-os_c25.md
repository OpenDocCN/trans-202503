# 第二十五章：精简代码

> 一旦你写完了，就无法再回去重新优化。
> 
> —Bob Lee

Android 从最早期开始的一个特点就是它经过了极其优化，以便能在当时那些极其受限的移动设备上运行。团队的性能思维影响了从 API（许多 API 是以特定方式编写的，以避免分配内存）到给外部开发者的编码建议的一切。这一切都围绕着编写最优代码，因为每一个周期，每一千字节，都消耗着宝贵的资源或电池寿命，这些本可以用在其他地方。

至少部分性能优先的关注可以归因于早期团队成员的背景。那些曾经在 Danger 工作的工程师们，他们让操作系统能在比 Android 的 G1 更为受限的设备上运行。而来自 PalmSource 的工程师们也熟悉移动设备的限制和现实。

Bob Lee 观察到，“他们（前 PalmSource 工程师）曾说，其中一个失败的原因是他们试图做的事情超出了硬件的承受能力。一旦你写完了代码，就不能回头再做优化了。我只是觉得他们在 Android 上避免了那个错误。这也是为什么黛安（哈克伯恩）和其他人对性能如此严格，一直微优化许多细节的原因。那时候的手机速度是如此慢。”

“我记得大家——我、黛安、丹（博恩斯坦）——都会待在这个战争室里，因为在发布的过程中，总会有很多地方因为使用过多内存而出现问题。我们没有交换分区，因为没有意义去设置交换分区。程序会因为内存不足而崩溃。那是一次次的英雄般的会议，我们有时会持续几天，而你永远不知道什么时候会结束，就是不停地努力解决内存问题。”

“这一切都与内存页的分配有关。黛安或者布赖恩·斯韦特兰曾写过这些工具，用来查看脏页以及哪些页面被访问过。我们只是必须解决这个问题。我们需要不断查看哪些应用程序引发了问题并尽量定位它们。”

Ficus 回顾他在 Be 和 Danger 的经历对他在 Android 工作时的影响：“我们当中很多人都来自嵌入式系统，拥有对 CPU 周期或内存极度节俭的哲学。我觉得从这个角度来看早期 Android 的许多决策是很有趣的。我看待这些工程师，就像他们是在大萧条时期成长的，他们学会了如何从锅底刮食物。”

整个平台团队的思维方式是性能优先。这源于早期设备的内存有限、CPU 速度较慢、没有 GPU 渲染（直到 Honeycomb 版本发布，Android 才开始使用 GPU 进行 UI 图形渲染），以及 Dalvik 的垃圾回收器（需要时间进行内存分配和回收）等因素的综合影响。即使今天每个设备的性能都更强大、更快速，这种态度在内部依然延续着。手机的每一项操作都会消耗电池电量，因此优化平台代码依然是值得的。从那些早期的日子开始，外部开发者的建议要求已经放宽，但 Android 的 API 和实现仍然反映了当初的性能限制。
