# 第九章：核心库

![g09001](img/g09001.png)

为平台提供一种编程语言是一回事。这确实是个大事，特别是当它是大多数开发者已经熟悉的语言时。但程序员们也希望拥有标准的实用工具函数，这样他们就不需要每次编写应用程序时重新发明轮子。一种编程语言让你能够编码逻辑（如条件语句、循环、方程式）。但像数据结构、网络或文件读写这样的更高层次的功能，是核心库的职责。

尽管 Android 团队采用了 Java 语言，但他们明确没有使用与 Sun Microsystems 提供的 Java 版本（即 Java 开发工具包 JDK）一起发布的库实现。JDK 包含了比如 `ArrayList` 类，这个类实现了一种在编程中常见的简单数据结构。但是 Android 没有使用这些类，所以他们需要提供自己的实现。

## Bob Lee 和 Java 库

当 Android 需要标准的 Java 库时，他们引入了一位在谷歌其他地方工作的 Java 专家：Bob Lee。

Bob（也被称为“疯狂的 Bob”^(2)) 在 90 年代初中时开始编程，主要是因为他想编写视频游戏。他很快掌握了多种编程语言，并在高中时从制作视频游戏转向为附近的一所大学建立网站。该大学对他的作品印象深刻，给了他全额奖学金让他继续从事这个工作。但大学不适合 Bob，他离开后开始做咨询工作，同时写书和流行的 Java 库，最终于 2004 年获得了谷歌的工作。

Bob 想要从事移动技术工作，因此在广告团队工作了几年后，他于 2007 年 3 月转到了 Android 团队。

当 Bob 加入时，Android 仍在使用 JamVM 运行时，直到 Dalvik 运行时上线。*核心库*基本上是一堆人为了单次使用目的编写的随机实用工具。“它们完全不兼容。某个人需要某个功能，就会实现自己需要的部分。它们看起来有点像 Java 库，但显然缺少了很多。”

幸运的是，已有一些现成的标准库选项，因此 Bob 和团队对它们进行了评估。“我们看过 GNU Classpath，但最后选择了 Apache Harmony^(3)。它有很多不太好的地方，所以我们需要重写其中的一部分，然后把它们贡献回去。比如我们重写了 `ThreadLocal` [和] `Runtime.exec()`。重写这些东西并合并回去是其中很重要的一部分。”

“还有一些由团队中的其他工程师添加到 Android 核心平台的 API，只是因为当时看起来是个好主意。如果有人认为某个功能可能有用，他们就会把它加进去。结果有一些真的很糟糕的东西。”

一个例子是`WeakHashMap`，这是一种开发人员在内存受限的情况下使用的数据结构类，就像当时的 Android 一样。它比传统的`HashMap`类更有优势，因为它会自动清理（垃圾回收）不再使用的对象。就像为内存堆清理垃圾的 Roomba，清理你遗留下来的垃圾。请注意，这里“弱”（weak）一词来源于“弱引用”这个术语，指的是当对象不再使用时，可以被垃圾回收的对象。

框架团队的 Joe Onorato 添加了`WeakHashMap` API。算是吧。他说：“我有一个库依赖于`WeakHashMap`，我需要将它链接^(4)，所以我创建了一个名为`WeakHashMap`的类。”问题在于，Joe 的类并不是一个“弱”`HashMap`，它只是一个标准的`HashMap`。它继承了`HashMap`，但没有添加任何能让它变得“弱”的逻辑。稍后，框架团队的 Jeff Hamilton 正在编写需要`WeakHashMap`功能的代码。他发现这个类已经存在于核心库中，使用它时遇到了内存问题，进行了大量的调试，直到 Jeff 发现 Joe 的`WeakHashMap`类根本没有清理内存。它只是一个普通的`HashMap`，并没有执行 Jeff 预期的垃圾回收工作。

Bob 继续说道：“我知道 Android 的 API 本来可以做得更好……但它们也可能做得更糟。”Bob 的大部分时间都用来防止这些 API 公开。“我会找到并删除所有这些东西。如果有一个类只被一个应用使用，我会把它移回到那个应用中——如果你不打算在多个应用中使用它，它就不应该出现在框架库里。”

在使核心库正常工作的过程中，Bob 实现了重要的网络功能，并修复了其中的错误。一个问题导致每台手机根本无法启动。“第一次启动手机时，它必须连接到时间服务器，但设备的时间设置在 2004 年某个时候。”手机会尝试通过安全连接连接到服务器，这需要服务器上的安全证书。但是手机上的初始时间早于证书在服务器上发布的时间，因此连接会失败，手机无法启动。Bob 的解决方案是捕获这个失败条件，并将手机上的初始时间设置为他修复这个 bug 的那一天。

Bob 还解决了一个仅在移动数据下出现的网络问题。Android 手机出现了严重的断网问题，看起来像是运营商网络基础设施的问题。

网络协议内置了容错机制，因为网络可能会中断，或者数据包可能会丢失或延迟。Android 使用了 Linux 中的*拥塞窗口*方法，该方法通过将数据包大小减半，然后再减半，一次次减小，直到从服务器获得数据包通过的响应。然后，它会在每次成功后将数据包大小翻倍，直到数据包最终恢复到原始大小。

这个算法对于常规的互联网流量是合理的，在互联网中，延迟（发送消息和接收响应之间的延迟）通常以毫秒为单位衡量，且中断比较少见。但它对蜂窝数据并不适用，因为蜂窝网络常常有一秒或更长时间的高延迟，而且短暂的中断也很常见。鲍勃进行了一些性能分析和调查，找到了问题所在。在故障发生后，数据包大小减少了，“每当数据包成功传输时，它会将缓冲区大小翻倍。但在移动网络上，由于延迟较高，2.5G 或 3G 网络的往返时间会达到一到两秒。所以，它只是每次成功往返时才增大缓冲区大小。在你遇到某种中断后，重新调整缓冲区大小可能需要大约 30 秒。”

## 杰西·威尔逊与糟糕的 API

> 我们花了很长时间将这些 API 从头重新实现，以使它们变得更加优秀，同时保持它们原本糟糕的 API。
> 
> —杰西·威尔逊

鲍勃曾一度独自工作于核心库，但最终，在 1.0 版本发布后，他得到了帮助。乔希·布洛赫（Josh Bloch）在 2008 年底加入了他的团队，杰西·威尔逊则在 2009 年初加入。

杰西·威尔逊（Jesse Wilson）在鲍勃（Bob）加入 Android 之前一直在与他一起工作于 Google AdWords 产品。“当 Android 看起来不像是一个负责任的职业选择时，鲍勃从 AdWords 转去 Android。我跟随他去那里，更多的是为了和鲍勃一起工作，而不是为了做 Android。”

最终，鲍勃和杰西离开了 Android 和 Google。鲍勃成为了 Square 的首席技术官（CTO）。杰西再次跟随鲍勃，加入了 Square。^(6) “我想他掌握了我的把柄。”

Jesse 描述了核心库团队的工作：“在 Android 的第一年，大家只是带进来他们认为需要的库，并把它们放到公共 API 中。我们有一个叫做 kXML 的东西，它是一个拉取解析器。我们有 org.json JSON 库。还有 ApacheHttp 客户端。我们基本上拥有这些库的 2006 年版本快照，它们后来加入了成千上万的特性，使它们变得过于庞大，无法适应 Android。它们的当前版本在许多重大方面不兼容。如果你在发布一个 Web 服务器，你可以控制你包含的版本；如果你做了不兼容的更改，客户端只需要做相应的修改。Android 的版本控制方式是，如果我们改变了一个 API，比如 JSON 库中的 API，即使新的 API 更好，应用也不能选择是否使用这个更改，所以必须确保 100% 向后兼容。因此，我们花了很长时间将这些 API 重新实现一遍，既要保证它们更好，又要保持现有的糟糕 API。”

“我们继承了所有的 Apache Harmony 代码，而 Apache Harmony 从来都不是一个真正发布的产品。它更多的是一个可以用来构建发布产品的清单。将一些半成品的东西做成正确的，花费了很多工作。”

“这其实是大量的重新实现和优化。标准库中的 org.json 代码，100% 是全新的。一天，Dan Morrill 找到我，说，‘嘿，提醒一下，我们正在使用的 JSON 库的开源库中有一个条款，‘软件应仅用于善良的目的，不得用于邪恶’^(7)。这意味着它不是开源的，因为开源没有针对任何目的的歧视。’所以我得去重新实现它。”
