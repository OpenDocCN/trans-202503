## 10

**汇编语言的关键要点**

![image](img/common.jpg)

本书的这一部分介绍了汇编语言的基础。尽管今天大多数人使用高级编程语言编程，但了解汇编语言可以增强程序员更好地理解他们的程序和编译器的能力。对于任何为嵌入式系统和其他资源受限环境设计软件的人，以及从事漏洞分析的人员，掌握汇编语言也是至关重要的。本书中关于汇编部分的章节涵盖了 64 位 Intel 汇编（x86-64）、32 位 Intel 汇编（IA32）和 64 位 ARM 汇编（ARMv8-A）。

### 10.1 共同特征

无论学习哪种具体的汇编语言，都有一些值得强调的*所有*汇编语言的共同特征。

**ISA 定义了汇编语言。** 机器上可用的具体汇编语言由该机器的*指令集架构*（ISA）定义。要识别特定 Linux 机器的底层架构，可以使用`uname -p`命令。

**寄存器存储数据。** 每个 ISA 都定义了一组基础的*寄存器*，CPU 用这些寄存器来处理数据。有些寄存器是*通用的*，可以存储任何类型的数据，而另一些寄存器则是*专用的*，通常由编译器为特定用途保留（例如栈指针、基址指针）。虽然通用寄存器是可读写的，但一些专用寄存器是只读的（例如指令指针）。

**指令指定了 CPU 能够执行的操作。** ISA（指令集架构）还定义了一系列*指令*，指定了 CPU 能够执行的操作。每条指令都有一个*操作码*（opcode），指明该指令的功能，并且有一个或多个*操作数*，指定要使用的数据。ISA 文档详细说明了数据传输、算术运算、条件判断、分支操作以及内存访问等特定指令。这些核心指令通常会组合起来表示更复杂的数据结构，如数组、结构体和矩阵。

**程序栈保存了与特定函数相关的局部变量。** 编译器使用进程虚拟地址空间的栈（或栈内存）来存储临时数据。在所有现代系统中，程序栈朝着*较低*的内存地址增长。编译器使用栈指针和基址指针来指定一个*栈帧*，该栈帧定义了与特定函数或过程相关的栈区域。每次函数调用时，都会将新的栈帧添加到栈中，定义与被调用函数相关的栈区域。当函数返回时，特定函数相关的栈帧会从栈中移除。通常，当函数结束时，栈指针和基址指针会恢复到它们的原始值。虽然这段书面记录表明局部变量会从栈中“清除”，但旧数据通常以垃圾值的形式保留，这有时会导致难以调试的行为。恶意攻击者也可以利用 ISA 栈管理的知识，制造像缓冲区溢出这样的危险安全漏洞。

**安全性。** 所有系统都容易受到像缓冲区溢出这样的安全漏洞的影响；然而，相对较新的 ARMv8-A 有机会从影响旧版 Intel 架构的安全缺陷中吸取教训。尽管如此，第一道防线始终是程序员。即使有额外的保护措施，没有任何 ISA 能够避免潜在的安全缺陷。在 C 语言编程时，程序员应该尽可能使用*长度说明符*，以减少由于边界溢出导致的安全漏洞的机会（参见表 10-1）。

**表 10-1：** 带有长度说明符的 C 函数

| **替代** | **使用** |
| --- | --- |
| `gets(buf)` | `fgets(buf, 12, stdin)` |
| `scanf("%s", buf)` | `scanf("%12s", buf)` |
| `strcpy(buf2, buf)` | `strncpy(buf2, buf, 12)` |
| `strcat(buf2, buf)` | `strncat(buf2, buf, 12)` |
| `sprintf(buf, "%d")` | `snprintf(buf, 12, "%d", num)` |

### 10.2 进一步阅读

本书仅提供了当前使用的一些最流行汇编语言的初步介绍。如果你想更深入地了解汇编语言，我们鼓励你查阅 ISA 规格：

+   Intel 64 和 IA32 手册， *[`software.intel.com/en-us/articles/intel-sdm#architecture`](https://software.intel.com/en-us/articles/intel-sdm#architecture)*

+   ARM Cortex-A 编程指南， *[`developer.arm.com/docs/den0024/a/preface`](https://developer.arm.com/docs/den0024/a/preface)*

以下免费的资源对于有兴趣学习 32 位汇编的人可能也会很有帮助：

+   IA32 编程网络附录，Randal Bryant 和 David O’Hallaron， *[`csapp.cs.cmu.edu/3e/waside/waside-ia32.pdf`](http://csapp.cs.cmu.edu/3e/waside/waside-ia32.pdf)*

+   32 位 ARM 汇编，Azeria Labs， *[`azeria-labs.com/writing-arm-assembly-part-1/`](https://azeria-labs.com/writing-arm-assembly-part-1/)*

以下书籍也包含了关于汇编语言的深入讨论；它们不是免费的，但它们是进一步阅读的宝贵资源：

+   英特尔系统：Randal Bryant 和 David O'Hallaron, *计算机系统：程序员的视角*, Pearson, 2015 年。

+   ARMv8: David Patterson 和 John Hennessy, *计算机组织与设计：ARM 版*, Morgan Kaufmann, 2016 年。
