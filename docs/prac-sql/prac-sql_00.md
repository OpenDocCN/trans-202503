# 前言

![](img/chapterart.png)

在加入*《今日美国》*的员工队伍后不久，我收到了一个数据集，接下来将近十年间我几乎每周都会分析这个数据集。它是每周的畅销书榜单，依据保密的销售数据对全国最畅销的书籍进行排名。这个榜单不仅为我提供了源源不断的故事创意，还以独特的方式捕捉了美国的时代精神。

你知道吗，烹饪书在母亲节那周的销量会略微增加，或者说，奥普拉·温弗瑞通过邀请许多默默无闻的作家上她的节目，把他们变成了畅销书作者？每周，我和书单编辑都会仔细研究销售数据和图书类别，对数据进行排序，寻找新的头条新闻。我们很少空手而归：我们记录了从《哈利·波特》系列的飞速崛起，到苏斯博士的《哦，你会去的地方！》成为毕业生常年送礼的经典之作。

那段时间，我的技术伙伴是数据库编程语言*SQL*（结构化查询语言）。一开始，我说服了*《今日美国》*的 IT 部门，允许我访问驱动我们书单应用的基于 SQL 的数据库系统。通过使用 SQL，我能够发掘数据库中隐藏的故事，这些数据包含了与书名、作者、类别以及定义出版界的代码相关的销售信息。

SQL 自那时以来一直对我有帮助，无论我担任的是产品开发、内容策略，还是最近作为*《华尔街日报》*的数据编辑。在每种情况下，SQL 都帮助我在数据中找到有趣的故事——而这正是你通过本书所能学到的内容。

## 什么是 SQL？

SQL 是一种广泛使用的编程语言，用于管理数据和数据库系统。无论你是市场分析师、记者，还是正在研究果蝇大脑神经元的科研人员，使用 SQL 来收集、修改、探索和总结数据都会带来好处。

由于 SQL 是一种已经存在了数十年的成熟语言，它已深深植根于许多现代系统中。IBM 的两位研究人员首次在 1974 年的论文中概述了 SQL（当时称为 SEQUEL）的语法，并在英国计算机科学家埃德加·F·科德的理论工作基础上发展了这一语言。1979 年，数据库公司甲骨文（当时名为关系软件）的前身成为首个将该语言应用于商业产品的公司。如今，SQL 仍然是世界上使用最广泛的计算机语言之一，而且这一局面不太可能很快改变。

每个数据库系统，如 PostgreSQL、MySQL 或 Microsoft SQL Server，都实现了自己版本的 SQL，因此如果你从一个系统跳到另一个系统，你会注意到语法上的细微差异——有时甚至是显著的差异。这背后有几个原因。美国国家标准协会（ANSI）在 1986 年采纳了 SQL 标准，国际标准化组织（ISO）在 1987 年随后也采纳了该标准。但是，标准并没有涵盖数据库实现所需的 SQL 的所有方面——例如，它没有涉及创建索引的条目。这就使得每个数据库系统制造商可以选择如何实现标准未涵盖的功能——目前没有任何数据库制造商声称完全符合该标准。

同时，商业考虑也可能促使商业数据库供应商创建非标准 SQL 特性，既为了竞争优势，也为了将用户留在自己的生态系统中。例如，微软的 SQL Server 使用专有的 Transact-SQL（T-SQL），其中包括许多不在 SQL 标准中的功能，例如用于声明局部变量的语法。因此，将使用 T-SQL 编写的代码迁移到另一个数据库系统可能并非易事。

本书中的示例和代码使用 PostgreSQL 数据库系统。PostgreSQL，简称 Postgres，是一款强大的应用程序，可以处理大量数据。以下是 PostgreSQL 成为本书推荐使用数据库系统的原因：

+   它是免费的。

+   它适用于 Windows、macOS 和 Linux 操作系统。

+   它的 SQL 实现旨在紧密遵循 SQL 标准。

+   它被广泛使用，因此在网上很容易找到帮助。

+   它的地理空间扩展 PostGIS 让你能够分析几何数据并执行映射功能，通常与 QGIS 等地图软件一起使用。

+   它可用于像 Amazon Web Services 和 Google Cloud 这样的云计算环境。

+   它是网页应用程序中常见的数据存储选择，包括那些由流行的网页框架 Django 提供支持的应用程序。

好消息是，PostgreSQL 的基本概念和大多数核心 SQL 语法约定在不同的数据库间都能通用。所以，如果你在工作中使用 MySQL，你可以运用你在这里学到的很多内容——或者轻松找到相似的代码概念。当语法是 PostgreSQL 特有时，我会特别指出。如果你需要学习具有偏离标准特性的系统的 SQL 语法，例如 Microsoft SQL Server 的 T-SQL，你可能需要进一步探索专注于该系统的资源。

## 为什么选择 SQL？

SQL 当然不是处理数据的唯一选择。许多人从 Microsoft Excel 表格和其中的各种分析功能开始。在使用 Excel 后，他们可能会转向 Access，这是微软 Office 某些版本中内置的数据库系统，它具有图形化查询界面，便于完成工作。那么，为什么要学习 SQL 呢？

一个原因是 Excel 和 Access 有它们的限制。Excel 当前每个工作表的最大行数为 1,048,576 行。Access 将数据库大小限制为两 GB，并且每个表格的列数限制为 255 列。数据集超出这些限制并不罕见。在面临最后期限时，你最不希望发现的问题就是你的数据库系统没有足够的容量来完成任务。

使用强大的 SQL 数据库系统，你可以处理 TB 级别的数据、多个相关表格以及成千上万的列。它让你对数据结构拥有精细的控制，从而提高效率、速度和——最重要的——准确性。

SQL 也是数据科学中编程语言的极好补充，例如 R 和 Python。如果你使用其中任何一种语言，你可以连接到 SQL 数据库，在某些情况下，甚至可以将 SQL 语法直接嵌入到编程语言中。对于没有编程语言背景的人来说，SQL 通常是一个容易理解的引导，帮助你了解与数据结构和编程逻辑相关的概念。

最后，SQL 不仅仅用于数据分析。如果你深入开发在线应用程序，你会发现数据库为许多常见的网页框架、交互式地图和内容管理系统提供了后台支持。当你需要深入了解这些应用程序的底层结构时，掌握 SQL 来管理数据和数据库将非常有用。

## 这本书适合谁？

*实用 SQL*是为那些在日常生活中接触数据，并希望学习如何分析、管理和转换数据的人而写的。考虑到这一点，我们涵盖了真实世界中的数据和场景，如美国人口普查数据、犯罪报告和纽约市的出租车数据。我们的目标不仅是理解 SQL 的工作原理，还要了解如何使用它来发现有价值的见解。

本书是为初学编程的人写的，因此早期章节涵盖了数据库、数据和 SQL 语法的关键基础。对于一些有 SQL 经验的读者来说，后面的章节会涉及更高级的主题，如地理信息系统（GIS）。我假设你对计算机操作比较熟悉，包括如何安装程序、浏览硬盘以及从互联网上下载文件，但我不假设你有编程或数据分析的经验。

## 你将学到什么

*实用 SQL*从设置系统和获取代码及数据示例的章节开始，然后讲解数据库、查询、表格和 SQL 在多个数据库系统中常见的数据基础知识。第 14 至 19 章涵盖了更具体的 PostgreSQL 主题，例如全文搜索、函数和 GIS。尽管本书中的许多章节可以独立阅读，但你应该按顺序阅读整本书，以便逐步掌握基础知识。早期章节中呈现的数据集通常会在后面再次出现，因此按顺序阅读本书有助于你保持进度。

以下总结提供了每一章的更多细节：

**第一章：设置你的编码环境**介绍了如何设置 PostgreSQL、pgAdmin 用户界面和文本编辑器，并且教你如何下载示例代码和数据。

**第二章：创建你的第一个数据库和表格**提供了将有关教师的简单数据集加载到新数据库中的逐步说明。

**第三章：使用 SELECT 进行数据探索**探索了基本的 SQL 查询语法，包括如何对数据进行排序和筛选。

**第四章：理解数据类型**解释了设置表格列以保存特定类型数据的定义，从文本到日期，再到各种形式的数字。

**第五章：导入和导出数据**解释了如何使用 SQL 命令从外部文件加载数据并将其导出。你将加载一份美国人口普查数据表，并在整本书中使用它。

**第六章：使用 SQL 进行基础数学和统计**涵盖了算术运算，并介绍了用于查找总和、平均值和中位数的聚合函数。

**第七章：在关系数据库中连接表格**解释了如何通过在关键列上连接多个相关表格来进行查询。你将学习如何以及何时使用不同类型的连接。

**第八章：适合你的表格设计**讲解了如何设置表格，以改善数据的组织性和完整性，同时也教你如何使用索引来加速查询。

**第九章：通过分组和汇总提取信息**解释了如何使用聚合函数来找出基于年度调查的美国图书馆使用趋势。

**第十章：检查和修改数据**通过使用关于肉类、蛋类和家禽生产商的记录示例，探索如何查找并修复不完整或不准确的数据。

**第十一章：SQL 中的统计函数**介绍了相关性、回归、排名等函数，帮助你从数据集中提取更多有意义的信息。

**第十二章：处理日期和时间**解释了如何在数据库中创建、操作和查询日期和时间，包括如何处理时区以及有关纽约市出租车行程和美铁火车时刻表的数据。

**第十三章：高级查询技巧**讲解了如何使用更复杂的 SQL 操作，如子查询、交叉表以及`CASE`语句，来重新分类温度读数数据集中的值。

**第十四章：挖掘文本以发现有意义的数据**讲解了如何使用 PostgreSQL 的全文搜索引擎和正则表达式从非结构化文本中提取数据，示例包括警察报告和美国总统演讲集。

**第十五章：使用 PostGIS 分析空间数据**介绍了与空间对象相关的数据类型和查询，这将帮助你分析地理特征，如县、市、道路和河流。

**第十六章：使用 JSON 数据**介绍了 JavaScript 对象表示法（JSON）数据格式，并通过关于电影和地震的数据探索 PostgreSQL 的 JSON 支持。

**第十七章：通过视图、函数和触发器节省时间**解释了如何自动化数据库任务，从而避免重复的日常工作。

**第十八章：从命令行使用 PostgreSQL**讲解了如何在计算机的命令提示符下使用文本命令连接到数据库并执行查询。

**第十九章：维护你的数据库**提供了跟踪数据库大小、自定义设置和备份数据的技巧和程序。

**第二十章：讲述你数据的故事**提供了生成分析思路、审查数据、得出合理结论并清晰呈现结果的指南。

**附录：PostgreSQL 的其他资源**列出了帮助你提高技能的软件和文档。

每一章最后都有一个“自己动手试一试”部分，其中包含练习，帮助你巩固所学的内容。

准备好了吗？让我们从第一章“设置你的编码环境”开始。
