## 前言

![图片](img/common.jpg)

我们在发布了一系列关于 rootkit 和 bootkit 的文章和博客后，意识到这个话题并没有得到它应有的关注，于是产生了写这本书的想法。我们觉得有更大的图景，我们希望能有一本书来尝试

让一切有意义——一本能够概括攻击者和防御者创新中使用的各种巧妙技巧、操作系统架构观察和设计模式的书。我们曾经寻找过这样的书，但未能找到，因此我们决定写一本自己想读的书。

这本书花费了我们四年半的时间，比我们计划的时间还要长，遗憾的是，这个时间远远超过了我们能够预期的，早期访问版的读者和支持者能够坚持的时间。如果你是这些早期访问支持者之一，并且仍在阅读这本书，我们深感荣幸，感谢你们的持续支持！

在这段时间里，我们观察到了攻防的共同进化。特别是，我们看到微软 Windows 的防御措施封死了 rootkit 和 bootkit 设计的几个主要分支。你将在本书的章节中找到这个故事。

我们还观察到了新型恶意软件的出现，这些恶意软件针对 BIOS 和芯片组固件，超出了当前 Windows 防御软件的防护范围。我们将解释这一共同进化的发展过程，并展望其未来的进展。

本书的另一个主题是针对操作系统启动过程早期阶段的逆向工程技术发展。传统上，越靠近 PC 启动过程的前期阶段，相关代码的可观察性就越差。这种不可观察性长期以来与安全性混淆在一起。然而，当我们深入研究影响低级操作系统技术（如安全启动）的引导木马和 BIOS 植入的取证时，我们发现“安全通过模糊化”的方式在这里的效果和其他计算机科学领域一样差。经过一段时间（在互联网时间尺度上，这段时间只会越来越短），模糊化安全的做法最终更多地有利于攻击者而非防御者。这个观点在其他关于该主题的书籍中没有得到充分覆盖，因此我们尝试填补这个空白。

### 为什么要读这本书？

我们的读者群体非常广泛，主要是对高级持久性恶意软件威胁绕过操作系统级安全感兴趣的信息安全研究人员。我们关注这些高级威胁如何被观察、逆向工程和有效分析。本书的每一部分都反映了高级威胁进化的不同阶段，从它们作为狭义概念验证的出现，到它们在威胁行为者中传播，最后进入更加隐秘的定向攻击武器库。

然而，我们的目标是让更广泛的读者群体受益，而不仅仅是 PC 恶意软件分析师。特别是我们希望嵌入式系统开发人员和云安全专家也能从本书中获得同样的帮助，因为 rootkit 和其他植入物的威胁在他们的生态系统中依然存在。

### 书中内容是什么？

我们从 第一部分 开始，探索 rootkit，在这一部分中，我们介绍了历史上曾作为 rootkit 游乐场的 Windows 内核。然后在 第二部分，我们将焦点转向操作系统的启动过程以及在 Windows 开始强化其内核模式后发展起来的 bootkit。我们从攻击者的角度剖析了启动过程的各个阶段，特别关注新的 UEFI 固件方案及其漏洞。最后，在 第三部分，我们聚焦于经典操作系统 rootkit 攻击和针对 BIOS 及固件的新版 bootkit 攻击的取证分析。

#### *第一部分：Rootkits*

本部分聚焦于经典的操作系统级 rootkit，在它们的鼎盛时期。这些历史性的 rootkit 示例提供了宝贵的见解，展示了攻击者如何看待操作系统的内部结构，并利用操作系统自身的结构，找到可靠地将其植入其中的方法。

**第一章：Rootkit 的组成：TDL3 案例分析** 我们通过讲述一个当时最有趣的 rootkit 的故事来开始探索 rootkit 的工作原理，这个故事基于我们与其多种变种的遭遇以及我们对这些威胁的分析。

**第二章：Festi Rootkit：最先进的垃圾邮件和 DDoS 僵尸网络** 在这里，我们分析了卓越的 Festi rootkit，它使用了当时最先进的隐匿技术来进行垃圾邮件和 DDoS 攻击。这些技术包括带着自己的定制内核级 TCP/IP 堆栈。

**第三章：观察 Rootkit 感染** 本章带领我们进入操作系统内核的深处，突出了攻击者为争夺内核更深层次控制而使用的技巧，比如拦截系统事件和调用。

#### *第二部分：Bootkits*

第二部分将焦点转向 bootkit 的演变，推动这种演变的条件，以及逆向工程这些威胁的技术。我们将看到 bootkit 如何发展，植入 BIOS 并利用 UEFI 固件漏洞。

**第四章：Bootkit 的演变** 本章深入探讨了促成 bootkit 出现的共同演变力量，并指导其发展。我们将研究一些最早发现的 bootkit，例如臭名昭著的 Elk Cloner。

**第五章：操作系统启动过程要点** 本章我们将介绍 Windows 启动过程的内部机制以及这些机制如何随着时间的推移发生变化。我们将深入探讨如主引导记录（MBR）、分区表、配置数据以及*bootmgr*模块等具体内容。

**第六章：启动过程安全** 本章将带您了解 Windows 启动过程的防御技术，如早期启动反恶意软件（ELAM）模块、内核模式代码签名策略及其漏洞，以及更新的基于虚拟化的安全技术。

**第七章：启动工具感染技术** 本章中，我们剖析了感染启动扇区的方法，并探讨这些方法如何随着时间的推移不断进化。我们将以一些熟悉的启动工具为例：TDL4、Gapz 和 Rovnix。

**第八章：使用 IDA Pro 对启动工具进行静态分析** 本章介绍了启动工具感染的静态分析方法和工具。我们将以 TDL4 启动工具为例，带您进行分析，并提供可供您自己分析使用的材料，包括可下载的磁盘镜像。

**第九章：启动工具动态分析：仿真与虚拟化** 本章我们将重点介绍动态分析方法，使用 Bochs 仿真器和 VMware 内置的 GDB 调试器。我们将带您通过步骤动态分析 MBR 和 VBR 启动工具。

**第十章：MBR 和 VBR 感染技术的演变：Olmasco** 本章追溯了用于将启动工具带入启动过程更低层次的隐身技术的演变。我们将以 Olmasco 为例，分析其感染和持久性技术、恶意软件功能以及有效载荷注入。

**第十一章：IPL 启动工具：Rovnix 和 Carberp** 本章我们将深入探讨两个最复杂的启动工具——Rovnix 和 Carberp，它们针对电子银行业务。这些是首批针对 IPL 并避开当时防御软件的启动工具。我们将使用 VMware 和 IDA Pro 进行分析。

**第十二章：Gapz：高级 VBR 感染** 我们将揭开启动工具隐身演化的巅峰：神秘的 Gapz 根工具，它使用了当时最先进的技术，针对 VBR 进行攻击。

**第十三章：MBR 勒索病毒的崛起** 本章我们将探讨启动工具如何在勒索病毒威胁中复苏。

**第十四章：UEFI 启动与 MBR/VBR 启动过程的对比** 本章探讨了 UEFI BIOS 设计的启动过程——这是发现最新恶意软件演化的关键信息。

**第十五章: 现代 UEFI 引导工具** 本章涵盖了我们对各种 BIOS 植入物的原创研究，包括概念验证和在实际环境中部署的版本。我们将讨论如何感染和在 UEFI BIOS 上保持持久性，并查看在实际环境中发现的 UEFI 恶意软件，例如 Computrace。

**第十六章: UEFI 固件漏洞** 本章深入探讨了现代 BIOS 漏洞的不同类别，这些漏洞允许引入 BIOS 植入物。这是对 UEFI 漏洞和漏洞利用的深入探讨，包括案例研究。

#### *第三部分：防御与取证技术*

本书的最后部分将讨论引导工具、根工具及其他 BIOS 威胁的取证。

**第十七章: UEFI 安全引导的工作原理** 本章深入探讨了安全引导技术及其发展、漏洞和有效性。

**第十八章: 分析隐藏文件系统的方法** 本章概述了恶意软件使用的隐藏文件系统及其检测方法。我们将解析一个隐藏文件系统镜像，并介绍我们设计的工具：HiddenFsReader。

**第十九章: BIOS/UEFI 取证：固件获取与分析方法** 本章讨论了检测最先进的威胁的方法。我们将探讨硬件、固件和软件方法，并使用各种开源工具，如 UEFITool 和 Chipsec。

### 如何阅读本书

本书中讨论的所有威胁样本以及其他支持材料可以在本书的网站上找到，* [`nostarch.com/rootkits/`](https://nostarch.com/rootkits/)*。该网站还提供了用于引导工具分析的工具链接，例如我们在原创研究中使用的 IDA Pro 插件的源代码。
