# 第十三章 跟随 WEBrick 路

# Ruby 和互联网

国王和王后从炼造厂的出口冲出来，走进明亮的傍晚阳光中，鲁本和斯卡雷特紧随其后。在他们前方，WEBrick 路延展得很远，深红色的砖块在阳光下微微发光。在远处，他们可以看见四个神秘的坏蛋形影不离地撤退，再远一点，是标志着王国边界的高墙。

“他们太快了！”鲁本喘着气，手扶在膝盖上。“我们永远也追不上他们！”

“永远不要说不可能，”拉斯提边说边跑到他们身后。“我们*一定*可以做点什么。”

王后转向他。“有没有办法关闭 WEBrick 路？”她问。

![image with no caption](img/httpatomoreillycomsourcenostarchimages2160075.png.jpg)

拉斯提想了想。“我不太确定，”他说，“但我有个主意。”他翻开了工作簿的所有页面，拿出一块带有熟悉屏幕的薄金属片。“这是我的便携计算装置，”他说。“我和我的工人们会继续前进，尽力抓住这些坏蛋。与此同时，如果你们能做点什么来关闭这条路，防止他们逃跑的话，可以用这个小计算机。”

“对！”斯卡雷特说道，接过工头的手持计算机。拉斯提向她眨了眨眼，然后示意炼造厂的男女工人迅速从出口涌出。“这边，大家！我们要尽力阻止这些坏蛋！快，快，快！”

当炼造厂的工人们跑下深红色的道路时，国王、王后、斯卡雷特和鲁本围在工头的便携计算装置旁。

“好，首先要做的是什么？”斯卡雷特说道。“我们怎么才能关闭这条路？”

国王拉了拉他蓬松的白胡子。“在我看来，”他说，“我们应该先检查一下这条路是否正常工作！如果它因为某些原因已经关闭，我们可以和拉斯提的队伍会合，去抓住这些坏蛋。”

斯卡雷特和鲁本互相看了一眼。“那是……其实是个好主意，”鲁本说道。“我们怎么测试这条路是否通畅？”

“嗯，”国王说道，“WEBrick 路就像王国中的一切一样，依赖 Ruby 运行，它是王国与外界之间的主要连接。如果我们能用 Ruby 检查是否能够从王国外部获取信息，那我们就能知道这条路是否正常工作。”

“就是这个！”鲁本说道。“如果我们能用 Ruby 连接互联网，那我们就知道这条路是通畅的！”

“但我们怎么做呢？”斯卡雷特说道。“我觉得我现在对 Ruby 已经挺熟悉了，可是我根本不知道从哪里开始连接互联网。”

“我想我知道怎么做了，”王后说道。“你看，连接到互联网就像是连接到一个文件——你只需要告诉 Ruby 该怎么做就行！可以吗？”她问。斯卡雷特点点头，将便携式计算装置递给了王后。王后开始打字。

“记得我们如何将代码写在不同的 Ruby 文件中，然后用`require`将一个脚本的代码引入到另一个文件吗？”女王问。Scarlet 和 Ruben 点了点头。“嗯，”女王继续说，“其实 Ruby 自带了一些小文件包，我们也可以用`require`来加载！”

“真的有？”国王问，难以置信。“当然！”女王说。“你可以把这些文件包看作是我们可以在自己项目中使用的代码小库，它们被称为*gems*。”

“没错！我好像听说过 Ruby gems，”Ruben 说。“有没有用于连接互联网的 gem？”

# 使用 open-uri Ruby Gem

女王点点头。“`open-uri` gem，”她说，“它让你的 Ruby 代码能够像打开文件一样打开互联网网站！一旦我们在 IRB 会话中`require`了它，我们就能做很多很棒的事情。”她在计算装置上输入：

```

>> require 'open-uri'
=> true

```

她把小机器递给了 Scarlet。“已经加载好，准备就绪！”她说。

Scarlet 看着屏幕。“难道我不需要`'./open-uri'`，而不是仅仅`'open-uri'`？”她问。

“Gem 不需要！”女王说。“这是你自己创建的文件才需要，但如果你`require`一个 gem，你只需要像字符串一样输入它的名称。Ruby 为你做的一件事就是追踪 gem 在你电脑上的安装位置。既然它已经知道去哪里找 gem，你就不需要用`./`去查找当前目录了。只需要输入 gem 的名字，Ruby 就会做剩下的事。”

“完美！”Scarlet 说。“现在我们只需要一个网站来测试 WEBrick 通道是否正常工作。”

“啊哈！”国王说，举起了一根手指。“我们可以用我最喜欢的网站来测试它！”

“那是什么？”Scarlet 问，准备在键盘上敲字。

“*Example.com*！”国王说，满脸笑容。女王翻了个白眼。

“这也不赖，”Scarlet 承认，并开始在那个小小的计算装置上输入。

### 注意

*为了让这段代码正常工作，你需要连接到互联网！如果需要帮助连接互联网，可以找个成年人帮忙。*

```

>> site = open('http://www.example.com')
=> #<StringIO:0x000001032de2f0>

```

“首先，”Scarlet 说，“我们用`open`方法告诉 Ruby 根据我们输入的 URL 网站来创建一个对象。然后，我们就可以像操作普通文本文件那样使用`.read`方法，这样就能获得* [www.example.com](http://www.example.com) *网站的内容！”

```

>> site.read
=> "<!doctype html>...

```

屏幕很快显示出了来自*example.com*网站的代码。

“它能用了！”Scarlet 说。“WEBrick 通道必须打开。现在我们只需要找到方法来关闭它！”

Ruben 想了想。“嘿，等一下，”他说，“王国是通过 WEBrick 通道来请求*并*发送信息的吗？”

“确实能行，”国王说。

“那是不是意味着有某种*Web 服务器*在运行？”Ruben 问。

女王打了个响指。“鲁本，你真是个天才！”她说道。鲁本微微脸红。女王转向斯嘉丽。“不仅有一个网页服务器在运行，而且它是一个*WEBrick 网页服务器*。”她开始快速讲解并兴奋地做着手势。“WEBrick 服务器是 Ruby 的一段特殊代码，用来将信息从王国发送出去。你看，当你访问一个网站时，你实际上是在向一个网页服务器——也就是某个在互联网上的计算机——请求信息。好吧，当互联网上的人们想要了解我们的王国时，我们自己的 WEBrick 网页服务器就会发送出去！”

### 注释

*WEBrick 服务器不仅仅存在于王国里——这就是你在自己计算机上使用的 Ruby 网页服务器的真正名称！*

“如果那个网页服务器被关闭……”鲁本开始说道。“……那么王国里的任何东西都无法外出！”斯嘉丽补充道。

“现在我们只需要搞清楚如何找到服务器来关闭它，”鲁本说道。

“嗯，”国王踢了踢一块灰尘，“其实我可能能帮上忙。你看，我丢东西太频繁了，已经非常熟悉计算机装置的搜索功能了。”

“太完美了！”斯嘉丽说道。“我们认为那个文件应该叫什么？”

# 调查王国的网页服务器

“嗯，你可能想搜索一下*WEBrick*或者*server*，”国王说道。“无论如何，我会这么做。”

斯嘉丽点点头，按了几个键，开始搜索文件。她眯起眼睛，摇了摇头，打了几个字，叹了口气，思考了下，又继续打字。

“我想我明白了！”她终于说道。“我找到一个叫*server.rb*的文件。”

“打开它，打开它！”鲁本站在脚尖上，努力更清楚地看到屏幕。

斯嘉丽打开了*server.rb*文件，这就是他们看到的内容：

```

require 'webrick'
include WEBrick

server = HTTPServer.new(
  :Port => 3000,
  :DocumentRoot => Dir.pwd
)
trap('INT') { server.shutdown }

server.start

```

“让我们看看，”斯嘉丽说道。“看起来前两行`require`了`webrick` gem，并引入了`WEBrick`模块。”

“这看起来对我来说没问题，”鲁本说道。“那么接下来的几行代码似乎创建了一个新的 WEBrick 服务器。我不确定`port`是做什么的，但它被设置为数字`3000`。`Dir.pwd`那部分是什么意思？”

“我想我明白了，”女王说道。“就像 Ruby 使用`File`类来处理文件的方法一样，它使用`Dir`类来处理*目录*的方法，目录其实就是*文件夹*的意思。”女王指着屏幕说道。“`pwd`方法返回*当前工作目录*，所以`Dir.pwd`其实就是 Ruby 表示‘就在这个文件夹’的方式。网页服务器正在运行，并且正在从这个文件夹中发送信息！”

“好的！”斯嘉丽说道。“我们只需要关掉它，我觉得我找到了线索。那行`trap('INT') { server.shutdown }`——那是做什么的？”

女王研究了屏幕一会儿。“如果我没记错的话，那是 Ruby 的方式来表示当它收到一个*中断信号*时，它将关闭服务器！”

“中断信号？”鲁本问道。“那是不是意味着我们必须告诉服务器停止运行？”

“没错，”女王说道。“但是，怎么做呢？”

“同时按住 CTRL 键和 C 键！”国王突然说道。所有人都转过头看向他。“就这么做！”他催促道，挥舞着双手。“我们不能浪费一秒钟！”斯嘉丽点点头，立即按下了键盘，接着她看到的情景是：

```

INFO going to shutdown ...
INFO WEBrick::HTTPServer#start done.

```

“我们成功了！我们成功了！”斯嘉丽和鲁本跳了起来，互相拥抱。

王后转向国王，微笑着问：“你怎么知道怎么做的？”她问道。

国王尴尬地笑了笑。“嗯，我经常弄坏我的计算机设备，所以我学会了使用 CTRL-C 来停止程序！”大家都笑了起来。

“现在服务器已经关闭，”斯嘉丽说，“没有任何人和物能够离开这个王国！快，我们得赶紧跑到 WEBrick 通道去看看，看看我们是不是及时阻止了那些坏人！”

他们四个人匆匆沿着鲜红的道路跑去，心里希望自己及时关闭了 WEBrick 通道。从远处看，他们看到一大群 Refactory 工人在四处走动。随着他们靠近，他们开始辨认出个别工人，再到人脸。不久，他们已经接近到足以看清楚，看到 Rusty 正疯狂地挥手示意他们过来，而就在他旁边，四个戴着兜帽的恶棍正站在人群中央！

“太棒了！美味的早餐肉汁！辉煌的玉米松饼！我们抓住他们了！”国王几乎激动得泪流满面。

当他们跑到人群前面时，工头转向他们，满脸笑容。“陛下！殿下！”他依次向国王和王后致意。“我不知道你们是怎么做到的，但你们关停了 WEBrick 通道，给我们足够的时间抓住了这些恶棍！他们当时正试图拉扯王国墙上的大门，想要逃走，结果我们把他们困在了这里。”他交叉双臂，笑了笑，浓密的胡须在脸上微微晃动。“我很高兴正式把他们交给你们。”

“谢谢你，Rusty，”王后说道。国王和王后走到人群中央，两个 Refactory 工人各自抓住四个神秘人物中的一个。鲁本和斯嘉丽紧随其后。

“你们这些混蛋在我们的王国里制造了彻底的混乱！”国王说道。

“而且它们剥夺了王国所有市民的紫色熊猫游行，”王后皱着眉头说道。

“是的，正是如此，”国王说道。“而且我们受够了！现在是你们揭开你们*真实*身份的时候了。”国王向 Refactory 工人们点了点头。每个工人都把手放在每个恶作剧者的兜帽两侧。

“按照我的数点。一...二...二又半...*三*！”国王喊道，工人们一把拉开了恶棍的兜帽。人群惊呼一声。站在他们面前，吐着舌头，发出嘶嘶声的，是四条巨大的蛇！

![没有说明的图片](img/httpatomoreillycomsourcenostarchimages2160077.png.jpg)

“真是字面意义上的蛇！”Rusty 说道。“怎么样？”

“实际上是 Pythonssss，”那条离 Rusty 最近的蛇嘶嘶地说道。

“甜美的嗨比尔迪-吉比尔迪！一条会说话的蛇！”国王说，躲在一名特别强壮的 Refactory 工人后面。

“‘名字是 Terry，’”那条蛇说道。“‘实际上是 Terry One。’”她用头指了指旁边的蛇。“‘那是 John，’”她说道。“‘然后是 Terry Two，再是 Graham。’”

“‘很高兴见到你，’”约翰说道。

“‘嗯，我们当然不高兴见到*你们*，’”国王恢复了勇气说道。“‘你们到底在*做什么*，制造这么大的麻烦？’”他开始用手指算。“‘偷走我的字符串！堵塞神秘管道！搞乱循环！摧毁哈希计算装置！黑入女王的机器！剥夺熊猫的紫色！这份清单一长串！’”

Graham 不安地环顾四周。“‘你的字符串？我们没偷你的字符串！’”他说道。

国王举起了双手。“好吧，算了，也许那是我做的，”他说，“但剩下的都是你们干的。我要求一个解释！”

Terry Two 低下了头；Ruben 和 Scarlet 分不清她是生气还是难过。“因为大家都只顾着 Ruby，Ruby，Ruby！”她说道。“没人愿意再使用 Python 了。”

“‘Python？’Ruben 问道。”

“‘你看到了吗？’”Terry Two 说道，朝 Ruben 点了点头。“这孩子连 Python 都没听说过！”

“‘它是什么？’Ruben 问道，向前探了探身子。”

Terry Two 叹了口气。“一种编程语言，非常像 Ruby，”她说道。

“‘但更好，’约翰插嘴说道。”

“‘哦，完全更好，’Terry One 插话道。”

“‘但王国里没人用它，’”Terry Two 继续说道。

“‘我们认为如果能让人觉得 Ruby 有什么问题，他们可能会转换过来，’”他说。

Scarlet 愤怒地走近了这些蛇。“你们应该展示 Python 有多好，而不是让人觉得 Ruby 有什么问题！”她斥责道。

约翰悲伤地摇了摇头。“没有人愿意听，”他说道，“所以我们认为最好的机会就是吸引注意，即使它必须是负面的。”没有人能确定，但看起来那条巨大的蛇眼里似乎含着泪水。

国王的表情稍微缓和了一些。“你们都知道 Python 吗？”他问道。

蛇们互相看了看，显然很困惑。它们缓慢地点了点头。

“‘告诉我一下，’”国王说道。

“‘它是一个非常棒的语言，’Graham 说道，‘它有字符串、数字和布尔值。’”

“‘数组，也有！’”Terry One 补充道。

“‘对象、方法和类，’约翰说道，‘你可以编写任何你喜欢的程序。’”

国王点了点头，绕着小圈走。“看起来，Ruby 和 Python 其实没有那么大区别，’”他说道。

蛇们沉默了一会儿。“或许……不是，”约翰终于说道，“但如果是那样，为什么不使用 Python 而不是 Ruby 呢？”

“‘我想我真正的问题是，’”国王说道，“‘为什么非得选择其中一个呢？为什么不写你更喜欢的那个呢？’”Terry One 张开嘴准备发言，但国王继续说道。“‘其实，如果我告诉你，可以写出*变成 Python 的 Ruby*，你们会怎么想？””

一时间寂静无声。Ruben、Scarlet 和女王互相交换了一些惊讶的目光。

“你看，”国王说道，“我一直不是个很好的程序员。编程对我来说从来都不容易。所以我花了很多时间练习，阅读文章和示例代码，试图变得更好。”他说着，从长袍里拿出了一卷小卷轴。“在我的研究过程中，我发现了一段非常神奇的代码，它能将 Ruby 代码转化为 Python 可以理解的指令。你可以写 Ruby，Python 程序就会出来！这不是很棒吗？”他激动地说道。“你可以用*任何语言*，*任何方式*，去编写代码，并且你仍然可以对计算机讲故事，让它做你想做的一切。这就是编程的魅力！”

蟒蛇们沉默了一会儿。最终，泰瑞·一开口了。“我……以前从没这么想过，”她说。

“我想我想说的是，”国王说道，“在这个王国里，所有的好奇心，所有的诚挚学习欲望，所有的分享和教学，*永远*是受欢迎的。是的，我们确实用 Ruby 来处理我们的日常事务。是的，这是我们许多公民所知道、喜欢，甚至*思考*的语言。但这并不意味着它是唯一的方式，也绝不意味着我们认为从 Python 中学不到任何东西！”

拉斯蒂把手捧在嘴边。“好极了！”他说，全场爆发出掌声。

“你们怎么说？”国王温和地问，走向四条蟒蛇。“你们愿意帮我们了解一些 Python 吗？我们可以教你们一些 Ruby。”

蟒蛇们互相交换了眼神，然后开始点头。

“我们真的非常抱歉，”格雷厄姆说。“我们只是感到伤心和沮丧，不知道该如何表达我们的感受。”

“我们希望没弄坏什么东西，”泰瑞·二说道。

“我们会帮忙修复任何我们弄坏的东西，”泰瑞·一补充道。

“我尝过汉克的哈希，”约翰说。“那是我吃过的最棒的食物。如果我能再去那里吃一顿，我愿意修复一百个 Ruby 程序！”

“那就这么决定了！”国王说道。他看向王后，王后微笑着点了点头。他又把目光转向四条蟒蛇。“凭借我作为这个王国众多公民赋予我的权力，现正式赦免你们所有的过错！”他稍微向前倾了倾身。“如果你们想回宫殿来点蛋糕和茶水，那也可以。”

蟒蛇们兴奋地点点头，欣喜若狂。“那太棒了，”泰瑞·一说道。“非常感谢！”

国王举起双臂。“大家回到皇家宫殿！”他大喊。“大家都有蛋糕和茶！”

人群中爆发出一阵巨大的欢呼声。那些一直控制着蟒蛇的重生厂工人将它们放开，大家将国王、王后、斯嘉丽和鲁本抬到肩膀上。

“你真是救了大忙，陛下！”斯嘉丽对国王说道。他挥了挥手，示意不必在意这份夸奖。

“你们这些孩子救了大忙！”他说。“要不是你们，我们根本无法解决这个谜题，恢复王国的和平与繁荣。”

“假设我们*都*分了一块蛋糕，”女王说。“说到这个！我们来给这个蛋糕和茶的聚会加点儿派。”

“好啊！”国王说，他在过去的几秒钟里一直在拍打他长袍的口袋。“哦，萝卜，”他说。“我把我的线放哪儿了？”

![没有标题的图片](img/httpatomoreillycomsourcenostarchimages2160079.png.jpg)

# 超越王国的边界

我的天啊！蛇！我根本没料到会看到这个，距离还差 42 英里。我还有很多问题！它们是怎么潜入王国的？它们知道哪些酷炫的 Python 技巧，像我这样的 Ruby 程序员能学到哪些？它们是怎么不借助手就能操作 Key-a-ma-Jigger 的？

在我思考这些和其他伟大的谜题时，您可以继续练习使用 WEBrick 网络服务器。您可以创建一个名为 web_server.rb 的新文件，并输入以下代码。

web_server.rb

```

require 'webrick'
include WEBrick

server = HTTPServer.new(Port: 3000)

server.mount_proc '/' do |request, response|
  response.body = 'Your Ruby adventure is just beginning!'
end

trap('INT') { server.shutdown }

server.start

```

这段代码与您之前看到的版本略有不同，但这里没有任何您没见过的内容！唯一需要注意的部分是内置于 WEBrick 中的`mount_proc`方法。这个方法告诉服务器如何响应某些请求；在本例中，如果您访问电脑上的`/` URL，您应该会看到分配给`response.body`的消息。您电脑的内建网站是*http://localhost/*。

和往常一样，您可以通过在终端中输入**`ruby web_server.rb`**来运行完成的脚本。启动脚本后，您应该会看到一些数字和文本，如下所示：

```

INFO WEBrick 1.3.1
INFO WEBrick::HTTPServer#start: pid=78115 port=3000

```

（您的数字可能会略有不同，但文字应该差不多。）当您看到文本出现时，您的网络服务器已经启动并运行！打开您最喜欢的网页浏览器（例如 Chrome、Firefox、Internet Explorer 或 Safari），然后访问*http://localhost:3000/*。如果一切正常，您应该会在浏览器窗口中看到`Your Ruby adventure is just beginning!`。疯狂吧？您的第一个网站刚刚诞生！（我打算给它起名叫 Marigold。）当您用完服务器后，在运行 WEBrick 的终端中按住 CTRL-C 来关闭它。

这个网络服务器非常简单，如果我了解你们，你们肯定已经在考虑如何改进它了。那么，别客气！尽管去修改*web_server.rb*文件中的代码。（每次修改后，您需要使用 CTRL-C 来关闭服务器并重启，以便查看修改效果。）例如，您可以从仅仅修改`response.body`字符串开始，然后尝试调整端口号或者添加更多的`mount_proc`。

这里有个提示：如果您将以下代码添加到您的*web_server.rb*文件中，然后访问*http://localhost:3000/favorite_vegetable*，会发生什么呢？

```

server.mount_proc '/favorite_vegetable' do |request, response|
  response.body = 'Certainly not yams!'
end

```

如果你想查看世界各地的人们所创建的宝贵资源，可以访问 RubyGems 网站，网址是 *[`rubygems.org/`](http://rubygems.org/)*。几乎任何任务，都可能有人为此创建了 gem，所以你应该时常光顾 RubyGems。花点时间浏览网站上的信息，你很快就能下载并使用别人创建的 gem！

说到分享代码，那个能够将 Ruby 转换成 Python 的神奇小程序真的是存在的！它是由一位名叫 *why the lucky stiff* 的程序员编写的，可以在 *GitHub* 网站找到，那里人们与全世界的人分享他们写的代码。你可以在 *[`github.com/`](https://github.com/)* 找到 GitHub 网站，在 *[`github.com/whymirror/unholy/`](https://github.com/whymirror/unholy/)* 找到 Ruby 转 Python 的项目——叫做 *unholy*。 (这段代码非常先进，但如果你坚持下去，我相信你会逐渐理解的。我还没遇到过比你更聪明的人！)

# 你已经知道这些啦！

本章我们把你已经知道的部分代码和概念带到了一个新的层次，所以让我们稍微停一下，确保你能完全理解。

你学到我们可以通过使用 `open-uri` gem 来获取互联网上网站的信息：

```

>> require 'open-uri'
=> true

>> site = open('http://www.example.com')
=> #<StringIO:0x000001032de2f0>

>> site.read
=> "<!doctype html>...

```

一个 *gem* 只是别人创建的一组文件，目的是让你编写 Ruby 程序变得更轻松。我们可以像 `require` 自己写的文件一样，在程序中 `require` gem，只是我们需要在文件名前加上 `./`，而对于 gem，我们只需要在 `require` 方法调用后以字符串的形式写出 gem 的名字。

随时可以尝试这段代码与其他网站进行交互！只要确保事先获得许可，并小心——有些网站返回的代码可能非常多，可能会填满你的终端窗口。

你还看到我们不仅仅是 *请求* 信息；我们可以通过像 WEBrick 这样的 *web 服务器*，将信息 *提供* 给访问者：

```

require 'webrick'
include WEBrick

server = HTTPServer.new(:Port => 3000)

server.mount_proc '/' do |request, response|
  response.body = 'WEBrick is online and running fine!'
end

trap('INT') { server.shutdown }

server.start

```

你学到我们可以修改 web 服务器代码来写简单的消息，看到代码中的变化，通过停止并重新启动服务器，且使用 CTRL-C 可以停止服务器（当我们把它运行起来后），只需输入 `ruby server_file_name.rb` 或在 IRB 中调用 `load 'server_file_name.rb'`。

最后，我们稍微谈了一下如何通过访问 RubyGems 网站 (*[`rubygems.org/`](http://rubygems.org/)*)，使用其他人编写的 gem，以及如何通过 GitHub 网站 (*[`github.com/`](https://github.com/)*)，与世界各地的人们分享和阅读代码。如果你想在这些网站上创建账户，可以找个成年人大人帮忙哦！

我们的故事也许结束了，亲爱的读者，但这并不意味着我已经完全停下了喋喋不休的脚步。在过去的几百页中，我们涵盖了*大量*的 Ruby 魔法，如果我只是说一句“好了，再见！”然后就草草了事，那我就会是个糟糕的教师、作家和程序员了。深呼吸一下，翻开下一页，让我们再花几句话回顾一下我们学到的所有疯狂、令人惊叹、精彩的内容。
