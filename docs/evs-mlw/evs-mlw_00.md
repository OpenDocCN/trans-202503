

# 第一章：介绍



![](img/opener.jpg)

这一年是 2010 年。全球威胁研究人员发现了一种新型恶意软件，它使用多种技术感染特定的受害者。它特别针对一种西门子可编程逻辑控制器，这种控制器被用于伊朗核设施中的铀浓缩过程。最终被命名为“Stuxnet”的恶意软件，会分析其运行环境，以确保只感染预定的受害者。由于其针对性的特点，以及其拥有的多种防御规避和隐蔽技术，Stuxnet 长时间未被发现。其使用的一项技术是窃取的代码签名证书，这是一种相对较新的战术，能够赋予恶意软件一种真实性的外观。

快进到 2019 年 1 月。一个被攻破的华硕软件更新服务器正在提供恶意的假更新，这些更新会检查受影响计算机的 MAC 地址。该攻击具有特别的针对性：只有当受害者的计算机拥有一小部分硬编码的地址时，执行文件才会从互联网上下载额外的有效载荷。一旦安装，恶意软件会保持潜伏并未被发现，直到特定的触发条件发生。这次攻击的幕后黑手使用合法的华硕证书为恶意文件签名，帮助有效载荷绕过反恶意软件防御。研究人员将这次攻击命名为“ShadowHammer”。

不久之后，2020 年，世界被一个威胁组织震惊，该组织渗透了 SolarWinds 的网络——这家公司为成千上万的组织提供网络和系统监控软件。威胁行为者将恶意代码注入到 SolarWinds Orion 平台的合法软件更新服务中。这些更新被推送到使用 Orion 的组织中，而恶意代码则悄无声息地有效地将远程访问木马送入受害组织的网络。由于这些攻击者使用了融入目标环境的技术，这次攻击长时间未被发现。该攻击后来被称为“Sunburst”。

在这些攻击中，世界见证了*规避：*威胁试图在尽可能长的时间内保持隐匿并未被发现，同时保护自己免受宿主和网络防御软件及调查人员的监控。一旦被发现，具有规避性的威胁可能会改变其行为，动态修改其代码，或自我终止，同时销毁所有曾经存在于受害者网络中的证据。

规避和上下文感知的恶意软件是一种高度有效且持久的威胁，要求防御者不断适应。因此，网络安全专业人员和研究人员必须深入了解恶意软件使用的各种规避技术、如何识别它们以及如何克服它们。这本书探讨了常见于 Windows 的规避和上下文感知恶意软件的性质，提供了恶意软件如何利用操作系统的功能和架构来规避检测的技术的洞察。 本书还旨在为恶意软件分析师、取证调查员、前线防御人员、检测工程师、研究人员和学生提供他们理解这些威胁类型并揭开隐藏恶意软件代码的层层防护所需的知识和工具。

在我们开始之前，让我们通过查看一些常见类型的恶意软件及其如何利用规避技术来明确恶意软件究竟是什么。

## 什么是恶意软件？

一般来说，*恶意软件*是指任何做恶意事情的软件。看起来很简单，对吧？然而，恶意软件的定义常常存在冲突。Remcos 是一种在开放互联网出售的软件，其作者将其描述为“远程管理工具”。然而，由于任何人都可以购买 Remcos（完全合法，我想补充一下），它通常被用于不良目的，并且具有与一种已知恶意软件——远程访问木马相同的许多功能。另一个例子是 AsyncRAT，一种开源的“远程访问工具”，根据其作者的说法，它“旨在通过安全的加密连接远程监控和控制其他计算机”。那么，Remcos 和 AsyncRAT 是恶意软件吗？答案在很大程度上取决于你问谁、谁在使用它以及使用的目的是什么。上下文是关键。

恶意软件可以分为不同类型，或称为 *类别*。恶意软件类别是通过不同恶意软件家族中行为和功能的分组来定义的。以下是一些最常见的恶意软件类别：

**远程访问木马（RATs）**

RATs 用于提供持久的连接或访问受感染系统。RATs 通常可以通过记录按键、向受感染主机发出命令或向主机下载其他恶意软件等技术来监控受感染的主机。

**信息窃取者**

信息窃取者通常针对受害主机上的敏感信息，如登录凭据、银行信息、加密货币钱包、浏览器历史记录和类似信息。然后，它们将这些数据发送回攻击者。专门针对银行和金融相关数据的银行木马，可以被认为是一种信息窃取者。

**下载器和加载器**

投放器和加载器旨在将额外的恶意软件部署到系统上。从技术上讲，投放器包含一个嵌入的有效负载，并在执行时将其投放到受害者的系统中。而加载器则从外部资源（如互联网）下载其有效负载。然而，这些术语通常可以互换使用。这些恶意软件变种为额外的恶意软件铺平道路，有时甚至在部署有效负载之前，通过禁用反恶意软件软件和其他终端防御措施来准备受害者主机。

**勒索软件**

勒索软件旨在阻止受害者访问系统或数据，直到支付一定的金额，通常是以加密货币的形式，给威胁行为者。该恶意软件可能会加密硬盘或系统上的特定文件，“锁定”对文件或程序的访问，或以其他方式阻止受害者按预期使用其系统。攻击者随后要求受害者支付赎金，以换取恢复系统和数据。

**擦除程序**

擦除程序（或*毁灭性软件*）与勒索软件是密切相关的。它们旨在破坏受害者系统上的文件，造成损害或影响服务。为了实现这一目的，擦除程序会加密机器上的数据或使用分区工具删除数据。例如，擦除程序通常像勒索软件一样运作，除了它们在加密数据后并不打算解密数据。

**蠕虫**

蠕虫是一种自我传播的恶意软件。一旦它们感染了一个主机，通常会扫描受害者的网络，寻找其他系统来感染。

**病毒**

*病毒*这个词经常与*恶意软件*同义使用，但这并不完全准确：所有病毒都是恶意软件，但并非所有恶意软件都是病毒。病毒将恶意代码附加到受害者系统上的文件中，当这些文件被发送到另一个受害者并被打开时，病毒会传播到新的受害者主机。

**Rootkit 和 Bootkit**

*Rootkit*是恶意软件的特殊变种，旨在隐瞒它们在系统用户和安全工具中的存在。为了避免被发现，Rootkit 通常会修改操作系统的内核级系统组件，这使得攻击者能够保持对被入侵系统的访问权限。*Bootkit*通常与 Rootkit 有相同的目的，但它们感染的是主引导记录（MBR）或计算机系统引导过程的其他组件，使得它们能够在操作系统加载之前控制系统。

**木马**

历史上，*木马*被定义为伪装成合法软件的恶意软件。我将它们列在此清单中是为了完整性，但我不喜欢这个术语及其定义。毕竟，哪种恶意软件不是伪装成合法软件的呢？如果恶意软件告诉我们它是恶意的，我们就不会被它欺骗并执行它。因此，*木马*是一个过时且经常被滥用的术语。

这份列表涵盖了大部分恶意软件，但并不详尽。其他恶意软件变种包括键盘记录器、加密货币挖矿程序、间谍软件、黑客工具等。需要记住的是，这些恶意软件类型并不总是简单明了，它们之间常常会有重叠。把这些恶意软件看作行为特征，而不是独立的类别，可能会更有帮助。

我们通常将恶意软件分为两大类：常见恶意软件和定制恶意软件。*常见*恶意软件通常面向大规模市场，无论是在公开的互联网还是在暗网论坛中都能找到。这类恶意软件通常会被多个不同的威胁团体同时使用。常见恶意软件的例子包括 Lokibot 和 Agent Tesla，这是目前流通的两款最流行的恶意软件。*定制*恶意软件则更加个性化，通常针对某一特定行业，甚至是某个特定公司或个人，且具有非常明确的目标。这类恶意软件的例子包括我们前面提到的 Stuxnet，以及 2022 年俄罗斯入侵乌克兰初期针对乌克兰系统的 HermeticWiper。常见恶意软件可以通过增强定制化功能，变得更具针对性和个性化。

> 注意

*恶意软件存在于所有主要操作系统中，包括（但不限于）Windows、macOS 以及各种 Unix 版本，和 Android、iOS 等移动操作系统。由于 Windows 是最为普及的，我决定在本书中重点讨论 Windows 恶意软件。然而，我们将在本书中讨论的许多规避技术也可以以某种形式在其他操作系统上实现。*

## 什么是恶意软件分析？

*恶意软件分析*是调查并拆解恶意代码和软件的过程。恶意软件分析师的目标是识别并理解恶意软件样本的行为、功能和潜在影响，以及与之相关的攻击（也称为其*背景*）。恶意软件分析既是一门艺术，也是一门科学，因为要完全理解一个恶意软件样本，尤其是那些更高级的变种，往往需要大量的创造力，并将这些知识用于检测和防止未来的攻击。正如我们在第三章中讨论的那样，恶意软件分析可以分为两种主要方法：静态分析和动态分析。

## 为什么恶意软件会使用规避技术？

规避的最终目标是通过避免被检测和分析来实现自我保护。一些恶意软件旨在尽可能长时间地潜伏在受害者的系统或网络中。其他恶意软件则试图在被发现之前尽可能绕过多个网络和主机防御，以便快速执行其有效载荷。恶意软件作者可能出于以下任何原因在其恶意软件中实现规避技术：

**妨碍分析**

智能恶意软件知道，它最终会被检测到，并且可能会在虚拟机或恶意软件沙箱中被分析员或研究人员调查。现在，恶意软件扫描其宿主系统并寻找运行在分析员实验室中的迹象，已经变得越来越常见。恶意软件还可能搜索分析工具的迹象，例如代码调试器，并干扰它们，以防止、挫败或至少减缓恶意软件分析员理解其潜在行为、功能和代码的努力。

**规避防御**

网络和宿主防御系统，例如入侵防御系统（IPS）、反恶意软件和端点检测与响应（EDR）产品，对于恶意软件来说是麻烦。规避性威胁会尝试绕过这些防御措施，以便保持在感染宿主上的隐匿状态。

**目标系统与上下文分析**

威胁如 Stuxnet 会不遗余力地识别其当前运行的系统类型。实施分析技术的恶意软件可能会尝试确定受害者的操作系统、受害者机器上安装的软件，甚至是受害者的物理位置。然后，恶意软件利用这些信息来判断该系统是否是有效目标。如果不是，恶意软件可能会删除所有曾经在受害者主机上存在的证据，从而逃避检测。恶意软件还可能通过分析来确定目标系统或网络中采用的特定防御措施，并根据这些信息改变其行为和功能。

## 我为何写这本书

多年来，我在网络犯罪及其作案者领域的专心研究中，发现了规避技术使用的增加，甚至在最基础和广泛传播的恶意软件中也是如此。现代恶意软件结合了多种战术，来绕过最强大的沙箱和防御，并尽可能地妨碍分析和调查。曾经只用于更高级或定制恶意软件的技术，现在变得更加普遍。不仅如此，恶意软件中的规避措施也在不断发展，以进一步妨碍分析工作。

本书旨在作为 Windows 平台恶意软件规避技术的入门指南和详尽资源。对于这个领域的新人和经验丰富的专业人员来说，识别并学习基础知识以应对规避威胁可能是具有挑战性的。尽管在这个领域正在进行大量研究，但它仍然相对小众。我坚信，我们作为恶意软件研究人员和安全分析师，越是了解现代威胁行为和新兴趋势，就能越有效地保护我们的组织并防止未来的受害者。

我的希望是，在阅读完本书后，你能拥有明确的策略，能够将其轻松融入到你的恶意软件分析方法或组织的防御措施中。最重要的是，我的目标是激发你对这一领域进一步学习的兴趣。我们必须共同努力，让威胁行为者和恶意软件作者时刻保持警觉。

虽然我认为自己在这一领域有一定的知识，但我也深知还有很多成长和学习的空间。如果你对本书中的内容有任何问题、反馈或额外的见解，请随时联系我。我总是乐于与人讨论网络威胁和恶意软件相关的话题。

## 谁应该阅读本书

我写这本书是为那些希望更好理解现代和先进恶意软件所采用的规避技术的人们。也许你已经是恶意软件研究员，想要探索恶意软件如何规避和绕过你的分析工具和实验环境。也许你是前线的事件响应者，希望更好地理解如何识别和检测这些类型的威胁，或者你是一个法证分析员，试图了解如何调查被先进恶意软件攻陷的系统。这本书就是为你准备的。

本书内容非常技术化，并不是针对初学者的 Windows 恶意软件分析指南，因此我假设你至少具备中级的网络安全知识，并对恶意软件分析有基本了解。理想情况下，你还应该有反汇编代码的经验。然而，如果你是这些话题的新手，也不用担心：本书的前三章提供了恶意软件分析的速成课程，以及理解后续章节所需的基本概念。

此外，我希望你已经设置了一个恶意软件分析实验环境，以便安全地执行恶意软件。这一点非常重要，因为本书中的所有示例都使用了真实的恶意软件样本。附录 A 包括了设置虚拟机和虚拟化平台进行安全恶意软件分析的指南。

## 本书结构

本书共分为 4 个部分，包含 17 章，以及 3 个附录。

第一部分，基础知识，为本书的其余部分奠定了知识基准。

**第一章：Windows 基础概念** 涵盖了 Windows 操作系统的基本概念。

**第二章：恶意软件筛查与行为分析** 聚焦于恶意软件筛查的基础知识，并分析恶意软件样本的行为，以确定它们如何在感染的系统上运行。

**第三章：静态与动态代码分析** 涵盖了静态和动态代码分析的基础知识，并讲解了如何使用这些技术揭示恶意软件的真实意图。

第二部分，上下文感知和沙箱规避，探讨了如何通过虚拟机和恶意软件分析沙箱检测到规避恶意软件。

**第四章: 枚举操作系统遗留物** 讨论了恶意软件如何仔细检查底层操作系统遗留物，以检测分析活动。

**第五章: 用户环境与交互检测** 解释了恶意软件如何通过枚举用户交互和它运行的环境来阻挠调查。

**第六章: 枚举硬件和网络配置** 探讨了恶意软件如何检查系统硬件和网络设置，以发现恶意软件分析师的沙箱和虚拟机。

**第七章: 运行时环境与虚拟处理器异常** 讨论了处理和运行时环境异常如何使恶意软件察觉分析尝试。

**第八章: 避免沙箱和干扰分析** 探讨了威胁行为者可以用来完全规避和干扰分析环境的几种技术。

第三部分，反逆向，详细介绍了攻击者如何通过复杂化逆向工程过程来对抗恶意软件分析师。

**第九章: 反反汇编** 解释了恶意软件如何使用反反汇编技术来防止和干扰手动代码分析。

**第十章: 反调试** 讨论了恶意软件如何检测并规避调试器和动态代码分析。

**第十一章: 隐蔽代码执行和误导** 演示了恶意软件如何隐蔽地执行代码，或如何使恶意软件分析师迷惑和误导。

第四部分，防御规避，深入探讨了恶意软件如何规避防御控制。

**第十二章: 进程注入、操控与钩子技术** 揭示了恶意软件如何将恶意代码注入不同进程、操控进程并钩取函数代码。

**第十三章: 避免端点和网络防御** 介绍了恶意软件如何规避并绕过网络和端点防御。

**第十四章: Rootkit 介绍** 讨论了一种特别危险的规避恶意软件类型：Rootkit 的基本原理。

**第十五章: 无文件、依赖现成工具及反取证技术** 探讨了恶意软件如何利用所谓的无文件技术和反取证措施来规避防御和取证工具。

**第十六章: 编码与加密** 专注于编码和加密技术，提供了分析恶意软件的实用方法。

**第十七章: 打包器和解包恶意软件** 讨论了恶意软件混淆器和打包器的工作原理，并深入讲解了如何解包恶意代码。

附录包括了建立恶意软件分析实验室的操作步骤；恶意软件可能利用的 Windows API 函数列表，用于规避目的；以及进一步阅读恶意软件及其分析世界的参考资料。

## 本书的恶意软件样本

本书中，我包含了分析实验室和关于特定恶意软件样本及其家族的信息。我常常引用恶意软件文件的签名，格式为SHA256:hash_value。这是一个例子：

```
SHA256:b625df3af182060e3ee589f95669a76f43840f93df0a66fb942af51895de5504
```

我在书中引用的大多数恶意软件样本都可以从 VirusTotal 上下载（[*https://<wbr>www<wbr>.virustotal<wbr>.com*](https://www.virustotal.com)），前提是你有商业账户，或者可以从 MalShare 免费下载（[*https://<wbr>malshare<wbr>.com*](https://malshare.com)）。请注意，这些恶意软件样本是*真实*的恶意软件。在下载并执行书中提到的任何恶意软件之前，确保你已建立了专门的恶意软件分析实验室，并配置为安全分析。附录 A 讨论了如何做到这一点的技巧。

最后，在这本书中，我尝试使用了多种恶意软件样本，包括 32 位和 64 位恶意软件。你可能会好奇，为什么我如此关注 32 位代码，而 64 位代码已逐渐取代它。简单的回答是，32 位恶意软件仍然很常见，这可能是因为恶意软件没有动力去转向 64 位架构。它不需要 64 位架构所提供的额外内存地址空间或性能。而且，最重要的是，32 位恶意软件几乎可以在每个版本的 Windows 上运行。请记住，一些人仍然在使用过时的操作系统，如 Windows XP、Windows Server 2003 和 Windows 7，以及更旧的处理器架构。

现在，让我们开始深入探讨 Windows 的基础概念。在第一章见。
