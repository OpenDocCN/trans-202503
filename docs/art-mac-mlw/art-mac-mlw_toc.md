# 详细目录

1.  封面页

1.  版权声明

1.  献词

1.  关于作者

1.  前言

1.  致谢

1.  简介

    1.  谁应该阅读本书？

    1.  本书内容概览

    1.  Mac 恶意软件术语说明

    1.  关于安全分析恶意软件的注意事项

    1.  附加资源

        1.  书籍

        1.  网站

    1.  下载本书的恶意软件样本

    1.  尾注

1.  第一部分：Mac 恶意软件基础

    1.  第一章：感染向量

        1.  Mac 保护

        1.  恶意邮件

        1.  虚假技术与支持

        1.  虚假更新

        1.  虚假应用程序

        1.  木马化应用程序

        1.  盗版与破解应用程序

        1.  自定义 URL 方案

        1.  Office 宏

        1.  Xcode 项目

        1.  供应链攻击

        1.  远程服务的账户泄露

        1.  漏洞利用

        1.  物理访问

        1.  接下来

        1.  尾注

    1.  第二章：持久性

        1.  登录项

        1.  启动代理与守护进程

        1.  计划作业与任务

            1.  Cron 作业

            1.  在职作业

            1.  定期脚本

        1.  登录与注销钩子

        1.  动态库

            1.  DYLD_* 环境变量

            1.  Dylib 代理

            1.  Dylib 劫持

        1.  插件

        1.  脚本

        1.  事件监控规则

        1.  重新打开的应用程序

        1.  应用程序与二进制修改

        1.  KnockKnock . . . 谁在那儿？

        1.  接下来

        1.  尾注

    1.  第三章：功能

        1.  Mac 恶意软件功能分类

        1.  调查与侦察

        1.  特权升级

            1.  逃脱沙箱

            1.  获得 Root 权限

        1.  与广告软件相关的劫持与注入

        1.  加密货币矿工

        1.  远程 Shell

        1.  远程进程与内存执行

        1.  远程下载与上传

        1.  文件加密

        1.  隐匿性

        1.  其他功能

        1.  接下来

        1.  尾注

1.  第二部分：Mac 恶意软件分析

    1.  第四章：非二进制分析

        1.  识别文件类型

        1.  从分发包中提取恶意文件

            1.  Apple 磁盘映像（.dmg）

            1.  包文件（.pkg）

        1.  分析脚本

            1.  Bash Shell 脚本

            1.  Python 脚本

            1.  AppleScript

            1.  Perl 脚本

        1.  Microsoft Office 文档

        1.  应用程序

        1.  接下来

        1.  尾注

    1.  第五章：二进制筛选

        1.  Mach-O 文件格式

            1.  头文件

            1.  加载命令

            1.  数据段

        1.  Mach-O 文件分类

            1.  哈希

            1.  代码签名信息

            1.  字符串

            1.  Objective-C 类信息

        1.  “非二进制”二进制文件

            1.  识别用于构建二进制文件的工具

            1.  提取非二进制组件

        1.  接下来

        1.  尾注

    1.  第六章：反汇编与反编译

        1.  汇编语言基础

            1.  寄存器

            1.  汇编指令

            1.  调用约定

            1.  objc_msgSend 函数

        1.  反汇编

            1.  Objective-C 反汇编

            1.  Swift 反汇编

            1.  C/C++ 反汇编

            1.  控制流反汇编

        1.  反编译

        1.  使用 Hopper 进行逆向工程

            1.  创建二进制文件以进行分析

            1.  加载二进制文件

            1.  探索接口

            1.  查看反汇编

            1.  更改显示模式

        1.  接下来

        1.  尾注

    1.  第七章：动态分析工具

        1.  进程监控

            1.  ProcessMonitor 工具

        1.  文件监控

            1.  fs_usage 工具

            1.  FileMonitor 工具

        1.  网络监控

            1.  macOS 的网络状态监视器

            1.  Netiquette 工具

            1.  网络流量监视器

        1.  接下来

        1.  脚注

    1.  第八章：调试

        1.  为什么你需要一个调试器

        1.  LLDB 调试器

            1.  启动调试会话

            1.  控制执行

            1.  使用断点

            1.  检查所有内容

            1.  修改进程状态

        1.  LLDB 脚本编写

        1.  一个示例调试会话：揭示 App Store 应用中的隐藏加密货币挖掘逻辑

        1.  接下来

        1.  脚注

    1.  第九章：反分析

        1.  反静态分析方法

            1.  作为常量伪装的敏感字符串

            1.  加密字符串

            1.  定位混淆字符串

            1.  找到去混淆代码

            1.  通过 Hopper 脚本去混淆字符串

            1.  强制恶意软件执行其解密程序

            1.  代码级混淆

            1.  绕过打包二进制代码

            1.  解密加密二进制文件

        1.  反动态分析方法

            1.  检查系统型号名称

            1.  统计系统的逻辑和物理 CPU

            1.  检查系统的 MAC 地址

            1.  检查系统完整性保护状态

            1.  检测或终止特定工具

            1.  检测调试器

            1.  通过 ptrace 防止调试

        1.  绕过反动态分析逻辑

            1.  修改执行环境

            1.  修补二进制镜像

            1.  修改恶意软件的指令指针

            1.  修改寄存器值

        1.  一个剩余挑战：环境生成的密钥

        1.  接下来

        1.  脚注

1.  第三部分：分析 EvilQuest

    1.  第十章：EvilQuest 的感染、分类和去混淆

        1.  感染向量

        1.  分类

            1.  确认文件类型

            1.  提取内容

            1.  探索包

        1.  从补丁二进制文件中提取嵌入的信息

        1.  分析命令行参数

            1.  --silent

            1.  --noroot

            1.  --ignrp

        1.  分析反分析逻辑

            1.  虚拟机反制逻辑？

            1.  反调试逻辑

            1.  混淆字符串

        1.  接下来

        1.  尾注

    1.  第十一章：EvilQuest 的持久性和核心功能分析

        1.  持久化

            1.  杀死不需要的进程

            1.  自我复制

            1.  将副本持久化为启动项

            1.  启动项

        1.  重新持久化逻辑

        1.  本地病毒感染逻辑

            1.  列出候选感染文件

            1.  检查是否感染每个文件

            1.  感染目标文件

            1.  执行并重新持久化感染文件

            1.  执行感染文件的原始代码

        1.  远程通信逻辑

            1.  中介与命令控制服务器

            1.  远程任务逻辑

            1.  react_exec (0x1)

            1.  react_save (0x2)

            1.  react_start (0x4)

            1.  react_keys (0x8)

            1.  react_ping (0x10)

            1.  react_host (0x20)

            1.  react_scmd (0x40)

        1.  文件外泄逻辑

            1.  目录列出外泄

            1.  证书和加密货币文件外泄

        1.  文件加密逻辑

        1.  EvilQuest 更新

            1.  更好的反分析逻辑

            1.  修改的服务器地址

            1.  更长的安全工具终止列表

            1.  新的持久化路径

            1.  个人鸣谢

            1.  更好的函数

            1.  移除的勒索软件逻辑

        1.  结论

        1.  尾注

1.  索引

## **表格列表**

1.  表 6-1：助记符和示例指令

1.  表 6-2：macOS（Intel 64 位）调用约定

1.  表 6-3：在 `objc_msgSend` 函数上下文中的调用约定

1.  表 8-1：控制执行的 LLDB 命令

1.  表 8-2：管理断点的 LLDB 命令

1.  表 8-3：显示内存内容的 LLDB 命令

1.  表 11-1：病毒感染逻辑创建的文件结构

## **插图列表**

1.  图 1-1：用户辅助的公证绕过说明 (Shlayer)

1.  图 1-2：假冒安全警报 (Shlayer)

1.  图 1-3：一个假冒的 Flash Player 更新 (Shlayer)

1.  图 1-4：*message-whatsapp.com* 主页 (Siggen)

1.  图 1-5：JMTTrading 主页

1.  图 1-6：一个被篡改的加密货币交易应用 (Lazarus Group 后门)

1.  图 1-7：盗版应用 (iWorm)

1.  图 1-8：Safari 的下载后打开“安全”文件功能

1.  图 1-9：浏览器警告... 但这足够吗？

1.  图 1-10：Microsoft Word 的宏警告

1.  图 1-11：受感染 Xcode 项目中的恶意构建脚本 (XCSSET)

1.  图 1-12：访问 *macupdate.com* 并下载并运行了篡改的应用程序的用户，可能不幸地感染了病毒——实际上这并不是他们的错。

1.  图 1-13：零日漏洞出售

1.  图 2-1：持久登录项。Finder 项目实际上是恶意软件 (NetWire)。

1.  图 2-2：一个被篡改的应用程序 (GMERA)

1.  图 2-3：一个恶意的浏览器扩展 (广告软件)

1.  图 2-4：重新打开应用程序的提示

1.  图 2-5：敲敲？谁在那儿？... 希望只有合法软件！

1.  图 3-1：恶意软件能力的分类

1.  图 3-2：一个授权提示 (EvilQuest)

1.  图 3-3：通过 `AuthorizationExecuteWithPrivileges` API 的授权提示 (ColdRoot)

1.  图 3-4：Safari 主页被劫持 (Mughthesec/Safe Finder)

1.  图 3-5：一个感染用户的新主页 (Mughthesec/Safe Finder)

1.  图 3-6：虚假广告货币化的网络捕获 (IPStorm)

1.  图 3-7：解密说明 (KeRanger)

1.  图 4-1：使用 WhatsYourSign 来识别一个应用程序 (WindTail)

1.  图 4-2：使用 WYS 来识别磁盘镜像 (EvilQuest)

1.  图 4-3：使用 Suspicious Package 检查一个软件包 (CPUMeaner)

1.  图 4-4：使用 Suspicious Package 导出文件（CPUMeaner）

1.  图 4-5：使用 Suspicious Package 检查安装后脚本（CPUMeaner）

1.  图 4-6：使用 Suspicious Package 检查包（AppleJeus）

1.  图 4-7：基于脚本的有效载荷（Siggen）

1.  图 4-8：Apple 的脚本编辑器

1.  图 4-9：通过 AppleScript 进行合成点击（DevilRobber）

1.  图 4-10：生成仅运行的 AppleScript

1.  图 4-11：查看应用程序包的内容（WindTail）

1.  图 4-12：使用 Apparency 查看应用程序包的内容（WindTail）

1.  图 5-1：Mach-O 二进制文件的布局

1.  图 5-2：使用 MachOView 查看 Mach-O 头部（WindTail）

1.  图 5-3：加载命令的布局

1.  图 5-4：利用 Google 通过哈希值识别恶意文件（WindTail）

1.  图 5-5：利用 VirusTotal 通过哈希值识别恶意文件（WindTail）

1.  图 5-6：利用 Google 通过代码签名团队标识符识别恶意文件（WindTail）

1.  图 5-7：利用 Google 通过嵌入的字符串识别恶意软件（WindTail）

1.  图 5-8：一个简单的基于脚本的应用程序，可能是通过 Appify 构建的（Shlayer）

1.  图 5-9：来自 MacUpdate 的安全警告

1.  图 5-10：通过 Platypus 嵌入的恶意安装程序脚本（CreativeUpdate）

1.  图 5-11：已归档的源代码（GravityRAT）

1.  图 5-12：解包的源代码文件（GravityRAT）

1.  图 6-1：Hopper 中的加载器窗口

1.  图 6-2：Hopper 中的基本文件信息

1.  图 6-3：Hopper 中的过程视图

1.  图 6-4：Hopper 中的嵌入字符串视图

1.  图 6-5：选择查看“Hello, World!”字符串的交叉引用选项。

1.  图 6-6：“Hello, World!”字符串的交叉引用

1.  图 6-7：`NSLog`函数的交叉引用

1.  图 6-8：Hopper 中的显示模式

1.  图 7-1：网络监视器揭示命令和控制服务器的地址（WindTail）

1.  图 7-2：使用 Netiquette 揭示命令和控制服务器的地址（Dacls）

1.  图 7-3：使用 Wireshark 捕获调查数据（ColdRoot）

1.  图 7-4：使用 Wireshark 揭示功能，在此案例中是一个返回恶意软件在感染系统中位置的命令（FruitFly）

1.  图 7-5：使用 Wireshark 揭示功能，在这种情况下是返回受感染系统屏幕截图的命令（FruitFly）

1.  图 8-1：苹果官方 Mac 应用商店中的隐秘加密货币挖矿工具

1.  图 9-1：嵌入的混淆数据（NetWire）

1.  图 9-2：对`@``selector(``yoop:)`的交叉引用（WindTail）

1.  图 9-3：UPX 段头（ColdRoot）

1.  图 10-1：被 EvilQuest 篡改的 Little Snitch 盗版

1.  图 10-2：VirusTotal 上的被篡改的*Mixed* *In* *Key 8.dmg*文件

1.  图 10-3：WYS 确认该项为磁盘映像

1.  图 10-4：WYS 确认该项为未签名的包

1.  图 10-5：使用 Suspicious Package 查看被篡改的*Mixed in Key*包中的文件

1.  图 10-6：仍然有效签名的应用程序（通过 WYS）

1.  图 10-7：恶意软件的认证提示，通过`osascript`

1.  图 11-1：将文件头类型转换为 Mach-O 头

1.  图 11-2：EvilQuest 的勒索通知

1.  图 11-3：对`ei_run_memory_hrd`函数的交叉引用

1.  图 11-4：一个有趣的观察

## **清单列表**

1.  清单 1-1：公证的恶意软件（Shlayer）

1.  清单 1-2：一个包含自定义 URL 方案`openurl2622007`的*Info.plist*文件（WindTail）

1.  清单 1-3：观察启动服务守护进程（`lsd`）的文件 I/O 事件

1.  清单 1-4：WindTail（*Final_Presentation.app*），现在注册为自定义 URL 处理程序

1.  清单 1-5：通过 Safari 下载并启动 WindTail（概念验证）

1.  清单 1-6：恶意宏代码（Lazarus Group 后门）

1.  清单 1-7：恶意构建脚本*Assets.xcassets*（XCSSET）

1.  清单 1-8：远程感染逻辑（IPStorm）

1.  清单 2-1：登录项持久性（NetWire）

1.  清单 2-2：导入，包括`LSSharedFileList*` API（WindTail）

1.  清单 2-3：用于解析*.plist*文件的 macOS 工具

1.  清单 2-4：一个示例启动项属性列表

1.  清单 2-5：一个启动项属性列表模板（NetWire）

1.  清单 2-6：启动代理持久性逻辑（NetWire）

1.  清单 2-7：恶意启动项属性列表（NetWire）

1.  清单 2-8：一个恶意安装脚本，*run.sh*（GMERA）

1.  清单 2-9：一个恶意启动代理 plist（GMERA）

1.  列表 2-10: 一个解密的属性列表模板（EvilQuest）

1.  列表 2-11: 一个启动项 plist（EvilQuest）

1.  列表 2-12: Cron 任务持久化（EmPyre）

1.  列表 2-13: Cron 任务持久化（Janicab）

1.  列表 2-14: 启用 at 调度程序

1.  列表 2-15: 周期性脚本

1.  列表 2-16: 一个示例 `LoginHook`

1.  列表 2-17: `DYLD_INSERT_LIBRARIES` 持久化（FlashBack）

1.  列表 2-18: 一个代理动态库

1.  列表 2-19: 一个动态库劫持者，PhotoFoundation，通过 Apple 的 Photo Stream Agent 加载

1.  列表 2-20: 一个 dylib 劫持持久化模块，*CreateHijacker.py*

1.  列表 2-21: 通过修改 *rc.common* 文件进行持久化（iKitten）

1.  列表 2-22: 重新打开的应用程序属性列表

1.  列表 2-23: 病毒感染逻辑（EvilQuest）

1.  列表 3-1: 检测 LittleSnitch 防火墙（Proton）

1.  列表 3-2: 调查相关方法（MacDownloader）

1.  列表 3-3: 调查（MacDownloader）

1.  列表 3-4: 通过启动代理逃逸沙箱

1.  列表 3-5: 调用 `AuthorizationExecuteWithPrivileges` API（ColdRoot）

1.  列表 3-6: 利用 writeconfig XPC 服务的零日漏洞（XSLCmd）

1.  列表 3-7: 一个持久化启动项 plist（CreativeUpdate）

1.  列表 3-8: 一个持久化的远程 Shell（Dummy）

1.  列表 3-9: 通过 `popen` API 执行命令（Lazarus Group 后门）

1.  列表 3-10: 一种文件执行方法（Komplex）

1.  列表 3-11: 文件执行逻辑（Komplex）

1.  列表 3-12: 内存中的代码执行（Lazarus Group 后门）

1.  列表 3-13: 文件下载连接（WindTail）

1.  列表 3-14: 文件外泄包装器（MacDownloader）

1.  列表 3-15: 文件外泄（MacDownloader）

1.  列表 3-16: libcurl API（Lazarus Group 植入利用）

1.  列表 3-17: 内核符号解析（FinSpy）

1.  列表 3-18: 内核模式下的进程隐藏（FinSpy）

1.  列表 4-1: 一个未知的文件类型

1.  列表 4-2: 使用 `file` 工具识别字节编译的 Python 脚本

1.  列表 4-3: 使用 `file` 工具识别编译后的 64 位 Mach-O 可执行文件（WindTail）

1.  列表 4-4: 使用磁盘映像时，`file` 工具的困境（EvilQuest）

1.  列表 4-5：使用 `hdiutil` 挂载被感染的磁盘镜像（CreativeUpdate）

1.  列表 4-6：列出磁盘镜像的文件（AppleJeus）

1.  列表 4-7：一个安装后脚本，包含安装逻辑（AppleJeus）

1.  列表 4-8：一个恶意的 bash 脚本（Siggen）

1.  列表 4-9：另一个恶意 bash 脚本（Siggen）

1.  列表 4-10：一个恶意的 Python 脚本（Dummy）

1.  列表 4-11：一个解码后的 Python 载荷（Siggen）

1.  列表 4-12：解码后的配置数据（Siggen）

1.  列表 4-13：反编译的 Python 代码（未指定的广告软件）

1.  列表 4-14：去混淆的 Python 代码（未指定的广告软件）

1.  列表 4-15：AppleScript 中的“Hello, World!”

1.  列表 4-16：使用 `file` 识别已编译的 AppleScript

1.  列表 4-17：通过 AppleScript 输出“Hello, World!”

1.  列表 4-18：恶意 AppleScript（未指定的广告软件）

1.  列表 4-19：通过 AppleScript 进行合成点击（DevilRobber）

1.  列表 4-20：通过 `osadecompile` 反编译仅运行 AppleScript 失败

1.  列表 4-21：一个持久化启动项 plist（OSAMiner）

1.  列表 4-22：通过 `osadecompile` 反编译仅运行 AppleScript 失败（OSAMiner）

1.  列表 4-23：通过 AppleScript 反汇编器反编译仅运行 AppleScript

1.  列表 4-24：通过 AppleScript 反汇编器和 `aevt_decompile` 反编译仅运行 AppleScript

1.  列表 4-25：进一步通过 `aevt_decompile` 反编译仅运行 AppleScript（OSAMiner）

1.  列表 4-26：混淆的 Perl（FruitFly）

1.  列表 4-27：美化过的，尽管仍然有些混淆的 Perl（FruitFly）

1.  列表 4-28：使用 `file` 识别 Office 文档

1.  列表 4-29：使用 `olevba` 提取宏

1.  列表 4-30：使用 `olevba` 提取恶意宏

1.  列表 4-31：使用 `find` 查看应用程序包的内容（WindTail）

1.  列表 4-32：一个 *Info.plist* 文件（WindTail）

1.  列表 4-33：使用 `file` 识别二进制属性列表（Siggen）

1.  列表 4-34：使用 `defaults` 读取二进制属性列表（Siggen）

1.  列表 5-1：`mach_header_64` 结构

1.  列表 5-2：使用 `otool` 查看 Mach-O 头部（WindTail）

1.  列表 5-3：一个通用二进制文件（Pirrit）

1.  列表 5-4：使用 `otool` `-f` 查看 fat 头部（Pirrit）

1.  清单 5-5：使用 `lipo` 从一个通用二进制文件中提取 Mach-O（Pirrit）

1.  清单 5-6：使用 `otool` 查看加载命令（WindTail）

1.  清单 5-7：`load_command` 结构体（Pirrit）

1.  清单 5-8：`entry_point_command` 结构体

1.  清单 5-9：`dylib_command` 和 `dylib` 结构体

1.  清单 5-10：一个被 Trojan 化的 iTerm 应用程序的依赖关系（ZuRu）

1.  清单 5-11：使用 `md5` 和 `shasum` 计算哈希值（WindTail）

1.  清单 5-12：使用 `codesign` 查看自签名文件的代码签名信息（WindTail）

1.  清单 5-13：使用 `codesign` 查看 Apple 应用程序的代码签名信息

1.  清单 5-14：使用 `codesign` 查看第三方应用程序的代码签名信息

1.  清单 5-15：通过 `spctl` 查看文件的认证状态

1.  清单 5-16：使用 `codesign` 查看文件的证书状态（WindTail）

1.  清单 5-17：使用 `strings` 提取嵌入的字符串

1.  清单 5-18：使用 `class-dump` 重构嵌入的类信息（Crisis）

1.  清单 5-19：使用 `class-dump` 重构嵌入的类信息（XAgent）

1.  清单 5-20：调用 PyInstaller 入口点的二进制文件

1.  清单 5-21：一个恶意安装程序脚本（Shlayer）

1.  清单 5-22：一个恶意安装程序脚本（CreativeUpdate）

1.  清单 5-23：MinerGate 的命令行加密货币挖矿程序

1.  清单 5-24：通过 `file` 和 `strings` 对二进制文件进行初步分析（GravityRAT）

1.  清单 5-25：使用 `pyinstxtractor` 提取 “PyInstallered” 二进制文件的内容（GravityRAT）

1.  清单 5-26：提取的 Python 文件（GravityRAT）

1.  清单 5-27：使用 `otool` 查看链接的框架（包括 Electron）（GravityRAT）

1.  清单 5-28：使用 `npx` 解包源代码（GravityRAT）

1.  清单 5-29：通过 cron 作业保持持久性（GravityRAT）

1.  清单 6-1：通过 Objective-C 初始化 URL 对象

1.  清单 6-2：初始化 URL 对象，反汇编版

1.  清单 6-3：初始化 `NSData` 对象，反汇编版（Komplex）

1.  清单 6-4：重构的 Objective-C 代码（Komplex）

1.  清单 6-5：写出文件，反汇编版（Komplex）

1.  清单 6-6：重构的 Objective-C 代码（Komplex）

1.  清单 6-7：一个嵌入的 Mach-O 二进制文件（Komplex）

1.  清单 6-8：Swift 反汇编 `NSTask` 初始化（Dacls）

1.  列表 6-9：更多 Swift 反汇编 `NSTask` 初始化（Dacls）

1.  列表 6-10：嵌入参数（Dacls）

1.  列表 6-11：`NSTask` 启动的反汇编（Dacls）

1.  列表 6-12：`getDeviceSerial` 函数的反汇编（AppleJeus）

1.  列表 6-13：网络连接检查与控制流（Komplex）

1.  列表 6-14：网络连接检查与控制流，重构版（Komplex）

1.  列表 6-15：`getDeviceSerial` 函数的反编译（AppleJeus）

1.  列表 6-16：`connectedToInternet` 函数的反编译（Komplex）

1.  列表 6-17：Apple 的“Hello, World！”

1.  列表 6-18：编译“Hello, World！”

1.  列表 6-19：“Hello, World！”通过 Hopper 反汇编

1.  列表 6-20：“Hello, World！”的反编译

1.  列表 6-21：原始“Hello, World！”源代码，供比较

1.  列表 7-1：使用 ProcessMonitor 观察安装程序命令（AppleJeus 变种）

1.  列表 7-2：使用 ProcessMonitor 揭示文件外泄功能（WindTail）

1.  列表 7-3：使用 `fs_usage` 观察文件访问（ColdRoot）

1.  列表 7-4：配置文件（ColdRoot）

1.  列表 7-5：使用 FileMonitor 揭示持久性（BirdMiner）

1.  列表 7-6：使用 FileMonitor 揭示持久后门组件（Yort）

1.  列表 7-7：嵌入的命令与控制服务器，通过加密防止静态分析（WindTail）

1.  列表 7-8：使用 `lsof` 揭示命令与控制服务器的地址（Mokes）

1.  列表 7-9：使用 `tcpdump` 观察下载（InstallCore）

1.  列表 8-1：加密数据（Mami）

1.  列表 8-2：解密的配置数据（Mami）

1.  列表 8-3：启动调试会话

1.  列表 8-4：等待附加到一个进程（命名为恶意软件）

1.  列表 8-5：进程附加，通过 `--waitfor` 标志触发

1.  列表 8-6：在程序的 `main` 函数上设置断点

1.  列表 8-7：断点命中；执行暂停

1.  列表 8-8：按地址设置断点

1.  列表 8-9：在 `installPayload` 方法上设置断点（FinFisher）

1.  列表 8-10：设置条件断点

1.  列表 8-11：添加断点命令

1.  列表 8-12：打印字典对象（Mami）

1.  列表 8-13：修改指令指针

1.  列表 8-14：修改寄存器

1.  列表 8-15：通过调试器脚本设置断点

1.  列表 8-16：通过调试器脚本实现断点动作

1.  列表 8-17：我们的调试器脚本在运行中

1.  列表 8-18：App Store 应用中的加密货币挖矿逻辑？

1.  列表 8-19：初始化调试会话并设置初始断点

1.  列表 8-20：断点触发；执行暂停

1.  列表 8-21：逐步执行指令并跨越方法调用

1.  列表 8-22：逐步执行指令，直到达到感兴趣的调用

1.  列表 8-23：显示 `startMiningWithPort:`... 方法的参数

1.  列表 8-24：显示包含加密货币挖矿账户信息和统计数据的网络对象

1.  列表 9-1：基本的字符串混淆（Dacls）

1.  列表 9-2：去混淆的字符串（Dacls）

1.  列表 9-3：命令与控制服务器的解密（WindTail）

1.  列表 9-4：解密后的命令与控制地址（WindTail）

1.  列表 9-5：混淆的字符串（WindTail）

1.  列表 9-6：转储现在解密的配置参数（NetWire）

1.  列表 9-7：可能的字符串去混淆（WindTail）

1.  列表 9-8：`yoop:` 方法（WindTail）

1.  列表 9-9：加密字符串，调用可能的字符串解密函数（DoubleFantasy）

1.  列表 9-10：一个简单的字符串解密算法（DoubleFantasy）

1.  列表 9-11：DoubleFantasy 字符串解密算法的 Python 重实现

1.  列表 9-12：利用 Hopper API 解密嵌入的字符串（DoubleFantasy）

1.  列表 9-13：反汇编，现在标注了解密的字符串（DoubleFantasy）

1.  列表 9-14：混淆的字符串（EvilQuest）

1.  列表 9-15：调用去混淆函数 `ei_str`（EvilQuest）

1.  列表 9-16：我们的动态字符串去混淆库（EvilQuest）

1.  列表 9-17：去混淆的字符串（EvilQuest）

1.  列表 9-18：虚假的函数调用（Pirrit）

1.  列表 9-19：虚假的指令（Pirrit）

1.  列表 9-20：通过 UPX 解包（ColdRoot）

1.  列表 9-21：加密的安装程序；注意 `flags` 字段设置为 `0x8`，`SG_PROTECTED_VERSION_1`（HackingTeam）

1.  列表 9-22：macOS 对加密 Mach-O 二进制文件的支持

1.  清单 9-23：混淆的反虚拟机逻辑 (MacRansom)

1.  清单 9-24：去混淆的反虚拟机命令 (MacRansom)

1.  清单 9-25：系统的硬件模型（在虚拟机中）

1.  清单 9-26：系统的硬件模型（在本地硬件上）

1.  清单 9-27：检索主要 MAC 地址 (Mughthesec)

1.  清单 9-28：检索系统完整性保护状态 (Pirrit)

1.  清单 9-29：基础防火墙检测 (Proton)

1.  清单 9-30：调试器检测（通过 `P_TRACED` 标志）

1.  清单 9-31：调试器检测 (Komplex)

1.  清单 9-32：由于 `ptrace` 和 `PT_DENY_ATTACH` 标志导致的过早退出 (Proton)

1.  清单 9-33：通过 `ptrace` 和 `PT_DENY_ATTACH` 混淆的反调试器逻辑 (Proton)

1.  清单 9-34：反分析函数？ (EvilQuest)

1.  清单 9-35：反调试逻辑 (EvilQuest)

1.  清单 9-36：反分析逻辑，现在已经被 `nop` 取代 (KeRanger)

1.  清单 9-37：跳过反调试器逻辑 (EvilQuest)

1.  清单 9-38：修改寄存器值以绕过反调试逻辑

1.  清单 10-1：列出挂载的磁盘映像内容

1.  清单 10-2：检查软件包的签名

1.  清单 10-3：*混合* *在* *Key 8.pkg* 的安装后脚本

1.  清单 10-4：监控恶意安装后脚本的行为

1.  清单 10-5：提取嵌入的字符串

1.  清单 10-6：提取嵌入的名称（API 调用、函数等）

1.  清单 10-7：反沙盒检查，通过时间检查

1.  清单 10-8：反调试逻辑的开始，使用 `sysctl` API

1.  清单 10-9：`P_TRACED` 标志（`0x800`）是否设置？如果设置，表示该进程正在被调试。

1.  清单 10-10：使用 `sysctl` 和 `P_TRACED` 的反调试逻辑

1.  清单 10-11：如果检测到调试器，则过早退出

1.  清单 10-12：通过 `ptrace` API 实现反调试逻辑

1.  清单 10-13：通过断点命令绕过反调试逻辑

1.  清单 10-14：混淆字符串，传递给 `ei_str` 函数

1.  清单 10-15：`ei_str` 函数，反编译后

1.  清单 10-16：解密所有 EvilQuest 嵌入的字符串

1.  清单 11-1：`ei_persistence_main`，反编译后

1.  清单 11-2：通过 `sysctl` API 进行进程枚举

1.  清单 11-3：EvilQuest 的“非预期”程序

1.  列表 11-4: 恶意进程终止

1.  列表 11-5: 调试器中观察到的恶意进程终止

1.  列表 11-6: 恶意软件复制操作的开始，在 FileMonitor 中看到

1.  列表 11-7: 哈希值确认复制文件完全相同

1.  列表 11-8: 传递给 `install_daemon` 函数的参数

1.  列表 11-9: （解密后的）启动项属性列表模板

1.  列表 11-10: 恶意软件的启动代理 plist (*~**/Library/LaunchAgents/com.apple.questd.plist*)

1.  列表 11-11: 恶意软件的启动守护进程 plist (*/Library/LaunchDaemons/com.apple.questd.plist*)

1.  列表 11-12: 恶意软件作为启动守护进程和代理同时运行

1.  列表 11-13: 被调用两次的 `run_daemon` 函数

1.  列表 11-14: 传递给 `run_daemon` 函数的参数

1.  列表 11-15: 构造启动项属性列表的路径

1.  列表 11-16: 观察 `AppleScript` 启动启动项

1.  列表 11-17: “重要” 文件

1.  列表 11-18: 观察持久化逻辑

1.  列表 11-19: 创建后台线程

1.  列表 11-20: `ei_loader_thread` 函数

1.  列表 11-21: `is_executable` 函数的核心逻辑

1.  列表 11-22: 读取候选文件的开始部分

1.  列表 11-23: 计算候选文件的大小

1.  列表 11-24: 检查 Mach-O 常量

1.  列表 11-25: 检查文件的 Mach-O 类型

1.  列表 11-26: 传递给 `append_ei` 函数的参数

1.  列表 11-27: 检查候选文件的可访问性

1.  列表 11-28: 恶意软件将自身读取到内存中

1.  列表 11-29: 将目标二进制文件读入内存

1.  列表 11-30: 检查目标文件是否已感染

1.  列表 11-31: 将恶意软件和目标文件写入磁盘

1.  列表 11-32: 将尾部数据写入磁盘

1.  列表 11-33: 被感染文件的十六进制转储

1.  列表 11-34: 检查尾部数据

1.  列表 11-35: 恶意软件重新保存、持久化并重新启动自己

1.  列表 11-36: `persist_executable_frombundle` 函数的参数

1.  列表 11-37: 观察恶意启动代理二进制文件和 plist 的重建

1.  列表 11-38：观察重新启动的重新持久化恶意软件

1.  列表 11-39：执行一个干净实例的感染二进制文件，确保没有异常

1.  列表 11-40：观察感染二进制文件的干净实例执行

1.  列表 11-41：参数初始化和调用 `get_mediator` 函数

1.  列表 11-42：备份命令与控制服务器的回退逻辑

1.  列表 11-43：`ei_get_host_info` 调查逻辑

1.  列表 11-44：转储调查结果

1.  列表 11-45：也许是收到命令的缓存？

1.  列表 11-46：调用 `react_exec` 函数

1.  列表 11-47：`ei_run_memory_hrd` 在内存中的编码执行逻辑

1.  列表 11-48：恶意软件代码中的一个 bug

1.  列表 11-49：`react_save` 函数的核心逻辑

1.  列表 11-50：`react_start` 函数未实现

1.  列表 11-51：键盘记录器逻辑，位于 `eilf_rglk_watch_routine` 函数中

1.  列表 11-52：`CGEventTapCreate` 函数的回调参数

1.  列表 11-53：键盘记录器的回调函数 `process_event`

1.  列表 11-54：`react_ping` 函数的核心逻辑

1.  列表 11-55：`react_scmd` 函数的核心逻辑

1.  列表 11-56：通过后台线程执行 `ei_forensic_thread` 函数

1.  列表 11-57：调用 `lfsc_dirlist` 函数

1.  列表 11-58：生成的（递归）目录列表

1.  列表 11-59：`is_lfsc_target` 函数的核心逻辑

1.  列表 11-60：“感兴趣”文件的加密列表

1.  列表 11-61：“感兴趣”文件的解密列表

1.  列表 11-62：通过 `ei_forensic_sendfile` 函数进行文件外泄

1.  列表 11-63：通过调试器观察文件外泄逻辑

1.  列表 11-64：计时器检查后，调用 `ei_carver_main` 函数

1.  列表 11-65：加密（勒索）目标文件

1.  列表 11-66：混淆的函数名称

1.  列表 11-67：新增的反调试逻辑

1.  列表 11-68：附加的“非必要”程序，现在包括我自己的 ReiKey 和 KnockKnock

1.  列表 11-69：更新后的持久化路径

## 指南

1.  封面

1.  前言部分

1.  献辞

1.  前言

1.  简介

1.  开始阅读

1.  索引

## 页面

1.  iii

1.  iv

1.  v

1.  vii

1.  xvii

1.  xviii

1.  xix

1.  xx

1.  xxi

1.  xxii

1.  xxiii

1.  xxiv

1.  xxv

1.  xxvi

1.  xxvii

1.  xxviii

1.  xxix

1.  1

1.  3

1.  4

1.  5

1.  6

1.  7

1.  8

1.  9

1.  10

1.  11

1.  12

1.  13

1.  14

1.  15

1.  16

1.  17

1.  18

1.  19

1.  20

1.  21

1.  22

1.  23

1.  24

1.  25

1.  26

1.  27

1.  28

1.  29

1.  30

1.  31

1.  32

1.  33

1.  34

1.  35

1.  36

1.  37

1.  38

1.  39

1.  40

1.  41

1.  42

1.  43

1.  44

1.  45

1.  46

1.  47

1.  48

1.  49

1.  50

1.  51

1.  52

1.  53

1.  54

1.  55

1.  56

1.  57

1.  58

1.  59

1.  60

1.  61

1.  62

1.  63

1.  64

1.  65

1.  66

1.  67

1.  69

1.  70

1.  71

1.  72

1.  73

1.  74

1.  75

1.  76

1.  77

1.  78

1.  79

1.  80

1.  81

1.  82

1.  83

1.  84

1.  85

1.  86

1.  87

1.  88

1.  89

1.  90

1.  91

1.  92

1.  93

1.  94

1.  95

1.  96

1.  97

1.  99

1.  100

1.  101

1.  102

1.  103

1.  104

1.  105

1.  106

1.  107

1.  108

1.  109

1.  110

1.  111

1.  112

1.  113

1.  114

1.  115

1.  116

1.  117

1.  118

1.  119

1.  120

1.  121

1.  122

1.  123

1.  125

1.  126

1.  127

1.  128

1.  129

1.  130

1.  131

1.  132

1.  133

1.  134

1.  135

1.  136

1.  137

1.  138

1.  139

1.  140

1.  141

1.  142

1.  143

1.  144

1.  145

1.  146

1.  147

1.  149

1.  150

1.  151

1.  152

1.  153

1.  154

1.  155

1.  156

1.  157

1.  158

1.  159

1.  160

1.  161

1.  162

1.  163

1.  165

1.  166

1.  167

1.  168

1.  169

1.  170

1.  171

1.  172

1.  173

1.  174

1.  175

1.  176

1.  177

1.  178

1.  179

1.  180

1.  181

1.  182

1.  183

1.  184

1.  185

1.  187

1.  188

1.  189

1.  190

1.  191

1.  192

1.  193

1.  194

1.  195

1.  196

1.  197

1.  198

1.  199

1.  200

1.  201

1.  202

1.  203

1.  204

1.  205

1.  206

1.  207

1.  208

1.  209

1.  210

1.  211

1.  212

1.  213

1.  214

1.  215

1.  216

1.  217

1.  218

1.  219

1.  221

1.  222

1.  223

1.  224

1.  225

1.  226

1.  227

1.  228

1.  229

1.  230

1.  231

1.  232

1.  233

1.  234

1.  235

1.  236

1.  237

1.  238

1.  239

1.  240

1.  241

1.  242

1.  243

1.  244

1.  245

1.  246

1.  247

1.  248

1.  249

1.  250

1.  251

1.  252

1.  253

1.  254

1.  255

1.  256

1.  257

1.  258

1.  259

1.  260

1.  261

1.  262

1.  263

1.  264

1.  265

1.  266

1.  267

1.  268

1.  269

1.  270

1.  271

1.  272

1.  273

1.  274

1.  275

1.  276

1.  277

1.  278

1.  279

1.  280

1.  281

1.  282

1.  283

1.  284

1.  285

1.  286

1.  287

1.  288

1.  289

1.  290

1.  291

1.  292

1.  293

1.  294
