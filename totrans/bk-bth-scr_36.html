<html><head></head><body>
<div id="sbo-rt-content" class="calibre1"><section aria-labelledby="ch33" epub:type="chapter" role="doc-chapter">
<hgroup>
<h2 class="title" id="ch33">
<span class="cn"><span aria-label=" Page 409. " epub:type="pagebreak" id="pg_409" role="doc-pagebreak" class="calibre2"/><span class="sans_dogma_ot_bold_b_">33</span></span>
<span class="ct1"><span class="sans_dogma_ot_bold_b_">STACKS, QUEUES, AND REAL-WORLD OBJECTS</span></span>
</h2>
</hgroup>
<figure class="opener"><img alt="" class="opener1" height="407" src="../images/chapter.jpg" width="408"/>
</figure>
<p class="chapterintro">In this chapter, I’ll build two more Batch data structures from scratch: stacks and queues. Both hold a finite set of ordered values, with the only difference being that stacks fit the last-in-first-out paradigm, while queues are first-in-first-out. I’ll detail both data structures in general and demonstrate how to build their unique functionalities. And of course, you’ll learn applications of these new tools, even a Batch pseudo-compiler of other bat files.</p>
<p class="tx">However, this chapter is as much about real-world Batch objects as it’s about stacks and queues. I’ll also use what you learned in the previous chapter to construct object bat files for each data structure. The objects will allow you to maintain multiple stacks or queues simultaneously, and they’ll <span aria-label=" Page 410. " epub:type="pagebreak" id="pg_410" role="doc-pagebreak"/>ideally inspire future real-world Batch objects of your own. I’ll even finish up with final thoughts on Batch object-oriented design.</p>
<section aria-labelledby="sec1" epub:type="division">
<h3 class="h" id="sec1"><span id="h1-222"/><span class="sans_futura_std_bold_b_">Stacks</span></h3>
<p class="tni">A <i class="calibre6">stack</i> is a data structure containing an ordered list of data items, organized as <i class="calibre6">last-in-first-out (LIFO)</i>. Undoubtedly, the best metaphor for a stack is a spring-loaded cafeteria plate dispenser. The weight of each plate pushes down a spring at the base of the dispenser so that only the top plate in the stack is available. Add more plates and the stack drops down so that only what’s now the top plate is poking up. The first plate added is at the bottom of the stack, and the first one retrieved is the last one added to the top of the stack. You can’t access a plate lower on the stack without first removing the plates above it, one by one. Take that top plate and the stack rises the height of a single plate, exposing the one that was just underneath it, while protecting the rest from the clumsy and possibly unhygienic hoi polloi.</p>
<p class="tx">Similarly, you can add or <i class="calibre6">push</i> a data item onto a stack, followed by more data items. At any point, you can retrieve or <i class="calibre6">pop</i> the data item at the top of the stack—that is, get the item added most recently. Most object-oriented languages come with a built-in stack data structure with methods for pushing an item onto the stack, popping the last item, and peeking at the last added item without actually removing it. There should also be methods to clear the stack and to determine whether the stack is empty.</p>
<p class="tx">Batch has no such built-in data structure, but if you’re still with me in this final chapter, I’ll assume that you also enjoy the challenge of creating atypical Batch functionality. The underlying structure of the stack in Batch is merely a single variable. To push the first value onto a stack, we’ll simply assign it to the stack variable. Then we’ll push subsequent items onto the stack by prepending to that variable, pushing the existing items down the stack.</p>
<p class="tx">To execute a pop request, we’ll extract the leading item in the variable from the contents of the variable, leaving the rest. A peek request will be similar, except we’ll leave the stack undisturbed. To make this work, we’ll need a delimiter between each item guaranteed not to be in the data. Spaces, pipes, and commas are good options, depending on the expected data, but my preference is the tab character. If it’s possible that your data might have tabs, you should choose something else as the delimiter; it can even be a variable itself set by the user.</p>
<p class="tx">To demonstrate the different pieces of functionality needed to implement a stack, I’ll construct and use a stack of friends. The first task is to come up with a variable name; any will do, but I’ll use the <span class="sans_thesansmonocd_w5regular_">stkFriends</span> variable. My convention is to prepend the name of the stack with <span class="sans_thesansmonocd_w5regular_">stk</span>, making it clear to anyone that stumbles across it (who also happens to know this convention) that the variable is the manifestation of a stack. In short order, I’ll bring all of this functionality into an object, but first I’ll step through the methodology for the push, pop, and peek functions.</p>
<p class="listhead"><span aria-label=" Page 411. " epub:type="pagebreak" id="pg_411" role="doc-pagebreak"/><b class="calibre10">Push</b></p>
<p class="listplainfirst">The logical place to start is with the <i class="calibre6">push</i>, and this solitary <span class="sans_thesansmonocd_w5regular_">set</span> command is all you need to push <span class="sans_thesansmonocd_w5regular_">Walter</span> onto the stack:</p>
<pre class="list"><code class="calibre11"><span class="sans_thesansmonocd_w5regular_">set stkFriends=Walter</span><span class="sans_thesansmonocd_w5regular_">▶</span><span class="sans_thesansmonocd_w5regular_">%stkFriends%</span>
</code></pre>
<p class="listcontinued1">Here, as well as in future listings, I’m using a solid arrow to represent the tab character. By default, it is indistinguishable from one or more spaces in most editors, but if using Notepad++, you can show tab characters as arrows by selecting <b class="calibre10">View</b><span class="sans_thesansmonocd_w5regular_"> ▶ </span><b class="calibre10">Show Symbol</b><span class="sans_thesansmonocd_w5regular_"> ▶ </span><b class="calibre10">Show Space and Tab</b>. (Other editors have a similar feature, and if you’ve gotten this far into the book using Notepad, you are clearly a glutton for punishment.)</p>
<p class="listbody">I’m using the <span class="sans_thesansmonocd_w5regular_">stkFriends</span> variable twice in the command, assigning it to itself, resolved with percent signs and prepended with the item I’m adding, <span class="sans_thesansmonocd_w5regular_">Walter</span>, and the delimiter, a tab character. This has, in effect, added the value to the top of the stack. Instead of the hardcoded data item, you can easily use a resolved variable in its place for the friend being added.</p>
<p class="listbody">If the stack is already empty, this command populates it with its first value, followed by a tab and nothing else.</p>
<p class="listhead"><b class="calibre10">Peek</b></p>
<p class="listplainfirst">The <i class="calibre6">peek</i> function finds the item on the top of the stack without altering the stack. It just takes a peek, without popping. We don’t know how many values are on the stack, if any at all, but we do know that if <span class="sans_thesansmonocd_w5regular_">stkFriends</span> is populated, its first tab-delimited value is at the top of the stack.</p>
<p class="listbody">The following code populates <span class="sans_thesansmonocd_w5regular_">aFriend</span> with whatever’s on top of the stack:</p>
<pre class="list"><code class="calibre11"><span class="sans_thesansmonocd_w5regular_">set aFriend=&amp;</span>
for /F "delims=<span class="sans_thesansmonocd_w5regular_">▶</span>" %%s in ("%stkFriends%") do (
   set aFriend=%%s
)
</code></pre>
<p class="listbody">The parsing of delimited data is clearly a job for the <span class="sans_thesansmonocd_w5regular_">for /F</span> command. I’m using the stack variable as text input, and since we’ve delimited the variable by tabs, I’m setting the <span class="sans_thesansmonocd_w5regular_">delims</span> keyword to a tab. The <span class="sans_thesansmonocd_w5regular_">tokens=1</span> clause is implied, meaning that the <span class="sans_thesansmonocd_w5regular_">for</span> variable defined as <span class="sans_thesansmonocd_w5regular_">%%s</span> resolves to the first token in the string, and since that first token is the last item placed onto the stack, we’ll simply capture it as <span class="sans_thesansmonocd_w5regular_">aFriend</span>.</p>
<p class="listbody">Also notice that I’m wiping out the <span class="sans_thesansmonocd_w5regular_">aFriend</span> variable prior to the <span class="sans_thesansmonocd_w5regular_">for</span> command. If the stack is empty, the <span class="sans_thesansmonocd_w5regular_">for /F</span> command doesn’t execute, so initializing the variable ensures that an empty stack returns a null value.</p>
<p class="listhead"><span aria-label=" Page 412. " epub:type="pagebreak" id="pg_412" role="doc-pagebreak"/><b class="calibre10">Pop</b></p>
<p class="listplain">The <i class="calibre6">pop</i> function is remarkably similar to the peek function with one significant difference; it also removes the returned data item from the top of the stack. Notice that the logic for this task mimics the previous listing with two additions: the <span class="sans_thesansmonocd_w5regular_">tokens</span> clause and the final <span class="sans_thesansmonocd_w5regular_">set</span> command:</p>
<pre class="list"><code class="calibre11"><span class="sans_thesansmonocd_w5regular_">set aFriend=&amp;</span>
for /F "tokens=1* delims=<span class="sans_thesansmonocd_w5regular_">▶</span>" %%s in ("%stkFriends%") do (
   set aFriend=%%s
   set stkFriends=%%t
)
</code></pre>
<p class="listbody">Instead of using the implied <span class="sans_thesansmonocd_w5regular_">tokens</span> clause, I’m setting the keyword to <span class="sans_thesansmonocd_w5regular_">1*</span>. This has no impact on the <span class="sans_thesansmonocd_w5regular_">for</span> variable, <span class="sans_thesansmonocd_w5regular_">%%s</span>, itself. It still resolves to the top item on the stack, but now the interpreter assigns the remainder of the text field to the second token, <span class="sans_thesansmonocd_w5regular_">%%t</span>. Since the rest of the text field is the entire stack minus the first item, I’m simply reassigning the abbreviated stack to the stack variable with the last <span class="sans_thesansmonocd_w5regular_">set</span> command. The entire process is analogous to breaking one square off the end of a chocolate bar and pushing the rest of the bar back into the wrapper.</p>
</section>
<section aria-labelledby="sec2" epub:type="division">
<h3 class="h" id="sec2"><span id="h1-223"/><span class="sans_futura_std_bold_b_">Queues</span></h3>
<p class="tni">Stacks and queues go together like chocolate and peanut butter. At its core, a <i class="calibre6">queue</i> is the <i class="calibre6">first-in-first-out (FIFO)</i> version of a stack. (This is the same as last-in-last-out, but LILO has never caught on.) The metaphor for a stack took us to a cafeteria, but the metaphor for a queue takes us to a restaurant. If you’re the first to show up without a reservation at a busy time, the host staff will likely put your name at the top of a list. They’ll add others to the list, and when a table frees up, you’ll be sat first from the list. Each of the others on this list will move up and continue to wait their turn in order.</p>
<p class="tx">Here’s a truly horrible business idea. I’ll open a pancake restaurant, call it Stacks, and use a stack for those waiting for a table. The group that arrives just as we get busy is first onto the stack, where they’ll wait, perhaps patiently, as others are added to and removed from the stack (that is, sat). Even if there are 20 groups on the stack, the people who just showed up get the next table. Obviously, this is a far better application for a queue.</p>
<p class="tx">Implementing a queue in Batch is almost identical to implementing a stack. The one significant difference is that when adding a data item to the queue, you’ll want to append it to the end of the variable instead of prepending it:</p>
<pre class="pre"><code class="calibre11">set queFriends=%queFriends%<span class="sans_thesansmonocd_w5regular_">▶</span>Walter</code></pre>
<p class="tx"><span aria-label=" Page 413. " epub:type="pagebreak" id="pg_413" role="doc-pagebreak"/>There are also a couple of differences in nomenclature. First, because the variable represents a queue, I’ve changed its leading text from <span class="sans_thesansmonocd_w5regular_">stk</span> to <span class="sans_thesansmonocd_w5regular_">que</span>, but again, this is just one convention. Second, the terms <i class="calibre6">push</i> and <i class="calibre6">pop</i> make sense only when thinking about a stack, such as a plate dispenser. When adding and removing values from a queue, I’ll instead use the pedestrian yet accurate terms <i class="calibre6">add</i> and <i class="calibre6">remove</i>, respectively.</p>
<p class="tx">Everything else is the same between the two data structures. Notice that the previous <span class="sans_thesansmonocd_w5regular_">set</span> command also uses the tab delimiter. The add and remove functions are respectively identical to the push and pop functions, other than the variable name, since both target the first delimited data item in the variable. In fact, they are so similar I’ll hold off showing you these functions until I build the queue object.</p>
<p class="warning"><span class="sans_dogma_ot_bold_b_1">WARNING</span></p>
<p class="warning-txt"><i class="calibre6">We live in a finite world, and just as the cafeteria plate dispenser can accept only so many plates, Batch has a limitation pertinent to stacks and queues. A single variable can’t exceed 32,767 bytes, and since this design of stacks and queues relies on a single variable holding the entire data structure, the cumulative size of all data items and delimiters in a stack or queue can’t cross this threshold. For instance, you can store 16,383 one-byte values or 1,927 sixteen-byte values. For most applications, this is sufficient, but if it isn’t, you can instead build these data structures with an array and a pointer to keep track of the pertinent index.</i></p>
</section>
<section aria-labelledby="sec3" epub:type="division">
<h3 class="h" id="sec3"><span id="h1-224"/><span class="sans_futura_std_bold_b_">Real-World Batch Objects</span></h3>
<p class="tni">In <span class="xref"><a href="chapter32.xhtml" class="calibre3">Chapter 32</a></span>, I explored Batch object-oriented design. I detailed a model that implemented every possible piece of functionality involving the four pillars of OOP, but in truth, that model isn’t representative of typical object bat files. Fortunately, the stack and queue offer instructive real-world examples of Batch objects.</p>
<section aria-labelledby="sec4" epub:type="division">
<h4 class="h1" id="sec4"><span id="h2-115"/><span class="sans_futura_std_heavy_oblique_bi_">The Stack Object</span></h4>
<p class="tni">I’ll show the stack object bat file, <i class="calibre6">oStack.bat</i>, in two parts, starting with the comments and mainline logic:</p>
<pre class="pre"><code class="calibre11">rem ****** Stack Object ******
rem parm 1 – Name of Stack 
rem parm 2 - Method: Push, Pop, Peek, Clear, or IsEmpty
rem parm 3 - Input/Output Variable:
rem            Value Pushed, Variable Popped, or Variable Peeked
rem            Boolean for isEmpty

  cmd /C exit 0
  call :%~2 "%~1" "%~3" || (
    &gt; C:\Batch\Log.txt echo ** ERROR - Invalid Method Name "%~2"
     exit
  )
  goto :eof
</code></pre>
<p class="tx"><span aria-label=" Page 414. " epub:type="pagebreak" id="pg_414" role="doc-pagebreak"/>The most striking difference between this code and the objects from the prior chapter is that I’ve replaced the “traffic cop” hiding private methods with a <span class="sans_thesansmonocd_w5regular_">call</span> command exposing all the methods as public.</p>
<p class="tx">In <span class="xref"><a href="chapter32.xhtml" class="calibre3">Chapter 32</a></span>, all object bat files had a <span class="sans_thesansmonocd_w5regular_">for</span> command containing the list of public methods, but the <i class="calibre6">oStack.bat</i> object bat file has only public methods. As a result, instead of maintaining a list, the <span class="sans_thesansmonocd_w5regular_">call</span> command directs the execution to the appropriate method, thus making all of the methods public. Since the second parameter is the name of the method to be called, I’m stripping it of possible double quotes and prepending it with a colon to create the name of the called label: <span class="sans_thesansmonocd_w5regular_">:%~2</span>.</p>
<p class="tx">The name of the stack is the first parameter coming into the bat file and also the first argument I pass to each of the methods. The second argument passed to each method is the third input parameter, and it has different uses dependent on the method. But instead of discussing this here, maybe I should instead just point you to the comments at the top of the bat file clearly delineating the parameters accepted by the object and its public methods.</p>
<p class="tx">The two pipes and the code block following the <span class="sans_thesansmonocd_w5regular_">call</span> command is a real-world application of conditional execution. (In <span class="xref"><a href="chapter28.xhtml" class="calibre3">Chapter 28</a></span>, I provided a detailed example of this technique, including why the <span class="sans_thesansmonocd_w5regular_">cmd</span> command at the top of the bat file is resetting the return code to <span class="sans_thesansmonocd_w5regular_">0</span>.) The upshot is that if the object receives a valid method, it invokes that method successfully, and if the parameter is an invalid method name, this logic writes the error message to <i class="calibre6">Log.txt</i> and ends the execution. Thus, all methods are public.</p>
<p class="tx">What happens if we don’t have this conditional execution and error handling? It works perfectly fine if every call to the bat file passes a valid method name. However, if for the first argument someone errantly passes the homophone for <span class="sans_thesansmonocd_w5regular_">Peek</span> referring to a mountaintop, the interpreter writes the following to stderr, and the execution continues unabated:</p>
<pre class="pre"><code class="calibre11">The system cannot find the batch label specified - Peak</code></pre>
<p class="tx">The interpreter neither finds nor calls the method, nor does it set the return variable, if applicable, resulting in unpredictable downstream results. Something like this deserves a hard abort to pique our attention, and that’s exactly what the conditional execution and rudimentary error handling is accomplishing.</p>
<p class="tx">Here’s the remainder of <i class="calibre6">oStack.bat</i> and its public methods mentioned in the prior comments:</p>
<pre class="pre"><code class="calibre11">:Push
 set stk%~1=%~2<span class="sans_thesansmonocd_w5regular_">▶</span>!stk%~1!
 goto :eof&amp; rem End :Push

<span aria-label=" Page 415. " epub:type="pagebreak" id="pg_415" role="doc-pagebreak"/>:Pop
 set %~2=&amp;
 for /F "tokens=1* delims=<span class="sans_thesansmonocd_w5regular_">▶</span>" %%s in ("!stk%~1!") do (
    set %~2=%%s
    set stk%~1=%%t
 )
 goto :eof&amp; rem End :Pop

:Peek
 set %~2=&amp;
 for /F "delims=<span class="sans_thesansmonocd_w5regular_">▶</span>" %%s in ("!stk%~1!") do (
    set %~2=%%s
 )
 goto :eof&amp; rem End :Peek

:Clear
 set stk%~1=&amp;
 goto :eof&amp; rem End :Clear

:IsEmpty
 if defined stk%~1 (
    set %~2=false==x
 ) else (
    set %~2=true==true
 )
 goto :eof&amp; rem End: IsEmpty
</code></pre>
<p class="tx">I’ve already discussed the mechanism for the push, pop, and peek functionality in the “<span class="xref">Stacks</span>” section, and in this object, you’ll find the polymorphic version for each under the appropriately named label. For instance, the <span class="sans_thesansmonocd_w5regular_">:Push</span> method sets the <span class="sans_thesansmonocd_w5regular_">stk%~1</span> variable in lieu of <span class="sans_thesansmonocd_w5regular_">stkFriends</span>. For this object to work with multiple stacks, it can’t explicitly reference a particular stack variable. Instead, it builds the name of the stack by resolving the first parameter and prepending it with the <span class="sans_thesansmonocd_w5regular_">stk</span> text before setting it to the concatenation of <span class="sans_thesansmonocd_w5regular_">%~2</span>, a tab character, and <span class="sans_thesansmonocd_w5regular_">!stk%~1!</span>. The second parameter is the value being pushed onto the stack, and the tab character is the delimiter. This command uses the <span class="sans_thesansmonocd_w5regular_">stk%~1</span> variable a second time to retrieve the existing values on the stack, resolving the variable with exclamation marks and delayed expansion. Ultimately, this pushes the second parameter onto the stack.</p>
<p class="tx">The <span class="sans_thesansmonocd_w5regular_">:Pop</span> and <span class="sans_thesansmonocd_w5regular_">:Peek</span> methods also make use of <span class="sans_thesansmonocd_w5regular_">stk%~1</span> for setting and/or resolving the stack. The only other new feature in these methods is that I’m setting <span class="sans_thesansmonocd_w5regular_">%~2</span> to the return value because the second parameter for both methods is the name of the variable being returned.</p>
<p class="tx">For this to be a proper stack object, it must provide two more methods typical of this data structure in other languages. The first accepts the name of the stack as its only parameter and clears all data items from it. To complete the task, the <span class="sans_thesansmonocd_w5regular_">:Clear</span> method simply sets <span class="sans_thesansmonocd_w5regular_">stk%~1</span> to nothing.</p>
<p class="tx">The other method returns a boolean that evaluates to true if the stack is empty or to false if anything is on the stack. The <span class="sans_thesansmonocd_w5regular_">:IsEmpty</span> method determines if <span class="sans_thesansmonocd_w5regular_">stk%~1</span> is defined. Depending on the result, it sets the second parameter to either true or false.</p>
<p class="tx"><span aria-label=" Page 416. " epub:type="pagebreak" id="pg_416" role="doc-pagebreak"/>Now we’re ready to use the stack object. These four calls add three friends to a new stack, with <span class="sans_thesansmonocd_w5regular_">Marty</span> being the last in:</p>
<pre class="pre"><code class="calibre11">set stack=C:\Batch\oStack.bat
call %stack% Friends clear
call %stack% Friends push Walter
call %stack% Friends push Donny
call %stack% Friends push Marty
</code></pre>
<p class="tni">The first call is probably unnecessary, but in the off chance that the <span class="sans_thesansmonocd_w5regular_">stkFriends</span> variable is defined, this initializes it. You can think of it as a constructor even though this design doesn’t have one.</p>
<p class="tx">Execute this multiple times, and the <span class="sans_thesansmonocd_w5regular_">aFriend</span> variable will come back as <span class="sans_thesansmonocd_w5regular_">Marty</span> every time because it peeks only at the data item:</p>
<pre class="pre"><code class="calibre11">call %stack% Friends peek aFriend</code></pre>
<p class="tx">This also returns <span class="sans_thesansmonocd_w5regular_">Marty</span> when called, but only once:</p>
<pre class="pre"><code class="calibre11">call %stack% Friends pop aFriend</code></pre>
<p class="tni">The next <span class="sans_thesansmonocd_w5regular_">pop</span> invocation returns <span class="sans_thesansmonocd_w5regular_">Donny</span>, the value placed on the stack just before <span class="sans_thesansmonocd_w5regular_">Marty</span>.</p>
<p class="tx">Now only <span class="sans_thesansmonocd_w5regular_">Walter</span> remains on the stack. You can add two more friends, but <span class="sans_thesansmonocd_w5regular_">Walter</span> remains in the bottom position:</p>
<pre class="pre"><code class="calibre11">call %stack% Friends push "The Stranger"
call %stack% Friends push Maude
</code></pre>
<p class="tni">Remember that arguments with embedded spaces need to be encased in double quotes and that <i class="calibre6">oStack.bat</i> handles them deftly with the use of tildes.</p>
<p class="tx">The <span class="sans_thesansmonocd_w5regular_">isEmpty</span> call returns a boolean variable:</p>
<pre class="pre"><code class="calibre11">call %stack% Friends isEmpty bool
if %bool% (&gt; con echo Empty) else (&gt; con echo NOT Empty)
</code></pre>
<p class="tni">The <span class="sans_thesansmonocd_w5regular_">bool</span> variable resolves as false since there are three items on the stack, and this logic writes <span class="sans_thesansmonocd_w5regular_">NOT Empty</span> to the console.</p>
<p class="tx">Lastly, to start from scratch, we can empty the stack of all its data items:</p>
<pre class="pre"><code class="calibre11">call %stack% Friends clear</code></pre>
<p class="tx">Call the object again to invoke the <span class="sans_thesansmonocd_w5regular_">isEmpty</span> method, and it returns the boolean set to true.</p>
</section>
<section aria-labelledby="sec5" epub:type="division">
<h4 class="h1" id="sec5"><span id="h2-116"/><span class="sans_futura_std_heavy_oblique_bi_">The Queue Object</span></h4>
<p class="tni">Since stacks and queues are so similar, I’m modeling the queue object on the stack object. But still, notice the many subtle differences and just one <span aria-label=" Page 417. " epub:type="pagebreak" id="pg_417" role="doc-pagebreak"/>significant difference as you examine the complete contents of the stack object bat file, <i class="calibre6">oQueue.bat</i>:</p>
<pre class="pre"><code class="calibre11">rem ****** Queue Object ******
rem parm 1 - Name of Queue 
rem parm 2 - Method: Add, Remove, Peek, Clear, or IsEmpty
rem parm 3 - Input/Output Variable:
rem            Value Added, Variable Removed, or Variable Peeked
rem            Boolean for isEmpty

  cmd /C exit 0
  call :%~2 "%~1" "%~3" || (
     &gt;&gt; C:\Batch\Log.txt echo ** ERROR - Invalid Method Name "%~2"
     exit
  )
  goto :eof
  
 :Add
<span aria-label="annotation1" class="code_codeannotation">❶</span> set que%~1=!que%~1!<span class="sans_thesansmonocd_w5regular_">▶</span>%~2
  goto :eof&amp; rem End :Add
  
 :Remove
  set %~2=&amp;
  for /F "tokens=1* delims=<span class="sans_thesansmonocd_w5regular_">▶</span>" %%q in ("!que%~1!") do (
     set %~2=%%q
     set que%~1=%%r
  )
  goto :eof&amp; rem End :Remove
  
 :Peek
  set %~2=&amp;
  for /F "delims=<span class="sans_thesansmonocd_w5regular_">▶</span>" %%q in ("!que%~1!") do (
     set %~2=%%q
  )
  goto :eof&amp; rem End :Peek
  
 :Clear
  set que%~1=&amp;
  goto :eof&amp; rem End :Clear
  
 :IsEmpty
  if defined que%~1 (
     set %~2=false==x
  ) else (
     set %~2=true==true
  )
  goto :eof&amp; rem End: IsEmpty
</code></pre>
<p class="tx">I’ve changed the <span class="sans_thesansmonocd_w5regular_">stk</span> text leading the variable name to <span class="sans_thesansmonocd_w5regular_">que</span> for obvious reasons. The <span class="sans_thesansmonocd_w5regular_">:Push</span> and <span class="sans_thesansmonocd_w5regular_">:Pop</span> methods have given way to the <span class="sans_thesansmonocd_w5regular_">:Add</span> and <span class="sans_thesansmonocd_w5regular_">:Remove</span> methods, respectively, and the comments at the top of the object clearly reflect these changes. The significant alteration is in the <span class="sans_thesansmonocd_w5regular_">set</span> command <span aria-label="annotation1" class="codeannotation">❶</span> that adds a data item to the queue in the <span class="sans_thesansmonocd_w5regular_">:Add</span> method. It now adds the value <span aria-label=" Page 418. " epub:type="pagebreak" id="pg_418" role="doc-pagebreak"/>to the end of the line instead of the beginning, meaning that the first item in is the first item out.</p>
<p class="tx">A couple of the method names are different, but the execution of this object should look familiar. Here’s an example of five calls:</p>
<pre class="pre"><code class="calibre11">set queue=C:\Batch\oQueue.bat
call %queue% Friends clear
call %queue% Friends add Walter
call %queue% Friends add Donny
call %queue% Friends add Marty
call %queue% Friends peek aFriend
</code></pre>
<p class="tx">The last call returns <span class="sans_thesansmonocd_w5regular_">aFriend</span> populated with the value of <span class="sans_thesansmonocd_w5regular_">Walter</span>, the first data item added to the queue. Compare this to the stack object that returned <span class="sans_thesansmonocd_w5regular_">Marty</span> for a very similar call.</p>
</section>
</section>
<section aria-labelledby="sec6" epub:type="division">
<h3 class="h" id="sec6"><span id="h1-225"/><span class="sans_futura_std_bold_b_">Stack and Queue Applications</span></h3>
<p class="tni">You can find applications for the queue object wherever there’s a need to process data in order. You might create a queue to hold a list of server names retrieved from a source, perhaps one or more files. Then as you remove each server from the queue, you can perform a particular task on that server. The task might be as simple as verifying that it’s up and running, or it might involve the creation of directories or complex file movements. What’s important is that the queue allows you to take each server in order.</p>
<p class="tx">With interactive Batch, you might ask the user for a list of multiple inputs. Instead of retrieving one piece of data, processing it, and then asking for another, you can ask for all of the data up front as you add all of it to a queue. Then the bat file can process each data item in order without another question.</p>
<p class="tx">Stack applications aren’t always as obvious, but when you need one, it’s usually the only adequate tool for the job. You can use a stack to reverse the order of letters or words looking for palindromes. Recursion is another application of a stack. With each recursive call, the interpreter pushes the current state of all variables onto a stack. You don’t have direct access to this stack, but after making too many recursive calls, the interpreter reports that the recursion has exceeded “STACK limits” (<span class="xref"><a href="chapter23.xhtml" class="calibre3">Chapter 23</a></span>). That’s not a coincidence.</p>
<p class="tx">Using a stack, you can even create a pseudo-compiler for bat files or other uncompiled source code. I don’t want to oversell this; proper compilers perform a number of tasks, and while we can go a long way toward performing just one of those tasks (the balancing of brackets), it won’t be bullet-proof. The concept behind this pseudo-compiler is that an open parenthesis needs a matching close parenthesis, just as curly and square brackets must come in pairs. They can be deeply nested, but a square bracket can’t close a curly bracket.</p>
<p class="tx"><span aria-label=" Page 419. " epub:type="pagebreak" id="pg_419" role="doc-pagebreak"/>Here are the complete contents of <i class="calibre6">PseudoCompiler.bat</i>, a bat file that attempts to balance all sets of brackets in a bat file:</p>
<pre class="pre"><code class="calibre11">@setlocal EnableExtensions EnableDelayedExpansion
@echo off
set stack=C:\Batch\oStack.bat
call %stack% Compiler clear

<span aria-label="annotation1" class="codeannotationhang">❶</span> for /F "usebackq tokens=*" %%r in ("%~1") do (
   set rec=%%r
 <span aria-label="annotation2" class="code_codeannotation">❷</span> for /L %%i in (0,1,100) do (
      set byte=!rec:~%%i,1!
    <span aria-label="annotation3" class="code_codeannotation">❸</span> if .^!byte! neq .^" (
       <span aria-label="annotation4" class="code_codeannotation">❹</span> for %%c in ({[^() do (
            if "!byte!" equ "%%c" (
             <span aria-label="annotation5" class="code_codeannotation">❺</span> call %stack% Compiler push !byte!
          )  )
        <span aria-label="annotation6" class="code_codeannotation">❻</span> for %%p in ("[:]" "{:}" "(:)") do (
           <span aria-label="annotation7" class="code_codeannotation">❼</span> for /F "tokens=1,2 delims=:" %%x in (%%p) do (
               if "!byte!" equ "%%y" (
                <span aria-label="annotation8" class="code_codeannotation">❽</span> call %stack% Compiler pop popped
                  if "!popped!" equ "" (
                     &gt; con echo ABORT Unmatched Close Bracket
                     pause &amp; exit
                  )
                  if "!popped!" neq "%%x" (
                    &gt; con echo ABORT Bracket Mismatch
                    pause &amp; exit
)  )  )  )  )  )  )

<span aria-label="annotation9" class="codeannotationhang">❾</span> call %stack% Compiler isEmpty bool
if not %bool% (
   &gt; con echo ABORT Unmatched Open Bracket
   pause &amp; exit
)
<span aria-label="annotation10" class="codeannotationhang">❿</span> &gt; con echo Successful Pseudo-Compile
pause
</code></pre>
<p class="tx">At a high level, this bat file accepts one file to be pseudo-compiled as its sole parameter <span aria-label="annotation1" class="codeannotation">❶</span>. When this code encounters any type of open bracket (including parentheses), it pushes the character onto a stack <span aria-label="annotation5" class="codeannotation">❺</span>. Then whenever it sees a close bracket of any type, it pops the last open bracket off the stack <span aria-label="annotation8" class="codeannotation">❽</span> and looks to see if they are a matching pair. If not, it aborts. When it’s done reading the bat file, it needs to verify that the stack is empty <span aria-label="annotation9" class="codeannotation">❾</span>, because if it isn’t, we must also abort because the input has at least one unclosed bracket.</p>
<p class="tx">A deeper dive demonstrates many techniques introduced throughout this book, and it’s always fun to deconstruct a four-level deep nested <span class="sans_thesansmonocd_w5regular_">for</span> command. After clearing the <span class="sans_thesansmonocd_w5regular_">Compiler</span> stack, the outer <span class="sans_thesansmonocd_w5regular_">for /F</span> command <span aria-label="annotation1" class="codeannotation">❶</span> accepts the lone parameter, <span class="sans_thesansmonocd_w5regular_">%~1</span>, as its input and reads each record sequentially. You can pseudo-compile any bat file by dragging and dropping it onto <i class="calibre6">PseudoCompiler.bat</i>.</p>
<p class="tx"><span aria-label=" Page 420. " epub:type="pagebreak" id="pg_420" role="doc-pagebreak"/>The <span class="sans_thesansmonocd_w5regular_">for /L</span> command <span aria-label="annotation2" class="codeannotation">❷</span> iterates through each of the first 100 bytes of the input record. Double quotes cause issues when resolved in later <span class="sans_thesansmonocd_w5regular_">if</span> commands, so the first <span class="sans_thesansmonocd_w5regular_">if</span> command <span aria-label="annotation3" class="codeannotation">❸</span> adeptly filters out the offending character. I’m using two escape characters for the comparison, and another one in the next line, where I execute an optionless <span class="sans_thesansmonocd_w5regular_">for</span> command <span aria-label="annotation4" class="codeannotation">❹</span> that passes each of the three possible open brackets into its code block. It treats the curly and square brackets as text, but I must escape the open parenthesis. If I find one of the three characters, I push the open bracket onto the stack <span aria-label="annotation5" class="codeannotation">❺</span>.</p>
<p class="tx">Another <span class="sans_thesansmonocd_w5regular_">for</span> command <span aria-label="annotation6" class="codeannotation">❻</span> is the driver for finding and handling instances of close brackets. It passes all three pairs of open and close brackets, delimited by a colon, into its code block, where the final <span class="sans_thesansmonocd_w5regular_">/F</span> command <span aria-label="annotation7" class="codeannotation">❼</span> breaks each pair into two tokens. If the byte from the file I’m examining matches the second token, I’ve found a close brackets, so I pop the last added item off the stack <span aria-label="annotation8" class="codeannotation">❽</span>. If that byte is a null, the close bracket is an orphan, so the code aborts and writes a rudimentary message to the console. If instead the popped byte doesn’t match the corresponding start bracket, the abort message notes the mismatched brackets.</p>
<p class="tx">If we make it through the entire file without finding a mismatch, the trailing logic checks that the stack is empty of all brackets <span aria-label="annotation9" class="codeannotation">❾</span> with the use of a boolean. If an orphan remains, the code aborts because there’s at least one unmatched open bracket. After clearing this last <span class="sans_thesansmonocd_w5regular_">if</span> command, the brackets have all balanced, and the code triumphantly reports the success <span class="codeannotation">❿</span>.</p>
<p class="tx">This code demonstrates a great use for a stack, but it has limitations and, as mentioned, is far from bullet-proof. First and foremost, it assumes that each record is 100 bytes or less. The error handling in general also leaves much to be desired. At the very least, it should track the line of the infraction.</p>
<p class="tx">As the interpreter processes each record, it resolves variables delimited by exclamation marks, so this routine doesn’t validate any variable names containing brackets (think arrays and hash tables). Such variables will likely resolve to nothing, but if the two bat files share any variables, that can also cause problems. For instance, when I attempted to recursively pseudo-compile <i class="calibre6">PseudoCompiler.bat</i> (by copying and pasting it onto itself), <span class="sans_thesansmonocd_w5regular_">popped</span> resolved to an open parenthesis, resulting in it incorrectly reporting a mismatch. This self-pseudo-compile also failed on the unpaired open brackets <span aria-label="annotation4" class="codeannotation">❹</span> being treated as text data.</p>
<p class="tx">Even with these limitations that accentuate the <i class="calibre6">pseudo</i> in pseudo-compiler, this is still a solid means of tracking down most missed parentheses and brackets in a typical bat file—and a great application of a stack. Notice that this bat file calls the stack object we built earlier for four distinct tasks: clearing the stack, pushing, popping, and determining if the stack is empty.</p>
<blockquote class="calibre8">
<p class="warning"><span class="sans_dogma_ot_bold_b_1">NOTE</span></p>
</blockquote>
<p class="warning-txt"><i class="calibre6">As a final note on the nested for commands, notice that I’ve chosen descriptive for variables that don’t conflict with each other. I capture the entire record (%%r) and</i> <span aria-label=" Page 421. " epub:type="pagebreak" id="pg_421" role="doc-pagebreak"/><i class="calibre6">iterate through it with an index (%%i), grabbing individual bytes (%%b). Then I pass a pair (%%p) of brackets into a loop, breaking them up into the open bracket (%%x) and the implied close bracket (%%y). The last two might not be descriptive, but I’m limited because they must be consecutive alphabetical characters.</i></p>
</section>
<section aria-labelledby="sec7" epub:type="division">
<h3 class="h" id="sec7"><span id="h1-226"/><span class="sans_futura_std_bold_b_">Final Thoughts on Batch Object-Oriented Design</span></h3>
<p class="tni">I could have discussed the stack and queue data structures without presenting them as objects. The methods in this chapter would have been routines inside of an ordinary bat file with hardcoded names for the data structures, but as important as stacks and queues are, this chapter is also about real-world object-oriented design.</p>
<p class="tx">The object-oriented example in the prior chapter (<span class="xref"><a href="chapter32.xhtml" class="calibre3">Chapter 32</a></span>) was pedagogical at its core. It showed as many aspects of Batch object-oriented design as possible, but the two objects in this chapter are examples of real-world Batch objects. When I code objects, they’re far more likely to resemble <i class="calibre6">oStack.bat</i> than <i class="calibre6">oMovie.bat</i> or <i class="calibre6">oComedy.bat</i>.</p>
<p class="tx">I hope you can see the advantages of putting all of the stack-specific code into a single reusable and concise bat file—that is, an object. This allows you to code hundreds of future stacks with this one object without ever having to consider the details of how the stack itself is implemented. With this in mind, you can reconsider arrays and hash tables (<span class="xref"><a href="chapter29.xhtml" class="calibre3">Chapter 29</a></span>), imagining an object for each with methods for adding elements, retrieving elements, and clearing all elements. Further imagine other methods for displaying the contents of the array or hash table, writing all elements to a file, or even sorting the elements of the array. If you’re feeling bold, you could even use the stack object in the array object to reverse the order of the array elements.</p>
<p class="tx">Real-world Batch objects implement only the functionality of OOP that’s needed to get a job done. In a strict object-oriented language, you can’t use an object until you invoke the constructor, but in Batch, for better or worse, you have more flexibility. The objects in this chapter don’t even have constructors. Since Batch is not a true object-oriented language, you’re free to use only the pieces of the OOP paradigm that you choose, and there’s no compiler to say otherwise. I could have created a constructor (it would’ve looked a lot like the <span class="sans_thesansmonocd_w5regular_">:Clear</span> method), but I left it out for no other reason than that I didn’t feel it was needed.</p>
<p class="tx">There’s also no inheritance in this chapter. You can easily use <i class="calibre6">oStack.bat</i> and <i class="calibre6">oQueue.bat</i> without it, and that’s exactly how I typically implement Batch object-oriented design, but you can always extend any object. Some future coder, maybe even you, might later build a child object inheriting from one of these objects.</p>
<p class="tx">For instance, if you’re using the queue object to maintain a list of servers to be processed in some way, you might also need to look up an IP address for each or just verify that it’s on the network. You can encapsulate this new logic in an object that also inherits the data and methods from <span aria-label=" Page 422. " epub:type="pagebreak" id="pg_422" role="doc-pagebreak"/>what would then become the <i class="calibre6">parent</i> queue object, while a procedural coder would resort to artlessly cloning the queue logic. (I hope that you can sense the great distain with which I typed that last clause.)</p>
<p class="tx">I’ve also shown that you can maintain a list of public methods or simply expose all methods in an object as public. All of this shows the flexibility of Batch object-oriented design. You can use only the design elements that you want or need and not what you don’t want or need. If it makes sense to have a constructor, create one; otherwise, don’t. If nothing else, small bat files with narrowly focused tasks are ideal. I encourage you to use some or all of the Batch object-oriented design paradigm that I’ve shown in these last two chapters in your bat files.</p>
</section>
<section aria-labelledby="sec8" epub:type="division">
<h3 class="h" id="sec8"><span id="h1-227"/><span class="sans_futura_std_bold_b_">Summary</span></h3>
<p class="tni">In this final chapter, I detailed two new data structures, namely, stacks and queues, showing you how to push and pop (or add and remove) data items. You also learned how to peek at the next value, clear all values, and determine whether the data structure is empty. I shared a few ideas about stack and queue applications, even creating a pseudo-compiler. It isn’t perfect, but it’s very useful and nicely demonstrated how to use a stack.</p>
<p class="tx">I also took all that you learned about stacks and queues and wrapped it up into two real-world Batch objects. You learned how to construct similar objects, using only the components of object-oriented design that make sense to you, and how to invoke those objects. I hope you’ll make use of the stack and queue objects and look for future problems in need of an object-oriented solution.</p>
</section>
</section>
</div></body></html>