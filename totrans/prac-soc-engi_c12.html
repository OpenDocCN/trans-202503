<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en">
<head>
<title>Chapter 12: Producing Threat Intelligence</title>
<link href="NSTemplate_v1.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:5e8bb34b-260b-4fef-91f3-caabb4446e65" name="Adept.expected.resource"/>
</head>
<body epub:type="bodymatter chapter">
<section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" id="Page_165" title="165"/>12</span><br/>
<span class="ChapterTitle">Producing Threat Intelligence</span></h1>
</header>
<figure class="opener">
<img alt="" src="image_fi/book_art/chapterart.png"/>
</figure>
<p class="ChapterIntro">So your organization has defended against a phishing threat. Congrats! Now how do you repeat this outcome when faced with future attacks? Does your organization want to share this intelligence with other organizations? Will your organization capture and store data about this attempt to prevent further attempts? Will you record any exploit kit code found in the phishing emails used to spread a malware dropper, and ultimately ransomware?</p>
<p>When an incident occurs, three useful things should happen. First, the organization should automate the organization’s response by using software that either proactively blocks the attack or runs a script to halt an incident in progress. Second, the organization could collect information about each attack to decrease its future detection and response time. Finally, the organization could share parts of this information with other organizations, allowing everyone to reduce their detection and response times.</p>
<p><span epub:type="pagebreak" id="Page_166" title="166"/>While some threat intelligence feeds are snake oil, many are legitimately useful products. But relying solely on someone else to provide your organization with intelligence, to help defend the environment that the organization built and is responsible for, is naive. While taking inputs from experts who have insight into trends and actors is a sound move, it should not be the only move.</p>
<p>In this chapter, we’ll walk through the process of creating threat intelligence about a phishing email by using a free intelligence-sharing platform: AT&amp;T Alien Labs OTX, sometimes still referred to as AlienVault OTX. We’ll also reuse many of the OSINT techniques you learned about earlier in this book, this time for the much different purpose of verifying whether a URL or email is malicious.</p>
<p>Before you follow along, I recommend setting up a virtual machine. That way, you can avoid opening any attached files and prevent possible malware infections on your workstation.</p>
<h2 id="h1-500983c12-0001">Using Alien Labs OTX</h2>
<p class="BodyFirst">Some threat intelligence vendors charge the organization to consume threat intelligence, while others charge the organization to produce it. But one vendor that is universally free and allows anyone to contribute is AT&amp;T Cybersecurity. Formerly known as AlienVault, this company runs the Alien Labs Open Threat Exchange (OTX) platform, which lets you subscribe to intelligence feeds and post your own information. </p>
<p>Admittedly, its main strength (that it’s free) is also its main weakness, but a positive point is that you do not have to consume any intelligence just because it is on the platform; you must select which feeds you choose to follow and subscribe to (for free).</p>
<p>If an organization uses AT&amp;T Cybersecurity’s Unified Security Monitoring (USM) or Open Source SEIM (OSSIM) as its SEIM, the organization can directly input pulses you subscribe to into USM by synching the SEIM with the OTX API. If the organization is not using USM, it can directly connect OTX with Suricata, Bro, and Trusted Automated Exchange of Indicator Information (TAXII); otherwise, it may use the Java, Python, or Go APIs.</p>
<p>Once the organization has the indicators in the desired format, it can immediately search for them using its method of choice—custom scripts, YARA, STIX, TAXII, or something similar. This will allow the organization to identify and respond to known threats.</p>
<h2 id="h1-500983c12-0002">Analyzing a Phishing Email in OTX</h2>
<p class="BodyFirst">What about threats that only your organization has observed? How can your organization better detect future attempts and possibly save other organizations from the same headaches later? Here is the simple answer: produce threat intelligence.</p>
<p><span epub:type="pagebreak" id="Page_167" title="167"/>Knowing where to start is one of the significant barriers to entry. Since this is a single chapter in a book about social engineering and OSINT, I will spare you the philosophical justifications for producing threat intelligence. Instead, let’s walk through an exercise. </p>
<p>First, you need some data about which to produce intelligence. This could be an email, a website, or a file. For the sake of covering all three aspects, let’s assume that the organization receives an email directing users to a website that prompts them to enter credentials and then downloads and attempts to execute a file when the user submits the credentials. You can use the file called <em>invoice.eml</em> in the GitHub repo at <a class="LinkURL" href="https://cti.seosint.xyz/">https://cti.seosint.xyz/</a>.</p>
<h3 id="h2-500983c12-0001">Creating a Pulse</h3>
<p class="BodyFirst">Log in to OTX and select <b>Create Pulse</b> on the OTX dashboard,<b> </b>which is where you’ll land each time you log in (<a href="#figure12-1" id="figureanchor12-1">Figure 12-1</a>). In OTX, a <em>pulse</em> is a set of indicators of compromise for a specific attack.</p>
<figure>
<img alt="&lt;&lt;OTX Dashboard shows tab listing pulses to which the user is subscribed, including &quot;IcedID GZIPLoader Analysis,&quot; “Dearcry Ransomware used against unpatched exchange servers,” and “Fin8 returns with improved BADHATCH Toolkit&quot;. &gt;&gt;" class="keyline" src="image_fi/500983c12/f12001.png"/>
<figcaption><p><a id="figure12-1">Figure 12-1</a>: OTX Dashboard</p></figcaption>
</figure>
<p>You should be presented with a few options for creating the pulse (<a href="#figure12-2" id="figureanchor12-2">Figure 12-2</a>). You can import text or a website or manually input the indicators. </p>
<span epub:type="pagebreak" id="Page_168" title="168"/><figure>
<img alt="&lt;&lt;OTX Create New Pulse page. Left, option to enter text/source URL which OTX automatically extracts to pull indicators of compromise. Right, option to drag and drop or manually browse files to add indicators.&gt;&gt;" class="keyline" src="image_fi/500983c12/f12002.png"/>
<figcaption><p><a id="figure12-2">Figure 12-2</a>: Creating a pulse in OTX</p></figcaption>
</figure>
<p>Let’s start by copying and pasting the whole source of the email. </p>
<h3 id="h2-500983c12-0002">Analyzing the Email Source</h3>
<p class="BodyFirst">I like to use Thunderbird for viewing the email source. It’s a free and open source mail client maintained by Mozilla. Once Thunderbird is installed and running, you can import any saved emails to OTX in <em>.eml</em> format and start analyzing. In Thunderbird, first open the email. Then in the top-right corner, select <b>More</b><span class="MenuArrow">▶</span><b>View Source </b>(<a href="#figure12-3" id="figureanchor12-3">Figure 12-3</a>).</p>
<figure>
<img alt="&lt;&lt;Thunderbird window shows email stating that the user’s PayPal account has been suspended and the user needs to confirm their identity. In top-right corner under the More drop-down menu, &quot;View Source&quot; is highlighted.&gt;&gt;" class="keyline" src="image_fi/500983c12/f12003.png"/>
<figcaption><p><a id="figure12-3">Figure 12-3</a>: Viewing the source of an email in Thunderbird</p></figcaption>
</figure>
<p><span epub:type="pagebreak" id="Page_169" title="169"/>Once the email is opened as the source, you should see something like the excerpt in <a href="#figure12-4" id="figureanchor12-4">Figure 12-4</a>. This is the underlying trail of data that gets transmitted when you send an email, including all checks performed and the email’s source and destinations. You can view any downloadable email in this way, sometimes even in the mail client itself. For example, in Gmail, you’d click the three dots in the top-right corner of an email and then select Show original.</p>
<figure>
<img alt="&lt;&lt;Excerpt of email source file located in file:///Users/joegray/Downloads/Invoice%20_Remittance%2010022.eml?type=application/x-message-display. Partially censored by author.&gt;&gt;" class="keyline" src="image_fi/500983c12/f12004.png"/>
<figcaption><p><a id="figure12-4">Figure 12-4</a>: The source of a phishing email</p></figcaption>
</figure>
<p>It’s important to view an email’s source. This lets you see where an email really came from, rather than relying on a potentially spoofed source address. You’ll see both the real email address and the spoofed email address, as well as the sender’s IP address. </p>
<p>When copying and pasting this email into the pulse, be careful not to include your mail server’s IP address or any other addresses belonging to reputable mail vendors. If you add these and start searching, you will receive an overwhelmingly high number of false positives, which, if not tuned, will breed complacency.</p>
<h3 id="h2-500983c12-0003">Inputting Indicators</h3>
<p class="BodyFirst">Now that you’ve obtained information from the source, you’re ready to import some indicators. <em>Indicators </em>are data points related to the activity that you are capturing in the pulse. <a href="#table12-1" id="tableanchor12-1">Table 12-1</a> lists the indicators that OTX accepts.</p>
<figure>
<figcaption class="TableTitle"><p><a id="table12-1">Table 12-1</a>: Indicators Accepted by OTX</p></figcaption>
<table border="1" id="table-500983c12-0001">
<thead>
<tr>
<td><b>Indicator type</b></td>
<td><b>Description</b></td>
</tr>
</thead>
<tbody>
<tr>
<td>IPv4</td>
<td>The IPv4 address of the source email server or site hosting the phishing or malware.</td>
</tr>
<tr>
<td>IPv6</td>
<td>The IPv6 address of the source email server or site hosting the phishing or malware.</td>
</tr>
<tr>
<td>Domain</td>
<td>The domain of the source email server or site hosting the phishing or malware.</td>
</tr>
<tr>
<td><span epub:type="pagebreak" id="Page_170" title="170"/>Hostname</td>
<td>The hostname or subdomain of the source email server or site hosting the phishing or malware.</td>
</tr>
<tr>
<td>Email</td>
<td>The source email address.</td>
</tr>
<tr>
<td>URL</td>
<td>The Uniform Resource Locator of the site hosting the phishing or malware.</td>
</tr>
<tr>
<td>URI</td>
<td>The Uniform Resource Identifier of the precise location within the site hosting the phishing or malware.</td>
</tr>
<tr>
<td>File hash</td>
<td>The one-way cryptographic representation of the malicious file contained within the phishing email. This can be accomplished in various formats including these:
<ul>
<li>MD5: 128-bit cryptographic representation of a file using the Message Digest 5 Algorithm</li>
<li>SHA-1: 160-bit cryptographic representation of a file using the Secure Hashing Algorithm</li>
<li>SHA-256: 256-bit cryptographic representation of a file using the Secure Hashing 265-bit Algorithm</li></ul>
</td>
</tr>
<tr>
<td>PEHASH</td>
<td>Portable Executable Hash (peHash) method of fuzzy hashing, which instead of hashing the entire file accomplishes byte-by-byte hashing by taking several variables from within the executable and hashing them.</td>
</tr>
<tr>
<td>IMPASH</td>
<td>Import Hash; similar to peHash, but tracks the DLLs and other files that the code imports.</td>
</tr>
<tr>
<td>CIDR</td>
<td>The classless interdomain routing address of the network IP address range that a domain owns, expressed as a base IP and the number of possible subnets. The format is typically <em>xxx.xxx.xxx.xxx</em>/<em>yy</em>, where <em>xxx.xxx.xxx.xxx</em> is the base IPv4 address and <em>yy</em> is a number between 1 and 32 that denotes the number of possible subnets and hosts within this block. You will typically see numbers between 24 and 32 in this range.</td>
</tr>
<tr>
<td>File path</td>
<td>A unique location within the workstation where the malicious files are discovered. This shows the behavior of uniformity, likely through a script.</td>
</tr>
<tr>
<td>MUTEX</td>
<td>A mutual exclusion object (MUTEX) is an object within a program designed to allow multiple threads to share the resource such as file access, but not at the same time.</td>
</tr>
<tr>
<td>CVE</td>
<td>Common Vulnerabilities and Exposures are responsibly disclosed vulnerabilities. Including a CVE in the pulse allows others to search for the CVE when subscribing to feeds. This is especially helpful when the phishing email attempts to perform some level of technical exploitation based on an existing vulnerability.</td>
</tr>
<tr>
<td>YARA</td>
<td>YARA is either Yet Another Recursive Acronym or Yet Another Regular Expression (REGEX) Analyzer. This is a means to match patterns within files and iterate across an environment either using a SEIM or a custom YARA tool, which supports Windows, macOS, and Linux.</td>
</tr>
</tbody>
</table>
</figure>
<p><span epub:type="pagebreak" id="Page_171" title="171"/>Copy the entire email source and paste it in the left-hand box in the image, and then select <b>Extract Indicators</b> (<a href="#figure12-5" id="figureanchor12-5">Figure 12-5</a>). This will do the parsing automatically, but you’ll need to go through the indicators and sanity-check them.</p>
<figure>
<img alt="&lt;&lt;OTX Create New Pulse page zoomed in on &quot;Enter Source URL or Text&quot; field with email source entered. &quot;Extract Indicators&quot; button is below field.&gt;&gt;" class="keyline" src="image_fi/500983c12/f12005.png"/>
<figcaption><p><a id="figure12-5">Figure 12-5</a>: OTX Indicator extraction</p></figcaption>
</figure>
<p>As you can see in <a href="#figure12-6" id="figureanchor12-6">Figure 12-6</a>, the parser extracted three indicators from the email you pasted.</p>
<figure>
<img alt="&lt;&lt;“Included IOCs” tab of Parser Results displays three extracted indicators with their types—IPv4, Hostname, and Email—outlined in red.&gt;&gt;" class="keyline" src="image_fi/500983c12/f12006.png"/>
<figcaption><p><a id="figure12-6">Figure 12-6</a>: Included indicators</p></figcaption>
</figure>
<p><span epub:type="pagebreak" id="Page_172" title="172"/>You need to verify that these indicators belong in the pulse. Since you know from inspecting the email source that the listed email is the sender’s, you don’t need to check it again. But you do need to check the domains and IP addresses. To accomplish this, let’s do a little OSINT. </p>
<p>You need to determine the following: Who owns each domain and IP address? Does the domain and IP address serve a legitimate purpose? Does the domain owner have any control over the data passed through their services? Do the IP addresses belong to email providers? Or do we own the domain or IP address?</p>
<p>The possible IOCs in <a href="#figure12-7" id="figureanchor12-7">Figure 12-7</a> are not valuable pieces of threat intelligence, so if OTX doesn’t, you will need to exclude them. You’ll do this later in the process, to avoid analyzing them twice.</p>
<figure>
<img alt="&lt;&lt;&quot;Excluded IOCs&quot; tab of parser results displays 13 excluded indicators with their types (IPv4, URL, and Hostname) and reasons for exclusion, which include “Manually excluded,” &quot;Private IP Address,&quot; and &quot;whitelisted domain outlook.com.&quot; &gt;&gt;" class="keyline" src="image_fi/500983c12/f12007.png"/>
<figcaption><p><a id="figure12-7">Figure 12-7</a>: Excluded indicators</p></figcaption>
</figure>
<p>Now, you move to the list of <em>Excluded IOCs</em>. You repeat the process you used for the Included IOCs for each item in the Excluded IOCs list. Off the bat, you can tell that some of these do not belong on the list of indicators. </p>
<p>From this extraction, go ahead and remove the following: three obvious Microsoft addresses (<em>by5pr19mb3713.namprd19.prod.outlook.com</em>, <em>by5pr19mb3970.namprd19.prod.outlook.com</em>, and <em>nam12-mw2-obe.outbound.protection.outlook.com</em>); two obvious Google addresses (<em>mail-sor-f41.google.com</em> and <em>mx.google.com</em>); a series of GoDaddy addresses (<em>p3plibsmtp01-08.prod.phx3.secureserver.net</em>, <em>p3plsmtp21-01-26.prod.phx3.secureserver.net</em>, and <em>p3plsmtp21-01.prod.phx3.secureserver.net</em>); and 10.186.134.206, which is a Class A, private, non-routable, internal IP address.</p>
<h3 id="h2-500983c12-0004">Testing a Potentially Malicious Domain in Burp</h3>
<p class="BodyFirst">OTX claims that <em>docsend.com</em> is a whitelisted domain, but it does allow users to upload files. This means it’s prudent to go ahead and check what the sender is trying to coerce victims into opening. In the digital forensics and malware world, this is part of what is known as <em>detonating</em>. Detonating can be dangerous if you’re on an unprotected system, as it can get infected. I recommend using a dedicated system for this, or at minimum a dedicated virtual machine. </p>
<p><span epub:type="pagebreak" id="Page_173" title="173"/>In addition to a virtual machine, I recommend ensuring that you have malware protection installed (if applicable), a firewall enabled at the host and network level, the use of a VPN, and (if you are comfortable with it), the Tor browser (or Brave—which offers a similar functionality), though you have to select Open a New Private Window with Tor. You may find yourself dealing with some nasty stuff, and you do not want to find yourself on the wrong side of the law while trying to conduct legitimate security research.</p>
<p>Open your virtual machine on a separate system and network segment than your main network, with a firewall and security appliance running between the system and the rest of your home lab and network. Depending on the level of analysis you intend on performing, you could choose to use a Linux virtual machine or a Windows one. If you want a good sense of how the attack is supposed to work, you may want to use a vulnerable Windows system. </p>
<p>Install Burp Suite on your host. <em>Burp</em> is a web proxy that allows you to intercept and alter data transmitted between you and the website. It will allow you to see calls made from your system to the website and the responses. You can also control any pop-ups and many unintended actions, like redirects to malicious sites. To install Burp, download a copy of the free Community Edition from <a class="LinkURL" href="https://portswigger.net/burp/communitydownload/">https://portswigger.net/burp/communitydownload/</a>. This will include a script similar to <code>burpsuite_community_linux_v&lt;#&gt;_#_##.sh</code>. Input the most recent version into the commands shown here:</p>
<pre><code>chmod 744 burpsuite_community_linux_v&lt;#&gt;_#_##.sh
./burpsuite_community_linux_v&lt;#&gt;_#_##.sh</code></pre>
<p>Once it’s installed, you can use the GUI to open Burp by either clicking the Burp icon or typing <em>Burp</em> into the operating system menu. Burp will prompt you to create a project. Click <b>Next</b>, and you should be prompted to accept the Burp default configurations or load a configuration file. Sticking with the defaults should be fine.</p>
<p>Next, you have to route your browser’s traffic through Burp. To do this, open Firefox and click the Menu icon and then scroll to the bottom. Click <b>Network Settings</b>. You should be prompted to enter information about your proxy, as shown in <a href="#figure12-8" id="figureanchor12-8">Figure 12-8</a>. Select <b>Manual proxy configuration</b> and then enter the IP address <code class="bold">127.0.0.1</code> as the HTTP Proxy and <code class="bold">8080</code> as the Port. Select the option to use this proxy server for all protocols. </p>
<p>Now that you have Burp installed and Firefox configured to route your traffic through Burp, open Burp and make sure that it is configured for intercepting traffic. To accomplish this, select the <b>Proxy</b> tab, then <b>Intercept</b>. Finally, ensure that Intercept is on.</p>
<span epub:type="pagebreak" id="Page_174" title="174"/><figure>
<img alt="&lt;&lt;Firefox preferences page shows &quot;Connection Settings&quot; box with options to &quot;Configure Proxy Access to the Internet.&quot; Outlined in red: &quot;Manual proxy configuration&quot; option, &quot;127.0.0.1&quot; HTTP Proxy, &quot;8080&quot; port, and &quot;Also use this proxy for FTP and HTTPS.&quot; checkbox.&gt;&gt;" class="" src="image_fi/500983c12/f12008.png"/>
<figcaption><p><a id="figure12-8">Figure 12-8</a>: Configuring a network proxy in Firefox</p></figcaption>
</figure>
<p>Once you’ve verified that Burp is configured correctly, you can use it to intercept your browser’s traffic (see <a href="#figure12-9" id="figureanchor12-9">Figure 12-9</a>). As long as Intercept is on, you’ll need to choose whether to forward or drop each web request<em>.</em> This means you can drop malicious (or legitimate) traffic instead of sending it to your browser.</p>
<figure>
<img alt="&lt;&lt;Burp Suite Community Edition dashboard with sections for Tasks, Event log, and Issue Activity (pro version only).&gt;&gt;" class="keyline" src="image_fi/500983c12/f12009.png"/>
<figcaption><p><a id="figure12-9">Figure 12-9</a>: Intercepting traffic with Burp</p></figcaption>
</figure>
<p><span epub:type="pagebreak" id="Page_175" title="175"/>Now, let’s visit the website found in the email. When you forward it using Burp, a website loads. This appears to be a PayPal site, but in <a href="#figure12-10" id="figureanchor12-10">Figure 12-10</a>, you can easily spot that it’s not legitimate: notice the URL lacks the word <em>PayPal</em> and has an <em>.es </em>top-level domain. In addition, the <em>code=US&amp;id=8799879&amp;country=United States</em> at the end shows that some sort of tracking is in use.</p>
<figure>
<img alt="&lt;&lt;Web page shows what appears to be a PayPal login screen. Highlighted in red: link's redirect location shows the URL http://nurrahmahgroup.esy.es/pjj/creer/Adeit.&quot;&gt;&gt;" class="keyline" src="image_fi/500983c12/f12010.png"/>
<figcaption><p><a id="figure12-10">Figure 12-10</a>: The example phishing landing page</p></figcaption>
</figure>
<p>The complete omission of <em>PayPal</em> from the URL is probably the biggest red flag. If you try to open this link in the sandbox system (the isolated system or virtual machine discussed earlier in this chapter), the host should be unknown. And, as you can see in <a href="#figure12-11" id="figureanchor12-11">Figure 12-11</a>, Burp shows us that entering information and clicking the link is a dead end—likely pointing to a failed attempt at <em>credential harvesting</em>.</p>
<figure>
<img alt="&lt;&lt;Burp Suite Community Edition window shows message &quot;Error: Request was dropped by user” with redirect to http://nurrahmahgroup.esy.es/pjj/creer/Adeit.&gt;&gt;" class="keyline" src="image_fi/500983c12/f12011.png"/>
<figcaption><p><a id="figure12-11">Figure 12-11</a>: Broken phishing redirect</p></figcaption>
</figure>
<p><span epub:type="pagebreak" id="Page_176" title="176"/>The fact that the site does nothing might indicate that PayPal or another vendor took action, probably leveraging the DMCA. It could also indicate an adversary that lacks the sophistication to expand their efforts. It’s important to avoid dismissing the threat associated with credential harvesting, however. As noted time and time again, people still routinely use the same password on multiple platforms, both personal and professional accounts. Many sites either do not force or do not support multifactor authentication, compounding this threat.</p>
<p>Although the link is broken, you should still add it to the OTX pulse. Before you move on, add the four IP addresses we identified as irrelevant to the excluded indicators by checking the boxes next to them and clicking <b>Exclude</b>.</p>
<h3 id="h2-500983c12-0005">Analyzing Downloadable Files</h3>
<p class="BodyFirst">This phishing campaign did not include any downloadable files. But what if it did? Let’s briefly discuss analyzing them. To start, you’ll need to get cryptographic hashes of those files. Having the cryptographic hashes of files allows you to compare the files in known states to other versions to see if anything changed. When a file is created (or in the case of malware, observed), you take a cryptographic hash of the file to help you search for it faster. You compare the hashes of files on your systems to the known bad file (in the case of malware) and alert on any matches. In some cases, the file changes itself, and so the hash will not remain the same. We call this <em>polymorphic malware</em>, and it’s a discussion for a completely different book. </p>
<p>You can hash a file by using a variety of tools. Some, like the following, come already installed on Linux. It’s sometimes worth entering multiple hash kinds, because some systems will check files using only one algorithm. </p>
<p>To produce an MD5 hash of the file, enter the following command:</p>
<pre><code><b>md5sum</b> <var class="bold">filename</var> </code></pre>
<p>To produce a SHA-1 hash of the file, enter this:</p>
<pre><code><b>sha1sum</b> <var class="bold">filename</var> </code></pre>
<p>To produce a SHA-256 hash of the file, enter this: </p>
<pre><code><b>sha256sum</b> <var class="bold">filename</var> </code></pre>
<p>To produce a SHA-512 hash of the file, enter this: </p>
<pre><code><b>sha512sum</b> <var class="bold">filename</var> </code></pre>
<p>Then add each hash to OTX. If you choose to write up this incident and publish a report, you might import the pulse from the URL and list the URL as a resource. </p>
<p>In the following sections, we will further analyze the <em>esy.es</em> domain. </p>
<h2 id="h1-500983c12-0003"><span epub:type="pagebreak" id="Page_177" title="177"/>Conducting OSINT for Threat Intelligence</h2>
<p class="BodyFirst">OTX isn’t the only resource you can use to analyze malicious links or emails. In this section, we’ll explore a few others. You might recognize some of these tools and techniques from the OSINT chapters of this book. Here, you’ll use these resources to figure out whether a site is harmful.</p>
<h3 id="h2-500983c12-0006">Searching VirusTotal</h3>
<p class="BodyFirst">A website owned by Chronicle Security, <a class="LinkURL" href="https://www.virustotal.com/">https://www.virustotal.com/</a>, allows researchers and threat intelligence professionals to analyze whether a file is listed as malicious on more than 60 antivirus platforms without having to buy every one of them. It also allows you to check the status of any URLs. VirusTotal also has an API for scripted analysis. Its web-based GUI search function accepts the following input types: the actual uploaded file, a URL, an IP address, a domain, or a file hash.</p>
<h3 id="h2-500983c12-0007">Identifying Malicious Sites on WHOIS</h3>
<p class="BodyFirst">You ran the WHOIS command when collecting OSINT. But when using WHOIS to analyze malware, you’ll want to look for additional information. Notably, in addition to the usual WHOIS information, you want to see the country where a domain is registered and its autonomous system number (ASN). The ASN will help later when you use PhishTank to analyze the systems from which the phishing email originates. <a href="#figure12-12" id="figureanchor12-12">Figure 12-12</a> shows the WHOIS record for the sketchy-seeming domain <em>esy.es</em>.</p>
<figure>
<img alt="&lt;&lt;DomainTools Whois Record for “Esy.es.” Entries include Registrar Status (&quot;taken&quot;), Name Servers (four with 455 domains each), and IP Location (&quot;Noord Holland Jordaan OpenTid Bv&quot;).&gt;&gt;" class="keyline" src="image_fi/500983c12/f12012.png"/>
<figcaption><p><a id="figure12-12">Figure 12-12</a>: <em>esy.es’</em>s WHOIS record</p></figcaption>
</figure>
<p>You can see that the domain was registered in an area of the Netherlands called Jordaan and last updated on 2021-06-09, and that it uses name servers hosted through main-hosting.com. In turn, performing a WHOIS search of main-hosting.com shows that it is being hosted on godaddy.com, whereas <span epub:type="pagebreak" id="Page_178" title="178"/>a reputable firm would likely host it in-house. You should also be wary of recently registered domains. Young domains warrant skepticism and analysis, as many are malicious. An 8-day-old domain and a 43-day-old name server are not automatically up to no good, but they do require additional investigation. In this instance, you should include both domains and any related IP addresses in your OTX pulse. </p>
<p>What would a legitimate site’s WHOIS record show? For comparison, <a href="#figure12-13" id="figureanchor12-13">Figure 12-13</a> is the WHOIS output for <em>nostarch.com</em>.</p>
<figure>
<img alt="&lt;&lt;DomainTools Whois Record for &quot;NostArch.com&quot;. Outlined in red are Registrant Country (is), ASN (AS13335 CLOUDFLARENET, US (registered Jul 14, 2010)), Domain Status (Registered and Active Website), and Hosting History (3 changes on 4 unique name servers over 17 years).&gt;&gt;" class="keyline" src="image_fi/500983c12/f12013_updated.png"/>
<figcaption><p><a id="figure12-13">Figure 12-13</a>: NoStarch’s WHOIS record</p></figcaption>
</figure>
<p>First note that the registrant country is Iceland. This is common when organizations use services like WhoisGuard or domain privacy to conceal their location, and this is not an immediate cause for alarm or further analysis. If you review the date, you should see that this domain was created in 1996 and includes a registered and active website. </p>
<p>Second, the ASN is listed as Cloudflare. The use of Cloudflare indicates that the site likely isn’t malicious, as content distribution networks typically remove anything they verify to be harmful. We also see that this domain has had three changes over four name servers in 17 years. This is normal and typically is indicative of changing providers. Technology has changed a lot since 1996, so it makes sense to switch providers and records to implement new technologies. </p>
<h3 id="h2-500983c12-0008"><span epub:type="pagebreak" id="Page_179" title="179"/>Discovering Phishes with PhishTank</h3>
<p class="BodyFirst">PhishTank (<a class="LinkURL" href="https://phishtank.com/">https://phishtank.com/</a>) is a free phishing verification platform operated by OpenDNS. It lets you search by domain, URL, or ASN. In my experience, searching by ASN is the most efficient. But since you don’t have an ASN for the potentially malicious <em>nurrahmahgroup.esy.es</em> domain, you’ll need to search by domain and URL. <a href="#figure12-14" id="figureanchor12-14">Figure 12-14</a> shows this search.</p>
<figure>
<img alt="&lt;&lt;PhishTank &quot;Home&quot; tab reads &quot;Join the fight against phishing. Submit suspected phishes. Track the status of your submissions. Verify other users' submissions. Develop software with our free API.&quot; Shows search box for searching phishing database by URL with contents http://nurrahmahgroup.esy.es/pjj/creer/Adeit/signin.&gt;&gt;" class="keyline" src="image_fi/500983c12/f12014.png"/>
<figcaption><p><a id="figure12-14">Figure 12-14</a>: PhishTank search for <em>nurrahmahgroup.esy.es</em> phish</p></figcaption>
</figure>
<p>As you can see in <a href="#figure12-15" id="figureanchor12-15">Figure 12-15</a>, the search yields nothing. That doesn’t mean that it isn’t a phishing attempt—just that no one has reported it. </p>
<figure>
<img alt="&lt;&lt;PhishTank web page shows message “Nothing known about http://nurrahmahgroup.esy.es/pjj/creer/Adeit.”&gt;&gt;" class="keyline" src="image_fi/500983c12/f12015.png"/>
<figcaption><p><a id="figure12-15">Figure 12-15</a>: A valid phish on <em>PhishTank.com</em></p></figcaption>
</figure>
<p><span epub:type="pagebreak" id="Page_180" title="180"/>Since the site is down, I will walk through reporting it, but not submit the report. To start the report, click the <b>Add it to the Tank?</b> link below the statement that says that nothing is known. Next, enter the URL of the phish. In this case, you will need to paste the body of the email into three reports to the Tank (if you were submitting) to associate all three domains used. You also select Microsoft as the organization referenced in the email, since it claimed to be from Office 365. Once it’s complete, click <b>Submit</b>. </p>
<p><a href="#figure12-16" id="figureanchor12-16">Figure 12-16</a> is an instance of entering the information associated with the phish into PhishTank for inclusion in its database.</p>
<figure>
<img alt="&lt;&lt;PhishTank &quot;Add A Phish&quot; tab. Outlined in red: fields for entering Phish URL (http://nurrahmahgroup.esy.es/pjj/creer/Adeit) and organization reference in the phishing email (PayPal). Also shows field for entering full email contents.&gt;&gt;" class="keyline" src="image_fi/500983c12/f12016.png"/>
<figcaption><p><a id="figure12-16">Figure 12-16</a>: Submitting a phishing sample to PhishTank</p></figcaption>
</figure>
<h3 id="h2-500983c12-0009">Browsing ThreatCrowd</h3>
<p class="BodyFirst">Part of AT&amp;T Cybersecurity, ThreatCrowd (<a class="LinkURL" href="https://www.threatcrowd.org/">https://www.threatcrowd.org/</a>) provides visualization regarding the legitimacy of domains, IP addresses, and other details like hashes. As with OTX and other platforms, you can access it independently or via links in ThreatMiner (discussed in the next section). <a href="#figure12-17" id="figureanchor12-17">Figure 12-17</a> shows the visualization for the <em>nurrahmahgroup.esy.es </em>domain.</p>
<p>In this visualization, you can see how various systems, hashes, domains, and other features interact with our system of interest. This can be very useful when building out a cyber threat intelligence program or doing a deep dive on a potential adversary. The graphical output also makes for some excellent artifacts when writing reports.</p>
<span epub:type="pagebreak" id="Page_181" title="181"/><figure>
<img alt="&lt;&lt;ThreatCrowd visualization shows connected nodes of varying sizes displaying color-coded domains, IP addresses, and hashes. Outlined in red: a medium-sized blue node labeled &quot;NURRAHMAHGROUP.ESY.ES,&quot; which connects to a large gray central node labeled with an IP address.&gt;&gt;" class="keyline" src="image_fi/500983c12/f12017.png"/>
<figcaption><p><a id="figure12-17">Figure 12-17</a>: ThreatCrowd visualization for <em>nurrahmahgroup.esy.es</em></p></figcaption>
</figure>
<h3 id="h2-500983c12-0010">Consolidating Information in ThreatMiner</h3>
<p class="BodyFirst">ThreatMiner (<a class="LinkURL" href="https://www.threatminer.org/">https://www.threatminer.org/</a>) takes an input and pulls from several other threat intelligence sources to produce a single-pane view of what other platforms are saying. ThreatMiner allows you to get an idea of the likelihood of malice rather quickly. Like anything else, it is not a perfect solution, but it is one of the best, especially since it is free. </p>
<p>The ThreatMiner website allows you to search for either indicators or APT Notes. <em>APT Notes</em> is a repository of publicly available papers and blogs, sorted by year and related to malicious campaigns, activity, or software associated with vendor-defined advanced persistent threat groups or toolsets. Since you already have some indicators, let’s search for them first. Like OTX, ThreatMiner can process a variety of indicator types, some of which differ from OTX’s. They include domains, IP addresses, hashes (MD5, SHA-1, and SHA-256), email address, APT Notes, SSL/TLS certificates, user-agents, antivirus names, filenames, URIs, registry keys, and mutexes. </p>
<p>Here’s one of ThreatMiner’s unique features: it opens a pane on the left side of the screen that shows possibly related Google search results. There, you should see WHOIS data for the indicator submitted, if appropriate. Further down the screen, you’ll see links to other resources, like RiskIQ, PassiveTotal, VirusTotal, DomainTools, ThreatCrowd, OTX, SecurityTrails, and Robtex.</p>
<p><a href="#figure12-18" id="figureanchor12-18">Figure 12-18</a> shows a search for <em>nurrahmahgroup.esy.es</em>.</p>
<span epub:type="pagebreak" id="Page_182" title="182"/><figure>
<img alt="&lt;&lt;ThreatMiner web page shows results for &quot;nurrahmahgroup.esy.es&quot; domain. Left pane displays possibly related Google search results (empty). Main page displays results for WHOIS information and related resources.&gt;&gt;" class="keyline" src="image_fi/500983c12/f12018_updated.png"/>
<figcaption><p><a id="figure12-18">Figure 12-18</a>: ThreatMiner results for <em>nurrahmahgroup.esy.es</em></p></figcaption>
</figure>
<p>Below the related resources, you’ll notice that there are no APT Notes for the domain. Nor are there any related passive DNS, subdomains, associated URLs, Robtex, or malware samples. Given that the phishing email you analyzed is old and the domain was recently registered, this makes sense. For a more mature indicator, or a domain that has not been taken down, expect to see more information here.</p>
<p>Now, if ThreatMiner searches all of these sites for you, why did I wait until the end to show you its capabilities? To help you understand how to perform the analysis by yourself. When I’m performing threat intelligence analysis on phishing emails, I often start with two windows open: OTX and ThreatMiner. To use the information that ThreatMiner identifies as related, simply click the link.</p>
<h2 id="h1-500983c12-0004">Conclusion</h2>
<p class="BodyFirst">Threat intelligence is more than snake oil and more than just consuming vendor feeds. It empowers you to analyze your own experiences and collect actionable information that not only helps you, but can help your clients, partners, and the community as a whole. In this chapter, you consumed and produced threat intelligence by using OTX, and then transitioned through defensive uses of WHOIS, ThreatCrowd, ThreatMiner, VirusTotal, and more. This is only the beginning of your threat intelligence efforts. Still, it is a solid foundation for you to be able to see beyond vendor hype, as well as produce high-quality materials to enhance your organization’s security.</p>
</section>
</body>
</html>