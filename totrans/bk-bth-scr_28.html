<html><head></head><body>
<div id="sbo-rt-content" class="calibre1"><section aria-labelledby="ch25" epub:type="chapter" role="doc-chapter">
<hgroup>
<h2 class="title" id="ch25">
<span class="cn"><span aria-label=" Page 293. " epub:type="pagebreak" id="pg_293" role="doc-pagebreak" class="calibre2"/><span class="sans_dogma_ot_bold_b_">25</span></span>
<span class="ct1"><span class="sans_dogma_ot_bold_b_">BAT FILES BUILDING BAT FILES</span></span>
</h2>
</hgroup>
<figure class="opener"><img alt="" class="opener1" height="407" src="../images/chapter.jpg" width="408"/>
</figure>
<p class="chapterintro">In our post-industrial age, manufacturers can build a toaster with relative ease, but no one has ever built a toaster that can build another toaster, and I’m going out on a very short limb to say no manufacturer ever will. Robots, at least in part, can build robots, but cars don’t build cars, and smartphones aren’t smart enough to build phones of any intellect. In the realm of software, however, code conceives code, programs propagate programs, and bats beget bats.</p>
<p class="tx">This chapter isn’t about flying mammal procreation, but instead discusses the technique of one bat file creating another bat file. Several languages offer an automated code generator, but those typically create a template or a good starting point from which to do the interesting coding. <span aria-label=" Page 294. " epub:type="pagebreak" id="pg_294" role="doc-pagebreak"/>Here I’m referring to one bat file creating another fully functional and ready-to-execute bat file.</p>
<p class="tx">If this sounds like a parlor trick, it isn’t. You might need information from one Batch process before you can write the code for a later process. Instead of writing the bat file for that second process, you can make the first bat file smart enough to write the second with all the needed information. This will also allow one bat file to intelligently break up large processes on the fly, dynamically creating any number of processes based on the size of the input.</p>
<p class="tx">I’ll first jump right into a complete step-by-step example of a bat file building a bat file, from the parent bat file to the created child bat file and ultimately to the child’s output. I’ll also detail how to populate a dynamically created bat file with static data, resolved variables, and yet to be resolved variables. I’ll put this all together with a real-world application, demonstrate multigenerational bat files, and, most important, discuss useful applications of this technique.</p>
<section aria-labelledby="sec1" epub:type="division">
<h3 class="h" id="sec1"><span id="h1-169"/><span class="sans_futura_std_bold_b_">Dynamically Creating a Bat File</span></h3>
<p class="tni">The best way to explain how a bat-file-building bat file works is through a simple yet (I hope) interesting example, so I’ll start with a demonstration of <i class="calibre6">Mother.bat</i>. When it executes, it’ll display its name to the console, which is nothing new, and then proceed to something that might have sounded like alchemy not long ago: building the aptly named <i class="calibre6">Daughter.bat</i>, a bat file that will write its name to the console along with the name of the bat file that gave it life when it itself executes.</p>
<p class="tx"><a href="#Lis25-1" class="calibre3">Listing 25-1</a> isn’t a code snippet; it shows the complete contents of <i class="calibre6">Mother.bat</i>, the parent bat file.</p>
<span id="Lis25-1"/>
<pre class="pre"><code class="calibre11">@setlocal EnableExtensions EnableDelayedExpansion
@echo off
<span aria-label="annotation1" class="codeannotationhang">❶</span><span class="sans_thesansmonocd_w5regular_"> &gt; con echo ***** This bat file is "%~NX0".</span>
&gt; con echo.

set batDtr=C:\Batch\Daughter.bat
<span aria-label="annotation2" class="codeannotationhang">❷</span><span class="sans_thesansmonocd_w5regular_"> &gt;  %batDtr% echo   @setlocal EnableExtensions EnableDelayedExpansion</span>
&gt;&gt; %batDtr% echo   @echo off
<span aria-label="annotation3" class="codeannotationhang">❸</span><span class="sans_thesansmonocd_w5regular_"> &gt;&gt; %batDtr% echo   ^&gt; con echo ***** This bat file is "%%~NX0".</span>
<span aria-label="annotation4" class="codeannotationhang">❹</span><span class="sans_thesansmonocd_w5regular_"> &gt;&gt; %batDtr% echo   ^&gt; con echo ***** It was created by "%~NX0".</span>
<span aria-label="annotation5" class="codeannotationhang">❺</span><span class="sans_thesansmonocd_w5regular_"> &gt;&gt; %batDtr% echo   ^&gt; con echo.</span>
<span aria-label="annotation6" class="codeannotationhang">❻</span><span class="sans_thesansmonocd_w5regular_"> &gt;&gt; %batDtr% echo   pause</span>
<span aria-label="annotation7" class="codeannotationhang">❼</span><span class="sans_thesansmonocd_w5regular_"> </span>pause
</code></pre>
<p class="listingcaption"><span class="futura_std_book_oblique_i_">Listing 25-1: The parent bat file,</span> <span class="sans_futura_std_book_">Mother.bat</span></p>
<p class="tx">The bat file starts with a <span class="sans_thesansmonocd_w5regular_">setlocal</span> command (as all my bat files do). It turns the <span class="sans_thesansmonocd_w5regular_">echo</span> to <span class="sans_thesansmonocd_w5regular_">off</span>, thus keeping the console display clean. The first section of code ends with two <span class="sans_thesansmonocd_w5regular_">echo</span> commands, writing the name of the bat file to the console followed by a blank line <span aria-label="annotation1" class="codeannotation">❶</span>. Since we aren’t in a routine, <span class="sans_thesansmonocd_w5regular_">%~0</span> <span aria-label=" Page 295. " epub:type="pagebreak" id="pg_295" role="doc-pagebreak"/>resolves to the hidden parameter of the path and name of the bat file being executed (<span class="xref"><a href="chapter11.xhtml" class="calibre3">Chapter 11</a></span>). With the use of two modifiers, <span class="sans_thesansmonocd_w5regular_">%~NX0</span> extracts just the filename and extension from the hidden parameter (<span class="xref"><a href="chapter17.xhtml" class="calibre3">Chapter 17</a></span>).</p>
<p class="tx">The final section of the bat file is where it gets interesting. Six <span class="sans_thesansmonocd_w5regular_">echo</span> commands write one line each to build the child bat file. The first <span class="sans_thesansmonocd_w5regular_">echo</span> command <span aria-label="annotation2" class="codeannotation">❷</span> with a single redirection character creates the child bat file, writing the <span class="sans_thesansmonocd_w5regular_">setlocal</span> command to it. (I’ve mentioned that every bat file I write starts with this command, and that also goes for bat files I indirectly write via other bat files.)</p>
<p class="tx">Nothing here is executing the <span class="sans_thesansmonocd_w5regular_">setlocal</span> command; this code treats it as simple text as it redirects or writes it to <i class="calibre6">Daughter.bat</i>. Don’t think of it as a <span class="sans_thesansmonocd_w5regular_">setlocal</span> command, but as a <i class="calibre6">proto</i>-<span class="sans_thesansmonocd_w5regular_">setlocal</span> command. Three spaces follow the name of the <span class="sans_thesansmonocd_w5regular_">echo</span> command; the first space delimits the command itself from the text it’s writing, and the next two spaces are part of the text it writes to the file. Functionally, the two additional spaces aren’t necessary, but for aesthetics I always indent, again even in dynamically created bat files.</p>
<p class="tx">Multiple commands performing redirection appear to have two <span class="sans_thesansmonocd_w5regular_">echo</span> commands each. Taking the last of these commands <span aria-label="annotation5" class="codeannotation">❺</span> first, the initial <span class="sans_thesansmonocd_w5regular_">echo</span> writes a line to the child bat file, a line consisting entirely of the <span class="sans_thesansmonocd_w5regular_">&gt; con echo.</span> text. The caret escape character is critical here. Without it, the interpreter would treat the greater-than sign after it like a second redirection operator, which obviously wouldn’t be good. With the caret, the greater-than sign is just another character written to the child bat file.</p>
<p class="tx">The two prior commands look quite similar to each other. Both are writing a record to <i class="calibre6">Daughter.bat</i>; both records will be <span class="sans_thesansmonocd_w5regular_">echo</span> commands writing something to the console, and both are using the caret as an escape character for its redirection character. There is, however, a critical difference between them.</p>
<p class="tx">Each writes distinctive text after the asterisks, but that’s trivial. The first command <span aria-label="annotation3" class="codeannotation">❸</span> has a second percent sign in what looks to be the resolution of the filename. Don’t be fooled by the subtlety; it’s the crux of this entire chapter. The text in the second command <span aria-label="annotation4" class="codeannotation">❹</span> does in fact resolve to the name of the parent bat file. But in the first command <span aria-label="annotation3" class="codeannotation">❸</span>, the first percent sign is the escape character for the second percent sign, meaning that the interpreter resolves the two characters to a single percent sign and writes it as a simple text character to the file. Thus, the tilde and other characters that come next have no special meaning to Batch in this context, so the interpreter also writes them unchanged as text to the child bat file.</p>
<p class="tx">Not to put too fine a point on this, but here’s how the interpreter handles these similar text strings when writing the child bat file:</p>
<ul class="ul">
<li class="listbullet">The <span class="sans_thesansmonocd_w5regular_">"%%~NX0"</span> text <span aria-label="annotation3" class="codeannotation">❸</span> becomes <span class="sans_thesansmonocd_w5regular_">"%~NX0"</span>.</li>
<li class="listbullet">The <span class="sans_thesansmonocd_w5regular_">"%~NX0"</span> text <span aria-label="annotation4" class="codeannotation">❹</span> becomes <span class="sans_thesansmonocd_w5regular_">"Mother.bat"</span>.</li>
</ul>
<p class="tx">The parent bat file writes one last line, which will become a <span class="sans_thesansmonocd_w5regular_">pause</span> command <span aria-label="annotation6" class="codeannotation">❻</span>, to the child bat file. Finally, an actual <span class="sans_thesansmonocd_w5regular_">pause</span> command <span aria-label="annotation7" class="codeannotation">❼</span> rounds out <i class="calibre6">Mother.bat</i>.</p>
<p class="tx"><span aria-label=" Page 296. " epub:type="pagebreak" id="pg_296" role="doc-pagebreak"/>Now we can execute <i class="calibre6">Mother.bat</i>, the bat-file-building bat file shown in <a href="#Lis25-1" class="calibre3">Listing 25-1</a>. The <span class="sans_thesansmonocd_w5regular_">"%~NX0"</span> from the first section of its code <span aria-label="annotation1" class="codeannotation">❶</span> resolves to <span class="sans_thesansmonocd_w5regular_">"Mother.bat"</span>, and the following appears on the console:</p>
<pre class="pre"><code class="calibre11">***** This bat files is "Mother.bat".

Press any key to continue ...
</code></pre>
<p class="tni">That <span class="sans_thesansmonocd_w5regular_">pause</span> command at the very end of <i class="calibre6">Mother.bat</i> holds the console open so that we can read this message.</p>
<p class="tx">More interesting, <i class="calibre6">Mother.bat</i> creates <i class="calibre6">Daughter.bat</i>, a fully functional bat file. This point cannot be stressed enough; the bat file shown in <a href="#Lis25-2" class="calibre3">Listing 25-2</a> was <i class="calibre6">not</i> created directly by a human.</p>
<span id="Lis25-2"/>
<pre class="pre"><code class="calibre11">@setlocal EnableExtensions EnableDelayedExpansion
@echo off
&gt; con echo ***** This bat file is "%~NX0".
&gt; con echo ***** It was created by "Mother.bat".
&gt; con echo.
pause
</code></pre>
<p class="listingcaption"><span class="futura_std_book_oblique_i_">Listing 25-2: The child bat file,</span> <span class="sans_futura_std_book_">Daughter.bat</span></p>
<p class="tx">The child bat file has six records with the two most interesting ones in the middle. As expected, the interpreter resolved <span class="sans_thesansmonocd_w5regular_">"%%~NX0"</span> from <i class="calibre6">Mother.bat</i> (<a href="#Lis25-1" class="calibre3">Listing 25-1</a>) to <span class="sans_thesansmonocd_w5regular_">"%~NX0"</span> in the first of these <span class="sans_thesansmonocd_w5regular_">echo</span> commands in <i class="calibre6">Daughter.bat</i>. This will be important when <i class="calibre6">Daughter.bat</i> itself (herself?) executes. Likewise, the next <span class="sans_thesansmonocd_w5regular_">echo</span> command in the child bat file contains the <span class="sans_thesansmonocd_w5regular_">"Mother.bat"</span> text, which the interpreter resolved from <span class="sans_thesansmonocd_w5regular_">"%~NX0"</span> in the parent bat file.</p>
<p class="tx">This culminates in the execution of the child bat file, <i class="calibre6">Daughter.bat</i>. Run it as you would any other bat file, and it writes the following to the console:</p>
<pre class="pre"><code class="calibre11">***** This bat file is "Daughter.bat".
***** It was created by "Mother.bat".

Press any key to continue ...
</code></pre>
<p class="tx">When the child bat file executes, the interpreter resolves <span class="sans_thesansmonocd_w5regular_">"%~NX0"</span> in the first redirected <span class="sans_thesansmonocd_w5regular_">echo</span> command to <span class="sans_thesansmonocd_w5regular_">"Daughter.bat"</span>. The next line of output comes from the <span class="sans_thesansmonocd_w5regular_">echo</span> command containing the already resolved <span class="sans_thesansmonocd_w5regular_">"Mother.bat"</span>.</p>
<p class="tx">As a recap, let’s follow the flow from the parent to the child to the child’s output. When the parent bat file executes, <span class="sans_thesansmonocd_w5regular_">"%%~NX0"</span> becomes <span class="sans_thesansmonocd_w5regular_">"%~NX0"</span> in the child bat file—again, two percent signs resolve to one due to escaping. Then when the child bat file executes, <span class="sans_thesansmonocd_w5regular_">"%~NX0"</span> resolves to <span class="sans_thesansmonocd_w5regular_">"Daughter.bat"</span> in the final output.</p>
<p class="tx">Contrast that with <span class="sans_thesansmonocd_w5regular_">"%~NX0"</span> in the parent bat file, which becomes <span class="sans_thesansmonocd_w5regular_">"Mother .bat"</span> in the child bat file. At that point it’s hardcoded text, at least from the perspective of the child, and when the child bat file executes, it writes <span class="sans_thesansmonocd_w5regular_">"Mother.bat"</span> to the console.</p>
<p class="tx"><span aria-label=" Page 297. " epub:type="pagebreak" id="pg_297" role="doc-pagebreak"/>This example demonstrates two important points. First, it’s very possible for a bat file to create another fully functional bat file. Second, some text containing escape characters can become a <i class="calibre6">resolvable</i> variable in the child, not a resolved variable. Put another way, the parent can write some text to the child, and when the child executes, that text resolves a variable to its value. But this example just touches on what’s possible.</p>
<p class="tx">No one will confuse this process with the artificial intelligence that might someday kill or enslave all of humanity, but I wouldn’t call <i class="calibre6">Mother.bat</i> a dumb bat file.</p>
</section>
<section aria-labelledby="sec2" epub:type="division">
<h3 class="h" id="sec2"><span id="h1-170"/><span class="sans_futura_std_bold_b_">Variable Resolution</span></h3>
<p class="tni">You can now resolve the hidden parameter in either the parent or child bat file, but resolving ordinary variables in either bat file is equally if not more important.</p>
<p class="tx">Variables delimited by percent signs and exclamation marks behave a bit differently. To demonstrate, the following listing uses two system variables set on all Windows computers: <span class="sans_thesansmonocd_w5regular_">computername</span> is the name of the computer, and <span class="sans_thesansmonocd_w5regular_">os</span> is the machine’s operating system (<span class="xref"><a href="chapter21.xhtml" class="calibre3">Chapter 21</a></span>). This code creates a small bat file named <i class="calibre6">Dynamic.bat</i>:</p>
<pre class="pre"><code class="calibre11">set batDyn=C:\Batch\Dynamic.bat 
&gt;  %batDyn% echo   @setlocal EnableExtensions EnableDelayedExpansion
&gt;&gt; %batDyn% echo   @echo off 
<span aria-label="annotation1" class="codeannotationhang">❶</span><span class="sans_thesansmonocd_w5regular_"> &gt;&gt; %batDyn% echo   ^&gt; con echo This bat was built on %computername%,</span>
&gt;&gt; %batDyn% echo   ^&gt; con echo       using the operating system !os!.
<span aria-label="annotation2" class="codeannotationhang">❷</span><span class="sans_thesansmonocd_w5regular_"> &gt;&gt; %batDyn% echo   ^&gt; con echo This bat is running on %%computername%%,</span>
&gt;&gt; %batDyn% echo   ^&gt; con echo       using the operating system ^^!os^^!.
&gt;&gt; %batDyn% echo   pause
</code></pre>
<p class="tx">I’ve encased the first reference to <span class="sans_thesansmonocd_w5regular_">computername</span> in a single set of percent signs <span aria-label="annotation1" class="codeannotation">❶</span>, and in the next command, I’ve set the first reference to <span class="sans_thesansmonocd_w5regular_">os</span> between a single set of exclamation marks. (Either delimiter works for either variable; I’m merely comparing and contrasting the two.) Both variables resolve to their respective values when these two <span class="sans_thesansmonocd_w5regular_">echo</span> commands execute, perhaps writing the following to the dynamic bat file:</p>
<pre class="pre"><code class="calibre11">&gt; con echo This bat was built on JACKLAPTOP,
&gt; con echo       using the operating system Windows_NT.
</code></pre>
<p class="tx">However, the next two <span class="sans_thesansmonocd_w5regular_">echo</span> commands <span aria-label="annotation2" class="codeannotation">❷</span> write the following two lines:</p>
<pre class="pre"><code class="calibre11">&gt; con echo This bat is running on %computername%,
&gt; con echo       using the operating system !os!.
</code></pre>
<p class="tx">When the interpreter encounters <span class="sans_thesansmonocd_w5regular_">%%computername%%</span>, it doesn’t see a variable. Since the percent sign is the escape character for itself, each pair resolves to a single percent sign, and the text between them isn’t a variable <span aria-label=" Page 298. " epub:type="pagebreak" id="pg_298" role="doc-pagebreak"/>name; it’s just along for the ride, at least for now. As detailed in <span class="xref"><a href="chapter14.xhtml" class="calibre3">Chapter 14</a></span>, escaping the exclamation mark is a bit trickier, but <span class="sans_thesansmonocd_w5regular_">^^!os^^!</span> similarly resolves to <span class="sans_thesansmonocd_w5regular_">!os!</span>.</p>
<p class="tx">Execute the child bat file, <i class="calibre6">Dynamic.bat</i>, on any computer, and the first pair of <span class="sans_thesansmonocd_w5regular_">echo</span> commands write what is now hardcoded text to the console—that is, they write the information derived from the machine where the first bat file ran. The next two <span class="sans_thesansmonocd_w5regular_">echo</span> commands, however, have two variables that resolve when <i class="calibre6">Dynamic.bat</i> executes, and their values reflect the computer name and operating system of the computer on which this child bat file runs.</p>
<p class="tx">Let’s look at a real-world application to demonstrate when it makes sense to resolve variables as we write them to the child bat file and when it makes sense to resolve them as the child executes.</p>
</section>
<section aria-labelledby="sec3" epub:type="division">
<h3 class="h" id="sec3"><span id="h1-171"/><span class="sans_futura_std_bold_b_">A Real-World Application</span></h3>
<p class="tni">The prior examples show how you can resolve variables and parameters in a dynamically created bat file, but these examples are pedagogical at their core. There’s no practical use for a bat file that does nothing more than announce its lineage and current status. A real-world bat-file-building bat file will do much more and be far more useful.</p>
<p class="tx">For instance, it will likely transmit variables from the parent to the child. As any bat file executes, it accumulates and modifies variables, but nothing automatically imbues those variables to a dynamically created bat file. A simple way of ensuring that a variable is preserved in its scion is to write a <span class="sans_thesansmonocd_w5regular_">set</span> command defining that variable to the child. When that bat file runs, the <span class="sans_thesansmonocd_w5regular_">set</span> command executes, and the variable is available for the remainder of its execution or until it’s reset.</p>
<p class="tx">I’ve already demonstrated how to write a single line of code with an <span class="sans_thesansmonocd_w5regular_">echo</span> command, but you can also write the contents of an entire file into a dynamically created bat file with a <span class="sans_thesansmonocd_w5regular_">type</span> command (<span class="xref"><a href="chapter12.xhtml" class="calibre3">Chapter 12</a></span>). Typically, I start a child bat file with a prologue static file and end it with an epilogue static file.</p>
<p class="tx">The prologue static file probably starts with a <span class="sans_thesansmonocd_w5regular_">setlocal</span> command (because most bat files should), and it likely sets some variables, but after that the contents could be anything. What’s important is that this file contains the hardcoded Batch code that’ll begin each bat file the process dynamically creates. Likewise, the epilogue static file contains all of the common code needed to complete all child bat files. At the very least it usually contains some callable routines and error handling.</p>
<p class="tx">Static bat files don’t have to come at the beginning and ending of dynamically created bat files. You can insert others with multiple <span class="sans_thesansmonocd_w5regular_">type</span> commands interspersed with the <span class="sans_thesansmonocd_w5regular_">echo</span> commands. You can even store just a few lines of code in a static file to avoid the need for escaping.</p>
<p class="tx">The following listing contains a template for a real-world bat-building bat:</p>
<span aria-label=" Page 299. " epub:type="pagebreak" id="pg_299" role="doc-pagebreak"/>
<pre class="pre"><code class="calibre11">set batDyn=C:\Batch\Dynamic.bat
<span aria-label="annotation1" class="codeannotationhang">❶</span> &gt;  %batDyn% type C:\Batch\StaticPrologue.bat
<span aria-label="annotation2" class="codeannotationhang">❷</span> &gt;&gt; %batDyn% echo.
<span aria-label="annotation3" class="codeannotationhang">❸</span> &gt;&gt; %batDyn% echo   set someVar=%someVar%
&gt;&gt; %batDyn% echo   set someOtherVar=%someOtherVar%
<span aria-label="annotation4" class="codeannotationhang">❹</span> &gt;&gt; %batDyn% echo   set parentPath=%path%
&gt;&gt; %batDyn% echo.
<span aria-label="annotation5" class="codeannotationhang">❺</span> &gt;&gt; %batDyn% echo   %someExe%
<span aria-label="annotation6" class="codeannotationhang">❻</span> &gt;&gt; %batDyn% echo   if %%errorlevel%% neq 0 ^(
<span aria-label="annotation7" class="codeannotationhang">❼</span> &gt;&gt; %batDyn% echo      ^&gt; con echo Some EXE FAILED
&gt;&gt; %batDyn% echo      pause
&gt;&gt; %batDyn% echo      goto :Abort
<span aria-label="annotation8" class="codeannotationhang">❽</span> &gt;&gt; %batDyn% echo   ^)
<span aria-label="annotation9" class="codeannotationhang">❾</span> &gt;&gt; %batDyn% type C:\Batch\StaticEpilogue.bat
</code></pre>
<p class="tx">At first glance, the redirection <span aria-label="annotation1" class="codeannotation">❶</span> that begins the creation of <i class="calibre6">Dynamic.bat</i> might look like the first of many <span class="sans_thesansmonocd_w5regular_">echo</span> commands, but this is the first of two <span class="sans_thesansmonocd_w5regular_">type</span> commands in the listing. This one writes the entirety of the <i class="calibre6">StaticPrologue.bat</i> file into the dynamically created bat file.</p>
<p class="tx">Two <span class="sans_thesansmonocd_w5regular_">echo</span> commands <span aria-label="annotation3" class="codeannotation">❸</span> demonstrate the technique for maintaining a parent variable in the child bat file. The argument of each burgeoning <span class="sans_thesansmonocd_w5regular_">set</span> command has the variable name to the left of the equal sign and its resolved value to the right. It looks redundant, but this turns into a hardcoded <span class="sans_thesansmonocd_w5regular_">set</span> command assigning a value to a variable in the child bat file.</p>
<p class="tx">The next <span class="sans_thesansmonocd_w5regular_">echo</span> command <span aria-label="annotation4" class="codeannotation">❹</span> demonstrates a twist on this technique; the new variable gets a new name. The child bat file might need to know the <span class="sans_thesansmonocd_w5regular_">path</span> variable used by the parent bat file, but we don’t want to impact the child’s own <span class="sans_thesansmonocd_w5regular_">path</span> variable. This command writes a <span class="sans_thesansmonocd_w5regular_">set</span> command that will eventually assign the full contents of the parent’s <span class="sans_thesansmonocd_w5regular_">path</span> variable to a variable named <span class="sans_thesansmonocd_w5regular_">parentPath</span> when <i class="calibre6">Dynamic.bat</i> executes.</p>
<p class="tx">There are two reasons to use the technique of escaping when creating a dynamic bat file. First, percent signs and exclamation marks used to resolve variables need escaping—sometimes. It all depends on when we should resolve the variable.</p>
<p class="tx"><i class="calibre6">Dynamic.bat</i> will invoke some executable and then check the return code. In this example, let’s assume that the executable is known when we create the dynamic bat file. For that reason, I’m simply resolving the variable as <span class="sans_thesansmonocd_w5regular_">%someExe%</span> <span aria-label="annotation5" class="codeannotation">❺</span> and writing it directly to the dynamic bat file where it will be hardcoded text.</p>
<p class="tx">The return code <span aria-label="annotation6" class="codeannotation">❻</span> is a very different story; clearly, we should <i class="calibre6">not</i> resolve it until this command executes as the dynamic bat file runs, so I’m using escape characters for the delimiters. The interpreter sees <span class="sans_thesansmonocd_w5regular_">%%errorlevel%%</span> and writes <span class="sans_thesansmonocd_w5regular_">%errorlevel%</span> to the file. Without the escape characters, the variable would have simply resolved to its state at the time it was written, likely <span class="sans_thesansmonocd_w5regular_">0</span>, resulting in a perpetually false conditional clause: <span class="sans_thesansmonocd_w5regular_">if 0 neq 0</span>. The escape characters leave this as a variable yet to be resolved.</p>
<p class="tx">The second reason to use escaping in a dynamic bat file is when the character has some other special significance in Batch. For instance, always escape pipes and ampersands when they are to be part of the dynamic <span aria-label=" Page 300. " epub:type="pagebreak" id="pg_300" role="doc-pagebreak"/>code. In this example, we need to escape the open <span aria-label="annotation6" class="codeannotation">❻</span> and close <span aria-label="annotation8" class="codeannotation">❽</span> parentheses around the code block, as well as the redirection symbol or greater-than sign <span aria-label="annotation7" class="codeannotation">❼</span> inside of the code block.</p>
<p class="tx">Assuming that <span class="sans_thesansmonocd_w5regular_">someExe</span> is set to a particular value, the interpreter might write the section of code between <span aria-label="annotation5" class="codeannotation">❺</span> and <span aria-label="annotation8" class="codeannotation">❽</span> to the dynamic bat file as:</p>
<pre class="pre"><code class="calibre11">C:\Batch\SomeExecutable.exe
if %errorlevel% neq 0 (
   &gt; con echo Some EXE FAILED
   pause
   goto :Abort
)
</code></pre>
<p class="tx">The second <span class="sans_thesansmonocd_w5regular_">type</span> command <span aria-label="annotation9" class="codeannotation">❾</span> rounds out this listing and writes the entirety of <i class="calibre6">StaticEpilogue.bat</i> to the dynamic file. It probably uses the three variables that the earlier code explicitly wrote to the dynamic bat file. Given the <span class="sans_thesansmonocd_w5regular_">goto</span> command inside the code block, I’m also very confident that there is an <span class="sans_thesansmonocd_w5regular_">:Abort</span> label somewhere in this file. Whatever its contents, they’ll complete the dynamic bat file.</p>
<p class="tx">But the writing of static files to child bat files has one subtle batveat. I’ve passed over one very critical command in the code, so critical that I’ve saved it for last. Immediately after the first <span class="sans_thesansmonocd_w5regular_">type</span> command writes the static prologue data to the dynamically created bat file, a simple <span class="sans_thesansmonocd_w5regular_">echo</span> command <span aria-label="annotation2" class="codeannotation">❷</span> appends a blank line to <i class="calibre6">Dynamic.bat</i>.</p>
<p class="tx">You might assume that I did this to simply separate the static code and the coming <span class="sans_thesansmonocd_w5regular_">set</span> commands in the new bat file, and that would’ve been a wonderful justification in its own right. After all, a blank line after the <span class="sans_thesansmonocd_w5regular_">set</span> commands <span aria-label="annotation4" class="codeannotation">❹</span> also creates some whitespace solely for this purpose, but the first blank line is for much more than aesthetics.</p>
<p class="tx">To explain the problem that this blank line is fixing, I once shared this bat-building bat technique with a co-worker who ended the equivalent of his <i class="calibre6">StaticPrologue.bat</i> with the setting of a critical variable:</p>
<pre class="pre"><code class="calibre11">set criticalVar=criticalValue</code></pre>
<p class="tni">This data is the very end of the file; there isn’t even a trailing blank line. It will be crucial momentarily.</p>
<p class="tx">After the <span class="sans_thesansmonocd_w5regular_">type</span> command in his main bat file, he didn’t write a blank line. Instead, he set a variable:</p>
<pre class="pre"><code class="calibre11">&gt;&gt; %batDyn% echo   set someVar=%someVar%</code></pre>
<p class="tx">The ultimate result was this line of code in the middle of his dynamic bat file:</p>
<pre class="pre"><code class="calibre11">set criticalVar=criticalValue  set someVar=Whatever</code></pre>
<p class="tx"><span aria-label=" Page 301. " epub:type="pagebreak" id="pg_301" role="doc-pagebreak"/>What looks to be a second <span class="sans_thesansmonocd_w5regular_">set</span> command isn’t a command at all; it’s just more text, including the spaces, appended to the intended value of the <i class="calibre6">actual</i> <span class="sans_thesansmonocd_w5regular_">set</span> command. The result is dynamic code that doesn’t set <span class="sans_thesansmonocd_w5regular_">criticalVar</span> to the intended value and doesn’t set <span class="sans_thesansmonocd_w5regular_">someVar</span> at all. It’s pretty obvious that the result is garbage, but what caused this?</p>
<p class="tx">When the interpreter performs an <span class="sans_thesansmonocd_w5regular_">echo</span> command redirected to a file, it appends the text to the very end of the target file. Then the interpreter immediately appends the two characters for a carriage return line feed, or more informally, it adds a CRLF. (I detailed the CRLF in <span class="xref"><a href="chapter14.xhtml" class="calibre3">Chapter 14</a></span>.) The end result is that when you view it in an editor, there’s an empty line at the bottom of the file. When you redirect multiple <span class="sans_thesansmonocd_w5regular_">echo</span> commands one after another, each command appends a line of text and a CRLF so that the next command appends its text as a new record.</p>
<p class="tx">That works great when you create the file exclusively with dynamically generated code via <span class="sans_thesansmonocd_w5regular_">echo</span> commands, but the <span class="sans_thesansmonocd_w5regular_">type</span> command writes an entire file just as it is into the target without adding a CRLF. That causes a potential problem if the creator of the static bat file didn’t append a CRLF onto the final record of the file. (That is, they didn’t position the cursor at the end of the last record, hit <small class="calibre5">ENTER</small>, and save the file.) When the interpreter writes the static file missing that CRLF to the dynamic bat file and then tries to append a record via an <span class="sans_thesansmonocd_w5regular_">echo</span> command, it actually appends that record to the final record of the copied static data instead, resulting in the dog’s breakfast we see here. (It also results in a frustrated co-worker trying to figure out why a couple variables aren’t resolved as expected.)</p>
<p class="tx">The <span class="sans_thesansmonocd_w5regular_">echo.</span> command <span aria-label="annotation2" class="codeannotation">❷</span> writes a null or blank record (not even any spaces) and, more important, a CRLF. Its inclusion here ensures that if the CRLF is missing from the last record of the static file, the code will insert another CRLF in the dynamically created bat file, and if it isn’t missing, it writes a null record, which nicely separates the sections of code. If you’re really counting on that whitespace, write two blank lines.</p>
<p class="tx">It seems like a never-ending battle to make code bullet-proof and to anticipate every possible condition that can break it, but there are two primary means of avoiding this issue: ensure that every static file you use ends with a CRLF, or write the blank line after every <span class="sans_thesansmonocd_w5regular_">type</span> command that doesn’t complete the child bat file. I find it far easier to control this in the code with the latter option, but it’s not a bad idea to always do both.</p>
</section>
<section aria-labelledby="sec4" epub:type="division">
<h3 class="h" id="sec4"><span id="h1-172"/><span class="sans_futura_std_bold_b_">Multigenerational Bat Files</span></h3>
<p class="tni">The quote “Give me a lever long enough and a fulcrum on which to place it, and I shall move the world” is attributed to Archimedes. I’d like to think that if the ancient Greeks had Batch, the great thinker would’ve said, “Give me enough escape characters and disk space, and I shall create an infinite bat-file-creating bat file.” Undoubtedly, this quote pales in comparison to the original, but escape characters can be escaped, and bat files aren’t limited to a single generation of offspring.</p>
<p class="tx"><span aria-label=" Page 302. " epub:type="pagebreak" id="pg_302" role="doc-pagebreak"/>Stripped of everything superfluous, this bare-bones version of <i class="calibre6">Mother.bat</i> will create a child bat file that’ll create a progeny of its own:</p>
<pre class="pre"><code class="calibre11">set batDtr=C:\Batch\Daughter.bat
&gt;  %batDtr% echo   set batGDtr=C:\Batch\GrandDaughter.bat
&gt;&gt; %batDtr% echo   ^&gt;   %%batGDtr%% echo   @echo off
&gt;&gt; %batDtr% echo   ^&gt;^&gt; %%batGDtr%% echo   ^^^&gt; con echo I am "%%%%~NX0"
&gt;&gt; %batDtr% echo   ^&gt;^&gt; %%batGDtr%% echo   ^^^&gt; con echo Begat by "%%~NX0"
&gt;&gt; %batDtr% echo   ^&gt;^&gt; %%batGDtr%% echo   ^^^&gt; con echo Begat by "%~NX0"
&gt;&gt; %batDtr% echo   ^&gt;^&gt; %%batGDtr%% echo   pause
</code></pre>
<p class="tx">Executing <i class="calibre6">Mother.bat</i> produces <i class="calibre6">Daughter.bat</i>:</p>
<pre class="pre"><code class="calibre11">set batGDtr=C:\Batch\GrandDaughter.bat
&gt;  %batGDtr% echo   @echo off
&gt;&gt; %batGDtr% echo   ^&gt; con echo I am "%%~NX0"
&gt;&gt; %batGDtr% echo   ^&gt; con echo Begat by "%~NX0"
&gt;&gt; %batGDtr% echo   ^&gt; con echo Begat by "Mother.bat"
&gt;&gt; %batGDtr% echo   pause
</code></pre>
<p class="tni">Notice that <span class="sans_thesansmonocd_w5regular_">^&gt;</span> escapes to <span class="sans_thesansmonocd_w5regular_">&gt;</span> and <span class="sans_thesansmonocd_w5regular_">%%</span> escapes to <span class="sans_thesansmonocd_w5regular_">%</span>, but by escaping the escape character, <span class="sans_thesansmonocd_w5regular_">^^^&gt;</span> becomes <span class="sans_thesansmonocd_w5regular_">^&gt;</span> and <span class="sans_thesansmonocd_w5regular_">%%%%</span> becomes <span class="sans_thesansmonocd_w5regular_">%%</span>.</p>
<p class="tx">Executing <i class="calibre6">Daughter.bat</i> produces <i class="calibre6">GrandDaughter.bat</i>:</p>
<pre class="pre"><code class="calibre11">@echo off
&gt; con echo I am "%~NX0"
&gt; con echo Begat by "Daughter.bat"
&gt; con echo Begat by "Mother.bat"
pause
</code></pre>
<p class="tx">Running <i class="calibre6">GrandDaughter.bat</i> produces the following output to the console where <span class="sans_thesansmonocd_w5regular_">%~NX0</span> resolves one last time, this time to <span class="sans_thesansmonocd_w5regular_">"GrandDaughter.bat"</span>:</p>
<pre class="pre"><code class="calibre11">I am "GrandDaughter.bat"
Begat by "Daughter.bat"
Begat by "Mother.bat"
Press any key to continue ...
</code></pre>
<p class="tx">I have an admission to make. This last example is nothing more than an egregious instance of the author shamelessly showing off—the coder’s equivalent of an endzone dance or a geek version of trash talk after a dunk. I’ve been coding in Batch for many years, and this is the first time I’ve ever even thought to code a bat that builds a bat that builds a bat. I’ve done it here only to show what’s possible and am hard-pressed to come up with a real-world application for it, but there are many uses for a bat file that creates a second bat file.</p>
</section>
<section aria-labelledby="sec5" epub:type="division">
<h3 class="h" id="sec5"><span id="h1-173"/><span aria-label=" Page 303. " epub:type="pagebreak" id="pg_303" role="doc-pagebreak"/><span class="sans_futura_std_bold_b_">Recommendations</span></h3>
<p class="tni">You can use the real-world application discussed earlier as a template for more complex dynamic bat files. It has all the pieces you’ll need: it assigns variables, using existing and new names; it uses escaping to allow variables to be resolved later; it escapes other special characters to be used in the child bat file; and it uses partial static bat files in tandem with the dynamically generated code.</p>
<p class="tx">This technique is great when a process grows to the point where you need to break it down into smaller chunks and execute them independently. Perhaps you’ll base the breakdown on the size of the input so you can write a bat file to build one to many dynamically created bat files after inspecting that input. Put another way, you can dynamically create a dynamic number of subprocesses.</p>
<p class="tx">The different subprocesses might even end up running on different servers to balance the load. You might be able to use static bat files for those subprocesses, but when you dynamically generate the other bat files, you can imbue them with information gathered during the execution of the original bat file.</p>
<p class="tx">Some might protest that you can pass the dynamic information as arguments to the second bat file, but that works only if the first bat actually calls the second. Some completely different process might execute your dynamically created bat file. That process doesn’t have to pass any arguments or even understand the contents of the bat file or its function. You can even create a bat file, hold it, and execute it at a later time.</p>
</section>
<section aria-labelledby="sec6" epub:type="division">
<h3 class="h" id="sec6"><span id="h1-174"/><span class="sans_futura_std_bold_b_">Summary</span></h3>
<p class="tni">In this chapter, I showed how a bat file can build another bat file. After a detailed demonstration, I discussed how to write resolved variables and resolvable variables to a dynamic bat file. I also shared some techniques that I use for creating variables in a dynamic bat file and building these bat files with both dynamic and static code. You learned situations in which dynamically created bat files are most useful and applicable.</p>
<p class="tx">In the next chapter, I’ll demonstrate an intriguing application of a bat-building bat. After discussing a very useful technique of automatically restarting an intermittent failure, I’ll apply lessons from this chapter to perform an even more difficult task, killing and restarting a hung execution. We’ll dynamically create a second bat file to call the process susceptible to hanging and monitor it from the first bat file. It’s amazing how problems start to find solutions in tools from an expanding toolkit.</p>
</section>
</section>
</div></body></html>