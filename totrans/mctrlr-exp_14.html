<html><head></head><body>
<div id="book-content">
<div id="sbo-rt-content"><h2 class="h2a" id="ch14"><span epub:type="pagebreak" id="page_137"/><strong>14  MC13224, the Simplest Fault Injection</strong></h2>&#13;
<p class="noindent">Let’s take a look at an exploit of mine from Goodspeed (2011), in which the Freescale MC13224 is unlocked by grounding out one of its pins during reset. This requires a custom PCB and a bit of hot air soldering, but it’s very reliable and does not involve any fancy software.</p>&#13;
<p class="indent">The MC13224 is a system-in-package (SiP) offering a 32-bit TDMI ARM7 CPU, with an 802.15.4 (Zigbee) radio. It has 128kB of SPI flash, 96kB of RAM, and 80kB of ROM implementing the 15.4 MAC functions. This was the chip used in the Defcon 18 Ninja Badge, Wozniak and Creighton (2010). Its selling point is that a 50Ω trace antenna tuned for 2.4GHz is all that you need to add as an antenna chain, with everything else but the crystals included internally.</p>&#13;
<p class="indent">System-in-package is a great way to make the PCB designer’s life easier, but you can see from the decapsulated photos in <a href="ch14.xhtml#ch14fig1">Figure 14.1</a> that this package is really three little chips in a trench-coat, trying to act like an adult.<sup><a id="ch14fn_1" href="footnotes.xhtml#ch14fn1">1</a></sup> The smallest chip is a radio balun, the largest is a CPU combined with a radio, and the third chip is flash memory.</p>&#13;
<p class="indent">Because the flash memory is on a separate die and the MC13224 has no execute-in-place feature, it is unable to execute code from flash memory directly. Rather, a ROM bootloader copies a working image from flash memory into RAM. If the security word “<code>OKOK</code>” is seen at the beginning of the image, then JTAG access is enabled before the bootloader branches into RAM. If the security word is instead set to “<code>SECU</code>,” then JTAG access is not enabled and the chip remains in its default, locked state.</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_138"/><img id="ch14fig1" src="../images/f0138-01.jpg" alt="Image" width="778" height="1065"/></div>&#13;
<p class="figcap">Figure 14.1: Decapsulated MC13224</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_139"/><img id="ch14fig2" src="../images/f0139-01.jpg" alt="Image" width="777" height="450"/></div>&#13;
<p class="figcap">Figure 14.2: SST25WF010</p>&#13;
<p class="indent">Looking closer at the flash chip, we find the model number from text written on the die, shown in <a href="ch14.xhtml#ch14fig3">Figure 14.3</a>. It’s a standard SST25WF010 low-voltage SPI flash chip. One way to read this would be to decapsulate the target chip and then wire-bond this SPI flash chip back into a new package and read it with a low-voltage SPI adapter. That would certainly work, but we’d prefer a solution that doesn’t require expensive equipment like a wire bonder.</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_140"/><img id="ch14fig3" src="../images/f0140-01.jpg" alt="Image" width="777" height="672"/></div>&#13;
<p class="figcap">Figure 14.3: MC13224, Pin 133 in Bold</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_141"/>A better technique takes advantage of the fact that, while the SPI bus is not bound out to external pins, pin 133 (<code>NVM_REG</code>) is the voltage regulator output for the flash chip, which is exposed in order to allow an external voltage regulator to replace the internal one. In low-power applications, power might be saved by shutting this down after booting.</p>&#13;
<p class="indent">What happens when we cut power to the SST25WF010 flash memory by grounding out this pin? Freescale (2010) explains in Figure 3-22 on <a href="ch08.xhtml#page_93">page 93</a> that the MC13224 will enable JTAG access when the magic word is not found in flash memory. It will then try to boot from UART1 as a serial port, as a SPI slave, as a SPI master, or as an I2C master. If none of these methods work, the chip will hang in an infinite loop, but it hangs with JTAG enabled!</p>&#13;
<p class="indent">So all that is needed to recover a copy of an MC13224’s flash memory is a board that holds pin 133 low during a reset, then loads a new executable into RAM that—after the pin is allowed to swing high—will read firmware out of the recently powered SST25WF010 and exfiltrate it through an I/O pin.</p>&#13;
<p class="indent">Toward that end, I’ve made a small batch of modified Econotag boards in <a href="ch14.xhtml#ch14fig4">Figure 14.4</a> that expose this pin to a jumper. A pair of tweezers can then hold the line low during a reboot to unlock JTAG. Once the tweezers are removed, a client for the internal SST25 SPI flash chip can be used through the board’s built-in OpenOCD implementation to dump the firmware.</p>&#13;
<p class="indent">For more sophisticated attacks on dual-die microcontrollers, see the GD32F130 exploit in <a href="app04.xhtml#app04_2">Chapter D.2</a> or the MT1335WE exploit in <a href="app04.xhtml#app04_4">Chapter D.4</a>.</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_142"/><img id="ch14fig4" src="../images/f0142-01.jpg" alt="Image" width="1124" height="778"/></div>&#13;
<p class="figcap">Figure 14.4: Modified Econotag</p>&#13;
</div>
</div>
</body></html>