<?xml version='1.0' encoding='utf-8'?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" epub:prefix="z3998: http://www.daisy.org/z3998/2012/vocab/structure/#" lang="en" xml:lang="en">
  <head>
    <title>Project 20: Wi-Fi Remote-Controlled Robot</title>
    <link href="../styles/9781593278717.css" rel="stylesheet" type="text/css"/>
    <link href="../68851547a55f.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <div id="sbo-rt-content"><h2 class="h2" id="ch20"><span epub:type="pagebreak" id="page_247"/><strong>20<br/>Wi-Fi Remote-Controlled Robot</strong></h2>
<p class="noindent"><span class="orange">In this project you’re going to build a two-wheel, battery-powered robot with a Raspberry Pi Zero W and the MotoZero add-on. You can control it over Wi-Fi using a web app you’ll make with Node-RED.</span></p>
<div class="image"><span epub:type="pagebreak" id="page_248"/><img src="../images/f0248-01.jpg" alt="image"/></div>
<p class="cap"><span class="orange"><strong>PARTS REQUIRED</strong></span></p>
<p class="cap1">Raspberry Pi Zero W (or other 40 GPIO Raspberry Pi)</p>
<p class="cap1">Smart robot car chassis kit</p>
<p class="cap1">MotoZero add-on board (or other motor controller add-on)</p>
<p class="cap1">Four AA batteries</p>
<p class="cap1">Portable charger</p>
<p class="cap1">Jumper wires</p>
<p class="cap"><span class="orange"><strong>SOFTWARE REQUIRED</strong></span></p>
<p class="cap1">Node-RED dashboard</p>
<h3 class="h3" id="lev202"><span epub:type="pagebreak" id="page_249"/><span class="orange"><strong>PROJECT OUTLINE</strong></span></h3>
<p class="noindent">Rather than going straight into the project, we’ll highlight the most important parts of the robot to give you an idea of how it will all work.</p>
<p class="noindentt"><span class="orange"><strong>Wi-Fi</strong></span></p>
<p class="noindent1">You’ll control the robot with a Node-RED application, so your Raspberry Pi needs to have Wi-Fi. Raspberry Pi models 3 and Zero W have built-in Wi-Fi, but if your board doesn’t, you can use a Wi-Fi dongle compatible with the Pi.</p>
<p class="noindentt"><span class="orange"><strong>Raspberry Pi Board</strong></span></p>
<p class="noindent1">We’re using the Raspberry Pi Zero W because its small size makes it perfect for the small robot chassis. But any Raspberry Pi version with 40 GPIOs is compatible with this project as long as it has Wi-Fi.</p>
<p class="noindentt"><span class="orange"><strong>Robot Chassis Kit</strong></span></p>
<p class="noindent1">We’re using a robot chassis kit that comes with everything you need to build the robot, including wheels, motors, and screws. You can find the kit in online marketplaces like Amazon or eBay by searching for <em>Smart Car Robot Chassis Kit</em>. You need the kit with two DC motors.</p>
<p class="noindentt"><span class="orange"><strong>MotoZero Add-on</strong></span></p>
<p class="noindent1">The DC motors will make the robot move, and you’ll control them using an add-on board called MotoZero. One place to find the board is online at The Pi Hut (<em><a href="https://thepihut.com/motozero/">https://thepihut.com/motozero/</a></em>). You can also use any other Raspberry Pi–compatible motor driver add-on for this project or build a circuit with the LC293D IC chip. We won’t cover how to build that circuit here, but there are plenty of tutorials online if you want to make your own.</p>
<p class="noindentt"><span class="orange"><strong>Power</strong></span></p>
<p class="noindent1">We don’t want to connect the Pi robot to a wall socket, because we want it to be portable, so we need to power the robot with a portable charger, or <em>power bank</em>. The power bank must be capable of outputting 5 V and 2 A. We tested this project with a power bank that has 2,200 mAh capacity and it worked fine; incorporating a power bank with more capacity will make the robot run for longer.</p>
<p class="indent1">The DC motors need to be powered independently from the Pi, meaning you need two independent power sources. To power up the motors, we’re using the battery holder that comes with the chassis kit along with four AA batteries, not included in the kit.</p>
<p class="noindentt"><span epub:type="pagebreak" id="page_250"/><span class="orange"><strong>Node-RED Application</strong></span></p>
<p class="noindent1">The Node-RED application you’ll use to control your robot should be able to make the robot go forward and backward, move right and left, and stop. Since you’re not running the Pi as a desktop computer, the Pi needs to automatically start Node-RED when it boots. You’ll also add an off button to the application so you can turn the Raspberry Pi off remotely.</p>
<p class="indentt"><a href="ch20.xhtml#ch20fig1">Figure 20-1</a> shows a high-level overview of how your robot will work.</p>
<div class="image"><a id="ch20fig1"/><img src="../images/f0250-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 20-1:</strong> The robot structure</p>
<h3 class="h3" id="lev203"><span class="orange"><strong>PREPARING THE RASPBERRY PI</strong></span></h3>
<p class="noindent">We’re using the Raspberry Pi Zero W board, shown in <a href="ch20.xhtml#ch20fig2">Figure 20-2</a>, which is a variant of Raspberry Pi Zero that has built-in wireless LAN and Bluetooth, but remember that you can use another Wi-Fi compatible board or a Wi-Fi dongle. The Raspberry Pi Zero W measures only 2.56 inches × 1.18 inches × 0.20 inches (65 mm × 30 mm × 5 mm) and costs around $10.</p>
<p class="indent">The Pi Zero has 40 GPIO pins with the same pinout as the Pi 3. As you can see in <a href="ch20.xhtml#ch20fig2">Figure 20-2</a>, it features a mini HDMI connector and two micro USB connectors, one of which is used exclusively for power. To use the Pi Zero as a desktop computer, you need a few extra accessories like a USB hub, a USB-to-micro-USB adapter, and an HDMI-to-mini-HDMI adapter to connect the peripherals. To save <span epub:type="pagebreak" id="page_251"/>you some money, we’ll prepare everything on our regular Raspberry Pi 3 and then switch the micro SD card to the Pi Zero W.</p>
<div class="image"><a id="ch20fig2"/><img src="../images/f0251-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 20-2:</strong> Raspberry Pi Zero W</p>
<p class="indent">We recommend using a new micro SD card for this project. Refer to <a href="ch00.xhtml#lev10">“Uploading the Operating System”</a> on <a href="ch00.xhtml#page_10">page 10</a> to see how to install the latest Raspbian release on your new micro SD card.</p>
<p class="indent">After installing the operating system, insert the micro SD card on your regular Pi. Power up the Pi and wait a few seconds for the system to start. Then configure the Wi-Fi from the desktop’s top-right corner by clicking <strong>Wi-Fi</strong>. Next, enter your Wi-Fi password, and wait a few seconds for the Wi-Fi connection to successfully establish.</p>
<p class="indent">The Node-RED software is preinstalled on the Pi’s operating system, but you still need to install the Node-RED dashboard. For that, first update the library repositories, and then install npm (Node Package Management) by entering the following at your command line:</p>
<div class="box">
<pre>pi@raspberrypi:~ $ <span class="codestrong">sudo apt update</span><br/>pi@raspberrypi:~ $ <span class="codestrong">sudo apt install npm</span></pre>
</div>
<p class="indent">When prompted, type <span class="codestrong">Y</span> and press <small>ENTER</small>. The installation may take a few minutes. Then enter the following commands to upgrade npm to the latest 3.x version, which is the version recommended for use with Node-RED:</p>
<div class="box">
<pre>pi@raspberrypi:~ $ <span class="codestrong">sudo npm install -g npm@3.x</span><br/>pi@raspberrypi:~ $ <span class="codestrong">hash –r</span></pre>
</div>
<p class="indent">Finally, enter the following to install the Node-RED dashboard:</p>
<div class="box">
<pre>pi@raspberrypi:~ $ <span class="codestrong">sudo npm install --unsafe-perm -g node-red-dashboard</span></pre>
</div>
<p class="indent">Again, Node-RED needs to start automatically when the Pi boots. For that, enter the following command in the terminal.</p>
<div class="box">
<pre><span epub:type="pagebreak" id="page_252"/>pi@raspberrypi:~ $ <span class="codestrong">sudo systemctl enable nodered.service</span></pre>
</div>
<p class="indent">With that done, shut down your Pi and switch the micro SD card to the Raspberry Pi Zero W.</p>
<h3 class="h3" id="lev204"><span class="orange"><strong>WIRING THE CIRCUIT</strong></span></h3>
<p class="noindent">To build the robot structure you need a chassis for the robot, two DC motors with corresponding wheels, the MotoZero add-on, jumper wires, and your Pi (with Wi-Fi). Use <a href="ch20.xhtml#ch20fig1">Figure 20-1</a> as a reference. We’ll start by mounting the MotoZero at the top of the Raspberry Pi and then wire the motors to MotoZero.</p>
<h4 class="h4" id="lev205"><span class="orange"><strong>Wiring the DC Motors to MotoZero</strong></span></h4>
<p class="noindent">MotoZero allows you to control four motors independently, but you need to control just two DC motors. The MotoZero will come unassembled, so you need to solder its parts. The Pi Hut provides an assembly manual on the product’s page, so go to <em><a href="https://thepihut.com/motozero/">https://thepihut.com/motozero/</a></em> and follow the instructions there before continuing. Your MotoZero should look like <a href="ch20.xhtml#ch20fig3">Figure 20-3</a> after assembly.</p>
<div class="image"><a id="ch20fig3"/><img src="../images/f0252-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 20-3:</strong> Assembled MotoZero add-on</p>
<p class="indent"><a href="ch20.xhtml#ch20fig3">Figure 20-3</a> shows the connections you can make to MotoZero: positive (+) and negative (–) connections for four DC motors, and a positive (+) and negative (–) connection for the power supply. You need an external power source for driving the motors. The motors require a big jump in current to move, so using a separate power source prevents the Pi from suddenly losing power when this jump occurs.</p>
<p class="indent">Follow these instructions and refer to <a href="ch20.xhtml#ch20fig1">Figure 20-1</a> to wire the motors and battery holder.</p>
<ol>
<li class="noindent"><p class="list">Connect the right DC motor’s red wire to the Motor 1 positive (+) pin on the MotoZero, and its black wire to the Motor 1 negative (–) pin. You’ll need to loosen the screws, place the wires in the pin slot, and then tighten the screws again.</p></li>
<li class="noindent"><p class="list"><span epub:type="pagebreak" id="page_253"/>Repeat the previous instruction for the left motor, connecting the power wires to the MotoZero Motor 2 connections.</p></li>
<li class="noindent"><p class="list">Without inserting the batteries, connect the battery holder’s red wire to the positive (+) pin on the MotoZero power connector and its black wire to the negative (–) pin, shown at the bottom of the board in <a href="ch20.xhtml#ch20fig3">Figure 20-3</a>.</p></li>
</ol>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>If you find the robot’s wheels are spinning in the opposite direction of what you intended, you may have to switch the DC motors’ red wires with the black wires on the positive (+) and negative (–) Motor 1 or Motor 2 terminals. You’ll know if you need to do this when you test the application at the end of the project.</em></p>
</div>
<h4 class="h4" id="lev206"><span class="orange"><strong>Controlling the Motors with MotoZero</strong></span></h4>
<p class="noindent">Each DC motor has three GPIO pins associated with it. One pin, known as the <em>enable</em> pin, enables the motor and is like an on and off switch. The other two pins control the power to the positive and negative motor wires. Applying power to one wire and GND to the other makes the motor turn in one direction, while applying power and GND to the opposite motor wires moves the motor in the opposite direction.</p>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>For information about the Motor 3 and Motor 4 GPIOs, you can check the MotoZero manual at The Pi Hut’s product page</em> (<a href="https://thepihut.com/motozero/">https://thepihut.com/motozero/</a>).</p>
</div>
<p class="indent">We’re just using the Motor 1 and Motor 2 terminals, which are controlled by the GPIOs shown in the following table, when you mount the MotoZero on the top of the Pi.</p>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="border_th-r"><p class="tab_th"><strong>MOTOR 1</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>MOTOR 2</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">enable: GPIO 5</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">enable: GPIO 6</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">Motor 1 (+): GPIO 27</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">Motor 2 (+): GPIO 22</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">Motor 1 (–): GPIO 24</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">Motor 2 (–): GPIO 17</span></p></td>
</tr>
</tbody>
</table>
<p class="indent">To make a motor spin, the enable pin must be HIGH to turn the motor on, and one—and only one—of the positive or negative pins should be HIGH. For example, if you want Motor 1 to spin in one direction, use the following setup:</p>
<ul>
<li class="noindent">GPIO 5: HIGH</li>
<li class="noindent">GPIO 27: HIGH</li>
<li class="noindent">GPIO 24: LOW</li>
</ul>
<p class="indent">To make the same motor spin in the opposite direction, use this:</p>
<ul>
<li class="noindent">GPIO 5: HIGH</li>
<li class="noindent">GPIO 27: LOW</li>
<li class="noindent">GPIO 24: HIGH</li>
</ul>
<p class="indent">To turn off the motor, you’d send a LOW signal to all the GPIOs. The same logic applies to the other motors.</p>
<h3 class="h3" id="lev207"><span epub:type="pagebreak" id="page_254"/><span class="orange"><strong>WRITING THE APPLICATION</strong></span></h3>
<p class="noindent">Once you’ve built your hardware, it’s time to create the Node-RED application. As your Pi is already in your robot chassis, the most practical way to create the robot Node-RED application is to use your regular desktop or laptop computer and control it from there.</p>
<p class="indent">First you’ll need to find your Raspberry Pi Zero W IP address; you’ll use it to access the Pi’s Node-RED application dashboard, where you can create a robot application.</p>
<p class="indent">You need to make sure the Raspberry Pi is turned on and that your computer and Pi are connected to the same network before continuing.</p>
<h4 class="h4" id="lev208"><span class="orange"><strong>Finding the Raspberry Pi IP Address</strong></span></h4>
<div class="note">
<p class="notet"><span class="red"><strong>WARNING</strong></span></p>
<p class="notep"><em>The Raspberry Pi Zero W has two mini USB ports, and one of them, labeled</em> PWR IN, <em>is designated for powering up the Pi.</em></p>
</div>
<p class="noindent">Power up the Raspberry Pi by connecting the 5 V power adapter to a wall socket. You’ll only use this power source while creating the Node-RED application; once it’s ready, you should change to the portable power source.</p>
<p class="indent">You’ll find the Pi’s IP address using Angry IP Scanner software. Download it onto your regular desktop or laptop computer for free from <em><a href="http://angryip.org/download/">http://angryip.org/download/</a></em>, and then follow the prompts to install it.</p>
<p class="indent">Once the installation is complete, open Angry IP Scanner and click the <strong>Start</strong> button. Wait a few seconds until it shows the available IP addresses. Your Pi IP address should have <em>raspberrypi.lan</em> as a hostname, so jot down the corresponding IP address. <a href="ch20.xhtml#ch20fig4">Figure 20-4</a> highlights our Raspberry Pi IP address, which is 192.168.1.122.</p>
<div class="image"><a id="ch20fig4"/><img src="../images/f0254-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 20-4:</strong> Finding the Raspberry Pi IP address with the Angry IP Scanner software</p>
<h4 class="h4" id="lev209"><span epub:type="pagebreak" id="page_255"/><span class="orange"><strong>Creating the Node-RED Flow</strong></span></h4>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>For an introduction to Node-RED, see <a href="ch17.xhtml#ch17">Project 17</a>.</em></p>
</div>
<p class="noindent">On your regular computer, making sure it’s on the same network as your Pi, open a web browser tab and go to <em>http://&lt;Pi IP address&gt;:1880</em>, replacing <em>&lt;Pi IP address&gt;</em> with the Raspberry Pi IP address you noted earlier. In our case, we navigated to <em>http://192.168.1.122:1880</em>. Your Raspberry Pi Node-RED web server should open.</p>
<p class="indent">In the top-right corner of the window, select the <strong>dashboard</strong> tab and, inside the <strong>Layout</strong> tab, create a tab called <strong>Robot</strong>. Next, create two groups inside that Robot tab, called <strong>Main</strong> and <strong>Poweroff</strong>. The Main group is where you’ll organize the buttons that control the robot, and the Poweroff group is where you’ll add the button to remotely turn off your Raspberry Pi. Once you’ve completed these tabs and groups, your layout should look like <a href="ch20.xhtml#ch20fig5">Figure 20-5</a>.</p>
<div class="image"><a id="ch20fig5"/><img src="../images/f0255-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 20-5:</strong> Node-RED application dashboard layout</p>
<p class="indent">Add five buttons, a function, six rpi gpio output nodes, and an exec node to the flow. Wire the nodes and edit their names to match the ones in <a href="ch20.xhtml#ch20fig6">Figure 20-6</a>.</p>
<div class="image"><a id="ch20fig6"/><img src="../images/f0255-02.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 20-6:</strong> Node-RED application nodes</p>
<p class="indent"><span epub:type="pagebreak" id="page_256"/>Edit the function’s properties so that it has six outputs, assigning all of the nodes’ properties as shown in <a href="ch20.xhtml#ch20tab1">Table 20-1</a>.</p>
<p class="tabcap" id="ch20tab1"><strong>TABLE 20-1:</strong> Properties assigned to each node</p>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="border_th-r"><p class="tab_th"><strong>NODE</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>PROPERTIES</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">Forward</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">Group: Main [Robot]<br/>Size: auto<br/>Icon: fa-arrow-up<br/>Label: Forward<br/>Payload: forward</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">Left</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">Group: Main [Robot]<br/>Size: auto<br/>Icon: fa-arrow-left<br/>Label: Left<br/>Payload: left</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">Right</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">Group: Main [Robot]<br/>Size: auto<br/>Icon: fa-arrow-right<br/>Label: Right<br/>Payload: right</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">Reverse</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">Group: Main [Robot]<br/>Size: auto<br/>Icon: fa-arrow-down<br/>Label: Reverse<br/>Payload: reverse</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">Stop</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">Group: Main [Robot]<br/>Size: auto<br/>Icon: fa-hand-paper-o<br/>Label: Stop<br/>Payload: stop</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">f</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">Function: enter the code in <a href="ch20.xhtml#ch20list1">Listing 20-1</a><br/>Outputs: 6</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">Enable M1</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">GPIO: GPIO5 – 29<br/>Type: Digital output</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">+ M1</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">GPIO: GPIO27 – 13<br/>Type: Digital output</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">– M1</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">GPIO: 18 – GPIO24<br/>Type: Digital output</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">Enable M2</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">GPIO: GPIO17 – 11<br/>Type: Digital output</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">+ M2</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">GPIO: GPIO6 – 31<br/>Type: Digital output</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span epub:type="pagebreak" id="page_257"/><span class="orange">– M2</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">GPIO: GPIO22 – 15<br/>Type: Digital output</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">Poweroff</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">Group: Poweroff [Robot]<br/>Size: auto<br/>Icon: fa-power-off<br/>Label: Poweroff<br/>Background: red</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">exec</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">Command: <code>/usr/bin/sudo</code><br/>+ Append: not checked<br/>poweroff<br/>Name: Poweroff</span></p></td></tr>
</tbody>
</table>
<p class="indent"><a href="ch20.xhtml#ch20fig7">Figure 20-7</a> shows how the exec node is set up.</p>
<div class="image"><a id="ch20fig7"/><img src="../images/f0257-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 20-7:</strong> exec node properties</p>
<p class="indent">All nodes should be in the Main group, except the Poweroff button, which should be part of the Poweroff group.</p>
<h4 class="h4" id="lev210"><span class="orange"><strong>Entering the Script</strong></span></h4>
<p class="noindent">Insert the JavaScript code in <a href="ch20.xhtml#ch20list1">Listing 20-1</a> (also available for download from <em><a href="https://www.nostarch.com/RaspberryPiProject/">https://www.nostarch.com/RaspberryPiProject/</a></em>) into the function node:</p>
<p class="listing" id="ch20list1"><strong>LISTING 20-1:</strong> The remote-controlled robot script</p>
<div class="box">
<pre><span class="ent">➊</span> <span class="purple">var</span> msg1 <span class="blue">=</span> { payload: <span class="orange">0</span> };<br/>  <span class="purple">var</span> msg2 <span class="blue">=</span> { payload: <span class="orange">0</span> };<br/>  <span class="purple">var</span> msg3 <span class="blue">=</span> { payload: <span class="orange">0</span> };<br/><span epub:type="pagebreak" id="page_258"/>  <span class="purple">var</span> msg4 <span class="blue">=</span> { payload: <span class="orange">0</span> };<br/>  <span class="purple">var</span> msg5 <span class="blue">=</span> { payload: <span class="orange">0</span> };<br/>  <span class="purple">var</span> msg6 = { payload: <span class="orange">0</span> };<br/><span class="ent">➋</span> <span class="purple">if</span> (msg.payload <span class="blue">===</span> <span class="green">"forward"</span>) {<br/>     msg1.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>     msg2.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>     msg4.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>     msg5.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>  }<br/>  <span class="purple">else if</span> (msg.payload <span class="blue">===</span> <span class="green">"left"</span>) {<br/>     msg1.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>     msg2.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>  }<br/>  <span class="purple">else if</span> (msg.payload <span class="blue">===</span> <span class="green">"right"</span>) {<br/>     msg4.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>     msg5.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>  }<br/>  <span class="purple">else if</span> (msg.payload <span class="blue">===</span> <span class="green">"reverse"</span>) {<br/>     msg1.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>     msg3.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>     msg4.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>     msg6.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>  }<br/><span class="ent">➌</span> <span class="purple">return</span> [msg1, msg2, msg3, msg4, msg5, msg6];</pre>
</div>
<p class="indent">This function sends messages to the connected rpi gpio output nodes in the order they’re connected to the function node. This means that <code>msg1</code> is sent to the Enable M1 node, <code>msg2</code> to + M1, <code>msg3</code> to – M1, and so on (see <a href="ch20.xhtml#ch20fig6">Figure 20-6</a>).</p>
<p class="indent">First you initialize all the payload message variable values to <code>0</code> <span class="ent">➊</span>. Then the series of <code>if</code> and <code>else if</code> statements checks which button was pressed <span class="ent">➋</span>, depending on the payload received by the function, and sets the message values according to the action the robot should take. For example, if you press the Forward button, the payload received by the function node is <code>forward</code>, so the condition at <span class="ent">➋</span> is met and the code changes the <code>msg1</code>, <code>msg2</code>, <code>msg4</code>, and <code>msg5</code> payload values to <code>1</code>, while <code>msg3</code> and <code>msg6</code> remain <code>0</code>.</p>
<p class="indent">Then, the function node sends the <code>msg.payload</code> values to the corresponding nodes <span class="ent">➌</span>. For the robot to go forward, the payloads would need to be:</p>
<ul>
<li class="noindent">Enable M1: <code>1</code></li>
<li class="noindent">+ M1: <code>1</code></li>
<li class="noindent">– M2: <code>0</code></li>
<li class="noindent"><span epub:type="pagebreak" id="page_259"/>Enable M2: <code>1</code></li>
<li class="noindent">+ M2: <code>1</code></li>
<li class="noindent">– M2: <code>0</code></li>
</ul>
<p class="indent">Here, both motors are enabled and moving in the same direction—forward. The following table shows the messages the function should send to each node for each action.</p>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>ACTION</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>ENABLE M1</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>+ M1</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>– M1</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>ENABLE M2</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>+ M2</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>– M2</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">Forward</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">Left</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">0</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">Right</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">Reverse</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">1</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">Stop</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
</tr>
</tbody>
</table>
<p class="indent">When the Stop button is clicked, none of the conditions set in the code is met, and the function sends the values initialized at the start <span class="ent">➊</span>.</p>
<p class="indent">Outside the function node, when the Poweroff button is clicked, the exec node executes the <code>poweroff</code> command to turn off the Pi. Remember that you’ve filled the <code>exec</code> command property with <em>/usr/bin/sudo/poweroff</em>—see <a href="ch20.xhtml#ch20tab1">Table 20-1</a>.</p>
<p class="indent">Once everything is in place, click the <strong>Deploy</strong> button at the top-right corner to save the changes and run the flow.</p>
<h4 class="h4" id="lev211"><span class="orange"><strong>Running the Application</strong></span></h4>
<p class="noindent">Now your Node-RED application is ready. Go to <em>http://&lt;Pi IP address&gt;:1880/ui</em> (replacing <em>&lt;Pi IP address&gt;</em> with your own) to see your application dashboard. It should look something like <a href="ch20.xhtml#ch20fig8">Figure 20-8</a>.</p>
<p class="indent">Test the controls to see if the wheels are moving in the right direction, and don’t forget that you need to insert the four AA batteries into the battery holder in order to power the motors.</p>
<p class="indent">If one or both motors are spinning in the wrong direction, switch the black and red wires on the MotoZero for that motor terminal, or change the payload messages to match the required directions.</p>
<div class="image"><span epub:type="pagebreak" id="page_260"/><a id="ch20fig8"/><img src="../images/f0260-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 20-8:</strong> Node-RED application to remotely control the robot</p>
<h3 class="h3" id="lev212"><span class="orange"><strong>POWERING UP THE ROBOT</strong></span></h3>
<p class="noindent">Now that the application is ready, click the <strong>Poweroff</strong> button to shut down the Pi. Then wait a few seconds for it to shut down.</p>
<p class="indent">Change the Pi’s power source from the wall socket to the power bank. Wait a few minutes for the Pi to power up and autostart Node-RED. On a smartphone or other device that’s on the same network as your Pi, open a new browser tab and go to <em>http://&lt;Pi IP address&gt;:1880/ui</em>. Then click on the buttons to remotely control your robot.</p>
<p class="indent">Congratulations—you now have a Wi-Fi-controlled robot!</p>
<h3 class="h3" id="lev213"><span class="orange"><strong>TAKING IT FURTHER</strong></span></h3>
<p class="noindent">There’s a lot of room for upgrades on your robot. Here are some ideas for upgrades that will need both hardware and software changes. You’ll need to experiment a bit with Node-RED to get these working:</p>
<ul>
<li class="noindent">Get a robot chassis with four wheels and control four motors instead of two.</li>
<li class="noindent">Add LEDs and buzzers to the robot to make it more interactive.</li>
<li class="noindent">Add sensors, like an ultrasonic sensor, so the robot can avoid obstacles by itself.</li>
</ul>
</div>
  </body>
</html>
