<html><head></head><body>
<div id="book-content">
<div id="sbo-rt-content"><h2 class="h2" id="ch07"><span epub:type="pagebreak" id="page_205"/><strong><span class="big">7</span><br/>ROOTING MALWARE</strong></h2>&#13;
<div class="image1"><img src="../images/common.jpg" alt="Image" width="189" height="189"/></div>&#13;
<p class="noindentsa">Malware developers often seek ways of elevating their apps’ privileges to gain root access, which requires a privilege escalation exploit of some sort. Once operating as root, malware can use app and system resources to perform operations such as installing system-level applications, accessing other apps’ protected files, and modifying filesystem permissions to allow other malicious apps to view sensitive data.</p>&#13;
<p class="indent">We covered multiple examples of rooting malware in <a href="ch02.xhtml">Chapter 2</a>. In this chapter, we’ll first discuss some well-known rooting malware families we haven’t yet explored. Then we’ll examine the performance of different machine learning techniques used to separate rooting malware from goodware, as well as from other forms of Android malware, and the key features used to do so. Though we’ll use the Rootnik rooting malware as an example throughout the chapter, we’ll also apply the detection techniques to the DroidDream malware.</p>&#13;
<h3 class="h3" id="ch07lev1"><strong>Rooting Malware Families</strong></h3>&#13;
<p class="noindent"><span epub:type="pagebreak" id="page_206"/>To the best of our knowledge, ZNIU was the first rooting malware to leverage the Dirty COW (copy-on-write) vulnerability, which allows privilege escalation in the Linux kernel. According to Trend Micro’s blog post “ZNIU: First Android Malware to Exploit Dirty COW,” it was distributed via over 1,200 apps and through infected websites. Once the app was installed on a device, it reached out to a command-and-control server and engaged in transactions with the compromised device’s mobile carrier through an SMS-enabled payment service, incurring charges to a company located in China. ZNIU used root privileges to circumvent Android’s default workflow, which requires user consent to grant an app SMS-related permissions. Some versions of ZNIU leveraged exploits other than Dirty COW, such as Iovyroot, which targets a Linux kernel vulnerability, or various exploits from the KingoRoot rooting app.</p>&#13;
<p class="indent">In 2017, researchers at Kaspersky Lab discovered Dvmap. Its authors first uploaded a benign app to Google Play and later updated it to a malicious version, a behavior common in malware because it helps the app build a user base without raising suspicion. The authors would make the malicious version available for short periods and then replace it with a benign version.</p>&#13;
<p class="indent">Dvmap was the first rooting malware sample known to use code injection techniques. It would substitute the executable file <em>/system/bin/ip</em> with a completely new file that contained malicious functionality, then inject code to execute the new file into two system libraries associated with Android’s Dalvik and ART runtimes, ensuring that it would run with elevated privileges. Replacing the file, and the subsequent code injection into the system libraries, required using a privilege escalation exploit. You can read more about this malware in the Kaspersky blog post “Dvmap: Android Malware with a New Technique for Controlling Devices Appears on Google Play.”</p>&#13;
<p class="indent">In September 2017, the Android Security team discovered Tizi, which roots devices, mostly in Africa, to carry out spyware operations by leveraging a number of vulnerabilities discovered in 2012 and 2013. Once it has obtained root privileges, Tizi uses this access to record calls on encrypted services such as WhatsApp, Skype, and Viber and monitor social media activity on Facebook, X, LinkedIn, and Telegram. You can read more about this malware in an Android Security team blog post titled “Tizi: Detecting and Blocking Socially Engineered Spyware on Android.”</p>&#13;
<h3 class="h3" id="ch07lev2"><strong>Testing Classifier Performance</strong></h3>&#13;
<p class="noindent">To evaluate how well machine learning classifiers can distinguish rooting malware from goodware, we tested 10 classifiers by feeding them various sets of features, as shown in <a href="ch07.xhtml#ch7tab1">Table 7-1</a>.</p>&#13;
<p class="tabcap" id="ch7tab1"><strong>Table 7-1:</strong>  Classifier Performance—Rooting Malware vs. Goodware</p>&#13;
<table class="all">&#13;
<colgroup>&#13;
<col style="width:20%"/>&#13;
<col style="width:20%"/>&#13;
<col style="width:10%"/>&#13;
<col style="width:10%"/>&#13;
<col style="width:10%"/>&#13;
<col style="width:10%"/>&#13;
<col style="width:10%"/>&#13;
<col style="width:10%"/>&#13;
</colgroup>&#13;
<thead>&#13;
<tr>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>Feature set</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>Best classifier</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>AUC</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>Precision</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>Recall</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>F1</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>FPR</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>FNR</strong></p></th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">API package</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">GBDT</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9939</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9324</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9009</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9164</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0676</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0146</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">Static (S)</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">XGBoost</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9811</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8658</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.7783</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8197</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.1342</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0296</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">Dynamic (D)</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">RF</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9065</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8735</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.5271</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.6575</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.1265</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0608</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">S + D</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">XGBoost</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9848</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8889</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8079</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8465</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.1111</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0257</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">API + S + D</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">XGBoost</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.9974</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.9564</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.9187</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.9372</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.0436</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.0109</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">TSG</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">XGBoost</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9927</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9018</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8896</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8957</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0982</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0163</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">LM</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">XGBoost</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9791</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8375</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.7488</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.7906</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.1625</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0335</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">FC</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">XGBoost</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9729</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8507</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.7438</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.7937</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.1493</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0341</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">CG</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">RF</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9571</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8349</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.6724</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.7449</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.1651</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0432</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">API + S + D + TSG</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">XGBoost</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9970</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9337</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9015</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9173</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0663</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0133</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">API + S + D + LM</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">XGBoost</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9972</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9514</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9163</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9335</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0486</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0113</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">API + S + D + FC</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">XGBoost</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9972</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9540</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9187</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9360</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0460</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0110</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="tab"><p class="noindent-tab">API + S + D + CG</p></td>&#13;
<td style="vertical-align: top" class="tab"><p class="noindent-tab">XGBoost</p></td>&#13;
<td style="vertical-align: top" class="tab"><p class="noindent-tab">0.9971</p></td>&#13;
<td style="vertical-align: top" class="tab"><p class="noindent-tab">0.9580</p></td>&#13;
<td style="vertical-align: top" class="tab"><p class="noindent-tab">0.8990</p></td>&#13;
<td style="vertical-align: top" class="tab"><p class="noindent-tab">0.9276</p></td>&#13;
<td style="vertical-align: top" class="tab"><p class="noindent-tab">0.0420</p></td>&#13;
<td style="vertical-align: top" class="tab"><p class="noindent-tab">0.0136</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">All features</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">XGBoost</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9970</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9482</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9015</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9242</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0518</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0133</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">Best late fusion</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">XGBoost</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9994</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9854</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9828</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab"><strong>0.9840</strong></p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0146</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0023</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_207"/>We first used a set of basic features derived from API packages, static analysis, and dynamic analysis (API, S, and D), as well as two combinations of these (S + D and API + S + D). The “Best classifier” column records the classifier with the best F1 score. As you can see, gradient-boosted decision tree (GDBT), XGBoost, and random forest (RF) classifiers perform best.</p>&#13;
<p class="indent">The table lists several performance metrics, all of which were introduced in <a href="ch05.xhtml">Chapter 5</a>: AUC, precision, recall, F1 score, false positive rate (FPR), and false negative rate (FNR). The F1 score is the most important of these, as it balances precision and recall. You can see that using API features alone already achieves a high F1 score (0.9164), outperforming the use of static features, dynamic features, or a combinations of these. Combining static, dynamic, and API features further improves the F1 score to 0.9372.</p>&#13;
<p class="indent">For the advanced features, we tested triadic suspicion graph–based features, landmark-based features, feature clustering features, and correlation graph–based features (TSG, LM, FC, and CG). We also combined each of these with the basic features. The results show that using just one kind of advanced feature achieves an F1 score ranging from 0.7449 to 0.8957, with TSG ranked the highest. When we add the basic features to the advanced features, performance significantly improves, with the best F1 score achieved by combining FC features with the basic features.</p>&#13;
<p class="indent">Lastly, we combined all of the features using two methods: inputting all of them to each classifier and using late fusion to combine the predictions of seven classifiers, each using one kind of feature. <em>Late fusion</em> is a classification technique that combines the predictions made by multiple classifiers. Suppose, for instance, that we used three different classifiers to predict the probability that a given app is malicious. These three classifiers would each return a probability, <em>p</em><sub>1</sub>, <em>p</em><sub>2</sub>, and <em>p</em><sub>3</sub>, respectively. Late fusion tries to find weights <em>w</em><sub>1</sub>, <em>w</em><sub>2</sub>, and <em>w</em><sub>3</sub>&#13;
such that when their sum is greater than 0.5, the likelihood of the app being malicious is as high as possible. As the last two <span epub:type="pagebreak" id="page_208"/>rows in <a href="ch07.xhtml#ch7tab1">Table 7-1</a> show, the best late fusion result outperforms all other methods, with an F1 score of 0.9840.</p>&#13;
<p class="indent">We also tested the ability of each classifier to distinguish rooting malware from other kinds of malware. This ability can be advantageous; for instance, if a machine learning classifier flags an app as rooting malware, you can send it to a rooting malware specialist for analysis. You can see the inputs and their performance in <a href="ch07.xhtml#ch7tab2">Table 7-2</a>.</p>&#13;
<p class="tabcap" id="ch7tab2"><strong>Table 7-2:</strong> Classifier Performance—Rooting Malware vs. Other Malware</p>&#13;
<table class="all">&#13;
<colgroup>&#13;
<col style="width:20%"/>&#13;
<col style="width:20%"/>&#13;
<col style="width:10%"/>&#13;
<col style="width:10%"/>&#13;
<col style="width:10%"/>&#13;
<col style="width:10%"/>&#13;
<col style="width:10%"/>&#13;
<col style="width:10%"/>&#13;
</colgroup>&#13;
<thead>&#13;
<tr>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>Feature set</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>Best classifier</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>AUC</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>Precision</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>Recall</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>F1</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>FPR</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>FNR</strong></p></th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">API package</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">RF</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9801</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9669</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.7883</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8685</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0331</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0435</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">Static (S)</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">XGBoost</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9530</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.7890</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.6724</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.7261</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.2110</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0621</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">Dynamic (D)</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">RF</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8686</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8444</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.4680</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.6022</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.1556</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0955</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">S + D</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">RF</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9610</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9085</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.6847</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.7809</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0915</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0587</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">API + S + D</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">XGBoost</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.9898</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.9472</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.8842</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.9146</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.0528</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.0223</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">TSG</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">RF</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9717</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9358</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.7883</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8557</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0642</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0437</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">LM</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">XGBoost</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9466</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.7922</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.6010</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.6835</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.2078</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0743</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">FC</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">RF</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9139</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8796</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.5936</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.7088</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.1204</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0746</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">CG</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">RF</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8452</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.7093</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.5049</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.5899</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.2907</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0914</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">API + S + D + TSG</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">XGBoost</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9896</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9395</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8793</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9084</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0605</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0233</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">API + S + D + LM</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">XGBoost</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9897</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9395</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8793</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9084</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0605</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0233</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">API + S + D + FC</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">XGBoost</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9898</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9446</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8818</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9121</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0554</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0228</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">API + S + D + CG</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">XGBoost</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.9896</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.9523</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.8842</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.9170</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.0477</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.0223</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">All features</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">XGBoost</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9893</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9333</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8966</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9146</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0667</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0200</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">Best late fusion</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">XGBoost</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9988</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9927</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9409</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent"><strong>0.9656</strong></p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0073</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0114</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<p class="indent">Again, API features worked the best of any individual basic feature, but combining all of the basic features further improved the F1 score. Of the advanced features, TSG again had the highest F1 score, though adding basic features to each kind of advanced feature significantly improved performance. Specifically, combining CG features with the basic features achieved the best F1 score, a result that differs from the best way to distinguish rooting malware from goodware. When we combined all basic and advanced features, late fusion results again outperformed all classifiers.</p>&#13;
<h3 class="h3" id="ch07lev3"><strong>Rooting Malware vs. Goodware</strong></h3>&#13;
<p class="noindent">We’ll use a malware family called Rootnik to illustrate how the features of rooting malware differ from those of goodware apps. Rootnik delivers its rooting malware through a variety of apps, such as <em>com.web.sdfile</em> (v2, f214), that claim to manage documents, videos, pictures, music, and other files on a user’s device. Once installed, the app reaches out to a command-and-control server, where it downloads code at will to perform a veritable laundry list of malicious acts, from pushing pornography and ads to the device to silently installing new apps. It embeds itself into a wide variety of legitimate applications and, once a device is rooted, steals Wi-Fi information including passwords and keys, the user’s location, and the device’s MAC address.</p>&#13;
<div class="image"><img id="ch7fig1" src="../images/ch07fig01.jpg" alt="Image" width="1848" height="929"/></div>&#13;
<p class="figcap"><em>Figure 7-1: Top 20 features that best distinguish Android rooting malware from goodware</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_209"/><span epub:type="pagebreak" id="page_210"/>In this section, we will consider a set of 1,829 Rootnik hashes. Of these, 444 are distinct, in the sense that they lead to different feature vectors of the type discussed in <a href="ch05.xhtml">Chapters 5</a> and <a href="ch06.xhtml">6</a>. We’ll cover the 20 features that best distinguish between rooting malware and goodware using the Extra-Trees classifier (short for extremely randomized trees, a variant of the random forest classifier), which randomly chooses multiple subsets of the training set, learns a decision tree for each subset, and then aggregates the decision trees. <a href="ch07.xhtml#ch7fig1">Figure 7-1</a> shows these features.</p>&#13;
<p class="indent">They include nine static permission-related features, a static feature based on the <span class="literal">sendnet</span> method, a static API call feature, six suspicion score features, two suspicion rank features, and one correlation graph feature. We will explain <span class="literal">sendnet</span> in more detail later in this chapter.</p>&#13;
<h4 class="h4" id="ch07lev1sec1"><strong><em>Permission-Related Features</em></strong></h4>&#13;
<p class="noindent"><a href="ch07.xhtml#ch7lis1">Listing 7-1</a> shows every permission requested by Rootnik in the app’s manifest file.</p>&#13;
<pre>&lt;uses-permission android:name=”android.permission.ACCESS_WIFI_STATE”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.CHANGE_WIFI_STATE”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.INTERNET”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.MOUNT_UNMOUNT_FILESYSTEMS”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.READ_EXTERNAL_STORAGE”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.WRITE_EXTERNAL_STORAGE”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.READ_MEDIA_STORAGE”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.ACCESS_NETWORK_STATE”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.READ_PHONE_STATE”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.KILL_BACKGROUND_PROCESSES”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.RECEIVE_BOOT_COMPLETED”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.SYSTEM_ALERT_WINDOW”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.WRITE_SETTINGS”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.VIBRATE”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.ACCESS_DOWNLOAD_MANAGER”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.DOWNLOAD_WITHOUT_NOTIFICATION”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.DISABLE_KEYGUARD”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.ACCESS_COARSE_LOCATION../&gt;&#13;
&lt;uses-permission android:name=”android.permission.GET_PACKAGE_SIZE”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.CLEAR_APP_CACHE”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.GET_TASKS”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.INSTALL_PACKAGES”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.DELETE_PACKAGES”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.CLEAR_APP_USER_DATA”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.CHANGE_COMPONENT_ENABLED_STATE”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.READ_FRAME_BUFFER”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.WAKE_LOCK”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.ACCESS_NETWORK_STATE”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.ACCESS_WIFI_STATE”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.RECEIVE_BOOT_COMPLETED”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.CHANGE_CONFIGURATION”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.READ_EXTERNAL_STORAGE”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.READ_PHONE_STATE”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.GET_TASKS”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.INTERNET”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.SYSTEM_ALERT_WINDOW”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.WRITE_EXTERNAL_STORAGE”/&gt;&#13;
&lt;uses-permission android:name=”com.android.launcher.permission.READ_SETTINGS”/&gt;&#13;
&lt;uses-permission android:name=”com.android.launcher.permission.INSTALL_SHORTCUT”/&gt;&#13;
&lt;uses-permission android:name=”com.android.launcher.permission.UNINSTALL_SHORTCUT”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.VIBRATE”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.MOUNT_UNMOUNT_FILESYSTEMS”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.WAKE_LOCK”/&gt;</pre>&#13;
<p class="list" id="ch7lis1"><em>Listing 7-1: All requested permissions in Rootnik</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_211"/>Apps seek the <span class="literal">INSTALL_PACKAGES</span> privileged permission when they want to install other packages or apps during runtime. Over the years, malware developers have tried to use this to sideload new packages. One big advantage of this permission is that it can be used to install apps without user consent, unlike its unprivileged counterpart <span class="literal">REQUEST_INSTALL_PACKAGES</span>. Sideloaded apps can then request arbitrary permissions and form the launchpad for even more malicious attacks. The classifier’s output shows that while 20.27 percent of rooting malware requests this permission, only 0.22 percent of goodware requests it. This is expected, as the privileged permission is only available to apps that have already successfully elevated their privilege level above that of regular apps.</p>&#13;
<p class="indent">The <span class="literal">GET_PACKAGE_SIZE</span> permission allows an app to get the package size of other apps. You can see from the classifier’s output that 30.75 percent of rooting malware requests this permission, compared to only 1.86 percent of goodware. Historically, Android used the <span class="literal">GET_PACKAGE_SIZE</span> permission to protect only a single Android API (<span class="literal">PackageManager.getPackageSizeInfo</span>), which was removed in Android 8.0 (Oreo). Spot-checking a few rooting apps showed that while they request this permission, they don’t seem to use it.</p>&#13;
<p class="indent">The <span class="literal">KILL_BACKGROUND_PROCESSES</span> permission allows an Android app to kill processes running silently in the background. There are both legitimate and malicious reasons for apps to request this permission. For instance, a benign app may want this permission in order to free up system resources in cases when another app is running in the background but not being actively used. On the other hand, malicious apps may request this permission in order to kill security processes running in the background. You can see that 28.33 percent of rooting malware requests this permission, but only 2.04 percent of goodware does.</p>&#13;
<p class="indent">Another important permission is <span class="literal">GET_TASKS</span>. Although deprecated in 2014, it lets an app identify the running processes on a device. As you can see from the classifier’s output, 67.81 percent of rooting malware requests this permission, compared to a mere 13.57 percent of goodware. Thus, an app that requests it is almost five times more likely to be rooting malware <span epub:type="pagebreak" id="page_212"/>than goodware. Android has severely restricted this feature to further improve sandboxing between apps.</p>&#13;
<p class="indent">Apps request the <span class="literal">MOUNT_UNMOUNT_FILESYSTEMS</span> permission to mount or unmount the device’s filesystems. This also enables them to add new files, delete files, or modify files on parts of the device that were previously restricted. This permission is frequently used to drop the BusyBox executable in the <em>/system/bin</em> directory. As BusyBox makes many standard Linux commands available in one executable, it’s a nice way to get a lot of standard malware capabilities onto a rooted device without having to download, copy, and install too many individual executable files. The malware itself may then use these capabilities as needed. The probability of the <span class="literal">MOUNT_UNMOUNT_FILESYSTEMS</span> permission being requested by rooting malware is 42.65 percent, compared to 4.21 percent for goodware, as unprivileged apps can’t use the permission at all.</p>&#13;
<p class="indent">The <span class="literal">SYSTEM_ALERT_WINDOW</span> permission lets an app display pop-up alert windows even if the app isn’t currently being used, offering clear and ample opportunity for abuse via phishing. We haven’t seen cases of such misuse in rooting apps, but many rooting malware apps may bundle their code into benign apps that use this permission for their normal operation. Rooting malware is far more likely to request this feature than goodware (53.76 percent versus 11.13 percent).</p>&#13;
<p class="indent">The <span class="literal">RECEIVE_BOOT_COMPLETED</span> permission allows an app to know when the system has completed a boot or reboot. Both goodware and malware apps can use this broadcast message to start when the boot finishes. The classifier’s output shows that 66.41 percent of rooting malware requests this permission, compared to 24.38 percent of goodware. Malware seems to be more likely to want to restart immediately after a reboot than goodware, which usually starts only when the user wants to interact with it.</p>&#13;
<p class="indent">Malicious apps also often request the <span class="literal">READ_PHONE_STATE</span> and <span class="literal">ACCESS_WIFI_STATE</span> permissions. Benign apps might use the first of these to get the phone’s IMEI number, as well as information about the kinds of networks the phone is connected to. For example, mobile payment apps may need this type of information to verify the identity of the device sending a payment request. Malware can use this permission to capture private information about a victim’s phone and is more than twice as likely to request it: 35.98 percent of goodware requests the <span class="literal">READ_PHONE_STATE</span> permission, compared to 83.01 percent of rooting malware. Similarly, hackers can use <span class="literal">ACCESS_WIFI_STATE</span> to capture Wi-Fi service set identifiers (SSIDs). While 80.57 percent of rooting malware requests this permission, its probability of being requested by goodware is half this (40.02 percent).</p>&#13;
<h4 class="h4" id="ch07lev1sec2"><strong><em>Network-Based Features</em></strong></h4>&#13;
<p class="noindent">In addition to the permission-related features, features related to the app’s network communications can help machine learning algorithms identify rooting malware. For instance, the static <span class="literal">sendnet</span> feature is set to the number of times that the application’s code invokes the <span class="literal">sendnet</span> method to send data over the internet. We can collect this kind of information by running the <span epub:type="pagebreak" id="page_213"/>Android app within an Android sandbox environment called DroidBox that enables us to run Android apps safely and gather dynamic features of the kind mentioned in <a href="ch06.xhtml">Chapter 6</a>. <a href="ch07.xhtml#ch7lis2">Listing 7-2</a> shows the Rootnik malware calling <span class="literal">sendnet</span>.</p>&#13;
<pre>"sendnet": [&#13;
  {&#13;
    "desthost": "abc.jxyxteam.com",&#13;
    "pid": 852,&#13;
    "processname": "com.web.sdfile",&#13;
    "time": 16.090091,&#13;
    "tid":  705893000,&#13;
    "data": "POST /HTTP/1.1\r\nContent-Type: application/x-www-form-urlencoded&#13;
\r\nConnection: close\r\nContent-Length: 257\r\nHost: abc.jxyxteam.com:7901\r\&#13;
nUser-Agent: Mozilla/5.0 (Linux; U; android 2.2.1; en-us; Nexus One Build/FRG83)&#13;
AppleWebKit/533.1 (KHTML, like Gecko) Version/4.0 Mobile Safari/ 533.1\r\nExpect:&#13;
100-continue\r\n\r\n",&#13;
    "destport": 7901&#13;
  },</pre>&#13;
<p class="list" id="ch7lis2"><em>Listing 7-2: The</em> <span class="codeitalic1">sendnet</span> <em>method, used to send data over the internet, in Rootnik</em></p>&#13;
<p class="indent">The DroidBox output shows Rootnik sending traffic to the external URL <em>abc.jxyxteam.com</em>, which likely belongs to a site operated by the malware developers.</p>&#13;
<p class="indent">The value of the <span class="literal">sendnet</span> feature is far more likely to be greater than zero for rooting malware than for goodware. The classifier’s output shows that 7.65 percent of malware uses this method, compared to only 0.057 percent of goodware, meaning that a rooting malware app is about 134 times more likely than goodware to use it.</p>&#13;
<p class="indent">Another feature used in distinguishing rooting malware from goodware is <span class="literal">org.apache.http.conn.scheme</span>, which captures the number of times the app’s code invokes the HTTP or HTTPS protocols. Rooting malware invokes this feature far more often than goodware (33.27 percent versus a mere 1.59 percent). In <a href="ch07.xhtml#ch7lis3">Listing 7-3</a>, you can see the Rootnik rooting malware calling the <span class="literal">org.apache.http.conn.scheme</span> API.</p>&#13;
<pre>import org.apache.http.conn.scheme.Scheme;&#13;
public C1124az(Context context, X509Certificate x509Certificate, String str,&#13;
String str2, int i) {&#13;
  this.f3838f = "";&#13;
  this.f3839g = null;&#13;
  this.f3833a = str;&#13;
  this.f3834b = i;&#13;
  this.f3836d = str2;&#13;
  this.f3840h = context;&#13;
  try {&#13;
    C1104af afVar = new C1104af(x509Certificate);&#13;
    afVar.setHostnameVerifier(SSLSocketFactory.ALLOW_ALL_HOSTNAME_VERIFIER); &#13;
    Scheme scheme = new Scheme("https",	afVar, i);&#13;
    this.f3835c = m3559f(str);&#13;
    this.f3835c.getConnectionManager().getSchemeRegistry().register(scheme); &#13;
    if (!C1126ba.m3582a()) {&#13;
      if (context != null) {&#13;
        this.f3838f = PreferenceManager.getDefaultSharedPreferences(context).&#13;
          getString(C1112an.m3519c(str),"");&#13;
      }&#13;
      mo5336e(this.f3833a);&#13;
    }&#13;
  } catch (Throwable th){&#13;
  }&#13;
}</pre>&#13;
<p class="list" id="ch7lis3"><em>Listing 7-3: The <span class="codeitalic1">org.apache.http.conn.scheme</span> API called in Rootnik</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_214"/>Keep in mind that there is nothing inherently malicious about using this method, which can support both benign and malicious traffic.</p>&#13;
<h3 class="h3" id="ch07lev4"><strong>Rooting Malware vs. Other Malware</strong></h3>&#13;
<p class="noindent">Now let’s discuss the features that best distinguish rooting malware from other forms of malware. <a href="ch07.xhtml#ch7fig2">Figure 7-2</a> shows the strongest 20 features for this purpose identified by the Extra-Trees classifier.</p>&#13;
<p class="indent">These include 10 permission-related features, 8 suspicion score or suspicion rank features, 1 API-related feature, and 1 landmark-based feature. In this section, we’ll cover some of the highlights. Because rooting malware is much more similar to other forms of malware than to goodware, the differences discussed here are smaller.</p>&#13;
<h4 class="h4" id="ch07lev1sec3"><strong><em>Permission-Related Features</em></strong></h4>&#13;
<p class="noindent">Ten permissions help the Extra-Trees classifier separate rooting malware from other malware. The first is <span class="literal">GET_PACKAGE_SIZE</span>. Apps that request this permission are far more likely to be rooting malware than other forms of malware; 30.15 percent of rooting malware requests it, compared to only 7.83 percent of other malware. However, the fact that some apps request this permission isn’t necessarily malicious.</p>&#13;
<p class="indent">The next four, <span class="literal">MOUNT_UNMOUNT_FILESYSTEMS</span>, <span class="literal">GET_TASKS</span>, <span class="literal">ACCESS_WIFI_STATE</span>, and <span class="literal">INSTALL_PACKAGES</span>, were also among the 20 features most useful for distinguishing rooting malware from goodware. Two additional permissions rooting malware requests slightly more often than other malware are <span class="literal">READ_LOGS</span> and <span class="literal">RESTART_PACKAGES</span>. The <span class="literal">READ_LOGS</span> permission grants access to all systems logs for privileged apps, but only an app’s own logs for unprivileged apps; <span class="literal">RESTART_PACKAGES</span> has been deprecated since API 15. In all of these cases, the differences in the percentages of rooting malware versus other types of malware requesting the permissions aren’t huge, and using any one of these <span epub:type="pagebreak" id="page_215"/><span epub:type="pagebreak" id="page_216"/>features individually to classify apps as rooting malware rather than some other kind malware will likely lead to errors.</p>&#13;
<div class="image"><img id="ch7fig2" src="../images/ch07fig02.jpg" alt="Image" width="1882" height="929"/></div>&#13;
<p class="figcap"><em>Figure 7-2: Top 20 features that best distinguish Android rooting malware from other forms of malware</em></p>&#13;
<p class="indent">Lastly, we have already seen that <span class="literal">READ_PHONE_STATE</span> and <span class="literal">RECEIVE_BOOT_COMPLETED</span> were important in distinguishing rooting malware from good-ware. Interestingly, <a href="ch07.xhtml#ch7fig2">Figure 7-2</a> shows that rooting malware is slightly less likely to request these permissions than other forms of malware, which might use them to start whenever the system is rebooted or to capture IMSI and IMEI information about the device.</p>&#13;
<h4 class="h4" id="ch07lev1sec4"><strong><em>Other Features</em></strong></h4>&#13;
<p class="noindent">The suspicion score and suspicion rank features play a far more important role in distinguishing rooting malware from other forms of malware than they did in the case of separating rooting malware from goodware. These more technical features seem able to make fine-grained distinctions that the coarser permission-related features miss.</p>&#13;
<p class="indent">The API feature <em>org.apache.http.conn.scheme</em>, which captures the number of times in the code that the app invokes the HTTP or HTTPS protocols, is also helpful here. While 63.27 percent of rooting malware makes at least one call to one of these protocols in its code, other forms of malware don’t use the Apache libraries nearly as often (though they may use other libraries for the same purpose). This class represents a number of protocols and describes protocol properties like which socket to use.</p>&#13;
<h3 class="h3" id="ch07lev5"><strong>DroidDream: A Case Study</strong></h3>&#13;
<p class="noindent">DroidDream was the first known rooting malware on the Android platform. In this section, we’ll apply the detection strategies learned in the earlier part of this chapter to analyze it. <a href="ch07.xhtml#ch7lis4">Listing 7-4</a> shows the permissions the app requests in <em>com.fall.down</em> (v1, 7d1d).</p>&#13;
<pre>&lt;uses-permission android:name=”android.permission.INTERNET”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.VIBRATE”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.READ_PHONE_STATE”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.CHANGE_WIFI_STATE”/&gt;&#13;
&lt;uses-permission android:name=”android.permission.ACCESS_WIFI_STATE”/&gt;</pre>&#13;
<p class="list" id="ch7lis4"><em>Listing 7-4: The permissions used in the DroidDream malware</em></p>&#13;
<p class="indent">We see that DroidDream asks for only a few of the 20 permissions discussed earlier in this chapter. The ones that our analysis deemed significant for recognizing rooting malware are <span class="literal">READ_PHONE_STATE</span> and <span class="literal">ACCESS_WIFI_STATE</span>. In <a href="ch07.xhtml#ch7lis5">Listing 7-5</a>, you can see the app using <span class="literal">READ_PHONE_STATE</span> to request IMEI information from the device.</p>&#13;
<pre>public static String getIMEI(Context context) {&#13;
  TelephonyManager mTelephonyMgr = (TelephonyManager) context.getSystemService("phone");&#13;
  if (mTelephonyMgr.getDeviceId() == null) {&#13;
    return "";&#13;
  }&#13;
  return mTelephonyMgr.getDeviceId();&#13;
}</pre>&#13;
<p class="list" id="ch7lis5"><em>Listing 7-5: IMEI access by the DroidDream malware</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_217"/><a href="ch07.xhtml#ch7lis6">Listing 7-6</a> contains DroidBox output that shows the DroidDream app accessing IMSI information, another activity that requires the <span class="literal">READ_PHONE_STATE</span> permission. Later in the code, the app sends both the IMEI and IMSI to its command-and-control server.</p>&#13;
<pre>"runbinary":[ &#13;
  { &#13;
    "code":"invoke-static Ljava/lang/Runtime;-&gt;getRuntime()Ljava/lang/Runtime;", &#13;
    "class":"Lcom/android/root/Setting;",&#13;
    "method":"runRootCommand"&#13;
  }, &#13;
  {&#13;
    "code":"invoke-virtual v9, vll, Ljava/lang/Runtime;-&gt;exec(Ljava/lang/String;)&#13;
Ljava/lang/Process;",&#13;
    "class":"Lcom/android/root/Setting;",&#13;
    "method":"runRootCommand"&#13;
  }, &#13;
  {&#13;
    "code":"invoke-static Ljava/lang/Runtime;-&gt;getRuntime()Ljava/lang/Runtime;",&#13;
    "class":"Lcom/android/root/udevRoot;",&#13;
    "method":"runExploid"&#13;
  } &#13;
], &#13;
"imsi":[ &#13;
  { &#13;
    "code":"invoke-virtual v0, Landroid/telephony/TelephonyManager;-&gt;getSubscriberid()&#13;
Ljava/lang/String;",&#13;
    "class":"Lcom/android/root/adbRoot;", &#13;
    "method": getIMSI"&#13;
  }, &#13;
  { &#13;
    "code":"invoke-virtual v0, Landroid/telephony/TelephonyManager;-&gt;getSubscriberid()&#13;
Ljava/lang/String;",&#13;
    "class":"Lcom/android/root/adbRoot;",&#13;
    "method": getIMSI"&#13;
  } &#13;
], &#13;
"socket":[ &#13;
  { &#13;
    "code":"invoke-virtual vl, Ljava/net/URL;-&gt;openConnection()Ljava/net/URLConnection;",&#13;
    "class":"Lcom/admob/android/ads/i;",	&#13;
    "method":"a"&#13;
  }, &#13;
  { &#13;
    "code":"invoke-virtual v0, Ljava/net/URL;-&gt;openConnection()Ljava/net/URLConnection;",&#13;
    "class":"Lcom/android/root/Setting;",&#13;
    "method":"postUrl"&#13;
  }&#13;
]</pre>&#13;
<p class="list" id="ch7lis6"><em>Listing 7-6: IMSI access by the DroidDream malware</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_218"/>The app also collects information about the device hardware and operating system, which requires the <span class="literal">INTERNET</span> permission. DroidDream uses this permission to connect to various external URLs, too. <a href="ch07.xhtml#ch7lis7">Listing 7-7</a> shows the list of URLs included in the DroidDream code.</p>&#13;
<pre>"urls":[&#13;
  "http://api.admob.com/v1/pubcode/android_sdk_emulator_notice",&#13;
  "http://market.android.com/search?q=pname:com.teamsoft.blockedtrafficfree",&#13;
  "http://market.android.com/search?q=pname:com.teamsoft.blockedtrafficpro",&#13;
  "http://market.android.com/search?q=pname:com.teamsoft.funnytest",&#13;
  "http://market.android.com/search?q=pname:com.teamsoft.rushhour",&#13;
  "http://mm.admob.com/static/android/canvas.html",&#13;
  "http://mm.admob.com/static/android/i18n/20100331",&#13;
  "http://r.admob.com/ad_source.php",&#13;
  "http://schemas.android.com/apk/res/"&#13;
]</pre>&#13;
<p class="list" id="ch7lis7"><em>Listing 7-7: External URLs accessed by the DroidDream malware</em></p>&#13;
<p class="indent">Individually, none of these features provides a smoking gun establishing that DroidDream is malicious. However, their collective presence is enough for our ensemble-based machine learning algorithm to label it as such. A security analyst could then examine the malware to find conclusive proof (for example, the <span class="literal">runExploid</span> method, shown in <a href="ch07.xhtml#ch7lis6">Listing 7-6</a>). If they did so, they’d determine that DroidDream roots phones with the so-called Rage-Against-the-Cage exploit, then uses its root privileges to install another app with elevated privileges.</p>&#13;
<h3 class="h3" id="ch07lev6"><strong>Up Next</strong></h3>&#13;
<p class="noindent">In this chapter, we showed that it’s possible to achieve high levels of predictive efficacy in malware detection using ensemble late fusion, which has a significantly higher performance than any other classifier. We also showed that while all feature types help separate rooting malware from goodware, as well as from other forms of malware, the advanced features covered in <a href="ch06.xhtml">Chapter 6</a> do especially well. In particular, the TSG suspicion scores and suspicion ranks make the biggest contribution to ensembles. Permissions also proved important.</p>&#13;
<p class="indent">The next chapter introduces detection techniques for another widely prevalent form of Android malware: spyware, which gathers personal information and uses it for a variety of nefarious purposes.</p>&#13;
</div>
</div>
<div style="float: none; margin: 10px 0px 10px 0px; text-align: center;"><p><a href="https://oceanofpdf.com"><i>OceanofPDF.com</i></a></p></div></body></html>