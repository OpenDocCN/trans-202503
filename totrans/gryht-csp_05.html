<html><head></head><body>
<p id="filepos455112" class="calibre_"><span class="calibre6"><span class="bold">
</span></span><span class="calibre1"><span class="bold">6</span></span><br class="calibre5"/><span class="calibre6"><span class="bold">AUTOMATING NEXPOSE</span></span></p><p class="calibre_12"><img src="images/00010.jpg" class="calibre_13"/></p><p class="calibre_6">Nexpose is a vulnerability scanner similar to Nessus but geared toward enterprise-level vulnerability <span class="italic">management</span>. This means not only helping system admins find which boxes need patches, but also helping them mitigate and prioritize the potential vulnerabilities over time. In this chapter, I show you how to use C# to automate Rapid7’s Nexpose vulnerability scanner in order to create a Nexpose site, scan that site, create a PDF report of the site’s vulnerabilities, and then delete the site. Nexpose’s reporting is incredibly flexible and powerful, allowing you to automatically generate reports for a wide variety of audiences, from executives to technical admins.</p><p class="calibre_6">Like the Nessus scanner discussed in <a href="index_split_010.html#filepos420379">Chapter 5</a>, Nexpose uses the HTTP protocol to expose its API, but it uses XML instead of JSON to format data. As in <a href="index_split_010.html#filepos420379">Chapter 5</a>, we’ll write two separate classes: one to communicate with the Nexpose API (the session class) and another to drive the API (the manager class). Once we’ve written the classes, you’ll learn how to run a scan and view the results.</p><p id="filepos456618" class="calibre_10"><span class="calibre3"><span class="bold"> Installing Nexpose</span></span></p><p class="calibre_11">Nexpose is available in various forms and editions from Rapid7. We’ll use the Nexpose binary installer from Rapid7 on a fresh Ubuntu 14.04 LTS machine using the commands and URL shown in <a href="#filepos457747">Listing 6-1</a>. This URL is updated with the latest installer whenever new versions are released. If the URL doesn’t work for whatever reason, you can also find a download link after registering for a Community activation key (required to run Nexpose). After downloading the installer, we need to set the executable file permission so we can subsequently run the installer as root.</p><blockquote class="calibre_14"><span class="calibre4">$ </span><span class="calibre4"><span class="bold">wget http://download2.rapid7.com/download/NeXpose-v4/NeXposeSetup-Linux64.bin</span></span><br class="calibre5"/><span class="calibre4">$ </span><span class="calibre4"><span class="bold">chmod +x ./NeXposeSetup-Linux64.bin</span></span><br class="calibre5"/><span class="calibre4">$ </span><span class="calibre4"><span class="bold">sudo ./NeXposeSetup-Linux64.bin</span></span><span class="calibre4">
</span><a id="filepos457747"/><span class="calibre4"><span class="italic">Listing 6-1: Downloading and installing Nexpose</span></span></blockquote><p class="calibre_6">When the installer is run in a graphical desktop environment, such as KDE or GNOME, a graphical installer is presented for the user to step through for the initial configuration, as shown in <a href="#filepos458418">Figure 6-1</a>. If you are installing Nexpose through a text-based environment, such as SSH, the installer should step through configuration with yes/no questions and other prompts for information.</p><p class="calibre_22"><img src="images/00013.jpg" class="calibre_33"/></p><p id="filepos458418" class="calibre_15"><span class="calibre4"><span class="italic">Figure 6-1: The graphical Nexpose installer</span></span></p><p class="calibre_6">Once Nexpose is installed, run <span class="calibre4"><span class="bold">ifconfig</span></span> in a terminal to see the IP address open in the web browser. Then enter <span class="calibre4"><span class="bold">https://</span></span><span class="calibre4"><span class="italic"><span class="bold">ip</span></span></span><span class="calibre4"><span class="bold">:3780/</span></span> into the browser, replacing <span class="italic"><span class="bold">ip</span></span> with the IP address of the machine running Nexpose. You should see the Nexpose login page, as shown in <a href="#filepos459137">Figure 6-2</a>.</p><p class="calibre_22"><img src="images/00017.jpg" class="calibre_34"/></p><p id="filepos459137" class="calibre_15"><span class="calibre4"><span class="italic">Figure 6-2: The Nexpose login page</span></span></p><p class="calibre_6">Use the credentials asked for during setup. You may see an SSL certificate error before being presented with the login page. Because Nexpose uses a self-signed SSL certificate by default, your browser probably doesn’t trust it and may complain. This is normal and expected.</p><p id="filepos459568" class="calibre_10"><span class="calibre3"><span class="italic"><span class="bold">Activation and Testing</span></span></span></p><p class="calibre_11">When you first log in, you should be prompted to enter the activation key you were sent in an email from Rapid7 after registering for the Community Edition, as shown in <a href="#filepos460042">Figure 6-3</a>.</p><p class="calibre_22"><img src="images/00019.jpg" class="calibre_35"/></p><p id="filepos460042" class="calibre_15"><span class="calibre4"><span class="italic">Figure 6-3: The activation modal pop-up in Nexpose</span></span></p><p class="calibre_6"> Now test your installation to make sure you have activated the software correctly and can authenticate with the Nexpose API by sending an HTTP request. You can use the <span class="calibre4">curl</span> utility to make an authentication request to the API and display the response, as shown in <a href="#filepos461017">Listing 6-2</a>.</p><blockquote class="calibre_14"><span class="calibre4">$ </span><span class="calibre4"><span class="bold">curl -d '&lt;LoginRequest user-id="nxadmin" password="nxpassword"/&gt;' -X POST -k \</span></span><br class="calibre5"/><span class="calibre4">
</span><span class="calibre4"><span class="bold">-H "Content-Type: text/xml" https://192.168.1.197:3780/api/1.1/xml</span></span><br class="calibre5"/><span class="calibre4">&lt;LoginResponse success="1" session-id="D45FFD388D8520F5FE18CACAA66BE527C1AF5888"/&gt;</span><br class="calibre5"/><span class="calibre4">$</span></blockquote><p id="filepos461017" class="calibre_15"><span class="calibre4"><span class="italic">Listing 6-2: Successfully authenticating with the Nexpose API using</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">curl</span></span></p><p class="calibre_6">If you see a response containing <span class="calibre4">success="1"</span> and a session ID, Nexpose has been correctly activated, and the API is functioning as expected with your credentials.</p><p id="filepos461446" class="calibre_10"><span class="calibre3"><span class="italic"><span class="bold">Some Nexpose Parlance</span></span></span></p><p class="calibre_11">Before we discuss managing and reporting on vulnerability scans in Nexpose any further, we need to define a couple of terms. When you start a vulnerability scan in Nexpose, you scan a <span class="italic">site</span>, which is a collection of related hosts or <span class="italic">assets</span>.</p><p class="calibre_6">Nexpose has two types of sites: static sites and dynamic sites. We will focus on the former during our automation. A static site holds a list of hosts you can only change by reconfiguring the site. This is why it is called <span class="italic">static</span>—the site won’t change over time. Nexpose also supports creating sites based on asset filters, so the assets in a dynamic site may change from one week to another based on their vulnerability count or inability to authenticate. Dynamic sites are more complex, but they are much more powerful than static sites and are a great feature to familiarize yourself with as extra homework.</p><p class="calibre_6">The assets that make up the sites are simply connected devices on your network that Nexpose can communicate with. These assets can be bare-metal data center rack servers, VMware ESXi hosts, or Amazon AWS instances. If you can ping it with an IP address, it can be an asset in your Nexpose site. Many times, it is beneficial to separate the hosts on your physical network into logical sites in Nexpose so you can more granularly scan and manage vulnerabilities. A sophisticated enterprise network may have a site specifically for ESXi hosts, a site for the C-level executive network segment, and a site for the customer service call center assets.</p><p id="filepos463212" class="calibre_10"><span class="calibre3"><span class="bold">The NexposeSession Class</span></span></p><p class="calibre_11">We’ll begin by writing the <span class="calibre4">NexposeSession</span> class to communicate with the Nexpose API, as shown in <a href="#filepos464682">Listing 6-3</a>.</p><blockquote class="calibre_14"><span class="calibre4">public class NexposeSession : IDisposable</span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4"> public ➊NexposeSession(string username, string password, string host,</span><br class="calibre5"/><span class="calibre4"> int port = ➋3780, NexposeAPIVersion version = ➌NexposeAPIVersion.v11)</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> this.➍Host = host;</span><br class="calibre5"/><span class="calibre4"> this.Port = port;</span><br class="calibre5"/><span class="calibre4"> this.APIVersion = version;</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> ServicePointManager.➎ServerCertificateValidationCallback = (s, cert, chain, ssl) =&gt; true;</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> this.➏Authenticate(username, password);</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> public string Host { get; set; }</span><br class="calibre5"/><span class="calibre4"> public int Port { get; set; }</span><br class="calibre5"/><span class="calibre4"> public bool IsAuthenticated { get; set; }</span><br class="calibre5"/><span class="calibre4"> public string SessionID { get; set; }</span><br class="calibre5"/><span class="calibre4"> public NexposeAPIVersion APIVersion { get; set; }</span></blockquote><p id="filepos464682" class="calibre_15"><span class="calibre4"><span class="italic">Listing 6-3: The beginning of the</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">NexposeSession</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">class with constructor and properties</span></span></p><p class="calibre_6">The <span class="calibre4">NexposeSession</span> class constructor ➊ takes up to five arguments: three are required (username, password, and the host to connect to), and two are optional (the port and API version, with defaults of <span class="calibre4">3780</span> ➋ and <span class="calibre4">NexposeAPIVersion.v11</span> ➌, respectively). Beginning at ➍, we assign the properties <span class="calibre4">Host</span>, <span class="calibre4">Port</span>, and <span class="calibre4">APIVersion</span> to the three required arguments. Next, we disable SSL certificate verification at ➎ by setting <span class="calibre4">ServerCertificateValidationCallback</span> to always return <span class="calibre4">true</span>. Doing so violates good security principles, but we disable verification because Nexpose runs on HTTPS with a self-signed certificate by default. (Otherwise, SSL certificate verification would fail during the HTTP request.) At ➏, we attempt to authenticate by calling the <span class="calibre4">Authenticate()</span> method, shown expanded in <a href="#filepos467077">Listing 6-4</a>.</p><blockquote class="calibre_14"><span class="calibre4">public XDocument ➊Authenticate(string username, string password)</span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4"> XDocument cmd = new ➋XDocument(</span><br class="calibre5"/><span class="calibre4"> new XElement("LoginRequest",</span><br class="calibre5"/><span class="calibre4"> new XAttribute("user-id", username),</span><br class="calibre5"/><span class="calibre4"> new XAttribute("password", password)));</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> XDocument doc = (XDocument)this.➌ExecuteCommand(cmd);</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> ➍if (doc.Root.Attribute("success").Value == "1")</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> ➎this.SessionID = doc.Root.Attribute("session-id").Value;</span><br class="calibre5"/><span class="calibre4"> this.IsAuthenticated = true;</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><span class="calibre4"> else</span><br class="calibre5"/><span class="calibre4"> throw new Exception("Authentication failed");</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> ➏return doc;</span><br class="calibre5"/><span class="calibre4">}</span></blockquote><p id="filepos467077" class="calibre_15"><span class="calibre4"><span class="italic">Listing 6-4: The</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">NexposeSession</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">class’s</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">Authenticate()</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">method</span></span></p><p class="calibre_6"> The <span class="calibre4">Authenticate()</span> method ➊ takes as arguments a username and a password. To send the username and password to the API for authentication, we create an <span class="calibre4">XDocument</span> at ➋ with root node <span class="calibre4">LoginRequest</span> and <span class="calibre4">user-id</span> and <span class="calibre4">password</span> attributes. We pass the <span class="calibre4">XDocument</span> to the <span class="calibre4">ExecuteCommand()</span> method ➌ and then store the result returned by the Nexpose server.</p><p class="calibre_6">At ➍, we determine whether Nexpose’s XML response has a success attribute value of 1. If so, at ➎ we assign the <span class="calibre4">SessionID</span> property to the <span class="calibre4">session-id</span> in the response and set <span class="calibre4">IsAuthenticated</span> to true. Finally, we return the XML response ➏.</p><p id="filepos468329" class="calibre_10"><span class="calibre3"><span class="italic"><span class="bold">The ExecuteCommand() Method</span></span></span></p><p class="calibre_11">The <span class="calibre4">ExecuteCommand()</span> method shown in <a href="#filepos469415">Listing 6-5</a> is the real meat of the <span class="calibre4">NexposeSession</span> class.</p><blockquote class="calibre_14"><span class="calibre4">public object ExecuteCommand(XDocument commandXml)</span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4"> string uri = string.Empty;</span><br class="calibre5"/><span class="calibre4"> switch (this.➊APIVersion)</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> case NexposeAPIVersion.v11:</span><br class="calibre5"/><span class="calibre4"> uri = "/api/1.1/xml";</span><br class="calibre5"/><span class="calibre4"> break;</span><br class="calibre5"/><span class="calibre4"> case NexposeAPIVersion.v12:</span><br class="calibre5"/><span class="calibre4"> uri = "/api/1.2/xml";</span><br class="calibre5"/><span class="calibre4"> break;</span><br class="calibre5"/><span class="calibre4"> default:</span><br class="calibre5"/><span class="calibre4"> throw new Exception("Unknown API version.");</span><br class="calibre5"/><span class="calibre4"> }</span></blockquote><p id="filepos469415" class="calibre_15"><span class="calibre4"><span class="italic">Listing 6-5: The beginning of the</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">NexposeSession</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">class’s</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">ExecuteCommand()</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">method</span></span></p><p class="calibre_6">Before we can send data to Nexpose, we need to know which version of the API to use, so at ➊ we use a <span class="calibre4">switch</span>/<span class="calibre4">case</span> block (similar to a series of <span class="calibre4">if</span> statements) to test the value of the <span class="calibre4">APIVersion</span>. A value of <span class="calibre4">NexposeAPIVersion.v11</span> or <span class="calibre4">NexposeAPIVersion.v12</span>, for example, would tell us that we need to use the API URI for version 1.1 or 1.2.</p><p class="calibre_10"><span class="calibre3"><span class="bold">Making the HTTP Request to the Nexpose API</span></span></p><p class="calibre_11">Having determined the URI to make the API request to, we can now send the XML request data to Nexpose, as shown in <a href="#filepos471307">Listing 6-6</a>.</p><blockquote class="calibre_14"><span class="calibre4"> byte[] byteArray = Encoding.ASCII.GetBytes(commandXml.ToString());</span><br class="calibre5"/><span class="calibre4">➊ HttpWebRequest request = WebRequest.Create("https://" + this.Host</span><br class="calibre5"/><span class="calibre4"> + ":" + this.Port.ToString() + uri) as HttpWebRequest;</span><br class="calibre5"/><span class="calibre4"> request.Method = ➋"POST";</span><br class="calibre5"/><span class="calibre4"> request.ContentType = ➌"text/xml";</span><br class="calibre5"/><span class="calibre4"> request.ContentLength = byteArray.Length;</span><br class="calibre5"/><span class="calibre4"> using (Stream dataStream = request.GetRequestStream())</span><br class="calibre5"/><span class="calibre4"> dataStream.➍Write(byteArray, 0, byteArray.Length); </span><a id="filepos471307"/><span class="calibre4"><span class="italic">Listing 6-6: Sending the XML command over HTTP for Nexpose inside</span></span><span class="calibre4">
</span><span class="calibre7"><span class="italic">ExecuteCommand()</span></span></blockquote><p class="calibre_6">Talking to the HTTP API for Nexpose happens in two parts. First, Nexpose makes the API request with the XML that will tell Nexpose what command we are running; then it reads the response with the results of the API request. To make the actual HTTP request to the Nexpose API, we create an <span class="calibre4">HttpWebRequest</span> ➊ and assign its <span class="calibre4">Method</span> property to <span class="calibre4">POST</span> ➋, its <span class="calibre4">ContentType</span> property to <span class="calibre4">text/xml</span> ➌, and the <span class="calibre4">ContentLength</span> property to the length of our XML. Next, we write the API XML command bytes to the HTTP request stream and send the stream to Nexpose with <span class="calibre4">Write()</span> ➍. Nexpose will parse the XML, determine what to do, and then return the results in the response.</p><blockquote class="calibre_8"><blockquote class="calibre_36"><span class="calibre3"><span class="bold">TLS IN MONO</span></span></blockquote></blockquote><blockquote class="calibre_8"><blockquote class="calibre_7">As of this writing, the state of TLS in Mono is in flux. Support for TLS v1.1 and v1.2 has been written, but it is not currently shipped by default. Because of this, the HTTP library may fail to make HTTPS requests and only output a cryptic exception about authentication failing. If this happens, it is because Nexpose is only allowing a TLS v1.1 or v1.2 connection and Mono can only support v1.0. To remedy this situation for testing purposes, you just need to add a line of code that will force Mono to proxy through Burp Suite, a tool we used in <a href="index_split_007.html#filepos114239">Chapter 2</a>.</blockquote></blockquote><blockquote class="calibre_8"><blockquote class="calibre_7">To do this, we can change the code in <a href="#filepos471307">Listing 6-6</a> to the following code in <a href="#filepos473722">Listing 6-7</a>.</blockquote></blockquote><blockquote class="calibre_8"><blockquote class="calibre_14"><span class="calibre4">request.Method = "POST";</span><br class="calibre5"/><span class="calibre4">request.Proxy = new ➊WebProxy("127.0.0.1:8080");</span><br class="calibre5"/><span class="calibre4">request.ContentType = "text/xml"; </span><span class="calibre4"><span class="italic">Listing 6-7: Setting a proxy for TLS</span></span></blockquote><a id="filepos473722"/></blockquote><blockquote class="calibre_8"><blockquote class="calibre_7">We add a line to set the Proxy property of the request so that it points to a listening Burp Suite proxy ➊. Burp Suite will happily negotiate a TLS v1.0 connection for our Mono client as well as a TLS v1.1/1.2 connection for the Nexpose server. When the TLS issues have been ironed out—hopefully in the near future—the code in this book should work across platforms without this hack.</blockquote></blockquote><p class="calibre_10"><span class="calibre3"><span class="bold">Reading the HTTP Response from the Nexpose API</span></span></p><p class="calibre_11">Next, we need to read the HTTP response from the API request we just made. <a href="#filepos476186">Listing 6-8</a> shows how we finish the <span class="calibre4">ExecuteCommand()</span> method by reading the HTTP response from Nexpose and then returning either an <span class="calibre4">XDocument</span> or an array of raw bytes, depending on the HTTP response content type. With <a href="#filepos476186">Listing 6-8</a> finishing the <span class="calibre4">ExecuteCommand()</span> method, we will be able to make an API request and then return the correct response data, depending on the response content type.</p><blockquote class="calibre_14"><span class="calibre4"> string response = string.Empty;</span><br class="calibre5"/><span class="calibre4"> using (HttpWebResponse r = request.➊GetResponse() as HttpWebResponse)</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> using (StreamReader reader = new ➋StreamReader(r.GetResponseStream()))</span><br class="calibre5"/><span class="calibre4"> response = reader.➌ReadToEnd();</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> if (r.ContentType.Contains(➍"multipart/mixed"))</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> string[] splitResponse = response</span><br class="calibre5"/><span class="calibre4"> .Split(new string[] {➎"--AxB9sl3299asdjvbA"}, StringSplitOptions.None);</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> splitResponse = splitResponse[2]</span><br class="calibre5"/><span class="calibre4"> .Split(new string[] { ➏"\r\n\r\n" }, StringSplitOptions.None);</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> string base64Data = splitResponse[1];</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> return ➐Convert.FromBase64String(base64Data);</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><span class="calibre4"> return XDocument.Parse(response);</span><br class="calibre5"/><span class="calibre4">}</span></blockquote><p id="filepos476186" class="calibre_15"><span class="calibre4"><span class="italic">Listing 6-8: The last part of the</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">NexposeSession</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">class’s</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">ExecuteCommand()</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">method</span></span></p><p class="calibre_6">Usually, when you send an XML command to Nexpose, you get XML in return. But when you request a vulnerability scan report, such as the PDF report we will request after performing a vulnerability scan, you get the HTTP response <span class="calibre4">multipart/mixed</span> rather than <span class="calibre4">application/xml</span>. Exactly why Nexpose changes the HTTP response based on PDF reports is not clear, but because our request may return a response with either a Base64-encoded report or an <span class="calibre4">XDocument</span> (the XML document class we first used in <a href="index_split_008.html#filepos243384">Chapter 3</a>), we need to be able to handle both types of responses.</p><p class="calibre_6">In order to begin reading the HTTP response from Nexpose, we call <span class="calibre4">GetResponse()</span> ➊ so that we can read the HTTP response stream; then we create a <span class="calibre4">StreamReader</span> ➋ to read the response data into a string ➌ and check its content type. If the response type is <span class="calibre4">multipart/mixed</span> ➍, we break the response into an array of strings so that we can parse the report data by leveraging the fact that Nexpose <span class="calibre4">multipart/mixed</span> responses always use the string <span class="calibre4">--AxB9sl3299asdjvbA</span> ➎ to separate the HTTP parameters in the HTTP response.</p><p class="calibre_6">After the HTTP response is split, the third element in the resulting string array will always contain the Base64-encoded report data from the scan. At ➏, we use two newline sequences (<span class="calibre4">\r\n\r\n</span>) to separate out this report data. Now we can reference only the Base64-encoded data, but first we must remove some invalid data from the end of the Base64-encoded report. Finally, we pass the Base64-encoded data to <span class="calibre4">Convert.FromBase64String()</span> ➐, which returns a byte array of the Base64-decoded data that can then be written to the filesystem as our final PDF report to read later.</p><p id="filepos478597" class="calibre_10"><span class="calibre3"><span class="italic"><span class="bold">Logging Out and Disposing of Our Session</span></span></span></p><p class="calibre_11"><a href="#filepos479870">Listing 6-9</a> shows the <span class="calibre4">Logout()</span> and <span class="calibre4">Dispose()</span> methods, which will make it easy for us to log out of our session and clean up any session data.</p><blockquote class="calibre_14"><span class="calibre4">public XDocument ➊Logout()</span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4"> XDocument cmd = new ➋XDocument(</span><br class="calibre5"/><span class="calibre4"> new XElement(➌"LogoutRequest",</span><br class="calibre5"/><span class="calibre4"> new XAttribute(➍"session-id", this.SessionID)));</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> XDocument doc = (XDocument)this.ExecuteCommand(cmd);</span><br class="calibre5"/><span class="calibre4"> this.➎IsAuthenticated = false;</span><br class="calibre5"/><span class="calibre4"> this.SessionID = string.Empty;</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> return doc;</span><br class="calibre5"/><span class="calibre4">}</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4">public void ➏Dispose()</span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4"> if (this.➐IsAuthenticated)</span><br class="calibre5"/><span class="calibre4"> this.Logout();</span><br class="calibre5"/><span class="calibre4">}</span></blockquote><p id="filepos479870" class="calibre_15"><span class="calibre4"><span class="italic">Listing 6-9: The</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">NexposeSession</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">class’s</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">Dispose()</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">and</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">Logout()</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">methods</span></span></p><p class="calibre_6">In <span class="calibre4">Logout()</span> ➊, we build an <span class="calibre4">XDocument</span> ➋ with the root node <span class="calibre4">LogoutRequest</span> ➌ and the attribute <span class="calibre4">session-id</span> ➍. When we send this information to Nexpose as XML, it will attempt to invalidate the session ID token, effectively logging us out. At the same time, we set <span class="calibre4">IsAuthenticated</span> ➎ to <span class="calibre4">false</span> and <span class="calibre4">SessionID</span> to <span class="calibre4">string.Empty</span> to clean up the old authentication information; then we return the logout response XML.</p><p class="calibre_6">We’ll use the <span class="calibre4">Dispose()</span> method ➏ (required by the <span class="calibre4">IDisposable</span> interface) to clean up our Nexpose session. As you can see at ➐, we check whether we are authenticated and, if so, call <span class="calibre4">Logout()</span> to invalidate our session.</p><p id="filepos481297" class="calibre_10"><span class="calibre3"><span class="italic"><span class="bold">Finding the API Version</span></span></span></p><p class="calibre_11"><a href="#filepos481845">Listing 6-10</a> shows how we’ll use <span class="calibre4">NexposeAPIVersion</span> to determine which Nexpose API version to use.</p><blockquote class="calibre_14"><span class="calibre4">public enum NexposeAPIVersion</span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4"> v11,</span><br class="calibre5"/><span class="calibre4"> v12</span><br class="calibre5"/><span class="calibre4">}</span></blockquote><p id="filepos481845" class="calibre_15"><span class="calibre4"><span class="italic">Listing 6-10: The</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">NexposeAPIVersion enum</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">used in the</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">NexposeSession</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">class</span></span></p><p class="calibre_6"> The code <span class="calibre4">enum NexposeAPIVersion</span> gives us an easy way to determine which API URI to make HTTP requests to. We used <span class="calibre4">NexposeAPIVersion</span> in <a href="#filepos469415">Listing 6-5</a> to do exactly this when building the API URI in <span class="calibre4">ExecuteCommand()</span>.</p><p id="filepos482549" class="calibre_10"><span class="calibre3"><span class="italic"><span class="bold">Driving the Nexpose API</span></span></span></p><p class="calibre_11"><a href="#filepos483544">Listing 6-11</a> shows how we can now use <span class="calibre4">NexposeSession</span> to communicate with the Nexpose API and authenticate and print the <span class="calibre4">SessionID</span>. This is a good test to ensure the code we have written so far is working as expected.</p><blockquote class="calibre_14"><span class="calibre4">class MainClass</span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4"> public static void Main(string[] args)</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> using (NexposeSession session = new ➊NexposeSession("admin", "adm1n!", "192.168.2.171"))</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> Console.WriteLine(session.SessionID);</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><span class="calibre4">}</span></blockquote><p id="filepos483544" class="calibre_15"><span class="calibre4"><span class="italic">Listing 6-11: Using</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">NexposeSession</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">to authenticate with the Nexpose API and print</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">SessionID</span></span></p><p class="calibre_6">At ➊, we attempt to authenticate by passing the username, password, and IP address of the Nexpose server to a new <span class="calibre4">NexposeSession</span>. If authentication succeeds, we display the <span class="calibre4">SessionID</span> assigned to the session onscreen. If authentication fails, we throw an exception with the message “Authentication failed.”</p><p id="filepos484265" class="calibre_10"><span class="calibre3"><span class="bold">The NexposeManager Class</span></span></p><p class="calibre_11">The <span class="calibre4">NexposeManager</span> class shown in <a href="#filepos485964">Listing 6-12</a> allows us to create, monitor, and report on the result of our scans. We begin with a simple API call.</p><blockquote class="calibre_14"><span class="calibre4">public class NexposeManager : ➊IDisposable</span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4"> private readonly NexposeSession _session;</span><br class="calibre5"/><span class="calibre4"> public NexposeManager(➋NexposeSession session)</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> if (!session.➌IsAuthenticated)</span><br class="calibre5"/><span class="calibre4"> throw new ➍ArgumentException("Trying to create manager from "</span><br class="calibre5"/><span class="calibre4"> + "unauthenticated session. Please authenticate.", "session");</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> _session = session;</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> public XDocument ➎GetSystemInformation()</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> XDocument xml = new XDocument(</span><br class="calibre5"/><span class="calibre4"> new XElement("➏SystemInformationRequest",</span><br class="calibre5"/><span class="calibre4"> new XAttribute("session-id", _session.SessionID)));</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> ➐return (XDocument)_session.ExecuteCommand(xml);</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><span class="calibre4"> public void ➑Dispose()</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> _session.Logout();</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><span class="calibre4">}</span></blockquote><p id="filepos485964" class="calibre_15"><span class="calibre4"><span class="italic">Listing 6-12: The</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">NexposeManager</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">class with a</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">GetSystemInformation()</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">method</span></span></p><p class="calibre_6">Because <span class="calibre4">NexposeManager</span> implements <span class="calibre4">IDisposable</span> ➊, we write a <span class="calibre4">Dispose()</span> method ➑ by declaring the <span class="calibre4">_session</span> to hold the <span class="calibre4">NexposeSession</span> class that <span class="calibre4">NexposeManager</span> will consume, and we pass in <span class="calibre4">NexposeSession</span> ➋ as the only argument. If the Nexpose session authenticates ➌, we assign <span class="calibre4">_session</span> to the session. If not, we throw an exception ➍.</p><p class="calibre_6">To test the manager class initially, we’ll implement a short and simple API method for retrieving some general system information about the Nexpose console. The <span class="calibre4">GetSystemInformation()</span> method ➎ makes a simple <span class="calibre4">SystemInformationRequest</span> API request ➏ and then returns the response ➐.</p><p class="calibre_6">In order to print the Nexpose system information (including versioning information, such as the PostgreSQL and Java versions in use, and hardware information, such as the CPU count and RAM available), we add <span class="calibre4">NexposeManager</span> to our <span class="calibre4">Main()</span> method from <a href="#filepos483544">Listing 6-11</a>, as shown in <a href="#filepos488327">Listing 6-13</a>.</p><blockquote class="calibre_14"><span class="calibre4">public static void Main(string[] args)</span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4"> using (NexposeSession session = new NexposeSession("admin", "Passw0rd!", "192.168.2.171"))</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> using (NexposeManager manager = new ➊NexposeManager(session))</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> Console.WriteLine(manager.➋GetSystemInformation().ToString());</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><span class="calibre4">}</span></blockquote><p id="filepos488327" class="calibre_15"><span class="calibre4"><span class="italic">Listing 6-13: Using the</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">NexposeManager</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">class in the</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">Main()</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">method</span></span></p><p class="calibre_6">We pass our <span class="calibre4">NexposeSession</span> class into the <span class="calibre4">NexposeManager</span> constructor ➊ and then call <span class="calibre4">GetSystemInformation()</span> ➋ to print the system information, as shown in <a href="#filepos489097">Figure 6-4</a>.</p><p class="calibre_22"><img src="images/00022.jpg" class="calibre_37"/></p><p id="filepos489097" class="calibre_15"><span class="calibre4"><span class="italic">Figure 6-4: Getting the Nexpose system information via the API</span></span></p><p id="filepos489233" class="calibre_10"><span class="calibre3"><span class="bold"> Automating a Vulnerability Scan</span></span></p><p class="calibre_11">In this section, we finally look at how to automate a vulnerability scan with Nexpose. We create a Nexpose site, scan the site, and then download a report of the findings. We’ll only scratch the surface of Nexpose’s powerful scanning features.</p><p id="filepos489634" class="calibre_10"><span class="calibre3"><span class="italic"><span class="bold">Creating a Site with Assets</span></span></span></p><p class="calibre_11">Before launching a scan with Nexpose, we need to create a site to be scanned. <a href="#filepos491843">Listing 6-14</a> shows how we can build the XML API request for creating a site in the <span class="calibre4">CreateOrUpdateSite()</span> method.</p><blockquote class="calibre_14"><span class="calibre4">public XDocument ➊CreateOrUpdateSite(string name, string[] hostnames = null,</span><br class="calibre5"/><span class="calibre4"> string[][] ips = null, int siteID = ➋-1)</span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4"> XElement hosts = new ➌XElement("Hosts");</span><br class="calibre5"/><span class="calibre4"> if (➍hostnames != null)</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> foreach (string host in hostnames)</span><br class="calibre5"/><span class="calibre4"> hosts.Add(new XElement("host", host));</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> if (➎ips != null)</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> foreach (string[] range in ips)</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> hosts.Add(new XElement ("range",</span><br class="calibre5"/><span class="calibre4"> new XAttribute("from", range[0]),</span><br class="calibre5"/><span class="calibre4"> new XAttribute("to", range[1])));</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> XDocument xml = ➏new XDocument(</span><br class="calibre5"/><span class="calibre4"> new XElement("SiteSaveRequest",</span><br class="calibre5"/><span class="calibre4"> new XAttribute("session-id", _session.SessionID),</span><br class="calibre5"/><span class="calibre4"> new XElement("Site",</span><br class="calibre5"/><span class="calibre4"> new XAttribute("id", siteID),</span><br class="calibre5"/><span class="calibre4"> new XAttribute("name", name),</span><br class="calibre5"/><span class="calibre4"> ➐hosts,</span><br class="calibre5"/><span class="calibre4"> new XElement("ScanConfig",</span><br class="calibre5"/><span class="calibre4"> new XAttribute("name", "Full audit"),</span><br class="calibre5"/><span class="calibre4"> new XAttribute(➑"templateID", "full-audit")))));</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> return (XDocument)_session.➒ExecuteCommand(xml);</span><br class="calibre5"/><span class="calibre4">}</span></blockquote><p id="filepos491843" class="calibre_15"><span class="calibre4"><span class="italic">Listing 6-14: The</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">CreateOrUpdateSite()</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">method in the</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">NexposeManager</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">class</span></span></p><p class="calibre_6">The <span class="calibre4">CreateOrUpdateSite()</span> method ➊ takes up to four arguments: the human-readable site name, any hostnames and IP ranges, and the site ID. Passing <span class="calibre4">-1</span> ➋ as the site ID, as shown here, creates a new site. At ➌, we create an XML element called <span class="calibre4">Hosts</span>, and if there is a <span class="calibre4">hostnames</span> argument that is not <span class="calibre4">null</span> ➍, we add it to <span class="calibre4">Hosts</span>. We do the same for any IP ranges ➎ passed as arguments.</p><p class="calibre_6">Next, we create an <span class="calibre4">XDocument</span> ➏ with the root XML node <span class="calibre4">SiteSaveRequest</span> and a <span class="calibre4">session-id</span> attribute to tell the Nexpose server that we’re authenticated and can make this API call. Inside the root node, we create an <span class="calibre4">XElement</span> called <span class="calibre4">Site</span> to hold specific information for the new site and scan configuration details, such as the hosts to scan ➐ and the scan template ID ➑. At ➒, we pass <span class="calibre4">SiteSaveRequest</span> to <span class="calibre4">ExecuteCommand()</span> and cast the object that <span class="calibre4">ExecuteCommand()</span> returns to an <span class="calibre4">XDocument</span>.</p><p id="filepos493502" class="calibre_10"><span class="calibre3"><span class="italic"><span class="bold">Starting a Scan</span></span></span></p><p class="calibre_11"><a href="#filepos495163">Listing 6-15</a> shows how to begin the site scan and get its status with the <span class="calibre4">ScanSite()</span> and <span class="calibre4">GetScanStatus()</span> methods. Hopefully you’re beginning to see how easy it can be to implement new API functionality in the <span class="calibre4">Manager</span> class when the <span class="calibre4">NexposeSession</span> class does all the communication and all you have to do is set up the API request XML.</p><blockquote class="calibre_14"><span class="calibre4">public XDocument ➊ScanSite(int ➋siteID)</span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4"> XDocument xml = ➌new XDocument(</span><br class="calibre5"/><span class="calibre4"> new XElement(➍"SiteScanRequest",</span><br class="calibre5"/><span class="calibre4"> new XAttribute("session-id", _session.SessionID),</span><br class="calibre5"/><span class="calibre4"> new XAttribute("site-id", siteID)));</span><br class="calibre5"/><span class="calibre4"> return (XDocument)_session.ExecuteCommand(xml);</span><br class="calibre5"/><span class="calibre4">}</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4">public XDocument ➎GetScanStatus(int scanID)</span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4"> XDocument xml = ➏new XDocument(</span><br class="calibre5"/><span class="calibre4"> new XElement("ScanStatusRequest",</span><br class="calibre5"/><span class="calibre4"> new XAttribute("session-id", _session.SessionID),</span><br class="calibre5"/><span class="calibre4"> new XAttribute("scan-id", scanID)));</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> return (XDocument)_session.ExecuteCommand (xml);</span><br class="calibre5"/><span class="calibre4">}</span></blockquote><p id="filepos495163" class="calibre_15"><span class="calibre4"><span class="italic">Listing 6-15: The</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">ScanSite()</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">and</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">GetScanStatus()</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">methods in the</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">NexposeManager</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">class</span></span></p><p class="calibre_6">The <span class="calibre4">ScanSite()</span> method ➊ takes the <span class="calibre4">siteID</span> ➋ as an argument to scan. We create an <span class="calibre4">XDocument</span> ➌ with root node <span class="calibre4">SiteScanRequest</span> ➍ and then add to it the <span class="calibre4">session-id</span> and <span class="calibre4">site-id</span> attributes. Next, we send the <span class="calibre4">SiteScanRequest</span> XML to the Nexpose server and return the response.</p><p class="calibre_6">The <span class="calibre4">GetScanStatus()</span> method ➎ accepts one argument, the scan ID to check, which is returned by the <span class="calibre4">ScanSite()</span> method. After creating a new <span class="calibre4">XDocument</span> ➏ with root node <span class="calibre4">ScanStatusRequest</span> and adding the <span class="calibre4">session-id</span> and <span class="calibre4">scan-id</span> attributes, we send the resulting <span class="calibre4">XDocument</span> to the Nexpose server and return the response to the caller.</p><p id="filepos496635" class="calibre_10"><span class="calibre3"><span class="bold"> Creating a PDF Site Report and Deleting the Site</span></span></p><p class="calibre_11"><a href="#filepos498467">Listing 6-16</a> shows how we create the scan report and delete the site using the API in the <span class="calibre4">GetPdfSiteReport()</span> and <span class="calibre4">DeleteSite()</span> methods.</p><blockquote class="calibre_14"><span class="calibre4">public byte[] GetPdfSiteReport(int siteID)</span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4"> XDocument doc = new XDocument(</span><br class="calibre5"/><span class="calibre4"> new XElement(➊"ReportAdhocGenerateRequest",</span><br class="calibre5"/><span class="calibre4"> new XAttribute("session-id", _session.SessionID),</span><br class="calibre5"/><span class="calibre4"> new XElement("AdhocReportConfig",</span><br class="calibre5"/><span class="calibre4"> new XAttribute("template-id", "audit-report"),</span><br class="calibre5"/><span class="calibre4"> new XAttribute("format", ➋"pdf"),</span><br class="calibre5"/><span class="calibre4"> new XElement("Filters",</span><br class="calibre5"/><span class="calibre4"> new XElement("filter",</span><br class="calibre5"/><span class="calibre4"> new XAttribute("type", "site"),</span><br class="calibre5"/><span class="calibre4"> new XAttribute("id", ➌siteID))))));</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> return (➍byte[])_session.ExecuteCommand(doc);</span><br class="calibre5"/><span class="calibre4">}</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4">public XDocument ➎DeleteSite(int siteID)</span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4"> XDocument xml = new XDocument(</span><br class="calibre5"/><span class="calibre4"> new XElement(➏"SiteDeleteRequest",</span><br class="calibre5"/><span class="calibre4"> new XAttribute("session-id", _session.SessionID),</span><br class="calibre5"/><span class="calibre4"> new XAttribute("site-id", siteID)));</span><br class="calibre5"/><span class="calibre4">➐ return (XDocument)_session.ExecuteCommand(xml);</span><br class="calibre5"/><span class="calibre4">}</span></blockquote><p id="filepos498467" class="calibre_15"><span class="calibre4"><span class="italic">Listing 6-16: The</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">GetPdfSiteReport()</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">and</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">DeleteSite()</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">methods in the</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">NexposeManager</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">class</span></span></p><p class="calibre_6">Both methods take only one argument, the site ID. To generate a PDF report, we use <span class="calibre4">ReportAdHocGenerateRequest</span> ➊ and specify <span class="calibre4">pdf</span> ➋ and the <span class="calibre4">siteID</span> ➌. We cast the object returned by <span class="calibre4">ExecuteCommand()</span> to a byte array ➍ instead of an <span class="calibre4">XDocument</span> because Nexpose will return a <span class="calibre4">multipart/mixed</span> HTTP response for a <span class="calibre4">ReportAdHocGenerateRequest</span>. We return the raw bytes of the PDF report to be written to the calling method.</p><p class="calibre_6">We use <span class="calibre4">DeleteSite()</span> ➎ to delete the site and create a <span class="calibre4">SiteDeleteRequest XDocument</span> ➏ and then make the API call and return the results ➐.</p><p id="filepos499790" class="calibre_10"><span class="calibre3"><span class="bold">Putting It All Together</span></span></p><p class="calibre_11">Now that you know how to drive Nexpose programmatically, let’s create a new Nexpose site, scan it, create a PDF report of its vulnerabilities, and delete the site. <a href="#filepos501086">Listing 6-17</a> begins this process by creating a new site and retrieving its ID with our two new classes.</p><blockquote class="calibre_14"><span class="calibre4">public static void Main(string[] args)</span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4"> using (NexposeSession session = new ➊NexposeSession("admin", "adm1n!", "192.168.2.171"))</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> using (NexposeManager manager = new ➋NexposeManager(session))</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> ➌string[][] ips =</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> new string[] { "192.168.2.169", ➍string.Empty }</span><br class="calibre5"/><span class="calibre4"> };</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> XDocument site = manager.➎CreateOrUpdateSite(➏Guid.NewGuid().ToString(), null, ips);</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> int siteID = int.Parse(site.Root.Attribute("site-id").Value); </span><a id="filepos501086"/><span class="calibre4"><span class="italic">Listing 6-17: Creating the temporary site and retrieving the site ID</span></span></blockquote><p class="calibre_6">After creating the <span class="calibre4">NexposeSession</span> ➊ and <span class="calibre4">NexposeManager</span> ➋ objects, we pass in the list of IP addresses to scan as a string ➌, with a starting and ending address. To scan a single IP, use an empty string as the second element, as shown at ➍. We pass the list of target IPs to <span class="calibre4">CreateOrUpdateSite()</span> ➎ along with a <span class="calibre4">Guid</span> ➏ as the name of the temporary site. (We simply need a unique string for the site name.) When we receive the HTTP response from Nexpose for creating the temporary site, we grab the site ID from the XML and store it.</p><p id="filepos501881" class="calibre_10"><span class="calibre3"><span class="italic"><span class="bold">Starting the Scan</span></span></span></p><p class="calibre_11"><a href="#filepos503026">Listing 6-18</a> shows how we run and monitor the vulnerability scan by basically sitting in a <span class="calibre4">while</span> loop and sleeping until the scan is finished.</p><blockquote class="calibre_14"><span class="calibre4"> XDocument scan = manager.➊ScanSite(siteID);</span><br class="calibre5"/><span class="calibre4"> XElement ele = scan.XPathSelectElement("//SiteScanResponse/Scan");</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> int scanID = int.Parse(ele.Attribute("scan-id").Value);</span><br class="calibre5"/><span class="calibre4"> XDocument status = manager.➋GetScanStatus(scanID);</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> while (status.Root.Attribute("status").Value != ➌"finished")</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> Thread.Sleep(1000);</span><br class="calibre5"/><span class="calibre4"> status = manager.GetScanStatus(scanID);</span><br class="calibre5"/><span class="calibre4"> Console.➍WriteLine(DateTime.Now.ToLongTimeString()+": "+status.ToString());</span><br class="calibre5"/><span class="calibre4"> }</span></blockquote><p id="filepos503026" class="calibre_15"><span class="calibre4"><span class="italic">Listing 6-18: Starting and monitoring the Nexpose scan</span></span></p><p class="calibre_6">We begin the scan by passing the site ID to <span class="calibre4">ScanSite()</span> ➊ and then grab the scan ID from the response and pass it to <span class="calibre4">GetScanStatus()</span> ➋. Next, in a <span class="calibre4">while</span> loop, we sleep for a few seconds, as long as the scan status is not <span class="calibre4">finished</span> ➌. Then we check the scan status again and display a status message to the user with <span class="calibre4">WriteLine()</span> ➍.</p><p id="filepos503648" class="calibre_10"><span class="calibre3"><span class="italic"><span class="bold">Generating a Report and Deleting the Site</span></span></span></p><p class="calibre_11">Once the scan finishes, we can generate a report and delete the site, as shown in <a href="#filepos504525">listing 6-19</a>.</p><blockquote class="calibre_14"><span class="calibre4"> byte[] report = manager.➊GetPdfSiteReport(siteID);</span><br class="calibre5"/><span class="calibre4"> string outdir = Environment.GetFolderPath(Environment.SpecialFolder.DesktopDirectory);</span><br class="calibre5"/><span class="calibre4"> string outpath = Path.Combine(outdir, ➋siteID + ".pdf");</span><br class="calibre5"/><span class="calibre4"> File.➌WriteAllBytes(outpath, report);</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> manager.➍DeleteSite(siteID);</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><span class="calibre4">}</span></blockquote><p id="filepos504525" class="calibre_15"><span class="calibre4"><span class="italic">Listing 6-19: Retrieving the Nexpose site report, writing it to the filesystem, and then deleting the site</span></span></p><p class="calibre_6">To generate a report, we pass the site ID to <span class="calibre4">GetPdfSiteReport()</span> ➊, which returns an array of bytes. Then we use <span class="calibre4">WriteAllBytes()</span> ➌ to save the PDF report to the user’s <span class="italic">Desktop</span> directory with the site’s ID as the filename ➋ and a <span class="italic">.pdf</span> extension. Then we delete the site with <span class="calibre4">DeleteSite()</span> ➍.</p><p id="filepos505133" class="calibre_10"><span class="calibre3"><span class="italic"><span class="bold">Running the Automation</span></span></span></p><p class="calibre_11"><a href="#filepos506888">Listing 6-20</a> shows how to run a scan and view its report.</p><blockquote class="calibre_14"><span class="calibre4">C:\Users\example\Documents\ch6\bin\Debug&gt;</span><span class="calibre4"><span class="bold">.\06_automating_nexpose.exe</span></span><br class="calibre5"/><span class="calibre4">11:42:24 PM: &lt;ScanStatusResponse success="1" scan-id="4" engine-id="3" status=➊"running" /&gt;</span><br class="calibre5"/><span class="calibre4">–-</span><span class="calibre4"><span class="italic">snip</span></span><span class="calibre4">--</span><br class="calibre5"/><span class="calibre4">11:47:01 PM: &lt;ScanStatusResponse success="1" scan-id="4" engine-id="3" status="running" /&gt;</span><br class="calibre5"/><span class="calibre4">11:47:08 PM: &lt;ScanStatusResponse success="1" scan-id="4" engine-id="3" status=➋"integrating" /&gt;</span><br class="calibre5"/><span class="calibre4">11:47:15 PM: &lt;ScanStatusResponse success="1" scan-id="4" engine-id="3" status=➌"finished" /&gt;</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4">C:\Users\example\Documents\ch6\bin\Debug&gt;</span><span class="calibre4"><span class="bold">dir \Users\example\Desktop\*.pdf</span></span><br class="calibre5"/><span class="calibre4"> Volume in drive C is Acer</span><br class="calibre5"/><span class="calibre4"> Volume Serial Number is 5619-09A2</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> Directory of C:\Users\example\Desktop</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4">07/30/2017 11:47 PM 103,174 4.pdf ➍</span><br class="calibre5"/><span class="calibre4">09/09/2015 09:52 PM 17,152,368 Automate the Boring Stuff with Python.pdf</span><br class="calibre5"/><span class="calibre4"> 2 File(s) 17,255,542 bytes</span><br class="calibre5"/><span class="calibre4"> 0 Dir(s) 362,552,098,816 bytes free</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4">C:\Users\example\Documents\ch6\bin\Debug&gt; </span><a id="filepos506888"/><span class="calibre4"><span class="italic">Listing 6-20: Running the scan and writing the report to the user’s Desktop</span></span></blockquote><p class="calibre_6">Notice in the output of <a href="#filepos506888">Listing 6-20</a> that Nexpose is returning at least three scan statuses, which are separate phases of the scan: running ➊, integrating ➋, and finished ➌. Once the scan finishes, our PDF report is written to the user’s <span class="italic">Desktop</span> ➍, as expected. You can open this new report with your favorite PDF reader and see what kind of vulnerabilities Nexpose may have found.</p><p id="filepos507486" class="calibre_10"><span class="calibre3"><span class="bold"> Conclusion</span></span></p><p class="calibre_11">In this chapter, you learned how to drive the vulnerability scanner Nexpose to report on vulnerabilities for a given host on a network. You also learned how Nexpose stores information about computers on the network, such as sites and assets. You built a few classes to drive Nexpose programmatically using the base C# libraries, and you learned how to use <span class="calibre4">NexposeSession</span> to authenticate with Nexpose and send and receive XML to the Nexpose API. You also saw how the <span class="calibre4">NexposeManager</span> class wraps functionality in the API, including the ability to create and delete sites. Finally, you were able to drive Nexpose to scan a network asset and then create a nice-looking PDF report displaying the results.</p><p class="calibre_6">Nexpose has capabilities far beyond simple vulnerability management. Expanding your library to cover this advanced functionality should be relatively straightforward and is an excellent way to familiarize yourself with the other powerful features Nexpose provides, such as custom scan policies, authenticated vulnerability scans, and more customizable reporting. An advanced, modern, mature enterprise network requires granular system controls that allow an organization to integrate security into business workflows. Nexpose brings all of this to the table and is a powerful tool to have in your arsenal as an IT manager or system admin. </p><div class="mbp_pagebreak" id="calibre_pb_11"/>
</body></html>