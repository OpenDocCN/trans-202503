<html><head></head><body>
<h2 class="h2p" id="part3"><span epub:type="pagebreak" id="page_213"/><span class="big">PART III</span><br/>BUILDING YOUR OWN MODULE</h2>&#13;
<p class="snoindent"><span class="bign">By now, you should have a firm grasp on what makes PowerShell <em>PowerShell</em>. We’ve covered the syntax of the language, as well as a few specific modules you may use in your day-to-day automation work. But up until the preceding chapter, we’ve been doing things only in pieces: a little syntax here, a little syntax there,</span> nothing major. In <a href="ch14.xhtml#ch14">Chapter 14</a>, with the server inventory script, you got your first taste of working on a prolonged PowerShell project. In <a href="part3.xhtml#part3">Part III</a>, we’re going to go bigger: you’re going to build your own PowerShell module.</p>&#13;
<h3 class="h3">PowerLab</h3>&#13;
<p class="noindent"><em>PowerLab</em> is a single PowerShell module that contains the functions you need to provision Windows servers from scratch. You’ll build PowerLab brick by brick; if you want to see the final result, you can find it in this GitHub repository: <em><a href="https://github.com/adbertram/PowerLab">https://github.com/adbertram/PowerLab</a></em>.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_214"/>The process of provisioning a Windows server from scratch will look something like this:</p>&#13;
<ul>&#13;
<li><p class="noindent">Create a virtual machine.</p></li>&#13;
<li><p class="noindent">Install a Windows operating system.</p></li>&#13;
<li><p class="noindent">Install a server service (Active Directory, SQL Server, or IIS).</p></li>&#13;
</ul>&#13;
<p class="indent">This means you’ll need your PowerLab module to do five things:</p>&#13;
<ul>&#13;
<li><p class="noindent">Create Hyper-V virtual machines</p></li>&#13;
<li><p class="noindent">Install a Windows server</p></li>&#13;
<li><p class="noindent">Create an Active Directory forest</p></li>&#13;
<li><p class="noindent">Provision SQL servers</p></li>&#13;
<li><p class="noindent">Provision IIS web servers</p></li>&#13;
</ul>&#13;
<p class="indent">To accomplish these tasks, you’ll use three primary commands:</p>&#13;
<ul>&#13;
<li><p class="noindent"><code>New-PowerLabActiveDirectoryForest</code></p></li>&#13;
<li><p class="noindent"><code>New-PowerLabSqlServer</code></p></li>&#13;
<li><p class="noindent"><code>New-PowerLabWebServer</code></p></li>&#13;
</ul>&#13;
<p class="indent">Of course, you’re going to use more than three commands. You’ll build each of these commands with multiple helper commands that will take care of behind-the-scenes functionality, including creating the virtual machine and installing the operating system. But we’ll go through all of that in the chapters ahead.</p>&#13;
<h3 class="h3">Prerequisites</h3>&#13;
<p class="noindent">You’ll need a few things to build PowerLab:</p>&#13;
<ul>&#13;
<li><p class="noindent">A Windows 10 Professional client computer in a workgroup. A Windows 10 machine joined to a domain may work but was not tested.</p></li>&#13;
<li><p class="noindent">A Hyper-V host in a workgroup running Windows Server 2012 R2 (at least) on the same network as the client—although the host could be joined to a domain as well, but this scenario was not tested.</p></li>&#13;
<li><p class="noindent">ISO files for Windows Server 2016, located on your Hyper-V host. Windows Server 2019 was not tested. You can download evaluation versions of Windows Server from <a href="https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2016?filetype=ISO"><em>https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2016?filetype=ISO</em></a>.</p></li>&#13;
<li><p class="noindent">Remote Server Administration Tools (RSAT) enabled on the client computer (download from <a href="https://www.microsoft.com/en-us/download/details.aspx?id=45520"><em>https://www.microsoft.com/en-us/download/details.aspx?id=45520</em></a>).</p></li>&#13;
<li><p class="noindent">The latest version of the Pester PowerShell module installed on your client computer.</p></li>&#13;
</ul>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_215"/>You also need to be logged in as a member of the local administrators group on the client computer, and have the PowerShell execution policy set to unrestricted. (You can run <span class="codestrong">Set-ExecutionPolicy Unrestricted</span> to change the execution policy, but I recommend changing this back to <code>AllSigned</code> or <code>RemoteSigned</code> when the lab setup is complete.)</p>&#13;
<h3 class="h3">Setting Up PowerLab</h3>&#13;
<p class="noindent">When providing something like PowerLab to consumers, you want to make setup as painless as possible. One way to do this is by providing a script that handles the installation and configuration of your module with minimal user input.</p>&#13;
<p class="indent">I’ve already written the installation script for PowerLab. It can be found in the PowerLab GitHub repository: <a href="https://raw.githubusercontent.com/adbertram/PowerLab/master/Install-PowerLab.ps1"><em>https://raw.githubusercontent.com/adbertram/PowerLab/master/Install-PowerLab.ps1</em></a>. That link will provide the raw source code for the script. You could copy and paste it into a new text file and save it as <em>Install-PowerLab.ps1</em>, but this is a PowerShell book, so let’s try running the following command:</p>&#13;
<pre>PS&gt; <span class="codestrong1">Invoke-WebRequest -Uri 'http://bit.ly/powerlabinstaller' -OutFile 'C:\Install-PowerLab.ps1'</span></pre>&#13;
<p class="indent">Be warned: when you run the script, you’ll have to answer some questions. You’ll need the hostname of the Hyper-V host, the IP address of the Hyper-V host, the local administrator username and password for the Hyper-V host, and the product keys (if not using a Windows Server evaluation copy) for each operating system you want to install.</p>&#13;
<p class="indent">Once you have all the information on hand, run the install script with the following command:</p>&#13;
<pre>PS&gt; <span class="codestrong1">C:\Install-PowerLab.ps1</span>&#13;
&#13;
Name of your HYPERV host: <span class="codestrong1">HYPERVSRV</span>&#13;
IP address of your HYPERV host: <span class="codestrong1">192.168.0.200</span>&#13;
Enabling PS remoting on local computer...&#13;
Adding server to trusted computers...&#13;
PS remoting is already enabled on [HYPERVSRV]&#13;
Setting firewall rules on Hyper-V host...&#13;
Adding the ANONYMOUS LOGON user to the local machine and host server&#13;
Distributed COM Users group for Hyper-V manager&#13;
Enabling applicable firewall rules on local machine...&#13;
Adding saved credential on local computer for Hyper-V host...&#13;
Ensure all values in the PowerLab configuration file are valid and close the&#13;
ISE when complete.&#13;
Enabling the Microsoft-Hyper-V-Tools-All features...&#13;
Lab setup is now complete.</pre>&#13;
<p class="indent">If you’d like to inspect what this script does, you can always download it via the book’s resources and check it out. However, know that it’s meant <span epub:type="pagebreak" id="page_216"/>to get us both to the same infrastructure, not necessarily show you what the script is doing; it may be over your head at this time. This script is meant to enable you to follow along with me.</p>&#13;
<h3 class="h3">Demo Code</h3>&#13;
<p class="noindent">All the code you will write in the following chapters can be found at <em><a href="https://github.com/adbertram/PowerShellForSysadmins/tree/master/Part%20III">https://github.com/adbertram/PowerShellForSysadmins/tree/master/Part%20III</a></em>. In addition to all the PowerLab code, you’ll find necessary data files and the Pester scripts to test the module and verify that your environment meets all the expected prerequisites. Before starting each chapter, I <em>strongly</em> suggest that you use the <code>Invoke-Pester</code> command to run the <em>Prerequisites.Tests.ps1</em> Pester script found in each chapter’s files. Doing so will save you from many headache-inducing bugs down the line.</p>&#13;
<h3 class="h3">Summary</h3>&#13;
<p class="noindent">You should have everything you need to start building PowerLab. We’ll cover a lot of ground in the following chapters, and draw on many areas of PowerShell, so don’t be surprised if you see something you don’t recognize. Plenty of online resources can help you through thorny syntax, and if you don’t understand something, you can always reach out to me on Twitter at @adbertram or reach out to others on the internet.</p>&#13;
<p class="indent">With that, let’s get started!</p>&#13;
</body></html>