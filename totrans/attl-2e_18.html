<html><head></head><body>
<h2 class="h2" id="ch18"><span epub:type="pagebreak" id="page_499"/><span class="big">18</span><br/>A CATALOG OF TIPS AND REUSABLE SOLUTIONS FOR CREATING GREAT PROJECTS</h2>&#13;
<p class="quote"><em>Experience is a hard teacher because she gives the test first, the lesson afterwards.<br/>—Vernon Sanders Law<sup><a id="ch18fn_1" href="footnote.xhtml#ch18fn1">1</a></sup></em></p>&#13;
<p class="image1"><img src="../images/common.jpg" alt="Image"/></p>&#13;
<p class="noindent">This chapter began as a catalog of reusable solutions—canned macros, if you will. But as I finished the chapters preceding this one, it became clear to me that I needed to broaden my definition of a <em>canned solution</em>. Instead of just cataloging interesting macros, this chapter lists several unrelated but important tips for creating great projects. Some of these are related to the GNU Autotools, but others are merely good programming practice with respect to open source and free software projects.</p>&#13;
<h3 class="h3" id="ch18sec1">Item 1: Keeping Private Details out of Public Interfaces</h3>&#13;
<p class="noindent">At times, I’ve come across poorly designed library interfaces where a project’s <em>config.h</em> file is required by the project’s public header files. This presents a problem when more than one such library is required by a consumer. Which <span epub:type="pagebreak" id="page_500"/><em>config.h</em> file should be included? Both have the same name, and chances are that both provide similar or identically named definitions.</p>&#13;
<p class="indent">When you carefully consider the purpose of <em>config.h</em>, you see that it makes little sense to expose it in a library’s public interface (by including it in any of the library’s public header files), because its purpose is to provide platform-specific definitions to a particular build of the library. On the other hand, the public interface of a portable library is, by definition, platform independent.</p>&#13;
<p class="indent">Interface design is a fairly general topic in computer science. This item focuses a bit more specifically on how to avoid including <em>config.h</em> in your public interfaces and, by extension, ensuring that you never install <em>config.h</em>.</p>&#13;
<p class="indent">When designing a library for consumption by other projects, you’re responsible for not polluting your consumers’ symbol spaces with useless garbage from your header files. I once worked on a project that consumed a library interface from another team. This team provided both a Windows and a Unix version of their library, with the header file being portable between the two platforms. Unfortunately, they didn’t understand the definition of a clean interface. At some point in their public header files, they had a bit of code that looked like <a href="ch18.xhtml#ch18ex1">Listing 18-1</a>.</p>&#13;
<pre>#ifdef _WIN32&#13;
# include &lt;windows.h&gt;&#13;
#else&#13;
typedef void * HANDLE;&#13;
#endif</pre>&#13;
<p class="caption" id="ch18ex1"><em>Listing 18-1: A poorly designed public header file that exposes platform-specific header files</em></p>&#13;
<p class="indent">Ouch! Did they really need to include <em>windows.h</em> just for the definition of <code>HANDLE</code>? No, and they probably should have used a different name for the handle object in their public interface because <code>HANDLE</code> is too generic and could easily conflict with a dozen other library interfaces. Something like <code>XYZ_HANDLE</code> or something more specific to the <em>XYZ</em> library would have been a better choice.</p>&#13;
<p class="indent">To properly design a library, first design the public interface to expose as little of the library’s internals as is reasonable. Now, you’ll have to determine the definition of <em>reasonable</em>, but it will probably involve a compromise between abstraction and performance.</p>&#13;
<p class="indent">When designing an API, start with the functionality you want to expose from your library; design functions that will maximize ease of use. If you find yourself trying to decide between a simpler implementation and a simpler user experience, always err on the side of ease of use for your consumers. They’ll thank you by actually using your library. Of course, if the interface is already defined by a software standard, then much of your work is done for you. Often this is not the case, and you will have to make these decisions.</p>&#13;
<p class="indent">Next, try to abstract away internal details. Unfortunately, the C language doesn’t make this easy to do because you often need to pass structure references in public APIs containing internal details of your implementation that consumers don’t need to see. (C++ is actually worse in this <span epub:type="pagebreak" id="page_501"/>area: C++ classes define public interfaces and private implementation details in the same class definition.)</p>&#13;
<h4 class="h4" id="ch18sec1-1"><em>Solutions in C</em></h4>&#13;
<p class="noindent">In C, a common solution for this problem is to define a public alias for a private structure in terms of a generic (<code>void</code>) pointer. Many developers don’t care for this approach because it reduces type safety in the interface, but the loss of type safety is significantly offset by the increase in interface abstraction, as shown in <a href="ch18.xhtml#ch18ex2">Listings 18-2</a> and <a href="ch18.xhtml#ch18ex3">18-3</a>.</p>&#13;
<pre>#include &lt;abc_pub.h&gt;&#13;
&#13;
# include &lt;config.h&gt;&#13;
&#13;
typedef struct&#13;
{&#13;
    /* private details */&#13;
} abc_impl;&#13;
&#13;
int abc_func(abc * p)&#13;
{&#13;
    abc_impl * ip = (abc_impl *)p;&#13;
    /* use 'p' through 'ip' */&#13;
}</pre>&#13;
<p class="caption" id="ch18ex2"><em>Listing 18-2: An example of a private C-language source file</em></p>&#13;
<pre>typedef void abc;&#13;
int abc_func(abc * p);</pre>&#13;
<p class="caption" id="ch18ex3"><em>Listing 18-3:</em> abc_pub.h: <em>A public header file describing a public interface (API)</em></p>&#13;
<p class="indent">Notice that the abstraction conveniently alleviates the need to include a bunch of really private definitions in the library’s public interface.<sup><a id="ch18fn_2" href="footnote.xhtml#ch18fn2">2</a></sup></p>&#13;
<p class="indent">But there’s a way that makes even better use of language syntax. In C, there’s a little-known, and even less used, concept called a <em>forward declaration</em> that allows you to name the type in a public header file without actually defining it there. <a href="ch18.xhtml#ch18ex4">Listing 18-4</a> provides an example of a library’s public header file that uses a forward declaration for the type used in the function declaration.</p>&#13;
<pre>struct abc;&#13;
<span class="codeitalic1">--snip--</span>&#13;
int abc_func(struct abc * p);</pre>&#13;
<p class="caption" id="ch18ex4"><em>Listing 18-4: Using a forward declaration in a public header file</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_502"/>Of course, this use of <code>struct abc</code> assumes that some other function in your public interface returns pointers to objects of that type that you can then pass into <code>abc_func</code>. If your user is responsible for filling out the structure before passing its address, then this mechanism will obviously not work for you. Rather, its use here is for the sole purpose of hiding the internals of <code>struct abc</code>.</p>&#13;
<h4 class="h4" id="ch18sec1-2"><em>Solutions in C++</em></h4>&#13;
<p class="noindent">Forward declarations can also be used in C++, but not in the same manner. In C++, forward declarations are used more to minimize compile-time header file interdependencies than to hide implementation details in public interfaces. We can use other techniques, however, to hide implementation details from users.</p>&#13;
<p class="indent">In C++, hiding implementation details with interface abstraction can be done in a few different ways, which include using virtual interfaces and the <em>PIMPL (Private IMPLementation)</em> pattern.</p>&#13;
<h5 class="h5">The PIMPL Pattern</h5>&#13;
<p class="noindent">In the PIMPL pattern, implementation details are hidden behind a pointer to a private implementation class stored as private data within the public interface class, as shown in <a href="ch18.xhtml#ch18ex5">Listings 18-5</a> and <a href="ch18.xhtml#ch18ex6">18-6</a>.</p>&#13;
<pre>#include &lt;abc_pub.h&gt;&#13;
&#13;
# include &lt;config.h&gt;&#13;
&#13;
class abc_impl&#13;
{&#13;
    /* private details */&#13;
};&#13;
&#13;
int abc::func(void)&#13;
{&#13;
    /* use 'pimpl' pointer */&#13;
}</pre>&#13;
<p class="caption" id="ch18ex5"><em>Listing 18-5: A private C++-language source file showing the proper use of the PIMPL pattern</em></p>&#13;
<pre><span class="ent">➊</span> class abc_impl;&#13;
&#13;
   class abc {&#13;
   <span class="ent">➋</span> abc_impl * pimpl;&#13;
   public:&#13;
     int func(void);&#13;
};</pre>&#13;
<p class="caption" id="ch18ex6"><em>Listing 18-6:</em> abc_pub.h: <em>The public header file exposes few private details via the PIMPL pattern.</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_503"/>As mentioned previously, the C++ language also allows the use of a forward declaration (like the one at <span class="ent">➊</span>) for any types used only through references or pointers (as at <span class="ent">➋</span>) but never actually dereferenced in the public interface. Thus, the definition of the implementation class need not be exposed in the public interface because the compiler will happily compile the public interface header file without the definition of the private implementation class.</p>&#13;
<p class="indent">The performance tradeoff here generally involves the dynamic allocation of an instance of the private implementation class and then the access of class data indirectly through this pointer, rather than directly in the public structure. Notice that all internal details are now conveniently hidden and thus not required by the public interface.</p>&#13;
<h5 class="h5">C++ Virtual Interfaces</h5>&#13;
<p class="noindent">Another approach when using C++ is to define a public <em>interface</em> class, whose methods are declared <em>pure virtual</em>, with the interface implemented internally by the library. To access an object of this class, consumers call a public <em>factory</em> function, which returns a pointer to the implementation class in terms of the interface definition. <a href="ch18.xhtml#ch18ex7">Listings 18-7</a> and <a href="ch18.xhtml#ch18ex8">18-8</a> illustrate the concept of C++ virtual interfaces.</p>&#13;
<pre>#include &lt;abc_pub.h&gt;&#13;
&#13;
# include &lt;config.h&gt;&#13;
&#13;
class abc_impl : public abc {&#13;
    virtual int func(void) {&#13;
        int rv;&#13;
        // implementation goes here&#13;
        return rv;&#13;
   }&#13;
};</pre>&#13;
<p class="caption" id="ch18ex7"><em>Listing 18-7: A private C++ language source file implementing a pure virtual interface</em></p>&#13;
<pre>   #define xyz_interface class&#13;
&#13;
   xyz_interface abc {&#13;
   public:&#13;
     virtual int func(void) = 0;&#13;
   };&#13;
&#13;
<span class="ent">➊</span> abc * abc_instantiate( /* abc_impl ctor params */ );</pre>&#13;
<p class="caption" id="ch18ex8"><em>Listing 18-8:</em> abc_pub.h: <em>A public C++ language header file, providing only the interface definition</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_504"/>Here, I use the C++ preprocessor to define a new keyword, <code>xyz_interface</code>. By definition, <code>xyz_interface</code> is synonymous with <code>class</code>, so the terms may be used interchangeably. The idea here is that an interface doesn’t expose any implementation details to the consumer. The public <em>factory</em> function <code>abc_instantiate</code> at <span class="ent">➊</span> returns a pointer to a new object of type <code>abc_impl</code>, except in terms of <code>abc</code>. Thus, nothing internal needs to be shown to the caller in the public header file.</p>&#13;
<p class="indent">It may seem like the virtual interface class method is more efficient than the PIMPL method, but the fact is that most compilers implement virtual function calls as tables of function pointers referred to by a hidden <em>vptr</em> address within the implementation class. As a result, you still end up calling all of your public methods indirectly through a pointer. The technique you choose to help hide your implementation details is more a matter of personal preference than performance.<sup><a id="ch18fn_3" href="footnote.xhtml#ch18fn3">3</a></sup></p>&#13;
<p class="indent">When I design a library, I first design a minimal, but complete, functional interface with as much of my internal implementation abstracted away as is reasonable. I try to use only standard library basic types, if possible, in my function prototypes and then include only the C or C++ standard header files required by the use of those types and definitions. This technique is the fastest way I’ve found to create a highly portable and maintainable interface.</p>&#13;
<p class="indent">If you still can’t see the value in the advice offered by this item, then let me give you one more scenario to ponder. Consider what happens when a Linux distro packager decides to create a <em>devel</em> package for your library—that is, a package containing static libraries and header files, designed to be installed into the <em>/usr/lib</em> and <em>/usr/include</em> directories on a target system. Every header file required by your library must be installed into the <em>/usr/include</em> directory. If your library’s public interface requires the inclusion of your <em>config.h</em> file, then by extension your <em>config.h</em> file must be installed into the <em>/usr/include</em> directory. Now consider what happens when multiple such libraries need to be installed. Which copy of <em>config.h</em> will win? Only one <em>config.h</em> file can exist in <em>/usr/include</em>.</p>&#13;
<p class="indent">I’ve seen message threads on the Autotools mailing lists defending the need to publish <em>config.h</em> in a public interface and providing techniques for naming <em>config.h</em> in a package-specific manner. These techniques often involve some form of post-processing of this file to rename its macros so they don’t conflict with <em>config.h</em> definitions installed by other packages. While this can be done, and while there are a few good reasons for doing so (usually involving a widely used legacy code base that can’t be modified without breaking a lot of existing code), these situations should be considered the exception, not <span epub:type="pagebreak" id="page_505"/>the rule, because a well-designed project should not need to expose platform- and project-specific definitions in its public interface.</p>&#13;
<p class="indent">If your project simply can’t live without <em>config.h</em> in its public interface, explore the nuances of the <code>AC_CONFIG_HEADERS</code> macro. Like all of the instantiating macros, this macro accepts a list of input files. The <code>autoheader</code> utility only writes the first input file in the list, so you can hand-create a second input file that contains definitions that you feel must be included in your public interface. Remember to name your public input file so as to reduce conflict with other packages’ public interfaces.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Also, explore the <em><code>AX_PREFIX_CONFIG_H</code></em> macro, found in the Autoconf Macro Archive (see “Item 8: Using the Autoconf Archive Project” on <a href="ch18.xhtml#page_528">page 528</a>, which will add a custom prefix to all items found in</em> config.h.</p>&#13;
</div>&#13;
<h3 class="h3" id="ch18sec2">Item 2: Implementing Recursive Extension Targets</h3>&#13;
<p class="noindent">An <em>extension target</em> is a <code>make</code> target that you write to accomplish some build goal that Automake doesn’t automatically support. A <em>recursive extension target</em> is one that traverses your project directory structure, visiting every <em>Makefile.am</em> file in your Autotools build system and giving each one the opportunity to do some work when the extension target is made.</p>&#13;
<p class="indent">When you add a new top-level target to your build system, you have to either tie it into an existing Automake target or add your own <code>make</code> code to the desired target that traverses the subdirectory structure provided by Automake in your build system.</p>&#13;
<p class="indent">The <code>SUBDIRS</code> variable is used to recursively traverse all subdirectories of the current directory, passing requested build commands into the makefiles in these directories. This works great for targets that must be built based on configuration options, because after configuration, the <code>SUBDIRS</code> variable contains only those directories destined to be built.</p>&#13;
<p class="indent">However, if you need to execute your new recursive target in <em>all</em> subdirectories, regardless of any conditional configuration that might exclude a subdirectory specified in <code>SUBDIRS</code>, use the <code>DIST_SUBDIRS</code> variable instead.</p>&#13;
<p class="indent">There are various ways to traverse the build hierarchy, including some really simple one-liners provided by GNU <code>make</code>-specific syntax. But the most portable way is to use the technique that Automake itself uses, as shown in <a href="ch18.xhtml#ch18ex9">Listing 18-9</a>.</p>&#13;
<pre>my-recursive-target:&#13;
      <span class="ent">➊</span> $(preorder_commands)&#13;
        for dir in $(SUBDIRS); do \&#13;
          ($(am__cd) $$dir &amp;&amp; $(MAKE) $(AM_MAKEFLAGS) $@) || exit 1; \&#13;
        done&#13;
      <span class="ent">➋</span> $(postorder_commands)&#13;
&#13;
.PHONY: my-recursive-target</pre>&#13;
<p class="caption" id="ch18ex9"><em>Listing 18-9: A makefile with a recursive target (WARNING: no support for "<code>.</code>" in <code>SUBDIRS</code>)</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_506"/>At some point in the hierarchy, you’ll need to do something useful besides calling down to lower levels. The <code>preorder_commands</code> macro at <span class="ent">➊</span> can be used to do things that must be done before recursing into lower-level directories. The <code>postorder_commands</code> macro at <span class="ent">➋</span> can likewise be used to do additional things once you return from the lower-level directories. Simply define either or both of these macros in any makefiles that need to do some pre-order or post-order processing for <code>my-recursive-target</code>.</p>&#13;
<p class="indent">For example, if you want to build some generated documentation, you might have a special target called <code>doxygen</code>. Even if you happen to be okay with building your documentation in the top-level directory, there may be times when you need to distribute the generation of your documentation to various directories within your project hierarchy. You might use code similar to that shown in <a href="ch18.xhtml#ch18ex10">Listing 18-10</a> in each <em>Makefile.am</em> file in your project.</p>&#13;
<pre>   # uncomment if doxyfile exists in this directory&#13;
<span class="ent">➊</span> # postorder_commands = $(DOXYGEN) $(DOXYFLAGS) doxyfile&#13;
&#13;
   doxygen:&#13;
           $(preorder_commands)&#13;
        <span class="ent">➋</span> for dir in $(SUBDIRS); do \&#13;
         <span class="ent">➌</span> ($(am__cd) $$dir &amp;&amp; $(MAKE) $(AM_MAKEFLAGS) $@) || exit 1; \&#13;
          done&#13;
          $(postorder_commands)&#13;
&#13;
.PHONY: doxygen</pre>&#13;
<p class="caption" id="ch18ex10"><em>Listing 18-10: Implementing <em><code>postorder_commands</code></em> for a <code>doxygen</code> directory</em></p>&#13;
<p class="indent">For directories where <em>doxyfile</em> doesn’t exist, you can comment out (or better yet, simply omit) the <code>postorder_commands</code> macro definition at <span class="ent">➊</span>. In this case, the <code>doxygen</code> target will be harmlessly propagated to the next lower level in the build tree by the three lines of shell code at <span class="ent">➋</span>.</p>&#13;
<p class="indent">The <code>exit</code> statement at the end of <span class="ent">➌</span> ensures that the build terminates when a lower-level makefile fails on the recursive target, propagating the shell error code (1) back up to each parent makefile until the top-level shell is reached. This is important; without it, the build may continue after a failure until a different error is encountered.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>I chose not to use the somewhat less portable <em><code>-C make</code></em> command line option to change directories before running the sub-<em><code>make</code></em> operation. I also use an Automake macro called <em><code>am__cd</code></em> to change directories. This macro is defined to take the contents of the <em><code>CDPATH</code></em> environment variable into account to reduce extraneous output noise during a built. You can replace it with <em><code>cd</code></em> (or <em><code>chdir</code></em>). Examine an Automake-generated makefile to see how Automake defines this macro.</em></p>&#13;
</div>&#13;
<p class="indent">If you choose to implement a completely recursive global target in this manner, you must include <a href="ch18.xhtml#ch18ex10">Listing 18-10</a> in every <em>Makefile.am</em> file in your project, even if that makefile has nothing to do with the generation <span epub:type="pagebreak" id="page_507"/>of documentation. If you don’t, <code>make</code> will fail on that makefile because no <code>doxygen</code> target exists within it. The commands may do nothing, but the target must exist.</p>&#13;
<p class="indent">If you want to do something simpler, such as pass a target down to a single subdirectory beneath the top-level directory (such as a <em>doc</em> directory just below the top), life becomes easier. Just implement the code shown in <a href="ch18.xhtml#ch18ex11">Listings 18-11</a> and <a href="ch18.xhtml#ch18ex12">18-12</a>.</p>&#13;
<pre>doxygen:&#13;
     <span class="ent">➊</span> $(am__cd) doc &amp;&amp; $(MAKE) $(AM_MAKEFLAGS) $@&#13;
&#13;
.PHONY: doxygen</pre>&#13;
<p class="caption" id="ch18ex11"><em>Listing 18-11: A top-level makefile that propagates a target to a single subdirectory</em></p>&#13;
<pre>doxygen:&#13;
        $(DOXYGEN) $(DOXYFLAGS) doxyfile&#13;
&#13;
.PHONY: doxygen</pre>&#13;
<p class="caption" id="ch18ex12"><em>Listing 18-12:</em> doc/Makefile.am: <em>The code to handle the new target</em></p>&#13;
<p class="indent">The shell statement at <span class="ent">➊</span> in the top-level makefile in <a href="ch18.xhtml#ch18ex11">Listing 18-11</a> simply passes the target (<code>doxygen</code>) down to the desired directory (<code>doc</code>).</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>The variables <em><code>DOXYGEN</code></em> and <em><code>DOXYFLAGS</code></em> are assumed to exist by virtue of some macro or  shell code executed within the <em><code>configure</code></em> script.</em></p>&#13;
</div>&#13;
<p class="indent">Automake recursive targets are more sophisticated in that they also support <code>make</code>’s <code>-k</code> command line option to continue building after errors. Additionally, Automake’s recursive target implementation supports the use of the dot (<code>.</code>) in the <code>SUBDIRS</code> variable, which represents the current directory. You may also support these features, but if you do, your boilerplate recursive <code>make</code> shell code will be messier. For the sake of completeness, <a href="ch18.xhtml#ch18ex13">Listing 18-13</a> shows an implementation that supports these features. Compare this listing to <a href="ch18.xhtml#ch18ex9">Listing 18-9</a>. The highlighted shell code shows the differences between these listings.</p>&#13;
<pre><span class="ash">my-recursive-target:</span>&#13;
        <span class="ash">$(preorder_commands)</span>&#13;
        @failcom='exit 1'; \&#13;
        for f in x $$MAKEFLAGS; do \&#13;
          case $$f in \&#13;
            *=* | --[!k]*);; \&#13;
         <span class="ent">➊</span> *k*) failcom='fail=yes';; \&#13;
          esac; \&#13;
        done; \&#13;
        <span class="ash">for dir in $(SUBDIRS); do \</span>&#13;
<span epub:type="pagebreak" id="page_508"/>        <span class="ent">➋</span> if test "$$dir" != .; then \&#13;
             <span class="ash">($(am__cd) $$dir &amp;&amp; $(MAKE) $(AM_MAKEFLAGS) $@) ||</span> eval \&#13;
                $$failcom; <span class="ash">\</span>&#13;
           fi; \&#13;
         <span class="ash">done</span>&#13;
         <span class="ash">$(postorder_commands)</span>&#13;
&#13;
<span class="ash">.PHONY: my-recursive-target</span></pre>&#13;
<p class="caption" id="ch18ex13"><em>Listing 18-13: Adding <code>make -k</code> and a check for the current directory</em></p>&#13;
<p class="indent">At <span class="ent">➊</span>, the <code>case</code> statement checks for a <code>-k</code> option in the <code>MAKEFLAGS</code> environment variable and, on finding it, sets the <code>failcom</code> shell variable to some innocuous shell code. If it’s not found, then <code>failcom</code> is left at its default value, <code>exit 1</code>, which is then inserted where an exit should occur on error. The <code>if</code> statement within the <code>for</code> loop at <span class="ent">➋</span> simply skips the recursive call for the dot entry in <code>SUBDIRS</code>. As with the previous examples, for the current directory, the functionality of the recursive target is found entirely within the <code>$(preorder_commands)</code> and <code>$(postorder_commands)</code> macro expansions.</p>&#13;
<p class="indent">I’ve tried to show you in this item that you can do as much or as little as you like with your own recursive targets. Most of the implementation is simply shell code in the command.</p>&#13;
<h3 class="h3" id="ch18sec3">Item 3: Using a Repository Revision Number in a Package Version</h3>&#13;
<p class="noindent">Version control is an important part of every project. Not only does it protect intellectual property, but it also allows the developer to back up and start again after a long series of mistakes. One advantage of version control systems like Git and Subversion is that the system assigns a unique revision number to every change to a project’s repository. This means that any distribution of the project’s source code can be logically tied to a particular repository revision number. This item presents a technique you can use to automatically insert a repository revision number into your package’s Autoconf version string.</p>&#13;
<p class="indent">Arguments to Autoconf’s <code>AC_INIT</code> macro must be static text. That is, they can’t be shell variables, and Autoconf will flag attempts to use shell variables in these arguments as errors. This is all well and good until you want to calculate any portion of your package’s version number during the configuration process.</p>&#13;
<p class="indent">I once tried to use a shell variable in <code>AC_INIT</code>’s <code>VERSION</code> argument so that I could substitute my Subversion revision number into the <code>VERSION</code> argument when <code>configure</code> was executed. I spent a couple of days trying to figure out how to trick Autoconf into letting me use a shell variable as a <em>revision</em> field in my package’s version number. Eventually, I discovered the trick shown in <a href="ch18.xhtml#ch18ex14">Listing 18-14</a>, which I implemented in my <em>configure.ac</em> file and in my top-level <em>Makefile.am</em> file.</p>&#13;
<pre><span epub:type="pagebreak" id="page_509"/><span class="ent">➊</span> SVNREV=`LC_ALL=C svnversion $srcdir 2&gt;/dev/null`&#13;
<span class="ent">➋</span> if ! svnversion || case $SVNREV in Unver*) true;; *) false;; esac;&#13;
  <span class="ent">➌</span> then SVNREV=`cat $srcdir/SVNREV`&#13;
  <span class="ent">➍</span> else echo $SVNREV&gt;$srcdir/SVNREV&#13;
    fi&#13;
<span class="ent">➎</span> AC_SUBST(SVNREV)</pre>&#13;
<p class="caption" id="ch18ex14"><em>Listing 18-14:</em> configure.ac: <em>Implementing a dynamic revision number as part of the package version</em></p>&#13;
<p class="indent">Here, the shell variable <code>SVNREV</code> is set at <span class="ent">➊</span> to the output of the <code>svnversion</code> command, as executed on the project top-level directory. The output is a raw Subversion revision number—that is, <em>if</em> the code is executed in a true Subversion work area, which isn’t always the case.</p>&#13;
<p class="indent">When a user executes this <code>configure</code> script from a distribution archive, Subversion may not even be installed on his workstation. Even if it is, the top-level project directory comes from the archive, not a Subversion repository. To handle these situations, the line at <span class="ent">➋</span> checks to see if <code>svnversion</code> can be executed or if the output from the first line starts with the first few letters of the phrase <em>Unversioned directory</em>, the result of executing the <code>svnversion</code> utility on a non-work-area directory.</p>&#13;
<p class="indent">If either of these cases is true, the <code>SVNREV</code> variable is populated at <span class="ent">➌</span> from the contents of a file called <em>SVNREV</em>. The project should be configured to ship the <em>SVNREV</em> file with a distribution archive containing the configuration code in <a href="ch18.xhtml#ch18ex14">Listing 18-14</a>. This must be done because if <code>svnversion</code> generates a true Subversion repository revision number, that value is immediately written to the <em>SVNREV</em> file by the <code>else</code> clause of this <code>if</code> statement at <span class="ent">➍</span>.</p>&#13;
<p class="indent">Finally, the call to <code>AC_SUBST</code> at <span class="ent">➎</span> substitutes the <code>SVNREV</code> variable into template files, including the project makefiles.</p>&#13;
<p class="indent">In the top-level <em>Makefile.am</em> file, I ensure that the <em>SVNREV</em> file becomes part of the distribution archive by adding it to the <code>EXTRA_DIST</code> list. Thus, when a distribution archive is created and published by the maintainer, it contains an <em>SVNREV</em> file with the source tree revision number used to generate the archive from this source code. The value in the <em>SVNREV</em> file is also used when an archive is generated from the source code in this tarball (via <code>make dist</code>). This is accurate because the original archive was actually generated from this particular revision of the Subversion repository.</p>&#13;
<p class="indent">Generally, it’s not particularly important that a project’s distribution archive be able to generate a proper distribution archive, but an Automake-generated archive can do so without this modification, so it should also be able to do so <em>with</em> it. <a href="ch18.xhtml#ch18ex15">Listing 18-15</a> highlights the relevant changes to the top-level <em>Makefile.am</em> file.</p>&#13;
<pre><span class="ash">EXTRA_DIST =</span> SVNREV&#13;
<span class="ash">distdir = $(PACKAGE)-$(VERSION)</span>.$(SVNREV)</pre>&#13;
<p class="caption" id="ch18ex15"><em>Listing 18-15:</em> Makefile.am: <em>A top-level makefile configured for SVN revision numbers</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_510"/>In <a href="ch18.xhtml#ch18ex15">Listing 18-15</a>, the <code>distdir</code> variable controls the name of the distribution directory and the archive filename generated by Automake. Setting this variable in the top-level <em>Makefile.am</em> file affects the generation of the distribution archive, because that <em>Makefile.am</em> file is where this functionality is located in the final generated <em>Makefile</em>.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Note the similarity of the</em> SVNREV <em>filename and the <em><code>SVNREV make</code></em> variable <em><code>[$(SVNREV)]</code></em> in <a href="ch18.xhtml#ch18ex15">Listing 18-15</a>. Although they appear to be the same, the text added to the <em><code>EXTRA_DIST</code></em> line refers to the</em> SVNREV <em>file in the top-level project directory, while the text added to the <em><code>distdir</code></em> variable refers to a <em><code>make</code></em> variable.</em></p>&#13;
</div>&#13;
<p class="indent">For most purposes, setting <code>distdir</code> in the top-level <em>Makefile.am</em> file should be sufficient. However, if you need <code>distdir</code> to be formatted correctly in another <em>Makefile.am</em> file in your project, just set it in that file as well.</p>&#13;
<p class="indent">The technique presented in this item does not automatically reconfigure the project to generate a new <em>SVNREV</em> file when you commit new changes (and so change the Subversion revision used in your build). I could have added this functionality with a few well-placed <code>make</code> rules, but that would have forced the build to check for commits with each new build.<sup><a id="ch18fn_4" href="footnote.xhtml#ch18fn4">4</a></sup></p>&#13;
<p class="indent"><a href="ch18.xhtml#ch18ex16">Listing 18-16</a> shows code similar to that in <a href="ch18.xhtml#ch18ex14">Listing 18-14</a>, except this code works for Git, rather than Subversion.</p>&#13;
<pre>GITREV=`git -C $srcdir rev-parse --short HEAD`&#13;
if [ -z "$GITREV" ];&#13;
  then GITREV=`cat $srcdir/GITREV`&#13;
  else echo $GITREV&gt;$srcdir/GITREV&#13;
fi&#13;
AC_SUBST(GITREV)</pre>&#13;
<p class="caption" id="ch18ex16"><em>Listing 18-16:</em> configure.ac: <em>Implementing a Git dynamic revision number</em></p>&#13;
<p class="indent">This version seems a little more intuitive to me because the <code>git</code> utility makes better use of the proper output channels for error conditions—the output of the command is sent to <code>stderr</code> if the current working directory is not a Git repository.</p>&#13;
<p class="indent">Of course, you should also modify the code from <a href="ch18.xhtml#ch18ex15">Listing 18-15</a> to reference the <em>GITREV</em> file instead of the <em>SVNREV</em> file.</p>&#13;
<p class="indent">Another great option, if you’re already using Gnulib, is to use the <em>version-gen</em> module in that library. This module provides many nice features related to incorporating a version number into your build.</p>&#13;
<h3 class="h3" id="ch18sec4">Item 4: Ensuring Your Distribution Packages Are Clean</h3>&#13;
<p class="noindent">Have you ever downloaded and unpacked an open source package and then tried to run <strong><code>./configure &amp;&amp; make</code></strong>, only to have it fail halfway through one of these steps? As you dug into the problem, perhaps you discovered missing <span epub:type="pagebreak" id="page_511"/>files in the archive. How sad to have this happen in an Autotools project, when the Autotools make it so easy to ensure that this simply doesn’t happen.</p>&#13;
<p class="indent">To ensure that your distribution archives are always clean and complete, run the <code>distcheck</code> target on a newly created archive. Don’t be satisfied with what you <em>believe</em> about your package. Allow Automake to run the distribution unit tests. I call these tests <em>unit tests</em> because they provide the same testing functionality for a distribution package that regular unit tests provide for your source code.</p>&#13;
<p class="indent">You’d never make a code change and ship a package without running your unit tests, would you? (If so, then you can safely skip this section.) Likewise, don’t ship your archives without running the build system unit tests—run <strong><code>make distcheck</code></strong> on your project <em>before</em> posting your new archives. If the <code>distcheck</code> target fails, find out why and fix it. The payoff is worth the effort.</p>&#13;
<h3 class="h3" id="ch18sec5">Item 5: Hacking Autoconf Macros</h3>&#13;
<p class="noindent">Occasionally you need a macro that Autoconf doesn’t quite provide. That’s when it pays to know how to copy and modify existing Autoconf macros.<sup><a id="ch18fn_5" href="footnote.xhtml#ch18fn5">5</a></sup></p>&#13;
<p class="indent">For example, here’s a solution to a common Autoconf mailing list issue. A user wants to use <code>AC_CHECK_LIB</code> to capture a desired library in the <code>LIBS</code> variable. The catch is that this library exports functions with C++, rather than C linkage. <code>AC_CHECK_LIB</code> is not very accommodating when it comes to C++, primarily because <code>AC_CHECK_LIB</code> makes certain assumptions about symbols exported with C linkage that just don’t apply to C++ symbols.</p>&#13;
<p class="indent">For example, the widely known (and standardized) rules of C linkage state that an exported C-linkage symbol (also known as the <code>cdecl</code> calling convention on Intel systems) is case sensitive and decorated with a leading underscore,<sup><a id="ch18fn_6" href="footnote.xhtml#ch18fn6">6</a></sup> whereas a symbol exported with C++ linkage is <em>mangled</em> using nonstandard, vendor-defined rules. The decorations are based on the signature of the function—specifically, the number and types of parameters as well as the classes and/or namespaces to which the function belongs. But the exact scheme is not defined by the C++ standard.</p>&#13;
<p class="indent">Now, stop and consider under what circumstances you’re likely to have symbols exported from a library using C++ linkage. There are two ways to export C++ symbols from a library. The first is to (either purposely or accidentally) export <em>global</em> functions without using the <code>extern "C"</code> linkage specification on your function prototypes. The second is to export entire classes—including public and protected methods and class data.</p>&#13;
<p class="indent">If you’ve accidentally forgotten to use <code>extern "C"</code> on your global functions, well, then, stop it. If you’re doing it on purpose, then I wonder why? The only reason I can think of is that you want to export more than one <span epub:type="pagebreak" id="page_512"/>overload of a given function name. This seems a rather trivial reason to keep your C developers from being able to use your library.</p>&#13;
<p class="indent">If you’re exporting classes, now that’s another story. In this case, you’re catering specifically to C++ users, which presents a real issue with <code>AC_CHECK_LIB</code>.</p>&#13;
<p class="indent">Autoconf provides a framework around the definition of <code>AC_CHECK_LIB</code> that allows for differences between C and C++. If you use the <code>AC_LANG([C++])</code> macro before you call <code>AC_CHECK_LIB</code>, you’ll generate a version of the test program that’s specific to C++. But don’t get your hopes up; the current implementation of the C++ version is simply a copy of the C version. I expect that a generic C++ implementation would be difficult at best to design.</p>&#13;
<p class="indent">But all is not lost. While a <em>generic</em> implementation would be difficult, as the project maintainer, you can easily write a project-specific version of the test code using <code>AC_CHECK_LIB</code>’s test code.</p>&#13;
<p class="indent">First we need to find the definition of the <code>AC_CHECK_LIB</code> macro. A <code>grep</code> of the Autoconf macro directory (usually <em>/usr/(local/)share/autoconf/autoconf</em>) should quickly locate the definition of <code>AC_CHECK_LIB</code> in the file called <em>libs.m4</em>. Because most macro definitions start with a comment header containing a hash mark and then the name of the macro and a single space, the following should work:</p>&#13;
<pre>$ <span class="codestrong1">cd /usr/share/autoconf/autoconf</span>&#13;
$ <span class="codestrong1">grep "^# AC_CHECK_LIB" *.m4</span>&#13;
libs.m4:# AC_CHECK_LIB(LIBRARY, FUNCTION,&#13;
$</pre>&#13;
<p class="indent">The definition of <code>AC_CHECK_LIB</code> is shown in <a href="ch18.xhtml#ch18ex17">Listing 18-17</a>.<sup><a id="ch18fn_7" href="footnote.xhtml#ch18fn7">7</a></sup></p>&#13;
<pre><span class="ash"># AC_CHECK_LIB(LIBRARY, FUNCTION,</span>&#13;
<span class="ash">#             [ACTION-IF-FOUND], [ACTION-IF-NOT-FOUND],</span>&#13;
<span class="ash">#             [OTHER-LIBRARIES])</span>&#13;
<span class="codeitalic1a">--snip--</span>&#13;
<span class="ash"># freedom.</span>&#13;
<span class="ash">AC_DEFUN([AC_CHECK_LIB],</span>&#13;
<span class="ash">[</span>m4_ifval([$3], , [AH_CHECK_LIB([$1])])dnl&#13;
AS_LITERAL_IF([$1], [AS_VAR_PUSHDEF([ac_Lib], [ac_cv_lib_$1_$2])],&#13;
    [AS_VAR_PUSHDEF([ac_Lib], [ac_cv_lib_$1''_$2])])dnl&#13;
AC_CACHE_CHECK([for $2 in -l$1], [ac_Lib],&#13;
    [ac_check_lib_save_LIBS=$LIBS&#13;
    LIBS="-l$1 $5 $LIBS"&#13;
  <span class="ent">➊</span> AC_LINK_IFELSE([AC_LANG_CALL([], [$2])],&#13;
         [AS_VAR_SET([ac_Lib], [yes])],&#13;
         [AS_VAR_SET([ac_Lib], [no])])&#13;
     LIBS=$ac_check_lib_save_LIBS])&#13;
     AS_VAR_IF([ac_Lib], [yes],&#13;
         [m4_default([$3], [AC_DEFINE_UNQUOTED(AS_TR_CPP(HAVE_LIB$1))&#13;
         LIBS="-l$1 $LIBS"&#13;
     ])],&#13;
<span epub:type="pagebreak" id="page_513"/>      [$4])dnl&#13;
AS_VAR_POPDEF([ac_Lib])<span class="ash">dnl</span>&#13;
<span class="ash">])# AC_CHECK_LIB</span></pre>&#13;
<p class="caption" id="ch18ex17"><em>Listing 18-17: The definition of <code>AC_CHECK_LIB</code>, as found in</em> libs.m4</p>&#13;
<p class="indent">This apparent quagmire is easily sorted out with a little analysis. The macro appears to accept up to five arguments (as shown in the comment header), the first two of which are required. The highlighted portion is the macro definition—the part we’ll copy into our <em>configure.ac</em> file and modify to work with our C++ exports.</p>&#13;
<p class="indent">Recall from <a href="ch16.xhtml">Chapter 16</a> that the placeholders for M4 macro definition parameters are similar to those of shell scripts: a dollar sign followed by a number. The first parameter is represented by <code>$1</code>, the second by <code>$2</code>, and so on. We need to determine which parameters are important to us and which ones to discard. We know that most calls to <code>AC_CHECK_LIB</code> pass only the first two arguments. The third and fourth parameters are optional and exist only so that you can change the macro’s default behavior, depending on whether it locates the desired function in the specified library. The fifth parameter allows you to provide a list of additional linker command line arguments (usually additional library and library directory references) that are required to properly link the desired library so the test program will not fail for extraneous reasons.</p>&#13;
<p class="indent">Say we have a C++ library that exports a class’s public data and methods. Our library is named <em>fancy</em>, our class is <code>Fancy</code>, and the method we’re interested in is called <code>execute</code>—specifically the <code>execute</code> method that accepts two integer arguments. Thus, its signature would be</p>&#13;
<pre>Fancy::execute(int, int)</pre>&#13;
<p class="indent">When exported with C linkage, such a function would be presented to the linker merely as <code>_execute</code> (or simply as <code>execute</code>, without the leading underscore, on some platforms), but when it’s exported with C++ linkage, all bets are off because of vendor-specific name mangling.</p>&#13;
<p class="indent">The only way to get the linker to find this symbol is to declare it in compiled source code with exactly this signature, but we don’t supply enough information to <code>AC_CHECK_LIB</code> to properly declare the function signature in the test code. Here’s the declaration required to tell the compiler how to properly mangle this method’s name:</p>&#13;
<pre>class Fancy { public: void execute(int,int); };</pre>&#13;
<p class="indent">Assuming that we’re looking for a function with C linkage called <code>execute</code>, the <code>AC_CHECK_LIB</code> macro generates a small test program like the one shown in <a href="ch18.xhtml#ch18ex18">Listing 18-18</a>. I’ve highlighted our function name so you can easily see where the macro inserts it into the generated test code.</p>&#13;
<pre><span class="ash">/* confdefs.h. */</span>&#13;
<span class="ash">#define PACKAGE_NAME ""</span>&#13;
<span epub:type="pagebreak" id="page_514"/><span class="ash">#define PACKAGE_TARNAME ""</span>&#13;
<span class="ash">#define PACKAGE_VERSION ""</span>&#13;
<span class="ash">#define PACKAGE_STRING ""</span>&#13;
<span class="ash">#define PACKAGE_BUGREPORT ""</span>&#13;
<span class="ash">/* end confdefs.h. */</span>&#13;
&#13;
<span class="ash">/* Override any GCC internal prototype to avoid an error.</span>&#13;
   <span class="ash">Use char because int might match the return type of a GCC</span>&#13;
   <span class="ash">builtin and then its argument prototype would still apply. */</span>&#13;
<span class="ash">#ifdef __cplusplus</span>&#13;
<span class="ash">extern "C"</span>&#13;
<span class="ash">#endif</span>&#13;
&#13;
<span class="ash">char</span> execute <span class="ash">();</span>&#13;
<span class="ash">int</span>&#13;
<span class="ash">main ()</span>&#13;
<span class="ash">{</span>&#13;
<span class="ash">return</span> execute <span class="ash">();</span>&#13;
    <span class="ash">;</span>&#13;
    <span class="ash">return 0;</span>&#13;
<span class="ash">}</span></pre>&#13;
<p class="caption" id="ch18ex18"><em>Listing 18-18: An Autoconf-generated check for the global C-language <code>execute</code> function</em></p>&#13;
<p class="indent">Except for these two uses of the specified function name, the entire test program is identical for every call to <code>AC_CHECK_LIB</code>. This macro creates a common prototype for all functions so that all functions are treated the same way. Clearly, however, not all functions accept no parameters and return a character, as defined in this code. <code>AC_CHECK_LIB</code> effectively lies to the compiler about the true nature of the function. The test only cares whether the test program can successfully be linked; it will never attempt to execute it (an operation that would fail spectacularly in most cases).</p>&#13;
<p class="indent">For C++ symbols, we need to generate a different test program—one that makes no assumptions about the signature of our exported symbol.</p>&#13;
<p class="indent">Looking back at <span class="ent">➊</span> in <a href="ch18.xhtml#ch18ex17">Listing 18-17</a>, it appears as if the <code>AC_LANG_CALL</code> macro has something to do with the generation of the test code in <a href="ch18.xhtml#ch18ex18">Listing 18-18</a> because the output of <code>AC_LANG_CALL</code> is generated directly into the first argument of a call to <code>AC_LINK_IFELSE</code>; its first argument is source code to be tested with the linker. As it turns out, this macro, too, is a higher-level wrapper around another macro, <code>AC_LANG_PROGRAM</code>. <a href="ch18.xhtml#ch18ex19">Listing 18-19</a> shows the definitions of both macros.<sup><a id="ch18fn_8" href="footnote.xhtml#ch18fn8">8</a></sup></p>&#13;
<pre>   # AC_LANG_CALL(C)(PROLOGUE, FUNCTION)&#13;
   # -----------------------------------&#13;
   # Avoid conflicting decl of main.&#13;
   m4_define([AC_LANG_CALL(C)],&#13;
<span class="ent">➊</span> [AC_LANG_PROGRAM([$1&#13;
<span epub:type="pagebreak" id="page_515"/>   m4_if([$2], [main], ,&#13;
   [/* Override any GCC internal prototype to avoid an error.&#13;
       Use char because int might match the return type of a GCC&#13;
       builtin and then its argument prototype would still apply. */&#13;
   #ifdef __cplusplus&#13;
   extern "C"&#13;
   #endif&#13;
<span class="ent">➋</span> char $2 ();])], [return $2 ();])])&#13;
&#13;
   # AC_LANG_PROGRAM(C)([PROLOGUE], [BODY])&#13;
   # --------------------------------------&#13;
   m4_define([AC_LANG_PROGRAM(C)],&#13;
<span class="ent">➌</span> [$1&#13;
   m4_ifdef([_AC_LANG_PROGRAM_C_F77_HOOKS], [_AC_LANG_PROGRAM_C_F77_HOOKS])[]dnl&#13;
   m4_ifdef([_AC_LANG_PROGRAM_C_FC_HOOKS], [_AC_LANG_PROGRAM_C_FC_HOOKS])[]dnl&#13;
   int&#13;
   main ()&#13;
   {&#13;
   dnl Do *not* indent the following line: there may be CPP directives.&#13;
   dnl Don't move the `;' right after for the same reason.&#13;
<span class="ent">➍</span> $2&#13;
     ;&#13;
     return 0;&#13;
   }])</pre>&#13;
<p class="caption" id="ch18ex19"><em>Listing 18-19: The definitions of <code>AC_LANG_CALL</code> and <code>AC_LANG_PROGRAM</code></em></p>&#13;
<p class="indent">At <span class="ent">➊</span>, <code>AC_LANG_CALL(C)</code> generates a call to <code>AC_LANG_PROGRAM</code>, passing the <code>PROLOGUE</code> argument in the first parameter. At <span class="ent">➌</span>, this prologue (in the form of <code>$1</code>) is immediately sent to the output stream. If the second argument passed to <code>AC_LANG_CALL(C)</code> (<code>FUNCTION</code>) is not <code>main</code>, a C-style function prototype is generated for the function. At <span class="ent">➋</span>, the text <code>return $2 ();</code> is passed as the <code>BODY</code> argument to <code>AC_LANG_PROGRAM</code>, which uses this text at <span class="ent">➍</span> to generate a call to the function. (Remember that this code will only be linked, never executed.)</p>&#13;
<p class="indent">For C++, we need to be able to define more of the test program so that it makes no assumptions about the prototype of our exported symbol, and <code>AC_LANG_CALL</code> is too specific to C, so we’ll use the lower-level macro, <code>AC_LANG_PROGRAM</code>, instead. <a href="ch18.xhtml#ch18ex20">Listing 18-20</a> shows how we might rework <code>AC_CHECK_LIB</code> to handle the function <code>Fancy::execute(int, int)</code> from a library called <em>fancy</em>. I’ve highlighted the places where I’ve modified the original macro definition of <a href="ch18.xhtml#ch18ex17">Listing 18-17</a> on <a href="ch18.xhtml#page_512">page 512</a>.</p>&#13;
<pre>   <span class="ash">AC_PREREQ([2.59])</span>&#13;
   <span class="ash">AC_INIT([test], [1.0])</span>&#13;
&#13;
   AC_LANG([C++])&#13;
&#13;
   <span class="ash"># --- A modified version of AC_CHECK_LIB</span>&#13;
   <span class="ash">m4_ifval([], , [AH_CHECK_LIB([</span>fancy<span class="ash">])])dnl</span>&#13;
<span class="ent">➊</span> <span class="ash">AS_VAR_PUSHDEF([ac_Lib], [ac_cv_lib_</span>fancy_execute<span class="ash">])dnl</span>&#13;
<span class="ent">➋</span> <span class="ash">AC_CACHE_CHECK([</span>whether -lfancy exports Fancy::execute(int,int)<span class="ash">], [ac_Lib],</span>&#13;
   <span class="ash">[ac_check_lib_save_LIBS=$LIBS</span>&#13;
<span epub:type="pagebreak" id="page_516"/>   <span class="ash">LIBS="-l</span>fancy <span class="ash">$LIBS"</span>&#13;
<span class="ent">➌</span> <span class="ash">AC_LINK_IFELSE([</span>AC_LANG_PROGRAM(&#13;
   [[class Fancy {&#13;
       public: void execute(int i, int j);&#13;
   };]],&#13;
   [[ MyClass test;&#13;
     test.execute(1, 1);]])],&#13;
     <span class="ash">[AS_VAR_SET([ac_Lib], [yes])],</span>&#13;
     <span class="ash">[AS_VAR_SET([ac_Lib], [no])])</span>&#13;
   <span class="ash">LIBS=$ac_check_lib_save_LIBS])</span>&#13;
   <span class="ash">AS_VAR_IF([ac_Lib], [yes],</span>&#13;
     <span class="ash">[AC_DEFINE_UNQUOTED(AS_TR_CPP(HAVE_LIBFANCY))</span>&#13;
     <span class="ash">LIBS="-l</span>fancy <span class="ash">$LIBS"</span>&#13;
   <span class="ash">],</span>&#13;
   <span class="ash">[])dnl</span>&#13;
   <span class="ash">AS_VAR_POPDEF([ac_Lib])dnl</span>&#13;
   <span class="ash"># --- End of modified version of AC_CHECK_LIB</span>&#13;
&#13;
   <span class="ash">AC_OUTPUT</span></pre>&#13;
<p class="caption" id="ch18ex20"><em>Listing 18-20: Hacking a modified version of <code>AC_CHECK_LIB</code> into</em> configure.ac</p>&#13;
<p class="indent">In <a href="ch18.xhtml#ch18ex20">Listing 18-20</a>, I’ve replaced the parameter placeholders with library and function names at <span class="ent">➊</span> and <span class="ent">➋</span> and added the prologue and body of the program to be generated by <code>AC_LANG_PROGRAM</code> at <span class="ent">➌</span>. I’ve also removed some extraneous text that specifically had to do with the optional parameters of <code>AC_CHECK_LIB</code> that I don’t care about in my version.</p>&#13;
<p class="indent">This code is much longer and more difficult to understand than a simple call to <code>AC_CHECK_LIB</code>, so it just begs to be turned into a macro. I’ll leave that to you as an exercise. Having read <a href="ch16.xhtml">Chapter 16</a>, you should be able to do this without too much difficulty. Note also that there is much room for optimization in this macro. As you become more proficient with M4, you’ll undoubtedly find ways you can reduced the size and complexity of this reworked macro, while maintaining the desired functionality.</p>&#13;
<h4 class="h4" id="ch18sec5-1"><em>Providing Library-Specific Autoconf Macros</em></h4>&#13;
<p class="noindent">This item is about hacking Autoconf macros when you need special features not provided by the standard macros, but the example I used was specifically about looking for a particular function in a library. This is a special case of a more general issue: finding libraries that provide desired functionality.</p>&#13;
<p class="indent">If you’re a library developer, consider providing downloadable Autoconf macros that test for the existence of your libraries, and perhaps version-specific functionality within them. By doing so, you make it easier for your users to ensure that their users have proper access to your libraries.</p>&#13;
<p class="indent">Such macros don’t have to be general purpose in nature, because they’re tailored to a specific library. Library-specific macros are much easier to write and can be more thorough in testing for the functionality of your library. As the author, you’re more likely to understand all the nuances of various versions of your library, so your macros can be spot-on with respect to determining library characteristics that your users may need to differentiate.</p>&#13;
<h3 class="h3" id="ch18sec6"><span epub:type="pagebreak" id="page_517"/>Item 6: Cross-Compiling</h3>&#13;
<p class="noindent">Cross-compilation occurs when the <em>build system</em> (the system on which the binaries are built) and the <em>host system</em> (the system on which those binaries are meant to be executed) are not of the same types. For example, we’re cross-compiling when we build Motorola 68000 binaries for an embedded system on a typical Intel x86 platform running GNU/Linux, or when we build Sparc binaries on a DEC Alpha system running Solaris. A far more common scenario is using your Linux system to build software designed to run on an embedded microcontroller.</p>&#13;
<p class="indent">The situation becomes even more complex if the software you’re building, such as a compiler or linker, can generate software. In this case, the <em>target system</em> represents the system for which your compiler or linker will ultimately generate code. When such a build system involves three different architectures, it’s often referred to as a <em>Canadian cross</em>.<sup><a id="ch18fn_9" href="footnote.xhtml#ch18fn9">9</a></sup> In this case, a compiler or linker is built on architecture A to run on architecture B and generate code for architecture C. Another type of three-system build, called a <em>cross-to-native</em> build, involves building an architecture-A compiler <em>on</em> architecture A to run on architecture B. In this case, three architectures are involved, but the host and target architectures are the same. Once you master the concepts of dual-system cross-compilation, moving on to using a three-system cross-compile mode is fairly simple.</p>&#13;
<p class="indent">Autoconf generates configuration scripts that attempt to guess the build system type and then assume that the host system type is the same. Unless told otherwise with command line options, <code>configure</code> assumes that non-cross-compilation mode is in effect. When executed without command line options that specify the build or host system types, an Autoconf-generated configuration script can usually accurately determine system type and characteristics.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Section 14, “Manual Configuration,” of the</em> GNU Autoconf Manual <em>discusses how to put Autoconf into cross-compilation mode. Unfortunately, the information that you’ll need in order to write proper</em> configure.ac <em>files for cross-compilation is spread throughout that manual in bits and pieces. Each macro with nuances specific to cross-compilation has a paragraph describing the effects of cross-compilation mode on that macro. Search the manual for “cross-comp” to find all the references.</em></p>&#13;
</div>&#13;
<p class="indent">System types are defined in the <em>GNU Autoconf Manual</em> in terms of a three-part canonical naming scheme involving CPU, vendor, and operating system, in the form <code>cpu-vendor-os</code>. But the <code>os</code> portion can itself be a pair containing a kernel and system type (<code>kernel-system</code>). If you know a canonical name for a system, you can specify it in each of three parameters to <code>configure</code>, as follows:</p>&#13;
<ul>&#13;
<li class="noindent"><code>--build=build-type</code></li>&#13;
<li class="noindent"><code>--host=host-type</code></li>&#13;
<li class="noindent"><code>--target=target-type</code></li>&#13;
</ul>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_518"/>These <code>configure</code> command line options, with correct canonical system type names, allow you to define the build, host, and target system types. (Defining the host system type to be the same as your build system type is redundant, because this is the default case for <code>configure</code>.)</p>&#13;
<p class="indent">One of the most challenging (and least documented) aspects of using these options is determining a proper canonical system name to use in these command line options. Nowhere in the <em>GNU Autoconf Manual</em> will you find a statement that tells you how to contrive a proper canonical name because canonical names are not unique for each system type. For instance, in most valid cross-compilation configurations, the <code>vendor</code> portion of the canonical name is simply ignored and can thus be set to anything.</p>&#13;
<p class="indent">When you use the <code>AC_CANONICAL_SYSTEM</code> macro early in your <em>configure.ac</em> file, you’ll find two new Autoconf helper scripts added to your project directory (by <code>automake --add-missing</code>, which is also executed by <code>autoreconf --install</code>). Specifically, these helper scripts are <code>config.guess</code> and <code>config.sub</code>. The job of <code>config.guess</code> is to determine, through heuristics, the canonical system name for your user’s system—the build system. You can execute this program yourself to determine an appropriate canonical name for your own build system. For instance, on my 64-bit Intel GNU/Linux system, I get the following output from <code>config.guess</code>:</p>&#13;
<pre>$ <span class="codestrong1">/usr/share/automake-1.15/config.guess</span>&#13;
x86_64-pc-linux-gnu&#13;
$</pre>&#13;
<p class="indent">As you can see here, <code>config.guess</code> requires no command line options, although there are a few available. (Use the <code>--help</code> option to see them.) Its job is to guess your system type, mostly based on the output of the <code>uname</code> utility. This guess is used as a default system type that can be overridden by a user on the <code>configure</code> command line. When cross-compiling, you can use this value in your <code>--build</code> command line option.<sup><a id="ch18fn_10" href="footnote.xhtml#ch18fn10">10</a></sup></p>&#13;
<p class="indent">The task of the <code>config.sub</code> program is to accept an input string as a sort of alias for a system type that you’re looking for and then to convert it to a proper Autoconf canonical name. But what is a valid alias? For a few clues, search for “Decode aliases” within <code>config.sub</code>. You’ll likely find a comment above a bit of code whose job it is to decode aliases for certain <code>CPU-COMPANY</code> combinations. Here are a few examples executed from my system; you should find the same results on your system:</p>&#13;
<pre>$ <span class="codestrong1">/usr/share/automake-1.15/config.sub i386</span>&#13;
i386-pc-none&#13;
$ <span class="codestrong1">/usr/share/automake-1.15/config.sub i386-linux</span>&#13;
i386-pc-linux-gnu&#13;
<span epub:type="pagebreak" id="page_519"/>$ <span class="codestrong1">/usr/share/automake-1.15/config.sub m68k</span>&#13;
m68k-unknown-none&#13;
$ <span class="codestrong1">/usr/share/automake-1.15/config.sub m68k-sun</span>&#13;
m68k-sun-sunos4.1.1&#13;
$ <span class="codestrong1">/usr/share/automake-1.15/config.sub alpha</span>&#13;
alpha-unknown-none&#13;
$ <span class="codestrong1">/usr/share/automake-1.15/config.sub alpha-dec</span>&#13;
alpha-dec-ultrix4.2&#13;
$ <span class="codestrong1">/usr/share/automake-1.15/config.sub sparc</span>&#13;
sparc-sun-sunos4.1.1&#13;
$ <span class="codestrong1">/usr/share/automake-1.15/config.sub sparc-sun</span>&#13;
sparc-sun-sunos4.1.1&#13;
$ <span class="codestrong1">/usr/share/automake-1.15/config.sub mips</span>&#13;
mips-unknown-elf&#13;
$</pre>&#13;
<p class="indent">As you can see, a lone CPU name is usually not quite enough information for <code>config.sub</code> to properly determine a useful canonical name for a desired host system.</p>&#13;
<p class="indent">Notice, too, that there are a few generic keywords that can sometimes provide enough information for cross-compilation, without actually providing true vendor or operating system names. For instance, <code>unknown</code> can be substituted for the vendor name in general, and <code>none</code> is occasionally appropriate for the operating system name. Clearly <code>elf</code> is a valid system name as well, and it can be enough in some circumstances for <code>configure</code> to determine which tool chain to use. However, by simply appending a proper vendor name to the CPU, you can allow <code>config.sub</code> can take a pretty good stab at coming up with the most likely operating system for that pair and then generate a useful canonical system type name.</p>&#13;
<p class="indent">Ultimately, the best way to determine a proper canonical system type name is to examine <code>config.sub</code> for something close to what you think you should be using for a CPU and a vendor name and then simply ask it. While this may seem like a shot in the dark, chances are good that if you’ve gotten to the point of writing a build system for a program that should be cross-compiled, you’re probably already very familiar with the names of your host CPU, vendor, and operating system.</p>&#13;
<p class="indent">When cross-compiling, you’ll most likely use tools other than the ones you normally use on your system or, at the very least, additional command line options on your normal tools. Such tools are usually installed in sets as packages. Another clue to a proper host system canonical name is the prefix of these tools’ names. There’s nothing magic in the way Autoconf handles cross-compilation. The host system canonical name is used directly to locate the proper tools by name in the system path. Thus, the host system canonical name you use will have to match the prefix on your tools.</p>&#13;
<p class="indent">Now let’s examine a common scenario: building 32-bit code on a 64-bit machine of the same CPU architecture. Technically, this is a form of cross-compilation, and it’s often a much simpler scenario than cross-compiling code for an entirely different machine architecture. Many GNU/Linux systems support both 32- and 64-bit execution. On these systems, <span epub:type="pagebreak" id="page_520"/>you can often use your build system’s tool chain to perform this task with special command line options. For example, to build C source code for a 32-bit Intel system on a 64-bit Intel system, you would simply use the following <code>configure</code> command line (I’ve highlighted the lines related to cross-compilation):<sup><a id="ch18fn_11" href="footnote.xhtml#ch18fn11">11</a></sup></p>&#13;
<pre>   $ <span class="codestrong1">./configure CPPFLAGS=-m32 LDFLAGS=-m32</span>&#13;
   <span class="ash">checking for a BSD-compatible install... /usr/bin/install -c</span>&#13;
   <span class="ash">checking whether build environment is sane... yes</span>&#13;
   <span class="ash">checking for a thread-safe mkdir -p... /bin/mkdir -p</span>&#13;
   <span class="ash">checking for gawk... gawk</span>&#13;
   <span class="ash">checking whether make sets $(MAKE)... yes</span>&#13;
<span class="ent">➊</span> checking build system type... x86_64-pc-linux-gnu&#13;
<span class="ent">➋</span> checking host system type... x86_64-pc-linux-gnu&#13;
   <span class="ash">checking for style of include used by make... GNU</span>&#13;
   <span class="ash">checking for gcc... gcc</span>&#13;
   <span class="ash">checking for C compiler default output file name... a.out</span>&#13;
   <span class="ash">checking whether the C compiler works... yes</span>&#13;
<span class="ent">➌</span> checking whether we are cross compiling... no&#13;
   <span class="ash">checking for suffix of executables...</span>&#13;
   <span class="ash">checking for suffix of object files... o</span>&#13;
   <span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="indent">Notice at <span class="ent">➌</span> that, as far as <code>configure</code> is concerned, we are not cross-compiling because we haven’t given <code>configure</code> any command line options instructing it to use a different tool chain than it would normally use. As you can see at <span class="ent">➊</span> and <span class="ent">➋</span>, both the build and host system types are what you’d expect for a 64-bit GNU/Linux system. Additionally, because my system is a dual-mode system, it can execute test programs compiled with these flags. They’ll run on the 64-bit CPU in 32-bit mode just fine.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Many systems require that you install the 32-bit tools before <em><code>gcc</code></em> will even recognize the <em><code>-m32</code></em> flag. For example, Fedora systems require the installation of the</em> glibc-devel.i686 <em>package, and my Linux Mint (Ubuntu-based) system required me to install the</em> gcc-multilib <em>package.</em></p>&#13;
</div>&#13;
<p class="indent">To be even more certain of a proper build on Linux systems, you can also use the <code>linux32</code> utility to change the personality of your 64-bit system to that of a 32-bit system, like this:</p>&#13;
<pre>$ <span class="codestrong1">linux32 ./configure CPPFLAGS=-m32 LDFLAGS=-m32</span>&#13;
<span class="codeitalic1">--snip--</span>&#13;
<span epub:type="pagebreak" id="page_521"/>checking whether we are cross compiling... no&#13;
<span class="codeitalic1">--snip--</span>&#13;
checking build system type... i686-pc-linux-gnu&#13;
checking host system type... i686-pc-linux-gnu&#13;
<span class="codeitalic1">--snip--</span></pre>&#13;
<p class="indent">We use <code>linux32</code> here because some subscripts executed by <code>configure</code> may inspect <code>uname -m</code> to determine the build machine’s architecture. The <code>linux32</code> utility ensures that these scripts properly see a 32-bit Linux system. You can test this yourself by running <code>uname</code> under <code>linux32</code>:</p>&#13;
<pre>$ <span class="codestrong1">uname -m</span>&#13;
x86_64&#13;
$ <span class="codestrong1">linux32 uname -m</span>&#13;
i686&#13;
$</pre>&#13;
<p class="indent">To get this sort of cross-compile to work on a Linux dual-mode system, you usually need to install one or more 32-bit development packages, as noted previously. If your project uses other system-level services, such as a graphical desktop, you will need the 32-bit versions of these libraries, as well.</p>&#13;
<p class="indent">Now let’s do it the more conventional (dare I say, <em>canonical</em>?) way. Rather than add <code>-m32</code> to the <code>CPPFLAGS</code> and <code>LDFLAGS</code> variables, we’ll set the build and host system types manually on the <code>configure</code> command line and see what happens. Again, I’ve highlighted the output lines related to cross-compilation:</p>&#13;
<pre>   $ <span class="codestrong1">./configure --build=x86_64-pc-linux-gnu --host=i686-pc-linux-gnu</span>&#13;
   <span class="ash">checking for a BSD-compatible install... /usr/bin/install -c</span>&#13;
   <span class="ash">checking whether build environment is sane... yes</span>&#13;
   <span class="ash">checking for a thread-safe mkdir -p... /bin/mkdir -p</span>&#13;
   <span class="ash">checking for gawk... gawk</span>&#13;
   <span class="ash">checking whether make sets $(MAKE)... yes</span>&#13;
<span class="ent">➊</span> checking for i686-pc-linux-gnu-strip... no&#13;
   <span class="ash">checking for strip... strip</span>&#13;
<span class="ent">➋</span> configure: WARNING: using cross tools not prefixed with host triplet&#13;
   checking build system type... x86_64-pc-linux-gnu&#13;
   checking host system type... i686-pc-linux-gnu&#13;
   <span class="ash">checking for style of include used by make... GNU</span>&#13;
<span class="ent">➌</span> checking for i686-pc-linux-gnu-gcc... no&#13;
   <span class="ash">checking for gcc... gcc</span>&#13;
   <span class="ash">checking for C compiler default output file name... a.out</span>&#13;
   <span class="ash">checking whether the C compiler works... yes</span>&#13;
   checking whether we are cross compiling... yes&#13;
   checking for suffix of executables...&#13;
   checking for suffix of object files... o&#13;
   <span class="codeitalic1">--</span><span class="codeitalic1">snip--</span></pre>&#13;
<p class="indent">Several key lines in this example indicate that, as far as <code>configure</code> is concerned, we’re cross-compiling. The cross-compilation build environment is <code>x86_64-pc-linux-gnu</code>, while the host is <code>i686-pc-linux-gnu</code>.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_522"/>But notice the highlighted <code>WARNING</code> text at <span class="ent">➋</span>. My system doesn’t have a tool chain that’s dedicated to building 32-bit Intel binaries. Such a tool chain includes all of the same tools required to build the 64-bit versions of my products, but the 32-bit versions are prefixed with the canonical system name of the host system. If you don’t have a properly prefixed tool chain installed and available in the system path, <code>configure</code> will default to using the build system tools—those without a prefix. This can work fine if your build system’s tools can cross-compile to the host system with proper command line options and if you’ve also specified those options in <code>CPPFLAGS</code> and <code>LDFLAGS</code>.</p>&#13;
<p class="indent">Normally, you’d have to install a tool chain designed to build the correct type of binaries. In this example, a version of such tools could easily be provided by creating soft links and simple shell scripts that pass additional required flags. According to the <code>configure</code> script output at <span class="ent">➊</span> and <span class="ent">➌</span>, I need to provide <code>i686-pc-linux-gnu-</code> prefixed versions of <code>strip</code> and <code>gcc</code>.</p>&#13;
<p class="indent">Generally, such foreign tool chains are installed into an auxiliary directory, which means you’d have to add that directory to your system <code>PATH</code> variable in order to allow <code>configure</code> to find them. For this example, I’ll just create them in <em>~/bin</em>.<sup><a id="ch18fn_12" href="footnote.xhtml#ch18fn12">12</a></sup> Once again I’ve highlighted the output text related to cross-compilation:</p>&#13;
<pre>   $ <span class="codestrong1">ln -s /usr/bin/strip ~/bin/i686-pc-linux-gnu-strip</span>&#13;
   $ <span class="codestrong1">echo '#!/bin/sh</span>&#13;
   &gt; <span class="codestrong1">gcc -m32 "$@"' &gt; ~/bin/i686-pc-linux-gnu-gcc</span>&#13;
   $ <span class="codestrong1">chmod +x ~/bin/i686-pc-linux-gnu-gcc</span>&#13;
   $ <span class="codestrong1">./configure --build=x86_64-pc-linux-gnu --host=i686-pc-linux-gnu</span>&#13;
   <span class="ash">checking for a BSD-compatible install... /usr/bin/install -c</span>&#13;
   <span class="ash">checking whether build environment is sane... yes</span>&#13;
   <span class="ash">checking for a thread-safe mkdir -p... /bin/mkdir -p</span>&#13;
   <span class="ash">checking for gawk... gawk</span>&#13;
   <span class="ash">checking whether make sets $(MAKE)... yes</span>&#13;
   checking for i686-pc-linux-gnu-strip... i686-pc-linux-gnu-strip&#13;
   checking build system type... x86_64-pc-linux-gnu&#13;
   checking host system type... i686-pc-linux-gnu&#13;
   <span class="ash">checking for style of include used by make... GNU</span>&#13;
   checking for i686-pc-linux-gnu-gcc... i686-pc-linux-gnu-gcc&#13;
   <span class="ash">checking for C compiler default output file name... a.out</span>&#13;
   <span class="ash">checking whether the C compiler works... yes</span>&#13;
   checking whether we are cross compiling... yes&#13;
   <span class="ash">checking for suffix of executables...</span>&#13;
   <span class="ash">checking for suffix of object files... o</span>&#13;
   <span class="ash">checking whether we are using the GNU C compiler... yes</span>&#13;
   checking whether i686-pc-linux-gnu-gcc accepts -g... yes&#13;
   <span class="codeitalic1">--snip--</span>&#13;
   $ <span class="codestrong1">make</span>&#13;
   <span class="codeitalic1a">--snip--</span>&#13;
<span class="ent">➊</span> <span class="ash">libtool: compile:</span> i686-pc-linux-gnu-gcc <span class="ash">-DHAVE_CONFIG_H -I. -I.. -g -O2</span>&#13;
    <span class="ash">-MT print.lo -MD -MP -MF .deps/print.Tpo -c print.c -fPIC -DPIC -o</span>&#13;
   <span class="codeitalic1a">--snip--</span>&#13;
   $</pre>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_523"/>This time, <code>configure</code> was able to find the proper tools. Notice that the compiler command at <span class="ent">➊</span> no longer contains the <code>-m32</code> flag. It’s there, but it’s hidden inside the <code>i686-pc-linux-gnu-gcc</code> script. As far as the Autotools are concerned, <code>i686-pc-linux-gnu-gcc</code> already knows how to build 32-bit binaries on a 64-bit system.</p>&#13;
<p class="indent">Cross-compilation is not for the average end user. As open source software developers, we use packages like the Autotools to ensure that our end users don’t have to be experts in software development in order to build and install our packages. But cross-compilation requires a certain level of system configuration that is beyond the scope of what the Autotools generally expect of end users. Additionally, cross-compilation is used most often within specialized fields, such as tool chain or embedded systems development. End users in these areas usually <em>are</em> experts in software development.</p>&#13;
<p class="indent">There are a few places where cross-compilation can, and possibly should, be made available to the average end user. However, I strongly encourage you to be explicit and detailed in the instructions you provide your users in your <em>README</em> and <em>INSTALL</em> documents.</p>&#13;
<h3 class="h3" id="ch18sec7">Item 7: Emulating Autoconf Text Replacement Techniques</h3>&#13;
<p class="noindent">Say your project builds a daemon that is configured at startup with values in a configuration text file. How does the daemon know where to find this file on startup? One way is to simply assume it’s located in <em>/etc</em>, but a well-written program will allow the user to configure this location when building the software. The system configuration directory has a variable location whose value can be specified on the <code>configure</code>, <code>make all</code>, or <code>make install</code> command line, as shown in the following examples:</p>&#13;
<pre>$ <span class="codestrong1">./configure --sysconfdir=/etc</span>&#13;
<span class="codeitalic1">--snip--</span>&#13;
$ <span class="codestrong1">make all sysconfdir=/usr/mypkg/etc</span>&#13;
<span class="codeitalic1">--snip--</span>&#13;
$ <span class="codestrong1">sudo make install sysconfdir=/usr/local/mypkg/etc</span>&#13;
<span class="codeitalic1">--snip--</span></pre>&#13;
<p class="indent">All of these examples take advantage of command line functionality provided by Autotools build systems, so they must all be carefully taken into account when creating project and project build source files. Let’s look at some examples that will explain how to do this.</p>&#13;
<p class="indent">Now, some conditions simply can’t work. For instance, you can’t pass a system configuration directory path into C source code from within the makefile when you build your program and then expect it to run correctly if you change where the configuration files are installed on the <code>make install</code> command line. Most end users won’t pass anything on the command line, but you should still ensure that they can set prefix directories from the <code>configure</code> and <code>make</code> command lines.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_524"/>This item is focused on placing command line prefix variable override information into the proper locations in your code and installed data files as late as possible in the build process.</p>&#13;
<p class="indent">Autoconf replaces text in <code>AC_SUBST</code> variables with the values of those variables as defined in <code>configure</code> at configuration time, but it doesn’t replace the text with raw values. In an Autotools project, if you execute <code>configure</code> with a specific <code>datadir</code>, you get the following:</p>&#13;
<pre>   $ <span class="codestrong1">./configure --datadir=/usr/share</span>&#13;
   <span class="codeitalic1">--snip--</span>&#13;
   $ <span class="codestrong1">grep "datadir =" Makefile</span>&#13;
   <span class="ash">pkgdatadir = $(datadir)/b64</span>&#13;
<span class="ent">➊</span> datadir = /usr/share&#13;
   $</pre>&#13;
<p class="indent">You can see at <span class="ent">➊</span> that the value of the shell variable <code>datadir</code> in <code>configure</code> is substituted exactly according to the command line instructions in the <code>make</code> variable <code>datadir</code> in <em>Makefile</em>. What’s not obvious here is that the default value of <code>datadir</code>, both in the <code>configure</code> script and in the makefile after substitution, is relative to other variables within the build system. By not overriding <code>datadir</code> on the <code>configure</code> command line, we see that the default value in the makefile contains unexpanded shell variable references:</p>&#13;
<pre>$ <span class="codestrong1">./configure</span>&#13;
<span class="codeitalic1">--snip--</span>&#13;
$ <span class="codestrong1">cat Makefile</span>&#13;
<span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">datadir =</span> ${datarootdir}&#13;
<span class="ash">datarootdir =</span> ${prefix}/share&#13;
<span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">prefix = /usr/local</span>&#13;
<span class="codeitalic1a">--snip--</span>&#13;
$</pre>&#13;
<p class="indent">In <a href="ch03.xhtml">Chapter 3</a> (see <a href="ch03.xhtml#ch03ex36">Listing 3-36</a>), we saw that we could pass command line options to the preprocessor that would allow us to consume these sorts of path values within our source code. <a href="ch18.xhtml#ch18ex21">Listing 18-21</a> demonstrates this by passing a C-preprocessor definition in the <code>CPPFLAGS</code> variable for a hypothetical program called <code>myprog</code>.<sup><a id="ch18fn_13" href="footnote.xhtml#ch18fn13">13</a></sup></p>&#13;
<pre>myprog_CPPFLAGS = -DSYSCONFDIR="\"@sysconfdir@\""</pre>&#13;
<p class="caption" id="ch18ex21"><em>Listing 18-21: Pushing prefix variables into C source code in</em> Makefile.am <em>or</em> Makefile.in</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_525"/>A C source file might then contain the code shown in <a href="ch18.xhtml#ch18ex22">Listing 18-22</a>.</p>&#13;
<pre><span class="codeitalic1">--snip--</span>&#13;
#ifndef SYSCONFDIR&#13;
# define SYSCONFDIR "/etc"&#13;
#endif&#13;
<span class="codeitalic1">--snip--</span>&#13;
const char * sysconfdir = SYSCONFDIR;&#13;
<span class="codeitalic1">--snip</span><span class="codeitalic1">--</span></pre>&#13;
<p class="caption" id="ch18ex22"><em>Listing 18-22: Using the preprocessor-defined variables in C source code</em></p>&#13;
<p class="indent">Automake does nothing special with the line in <a href="ch18.xhtml#ch18ex21">Listing 18-21</a> between <em>Makefile.am</em> and <em>Makefile.in</em>, but the <code>configure</code> script converts the <em>Makefile.in</em> line into the <em>Makefile</em> line shown in <a href="ch18.xhtml#ch18ex23">Listing 18-23</a>.</p>&#13;
<pre>myprog_CPPFLAGS = -DSYSCONFDIR="\"${prefix}/etc\""</pre>&#13;
<p class="caption" id="ch18ex23"><em>Listing 18-23: The resulting</em> Makefile <em>line after <code>configure</code> substitutes <code>@sysconfdir@</code></em></p>&#13;
<p class="indent">When <code>make</code> passes this option on the compiler command line, it dereferences the variables to produce the following output command line (shown only in part here):</p>&#13;
<pre>libtool: compile: gcc ... -DSYSCONFDIR=\"/usr/local/etc\" ...</pre>&#13;
<p class="indent">There are a couple of problems with this approach. First, between <code>configure</code> and <code>make</code>, you lose the resolution of the <code>sysconfdir</code> variable because <code>configure</code> substitutes <code>${prefix}</code><em>/etc</em>, rather than <code>${sysconfdir}</code>, for <code>@sysconfdir@</code>. The problem is that you can no longer set the value of <code>sysconfdir</code> on the <code>make</code> command line. To solve this problem, use the <code>${sysconfdir} make</code> variable directly in your <code>CPPFLAGS</code> variable, as shown in <a href="ch18.xhtml#ch18ex24">Listing 18-24</a>, rather than the Autoconf <code>@sysconfdir@</code> substitution variable.</p>&#13;
<pre>myprog_CPPFLAGS = -DSYSCONFDIR="\"${sysconfdir}\""</pre>&#13;
<p class="caption" id="ch18ex24"><em>Listing 18-24: Using the <code>make</code> variable in <code>CPPFLAGS</code> instead of the Autoconf substitution variable</em></p>&#13;
<p class="indent">You can use this approach to specify a value for <code>sysconfdir</code> on both the <code>configure</code> and <code>make</code> command lines. Setting the variable on the <code>configure</code> command line defines a default value in <em>Makefile.in</em> (and subsequently in the generated <em>Makefile</em>), which can then be overridden on the <code>make</code> command line.</p>&#13;
<p class="indent">The problem with using different values on the <code>make all</code> and <code>make install</code> command lines is a bit more subtle. Consider what happens if you do the following:</p>&#13;
<pre>$ <span class="codestrong1">make sysconfdir=/usr/local/myprog/etc</span>&#13;
<span class="codeitalic1">--snip--</span>&#13;
$ <span class="codestrong1">sudo make install sysconfdir=/etc</span>&#13;
<span class="codeitalic1">--snip--</span>&#13;
$</pre>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_526"/>Here, you’re basically lying to the compiler when you tell it that your configuration file will be installed in <em>/usr/local/myprog/etc</em> during the build. The compiler will happily generate the code in <a href="ch18.xhtml#ch18ex22">Listing 18-22</a> so that it refers to this path; the second command line will then install your configuration file into <em>/etc</em>, and your program will contain a hardcoded path to the wrong location. Unfortunately, there’s little that you can do to correct this, because you’ve allowed your users to define these variables anywhere and because the <em>GNU Coding Standards</em> state the <code>make install</code> shouldn’t recompile anything.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>There are cases where different installation paths are given to the build and install processes on purpose. Recall the discussion of <em><code>DESTDIR</code></em> in “Getting Your Project into a Linux Distro” on <a href="ch03.xhtml#page_67">page 67</a>, wherein RPM packages are built and installed in a staging directory so that built products can be packaged in an RPM to be installed into the correct location later.</em></p>&#13;
</div>&#13;
<p class="indent">Regardless of the potential pitfalls, being able to specify installation locations on the <code>make</code> command line is a powerful technique, but one that only works in makefiles because it relies heavily on <code>make</code> variable substitution within compiler command lines in your makefiles.</p>&#13;
<p class="indent">What if you want to replace a value in an installed data file that isn’t processed by <code>make</code> on a shell command line? You could convert your data file into an Autoconf template and then simply reference the Autoconf substitution variable within that file.</p>&#13;
<p class="indent">In fact, we did just that in the <em>doxyfile.in</em> templates that we created for the FLAIM project in <a href="ch15.xhtml">Chapter 15</a>. However, this only worked in Doxygen input files because the class of variables used in those templates is always defined with complete absolute or relative paths by <code>configure</code>. That is, the values of <code>@srcdir@</code> and <code>@top_srcdir@</code> contain no additional shell variables. These variables are not installation directory (prefix) variables, which, with the exception of <code>prefix</code> itself, are always defined relative to other prefix variables.</p>&#13;
<p class="indent">You can, however, <em>emulate</em> the Autoconf substitution variable process within a makefile, allowing substitution variables to be used in installed data files. <a href="ch18.xhtml#ch18ex25">Listing 18-25</a> shows a template in which you might want to replace variables with path information normally found in the standard prefix variables during a build.</p>&#13;
<pre># Configuration file for myprog&#13;
logdir = @localstatedir@/log&#13;
<span class="codeitalic1">--snip--</span></pre>&#13;
<p class="caption" id="ch18ex25"><em>Listing 18-25: A sample config file template for myprog, to be installed in <code>$(sysconfdir)</code></em></p>&#13;
<p class="indent">This template is for a program configuration file, which might normally be installed in the system configuration directory. We want the location of the program’s log file, specified in this configuration file, to be determined at install time by the value of <code>@localstatedir@</code>. Unfortunately, <code>configure</code> would replace this variable with a string containing at least <code>${prefix}</code>, which is not useful in a program configuration file. <a href="ch18.xhtml#ch18ex26">Listing 18-26</a> shows a <em>Makefile.am</em> file <span epub:type="pagebreak" id="page_527"/>with additional <code>make</code> script to generate <em>myprog.cfg</em> by performing substitution on variables in <em>myprog.cfg.in</em>.</p>&#13;
<pre>   EXTRA_DIST = myprog.cfg.in&#13;
<span class="ent">➊</span> sysconf_DATA = myprog.cfg&#13;
&#13;
<span class="ent">➋</span> edit = sed -e 's|@localstatedir[@]|$(localstatedir)|g'&#13;
<span class="ent">➌</span> myprog.cfg: myprog.cfg.in Makefile&#13;
           $(edit) $(srcdir)/$@.in &gt; $@.tmp&#13;
           mv $@.tmp $@&#13;
&#13;
   CLEANFILES = myprog.cfg</pre>&#13;
<p class="caption" id="ch18ex26"><em>Listing 18-26: Substituting <code>make</code> variables into data files using <code>sed</code> in a makefile</em></p>&#13;
<p class="indent">In this <em>Makefile.am</em> file, I’ve defined a custom <code>make</code> target at <span class="ent">➌</span> to build the <em>myprog.cfg</em> data file. I’ve also defined a <code>make</code> variable called <code>edit</code> at <span class="ent">➋</span>, which resolves to a partial <code>sed</code> command that replaces all instances of <code>@localstatedir@</code> in the template file (<code>$(srcdir)/</code><em>myprog.cfg.in</em>) with the value of the <code>$(localstatedir)</code> variable. Because <code>make</code> recursively processes variable replacements until all variable references are resolved, using <code>make</code> in this manner will ensure that you never leave any variable references in your final output. In the command where this variable is used, <code>sed</code>’s output is redirected to the output file (<em>myprog.cfg</em>).<sup><a id="ch18fn_14" href="footnote.xhtml#ch18fn14">14</a></sup></p>&#13;
<p class="indent">The only nonobvious code in this example is the use of the square brackets around the trailing at sign (<code>@</code>) in the <code>sed</code> expression, which represent regular expression syntax indicating that any of the enclosed characters should be matched. Because there is only one enclosed character, this would seem to be a pointless complication, but the purpose of these brackets is to keep <code>configure</code> from replacing <code>@localstatedir@</code> in the <code>edit</code> variable when it performs Autoconf variable substitution on this makefile. We want <code>make</code> to use this variable, not <code>configure</code>.</p>&#13;
<p class="indent">I assign <em>myprog.cfg</em> to the <code>sysconf_DATA</code> variable at <span class="ent">➊</span> to tie execution of this new rule into the framework provided by Automake. Automake will install this file into the system configuration directory after building it, if necessary.</p>&#13;
<p class="indent">The files in <code>DATA</code> primaries are added as dependencies to the <code>all</code> target via the internal <code>all-am</code> target. If <em>myprog.cfg</em> doesn’t exist, <code>make</code> will look for a rule to build it. Since I have such a rule, <code>make</code> will simply execute that rule when I build the <code>all</code> target.</p>&#13;
<p class="indent">I’ve added the template file name <em>myprog.cfg.in</em> to the <code>EXTRA_DIST</code> variable at the top of <a href="ch18.xhtml#ch18ex26">Listing 18-26</a> because neither Autoconf nor Automake is aware of this file. In addition, I’ve added the generated file <em>myprog.cfg</em> to the <code>CLEANFILES</code> variable at the bottom of the listing because, as far as Automake is concerned, <em>myprog.cfg</em> is a distributed data file that should not be automatically deleted by <code>make clean</code>.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><span epub:type="pagebreak" id="page_528"/><em>This example demonstrates a good reason for Automake to not automatically distribute files listed in <em><code>DATA</code></em> primaries. Sometimes such files are built in this manner. If built data files were automatically distributed, the <em><code>distcheck</code></em> target would fail because myprog.cfg was not available for distribution before building.</em></p>&#13;
</div>&#13;
<p class="indent">In this example, I tied the building of <em>myprog.cfg</em> into the install process by adding it to the <code>sysconf_DATA</code> variable, and then I placed a dependency between <em>mydata.cfg.in</em> and <em>mydata.cfg</em><sup><a id="ch18fn_15" href="footnote.xhtml#ch18fn15">15</a></sup> to ensure that the installed file is built when <code>make all</code> is executed. You could also tie into a standard or custom build or installation target using appropriate <code>-hook</code> or custom targets.</p>&#13;
<p class="indent">No discussion of this topic would be complete without a mention of the Gnulib <em>configmake</em> module. If you’re already using Gnulib and need to do something like what I’ve been talking about in this item, consider using <em>configmake</em>, which creates a <em>configmake.h</em> header file that can be included by your source files to provide access to all of the standard directory variables as C preprocessor macros. It’s only useful for C code, so you’d still need the techniques I’ve shown you here for non-C-source code use cases (such as installed configuration files that need to reference prefix variable paths).</p>&#13;
<h3 class="h3" id="ch18sec8">Item 8: Using the Autoconf Archive Project</h3>&#13;
<p class="noindent">In “Item 5: Hacking Autoconf Macros” on <a href="ch18.xhtml#page_511">page 511</a>, I demonstrated a technique for hacking Autoconf macros to provide functionality that’s close to, but not exactly the same as, that of the original macro. When you need a macro that Autoconf doesn’t provide, you can either write it yourself or look for one that someone else has written. This item is about the second option, and a perfect place to begin your search is the Autoconf Archive project.</p>&#13;
<p class="indent">As of this writing, the Autoconf Archive source project is hosted by GNU Savannah.<sup><a id="ch18fn_16" href="footnote.xhtml#ch18fn16">16</a></sup> The original ac-archive project was the result of a merger between two older projects: one by Guido Draheim (at <em><a href="http://ac-archive.sourceforge.net/">http://ac-archive.sourceforge.net/</a></em>) and the other by Peter Simon (at <em>http://auto-archive.cryp.to</em>). The first of these sites is still online today, although it displays a huge red warning box indicating that you should submit updates to the GNU Autoconf Macro Archive at Savannah; the second has been taken down. There is some long history and not a few flame wars on email lists between these two projects. Ultimately, each project incorporated most of the contents of the other, but Peter Simon’s is the one that was migrated into the Savannah repository, and the current home page is found at <em><a href="https://www.gnu.org/software/autoconf-archive/">https://www.gnu.org/software/autoconf-archive/</a></em>.<sup><a id="ch18fn_17" href="footnote.xhtml#ch18fn17">17</a></sup></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_529"/>The value in the archive is that private macros become public and public macros are incrementally improved by many users.</p>&#13;
<p class="indent">As of this writing, the macro archive contains over 500 macros not distributed with Autoconf, including the <code>AX_PTHREAD</code> macro discussed in “Doing Threads the Right Way” on <a href="ch14.xhtml#page_384">page 384</a>. The latest release of the archive can be checked out from the project’s Savannah git site. The site indexes macros by category, author, and open source license, allowing you to choose macros based on specific criteria. You can also search for a macro by name or by entering any text that might be found in the macro’s header comments.</p>&#13;
<p class="indent">If you find yourself in need of a macro that Autoconf doesn’t appear to provide, check out the Autoconf Archive.</p>&#13;
<h3 class="h3" id="ch18sec9">Item 9: Using Incremental Installation Techniques</h3>&#13;
<p class="noindent">Some people have requested that <code>make install</code> be made smart enough to install only files that are not already installed or that are newer than installed versions of the same files.</p>&#13;
<p class="indent">This feature is available by default to users by passing the <code>-C</code> command line option to <code>install-sh</code>. It can be enabled directly by end users by using the following syntax on the <code>make</code> command line during execution of <code>make install</code>:</p>&#13;
<pre>$ <span class="codestrong1">make install "INSTALL=/path/to/install-sh -C"</span></pre>&#13;
<p class="indent">If you think your users will benefit from this option, consider adding some information about its proper use to the <em>INSTALL</em> file that ships with your project. Don’t you just love features you don’t have to implement?</p>&#13;
<h3 class="h3" id="ch18sec10">Item 10: Using Generated Source Code</h3>&#13;
<p class="noindent">Automake requires that all source files used within a project be statically defined within the project’s <em>Makefile.am</em> files, but sometimes the contents of source files need to be generated at build time.</p>&#13;
<p class="indent">There are two ways to deal with generated sources (more specifically, generated header files) in your projects. The first involves the use of an Automake-provided crutch for developers not interested in the finer points of <code>make</code>. The second involves writing proper dependency rules to allow <code>make</code> to understand the relationships between your source files and your products. I’ll cover the crutch first, and then we’ll get into the details of proper dependency management in <em>Makefile.am</em> files.</p>&#13;
<h4 class="h4" id="ch18sec10-1"><em>Using the BUILT_SOURCES Variable</em></h4>&#13;
<p class="noindent">When you have a header file that’s generated as part of your build process, you can tell Automake to generate rules that will always create this file first, before attempting to build your products. To do this, add the header file to the Automake <code>BUILT_SOURCES</code> variable, as shown in <a href="ch18.xhtml#ch18ex27">Listing 18-27</a>.</p>&#13;
<pre><span epub:type="pagebreak" id="page_530"/><span class="ash">bin_PROGRAMS = program</span>&#13;
<span class="ash">program_SOURCES = program.c program.h</span>&#13;
<span class="ash">nodist_program_SOURCES = generated.h</span>&#13;
BUILT_SOURCES = generated.h&#13;
<span class="ash">CLEANFILES = generated.h</span>&#13;
<span class="ash">generated.h: Makefile</span>&#13;
        <span class="ash">echo "#define generated 1" &gt; $@</span></pre>&#13;
<p class="caption" id="ch18ex27"><em>Listing 18-27: Using <code>BUILT_SOURCES</code> to deal with generated source files</em></p>&#13;
<p class="indent">The <code>nodist_program_SOURCES</code> variable ensures that Automake will not generate rules that try to distribute this file; we want it to be built when the end user runs <code>make</code>, not shipped in the distribution package.</p>&#13;
<p class="indent">Without a user-provided clue, Automake-generated makefiles have no way of knowing that the rule for <em>generated.h</em> should be executed before <em>program.c</em> is compiled. I call <code>BUILT_SOURCES</code> a “crutch” because it simply forces the rules used to generate the listed files to execute first, and only when the user makes the <code>all</code> or <code>check</code> target. The rules created using <code>BUILT_SOURCES</code> aren’t even executed if you attempt to make the <code>program</code> target directly. With that said, let’s look at what’s going on under the covers.</p>&#13;
<h4 class="h4" id="ch18sec10-2"><em>Dependency Management</em></h4>&#13;
<p class="noindent">There are two distinct classes of source files in a C or C++ project: those explicitly defined as dependencies within your makefile and those referenced only indirectly through, for instance, preprocessor inclusion.</p>&#13;
<p class="indent">You can hardcode all of these dependencies directly into your makefiles. For instance, if <em>program.c</em> includes <em>program.h</em>, and if <em>program.h</em> includes <em>console.h</em> and <em>print.h</em>, then <em>program.o</em> actually depends on all of these files, not just <em>program.c</em>. And yet, a normal handcoded makefile explicitly defines only the relationships between the <em>.c</em> files and the program. For a truly accurate build, <code>make</code> needs to be told about all of these relationships using a rule like the one shown in <a href="ch18.xhtml#ch18ex28">Listing 18-28</a>.</p>&#13;
<pre>   program: program.o&#13;
           $(CC) $(CFLAGS) $(LDFLAGS) -o $@ program.o&#13;
&#13;
<span class="ent">➊</span> program.o: program.c program.h console.h print.h&#13;
           $(CC) -c $(CPPFLAGS) $(CFLAGS) -o $@ program.c</pre>&#13;
<p class="caption" id="ch18ex28"><em>Listing 18-28: Rules describing the complete relationship between files</em></p>&#13;
<p class="indent">The relationship between <em>program.o</em> and <em>program.c</em> is often defined by an <em>implicit</em> rule, so the rule at <span class="ent">➊</span> in <a href="ch18.xhtml#ch18ex28">Listing 18-28</a> is often broken into two separate rules, as shown in <a href="ch18.xhtml#ch18ex29">Listing 18-29</a>.</p>&#13;
<pre>   program: program.o&#13;
           $(CC) $(CFLAGS) $(LDFLAGS) -o $@ program.o&#13;
&#13;
<span class="ent">➊</span> %.o: %.c&#13;
<span epub:type="pagebreak" id="page_531"/>           $(CC) -c $(CPPFLAGS) $(CFLAGS) -o $@ $&lt;&#13;
&#13;
<span class="ent">➋</span> program.o: program.h console.h print.h</pre>&#13;
<p class="caption" id="ch18ex29"><em>Listing 18-29: An implicit rule for C source files, defined as a GNU <code>make</code> pattern rule</em></p>&#13;
<p class="indent">In <a href="ch18.xhtml#ch18ex29">Listing 18-29</a>, the GNU <code>make</code>-specific <em>pattern rule</em> at <span class="ent">➊</span> tells <code>make</code> that the associated command can generate a file ending in <em>.o</em> from a file of the same base name ending in <em>.c</em>.<sup><a id="ch18fn_18" href="footnote.xhtml#ch18fn18">18</a></sup> Thus, whenever <code>make</code> needs to find a rule to generate a file ending in <em>.o</em> that’s listed as a dependency in one of your rules, it searches for a <em>.c</em> file with the same base name. If it finds one, it applies this rule to rebuild the <em>.o</em> file from the corresponding <em>.c</em> file if the timestamp on the <em>.c</em> file is newer than that of the existing <em>.o</em> file or if the <em>.o</em> file is missing.</p>&#13;
<p class="indent">There is a documented set of implicit pattern rules built into <code>make</code>, so you don’t generally have to write such rules. Still, you must somehow tell <code>make</code> about the indirect<sup><a id="ch18fn_19" href="footnote.xhtml#ch18fn19">19</a></sup> dependencies between the <em>.o</em> file and any included <em>.h</em> files. These dependencies cannot simply be implied with a built-in rule because there are no implicit relationships between these files that are based on file naming conventions, such as the relationship between <em>.c</em> and <em>.o</em> files. The relationships are manually coded into the source and header files as inclusions.</p>&#13;
<p class="indent">As I mentioned in <a href="ch03.xhtml">Chapter 3</a>, writing such rules is tedious and error prone, because during development (and even maintenance, to a lesser degree), the myriad relationships between source and header files can change all the time and the rules must be updated carefully with each change to keep the build accurate. The C preprocessor is much better suited to automatically writing and maintaining these rules for you.</p>&#13;
<h5 class="h5">A Two-Pass System</h5>&#13;
<p class="noindent">There are two ways to use the preprocessor to manage dependencies. The first is to create a two-pass system, wherein the first pass just builds the dependencies and the second pass compiles the source code based on those dependencies. This is done by defining rules that use certain preprocessor commands to generate <code>make</code> dependency rules, as shown in <a href="ch18.xhtml#ch18ex30">Listing 18-30</a>.<sup><a id="ch18fn_20" href="footnote.xhtml#ch18fn20">20</a></sup></p>&#13;
<pre><span epub:type="pagebreak" id="page_532"/>   program: program.o&#13;
           $(CC) $(CFLAGS) $(LDFLAGS) -o $@ program.o&#13;
&#13;
   %.o: %.c&#13;
           $(CC) $(CPPFLAGS) -c $(CFLAGS) -o $@ $&lt;&#13;
&#13;
<span class="ent">➊</span> %.d: %.c&#13;
           $(CC) -M $(CPPFLAGS) $&lt; &gt;$@&#13;
&#13;
<span class="ent">➋</span> sinclude program.d</pre>&#13;
<p class="caption" id="ch18ex30"><em>Listing 18-30: Building automatic dependencies directly</em></p>&#13;
<p class="indent">In <a href="ch18.xhtml#ch18ex30">Listing 18-30</a>, the pattern rule at <span class="ent">➊</span> specifies the same sort of relationship between <em>.d</em> and <em>.c</em> files as the one shown at <span class="ent">➊</span> in <a href="ch18.xhtml#ch18ex29">Listing 18-29</a> does for <em>.o</em> and <em>.c</em> files. The <code>sinclude</code> statement here at <span class="ent">➋</span> tells <code>make</code> to include another makefile, and GNU <code>make</code> is smart enough not only to ensure that all makefiles are included before the primary dependency graph is analyzed but also to look for rules to build them.<sup><a id="ch18fn_21" href="footnote.xhtml#ch18fn21">21</a></sup> Running <code>make</code> on this makefile produces the following output:</p>&#13;
<pre>   $ <span class="codestrong1">make</span>&#13;
   cc -M program.c &gt;program.d&#13;
   cc -c -o program.o program.c&#13;
   cc -o program program.o&#13;
   $&#13;
   $ <span class="codestrong1">cat program.d</span>&#13;
   program.o: program.c /usr/include/stdio.h /usr/include/features.h \&#13;
   /usr/include/sys/cdefs.h /usr/include/bits/wordsize.h \&#13;
<span class="ent">➊</span> <span class="codeitalic1">--snip--</span>&#13;
   /usr/include/bits/pthreadtypes.h /usr/include/alloca.h program.h \&#13;
   console.h print.h&#13;
   $&#13;
   $ <span class="codestrong1">touch console.h &amp;&amp; make</span>&#13;
   cc -c -o program.o program.c&#13;
   cc -o program program.o&#13;
   $</pre>&#13;
<p class="indent">As you can see here, the rule to generate <em>program.d</em> is executed first, as <code>make</code> attempts to include that file. The elided section at <span class="ent">➊</span> refers to the many system header files traversed while recursively scanning the included set of headers. The file contains a dependency rule similar<sup><a id="ch18fn_22" href="footnote.xhtml#ch18fn22">22</a></sup> to the one we wrote <span epub:type="pagebreak" id="page_533"/>at <span class="ent">➋</span> in <a href="ch18.xhtml#ch18ex29">Listing 18-29</a>. (The reference to <em>program.c</em> is missing in our hand-coded rule’s dependency list because it’s redundant, though harmless.) You can also see from the console example that touching one of these included files now properly causes the <em>program.c</em> source file to be rebuilt.</p>&#13;
<p class="indent">The problems with the mechanism outlined in <a href="ch18.xhtml#ch18ex30">Listing 18-30</a> include the fact that the entire source tree must be traversed twice: once to check for and possibly generate the dependency files and then again to compile any modified source files.</p>&#13;
<p class="indent">Another problem is that if one header includes another, and the second header is modified, the object file will be updated but not the dependency file included by <code>make</code>. The next time the second-level header is modified, neither the object nor the dependency file will be updated. Deleted header files also cause problems: the build system doesn’t recognize that the deleted file was purposely removed, so it complains that files referenced in the existing dependencies are missing.</p>&#13;
<h5 class="h5">Doing It in One Pass</h5>&#13;
<p class="noindent">A more efficient way to handle automatic dependencies is to generate the dependency files as a side effect of compilation. <a href="ch18.xhtml#ch18ex31">Listing 18-31</a> shows how this can be done by using the non-portable <code>-MMD</code> GNU extension compiler option (highlighted in the listing).</p>&#13;
<pre>   <span class="ash">program: program.o</span>&#13;
           <span class="ash">$(CC) $(CFLAGS) $(LDFLAGS) -o $@ program.o</span>&#13;
&#13;
   <span class="ash">%.o: %.c</span>&#13;
<span class="ent">➊</span>         <span class="ash">$(CC) -</span>MMD <span class="ash">$(CPPFLAGS) -c $(CFLAGS) -o $@ $&lt;</span>&#13;
&#13;
<span class="ent">➋</span> <span class="ash">sinclude program.d</span></pre>&#13;
<p class="caption" id="ch18ex31"><em>Listing 18-31: Generating dependencies as a side effect of compilation</em></p>&#13;
<p class="indent">Here, I’ve removed the second pattern rule (originally shown at <span class="ent">➊</span> in <a href="ch18.xhtml#ch18ex30">Listing 18-30</a>) and added a <code>-MMD</code> option to the compiler command line at <span class="ent">➊</span> in <a href="ch18.xhtml#ch18ex31">Listing 18-31</a>. This option tells the preprocessor to generate a <em>.d</em> file of the same base name as the <em>.c</em> file that it’s currently compiling. When <code>make</code> is executed on a clean work area, the <code>sinclude</code> statement at <span class="ent">➋</span> silently fails to include the missing <em>program.d</em> file, but it doesn’t matter because all of the object files will be built the first time anyway. During subsequent incremental builds, the previously built <em>program.d</em> is included, and its dependency rules take effect during those builds.</p>&#13;
<h4 class="h4" id="ch18sec10-3"><em>Built Sources Done Right</em></h4>&#13;
<p class="noindent">The one-pass method just described is roughly the one that Automake uses to manage automatic dependencies, when possible. The problems with this approach are most often manifested when working with generated sources, including both <em>.c</em> files and <em>.h</em> files. For instance, let’s expand the example <span epub:type="pagebreak" id="page_534"/>shown in <a href="ch18.xhtml#ch18ex31">Listing 18-31</a> a bit to contain a generated header file called <em>generated.h</em>, included by <em>program.h</em>. <a href="ch18.xhtml#ch18ex32">Listing 18-32</a> shows a first attempt at this modification. Additions to <a href="ch18.xhtml#ch18ex31">Listing 18-31</a> are highlighted in this listing.</p>&#13;
<pre><span class="ash">program: program.o</span>&#13;
        <span class="ash">$(CC) $(CFLAGS) $(LDFLAGS) -o $@ program.o</span>&#13;
&#13;
<span class="ash">%.o: %.c</span>&#13;
        <span class="ash">$(CC) -MMD $(CPPFLAGS) -c $(CFLAGS) -o $@ $&lt;</span>&#13;
&#13;
generated.h: Makefile&#13;
        echo "#define generated" &gt;$@&#13;
&#13;
<span class="ash">sinclude program.d</span></pre>&#13;
<p class="caption" id="ch18ex32"><em>Listing 18-32: A makefile that works with a generated header file dependency</em></p>&#13;
<p class="indent">In this case, when we execute <code>make</code>, we find that the lack of an initial dependency file works against us:</p>&#13;
<pre>$ <span class="codestrong1">make</span>&#13;
cc -MMD -c -o program.o program.c&#13;
In file included from program.c:4:&#13;
program.h:3:23: error: generated.h: No such file or directory&#13;
make: *** [program.o] Error 1&#13;
$</pre>&#13;
<p class="indent">Because there is no initial secondary dependency information, <code>make</code> doesn’t know it needs to run the commands for the <em>generated.h</em> rule yet, because <em>generated.h</em> only depends on <em>Makefile</em>, which hasn’t changed. To fix this problem in a <em>Makefile.am</em> file, we could just list <em>generated.h</em> in the <code>BUILT_SOURCES</code> variable, as we did in <a href="ch18.xhtml#ch18ex27">Listing 18-27</a> on <a href="ch18.xhtml#page_531">page 531</a>. This would add <em>generated.h</em> as the first dependency of the <code>all</code> and <code>check</code> targets, thereby forcing them to be built first in the likely event the user happens to enter <code>make</code>, <code>make all</code>, or <code>make check</code>.<sup><a id="ch18fn_23" href="footnote.xhtml#ch18fn23">23</a></sup></p>&#13;
<p class="indent">The proper way to handle this problem is very simple, and it works every time in both makefiles and <em>Makefile.am</em> files: write a dependency rule between <em>program.o</em> and <em>generated.h</em>, as shown in the updated makefile in <a href="ch18.xhtml#ch18ex33">Listing 18-33</a>. The highlighted line contains the additional rule.</p>&#13;
<pre><span class="ash">program: program.o</span>&#13;
        <span class="ash">$(CC) $(CFLAGS) $(LDFLAGS) -o $@ program.o</span>&#13;
&#13;
<span class="ash">%.o: %.c</span>&#13;
        <span class="ash">$(CC) -MMD $(CPPFLAGS) -c $(CFLAGS) -o $@ $&lt;</span>&#13;
&#13;
program.o: generated.h&#13;
<span epub:type="pagebreak" id="page_535"/><span class="ash">generated.h: Makefile</span>&#13;
        <span class="ash">echo "#define generated" &gt;$@</span>&#13;
&#13;
<span class="ash">sinclude program.d</span></pre>&#13;
<p class="caption" id="ch18ex33"><em>Listing 18-33: Adding a hardcoded dependency rule for a generated header file</em></p>&#13;
<p class="indent">The new rule tells <code>make</code> about the relationship between <em>program.o</em> and <em>generated.h</em>:</p>&#13;
<pre>   $ <span class="codestrong1">make</span>&#13;
   echo "#define generated" &gt;generated.h&#13;
   cc -MMD -c -o program.o program.c&#13;
   cc -o program program.o&#13;
   $&#13;
   $ <span class="codestrong1">make</span>&#13;
   make: 'program' is up-to-date.&#13;
   $&#13;
<span class="ent">➊</span> $ <span class="codestrong1">touch generated.h &amp;&amp; make</span>&#13;
   cc -MMD -c -o program.o program.c&#13;
   cc -o program program.o&#13;
   $&#13;
<span class="ent">➋</span> $ <span class="codestrong1">touch Makefile &amp;&amp; make</span>&#13;
   echo "#define generated" &gt;generated.h&#13;
   cc -MMD -c -o program.o program.c&#13;
   cc -o program program.o&#13;
   $</pre>&#13;
<p class="indent">Here, touching <em>generated.h</em> (at <span class="ent">➊</span>) causes <code>program</code> to be updated. Touching <em>Makefile</em> (at <span class="ent">➋</span>) causes <em>generated.h</em> to be re-created first.</p>&#13;
<p class="indent">To implement the dependency rule shown in <a href="ch18.xhtml#ch18ex33">Listing 18-33</a> in an Automake <em>Makefile.am</em> file, you’d use the highlighted rule shown in <a href="ch18.xhtml#ch18ex34">Listing 18-34</a>.</p>&#13;
<pre><span class="ash">bin_PROGRAMS = program</span>&#13;
<span class="ash">program_SOURCES = program.c program.h</span>&#13;
<span class="ash">nodist_program_SOURCES = generated.h</span>&#13;
program.$(OBJEXT): generated.h&#13;
<span class="ash">CLEANFILES = generated.h</span>&#13;
<span class="ash">generated.h: Makefile</span>&#13;
        <span class="ash">echo "#define generated 1" &gt; $@</span></pre>&#13;
<p class="caption" id="ch18ex34"><em>Listing 18-34: Replacing <code>BUILT_SOURCES</code> with a proper dependency rule</em></p>&#13;
<p class="indent">This is exactly the same code shown previously in <a href="ch18.xhtml#ch18ex27">Listing 18-27</a> on <a href="ch18.xhtml#page_531">page 531</a>, except that we’ve replaced the <code>BUILT_SOURCES</code> variable with a proper dependency rule. The advantage of this method is that it always <span epub:type="pagebreak" id="page_536"/>works as it should; <em>generated.h</em> will always be built exactly when it needs to be, regardless of the target specified by the user.<sup><a id="ch18fn_24" href="footnote.xhtml#ch18fn24">24</a></sup></p>&#13;
<p class="indent">If you had tried to generate a C source file rather than a header file, you’d find that you didn’t even need the additional dependency rule because <em>.o</em> files implicitly depend on their <em>.c</em> files. However, you must still list your generated <em>.c</em> file in the <code>nodist_program_SOURCES</code> variable to keep Automake from trying to distribute it.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>When you define your own rule, you suppress any rules that Automake may generate for that product. In the case of a specific object file, this is not likely to be a problem, but keep this Automake idiosyncrasy in mind when defining rules.</em></p>&#13;
</div>&#13;
<p class="indent">As you can see, all you really need to properly manage generated sources is a correctly written set of dependency rules as well as appropriate <code>nodist_*_SOURCES</code> variables. The <code>make</code> utility and the Autotools provide the required framework in the form of built-in <code>make</code> functionality, macros, and variables. You just have to put them together correctly. For example, in the <em>GNU Automake Manual</em>, see Section 8.1.2, which discusses program linking.<sup><a id="ch18fn_25" href="footnote.xhtml#ch18fn25">25</a></sup> This section refers to the <code>EXTRA_prog_DEPENDENCIES</code> variable as a mechanism for extending Automake’s generated dependency graph for a specific target.</p>&#13;
<h3 class="h3" id="ch18sec11">Item 11: Disabling Undesirable Targets</h3>&#13;
<p class="noindent">Sometimes the Autotools do too much for you. Here’s an example from the Automake mailing list:</p>&#13;
<p class="bqpara">I use automake in one of my projects along with texinfo. That project has documentation full of images. As you probably know, <code>`make pdf'</code> makes a PDF document from JPGs and PNGs, whereas <code>`make dvi'</code> requires EPSs. However, EPS images are insanely large (in this case like 15 times larger than JPGs).</p>&#13;
<p class="bqpara">The problem is that running <code>`make distcheck'</code> results in error since the EPS images that should be there aren't there and <code>`make distcheck'</code> tries to run `make dvi' everywhere. I would like to run <code>`make pdf'</code> instead, or at least to disable building DVI. Is there any way to accomplish that?</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_537"/>First a little background information: The Automake <code>TEXINFOS</code> primary makes several documentation targets available to the end user, including <code>info</code>, <code>dvi</code>, <code>ps</code>, <code>pdf</code>, and <code>html</code>. It also provides several installation targets, including <code>install-info</code>, <code>install-dvi</code>, <code>install-ps</code>, <code>install-pdf</code>, and <code>install-html</code>. Of these targets, only <code>info</code> is automatically built with <code>make</code> or <code>make all</code>, and only <code>install-info</code> is executed with <code>make install</code>.<sup><a id="ch18fn_26" href="footnote.xhtml#ch18fn26">26</a></sup></p>&#13;
<p class="indent">However, it appears that the <code>distcheck</code> target also builds at least the <code>dvi</code> target, as well. The problem just outlined is that the poster doesn’t provide the Encapsulated PostScript (EPS) graphics files required to build the DVI documentation, so the <code>distcheck</code> target fails because it can’t build documentation that the poster doesn’t want to support anyway.</p>&#13;
<p class="indent">To fix this issue, you would simply provide your own version of the target that does nothing, as shown in <a href="ch18.xhtml#ch18ex35">Listing 18-35</a>.</p>&#13;
<pre>   <span class="codeitalic1">--snip--</span>&#13;
   info_TEXINFOS = zardoz.texi&#13;
<span class="ent">➊</span> dvi: # do nothing for make dvi</pre>&#13;
<p class="caption" id="ch18ex35"><em>Listing 18-35: Disabling the <code>dvi</code> target in a</em> Makefile.am <em>that specifies <code>TEXINFOS</code> primaries</em></p>&#13;
<p class="indent">With the one-line addition at <span class="ent">➊</span>, <code>make distcheck</code> is back in business. Now, when it builds the <code>dvi</code> target, it succeeds because it does nothing.</p>&#13;
<p class="indent">Other Automake primaries provide multiple additional targets as well. If you only want to support a subset of these targets, you can effectively disable the undesired targets by providing one of your own. If you’d like to be a bit more vocal about the disabling override, simply include an <code>echo</code> statement as a command that tells the user that your package doesn’t provide DVI documentation, but be careful not to execute anything that might fail in this override, or your user will be right back in the same boat.</p>&#13;
<h3 class="h3" id="ch18sec12">Item 12: Watch Those Tab Characters!</h3>&#13;
<p class="noindent">Having made the transition to Automake, you’re not using raw makefiles anymore, so why should you still care about tab characters? Remember that <em>Makefile.am</em> files are simply stylized makefiles. Ultimately, every line in a <em>Makefile.am</em> file will be either consumed directly by Automake, and then transformed into true <code>make</code> syntax, or copied directly into the final makefile. This means that tab characters matter within <em>Makefile.am</em> files.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_538"/>Consider this example from the Automake mailing list:</p>&#13;
<pre>lib_LTLIBRARIES = libfoo.la&#13;
libfoo_la_SOURCES = foo.cpp&#13;
if WANT_BAR&#13;
  <span class="ent">➊</span> libfoo_la_SOURCES += a.cpp&#13;
else&#13;
  <span class="ent">➋</span> libfoo_la_SOURCES += b.cpp&#13;
endif&#13;
&#13;
AM_CPPFLAGS = -I${top_srcdir}/include&#13;
libfoo_la_LDFLAGS = -version-info 0:0:0</pre>&#13;
<p class="bqpara">I have been reading both autoconf and automake manuals and as far as I can see, the above should work. However the files (a.cpp or b.cpp) [are] always added at the bottom of the generated Makefile and are therefore not used in the compilation. No matter what I try, I cannot get even the above code to generate a correct makefile, but obviously I am doing something wrong.</p>&#13;
<p class="indent">The answer, provided by another poster, was simple and accurate, if not terse to a fault:</p>&#13;
<p class="bqpara">Remove the indentation.</p>&#13;
<p class="indent">The trouble here is that the two lines within the Automake conditional at <span class="ent">➊</span> and <span class="ent">➋</span> are indented with tab characters.</p>&#13;
<p class="indent">You may recall from “Automake Configuration Features” on <a href="ch14.xhtml#page_380">page 380</a>, where I discussed the implementation of Automake conditionals, that text within conditionals is prefixed with an Autoconf substitution variable that is ultimately transformed into either an empty string or a hash mark. The implication here is that these lines are essentially either left as is or commented out within the final makefile. The commented lines really don’t concern us, but you can clearly see that if the uncommented lines in the makefile begin with the tab character, Automake will treat them as commands, rather than as definitions, and sort them accordingly in the final makefile. When <code>make</code> processes the generated makefile, it will attempt to interpret these lines as orphan commands.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Had the original poster used spaces to indent the conditional statements, they’d have had no problem.</em></p>&#13;
</div>&#13;
<p class="indent">The moral of the story: watch those tab characters!</p>&#13;
<h3 class="h3" id="ch18sec13"><span epub:type="pagebreak" id="page_539"/>Item 13: Packaging Choices</h3>&#13;
<p class="noindent">The ultimate goal of a package maintainer is to make it easy for the end user. System-level packages never have this problem because they don’t rely on anything that’s not part of the core operating system. But higher-level packages often rely on multiple subpackages, some of which are more pervasive than others.</p>&#13;
<p class="indent">For example, consider the Subversion project. If you download the latest source archive from the Subversion project website, you’ll find that it comes in two flavors. The first contains only the Subversion source code, but if you unpack and build this project, you’ll find that you’ll need to download and install the Apache runtime and runtime utility (<em>apr</em> and <em>apr-utils</em>) packages, the <em>zlib-devel</em> package, and the <em>sqlite-devel</em> package. At this point, you can build Subversion, but to enable secure access to repositories via HTTPS, you’ll also need <em>neon</em> or <em>serf</em> and <em>openssl</em>.</p>&#13;
<p class="indent">The Subversion project maintainers felt that community adoption of Subversion was important enough to go the extra mile, so to speak. To help you out in your quest to build a functional Subversion package, they’ve provided a second package called <em>subversion-deps</em>, which contains a source-level distribution of some of Subversion’s more important requirements.<sup><a id="ch18fn_27" href="footnote.xhtml#ch18fn27">27</a></sup> Simply unpack the <em>subversion-deps</em> source package in the same directory where you unpacked your <em>subversion</em> source package. The root directory in the <em>subversion-deps</em> package contains only subdirectories—one for each of these source-level dependencies.</p>&#13;
<p class="indent">You can choose to add source packages to your projects’ build systems in the same manner. Of course, the process is much simpler if you’re using Automake. You need only call <code>AC_CONFIG_SUBDIRS</code> for subdirectories containing add-on projects in your build tree. <code>AC_CONFIG_SUBDIRS</code> quietly ignores missing subproject directories. I showed you an example of this process in <a href="ch14.xhtml">Chapter 14</a>, where I built the FLAIM toolkit as a subproject if it existed as a subdirectory within any of the higher-level FLAIM project directories.</p>&#13;
<p class="indent">Which packages should you ship with your package? The key lies in determining which packages your consumers are least likely to be able to find on their own.</p>&#13;
<h3 class="h3" id="ch18sec14"><span epub:type="pagebreak" id="page_540"/>Wrapping Up</h3>&#13;
<p class="noindent">I hope you find these solutions—indeed, this book—useful on your quest to create a really great user experience with your open source projects. I began this book with the statement that people often start out hating the Autotools because they don’t understand the purpose of the Autotools. By now, you should have a fairly well-developed sense of this purpose. If you were disinclined to use the Autotools before, then I hope I’ve given you reason to reconsider.</p>&#13;
<p class="indent">Recall the famously misquoted line from Albert Einstein: “Everything should be made as simple as possible, but no simpler.”<sup><a id="ch18fn_28" href="footnote.xhtml#ch18fn28">28</a></sup> Not all things can be made so simple that anyone can master them with little training. This is especially true when it comes to processes that are designed to make life simpler for others. The Autotools offer the ability for experts—programmers and software engineers—to make open source software more accessible to end users. Let’s face it—this process is less than trivial, but the Autotools attempt to make it as simple as possible.</p>&#13;
</body></html>