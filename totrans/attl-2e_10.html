<html><head></head><body>
<h2 class="h2" id="ch10"><span epub:type="pagebreak" id="page_271"/><span class="big">10</span><br/>FINDING BUILD DEPENDENCIES WITH PKG-CONFIG</h2>&#13;
<p class="quote"><em>A common mistake that people make when trying to design something completely foolproof is to underestimate the ingenuity of complete fools.<br/>—Douglas Adams</em>, The Hitchhiker’s Guide to the Galaxy</p>&#13;
<div class="image1"><img src="../images/common.jpg" alt="Image"/></div>&#13;
<p class="noindent">Let’s say your project depends on a library called <em>stpl</em>—some third-party library. How can your build system determine where <em>libstpl.so</em> is installed on an end user’s system? Where are <em>stpl</em>’s header files to be found? Do you simply assume <em>/usr/lib</em> and <em>/usr/include</em>? This is effectively what Autoconf does if you don’t tell it to look elsewhere, and for many packages perhaps that’s fine—it’s a common convention to install libraries and headers into these directories.</p>&#13;
<p class="indent">But what if they aren’t installed in these locations? Or perhaps they were built locally and installed into the <em>/usr/local</em> tree. What compiler and linker options should be used when using <em>stpl</em> in your project? These are a few issues that have plagued developers from the beginning, and the Autotools don’t really do much to manage this problem. Autoconf expects any libraries you use to be installed into “standard places,” meaning into directories where the preprocessor and linker automatically look for header files and libraries. If <span epub:type="pagebreak" id="page_272"/>a user has the library but it’s installed in a different location, the Autotools expect end users to know how to interpret the configuration failure. As it happens, there are several good reasons why many libraries are not installed in these standard places.</p>&#13;
<p class="indent">Additionally, Autoconf can’t easily find libraries that are not installed at all. For example, you may have just built a library package and you want another package to pick up headers and libraries from the first package’s build directory structure. This is possible with Autoconf, but it involves the end user setting variables like <code>CPPFLAGS</code> and <code>LDFLAGS</code> on the <code>configure</code> command line. The project maintainer can make things a little easier by providing user-specified configuration options with the <code>AC_ARG_ENABLE</code> and <code>AC_ARG_WITH</code> macros for libraries they anticipate might not be easy to find in standard places, but if your project uses a lot of third-party libraries, it’s just guesswork trying to determine which of these will be particularly problematic for users. And then, users are not often programmers; we cannot rely on them to have enough background to know what to use for option values, even if we do supply command line options for problematic dependencies. Throughout this chapter, I’ll refer to these as <em>build dependency issues</em>.</p>&#13;
<p class="indent">There is a tool that provides a solution for these types of problems in a more elegant fashion using a very common tactic in software design—by providing another layer of indirection. And it’s not part of the GNU Autotools. Regardless, its use has become so prolific over the past 20 years that it would be an oversight to exclude a description of <em>pkg-config</em> in any book that discusses Linux build systems. Pkg-config is as useful as it is today because a lot of projects have begun to use it—especially library projects, and most especially library projects that install into nonstandard locations.</p>&#13;
<p class="indent">In this chapter, we’ll look at pkg-config’s components and functionality and how to use it in your projects. For your own library projects, we’ll also discuss how to update the pkg-config database as your package is installed onto users’ (or as I like to call them, potential contributors’) systems.</p>&#13;
<p class="indent">Before we get started, allow me to state up front that this chapter makes a lot of references to filesystem objects that may or may not exist on your flavor of Linux, or perhaps exist in a different form or location. It’s the nature of what we’re doing here—we’re discussing packages with libraries and header files that probably exist in different locations on different Linux flavors. I’ll try to point out such potential differences as we come to them so you’ll not be too surprised when things don’t line up exactly on our two systems.</p>&#13;
<h3 class="h3" id="ch10sec1">A pkg-config Overview</h3>&#13;
<p class="noindent">Pkg-config is an open source software utility maintained by the <em><a href="http://freedesktop.org">freedesktop.org</a></em> project. The pkg-config website is a part of the <a href="http://freedesktop.org">freedesktop.org</a> project website. The pkg-config project is the result of an effort to turn the <code>gnome-config</code> script—a part of the gnome build system—into a more general-purpose tool, and it seems to have caught on. Some inspiration for pkg-config also came from the <code>gtk-config</code> program.</p>&#13;
<div class="sidebar">&#13;
<p class="sidebart"><span epub:type="pagebreak" id="page_273"/>A NOTE ABOUT PKG-CONFIG CLONES</p>&#13;
<p class="noindent">The <a href="http://freedesktop.org">freedesktop.org</a> pkg-config project has been around for a long time and has garnered a somewhat loyal following. As a direct result, other projects now exist that offer functionality that is similar—often identical—to the pkg-config project. One that comes to mind is the pkgconf project (which Red Hat’s Fedora Linux seems to prefer when you ask the <code>yum</code> package manager to install pkg-config for you).</p>&#13;
<p class="indent">Do not confuse these two. The pkgconf project is a modern clone of the original pkg-config project that comes with claims of higher efficiency—and as far as I’m concerned, it may very well live up to these claims. Regardless, this chapter is about pkg-config. If you’ve found a project that provides functionality similar to pkg-config and you like it, then by all means use it. My goal here is to teach you about pkg-config. If this material helps you understand how to use pkgconf, or another pkg-config clone, then you’re getting from this book exactly what I hoped to convey.</p>&#13;
<p class="indent">That said, however, I cannot cover all of the nuanced differences among the different pkg-config clones. If you want to follow along with my examples and your flavor of Linux won’t install the original pkg-config package for you, you can always navigate in your browser to <em><a href="https://www.freedesktop.org/wiki/Software/pkg-config">https://www.freedesktop.org/wiki/Software/pkg-config</a></em> and download and install version 0.29.2 of the original pkg-config project</p>&#13;
</div>&#13;
<p class="indent">Pkg-config is used simply by invoking the <code>pkg-config</code> command line utility with options that display the desired data. When you’re looking for libraries and header files, the “desired data” includes package version information as well as compiler and linker options wherein library and header file locations are specified. For instance, to obtain C-preprocessor flags required to access a library’s header files, one need only specify the <code>--cflags</code> option on the <code>pkg-config</code> command line, and compiler options appropriate for the package are displayed to <code>stdout</code>. This display can be captured and appended to compiler command lines in your configuration scripts and makefiles as needed.</p>&#13;
<p class="indent">Perhaps you’re wondering why we even need a tool like <code>pkg-config</code> when Autoconf provides the <code>AC_CHECK_LIB</code> and <code>AC_SEARCH_LIBS</code> macros. In the first place, as I mentioned previously, the Autoconf macros are designed to only look in “standard locations” for libraries. You can trick the macros into looking in other places by preloading search paths into <code>CPPFLAGS</code> (using <code>-I</code> options) and <code>LDFLAGS</code> (using <code>-L</code> options). However, pkg-config is designed to help you find libraries that may be installed in places only your users’ pkg-config installations know about; the best thing about pkg-config is that it knows how to find libraries and headers on end users’ systems that these users don’t even know about. Pkg-config can also tell your build system about additional dependencies required when your users are trying to statically link to your libraries. Therefore, it effectively hides such details from users, and that’s the sort of user experience we’re looking for.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_274"/>There are, however, some caveats to using pkg-config with the Autotools. In the first edition of this book, I suggested that the <code>PKG_CHECK_MODULES</code> add-on M4 macro that’s shipped with pkg-config was a good approach to using it with Autoconf. I’ve since amended my thoughts on this issue as I’ve discovered over the years that the use of this macro can cause more problems than it solves under some rather common conditions. Additionally, <code>pkg-config</code> is so simple to use directly in shell script that it makes little sense to wrap it with less-than-transparent M4 macros. We’ll discuss this topic in much more detail in this chapter, but I wanted to set the stage for the pattern of use you’ll see in the examples that follow.</p>&#13;
<h3 class="h3" id="ch10sec2">Diving In</h3>&#13;
<p class="noindent">Let’s start by looking at the output of the <code>--help</code> option for the <code>pkg-config</code> command:</p>&#13;
<pre>$ <span class="codestrong1">pkg-config --help</span>&#13;
Usage:&#13;
  pkg-config [OPTION...]&#13;
<span class="codeitalic1">--snip--</span>&#13;
Application Options:&#13;
<span class="codeitalic1">--snip--</span>&#13;
  --modversion                               output version for package&#13;
<span class="codeitalic1">--snip--</span>&#13;
  --libs                                     output all linker flags&#13;
  --static                                   output linker flags for static linking&#13;
<span class="codeitalic1">--snip--</span>&#13;
  --libs-only-l                              output -l flags&#13;
  --libs-only-other                          output other libs (e.g. -pthread)&#13;
  --libs-only-L                              output -L flags&#13;
  --cflags                                   output all pre-processor and compiler flags&#13;
  --cflags-only-I                            output -I flags&#13;
  --cflags-only-other                        output cflags not covered by the cflags-only-I option&#13;
  --variable=NAME                            get the value of variable named NAME&#13;
  --define-variable=NAME=VALUE               set variable NAME to VALUE&#13;
  --exists                                   return 0 if the module(s) exist&#13;
  --print-variables                          output list of variables defined by the module&#13;
  --uninstalled                              return 0 if the uninstalled version of one or more&#13;
                                             module(s) or their dependencies will be used&#13;
  --atleast-version=VERSION                  return 0 if the module is at least version VERSION&#13;
  --exact-version=VERSION                    return 0 if the module is at exactly version VERSION&#13;
  --max-version=VERSION                      return 0 if the module is at no newer than version&#13;
                                             VERSION&#13;
  --list-all                                 list all known packages&#13;
  --debug                                    show verbose debug information&#13;
  --print-errors                             show verbose information about missing or conflicting&#13;
                                             packages (default unless --exists or&#13;
                                             --atleast/exact/max-version given on the command line)&#13;
<span class="codeitalic1">--snip--</span>&#13;
$</pre>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_275"/>I’ve only shown what I consider the most useful options here. There are another dozen or so, but these are the ones we’ll use all the time in our <em>configure.ac</em> files. (I’ve taken the liberty of wrapping long description lines as pkg-config seems to think everyone has a 300-column monitor.)</p>&#13;
<p class="indent">Let’s start by listing all of the modules pkg-config is aware of on the system. Here’s a sampling of the ones on my system:</p>&#13;
<pre>$ <span class="codestrong1">pkg-config --list-all</span>&#13;
<span class="codeitalic1">--snip--</span>&#13;
systemd                        systemd - systemd System and Service Manager&#13;
fontutil                       FontUtil - Font utilities dirs&#13;
usbutils                       usbutils - USB device database&#13;
bash-completion                bash-completion - programmable completion for the bash shell&#13;
libcurl                        libcurl - Library to transfer files with ftp, http, etc.&#13;
<span class="codeitalic1">--snip--</span>&#13;
notify-python                  notify-python - Python bindings for libnotify&#13;
nemo-python                    Nemo-Python - Nemo-Python Components&#13;
libcrypto                      OpenSSL-libcrypto - OpenSSL cryptography library&#13;
libgdiplus                     libgdiplus - GDI+ implementation&#13;
shared-mime-info               shared-mime-info - Freedesktop common MIME database&#13;
libssl                         OpenSSL-libssl - Secure Sockets Layer and cryptography libraries&#13;
xbitmaps                       X bitmaps - Bitmaps that are shared between X applications&#13;
<span class="codeitalic1">--snip--</span>&#13;
xkbcomp                        xkbcomp - XKB keymap compiler&#13;
dbus-python                    dbus-python - Python bindings for D-Bus&#13;
$</pre>&#13;
<p class="indent">Pkg-config becomes <em>aware</em> of a package by having the package installation process update the pkg-config database, which is nothing more than a well-known directory that <code>pkg-config</code> examines to resolve queries. The database entries are simply plaintext files ending in a <em>.pc</em> extension. Therefore, making pkg-config aware of your library project during installation is nothing more difficult than generating and installing a text file, and Autoconf can help us generate this file, as we’ll see later.</p>&#13;
<p class="indent">The <code>pkg-config</code> utility looks in several directories to find these files. We can discover what directories it looks in, and the order of the search, by calling it with the <code>--debug</code> option and piping the output (sent to <code>stderr</code>) through <code>grep</code> in this manner:</p>&#13;
<pre>$ <span class="codestrong1">pkg-config --debug |&amp; grep directory</span>&#13;
Cannot open directory #1 '/usr/local/lib/x86_64-linux-gnu/pkgconfig' in package search path: No&#13;
such file or directory&#13;
Cannot open directory #2 '/usr/local/lib/pkgconfig' in package search path: No such file or&#13;
directory&#13;
Cannot open directory #3 '/usr/local/share/pkgconfig' in package search path: No such file or&#13;
directory&#13;
Scanning directory #4 '/usr/lib/x86_64-linux-gnu/pkgconfig'&#13;
Scanning directory #5 '/usr/lib/pkgconfig'&#13;
Scanning directory #6 '/usr/share/pkgconfig'&#13;
$</pre>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_276"/>The first three directories that <code>pkg-config</code> tried to look in on my system did not exist. These are all in the <em>/usr/local</em> tree. I haven’t built and installed many packages on this system; as a result, I haven’t installed any <em>.pc</em> files into the <em>/usr/local</em> tree.</p>&#13;
<p class="indent">From the output, it’s clear that <em>.pc</em> files must be installed into one of these six directories: <em>/usr(/local)/lib/x86_64-linux-gnu/pkgconfig</em>, <em>/usr(/local)/lib/pkgconfig</em>, or <em>/usr(/local)/share/pkgconfig</em>. When you think about it, you’ll recognize these paths as what amounts to pkg-config’s <code>${libdir}</code><em>/</em><em>pkgconfig</em> and <code>${datadir}</code><em>/pkgconfig</em> directories if, that is, pkg-config didn’t need to choose between <em>/usr</em> and <em>/usr/local</em> during its installation. In the early days, these were indeed just pkg-config’s library and data installation paths, but it didn’t take long for the project developers to realize that where pkg-config was installed was not really germane to where pkg-config should search on users’ systems for <em>.pc</em> files—they could be found in many locations, depending not on where pkg-config was installed but on where the users had installed packages on their systems—all over the place.</p>&#13;
<p class="indent">But what about packages installed into custom locations or packages not yet installed? Pkg-config has solutions for these cases as well. The <code>PKG_CONFIG_PATH</code> environment variable can prepend user-specified paths to the default search path <code>pkg-config</code> uses to search for its data files. We’ll discover how to use this functionality as we cover more details about using the <code>pkg-config</code> command in <em>configure.ac</em>.</p>&#13;
<h3 class="h3" id="ch10sec3">Writing pkg-config Metadata Files</h3>&#13;
<p class="noindent">As stated earlier, pkg-config’s <em>.pc</em> files are simply short text files that describe critical aspects of the build-and-link process to consumer build processes that use components of these dependent packages.</p>&#13;
<p class="indent">Let’s take a look at a sample <em>.pc</em> file on my system—the one for the <em>libssl</em> library, a part of the OpenSSL package. First we’ll need to find it:</p>&#13;
<pre>$ <span class="codestrong1">pkg-config --variable pcfiledir libssl</span>&#13;
/usr/lib/x86_64-linux-gnu/pkgconfig&#13;
$</pre>&#13;
<p class="indent">The <code>--variable</code> option allows you to query the value of a variable, and <code>pcfiledir</code> is a pkg-config-defined variable that exists for every <em>.pc</em> file. I cover the complete list of predefined variables later in this chapter. The <code>pcfiledir</code> variable shows you the current location of the file as discovered by <code>pkg-config</code>. The nice thing about this variable is that it can also be used within your <em>.pc</em> file to provide a sort of relocation mechanism. If your library and include file paths are all relative to <code>${pcfiledir}</code> within your <em>.pc</em> file, you can move it anywhere you like (as long as you move the libraries and header files it locates to the same relative locations).</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_277"/>I’ve provided the full contents of my <em>libssl.pc</em> file in <a href="ch10.xhtml#ch10ex1">Listing 10-1</a>.</p>&#13;
<pre><span class="ent">➊</span> prefix=/usr&#13;
   exec_prefix=${prefix}&#13;
   libdir=${exec_prefix}/lib/x86_64-linux-gnu&#13;
   includedir=${prefix}/include&#13;
&#13;
<span class="ent">➋</span> Name: OpenSSL-libssl&#13;
   Description: Secure Sockets Layer and cryptography libraries&#13;
   Version: 1.0.2g&#13;
   Requires.private: libcrypto&#13;
   Libs: -L${libdir} -lssl&#13;
   Libs.private: -ldl&#13;
   Cflags: -I${includedir}</pre>&#13;
<p class="caption" id="ch10ex1"><em>Listing 10-1:</em> libssl.pc: <em>A sample</em> .pc <em>file</em></p>&#13;
<p class="indent">A <em>.pc</em> file contains two types of entities: variable definitions (starting at <span class="ent">➊</span>), which may reference other variables using Bourne shell–like syntax, and key-value tags (starting at <span class="ent">➋</span>), which define the types of data that <code>pkg-config</code> can return about an installed package. These files can contain as little or as much of the pkg-config specification as is required by the package. Besides these entities, <em>.pc</em> files may also contain comments—any text preceded by a hash (<code>#</code>) mark. While these types of entities may be intermixed, it’s common convention to put variable definitions at the top, followed by the key-value pairs.</p>&#13;
<p class="indent">Variables look and act like shell variables; definitions are formatted as a variable name, followed by an equal (<code>=</code>) sign, followed by a value. You do not need to quote the value portion, even if it contains whitespace.</p>&#13;
<p class="indent">Pkg-config makes some predefined variables available for use within the <em>.pc</em> file and (as we’ve already seen) from the command line. <a href="ch10.xhtml#ch10tab1">Table 10-1</a> shows these variables.</p>&#13;
<p class="tabcap" id="ch10tab1"><strong>Table 10-1:</strong> Pre-Defined Variables Recognized by pkg-config</p>&#13;
<table class="topbot-d1">&#13;
<colgroup>&#13;
<col style="width:40%"/>&#13;
<col style="width:60%"/>&#13;
</colgroup>&#13;
<tbody>&#13;
<tr>&#13;
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>Variable</strong></p></td>&#13;
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>Description</strong></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;" class="table-b1"><p class="taba"><code>pc_path</code></p></td>&#13;
<td style="vertical-align: top;" class="table-b1"><p class="taba">The default search path used by <code>pkg-config</code> to find the <em>.pc</em> file</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;" class="table-b"><p class="taba"><code>pcfiledir</code></p></td>&#13;
<td style="vertical-align: top;" class="table-b"><p class="taba">The installed location of the <em>.pc</em> file</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;" class="table-b1"><p class="taba"><code>pc_sysrootdir</code></p></td>&#13;
<td style="vertical-align: top;" class="table-b1"><p class="taba">The system root directory set by the user, or <em>/</em> by default</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;" class="table-b"><p class="taba"><code>pc_top_builddir</code></p></td>&#13;
<td style="vertical-align: top;" class="table-b"><p class="taba">The location of the user’s top build directory when executing <code>pkg-config</code></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<p class="indent">After you’ve looked at enough <em>.pc</em> files, you may begin to wonder if variables like <code>prefix</code>, <code>exec_prefix</code>, <code>includedir</code>, <code>libdir</code>, and <code>datadir</code> have any special meaning to pkg-config. They don’t; it’s just nice to define these paths relative to each other to reduce duplication.</p>&#13;
<p class="indent">Key-value pairs are formatted as a well-known keyword, followed by a colon (<code>:</code>) character, followed by some text that makes up the value portion. Values may reference variables; referencing an undefined variable merely expands to nothing. Quotes are not needed in these values either.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_278"/>The keys of key-value pairs are well-known and documented, although putting unknown keys in the file has no effect on <code>pkg-config</code>’s ability to use the rest of the data in the file. The keys shown in <a href="ch10.xhtml#ch10tab2">Table 10-2</a> are well-known:</p>&#13;
<p class="tabcap" id="ch10tab2"><strong>Table 10-2:</strong> Well-Known Keys in Key-Value Pairs Recognized by pkg-config</p>&#13;
<table class="topbot-d1">&#13;
<colgroup>&#13;
<col style="width:40%"/>&#13;
<col style="width:60%"/>&#13;
</colgroup>&#13;
<tbody>&#13;
<tr>&#13;
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>Key</strong></p></td>&#13;
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>Description</strong></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;" class="table-b1"><p class="taba"><code>Name</code></p></td>&#13;
<td style="vertical-align: top;" class="table-b1"><p class="taba">A human-readable name for the library or package.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;" class="table-b"><p class="taba"><code>Description</code></p></td>&#13;
<td style="vertical-align: top;" class="table-b"><p class="taba">A brief human-readable description of the package.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;" class="table-b1"><p class="taba"><code>URL</code></p></td>&#13;
<td style="vertical-align: top;" class="table-b1"><p class="taba">A URL associated with the package—perhaps the package download site.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;" class="table-b"><p class="taba"><code>Version</code></p></td>&#13;
<td style="vertical-align: top;" class="table-b"><p class="taba">A version string for the package.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;" class="table-b1"><p class="taba"><code>Requires</code></p></td>&#13;
<td style="vertical-align: top;" class="table-b1"><p class="taba">A list of packages required by this package; specific versions may be specified.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;" class="table-b"><p class="taba"><code>Requires.private</code></p></td>&#13;
<td style="vertical-align: top;" class="table-b"><p class="taba">A list of private packages required by this package.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;" class="table-b1"><p class="taba"><code>Conflicts</code></p></td>&#13;
<td style="vertical-align: top;" class="table-b1"><p class="taba">An optional field describing packages that this package conflicts with.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;" class="table-b"><p class="taba"><code>Cflags</code></p></td>&#13;
<td style="vertical-align: top;" class="table-b"><p class="taba">Compiler flags that should be used with this package.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;" class="table-b1"><p class="taba"><code>Libs</code></p></td>&#13;
<td style="vertical-align: top;" class="table-b1"><p class="taba">Linker flags that should be used with this package.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;" class="table-b"><p class="taba"><code>Libs.private</code></p></td>&#13;
<td style="vertical-align: top;" class="table-b"><p class="taba">Linker flags for private libraries required by this package.</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<h4 class="h4" id="ch10sec3-1"><em>Informational Fields</em></h4>&#13;
<p class="noindent">To get the <code>pkg-config --exists</code> command to return zero to the shell, you need to specify <code>Name</code>, <code>Description</code>, and <code>Version</code>, at the very least. To be complete, consider also providing a URL if your project has one.</p>&#13;
<p class="indent">If you’re not sure why a particular <code>pkg-config</code> command is not working as expected, use the <code>--print-errors</code> option. Where <code>pkg-config</code> would normally silently return a shell code, <code>--print-errors</code> will display a reason for a nonzero shell code:</p>&#13;
<pre>$ <span class="codestrong1">cat test.pc</span>&#13;
prefix=/usr&#13;
libdir=${prefix}/lib dir&#13;
&#13;
Name: test&#13;
#Description: a test pc file&#13;
Version: 1.0.0&#13;
$&#13;
$ <span class="codestrong1">pkg-config --exists --print-errors test.pc</span>&#13;
Package 'test' has no Description: field&#13;
$ <span class="codestrong1">echo $?</span>&#13;
1&#13;
$</pre>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>The <code>--validate</code> option will also provide this information for both installed and uninstalled</em> .pc <em>files.</em></p>&#13;
</div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_279"/>One obvious oversight is the lack of options for displaying the name and description information belonging to a package. The description is displayed when using the <code>--list-all</code> option; however, even the package name that shows up in that listing is actually the base name of the <em>.pc</em> file, not the value of the <code>Name</code> field from within the file. In spite of this, as mentioned previously, these three fields—<code>Name</code>, <code>Description</code>, and <code>Version</code>—are required; otherwise, as far as <code>pkg-config</code> is concerned, the package does not exist.</p>&#13;
<h4 class="h4" id="ch10sec3-2"><em>Functional Fields</em></h4>&#13;
<p class="noindent">The category of the <code>Version</code> field crosses over from informational to functional, as there are some <code>pkg-config</code> command line options that can make use of the value of this field to provide data about the package to configuration scripts. The <code>Requires</code>, <code>Requires.private</code>, <code>Cflags</code>, <code>Libs</code>, and <code>Libs.private</code> fields also provide machine-readable information to configuration scripts and makefiles. <code>Cflags</code>, <code>Libs</code>, and <code>Libs.private</code> directly provide command line options for the C compiler and linker. The options to be added to these tools’ command lines are accessed by using various of the <code>pkg-config</code> command line options.</p>&#13;
<p class="indent">While pkg-config is conceptually simple, some of the details are a bit elusive if you haven’t played with it long enough to glean a proper understanding. Let’s cover each of these fields in more detail.</p>&#13;
<p class="indent">The informational fields are designed to be read by people. The package version, for instance, can be displayed using the <code>--modversion</code> option:</p>&#13;
<pre>$ <span class="codestrong1">pkg-config --modversion libssl</span>&#13;
1.0.2g&#13;
$</pre>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Do not confuse the <code>--version</code> option with the <em><code>--modversion</code></em> option. If you do, you’ll quietly get pkg-config’s version, regardless of what module you specify after <em><code>--version</code></em>.</em></p>&#13;
</div>&#13;
<p class="indent">However, the <code>Version</code> field can also be used to indicate to configuration scripts if a package’s version meets requirements:</p>&#13;
<pre>$ <span class="codestrong1">pkg-config --atleast-version 1.0.2 libssl &amp;&amp; echo "libssl is good enough"</span>&#13;
libssl is good enough&#13;
$ <span class="codestrong1">pkg-config --exists "libssl &gt;= 2.0" || echo "nope - too old :("</span>&#13;
nope - too old :(&#13;
$</pre>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Library version checks go against Autoconf’s general philosophy of checking for required functionality, rather than checking for a specific version of a library, because some distro providers backport functionality to older versions of libraries so they can use that functionality without upgrading the library on a target version of their distro (mostly for convenience, as newer versions of libraries sometimes come with newer dependency requirements that can propagate for several levels). These examples are provided merely to show you what’s possible with the functionality provided by pkg-config.</em></p>&#13;
</div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_280"/>Of the functional fields, some are more obvious than others. We’ll cover each of them, starting with the more trivial ones. The <code>Cflags</code> field is probably the simplest to comprehend. It merely provides include path additions and other options to the C preprocessor and compiler. All options for both of these tools are combined into this one field, but <code>pkg-config</code> provides command line options for returning portions of the field value:</p>&#13;
<pre>$ <span class="codestrong1">pkg-config --cflags xorg-wacom</span>&#13;
-I/usr/include/xorg&#13;
$ <span class="codestrong1">pkg-config --cflags-only-other xorg-wacom</span>&#13;
$</pre>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>The important thing to notice here is that the <em><code>Cflags</code></em> field contains compiler command line options, not portions of compiler command line options. For example, to define an include path for your library, ensure the value in <em><code>Cflags</code></em> contains both the <em><code>-I</code></em> flag and the path, just as you would on the compiler command line.</em></p>&#13;
</div>&#13;
<p class="indent">The other options that affect the output of the <code>Cflags</code> field are <code>--cflags-only-I</code> and <code>--cflags-only-other</code>. As you can see, <code>pkg-config</code> is aware of the difference between <code>-I</code> options and other options; if you specify <code>--cflags-only-I</code>, you’ll only see the <code>-I</code> options in the <em>.pc</em> file.</p>&#13;
<p class="indent">The <code>Libs</code> field provides a place to set <code>-L</code>, <code>-l</code>, and any other options destined for the linker. For instance, if your package provides the <em>stpl</em> library, <em>libstpl.so</em>, you would add the <code>-L</code><em><code>/installed/lib/path</code></em> and <code>-lstpl</code> options to the <code>Libs</code> field. Pkg-config’s <code>--libs</code> option returns the entire value, and, as with <code>Cflags</code>, there are separate options (<code>--libs-only-l</code>, <code>--libs-only-L</code>, and <code>--libs-only-other</code>) that separate and return subsets of the <code>Libs</code> options.</p>&#13;
<p class="indent">Somewhat harder to grasp is the use of the <code>Libs.private</code> field. This field is documented as being for libraries “required by this package but not exposed to applications.” In reality, however, while these are libraries required to build the library published by the package, they’re also libraries required by the consumer of the package if they’re linking statically to the package’s library.<sup><a id="ch10fn_1" href="footnote.xhtml#ch10fn1">1</a></sup> In fact, the use of <code>pkg-config</code>’s <code>--static</code> command line option, in conjunction with the <code>--libs</code> (or variations thereof) option, will display a combination of the <code>Libs</code> and <code>Libs.private</code> field options. This is because linking to a static library requires, at link time, all of the symbols required by all of the code pulled in from the static library to which you are directly linking.</p>&#13;
<p class="indent">This is an important concept, and understanding how it works is the key to properly writing <em>.pc</em> files for your projects. Think about it from the end user’s perspective: they want to compile some project, and they want it to be linked statically with your library (we must also assume your project builds and installs a static version of your library, of course). In order to do <span epub:type="pagebreak" id="page_281"/>this, what options and libraries will be required on the compiler and linker command lines, <em>in addition to those already required when linking to your dynamic library</em>, in order to successfully perform this task? The answer to this question will tell you what should go into the <code>Libs.private</code> field in the <em>.pc</em> file for your project.</p>&#13;
<p class="indent">Now that those topics are behind us, we can properly discuss the <code>Requires</code> and <code>Requires.private</code> fields. The values in these fields are other pkg-config package names, with optional version specifications. If your package requires a particular version of another package that’s also managed by pkg-config, you need only specify that package in the <code>Requires</code> field if its <code>Cflags</code> and <code>Libs</code> field values are required by your users’ build processes in order to consume your package’s shared library, or in the <code>Requires.private</code> field if its <code>Cflags</code> and <code>Libs.private</code> field values are required in order to consume your package’s static library.</p>&#13;
<p class="indent">With this understanding of <code>Requires</code> and <code>Requires.private</code>, we can now see that additional options required by pkg-config packages that you’d normally put into your <code>Cflags</code> and <code>Libs</code> or <code>Libs.private</code> fields are not needed in those fields because you can simply reference the package by name (and version or version range) in <code>Requires</code> or <code>Requires.private</code>. Pkg-config will recursively find and combine options from all the packages’ fields as needed.</p>&#13;
<p class="indent">If the package required by your package is not managed by pkg-config, you must add the options you’d normally find in such <em>.pc</em> files into your own <code>Cflags</code>, <code>Libs</code>, and <code>Libs.private</code> fields.</p>&#13;
<p class="indent">The version specification used in the <code>Requires</code> and <code>Requires.private</code> fields matches that of the RPM version specification. You may use <code>&gt;</code>, <code>&gt;=</code>, <code>=</code>, <code>&lt;=</code>, or <code>&lt;</code>. Sadly, these fields only allow one instance of a given library, which means you can’t apply both upper and lower bounds on the versions of required packages. <a href="ch10.xhtml#ch10ex2">Listing 10-2</a> provides a contrived example of using version ranges.</p>&#13;
<pre><span class="codeitalic1">--snip--</span>&#13;
Name: music&#13;
Description: A library for managing music files&#13;
Version: 1.0.0&#13;
Requires: chooser &gt;= 1.0.1, player &lt; 3.0&#13;
<span class="codeitalic1">--snip--</span></pre>&#13;
<p class="caption" id="ch10ex2"><em>Listing 10-2: Specifying version and version ranges in <code>Requires</code></em></p>&#13;
<p class="indent">The <code>Requires</code> field indicates that two libraries are required here: <em>chooser</em> and <em>player</em>. The version of <em>chooser</em> must be 1.0.1 or higher, and the version of <em>player</em> must be less than 3.0.<sup><a id="ch10fn_2" href="footnote.xhtml#ch10fn2">2</a></sup></p>&#13;
<p class="indent">Finally, the <code>Conflicts</code> field merely allows you as the author of a package to define packages that conflict with your package, and the format of the <span epub:type="pagebreak" id="page_282"/>field is identical to that of <code>Requires</code> and <code>Requires.private</code>. For this field you may provide the same package more than once in order to define specific ranges of versions that conflict with your package.</p>&#13;
<p class="indent">When you’ve completed writing your <em>.pc</em> file, you can validate it using the <code>--validate</code> option:</p>&#13;
<pre>$ <span class="codestrong1">pkg-config --validate test.pc</span>&#13;
$</pre>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>You can use any <em><code>pkg-config</code></em> options that provide field information on either an installed</em> .pc <em>file, by using just the base name of the file, or on an uninstalled</em> .pc <em>file, by specifying the full name of the file, as is done in this example.</em></p>&#13;
</div>&#13;
<p class="indent">If you have any errors that <code>pkg-config</code> can detect, they’ll be displayed. If you see nothing, then you know that <code>pkg-config</code> can at least parse your file properly and that a few basic checks pass.</p>&#13;
<h3 class="h3" id="ch10sec4">Generating .pc Files with Autoconf</h3>&#13;
<p class="noindent">Now that you understand the basic structure of a <em>.pc</em> file, let’s consider how we might use configuration data generated by our configuration scripts to generate a <em>.pc</em> file. Consider the types of information provided by pkg-config. Much of it is path information, and configuration scripts are designed to manage all these paths, including install locations for built products.</p>&#13;
<p class="indent">For example, the user may specify an installation prefix on the <code>configure</code> command line. This prefix determines where the package’s include files and libraries will end up on their system when they install the package. The <em>.pc</em> file had better know these locations, and it would be nice of us to provide a build system that automatically updates this file to reflect the prefix path the user specified on their <code>configure</code> command line.</p>&#13;
<h4 class="h4" id="ch10sec4-1"><em>Generating pc Files from pc.in Templates</em></h4>&#13;
<p class="noindent">To accomplish this, we won’t write <em>.pc</em> files. Instead, we’ll write <em>.pc.in</em> template files for Autoconf and set the value of the <code>prefix</code> variable to <code>@prefix@</code> in these templates. That way, <code>configure</code> will replace this reference with the actual configured prefix when it converts the <em>.pc.in</em> template into the installable <em>.pc</em> file.</p>&#13;
<p class="indent">We can also set the value of the <code>Version</code> field to <code>@PACKAGE_VERSION@</code>, which is defined by the value you pass to the Autoconf <code>AC_INIT</code> macro in <em>configure.ac</em>. To facilitate an experiment, create a <em>configure.ac</em> file in an empty directory, as shown in <a href="ch10.xhtml#ch10ex3">Listing 10-3</a>.</p>&#13;
<pre>AC_INIT([test],[3.1])&#13;
AC_OUTPUT([test.pc])</pre>&#13;
<p class="caption" id="ch10ex3"><em>Listing 10-3:</em> configure.ac: <em>Generating test</em>.pc <em>from</em> test.pc.in</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_283"/>Now create a <em>test.pc.in</em> file in the same directory, like the one shown in <a href="ch10.xhtml#ch10ex4">Listing 10-4</a>.</p>&#13;
<pre><span class="ent">➊</span> prefix=@prefix@&#13;
   libdir=${prefix}/lib/test&#13;
   includedir=${prefix}/include/test&#13;
&#13;
   Name: test&#13;
   Description: A test .pc file&#13;
<span class="ent">➋</span> Version: @PACKAGE_VERSION@&#13;
&#13;
   CFlags: -I${includedir} -std=c11&#13;
   Libs: -L${libdir} -ltest</pre>&#13;
<p class="caption" id="ch10ex4"><em>Listing 10-4:</em> test.pc.in: <em>A</em> .pc <em>template file</em></p>&#13;
<p class="indent">Here we’ve specified the <code>prefix</code> and <code>Version</code> field values at <span class="ent">➊</span> and <span class="ent">➋</span> as Autoconf substitution variable references.</p>&#13;
<p class="indent">Generate the file and check the result:</p>&#13;
<pre>   $ <span class="codestrong1">autoreconf -i</span>&#13;
   $ <span class="codestrong1">./configure --prefix=$HOME/test</span>&#13;
   configure: creating ./config.status&#13;
   config.status: creating test.pc&#13;
   $&#13;
   $ <span class="codestrong1">cat test.pc</span>&#13;
<span class="ent">➊</span> prefix=/home/jcalcote/test&#13;
   libdir=${prefix}/lib/test&#13;
   includedir=${prefix}/include/test&#13;
&#13;
   Name: test&#13;
   Description: A test .pc file&#13;
<span class="ent">➋</span> Version: 3.1&#13;
&#13;
   CFlags: -I${includedir} -std=c11&#13;
   Libs: -L${libdir} -ltest&#13;
   $&#13;
   $ <span class="codestrong1">pkg-config --cflags test.pc</span>&#13;
   -std=c11 -I/home/jcalcote/test/include/test&#13;
   $</pre>&#13;
<p class="indent">As you can see at <span class="ent">➊</span> and <span class="ent">➋</span> in the console output, the Autoconf variable references were replaced in the generated <em>test.pc</em> file with the values of those Autoconf variables.</p>&#13;
<h4 class="h4" id="ch10sec4-2"><em>Generating .pc Files with make</em></h4>&#13;
<p class="noindent">Generating <em>.pc</em> files from templates using Autoconf has the disadvantage of inhibiting the user’s ability to change their prefix choices when they run <code>make</code>. This minor issue can be overcome by writing <em>Makefile.am</em> rules to generate the <em>.pc</em> files. Change the <em>configure.ac</em> file from the previous experiment, as shown in <a href="ch10.xhtml#ch10ex5">Listing 10-5</a>.</p>&#13;
<pre><span epub:type="pagebreak" id="page_284"/><span class="ash">AC_INIT([test],[3.1])</span>&#13;
AM_INIT_AUTOMAKE([foreign])&#13;
<span class="ash">AC_OUTPUT([</span>Makefile<span class="ash">])</span></pre>&#13;
<p class="caption" id="ch10ex5"><em>Listing 10-5:</em> configure.ac: <em>Changes required to <a href="ch10.xhtml#ch10ex3">Listing 10-3</a> to generate</em> test.pc <em>using</em> <code>make</code></p>&#13;
<p class="indent">Now add a <em>Makefile.am</em> file, as shown in <a href="ch10.xhtml#ch10ex6">Listing 10-6</a>.</p>&#13;
<pre>EXTRA_DIST = test.pc&#13;
%.pc : %.pc.in&#13;
        sed -e 's|[@]prefix@|$(prefix)|g'\&#13;
          -e 's|[@]PACKAGE_VERSION@|$(PACKAGE_VERSION)|' $&lt; &gt;$@</pre>&#13;
<p class="caption" id="ch10ex6"><em>Listing 10-6:</em> Makefile.am: <em>Adding</em> <code>make</code> <em>rules to generate</em> test.pc</p>&#13;
<p class="indent">The key functionality in <a href="ch10.xhtml#ch10ex6">Listing 10-6</a> is encapsulated in the pattern rule that converts <em>.pc.in</em> files into <em>.pc</em> files using a simple <code>sed</code> command. The only odd bit in this <code>sed</code> command is the use of square brackets around the leading at (<code>@</code>) sign on the variables to be replaced. Those brackets are treated by <code>sed</code> as extraneous regular expression syntax, but the effect they have on Autoconf is to inhibit it from interpreting the sequence as the opening character of a replacement variable. We don’t want Autoconf replacing this variable. Rather, we want <code>sed</code> to look for the sequence in <em>test.pc.in</em>. Another solution is to come up with your own format for variables to be replaced, but do note that this syntax is fairly common in the Autotools community for this very purpose.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Pattern rules are specific to GNU <em><code>make</code></em> and are therefore not portable. There has been some chatter recently on the Automake mailing list of relaxing the restriction requiring the generation of portable <em><code>make</code></em> syntax and simply requiring GNU <em><code>make</code></em> because GNU <em><code>make</code></em> has been ported so widely these days.</em></p>&#13;
</div>&#13;
<p class="indent">For this example, I’ve added <em>test.pc</em> to the Automake <code>EXTRA_DIST</code> variable so it will be built when <code>make dist</code> or <code>distclean</code> is executed, but you can add <em>test.pc</em> as a prerequisite to any target in your <em>Makefile.am</em> files to make it available to that stage of the build if required. Let’s try it out:</p>&#13;
<pre>$ <span class="codestrong1">autoreconf -i</span>&#13;
configure.ac:2: installing './install-sh'&#13;
configure.ac:2: installing './missing'&#13;
$&#13;
$ <span class="codestrong1">./configure</span>&#13;
checking for a BSD-compatible install... /usr/bin/install -c&#13;
checking whether build environment is sane... yes&#13;
checking for a thread-safe mkdir -p... /bin/mkdir -p&#13;
checking for gawk... gawk&#13;
checking whether make sets $(MAKE)... yes&#13;
checking whether make supports nested variables... yes&#13;
checking that generated files are newer than configure... done&#13;
configure: creating ./config.status&#13;
config.status: creating Makefile&#13;
$&#13;
$ <span class="codestrong1">make prefix=/usr dist</span>&#13;
<span epub:type="pagebreak" id="page_285"/>make    dist-gzip am__post_remove_distdir='@:'&#13;
make[1]: Entering directory '/home/jcalcote/dev/book/autotools2e/book/test'&#13;
sed -e 's|[@]prefix@|/usr|g'\&#13;
            -e 's|[@]PACKAGE_VERSION@|3.1|' test.pc.in &gt;test.pc&#13;
<span class="codeitalic1">--snip--</span>&#13;
$&#13;
$ <span class="codestrong1">cat test.pc</span>&#13;
prefix=/usr&#13;
<span class="codeitalic1">--snip--</span></pre>&#13;
<p class="indent">Note that I added <code>prefix=/usr</code> to the <code>make</code> command line; thus, <em>test.pc</em> was generated with that value in the <code>prefix</code> variable.</p>&#13;
<h3 class="h3" id="ch10sec5">Uninstalled .pc Files</h3>&#13;
<p class="noindent">I mentioned at the outset of this chapter that pkg-config had the ability to handle resolving references to uninstalled libraries and header files also. By <em>uninstalled</em>, I mean products that have been built but not installed; they’re still sitting in another project’s build output directory. Let’s now consider how this is done.</p>&#13;
<p class="indent">To use it, a user would set <code>PKG_CONFIG_PATH</code> to point to a directory containing a <em>-uninstalled</em> variant of a required package’s <em>.pc</em> file. By “<em>-uninstalled</em> variant,” I mean that a <em>.pc</em> file named <em>test.pc</em> would have a <em>-uninstalled</em> variant named <em>test-uninstalled.pc</em>. The <em>-uninstalled</em> variant is not installed in a pkg-config database directory but, rather, is still sitting in the project source directory for the third-party dependency that the user has built. Here’s an example:</p>&#13;
<pre>$ <span class="codestrong1">./configure PKG_CONFIG_PATH=$HOME/required/pkg</span>&#13;
<span class="codeitalic1">--snip</span><span class="codeitalic1">--</span>&#13;
$</pre>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>I’m following the Autoconf recommended procedure here of passing environment variables as parameters to <em><code>configure</code></em>. Setting the variable in the environment or setting it on the same command line before <em><code>configure</code></em> works also, but is not recommended because <em><code>configure</code></em> is less aware of variables set in these other ways.</em></p>&#13;
</div>&#13;
<p class="indent">Assuming <em><code>$HOME</code></em><em>/required/pkg</em> was where the required package was unpacked and built, and assuming the same directory held the (possibly generated) <em>.pc</em> files for that package and that there was a <em>-uninstalled</em> variant in that directory, that file would be accessed by executions of the <code>pkg-config</code> utility that reference the required package’s name from within our <code>configure</code> script.</p>&#13;
<p class="indent">Obviously, you would not want to install the <em>-uninstalled</em> variant of any of your <em>.pc</em> files—they’re designed to be used only in this fashion, from within a build directory. Perhaps not quite as obvious is the fact that the <em>-uninstalled</em> variants of your <em>.pc</em> files don’t contain all the same options as their installed counterparts. The difference, simply stated, is in the path options. The <em>-uninstalled</em> variants should contain absolute paths relative to the source <span epub:type="pagebreak" id="page_286"/>location of your header files and the build location of your libraries so that when the options are passed to consumers’ tools, they’ll be able to find the products (header files and libraries) in those paths.</p>&#13;
<p class="indent">Let’s try it out. Edit the <em>configure.ac</em> file you created from <a href="ch10.xhtml#ch10ex3">Listing 10-3</a> to be like that shown in <a href="ch10.xhtml#ch10ex7">Listing 10-7</a>.</p>&#13;
<pre>AC_INIT([test],[3.1])&#13;
AC_OUTPUT([test.pc <span class="codestrong1">test-uninstalled.pc</span>])</pre>&#13;
<p class="caption" id="ch10ex7"><em>Listing 10-7:</em> configure.ac: <em>Generating the</em> -uninstalled <em>variant of</em> test.pc</p>&#13;
<p class="indent">Absolute paths can be derived by using appropriate Autoconf substitution variables, like <code>@abs_top_srcdir@</code> and <code>@abs_top_builddir@</code>, in the manner shown in <a href="ch10.xhtml#ch10ex8">Listing 10-8</a>.</p>&#13;
<pre><span class="ent">➊</span> libdir=@abs_top_builddir@/lib/test&#13;
<span class="ent">➋</span> includedir=@abs_top_srcdir@/include/test&#13;
&#13;
   Name: test&#13;
   Description: A test .pc file&#13;
<span class="ent">➌</span> Version: @PACKAGE_VERSION@&#13;
&#13;
   CFlags: -I${includedir} -std=c11&#13;
   Libs: -L${libdir} -ltest</pre>&#13;
<p class="caption" id="ch10ex8"><em>Listing 10-8:</em> test-uninstalled.pc: <em>A</em> -uninstalled <em>variant of</em> test.pc.in</p>&#13;
<p class="indent">This is the <em>-uninstalled</em> variant of the <em>.pc</em> file from <a href="ch10.xhtml#ch10ex4">Listing 10-4</a>. I’ve removed the <code>prefix</code> variable, as it no longer makes sense in this context. I’ve replaced the <code>${prefix}</code> references with <code>@abs_top_builddir@</code> in the <code>libdir</code> pkg-config variable at <span class="ent">➊</span> and <code>@abs_top_srcdir@</code> in the <code>includedir</code> pkg-config variable at <span class="ent">➋</span>. Let’s try it out:</p>&#13;
<pre>$ <span class="codestrong1">autoreconf</span>&#13;
$ <span class="codestrong1">./configure</span>&#13;
configure: creating ./config.status&#13;
config.status: creating test.pc&#13;
config.status: creating test-uninstalled.pc&#13;
$ <span class="codestrong1">pkg-config --cflags test.pc</span>&#13;
-std=c11 -I/home/jcalcote/dev/book/autotools2e/book/temp/include/test&#13;
$</pre>&#13;
<p class="indent">You may be asking yourself at this point why this is supposed to be so much easier than just setting <code>CFLAGS</code> (or <code>CPPFLAGS</code>) and <code>LDFLAGS</code> on the <code>configure</code> command line. Well, for one thing, it’s easier to remember <code>PKG_CONFIG_PATH</code> than all of the potentially required individual tool variables. Another reason is the options are encapsulated where they’re best understood—within <em>.pc</em> files written by the required package’s author. Finally, if these options change, you’ll have to change your use of individual variables accordingly, but the <code>PKG_CONFIG_PATH</code> will remain the same. The extra level of indirection afforded by pkg-config hides all the details from both you and your power users and contributors.</p>&#13;
<h3 class="h3" id="ch10sec6"><span epub:type="pagebreak" id="page_287"/>Using pkg-config in configure.ac</h3>&#13;
<p class="noindent">We’ve seen the way <em>.pc</em> files are put together. Now let’s take a look at how to consume this functionality in <em>configure.ac</em>. As mentioned in the previous section, the <code>--cflags</code> option provides access to the <code>Cflags</code> fields your compiler needs in order to compile this package. Let’s try this out with the <em>libssl.pc</em> file we saw previously. I’ve reproduced the relevant portion of <a href="ch10.xhtml#ch10ex1">Listing 10-1</a> here in <a href="ch10.xhtml#ch10ex9">Listing 10-9</a>.</p>&#13;
<pre>prefix=/usr&#13;
<span class="codeitalic1">--snip--</span>&#13;
includedir=${prefix}/include&#13;
<span class="codeitalic1">--snip--</span>&#13;
Cflags: -I${includedir}</pre>&#13;
<p class="caption" id="ch10ex9"><em>Listing 10-9:</em> libssl.pc: <em>Relevant portion of this</em> .pc <em>file</em></p>&#13;
<p class="indent">When we use the <code>--cflags</code> option against this <em>.pc</em> file, we now understand that we should see a <code>-I</code> compiler command line option.</p>&#13;
<pre>$ <span class="codestrong1">pkg-config --cflags libssl</span>&#13;
&#13;
$</pre>&#13;
<p class="indent">And . . . nothing is printed. Huh, did we do something wrong? The <em>libssl.pc</em> file shows us that if we mentally expand the variables, we should see something like <code>-I/usr/include</code>, right? Actually, <code>pkg-config</code> is doing exactly what it should do—it’s printing <em>the additional command line options</em> necessary to find the <em>libssl</em> header files. We don’t need to tell the compiler about the <em>/usr</em><em>/include</em> directory, as this is a standard location and <code>pkg-config</code> knows this and omits such options automatically.<sup><a id="ch10fn_3" href="footnote.xhtml#ch10fn3">3</a></sup></p>&#13;
<p class="indent">Let’s try a <em>.pc</em> file whose <code>Cflags</code> value includes something other than standard include locations. Note here that I’m using <code>pkg-config</code> itself to find the location of its database directory for the <em>xorg-wacom.pc</em> file because it’s different on different Linux distributions:</p>&#13;
<pre>$ <span class="codestrong1">cat $(pkg-config --variable pcfiledir xorg-wacom)/xorg-wacom.pc</span>&#13;
sdkdir=/usr/include/xorg&#13;
&#13;
Name: xorg-wacom&#13;
Description: X.Org Wacom Tablet driver.&#13;
Version: 0.32.0&#13;
Cflags: -I${sdkdir}&#13;
$&#13;
$ <span class="codestrong1">pkg-config --cflags xorg-wacom</span>&#13;
-I/usr/include/xorg&#13;
$</pre>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_288"/>Since <em>/usr/include/xorg</em> is not a standard include path, a <code>-I</code> option for that path is displayed.<sup><a id="ch10fn_4" href="footnote.xhtml#ch10fn4">4</a></sup> All of this means that you can be complete in documenting your package’s requirements in your <em>.pc</em> files without worrying about cluttering consumer compiler and linker command lines with pointless redundant definitions.</p>&#13;
<p class="indent">So, how do we use this output? Nothing more difficult than a little shell script, as shown in <a href="ch10.xhtml#ch10ex10">Listing 10-10</a>.</p>&#13;
<pre><span class="codeitalic1">--snip--</span>&#13;
<span class="codestrong1">LIBSSL_CFLAGS=$(pkg-config --cflags libssl)</span>&#13;
<span class="codeitalic1">--snip--</span></pre>&#13;
<p class="caption" id="ch10ex10"><em>Listing 10-10: Using <code>pkg-config</code> to populate <code>CFLAGS</code> in</em> configure.ac</p>&#13;
<p class="indent">The dollar-parens notation captures the output of this <code>pkg-config</code> command in the <code>LIBSSL_CFLAGS</code> environment variable.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>You may, of course, use backticks rather than the dollar-parens notation I used in <a href="ch10.xhtml#ch10ex10">Listing 10-10</a> to accomplish the same goal. The backtick format is older and slightly more portable, but it has the drawback of not being easily nestable. For example, you cannot do something like <em><code>$(pkg-config --cflags $(cat libssl-pc-file.txt))</code></em> with backticks without a lot of escape magic.</em></p>&#13;
</div>&#13;
<p class="indent">The linker options are accessed in a similar manner:</p>&#13;
<pre>$ <span class="codestrong1">pkg-config --libs libssl</span>&#13;
-lssl&#13;
$</pre>&#13;
<p class="indent">Referring back to the <em>libssl.pc</em> file in <a href="ch10.xhtml#ch10ex1">Listing 10-1</a>, we can indeed see that the <code>Libs</code> line contained <code>-lssl</code>. Also, as we just discovered, the <code>-L</code> option, referring a standard linker location, <em>/usr/lib/x86_64-linux-gnu</em>, was automatically omitted. We can add this to our <em>configure.ac</em> file in the manner shown in <a href="ch10.xhtml#ch10ex11">Listing 10-11</a>.</p>&#13;
<pre><span class="codeitalic1">--snip--</span>&#13;
<span class="codestrong1">LIBSSL_LIBS=$(pkg-config --libs libssl)</span>&#13;
<span class="codeitalic1">--snip--</span></pre>&#13;
<p class="caption" id="ch10ex11"><em>Listing 10-11: Using <code>pkg-config</code> to populate <code>LIBS</code> in</em> configure.ac</p>&#13;
<p class="indent">Let’s tie it all together by populating all required variables for compiling <em>libssl</em> header files and linking with <em>libssl</em>. <a href="ch10.xhtml#ch10ex12">Listing 10-12</a> shows how this might be done.</p>&#13;
<pre><span epub:type="pagebreak" id="page_289"/><span class="codeitalic1">--snip--</span>&#13;
<span class="codestrong1">if pkg-config --atleast-version=1.0.2 libssl; then</span>&#13;
  LIBSSL_CFLAGS=$(pkg-config --cflags libssl)&#13;
  LIBSSL_LIBS=$(pkg-config --libs libssl)&#13;
<span class="codestrong1">else</span>&#13;
  <span class="codestrong1">m4_fatal([Requires libssl v1.0.2 or higher])</span>&#13;
<span class="codestrong1">fi</span>&#13;
<span class="codeitalic1">--snip--</span>&#13;
<span class="codestrong1">CFLAGS="${CFLAGS} ${LIBSSL_CFLAGS}"</span>&#13;
<span class="codestrong1">LIBS="${LIBS} ${LIBSSL_LIBS}"</span>&#13;
<span class="codeitalic1">--snip--</span></pre>&#13;
<p class="caption" id="ch10ex12"><em>Listing 10-12: Using <code>pkg-config</code> to access</em> libssl <em>in</em> configure.ac</p>&#13;
<p class="indent">Could it be any simpler or any more readable? I doubt it. Let’s look at one more example—that of linking statically to <em>libssl</em>, which also requires (privately) <em>libcrytpo</em>:</p>&#13;
<pre>   $ <span class="codestrong1">cat $(pkg-config --variable pcfiledir libssl)/libssl.pc</span>&#13;
   prefix=/usr&#13;
   exec_prefix=${prefix}&#13;
   libdir=${exec_prefix}/lib/x86_64-linux-gnu&#13;
   includedir=${prefix}/include&#13;
&#13;
   Name: OpenSSL-libssl&#13;
   Description: Secure Sockets Layer and cryptography libraries&#13;
   Version: 1.0.2g&#13;
<span class="ent">➊</span> Requires.private: libcrypto&#13;
   Libs: -L${libdir} -lssl&#13;
<span class="ent">➋</span> Libs.private: -ldl&#13;
   Cflags: -I${includedir}&#13;
   $&#13;
   $ <span class="codestrong1">cat $(pkg-config --variable pcfiledir libcrypto)/libcrypto.pc</span>&#13;
   prefix=/usr&#13;
   exec_prefix=${prefix}&#13;
   libdir=${exec_prefix}/lib/x86_64-linux-gnu&#13;
   includedir=${prefix}/include&#13;
&#13;
   Name: OpenSSL-libcrypto&#13;
   Description: OpenSSL cryptography library&#13;
   Version: 1.0.2g&#13;
   Requires:&#13;
   Libs: -L${libdir} -lcrypto&#13;
<span class="ent">➌</span> Libs.private: -ldl&#13;
   Cflags: -I${includedir}&#13;
   $&#13;
   $ <span class="codestrong1">pkg-config --static --libs libssl</span>&#13;
<span class="ent">➍</span> -lssl -ldl -lcrypto -ldl&#13;
   $</pre>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_290"/>As you can see in this console example at <span class="ent">➊</span>, <em>libssl</em> privately requires the pkg-config-managed <em>libcrypto</em> package, meaning that linking to the <em>libssl</em> shared library does not require the addition of <code>-lcrypto</code> on the linker command line, but linking to it statically does require this additional library option. We can also see at <span class="ent">➋</span> that <em>libssl</em> privately requires a library that’s not maintained by pkg-config, <em>libdl.so</em>.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>You may find the contents of your</em> libssl.pc <em>and</em> libcrypto.pc <em>files are somewhat different from mine, depending on your Linux distribution and the version of openssl you have installed. Don’t worry about the differences—things will work fine on your system with your</em> .pc <em>files. The important part of this example is to understand the concepts I’m explaining.</em></p>&#13;
</div>&#13;
<p class="indent">Moving down to the <em>libcrypto.pc</em> file, we see at <span class="ent">➌</span> that <em>libcrypto</em> also privately requires <em>libdl.so</em>.</p>&#13;
<p class="indent">The noteworthy item at <span class="ent">➍</span> is that pkg-config is “smart enough” to understand the linker’s library ordering requirements and set <code>-ldl</code> on the output line after both <code>-lssl</code> and <code>-lcrypto</code>.<sup><a id="ch10fn_5" href="footnote.xhtml#ch10fn5">5</a></sup> We humans have a hard enough time doing this stuff manually at times. It’s nice when a tool comes along that just manages everything the way it should without making us worry about how it’s done. Ultimately, the point I’m trying to make is that pkg-config puts control of the options squarely in the hands of the person most likely to understand how all these options should be specified and ordered—the maintainer of our dependencies.</p>&#13;
<h3 class="h3" id="ch10sec7">pkg-config Autoconf Macros</h3>&#13;
<p class="noindent">As I mentioned at the outset of this chapter, pkg-config also ships a set of Autoconf extension macros in a file called <em>pkg.m4</em> that’s installed into the <em>/usr</em><em>(/local)/share/aclocal</em> directory, which is where <code>autoconf</code> looks for <em>.m4</em> files containing the Autoconf standard macros that you can use in your <em>configure.ac</em> files.</p>&#13;
<p class="indent">Why didn’t I use these in my examples? Well, there are a couple of reasons why I tend to avoid these macros, one obvious and the other more subtle—nefarious even. The obvious reason is how easy it is to use the <code>pkg-config</code> utility directly in shell script in <em>configure.ac</em>. Why would you try to wrap that in an M4 macro?</p>&#13;
<p class="indent">As for the second reason, recall from previous discussions that the input to <code>autoconf</code> is a data stream containing the contents of your <em>configure.ac</em> file, along with all of the macro definitions required to allow M4 to expand all macro invocations into shell script. These macro definitions become part of the input stream because <code>autoconf</code> reads all of the <em>.m4</em> files in the <span epub:type="pagebreak" id="page_291"/><em>/usr</em><em>(/local)/share/aclocal</em> directory first, before reading your <em>configure.ac</em> file. In other words, there is no indication to <code>autoconf</code> that a required <em>.m4</em> file is missing. It simply expects all macro definitions required by <em>configure.ac</em> to be found in the <em>.m4</em> files in the installation paths’ <em>aclocal</em> directory. As a result, <code>autoconf</code> cannot tell you if a macro definition in the input stream is not present. It simply fails to realize that <code>PKG_CHECK_MODULES</code> is a macro and, therefore, does not expand it to valid shell script. All of this happens when you run <code>autoconf</code> (or <code>autoreconf</code>). When you then try to run <code>configure</code>, it fails with messages that are so far removed from the actual problem that you couldn’t possibly know just from reading them what they mean.</p>&#13;
<p class="indent">A picture is worth a thousand words, so let’s try a quick experiment. Create a <em>configure.ac</em> file in an empty directory, as shown in <a href="ch10.xhtml#ch10ex13">Listing 10-13</a>.</p>&#13;
<pre>AC_INIT([test],[1.0])&#13;
AN_UNDEFINED_MACRO()</pre>&#13;
<p class="caption" id="ch10ex13"><em>Listing 10-13: A</em> configure.ac <em>file with an unknown</em> macro <em>expansion</em></p>&#13;
<p class="indent">Now execute <code>autoconf</code>, followed by <code>./configure</code>:</p>&#13;
<pre>$ <span class="codestrong1">autoconf</span>&#13;
$ <span class="codestrong1">./configure</span>&#13;
./configure: line 1675: syntax error: unexpected end of file&#13;
$</pre>&#13;
<p class="indent">Notice how you get no error while <code>autoconf</code> is converting <em>configure.ac</em> into <em>configure</em>. This makes complete sense because <code>m4</code>, being a text-based macro processor, doesn’t try to interpret anything in the data stream except for known macros. Everything else is passed directly though to the output stream, as if it were actual shell script.</p>&#13;
<p class="indent">When we ran <code>configure</code>, we got a cryptic error about unexpected end-of-file (at line 1675. . . from a two-line <em>configure.ac</em> file). What’s really happening here is that you unintentionally started defining a shell function called <code>AN_UNDEFINED_MACRO</code> but didn’t supply a body in curly braces for the function. The shell thought this was not cool and told you about it in its usual succinct manner.</p>&#13;
<p class="indent">Had we left the parentheses off of <code>AN_UNDEFINED_MACRO</code>, the shell would have been a bit more informational:</p>&#13;
<pre>$ <span class="codestrong1">cat configure.ac</span>&#13;
AC_INIT([test],[1.0])&#13;
AN_UNDEFINED_MACRO&#13;
$ <span class="codestrong1">./configure</span>&#13;
./configure: line 1674: AN_UNDEFINED_MACRO: command not found&#13;
$</pre>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_292"/>At least this time, the shell told us the name of the problematic item, giving us the opportunity to go looking for it in <em>configure.ac</em> and perhaps figure out what’s wrong.<sup><a id="ch10fn_6" href="footnote.xhtml#ch10fn6">6</a></sup></p>&#13;
<p class="indent">The point is, this is exactly what happens when you <em>think</em> you’re using a pkg-config macro but <em>pkg.m4</em> was not found by <code>autoconf</code> while it was looking through the usual macro directories. Not very enlightening. In my humble opinion, you’re much better off just skipping the hundreds of lines of nontransparent macro code and using <code>pkg-config</code> directly in your <em>configure.ac</em> file.</p>&#13;
<p class="indent">The reasons why <code>autoconf</code> might not find your installed <em>pkg.m4</em> file are enlightening, however. One common reason is that you installed the <em>pkg-config</em> package (or it was automatically installed when the OS was installed) from your distro’s package repository, using <code>yum</code> or <code>apt</code>. But you downloaded, built, and installed Autoconf from the GNU website because your distro’s version of Autoconf is four revisions behind and you need the latest. Where did pkg-config’s installation process install <em>pkg.m4</em>? (Hint: <em>/usr/share/aclocal</em>.) Where is <code>autoconf</code> getting its macro files from? (Hint: <em>/usr/</em>local<em>/share/aclocal</em>.) You can, of course, easily remedy this problem by copying <em>/usr/share/aclocal/pkg.m4</em> into <em>/usr/local/share/aclocal</em>, and once you’ve hit this problem one or two times, you’ll never be caught by it again. But your power users and contributors will have to go through the same process—or you could just tell them all to buy this book and read <a href="ch10.xhtml">Chapter 10</a>.</p>&#13;
<h3 class="h3" id="ch10sec8">Summary</h3>&#13;
<p class="noindent">In this chapter, we’ve discussed the benefits of using Autoconf with pkg-config, how to generate <em>.pc</em> files from Autoconf templates, how to use <code>pkg-config</code> from <em>configure.ac</em> files, and various nuances of pkg-config features.</p>&#13;
<p class="indent">You can read <em>somewhat</em> more about the proper use of the <em>pkg-config</em> package on the official pkg-config website at <em><a href="https://www.freedesktop.org/wiki/Software/pkg-config">https://www.freedesktop.org/wiki/Software/pkg-config</a></em>. Dan Nicholson has written a concise and easy-to-follow tutorial on using pkg-config on his personal page at <a href="http://freedesktop.org">freedesktop.org</a> (<em><a href="http://people.freedesktop.org/~dbn/pkg-config-guide.html">http://people.freedesktop.org/~dbn/pkg-config-guide.html</a></em>). This page can also be accessed via links on the pkg-config website.</p>&#13;
<p class="indent">The <em>pkg-config</em> man page has a bit more information about the proper use of <code>pkg-config</code>, but, honestly, there isn’t much more out there, other than blog entries written by enterprising individuals. Thankfully, there really isn’t very much more to figure out about pkg-config. It’s well written and well documented (as far as software goes), with a few minor exceptions, which I’ve tried to cover here.</p>&#13;
</body></html>