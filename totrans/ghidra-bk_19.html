<html><head></head><body><div id="sbo-rt-content"><span epub:type="pagebreak" id="page_341"/>
<h2 class="h2" id="ch16"><strong><span class="big">16</span><br/>GHIDRA IN HEADLESS MODE</strong></h2>
<div class="image1"><img src="Images/com.jpg" alt="Image" width="204" height="204"/></div>
<p class="noindent">In earlier chapters, we focused on exploring a single file within a single project, facilitated by the Ghidra GUI. In addition to the GUI, Ghidra has a command line interface called the <em>Ghidra headless analyzer</em>. The headless analyzer provides some of the same capabilities as the Ghidra GUI, including the ability to work with projects and files, but it’s better suited for batch processing and scripted control of Ghidra. In this chapter, we discuss Ghidra’s headless mode and how it can help you perform repetitive tasks across a larger number of files. We start with a familiar example and then expand our discussion to more complex options.</p>
<span epub:type="pagebreak" id="page_342"/>
<h3 class="h3" id="ch16lev287"><strong>Getting Started</strong></h3>
<p class="noindent">Let’s start by recalling our first use of Ghidra in <a href="ch04.xhtml#ch04">Chapter 4</a>. We successfully accomplished the following steps:</p>
<ol>
<li class="noindent">Launch Ghidra.</li>
<li class="noindent">Create a new Ghidra project.</li>
<li class="noindent">Identify a location for the project.</li>
<li class="noindent">Import a file to the project.</li>
<li class="noindent">Auto analyze the file.</li>
<li class="noindent">Save and exit.</li>
</ol>
<p class="indent">Let’s replicate these tasks using the Ghidra headless analyzer’s command line interface. The headless analyzer (<em>analyzeHeadless</em> or <em>analyzeHeadless.bat</em>) as well as a helpful file called <em>analyzeHeadlessREADME.html</em> can be found in the <em>support</em> directory of your Ghidra installation. To simplify file paths, we have temporarily placed the file <em>global_array_demo_x64</em> in the same directory. First, we will identify the commands and parameters needed for each of the individual tasks and then we will put them all together to accomplish our goal. While it hasn’t made a significant difference in previous chapters, there are more distinctions between the three Ghidra platforms when we are operating from the command line. In our examples, we use the Windows installation and make note of significant differences on other platforms.</p>
<div class="box5">
<p class="boxtitle-c"><strong>TO SLASH OR BACKSLASH?</strong></p>
<p class="noindent">A major difference among the operating system platforms that support Ghidra is the manner in which they identify filesystem paths. While the syntax is consistent, different platforms use different directory separators. Windows uses a backward slash, whereas Linux and macOS use a forward slash. A path looks like this in Windows:</p>
<p class="programs">D:\GhidraProjects\ch16\demo_stackframe_32</p>
<p class="indent">And it looks like this in Linux and macOS:</p>
<p class="programs">/GhidraProjects/ch16/demo_stackframe_32</p>
<p class="indent">This syntax can be even more confusing for Windows users as forward slashes are used in URLs and command line switches (and Ghidra documentation). Operating systems recognize this issue and try to accept either, but not always in a predictable manner. For the examples in this chapter, we use the Windows convention so readers can enjoy being backward compatible with DOS.</p>
</div>
<span epub:type="pagebreak" id="page_343"/>
<h4 class="h4" id="ch16lev288"><strong><em>Step 1: Launch Ghidra</em></strong></h4>
<p class="noindent">This step is accomplished using the <span class="literal">analyzeHeadless</span> command. All additional steps will be accomplished using the parameters and options associated with this command. Running <span class="literal">analyzeHeadless</span> without any parameters displays a usage message with the command’s syntax and options, as shown in <a href="ch16.xhtml#fig16_1">Figure 16-1</a>. To launch Ghidra, we need to add some of these parameters to the command.</p>
<div class="image"><img src="Images/fig16-1.jpg" alt="image" width="592" height="415"/></div>
<p class="figcap" id="fig16_1"><em>Figure 16-1: Headless analyzer syntax</em></p>
<h4 class="h4" id="ch16lev289"><strong><em>Steps 2 and 3: Create a New Ghidra Project in a Specified Location</em></strong></h4>
<p class="noindent">In headless mode, Ghidra creates a project for you if the project does not already exist. If the project already exists in the specified location, Ghidra opens the existing project. As a result, two parameters are required: the project location and the project name. The following command creates a project named <em>CH16</em> in our <em>D:\GhidraProjects</em> directory:</p>
<p class="programs">analyzeHeadless D:\GhidraProjects CH16</p>
<p class="indent">This is a minimal launch of headless Ghidra to open a project and accomplishes nothing more. In fact, the response message from Ghidra tells you exactly that:</p>
<p class="programs">Nothing to do...must specify -import, -process, or prescript and/or postscript.</p>
<span epub:type="pagebreak" id="page_344"/>
<h4 class="h4" id="ch16lev290"><strong><em>Step 4: Import a File to the Project</em></strong></h4>
<p class="noindent">To import a file, Ghidra requires the <span class="literal">-import</span> option and the name of the file to import. We will import <em>global_array_demo_x64</em>, which we have used in the past. As mentioned, for simplicity in this initial example, we have placed the file in the <em>support</em> directory. Alternatively, we could specify the full path to the file on the command line. We add the <span class="literal">-import</span> option to our command:</p>
<p class="programs">analyzeHeadless D:\GhidraProjects CH16 -import global_array_demo_x64</p>
<h4 class="h4" id="ch16lev291"><strong><em>Steps 5 and 6: Auto Analyze the File, Save, and Exit</em></strong></h4>
<p class="noindent">In headless mode, auto analysis and saving happen by default, so the command in step 4 accomplishes everything we want. An option is required to <em>not</em> analyze the file (<span class="literal">-noanalysis</span>), and there are options available to control how the project and associated files are saved.</p>
<p class="indent">Here is our completed command to accomplish our six objectives:</p>
<p class="programs">analyzeHeadless D:\GhidraProjects CH16 -import global_array_demo_x64</p>
<p class="indent">As with many console commands, you may be asking yourself, “How can I be sure anything has happened?” Your first sign of success (or failure) is the messages displayed at the console. Informational messages that start with the prefix <span class="literal">INFO</span> provide progress reports as the headless analyzer starts its work. Error messages start with the prefix <span class="literal">ERROR</span>. <a href="ch16.xhtml#exa16_1">Listing 16-1</a> includes a subset of the messages, including an error message.</p>
<p class="programs"><span class="ent">➊</span> INFO  HEADLESS Script Paths:<br/>
      C:\Users\Ghidrabook\ghidra_scripts<br/>
   <span class="ent">➋</span> D:\ghidra_PUBLIC\Ghidra\Extensions\SimpleROP\ghidra_scripts<br/>
      D:\ghidra_PUBLIC\Ghidra\Features\Base\ghidra_scripts<br/>
      D:\ghidra_PUBLIC\Ghidra\Features\BytePatterns\ghidra_scripts<br/>
      D:\ghidra_PUBLIC\Ghidra\Features\Decompiler\ghidra_scripts<br/>
      D:\ghidra_PUBLIC\Ghidra\Features\FileFormats\ghidra_scripts<br/>
      D:\ghidra_PUBLIC\Ghidra\Features\FunctionID\ghidra_scripts<br/>
      D:\ghidra_PUBLIC\Ghidra\Features\GnuDemangler\ghidra_scripts<br/>
      D:\ghidra_PUBLIC\Ghidra\Features\Python\ghidra_scripts<br/>
      D:\ghidra_PUBLIC\Ghidra\Features\VersionTracking\ghidra_scripts<br/>
      D:\ghidra_PUBLIC\Ghidra\Processors\8051\ghidra_scripts<br/>
      D:\ghidra_PUBLIC\Ghidra\Processors\DATA\ghidra_scripts<br/>
      D:\ghidra_PUBLIC\Ghidra\Processors\PIC\ghidra_scripts(HeadlessAnalyzer)<br/>
   INFO  HEADLESS: execution starts (HeadlessAnalyzer)<br/>
   INFO  Opening existing project: D:\GhidraProjects\CH16 (HeadlessAnalyzer)<br/>
<span class="ent">➌</span> ERROR Abort due to Headless analyzer error:<br/>
      ghidra.framework.store.LockException:<br/>
      Unable to lock project! D:\GhidraProjects\CH16 (HeadlessAnalyzer)<br/>
      java.io.IOException: ghidra.framework.store.LockException:<br/>
      Unable to lock project! D:\GhidraProjects\CH16<br/>
      ...</p>
<p class="ex-caption" id="exa16_1"><em>Listing 16-1: Headless analyzer with error condition</em></p>
<span epub:type="pagebreak" id="page_345"/>
<p class="indent">The script paths used in headless mode are listed <span class="ent">➊</span>. Later in the chapter, we show how to use additional scripts with our headless commands. The extension we created in the preceding chapter, SimpleROP, is included in the script path <span class="ent">➋</span> because every extension adds a new path to the script path. The <span class="literal">LockException</span> <span class="ent">➌</span> is perhaps the most common error associated with the headless analyzer. The headless analyzer fails if you attempt to run it on a project that you already have open in another Ghidra instance. When this occurs, the headless analyzer is unable to lock the project for its own, exclusive use, so the command fails.</p>
<p class="indent">To fix the error, close any running Ghidra instance that has the <em>CH16</em> project open and run the command again. <a href="ch16.xhtml#fig16_2">Figure 16-2</a> shows the tail end of the output for successful execution of our command, which is similar to the pop-up windows that we see when analyzing files in the Ghidra GUI.</p>
<div class="image"><img src="Images/fig16-2.jpg" alt="image" width="592" height="658"/></div>
<p class="figcap" id="fig16_2"><em>Figure 16-2: Headless analyzer results displayed to the console</em></p>
<p class="indent">To verify the results in the Ghidra GUI, open the project and confirm that the file has been loaded, as shown in <a href="ch16.xhtml#fig16_3">Figure 16-3</a>, and then open the file in the CodeBrowser to confirm analysis.</p>
<span epub:type="pagebreak" id="page_346"/>
<div class="image"><img src="Images/fig16-3.jpg" alt="image" width="441" height="553"/></div>
<p class="figcap" id="fig16_3"><em>Figure 16-3: Ghidra GUI confirmation that the project has been created and the file loaded</em></p>
<p class="indent">Now that we have replicated our earlier analysis using Ghidra in headless mode, let’s investigate some situations where headless mode has an advantage over the GUI. To create a project and load and analyze all of the files shown in <a href="ch16.xhtml#fig16_4">Figure 16-4</a> using the Ghidra GUI, we could create the project and then load each file individually, or select files to include in a batch import operation, as discussed in “<a href="ch16.xhtml#ch16lev304">Batch Import</a>” on <a href="ch11.xhtml#page_226">page 226</a>. Headless Ghidra allows us to name a directory and analyze all contained files.</p>
<div class="image"><img src="Images/fig16-4.jpg" alt="image" width="302" height="312"/></div>
<p class="figcap" id="fig16_4"><em>Figure 16-4: Input directory for headless Ghidra examples</em></p>
<span epub:type="pagebreak" id="page_347"/>
<p class="indent">The following command tells the headless analyzer to open or create a project named <em>CH16</em> in the <em>D:\GhidraProjects</em> directory and import and analyze all of the files in the <em>D:\ch16</em> directory:</p>
<p class="programs">analyzeHeadless D:\GhidraProjects CH16 -import D:\ch16</p>
<p class="indent">After the command is executed, we can load the new project into the Ghidra GUI and see its associated files, as shown in <a href="ch16.xhtml#fig16_5">Figure 16-5</a>. The subdirectory <em>D:\ch16\CH16_subdirectory</em> does not appear in the project, nor do any of the files within the subdirectory. We will come back to this when we discuss additional options and parameters that can be used with headless Ghidra in the following section.</p>
<div class="image"><img src="Images/fig16-5.jpg" alt="image" width="472" height="445"/></div>
<p class="figcap" id="fig16_5"><em>Figure 16-5: Project resulting from pointing headless Ghidra at a directory</em></p>
<h4 class="h4" id="ch16lev292"><strong><em>Options and Parameters</em></strong></h4>
<p class="noindent">The simple examples of using headless Ghidra to create a project, load and analyze a single file, and use batch processing to import an entire directory are just the beginning of what is possible. While we will not be able to discuss all capabilities of headless Ghidra, we will provide a brief introduction to each of the options currently available.</p>
<h5 class="h5" id="ch16lev293"><strong>General Options</strong></h5>
<p class="noindent">The following are brief descriptions with related examples of additional options that we could use to further control what is happening in our simple examples. (Wrapped lines are indented.) When encountered, common error conditions are discussed. Specialized error conditions are left as an exercise for the reader in the comfort of the Ghidra Help file.</p>
<span epub:type="pagebreak" id="page_348"/>
<p class="listhead"><span class="codestrong">-log</span> <span class="EmpStrongItalic">logfilepath</span></p>
<p class="listbody">Many things can go wrong (and right) when executing from the command line. Fortunately, Ghidra plugins provide continuous feedback as to what is happening while Ghidra is running. While this feedback is less vital in the Ghidra GUI (because you have visual cues as to what is happening), it is important in headless Ghidra.</p>
<p class="listbody1">By default, a logfile is written to <em>.ghidra/.ghidra_&lt;VER&gt;_PUBLIC</em>/<em>application.log</em> in the user’s home directory. You may select a new location by adding the <span class="literal">-log</span> option to your command line. To create a directory, <em>CH16-logs</em>, and write a logfile to <em>CH16-logfile</em>, use the following command:</p>
<p class="programs">analyzeHeadless D:\GhidraProjects CH16 -import global_array_demo_x64<br/>
  -log D:\GhidraProjects\CH16-logs\CH16-Logfile</p>
<p class="listhead"><span class="codestrong">-noanalysis</span></p>
<p class="listbody">This option instructs Ghidra not to analyze any files that you import from the command line. Opening the file <em>global_array_demo_x64</em> in the Ghidra GUI after the following statement is executed would present you with a loaded, but not analyzed, version of the file within the <em>CH16</em> project:</p>
<p class="programs">analyzeHeadless D:\GhidraProjects CH16 -import global_array_demo_x64<br/>
  -noanalysis</p>
<p class="listhead"><span class="codestrong">-overwrite</span></p>
<p class="listbody">In <a href="ch16.xhtml#exa16_1">Listing 16-1</a>, we saw an error condition when Ghidra tried to open a project that was already open. A second common error occurs when Ghidra tries to import a file into a project and the file has already been imported. To import a new version of the file, or overwrite the existing file regardless of contents, use the <span class="literal">-overwrite</span> option. Without this option, running the following headless command twice would result in an error during the second execution. With this option, we can rerun the command as many times as we wish:</p>
<p class="programs">analyzeHeadless D:\GhidraProjects CH16 -import global_array_demo_x64<br/>
  -overwrite</p>
<p class="listhead"><span class="codestrong">-readOnly</span></p>
<p class="listbody">To import a file without saving the file in the project, use the <span class="literal">-readOnly</span> option. If you use this option, the <span class="literal">-overwrite</span> option will be ignored (if present). This option also has meaning when used with the <span class="literal">-process</span> option rather than the <span class="literal">-import</span> command. The <span class="literal">-process</span> option is covered later in the chapter.</p>
<p class="programs">analyzeHeadless D:\GhidraProjects CH16 -import global_array_demo_x64<br/>
  -readOnly</p>
<span epub:type="pagebreak" id="page_349"/>
<p class="listhead"><span class="codestrong">-deleteProject</span></p>
<p class="listbody">This option instructs Ghidra not to save any project being created with the <span class="literal">–import</span> option. This option can be used with any of the other options but is assumed (even if omitted) when using <span class="literal">-readOnly</span>. The newly created project is deleted after analysis is complete. This option will not delete an existing project:</p>
<p class="programs">analyzeHeadless D:\GhidraProjects CH16 -import global_array_demo_x64<br/>
  -deleteProject</p>
<p class="listhead"><span class="codestrong">-recursive</span></p>
<p class="listbody">By default, Ghidra does not recurse into subdirectories when asked to process an entire directory. Use this option when you do want Ghidra to perform recursive directory processing (that is, process any subdirectories it finds along the way). To demonstrate this functionality, we will point Ghidra at the same <em>ch16</em> directory we processed earlier, but this time will use the <span class="literal">-recursive</span> option:</p>
<p class="programs">analyzeHeadless D:\GhidraProjects CH16 -import D:\ch16 -recursive</p>
<p class="indent">Opening the project, <em>CH16</em>, after running this command results in the project structure shown in <a href="ch16.xhtml#fig16_6">Figure 16-6</a>. In contrast to <a href="ch16.xhtml#fig16_5">Figure 16-5</a>, the <em>CH16_subdirectory</em> is included in the project as well as its associated file, and the directory hierarchy is retained within the project hierarchy.</p>
<div class="image"><img src="Images/fig16-6.jpg" alt="image" width="472" height="484"/></div>
<p class="figcap" id="fig16_6"><em>Figure 16-6: Headless Ghidra project resulting from the</em> <span class="codeitalic">-recursive</span> <em>option</em></p>
<span epub:type="pagebreak" id="page_350"/>
<div class="box5">
<p class="boxtitle-c"><strong>WILDCARDS!</strong></p>
<p class="noindent">Wildcards provide an easy method to select multiple files for headless Ghidra without listing each one separately. In short, an asterisk (<span class="literal">*</span>) matches any sequence of characters, and a question mark (<span class="literal">?</span>) matches a single character. To load and analyze only the 32-bit files from <a href="ch16.xhtml#fig16_7">Figure 16-7</a>, use a wildcard as follows:</p>
<p class="programs">analyzeHeadless D:\GhidraProjects CH16 -import D:\ch16\demo_stackframe_32*</p>
<p class="indent">This creates the CH16 project and loads and analyzes all of the 32-bit files in the <em>ch16</em> directory. The resulting project is shown in <a href="ch16.xhtml#fig16_7">Figure 16-7</a>. See <em>analyzeHeadlessREADME.html</em> for detailed information about using wildcards to specify files for import and processing. You will also see wildcards in future headless Ghidra scripting examples.</p>
<div class="image"><img src="Images/fig16-7.jpg" alt="image" width="473" height="339"/></div>
<p class="figcap" id="fig16_7"><em>Figure 16-7: Project files resulting from the wildcard</em> <span class="codeitalic">demo_stackframe_32*</span></p>
</div>
<p class="listhead"><span class="codestrong">-analysisTimeoutPerFile</span> <span class="EmpStrongItalic">seconds</span></p>
<p class="listbody">As you have analyzed (or sat and watched Ghidra analyze) files, you may have noticed several factors that impact the analysis time, like the size of the file, whether it’s statically linked, and the decompiler analysis options. Regardless of the file contents and options, you can’t know in advance exactly how long it may take to analyze a file.</p>
<p class="listbody1">In headless Ghidra, particularly when you are processing a large number of files, you can use the <span class="literal">-analysisTimeoutPerFile</span> option to ensure that your task ends in a reasonable amount of time. With this option, you specify a time-out in seconds, and analysis will be interrupted should time expire. For example, our existing headless Ghidra command takes a little over one second to analyze on our system (refer to <span epub:type="pagebreak" id="page_351"/><a href="ch16.xhtml#fig16_2">Figure 16-2</a>). If we had <em>really</em> limited time to execute this script, the following headless command would stop analysis after one second:</p>
<p class="programs">analyzeHeadless D:\GhidraProjects CH16 -import global_array_demo_x64<br/>
  -analysisTimeoutPerFile 1</p>
<p class="indent">This would result in the console display shown in <a href="ch16.xhtml#fig16_8">Figure 16-8</a>.</p>
<div class="image"><img src="Images/fig16-8.jpg" alt="image" width="593" height="222"/></div>
<p class="figcap" id="fig16_8"><em>Figure 16-8: Console warning that analysis timed out</em></p>
<p class="listhead"><span class="codestrong">-processor</span> <span class="EmpStrongItalic">languageID</span> and <span class="codestrong">-cspec</span> <span class="EmpStrongItalic">compilerSpecID</span></p>
<p class="listbody">As shown in previous examples, Ghidra is generally quite good at identifying information about a file and making import recommendations. A sample window showing the recommendations for a particular file is shown in <a href="ch16.xhtml#fig16_9">Figure 16-9</a>. This window is displayed every time you use the GUI to import a file into a project.</p>
<div class="image"><img src="Images/fig16-9.jpg" alt="image" width="575" height="339"/></div>
<p class="figcap" id="fig16_9"><em>Figure 16-9: Ghidra GUI import confirmation dialog</em></p>
<p class="indent">If you feel that you have additional insight into the appropriate language or compiler, you can expand the box to the right of the Language specification. This presents you with the window shown in <a href="ch16.xhtml#fig16_10">Figure 16-10</a>, which gives you the opportunity to select a language and compiler specification.</p>
<span epub:type="pagebreak" id="page_352"/>
<div class="image"><img src="Images/fig16-10.jpg" alt="image" width="575" height="313"/></div>
<p class="figcap" id="fig16_10"><em>Figure 16-10: Ghidra language/compiler specification selection window</em></p>
<p class="indent">To do the same in headless Ghidra, use the <span class="literal">-cspec</span> and/or <span class="literal">processor</span> options, as shown next. You cannot use the <span class="literal">-cspec</span> option without using the <span class="literal">-processor</span> option. You can use the <span class="literal">-processor</span> option without the <span class="literal">-cspec</span> option, in which case Ghidra will choose the default compiler associated with the processor.</p>
<p class="programs">analyzeHeadless D:\GhidraProjects CH16 -import global_array_demo_x64<br/>
  -processor "x86:LE:64:default" -cspec "gcc"</p>
<p class="listhead"><span class="codestrong">-loader</span> <span class="EmpStrongItalic">loadername</span></p>
<p class="listbody">The <span class="literal">-loader</span> option can be the most complex of the headless Ghidra options. The <span class="codeitalic">loadername</span> argument names one of Ghidra’s loader modules (discussed in <a href="ch17.xhtml#ch17">Chapter 17</a>) that will be used to import a new file into the named project. Sample loader names include <span class="literal">PeLoader</span>, <span class="literal">ElfLoader</span>, and <span class="literal">MachoLoader</span>. Each loader module may recognize additional command line arguments of its own. These additional arguments are discussed in <em>support/analyzeHeadlessREADME.html</em>.</p>
<p class="listhead"><span class="codestrong">-max-cpu</span> <span class="EmpStrongItalic">number</span></p>
<p class="listbody">This option allows to you to put an upper limit on the number of processor (CPU) cores used to process the headless Ghidra command. The option requires an integer value as an argument. If the value is less than 1, the maximum number of cores is set to 1.</p>
<p class="programs">analyzeHeadless D:\GhidraProjects CH16 -import global_array_demo_x64<br/>
  -max-cpu 5</p>
<h5 class="h5" id="ch16lev294"><strong>Server Options</strong></h5>
<p class="noindent">Some commands are used only when interacting with a Ghidra Server. As this is not the focus of this book, we will mention these commands only briefly. Additional information can be found in <em>analyzeheadlessREADME.html</em>.</p>
<span epub:type="pagebreak" id="page_353"/>
<p class="listhead"><span class="codestrong">ghidra://</span><span class="EmpStrongItalic">server</span><span class="codestrong">[:</span><span class="EmpStrongItalic">port</span><span class="codestrong">]/</span><span class="EmpStrongItalic">repository_name</span><span class="codestrong">[/</span><span class="EmpStrongItalic">folder_path</span><span class="codestrong">]</span></p>
<p class="listbody">The previous examples have all specified a project location or project name. This alternative allows you to specify a Ghidra Server repository and optional folder path.</p>
<p class="listhead"><span class="codestrong">-p</span></p>
<p class="listbody">With Ghidra Server, this option forces a password prompt via the console.</p>
<p class="listhead"><span class="codestrong">-connect [</span><span class="EmpStrongItalic">userID</span><span class="codestrong">]</span></p>
<p class="listbody">This option provides a <span class="codeitalic">userID</span> to override the default <span class="codeitalic">userID</span> when connecting to a Ghidra Server.</p>
<p class="listhead"><span class="codestrong">-keystore</span> <span class="EmpStrongItalic">path</span></p>
<p class="listbody">This option allows you to specify a private keystore file when using PKI or SSH authentication.</p>
<p class="listhead"><span class="codestrong">-commit ["</span><span class="EmpStrongItalic">comment</span><span class="codestrong">"]</span></p>
<p class="listbody">While <span class="literal">commit</span> is enabled by default, this option allows you to associate a comment with a commit.</p>
<h5 class="h5" id="ch16lev295"><strong>Script Options</strong></h5>
<p class="noindent">Perhaps the most powerful applications for headless Ghidra are associated with Ghidra’s scripting abilities. <a href="ch14.xhtml#ch14">Chapters 14</a> and <a href="ch15.xhtml#ch15">15</a> both demonstrated how scripts can be created and used with the Ghidra GUI. After we present script options, we will demonstrate how powerful headless Ghidra can be in a scripting context.</p>
<p class="listhead"><span class="codestrong">-process [</span><span class="EmpStrongItalic">project_file</span><span class="codestrong">]</span></p>
<p class="listbody">This option processes select files (as opposed to importing them). If you do not specify a file, all files in the project folder will be processed. All specified files will also be analyzed unless you use the <span class="literal">-</span><span class="literal">noanalysis</span> option. Ghidra accepts two wildcard characters (<span class="literal">*</span> and <span class="literal">?</span>) for the <span class="literal">–process</span> option in order to simplify selection of multiple files. For this option, unlike with the <span class="literal">–import</span> option, you are naming Ghidra imported project files, <em>not</em> local filesystem files, so you need to quote any filenames that contain these wildcards in order to prevent your shell from expanding them prematurely.</p>
<p class="listhead"><span class="codestrong">-scriptPath "</span><span class="EmpStrongItalic">path1</span><span class="codestrong">[;</span><span class="EmpStrongItalic">path2</span><span class="codestrong">...]"</span></p>
<p class="listbody">By default, headless Ghidra includes many default script paths as well as script paths for imported extensions, as seen in <a href="ch16.xhtml#exa16_1">Listing 16-1</a>. To extend the list of paths that Ghidra searches for available scripts, use the <span class="literal">–scriptPath</span> option, which requires a quoted path list argument. Within the quotes, multiple paths must be separated using a semicolon. Two special prefix designators are recognized in path components:</p>
<p class="listbody1"><span epub:type="pagebreak" id="page_354"/><span class="literal">$GHIDRA_HOME</span> and <span class="literal">$USER_HOME</span>. <span class="literal">$GHIDRA_HOME</span> refers to the Ghidra installation directory, and <span class="literal">$USER_HOME</span> refers to the user’s home directory. Note that these are not environment variables and that your command shell may require you to escape the leading <span class="literal">$</span> character in order for it to be passed to Ghidra. The following example adds the <em>D:\GhidraScripts</em> directory to the script path:</p>
<p class="programs">analyzeHeadless D:\GhidraProjects CH16 -import global_array_demo_x64<br/>
  -scriptPath "D:\GhidraScripts"</p>
<p class="indent">After you run the command, the new script directory, <em>D:\GhidraScripts</em>, is included in the script path:</p>
<p class="programs">
INFO  HEADLESS Script Paths:<br/>
  D:\GhidraScripts<br/>
  C:\Users\Ghidrabook\ghidra_scripts<br/>
  D:\ghidra_PUBLIC\Ghidra\Extensions\SimpleROP\ghidra_scripts<br/>
  D:\ghidra_PUBLIC\Ghidra\Features\Base\ghidra_scripts<br/>
  D:\ghidra_PUBLIC\Ghidra\Features\BytePatterns\ghidra_scripts<br/>
  D:\ghidra_PUBLIC\Ghidra\Features\Decompiler\ghidra_scripts<br/>
  D:\ghidra_PUBLIC\Ghidra\Features\FileFormats\ghidra_scripts<br/>
  D:\ghidra_PUBLIC\Ghidra\Features\FunctionID\ghidra_scripts<br/>
  D:\ghidra_PUBLIC\Ghidra\Features\GnuDemangler\ghidra_scripts<br/>
  D:\ghidra_PUBLIC\Ghidra\Features\Python\ghidra_scripts<br/>
  D:\ghidra_PUBLIC\Ghidra\Features\VersionTracking\ghidra_scripts<br/>
  D:\ghidra_PUBLIC\Ghidra\Processors\8051\ghidra_scripts<br/>
  D:\ghidra_PUBLIC\Ghidra\Processors\DATA\ghidra_scripts<br/>
  D:\ghidra_PUBLIC\Ghidra\Processors\PIC\ghidra_scripts (HeadlessAnalyzer)<br/>
INFO  HEADLESS: execution starts (HeadlessAnalyzer)</p>
<p class="listhead"><span class="codestrong">-preScript</span></p>
<p class="listbody">This option names a script to be run before analysis. The script may contain an optional list of arguments.</p>
<p class="listhead"><span class="codestrong">-postScript</span></p>
<p class="listbody">This option names a script to be run after analysis. The script may contain an optional list of arguments.</p>
<p class="listhead"><span class="codestrong">-propertiesPath</span></p>
<p class="listbody">This option specifies the path to any property files associated with a script. Property files provide input to scripts that are run in headless mode. Examples of scripts and their associated property files are included in the headless analyzer documentation.</p>
<p class="listhead"><span class="codestrong">-okToDelete</span></p>
<p class="listbody">As scripts can do whatever their creators intend, it is possible for a script to delete (or try to delete) files within a Ghidra project. To prevent this as an undesired side-effect, headless Ghidra will not allow <span epub:type="pagebreak" id="page_355"/>deletion of files by a script unless the <span class="literal">-okToDelete</span> option is included when the script is invoked. Note: This parameter is not required when running in <span class="literal">-import</span> mode.</p>
<h3 class="h3" id="ch16lev296"><strong>Writing Scripts</strong></h3>
<p class="noindent">Now that you understand the basic components of a headless Ghidra command, let’s build some scripts to run from the command line.</p>
<h4 class="h4" id="ch16lev297"><strong><em>HeadlessSimpleROP</em></strong></h4>
<p class="noindent">Recall the SimpleROP analyzer that we wrote in <a href="ch15.xhtml#ch15">Chapter 15</a>. We wrote the module using the Eclipse IDE and then imported the extension into Ghidra so we could run it on any file we imported. Now we want to point SimpleROP at a directory and have it identify ROP gadgets in every file (or select files) in the directory. In addition to the SimpleROP output file with ROP gadgets for each existing binary, we also want a summary file that lists each file and the number of identified ROP gadgets in each.</p>
<p class="indent">For a job like this, running SimpleROP through the Ghidra GUI would introduce a time penalty for actions like opening and closing the CodeBrowser to display each file in the listing window, and so on. We do not need to see any of the files in the CodeBrowser window to accomplish our new goal. Why can’t we just write a script to find the gadgets independent of the GUI completely? This is exactly the kind of use case appropriate for headless Ghidra.</p>
<p class="indent">While we could modify the functionality of SimpleROP to accomplish our goal, we do not want to lose the utility of an existing Ghidra extension that other users may find useful. (We realize that we just introduced it in the preceding chapter . . . but it might have gone viral.) Instead, we will use some of the code from SimpleROP as a base to create our new script, <em>HeadlessSimpleROP</em>, which finds all ROP gadgets in <em>&lt;filename&gt;</em> and creates and writes them to <em>&lt;filename&gt;_gadgets.txt</em>, then appends <em>&lt;path&gt;/&lt;filename&gt;</em> and the count of ROP gadgets to a <em>HeadlessSimpleROP</em> summary file called <em>gadget_summary.txt</em>. All other functionality required (parsing directories, files, and so on) will be provided by headless Ghidra using the options we discussed earlier in this chapter.</p>
<p class="indent">To simplify development, we create a new script using the Eclipse ▸ GhidraDev approach presented in <a href="ch15.xhtml#ch15">Chapter 15</a> and then copy the <em>SimpleROPAnalyzer.java</em> source code into the new script template and edit the code as needed. Finally, we will run the script using the <span class="literal">-postScript</span> option so that it is invoked following the analysis phase for each opened file.</p>
<h5 class="h5" id="ch16lev298"><strong>Creating the HeadlessSimpleROP Script Template</strong></h5>
<p class="noindent">Begin by creating a template. From the GhidraDev menu, choose <strong>New</strong> ▸ <strong>GhidraScript</strong> and fill in the information shown in the dialog in <a href="ch16.xhtml#fig16_11">Figure 16-11</a>. While we could place the script in any folder, we will place it in the <em>ghidra_scripts</em> folder within our existing SimpleROP module in Eclipse.</p>
<span epub:type="pagebreak" id="page_356"/>
<div class="image"><img src="Images/fig16-11.jpg" alt="image" width="574" height="475"/></div>
<p class="figcap" id="fig16_11"><em>Figure 16-11: Create Ghidra Script dialog</em></p>
<p class="indent">Click <strong>Finish</strong> to see the new script template, complete with metadata, as shown in <a href="ch16.xhtml#fig16_12">Figure 16-12</a>. The task tag on line 14 shows you where to get started.</p>
<div class="image"><img src="Images/fig16-12.jpg" alt="image" width="592" height="362"/></div>
<p class="figcap" id="fig16_12"><em>Figure 16-12: New</em> HeadlessSimpleROP <em>script template</em></p>
<p class="indent">To convert the SimpleROP analyzer into the <em>HeadlessSimpleROP</em> script, we need to do the following:</p>
<ol>
<li class="noindent">Remove the unneeded <span class="literal">import</span> statements.</li>
<li class="noindent">Remove the analyzer public methods.</li>
<li class="noindent"><span epub:type="pagebreak" id="page_357"/>Duplicate the functionality of the <span class="literal">added</span> method that is called when the SimpleROPAnalyzer is invoked with the <span class="literal">run</span> method, which is called when the <em>HeadlessSimpleROP</em> script is invoked.</li>
<li class="noindent">Add the functionality to append the filename and number of gadgets found to the summary file, <em>gadget_summary.txt</em>.</li>
</ol>
<p class="indent">We will place our script, <em>HeadlessSimpleROP</em>, in the <em>D:\GhidraScripts</em> directory and use the headless analyzer to demonstrate its functionality. In the next sections, we will run a series of tests invoking the <em>HeadlessSimpleROP</em> script using items in the directory structure shown in <a href="ch16.xhtml#fig16_6">Figure 16-6</a>. These tests also demonstrate some of the options associated with headless Ghidra.</p>
<h5 class="h5" id="ch16lev299"><strong>Test Scenario 1: Load, Analyze, and Process a Single File</strong></h5>
<p class="noindent">In the following listing, we use headless Ghidra to import, analyze, and invoke our script to generate a gadget report for a single file (the ^ character is the line-continuation character in a Windows command shell):</p>
<p class="programs">analyzeHeadless D:\GhidraProjects CH16_ROP ^<br/>
     -import D:\ch16\demo_stackframe_32 ^<br/>
     -scriptPath D:\GhidraScripts ^<br/>
     -postScript HeadlessSimpleROP.java</p>
<p class="indent">When executed, the Ghidra headless analyzer creates a project called <em>CH16_ROP</em> in the <em>GhidraProjects</em> directory, then imports the file <em>demo_stackframe_32</em>, which will also be loaded and analyzed. We indicate the directory in which our script resides using <span class="literal">scriptPath</span>. Finally, after analysis, our script is run on the imported and analyzed file.</p>
<p class="indent">Once the command has completed, we check the contents of the <em>gadget_summary.txt</em> and <em>demo_stackframe_32_gadgets.txt</em> files to determine if our script worked correctly. The <em>demo_stackframe_32_gadgets.txt</em> contains 16 potential ROP gadgets:</p>
<p class="programs">080482c6;ADD ESP,0x8;POP EBX;RET;<br/>
080482c9;POP EBX;RET;<br/>
08048343;MOV EBX,dword ptr [ESP];RET;<br/>
08048360;MOV EBX,dword ptr [ESP];RET;<br/>
08048518;SUB ESP,0x4;PUSH EBP;PUSH dword ptr [ESP + 0x2c];PUSH dword ptr [ESP + 0x2c];<br/>
         CALL dword ptr [EBX + EDI*0x4 + 0xffffff0c];<br/>
0804851b;PUSH EBP;PUSH dword ptr [ESP + 0x2c];PUSH dword ptr [ESP + 0x2c];<br/>
         CALL dword ptr [EBX + EDI*0x4 + 0xffffff0c];<br/>
0804851c;PUSH dword ptr [ESP + 0x2c];PUSH dword ptr [ESP + 0x2c];<br/>
         CALL dword ptr [EBX + EDI*0x4 + 0xffffff0c];<br/>
08048520;PUSH dword ptr [ESP + 0x2c];CALL dword ptr [EBX + EDI*0x4 + 0xffffff0c];<br/>
08048535;ADD ESP,0xc;POP EBX;POP ESI;POP EDI;POP EBP;RET;<br/>
08048538;POP EBX;POP ESI;POP EDI;POP EBP;RET;<br/>
08048539;POP ESI;POP EDI;POP EBP;RET;<br/>
0804853a;POP EDI;POP EBP;RET;<br/>
0804853b;POP EBP;RET;<br/>
<span epub:type="pagebreak" id="page_358"/>
0804854d;ADD EBX,0x1ab3;ADD ESP,0x8;POP EBX;RET;<br/>
08048553;ADD ESP,0x8;POP EBX;RET;<br/>
08048556;POP EBX;RET;</p>
<p class="indent">Here is the associated entry in <em>gadget_summary.txt</em>:</p>
<p class="programs">demo_stackframe_32: Found 16 potential gadgets</p>
<h5 class="h5" id="ch16lev300"><strong>Test Scenario 2: Load, Analyze, and Process All Files in a Directory</strong></h5>
<p class="noindent">In this test, we import an entire directory, rather than a file with the <span class="literal">import</span> statement:</p>
<p class="programs">analyzeHeadless D:\GhidraProjects CH16_ROP ^<br/>
      -import D:\ch16 ^<br/>
      -scriptPath D:\GhidraScripts ^<br/>
      -postScript HeadlessSimpleROP.java</p>
<p class="indent">When the headless analyzer is complete, the following contents are found in <em>gadget_summary.txt</em>:</p>
<p class="programs">demo_stackframe_32: Found 16 potential gadgets<br/>
demo_stackframe_32_canary: Found 16 potential gadgets<br/>
demo_stackframe_32_stripped: Found 16 potential gadgets<br/>
<span epub:type="pagebreak" id="page_359"/>
demo_stackframe_64: Found 24 potential gadgets<br/>
demo_stackframe_64_canary: Found 24 potential gadgets<br/>
demo_stackframe_64_stripped: Found 24 potential gadgets</p>
<p class="indent">These are the six files in the root directory shown in <a href="ch16.xhtml#fig16_6">Figure 16-6</a>. In addition to the gadget summary file, we also produced individual gadget files listing the potential ROP gadgets associated with each file. In the remaining examples, we will concern ourselves only with the gadget summary file.</p>
<h5 class="h5" id="ch16lev301"><strong>Test Scenario 3: Load, Analyze, and Process All Files in a Directory Recursively</strong></h5>
<p class="noindent">In this test, we add the <span class="literal">-recursive</span> option. This extends the import operation to recursively visit all files in all subdirectories within the <em>ch16</em> directory:</p>
<p class="programs">analyzeHeadless D:\GhidraProjects CH16_ROP ^<br/>
      -import D:\ch16  ^<br/>
      -scriptPath D:\GhidraScripts ^<br/>
      -postScript HeadlessSimpleROP.java ^<br/>
      -recursive</p>
<p class="indent">When the headless analyzer is complete, the following contents are found in <em>gadget_summary.txt</em>, with the subdirectory file appearing at the top of the list:</p>
<p class="programs">demo_stackframe_32_sub: Found 16 potential gadgets<br/>
demo_stackframe_32: Found 16 potential gadgets<br/>
demo_stackframe_32_canary: Found 16 potential gadgets<br/>
demo_stackframe_32_stripped: Found 16 potential gadgets<br/>
demo_stackframe_64: Found 24 potential gadgets<br/>
demo_stackframe_64_canary: Found 24 potential gadgets<br/>
demo_stackframe_64_stripped: Found 24 potential gadgets</p>
<h5 class="h5" id="ch16lev302"><strong>Test Scenario 4: Load, Analyze, and Process All 32-bit Files in a Directory</strong></h5>
<p class="noindent">In this test, we use an * as a shell wildcard to restrict the import contents to the files with the 32-bit designator:</p>
<p class="programs">analyzeHeadless D:\GhidraProjects CH16ROP ^<br/>
      -import D:\ch16\demo_stackframe_32* ^<br/>
      -recursive ^<br/>
      -postScript HeadlessSimpleROP.java ^<br/>
      -scriptPath D:\GhidraScripts</p>
<p class="indent">The resulting <em>gadget_summary</em> file contains the following:</p>
<p class="programs">demo_stackframe_32: Found 16 potential gadgets<br/>
demo_stackframe_32_canary: Found 16 potential gadgets<br/>
demo_stackframe_32_stripped: Found 16 potential gadgets</p>
<p class="indent">If you know in advance that you’re interested in only the generated gadget files, use the <span class="literal">-readOnly</span> option. This option instructs Ghidra not to save imported files into the project named in the command, and is useful for avoiding project clutter from batch-processing many files.</p>
<h4 class="h4" id="ch16lev303"><strong><em>Automated FidDb Creation</em></strong></h4>
<p class="noindent">In <a href="ch13.xhtml#ch13">Chapter 13</a>, we started creating a Function ID database (FidDb) populated with fingerprints of functions taken from a static version of <em>libc</em>. Using the GUI and Ghidra’s batch file import mode, we imported 1,690 object files from a <em>libc.a</em> archive. However, we ran into a roadblock when it came to analyzing the files because the GUI has minimal support for batch analysis. Now that you are familiar with headless Ghidra, we can use it to complete our new FidDb.</p>
<h5 class="h5" id="ch16lev304"><strong>Batch Import and Analysis</strong></h5>
<p class="noindent">Importing and analyzing 1,690 files from an archive once seemed a daunting task, but the preceding examples have shown us everything we need to know to make short work of this task. We consider two cases here and provide command line examples for each.</p>
<p class="indent">If <em>libc.a</em> has not yet been imported into a Ghidra project, we extract the contents of our <em>libc.a</em> into a directory and then use headless Ghidra to process the entire directory:</p>
<p class="programs">$ mkdir libc.a &amp;&amp; cd libc.a<br/>
$ ar x <span class="codeitalic1">path\to\archive</span> &amp;&amp; cd ..<br/>
$ analyzeHeadless D:\GhidraProjects CH16 –import libc.a ^<br/>
        -processor x86:LE:64:default –cspec gcc –loader ElfLoader ^<br/>
        -recursive</p>
<span epub:type="pagebreak" id="page_360"/>
<p class="indent">The command results in thousands of lines of output as Ghidra reports its progress on the 1,690 files it processes, but once the command has completed, you will have a new <em>libc.a</em> folder in your project that contains 1,690 analyzed files.</p>
<p class="indent">If we’ve used the GUI to batch import <em>libc.a</em>, but had not processed any of the 1,690 imported files, the following command line would take care of the analysis:</p>
<p class="programs">$ analyzeHeadless D:\GhidraProjects CH16\libc.a –process</p>
<p class="indent">With the entire static archive efficiently imported and analyzed, we can now use the features of the Function ID plugin to create and populate an FidDb, as detailed in <a href="ch13.xhtml#ch13">Chapter 13</a>.</p>
<h3 class="h3" id="ch16lev305"><strong>Summary</strong></h3>
<p class="noindent">While GUI Ghidra remains the most straightforward and fully featured version, running Ghidra in headless mode offers tremendous flexibility in creating complex tools built around Ghidra’s automated analysis. At this point, we have covered all of Ghidra’s most commonly used features and examined ways that you can make Ghidra work for you. It is time to move on to more advanced features.</p>
<p class="indent">Over the course of the next few chapters, we will look at approaches for some of the more challenging problems that arise while reverse engineering binaries, including dealing with unknown file formats and unknown processor architectures by building sophisticated Ghidra extensions. We’ll also spend some time investigating Ghidra’s decompiler and discuss some of the ways that compilers can vary in their generation of code to improve your fluency in reading disassembly listings.</p>
</div>



  </body></html>