<html><head></head><body>
<h2 class="h1-part" id="part02"><span epub:type="pagebreak" id="page_83"/><span class="green2">Displays</span></h2>


<h2 class="h2" id="ch06"><span epub:type="pagebreak" id="page_84"/><strong>6<br/>AN LCD Reminder</strong></h2>
<p class="noindent"><span class="green2">In this project, you’ll connect a character LCD to your Raspberry Pi to display a scrolling reminder message. You’ll start by displaying static text for short messages and then learn how to display scrolling text ideal for longer messages.</span></p>
<div class="image"><span epub:type="pagebreak" id="page_85"/><img src="../images/f0085-01.jpg" alt="image"/></div>
<p class="cap"><span class="green2"><strong>PARTS REQUIRED</strong></span></p>
<p class="cap1">Raspberry Pi</p>
<p class="cap1">Breadboard</p>
<p class="cap1">16×2 Hi tachi HD44780-compatible LCD</p>
<p class="cap1">10 kΩ potent iometer</p>
<p class="cap1">Jumper wires</p>
<p class="cap"><span class="green2"><strong>SOFTWARE REQUIRED</strong></span></p>
<p class="cap1">Adafruit_CharLCD library</p>
<h3 class="h3" id="lev64"><span epub:type="pagebreak" id="page_86"/><span class="green2"><strong>INTRODUCING THE LIQUID CRYSTAL DISPLAY</strong></span></h3>
<p class="noindent">The simplest and cheapest display screen around is the <em>liquid crystal display (LCD)</em>. LCDs are found in everyday electronics devices like vending machines, calculators (see <a href="ch06.xhtml#ch06fig1">Figure 6-1</a>), parking meters, and printers, and are ideal for displaying text or small icons.</p>
<div class="image"><a id="ch06fig1"/><img src="../images/f0086-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 6-1:</strong> Calculator with an LCD</p>
<p class="indent">LCDs are measured according to the number of rows and columns of characters that fit on the screen. A 16×2 LCD can display 2 rows of 16 characters each. You’ll find sizes ranging from 8×1 to 40×4.</p>
<p class="indent">LCDs also vary in background color. You can find a wide variety of background colors, including RGB background lights that let you create any color.</p>
<p class="indent">The most common LCD modules use the Hitachi HD44780 chip, which allows you to use custom characters. <a href="ch06.xhtml#ch06fig2">Figure 6-2</a> shows a standard 16×2 Hitachi HD44780–compatible LCD; we recommend using this type for this project. Most 16×2 screens will be compatible, but before you buy one, check the part’s data sheet just to be safe. You can also use 20×4 LCDs as long as they are Hitachi HD44780–compatible.</p>
<div class="image"><a id="ch06fig2"/><img src="../images/f0086-02.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 6-2:</strong> A standard 16×2 Hitachi HD44780–compatible LCD</p>
<p class="indent"><span epub:type="pagebreak" id="page_87"/>If you look closely at <a href="ch06.xhtml#ch06fig2">Figure 6-2</a>, you’ll see 32 rectangles made of 5×8 pixels. The combination of on and off pixels is what makes up the character shapes.</p>
<h4 class="h4" id="lev65"><span class="green2"><strong>Soldering the Headers</strong></span></h4>
<p class="noindent">More likely than not, your LCD module will come with the header pins separate, as shown in <a href="ch06.xhtml#ch06fig3">Figure 6-3</a>. You’ll need to solder the pins to your module to make it breadboard-friendly. Put the pins in the available holes—there should be 16 pins for 16 holes—with the long end pointing down and solder them in place.</p>
<div class="image"><a id="ch06fig3"/><img src="../images/f0087-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 6-3:</strong> LCD with separate header pins</p>
<h4 class="h4" id="lev66"><span class="green2"><strong>The LCD Module Pinout</strong></span></h4>
<p class="noindent">The LCD module pins are numbered from 1 to 16, from left to right when the pins are above the screen:</p>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="border_thc"><p class="tab_th"><strong>PIN</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>SYMBOL</strong></p></td>
<td style="vertical-align: top;" class="border_thc"><p class="tab_th"><strong>DESCRIPTION</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">1</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">VSS</span></p></td>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">Ground</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">2</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">VDD</span></p></td>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">Power supply</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">3</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">V0</span></p></td>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">Contrast adjustment</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">4</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">RS</span></p></td>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">Register selection</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">5</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">R/W</span></p></td>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">Read/Write selection</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">6</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">E</span></p></td>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">Enable</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">7–14</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">DB0–DB7</span></p></td>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">Data pins</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">15</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">LEDA</span></p></td>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">Backlight anode (5V)</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">16</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">LEDK</span></p></td>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">Backlight cathode (–)</span></p></td>
</tr>
</tbody>
</table>
<div class="note">
<p class="notet"><span epub:type="pagebreak" id="page_88"/><span class="red"><strong>WARNING</strong></span></p>
<p class="notep"><em>The Raspberry Pi GPIOs are designed for 3.3 V, but most LCDs are 5 V. This isn’t a problem as long as you’re only sending data out of the Pi and not reading data from the screen to the Pi. With a 5 V screen,</em> do not connect the R/W pin of the display to the Pi. <em>This pin sends data at 5 V, and it will very likely fry your Pi!</em></p>
</div>
<p class="indent">VSS is a ground pin and should be connected to GND. VDD is a power pin and should be given 5 V or 3.3 V depending on the type of LCD you are working with; most require 5 V.</p>
<p class="indent">V0 allows you to adjust the contrast between the characters and the backlight when the LCD is connected to a potentiometer.</p>
<p class="indent">RS, R/W, and E are control pins. When using the screen to display text only, as in this project, you should permanently connect R/W directly to ground; in other words, you’ll only be writing to the LCD and not reading from it.</p>
<p class="indent">Pins 7 to 14 are data pins, used to send information. Pins 15 and 16 are the anode and cathode for the backlight.</p>
<p class="indent">Though the LCD module has 16 pins, you need only 6 of them to communicate with your Raspberry Pi: 4, 6, 11, 12, 13, and 14.</p>
<h3 class="h3" id="lev67"><span class="green2"><strong>WIRING YOUR CIRCUIT</strong></span></h3>
<p class="noindent">Now that your LCD is ready to use, you can start building this project’s circuit. Follow these steps to wire the LCD and Pi, using the circuit diagram in <a href="ch06.xhtml#ch06fig4">Figure 6-4</a> for reference.</p>
<ol>
<li class="noindent"><p class="list">Connect the breadboard power rails to 5 V and GND.</p></li>
<li class="noindent"><p class="list">To power the LCD, connect 5 V from the power rails to LCD pin 2 (VDD) and to LCD pin 15 (LEDA). Connect LCD pin 1 (VSS), pin 5 (R/W), and pin 16 (LEDK) to the GND rail on the breadboard.</p></li>
<li class="noindent"><p class="list">Add a potentiometer to adjust the contrast: connect one of the outer leads to the GND and the other outer lead to 5 V, and then connect the middle lead to LCD pin 3 (V0).</p></li>
<li class="noindent"><p class="list">Connect the Pi’s GPIO pins as shown in the following table.</p></li>
</ol>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="border_thc"><p class="tab_th"><strong>LCD</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>RASPBERRY PI</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">4 (RS)</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">GPIO 27</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">6 (E)</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">GPIO 22</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">11 (DB4)</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">GPIO 25</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">12 (DB5)</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">GPIO 24</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">13 (DB6)</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">GPIO 23</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">14 (DB7)</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">GPIO 18</span></p></td>
</tr>
</tbody>
</table>
<div class="image"><span epub:type="pagebreak" id="page_89"/><a id="ch06fig4"/><img src="../images/f0089-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 6-4:</strong> LCD wired to the Raspberry Pi</p>
<p class="indent">When you’re finished wiring, try adjusting the LCD contrast by rotating the potentiometer; you should see the backlighting change. If the contrast doesn’t change, double-check the wiring before moving on.</p>
<h3 class="h3" id="lev68"><span class="green2"><strong>WRITING THE SCRIPT</strong></span></h3>
<p class="noindent">Before you can write the script to display messages on the LCD, you need to install the Python library for a character LCD, Adafruit_CharLCD. This library features a lot of functions that make it easy to control the LCD.</p>
<h4 class="h4" id="lev69"><span class="green2"><strong>Installing the Python Library for a Character LCD</strong></span></h4>
<p class="noindent">Go to the Raspberry Pi desktop taskbar and open the terminal. Before installing the Adafruit_CharLCD library, you need to install the following dependencies:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~ $ <span class="codestrong">sudo apt update</span><br/>pi@raspberrypi:~ $ <span class="codestrong">sudo apt install build-essential python3</span><br/><span class="codestrong">python-dev python-smbus python3-pip git-core</span></p>
</div>
<p class="indent">When prompted, type <span class="codestrong">y</span> and press <small>ENTER</small>.</p>
<p class="indent">Navigate to the desktop, create a folder called <em>Libraries</em>, and change directory to the newly created folder with the following commands:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~ $ <span class="codestrong">cd ~/Desktop</span><br/>pi@raspberrypi:~/Desktop $ <span class="codestrong">mkdir Libraries</span><br/>pi@raspberrypi:~/Desktop $ <span class="codestrong">cd Libraries</span><br/>pi@raspberrypi:~/Desktop/Libraries $</p>
</div>
<p class="indent"><span epub:type="pagebreak" id="page_90"/>Download the installation files by entering the following command:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~/Desktop/Libraries $ <span class="codestrong">git clone https://github.com/</span><br/><span class="codestrong">adafruit/Adafruit_Python_CharLCD.git</span></p>
</div>
<p class="indent">Navigate to the <em>Adafruit_Python_CharLCD</em> directory:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~/Desktop/Libraries $ <span class="codestrong">cd Adafruit_Python_CharLCD</span></p>
</div>
<p class="indent">Finally, execute the following command to install the Adafruit_CharLCD library:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~/Desktop/Libraries/Adafruit_Python_CharLCD $ <span class="codestrong">sudo</span><br/><span class="codestrong">python3 setup.py install</span></p>
</div>
<p class="indent">Congratulations! You successfully installed the Python library for a character LCD. We encourage you to navigate through the <em>Examples</em> folder and take a look.</p>
<h4 class="h4" id="lev70"><span class="green2"><strong>Displaying a Character Message</strong></span></h4>
<p class="noindent">Go to your <em>Projects</em> folder and create a new folder called <em>Displays</em>. Open <strong>Python 3 (IDLE)</strong> and go to <strong>File</strong> <span class="ent">▸</span> <strong>New File</strong> to create a new script. Then, enter the following code into the Python Editor and save the script as <em>character_lcd.py</em> (remember that you can download all the scripts at <em><a href="https://www.nostarch.com/RaspberryPiProject/">https://www.nostarch.com/RaspberryPiProject/</a></em>):</p>
<div class="box">
<p class="programs"><span class="ent">➊</span> <span class="orange">import</span> Adafruit_CharLCD <span class="orange">as</span> LCD<br/><br/>  <span class="red1">#Raspberry Pi pin configuration</span><br/><span class="ent">➋</span> lcd_rs = 27<br/>  lcd_en = 22<br/>  lcd_d4 = 25<br/>  lcd_d5 = 24<br/>  lcd_d6 = 23<br/>  lcd_d7 = 18<br/>  lcd_backlight = 4<br/><br/>  <span class="red1">#define the LCD size</span><br/><span class="ent">➌</span> lcd_columns = 16<br/>  lcd_rows = 2<br/><br/>  <span class="red1">#initialize the LCD</span><br/><span class="ent">➍</span> lcd = LCD.Adafruit_CharLCD(lcd_rs, lcd_en, lcd_d4, lcd_d5, lcd_d6, <br/>  lcd_d7, lcd_columns, lcd_rows, lcd_backlight)<br/><br/>  <span class="red1">#write your message</span><br/><span class="ent">➎</span> lcd.message(<span class="green">'It works\nYou rock!'</span>)</p>
</div>
<p class="indent"><span epub:type="pagebreak" id="page_91"/>You start by importing the previously installed character LCD library at <span class="ent">➊</span>. Then, at <span class="ent">➋</span> you configure your Pi pins. At <span class="ent">➌</span>, you define your LCD size. If you’re using a 20×4 LCD, you need to change those two lines of code accordingly.</p>
<p class="indent">After that, the LCD is initialized <span class="ent">➍</span>, and you write your message inside the function <span class="literal">lcd.message('</span><span class="codeitalic">string</span><span class="literal">')</span> between the single quotes <span class="ent">➎</span>. The <span class="literal">\n</span> escape character tells the LCD to display the text that follows on the next line. Feel free to change this message to anything you like!</p>
<p class="indent">Press <strong>F5</strong> or go to <strong>Run</strong> <span class="ent">▸</span> <strong>Run Module</strong> to run the script, and your LCD should display the text, as in <a href="ch06.xhtml#ch06fig5">Figure 6-5</a>.</p>
<div class="image"><a id="ch06fig5"/><img src="../images/f0091-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 6-5:</strong> Your circuit displaying a static message</p>
<h4 class="h4" id="lev71"><span class="green2"><strong>Adding Other Functionality</strong></span></h4>
<p class="noindent">It’s worth knowing a few other useful functions you can use for more than just displaying text; you may want to set the cursor to a certain position or clear the display in preparation for new messages, for example. The library you’ve installed provides the following functions for you:</p>
<ul>
<li class="noindent"><span class="literal">lcd.message(</span><span class="codeitalic">string</span><span class="literal">)</span> displays the message written between brackets.</li>
<li class="noindent"><span class="literal">lcd.clear()</span> clears the display.</li>
<li class="noindent"><span class="literal">lcd.show_cursor(</span><span class="codeitalic">boolean</span><span class="literal">)</span> shows the cursor after the message.</li>
<li class="noindent"><span class="literal">lcd.blink(</span><span class="codeitalic">boolean</span><span class="literal">)</span> shows a blinking cursor.</li>
<li class="noindent"><span epub:type="pagebreak" id="page_92"/><span class="literal">lcd.move_right()</span> moves the displayed message one character to the right.</li>
<li class="noindent"><span class="literal">lcd.move_left()</span> moves the displayed message one character to the left.</li>
<li class="noindent"><span class="literal">lcd.home()</span> sets the cursor to the first column and first row (0,0).</li>
<li class="noindent"><span class="literal">lcd.set_cursor(int, int)</span> sets the cursor to the specified column and row. For example, <span class="literal">lcd.set_cursor(2, 1)</span> sets the cursor to the third column and second row.</li>
</ul>
<p class="indent">The data types shown in italic tell you what kind of value you need to enter as an argument; for example, in place of <span class="codeitalic">boolean</span> you’d enter <span class="literal">True</span> or <span class="literal">False</span>.</p>
<h4 class="h4" id="lev72"><span class="green2"><strong>Scrolling a Reminder Message</strong></span></h4>
<p class="noindent">This LCD screen is pretty small, so you’ll get stuck if you try to display messages longer than 32 characters. So, now we’ll show you how to write a script to display a longer message that scrolls across the screen, like a reminder for a doctor appointment you can’t miss. In the first row, you’ll have a title for your message, like “Reminder” or “Don’t forget,” and in the second row your reminder message will scroll by.</p>
<p class="indent">Displaying a scrolling message is not as straightforward as showing a static message, so let’s think about what we want to happen before we write our code:</p>
<ul>
<li class="noindent">The first row displays a static title.</li>
<li class="noindent">The second row displays a scrolling message.</li>
<li class="noindent">The scrolling message moves from right to left.</li>
<li class="noindent">The characters should appear from the rightmost column.</li>
<li class="noindent">The characters should disappear at the leftmost column.</li>
</ul>
<p class="indent">The message scrolls forever until stopped. Inside the <em>Displays</em> folder, create a new script with <strong>Python 3 (IDLE)</strong> called <em>scrolling_text.py</em> and enter the following code:</p>
<div class="box">
<p class="programs">  <span class="orange">import</span> Adafruit_CharLCD <span class="orange">as</span> LCD<br/><span class="ent">➊</span> <span class="orange">import</span> time<br/><br/>  <span class="red1">#Raspberry Pi pin configuration</span><br/>  lcd_rs = 27<br/>  lcd_en = 22<br/>  lcd_d4 = 25<br/>  lcd_d5 = 24<br/><span epub:type="pagebreak" id="page_93"/>  lcd_d6 = 23<br/>  lcd_d7 = 18<br/>  lcd_backlight = 4<br/><br/>  <span class="red1">#define the LCD size</span><br/>  lcd_columns = 16<br/>  lcd_rows = 2<br/><br/>  <span class="red1">#initialize the LCD</span><br/>  lcd = LCD.Adafruit_CharLCD(lcd_rs, lcd_en, lcd_d4, lcd_d5, lcd_d6,<br/>  lcd_d7, lcd_columns, lcd_rows, lcd_backlight)<br/><br/>  <span class="red1">#write your message</span><br/><span class="ent">➋</span> title = <span class="green">"Don't forget!"</span><br/><span class="ent">➌</span> reminder = <span class="green">"You have a doctor appointment next Monday"</span><br/><br/>  <span class="red1">#set the delay for scroll</span><br/><span class="ent">➍</span> delay = 0.3<br/><br/>  <span class="red1">#write a function to scroll the message</span><br/><span class="ent">➎</span> <span class="orange">def</span> <span class="blue">scroll_message</span>(reminder, delay):<br/>      padding = <span class="green">' '</span> * lcd_columns<br/>      reminder_message = padding + reminder + <span class="green">' '</span><br/>    <span class="ent">➏</span> <span class="orange">for</span> i <span class="orange">in</span> <span class="purple">range</span>(<span class="purple">len</span>(reminder_message)):<br/>          lcd.set_cursor(0, 1)<br/>          lcd.message(reminder_message[i:(i+lcd_columns)])<br/>          time.sleep(delay)<br/><br/><span class="ent">➐</span> lcd.clear()<br/>  lcd.home()<br/>  lcd.message(title)<br/><br/>  <span class="red1">#scroll the message in an infinite loop</span><br/><span class="ent">➑</span> <span class="orange">while</span> <span class="orange">True</span>:<br/>      scroll_message(reminder, delay)</p>
</div>
<p class="indent">You’re already familiar with importing the Adafruit_CharLCD library, configuring the Raspberry Pi pins, defining the screen size, and initializing the LCD.</p>
<p class="indent">For this example, you also need to import the time library <span class="ent">➊</span> to use functions related to time. At <span class="ent">➋</span> and <span class="ent">➌</span>, you assign the text that will be displayed as the title and reminder messages, respectively. The <span class="literal">delay</span> <span class="ent">➍</span> will be the time a character stays in one place before moving one character to the left. In this case, you set the delay to <span class="literal">0.3</span> seconds; the lower the delay, the faster the text will scroll.</p>
<p class="indent">At <span class="ent">➎</span>, you create a function called <span class="literal">scroll_message(</span><span class="literal"><em>string</em>, <em>float</em>)</span> that accepts two parameters: a string that will be your <span class="literal">reminder</span> and a float that will be the <span class="literal">delay</span>. Inside the function you start by creating <span epub:type="pagebreak" id="page_94"/>a <span class="literal">padding</span> variable that consists of a blank character multiplied by the number of columns your LCD has. This will fill all your character slots initially with a blank square variable, creating the illusion that characters are appearing gradually. Then you create a new variable called <span class="literal">reminder_message</span> that is the concatenation of the <span class="literal">padding</span>, the <span class="literal">reminder</span>, and one blank space. You need to add this extra blank space to create the disappearing effect of the <span class="literal">reminder_message</span>.</p>
<p class="indent">The function goes through a <span class="literal">for</span> <span class="ent">➏</span> loop from <span class="literal">0</span> to the length of the <span class="literal">reminder_message</span>. The function <span class="literal">len(</span><span class="codeitalic">object</span><span class="literal">)</span> returns the length of an object—in this case, the number of characters in the <span class="literal">reminder_message</span> string, which tells us how many times to loop.</p>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>Python uses</em> zero-based indexing, <em>which means that indexes start counting at zero. For instance, the first character of a string has index <span class="literal">0</span>.</em></p>
</div>
<p class="indent">Inside the loop, the code starts by setting the cursor to the first column, second row, where you want to start displaying your reminder. In the next line, <span class="literal">reminder_message[i:(i+lcd_columns)]</span> truncates your <span class="literal">reminder_message</span>, returning the characters from index <span class="literal">i</span> to index number <span class="literal">i+lcd_columns</span> exclusively.</p>
<p class="indent">Each time the loop runs, you will display a different part of your message; this is what actually creates the scrolling effect (see <a href="ch06.xhtml#ch06fig6">Figure 6-6</a>).</p>
<div class="image"><a id="ch06fig6"/><img src="../images/f0094-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 6-6:</strong> Truncating a string to make a scrolling effect</p>
<p class="indent">After displaying the full message, the code waits the number of seconds assigned in the <span class="literal">delay</span> variable.</p>
<p class="indent">At <span class="ent">➐</span>, you clear the screen and display the <span class="literal">title</span> message from the first column, in the first row.</p>
<p class="indent"><span epub:type="pagebreak" id="page_95"/>Finally, at <span class="ent">➑</span>, you create a <span class="literal">while</span> loop that is always <span class="literal">True</span>. This is a little trick to make something run forever and ever. Inside that loop you call the function <span class="literal">scroll_message(</span><span class="literal"><em>string</em>, <em>float</em>)</span> with your own arguments: <span class="literal">reminder</span> and <span class="literal">delay</span>.</p>
<h4 class="h4" id="lev73"><span class="green2"><strong>Running the Script</strong></span></h4>
<p class="noindent">Press <strong>F5</strong> or go to <strong>Run</strong> <span class="ent">▸</span> <strong>Run Module</strong> to run the script. Unfortunately, we can’t show the text moving in a book, but you get the idea!</p>
<h3 class="h3" id="lev74"><span class="green2"><strong>TAKING IT FURTHER</strong></span></h3>
<p class="noindent">We recommend that you modify the sample script we’ve given you with the coding tricks you’ve learned here and earlier, and experiment with the functions shown in <a href="ch06.xhtml#lev71">“Adding Other Functionality”</a> on <a href="ch06.xhtml#page_91">page 91</a> to get familiar with the LCD. When you’re done, here are some projects to try:</p>
<ul>
<li class="noindent">Build a weather forecaster using the LCD display—take a look at <a href="ch07.xhtml#ch07">Project 7</a>, in which we show how to get weather data.</li>
<li class="noindent">Display messages based on weather conditions, like “Don’t forget your umbrella.”</li>
<li class="noindent">Display sensor data on the LCD—check out <a href="ch09.xhtml#ch09">Projects 9</a>–<a href="ch12.xhtml#ch12">12</a> to learn how to read data from a sensor.</li>
</ul>


<h2 class="h2" id="ch07"><span epub:type="pagebreak" id="page_96"/><strong>7<br/>Mini Weather Forecaster</strong></h2>
<p class="noindent"><span class="green2">In this project, you’re going to build a weather forecaster that displays the day’s weather for your location on an OLED display. You’ll learn how to make API requests, which are really useful for projects that rely on frequently updated data, and how to use an OLED display.</span></p>
<div class="image"><span epub:type="pagebreak" id="page_97"/><img src="../images/f0097-01.jpg" alt="image"/></div>
<p class="cap"><span class="green2"><strong>PARTS REQUIRED</strong></span></p>
<p class="cap1">Raspberry Pi</p>
<p class="cap1">Breadboard</p>
<p class="cap1">0.96-inch OLED display</p>
<p class="cap1">Jumper wires</p>
<p class="cap"><span class="green2"><strong>SOFTWARE REQUIRED</strong></span></p>
<p class="cap1">Adafruit_SSD1306 library</p>
<h3 class="h3" id="lev75"><span epub:type="pagebreak" id="page_98"/><span class="green2"><strong>INTRODUCING THE OLED DISPLAY</strong></span></h3>
<p class="noindent">The <em>organic light-emitting diode (OLED)</em> display this project uses is the SSD1306 model: a monocolor, 0.96-inch display with 128×64 pixels, shown in <a href="ch07.xhtml#ch07fig1">Figure 7-1</a>. Compared to the LCD, which has a reserved space of 5×8 pixels for each character, the OLED display is much more versatile. It allows you to choose which pixels are on and off, enabling you to produce custom text and images anywhere in the display. The OLED display also doesn’t require backlight, which results in a very nice contrast in dark environments. Additionally, its pixels consume energy only when they are on, so the OLED display consumes less power than an LCD.</p>
<div class="image"><a id="ch07fig1"/><img src="../images/f0098-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 7-1:</strong> The SSD1306 0.96-inch monocolor OLED display</p>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>Some OLED displays use SPI communication instead of I<sup>2</sup>C—these will come with a different set of pins. Make sure you check the pin layout before purchasing your OLED display.</em></p>
</div>
<p class="indent">This OLED display generally has four pins, GND, VCC, SCL, and SDA (see <a href="ch07.xhtml#ch07fig1">Figure 7-1</a>), though you may find that some models come with an extra reset pin. Some displays may come with the pins in a different order as well—VCC, GND, SCL, SDA—so just pay attention to the labels as you follow this project’s instructions.</p>
<p class="indent">The OLED display in <a href="ch07.xhtml#ch07fig1">Figure 7-1</a> uses the Inter-Integrated Circuit (I<sup>2</sup>C) communication protocol to communicate with the Raspberry Pi, for which you need the SDA and SCL pins (GPIO 2 and GPIO 3, respectively).</p>
<h3 class="h3" id="lev76"><span class="green2"><strong>USING THE OPENWEATHERMAP API</strong></span></h3>
<p class="noindent">An application programming interface (API) is a set of functions written by software developers to enable anyone to use their data or services. For example, the OpenWeatherMap project (<em><a href="https://openweathermap.org/">https://openweathermap.org/</a></em>) has an API that enables users to request <span epub:type="pagebreak" id="page_99"/>weather data using many different programming languages. In this project you’ll use that API to request the day’s weather forecast for your chosen location. Learning to use APIs with your Pi is a great skill because it allows you access to a wide variety of constantly changing information, such as current stock prices, currency exchange rates, the latest news, traffic updates, tweets, and much more.</p>
<p class="indent">OpenWeatherMap’s free plan provides everything you need to complete this project. To use the API you need an API key, known as the <em>APIID</em>. To get an APIID:</p>
<ol>
<li class="noindent"><p class="list">Open a browser and go to <em><a href="https://openweathermap.org/appid/">https://openweathermap.org/appid/</a></em>.</p></li>
<li class="noindent"><p class="list">Press the <strong>Sign up</strong> button and create a free account.</p></li>
<li class="noindent"><p class="list">You’ll be presented with a dashboard that contains several tabs. Select the <strong>API keys</strong> tab, as shown in <a href="ch07.xhtml#ch07fig2">Figure 7-2</a>.</p>
<div class="image"><a id="ch07fig2"/><img src="../images/f0099-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 7-2:</strong> API keys on OpenWeatherMap</p></li>
<li class="noindent"><p class="list">On the API keys tab, you’ll see a default key (shown in <a href="ch07.xhtml#ch07fig2">Figure 7-2</a>); this is a unique key you’ll need to pull information from the site. Copy and paste this key somewhere; you’ll need it in a moment. You can create a new key for each separate project if you like, but if you aren’t familiar with using APIs, we’d recommend just using the default key provided.</p></li>
<li class="noindent"><p class="list">To pull information on weather in your chosen location, enter the following URL:</p>
<div class="box">
<p class="programs">http://api.openweathermap.org/data/2.5/weather?q=<em>your_city</em>,<br/><em>your_country_code</em>&amp;APPID=<em>your_unique_API_key</em></p>
</div>
<div class="note">
<p class="notet"><span class="red"><strong>WARNING</strong></span></p>
<p class="notep"><em>APIs are unique to the user and shouldn’t be shared with anyone. In this case, whoever has your API key can only request the weather, but if you were using social media APIs, for example, you could run into security issues—like strangers getting access to your personal information. Don’t share your API keys with anyone.</em></p>
</div>
<p class="indentv">Replace <span class="codeitalic">your_city</span> with the city you want data for, <span class="codeitalic">your_country_code</span> with the country code for that city, and <span epub:type="pagebreak" id="page_100"/><span class="codeitalic">your_unique_API_key</span> with the unique API key from step 4. For example, the updated API URL for the town of Porto, Portugal, would be:</p>
<div class="box">
<p class="programs">http://api.openweathermap.org/data/2.5/weather?q=Porto,<br/>PT&amp;APPID=801d2603e9f2e1c70e042e4f5f6e0---</p>
</div></li>
<li class="noindent"><p class="list">Copy your URL into your browser, and the API will return a bunch of information corresponding to your local weather. <a href="ch07.xhtml#ch07list1">Listing 7-1</a> shows the weather in Porto, Portugal, on the day we wrote this project.</p>
<p class="listing" id="ch07list1"><strong>LISTING 7-1:</strong> The API response</p>
<div class="box">
<p class="programs">{"coord":{"lon":8.61,"lat":41.15},"weather":[{"id":802,<br/>"main":"Clouds","description":"scattered clouds","icon":"03d"}],<br/>"base":"stations","main":{"temp":280.704,"pressure":1010.06,<br/>"humidity":96,"temp_min":280.704,"temp_max":280.704,<br/>"sea_level":1041.03,"grnd_level":1010.06},"wind":{"speed":1.01,<br/>"deg":74.0017},"clouds":{"all":36},"dt":1487153693,<br/>"sys":{"message":0.0042,"country":"PT","sunrise":1487143701,<br/>"sunset":1487182157},"id":2735943,"name":"Porto","cod":200}</p>
</div></li>
</ol>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>More information on using the API to get weather information is available at</em> <a href="https://openweathermap.org/current">https://openweathermap.org/current</a>.</p>
</div>
<p class="indent">This may not look like much now, but next you’ll see how to organize this data with tabs and paragraphs to make it more readable.</p>
<h4 class="h4" id="lev77"><span class="green2"><strong>Understanding JSON Syntax</strong></span></h4>
<p class="noindent">As you can see, the weather data for your chosen location is stored in a specific way, with symbols like <span class="literal">{}[] : ""</span> and <span class="literal">,</span>. This syntax is <em>JavaScript Object Notation (JSON)</em>, a standard for exchanging data in a way that’s convenient for computers. In JSON syntax:</p>
<ul>
<li class="noindent">Data is represented in name/value pairs.</li>
<li class="noindent">Each name is followed by a colon ( <span class="literal">:</span>).</li>
<li class="noindent">Name/value pairs are separated with commas.</li>
<li class="noindent">Curly brackets hold objects.</li>
<li class="noindent">Square brackets hold arrays.</li>
</ul>
<p class="indent"><a href="ch07.xhtml#ch07list2">Listing 7-2</a> shows how you can organize the API information so it’s easier to understand.</p>
<p class="listing" id="ch07list2"><strong>LISTING 7-2:</strong> The API JSON information rearranged for a clearer structure</p>
<div class="box">
<p class="programs">{<br/>   <span class="green">"coord"</span>:{<br/>      <span class="green">"lon"</span>:-8.61,<br/>      <span class="green">"lat"</span>:41.15<br/>   },<br/><span epub:type="pagebreak" id="page_101"/>   <span class="green">"weather"</span>:[{<br/>         <span class="green">"id"</span>:803,<br/>         <span class="green">"main"</span>:<span class="green">"Clouds"</span>,<br/>         <span class="green">"description"</span>:<span class="green">"broken clouds"</span>,<br/>         <span class="green">"icon"</span>:<span class="green">"04d"</span><br/>      }<br/>   ],<br/>   <span class="green">"base"</span>:<span class="green">"stations"</span>,<br/>   <span class="green">"main"</span>:{<br/>      <span class="green">"temp"</span>:288.15,<br/>      <span class="green">"pressure"</span>:1020,<br/>      <span class="green">"humidity"</span>:93,<br/>      <span class="green">"temp_min"</span>:288.15,<br/>      <span class="green">"temp_max"</span>:288.15<br/>   },<br/>   <span class="green">"visibility"</span>:10000,<br/>   <span class="green">"wind"</span>:{<br/>      <span class="green">"speed"</span>:3.6,<br/>      <span class="green">"deg"</span>:230<br/>   },<br/>   <span class="green">"clouds"</span>:{<br/>      <span class="green">"all"</span>:75<br/>   },<br/>   <span class="green">"dt"</span>:1488726000,<br/>   <span class="green">"sys"</span>:{<br/>      <span class="green">"type"</span>:1,<br/>      <span class="green">"id"</span>:5959,<br/>      <span class="green">"message"</span>:0.002,<br/>      <span class="green">"country"</span>:<span class="green">"PT"</span>,<br/>      <span class="green">"sunrise"</span>:1488697277,<br/>      <span class="green">"sunset"</span>:1488738646<br/>   },<br/>   <span class="green">"id"</span>:2735943,<br/>   <span class="green">"name"</span>:<span class="green">"Porto"</span>,<br/>   <span class="green">"cod"</span>:200<br/>}</p>
</div>
<p class="indent">Now you can more easily see all the different kinds of information the API provides.</p>
<h4 class="h4" id="lev78"><span class="green2"><strong>Making an API Request</strong></span></h4>
<p class="noindent">Now you have a URL that returns your local weather data. To show you how to access the information using Python, we’ll give you an example.</p>
<p class="indent">The simple code snippet in <a href="ch07.xhtml#ch07list3">Listing 7-3</a> requests the current maximum temperature in Kelvin for Porto, Portugal, and prints it in the Python shell. Replace our URL with your own, and you’ll get the same information for your chosen location.</p>
<p class="listing" id="ch07list3"><span epub:type="pagebreak" id="page_102"/><strong>LISTING 7-3:</strong> Requesting maximum temperature</p>
<div class="box">
<p class="programs"><span class="ent">➊</span> <span class="orange">import</span> requests<br/><span class="ent">➋</span> weather_data = requests.get(<span class="green">'http://api.openweathermap.org/data/2.5/</span><br/>  <span class="green">weather?q=Porto,PT&amp;APPID=801d2603e9f2e1c70e042e4f5f6e0---'</span>)<br/><span class="ent">➌</span> temp_max = weather_data.json().get(<span class="green">'main'</span>).get(<span class="green">'temp_max'</span>)<br/>  <span class="purple">print</span>(temp_max)</p>
</div>
<p class="indent">At <span class="ent">➊</span>, you import the requests library, which is essential for making API requests.</p>
<p class="indent">At <span class="ent">➋</span>, you create a variable called <span class="literal">weather_data</span> in which you store the data returned after the API request. To make an API request for information, you use the command <span class="literal">requests.get('</span><span class="codeitalic">your_url</span><span class="literal">')</span>, with your URL as the argument inside single quotes.</p>
<p class="indent">At <span class="ent">➌</span>, you create the <span class="literal">temp_max</span> variable to hold the particular data you’re requesting. In this case, you want the maximum temperature.</p>
<p class="indent">To get that value, you first convert the <span class="literal">weather_data</span> variable to JSON with the <span class="literal">.json()</span> method. Then, using the <span class="literal">.get()</span> method, you access the <span class="literal">temp_max</span> variable, which contains the maximum temperature value. You can see in <a href="ch07.xhtml#ch07list2">Listing 7-2</a> that <span class="literal">main</span> is the top-level parent of the data you want to access, <span class="literal">temp_max</span>, so you need to get through <span class="literal">main</span> first.</p>
<p class="indent">In the same way, to access the wind speed you enter:</p>
<div class="box">
<p class="programs">weather_data.json().get(<span class="green">'wind'</span>).get(<span class="green">'speed'</span>)</p>
</div>
<p class="indent">You need to go through the parent of <span class="literal">speed</span>, which is <span class="literal">wind</span>, to request the information about wind speed.</p>
<p class="indent">If you just want to get the city name, you enter:</p>
<div class="box">
<p class="programs">weather_data.json().get(<span class="green">'name'</span>)</p>
</div>
<p class="indent">After learning how to make API requests in Python, you’re ready to start this project!</p>
<div class="box3">
<p class="box-title"><span class="green2"><strong>THE REQUESTS LIBRARY</strong></span></p>
<p class="box-p">The requests library, also called “HTTP for Humans,” is an Apache2- licensed Python library used to send <em>hypertext transfer protocol (HTTP)</em> requests. This powerful library makes it simple to connect to web servers via HTTP. This capability allows you to easily request information from any web page, as you’ve been doing here.</p>
</div>
<h3 class="h3" id="lev79"><span epub:type="pagebreak" id="page_103"/><span class="green2"><strong>WIRING THE CIRCUIT</strong></span></h3>
<p class="noindent">Simply wire the OLED display to the Pi according to the pinout shown in the table. Remember that the pin order may be different on some models, so follow the pin labels.</p>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="border_thc"><p class="tab_th"><strong>OLED DISPLAY</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>RASPBERRY PI</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">VCC</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">3.3 V</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">GND</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">GND</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">SDA</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">GPIO 2 (SDA)</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">SCL</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">GPIO 3 (SCL)</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">RST (if existent)</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">GPIO 24</span></p></td>
</tr>
</tbody>
</table>
<p class="indent">Check your circuit against <a href="ch07.xhtml#ch07fig3">Figure 7-3</a> and then move on to the software.</p>
<div class="image"><a id="ch07fig3"/><img src="../images/f0103-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 7-3:</strong> Wiring the OLED display to the Raspberry Pi</p>
<h3 class="h3" id="lev80"><span class="green2"><strong>WRITING THE SCRIPT</strong></span></h3>
<p class="noindent">Before you enter the script, you need to install the Adafruit_SSD1306 library to use the OLED with the Raspberry Pi. This library makes it simple to write text and draw images on the display. You’ll also need to enable I<sup>2</sup>C communication so the OLED and Pi can communicate.</p>
<h4 class="h4" id="lev81"><span epub:type="pagebreak" id="page_104"/><span class="green2"><strong>Installing the Library for the OLED Display</strong></span></h4>
<p class="noindent">If you haven’t done so already, create a folder called <em>Libraries</em> on your Desktop. Then, open the terminal and navigate to the <em>Libraries</em> folder on your Pi:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~ $ <span class="codestrong">cd Desktop/Libraries</span></p>
</div>
<p class="indent">Clone the OLED library:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~/Desktop/Libraries $ <span class="codestrong">git clone https://github.com/</span><br/><span class="codestrong">adafruit/Adafruit_Python_SSD1306.git</span></p>
</div>
<p class="indent">Install the Adafruit_Python_SSD1306 library:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~/Desktop/Libraries $ <span class="codestrong">cd adafruit/</span><br/><span class="codestrong">Adafruit_Python_SSD1306</span><br/>pi@raspberrypi:~/Desktop/Libraries/adafruit/Adafruit_Python_SSD1306<br/>$ <span class="codestrong">sudo python3 setup.py install</span></p>
</div>
<h4 class="h4" id="lev82"><span class="green2"><strong>Enabling I<sup>2</sup>C Communication</strong></span></h4>
<p class="noindent">The OLED communicates with the Pi using the I<sup>2</sup>C communication protocol, so you need to enable I<sup>2</sup>C communication on your Pi. Go to the Desktop main menu and select <strong>Preferences</strong> <span class="ent">▸</span> <strong>Raspberry Pi Configuration</strong>. In the Interfaces tab, enable I<sup>2</sup>C, as shown in <a href="ch07.xhtml#ch07fig4">Figure 7-4</a>, and press <strong>OK</strong>.</p>
<div class="image"><a id="ch07fig4"/><img src="../images/f0104-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 7-4:</strong> Enabling I<sup>2</sup>C communication</p>
<div class="box3">
<p class="box-title"><span epub:type="pagebreak" id="page_105"/><span class="green2"><strong>I<sup>2</sup>C COMMUNICATION PROTOCOL</strong></span></p>
<p class="box-p"><em>I<sup>2</sup>C</em>, or <em>Inter-Integrated Circuit</em>, is a communication protocol that allows communication between multiple <em>slave</em> integrated circuits and one master chip. The slaves are the devices that respond to the master. The master chip can communicate with all slaves, but a slave can only communicate with the master. Both the slave and master can transfer data, but that transfer is always controlled by the master. In this case, the Raspberry Pi is the master chip and the OLED integrated circuit is the slave. The Raspberry Pi supports I<sup>2</sup>C communication in its GPIO pins through the SDA and SCL pins. The biggest advantage of using this communication protocol is that you can connect more than one device via I<sup>2</sup>C using just the SDA and SCL pins—no need to use additional pins on the header.</p>
</div>
<h4 class="h4" id="lev83"><span class="green2"><strong>Entering the Script</strong></span></h4>
<p class="noindent">Open <strong>Python 3 (IDLE)</strong> and go to <strong>File</strong> <span class="ent">▸</span> <strong>New File</strong> to create a new script. Copy the code shown in <a href="ch07.xhtml#ch07list4">Listing 7-4</a> to the Python Editor and save the script as <em>weather_forecast.py</em> inside the <em>Displays</em> folder (remember that you can download all the scripts at <em><a href="https://www.nostarch.com/RaspberryPiProject/">https://www.nostarch.com/RaspberryPiProject/</a></em>):</p>
<p class="listing" id="ch07list4"><strong>LISTING 7-4:</strong> The <em>weather_forecast.py</em> script</p>
<div class="box">
<p class="programs"><span class="ent">➊</span> <span class="orange">import</span> time<br/>  <span class="orange">import</span> Adafruit_SSD1306<br/>  <span class="orange">import</span> requests<br/><br/>  <span class="orange">from</span> PIL <span class="orange">import</span> Image<br/>  <span class="orange">from</span> PIL <span class="orange">import</span> ImageDraw<br/>  <span class="orange">from</span> PIL <span class="orange">import</span> ImageFont<br/><br/>  <span class="red1">#Raspberry Pi pin configuration</span><br/><span class="ent">➋</span> RST = 24<br/><br/><span class="ent">➌</span> <span class="red1">#128x32 display with hardware I2C</span><br/>  <span class="red1">#disp = Adafruit_SSD1306.SSD1306_128_32(rst=RST)</span><br/><br/>  <span class="red1">#128x64 display with hardware I2C</span><br/>  disp = Adafruit_SSD1306.SSD1306_128_64(rst=RST)<br/><br/><span epub:type="pagebreak" id="page_106"/>  <span class="red1">#set your unique OpenWeatherMap.org URL</span><br/><span class="ent">➍</span> open_weather_map_url = <span class="green">'http://api.openweathermap.org/data/2.5/</span><br/>  <span class="green">weather?q=Porto,PT&amp;APPID=801d2603e9f2e1c70e042e4f5f6e0---'</span><br/><br/>  <span class="red1">#initialize display</span><br/><span class="ent">➎</span> disp.begin()<br/><br/>  <span class="orange">while True</span>:<br/>      <span class="red1">#clear display</span><br/>      disp.clear()<br/>      disp.display()<br/><br/>      <span class="red1">#create blank image for drawing</span><br/>      <span class="red1">#make sure to create image with mode '1' for 1-bit color</span><br/>      width = disp.width<br/>      height = disp.height<br/>      image = Image.new(<span class="green">'1'</span>, (width, height))<br/><br/>      <span class="red1">#get drawing object to draw on image</span><br/>      draw = ImageDraw.Draw(image)<br/><br/>      <span class="red1">#draw a black filled box to clear the image</span><br/>      draw.rectangle((0,0,width,height), outline=0, fill=0)<br/><br/>      <span class="red1">#define constants to define drawing area</span><br/>      padding = 2<br/>      top = padding<br/><br/>      <span class="red1">#move left to right, keeping track of the current x position</span><br/>      <span class="red1">#for drawing text</span><br/>      x = padding<br/><br/>      <span class="red1">#load default font</span><br/>      font = ImageFont.load_default()<br/><br/>      <span class="red1">#openWeatherMap.org weather data request</span><br/><span class="ent">➏</span>     weather_data = requests.get(open_weather_map_url)<br/><br/>      <span class="red1">#display location</span><br/><span class="ent">➐</span>     location = weather_data.json().get(<span class="green">'name'</span>) + <span class="green">' - '</span><br/>  + weather_data.json().get(<span class="green">'sys'</span>).get(<span class="green">'country'</span>)<br/>      draw.text((x, top), location, font=font, fill=255)<br/><br/>      <span class="red1">#display description</span><br/>      description = <span class="green">'</span><span class="green">Desc '</span> + weather_data.json().get(<span class="green">'weather'</span>)[0]<br/>  .get(<span class="green">'main'</span>)<br/>      draw.text((x, top+10), description,  font=font, fill=255)<br/><br/>      raw_temperature = weather_data.json().get(<span class="green">'main'</span>)<br/>  .get(<span class="green">'temp'</span>)-273.15<br/><br/><span epub:type="pagebreak" id="page_107"/>      <span class="red1">#temperature in Celsius</span><br/>      temperature = <span class="green">'Temp '</span> + str(raw_temperature) + <span class="green">'*C'</span><br/><br/>      <span class="red1">#uncomment for temperature in Fahrenheit</span><br/>      <span class="red1">#temperature = 'Temp ' + str(raw_temperature*(9/5.0)+32) + '*F'</span><br/>      <span class="red1">#display temperature</span><br/>      draw.text((x, top+20), temperature, font=font, fill=255)<br/><br/>      <span class="red1">#display pressure</span><br/>      pressure = <span class="green">'Pres '</span> + str(weather_data.json().get(<span class="green">'main'</span>)<br/>  .get(<span class="green">'pressure'</span>)) + <span class="green">'hPa'</span><br/>      draw.text((x, top+30), pressure, font=font, fill=255)<br/><br/>      <span class="red1">#display humidity</span><br/>      humidity = <span class="green">'Humi '</span> + str(weather_data.json().get(<span class="green">'main'</span>)<br/>  .get(<span class="green">'humidity'</span>)) + <span class="green">'%'</span><br/>      draw.text((x, top+40), humidity, font=font, fill=255)<br/><br/>      <span class="red1">#display wind</span><br/>      wind = <span class="green">'Wind '</span> + str(weather_data.json().get(<span class="green">'wind'</span>)<br/>  .get(<span class="green">'speed'</span>)) + <span class="green">'mps '</span> + str(weather_data.json().get(<span class="green">'wind'</span>)<br/>  .get(<span class="green">'deg'</span>)) + <span class="green">'*'</span><br/>      draw.text((x, top+50), wind, font=font, fill=255)<br/><br/>      <span class="red1">#display image</span><br/><span class="ent">➑</span>     disp.image(image)<br/>      disp.display()<br/>      time.sleep(10)</p>
</div>
<p class="indent">As usual, your code starts by importing the required libraries <span class="ent">➊</span>. The Adafruit_SSD1306 library contains the OLED display driver classes. From the Python Imaging Library (PIL) you import three modules—<span class="literal">Image</span>, <span class="literal">ImageDraw</span>, and <span class="literal">ImageFont</span>—to create an image with the text that you’re going to display on the OLED.</p>
<div class="box3">
<p class="box-title"><span class="green2"><strong>THE OLED LIBRARIES</strong></span></p>
<p class="box-p">The Adafruit_SSD1306 library refers to everything shown on the OLED display as an “image”—even text. The three modules you’re using here have the following roles:</p>
<ul>
<li class="noindent">Image creates a new image.</li>
<li class="noindent">ImageDraw draws the text or icons inside the image and shows what you’ll see on the actual OLED display.</li>
<li class="noindent">ImageFont sets the text font.</li>
</ul>
</div>
<h5 class="h5"><span epub:type="pagebreak" id="page_108"/><strong>Initializing the OLED Display</strong></h5>
<p class="noindent">Even if your display doesn’t have a reset pin, you need to set the <span class="literal">RST</span> pin in your code. If your display does have a reset pin, it should be connected to GPIO 24. So, in either case, you set <span class="literal">RST</span> to <span class="literal">24</span> here <span class="ent">➋</span>.</p>
<p class="indent">At <span class="ent">➌</span>, you create a class for your display. For a 128×32 display, create the class <span class="literal">SSD1306_128_32</span>; for a 128×64 display, create the class <span class="literal">SSD1306_128_64</span>. We’ve given both options in the code so you can just uncomment the line that matches your display size and comment out the other.</p>
<p class="indent">At <span class="ent">➎</span>, you initialize the display library and prepare the display so that you can draw text on it. We’ve commented the code heavily to help you understand the purpose of each line.</p>
<h5 class="h5"><strong>Making the API Request</strong></h5>
<p class="noindent">At <span class="ent">➍</span>, you create a variable called <span class="literal">open_weather_map_url</span> to hold the API URL. Make sure to update this line with your own API URL.</p>
<p class="indent">At <span class="ent">➏</span>, you make the API request, after which there are several blocks of code that work similarly. We’ll explain the one at <span class="ent">➐</span>, and then you’ll be able to follow what the rest are doing. You create a variable, <span class="literal">location</span>, to get the location. This variable is a concatenation of several strings. First, you get the location using <span class="literal">weather_data.json().get('name')</span>, which in this example returns <span class="literal">Porto</span>. You add a hyphen by using <span class="literal">+ ' - '</span> and then the country code using <span class="literal">weather_data.json().get('sys').get('country')</span>; in this example, it returns <span class="literal">PT</span>. So, the <span class="literal">location</span> variable returns <span class="literal">Porto – PT</span>.</p>
<h5 class="h5"><strong>Drawing Text on the OLED Display</strong></h5>
<p class="noindent">To draw text on the display, you use the <span class="literal">draw.text()</span> function, which takes the following parameters:</p>
<p class="noindent"><span class="green2"><span class="codestrong">x and y coordinates</span></span>  Where the text starts being drawn</p>
<p class="noindent"><span class="green2"><span class="codestrong">text</span></span>  The text to display</p>
<p class="noindent"><span class="green2"><span class="codestrong">font</span></span>  The font the text will appear in</p>
<p class="noindent"><span class="green2"><span class="codestrong">fill</span></span>  The pixel brightness—255 is the maximum</p>
<p class="indent">For example, to display the location on the top line of the OLED forecaster, use the following:</p>
<div class="box">
<p class="programs">draw.text((x, top), location, font=font, fill=255)</p>
</div>
<p class="indent">The <span class="literal">x</span> and <span class="literal">top</span> coordinates were defined at <span class="ent">➎</span>. This example uses the default library font, though you should feel free to explore other fonts by downloading the font files and modifying the code.</p>
<p class="indent"><span epub:type="pagebreak" id="page_109"/>The blocks of code to display the weather description, temperature, pressure, humidity, and wind are all similar. Note that you need to increment the <span class="literal">to</span>p variable to draw text on the next line of the display.</p>
<p class="indent">Finally, the lines of code at <span class="ent">➑</span> display the image on the OLED. The delay time at the end determines how fast the loop updates the weather information—in this case, every 10 seconds.</p>
<h4 class="h4" id="lev84"><span class="green2"><strong>Running the Script</strong></span></h4>
<p class="noindent">Press <strong>F5</strong> or go to <strong>Run</strong> <span class="ent">▸</span> <strong>Run Module</strong> to run the script. Congratulations, now you have a tiny weather forecaster that will give you constantly updated data on the weather in your chosen location!</p>
<h3 class="h3" id="lev85"><span class="green2"><strong>TAKING IT FURTHER</strong></span></h3>
<p class="noindent">You can use APIs to get way more information than just the weather. With your favorite search engine, enter a query like <em>free API for &lt;thing&gt;</em> to find an API you can access. Here are some ideas to get you started:</p>
<ul>
<li class="noindent">Traffic</li>
<li class="noindent">Tweets</li>
<li class="noindent">Latest news</li>
<li class="noindent">Stock prices</li>
<li class="noindent">Current Bitcoin exchange rate</li>
</ul>


<h2 class="h2" id="ch08"><span epub:type="pagebreak" id="page_110"/><strong>8<br/>Pong with a Sense HAT</strong></h2>
<p class="noindent"><span class="green2">Here you’ll build your own LED Pong game using the Sense HAT. The Sense HAT is an add-on board for your Pi that gives it a lot more functionality through extra features like an LED matrix, joystick, and several sensors that get information from the outside world.</span></p>
<div class="image"><span epub:type="pagebreak" id="page_111"/><img src="../images/f0111-01.jpg" alt="image"/></div>
<p class="cap"><span class="green2"><strong>PARTS REQUIRED</strong></span></p>
<p class="cap1">Raspberry Pi (versions with 40 GPIOs)</p>
<p class="cap1">Sense HAT</p>
<p class="indentt"><span epub:type="pagebreak" id="page_112"/>You’ll use the Sense HAT’s LED matrix to display the game and the joystick to play. If you don’t have the hardware, not to worry: you’ll also learn how to use the Sense HAT emulator to create the same game without it.</p>
<h3 class="h3" id="lev86"><span class="green2"><strong>INTRODUCING PONG</strong></span></h3>
<p class="noindent">One of the first video games ever created, Pong is an immensely popular 2D table-tennis (ping-pong) game that can be played in single- or double-player mode. You’re going to create the single-player version, so it’s more like playing squash: you bounce the ball against the walls with your bat and catch it with the bat when it comes back. If you miss the ball, you lose.</p>
<h3 class="h3" id="lev87"><span class="green2"><strong>INTRODUCING THE RASPBERRY PI SENSE HAT</strong></span></h3>
<p class="noindent">The Raspberry Pi Sense HAT features an 8×8 RGB LED matrix, a five-button joystick, a gyroscope, an accelerometer, a magnetometer, a temperature sensor, a barometric sensor, and a humidity sensor in one package, shown in <a href="ch08.xhtml#ch08fig1">Figure 8-1</a>.</p>
<div class="image"><a id="ch08fig1"/><img src="../images/f0112-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 8-1:</strong> Raspberry Pi Sense HAT</p>
<h4 class="h4" id="lev88"><span class="green2"><strong>Mounting the Board</strong></span></h4>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>The Sense HAT is not compatible with Raspberry Pi 1 Model A and B, but you can build the project using the emulator if you have an incompatible board.</em></p>
</div>
<p class="noindent">This project doesn’t require much hardware assembly—you just need to mount the Sense HAT on the Pi, and the rest is done in code.</p>
<p class="indent">Attach the 40 GPIOs on the Sense HAT to the 40 GPIOs on your Raspberry Pi; the boards should line up perfectly. When you first successfully mount the Sense HAT on a powered Pi, the LED matrix displays an illuminated rainbow background as shown in <a href="ch08.xhtml#ch08fig2">Figure 8-2</a>.</p>
<div class="image"><span epub:type="pagebreak" id="page_113"/><a id="ch08fig2"/><img src="../images/f0113-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 8-2:</strong> Sense HAT welcome rainbow</p>
<h4 class="h4" id="lev89"><span class="green2"><strong>Using the Sense HAT Emulator</strong></span></h4>
<p class="noindent">If you don’t have a Sense HAT or a compatible board, or if you just want to test the script first, you can use the Sense HAT emulator to build the Pong game on your computer. The emulator is a virtual Sense HAT that you can interact with to test your scripts. To launch it from the Desktop main menu, go to <strong>Programming</strong> <span class="ent">▸</span> <strong>Sense HAT Emulator</strong>. This opens the emulator window, shown in <a href="ch08.xhtml#ch08fig3">Figure 8-3</a>.</p>
<div class="image"><a id="ch08fig3"/><img src="../images/f0113-02.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 8-3:</strong> Sense HAT Emulator window</p>
<p class="indent">The Sense HAT emulator comes with examples stored in <strong>File</strong> <span class="ent">▸</span> <strong>Examples</strong>; just select the example you want and then run the file to see the code in action in the emulator window.</p>
<h3 class="h3" id="lev90"><span epub:type="pagebreak" id="page_114"/><span class="green2"><strong>WORKING WITH SENSE HAT FUNCTIONS AND CONTROLS</strong></span></h3>
<p class="noindent">Before you go right into building the game, it’s important to understand how to control the LED matrix and read inputs from the joystick. Let’s look at some examples that you’ll use later in the Pong script.</p>
<h4 class="h4" id="lev91"><span class="green2"><strong>Controlling the LED Matrix</strong></span></h4>
<p class="noindent">The Sense HAT LED matrix has 8 columns and 8 rows, containing a total of 64 RGB LEDs. You can display text and create images on the matrix by controlling each LED individually. You can also set the color of each LED.</p>
<h5 class="h5"><strong>Displaying Text</strong></h5>
<p class="noindent">The code in <a href="ch08.xhtml#ch08list1">Listing 8-1</a> displays the scrolling text “Hello World!” in blue on the dot matrix.</p>
<p class="listing" id="ch08list1"><strong>LISTING 8-1:</strong> Display text on the Sense HAT LED matrix</p>
<div class="box">
<p class="programs"><span class="ent">➊</span> <span class="orange">from</span> sense_hat <span class="orange">import</span> SenseHat<br/>  <span class="red1">#uncomment the following line if you are using the emulator</span><br/><span class="ent">➋</span> <span class="red1">#from sense_emu import SenseHat</span><br/>  sense = SenseHat()<br/><span class="ent">➌</span> sense.show_message(<span class="green">'Hello World!'</span>, text_colour = [0, 0, 255])</p>
</div>
<p class="indent">First import the <span class="literal">SenseHat</span> class <span class="ent">➊</span>. If you’re using the emulator, delete or comment out this line and uncomment the code at <span class="ent">➋</span>.</p>
<p class="indent">The <span class="literal">show_message()</span> function <span class="ent">➌</span> accepts the message to display—a text string—as the first parameter, and then takes several options as further parameters:</p>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>The sense_hat library uses the British spelling “colour,” so you must use “colour” throughout your code.</em></p>
</div>
<ul>
<li class="noindent">Use <span class="literal">text_colour = [<em>r</em>, <em>g</em>, <em>b</em>]</span> to set the RGB color of the text, replacing <span class="literal"><em>r</em>, <em>g</em>, <em>b</em></span> with integers between <span class="literal">0</span> and <span class="literal">255</span> (as you did in <a href="ch05.xhtml#ch05">Project 5</a>).</li>
<li class="noindent">Use <span class="literal">scroll_speed = <em>x</em></span>, where <span class="codeitalic">x</span> is a float, to control the speed at which text moves across the display. The default scrolling speed is set to pause for 0.1 seconds each time the text shifts one pixel to the left.</li>
<li class="noindent">Use <span class="literal">back_colour = [<em>r</em>, <em>g</em>, <em>b</em>]</span> to set the background color, replacing <span class="literal"><em>r</em>, <em>g</em>, <em>b</em></span> with integer values as with <span class="literal">text_colour</span>.</li>
</ul>
<h5 class="h5"><strong>Controlling Specific LEDs</strong></h5>
<p class="noindent">To control individual LEDs, you refer to each LED you want to light by its position in the matrix. For that, the Sense HAT uses an (x, y) coordinate system. For example, the LEDs in <a href="ch08.xhtml#ch08fig4">Figure 8-4</a> have the coordinates listed next to the diagram.</p>
<div class="image"><span epub:type="pagebreak" id="page_115"/><a id="ch08fig4"/><img src="../images/f0115-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 8-4:</strong> Sense HAT coordinate system</p>
<p class="indent">To light up the LEDs in <a href="ch08.xhtml#ch08fig4">Figure 8-4</a> with their corresponding colors, you’d use the code in <a href="ch08.xhtml#ch08list2">Listing 8-2</a>.</p>
<p class="listing" id="ch08list2"><strong>LISTING 8-2:</strong> Using <span class="literal">set_pixel()</span> to light particular LEDs</p>
<div class="box">
<p class="programs"><span class="orange">from</span> sense_hat <span class="orange">import</span> SenseHat<br/><span class="red1">#uncomment the following line if you are using the emulator</span><br/><span class="red1">#from sense_emu import SenseHat</span><br/>sense = SenseHat()<br/><span class="red1">#set blue pixel</span><br/>sense.set_pixel(0, 1, 0, 0, 255)<br/><span class="red1">#set green pixel</span><br/>sense.set_pixel(7, 6, 0, 255, 0)<br/><span class="red1">#set pink pixel</span><br/>sense.set_pixel(2, 5, 255, 51, 153)</p>
</div>
<p class="indent">The function <span class="literal">sense.set_pixel(<em>x</em>, <em>y</em>, <em>r</em>, <em>g</em>, <em>b</em>)</span> lights up a specific LED, in which <span class="codeitalic">x</span> is the x-coordinate; <span class="codeitalic">y</span> is the y-coordinate; and <span class="codeitalic">r</span>, <span class="codeitalic">g</span>, and <span class="codeitalic">b</span> set the color.</p>
<h5 class="h5"><strong>Displaying a Picture</strong></h5>
<p class="noindent">Rather than controlling individual LEDs, you can use the function <span class="literal">sense.set_pixels()</span> to more quickly display an image. Instead of entering coordinates, you insert a list for all 64 LEDs that determines the color of each LED. Take a look at the code in <a href="ch08.xhtml#ch08list3">Listing 8-3</a>, which displays a sad face.</p>
<p class="listing" id="ch08list3"><strong>LISTING 8-3:</strong> Displaying an image with <span class="literal">set_pixels()</span></p>
<div class="box">
<p class="programs"><span class="orange">from</span> sense_hat <span class="orange">import</span> SenseHat<br/><span class="red1">#uncomment the following line if you are using the emulator</span><br/><span class="red1">#from sense_emu import SenseHat</span><br/>sense = SenseHat()<br/><br/><span class="red1">#red color</span><br/>X = [255, 0, 0]<br/><br/><span epub:type="pagebreak" id="page_116"/><span class="red1">#no color</span><br/>N = [0, 0, 0]<br/><br/><span class="red1">#sad face array</span><br/>sad_face = [<br/>N, N, <span class="red1">X</span>, <span class="red1">X</span>, <span class="red1">X</span>, <span class="red1">X</span>, N, N,<br/>N, <span class="red1">X</span>, N, N, N, N, <span class="red1">X</span>, N,<br/><span class="red1">X</span>, N, <span class="red1">X</span>, N, N, <span class="red1">X</span>, N, <span class="red1">X</span>,<br/><span class="red1">X</span>, N, N, N, N, N, N, <span class="red1">X</span>,<br/><span class="red1">X</span>, N, N, <span class="red1">X</span>, <span class="red1">X</span>, N, N, <span class="red1">X</span>,<br/><span class="red1">X</span>, N, <span class="red1">X</span>, N, N, <span class="red1">X</span>, N, <span class="red1">X</span>,<br/>N, <span class="red1">X</span>, N, N, N, N, <span class="red1">X</span>, N,<br/>N, N, <span class="red1">X</span>, <span class="red1">X</span>, <span class="red1">X</span>, <span class="red1">X</span>, N, N<br/>]<br/><br/>sense.set_pixels(sad_face)</p>
</div>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>The red Xs in the <span class="literal">sad_face</span> array won’t appear red in your code. We’re just highlighting them so it’s easier to visualize how the LEDs will look.</em></p>
</div>
<p class="indent">You create a variable to store the color of the lit LEDs (<span class="literal">X</span>), and a variable to store the color of the background (<span class="literal">N</span>)—you can set the background to any color or set it to <span class="literal">0</span> to keep it unlit. Then you need to create an array that sets each of the 64 LEDs either to <span class="literal">X</span> or to <span class="literal">N</span>. <a href="ch08.xhtml#ch08fig5">Figure 8-5</a> shows the end result of the code in <a href="ch08.xhtml#ch08list3">Listing 8-3</a>:</p>
<div class="image"><a id="ch08fig5"/><img src="../images/f0116-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 8-5:</strong> Displaying a sad face on the LED matrix</p>
<p class="indent">You can include as many colors as you want in your drawing; you just need to change the color parameters. We encourage you to practice working with the LED matrix by changing the colors and drawing your own images.</p>
<p class="indent">Now that you know how to control the LED matrix, let’s look at how to program the joystick.</p>
<h4 class="h4" id="lev92"><span epub:type="pagebreak" id="page_117"/><span class="green2"><strong>Reading Data from the Joystick</strong></span></h4>
<p class="noindent">The joystick that comes with the Sense HAT has five control options:</p>
<ul>
<li class="noindent">Move up</li>
<li class="noindent">Move down</li>
<li class="noindent">Move right</li>
<li class="noindent">Move left</li>
<li class="noindent">Press</li>
</ul>
<p class="indent">You need to tell your program what each control option should make the Pi do. The script in <a href="ch08.xhtml#ch08list4">Listing 8-4</a> sets the events associated with each joystick control, and displays a message on the computer screen saying which control was used:</p>
<p class="listing" id="ch08list4"><strong>LISTING 8-4:</strong> Associating events with each joystick control</p>
<div class="box">
<p class="programs">  <span class="orange">from</span> signal <span class="orange">import</span> pause<br/><br/>  <span class="orange">from</span> sense_hat <span class="orange">import</span> SenseHatm<br/>  <span class="red1">#uncomment the following line if you are using the emulator</span><br/>  <span class="red1">#from sense_emu import SenseHat</span><br/>  sense = SenseHat()<br/><br/><span class="ent">➊</span> <span class="orange">def</span> <span class="blue">move_up</span>(event):<br/>      <span class="purple">print</span>(<span class="green">'joystick was moved up'</span>)<br/><br/>  <span class="orange">def</span> <span class="blue">move_down</span>(event):<br/>      <span class="purple">print</span>(<span class="green">'joystick was moved down'</span>)<br/><br/>  <span class="orange">def</span> <span class="blue">move_right</span>(event):<br/>      <span class="purple">print</span>(<span class="green">'joystick was moved right'</span>)<br/><br/>  <span class="orange">def</span> <span class="blue">move_left</span>(event):<br/>      <span class="purple">print</span>(<span class="green">'joystick was moved left'</span>)<br/><br/>  <span class="orange">def</span> <span class="blue">move_middle</span>(event):<br/>      <span class="purple">print</span>(<span class="green">'joystick was pressed'</span>)<br/><br/><span class="ent">➋</span> sense.stick.direction_up = move_up<br/>  sense.stick.direction_down = move_down<br/>  sense.stick.direction_right = move_right<br/>  sense.stick.direction_left = move_left<br/>  sense.stick.direction_middle = move_middle<br/><br/>  pause()</p>
</div>
<p class="indent">First, you need to tell your Pi what action to take when each joystick control is triggered. You do that by defining a series of functions to perform actions. For example, when the joystick is <span epub:type="pagebreak" id="page_118"/>moved up, you call the function <span class="literal">move_up()</span> <span class="ent">➊</span> to print the message <span class="literal">joystick was moved up</span>. The <span class="literal">event</span> argument tells the Pi that the joystick will be sending information to those functions. Then you use <span class="literal">sense.stick.direction_up = move_up</span> <span class="ent">➋</span> to associate the <span class="literal">move_up</span> function with the up movement of the joystick.</p>
<p class="indent">The other movement functions work in the same way.</p>
<h3 class="h3" id="lev93"><span class="green2"><strong>WRITING THE SCRIPT</strong></span></h3>
<p class="noindent">Now that you know how to display text and drawings on the LED matrix and how to make something happen when the joystick is used, you’re ready to start writing the script for your game.</p>
<p class="indent">Here’s what the game aims to do:</p>
<ul>
<li class="noindent">A bat that is 3 pixels long and 1 pixel wide should appear in column 0.</li>
<li class="noindent">Each time you move the joystick up or down, the bat should move correspondingly.</li>
<li class="noindent">The ball should start in a random position and move diagonally.</li>
<li class="noindent">When the ball hits something—walls, ceiling, or the bat—it should move diagonally in the opposite direction.</li>
<li class="noindent">If the ball hits column 0, it means you missed the ball, so you lose and the game is over.</li>
</ul>
<h4 class="h4" id="lev94"><span class="green2"><strong>Entering the Script</strong></span></h4>
<p class="noindent">Open <strong>Python 3 (IDLE)</strong> and go to <strong>File</strong> <span class="ent">▸</span> <strong>New File</strong> to create a new script. Then copy the code in <a href="ch08.xhtml#ch08list5">Listing 8-5</a> to the new file and save the script as <em>pong_game.py</em> inside the <em>Displays</em> folder (remember that you can download all the scripts at <em><a href="https://www.nostarch.com/RaspberryPiProject/">https://www.nostarch.com/RaspberryPiProject/</a></em>).</p>
<p class="listing" id="ch08list5"><strong>LISTING 8-5:</strong> The Pong game code</p>
<div class="box">
<p class="programs">  <span class="red1">#based on raspberrypi.org Sense HAT Pong example</span><br/><br/>  <span class="red1">#import necessary libraries</span><br/><span class="ent">➊</span> from <span class="orange">random</span> import <span class="orange">randint</span><br/>  from <span class="orange">time</span> import <span class="orange">sleep</span><br/><br/>  <span class="red1">#use this line if you are using the Sense HAT board</span><br/>  <span class="orange">from</span> sense_hat <span class="orange">import</span> SenseHat<br/>  <span class="red1">#uncomment the following line if you are using the emulator</span><br/>  <span class="red1">#from sense_emu import SenseHat</span><br/><br/>  <span class="red1">#create an object called sense</span><br/><span class="ent">➋</span> sense = SenseHat()<br/><br/><span epub:type="pagebreak" id="page_119"/>  <span class="red1">#set bat position, random ball position, and velocity</span><br/><span class="ent">➌</span> y = 4<br/><span class="ent">➍</span> ball_position = [<span class="purple">int</span>(randint(2,6)), <span class="purple">int</span>(randint(1,6))]<br/><span class="ent">➎</span> ball_velocity = [1, 1]<br/><br/>  <span class="red1">#red color</span><br/>  X = [255, 0, 0]<br/>  <span class="red1">#no color</span><br/>  N = [0, 0, 0]<br/><br/>  <span class="red1">#sad face array</span><br/>  sad_face = [<br/>  N, N, X, X, X, X, N, N,<br/>  N, X, N, N, N, N, X, N,<br/>  X, N, X, N, N, X, N, X,<br/>  X, N, N, X, N, N, N, X,<br/>  X, N, N, X, N, N, N, X,<br/>  X, N, X, N, N, X, N, X,<br/>  N, X, N, N, N, N, X, N,<br/>  N, N, X, X, X, X, N, N<br/>  ]<br/><br/>  <span class="red1">#draw bat at y position</span><br/><span class="ent">➏</span> <span class="orange">def</span> <span class="blue">draw_bat</span>():<br/>      sense.set_pixel(0, y, 0, 255, 0)<br/>      sense.set_pixel(0, y+1, 0, 255, 0)<br/>      sense.set_pixel(0, y-1, 0, 255, 0)<br/><br/>  <span class="red1">#move bat up</span><br/><span class="ent">➐</span> <span class="orange">def</span> <span class="blue">move_up</span>(event):<br/>      <span class="orange">global</span> y<br/>      <span class="orange">if</span> y &gt; 1 <span class="orange">and</span> event.action==<span class="green">'pressed'</span>:<br/>          y -= 1<br/><br/>  <span class="red1">#move bat down</span><br/>  <span class="orange">def</span> <span class="blue">move_down</span>(event):<br/>      <span class="orange">global</span> y<br/>      <span class="orange">if</span> y &lt; 6 <span class="orange">and</span> event.action==<span class="green">'pressed'</span>:<br/>          y += 1<br/><br/>  <span class="red1">#move ball to the next position</span><br/><span class="ent">➑</span> <span class="orange">def</span> <span class="blue">draw_ball</span>():<br/>      <span class="red1">#ball displayed on current position</span><br/>      sense.set_pixel(ball_position[0], ball_position[1], 75, 0, 255)<br/>      <span class="red1">#next ball position</span><br/>      ball_position[0] += ball_velocity[0]<br/>      ball_position[1] += ball_velocity[1]<br/>      <span class="red1">#if ball hits ceiling, calculate next position</span><br/>      <span class="orange">if</span> ball_position[0] == 7:<br/>          ball_velocity[0] = -ball_velocity[0]<br/>      <span class="red1">#if ball hits wall, calculate next position</span><br/>      <span class="orange">if</span> ball_position[1] == 0 <span class="orange">or</span> ball_position[1] == 7:<br/>          ball_velocity[1] = -ball_velocity[1]<br/><span epub:type="pagebreak" id="page_120"/>      <span class="red1">#if ball reaches 0 position, player loses and game quits</span><br/>      <span class="orange">if</span> ball_position[0] == 0:<br/>          sleep(0.25)<br/>          sense.set_pixels(sad_face)<br/>          <span class="purple">quit</span>()<br/>      <span class="red1">#if ball hits bat, calculate next ball position</span><br/>      <span class="orange">if</span> ball_position[0] == 1 <span class="orange">and</span> y - 1 &lt;= ball_position[1] &lt;= y+1:<br/>          ball_velocity[0] = -ball_velocity[0]<br/><br/>  <span class="red1">#when joystick moves up or down, trigger corresponding function</span><br/><span class="ent">➒</span> sense.stick.direction_up = move_up<br/>  sense.stick.direction_down = move_down<br/><br/>  <span class="red1">#run the game</span><br/><span class="ent">➓</span> <span class="orange">while True</span>:<br/>      sense.clear()<br/>      draw_bat()<br/>      draw_ball()<br/>      sleep(0.25)</p>
</div>
<p class="indent">There’s a lot going on in this code. Let’s walk through it step by step.</p>
<h5 class="h5"><strong>Importing Necessary Libraries</strong></h5>
<p class="noindent">At <span class="ent">➊</span>, you import the <span class="literal">randint()</span> function from the rand library to generate pseudorandom integers and the <span class="literal">sleep()</span> function from the time library to set delay times.</p>
<p class="indent">At <span class="ent">➋</span>, you create an object called <span class="literal">sense</span> that will be used to refer to the Sense HAT throughout the code.</p>
<h5 class="h5"><strong>Creating the Bat</strong></h5>
<p class="noindent">The bat is a 3-pixel bar that moves up and down the leftmost column. At <span class="ent">➌</span>, you define the bat’s starting position at 4 pixels down from the top with <span class="literal">y = 4</span>. The complete bat is drawn in green within the <span class="literal">draw_bat()</span> function <span class="ent">➏</span>, which adds one more pixel to the top of the starting position (<span class="literal">y - 1</span>) and to the bottom (<span class="literal">y + 1</span>) to make the bat 3 pixels long.</p>
<h5 class="h5"><strong>Moving the Bat</strong></h5>
<p class="noindent">The bat moves just on the y-axis, so its x-coordinate is always <span class="literal">0</span>, but its y-coordinate needs to change as the player moves the bat. In other words, the player can only move the bat up and down. The <span class="literal">move_up()</span> and <span class="literal">move_down()</span> functions, defined at <span class="ent">➐</span>, control those movements. At <span class="ent">➒</span>, you tell the Pi what action to take when the player moves the joystick up or down by calling <span class="literal">move_up()</span> and <span class="literal">move_down()</span>, respectively.</p>
<p class="indent">Take a closer look at the <span class="literal">move_up()</span> function (the <span class="literal">move_down()</span> function works in a similar way):</p>
<div class="box">
<p class="programs"><span epub:type="pagebreak" id="page_121"/><span class="red1">#move bat up</span><br/><span class="orange">def</span> <span class="blue">move_up</span>(event):<br/>    <span class="orange">global</span> y<br/>    <span class="orange">if</span> y &gt; 1 <span class="orange">and</span> event.action==<span class="green">'pressed'</span>:<br/>        y -= 1</p>
</div>
<p class="indent">The <span class="literal">move_up()</span> function accepts <span class="literal">event</span> as a parameter. Basically, the <span class="literal">event</span> parameter allows you to pass some information about the joystick to the function—such as the time the stick was used; the direction it was pushed; and if it was pressed, released, or held—so the Pi knows how to react.</p>
<div class="note">
<p class="notet"><strong>HINT</strong></p>
<p class="notep"><em>Writing</em> <span class="literal">y -= 1</span> <em>in Python is equal to</em> <span class="literal">y = y - 1</span>.</p>
</div>
<p class="indent">When the player moves the joystick up, the function moves the y-coordinate of the bat up by subtracting <span class="literal">1</span> from the variable <span class="literal">y</span>. But first, the code checks that <span class="literal">y &gt; 1</span>; otherwise, the bat may end up moving out of the matrix.</p>
<h5 class="h5"><strong>Declaring Variable Scope</strong></h5>
<p class="noindent">Note that <span class="literal">y</span> is defined as a <span class="literal">global</span> variable. Not all variables in a program are accessible at all locations in the program, so there might be areas where it is invalid to call a certain variable. A variable’s <em>scope</em> is the area of a program where it is accessible. In Python, there are two basic variable scopes: <em>local</em> and <em>global</em>.</p>
<p class="indent">A variable defined in the main code body is global, meaning it is accessible anywhere else in the code. A variable defined inside a function is local to that function, so what you do with the local variable inside the function has no effect on variables outside, even if they have the same name.</p>
<p class="indent">As you want <span class="literal">y</span> to be usable both inside the function where it is defined and throughout the code, it needs to be declared as <span class="literal">global</span>. Otherwise, when you move the joystick nothing will happen, because the <span class="literal">y</span> variable is just being changed inside the function and not in the main body of the code.</p>
<h5 class="h5"><strong>Creating the Ball</strong></h5>
<p class="noindent">To make a moving ball, you first need a starting position and a velocity. At <span class="ent">➍</span>, you set the ball’s starting position using a list. Lists are defined between square brackets, <span class="literal">[<em>0th element</em>, <em>1st element</em>, ..., <em>nth element</em>]</span>, and each element is separated by a comma. The elements in the lists have <em>zero indexing</em>, meaning the index for the first element is 0, not 1. In this case, our 0th element is the x-position, and the 1st element is the y-position.</p>
<p class="indent"><span epub:type="pagebreak" id="page_122"/>When you start the game, the ball is in a random position, generated by the <span class="literal">randint()</span> function. That random position can be between 1 and 6 for the y-axis and 2 and 6 for the x-axis. These numbers ensure that the ball doesn’t start on the ceiling, walls, or next to the bat.</p>
<h5 class="h5"><strong>Moving the Ball</strong></h5>
<p class="noindent">Once you have a starting position for the ball, you need to give it a velocity <span class="ent">➎</span> to get it moving. You create a list for the ball’s velocity in which the 0th element is the velocity for the x-coordinate and the 1st element is the velocity for the y-coordinate.</p>
<p class="indent">You need to add or subtract the velocity to or from the current ball position to make the ball move forward or backward, respectively. The <span class="literal">draw_ball()</span> function at <span class="ent">➑</span> is where you display and move the ball, which always moves in diagonals. If it goes forward it continues forward, and if it goes backward it continues backward, unless it hits the ceiling or the bat, in which case it goes in the opposite direction.</p>
<h5 class="h5"><strong>Keeping the Game Running</strong></h5>
<p class="noindent">Once everything is set up, you add a <span class="literal">while</span> loop to keep the game running <span class="ent">➓</span>. The <span class="literal">while</span> loop starts by cleaning the display; then, it calls the function <span class="literal">draw_bat()</span> to draw the bat and <span class="literal">draw_ball()</span> to display the ball.</p>
<p class="indent">The <span class="literal">sleep()</span> function in the last line defines the time the ball takes to move to another position, so you can use this function to determine how fast the ball moves. If you increase the delay time, the game becomes slower and easier; if you decrease it, the game moves faster. We encourage you to experiment with different delay times.</p>
<h4 class="h4" id="lev95"><span class="green2"><strong>Running the Script</strong></span></h4>
<p class="noindent">Congratulations! After a lot of programming, you have your reward: you can play Pong on your Sense HAT! Press <strong>F5</strong> or go to <strong>Run</strong> <span class="ent">▸</span> <strong>Run Module</strong> to run the script.</p>
<p class="indent">When you lose and the game ends, the LED matrix displays a sad face as shown in <a href="ch08.xhtml#ch08fig6">Figure 8-6</a>.</p>
<div class="image"><span epub:type="pagebreak" id="page_123"/><a id="ch08fig6"/><img src="../images/f0123-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 8-6:</strong> LED matrix displaying a sad face when the game ends</p>
<h3 class="h3" id="lev96"><span class="green2"><strong>TAKING IT FURTHER</strong></span></h3>
<p class="noindent">Here are some ideas to upgrade your game:</p>
<ul>
<li class="noindent">Decrease the delay time as the game continues to increase the level of difficulty.</li>
<li class="noindent">Add a scoring system so that you earn a point every time the ball hits the bat, and display the score on the screen.</li>
<li class="noindent">Insert a condition that restarts the game when you press the joystick.<span epub:type="pagebreak" id="page_124"/></li>
</ul>
</body></html>