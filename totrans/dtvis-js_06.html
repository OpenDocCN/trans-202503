<html><head></head><body><section class="chapter" title="Chapter&#xA0;6.&#xA0;Visualizing Geographic Data" epub:type="chapter" id="visualizing_geographic_data"><div class="titlepage"><div><div><h2 class="title">Chapter 6. Visualizing Geographic Data</h2></div></div></div><p><a id="iddle1653" class="indexterm"/>Humans crave context when evaluating data, so it’s important to provide that context when it’s available. In the previous chapter, we saw how timelines can provide one frame of reference; now we’ll examine another equally important context: place. If a data set includes geographic coordinates or has values that correspond to different geographic regions, you can provide geographic context using a <a id="iddle1165" class="indexterm"/><a id="iddle1378" class="indexterm"/><a id="iddle1382" class="indexterm"/><a id="iddle1647" class="indexterm"/><a id="iddle1651" class="indexterm"/><a id="iddle1971" class="indexterm"/>map-based visualization. The examples in this chapter consider two types of map-based visualizations.</p><p>In the first two examples, we want to show how data varies by region. The resulting visualizations, known as choropleth maps, use color to highlight different characteristics of the different regions. For the next two examples, the visualization data doesn’t itself vary by region directly, but the data does have a geographic component. By showing the data on a map, we can help our users understand it.</p><p>More specifically, we’ll see the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>How to use special map fonts to create maps with minimal JavaScript</p></li><li class="listitem"><p>How to manipulate Scalable Vector Graphic (SVG) image maps with JavaScript</p></li><li class="listitem"><p>How to use a simple mapping library to add maps to web pages</p></li><li class="listitem"><p>How to integrate a full-featured map library into a visualization</p></li></ul></div><div class="sect1" title="Using Map Fonts"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="using_map_fonts">Using Map Fonts</h2></div></div></div><p>One technique for adding maps to web pages is surprisingly simple but often overlooked—map fonts. Two examples of these fonts are Stately (<span class="emphasis"><em><a class="ulink" href="http://intridea.github.io/stately/" target="_top">http://intridea.github.io/stately/</a></em></span>) for the United States and Continental (<span class="emphasis"><em><a class="ulink" href="http://contfont.net/" target="_top">http://contfont.net/</a></em></span>) for Europe. Map fonts are special-purpose web fonts whose character sets contain map symbols instead of letters and numbers. In just a few easy steps, we’ll create a visualization of Europe using the symbols from Continental.</p><div class="sect2" title="Step 1: Include the Fonts in the Page"><div class="titlepage"><div><div><h3 class="title" id="step_1_include_the_fonts_in_the_page">Step 1: Include the Fonts in the Page</h3></div></div></div><p>The main websites for both Stately and Continental include more detailed instructions for installing the fonts, but all that’s really necessary is including a single CSS style sheet. In the case of Continental, that style sheet is called, naturally, <span class="emphasis"><em>continental.css</em></span>. No JavaScript libraries are required.</p><a id="pro_id00257"/><pre class="programlisting"><span class="dodgerblue">&lt;!DOCTYPE</span> html<span class="dodgerblue">&gt;</span>
<span class="steelblue"><span class="strong"><strong>&lt;html</strong></span></span> <span class="steelblue">lang=</span><span class="maroon">"en"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;head&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;meta</strong></span></span> <span class="steelblue">charset=</span><span class="maroon">"utf-8"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;title&gt;&lt;/title&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;link</strong></span></span> <span class="steelblue">rel=</span><span class="maroon">"stylesheet"</span> <span class="steelblue">type=</span><span class="maroon">"text/css"</span> <span class="steelblue">href=</span><span class="maroon">"css/continental.css"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;/head&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;body&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"map"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;/body&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/html&gt;</strong></span></span></pre><div class="note" title="Note"><h3 class="title"><a id="ch06note01"/>Note</h3><p><a id="iddle1381" class="indexterm"/><a id="iddle1650" class="indexterm"/><a id="iddle1916" class="indexterm"/><span class="strong"><strong>For a production website, you might want to combine</strong></span> <span class="emphasis"><em>continental.css</em></span> <span class="strong"><strong>with your site’s other style sheets to minimize the number of network requests the browser has to make.</strong></span></p></div></div><div class="sect2" title="Step 2: Display One Country"><div class="titlepage"><div><div><h3 class="title" id="step_2_display_one_country">Step 2: Display One Country</h3></div></div></div><p>To show a single country, all we have to do is include an HTML <code class="literal">&lt;span&gt;</code> element with the appropriate attributes. We can do this right in the markup, adding a class attribute set to <code class="literal">map-</code> followed by a two-letter country abbreviation. (<span class="emphasis"><em>fr</em></span> is the international two-letter abbreviation for France.)</p><a id="pro_id00258"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"map"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;span</strong></span></span> <span class="steelblue">class=</span><span class="maroon">"map-fr"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/span&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/div&gt;</strong></span></span></pre><p>For this example, we’ll use JavaScript to generate the markup.</p><a id="pro_id00259"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> fr = <span class="steelblue">document</span>.<span class="olive">createElement</span>(<span class="maroon">"span"</span>);
<span class="steelblue">fr</span>.<span class="olive">className</span> = <span class="maroon">"map-fr"</span>;
<span class="steelblue">document</span>.<span class="olive">getElementById</span>(<span class="maroon">"map"</span>).<span class="olive">appendChild</span>(fr);</pre><p>Here we’ve created a new <code class="literal">&lt;span&gt;</code> element, giving it a class name of <code class="literal">"map-fr"</code>, and appending it to the map <code class="literal">&lt;div&gt;</code>.</p><p>One last bit of housekeeping is setting the size of the font. By default, any map font character will be the same size as a regular text character. For maps we want something much larger, so we can use standard CSS rules to increase the size.</p><a id="pro_id00260"/><pre class="programlisting"><span class="red">#map</span> <span class="steelblue"><span class="strong"><strong>{</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>font-size:</strong></span></span> <span class="dodgerblue">200px</span><span class="steelblue"><span class="strong"><strong>;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>}</strong></span></span></pre><p>That’s all it takes to add France to a web page, as you can see in <a class="xref" href="ch06.html#map_fonts_make_it_very_easy_to_add_a_map" title="Figure 6-1. Map fonts make it very easy to add a map to a web page.">Figure 6-1</a>.</p><div class="figure"><a id="map_fonts_make_it_very_easy_to_add_a_map"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00085"/><img src="figs/web/06fig01.png.jpg" alt="Map fonts make it very easy to add a map to a web page."/></div></div><div class="figure-title">Figure 6-1. Map fonts make it very easy to add a map to a web page.</div></div></div><div class="sect2" title="Step 3: Combine Multiple Countries into a Single Map"><div class="titlepage"><div><div><h3 class="title" id="step_3_combine_multiple_countries_into_a">Step 3: Combine Multiple Countries into a Single Map</h3></div></div></div><p><a id="iddle1380" class="indexterm"/><a id="iddle1649" class="indexterm"/><a id="iddle1917" class="indexterm"/>For this example we want to show more than a single country. We’d like to visualize the median age for all of Europe’s countries, based on United Nations population data (<span class="emphasis"><em><a class="ulink" href="http://www.un.org/en/development/desa/population/" target="_top">http://www.un.org/en/development/desa/population/</a></em></span>) from 2010. To do that, we’ll create a map that includes all European countries, and we’ll style each country according to the data.</p><p>The first step in this visualization is putting all of the countries into a single map. Since each country is a separate character in the Continental font, we want to overlay those characters on top of one another rather than spread them across the page. That requires setting a couple of CSS rules.</p><a id="pro_id00261"/><pre class="programlisting">  <span class="red">#map</span> <span class="steelblue"><span class="strong"><strong>{</strong></span></span>
➊    <span class="steelblue"><span class="strong"><strong>position:</strong></span></span> <span class="dodgerblue">relative</span><span class="steelblue"><span class="strong"><strong>;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>}</strong></span></span>
  <span class="red">#map</span> &gt; <span class="dodgerblue">[class*=</span><span class="maroon">"map-"</span><span class="dodgerblue">]</span> <span class="steelblue"><span class="strong"><strong>{</strong></span></span>
➋    <span class="steelblue"><span class="strong"><strong>position:</strong></span></span> <span class="dodgerblue">absolute</span><span class="steelblue"><span class="strong"><strong>;</strong></span></span>
➌    <span class="steelblue"><span class="strong"><strong>top:</strong></span></span> <span class="dodgerblue">0</span><span class="steelblue"><span class="strong"><strong>;</strong></span></span>
      <span class="steelblue"><span class="strong"><strong>left:</strong></span></span> <span class="dodgerblue">0</span><span class="steelblue"><span class="strong"><strong>;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>}</strong></span></span></pre><p>First we set the position of the outer container to <code class="literal">relative</code> ➊. This rule doesn’t change the styling of the outer container at all, but it does establish a <span class="emphasis"><em>positioning context</em></span> for anything within the container. Those elements will be our individual country symbols, and we set their position to be <code class="literal">absolute</code> ➋. We then place each one at the top and left ➌, respectively, of the map so they’ll overlay one another. Because we’ve positioned the container <code class="literal">relative</code>, the country symbols will be positioned relative to that container rather than to the page as a whole.</p><p>Note that we’ve used a couple of CSS tricks to apply this positioning to all of the individual symbols within this element. We start by selecting the element with an <code class="literal">id</code> of <code class="literal">map</code>. Nothing fancy there. The direct descendent selector (<code class="literal">&gt;</code>), however, says that what follows should match only elements that are immediate children of that element, not arbitrary descendants. Finally, the attribute selector <code class="literal">[class*="map-"]</code> specifies only children that have a class containing the characters <code class="literal">map-</code>. Since all the country symbols will be <code class="literal">&lt;span&gt;</code> elements with a class of <code class="literal">map-</code><span class="emphasis"><em><code class="literal">xx</code></em></span> (where <span class="emphasis"><em><code class="literal">xx</code></em></span> is the two-letter country abbreviation), this will match all of our countries.</p><p>In our JavaScript, we can start with an array listing all of the countries and iterate through it. For each country, we create a <code class="literal">&lt;span&gt;</code> element with the appropriate class and insert it in the map <code class="literal">&lt;div&gt;</code>.</p><a id="pro_id00262"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> countries = [
  <span class="maroon">"ad"</span>, <span class="maroon">"al"</span>, <span class="maroon">"at"</span>, <span class="maroon">"ba"</span>, <span class="maroon">"be"</span>, <span class="maroon">"bg"</span>, <span class="maroon">"by"</span>, <span class="maroon">"ch"</span>, <span class="maroon">"cy"</span>, <span class="maroon">"cz"</span>,
  <span class="maroon">"de"</span>, <span class="maroon">"dk"</span>, <span class="maroon">"ee"</span>, <span class="maroon">"es"</span>, <span class="maroon">"fi"</span>, <span class="maroon">"fo"</span>, <span class="maroon">"fr"</span>, <span class="maroon">"ge"</span>, <span class="maroon">"gg"</span>, <span class="maroon">"gr"</span>,
  <span class="maroon">"hr"</span>, <span class="maroon">"hu"</span>, <span class="maroon">"ie"</span>, <span class="maroon">"im"</span>, <span class="maroon">"is"</span>, <span class="maroon">"it"</span>, <span class="maroon">"je"</span>, <span class="maroon">"li"</span>, <span class="maroon">"lt"</span>, <span class="maroon">"lu"</span>,
  <span class="maroon">"lv"</span>, <span class="maroon">"mc"</span>, <span class="maroon">"md"</span>, <span class="maroon">"me"</span>, <span class="maroon">"mk"</span>, <span class="maroon">"mt"</span>, <span class="maroon">"nl"</span>, <span class="maroon">"no"</span>, <span class="maroon">"pl"</span>, <span class="maroon">"pt"</span>,
  <span class="maroon">"ro"</span>, <span class="maroon">"rs"</span>, <span class="maroon">"ru"</span>, <span class="maroon">"se"</span>, <span class="maroon">"si"</span>, <span class="maroon">"sk"</span>, <span class="maroon">"sm"</span>, <span class="maroon">"tr"</span>, <span class="maroon">"ua"</span>, <span class="maroon">"uk"</span>,
  <span class="maroon">"va"</span>
];
<span class="steelblue"><span class="strong"><strong>var</strong></span></span> map = <span class="steelblue">document</span>.<span class="olive">getElementById</span>(<span class="maroon">"map"</span>);
<span class="steelblue">countries</span>.<span class="olive">forEach</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(cc) {
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> span = <span class="steelblue">document</span>.<span class="olive">createElement</span>(<span class="maroon">"span"</span>);
    <span class="steelblue">span</span>.<span class="olive">className</span> = <span class="maroon">"map-"</span> + cc;
    <span class="steelblue">map</span>.<span class="olive">appendChild</span>(span);
});</pre><p><a id="iddle1383" class="indexterm"/><a id="iddle1652" class="indexterm"/>With these style rules defined, inserting multiple <code class="literal">&lt;span&gt;</code> elements within our map <code class="literal">&lt;div&gt;</code> creates the complete, if somewhat uninteresting, map of Europe shown in <a class="xref" href="ch06.html#overlaying_map_characters_on_top_of_one" title="Figure 6-2. Overlaying map characters on top of one another creates a complete map.">Figure 6-2</a>.</p><div class="figure"><a id="overlaying_map_characters_on_top_of_one"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00086"/><img src="figs/web/06fig02.png.jpg" alt="Overlaying map characters on top of one another creates a complete map."/></div></div><div class="figure-title">Figure 6-2. Overlaying map characters on top of one another creates a complete map.</div></div></div><div class="sect2" title="Step 4: Vary the Countries Based on the Data"><div class="titlepage"><div><div><h3 class="title" id="step_4_vary_the_countries_based_on_the_d">Step 4: Vary the Countries Based on the Data</h3></div></div></div><p>Now we’re ready to create the actual data visualization. Naturally, we’ll start with the data, in this case from the United Nations. Here’s how we could format that data in a JavaScript array. (The full data set can be found with the book’s source code at <span class="emphasis"><em><a class="ulink" href="http://jsDataV.is/source/" target="_top">http://jsDataV.is/source/</a></em></span>.)</p><a id="pro_id00263"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> ages = [
    { <span class="maroon">"country"</span>: <span class="maroon">"al"</span>, <span class="maroon">"age"</span>: <span class="red">29.968</span> },
    { <span class="maroon">"country"</span>: <span class="maroon">"at"</span>, <span class="maroon">"age"</span>: <span class="red">41.768</span> },
    { <span class="maroon">"country"</span>: <span class="maroon">"ba"</span>, <span class="maroon">"age"</span>: <span class="red">39.291</span> },
    { <span class="maroon">"country"</span>: <span class="maroon">"be"</span>, <span class="maroon">"age"</span>: <span class="red">41.301</span> },
    { <span class="maroon">"country"</span>: <span class="maroon">"bg"</span>, <span class="maroon">"age"</span>: <span class="red">41.731</span> },
    <span class="indianred"><span class="emphasis"><em>// Data set continues...</em></span></span></pre><p><a id="iddle1175" class="indexterm"/>There are several ways we could use this data to modify the map. We could use JavaScript code to set the visualization properties directly by, for example, changing the <code class="literal">color</code> style for each country symbol. That would work, but it forgoes one of the big advantages of map fonts. With map fonts, our visualization is standard HTML, so we can use standard CSS to style it. If, in the future, we want to change the styles on the page, they’ll all be contained within the style sheets, and we won’t have to hunt through our JavaScript code to adjust colors.</p><p>To indicate which styles are appropriate for an individual country symbol, we can attach a <code class="literal">data-</code> attribute to each.</p><a id="pro_id00264"/><pre class="programlisting">➊ <span class="steelblue"><span class="strong"><strong>var</strong></span></span> findCountryIndex = <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(cc) {
       <span class="steelblue"><span class="strong"><strong>for</strong></span></span> (<span class="steelblue"><span class="strong"><strong>var</strong></span></span> idx=<span class="red">0</span>; idx&lt;<span class="steelblue">ages</span>.<span class="olive">length</span>; idx++) {
           <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (ages[idx].<span class="olive">country</span> === cc) {
               <span class="steelblue"><span class="strong"><strong>return</strong></span></span> idx;
           }
       }
       <span class="steelblue"><span class="strong"><strong>return</strong></span></span> -<span class="red">1</span>;
   }
   <span class="steelblue"><span class="strong"><strong>var</strong></span></span> map = <span class="steelblue">document</span>.<span class="olive">getElementById</span>(<span class="maroon">"map"</span>);
   <span class="steelblue">countries</span>.<span class="olive">forEach</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(cc) {
       <span class="steelblue"><span class="strong"><strong>var</strong></span></span> idx = <span class="olive">findCountryIndex</span>(cc);
       <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (idx !== -<span class="red">1</span>) {
           <span class="steelblue"><span class="strong"><strong>var</strong></span></span> span = <span class="steelblue">document</span>.<span class="olive">createElement</span>(<span class="maroon">"span"</span>);
           <span class="steelblue">span</span>.<span class="olive">className</span> = <span class="maroon">"map-"</span> + cc;
➋         <span class="steelblue">span</span>.<span class="olive">setAttribute</span>(<span class="maroon">"data-age"</span>, <span class="steelblue">Math</span>.<span class="olive">round</span>(ages[idx].<span class="olive">age</span>));
           <span class="steelblue">map</span>.<span class="olive">appendChild</span>(span);
       }
   });</pre><p>In this code, we set the <code class="literal">data-age</code> attribute to the mean age, rounded to the nearest whole number ➋. To find the age for a given country, we need that country’s index in the <code class="literal">ages</code> array. The <code class="literal">findCountryIndex()</code> function ➊ does that in a straightforward way.</p><p>Now we can assign CSS style rules based on that <code class="literal">data-age</code> attribute. Here’s the start of a simple blue gradient for the different ages, where greater median ages are colored darker blue-green.</p><a id="pro_id00265"/><pre class="programlisting"><span class="red">#map</span> &gt; <span class="dodgerblue">[data-age=</span><span class="maroon">"44"</span><span class="dodgerblue">]</span> <span class="steelblue"><span class="strong"><strong>{</strong></span></span> <span class="steelblue"><span class="strong"><strong>color:</strong></span></span> <span class="dodgerblue">#2d9999</span><span class="steelblue"><span class="strong"><strong>;</strong></span></span> <span class="steelblue"><span class="strong"><strong>}</strong></span></span>
<span class="red">#map</span> &gt; <span class="dodgerblue">[data-age=</span><span class="maroon">"43"</span><span class="dodgerblue">]</span> <span class="steelblue"><span class="strong"><strong>{</strong></span></span> <span class="steelblue"><span class="strong"><strong>color:</strong></span></span> <span class="dodgerblue">#2a9493</span><span class="steelblue"><span class="strong"><strong>;</strong></span></span> <span class="steelblue"><span class="strong"><strong>}</strong></span></span>
<span class="red">#map</span> &gt; <span class="dodgerblue">[data-age=</span><span class="maroon">"42"</span><span class="dodgerblue">]</span> <span class="steelblue"><span class="strong"><strong>{</strong></span></span> <span class="steelblue"><span class="strong"><strong>color:</strong></span></span> <span class="dodgerblue">#278f8e</span><span class="steelblue"><span class="strong"><strong>;</strong></span></span> <span class="steelblue"><span class="strong"><strong>}</strong></span></span>
<span class="indianred"><span class="emphasis"><em>/* CSS rules continue... */</em></span></span></pre><div class="note" title="Note"><h3 class="title"><a id="ch06note02"/>Note</h3><p><a id="iddle1379" class="indexterm"/><a id="iddle1591" class="indexterm"/><a id="iddle1648" class="indexterm"/><span class="strong"><strong>Although they’re beyond the scope of this book, CSS preprocessors such as LESS (</strong></span><span class="emphasis"><em><a class="ulink" href="http://lesscss.org/" target="_top">http://lesscss.org/</a></em></span><span class="strong"><strong>) and SASS (</strong></span><span class="emphasis"><em><a class="ulink" href="http://sass-lang.com/" target="_top">http://sass-lang.com/</a></em></span><span class="strong"><strong>) make it easy to create these kinds of rules.</strong></span></p></div><p>Now we have the nice visualization of the age trends shown in <a class="xref" href="ch06.html#with_css_rulescomma_we_can_change_the_st" title="Figure 6-3. With CSS rules, we can change the styles of individual map symbols.">Figure 6-3</a>.</p><div class="figure"><a id="with_css_rulescomma_we_can_change_the_st"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00087"/><img src="figs/web/06fig03.png.jpg" alt="With CSS rules, we can change the styles of individual map symbols."/></div></div><div class="figure-title">Figure 6-3. With CSS rules, we can change the styles of individual map symbols.</div></div></div><div class="sect2" title="Step 5: Add a Legend"><div class="titlepage"><div><div><h3 class="title" id="step_5_add_a_legend">Step 5: Add a Legend</h3></div></div></div><p>To finish off the visualization, we can add a legend to the map. Because the map itself is nothing more than standard HTML elements with CSS styling, it’s easy to create a matching legend. This example covers a fairly broad range (ages 28 to 44), so a linear gradient works well as a key. Your own implementation will depend on the specific browser versions that you wish to support, but a generic style rule would be as follows:</p><a id="pro_id00266"/><pre class="programlisting"><span class="red">#map-legend</span> <span class="red">.key</span> <span class="steelblue"><span class="strong"><strong>{</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>background:</strong></span></span> linear-gradient(to <span class="dodgerblue">bottom</span>, <span class="dodgerblue">#004a4a</span> <span class="dodgerblue">0%</span>,<span class="dodgerblue">#2d9999</span> <span class="dodgerblue">100%</span>)<span class="steelblue"><span class="strong"><strong>;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>}</strong></span></span></pre><p>The resulting visualization in <a class="xref" href="ch06.html#standard_html_can_also_provide_a_legend" title="Figure 6-4. Standard HTML can also provide a legend for the visualization.">Figure 6-4</a> summarizes the median age for European countries in a clear and concise format.</p><div class="figure"><a id="standard_html_can_also_provide_a_legend"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00088"/><img src="figs/web/06fig04.png.jpg" alt="Standard HTML can also provide a legend for the visualization."/></div></div><div class="figure-title">Figure 6-4. Standard HTML can also provide a legend for the visualization.</div></div></div></div><div class="sect1" title="Working with Scalable Vector Graphics"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="working_with_scalable_vector_graphics">Working with Scalable Vector Graphics</h2></div></div></div><p><a id="iddle1661" class="indexterm"/><a id="iddle1850" class="indexterm"/>Map fonts like those in the previous example are easy to use and visually effective, but only a few map fonts exist, and they definitely don’t cover all the conceivable geographic regions. For visualizations of other regions, we’ll have to find a different technique. Maps, of course, are ultimately images, and web browsers can display many different image formats. One format in particular, called <span class="emphasis"><em>Scalable Vector Graphics (SVG)</em></span>, is especially well suited for interactive visualizations. That’s because, as we’ll see in this example, JavaScript code (as well as CSS styles) can easily and naturally interact with SVG images.</p><p>Although our example for this section deals with a map, the techniques here are by no means limited to maps. Whenever you have a diagram or illustration in SVG format, you can manipulate it directly on a web page.</p><div class="note" title="Note"><h3 class="title"><a id="ch06note03"/>Note</h3><p><span class="strong"><strong>There is one important consideration for using SVG: only modern web browsers support it. more specifically, IE8 (and earlier) cannot display SVG images. If a significant number of your users are using older browsers, you might want to consider alternatives.</strong></span></p></div><p>For web developers, SVG is especially convenient because its syntax uses the same structure as HTML. You can use many of the same tools and techniques for working with HTML on SVG as well. Consider, for example, a skeletal HTML document.</p><a id="pro_id00267"/><pre class="programlisting"><span class="dodgerblue">&lt;!DOCTYPE</span> html<span class="dodgerblue">&gt;</span>
<span class="steelblue"><span class="strong"><strong>&lt;html</strong></span></span> <span class="steelblue">lang=</span><span class="maroon">"en"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;head&gt;</strong></span></span><span class="indianred"><span class="emphasis"><em>&lt;!-- --&gt;</em></span></span><span class="steelblue"><span class="strong"><strong>&lt;/head&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;body&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;nav&gt;</strong></span></span><span class="indianred"><span class="emphasis"><em>&lt;!-- --&gt;</em></span></span><span class="steelblue"><span class="strong"><strong>&lt;/nav&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;main&gt;</strong></span></span>
      <span class="steelblue"><span class="strong"><strong>&lt;section&gt;</strong></span></span><span class="indianred"><span class="emphasis"><em>&lt;!-- --&gt;</em></span></span><span class="steelblue"><span class="strong"><strong>&lt;/section&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;/main&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;nav&gt;</strong></span></span><span class="indianred"><span class="emphasis"><em>&lt;!-- --&gt;</em></span></span><span class="steelblue"><span class="strong"><strong>&lt;/nav&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;/body&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/html&gt;</strong></span></span></pre><p><a id="iddle1176" class="indexterm"/>Compare that to the next example: the universal symbol for first aid represented in an SVG document.</p><div class="note" title="Note"><h3 class="title"><a id="ch06note04"/>Note</h3><p><span class="strong"><strong>If you have worked with htmL before htmL5, the similarities might be especially striking, as the SVG header text follows the same format as htmL4.</strong></span></p></div><a id="pro_id00268"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;?xml</strong></span></span> version="1.0" encoding="UTF-8"<span class="steelblue"><span class="strong"><strong>?&gt;</strong></span></span>
<span class="dodgerblue">&lt;!DOCTYPE</span> svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
    "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"<span class="dodgerblue">&gt;</span>
<span class="steelblue"><span class="strong"><strong>&lt;svg</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"firstaid"</span> <span class="steelblue">version=</span><span class="maroon">"1.1"</span> <span class="steelblue">xmlns=</span><span class="maroon">"http://www.w3.org/2000/svg"</span>
     <span class="steelblue">width=</span><span class="maroon">"100"</span> <span class="steelblue">height=</span><span class="maroon">"100"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;rect</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"background"</span> <span class="steelblue">x=</span><span class="maroon">"0"</span> <span class="steelblue">y=</span><span class="maroon">"0"</span> <span class="steelblue">width=</span><span class="maroon">"100"</span> <span class="steelblue">height=</span><span class="maroon">"100"</span> <span class="steelblue">rx=</span><span class="maroon">"20"</span> <span class="steelblue"><span class="strong"><strong>/&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;rect</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"vertical"</span>   <span class="steelblue">x="</span><span class="maroon">39"</span> <span class="steelblue">y=</span><span class="maroon">"19"</span> <span class="steelblue">width=</span><span class="maroon">"22"</span> <span class="steelblue">height=</span><span class="maroon">"62"</span> <span class="steelblue"><span class="strong"><strong>/&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;rect</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"horizontal"</span> <span class="steelblue">x=</span><span class="maroon">"19"</span> <span class="steelblue">y=</span><span class="maroon">"39"</span> <span class="steelblue">width=</span><span class="maroon">"62"</span> <span class="steelblue">height=</span><span class="maroon">"22"</span> <span class="steelblue"><span class="strong"><strong>/&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/svg&gt;</strong></span></span></pre><p>You can even style the SVG elements using CSS. Here’s how we could color the preceding image:</p><a id="pro_id00269"/><pre class="programlisting">svg<span class="red">#firstaid</span> <span class="steelblue"><span class="strong"><strong>{</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>stroke:</strong></span></span> <span class="dodgerblue">none</span><span class="steelblue"><span class="strong"><strong>;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>}</strong></span></span>
svg<span class="red">#firstaid</span> <span class="red">#background</span> <span class="steelblue"><span class="strong"><strong>{</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>fill:</strong></span></span> <span class="dodgerblue">#000</span><span class="steelblue"><span class="strong"><strong>;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>}</strong></span></span>
svg<span class="red">#firstaid</span> <span class="red">#vertical</span>,
svg<span class="red">#firstaid</span> <span class="red">#horizontal</span> <span class="steelblue"><span class="strong"><strong>{</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>fill:</strong></span></span> <span class="dodgerblue">#FFF</span><span class="steelblue"><span class="strong"><strong>;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>}</strong></span></span></pre><p><a class="xref" href="ch06.html#svg_images_may_be_embedded_directly_with" title="Figure 6-5. SVG images may be embedded directly within web pages.">Figure 6-5</a> shows how that SVG renders.</p><div class="figure"><a id="svg_images_may_be_embedded_directly_with"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00089"/><img src="figs/web/06fig05.png.jpg" alt="SVG images may be embedded directly within web pages."/></div></div><div class="figure-title">Figure 6-5. SVG images may be embedded directly within web pages.</div></div><p><a id="iddle1017" class="indexterm"/><a id="iddle1476" class="indexterm"/><a id="iddle1659" class="indexterm"/><a id="iddle1739" class="indexterm"/><a id="iddle1848" class="indexterm"/><a id="iddle1898" class="indexterm"/><a id="iddle2159" class="indexterm"/>The affinity between HTML and SVG is, in fact, far stronger than the similar syntax. With modern browsers, you can mix SVG and HTML in the same web page. To see how that works, let’s visualize health data for the 159 counties in the US state of Georgia. The data comes from County Health Rankings (<span class="emphasis"><em><a class="ulink" href="http://www.countyhealthrankings.org/" target="_top">http://www.countyhealthrankings.org/</a></em></span>).</p><div class="sect2" title="Step 1: Create the SVG Map"><div class="titlepage"><div><div><h3 class="title" id="step_1_create_the_svg_map">Step 1: Create the SVG Map</h3></div></div></div><p>Our visualization starts with a map, so we’ll need an illustration of Georgia’s counties in SVG format. Although that might seem like a challenge, there are actually many sources for SVG maps that are free to use, as well as special-purpose applications that can generate SVG maps for almost any region. The Wikimedia Commons (<span class="emphasis"><em><a class="ulink" href="http://commons.wikimedia.org/wiki/Main_Page" target="_top">http://commons.wikimedia.org/wiki/Main_Page</a></em></span>), for example, contains a large number of open source maps, including many of Georgia. We’ll use one showing data from the National Register of Historic Places (<span class="emphasis"><em><a class="ulink" href="http://commons.wikimedia.org/wiki/File:NRHP_Georgia_Map.svg#file" target="_top">http://commons.wikimedia.org/wiki/File:NRHP_Georgia_Map.svg#file</a></em></span>).</p><p>After downloading the map file, we can adjust it to better fit our needs, removing the legend, colors, and other elements that we don’t need. Although you can do this in a text editor (just as you can edit HTML), you may find it easier to use a graphics program such as Adobe Illustrator or a more web-focused app like Sketch (<span class="emphasis"><em><a class="ulink" href="http://www.bohemiancoding.com/sketch/" target="_top">http://www.bohemiancoding.com/sketch/</a></em></span>). You might also want to take advantage of an SVG optimization website (<span class="emphasis"><em><a class="ulink" href="http://petercollingridge.appspot.com/svg-optimiser/" target="_top">http://petercollingridge.appspot.com/svg-optimiser/</a></em></span>) or application (<span class="emphasis"><em><a class="ulink" href="https://github.com/svg/" target="_top">https://github.com/svg/</a></em></span>), which can compress an SVG by removing extraneous tags and reducing the sometimes-excessive precision of graphics programs.</p><p>Our result will be a series of <code class="literal">&lt;path&gt;</code> elements, one for each county. We’ll also want to assign a <code class="literal">class</code> or <code class="literal">id</code> to each path to indicate the county. The resulting SVG file might begin like the following.</p><a id="pro_id00270"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;svg</strong></span></span> <span class="steelblue">version=</span><span class="maroon">"1.1"</span> <span class="steelblue">xmlns=</span><span class="maroon">"http://www.w3.org/2000/svg"</span>
    <span class="steelblue">width=</span><span class="maroon">"497"</span> <span class="steelblue">height=</span><span class="maroon">"558"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;path</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"ck"</span> <span class="steelblue">d=</span><span class="maroon">"M 216.65,131.53 L 216.41,131.53 216.17,131.53..."</span> <span class="steelblue"><span class="strong"><strong>/&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;path</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"me"</span> <span class="steelblue">d=</span><span class="maroon">"M 74.32,234.01 L 74.32,232.09 74.32,231.61..."</span> <span class="steelblue"><span class="strong"><strong>/&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;path</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"ms"</span> <span class="steelblue">d=</span><span class="maroon">"M 64.96,319.22 L 64.72,319.22 64.48,318.98..."</span> <span class="steelblue"><span class="strong"><strong>/&gt;</strong></span></span>
    <span class="indianred"><span class="emphasis"><em>&lt;!-- Markup continues... --&gt;</em></span></span></pre><p>To summarize, here are the steps to create the SVG map.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Locate a suitably licensed SVG-format map file or create one using a special-purpose map application.</p></li><li class="listitem"><p>Edit the SVG file in a graphics application to remove extraneous components and simplify the illustration.</p></li><li class="listitem"><p>Optimize the SVG file using an optimization site or application.</p></li><li class="listitem"><p>Make final adjustments (such as adding <code class="literal">id</code> attributes) in your regular HTML editor.</p></li></ol></div></div><div class="sect2" title="Step 2: Embed the Map in the Page"><div class="titlepage"><div><div><h3 class="title" id="step_2_embed_the_map_in_the_page">Step 2: Embed the Map in the Page</h3></div></div></div><p><a id="iddle1463" class="indexterm"/><a id="iddle1660" class="indexterm"/><a id="iddle1740" class="indexterm"/><a id="iddle1849" class="indexterm"/>The simplest way to include an SVG map in a web page is to embed the SVG markup directly within the HTML markup. To include the first-aid symbol, for example, just include the SVG tags within the page itself, as shown at ➊ through ➋. You don’t have to include the header tags that are normally present in a standalone SVG file.</p><a id="pro_id00271"/><pre class="programlisting">   <span class="dodgerblue">&lt;!DOCTYPE</span> html<span class="dodgerblue">&gt;</span>
   <span class="steelblue"><span class="strong"><strong>&lt;html</strong></span></span> <span class="steelblue">lang=</span><span class="maroon">"en"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;head&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;meta</strong></span></span> <span class="steelblue">charset=</span><span class="maroon">"utf-8"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;title&gt;&lt;/title&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;/head&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;body&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;div&gt;</strong></span></span>
➊       <span class="steelblue"><span class="strong"><strong>&lt;svg</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"firstaid"</span> <span class="steelblue">version=</span><span class="maroon">"1.1"</span>
             <span class="steelblue">xmlns=</span><span class="maroon">"http://www.w3.org/2000/svg"</span>
           <span class="steelblue">width=</span><span class="maroon">"100"</span> <span class="steelblue">height=</span><span class="maroon">"100"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
           <span class="steelblue"><span class="strong"><strong>&lt;rect</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"background"</span> <span class="steelblue">x=</span><span class="maroon">"0"</span> <span class="steelblue">y=</span><span class="maroon">"0"</span>
                 <span class="steelblue">width=</span><span class="maroon">"100"</span> <span class="steelblue">height=</span><span class="maroon">"100"</span> <span class="steelblue">rx=</span><span class="maroon">"20"</span> <span class="steelblue"><span class="strong"><strong>/&gt;</strong></span></span>
           <span class="steelblue"><span class="strong"><strong>&lt;rect</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"vertical"</span> <span class="steelblue">x=</span><span class="maroon">"39"</span> <span class="steelblue">y=</span><span class="maroon">"19"</span>
                 <span class="steelblue">width=</span><span class="maroon">"22"</span> <span class="steelblue">height=</span><span class="maroon">"62"</span> <span class="steelblue"><span class="strong"><strong>/&gt;</strong></span></span>
           <span class="steelblue"><span class="strong"><strong>&lt;rect</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"horizontal"</span> <span class="steelblue">x=</span><span class="maroon">"19"</span> <span class="steelblue">y=</span><span class="maroon">"39"</span>
                 <span class="steelblue">width=</span><span class="maroon">"62"</span> <span class="steelblue">height=</span><span class="maroon">"22"</span> <span class="steelblue"><span class="strong"><strong>/&gt;</strong></span></span>
➋       <span class="steelblue"><span class="strong"><strong>&lt;/svg&gt;</strong></span></span>
      <span class="steelblue"><span class="strong"><strong>&lt;/div&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;/body&gt;</strong></span></span>
   <span class="steelblue"><span class="strong"><strong>&lt;/html&gt;</strong></span></span></pre><p>If your map is relatively simple, direct embedding is the easiest way to include it in the page. Our map of Georgia, however, is about 1 MB even after optimization. That’s not unusual for maps with reasonable resolution, as describing complex borders such as coastlines or rivers can make for large <code class="literal">&lt;path&gt;</code> elements. Especially if the map isn’t the sole focus of the page, you can provide a better user experience by loading the rest of the page first. That will give your users something to read while the map loads in the background. You can even add a simple animated progress loader if that’s appropriate for your site.</p><p>If you’re using jQuery, loading the map is a single instruction. You do want to make sure, though, that your code doesn’t start manipulating the map until the load is complete. Here’s how that would look in the source code.</p><a id="pro_id00272"/><pre class="programlisting"><span class="olive">$</span>(<span class="maroon">"#map"</span>).<span class="olive">load</span>(<span class="maroon">"img/ga.svg"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {
    <span class="indianred"><span class="emphasis"><em>// Only manipulate the map inside this block</em></span></span>
})</pre></div><div class="sect2" title="Step 3: Collect the Data"><div class="titlepage"><div><div><h3 class="title" id="step_3_collect_the_data">Step 3: Collect the Data</h3></div></div></div><p><a id="iddle1042" class="indexterm"/><a id="iddle1629" class="indexterm"/><a id="iddle1657" class="indexterm"/><a id="iddle1664" class="indexterm"/><a id="iddle1846" class="indexterm"/>The data for our visualization is available as an Excel spreadsheet directly from County Health Rankings (<span class="emphasis"><em><a class="ulink" href="http://www.countyhealthrankings.org/" target="_top">http://www.countyhealthrankings.org/</a></em></span>). We’ll convert that to a JavaScript object in advance, and we’ll add a two-letter code corresponding to each county. Here’s how that array might begin.</p><a id="pro_id00273"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> counties = [
    {
      <span class="maroon">"name"</span>:<span class="maroon">"Appling"</span>,
      <span class="maroon">"code"</span>:<span class="maroon">"ap"</span>,
      <span class="maroon">"outcomes_z"</span>:<span class="red">0.93</span>,
      <span class="maroon">"outcomes_rank"</span>:<span class="red">148</span>,
      <span class="indianred"><span class="emphasis"><em>// Data continues...</em></span></span>
    },
    {
      <span class="maroon">"name"</span>:<span class="maroon">"Atkinson"</span>,
      <span class="maroon">"code"</span>:<span class="maroon">"at"</span>,
      <span class="maroon">"outcomes_z"</span>:<span class="red">0.40</span>,
      <span class="maroon">"outcomes_rank"</span>:<span class="red">118</span>,
    <span class="indianred"><span class="emphasis"><em>// Data set continues...</em></span></span>
];</pre><p>For this visualization we’d like to show the variation in health outcomes among counties. The data set provides two variables for that value, a ranking and a z-score (a measure of how far a sample is from the mean in terms of standard deviation). The County Health Rankings site provides z-scores slightly modified from the traditional statistical definition. Normal z-scores are always positive; in this data set, however, measurements that are subjectively better than average are multiplied by –1 so that they are negative. A county whose health outcome is two standard deviations “better” than the mean, for example, is given a z-score of –2 instead of 2. This adjustment makes it easier to use these z-scores in our visualization.</p><p>Our first step in working with these z-scores is to find the maximum and minimum values. We can do that by extracting the outcomes as a separate array and then using JavaScript’s built-in <code class="literal">Math.max()</code> and <code class="literal">Math.min()</code> functions. Note that the following code uses the <code class="literal">map()</code> method to extract the array, and that method is available only in modern browsers. Since we’ve chosen to use SVG images, however, we’ve already restricted our users to modern browsers, so we might as well take advantage of that when we can.</p><a id="pro_id00274"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> outcomes = <span class="steelblue">counties</span>.<span class="olive">map</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(county) {<span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue">county</span>.<span class="olive">outcomes_z</span>;});
<span class="steelblue"><span class="strong"><strong>var</strong></span></span> maxZ = <span class="steelblue">Math</span>.<span class="steelblue">max</span>.<span class="olive">apply</span>(<span class="steelblue"><span class="strong"><strong>null</strong></span></span>, outcomes);
<span class="steelblue"><span class="strong"><strong>var</strong></span></span> minZ = <span class="steelblue">Math</span>.<span class="steelblue">min</span>.<span class="olive">apply</span>(<span class="steelblue"><span class="strong"><strong>null</strong></span></span>, outcomes);</pre><p>Notice how we’ve used the <code class="literal">.apply()</code> method here. Normally the <code class="literal">Math.max()</code> and <code class="literal">Math.min()</code> functions accept a comma-separated list of arguments. We, of course, have an array instead. The <code class="literal">apply()</code> method, which works with any JavaScript function, turns an array into a comma-separated list. The first parameter is the context to use, which in our case doesn’t matter, so we set it to <code class="literal">null</code>.</p><p><a id="iddle1096" class="indexterm"/><a id="iddle1122" class="indexterm"/><a id="iddle1123" class="indexterm"/><a id="iddle1157" class="indexterm"/><a id="iddle1658" class="indexterm"/><a id="iddle1847" class="indexterm"/>To complete the data preparation, let’s make sure the minimum and maximum ranges are symmetric about the mean.</p><a id="pro_id00275"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>if</strong></span></span> (<span class="steelblue">Math</span>.<span class="olive">abs</span>(minZ) &gt; <span class="steelblue">Math</span>.<span class="olive">abs</span>(maxZ)) {
    maxZ = -minZ;
} <span class="steelblue"><span class="strong"><strong>else</strong></span></span> {
    minZ = -maxZ;
}</pre><p>If, for example, the z-scores ranged from <code class="literal">-2</code> to <code class="literal">1.5</code>, this code would extend the range to <code class="literal">[-2, 2]</code>. This adjustment will make the color scales symmetric as well, thus making our visualization easier for users to interpret.</p></div><div class="sect2" title="Step 4: Define the Color Scheme"><div class="titlepage"><div><div><h3 class="title" id="step_4_define_the_color_scheme">Step 4: Define the Color Scheme</h3></div></div></div><p>Defining an effective color scheme for a map can be quite tricky, but fortunately there are some excellent resources available. For this visualization we’ll rely on the Chroma.js library (<span class="emphasis"><em><a class="ulink" href="http://driven-by-data.net/about/chromajs/" target="_top">http://driven-by-data.net/about/chromajs/</a></em></span>). That library includes many tools for working with and manipulating colors and color scales, and it can satisfy the most advanced color theorist. For our example, however, we can take advantage of the predefined color scales, specifically those defined originally by Cynthia Brewer (<span class="emphasis"><em><a class="ulink" href="http://colorbrewer2.org/" target="_top">http://colorbrewer2.org/</a></em></span>).</p><p>The Chroma.js library is available on popular content distribution networks, so we can rely on a network such as CloudFlare’s cdnjs (<span class="emphasis"><em><a class="ulink" href="http://cdnjs.com/" target="_top">http://cdnjs.com/</a></em></span>) to host it.</p><a id="pro_id00276"/><pre class="programlisting"><span class="dodgerblue">&lt;!DOCTYPE</span> html<span class="dodgerblue">&gt;</span>
<span class="steelblue"><span class="strong"><strong>&lt;html</strong></span></span> <span class="steelblue">lang=</span><span class="maroon">"en"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;head&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;meta</strong></span></span> <span class="steelblue">charset=</span><span class="maroon">"utf-8"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;title&gt;&lt;/title&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;/head&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;body&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"map"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span>
     <span class="steelblue">src=</span><span class="maroon">"///cdnjs.cloudflare.com/ajax/libs/chroma-js/0.5.2/chroma.min.js"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;/script&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;/body&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/html&gt;</strong></span></span></pre><p>To use a predefined scale, we pass the scale’s name (<code class="literal">"BrBG"</code> for Brewer’s brown-to-blue-green scale) to the <code class="literal">chroma.scale()</code> function.</p><a id="pro_id00277"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> scale = <span class="steelblue">chroma</span>.<span class="olive">scale</span>(<span class="maroon">"BrBG"</span>).<span class="olive">domain</span>([maxZ, minZ]).<span class="olive">out</span>(<span class="maroon">"hex"</span>);</pre><p>At the same time, we indicate the domain for our scale (<code class="literal">minZ</code> to <code class="literal">maxZ</code>, although we’re reversing the order because of the data set’s z-score adjustment) and our desired output. The <code class="literal">"hex"</code> output is the common <code class="literal">"#012345"</code> format compatible with CSS and HTML markup.</p></div><div class="sect2" title="Step 5: Color the Map"><div class="titlepage"><div><div><h3 class="title" id="step_5_color_the_map">Step 5: Color the Map</h3></div></div></div><p><a id="iddle1340" class="indexterm"/><a id="iddle1741" class="indexterm"/>With our color scheme established, we can now apply the appropriate colors to each county on the map. That’s probably the easiest step in the whole visualization. We iterate through all the counties, finding their <code class="literal">&lt;path&gt;</code> elements based on their <code class="literal">id</code> values, and applying the color by setting the <code class="literal">fill</code> attribute.</p><a id="pro_id00278"/><pre class="programlisting"><span class="steelblue">counties</span>.<span class="olive">forEach</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(county) {
    <span class="steelblue">document</span>.<span class="olive">getElementById</span>(<span class="steelblue">county</span>.<span class="olive">code</span>)
      .<span class="olive">setAttribute</span>(<span class="maroon">"fill"</span>, <span class="olive">scale</span>(<span class="steelblue">county</span>.<span class="olive">outcomes_z</span>));
})</pre><p>The resulting map, shown in <a class="xref" href="ch06.html#css_rules_can_set_the_styles_for_individ" title="Figure 6-6. CSS rules can set the styles for individual SVG elements within an SVG illustration.">Figure 6-6</a>, illustrates which counties are above average and which are below average for health outcomes in 2014.</p><div class="figure"><a id="css_rules_can_set_the_styles_for_individ"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00090"/><img src="figs/web/06fig06.png.jpg" alt="CSS rules can set the styles for individual SVG elements within an SVG illustration."/></div></div><div class="figure-title">Figure 6-6. CSS rules can set the styles for individual SVG elements within an SVG illustration.</div></div></div><div class="sect2" title="Step 6: Add a Legend"><div class="titlepage"><div><div><h3 class="title" id="step_6_add_a_legend">Step 6: Add a Legend</h3></div></div></div><p><a id="iddle1177" class="indexterm"/><a id="iddle1401" class="indexterm"/><a id="iddle1592" class="indexterm"/><a id="iddle1656" class="indexterm"/><a id="iddle1845" class="indexterm"/><a id="iddle1987" class="indexterm"/>To help users interpret the map, we can add a legend to the visualization. We can take advantage of the Chroma.js scale to easily create a table that explains the variation. For the table, we’ll use four increments for the colors on each side of the mean value. That gives us a total of nine colors for the legend.</p><a id="pro_id00279"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;table</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"legend"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;tr</strong></span></span> <span class="steelblue">class=</span><span class="maroon">"scale"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;/td&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;/tr&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;tr</strong></span></span> <span class="steelblue">class=</span><span class="maroon">"text"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;td</strong></span></span> <span class="steelblue">colspan=</span><span class="maroon">"4"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>Worse than Average<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>Average<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;td</strong></span></span> <span class="steelblue">colspan=</span><span class="maroon">"4"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>Better than Average<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;/tr&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/table&gt;</strong></span></span></pre><p>Some straightforward CSS will style the table appropriately. Because we have nine colors, we set the width of each table cell to <code class="literal">11.1111%</code> (1/9 is 0.111111).</p><a id="pro_id00280"/><pre class="programlisting">table<span class="red">#legend</span> tr<span class="red">.scale</span> td <span class="steelblue"><span class="strong"><strong>{</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>height:</strong></span></span> <span class="dodgerblue">1em</span><span class="steelblue"><span class="strong"><strong>;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>width:</strong></span></span> <span class="dodgerblue">11.1111%</span><span class="steelblue"><span class="strong"><strong>;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>}</strong></span></span>
table<span class="red">#legend</span> tr<span class="red">.text</span> td<span class="red">:first-child</span> <span class="steelblue"><span class="strong"><strong>{</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>text-align:</strong></span></span> <span class="dodgerblue">left</span><span class="steelblue"><span class="strong"><strong>;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>}</strong></span></span>
table<span class="red">#legend</span> tr<span class="red">.text</span> td<span class="red">:nth-child</span>(2) <span class="steelblue"><span class="strong"><strong>{</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>text-align:</strong></span></span> <span class="dodgerblue">center</span><span class="steelblue"><span class="strong"><strong>;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>}</strong></span></span>
table<span class="red">#legend</span> tr<span class="red">.text</span> td<span class="red">:last-child</span> <span class="steelblue"><span class="strong"><strong>{</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>text-align:</strong></span></span> <span class="dodgerblue">right</span><span class="steelblue"><span class="strong"><strong>;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>}</strong></span></span></pre><p>Finally, we use the Chroma scale created earlier to set the background color for the legend’s table cells. Because the legend is a <code class="literal">&lt;table&gt;</code> element, we can directly access the rows and the cells within the rows. Although these elements look like arrays in the following code, they’re not true JavaScript arrays, so they don’t support array methods such as <code class="literal">forEach()</code>. For now, we’ll iterate through them with a <code class="literal">for</code> loop, but if you’d rather use the array methods, stay tuned for a simple trick. Note that once again we’re working backward because of the data set’s z-score adjustments.</p><a id="pro_id00281"/><pre class="programlisting">   <span class="steelblue"><span class="strong"><strong>var</strong></span></span> legend = <span class="steelblue">document</span>.<span class="olive">getElementById</span>(<span class="maroon">"legend"</span>);
   <span class="steelblue"><span class="strong"><strong>var</strong></span></span> cells = <span class="steelblue">legend</span>.<span class="olive">rows</span>[<span class="red">0</span>].<span class="olive">cells</span>;
   <span class="steelblue"><span class="strong"><strong>for</strong></span></span> (<span class="steelblue"><span class="strong"><strong>var</strong></span></span> idx=<span class="red">0</span>; idx&lt;<span class="steelblue">cells</span>.<span class="olive">length</span>; idx++) {
       <span class="steelblue"><span class="strong"><strong>var</strong></span></span> td = cells[idx];
➊     <span class="steelblue">td</span>.<span class="steelblue">style</span>.<span class="olive">backgroundColor</span> = <span class="olive">scale</span>(maxZ -
           ((idx + <span class="red">0.5</span>) / <span class="steelblue">cells</span>.<span class="olive">length</span>) * (maxZ - minZ));
   };</pre><p><a id="iddle1655" class="indexterm"/><a id="iddle1844" class="indexterm"/><a id="iddle1980" class="indexterm"/>At ➊ we calculate the fraction of the current index from the total number of legend colors <code class="literal">((idx + 0.5) / cells.length)</code>, multiply that by the total range of the scale <code class="literal">(maxZ - minZ)</code>, and subtract the result from the maximum value.</p><p>The result is the legend for the map in <a class="xref" href="ch06.html#html_less_thantablegreater_than_can_serv" title="Figure 6-7. An HTML &lt;table&gt; can serve as a legend.">Figure 6-7</a>.</p><div class="figure"><a id="html_less_thantablegreater_than_can_serv"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00091"/><img src="figs/web/06fig07.png.jpg" alt="An HTML &lt;table&gt; can serve as a legend."/></div></div><div class="figure-title">Figure 6-7. An HTML <code class="literal">&lt;table&gt;</code> can serve as a legend.</div></div></div><div class="sect2" title="Step 7: Add Interactions"><div class="titlepage"><div><div><h3 class="title" id="step_7_add_interactions">Step 7: Add Interactions</h3></div></div></div><p>To complete the visualization, let’s enable users to hover their mouse over a county on the map to see more details. Of course, mouse interactions are not available for tablet or smartphone users. To support those users, you could add a similar interaction for tap or click events. That code would be almost identical to the next example.</p><p>We’ll start by defining a table to show county details.</p><a id="pro_id00282"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;table</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"details"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;tr&gt;&lt;td&gt;</strong></span></span>County:<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;tr&gt;&lt;td&gt;</strong></span></span>Rank:<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;tr&gt;&lt;td&gt;</strong></span></span>Health Behaviors:<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;tr&gt;&lt;td&gt;</strong></span></span>Clinical Care:<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;tr&gt;&lt;td&gt;</strong></span></span>Social &amp; Economic Factors:<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;tr&gt;&lt;td&gt;</strong></span></span>Physical Environment:<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;/tr&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/table&gt;</strong></span></span></pre><p>Initially, we don’t want that table to be visible.</p><a id="pro_id00283"/><pre class="programlisting">table<span class="red">#details</span> <span class="steelblue"><span class="strong"><strong>{</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>display:</strong></span></span> <span class="dodgerblue">none</span><span class="steelblue"><span class="strong"><strong>;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>}</strong></span></span></pre><p><a id="iddle1402" class="indexterm"/><a id="iddle1480" class="indexterm"/><a id="iddle1742" class="indexterm"/><a id="iddle1785" class="indexterm"/>To show the table, we use event handler functions that track when the mouse enters or leaves an SVG path for a county. To find these <code class="literal">&lt;path&gt;</code> elements, we can use the <code class="literal">querySelectorAll()</code> function that modern browsers support. Unfortunately, that function doesn’t return a true array of elements, so we can’t use array methods such as <code class="literal">forEach()</code> to iterate through those elements. There’s a trick, however, that will let us convert the returned list into a true array.</p><a id="pro_id00284"/><pre class="programlisting">[].<span class="steelblue">slice</span>.<span class="olive">call</span>(<span class="steelblue">document</span>.<span class="olive">querySelectorAll</span>(<span class="maroon">"#map path"</span>))
    .<span class="olive">forEach</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(path) {
        <span class="steelblue">path</span>.<span class="olive">addEventListener</span>(<span class="maroon">"mouseenter"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(){
            <span class="steelblue">document</span>.<span class="olive">getElementById</span>(<span class="maroon">"details"</span>).<span class="steelblue">style</span>.<span class="olive">display</span> = <span class="maroon">"table"</span>;
        });
        <span class="steelblue">path</span>.<span class="olive">addEventListener</span>(<span class="maroon">"mouseleave"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(){
            <span class="steelblue">document</span>.<span class="olive">getElementById</span>(<span class="maroon">"details"</span>).<span class="steelblue">style</span>.<span class="olive">display</span> = <span class="maroon">"none"</span>;
        });
    }
);</pre><p>This code calls the <code class="literal">[].slice.call()</code> function with the “not quite array” object as its parameter. The result is a true array with all of its useful methods.</p><p>In addition to making the details table visible, we’ll also want to update it with the appropriate information. To help with this display, we can write a function that converts a z-score into a more user-friendly explanation. The specific values in the following example are arbitrary since we’re not trying for statistical precision in this visualization.</p><a id="pro_id00285"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> zToText = <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(z) {
    z = +z;
    <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (z &gt; <span class="red">0.25</span>)  { <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="maroon">"Far Below Average"</span>; }
    <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (z &gt;  <span class="red">0.1</span>)  { <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="maroon">"Below Average"</span>; }
    <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (z &gt; -<span class="red">0.1</span>)  { <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="maroon">"Average"</span>; }
    <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (z &gt; -<span class="red">0.25</span>) { <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="maroon">"Above Average"</span>; }
    <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="maroon">"Far Above Average"</span>;
}</pre><p>There are a couple of noteworthy items in this function. First, the statement <code class="literal">z = +z</code> converts the z-score from a string to a numeric value for the tests that follow. Second, remember that because of the z-score adjustments, the negative z-scores are actually better than average, while the positive values are below average.</p><p>We can use this function to provide the data for our details table. The first step is finding the full data set for the associated <code class="literal">&lt;path&gt;</code> element. To do that, we search through the <code class="literal">counties</code> array looking for a <code class="literal">code</code> property that matches the <code class="literal">id</code> attribute of the path.</p><a id="pro_id00286"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> county = <span class="steelblue"><span class="strong"><strong>null</strong></span></span>;
<span class="steelblue">counties</span>.<span class="olive">some</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(c) {
    <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (<span class="steelblue">c</span>.<span class="olive">code</span> === <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">id</span>) {
        county = c;
        <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue"><span class="strong"><strong>true</strong></span></span>;
    }
    <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue"><span class="strong"><strong>false</strong></span></span>;
});</pre><p>Because <code class="literal">indexOf()</code> doesn’t allow us to find objects by key, we’ve used the <code class="literal">some()</code> method instead. That method terminates as soon as it finds a match, so we avoid iterating through the entire array.</p><p>Once we’ve found the county data, it’s a straightforward process to update the table. The following code directly updates the relevant table cell’s text content. For a more robust implementation, you could provide class names for the cells and update based on those class names.</p><a id="pro_id00287"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> table = <span class="steelblue">document</span>.<span class="olive">getElementById</span>(<span class="maroon">"details"</span>);
<span class="steelblue">table</span>.<span class="olive">rows</span>[<span class="red">0</span>].<span class="olive">cells</span>[<span class="red">1</span>].<span class="olive">textContent</span> =
    <span class="steelblue">county</span>.<span class="olive">name</span>;
<span class="steelblue">table</span>.<span class="olive">rows</span>[<span class="red">1</span>].<span class="olive">cells</span>[<span class="red">1</span>].<span class="olive">textContent</span> =
    <span class="steelblue">county</span>.<span class="olive">outcomes_rank</span> + <span class="maroon">" out of "</span> + <span class="steelblue">counties</span>.<span class="olive">length</span>;
<span class="steelblue">table</span>.<span class="olive">rows</span>[<span class="red">2</span>].<span class="olive">cells</span>[<span class="red">1</span>].<span class="olive">textContent</span> =
    <span class="olive">zToText</span>(<span class="steelblue">county</span>.<span class="olive">health_behaviors_z</span>);
<span class="steelblue">table</span>.<span class="olive">rows</span>[<span class="red">3</span>].<span class="olive">cells</span>[<span class="red">1</span>].<span class="olive">textContent</span> =
    <span class="olive">zToText</span>(<span class="steelblue">county</span>.<span class="olive">clinical_care_z</span>);
<span class="steelblue">table</span>.<span class="olive">rows</span>[<span class="red">4</span>].<span class="olive">cells</span>[<span class="red">1</span>].<span class="olive">textContent</span> =
    <span class="olive">zToText</span>(<span class="steelblue">county</span>.<span class="olive">social_and_economic_factors_z</span>);
<span class="steelblue">table</span>.<span class="olive">rows</span>[<span class="red">5</span>].<span class="olive">cells</span>[<span class="red">1</span>].<span class="olive">textContent</span> =
    <span class="olive">zToText</span>(<span class="steelblue">county</span>.<span class="olive">physical_environment_z</span>);</pre><p>Now we just need a few more refinements:</p><a id="pro_id00288"/><pre class="programlisting">   <span class="steelblue">path</span>.<span class="olive">addEventListener</span>(<span class="maroon">"mouseleave"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(){
       <span class="indianred"><span class="emphasis"><em>// Previous code</em></span></span>
➊     <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">setAttribute</span>(<span class="maroon">"stroke"</span>, <span class="maroon">"#444444"</span>);
   });
   <span class="steelblue">path</span>.<span class="olive">addEventListener</span>(<span class="maroon">"mouseleave"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(){
       <span class="indianred"><span class="emphasis"><em>// Previous code</em></span></span>
➋     <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">setAttribute</span>(<span class="maroon">"stroke"</span>, <span class="maroon">"none"</span>);
   });</pre><p>Here we add a stroke color at ➊ for counties that are highlighted. We remove the stroke at ➋ when the mouse leaves the path.</p><p>At this point our visualization example is complete. <a class="xref" href="ch06.html#browsers_left_parenthesisand_a_bit_of_co" title="Figure 6-8. Browsers (and a bit of code) can turn SVG illustrations into interactive visualizations.">Figure 6-8</a> shows the result.</p><div class="figure"><a id="browsers_left_parenthesisand_a_bit_of_co"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00092"/><img src="figs/web/06fig08.png.jpg" alt="Browsers (and a bit of code) can turn SVG illustrations into interactive visualizations."/></div></div><div class="figure-title">Figure 6-8. Browsers (and a bit of code) can turn SVG illustrations into interactive visualizations.</div></div></div></div><div class="sect1" title="Including Maps for Context"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="including_maps_for_context">Including Maps for Context</h2></div></div></div><p><a id="iddle1164" class="indexterm"/><a id="iddle1421" class="indexterm"/><a id="iddle1633" class="indexterm"/><a id="iddle1683" class="indexterm"/><a id="iddle1968" class="indexterm"/>So far in this chapter, we’ve looked at map visualizations where the main subjects are geographic regions—countries in Europe or counties in Georgia. In those cases, choropleth maps were effective in showing the differences between regions. Not all map visualizations have the same focus, however. In some cases, we want to include a map more as context or background for the visualization data.</p><p>When we want to include a map as a visualization background, we’re likely to find that traditional mapping libraries will serve us better than custom choropleth maps. The most well-known mapping library is probably Google Maps (<span class="emphasis"><em><a class="ulink" href="http://maps.google.com/" target="_top">http://maps.google.com/</a></em></span>), and you’ve almost certainly seen many examples of embedded Google maps on web pages. There are, however, several free and open source alternatives to Google Maps. For this example, we’ll use the Modest Maps library (<span class="emphasis"><em><a class="ulink" href="https://github.com/modestmaps/modestmaps-js/" target="_top">https://github.com/modestmaps/modestmaps-js/</a></em></span>) from Stamen Design. To show off this library, we’ll visualize the major UFO sightings in the United States (<span class="emphasis"><em><a class="ulink" href="http://en.wikipedia.org/wiki/UFO_sightings_in_the_United_States" target="_top">http://en.wikipedia.org/wiki/UFO_sightings_in_the_United_States</a></em></span>), or at least those important enough to merit a Wikipedia entry.</p><div class="sect2" title="Step 1: Set Up the Web Page"><div class="titlepage"><div><div><h3 class="title" id="step_1_set_up_the_web_page">Step 1: Set Up the Web Page</h3></div></div></div><p><a id="iddle1620" class="indexterm"/>For our visualization, we’ll rely on a couple of components from the Modest Maps library: the core library itself and the spotlight extension that can be found in the library’s examples folder. In production you would likely combine these and minify the result to optimize performance, but for our example, we’ll include them separately.</p><a id="pro_id00289"/><pre class="programlisting">   <span class="dodgerblue">&lt;!DOCTYPE</span> html<span class="dodgerblue">&gt;</span>
   <span class="steelblue"><span class="strong"><strong>&lt;html</strong></span></span> <span class="steelblue">lang=</span><span class="maroon">"en"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;head&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;meta</strong></span></span> <span class="steelblue">charset=</span><span class="maroon">"utf-8"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;title&gt;&lt;/title&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;/head&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;body&gt;</strong></span></span>
➊     <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"map"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"js/modestmaps.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"js/spotlight.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;/body&gt;</strong></span></span>
   <span class="steelblue"><span class="strong"><strong>&lt;/html&gt;</strong></span></span></pre><p>We’ve also set aside a <code class="literal">&lt;div&gt;</code> at ➊ to hold the map. Not surprisingly, it has the <code class="literal">id</code> of <code class="literal">"map"</code>.</p></div><div class="sect2" title="Step 2: Prepare the Data"><div class="titlepage"><div><div><h3 class="title" id="step_2_prepare_the_data-id00026">Step 2: Prepare the Data</h3></div></div></div><p>The Wikipedia data can be formatted as an array of JavaScript objects. We can include whatever information we wish in the objects, but we’ll definitely need the latitude and longitude of the sighting in order to place it on the map. Here’s how you might structure the data.</p><a id="pro_id00290"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> ufos = [
{
    <span class="maroon">"date"</span>: <span class="maroon">"April, 1941"</span>,
    <span class="maroon">"city"</span>: <span class="maroon">"Cape Girardeau"</span>,
    <span class="maroon">"state"</span>: <span class="maroon">"Missouri"</span>,
    <span class="maroon">"location"</span>: [<span class="red">37.309167</span>, -<span class="red">89.546389</span>],
    <span class="maroon">"url"</span>: <span class="maroon">"http://en.wikipedia.org/wiki/Cape_Girardeau_UFO_crash"</span>
},{
    <span class="maroon">"date"</span>: <span class="maroon">"February 24, 1942"</span>,
    <span class="maroon">"city"</span>: <span class="maroon">"Los Angeles"</span>,
    <span class="maroon">"state"</span>: <span class="maroon">"California"</span>,
    <span class="maroon">"location"</span>: [<span class="red">34.05</span>, -<span class="red">118.25</span>],
    <span class="maroon">"url"</span>: <span class="maroon">"http://en.wikipedia.org/wiki/Battle_of_Los_Angeles"</span>
},{
<span class="indianred"><span class="emphasis"><em>// Data set continues...</em></span></span></pre><p>The <code class="literal">location</code> property holds the latitude and longitude (where negative values indicate west) as a two-element array.</p></div><div class="sect2" title="Step 3: Choose a Map Style"><div class="titlepage"><div><div><h3 class="title" id="step_3_choose_a_map_style">Step 3: Choose a Map Style</h3></div></div></div><p><a id="iddle1680" class="indexterm"/><a id="iddle1969" class="indexterm"/>As with most mapping libraries, Modest Maps builds its maps using layers. The layering process works much like it does in a graphics application such as Photoshop or Sketch. Subsequent layers add further visual information to the map. In most cases, the base layer for a map consists of image tiles. Additional layers such as markers or routes can be included on top of the image tiles.</p><p>When we tell Modest Maps to create a map, it calculates which tiles (both size and location) are needed and then it requests those tiles asynchronously over the Internet. The tiles define the visual style of the map. Stamen Design has published several tile sets itself; you can see them on <span class="emphasis"><em><a class="ulink" href="http://maps.stamen.com/" target="_top">http://maps.stamen.com/</a></em></span>.</p><p>To use the Stamen tiles, we’ll add one more, small JavaScript library to our page. That library is available directly from Stamen Design (<span class="emphasis"><em><a class="ulink" href="http://maps.stamen.com/js/tile.stamen.js" target="_top">http://maps.stamen.com/js/tile.stamen.js</a></em></span>). It should be included <span class="emphasis"><em>after</em></span> the Modest Maps library.</p><a id="pro_id00291"/><pre class="programlisting"><span class="dodgerblue">&lt;!DOCTYPE</span> html<span class="dodgerblue">&gt;</span>
<span class="steelblue"><span class="strong"><strong>&lt;html</strong></span></span> <span class="steelblue">lang=</span><span class="maroon">"en"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;head&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;meta</strong></span></span> <span class="steelblue">charset=</span><span class="maroon">"utf-8"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;title&gt;&lt;/title&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;/head&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;body&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"map"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"js/modestmaps.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"js/spotlight.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"http://maps.stamen.com/js/tile.stamen.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;/body&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/html&gt;</strong></span></span></pre><p>For our example, the “toner” style is a good match, so we’ll use those tiles. To use those tiles, we create a <span class="emphasis"><em>tile layer</em></span> for the map.</p><a id="pro_id00292"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> tiles = <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">MM</span>.<span class="olive">StamenTileLayer</span>(<span class="maroon">"toner"</span>);</pre><p>When you consider a source for image tiles, be aware of any copyright restrictions. Some image tiles must be licensed, and even those that are freely available often require that any user identify the provider as the source.</p></div><div class="sect2" title="Step 4: Draw the Map"><div class="titlepage"><div><div><h3 class="title" id="step_4_draw_the_map">Step 4: Draw the Map</h3></div></div></div><p>Now we’re ready to draw the map itself. That takes two JavaScript statements:</p><a id="pro_id00293"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> map = <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">MM</span>.<span class="olive">Map</span>(<span class="maroon">"map"</span>, tiles);
<span class="steelblue">map</span>.<span class="olive">setCenterZoom</span>(<span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">MM</span>.<span class="olive">Location</span>(<span class="red">38.840278</span>, -<span class="red">96.611389</span>), <span class="red">4</span>);</pre><p>First we create a new <code class="literal">MM.Map</code> object, giving it the <code class="literal">id</code> of the element containing the map and the tiles we just initialized. Then we provide the latitude and longitude for the map’s center as well as an initial zoom level. For your own maps, <a id="iddle1724" class="indexterm"/><a id="iddle1970" class="indexterm"/>you may need to experiment a bit to get the right values, but for this example, we’ll center and zoom the map so that it comfortably shows the continental United States.</p><p>The resulting map, shown in <a class="xref" href="ch06.html#map_libraries_can_show_maps_based_on_geo" title="Figure 6-9. Map libraries can show maps based on geographic coordinates.">Figure 6-9</a>, forms a base for showing the sightings.</p><div class="figure"><a id="map_libraries_can_show_maps_based_on_geo"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00093"/><img src="figs/web/06fig09.png.jpg" alt="Map libraries can show maps based on geographic coordinates."/></div></div><div class="figure-title">Figure 6-9. Map libraries can show maps based on geographic coordinates.</div></div><p>Notice that both Stamen Design and OpenStreetMap are credited. That attribution is required by the terms of the Stamen Design license.</p></div><div class="sect2" title="Step 5: Add the Sightings"><div class="titlepage"><div><div><h3 class="title" id="step_5_add_the_sightings">Step 5: Add the Sightings</h3></div></div></div><p>With our map in place, it’s time to add the individual UFO sightings. We’re using the spotlight extension to highlight these locations, so we first create a spotlight layer for the map. We’ll also want to set the radius of the spotlight effect. As with the center and zoom parameters, a bit of trial and error helps here.</p><a id="pro_id00294"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> layer = <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="olive">SpotlightLayer</span>();
<span class="steelblue">layer</span>.<span class="steelblue">spotlight</span>.<span class="olive">radius</span> = <span class="red">15</span>;
<span class="steelblue">map</span>.<span class="olive">addLayer</span>(layer);</pre><p>Now we can iterate through the array of sightings that make up our data. For each sighting, we extract the latitude and longitude of the location and add that location to the spotlight layer.</p><a id="pro_id00295"/><pre class="programlisting"><span class="steelblue">ufos</span>.<span class="olive">forEach</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ufo) {
    <span class="steelblue">layer</span>.<span class="olive">addLocation</span>(<span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">MM</span>.<span class="olive">Location</span>(<span class="steelblue">ufo</span>.<span class="olive">location</span>[<span class="red">0</span>], <span class="steelblue">ufo</span>.<span class="olive">location</span>[<span class="red">1</span>]));
});</pre><p><a id="iddle1573" class="indexterm"/><a id="iddle1582" class="indexterm"/><a id="iddle1584" class="indexterm"/><a id="iddle1634" class="indexterm"/><a id="iddle1643" class="indexterm"/><a id="iddle1645" class="indexterm"/><a id="iddle1895" class="indexterm"/><a id="iddle1910" class="indexterm"/>At this point our visualization is complete. <a class="xref" href="ch06.html#adding_layers_in_a_map_library_can_empha" title="Figure 6-10. Adding layers in a map library can emphasize regions of a map.">Figure 6-10</a> shows where UFOs have allegedly appeared over the United States in a suitably mysterious context.</p><div class="figure"><a id="adding_layers_in_a_map_library_can_empha"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00094"/><img src="figs/web/06fig10.png.jpg" alt="Adding layers in a map library can emphasize regions of a map."/></div></div><div class="figure-title">Figure 6-10. Adding layers in a map library can emphasize regions of a map.</div></div></div></div><div class="sect1" title="Integrating a Full-Featured Mapping Library"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="integrating_a_full-featured_mapping_libr">Integrating a Full-Featured Mapping Library</h2></div></div></div><p>The Modest Maps library of the previous example is a fine library for simple map visualizations, but it doesn’t have all of the features and support of a full-featured service such as Google Maps. There is, however, an open source library that does provide those features: Leaflet (<span class="emphasis"><em><a class="ulink" href="http://leafletjs.com/" target="_top">http://leafletjs.com/</a></em></span>). In this example, we’ll build a more complex visualization that features a Leaflet-based map.</p><p>In the 1940s, two private railroads were in competition for passenger traffic in the southeastern United States. Two routes that competed most directly were the Silver Comet (run by Seaboard Air Lines) and the Southerner (operated by Southern Railways). Both served passengers traveling between New York and Birmingham, Alabama. One factor cited in the Southerner’s ultimate success was the shorter distance of its route. Trips on the Southerner were quicker, giving Southern Railways a competitive advantage. Let’s create a visualization to demonstrate that advantage.</p><div class="sect2" title="Step 1: Prepare the Data"><div class="titlepage"><div><div><h3 class="title" id="step_1_prepare_the_data-id00027">Step 1: Prepare the Data</h3></div></div></div><p>The data for our visualization is readily available as timetables for the two routes. A more precise comparison might consider timetables from the same year, but for this example, we’ll use the Southerner’s timetable from 1941 (<span class="emphasis"><em><a class="ulink" href="http://www.streamlinerschedules.com/concourse/track1/southerner194112.html" target="_top">http://www.streamlinerschedules.com/concourse/track1/southerner194112.html</a></em></span>) and the Silver Comet’s timetable from 1947 (<span class="emphasis"><em><a class="ulink" href="http://www.streamlinerschedules.com/concourse/track1/silvercomet194706.html" target="_top">http://www.streamlinerschedules.com/concourse/track1/silvercomet194706.html</a></em></span>), as they are readily available on the Internet. The <a id="iddle1585" class="indexterm"/><a id="iddle1646" class="indexterm"/>timetables only include station names, so we will have to look up latitude and longitude values (using, for example, Google Maps) for all of the stations in order to place them on a map. We can also calculate the time difference between stops, in minutes. Those calculations result in two arrays, one for each train.</p><a id="pro_id00296"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> seaboard = [
    { <span class="maroon">"stop"</span>: <span class="maroon">"Washington"</span>,
      <span class="maroon">"latitude"</span>: <span class="red">38.895111</span>, <span class="maroon">"longitude"</span>: -<span class="red">77.036667</span>,
      <span class="maroon">"duration"</span>: <span class="red">77</span> },
    { <span class="maroon">"stop"</span>: <span class="maroon">"Fredericksburg"</span>,
      <span class="maroon">"latitude"</span>: <span class="red">38.301806</span>, <span class="maroon">"longitude"</span>: -<span class="red">77.470833</span>,
      <span class="maroon">"duration"</span>: <span class="red">89</span> },
    { <span class="maroon">"stop"</span>: <span class="maroon">"Richmond"</span>,
      <span class="maroon">"latitude"</span>: <span class="red">37.533333</span>, <span class="maroon">"longitude"</span>: -<span class="red">77.466667</span>,
      <span class="maroon">"duration"</span>: <span class="red">29</span> },
    <span class="indianred"><span class="emphasis"><em>// Data set continues...</em></span></span>
];
<span class="steelblue"><span class="strong"><strong>var</strong></span></span> southern = [
    { <span class="maroon">"stop"</span>: <span class="maroon">"Washington"</span>,
      <span class="maroon">"latitude"</span>: <span class="red">38.895111</span>, <span class="maroon">"longitude"</span>: -<span class="red">77.036667</span>,
      <span class="maroon">"duration"</span>: <span class="red">14</span> },
    { <span class="maroon">"stop"</span>: <span class="maroon">"Alexandria"</span>,
      <span class="maroon">"latitude"</span>: <span class="red">38.804722</span>, <span class="maroon">"longitude"</span>: -<span class="red">77.047222</span>,
      <span class="maroon">"duration"</span>: <span class="red">116</span> },
    { <span class="maroon">"stop"</span>: <span class="maroon">"Charlottesville"</span>,
      <span class="maroon">"latitude"</span>: <span class="red">38.0299</span>, <span class="maroon">"longitude"</span>: -<span class="red">78.479</span>,
      <span class="maroon">"duration"</span>: <span class="red">77</span> },
    <span class="indianred"><span class="emphasis"><em>// Data set continues...</em></span></span>
];</pre></div><div class="sect2" title="Step 2: Set Up the Web Page and Libraries"><div class="titlepage"><div><div><h3 class="title" id="step_2_set_up_the_web_page_and_libraries">Step 2: Set Up the Web Page and Libraries</h3></div></div></div><p>To add Leaflet maps to our web page, we’ll need to include the library and its companion style sheet. Both are available from a content distribution network, so there’s no need to host them on our own servers.</p><a id="pro_id00297"/><pre class="programlisting">   <span class="dodgerblue">&lt;!DOCTYPE</span> html<span class="dodgerblue">&gt;</span>
   <span class="steelblue"><span class="strong"><strong>&lt;html</strong></span></span> <span class="steelblue">lang=</span><span class="maroon">"en"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;head&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;meta</strong></span></span> <span class="steelblue">charset=</span><span class="maroon">"utf-8"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;title&gt;&lt;/title&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;link</strong></span></span> <span class="steelblue">rel=</span><span class="maroon">"stylesheet"</span>
        <span class="steelblue">href=</span><span class="maroon">"http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css"</span> <span class="steelblue"><span class="strong"><strong>/&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;/head&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;body&gt;</strong></span></span>
➊       <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"map"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span>
         <span class="steelblue">src=</span><span class="maroon">"http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;/script&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;/body&gt;</strong></span></span>
   <span class="steelblue"><span class="strong"><strong>&lt;/html&gt;</strong></span></span></pre><p><a id="iddle1580" class="indexterm"/><a id="iddle1641" class="indexterm"/><a id="iddle2200" class="indexterm"/>When we create our page, we also define a <code class="literal">&lt;div&gt;</code> container for the map at ➊.</p></div><div class="sect2" title="Step 3: Draw the Base Map"><div class="titlepage"><div><div><h3 class="title" id="step_3_draw_the_base_map">Step 3: Draw the Base Map</h3></div></div></div><p>The Silver Comet and the Southerner traveled between New York and Birmingham (and, in the case of the Southerner, all the way to New Orleans). But the region that’s relevant for our visualization lies between Washington, DC, and Atlanta, Georgia, because that’s the only region where the train routes differed; for the rest of their journeys, the routes were essentially the same. Our map, therefore, will extend from Atlanta in the southwest to Washington, DC, in the northeast. Using a bit of trial and error, we can determine the best center point and zoom level for the map. The center point defines the latitude and longitude for the map’s center, and the zoom level determines the area covered by the map on its initial display. When we create the map object, we give it the <code class="literal">id</code> of the containing element as well as those parameters.</p><a id="pro_id00298"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> map = <span class="steelblue">L</span>.<span class="olive">map</span>(<span class="maroon">"map"</span>,{
    <span class="dodgerblue">center</span>: [<span class="red">36.3</span>, -<span class="red">80.2</span>],
    <span class="dodgerblue">zoom</span>: <span class="red">6</span>
});</pre><p>For this particular visualization, there is little point in zooming or panning the map, so we can include additional options to disable those interactions.</p><a id="pro_id00299"/><pre class="programlisting">   <span class="steelblue"><span class="strong"><strong>var</strong></span></span> map = <span class="steelblue">L</span>.<span class="olive">map</span>(<span class="maroon">"map"</span>,{
       <span class="dodgerblue">center</span>: [<span class="red">36.3</span>, -<span class="red">80.2</span>],
➊     <span class="dodgerblue">maxBounds</span>: [ [<span class="red">33.32134852669881</span>, -<span class="red">85.20996093749999</span>],
➋                [<span class="red">39.16414104768742</span>, -<span class="red">75.9814453125</span>] ],
       <span class="dodgerblue">zoom</span>: <span class="red">6</span>,
➌     <span class="dodgerblue">minZoom</span>: <span class="red">6</span>,
➍     <span class="dodgerblue">maxZoom</span>: <span class="red">6</span>,
➎     <span class="dodgerblue">dragging</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
➏     <span class="dodgerblue">zoomControl</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
➐     <span class="dodgerblue">touchZoom</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
       <span class="dodgerblue">scrollWheelZoom</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
       <span class="dodgerblue">doubleClickZoom</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
➑     <span class="dodgerblue">boxZoom</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
➒     <span class="dodgerblue">keyboard</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>
   });</pre><p><a id="iddle1672" class="indexterm"/><a id="iddle1773" class="indexterm"/><a id="iddle2174" class="indexterm"/>Setting both the minimum zoom level ➌ and the maximum zoom level ➍ to be equal to the initial zoom level disables zooming. We also disable the onscreen map controls for zooming at ➏. The other zoom controls are likewise disabled (➐ through ➑). For panning, we disable dragging the map at ➎ and keyboard arrow keys at ➒. We also specify the latitude/longitude bounds for the map (➊ and ➋).</p><p>Because we’ve disabled the user’s ability to pan or zoom the map, we should also make sure the mouse cursor doesn’t mislead the user when it’s hovering over the map. The <span class="emphasis"><em>leaflet.css</em></span> style sheet expects zooming and panning to be enabled, so it sets the cursor to a “grabbing” hand icon. We can override that value with a style rule of our own. We have to define this rule <span class="emphasis"><em>after</em></span> including the <span class="emphasis"><em>leaflet.css</em></span> file.</p><a id="pro_id00300"/><pre class="programlisting"><span class="red">.leaflet-container</span> <span class="steelblue"><span class="strong"><strong>{</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>cursor:</strong></span></span> <span class="dodgerblue">default</span><span class="steelblue"><span class="strong"><strong>;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>}</strong></span></span></pre><p>As with the Modest Maps example, we base our map on a set of tiles. There are many tile providers that support Leaflet; some are open source, while others are commercial. Leaflet has a demo page (<span class="emphasis"><em><a class="ulink" href="http://leaflet-extras.github.io/leaflet-providers/preview/" target="_top">http://leaflet-extras.github.io/leaflet-providers/preview/</a></em></span>) you can use to compare some of the open source tile providers. For our example, we want to avoid tiles with roads, as the highway network looked very different in the 1940s. Esri has a neutral WorldGrayCanvas set that works well for our visualization. It does include current county boundaries, and some counties may have changed their borders since the 1940s. For our example, we won’t worry about that detail, though you might consider it in any production visualization. Leaflet’s API lets us create the tile layer and add it to the map in a single statement. The Leaflet includes a built-in option to handle attribution so we can be sure to credit the tile source appropriately.</p><a id="pro_id00301"/><pre class="programlisting">   <span class="steelblue">L</span>.<span class="olive">tileLayer</span>(<span class="maroon">"http://server.arcgisonline.com/ArcGIS/rest/services/"</span>+
               <span class="maroon">"Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}"</span>, {
        <span class="dodgerblue">attribution</span>: <span class="maroon">"Tiles &amp;copy; Esri &amp;mdash; Esri, DeLorme, NAVTEQ"</span>,
➊      <span class="dodgerblue">maxZoom</span>: <span class="red">16</span>
   }).<span class="olive">addTo</span>(map);</pre><p>Note that the <code class="literal">maxZoom</code> option at ➊ indicates the maximum zoom layer available for that particular tile set. That value is independent of the zoom level we’re permitting for our map.</p><p>With a map and a base tile layer, we have a good starting point for our visualization in (see <a class="xref" href="ch06.html#base_layer_map_provides_the_canvas_for_a" title="Figure 6-11. A base layer map provides the canvas for a visualization.">Figure 6-11</a>).</p><div class="figure"><a id="base_layer_map_provides_the_canvas_for_a"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00095"/><img src="figs/web/06fig11.png.jpg" alt="A base layer map provides the canvas for a visualization."/></div></div><div class="figure-title">Figure 6-11. A base layer map provides the canvas for a visualization.</div></div></div><div class="sect2" title="Step 4: Add the Routes to the Map"><div class="titlepage"><div><div><h3 class="title" id="step_4_add_the_routes_to_the_map">Step 4: Add the Routes to the Map</h3></div></div></div><p><a id="iddle1575" class="indexterm"/><a id="iddle1630" class="indexterm"/><a id="iddle1636" class="indexterm"/><a id="iddle1774" class="indexterm"/><a id="iddle1827" class="indexterm"/>For the next step in our visualization, we want to show the two routes on our map. First, we’ll simply draw each route on the map. Then, we’ll add an animation that traces both routes at the same time to show which one is faster.</p><p>The Leaflet library includes a function that does exactly what we need to draw each route: <code class="literal">polyline()</code> connects a series of lines defined by the latitude and longitude of their endpoints and prepares them for a map. Our data set includes the geographic coordinates of each route’s stops, so we can use the JavaScript <code class="literal">map()</code> method to format those values for Leaflet. For the Silver Comet example, the following statement extracts its stops.</p><a id="pro_id00302"/><pre class="programlisting"><span class="steelblue">seaboard</span>.<span class="olive">map</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(stop) {
    <span class="steelblue"><span class="strong"><strong>return</strong></span></span> [<span class="steelblue">stop</span>.<span class="olive">latitude</span>, <span class="steelblue">stop</span>.<span class="olive">longitude</span>]
})</pre><p>This statement returns an array of latitude/longitude pairs:</p><a id="pro_id00303"/><pre class="programlisting">[
  [<span class="red">38.895111</span>,-<span class="red">77.036667</span>],
  [<span class="red">38.301806</span>,-<span class="red">77.470833</span>],
  [<span class="red">37.533333</span>,-<span class="red">77.466667</span>],
  [<span class="red">37.21295</span>,-<span class="red">77.400417</span>],
  <span class="indianred"><span class="emphasis"><em>/* Data set continues... */</em></span></span>
]</pre><p><a id="iddle1141" class="indexterm"/><a id="iddle1775" class="indexterm"/>That result is the perfect input to the <code class="literal">polyline()</code> function. We’ll use it for each of the routes. The options let us specify a color for the lines, which we’ll match with the associated railroad’s official color from the era. We also indicate that the lines have no function when clicked by setting the <code class="literal">clickable</code> option to <code class="literal">false</code>.</p><a id="pro_id00304"/><pre class="programlisting"><span class="steelblue">L</span>.<span class="olive">polyline</span>(
    <span class="steelblue">seaboard</span>.<span class="olive">map</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(stop) {<span class="steelblue"><span class="strong"><strong>return</strong></span></span> [<span class="steelblue">stop</span>.<span class="olive">latitude</span>, <span class="steelblue">stop</span>.<span class="olive">longitude</span>]}),
    {<span class="dodgerblue">color:</span> <span class="maroon">"#88020B"</span>, <span class="dodgerblue">weight</span>: <span class="red">1</span>, <span class="dodgerblue">clickable</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>}
).<span class="olive">addTo</span>(map);

<span class="steelblue">L</span>.<span class="olive">polyline</span>(
    <span class="steelblue">southern</span>.<span class="olive">map</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(stop) {<span class="steelblue"><span class="strong"><strong>return</strong></span></span> [<span class="steelblue">stop</span>.<span class="olive">latitude</span>, <span class="steelblue">stop</span>.<span class="olive">longitude</span>]}),
    {<span class="dodgerblue">color:</span> <span class="maroon">"#106634"</span>, <span class="dodgerblue">weight</span>: <span class="red">1</span>, <span class="dodgerblue">clickable</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>}
).<span class="olive">addTo</span>(map);</pre><p>With this addition, the visualization shown in <a class="xref" href="ch06.html#additional_map_layers_add_data_to_the_ca" title="Figure 6-12. Additional map layers add data to the canvas.">Figure 6-12</a> is starting to convey the relative distances of the two routes.</p><div class="figure"><a id="additional_map_layers_add_data_to_the_ca"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00096"/><img src="figs/web/06fig12.png.jpg" alt="Additional map layers add data to the canvas."/></div></div><div class="figure-title">Figure 6-12. Additional map layers add data to the canvas.</div></div></div><div class="sect2" title="Step 5: Add an Animation Control"><div class="titlepage"><div><div><h3 class="title" id="step_5_add_an_animation_control">Step 5: Add an Animation Control</h3></div></div></div><p><a id="iddle1167" class="indexterm"/><a id="iddle1574" class="indexterm"/><a id="iddle1635" class="indexterm"/><a id="iddle1721" class="indexterm"/><a id="iddle1726" class="indexterm"/>Next, we’ll animate the two routes. Not only will this emphasize the competitive advantage of the shorter route, but it will also make the visualization more interesting and engaging. We’ll definitely want to let our users start and stop the animation, so our map will need a control button. The Leaflet library doesn’t have its own animation control, but the library does have a lot of support for customizations. Part of that support is a generic <code class="literal">Control</code> object. We can create an animation control by starting with that object and extending it.</p><a id="pro_id00305"/><pre class="programlisting"><span class="steelblue">L</span>.<span class="steelblue">Control</span>.<span class="olive">Animate</span> = <span class="steelblue">L</span>.<span class="steelblue">Control</span>.<span class="olive">extend</span>({
    <span class="indianred"><span class="emphasis"><em>// Custom code goes here</em></span></span>
});</pre><p>Next we define the options for our custom control. Those options include its position on the map, the text and tool tip (title) for its states, and functions to call when the animation starts or stops. We define these within an <code class="literal">options</code> object as follows, which lets Leaflet integrate them within its normal functionality.</p><a id="pro_id00306"/><pre class="programlisting"><span class="steelblue">L</span>.<span class="steelblue">Control</span>.<span class="olive">Animate</span> = <span class="steelblue">L</span>.<span class="steelblue">Control</span>.<span class="olive">extend</span>({
    <span class="dodgerblue">options</span>: {
        <span class="dodgerblue">position</span>: <span class="maroon">"topleft"</span>,
        <span class="dodgerblue">animateStartText</span>: <span class="maroon">"</span><span class="maroon"><span class="inlinemediaobject"><a id="inline_id00002"/><img src="figs/web/common-01.png.jpg" alt=""/></span></span><span class="maroon">"</span>,
        <span class="dodgerblue">animateStartTitle</span>: <span class="maroon">"Start Animation"</span>,
        <span class="dodgerblue">animatePauseText</span>: <span class="maroon">"</span><span class="maroon"><span class="inlinemediaobject"><a id="inline_id00003"/><img src="figs/web/common-02.png.jpg" alt=""/></span></span><span class="maroon">"</span>,
        <span class="dodgerblue">animatePauseTitle</span>: <span class="maroon">"Pause Animation"</span>,
        <span class="dodgerblue">animateResumeText</span>: <span class="maroon">"</span><span class="maroon"><span class="inlinemediaobject"><a id="inline_id00004"/><img src="figs/web/common-01.png.jpg" alt=""/></span></span><span class="maroon">"</span>,
        <span class="dodgerblue">animateResumeTitle</span>: <span class="maroon">"Resume Animation"</span>,
        <span class="dodgerblue">animateStartFn</span>: <span class="steelblue"><span class="strong"><strong>null</strong></span></span>,
        <span class="dodgerblue">animateStopFn</span>: <span class="steelblue"><span class="strong"><strong>null</strong></span></span>
    },</pre><p>For our example, we’re using UTF-8 characters for the play and pause control. In a production visualization, you might consider using icon fonts or images to have maximum control over the appearance.</p><p>Our animation control also needs an <code class="literal">onAdd()</code> method for Leaflet to call when it adds a control to a map. This method constructs the HTML markup for the control and returns that to the caller.</p><a id="pro_id00307"/><pre class="programlisting">   onAdd: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
       <span class="steelblue"><span class="strong"><strong>var</strong></span></span> animateName = <span class="maroon">"leaflet-control-animate"</span>,
➊         container = <span class="steelblue">L</span>.<span class="steelblue">DomUtil</span>.<span class="olive">create</span>(
               <span class="maroon">"div"</span>, animateName + <span class="maroon">" leaflet-bar"</span>),
           options = <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">options</span>;

➋         <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">_button</span> = <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">_createButton</span>(
               <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">options</span>.<span class="olive">animateStartText</span>,
               <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">options</span>.<span class="olive">animateStartTitle</span>,
               animateName,
               container,
           <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">_clicked</span>);

       <span class="steelblue"><span class="strong"><strong>return</strong></span></span> container;
   },</pre><p><a id="iddle1012" class="indexterm"/><a id="iddle1138" class="indexterm"/><a id="iddle1172" class="indexterm"/><a id="iddle1571" class="indexterm"/><a id="iddle1572" class="indexterm"/><a id="iddle1586" class="indexterm"/><a id="iddle1687" class="indexterm"/>Our implementation of <code class="literal">onAdd()</code> constructs the markup in two stages. First, starting at ➊, it creates a <code class="literal">&lt;div&gt;</code> element and gives that element two classes: <code class="literal">leaflet-control-animate</code> and <code class="literal">leaflet-bar</code>. The first class is unique to our animation control, and we can use it to apply CSS rules uniquely to our control. The second class is a general Leaflet class for all toolbars. By adding it to the animation control, we’re making that control consistent with other Leaflet controls. Note that Leaflet includes the <code class="literal">L.DomUtil.create()</code> method at ➊ to handle the details of creating the element.</p><p>The second part of <code class="literal">onAdd()</code> creates a button element within this <code class="literal">&lt;div&gt;</code> container. Most of the work takes place in the <code class="literal">_createButton()</code> function at ➋, which we’ll examine shortly. The parameters to the function include the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The text for the button</p></li><li class="listitem"><p>The tool tip (title) to display when the mouse hovers over the button</p></li><li class="listitem"><p>The CSS class to apply to the button</p></li><li class="listitem"><p>The container in which to insert the button</p></li><li class="listitem"><p>A function to call when the button is clicked</p></li></ul></div><p>If you’re wondering why the name of this function begins with an underscore (_), that’s the convention that Leaflet uses for private methods (and attributes). There’s no requirement to follow it, but doing so will make it easier for someone familiar with Leaflet to understand our code.</p><p>The <code class="literal">_createButton()</code> method itself relies on Leaflet utility functions.</p><a id="pro_id00308"/><pre class="programlisting">   _createButton: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> (html, title, className, container, callback) {
➊     <span class="steelblue"><span class="strong"><strong>var</strong></span></span> link = <span class="steelblue">L</span>.<span class="steelblue">DomUtil</span>.<span class="olive">create</span>(<span class="maroon">"a"</span>, className, container);
       <span class="steelblue">link</span>.<span class="olive">innerHTML</span> = html;
       <span class="steelblue">link</span>.<span class="olive">href</span> = <span class="maroon">"#"</span>;
➋     <span class="steelblue">link</span>.<span class="olive">title</span> = title;

       <span class="steelblue">L</span>.<span class="olive">DomEvent</span>
➌         .<span class="olive">on</span>(link, <span class="maroon">"mousedown dblclick"</span>, <span class="steelblue">L</span>.<span class="steelblue">DomEvent</span>.<span class="olive">stopPropagation</span>)
➍         .<span class="olive">on</span>(link, <span class="maroon">"click"</span>, <span class="steelblue">L</span>.<span class="steelblue">DomEvent</span>.<span class="olive">stop</span>)
➎         .<span class="olive">on</span>(link, <span class="maroon">"click"</span>, callback, <span class="steelblue"><span class="strong"><strong>this</strong></span></span>);

       <span class="steelblue"><span class="strong"><strong>return</strong></span></span> link;
   },</pre><p>First it creates the button as an <code class="literal">&lt;a&gt;</code> element with the specified text, title, and class, and it creates that element within the appropriate container (➊ through ➋). It then binds several events to this <code class="literal">&lt;a&gt;</code> element. First it ignores initial <code class="literal">mousedown</code> and double-click events at ➌. It also prevents single-click events from propagating up <a id="iddle1570" class="indexterm"/><a id="iddle1817" class="indexterm"/>the document tree and from implementing their default behavior at ➍. Finally, it executes the callback function on <code class="literal">click</code> events at ➎.</p><p>The callback function itself is our next task.</p><a id="pro_id00309"/><pre class="programlisting">➊  _running: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,

   _clicked: <span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {
➋     <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">_running</span>) {
           <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">options</span>.<span class="olive">animateStopFn</span>) {
               <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">options</span>.<span class="olive">animateStopFn</span>();
           }
           <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">_button</span>.<span class="olive">innerHTML</span> = <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">options</span>.<span class="olive">animateResumeText</span>;
           <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">_button</span>.<span class="olive">title</span> = <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">options</span>.<span class="olive">animateResumeTitle</span>;
       } <span class="steelblue"><span class="strong"><strong>else</strong></span></span> {
           <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">options</span>.<span class="olive">animateStartFn</span>) {
               <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">options</span>.<span class="olive">animateStartFn</span>();
           }
           <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">_button</span>.<span class="olive">innerHTML</span> = <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">options</span>.<span class="olive">animatePauseText</span>;
           <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">_button</span>.<span class="olive">title</span> = <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">options</span>.<span class="olive">animatePauseTitle</span>;
       }
       <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">_running</span> = !<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">_running</span>;
   },</pre><p>Before we get into the function, we add a single state variable (<code class="literal">_running</code>) to keep track of whether the animation is currently running. It starts out stopped at ➊. Then our callback function starts by checking this variable at ➋. If <code class="literal">_running</code> is <code class="literal">true</code>, that means the animation was running and has just been paused by the current click, so it changes the control to indicate that clicking will now resume the animation. If the animation isn’t running, the callback function does the opposite: it changes the control to indicate that a subsequent click will pause it. In both cases, the callback function executes the appropriate control function if one exists. Finally, it sets the state of <code class="literal">_running</code> to its complement.</p><p>The last part of our custom control adds a <code class="literal">reset()</code> method to clear the animation. This function sets the control back to its initial state.</p><a id="pro_id00310"/><pre class="programlisting">    reset: <span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {
        <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">_running</span> = <span class="steelblue"><span class="strong"><strong>false</strong></span></span>;
        <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">_button</span>.<span class="olive">innerHTML</span> = <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">options</span>.<span class="olive">animateStartText</span>;
        <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">_button</span>.<span class="olive">title</span> = <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">options</span>.<span class="olive">animateStartTitle</span>;
    }
});</pre><p>To completely integrate our custom control into the Leaflet architecture, we add a function to the <code class="literal">L.control</code> object. Following the Leaflet convention, this function’s name begins with a lowercase letter but is otherwise identical to the name of our control.</p><a id="pro_id00311"/><pre class="programlisting"><span class="steelblue">L</span>.<span class="steelblue">control</span>.<span class="olive">animate</span> = <span class="steelblue"><span class="strong"><strong>function</strong></span></span> (options) {
    <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">L</span>.<span class="steelblue">Control</span>.<span class="olive">Animate</span>(options);
};</pre><p><a id="iddle1027" class="indexterm"/><a id="iddle1583" class="indexterm"/><a id="iddle1644" class="indexterm"/>Defining this last function lets us create the control using a common Leaflet syntax.</p><a id="pro_id00312"/><pre class="programlisting"><span class="steelblue">L</span>.<span class="steelblue">control</span>.<span class="olive">animate</span>().<span class="olive">addTo</span>(map);</pre><p>This is the same syntax we’ve seen before with layers and polylines.</p></div><div class="sect2" title="Step 6: Prepare the Animation"><div class="titlepage"><div><div><h3 class="title" id="step_6_prepare_the_animation">Step 6: Prepare the Animation</h3></div></div></div><p>With a convenient user control in place, we can now begin work on the animation itself. Although this particular animation isn’t especially taxing, we can still follow best practices and compute as much as possible in advance. Since we’re animating two routes, we’ll define a function that will build an animation for any input route. A second parameter will specify polyline options. This function will return an array of polyline paths, indexed by minutes. You can see the basic structure of this function next.</p><a id="pro_id00313"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> buildAnimation = <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(route, options) {
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> animation = [];

    <span class="indianred"><span class="emphasis"><em>// Code to build the polylines</em></span></span>

    <span class="steelblue"><span class="strong"><strong>return</strong></span></span> animation;
}</pre><p>The first element in the array will be the polyline for the first minute of the route. We’ll build the entire array in the <code class="literal">animation</code> variable.</p><p>To build the paths, we iterate through the stops on the route.</p><a id="pro_id00314"/><pre class="programlisting">➊ <span class="steelblue"><span class="strong"><strong>for</strong></span></span> (<span class="steelblue"><span class="strong"><strong>var</strong></span></span> stopIdx=<span class="red">0</span>, prevStops=[];
            stopIdx &lt; <span class="steelblue">route</span>.<span class="olive">length</span><span class="red">-1</span>; stopIdx++) {
       <span class="indianred"><span class="emphasis"><em>// Code to calculate steps between current stop and next stop</em></span></span>
   }</pre><p>We want to keep track of all the stops we’ve already passed, so we define the <code class="literal">prevStops</code> array and initialize it as empty at ➊. Each iteration calculates the animation steps for the current stop up to the next stop. There’s no need to go beyond the final stop on the route, so we terminate the loop at the next-to-last stop (<code class="literal">stopIdx &lt; route.length-1;</code>).</p><p>As we start to calculate the paths beginning at the current stop, we’ll store that stop and the next one in local variables, and we’ll add the current stop to the <code class="literal">prevStops</code> array that’s keeping track of previous stops.</p><a id="pro_id00315"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> stop = route[stopIdx];
<span class="steelblue"><span class="strong"><strong>var</strong></span></span> nextStop = route[stopIdx<span class="red">+1</span>]
<span class="steelblue">prevStops</span>.<span class="olive">push</span>([<span class="steelblue">stop</span>.<span class="olive">latitude</span>, <span class="steelblue">stop</span>.<span class="olive">longitude</span>]);</pre><p><a id="iddle1162" class="indexterm"/><a id="iddle1295" class="indexterm"/><a id="iddle1577" class="indexterm"/><a id="iddle1638" class="indexterm"/><a id="iddle1828" class="indexterm"/>For each stop in our data sets, the <code class="literal">duration</code> property stores the number of minutes until the next stop. We’ll use an inner loop, shown next, to count from <code class="literal">1</code> up to that value.</p><a id="pro_id00316"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>for</strong></span></span> (<span class="steelblue"><span class="strong"><strong>var</strong></span></span> minutes = <span class="red">1</span>; minutes &lt;= <span class="steelblue">stop</span>.<span class="olive">duration</span>; minutes++) {
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> position = [
        <span class="steelblue">stop</span>.<span class="olive">latitude</span> +
          (<span class="steelblue">nextStop</span>.<span class="olive">latitude</span> - <span class="steelblue">stop</span>.<span class="olive">latitude</span>) *
          (minutes/<span class="steelblue">stop</span>.<span class="olive">duration</span>),
        <span class="steelblue">stop</span>.<span class="olive">longitude</span> +
          (<span class="steelblue">nextStop</span>.<span class="olive">longitude</span> - <span class="steelblue">stop</span>.<span class="olive">longitude</span>) *
          (minutes/<span class="steelblue">stop</span>.<span class="olive">duration</span>)
    ];
    <span class="steelblue">animation</span>.<span class="olive">push</span>(
        <span class="steelblue">L</span>.<span class="olive">polyline</span>(<span class="steelblue">prevStops</span>.<span class="olive">concat</span>([position]), options)
    );
}</pre><p>Within the loop, we use a simple linear interpolation to calculate the position at the corresponding time. That position, when appended to the <code class="literal">prevStops</code> array, is the polyline path for that time. This code creates a polyline based on the path and adds it to the animation array.</p><p>When we use the array <code class="literal">concat()</code> method, we embed the position array within another array object. That keeps <code class="literal">concat()</code> from flattening the position array before appending it. You can see the difference in the following examples. It’s the latter outcome that we want.</p><a id="pro_id00317"/><pre class="programlisting">[[<span class="red">1</span>,<span class="red">2</span>], [<span class="red">3</span>,<span class="red">4</span>]].<span class="olive">concat</span>([<span class="red">5</span>,<span class="red">6</span>]);   <span class="indianred"><span class="emphasis"><em>// =&gt; [[1,2], [3,4], 5, 6]</em></span></span>
[[<span class="red">1</span>,<span class="red">2</span>], [<span class="red">3</span>,<span class="red">4</span>]].<span class="olive">concat</span>([[<span class="red">5</span>,<span class="red">6</span>]]); <span class="indianred"><span class="emphasis"><em>// =&gt; [[1,2], [3,4], [5,6]]</em></span></span></pre></div><div class="sect2" title="Step 7: Animate the Routes"><div class="titlepage"><div><div><h3 class="title" id="step_7_animate_the_routes">Step 7: Animate the Routes</h3></div></div></div><p>Now it’s finally time to execute the animation. To initialize it, we create an array to hold the two routes.</p><a id="pro_id00318"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> routeAnimations = [
    <span class="olive">buildAnimation</span>(seaboard,
      {<span class="dodgerblue">clickable:</span> <span class="steelblue"><span class="strong"><strong>false</strong></span></span>, <span class="dodgerblue">color</span>: <span class="maroon">"#88020B"</span>, <span class="dodgerblue">weight</span>: <span class="red">8</span>, <span class="dodgerblue">opacity</span>: <span class="red">1.0</span>}
    ),
    <span class="olive">buildAnimation</span>(southern,
      {<span class="dodgerblue">clickable:</span> <span class="steelblue"><span class="strong"><strong>false</strong></span></span>, <span class="dodgerblue">color</span>: <span class="maroon">"#106634"</span>, <span class="dodgerblue">weight</span>: <span class="red">8</span>, <span class="dodgerblue">opacity</span>: <span class="red">1.0</span>}
    )
];</pre><p><a id="iddle1043" class="indexterm"/><a id="iddle1665" class="indexterm"/>Next we calculate the maximum number of animation steps. That’s the minimum of the length of the two animation arrays.</p><a id="pro_id00319"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> maxSteps = <span class="steelblue">Math</span>.<span class="steelblue">min</span>.<span class="olive">apply</span>(<span class="steelblue"><span class="strong"><strong>null</strong></span></span>,
    <span class="steelblue">routeAnimations</span>.<span class="olive">map</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(animation) {
        <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue">animation</span>.<span class="olive">length</span>
    })
);</pre><p>That statement might seem overly complex for finding the minimum length, but it works with an arbitrary number of routes. If, in the future, we decided to animate a third route on our map, we wouldn’t have to change the code. The best way to understand the statement is to start in the middle and work outward. The following fragment converts the array of route animations into an array of lengths, specifically <code class="literal">[870,775]</code>:</p><a id="pro_id00320"/><pre class="programlisting"><span class="steelblue">routeAnimations</span>.<span class="olive">map</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(animation) {<span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue">animation</span>.<span class="olive">length</span>})</pre><p>To find the minimum value in an array, we can use the <code class="literal">Math.min()</code> function, except that function expects its parameters as a comma-separated list of arguments rather than an array. The <code class="literal">apply()</code> method (which is available for any JavaScript function) converts an array into a comma-separated list. Its first parameter is a context for the function, which in our case is irrelevant, so we pass <code class="literal">null</code> for that parameter.</p><p>The animation keeps track of its current state with the <code class="literal">step</code> variable, which we initialize to <code class="literal">0</code>.</p><a id="pro_id00321"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> step = <span class="red">0</span>;</pre><p>The <code class="literal">animateStep()</code> function processes each step in the animation. There are four parts to this function.</p><a id="pro_id00322"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> animateStep = <span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {
    <span class="indianred"><span class="emphasis"><em>// Draw the next step in the animation</em></span></span>
}</pre><p>First we check to see whether this is the very first step in the animation.</p><a id="pro_id00323"/><pre class="programlisting">   <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (step &gt; <span class="red">0</span>) {
       <span class="steelblue">routeAnimations</span>.<span class="olive">forEach</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(animation) {
➊         <span class="steelblue">map</span>.<span class="olive">removeLayer</span>(animation[step<span class="red">-1</span>]);
       });
   }</pre><p>If it isn’t, <code class="literal">step</code> will be greater than zero and we can remove the previous step’s polylines from the map at ➊.</p><p><a id="iddle1026" class="indexterm"/><a id="iddle1747" class="indexterm"/>Next we check to see if we’re already at the end of the animation. If so, then we restart the animation back at step 0.</p><a id="pro_id00324"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>if</strong></span></span> (step === maxSteps) {
    step = <span class="red">0</span>;
}</pre><p>For the third part, we add the current step’s polylines to the map.</p><a id="pro_id00325"/><pre class="programlisting"><span class="steelblue">routeAnimations</span>.<span class="olive">forEach</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(animation) {
    <span class="steelblue">map</span>.<span class="olive">addLayer</span>(animation[step]);
});</pre><p>Finally, we return <code class="literal">true</code> if we’ve reached the end of the animation.</p><a id="pro_id00326"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>return</strong></span></span> ++step === maxSteps;</pre><p>We’ll execute this step function repeatedly in a JavaScript interval, shown next.</p><a id="pro_id00327"/><pre class="programlisting">   <span class="steelblue"><span class="strong"><strong>var</strong></span></span> interval = <span class="steelblue"><span class="strong"><strong>null</strong></span></span>;
   <span class="steelblue"><span class="strong"><strong>var</strong></span></span> animate = <span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {
       interval = <span class="steelblue">window</span>.<span class="olive">setInterval</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {
➊         <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (<span class="olive">animateStep</span>()) {
               <span class="steelblue">window</span>.<span class="olive">clearInterval</span>(interval);
               <span class="steelblue">control</span>.<span class="olive">reset</span>();
           }
       }, <span class="red">30</span>);
   }
➋ <span class="steelblue"><span class="strong"><strong>var</strong></span></span> pause = <span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {
       <span class="steelblue">window</span>.<span class="olive">clearInterval</span>(interval);
   }</pre><p>We use a variable to keep a reference to that interval and add functions to start and stop it. In the <code class="literal">animate()</code> function, we check the return value from <code class="literal">animateStep()</code> at ➊. When it returns <code class="literal">true</code>, the animation is complete, so we clear the interval and reset our control. (We’ll see where that control is defined shortly.) The <code class="literal">pause()</code> function at ➋ stops the interval.</p><p>Now all we need to do is define the animation control using the object we created in Step 5.</p><a id="pro_id00328"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> control = <span class="steelblue">L</span>.<span class="steelblue">control</span>.<span class="olive">animate</span>({
    <span class="dodgerblue">animateStartFn</span>: animate,
    <span class="dodgerblue">animateStopFn</span>:  pause
});
<span class="steelblue">control</span>.<span class="olive">addTo</span>(map);</pre><p>Once we add it to the map, the user will be able to activate the animation.</p></div><div class="sect2" title="Step 8: Create Labels for the Stops"><div class="titlepage"><div><div><h3 class="title" id="step_8_create_labels_for_the_stops">Step 8: Create Labels for the Stops</h3></div></div></div><p><a id="iddle1485" class="indexterm"/><a id="iddle1555" class="indexterm"/><a id="iddle1562" class="indexterm"/><a id="iddle1579" class="indexterm"/><a id="iddle1640" class="indexterm"/><a id="iddle1725" class="indexterm"/>Before we wrap up the animation, we’ll add some labels for each train stop. To emphasize the passage of time, we’ll reveal each label as the animation reaches the corresponding stop. To do that, we’ll create the labels using a special object; then we’ll create a method to add labels to the map; and, to finish the label object, we’ll add methods that get or set a label’s status.</p><p>Since Leaflet doesn’t have a predefined object for labels, we can once again create our own custom object. We start with the basic Leaflet <code class="literal">Class</code>.</p><a id="pro_id00329"/><pre class="programlisting"><span class="steelblue">L</span>.<span class="olive">Label</span> = <span class="steelblue">L</span>.<span class="steelblue">Class</span>.<span class="olive">extend</span>({
    <span class="indianred"><span class="emphasis"><em>// Implement the Label object</em></span></span>
});</pre><p>Our <code class="literal">Label</code> object accepts parameters for its position on the map, its label text, and any options. Next, we extend the <code class="literal">initialize()</code> method of the Leaflet <code class="literal">Class</code> to handle those parameters.</p><a id="pro_id00330"/><pre class="programlisting">   initialize: <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(latLng, label, options) {
       <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">_latlng</span> = latLng;
       <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">_label</span> = label;
➊     <span class="steelblue">L</span>.<span class="steelblue">Util</span>.<span class="olive">setOptions</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>, options);
➋     <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">_status</span> = <span class="maroon">"hidden"</span>;
   },</pre><p>For position and text, we simply save their values for later use. For the options, we use a Leaflet utility at ➊ to easily support default values. The object includes one variable to keep track of its status. Initially all labels are hidden, so <code class="literal">this._status</code> is initialized appropriately at ➋.</p><p>Next we define the default option values with the <code class="literal">options</code> attribute.</p><a id="pro_id00331"/><pre class="programlisting">    options: {
        <span class="dodgerblue">offset</span>: <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">L</span>.<span class="olive">Point</span>(<span class="red">0</span>, <span class="red">0</span>)
    },
});</pre><p>The only option we need for our label is an offset for the standard position. By default, that offset will be <code class="literal">0</code> in both the x- and y-coordinates.</p><p>This <code class="literal">options</code> attribute, combined with the call to <code class="literal">L.Util.setOptions</code> in the <code class="literal">initialize</code> method, establishes a default value (<code class="literal">0,0</code>) for the offset that can be easily overridden when a <code class="literal">Label</code> object is created.</p><p>Next we write the method that adds a label to a map.</p><a id="pro_id00332"/><pre class="programlisting">   onAdd: <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(map) {
➊     <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">_container</span> = <span class="steelblue">L</span>.<span class="steelblue">DomUtil</span>.<span class="olive">create</span>(<span class="maroon">"div"</span>, <span class="maroon">"leaflet-label"</span>);
➋     <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">_container</span>.<span class="steelblue">style</span>.<span class="olive">lineHeight</span> = <span class="maroon">"0"</span>;
➌     <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">_container</span>.<span class="steelblue">style</span>.<span class="olive">opacity</span> = <span class="maroon">"0"</span>;
➍     <span class="steelblue">map</span>.<span class="olive">getPanes</span>().<span class="steelblue">markerPane</span>.<span class="olive">appendChild</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">_container</span>);
➎     <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">_container</span>.<span class="olive">innerHTML</span> = <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">_label</span>;
➏     <span class="steelblue"><span class="strong"><strong>var</strong></span></span> position = <span class="steelblue">map</span>.<span class="olive">latLngToLayerPoint</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">_latlng</span>);
➐     position = <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">L</span>.<span class="olive">Point</span>(
           <span class="steelblue">position</span>.<span class="olive">x</span> + <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">options</span>.<span class="steelblue">offset</span>.<span class="olive">x</span>,
           <span class="steelblue">position</span>.<span class="olive">y</span> + <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">options</span>.<span class="steelblue">offset</span>.<span class="olive">y</span>
➑     );
➒     <span class="steelblue">L</span>.<span class="steelblue">DomUtil</span>.<span class="olive">setPosition</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">_container</span>, position);
   },</pre><p><a id="iddle1588" class="indexterm"/>This method does the following:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Creates a new <code class="literal">&lt;div&gt;</code> element with the CSS class <code class="literal">leaflet-label</code> at ➊</p></li><li class="listitem"><p>Sets the <code class="literal">line-height</code> of that element to <code class="literal">0</code> to work around a quirk in the way Leaflet calculates position at ➋</p></li><li class="listitem"><p>Sets the <code class="literal">opacity</code> of the element to <code class="literal">0</code> to match its initial <code class="literal">hidden</code> status at ➌</p></li><li class="listitem"><p>Adds the new element to the <code class="literal">markerPane</code> layer in the map at ➍</p></li><li class="listitem"><p>Sets the contents of the element to the label text at ➎</p></li><li class="listitem"><p>Calculates a position for the label using its defined latitude/longitude at ➏ and then adjusts for any offset (➐ through ➑)</p></li><li class="listitem"><p>Positions the element on the map at ➒</p></li></ol></div><div class="note" title="Note"><h3 class="title"><a id="ch06note05"/>Note</h3><p><span class="strong"><strong>Step 2—setting the <code class="literal">line-height</code> to <code class="literal">0</code>—addresses a problem in the method Leaflet uses to position elements on the map. In particular, Leaflet does not account for other elements in the same parent container. By setting all elements to have no line height, we nullify this effect so that the calculated position is correct.</strong></span></p></div><p>Finally, we add methods to get and set the label’s status. As the following code indicates, our labels can have three different status values, and those values determine the opacity of the label.</p><a id="pro_id00333"/><pre class="programlisting">getStatus: <span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {
    <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">_status</span>;
},
setStatus: <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(status) {
    <span class="steelblue"><span class="strong"><strong>switch</strong></span></span> (status) {
        <span class="steelblue"><span class="strong"><strong>case</strong></span></span> <span class="maroon">"hidden"</span>:
            <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">_status</span> = <span class="maroon">"hidden"</span>;
            <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">_container</span>.<span class="steelblue">style</span>.<span class="olive">opacity</span> = <span class="maroon">"0"</span>;
            <span class="steelblue"><span class="strong"><strong>break</strong></span></span>;
        <span class="steelblue"><span class="strong"><strong>case</strong></span></span> <span class="maroon">"shown"</span>:
            <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">_status</span> = <span class="maroon">"shown"</span>;
            <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">_container</span>.<span class="steelblue">style</span>.<span class="olive">opacity</span> = <span class="maroon">"1"</span>;
            <span class="steelblue"><span class="strong"><strong>break</strong></span></span>;
        <span class="steelblue"><span class="strong"><strong>case</strong></span></span> <span class="maroon">"dimmed"</span>:
            <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">_status</span> = <span class="maroon">"dimmed"</span>;
            <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">_container</span>.<span class="steelblue">style</span>.<span class="olive">opacity</span> = <span class="maroon">"0.5"</span>;
            <span class="steelblue"><span class="strong"><strong>break</strong></span></span>;
    }
}</pre><p><a id="iddle1047" class="indexterm"/><a id="iddle1107" class="indexterm"/><a id="iddle1561" class="indexterm"/><a id="iddle1578" class="indexterm"/><a id="iddle1639" class="indexterm"/><a id="iddle1715" class="indexterm"/><a id="iddle1899" class="indexterm"/>We included the option to adjust the label’s position because not all labels will look good positioned exactly on the latitude and longitude of the station. Most will benefit from slight shifts to avoid interference with the route polylines, text on the base map tiles, or other labels. For a custom visualization such as this example, there’s no substitute for trial-and-error adjustments. We’ll capture those adjustments for each label by adding another <code class="literal">offset</code> field to our data set. The augmented data set might begin like this:</p><a id="pro_id00334"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> seaboard = [
{ <span class="maroon">"stop"</span>: <span class="maroon">"Washington"</span>,     <span class="maroon">"offset"</span>: [-<span class="red">30</span>,-<span class="red">10</span>], <span class="indianred"><span class="emphasis"><em>/* Data continues... */</em></span></span> },
{ <span class="maroon">"stop"</span>: <span class="maroon">"Fredericksburg"</span>, <span class="maroon">"offset"</span>: [  <span class="red">6</span>,  <span class="red">4</span>], <span class="indianred"><span class="emphasis"><em>/* Data continues... */</em></span></span> },
{ <span class="maroon">"stop"</span>: <span class="maroon">"Richmond"</span>,       <span class="maroon">"offset"</span>: [  <span class="red">6</span>,  <span class="red">4</span>], <span class="indianred"><span class="emphasis"><em>/* Data continues... */</em></span></span> },
<span class="indianred"><span class="emphasis"><em>// Data set continues...</em></span></span></pre></div><div class="sect2" title="Step 9: Build the Label Animation"><div class="titlepage"><div><div><h3 class="title" id="step_9_build_the_label_animation">Step 9: Build the Label Animation</h3></div></div></div><p>To create the label animation, we can once again iterate through the trains’ routes. Because we have more than one route, a general-purpose function will let us avoid duplicating code. As you can see from the following code, we’re not using a fixed number of arguments to our function. Instead, we let the caller pass in as many individual routes as desired. All of those input parameters will be stored in the <code class="literal">arguments</code> object.</p><p>The <code class="literal">arguments</code> object looks a lot like a JavaScript array. It has a <code class="literal">length</code> property, and we can access individual elements using, for example, <code class="literal">arguments[0]</code>. Unfortunately, the object isn’t a true array, so we can’t use the convenient array methods (such as <code class="literal">forEach</code>) on it. As a workaround, the very first statement in our <code class="literal">buildLabelAnimation()</code> function, shown next, relies on a simple trick to convert the <code class="literal">arguments</code> object into the true <code class="literal">args</code> array.</p><a id="pro_id00335"/><pre class="programlisting">   <span class="steelblue"><span class="strong"><strong>var</strong></span></span> buildLabelAnimation = <span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {
➊     <span class="steelblue"><span class="strong"><strong>var</strong></span></span> args = <span class="steelblue">Array</span>.<span class="steelblue">prototype</span>.<span class="steelblue">slice</span>.<span class="olive">call</span>(arguments),
           labels = [];

       <span class="indianred"><span class="emphasis"><em>// Calculate label animation values</em></span></span>

       <span class="steelblue"><span class="strong"><strong>return</strong></span></span> labels;
   }</pre><p>It’s a bit long winded, but the statement at ➊ effectively executes the <code class="literal">slice()</code> method on <code class="literal">arguments</code>. That operation clones <code class="literal">arguments</code> into a true array.</p><div class="note" title="Note"><h3 class="title"><a id="ch06note06"/>Note</h3><p><span class="strong"><strong>This same trick works for nearly all of JavaScript’s “array-like” objects. You can often use it to convert them into true arrays.</strong></span></p></div><p>With the routes converted into an array, we can use <code class="literal">forEach</code> to iterate through all of them, regardless of their number.</p><a id="pro_id00336"/><pre class="programlisting"><span class="steelblue">args</span>.<span class="olive">forEach</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(route) {
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> minutes = <span class="red">0</span>;
    <span class="steelblue">route</span>.<span class="olive">forEach</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(stop,idx) {
        <span class="indianred"><span class="emphasis"><em>// Process each stop on the route</em></span></span>
    });
});</pre><p><a id="iddle1556" class="indexterm"/>As we begin processing each route, we set the <code class="literal">minutes</code> value to <code class="literal">0</code>. Then we can use <code class="literal">forEach</code> again to iterate through all the stops on the route.</p><a id="pro_id00337"/><pre class="programlisting">   <span class="steelblue">route</span>.<span class="olive">forEach</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(stop,idx) {
       <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (idx !== <span class="red">0</span> &amp;&amp; idx &lt; <span class="steelblue">route</span>.<span class="olive">length</span><span class="red">-1</span>) {
➊         <span class="steelblue"><span class="strong"><strong>var</strong></span></span> label = <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">L</span>.<span class="olive">Label</span>(
               [<span class="steelblue">stop</span>.<span class="olive">latitude</span>, <span class="steelblue">stop</span>.<span class="olive">longitude</span>],
               <span class="steelblue">stop</span>.<span class="olive">stop</span>,
               {<span class="dodgerblue">offset</span>: <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">L</span>.<span class="olive">Point</span>(<span class="steelblue">stop</span>.<span class="olive">offset</span>[<span class="red">0</span>], <span class="steelblue">stop</span>.<span class="olive">offset</span>[<span class="red">1</span>])}
           );
           <span class="steelblue">map</span>.<span class="olive">addLayer</span>(label);
➋         <span class="steelblue">labels</span>.<span class="olive">push</span>(
               {<span class="dodgerblue">minutes</span>: minutes, <span class="dodgerblue">label</span>: label, <span class="dodgerblue">status</span>: <span class="maroon">"shown"</span>}
           );
➌         <span class="steelblue">labels</span>.<span class="olive">push</span>(
               {<span class="dodgerblue">minutes</span>: minutes<span class="red">+50</span>, <span class="dodgerblue">label</span>: label, <span class="dodgerblue">status</span>: <span class="maroon">"dimmed"</span>}
           );
       }
       minutes += <span class="steelblue">stop</span>.<span class="olive">duration</span>;
   });</pre><p>For each stop in the route, we first check to see whether that stop is the first or last one. If so, we don’t want to animate a label for that stop. Otherwise, we create a new <code class="literal">Label</code> object at ➊ and add it to the map. Then we append that <code class="literal">Label</code> object to the <code class="literal">labels</code> array that’s accumulating the label animation data. Notice that we add each label to this array twice. The first time we add it (➋) is at the time the animation reaches the stop; in this case, we add it with a status of <code class="literal">shown</code>. We also add the label to the array 50 minutes later (➌), this time with a status of <code class="literal">dimmed</code>. When we execute the animation, it will show the label when the route first reaches the station and then dim it a bit later.</p><p>Once we’ve iterated through all the routes, our <code class="literal">labels</code> array will indicate when each label should change status. At this point, though, the labels aren’t listed in the order of their animation state changes. To fix that, we sort the array in order of increasing time.</p><a id="pro_id00338"/><pre class="programlisting"><span class="steelblue">labels</span>.<span class="olive">sort</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(a,b) {<span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue">a</span>.<span class="olive">minutes</span> - <span class="steelblue">b</span>.<span class="olive">minutes</span>;})</pre><p>To use our new function, we call and pass in all the routes to animate.</p><a id="pro_id00339"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> labels = <span class="olive">buildLabelAnimation</span>(seaboard, southern);</pre><p><a id="iddle1563" class="indexterm"/><a id="iddle1581" class="indexterm"/><a id="iddle1642" class="indexterm"/><a id="iddle1900" class="indexterm"/>Because we’re not animating the start (Washington, DC) or end (Atlanta) of any routes, we can go ahead and display those on the map from the start. We can get the coordinates from any route; the following example uses the <code class="literal">seaboard</code> data set.</p><a id="pro_id00340"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> start = seaboard[<span class="red">0</span>];
<span class="steelblue"><span class="strong"><strong>var</strong></span></span> label = <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">L</span>.<span class="olive">Label</span>(
    [<span class="steelblue">start</span>.<span class="olive">latitude</span>, <span class="steelblue">start</span>.<span class="olive">longitude</span>],
    <span class="steelblue">start</span>.<span class="olive">stop</span>,
    {<span class="dodgerblue">offset:</span> <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">L</span>.<span class="olive">Point</span>(<span class="steelblue">start</span>.<span class="olive">offset</span>[<span class="red">0</span>], <span class="steelblue">start</span>.<span class="olive">offset</span>[<span class="red">1</span>])}
);
<span class="steelblue">map</span>.<span class="olive">addLayer</span>(label);
<span class="steelblue">label</span>.<span class="olive">setStatus</span>(<span class="maroon">"shown"</span>);

<span class="steelblue"><span class="strong"><strong>var</strong></span></span> finish = seaboard[<span class="steelblue">seaboard</span>.<span class="olive">length</span><span class="red">-1</span>];
label = <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">L</span>.<span class="olive">Label</span>(
    [<span class="steelblue">finish</span>.<span class="olive">latitude</span>, <span class="steelblue">finish</span>.<span class="olive">longitude</span>],
    <span class="steelblue">finish</span>.<span class="olive">stop</span>,
    {<span class="dodgerblue">offset:</span> <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">L</span>.<span class="olive">Point</span>(<span class="steelblue">finish</span>.<span class="olive">offset</span>[<span class="red">0</span>], <span class="steelblue">finish</span>.<span class="olive">offset</span>[<span class="red">1</span>])}
);
<span class="steelblue">map</span>.<span class="olive">addLayer</span>(label);
<span class="steelblue">label</span>.<span class="olive">setStatus</span>(<span class="maroon">"shown"</span>);</pre></div><div class="sect2" title="Step 10: Incorporate Label Animation in the Animation Step"><div class="titlepage"><div><div><h3 class="title" id="step_10_incorporate_label_animation_in_t">Step 10: Incorporate Label Animation in the Animation Step</h3></div></div></div><p>Now that the label animation data is available, we can make some adjustments to our animation function to incorporate the labels as well as the polyline paths. The first change is deciding when to conclude the animation. Because we’re dimming the labels some time after the route passes their stops, we can’t simply stop when all the paths are drawn. That might leave some labels undimmed. We’ll need separate variables to store the number of steps for each animation, and the total number of animation steps will be whichever is greater.</p><a id="pro_id00341"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> maxPathSteps = <span class="steelblue">Math</span>.<span class="steelblue">min</span>.<span class="olive">apply</span>(<span class="steelblue"><span class="strong"><strong>null</strong></span></span>,
    <span class="steelblue">routeAnimations</span>.<span class="olive">map</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(animation) {
        <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue">animation</span>.<span class="olive">length</span>
    })
);
<span class="steelblue"><span class="strong"><strong>var</strong></span></span> maxLabelSteps = labels[<span class="steelblue">labels</span>.<span class="olive">length</span><span class="red">-1</span>].<span class="olive">minutes</span>;
<span class="steelblue"><span class="strong"><strong>var</strong></span></span> maxSteps = <span class="steelblue">Math</span>.<span class="olive">max</span>(maxPathSteps, maxLabelSteps);</pre><p>We also need a copy of the label animation data that we can destroy during the animation, while keeping the original data intact. We don’t want to destroy the original so that users can replay the animation if they wish. The easiest way to copy a JavaScript array is by calling its <code class="literal">slice(0)</code> method.</p><div class="note" title="Note"><h3 class="title"><a id="ch06note07"/>Note</h3><p><span class="strong"><strong>We can’t simply copy the array using an assignment statement (<code class="literal">var labelAnimation = labels</code>). In JavaScript this statement would simply set <code class="literal">labelAnimation</code> to reference the same actual array as labels. Any changes made to the first would also affect the latter.</strong></span></p></div><a id="pro_id00342"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> labelAnimation = <span class="steelblue">labels</span>.<span class="olive">slice</span>(<span class="red">0</span>);</pre><p><a id="iddle1888" class="indexterm"/>The animation step function itself needs some additional code to handle labels. It will now have five major parts; we’ll walk through each of them in the code that follows. Our first adjustment is to make sure the code removes previous polyline paths only as long as we’re still adding paths to the map. That’s true only when <code class="literal">step</code> is less than <code class="literal">maxPathSteps</code>.</p><a id="pro_id00343"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>if</strong></span></span> (step &gt; <span class="red">0</span> &amp;&amp; step &lt; maxPathSteps) {
    <span class="steelblue">routeAnimations</span>.<span class="olive">forEach</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(animation) {
        <span class="steelblue">map</span>.<span class="olive">removeLayer</span>(animation[step<span class="red">-1</span>]);
    });
}</pre><p>The next block handles the case in which the user replays the animation.</p><a id="pro_id00344"/><pre class="programlisting">   <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (step === maxSteps) {
➊     <span class="steelblue">routeAnimations</span>.<span class="olive">forEach</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(animation) {
           <span class="steelblue">map</span>.<span class="olive">removeLayer</span>(animation[maxPathSteps<span class="red">-1</span>]);
➋     });
➌     labelAnimation = <span class="steelblue">labels</span>.<span class="olive">slice</span>(<span class="red">0</span>);
➍     <span class="steelblue">labelAnimation</span>.<span class="olive">forEach</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(label) {
           <span class="steelblue">label</span>.<span class="steelblue">label</span>.<span class="olive">setStatus</span>(<span class="maroon">"hidden"</span>);
➎     });
➏     step = <span class="red">0</span>;
   }</pre><p>When the animation replays, the <code class="literal">step</code> value will still be set to <code class="literal">maxSteps</code> from the prior animation. To reset the animation, we remove the last polyline paths for each route (➊ through ➋), make a new copy of the label animation data (➌), and hide all the labels (➍ through ➎). We also reset the <code class="literal">step</code> variable to <code class="literal">0</code> (➏).</p><p>The third block is a completely new block that animates the labels.</p><a id="pro_id00345"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>while</strong></span></span> (<span class="steelblue">labelAnimation</span>.<span class="olive">length</span> &amp;&amp; step === labelAnimation[<span class="red">0</span>].<span class="olive">minutes</span>) {
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> label = labelAnimation[<span class="red">0</span>].<span class="olive">label</span>;
    <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (step &lt; maxPathSteps || <span class="steelblue">label</span>.<span class="olive">getStatus</span>() === <span class="maroon">"shown"</span>) {
        <span class="steelblue">label</span>.<span class="olive">setStatus</span>(labelAnimation[<span class="red">0</span>].<span class="olive">status</span>);
    }
    <span class="steelblue">labelAnimation</span>.<span class="olive">shift</span>();
}</pre><p>This block looks at the first element in the <code class="literal">labelAnimation</code> array, if one exists. If the time value for that element (its <code class="literal">minutes</code> property) is the same as the animation step, we check to see if we need to process it. We always process label animations when we’re still adding the paths. If the paths are complete, though, we process animations only for labels that are already shown. Once we’re finished with the first element in <code class="literal">labelAnimation</code>, we remove it from the array (using the <code class="literal">shift()</code> method) <a id="iddle1589" class="indexterm"/><a id="iddle1722" class="indexterm"/>and check again. We must keep checking in case multiple label animation actions are scheduled at the same time.</p><p>The preceding code explains a couple of things about our label animation preparation. First, because we sorted the label animation, we only need to look at the first element in that array. That’s much more efficient than searching through the entire array. Secondly, because we’re working with a copy of the label animation array instead of the original, it’s safe to remove elements once we finish processing them.</p><p>Now that we’ve handled all the label animations, we can return to the polyline paths. As long as there are still paths to animate, we add them to the map as before.</p><a id="pro_id00346"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>if</strong></span></span> (step &lt; maxPathSteps) {
    <span class="steelblue">routeAnimations</span>.<span class="olive">forEach</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(animation) {
        <span class="steelblue">map</span>.<span class="olive">addLayer</span>(animation[step]);
    });
}</pre><p>The final code block in our animation step function is the same as before. We return an indication of whether the animation is complete.</p><a id="pro_id00347"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>return</strong></span></span> ++step === maxSteps;</pre><p>There’s one more improvement we can make to the animation, in this case with a judicious bit of CSS. Because we use the <code class="literal">opacity</code> property to change the status of the labels, we can define a CSS transition for that property that will make any changes less abrupt.</p><a id="pro_id00348"/><pre class="programlisting"><span class="red">.leaflet-label</span> <span class="steelblue"><span class="strong"><strong>{</strong></span></span>
   <span class="steelblue"><span class="strong"><strong>-webkit-transition:</strong></span></span> opacity <span class="dodgerblue">.5s</span> ease-in-out<span class="steelblue"><span class="strong"><strong>;</strong></span></span>
      <span class="steelblue"><span class="strong"><strong>-moz-transition:</strong></span></span> opacity <span class="dodgerblue">.5s</span> ease-in-out<span class="steelblue"><span class="strong"><strong>;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>-ms-transition:</strong></span></span> opacity <span class="dodgerblue">.5s</span> ease-in-out<span class="steelblue"><span class="strong"><strong>;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>-o-transition:</strong></span></span> opacity <span class="dodgerblue">.5s</span> ease-in-out<span class="steelblue"><span class="strong"><strong>;</strong></span></span>
           <span class="steelblue"><span class="strong"><strong>transition:</strong></span></span> opacity <span class="dodgerblue">.5s</span> ease-in-out<span class="steelblue"><span class="strong"><strong>;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>}</strong></span></span></pre><p>To accommodate all popular browsers, we use appropriate vendor prefixes, but the effect of the rule is consistent. Whenever the browser changes the opacity of elements within a <code class="literal">leaflet-label</code> class, it will ease the transition in and out over a 500-millisecond period. This transition prevents the label animations from distracting users too much from the path animation that is the visualization’s main effect.</p></div><div class="sect2" title="Step 11: Add a Title"><div class="titlepage"><div><div><h3 class="title" id="step_11_add_a_title">Step 11: Add a Title</h3></div></div></div><p><a id="iddle1576" class="indexterm"/><a id="iddle1587" class="indexterm"/><a id="iddle1637" class="indexterm"/>To complete the visualization, all we need is a title and a bit of explanation. We can build the title as a Leaflet control, much as we did for the animation control. The code to do this is quite straightforward.</p><a id="pro_id00349"/><pre class="programlisting"><span class="steelblue">L</span>.<span class="steelblue">Control</span>.<span class="olive">Title</span> = <span class="steelblue">L</span>.<span class="steelblue">Control</span>.<span class="olive">extend</span>({
     <span class="dodgerblue">options</span>: {
➊       <span class="dodgerblue">position</span>: <span class="maroon">"topleft"</span>
     },

➋    <span class="dodgerblue">initialize</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> (title, options) {
           <span class="steelblue">L</span>.<span class="olive">setOptions</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>, options);
           <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">_title</span> = title;
     },

     <span class="dodgerblue">onAdd</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> (map) {
         <span class="steelblue"><span class="strong"><strong>var</strong></span></span> container = <span class="steelblue">L</span>.<span class="steelblue">DomUtil</span>.<span class="olive">create</span>(<span class="maroon">"div"</span>, <span class="maroon">"leaflet-control-title"</span>);
➌       <span class="steelblue">container</span>.<span class="olive">innerHTML</span> = <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">_title</span>;
         <span class="steelblue"><span class="strong"><strong>return</strong></span></span> container;
     }
 });

 <span class="steelblue">L</span>.<span class="steelblue">control</span>.<span class="olive">title</span> = <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(title, options) {
     <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">L</span>.<span class="steelblue">Control</span>.<span class="olive">Title</span>(title, options);
 };</pre><p>We provide a default position in the top left of the map (➊) and accept a title string as an initialization parameter (➋). At ➌, we make it so that title string becomes the <code class="literal">innerHTML</code> of the control when we add it to the map.</p><p>Now we can use the following code to create a title object with our desired content and immediately add it to the map. Here’s a simple implementation; <a class="xref" href="ch06.html#maps_built_in_the_browser_with_a_map_lib" title="Figure 6-13. Maps built in the browser with a map library can use interactivity to build interest.">Figure 6-13</a> includes some extra information.</p><a id="pro_id00350"/><pre class="programlisting"><span class="steelblue">L</span>.<span class="steelblue">control</span>.<span class="olive">title</span>(<span class="maroon">"Geography as a Competitive Advantage"</span>).<span class="olive">addTo</span>(map);</pre><p>To set the title’s appearance, we can define CSS rules for children of the <code class="literal">leaflet-control-title</code> class.</p><p>At this point, we have the interactive visualization of the two train routes in <a class="xref" href="ch06.html#maps_built_in_the_browser_with_a_map_lib" title="Figure 6-13. Maps built in the browser with a map library can use interactivity to build interest.">Figure 6-13</a>. Users can clearly see that the Southerner has a quicker route from Washington to Atlanta.</p><div class="figure"><a id="maps_built_in_the_browser_with_a_map_lib"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00097"/><img src="figs/web/06fig13.png.jpg" alt="Maps built in the browser with a map library can use interactivity to build interest."/></div></div><div class="figure-title">Figure 6-13. Maps built in the browser with a map library can use interactivity to build interest.</div></div></div></div><div class="sect1" title="Summing Up"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="summing_up-id00028">Summing Up</h2></div></div></div><p>In this chapter, we’ve looked at several visualizations based on maps. In the first two examples, geographic regions were the main subjects of the visualization, and we built choropleth maps to compare and contrast those regions. Map fonts are quick and convenient, but only if they’re available for the regions the visualization needs. Although it usually takes more effort, we have far more control over the map regions if we use SVGs to create our own custom maps. Unlike other image formats, SVG can be easily manipulated in a web page with just CSS and JavaScript. This chapter also looked at examples based on traditional mapping libraries. Mapping libraries are especially convenient when your data sets include latitude and longitude values, as the libraries take care of the complicated mathematics required to position those points on a two-dimensional projection. As we saw, some libraries are relatively simple yet perfectly capable of mapping a data set. Full-featured libraries such as Leaflet offer much more power and customization, and we relied on that extensibility for a custom, animated map.</p></div></section></body></html>