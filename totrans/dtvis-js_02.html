<html><head></head><body><section class="chapter" title="Chapter&#xA0;2.&#xA0;Making Charts Interactive" epub:type="chapter" id="making_charts_interactive"><div class="titlepage"><div><div><h2 class="title">Chapter 2. Making Charts Interactive</h2></div></div></div><p><a id="iddle1495" class="indexterm"/>In <a class="xref" href="ch01.html" title="Chapter 1. Graphing Data">Chapter 1</a> we saw how to create a wide variety of simple, static charts. In many cases such charts are the ideal visualization, but they don’t take advantage of an important characteristic of the Web—interactivity. Sometimes you want to do more than just present data to your users; you want to give them a chance to explore the data, to focus on the elements they find particularly interesting, or to consider alternative <a id="iddle1504" class="indexterm"/>scenarios. In those cases we can take advantage of the Web as a medium by adding interactivity to our visualizations.</p><p>Because they’re designed for the Web, virtually all of the libraries and toolkits we examine in this book include support for interactivity. That’s certainly true of the Flotr2 library used in <a class="xref" href="ch01.html" title="Chapter 1. Graphing Data">Chapter 1</a>. But let’s take the opportunity to explore an alternative. In this chapter, we’ll use the <span class="emphasis"><em>Flot library</em></span> (<span class="emphasis"><em><a class="ulink" href="http://www.flotcharts.org/" target="_top">http://www.flotcharts.org/</a></em></span>), which is based on jQuery and features exceptionally strong support for interactive and real-time charts.</p><p>For this chapter, we’re also going to stick with a single data source: the gross domestic product (GDP) for countries worldwide. This data is publicly available from the <span class="emphasis"><em>World Bank</em></span> (<span class="emphasis"><em><a class="ulink" href="http://data.worldbank.org/" target="_top">http://data.worldbank.org/</a></em></span>). It may not seem like the most exciting data to work with, but effective visualizations can bring even the most mundane data alive. Here’s what you’ll learn:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>How to let users select the content for a chart</p></li><li class="listitem"><p>How to let users zoom into a chart to see more details</p></li><li class="listitem"><p>How to make a chart respond to user mouse movements</p></li><li class="listitem"><p>How to dynamically get data for a chart using an AJAX service</p></li></ul></div><div class="sect1" title="Selecting Chart Content"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="selecting_chart_content">Selecting Chart Content</h2></div></div></div><p>If you’re presenting data to a large audience on the Web, you may find that different users are especially interested in different aspects of your data. With global GDP data, for example, we might expect that individual users would be most interested in the data for their own region of the world. If we can anticipate inquiries like this from the user, we can construct our visualization to answer them.</p><p>In this example, we’re targeting a worldwide audience, and we want to show data for all regions. To accommodate individual users, however, we can make the regions selectable; that is, users will be able to show or hide the data from each region. If some users don’t care about data for particular regions, they can simply choose not to show it.</p><p>Interactive visualizations usually require more thought than simple, static charts. Not only must the original presentation of data be effective, but the way the user controls the presentation <span class="emphasis"><em>and</em></span> the way the presentation responds must be effective as well. It usually helps to consider each of those requirements explicitly.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Make sure the initial, static presentation shows the data effectively.</p></li><li class="listitem"><p>Add any user controls to the page and ensure they make sense for the visualization.</p></li><li class="listitem"><p>Add the code that makes the controls work.</p></li></ol></div><p>We’ll tackle each of these phases in the following example.</p><div class="sect2" title="Step 1: Include the Required JavaScript Libraries"><div class="titlepage"><div><div><h3 class="title" id="step_1_include_the_required_javascript_l">Step 1: Include the Required JavaScript Libraries</h3></div></div></div><p><a id="iddle1117" class="indexterm"/><a id="iddle1146" class="indexterm"/><a id="iddle1163" class="indexterm"/><a id="iddle1168" class="indexterm"/><a id="iddle1316" class="indexterm"/><a id="iddle1352" class="indexterm"/><a id="iddle1467" class="indexterm"/><a id="iddle1510" class="indexterm"/><a id="iddle1542" class="indexterm"/><a id="iddle1544" class="indexterm"/><a id="iddle1873" class="indexterm"/>Since we’re using the Flot library to create the chart, we need to include that library in our web pages. And since Flot requires jQuery, we’ll include that in our pages as well. Fortunately, both jQuery and Flot are popular libraries, and they are available on public <span class="emphasis"><em>content distribution networks (CDNs)</em></span>. That gives you the option of loading both from a CDN instead of hosting them on your own site. There are several advantages to relying on a CDN:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: none"><p title="Better performance"><span class="title"><strong><span class="strong"><strong>Better performance</strong></span></strong></span>. If the user has previously visited other websites that retrieved the libraries from the same CDN, then the libraries may already exist in the browser’s local cache. In that case the browser simply retrieves them from the cache, avoiding the delay of additional network requests. (See the second disadvantage in the next list for a different view on performance.)</p></li><li class="listitem" style="list-style-type: none"><p title="Lower cost"><span class="title"><strong><span class="strong"><strong>Lower cost</strong></span></strong></span>. One way or another, the cost of your site is likely based on how much bandwidth you use. If your users are able to retrieve libraries from a CDN, then the bandwidth required to service their requests won’t count against your site.</p><p>Of course there are also disadvantages to CDNs as well.</p></li><li class="listitem" style="list-style-type: none"><p title="Loss of control"><span class="title"><strong><span class="strong"><strong>Loss of control</strong></span></strong></span>. If the CDN goes down, then the libraries your page needs won’t be available. That puts your site’s functionality at the mercy of the CDN. There are approaches to mitigate such failures. You can try to retrieve from the CDN and fall back to your own hosted copy if the CDN request fails. Implementing such a fallback is tricky, though, and it could introduce errors in your code.</p></li><li class="listitem" style="list-style-type: none"><p title="Lack of flexibility"><span class="title"><strong><span class="strong"><strong>Lack of flexibility</strong></span></strong></span>. With CDN-hosted libraries, you’re generally stuck with a limited set of options. For example, in this case we need both the jQuery and Flot libraries. CDNs provide those libraries only as distinct files, so to get both we’ll need two network requests. If we host the libraries ourselves, on the other hand, we can combine them into a single file and cut the required number of requests in half. For high-latency networks (such as mobile networks), the number of requests may be the biggest factor in determining the performance of your web page.</p></li></ul></div><p>There isn’t a clear-cut answer for all cases, so you’ll have to weigh the options against your own requirements. For this example (and the others in this chapter), we’ll use the CloudFlare CDN.</p><p>In addition to the jQuery library, Flot relies on the HTML canvas feature. To support IE8 and earlier, we’ll include the excanvas.min.js library in our pages and make sure that only IE8 and earlier will load it, just like we did for our bar chart in <a class="xref" href="ch01.html" title="Chapter 1. Graphing Data">Chapter 1</a>. Also, since excanvas isn’t available on a public CDN, we’ll have to host it on our own server. Here’s the skeleton to start with:</p><a id="pro_id00048"/><pre class="programlisting"><span class="dodgerblue">&lt;!DOCTYPE</span> html<span class="dodgerblue">&gt;</span>
<span class="steelblue"><span class="strong"><strong>&lt;html</strong></span></span> <span class="steelblue">lang=</span><span class="maroon">"en"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;head&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;meta</strong></span></span> <span class="steelblue">charset=</span><span class="maroon">"utf-8"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;title&gt;&lt;/title&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;/head&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;body&gt;</strong></span></span>
    <span class="indianred"><span class="emphasis"><em>&lt;!-- Content goes here --&gt;</em></span></span>
    <span class="indianred"><span class="emphasis"><em>&lt;!--[if lt IE 9]&gt;&lt;script src="js/excanvas.min.js"&gt;&lt;/script&gt;&lt;![endif]--&gt;</em></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"//cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;/script&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"//cdnjs.cloudflare.com/ajax/libs/flot/0.7/jquery.flot.min.js"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;/script&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;/body&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/html&gt;</strong></span></span></pre><p><a id="iddle1508" class="indexterm"/><a id="iddle1511" class="indexterm"/><a id="iddle1871" class="indexterm"/><a id="iddle1874" class="indexterm"/>As you can see, we’re including the JavaScript libraries at the end of the document. This approach lets the browser load the document’s entire HTML markup and begin laying out the page while it waits for the server to provide the JavaScript libraries.</p></div><div class="sect2" title="Step 2: Set Aside a &lt;div&gt; Element to Hold the Chart"><div class="titlepage"><div><div><h3 class="title" id="step_2_set_aside_a_less_thandivg-id00008">Step 2: Set Aside a &lt;div&gt; Element to Hold the Chart</h3></div></div></div><p>Within our document, we need to create a <code class="literal">&lt;div&gt;</code> element to contain the chart we’ll construct. This element must have an explicit height and width, or Flot won’t be able to construct the chart. We can indicate the element’s size in a CSS style sheet, or we can place it directly on the element itself. Here’s how the document might look with the latter approach.</p><a id="pro_id00049"/><pre class="programlisting">   <span class="dodgerblue">&lt;!DOCTYPE</span> html<span class="dodgerblue">&gt;</span>
   <span class="steelblue"><span class="strong"><strong>&lt;html</strong></span></span> <span class="steelblue">lang=</span><span class="maroon">"en"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;head&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;meta</strong></span></span> <span class="steelblue">charset=</span><span class="maroon">"utf-8"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;title&gt;&lt;/title&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;/head&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;body&gt;</strong></span></span>
➊     <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"chart"</span> <span class="steelblue">style=</span><span class="maroon">"width:600px;height:400px;"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
       <span class="indianred"><span class="emphasis"><em>&lt;!--[if lt IE 9]&gt;&lt;script src="js/excanvas.min.js"&gt;&lt;/script&gt;&lt;![endif]--&gt;</em></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"//cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;/script&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"//cdnjs.cloudflare.com/ajax/libs/flot/0.7/jquery.flot.min.js"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;/script&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;/body&gt;</strong></span></span>
   <span class="steelblue"><span class="strong"><strong>&lt;/html&gt;</strong></span></span></pre><p>Note at ➊ that we’ve given the &lt;<code class="literal">div&gt;</code> an explicit <code class="literal">id</code> so we can reference it later.</p></div><div class="sect2" title="Step 3: Prepare the Data"><div class="titlepage"><div><div><h3 class="title" id="step_3_prepare_the_data">Step 3: Prepare the Data</h3></div></div></div><p>In later examples we’ll see how to get the data directly from the World Bank’s web service, but for this example, let’s keep things simple and assume we have the data already downloaded and formatted for JavaScript. (For brevity, only excerpts are shown here. The book’s source code includes the full data set.)</p><a id="pro_id00050"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> eas = [[<span class="red">1960</span>,<span class="red">0.1558</span>],[<span class="red">1961</span>,<span class="red">0.1547</span>],[<span class="red">1962</span>,<span class="red">0.1574</span>], <span class="indianred"><span class="emphasis"><em>// Data continues...</em></span></span>
<span class="steelblue"><span class="strong"><strong>var</strong></span></span> ecs = [[<span class="red">1960</span>,<span class="red">0.4421</span>],[<span class="red">1961</span>,<span class="red">0.4706</span>],[<span class="red">1962</span>,<span class="red">0.5145</span>], <span class="indianred"><span class="emphasis"><em>// Data continues...</em></span></span>
<span class="steelblue"><span class="strong"><strong>var</strong></span></span> lcn = [[<span class="red">1960</span>,<span class="red">0.0811</span>],[<span class="red">1961</span>,<span class="red">0.0860</span>],[<span class="red">1962</span>,<span class="red">0.0990</span>], <span class="indianred"><span class="emphasis"><em>// Data continues...</em></span></span>
<span class="steelblue"><span class="strong"><strong>var</strong></span></span> mea = [[<span class="red">1968</span>,<span class="red">0.0383</span>],[<span class="red">1969</span>,<span class="red">0.0426</span>],[<span class="red">1970</span>,<span class="red">0.0471</span>], <span class="indianred"><span class="emphasis"><em>// Data continues...</em></span></span>
<span class="steelblue"><span class="strong"><strong>var</strong></span></span> sas = [[<span class="red">1960</span>,<span class="red">0.0478</span>],[<span class="red">1961</span>,<span class="red">0.0383</span>],[<span class="red">1962</span>,<span class="red">0.0389</span>], <span class="indianred"><span class="emphasis"><em>// Data continues...</em></span></span>
<span class="steelblue"><span class="strong"><strong>var</strong></span></span> ssf = [[<span class="red">1960</span>,<span class="red">0.0297</span>],[<span class="red">1961</span>,<span class="red">0.0308</span>],[<span class="red">1962</span>,<span class="red">0.0334</span>], <span class="indianred"><span class="emphasis"><em>// Data continues...</em></span></span></pre><p><a id="iddle1353" class="indexterm"/><a id="iddle1509" class="indexterm"/><a id="iddle1760" class="indexterm"/><a id="iddle1872" class="indexterm"/>This data includes the historical GDP (in current US dollars) for major regions of the world, from 1960 to 2011. The names of the variables are the World Bank region codes.</p><div class="note" title="Note"><h3 class="title"><a id="ch02note01"/>Note</h3><p><span class="strong"><strong>At the time of this writing, World Bank data for North America was temporarily unavailable.</strong></span></p></div></div><div class="sect2" title="Step 4: Draw the Chart"><div class="titlepage"><div><div><h3 class="title" id="step_4_draw_the_chart-id00009">Step 4: Draw the Chart</h3></div></div></div><p>Before we add any interactivity, let’s check out the chart itself. The Flot library provides a simple function call to create a static graph. We call the jQuery extension <code class="literal">plot</code> and pass it two parameters. The first parameter identifies the HTML element that should contain the chart, and the second parameter provides the data as an array of data sets. In this case, we pass in an array with the series we defined earlier for each region.</p><a id="pro_id00051"/><pre class="programlisting"><span class="olive">$</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
    <span class="steelblue">$</span>.<span class="olive">plot</span>(<span class="olive">$</span>(<span class="maroon">"#chart"</span>), [ eas, ecs, lcn, mea, sas, ssf ]);
});</pre><p><a class="xref" href="ch02.html#flot_can_show_a_static_line_chart_well_w" title="Figure 2-1. Flot can show a static line chart well with just default options.">Figure 2-1</a> shows the resulting chart.</p><div class="figure"><a id="flot_can_show_a_static_line_chart_well_w"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00027"/><img src="figs/web/02fig01.png.jpg" alt="Flot can show a static line chart well with just default options."/></div></div><div class="figure-title">Figure 2-1. Flot can show a static line chart well with just default options.</div></div><p><a id="iddle1121" class="indexterm"/><a id="iddle1492" class="indexterm"/><a id="iddle1554" class="indexterm"/>It looks like we’ve done a good job of capturing and presenting the data statically, so we can move on to the next phase.</p></div><div class="sect2" title="Step 5: Add the Controls"><div class="titlepage"><div><div><h3 class="title" id="step_5_add_the_controls">Step 5: Add the Controls</h3></div></div></div><p>Now that we have a chart we’re happy with, we can add the HTML controls to interact with it. For this example, our goal is fairly simple: our users should be able to pick which regions appear on the graph. We’ll give them that option with a set of checkboxes, one for each region. Here’s the markup to include the checkboxes.</p><a id="pro_id00052"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;label&gt;&lt;input</strong></span></span> <span class="steelblue">type=</span><span class="maroon">"checkbox"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span> East Asia &amp; Pacific<span class="steelblue"><span class="strong"><strong>&lt;/label&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;label&gt;&lt;input</strong></span></span> <span class="steelblue">type=</span><span class="maroon">"checkbox"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span> Europe &amp; Central Asia<span class="steelblue"><span class="strong"><strong>&lt;/label&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;label&gt;&lt;input</strong></span></span> <span class="steelblue">type=</span><span class="maroon">"checkbox"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span> Latin America &amp; Caribbean<span class="steelblue"><span class="strong"><strong>&lt;/label&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;label&gt;&lt;input</strong></span></span> <span class="steelblue">type=</span><span class="maroon">"checkbox"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span> Middle East &amp; North Africa<span class="steelblue"><span class="strong"><strong>&lt;/label&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;label&gt;&lt;input</strong></span></span> <span class="steelblue">type=</span><span class="maroon">"checkbox"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span> South Asia<span class="steelblue"><span class="strong"><strong>&lt;/label&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;label&gt;&lt;input</strong></span></span> <span class="steelblue">type=</span><span class="maroon">"checkbox"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span> Sub-Saharan Africa<span class="steelblue"><span class="strong"><strong>&lt;/label&gt;</strong></span></span></pre><p>You may be surprised to see that we’ve placed the <code class="literal">&lt;input&gt;</code> controls inside the <code class="literal">&lt;label&gt;</code> elements. Although it looks a little unusual, that’s almost always the best approach. When we do that, the browser interprets clicks on the label as clicks on the control, whereas if we separate the labels from the controls, it forces the user to click on the tiny checkbox itself to have any effect.</p><p>On our web page, we’d like to place the controls on the right side of the chart. We can do that by creating a containing <code class="literal">&lt;div&gt;</code> and making the chart and the controls float (left) within it. While we’re experimenting with the layout, it’s easiest to simply add the styling directly in the HTML markup. In a production implementation, you might want to define the styles in an external style sheet.</p><a id="pro_id00053"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"visualization"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"chart"</span> <span class="steelblue">style=</span><span class="maroon">"width:500px;height:333px;float:left"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"controls"</span> <span class="steelblue">style=</span><span class="maroon">"float:left;"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;label&gt;&lt;input</strong></span></span> <span class="steelblue">type=</span><span class="maroon">"checkbox"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span> East Asia &amp; Pacific<span class="steelblue"><span class="strong"><strong>&lt;/label&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;label&gt;&lt;input</strong></span></span> <span class="steelblue">type=</span><span class="maroon">"checkbox"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span> Europe &amp; Central Asia<span class="steelblue"><span class="strong"><strong>&lt;/label&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;label&gt;&lt;input</strong></span></span> <span class="steelblue">type=</span><span class="maroon">"checkbox"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span> Latin America &amp; Caribbean<span class="steelblue"><span class="strong"><strong>&lt;/label&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;label&gt;&lt;input</strong></span></span> <span class="steelblue">type=</span><span class="maroon">"checkbox"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span> Middle East &amp; North Africa<span class="steelblue"><span class="strong"><strong>&lt;/label&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;label&gt;&lt;input</strong></span></span> <span class="steelblue">type=</span><span class="maroon">"checkbox"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span> South Asia<span class="steelblue"><span class="strong"><strong>&lt;/label&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;label&gt;&lt;input</strong></span></span> <span class="steelblue">type=</span><span class="maroon">"checkbox"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span> Sub-Saharan Africa<span class="steelblue"><span class="strong"><strong>&lt;/label&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;/div&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/div&gt;</strong></span></span></pre><p>We should also add a title and instructions and make all the <code class="literal">&lt;input&gt;</code> checkboxes default to <code class="literal">checked</code>. Let’s see the chart now, to make sure the formatting looks okay (<a class="xref" href="ch02.html#standard_html_can_create_controls_for_ch" title="Figure 2-2. Standard HTML can create controls for chart interaction.">Figure 2-2</a>).</p><div class="figure"><a id="standard_html_can_create_controls_for_ch"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00028"/><img src="figs/web/02fig02.png.jpg" alt="Standard HTML can create controls for chart interaction."/></div></div><div class="figure-title">Figure 2-2. Standard HTML can create controls for chart interaction.</div></div><p><a id="iddle1356" class="indexterm"/><a id="iddle1493" class="indexterm"/><a id="iddle1496" class="indexterm"/><a id="iddle1594" class="indexterm"/>Now we see how the controls look in relation to the chart in <a class="xref" href="ch02.html#standard_html_can_create_controls_for_ch" title="Figure 2-2. Standard HTML can create controls for chart interaction.">Figure 2-2</a>, and we can verify that they make sense both for the data and for the interaction model. Our visualization lacks a critical piece of information, though: it doesn’t identify which line corresponds to which region. For a static visualization, we could simply use the Flot library to add a legend to the chart, but that approach isn’t ideal here. You can see the problem in <a class="xref" href="ch02.html#flot_libraryapostrophes_standard_legend" title="Figure 2-3. The Flot library’s standard legend doesn’t match the chart styles well.">Figure 2-3</a>, as the legend looks confusingly like the interaction controls.</p><div class="figure"><a id="flot_libraryapostrophes_standard_legend"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00029"/><img src="figs/web/02fig03.png.jpg" alt="The Flot library’s standard legend doesn’t match the chart styles well."/></div></div><div class="figure-title">Figure 2-3. The Flot library’s standard legend doesn’t match the chart styles well.</div></div><p>We can eliminate the visual confusion by combining the legend and the interaction controls. The checkbox controls will serve as a legend if we add color boxes that identify the chart lines.</p><p><a id="iddle1273" class="indexterm"/><a id="iddle1306" class="indexterm"/><a id="iddle1506" class="indexterm"/><a id="iddle1869" class="indexterm"/><a id="iddle1913" class="indexterm"/>We can add the colored boxes using an HTML <code class="literal">&lt;span&gt;</code> tag and a bit of styling. Here is the markup for one such checkbox with the styles inline. (Full web page implementations might be better organized by having most of the styles defined in an external style sheet.)</p><a id="pro_id00054"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;label</strong></span></span> <span class="steelblue">class=</span><span class="maroon">"checkbox"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;input</strong></span></span> <span class="steelblue">type=</span><span class="maroon">"checkbox"</span> <span class="steelblue">checked</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;span</strong></span></span> <span class="steelblue">style=</span><span class="maroon">"background-color:rgb(237,194,64);height:0.9em;</span>
                 <span class="maroon">width:0.9em;margin-right:0.25em;display:inline-block;"</span><span class="steelblue"><span class="strong"><strong>/&gt;</strong></span></span>
    East Asia &amp; Pacific
<span class="steelblue"><span class="strong"><strong>&lt;/label&gt;</strong></span></span></pre><p>In addition to the background color, the <code class="literal">&lt;span&gt;</code> needs an explicit size, and we use an <code class="literal">inline-block</code> value for the <code class="literal">display</code> property to force the browser to show the span even though it has no content. As you can also see, we’re using <code class="literal">em</code>s instead of pixels to define the size of the block. Since <code class="literal">ems</code> scale automatically with the text size, the color blocks will match the text label size even if users zoom in or out on the page.</p><p>A quick check in the browser can verify that the various elements combine effectively (<a class="xref" href="ch02.html#interaction_controls_can_also_serve_as_c" title="Figure 2-4. Interaction controls can also serve as chart elements such as legends.">Figure 2-4</a>).</p><div class="figure"><a id="interaction_controls_can_also_serve_as_c"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00030"/><img src="figs/web/02fig04.png.jpg" alt="Interaction controls can also serve as chart elements such as legends."/></div></div><div class="figure-title">Figure 2-4. Interaction controls can also serve as chart elements such as legends.</div></div><p>That looks pretty good, so now we can move on to the interaction itself.</p></div><div class="sect2" title="Step 6: Define the Data Structure for the Interaction"><div class="titlepage"><div><div><h3 class="title" id="step_6_define_the_data_structure_for_the">Step 6: Define the Data Structure for the Interaction</h3></div></div></div><p>Now that the general layout looks good, we can turn back to JavaScript. First we need to expand our data to track the interaction state. Instead of storing the data as simple arrays of values, we’ll use an array of objects. Each object will include the corresponding data values along with other properties.</p><a id="pro_id00055"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> source = [
    { <span class="dodgerblue">data</span>: eas, <span class="dodgerblue">show</span>: <span class="steelblue"><span class="strong"><strong>true</strong></span></span>, <span class="dodgerblue">color</span>: <span class="maroon">"#FE4C4C"</span>, <span class="dodgerblue">name</span>: <span class="maroon">"East Asia &amp; Pacific"</span> },
    { <span class="dodgerblue">data</span>: ecs, <span class="dodgerblue">show</span>: <span class="steelblue"><span class="strong"><strong>true</strong></span></span>, <span class="dodgerblue">color</span>: <span class="maroon">"#B6ED47"</span>, <span class="dodgerblue">name</span>: <span class="maroon">"Europe &amp; Central Asia"</span> },
    { <span class="dodgerblue">data</span>: lcn, <span class="dodgerblue">show</span>: <span class="steelblue"><span class="strong"><strong>true</strong></span></span>, <span class="dodgerblue">color</span>: <span class="maroon">"#2D9999"</span>,
      <span class="dodgerblue">name</span>: <span class="maroon">"Latin America &amp; Caribbean"</span> },
    { <span class="dodgerblue">data</span>: mea, <span class="dodgerblue">show</span>: <span class="steelblue"><span class="strong"><strong>true</strong></span></span>, <span class="dodgerblue">color</span>: <span class="maroon">"#A50000"</span>,
      <span class="dodgerblue">name</span>: <span class="maroon">"Middle East &amp; North Africa"</span> },
    { <span class="dodgerblue">data</span>: sas, <span class="dodgerblue">show</span>: <span class="steelblue"><span class="strong"><strong>true</strong></span></span>, <span class="dodgerblue">color</span>: <span class="maroon">"#679A00"</span>, <span class="dodgerblue">name</span>: <span class="maroon">"South Asia"</span> },
    { <span class="dodgerblue">data</span>: ssf, <span class="dodgerblue">show</span>: <span class="steelblue"><span class="strong"><strong>true</strong></span></span>, <span class="dodgerblue">color</span>: <span class="maroon">"#006363"</span>, <span class="dodgerblue">name</span>: <span class="maroon">"Sub-Saharan Africa"</span> }
];</pre><p><a id="iddle1006" class="indexterm"/><a id="iddle1008" class="indexterm"/><a id="iddle1357" class="indexterm"/><a id="iddle1507" class="indexterm"/><a id="iddle1761" class="indexterm"/><a id="iddle1870" class="indexterm"/>Each object includes the data points for a region, and it also gives us a place to define additional properties, including the label for the series and other status information. One property that we want to track is whether the series should be included on the chart (using the key <code class="literal">show</code>). We also need to specify the color for each line; otherwise, the Flot library will pick the color dynamically based on how many regions are visible at the same time, and we won’t be able to match the color with the control legend.</p></div><div class="sect2" title="Step 7: Determine Chart Data Based on the Interaction State"><div class="titlepage"><div><div><h3 class="title" id="step_7_determine_chart_data_based_on_the">Step 7: Determine Chart Data Based on the Interaction State</h3></div></div></div><p>When we call <code class="literal">plot()</code> to draw the chart, we need to pass in an object containing the data series and the color for each region. The <code class="literal">source</code> array has the information we need, but it contains other information as well, which could potentially make Flot behave unexpectedly. We want to pass in a simpler object to the plot function. For example, the East Asia &amp; Pacific series would be defined this way:</p><a id="pro_id00056"/><pre class="programlisting">{
    <span class="dodgerblue">data</span>:  eas,
    <span class="dodgerblue">color</span>: <span class="maroon">"#E41A1C"</span>
}</pre><p>We also want to be sure to show the data only for regions the user has selected. That may be only a subset of the complete data set. Those two operations—transforming array elements (in this case, to simpler objects) and filtering an array to a subset—are very common requirements for visualizations. Fortunately, jQuery has two utility functions that make both operations easy: <code class="literal">$.map()</code> and <code class="literal">$.grep()</code>.</p><p>Both <code class="literal">.grep()</code> and <code class="literal">.map()</code> accept two parameters. The first parameter is an array or, more precisely, an “array-like” object. That’s either a JavaScript array or another JavaScript object that looks and acts like an array. (There is a technical distinction, but it’s not something we have to worry about here.) The second parameter is a function that operates on elements of the array one at a time. For <code class="literal">.grep()</code>, that function returns <code class="literal">true</code> or <code class="literal">false</code> to filter out elements accordingly. In the case of <code class="literal">.map()</code>, the function returns a transformed object that replaces the original element in the array. <a class="xref" href="ch02.html#jquery_library_has_utility_functions_to" title="Figure 2-5. The jQuery library has utility functions to help transform and filter data.">Figure 2-5</a> shows how these functions convert the initial data into the final data array.</p><div class="figure"><a id="jquery_library_has_utility_functions_to"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00031"/><img src="figs/web/02fig05.png.jpg" alt="The jQuery library has utility functions to help transform and filter data."/></div></div><div class="figure-title">Figure 2-5. The jQuery library has utility functions to help transform and filter data.</div></div><p><a id="iddle1889" class="indexterm"/>Taking these one at a time, here’s how to filter out irrelevant data from the response. We use <code class="literal">.grep()</code> to check the <code class="literal">show</code> property in our source data so that it returns an array with only the objects where <code class="literal">show</code> is set to <code class="literal">true</code>.</p><a id="pro_id00057"/><pre class="programlisting"><span class="steelblue">$</span>.<span class="olive">grep</span>(
    source,
    <span class="steelblue"><span class="strong"><strong>function</strong></span></span> (obj) { <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue">obj</span>.<span class="olive">show</span>; }
)</pre><p>And here’s how to transform the elements to retain only relevant properties:</p><a id="pro_id00058"/><pre class="programlisting"><span class="steelblue">$</span>.<span class="olive">map</span>(
    source,
    <span class="steelblue"><span class="strong"><strong>function</strong></span></span> (obj) { <span class="steelblue"><span class="strong"><strong>return</strong></span></span> { <span class="dodgerblue">data</span>: <span class="steelblue">obj</span>.<span class="olive">data</span>, <span class="dodgerblue">color</span>: <span class="steelblue">obj</span>.<span class="olive">color</span> }; }
)</pre><p>There’s no need to make these separate steps. We can combine them in a nice, concise expression as follows:</p><a id="pro_id00059"/><pre class="programlisting"><span class="steelblue">$</span>.<span class="olive">map</span>(
    <span class="steelblue">$</span>.<span class="olive">grep</span>(
        source,
        <span class="steelblue"><span class="strong"><strong>function</strong></span></span> (obj) { <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue">obj</span>.<span class="olive">show</span>; }
    ),
    <span class="steelblue"><span class="strong"><strong>function</strong></span></span> (obj) { <span class="steelblue"><span class="strong"><strong>return</strong></span></span> { <span class="dodgerblue">data</span>: <span class="steelblue">obj</span>.<span class="olive">data</span>, <span class="dodgerblue">color</span>: <span class="steelblue">obj</span>.<span class="olive">color</span> }; }
)</pre><p>That expression in turn provides the input data to Flot’s <code class="literal">plot()</code> function.</p></div><div class="sect2" title="Step 8: Add the Controls Using JavaScript"><div class="titlepage"><div><div><h3 class="title" id="step_8_add_the_controls_using_javascript">Step 8: Add the Controls Using JavaScript</h3></div></div></div><p><a id="iddle1179" class="indexterm"/><a id="iddle1298" class="indexterm"/><a id="iddle1494" class="indexterm"/><a id="iddle1505" class="indexterm"/><a id="iddle1619" class="indexterm"/><a id="iddle1868" class="indexterm"/><a id="iddle1914" class="indexterm"/><a id="iddle2119" class="indexterm"/>Now that our new data structure can provide the chart input, let’s use it to add the checkbox controls to the page as well. The jQuery <code class="literal">.each()</code> function is a convenient way to iterate through the array of regions. Its parameters include an array of objects and a function to execute on each object in the array. That function takes two parameters, the array index and the array object.</p><a id="pro_id00060"/><pre class="programlisting"><span class="steelblue">$</span>.<span class="olive">each</span>(source, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(idx, region) {
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> input = <span class="olive">$</span>(<span class="maroon">"&lt;input&gt;"</span>).<span class="olive">attr</span>(<span class="maroon">"type"</span>,<span class="maroon">"checkbox"</span>).<span class="olive">attr</span>(<span class="maroon">"id"</span>,<span class="maroon">"chk-"</span>+idx);
    <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (<span class="steelblue">region</span>.<span class="olive">show</span>) {
        <span class="olive">$</span>(input).<span class="olive">prop</span>(<span class="maroon">"checked"</span>,<span class="steelblue"><span class="strong"><strong>true</strong></span></span>);
    }
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> span = <span class="olive">$</span>(<span class="maroon">"&lt;span&gt;"</span>).<span class="olive">css</span>({
        <span class="maroon">"background-color"</span>: <span class="steelblue">region</span>.<span class="olive">color</span>,
        <span class="maroon">"display"</span>:          <span class="maroon">"inline-block"</span>,
        <span class="maroon">"height"</span>:           <span class="maroon">"0.9em"</span>,
        <span class="maroon">"width"</span>:            <span class="maroon">"0.9em"</span>,
        <span class="maroon">"margin-right"</span>:     <span class="maroon">"0.25em"</span>,
    });
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> label = <span class="olive">$</span>(<span class="maroon">"&lt;label&gt;"</span>).<span class="olive">append</span>(input).<span class="olive">append</span>(span).<span class="olive">append</span>(<span class="steelblue">region</span>.<span class="olive">name</span>);
    <span class="olive">$</span>(<span class="maroon">"#controls"</span>).<span class="olive">append</span>(label);
});</pre><p>Within the iteration function we do four things. First, we create the checkbox <code class="literal">&lt;input&gt;</code> control. As you can see, we’re giving each control a unique <code class="literal">id</code> attribute that combines the <code class="literal">chk-</code> prefix with the source array index. If the chart is showing that region, the control’s <code class="literal">checked</code> property is set to <code class="literal">true</code>. Next we create the <code class="literal">&lt;span&gt;</code> for the color block. We’re setting all the styles, including the region’s color, using the <code class="literal">css()</code> function. The third element we create in the function is the <code class="literal">&lt;label&gt;</code>. To that element we append the checkbox <code class="literal">&lt;input&gt;</code> control, the color box <code class="literal">&lt;span&gt;</code>, and the region’s name. Finally, we add the <code class="literal">&lt;label&gt;</code> to the document.</p><p>Notice that we don’t add the intermediate elements (such as the <code class="literal">&lt;input&gt;</code> or the <code class="literal">&lt;span&gt;</code>) directly to the document. Instead, we construct those elements using local variables. We then assemble the local variables into the final, complete <code class="literal">&lt;label&gt;</code> and add that to the document. This approach significantly improves the performance of web pages. Every time JavaScript code adds elements to the document, the web browser has to recalculate the appearance of the page. For complex pages, that can take time. By assembling the elements before adding them to the document, we’ve only forced the browser to perform that calculation once for each region. (You could further optimize performance by combining all of the regions in a local variable and adding only that single local variable to the document.)</p><p>If we combine the JavaScript to draw the chart with the JavaScript to create the controls, we need only a skeletal HTML structure.</p><a id="pro_id00061"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"visualization"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"chart"</span> <span class="steelblue">style=</span><span class="maroon">"width:500px;height:333px;float:left"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"controls"</span> <span class="steelblue">style=</span><span class="maroon">"float:left;"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;p&gt;</strong></span></span>Select Regions to Include:<span class="steelblue"><span class="strong"><strong>&lt;/p&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;/div&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/div&gt;</strong></span></span></pre><p><a id="iddle1358" class="indexterm"/><a id="iddle1472" class="indexterm"/><a id="iddle1512" class="indexterm"/><a id="iddle1762" class="indexterm"/><a id="iddle1768" class="indexterm"/><a id="iddle1769" class="indexterm"/><a id="iddle1875" class="indexterm"/><a id="iddle1890" class="indexterm"/>Our reward is the visualization in <a class="xref" href="ch02.html#setting_the_chart_options_ensures_that_t" title="Figure 2-6. Setting the chart options ensures that the data matches the legend.">Figure 2-6</a>—the same one as shown in <a class="xref" href="ch02.html#interaction_controls_can_also_serve_as_c" title="Figure 2-4. Interaction controls can also serve as chart elements such as legends.">Figure 2-4</a>—but this time we’ve created it dynamically using JavaScript.</p><div class="figure"><a id="setting_the_chart_options_ensures_that_t"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00032"/><img src="figs/web/02fig06.png.jpg" alt="Setting the chart options ensures that the data matches the legend."/></div></div><div class="figure-title">Figure 2-6. Setting the chart options ensures that the data matches the legend.</div></div></div><div class="sect2" title="Step 9: Respond to the Interaction Controls"><div class="titlepage"><div><div><h3 class="title" id="step_9_respond_to_the_interaction_contro">Step 9: Respond to the Interaction Controls</h3></div></div></div><p>We still haven’t added any interactivity, of course, but we’re almost there. Our code just needs to watch for clicks on the controls and redraw the chart appropriately. Since we’ve conveniently given each checkbox an <code class="literal">id</code> attribute that begins with <code class="literal">chk-</code>, it’s easy to watch for the right events.</p><a id="pro_id00062"/><pre class="programlisting"><span class="olive">$</span>(<span class="maroon">"input[id^='chk-']"</span>).<span class="olive">click</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev) {
    <span class="indianred"><span class="emphasis"><em>// Handle the click</em></span></span>
})</pre><p>When the code sees a click, it should determine which checkbox was clicked, toggle the <code class="literal">show</code> property of the data source, and redraw the chart. We can find the specific region by skipping past the four-character <code class="literal">chk-</code> prefix of the event target’s <code class="literal">id</code> attribute.</p><a id="pro_id00063"/><pre class="programlisting">idx = <span class="steelblue">ev</span>.<span class="steelblue">target</span>.<span class="steelblue">id</span>.<span class="olive">substr</span>(<span class="red">4</span>);
source[idx].<span class="olive">show</span> = !source[idx].<span class="olive">show</span></pre><p>Redrawing the chart requires a couple of calls to the chart object that <code class="literal">plot()</code> returns. We reset the data and then tell the library to redraw the chart.</p><a id="pro_id00064"/><pre class="programlisting"><span class="steelblue">plotObj</span>.<span class="olive">setData</span>(
    <span class="steelblue">$</span>.<span class="olive">map</span>(
        <span class="steelblue">$</span>.<span class="olive">grep</span>(source, <span class="steelblue"><span class="strong"><strong>function</strong></span></span> (obj) { <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue">obj</span>.<span class="olive">show</span>; }),
        <span class="steelblue"><span class="strong"><strong>function</strong></span></span> (obj) { <span class="steelblue"><span class="strong"><strong>return</strong></span></span> { <span class="dodgerblue">data</span>: <span class="steelblue">obj</span>.<span class="olive">data</span>, <span class="dodgerblue">color</span>: <span class="steelblue">obj</span>.<span class="olive">color</span> }; }
    )
);
<span class="steelblue">plotObj</span>.<span class="olive">draw</span>();</pre><p><a id="iddle1518" class="indexterm"/><a id="iddle2194" class="indexterm"/>And that’s it. We finally have a fully interactive visualization of regional gross domestic product, as shown in <a class="xref" href="ch02.html#interactive_chart_gives_users_control_ov" title="Figure 2-7. An interactive chart gives users control over the visualization.">Figure 2-7</a>.</p><div class="figure"><a id="interactive_chart_gives_users_control_ov"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00033"/><img src="figs/web/02fig07.png.jpg" alt="An interactive chart gives users control over the visualization."/></div></div><div class="figure-title">Figure 2-7. An interactive chart gives users control over the visualization.</div></div><p>The visualization we’ve created engages users more effectively than a static chart. They can still see the overall picture, but the interaction controls let them focus on aspects of the data that are especially important or interesting to them.</p><p>There is still a potential problem with this implementation. Two data sets (Europe and East Asia &amp; Pacific) dominate the chart. When users deselect those regions, the remaining data is confined to the very bottom of the chart, and much of the chart’s area is wasted. You could address this by rescaling the chart every time you draw it. To do this, you would call <code class="literal">plotObj.setupGrid()</code> before calling <code class="literal">plotObj.draw()</code>. On the other hand, users may find this constant rescaling disconcerting, because it changes the whole chart, not just the region they selected. In the next example, we’ll address this type of problem by giving users total control over the scale of both axes.</p></div></div><div class="sect1" title="Zooming In on Charts"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="zooming_in_on_charts">Zooming In on Charts</h2></div></div></div><p>So far, we’ve given users some interaction with the visualization by letting them choose which data sets appear. In many cases, however, you’ll want to give them even more control, especially if you’re showing a lot of data and details are hard to <a id="iddle1364" class="indexterm"/><a id="iddle1365" class="indexterm"/><a id="iddle1519" class="indexterm"/><a id="iddle1522" class="indexterm"/><a id="iddle1695" class="indexterm"/><a id="iddle1877" class="indexterm"/><a id="iddle2195" class="indexterm"/><a id="iddle2198" class="indexterm"/>discern. If users can’t see the details they need, our visualization has failed. Fortunately, we can avoid this problem by giving users a chance to inspect fine details within the data. One way to do that is to let users zoom in on the chart.</p><p>Although the Flot library in its most basic form does not support zooming, there are at least two library extensions that add this feature: the <span class="emphasis"><em>selection</em></span> plug-in and the <span class="emphasis"><em>navigation</em></span> plug-in. The navigation plug-in acts a bit like Google Maps. It adds a control that looks like a compass to one corner of the plot and gives users arrows and buttons to pan or zoom the display. This interface is not especially effective for charts, however. Users cannot control exactly how much the chart pans or zooms, which makes it difficult for them to anticipate the effect of an action.</p><p>The selection plug-in provides a much better interface. Users simply drag their mouse across the area of the chart they want to zoom in on. The effect of this gesture is more intuitive, and users can be as precise as they like in those actions. The plug-in does have one significant downside, however: it doesn’t support touch interfaces.</p><p>For this example, we’ll walk through the steps required to support zooming with the selection plug-in. Of course, the best approach for your own website and visualizations will vary from case to case.</p><div class="sect2" title="Step 1: Prepare the Page"><div class="titlepage"><div><div><h3 class="title" id="step_1_prepare_the_page">Step 1: Prepare the Page</h3></div></div></div><p>Because we’re sticking with the same data, most of the preparation is identical to the last example.</p><a id="pro_id00065"/><pre class="programlisting">   <span class="dodgerblue">&lt;!DOCTYPE</span> html<span class="dodgerblue">&gt;</span>
   <span class="steelblue"><span class="strong"><strong>&lt;html</strong></span></span> <span class="steelblue">lang=</span><span class="maroon">"en"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;head&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;meta</strong></span></span> <span class="steelblue">charset=</span><span class="maroon">"utf-8"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;title&gt;&lt;/title&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;/head&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;body&gt;</strong></span></span>
       <span class="indianred"><span class="emphasis"><em>&lt;!-- Content goes here --&gt;</em></span></span>
       <span class="indianred"><span class="emphasis"><em>&lt;!--[if lt IE 9]&gt;&lt;script src="js/excanvas.min.js"&gt;&lt;/script&gt;&lt;![endif]--&gt;</em></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"//cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;/script&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"//cdnjs.cloudflare.com/ajax/libs/flot/0.7/jquery.flot.min.js"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;/script&gt;</strong></span></span>
➊     <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"js/jquery.flot.selection.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;/body&gt;</strong></span></span>
   <span class="steelblue"><span class="strong"><strong>&lt;/html&gt;</strong></span></span></pre><p>As you can see, we do, however, have to add the selection plug-in to the page. It is not available on common CDNs, so we host it on our own server, as shown at ➊.</p></div><div class="sect2" title="Step 2: Draw the Chart"><div class="titlepage"><div><div><h3 class="title" id="step_2_draw_the_chart-id00010">Step 2: Draw the Chart</h3></div></div></div><p>Before we add any interactivity, let’s go back to a basic chart. This time, we’ll add a legend inside the chart since we won’t be including checkboxes next to the chart.</p><a id="pro_id00066"/><pre class="programlisting"><span class="olive">$</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
    <span class="steelblue">$</span>.<span class="olive">plot</span>(<span class="olive">$</span>(<span class="maroon">"#chart"</span>) [
        { <span class="dodgerblue">data</span>: eas, <span class="dodgerblue">label</span>: <span class="maroon">"East Asia &amp; Pacific"</span> },
        { <span class="dodgerblue">data</span>: ecs, <span class="dodgerblue">label</span>: <span class="maroon">"Europe &amp; Central Asia"</span> },
        { <span class="dodgerblue">data</span>: lcn, <span class="dodgerblue">label</span>: <span class="maroon">"Latin America &amp; Caribbean"</span> },
        { <span class="dodgerblue">data</span>: mea, <span class="dodgerblue">label</span>: <span class="maroon">"Middle East &amp; North Africa"</span> },
        { <span class="dodgerblue">data</span>: sas, <span class="dodgerblue">label</span>: <span class="maroon">"South Asia"</span> },
        { <span class="dodgerblue">data</span>: ssf, <span class="dodgerblue">label</span>: <span class="maroon">"Sub-Saharan Africa"</span> }
    ], {<span class="dodgerblue">legend</span>: {<span class="dodgerblue">position</span>: <span class="maroon">"nw"</span>}});
});</pre><p><a id="iddle1359" class="indexterm"/><a id="iddle1521" class="indexterm"/><a id="iddle1763" class="indexterm"/><a id="iddle2197" class="indexterm"/>Here, we call the jQuery extension <code class="literal">plot</code> (from the Flot library) and pass it three parameters. The first parameter identifies the HTML element that should contain the chart, and the second parameter provides the data as an array of data series. These series contain regions we defined earlier, plus a label to identify each series. The final parameter specifies options for the plot. We’ll keep it simple for this example—the only option we’re including tells Flot to position the legend in the top-left (northwest) corner of the chart.</p><p><a class="xref" href="ch02.html#starting_point_for_most_interactive_char" title="Figure 2-8. The starting point for most interactive charts is a good static chart.">Figure 2-8</a> shows the resulting chart.</p><div class="figure"><a id="starting_point_for_most_interactive_char"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00034"/><img src="figs/web/02fig08.png.jpg" alt="The starting point for most interactive charts is a good static chart."/></div></div><div class="figure-title">Figure 2-8. The starting point for most interactive charts is a good static chart.</div></div><p>It looks like we’ve done a good job of capturing and presenting the data statically, so we can move on to the next phase.</p></div><div class="sect2" title="Step 3: Prepare the Data to Support Interaction"><div class="titlepage"><div><div><h3 class="title" id="step_3_prepare_the_data_to_support_inter">Step 3: Prepare the Data to Support Interaction</h3></div></div></div><p>Now that we have a working static chart, we can plan how to support interaction. As part of that support, and for the sake of convenience, we’ll store all the parameters we’re passing to <code class="literal">plot()</code> in local variables.</p><a id="pro_id00067"/><pre class="programlisting">➊ <span class="steelblue"><span class="strong"><strong>var</strong></span></span> $el = <span class="olive">$</span>(<span class="maroon">"#chart"</span>),
➋     data = [
           { <span class="dodgerblue">data</span>: eas, <span class="dodgerblue">label</span>: <span class="maroon">"East Asia &amp; Pacific"</span> },
           { <span class="dodgerblue">data</span>: ecs, <span class="dodgerblue">label</span>: <span class="maroon">"Europe &amp; Central Asia"</span> },
           { <span class="dodgerblue">data</span>: lcn, <span class="dodgerblue">label</span>: <span class="maroon">"Latin America &amp; Caribbean"</span> },
           { <span class="dodgerblue">data</span>: mea, <span class="dodgerblue">label</span>: <span class="maroon">"Middle East &amp; North Africa"</span> },
           { <span class="dodgerblue">data</span>: sas, <span class="dodgerblue">label</span>: <span class="maroon">"South Asia"</span> },
           { <span class="dodgerblue">data</span>: ssf, <span class="dodgerblue">label</span>: <span class="maroon">"Sub-Saharan Africa"</span> }
       ],
➌     options = {<span class="dodgerblue">legend</span>: {<span class="dodgerblue">position</span>: <span class="maroon">"nw"</span>}};

➍ <span class="steelblue"><span class="strong"><strong>var</strong></span></span> plotObj = <span class="steelblue">$</span>.<span class="olive">plot</span>($el, data, options);</pre><p><a id="iddle1318" class="indexterm"/><a id="iddle1404" class="indexterm"/><a id="iddle1523" class="indexterm"/><a id="iddle1719" class="indexterm"/><a id="iddle1770" class="indexterm"/><a id="iddle1793" class="indexterm"/><a id="iddle2050" class="indexterm"/><a id="iddle2177" class="indexterm"/><a id="iddle2181" class="indexterm"/><a id="iddle2199" class="indexterm"/>Before we call <code class="literal">plot()</code>, we create the variables <code class="literal">$el</code> ➊, <code class="literal">data</code> ➋, and <code class="literal">options</code> ➌. We’ll also need to save the object returned from <code class="literal">plot()</code> at ➍.</p></div><div class="sect2" title="Step 4: Prepare to Accept Interaction Events"><div class="titlepage"><div><div><h3 class="title" id="step_4_prepare_to_accept_interaction_eve">Step 4: Prepare to Accept Interaction Events</h3></div></div></div><p>Our code also has to prepare to handle the interaction events. The selection plug-in signals the user’s actions by triggering custom <code class="literal">plotselected</code> events on the element containing the chart. To receive these events, we need a function that expects two parameters—the standard JavaScript event object and a custom object containing details about the selection. We’ll worry about how to process the event shortly. For now let’s focus on preparing for it.</p><a id="pro_id00068"/><pre class="programlisting"><span class="steelblue">$el</span>.<span class="olive">on</span>(<span class="maroon">"plotselected"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev, ranges) {
    <span class="indianred"><span class="emphasis"><em>// Handle selection events</em></span></span>
});</pre><p>The jQuery <code class="literal">.on()</code> function assigns a function to an arbitrary event. Events can be standard JavaScript events such as <code class="literal">click</code>, or they can be custom events like the one we’re using. The event of interest is the first parameter to <code class="literal">.on()</code>. The second parameter is the function that will process the event. As noted previously, it also takes two parameters.</p><p>Now we can consider the action we want to take when our function receives an event. The <code class="literal">ranges</code> parameter contains both an <code class="literal">xaxis</code> and a <code class="literal">yaxis</code> object, which have information about the <code class="literal">plotselected</code> event. In both objects, the <code class="literal">from</code> and <code class="literal">to</code> properties specify the region that the user selected. To zoom to that selection, we can simply redraw the chart by using those ranges for the chart’s axes.</p><p>Specifying the axes for the redrawn chart requires us to pass new options to the <code class="literal">plot()</code> function, but we want to preserve whatever options are already defined. The jQuery <code class="literal">.extend()</code> function gives us the perfect tool for that task. The function merges JavaScript objects so that the result contains all of the properties in each object. If the objects might contain other objects, then we have to tell jQuery to use “deep” mode when it performs the merge. Here’s the complete call to <code class="literal">plot()</code>, which we place inside the <code class="literal">plotselected</code> event handler.</p><a id="pro_id00069"/><pre class="programlisting">plotObj = <span class="steelblue">$</span>.<span class="olive">plot</span>($el, data,
    <span class="steelblue">$</span>.<span class="olive">extend</span>(<span class="steelblue"><span class="strong"><strong>true</strong></span></span>, {}, options, {
        <span class="dodgerblue">xaxis</span>: { <span class="dodgerblue">min</span>: <span class="steelblue">ranges</span>.<span class="steelblue">xaxis</span>.<span class="olive">from</span>, <span class="dodgerblue">max</span>: <span class="steelblue">ranges</span>.<span class="steelblue">xaxis</span>.<span class="olive">to</span> },
        <span class="dodgerblue">yaxis</span>: { <span class="dodgerblue">min</span>: <span class="steelblue">ranges</span>.<span class="steelblue">yaxis</span>.<span class="olive">from</span>, <span class="dodgerblue">max</span>: <span class="steelblue">ranges</span>.<span class="steelblue">yaxis</span>.<span class="olive">to</span> }
    })
);</pre><p><a id="iddle1319" class="indexterm"/><a id="iddle1360" class="indexterm"/><a id="iddle1520" class="indexterm"/><a id="iddle1681" class="indexterm"/><a id="iddle1729" class="indexterm"/><a id="iddle1764" class="indexterm"/><a id="iddle1876" class="indexterm"/><a id="iddle2196" class="indexterm"/>When we use <code class="literal">.extend()</code>, the first parameter (<code class="literal">true</code>) requests deep mode, the second parameter specifies the starting object, and subsequent parameters specify additional objects to merge. We’re starting with an empty object (<code class="literal">{}</code>), merging the regular options, and then further merging the axis options for the zoomed chart.</p></div><div class="sect2" title="Step 5: Enable the Interaction"><div class="titlepage"><div><div><h3 class="title" id="step_5_enable_the_interaction">Step 5: Enable the Interaction</h3></div></div></div><p>Since we’ve included the selections plug-in library on our page, activating the interaction is easy. We simply include an additional <code class="literal">selection</code> option in our call to <code class="literal">plot()</code>. Its <code class="literal">mode</code> property indicates the direction of selections the chart will support. Possible values include <code class="literal">"x"</code> (for x-axis only), <code class="literal">"y"</code> (for y-axis only), or <code class="literal">"xy"</code> (for both axes). Here’s the complete <code class="literal">options</code> variable we want to use.</p><a id="pro_id00070"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> options = {
    <span class="dodgerblue">legend</span>: {<span class="dodgerblue">position</span>: <span class="maroon">"nw"</span>},
    <span class="dodgerblue">selection</span>: {<span class="dodgerblue">mode</span>: <span class="maroon">"xy"</span>}
};</pre><p>And with that addition, our chart is now interactive. Users can zoom in to see as much detail as they want. There is a small problem, though: our visualization doesn’t give users a way to zoom back out. Obviously we can’t use the selection plug-in to zoom out, since that would require users to select outside the current chart area. Instead, we can add a button to the page to reset the zoom level.</p><a id="pro_id00071"/><pre class="programlisting">   <span class="dodgerblue">&lt;!DOCTYPE</span> html<span class="dodgerblue">&gt;</span>
   <span class="steelblue"><span class="strong"><strong>&lt;html</strong></span></span> <span class="steelblue">lang=</span><span class="maroon">"en"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;head&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;meta</strong></span></span> <span class="steelblue">charset=</span><span class="maroon">"utf-8"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;title&gt;&lt;/title&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;/head&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;body&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"chart"</span> <span class="steelblue">style=</span><span class="maroon">"width:600px;height:400px;"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
➊     <span class="steelblue"><span class="strong"><strong>&lt;button</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"unzoom"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>Reset Zoom<span class="steelblue"><span class="strong"><strong>&lt;/button&gt;</strong></span></span>
       <span class="indianred"><span class="emphasis"><em>&lt;!--[if lt IE 9]&gt;&lt;script src="js/excanvas.min.js"&gt;&lt;/script&gt;&lt;![endif]--&gt;</em></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"//cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;/script&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"//cdnjs.cloudflare.com/ajax/libs/flot/0.7/jquery.flot.min.js"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;/script&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"js/jquery.flot.selection.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;/body&gt;</strong></span></span>
   <span class="steelblue"><span class="strong"><strong>&lt;/html&gt;</strong></span></span></pre><p>You can see the button in the markup at ➊; it’s right after the <code class="literal">&lt;div&gt;</code> that holds the chart.</p><p>Now we just need to add code to respond when a user clicks the button. Fortunately, this code is pretty simple.</p><a id="pro_id00072"/><pre class="programlisting"><span class="olive">$</span>(<span class="maroon">"#unzoom"</span>).<span class="olive">click</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {
    plotObj = <span class="steelblue">$</span>.<span class="olive">plot</span>($el, data, options);
});</pre><p>Here we just set up a click handler with jQuery and redraw the chart using the original options. We don’t need any event data, so our event handling function doesn’t even need parameters.</p><p>That gives us a complete, interactive visualization. Users can zoom in to any level of detail and restore the original zoom with one click. You can see the interaction in <a class="xref" href="ch02.html#interactive_charts_let_users_focus_on_da" title="Figure 2-9. Interactive charts let users focus on data relevant to their needs.">Figure 2-9</a>.</p><div class="figure"><a id="interactive_charts_let_users_focus_on_da"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00035"/><img src="figs/web/02fig09.png.jpg" alt="Interactive charts let users focus on data relevant to their needs."/></div></div><div class="figure-title">Figure 2-9. Interactive charts let users focus on data relevant to their needs.</div></div><p><a class="xref" href="ch02.html#users_can_zoom_in_on_a_section_of_partic" title="Figure 2-10. Users can zoom in on a section of particular interest.">Figure 2-10</a> shows what the user sees after zooming in.</p><div class="figure"><a id="users_can_zoom_in_on_a_section_of_partic"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00036"/><img src="figs/web/02fig10.png.jpg" alt="Users can zoom in on a section of particular interest."/></div></div><div class="figure-title">Figure 2-10. Users can zoom in on a section of particular interest.</div></div><p><a id="iddle1513" class="indexterm"/><a id="iddle2058" class="indexterm"/>If you experiment with this example, you’ll soon see that users cannot select an area of the chart that includes the legend. That may be okay for your visualization, but if it’s not, the simplest solution is to create your own legend and position it off the chart’s canvas, like we did for the first example in this chapter.</p></div></div><div class="sect1" title="Tracking Data Values"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="tracking_data_values">Tracking Data Values</h2></div></div></div><p>A big reason we make visualizations interactive is to give users control over their view of the data. We can present a “big picture” view of the data, but we don’t want to prevent users from digging into the details. Often, however, this can force an either/or choice on users: they can see the overall view, or they can see a detailed picture, but they can’t see both at the same time. This example looks at an alternative approach that enables users to see overall trends and specific details at once. To do that, we take advantage of the mouse as an input device. When the user’s mouse hovers over a section of the chart, our code overlays details relevant to that part of the chart.</p><p>This approach does have a significant limitation: it works only when the user has a mouse. If you’re considering this technique, be aware that users on touchscreen devices won’t be able to take advantage of the interactive aspect; they’ll see only the static chart.</p><p><a id="iddle1514" class="indexterm"/><a id="iddle2059" class="indexterm"/>Since simple GDP data doesn’t lend itself well to the approach in this example, we’ll visualize a slightly different set of data from the World Bank. This time we’ll look at exports as a percentage of GDP. Let’s start by considering a simple line chart, shown in <a class="xref" href="ch02.html#plotting_multiple_data_sets_on_a_single" title="Figure 2-11. Plotting multiple data sets on a single chart can be confusing for users.">Figure 2-11</a>, with data for each world region.</p><div class="figure"><a id="plotting_multiple_data_sets_on_a_single"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00037"/><img src="figs/web/02fig11.png.jpg" alt="Plotting multiple data sets on a single chart can be confusing for users."/></div></div><div class="figure-title">Figure 2-11. Plotting multiple data sets on a single chart can be confusing for users.</div></div><p>There are a couple of ways this chart falls short. First, many of the series have similar values, forcing some of the chart’s lines to cross back and forth over each other. That crisscrossing makes it hard for users to follow a single series closely to see detailed trends. Second, it’s hard for users to compare specific values for all of the regions at a single point in time. Most chart libraries, including Flot, have options to display values as users mouse over the chart, but that approach shows only one value at a time. We’d like to give our users a chance to compare the values of multiple regions.</p><p>In this example we’ll use a two-phase approach to solve both of those problems. First, we’ll change the visualization from a single chart with multiple series to multiple charts, each with a single series. That will isolate each region’s data, making it easier to see a particular region’s trends. Then we’ll add an advanced mouse tracking feature that spans all of the charts. This feature will let users see individual values in all of the charts at once.</p><div class="sect2" title="Step 1: Set Aside a &lt;div&gt; Element to Hold the Charts"><div class="titlepage"><div><div><h3 class="title" id="step_1_set_aside_a_less_thandivgreater_t">Step 1: Set Aside a &lt;div&gt; Element to Hold the Charts</h3></div></div></div><p>Within our document, we need to create a <code class="literal">&lt;div&gt;</code> element to contain the charts we’ll construct. This element won’t contain the charts directly; rather, we’ll be placing other <code class="literal">&lt;div&gt;</code>s within it, which will each contain a chart.</p><a id="pro_id00073"/><pre class="programlisting">   <span class="dodgerblue">&lt;!DOCTYPE</span> html<span class="dodgerblue">&gt;</span>
   <span class="steelblue"><span class="strong"><strong>&lt;html</strong></span></span> <span class="steelblue">lang=</span><span class="maroon">"en"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;head&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;meta</strong></span></span> <span class="steelblue">charset=</span><span class="maroon">"utf-8"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;title&gt;&lt;/title&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;/head&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;body&gt;</strong></span></span>
➊     <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"charts"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
       <span class="indianred"><span class="emphasis"><em>&lt;!--[if lt IE 9]&gt;&lt;script src="js/excanvas.min.js"&gt;&lt;/script&gt;&lt;![endif]--&gt;</em></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"//cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;/script&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"//cdnjs.cloudflare.com/ajax/libs/flot/0.7/jquery.flot.min.js"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;/script&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;/body&gt;</strong></span></span>
   <span class="steelblue"><span class="strong"><strong>&lt;/html&gt;</strong></span></span></pre><p><a id="iddle1299" class="indexterm"/><a id="iddle1517" class="indexterm"/><a id="iddle2062" class="indexterm"/>The <code class="literal">"charts" &lt;div&gt;</code> is added at ➊. We’ve also included the required JavaScript libraries here, just as in the previous examples.</p><p>We’ll use JavaScript to create the <code class="literal">&lt;div&gt;</code>s for the charts themselves. These elements must have an explicit height and width, or Flot won’t be able to construct the charts. You can indicate the element’s size in a CSS style sheet, or you can define it when we create the <code class="literal">&lt;div&gt;</code> (as in the following example). This creates a new <code class="literal">&lt;div&gt;</code>, sets its width and height, saves a reference to it, and then appends it to the containing <code class="literal">&lt;div&gt;</code> already in our document.</p><a id="pro_id00074"/><pre class="programlisting"><span class="steelblue">$</span>.<span class="olive">each</span>(exports, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(idx,region) {
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> div = <span class="olive">$</span>(<span class="maroon">"&lt;div&gt;"</span>).<span class="olive">css</span>({
        <span class="dodgerblue">width</span>: <span class="maroon">"600px"</span>,
        <span class="dodgerblue">height</span>: <span class="maroon">"60px"</span>
    });
    <span class="steelblue">region</span>.<span class="olive">div</span> = div;
    <span class="olive">$</span>(<span class="maroon">"#charts"</span>).<span class="olive">append</span>(div);
});</pre><p>To iterate through the array of regions, we use the jQuery <code class="literal">.each()</code> function. That function accepts two parameters: an array of objects (<code class="literal">exports</code>) and a function. It iterates through the array one object at a time, calling the function with the individual object (<code class="literal">region</code>) and its index (<code class="literal">idx</code>) as parameters.</p></div><div class="sect2" title="Step 2: Prepare the Data"><div class="titlepage"><div><div><h3 class="title" id="step_2_prepare_the_data">Step 2: Prepare the Data</h3></div></div></div><p>We’ll see how to get data directly from the World Bank’s web service in the next section, but for now we’ll keep things simple again and assume we have the data downloaded and formatted for JavaScript already. (Once again, only excerpts are shown here. The book’s source code includes the full data set.)</p><a id="pro_id00075"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> exports = [
    { <span class="dodgerblue">label</span>: <span class="maroon">"East Asia &amp; Pacific"</span>,
      <span class="dodgerblue">data</span>: [[<span class="red">1960</span>,<span class="red">13.2277</span>],[<span class="red">1961</span>,<span class="red">11.7964</span>], <span class="indianred"><span class="emphasis"><em>// Data continues...</em></span></span>
    { <span class="dodgerblue">label</span>: <span class="maroon">"Europe &amp; Central Asia"</span>,
      <span class="dodgerblue">data</span>: [[<span class="red">1960</span>,<span class="red">19.6961</span>],[<span class="red">1961</span>,<span class="red">19.4264</span>], <span class="indianred"><span class="emphasis"><em>// Data continues...</em></span></span>
    { <span class="dodgerblue">label</span>: <span class="maroon">"Latin America &amp; Caribbean"</span>,
      <span class="dodgerblue">data</span>: [[<span class="red">1960</span>,<span class="red">11.6802</span>],[<span class="red">1961</span>,<span class="red">11.3069</span>], <span class="indianred"><span class="emphasis"><em>// Data continues...</em></span></span>
    { <span class="dodgerblue">label</span>: <span class="maroon">"Middle East &amp; North Africa"</span>,
      <span class="dodgerblue">data</span>: [[<span class="red">1968</span>,<span class="red">31.1954</span>],[<span class="red">1969</span>,<span class="red">31.7533</span>], <span class="indianred"><span class="emphasis"><em>// Data continues...</em></span></span>
    { <span class="dodgerblue">label</span>: <span class="maroon">"North America"</span>,
      <span class="dodgerblue">data</span>: [[<span class="red">1960</span>,<span class="red">5.9475</span>],[<span class="red">1961</span>,<span class="red">5.9275</span>], <span class="indianred"><span class="emphasis"><em>// Data continues...</em></span></span>
    { <span class="dodgerblue">label</span>: <span class="maroon">"South Asia"</span>,
      <span class="dodgerblue">data</span>: [[<span class="red">1960</span>,<span class="red">5.7086</span>],[<span class="red">1961</span>,<span class="red">5.5807</span>], <span class="indianred"><span class="emphasis"><em>// Data continues...</em></span></span>
    { <span class="dodgerblue">label</span>: <span class="maroon">"Sub-Saharan Africa"</span>,
      <span class="dodgerblue">data</span>: [[<span class="red">1960</span>,<span class="red">25.5083</span>],[<span class="red">1961</span>,<span class="red">25.3968</span>], <span class="indianred"><span class="emphasis"><em>// Data continues...</em></span></span>
];</pre><p><a id="iddle1361" class="indexterm"/><a id="iddle1515" class="indexterm"/><a id="iddle1765" class="indexterm"/><a id="iddle1880" class="indexterm"/><a id="iddle2060" class="indexterm"/><a id="iddle2178" class="indexterm"/>The <code class="literal">exports</code> array contains an object for each region, and each object contains a label and a data series.</p></div><div class="sect2" title="Step 3: Draw the Charts"><div class="titlepage"><div><div><h3 class="title" id="step_3_draw_the_charts">Step 3: Draw the Charts</h3></div></div></div><p>With the <code class="literal">&lt;div&gt;</code>s for each chart now in place on our page, we can draw the charts using Flot’s <code class="literal">plot()</code> function. That function takes three parameters: the containing element (which we just created), the data, and chart options. To start, let’s look at the charts without any decoration—such as labels, grids, or checkmarks—just to make sure the data is generally presented the way we want.</p><a id="pro_id00076"/><pre class="programlisting"><span class="steelblue">$</span>.<span class="olive">each</span>(exports, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(idx,region) {
    <span class="steelblue">region</span>.<span class="olive">plot</span> = <span class="steelblue">$</span>.<span class="olive">plot</span>(<span class="steelblue">region</span>.<span class="olive">div</span>, [<span class="steelblue">region</span>.<span class="olive">data</span>], {
        <span class="dodgerblue">series</span>: {<span class="dodgerblue">lines</span>: {<span class="dodgerblue">fill</span>: <span class="steelblue"><span class="strong"><strong>true</strong></span></span>, <span class="dodgerblue">lineWidth</span>: <span class="red">1</span>}, <span class="dodgerblue">shadowSize</span>: <span class="red">0</span>},
        <span class="dodgerblue">xaxis</span>: {<span class="dodgerblue">show</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>, <span class="dodgerblue">min</span>:<span class="red">1960</span>, <span class="dodgerblue">max</span>: <span class="red">2011</span>},
        <span class="dodgerblue">yaxis</span>: {<span class="dodgerblue">show</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>, <span class="dodgerblue">min</span>: <span class="red">0</span>, <span class="dodgerblue">max</span>: <span class="red">60</span>},
        <span class="dodgerblue">grid</span>:  {<span class="dodgerblue">show</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>},
    });
});</pre><p>The preceding code uses several <code class="literal">plot()</code> options to strip the chart of all the extras and set the axes the way we want. Let’s consider each option in turn.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: none"><p title="series"><span class="title"><strong><span class="strong"><strong><code class="literal">series</code></strong></span></strong></span>. Tells Flot how we want it to graph the data series. In our case we want a line chart (which is the default type), but we want to fill the area from the line down to the x-axis, so we set <code class="literal">fill</code> to <code class="literal">true</code>. This option creates an area chart instead of a line chart. Because our charts are so short, an area chart will keep the data visible. For the same reason, we want the line itself to be as small as possible to match, so we set <code class="literal">lineWidth</code> to <code class="literal">1</code> (pixel), and we can dispense with shadows by setting <code class="literal">shadowSize</code> to <code class="literal">0</code>.</p></li><li class="listitem" style="list-style-type: none"><p title="xaxis"><span class="title"><strong><span class="strong"><strong><code class="literal">xaxis</code></strong></span></strong></span>. Defines the properties of the x-axis. We don’t want to include one on these charts, so we set <code class="literal">show</code> to <code class="literal">false</code>. We do, however, need to explicitly set the range of the axis. If we don’t, Flot will create one automatically, using the range of each series. Since our data doesn’t have consistent values for all years (the Middle East &amp; North Africa data set, for example, doesn’t include data before 1968), we need to make Flot use the exact same x-axis range on all charts, so we specify a range from <code class="literal">1960</code> to <code class="literal">2011</code>.</p></li><li class="listitem" style="list-style-type: none"><p title="yaxis"><span class="title"><strong><span class="strong"><strong><code class="literal">yaxis</code></strong></span></strong></span>. <a id="iddle1351" class="indexterm"/><a id="iddle1432" class="indexterm"/><a id="iddle2182" class="indexterm"/>Works much like the <code class="literal">xaxis</code> options. We don’t want to show one, but we do need to specify an explicit range so that all of the charts are consistent.</p></li><li class="listitem" style="list-style-type: none"><p title="grid"><span class="title"><strong><span class="strong"><strong><code class="literal">grid</code></strong></span></strong></span>. Tells Flot how to add grid lines and checkmarks to the charts. For now, we don’t want anything extra, so we turn off the grid completely by setting <code class="literal">show</code> to <code class="literal">false</code>.</p></li></ul></div><p>We can check the result in <a class="xref" href="ch02.html#separating_individual_data_sets_into_mul" title="Figure 2-12. Separating individual data sets into multiple charts can make it easier to see the details of each set.">Figure 2-12</a> to make sure the charts appear as we want.</p><div class="figure"><a id="separating_individual_data_sets_into_mul"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00038"/><img src="figs/web/02fig12.png.jpg" alt="Separating individual data sets into multiple charts can make it easier to see the details of each set."/></div></div><div class="figure-title">Figure 2-12. Separating individual data sets into multiple charts can make it easier to see the details of each set.</div></div><p>Next we turn to the decoration for the chart. We’re obviously missing labels for each region, but adding them takes some care. Your first thought might be to include a legend along with each chart in the same <code class="literal">&lt;div&gt;</code>. Flot’s event handling, however, will work much better if we can keep all the charts—and only the charts—in their own <code class="literal">&lt;div&gt;</code>. That’s going to require some restructuring of our markup. We’ll create a wrapper <code class="literal">&lt;div&gt;</code> and then place separate <code class="literal">&lt;div&gt;</code>s for the charts and the legends within it. We can use the CSS <code class="literal">float</code> property to position them side by side.</p><a id="pro_id00077"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"charts-wrapper"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"charts"</span> <span class="steelblue">style=</span><span class="maroon">"float:left;"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"legends"</span> <span class="steelblue">style=</span><span class="maroon">"float:left;"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">style=</span><span class="maroon">"clear:both;"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/div&gt;</strong></span></span></pre><p>When we create each legend, we have to be sure it has the exact same height as the chart. Because we’re setting both explicitly, that’s not hard to do.</p><a id="pro_id00078"/><pre class="programlisting"><span class="steelblue">$</span>.<span class="olive">each</span>(exports, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(idx,region) {
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> legend = <span class="olive">$</span>(<span class="maroon">"&lt;p&gt;"</span>).<span class="olive">text</span>(<span class="steelblue">region</span>.<span class="olive">label</span>).<span class="olive">css</span>({
        <span class="maroon">"height"</span>:        <span class="maroon">"17px"</span>,
        <span class="maroon">"margin-bottom"</span>: <span class="maroon">"0"</span>,
        <span class="maroon">"margin-left"</span>:   <span class="maroon">"10px"</span>,
        <span class="maroon">"padding-top"</span>:   <span class="maroon">"33px"</span>
    });
    <span class="olive">$</span>(<span class="maroon">"#legends"</span>).<span class="olive">append</span>(legend);
});</pre><p><a id="iddle1300" class="indexterm"/><a id="iddle1433" class="indexterm"/><a id="iddle1891" class="indexterm"/><a id="iddle2013" class="indexterm"/>Once again we use <code class="literal">.each</code>, this time to append a legend for each region to the <code class="literal">legends</code> element.</p><p>Now we’d like to add a continuous vertical grid that spans all of the charts. Because the charts are stacked, grid lines in the individual charts can appear as one continuous line as long as we can remove any borders or margins between charts. It takes several <code class="literal">plot()</code> options to achieve that, as shown here.</p><a id="pro_id00079"/><pre class="programlisting"><span class="steelblue">$</span>.<span class="olive">plot</span>(<span class="steelblue">region</span>.<span class="olive">div</span>, [<span class="steelblue">region</span>.<span class="olive">data</span>], {
    <span class="dodgerblue">series</span>: {<span class="dodgerblue">lines</span>: {<span class="dodgerblue">fill</span>: <span class="steelblue"><span class="strong"><strong>true</strong></span></span>, <span class="dodgerblue">lineWidth</span>: <span class="red">1</span>}, <span class="dodgerblue">shadowSize</span>: <span class="red">0</span>},
    <span class="dodgerblue">xaxis</span>:  {<span class="dodgerblue">show</span>: <span class="steelblue"><span class="strong"><strong>true</strong></span></span>, <span class="dodgerblue">labelHeight</span>: <span class="red">0</span>, <span class="dodgerblue">min</span>:<span class="red">1960</span>, <span class="dodgerblue">max</span>: <span class="red">2011</span>,
             <span class="dodgerblue">tickFormatter</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {<span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="maroon">""</span>;}},
    <span class="dodgerblue">yaxis</span>:  {<span class="dodgerblue">show</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>, <span class="dodgerblue">min</span>: <span class="red">0</span>, <span class="dodgerblue">max</span>: <span class="red">60</span>},
    <span class="dodgerblue">grid</span>:   {<span class="dodgerblue">show</span>: <span class="steelblue"><span class="strong"><strong>true</strong></span></span>, <span class="dodgerblue">margin</span>: <span class="red">0</span>, <span class="dodgerblue">borderWidth</span>: <span class="red">0</span>, <span class="dodgerblue">margin</span>: <span class="red">0</span>,
             <span class="dodgerblue">labelMargin</span>: <span class="red">0</span>, <span class="dodgerblue">axisMargin</span>: <span class="red">0</span>, <span class="dodgerblue">minBorderMargin</span>: <span class="red">0</span>},
});</pre><p>We enable the grid by setting the <code class="literal">grid</code> option’s <code class="literal">show</code> property to <code class="literal">true</code>. Then we remove all the borders and padding by setting the various widths and margins to <code class="literal">0</code>. To get the vertical lines, we also have to enable the x-axis, so we set its <code class="literal">show</code> property to <code class="literal">true</code> as well. But we don’t want any labels on individual charts, so we specify a <code class="literal">labelHeight</code> of <code class="literal">0</code>. To be certain that no labels appear, we also define a <code class="literal">tickFormatter()</code> function that returns an empty string.</p><p>The last bits of decoration we’d like to add are x-axis labels below the bottom chart. To do that, we can create a dummy chart with no visible data, position that dummy chart below the bottom chart, and enable labels on its x-axis. The following three sections create an array of dummy data, create a <code class="literal">&lt;div&gt;</code> to hold the dummy chart, and plot the dummy chart.</p><a id="pro_id00080"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> dummyData = [];
<span class="steelblue"><span class="strong"><strong>for</strong></span></span> (<span class="steelblue"><span class="strong"><strong>var</strong></span></span> yr=<span class="red">1960</span>; yr&lt;<span class="red">2012</span>; yr++) <span class="steelblue">dummyData</span>.<span class="olive">push</span>([yr,<span class="red">0</span>]);

<span class="steelblue"><span class="strong"><strong>var</strong></span></span> dummyDiv = <span class="olive">$</span>(<span class="maroon">"&lt;div&gt;"</span>).<span class="olive">css</span>({ <span class="dodgerblue">width</span>: <span class="maroon">"600px"</span>, <span class="dodgerblue">height</span>: <span class="maroon">"15px"</span> });
<span class="olive">$</span>(<span class="maroon">"#charts"</span>).<span class="olive">append</span>(dummyDiv);

<span class="steelblue"><span class="strong"><strong>var</strong></span></span> dummyPlot = <span class="steelblue">$</span>.<span class="olive">plot</span>(dummyDiv, [dummyData], {
    <span class="dodgerblue">xaxis</span>: {<span class="dodgerblue">show</span>: <span class="steelblue"><span class="strong"><strong>true</strong></span></span>, <span class="dodgerblue">labelHeight</span>: <span class="red">12</span>, <span class="dodgerblue">min</span>:<span class="red">1960</span>, <span class="dodgerblue">max</span>: <span class="red">2011</span>},
    <span class="dodgerblue">yaxis</span>: {<span class="dodgerblue">show</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>, <span class="dodgerblue">min</span>: <span class="red">100</span>, <span class="dodgerblue">max</span>: <span class="red">200</span>},
    <span class="dodgerblue">grid</span>:  {<span class="dodgerblue">show</span>: <span class="steelblue"><span class="strong"><strong>true</strong></span></span>, <span class="dodgerblue">margin</span>: <span class="red">0</span>, <span class="dodgerblue">borderWidth</span>: <span class="red">0</span>, <span class="dodgerblue">margin</span>: <span class="red">0</span>,
            <span class="dodgerblue">labelMargin</span>: <span class="red">0</span>, <span class="dodgerblue">axisMargin</span>: <span class="red">0</span>, <span class="dodgerblue">minBorderMargin</span>: <span class="red">0</span>},
});</pre><p><a id="iddle1362" class="indexterm"/><a id="iddle1363" class="indexterm"/><a id="iddle1434" class="indexterm"/><a id="iddle1461" class="indexterm"/><a id="iddle1516" class="indexterm"/><a id="iddle1766" class="indexterm"/><a id="iddle2061" class="indexterm"/>With the added decoration, our chart in <a class="xref" href="ch02.html#carefully_stacking_multiple_charts_creat" title="Figure 2-13. Carefully stacking multiple charts creates the appearance of a unified chart.">Figure 2-13</a> looks great.</p><div class="figure"><a id="carefully_stacking_multiple_charts_creat"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00039"/><img src="figs/web/02fig13.png.jpg" alt="Carefully stacking multiple charts creates the appearance of a unified chart."/></div></div><div class="figure-title">Figure 2-13. Carefully stacking multiple charts creates the appearance of a unified chart.</div></div></div><div class="sect2" title="Step 4: Implement the Interaction"><div class="titlepage"><div><div><h3 class="title" id="step_4_implement_the_interaction">Step 4: Implement the Interaction</h3></div></div></div><p>For our visualization, we want to track the mouse as it hovers over any of our charts. The Flot library makes that relatively easy. The <code class="literal">plot()</code> function’s <code class="literal">grid</code> options include the <code class="literal">hoverable</code> property, which is set to <code class="literal">false</code> by default. If you set this property to <code class="literal">true</code>, Flot will trigger <code class="literal">plothover</code> events as the mouse moves over the chart area. It sends these events to the <code class="literal">&lt;div&gt;</code> that contains the chart. If there is code listening for those events, that code can respond to them. If you use this feature, Flot will also highlight the data point nearest the mouse. That’s a behavior we don’t want, so we’ll disable it by setting <code class="literal">autoHighlight</code> to <code class="literal">false</code>.</p><a id="pro_id00081"/><pre class="programlisting"><span class="steelblue">$</span>.<span class="olive">plot</span>(<span class="steelblue">region</span>.<span class="olive">div</span>, [<span class="steelblue">region</span>.<span class="olive">data</span>], {
    <span class="dodgerblue">series</span>: {<span class="dodgerblue">lines</span>: {<span class="dodgerblue">fill</span>: <span class="steelblue"><span class="strong"><strong>true</strong></span></span>, <span class="dodgerblue">lineWidth</span>: <span class="red">1</span>}, <span class="dodgerblue">shadowSize</span>: <span class="red">0</span>},
    <span class="dodgerblue">xaxis</span>:  {<span class="dodgerblue">show</span>: <span class="steelblue"><span class="strong"><strong>true</strong></span></span>, <span class="dodgerblue">labelHeight</span>: <span class="red">0</span>, <span class="dodgerblue">min</span>: <span class="red">1960</span>, <span class="dodgerblue">max</span>: <span class="red">2011</span>,
             <span class="dodgerblue">tickFormatter</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {<span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="maroon">""</span>;}},
    <span class="dodgerblue">yaxis</span>:  {<span class="dodgerblue">show</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>, <span class="dodgerblue">min</span>: <span class="red">0</span>, <span class="dodgerblue">max</span>: <span class="red">60</span>},
    <span class="dodgerblue">grid</span>:   {<span class="dodgerblue">show</span>: <span class="steelblue"><span class="strong"><strong>true</strong></span></span>, <span class="dodgerblue">margin</span>: <span class="red">0</span>, <span class="dodgerblue">borderWidth</span>: <span class="red">0</span>, <span class="dodgerblue">margin</span>: <span class="red">0</span>,
             <span class="dodgerblue">labelMargin</span>: <span class="red">0</span>, <span class="dodgerblue">axisMargin</span>: <span class="red">0</span>, <span class="dodgerblue">minBorderMargin</span>: <span class="red">0</span>,
             <span class="dodgerblue">hoverable</span>: <span class="steelblue"><span class="strong"><strong>true</strong></span></span>, <span class="dodgerblue">autoHighlight</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>},
});</pre><p>Now that we’ve told Flot to trigger events on all of our charts, you might think we would have to set up code to listen for events on all of them. There’s an even better approach, though. We structured our markup so that all the charts—and only the charts—are inside the containing <code class="literal">charts &lt;div&gt;</code>. In JavaScript, if no code is listening for an event on a specific document element, those events <a id="iddle1274" class="indexterm"/><a id="iddle1688" class="indexterm"/><a id="iddle1767" class="indexterm"/><a id="iddle1772" class="indexterm"/><a id="iddle1776" class="indexterm"/><a id="iddle2190" class="indexterm"/>automatically “bubble up” to the containing elements. So if we just set up an event listener on the <code class="literal">charts &lt;div&gt;</code>, we can capture the <code class="literal">plothover</code> events on all of the individual charts. We’ll also need to know when the mouse leaves the chart area. We can catch those events using the standard <code class="literal">mouseout</code> event as follows:</p><a id="pro_id00082"/><pre class="programlisting"><span class="olive">$</span>(<span class="maroon">"charts"</span>).<span class="olive">on</span>(<span class="maroon">"plothover"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {
    <span class="indianred"><span class="emphasis"><em>// The mouse is hovering over a chart</em></span></span>
}).<span class="olive">on</span>(<span class="maroon">"mouseout"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {
    <span class="indianred"><span class="emphasis"><em>// The mouse is no longer hovering over a chart</em></span></span>
});</pre><p>To respond to the <code class="literal">plothover</code> events, we want to display a vertical line across all of the charts. We can construct that line using a <code class="literal">&lt;div&gt;</code> element with a border. In order to move it around, we use absolute positioning. It also needs a positive <code class="literal">z-index</code> value to make sure the browser draws it on top of the chart. The marker starts off hidden with a <code class="literal">display</code> property of <code class="literal">none</code>. Since we want to position the marker within the containing <code class="literal">&lt;div&gt;</code>, we set the containing <code class="literal">&lt;div&gt;</code>’s <code class="literal">position</code> property to <code class="literal">relative</code>.</p><a id="pro_id00083"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"charts-wrapper"</span> <span class="steelblue">style=</span><span class="maroon">"position:relative;"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"marker"</span> <span class="steelblue">style=</span><span class="maroon">"position:absolute;z-index:1;display:none;</span>
                            <span class="maroon">width:1px;border-left: 1px solid black;"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"charts"</span> <span class="steelblue">style=</span><span class="maroon">"float:left;"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"legends"</span> <span class="steelblue">style=</span><span class="maroon">"float:left;"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">style=</span><span class="maroon">"clear:both;"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/div&gt;</strong></span></span></pre><p>When Flot calls the function listening for <code class="literal">plothover</code> events, it passes that function three parameters: the JavaScript event object, the position of the mouse expressed as x- and y-coordinates, and, if a chart data point is near the mouse, information about that data point. In our example we need only the x-coordinate. We can round it to the nearest integer to get the year. We also need to know where the mouse is relative to the page. Flot will calculate that for us if we call the <code class="literal">pointOffset()</code> of any of our plot objects. Note that we can’t reliably use the third parameter, which is available only if the mouse is near an actual data point, so we can ignore it.</p><a id="pro_id00084"/><pre class="programlisting"><span class="olive">$</span>(<span class="maroon">"charts"</span>).<span class="olive">on</span>(<span class="maroon">"plothover"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev, pos) {
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> year = <span class="steelblue">Math</span>.<span class="olive">round</span>(<span class="steelblue">pos</span>.<span class="olive">x</span>);
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> left = <span class="steelblue">dummyPlot</span>.<span class="olive">pointOffset</span>(pos).<span class="olive">left</span>;
});</pre><p>Once we’ve calculated the position, it’s a simple matter to move the marker to that position, make sure it’s the full height of the containing <code class="literal">&lt;div&gt;</code>, and turn it on.</p><a id="pro_id00085"/><pre class="programlisting">   <span class="olive">$</span>(<span class="maroon">"#charts"</span>).<span class="olive">on</span>(<span class="maroon">"plothover"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev, pos) {
       <span class="steelblue"><span class="strong"><strong>var</strong></span></span> year = <span class="steelblue">Math</span>.<span class="olive">round</span>(<span class="steelblue">pos</span>.<span class="olive">x</span>);
       <span class="steelblue"><span class="strong"><strong>var</strong></span></span> left = <span class="steelblue">dummyPlot</span>.<span class="olive">pointOffset</span>(pos).<span class="olive">left</span>;
➊     <span class="steelblue"><span class="strong"><strong>var</strong></span></span> height = <span class="olive">$</span>(<span class="maroon">"#charts"</span>).<span class="olive">height</span>();
       <span class="olive">$</span>(<span class="maroon">"#marker"</span>).<span class="olive">css</span>({
           <span class="maroon">"top"</span>:    <span class="red">0</span>,
➋         <span class="maroon">"left"</span>:   left,
           <span class="maroon">"width"</span>:  <span class="maroon">"1px"</span>,
➌         <span class="maroon">"height"</span>: height
       }).<span class="olive">show</span>();
   });</pre><p><a id="iddle1689" class="indexterm"/><a id="iddle1802" class="indexterm"/>In this code, we calculate the marker height at ➊, set its position at ➋, and set the height at ➌.</p><p>We also have to be a little careful on the <code class="literal">mouseout</code> event. If a user moves the mouse so that it is positioned directly on top of the marker, that will generate a <code class="literal">mouseout</code> event for the <code class="literal">charts &lt;div&gt;</code>. In that special case, we want to leave the marker displayed. To tell where the mouse has moved, we check the <code class="literal">relatedTarget</code> property of the event. We hide the marker only if the related target isn’t the marker itself.</p><a id="pro_id00086"/><pre class="programlisting"><span class="olive">$</span>(<span class="maroon">"#charts"</span>).<span class="olive">on</span>(<span class="maroon">"mouseout"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev) {
    <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (<span class="steelblue">ev</span>.<span class="steelblue">relatedTarget</span>.<span class="olive">id</span> !== <span class="maroon">"marker"</span>) {
        <span class="olive">$</span>(<span class="maroon">"#marker"</span>).<span class="olive">hide</span>();
    }
});</pre><p>There’s still one hole in our event processing. If the user moves the mouse directly over the marker, and then moves the mouse off the chart area entirely (without moving it off the marker), we won’t catch the fact that the mouse is no longer hovering on the chart. To catch this event, we can listen for <code class="literal">mouseout</code> events on the marker itself. There’s no need to worry about the mouse moving off the marker and back onto the chart area; the existing <code class="literal">plothover</code> event will cover that scenario.</p><a id="pro_id00087"/><pre class="programlisting"><span class="olive">$</span>(<span class="maroon">"#marker"</span>).<span class="olive">on</span>(<span class="maroon">"mouseout"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev) {
      <span class="olive">$</span>(<span class="maroon">"#marker"</span>).<span class="olive">hide</span>();
});</pre><p>The last part of our interaction shows the values of all charts corresponding to the horizontal position of the mouse. We can create <code class="literal">&lt;div&gt;</code>s to hold these values back when we create each chart. Because these <code class="literal">&lt;div&gt;</code>s might extend beyond the chart area proper, we’ll place them in the outer <code class="literal">charts-wrapper &lt;div&gt;</code>.</p><a id="pro_id00088"/><pre class="programlisting">   <span class="steelblue">$</span>.<span class="olive">each</span>(exports, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(idx,region) {
       <span class="steelblue"><span class="strong"><strong>var</strong></span></span> value = <span class="olive">$</span>(<span class="maroon">"&lt;div&gt;"</span>).<span class="olive">css</span>({
           <span class="maroon">"position"</span>:  <span class="maroon">"absolute"</span>,
           <span class="maroon">"top"</span>:       (<span class="steelblue">div</span>.<span class="olive">position</span>().<span class="olive">top</span> - <span class="red">3</span>) + <span class="maroon">"px"</span>,
➊         <span class="maroon">"display"</span>:   <span class="maroon">"none"</span>,
           <span class="maroon">"z-index"</span>:   <span class="red">1</span>,
           <span class="maroon">"font-size"</span>: <span class="maroon">"11px"</span>,
           <span class="maroon">"color"</span>:     <span class="maroon">"black"</span>
       });
       <span class="steelblue">region</span>.<span class="olive">value</span> = value;
       <span class="olive">$</span>(<span class="maroon">"#charts-wrapper"</span>).<span class="olive">append</span>(value);
   });</pre><p><a id="iddle1426" class="indexterm"/>Notice that as we create these <code class="literal">&lt;div&gt;</code>s, we set all the properties except the left position, since that will vary with the mouse. We also hide the elements with a <code class="literal">display</code> property of <code class="literal">none</code> at ➊.</p><p>With the <code class="literal">&lt;div&gt;</code>s waiting for us in the document, our event handler for <code class="literal">plothover</code> sets the text for each, positions them horizontally, and shows them on the page. To set the text value, we can use the jQuery <code class="literal">.grep()</code> function to search through the data for a year that matches. If none is found, the text for the value <code class="literal">&lt;div&gt;</code> is emptied.</p><a id="pro_id00089"/><pre class="programlisting"><span class="olive">$</span>(<span class="maroon">"#charts"</span>).<span class="olive">on</span>(<span class="maroon">"plothover"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev, pos) {
    <span class="steelblue">$</span>.<span class="olive">each</span>(exports, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(idx, region) {
        matched = <span class="steelblue">$</span>.<span class="olive">grep</span>(<span class="steelblue">region</span>.<span class="olive">data</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(pt) { <span class="steelblue"><span class="strong"><strong>return</strong></span></span> pt[<span class="red">0</span>] === year; });
        <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (<span class="steelblue">matched</span>.<span class="olive">length</span> &gt; <span class="red">0</span>) {
            <span class="steelblue">region</span>.<span class="steelblue">value</span>.<span class="olive">text</span>(year + <span class="maroon">": "</span> + <span class="steelblue">Math</span>.<span class="olive">round</span>(matched[<span class="red">0</span>][<span class="red">1</span>]) + <span class="maroon">"%"</span>);
        } <span class="steelblue"><span class="strong"><strong>else</strong></span></span> {
            <span class="steelblue">region</span>.<span class="steelblue">value</span>.<span class="olive">text</span>(<span class="maroon">""</span>);
        }
        <span class="steelblue">region</span>.<span class="steelblue">value</span>.<span class="olive">css</span>(<span class="maroon">"left"</span>, (left<span class="red">+4</span>)+<span class="maroon">"px"</span>).<span class="olive">show</span>();
    });
});</pre><p>Finally, we need to hide these <code class="literal">&lt;div&gt;</code>s when the mouse leaves the chart area. We should also handle the case of the mouse moving directly onto the marker, just as we did before.</p><a id="pro_id00090"/><pre class="programlisting"><span class="olive">$</span>(<span class="maroon">"#charts"</span>).<span class="olive">on</span>(<span class="maroon">"plothover"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev, pos) {

    <span class="indianred"><span class="emphasis"><em>// Handle plothover event</em></span></span>

}).<span class="olive">on</span>(<span class="maroon">"mouseout"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev) {
    <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (<span class="steelblue">ev</span>.<span class="steelblue">relatedTarget</span>.<span class="olive">id</span> !== <span class="maroon">"marker"</span>) {
        <span class="olive">$</span>(<span class="maroon">"#marker"</span>).<span class="olive">hide</span>();
        <span class="steelblue">$</span>.<span class="olive">each</span>(exports, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(idx, region) {
            <span class="steelblue">region</span>.<span class="steelblue">value</span>.<span class="olive">hide</span>();
        });
    }
});

<span class="olive">$</span>(<span class="maroon">"#marker"</span>).<span class="olive">on</span>(<span class="maroon">"mouseout"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev) {
    <span class="olive">$</span>(<span class="maroon">"#marker"</span>).<span class="olive">hide</span>();
    <span class="steelblue">$</span>.<span class="olive">each</span>(exports, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(idx, region) {
        <span class="steelblue">region</span>.<span class="steelblue">value</span>.<span class="olive">hide</span>();
    });
});</pre><p><a id="iddle1019" class="indexterm"/><a id="iddle1054" class="indexterm"/><a id="iddle1497" class="indexterm"/><a id="iddle1820" class="indexterm"/>We can now enjoy the results of our coding, in <a class="xref" href="ch02.html#final_visualization_combines_multiple_ch" title="Figure 2-14. The final visualization combines multiple charts with mouse tracking to more clearly present the data.">Figure 2-14</a>. Our visualization clarifies the trends in exports for each region, and it lets users interact with the charts to compare regions and view detailed values.</p><div class="figure"><a id="final_visualization_combines_multiple_ch"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00040"/><img src="figs/web/02fig14.png.jpg" alt="The final visualization combines multiple charts with mouse tracking to more clearly present the data."/></div></div><div class="figure-title">Figure 2-14. The final visualization combines multiple charts with mouse tracking to more clearly present the data.</div></div><p>As users move their mouse across the charts, the vertical bar moves as well. The values corresponding to the mouse position also appear to the right of the marker for each chart. The interaction makes it easy and intuitive to compare values for any of the regions.</p><p>The chart we’ve created in this example is similar to the <span class="emphasis"><em>small multiples</em></span> approach for letting users compare many values. In our example the chart takes up the full page, but it could also be designed as one element in a larger presentation such as a table. <a class="xref" href="ch03.html" title="Chapter 3. Integrating Charts on a Page">Chapter 3</a> gives examples of integrating charts in larger web page elements.</p></div></div><div class="sect1" title="Retrieving Data Using AJAX"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="retrieving_data_using_ajax">Retrieving Data Using AJAX</h2></div></div></div><p>Most of the examples in this book emphasize the final product of data visualization: the graphs, charts, or images that our users see. But effective visualizations often require a lot of work behind the scenes. After all, effective data visualizations need <span class="emphasis"><em>data</em></span> just as much as they need the visualization. This example focuses on a common approach for accessing data—<span class="emphasis"><em>Asynchronous JavaScript and XML</em></span>, more commonly known as <span class="emphasis"><em>AJAX</em></span>. The example here details AJAX interactions with the World Bank, but both the general approach and the specific techniques shown here apply equally well to many other data sources on the Web.</p><div class="sect2" title="Step 1: Understand the Source Data"><div class="titlepage"><div><div><h3 class="title" id="step_1_understand_the_source_data">Step 1: Understand the Source Data</h3></div></div></div><p><a id="iddle1025" class="indexterm"/><a id="iddle1503" class="indexterm"/><a id="iddle1826" class="indexterm"/>Often, the first challenge in working with remote data is to understand its format and structure. Fortunately, our data comes from the World Bank, and its website thoroughly documents its <span class="emphasis"><em>application programming interface (API)</em></span>. We won’t spend too much time on the particulars in this example, since you’ll likely be using a different data source. But a quick overview is helpful.</p><p>The first item of note is that the World Bank divides the world into several regions. As with all good APIs, the World Bank API allows us to issue a query to get a list of those regions.</p><a id="pro_id00091"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>http</strong></span></span>://api.worldbank.org/regions/?format=json</pre><p>Our query returns the full list as a JSON array, which starts as follows:</p><a id="pro_id00092"/><pre class="programlisting">[ { <span class="maroon">"page"</span>: <span class="maroon">"1"</span>,
    <span class="maroon">"pages"</span>: <span class="maroon">"1"</span>,
    <span class="maroon">"per_page"</span>: <span class="maroon">"50"</span>,
    <span class="maroon">"total"</span>: <span class="maroon">"22"</span>
  },
  [ { <span class="maroon">"id"</span>: <span class="maroon">""</span>,
      <span class="maroon">"code"</span>: <span class="maroon">"ARB"</span>,
      <span class="maroon">"name"</span>: <span class="maroon">"Arab World"</span>
    },
    { <span class="maroon">"id"</span>: <span class="maroon">""</span>,
      <span class="maroon">"code"</span>: <span class="maroon">"CSS"</span>,
      <span class="maroon">"name"</span>: <span class="maroon">"Caribbean small states"</span>
    },
    { <span class="maroon">"id"</span>: <span class="maroon">""</span>,
      <span class="maroon">"code"</span>: <span class="maroon">"EAP"</span>,
      <span class="maroon">"name"</span>: <span class="maroon">"East Asia &amp; Pacific (developing only)"</span>
    },
    { <span class="maroon">"id"</span>: <span class="maroon">"1"</span>,
      <span class="maroon">"code"</span>: <span class="maroon">"EAS"</span>,
      <span class="maroon">"name"</span>: <span class="maroon">"East Asia &amp; Pacific (all income levels)"</span>
    },
    { <span class="maroon">"id"</span>: <span class="maroon">""</span>,
      <span class="maroon">"code"</span>: <span class="maroon">"ECA"</span>,
      <span class="maroon">"name"</span>: <span class="maroon">"Europe &amp; Central Asia (developing only)"</span>
    },
    { <span class="maroon">"id"</span>: <span class="maroon">"2"</span>,
      <span class="maroon">"code"</span>: <span class="maroon">"ECS"</span>,
      <span class="maroon">"name"</span>: <span class="maroon">"Europe &amp; Central Asia (all income levels)"</span>
    },</pre><p>The first object in the array supports paging through a large data set, which isn’t important for us now. The second element is an array with the information we need: the list of regions. There are 22 regions in total, but many overlap. We’ll want to pick from the total number of regions so that we both include all the world’s <a id="iddle1003" class="indexterm"/><a id="iddle1021" class="indexterm"/><a id="iddle1416" class="indexterm"/><a id="iddle1473" class="indexterm"/><a id="iddle1499" class="indexterm"/><a id="iddle1822" class="indexterm"/>countries and don’t have any country in multiple regions. The regions that meet these criteria are conveniently marked with an <code class="literal">id</code> property, so we’ll select from the list only those regions whose <code class="literal">id</code> property is not <code class="literal">null</code>.</p></div><div class="sect2" title="Step 2: Get the First Level of Data via AJAX"><div class="titlepage"><div><div><h3 class="title" id="step_2_get_the_first_level_of_data_via_a">Step 2: Get the First Level of Data via AJAX</h3></div></div></div><p>Now that you understand the data format (so far), let’s write some code to retrieve the data. Since we have jQuery loaded, we’ll take advantage of many of its utilities. Let’s start at the simplest level and work up to a full implementation.</p><p>As you might expect, the $<code class="literal">.getJSON()</code> function will do most of the work for us. The simplest way to use that function might be something like the following:</p><a id="pro_id00093"/><pre class="programlisting">   <span class="steelblue">$</span>.<span class="olive">getJSON</span>(
       <span class="maroon">"http://api.worldbank.org/regions/"</span>,
➊     {<span class="dodgerblue">format</span>: <span class="maroon">"json"</span>},
       <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(response) {
           <span class="indianred"><span class="emphasis"><em>// Do something with response</em></span></span>
       }
   );</pre><p>Note that we’re adding <code class="literal">format: "json"</code> to the query at ➊ to tell the World Bank what format we want. Without that parameter, the server returns XML, which isn’t at all what <code class="literal">getJSON()</code> expects.</p><p>Unfortunately, that code won’t work with the current web servers supplying the World Bank data. In fact, this problem is very common today. As is often the case with the Web, security concerns are the source of the complication. Consider the information flow we’re establishing, shown in <a class="xref" href="ch02.html#our_server_left_parenthesisyourdotweb" title="Figure 2-15. Our server (your.web.site.com) sends a web page—including scripts—to the user, and those scripts, executing in the user’s browser, query the World Bank site (api.worldbank.com).">Figure 2-15</a>.</p><div class="figure"><a id="our_server_left_parenthesisyourdotweb"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00041"/><img src="figs/web/02fig15.png.jpg" alt="Our server (your.web.site.com) sends a web page—including scripts—to the user, and those scripts, executing in the user’s browser, query the World Bank site (api.worldbank.com)."/></div></div><div class="figure-title">Figure 2-15. Our server <span class="emphasis"><em>(your.web.site.com)</em></span> sends a web page—including scripts—to the user, and those scripts, executing in the user’s browser, query the World Bank site (<span class="emphasis"><em>api.worldbank.com</em></span>).</div></div><p><a id="iddle1403" class="indexterm"/><a id="iddle1417" class="indexterm"/><a id="iddle1549" class="indexterm"/><a id="iddle1779" class="indexterm"/><a id="iddle1832" class="indexterm"/>Getting data using AJAX often requires the cooperation of three different systems.</p><p>The script’s communication with the World Bank is invisible to users, so they have no chance to approve or refuse the exchange. In the case of the World Bank, it’s hard to imagine any reason for users to reject the query, but what if our script were accessing users’ social network profile or, more seriously, their online banking site? In such cases user concerns would be justified. Because the communication is invisible to the user, and because the web browser cannot guess which communications might be sensitive, the browser simply prohibits all such communications. The technical term for this is <span class="emphasis"><em>same-origin policy</em></span>. This policy means that web pages that our server provides cannot directly access the World Bank’s JSON interface.</p><p>Some websites address this problem by adding an HTTP header in their responses. The header tells the browser that it’s safe for any web page to access this data:</p><a id="pro_id00094"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>Access-Control-Allow-Origin</strong></span></span>: *</pre><p>Unfortunately, as of this writing, the World Bank has not implemented this header. The option is relatively new, so it’s missing from many web servers. To work within the constraints of the same-origin policy, therefore, we rely on jQuery’s help and a small bit of trickery. The trick relies on the one exception to the same-origin policy that all browsers recognize: third-party JavaScript files. Browsers do allow web pages to request JavaScript files from third-party servers (that is, after all, how services such as Google Analytics can work). We just need to make the response data from the World Bank look like regular JavaScript instead of JSON. Fortunately, the World Bank cooperates with us in this minor deception. We simply add two query parameters to our request:</p><a id="pro_id00095"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>?format</strong></span></span>=jsonP<span class="steelblue"><span class="strong"><strong>&amp;</strong></span></span><span class="steelblue">prefix=</span>Getdata</pre><p>The <code class="literal">format</code> parameter with a value of <code class="literal">jsonP</code> tells the World Bank that we want the response formatted as <span class="emphasis"><em>JSON with padding</em></span>, which is a variant of JSON that is also regular JavaScript. The second parameter, <code class="literal">prefix</code>, tells the World Bank the name of the function that will accept the data. (Without that information, the JavaScript that the World Bank constructs wouldn’t know how to communicate with our code.) It’s a bit messy, but jQuery handles most of the details for us. The only catch is that we have to add <code class="literal">?</code><span class="emphasis"><em><code class="literal">something</code></em></span><code class="literal">=?</code> to the URL we pass to <code class="literal">.getJSON()</code>, where <span class="emphasis"><em><code class="literal">something</code></em></span> is whatever the web service requires for its JSONP response. The World Bank expects <code class="literal">prefix</code>, but a more common value is <code class="literal">callback</code>.</p><p>Now we can put together some code that will work with the World Bank and many other web servers, although the parameter <code class="literal">prefix</code> is specific to the World Bank.</p><a id="pro_id00096"/><pre class="programlisting">   <span class="steelblue">$</span>.<span class="olive">getJSON</span>(
➊     <span class="maroon">"http://api.worldbank.org/regions/?prefix=?"</span>,
➋     {<span class="dodgerblue">format</span>: <span class="maroon">"jsonp"</span>},
       <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(response) {
           <span class="indianred"><span class="emphasis"><em>// Do something with response</em></span></span>
       }
   );</pre><p><a id="iddle1256" class="indexterm"/><a id="iddle1418" class="indexterm"/><a id="iddle1550" class="indexterm"/>We’ve added the <code class="literal">prefix</code> directly in the URL at ➊, and we’ve changed the format to <code class="literal">jsonp</code> at ➋.</p><p>JSONP does suffer from one major shortcoming: there is no way for the server to indicate an error. That means we should spend extra time testing and debugging any JSONP requests, and we should be vigilant about any changes in the server that might cause previously functioning code to fail. Eventually the World Bank will update the HTTP headers in its responses (perhaps even by the time of this book’s publication), and we can switch to the more robust JSON format.</p><div class="note" title="Note"><h3 class="title"><a id="ch02note02"/>Note</h3><p><span class="strong"><strong>At the time of this writing, the World Bank has a significant bug in its API. The server doesn’t preserve the case (uppercase versus lowercase) of the callback function. The full source code for this example includes a work-around for the bug, but you’re unlikely to need that for other servers. Just in case, though, you can look at the comments in the source code for a complete documentation of the fix.</strong></span></p></div><p>Now let’s get back to the code itself. In the preceding snippet, we’re defining a callback function directly in the call to <code class="literal">.getJSON()</code>. You’ll see this code structure in many implementations. This certainly works, but if we continue along these lines, things are going to get quite messy very soon. We’ve already added a couple of layers of indentation before we even start processing the response. As you can guess, once we get this initial response, we’ll need to make several more requests for additional data. If we try to build our code in one monolithic block, we’ll end up with so many levels of indentation that there won’t be any room for actual code. More significantly, the result would be one massive interconnected block of code that would be challenging to understand, much less debug or enhance.</p><p>Fortunately, jQuery gives us the tool for a much better approach: the <code class="literal">$.Deferred</code> object. A <code class="literal">Deferred</code> object acts as a central dispatcher and scheduler for events. Once the <code class="literal">Deferred</code> object is created, different parts of our code indicate that they want to know when the event completes, while other parts of our code signal the event’s status. <code class="literal">Deferred</code> coordinates all those different activities, letting us separate how we trigger and manage events from dealing with their consequences.</p><p>Let’s see how to improve our AJAX request with <code class="literal">Deferred</code> objects. Our main goal is to separate the initiation of the event (the AJAX request) from dealing with its consequences (processing the response). With that separation, we won’t need a success function as a callback parameter to the request itself. Instead, we’ll rely on the fact that the <code class="literal">.getJSON()</code> call returns a <code class="literal">Deferred</code> object. (Technically, the function returns a restricted form of the <code class="literal">Deferred</code> object known as a <code class="literal">promise</code>; the differences aren’t important for us now, though.) We want to save that returned object in a variable.</p><a id="pro_id00097"/><pre class="programlisting"><span class="indianred"><span class="emphasis"><em>// Fire off the query and retain the deferred object tracking it</em></span></span>
deferredRegionsRequest = <span class="steelblue">$</span>.<span class="olive">getJSON</span>(
    <span class="maroon">"http://api.worldbank.org/regions/?prefix=?"</span>,
    {<span class="dodgerblue">format</span>: <span class="maroon">"jsonp"</span>}
);</pre><p><a id="iddle1007" class="indexterm"/><a id="iddle1009" class="indexterm"/><a id="iddle1022" class="indexterm"/><a id="iddle1257" class="indexterm"/><a id="iddle1282" class="indexterm"/><a id="iddle1322" class="indexterm"/><a id="iddle1474" class="indexterm"/><a id="iddle1500" class="indexterm"/><a id="iddle1823" class="indexterm"/>That’s simple and straightforward. Now, in a different part of our code, we can indicate our interest in knowing when the AJAX request is complete.</p><a id="pro_id00098"/><pre class="programlisting"><span class="steelblue">deferredRegionsRequest</span>.<span class="olive">done</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(response) {
    <span class="indianred"><span class="emphasis"><em>// Do something with response</em></span></span>
});</pre><p>The <code class="literal">done()</code> method of the <code class="literal">Deferred</code> object is key. It specifies a new function that we want to execute whenever the event (in this case the AJAX request) successfully completes. The <code class="literal">Deferred</code> object handles all the messy details. In particular, if the event is already complete by the time we get around to registering the callback via <code class="literal">done()</code>, the <code class="literal">Deferred</code> object executes that callback immediately. Otherwise, it waits until the request is complete. We can also express an interest in knowing if the AJAX request fails; instead of <code class="literal">done()</code>, we use the <code class="literal">fail()</code> method for this. (Even though JSONP doesn’t give the server a way to report errors, the request itself could still fail.)</p><a id="pro_id00099"/><pre class="programlisting"><span class="steelblue">deferredRegionsRequest</span>.<span class="olive">fail</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {
    <span class="indianred"><span class="emphasis"><em>// Oops, our request for region information failed</em></span></span>
});</pre><p>We’ve obviously reduced the indentation to a more manageable level, but we’ve also created a much better structure for our code. The function that makes the request is separate from the code that handles the response. That’s much cleaner, and it’s definitely easier to modify and debug.</p></div><div class="sect2" title="Step 3: Process the First Level of Data"><div class="titlepage"><div><div><h3 class="title" id="step_3_process_the_first_level_of_data">Step 3: Process the First Level of Data</h3></div></div></div><p>Now let’s tackle processing the response. The paging information isn’t relevant, so we can skip right to the second element in the returned response. We want to process that array in two steps.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Filter out any elements in the array that aren’t relevant to us. In this case we’re interested only in regions that have an <code class="literal">id</code> property that isn’t <code class="literal">null</code>.</p></li><li class="listitem"><p>Transform the elements in the array so that they contain only the properties we care about. For this example, we need only the <code class="literal">code</code> and <code class="literal">name</code> properties.</p></li></ol></div><p>This probably sounds familiar. In fact, it’s exactly what we needed to do in this chapter’s first example. As we saw there, jQuery’s <span class="emphasis"><em><code class="literal">$</code></em></span><code class="literal">.map() and</code> <span class="emphasis"><em><code class="literal">$</code></em></span><code class="literal">.grep()</code> functions are a big help.</p><p>Taking these steps one at a time, here’s how to filter out irrelevant data from the response.</p><a id="pro_id00100"/><pre class="programlisting">filtered = <span class="steelblue">$</span>.<span class="olive">grep</span>(response[<span class="red">1</span>], <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(regionObj) {
    <span class="steelblue"><span class="strong"><strong>return</strong></span></span> (<span class="steelblue">regionObj</span>.<span class="olive">id</span> !== <span class="steelblue"><span class="strong"><strong>null</strong></span></span>);
});</pre><p><a id="iddle1024" class="indexterm"/><a id="iddle1258" class="indexterm"/><a id="iddle1419" class="indexterm"/><a id="iddle1502" class="indexterm"/><a id="iddle1825" class="indexterm"/>And here’s how to transform the elements to retain only relevant properties. And as long as we’re doing that, let’s get rid of the parenthetical “(all income levels)” that the World Bank appends to some region names. All of our regions (those with an <code class="literal">id</code>) include all income levels, so this information is superfluous.</p><a id="pro_id00101"/><pre class="programlisting">regions = <span class="steelblue">$</span>.<span class="olive">map</span>(filtered, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(regionObj) {
        <span class="steelblue"><span class="strong"><strong>return</strong></span></span> {
            <span class="dodgerblue">code</span>: <span class="steelblue">regionObj</span>.<span class="olive">code</span>,
            <span class="dodgerblue">name</span>: <span class="steelblue">regionObj</span>.<span class="steelblue">name</span>.<span class="olive">replace</span>(<span class="maroon">" (all income levels)"</span>,<span class="maroon">""</span>)
        };
    }
);</pre><p>There’s no need to make these separate steps. We can combine them in a nice, concise expression.</p><a id="pro_id00102"/><pre class="programlisting"><span class="steelblue">deferredRegionsRequest</span>.<span class="olive">done</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(response) {
    regions = <span class="steelblue">$</span>.<span class="olive">map</span>(
        <span class="steelblue">$</span>.<span class="olive">grep</span>(response[<span class="red">1</span>], <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(regionObj) {
            <span class="steelblue"><span class="strong"><strong>return</strong></span></span> (<span class="steelblue">regionObj</span>.<span class="olive">id</span> !== <span class="steelblue"><span class="strong"><strong>null</strong></span></span>);
        }),
        <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(regionObj) {
            <span class="steelblue"><span class="strong"><strong>return</strong></span></span> {
                <span class="dodgerblue">code</span>: <span class="steelblue">regionObj</span>.<span class="olive">code</span>,
                <span class="dodgerblue">name</span>: <span class="steelblue">regionObj</span>.<span class="steelblue">name</span>.<span class="olive">replace</span>(<span class="maroon">" (all income levels)"</span>,<span class="maroon">""</span>)
            };
        }
    );
});</pre></div><div class="sect2" title="Step 4: Get the Real Data"><div class="titlepage"><div><div><h3 class="title" id="step_4_get_the_real_data">Step 4: Get the Real Data</h3></div></div></div><p>At this point, of course, all we’ve managed to retrieve is the list of regions. That’s not the data we want to visualize. Usually, getting the real data through a web-based interface requires (at least) two request stages. The first request just gives you the essential information for subsequent requests. In this case, the real data we want is the GDP, so we’ll need to go through our list of regions and retrieve that data for each one.</p><p>Of course we can’t just blindly fire off the second set of requests, in this case for the detailed region data. First, we have to wait until we have the list of regions. In Step 2 we dealt with a similar situation by using <code class="literal">.getJSON()</code> with a <code class="literal">Deferred</code> object to separate event management from processing. We can use the same technique here; the only difference is that we’ll have to create our own <code class="literal">Deferred</code> object.</p><a id="pro_id00103"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> deferredRegionsAvailable = <span class="steelblue">$</span>.<span class="olive">Deferred</span>();</pre><p><a id="iddle1283" class="indexterm"/><a id="iddle1818" class="indexterm"/>Later, when the region list is available, we indicate that status by calling the object’s <code class="literal">resolve()</code> method.</p><a id="pro_id00104"/><pre class="programlisting"><span class="steelblue">deferredRegionsAvailable</span>.<span class="olive">resolve</span>();</pre><p>The actual processing is handled by the <code class="literal">done()</code> method.</p><a id="pro_id00105"/><pre class="programlisting"><span class="steelblue">deferredRegionsAvailable</span>.<span class="olive">done</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {
    <span class="indianred"><span class="emphasis"><em>// Get the region data</em></span></span>
});</pre><p>The code that gets the actual region data needs the list of regions, of course. We could pass that list around as a global variable, but that would be polluting the global namespace. (And even if you’ve properly namespaced your application, why pollute your own namespace?) This problem is easy to solve. Any arguments we provide to the <code class="literal">resolve()</code> method are passed straight to the <code class="literal">done()</code> function.</p><p>Let’s take a look at the big picture so we can see how all the pieces fit together.</p><a id="pro_id00106"/><pre class="programlisting">   <span class="indianred"><span class="emphasis"><em>// Request the regions list and save status of the request in a Deferred object</em></span></span>
➊ <span class="steelblue"><span class="strong"><strong>var</strong></span></span> deferredRegionsRequest = <span class="steelblue">$</span>.<span class="olive">getJSON</span>(
       <span class="maroon">"http://api.worldbank.org/regions/?prefix=?"</span>,
       {<span class="dodgerblue">format</span>: <span class="maroon">"jsonp"</span>}
   );

   <span class="indianred"><span class="emphasis"><em>// Create a second Deferred object to track when list processing is complete</em></span></span>
➋ <span class="steelblue"><span class="strong"><strong>var</strong></span></span> deferredRegionsAvailable = <span class="steelblue">$</span>.<span class="olive">Deferred();</span>

   <span class="indianred"><span class="emphasis"><em>// When the request finishes, start processing</em></span></span>
➌ <span class="steelblue">deferredRegionsRequest</span>.<span class="olive">done</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(response) {
       <span class="indianred"><span class="emphasis"><em>// When we finish processing, resolve the second Deferred with the results</em></span></span>
➍     <span class="steelblue">deferredRegionsAvailable</span>.<span class="olive">resolve</span>(
           <span class="steelblue">$</span>.<span class="olive">map</span>(
               <span class="steelblue">$</span>.<span class="olive">grep</span>(response[<span class="red">1</span>], <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(regionObj) {
                   <span class="steelblue"><span class="strong"><strong>return</strong></span></span> (<span class="steelblue">regionObj</span>.<span class="olive">id</span> != <span class="maroon">""</span>);
               }),
               <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(regionObj) {
                   <span class="steelblue"><span class="strong"><strong>return</strong></span></span> {
                       <span class="dodgerblue">code</span>: <span class="steelblue">regionObj</span>.<span class="olive">code</span>,
                       <span class="dodgerblue">name</span>: <span class="steelblue">regionObj</span>.<span class="steelblue">name</span>.<span class="olive">replace</span>(<span class="maroon">" (all income levels)"</span>,<span class="maroon">""</span>)
                   };
               }
           )
       );
   });
   <span class="steelblue">deferredRegionsAvailable</span>.<span class="olive">done</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(regions) {
➎     <span class="indianred"><span class="emphasis"><em>// Now we have the regions, go get the data</em></span></span>
   });</pre><p><a id="iddle1259" class="indexterm"/><a id="iddle1301" class="indexterm"/>First, starting at ➊, we request the list of regions. Then, at ➋, we create a second <code class="literal">Deferred</code> object to track our processing of the response. In the block starting at ➌, we handle the response from our initial request. Most importantly, we resolve the second <code class="literal">Deferred</code> object, at ➍, to signal that our processing is complete. Finally, starting at ➎, we can begin processing the response.</p><p>Retrieving the actual GDP data for each region requires a new AJAX request. As you might expect, we’ll save the <code class="literal">Deferred</code> objects for those requests so we can process the responses when they’re available. The jQuery <code class="literal">.each()</code> function is a convenient way to iterate through the list of regions to initiate these requests.</p><a id="pro_id00107"/><pre class="programlisting">   <span class="steelblue">deferredRegionsAvailable</span>.<span class="olive">done</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(regions) {
       <span class="steelblue">$</span>.<span class="olive">each</span>(regions, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(idx, regionObj) {
           <span class="steelblue">regionObj</span>.<span class="olive">deferredDataRequest</span> = <span class="steelblue">$</span>.<span class="olive">getJSON</span>(
               <span class="maroon">"http://api.worldbank.org/countries/"</span>
                  + <span class="steelblue">regionObj</span>.<span class="olive">code</span>
➊                + <span class="maroon">"/indicators/NY.GDP.MKTP.CD"</span>
                  + <span class="maroon">"?prefix=?"</span>,
               { <span class="dodgerblue">format</span>: <span class="maroon">"jsonp"</span>, <span class="dodgerblue">per_page</span>: <span class="red">9999</span> }
           );
       });
   });</pre><p>The “<code class="literal">NY.GDP.MKTP.CD</code>” part of each request URL at ➊ is the World Bank’s code for GDP data.</p><p>As long as we’re iterating through the regions, we can include the code to process the GDP data. By now it won’t surprise you that we’ll create a <code class="literal">Deferred</code> object to track when that processing is complete. The processing itself will simply store the returned response (after skipping past the paging information) in the region object.</p><a id="pro_id00108"/><pre class="programlisting">   <span class="steelblue">deferredRegionsAvailable</span>.<span class="olive">done</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(regions) {
       <span class="steelblue">$</span>.<span class="olive">each</span>(regions, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(idx, regionObj) {
           <span class="steelblue">regionObj</span>.<span class="olive">deferredDataRequest</span> = <span class="steelblue">$</span>.<span class="olive">getJSON</span>(
               <span class="maroon">"http://api.worldbank.org/countries/"</span>
                  + <span class="steelblue">regionObj</span>.<span class="olive">code</span>
                  + <span class="maroon">"/indicators/NY.GDP.MKTP.CD"</span>
                  + <span class="maroon">"?prefix=?"</span>,
               { <span class="dodgerblue">format</span>: <span class="maroon">"jsonp"</span>, <span class="dodgerblue">per_page</span>: <span class="red">9999</span> }
           );
           <span class="steelblue">regionObj</span>.<span class="olive">deferredDataAvailable</span> = <span class="steelblue">$</span>.<span class="olive">Deferred</span>();
           <span class="steelblue">regionObj</span>.<span class="steelblue">deferredDataRequest</span>.<span class="olive">done</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(response) {
➊             <span class="steelblue">regionObj</span>.<span class="olive">rawData</span> = response[<span class="red">1</span>] || [];
               <span class="steelblue">regionObj</span>.<span class="steelblue">deferredDataAvailable</span>.<span class="olive">resolve</span>();
           });
       });
   });</pre><p><a id="iddle1023" class="indexterm"/><a id="iddle1354" class="indexterm"/><a id="iddle1427" class="indexterm"/><a id="iddle1501" class="indexterm"/><a id="iddle1622" class="indexterm"/><a id="iddle1824" class="indexterm"/><a id="iddle2155" class="indexterm"/>Note that we’ve also added a check at ➊ to make sure the World Bank actually returns data in its response. Possibly due to internal errors, it may return a <code class="literal">null</code> object instead of the array of data. When that happens, we’ll set the <code class="literal">rawData</code> to an empty array instead of <code class="literal">null</code>.</p></div><div class="sect2" title="Step 5: Process the Data"><div class="titlepage"><div><div><h3 class="title" id="step_5_process_the_data">Step 5: Process the Data</h3></div></div></div><p>Now that we’ve requested the real data, it’s almost time to process it. There is a final hurdle to overcome, and it’s a familiar one. We can’t start processing the data until it’s available, which calls for defining one more <code class="literal">Deferred</code> object and resolving that object when the data is complete. (By now it’s probably sinking in just how handy <code class="literal">Deferred</code> objects can be.)</p><p>There is one little twist, however. We’ve now got multiple requests in progress, one for each region. How can we tell when all of those requests are complete? Fortunately, jQuery provides a convenient solution with the <code class="literal">.when()</code> function. That function accepts a list of <code class="literal">Deferred</code> objects and indicates success only when all of the objects have succeeded. We just need to pass that list of <code class="literal">Deferred</code> objects to the <code class="literal">.when()</code> function.</p><p>We could assemble an array of <code class="literal">Deferred</code> objects using the <code class="literal">.map()</code> function, but <code class="literal">.when()</code> expects a parameter list, not an array. Buried deep in the JavaScript standard is a technique for converting an array to a list of function parameters. Instead of calling the function directly, we execute the <code class="literal">.when()</code> function’s <code class="literal">apply()</code> method. That method takes, as its parameters, the context (<code class="literal">this</code>) and an array.</p><p>Here’s the <code class="literal">.map()</code> function that creates the array.</p><a id="pro_id00109"/><pre class="programlisting"><span class="steelblue">$</span>.<span class="olive">map</span>(regions, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(regionObj) {
    <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue">regionObj</span>.<span class="olive">deferredDataAvailable</span>
<span class="strong"><strong>})</strong></span></pre><p>And here’s how we pass it to <code class="literal">when()</code> as a parameter list.</p><a id="pro_id00110"/><pre class="programlisting"><span class="steelblue">$</span>.<span class="steelblue">when</span>.<span class="olive">apply</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>,<span class="steelblue">$</span>.<span class="olive">map</span>(regions, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(regionObj) {
    <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue">regionObj</span>.<span class="olive">deferredDataAvailable</span>
}));</pre><p>The <code class="literal">when()</code> function returns its own <code class="literal">Deferred</code> object, so we can use the methods we already know to process its completion. Now we finally have a complete solution for retrieving the World Bank data.</p><p>With our data safely in hand, we can now coerce it into a format that Flot accepts. We extract the <code class="literal">date</code> and <code class="literal">value</code> properties from the raw data. We also have to account for gaps in the data. The World Bank doesn’t have GDP data for every region for every year. When it’s missing data for a particular year, it returns <code class="literal">null</code> for <code class="literal">value</code>. The same combination of <code class="literal">.grep()</code> and <code class="literal">.map()</code> that we used before will serve us once again.</p><a id="pro_id00111"/><pre class="programlisting">   <span class="steelblue">deferredAllDataAvailable</span>.<span class="olive">done</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(regions) {
➊     <span class="steelblue">$</span>.<span class="olive">each</span>(regions, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(idx, regionObj) {
➋         <span class="steelblue">regionObj</span>.<span class="olive">flotData</span> = <span class="steelblue">$</span>.<span class="olive">map</span>(
➌             <span class="steelblue">$</span>.<span class="olive">grep</span>(<span class="steelblue">regionObj</span>.<span class="olive">rawData</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(dataObj) {
                   <span class="steelblue"><span class="strong"><strong>return</strong></span></span> (<span class="steelblue">dataObj</span>.<span class="olive">value</span> !== <span class="steelblue"><span class="strong"><strong>null</strong></span></span>);
               }),
➍             <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(dataObj) {
                   <span class="steelblue"><span class="strong"><strong>return</strong></span></span> [[
➎                     <span class="olive">parseInt</span>(<span class="steelblue">dataObj</span>.<span class="olive">date</span>),
➏                     <span class="olive">parseFloat</span>(<span class="steelblue">dataObj</span>.<span class="olive">value</span>)/<span class="red">1e12</span>
                   ]];
               }
           )
       })
   });</pre><p><a id="iddle1020" class="indexterm"/><a id="iddle1302" class="indexterm"/><a id="iddle1498" class="indexterm"/><a id="iddle1821" class="indexterm"/>As you can see, we’re iterating through the list of regions with the <code class="literal">.each()</code> function at ➊. For each region, we create an object of data for the Flot library. (No points for originality in naming that object <code class="literal">flotData</code> at ➋.) Then we filter the data starting at ➌ to eliminate any data points with <code class="literal">null</code> values. The function that creates our Flot data array starts at ➍. It takes, as input, a single data object from the World Bank, and returns the data as a two-dimensional data point. The first value is the date, which we extract as an integer at ➎, and the second value is the GDP data, which we extract as a floating-point number at ➏. Dividing by <code class="literal">1e12</code> converts the GDP data to trillions.</p></div><div class="sect2" title="Step 6: Create the Chart"><div class="titlepage"><div><div><h3 class="title" id="step_6_create_the_chart">Step 6: Create the Chart</h3></div></div></div><p>Since we’ve made it this far with a clear separation between code that handles events and code that processes the results, there’s no reason not to continue the approach when we actually create the chart. Yet another <code class="literal">Deferred</code> object creates that separation.</p><a id="pro_id00112"/><pre class="programlisting">   <span class="steelblue"><span class="strong"><strong>var</strong></span></span> deferredChartDataReady = <span class="steelblue">$</span>.<span class="olive">Deferred</span>();

   <span class="steelblue">deferredAllDataAvailable</span>.<span class="olive">done</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(regions) {
       <span class="steelblue">$</span>.<span class="olive">each</span>(regions, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(idx, regionObj) {
           <span class="steelblue">regionObj</span>.<span class="olive">flotData</span> = <span class="steelblue">$</span>.<span class="olive">map</span>(
               <span class="steelblue">$</span>.<span class="olive">grep</span>(<span class="steelblue">regionObj</span>.<span class="olive">rawData</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(dataObj) {
                   <span class="steelblue"><span class="strong"><strong>return</strong></span></span> (<span class="steelblue">dataObj</span>.<span class="olive">value</span> !== <span class="steelblue"><span class="strong"><strong>null</strong></span></span>);
               }),
               <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(dataObj) {
                   <span class="steelblue"><span class="strong"><strong>return</strong></span></span> [[
                       <span class="olive">parseInt</span>(<span class="steelblue">dataObj</span>.<span class="olive">date</span>),
                       <span class="olive">parseFloat</span>(<span class="steelblue">dataObj</span>.<span class="olive">value</span>)/<span class="red">1e12</span>
                   ]];
               }
           )
       })
➊     <span class="steelblue">deferredChartDataReady</span>.<span class="olive">resolve</span>(regions);
   });
   <span class="steelblue">deferredChartDataReady</span>.<span class="olive">done</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(regions) {
       <span class="indianred"><span class="emphasis"><em>// Draw the chart</em></span></span>
   });</pre><p><a id="iddle1260" class="indexterm"/><a id="iddle1623" class="indexterm"/>Here we’ve taken the preceding code fragments and wrapped them in <code class="literal">Deferred</code> object handling. Once all of the data has been processed, we resolve that <code class="literal">Deferred</code> object at ➊.</p><p>The entire process is reminiscent of a frog hopping between lily pads in a pond. The pads are the processing steps, and <code class="literal">Deferred</code> objects are the bridges between them (<a class="xref" href="ch02.html#deferred_objects_help_keep_each_bit_of_c" title="Figure 2-16. Deferred objects help keep each bit of code isolated to its own pad.">Figure 2-16</a>).</p><div class="figure"><a id="deferred_objects_help_keep_each_bit_of_c"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00042"/><img src="figs/web/02fig16.png.jpg" alt="Deferred objects help keep each bit of code isolated to its own pad."/></div></div><div class="figure-title">Figure 2-16. <code class="literal">Deferred</code> objects help keep each bit of code isolated to its own pad.</div></div><p>The real benefit to this approach is its separation of concerns. Each processing step remains independent of the others. Should any step require changes, there’s no need to look at the others. Each lily pad, in effect, remains its own island without concern for the rest of the pond.</p><p>Once we’re at the final step, we can use any or all of the techniques from this chapter’s other examples to draw the chart. Once again, the <code class="literal">.map()</code> function can easily extract relevant information from the region data. Here is a basic example:</p><a id="pro_id00113"/><pre class="programlisting"><span class="steelblue">deferredChartDataReady</span>.<span class="olive">done</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(regions) {
    <span class="steelblue">$</span>.<span class="olive">plot</span>(<span class="olive">$</span>(<span class="maroon">"#chart"</span>),
        <span class="steelblue">$</span>.<span class="olive">map</span>(regions, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(regionObj) {
            <span class="steelblue"><span class="strong"><strong>return</strong></span></span> {
                <span class="dodgerblue">label</span>: <span class="steelblue">regionObj</span>.<span class="olive">name</span>,
                <span class="dodgerblue">data</span>: <span class="steelblue">regionObj</span>.<span class="olive">flotData</span>
            };
        })
        ,{ <span class="dodgerblue">legend</span>: { <span class="dodgerblue">position</span>: <span class="maroon">"nw"</span>} }
    );
});</pre><p><a id="iddle1036" class="indexterm"/><a id="iddle1037" class="indexterm"/><a id="iddle1245" class="indexterm"/><a id="iddle1780" class="indexterm"/>Our basic chart now gets its data directly from the World Bank. We no longer have to manually process its data, and our charts are updated automatically whenever the World Bank updates its data (<a class="xref" href="ch02.html#with_ajax_we_can_graph_live_data_from_an" title="Figure 2-17. With AJAX we can graph live data from another site in the user’s browser.">Figure 2-17</a>).</p><div class="figure"><a id="with_ajax_we_can_graph_live_data_from_an"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00043"/><img src="figs/web/02fig17.png.jpg" alt="With AJAX we can graph live data from another site in the user’s browser."/></div></div><div class="figure-title">Figure 2-17. With AJAX we can graph live data from another site in the user’s browser.</div></div><p>In this example you’ve seen how to access the World Bank’s application programming interface. The same approach works for many other organizations that provide data on the Internet. In fact, there are so many data sources available today that it can be difficult to keep track of them all.</p><p>Here are two helpful websites that serve as a central repository for both public and private APIs accessible on the Internet:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>APIhub (<span class="emphasis"><em><a class="ulink" href="http://www.apihub.com/" target="_top">http://www.apihub.com/</a></em></span>)</p></li><li class="listitem"><p>ProgrammableWeb (<span class="emphasis"><em><a class="ulink" href="http://www.programmableweb.com/" target="_top">http://www.programmableweb.com/</a></em></span>)</p></li></ul></div><p>Many governments also provide a directory of available data and APIs. The United States, for example, centralizes its resources at the Data.gov website (<span class="emphasis"><em><a class="ulink" href="http://www.data.gov/" target="_top">http://www.data.gov/</a></em></span>).</p><p>This example focuses on the AJAX interaction, so the resulting chart is a simple, static line chart. Any of the interactions described in the other examples from this chapter could be added to increase the interactivity of the visualization.</p></div></div><div class="sect1" title="Summing Up"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="summing_up-id00011">Summing Up</h2></div></div></div><p>As the examples in this chapter show, we don’t have to be satisfied with static charts on our web pages. A little JavaScript can bring charts to life by letting users interact with them. These interactions give users a chance to see a “big picture” view of the data and, on the same page, look into the specific aspects that are most interesting and relevant to them. We’ve considered techniques that let users select which data series appear on our charts, zoom in on specific chart areas, and use their mouse to explore details of the data without losing sight of the overall view. We’ve also looked at how to get interactive data directly from its source using AJAX and asynchronous programming.</p></div></section></body></html>