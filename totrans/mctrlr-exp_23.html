<html><head></head><body>
<div id="book-content">
<div id="sbo-rt-content"><h2 class="h2a" id="ch23"><span epub:type="pagebreak" id="page_217"/><strong>23  Game Boy Via ROM</strong></h2>&#13;
<p class="indent">Nintendo’s Game Boy, internally known as the Dot Matrix Game (DMG), did not feature the CIC protection chip that we’ll discuss in <a href="ch25.xhtml#ch25">Chapter 25</a>. Instead of a lockout chip, the game cartridge is required to contain Nintendo’s logo.</p>&#13;
<p class="indent">This is enforced by a first-stage boot ROM that compares its own copy of the logo to one in the cartridge. If the logos match, a short animation and sound are presented before the ROM disables itself and jumps into the game cartridge. In this chapter, we’ll take the last chapter’s theory and use it to rip out the ROM contents and make our own disassembly.</p>&#13;
<p class="indent">Perhaps you’ve already realized that anyone can put any logo into a cartridge, and that the logo comparison is not a technical challenge when making an unlicensed game. The enforcement mechanism was not technical; rather, it was Nintendo’s legal counsel, who would gleefully sue the living hell out of anyone who used their trademark without permission. And if you, dear reader, happen to be one of Nintendo’s lawyers, please don’t sue me.</p>&#13;
<p class="indent">Neviksti (2005) describes an extraction of the ROM. I repeated this in my own lab to produce the ROM photograph in <a href="ch23.xhtml#ch23fig5">Figure 23.5</a>. Bits are clearly visible in surface photographs of the die, without any delayering or staining, making this an excellent first target.</p>&#13;
<p class="indent">As with any chemistry, please be careful not to get yourself hurt. The hassles of doing this slowly and safely are worth keeping your eyes and your fingers.</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_218"/><img id="ch23fig1" src="../images/f0218-01.jpg" alt="Image" width="827" height="665"/></div>&#13;
<p class="figcap">Figure 23.1: End of the Game Boy ROM from Neviksti (2005)</p>&#13;
<h3 class="h3" id="ch00lev1sec69"><span epub:type="pagebreak" id="page_219"/><strong>Decapsulation</strong></h3>&#13;
<p class="noindent">To get the ROM, we first need to sacrifice a Game Boy. The CPU is labeled <span class="literal">DMG-CPU B</span>, and you can find it on the board that is closer to the back of the device, away from the LCD.</p>&#13;
<p class="indent">(ROMs of the Game Boy Color and the Super Game Boy are not clearly visible from the surface. See <a href="app05.xhtml#app05_4">Chapter E.4</a> for a glitching attack that keeps the ROM visible while executing code from cartridge memory.)</p>&#13;
<p class="indent">Decapsulation is performed with the HNO<sub>3</sub> bath method from <a href="ch18.xhtml#ch18">Chapter 18</a>. Bits are surface visible, so there’s no need for the delayering procedures that require more dangerous chemicals. We pretty much just boil the whole QFP package in 65% nitric acid until the packaging falls away, then clean it in acetone and isopropyl alcohol for photography.</p>&#13;
<h3 class="h3" id="ch00lev1sec70"><strong>Photography</strong></h3>&#13;
<p class="noindent">The ROM that we’re after is in the CPU, whose surface die photograph is shown in <a href="ch23.xhtml#ch23fig2">Figure 23.2</a>. Bits are impossible to see at that magnification, so see <a href="ch23.xhtml#ch23fig3">Figure 23.3</a> for a closeup.</p>&#13;
<p class="indent">To locate the ROM, first find the memory bus, which is the horizontal nest of wires roughly in the middle of the chip. Starting from the western edge, follow the bus toward the east until it dead-ends at the eastern sea of gates. The ROM is the thin horizontal structure just north of that bus and just west of the sea of gates. At a decent magnification, the bits will pop out at you, looking almost like foreign writing at a distance just too far to resolve.</p>&#13;
<p class="indent">The dark spots are via wires that connect layers vertically, while the bright spots are the absence of a via. This makes the color of the spot imply the value of the bit. Not all vias are bits, of course, but in <a href="ch23.xhtml#ch23fig3">Figure 23.3</a> you should see two columns of eight bits and the first six rows. The vias in the longer metal lines, those that reach the power rail at the top of the image, are not bits and should not be extracted. To be sure that you understand what is and is not a bit, please take a moment to produce the ASCII art table from the photograph.</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_220"/><img id="ch23fig2" src="../images/f0220-01.jpg" alt="Image" width="777" height="647"/></div>&#13;
<p class="figcap">Figure 23.2: Nintendo DMG-01-CPU from a Game Boy</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_221"/><img id="ch23fig3" src="../images/f0221-01.jpg" alt="Image" width="778" height="606"/></div>&#13;
<p class="figcap">Figure 23.3: Close-up of DMG-01-CPU Bits</p>&#13;
<div class="image"><img id="ch23fig4" src="../images/f0221-01a.jpg" alt="Image" width="778" height="131"/></div>&#13;
<p class="figcap">Figure 23.4: Nintendo Logo at <span class="literal">0xA8</span> (ROM) and <span class="literal">0x104</span> (Cart).</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_222"/>After locating the ROM and its bits, I photographed it as a panorama of twenty-two images at 50x magnification through a metallurgical microscope. These images were stitched together with Hugin and Panotools to form a panorama that is 9,000 pixels wide and 2,249 pixels tall. You can find it in reduced resolution as <a href="ch23.xhtml#ch23fig5">Figure 23.5</a>, or as a digital file.<sup><a id="ch23fn_1" href="footnotes.xhtml#ch23fn1">1</a></sup></p>&#13;
<h3 class="h3" id="ch00lev1sec71"><strong>Bit Extraction</strong></h3>&#13;
<p class="noindent">Having a photograph of the chip, the next step is to extract the bits into a textfile.</p>&#13;
<p class="indent">I used Mask ROM Tool for this, drawing lines for each column and row. This ROM is rather small and the stitched image was quite well aligned, so I could place row and column lines that span the entire length of the ROM.</p>&#13;
<p class="indent">The software marks a bit wherever a row and column intersect, and it helpfully draws a histogram of the bits for me to choose a threshold color between ones and zeroes. Both the red and green colors channels have a clear separation between ones and zeroes, but I found that green had a wider gap, so that’s the best channel for sampling. The color I used was that of the pixel at the center of the bit; there was no need for more complicated sampling strategies.</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_223"/><img id="ch23fig5" src="../images/f0223-01.jpg" alt="Image" width="1125" height="560"/></div>&#13;
<p class="figcap">Figure 23.5: ASCII Art of the DMG-01-CPU Bits</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_224"/><img id="ch23fig6" src="../images/f0224-01.jpg" alt="Image" width="689" height="620"/></div>&#13;
<p class="figcap">Figure 23.6: Game Boy Memory Map</p>&#13;
<h3 class="h3" id="ch00lev1sec72"><span epub:type="pagebreak" id="page_225"/><strong>Bit Decoding</strong></h3>&#13;
<p class="noindent">After extracting the physically ordered ASCII art bits in <a href="ch23.xhtml#ch23fig5">Figure 23.5</a>, the next challenge is to decode it. Let’s look at three ways to do that.</p>&#13;
<p class="indent">McMaster (2018) uses this chip as an example for automatically solving bit decoding given known plaintext. The Game Boy uses a Sharp LR35902 CPU, which is roughly like a Z80. Like the Z80, LR35902 code usually sets the stack pointer in the very first instruction with the <span class="literal">0x31</span> opcode. McMaster therefore searches with his Zorrom tool for all decodings in which the first byte comes out as <span class="literal">0x31</span>.</p>&#13;
<div class="imagel"><img src="../images/f0225-01.jpg" alt="Image" width="811" height="112"/></div>&#13;
<p class="indent">These filenames contain the decoding parameters, in which both are rotated 180 <sup>°</sup>C and flipped on the X axis. Bits are inverted, and the only difference is that one uses the <span class="literal">cols-left</span> strategy while the other uses the <span class="literal">cols-downr</span> strategy.</p>&#13;
<p class="indent">He then uses the <span class="literal">unidasm</span> disassembler from MAME to examine each file’s first instruction. The <span class="literal">cols-left</span> variant begins with <span class="literal">31 11 47</span>, setting the stack pointer to <span class="literal">0x4711</span>, while the <span class="literal">cols-downr</span> variant begins with <span class="literal">31 fe ff</span>, setting the stack pointer to <span class="literal">0xfffe</span>. From the memory map in <a href="ch23.xhtml#ch23fig6">Figure 23.6</a>, we can see that the latter is a much more reasonable value, at the tail end of high RAM rather than a random address in the middle of the banked cartridge ROM.</p>&#13;
<p class="indent">We can also perform the same solution with GatoROM.</p>&#13;
<div class="imagel"><img src="../images/f0225-02.jpg" alt="Image" width="811" height="89"/></div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_226"/>Automated tools are great when they work, but we should always be suspicious of tools that we don’t understand. The <span class="literal">cols-downr</span> mode is not very complex; it just means that bytes are encoded in 16-bit logical columns made of two 8-bit physical columns. The leftmost column contains the most significant bits, and the first byte of the row is in the leftmost position. To get the next byte, first work downward and then move everything one step to the right.</p>&#13;
<p class="indent">The tail end of the ROM, shown in disassembly in <a href="ch23.xhtml#ch23fig1">Figure 23.1</a>, disables read access at <span class="literal">0x00fe</span> by writing 1 into the register at <span class="literal">0xff50</span> before continuing into cartridge memory at <span class="literal">0x0100</span>. This is why dumping the ROM is not as simple as building a cartridge to display it on the screen, export it through the link port, or beep it through the speaker.</p>&#13;
</div>
</div>
</body></html>