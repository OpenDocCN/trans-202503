<html><head></head><body>
<h2 class="h2" id="ch07"><span epub:type="pagebreak" id="page_182"/><span class="num">7</span> Tiny Desktop Greenhouse</h2>&#13;
<p class="noindent"><span epub:type="pagebreak" id="page_183"/><span class="red">Greenhouses come in all shapes and sizes, from tiny indoor greenhouses made from plastic sheeting to large industrial greenhouses that span thousands of square feet. Not everyone wants a full-size greenhouse, though, so in this project you’ll build a smaller-scale model that can sit on your desk (</span><a class="red" href="ch07.xhtml#ch07fig01">Figure 7-1</a><span class="red">).</span></p>&#13;
<p class="figuret"><span epub:type="pagebreak" id="page_184"/><a id="ch07fig01"/><strong>FIGURE 7-1:</strong> The Tiny Desktop Greenhouse</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_1.jpg"/></div>&#13;
<p class="indent">In a traditional greenhouse, the panes of transparent glass or plastic allow light energy in to heat up the interior of the greenhouse, and the greenhouse is sealed to trap that warm air inside, resulting in an overall increase in temperature. The danger, of course, is that a greenhouse might become <em>too</em> hot. To regulate temperature, many greenhouses have fans and <em>autovents</em> that open windows at the top of the greenhouse to ventilate when it gets too hot.</p>&#13;
<p class="indent">Your greenhouse will also have an autovent. You’ll build a greenhouse controller that will monitor the temperature, and if it gets too warm, a window will open and a fan will turn on.</p>&#13;
<div class="sidebar">&#13;
<p class="sidebart"><strong>THE GREENHOUSE EFFECT</strong></p>&#13;
<p class="noindent">Greenhouses are warm enough to grow veggies year round because they’re able to trap and store energy. Earth’s atmosphere works similar to a greenhouse. Heat from the sun is radiated by the earth and then reflected and captured by the atmosphere. This unique property is known as the <em>greenhouse effect</em>, and it’s responsible for keeping the temperature of our planet temperate and livable. Without it, the temperature of our planet would average near 0 degrees Fahrenheit (–18 degrees Celsius)!</p>&#13;
<p class="indent">Another common example of the greenhouse effect is a car in the middle of the summer. With the windows closed, the temperature inside the car can rise 20 to 30 degrees higher than the outside temperature. This is why you should never leave your pets in the car—especially in the summer!</p>&#13;
</div>&#13;
<h3 class="h3" id="ch07lev1sec1"><span epub:type="pagebreak" id="page_185"/><strong>MATERIALS TO GATHER</strong></h3>&#13;
<p class="noindent">To lift the autovent, this project uses a servo motor similar to the one you used for the Balance Beam in <a href="ch06.xhtml#ch06">Project 6</a>. We’ll also introduce three new parts in this project: a small DC hobby motor for the fan, a <em>transistor</em> to control the motor, and a <em>temperature sensor</em> to detect the temperature inside the greenhouse.</p>&#13;
<p class="indent">As you gather your parts, you’ll find that the transistor and the temperature sensor look very similar—they’re both small, threelegged devices that have a round, black plastic end with a flat edge (see <a href="ch07.xhtml#ch07fig02">Figure 7-2</a>). To differentiate between them, tilt the flat edge against a light source, and you should see some printing; the temperature sensor should have the letters <em>TMP</em> marked on it. Gather your parts, shown in <a href="ch07.xhtml#ch07fig03">Figures 7-3</a> and <a href="ch07.xhtml#ch07fig04">7-4</a>, and let’s get started!</p>&#13;
<p class="figuret"><a id="ch07fig02"/><strong>FIGURE 7-2:</strong> TMP36 temperature sensor (left) and 2N2222 transistor (right)</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_2.jpg"/></div>&#13;
<h4 class="h4" id="ch07lev2sec1"><strong>Electronic Parts</strong></h4>&#13;
<p class="bull">• One SparkFun RedBoard (DEV-13975), Arduino Uno (DEV-11021), or any other Arduino-compatible board</p>&#13;
<p class="bull">• One USB Mini-B cable (CAB-11301 or your board’s USB cable)</p>&#13;
<p class="bull">• One solderless breadboard (PRT-12002)</p>&#13;
<p class="bull">• One 330 Ω resistor (COM-08377, or COM-11507 for a pack of 20)</p>&#13;
<p class="bull">• One diode (COM-08588)</p>&#13;
<p class="bull">• One NPN transistor—2N2222 or BC337 (COM-13689)</p>&#13;
<p class="bull">• One TMP36 temperature sensor (SEN-10988)</p>&#13;
<p class="bull">• One hobby motor (ROB-11696)</p>&#13;
<div class="noter">&#13;
<p class="notet"><strong>NOTE</strong></p>&#13;
<p class="notep"><em>The parts marked with an asterisk (*) do not come with the standard SparkFun Inventor’s Kit but are available in the separate add-on kit.</em></p>&#13;
</div>&#13;
<p class="bull"><span epub:type="pagebreak" id="page_186"/>• One submicro size servo motor (ROB-09065)</p>&#13;
<p class="bull">• Male-to-male jumper wires (PRT-11026)</p>&#13;
<p class="bull">• Male-to-female jumper wires (PRT-09140*)</p>&#13;
<p class="figuret"><a id="ch07fig03"/><strong>FIGURE 7-3:</strong> Components for the Tiny Desktop Greenhouse</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_3.jpg"/></div>&#13;
<h4 class="h4" id="ch07lev2sec2"><strong>Other Materials and Tools</strong></h4>&#13;
<p class="bull">• Pencil (not shown)</p>&#13;
<p class="bull">• Craft knife</p>&#13;
<p class="bull">• Metal ruler</p>&#13;
<p class="bull">• Ruler</p>&#13;
<p class="bull">• Needle-nose pliers</p>&#13;
<p class="bull">• Wire cutters</p>&#13;
<p class="bull">• Glue (hot glue gun or craft glue)</p>&#13;
<p class="bull">• Masking tape (not shown)</p>&#13;
<p class="bull">• Cardboard (approximately one 11 × 17-inch piece or three 8.5 × 11-inch pieces)</p>&#13;
<p class="bull">• Enclosure template (see <a href="ch07.xhtml#ch07fig18">Figure 7-18</a> on page <a href="ch07.xhtml#page_208">208</a>)</p>&#13;
<p class="bull">• 1 sheet (8.5 × 11 inches) transparency film (not shown)</p>&#13;
<p class="bull">• 1 medium-size paper clip (not shown)</p>&#13;
<p class="figuret"><span epub:type="pagebreak" id="page_187"/><a id="ch07fig04"/><strong>FIGURE 7-4:</strong> Recommended tools and materials</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_4.jpg"/></div>&#13;
<h3 class="h3" id="ch07lev1sec2"><strong>NEW COMPONENTS</strong></h3>&#13;
<p class="noindent">First, let’s take a look at the new components, starting with the temperature sensor.</p>&#13;
<h4 class="h4" id="ch07lev2sec3"><strong>TMP36 Temperature Sensor</strong></h4>&#13;
<p class="noindent">You already know how to measure light levels. With this nifty sensor, you’ll be able to measure temperature as well. The TMP36 is one of the easiest temperature sensors to use. The sensor itself is encased in a small plastic shell shaped like a cylinder with a flat edge, and it has just three pins. (Remember to tilt the flat edge against the light to identify the letters <em>TMP</em> so you don’t mix it up with the transistor. If it says 2N2222 or anything else, it’s the wrong part.)</p>&#13;
<p class="indent">When properly connected to power, the TMP36 sensor will produce a voltage that is directly proportional to the temperature it senses. Similar to how you measured the light level in <a href="ch05.xhtml#ch05">Project 5</a> or the position of the potentiometer in <a href="ch06.xhtml#ch06">Project 6</a>, you can use <code>analogRead()</code> to measure the voltage on this sensor. We’ll show you how to convert this voltage to a temperature reading in this project.</p>&#13;
<h4 class="h4" id="ch07lev2sec4"><strong>Standard Hobby Motor</strong></h4>&#13;
<p class="noindent">To move air through the greenhouse, you’ll build a fan using a small hobby motor, as shown in <a href="ch07.xhtml#ch07fig05">Figure 7-5</a>. This is the simplest type of motor available. When you connect its two wires to a power source, the motor spins, and when you reverse the connections, the motor spins in the opposite direction. Unlike the servo motor that you used <span epub:type="pagebreak" id="page_188"/>in <a href="ch06.xhtml#ch06">Project 6</a>, the hobby motor spins continuously. The hobby motor works with a voltage between 3V and 6V, so it’s perfect for Arduino projects.</p>&#13;
<p class="figuret"><a id="ch07fig05"/><strong>FIGURE 7-5:</strong> Standard DC hobby motor</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_5.jpg"/></div>&#13;
<h4 class="h4" id="ch07lev2sec5"><strong>NPN Transistor</strong></h4>&#13;
<p class="noindent">The invention of the transistor made it possible to create all kinds of digital devices. For example, the microcontroller on the Arduino is actually made up of millions of transistors. Transistors are part of a family of components called <em>semiconductors</em>. A semiconductor is a device that sometimes behaves like a conductor, allowing current to flow, and other times acts like an insulator, preventing current from flowing.</p>&#13;
<p class="indent">This project uses the transistor like a switch by boosting the Arduino’s amp output. The hobby motor uses about 200–300 mA of current, but the Arduino <code>OUTPUT</code> pins are only capable of sourcing about 40 mA of current. Using a simple transistor circuit, we’ll show you how to use the low-current Arduino pin to trigger the transistor to open or close, just like a switch.</p>&#13;
<h3 class="h3" id="ch07lev1sec3"><strong>TAKING A SYSTEMS APPROACH</strong></h3>&#13;
<p class="noindent">For the sake of organization, you’ll build this project as three separate parts, or subsystems. This technique, known as a <em>systems approach</em>, is used by engineers to separate a complex project into manageable sections that can each be built and tested individually. The main components of the three different parts are the temperature sensor, the servo motor (for the autovent), and the DC motor (for the fan). A schematic of the three parts is shown in <a href="ch07.xhtml#ch07fig06">Figure 7-6</a>, and a wiring diagram of the compiled project is shown in <a href="ch07.xhtml#ch07fig07">Figure 7-7</a>.</p>&#13;
<p class="figuret"><span epub:type="pagebreak" id="page_189"/><a id="ch07fig06"/><strong>FIGURE 7-6:</strong> Schematic diagram of the circuit</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_6.jpg"/></div>&#13;
<p class="figuret"><a id="ch07fig07"/><strong>FIGURE 7-7:</strong> Wiring diagram of the circuit</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_7.jpg"/></div>&#13;
<h3 class="h3" id="ch07lev1sec4"><strong>BUILD THE TEMPERATURE MONITOR</strong></h3>&#13;
<p class="noindent">First let’s take a look at the part of the greenhouse control system that will measure temperature. There are a lot of different temperature sensors out there. A few common types that you might encounter are <em>thermistors</em>, which change resistance based on temperature, and <em>thermocouples</em>, which output a really small voltage (less than 10 mV) and require an amplifier circuit to use. The TMP36 device is a third type of sensor that simply outputs a voltage calibrated to be 0.75 V at 25 degrees Celsius. The voltage then varies linearly based on the temperature of its surroundings. This means that as the temperature changes the voltage changes accordingly, as shown in <a href="ch07.xhtml#ch07fig08">Figure 7-8</a>.</p>&#13;
<p class="figuret"><span epub:type="pagebreak" id="page_190"/><a id="ch07fig08"/><strong>FIGURE 7-8:</strong> The linear temperature versus voltage response of the TMP36 sensor</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_8.jpg"/></div>&#13;
<h4 class="h4" id="ch07lev2sec6"><strong>Measure Temperature with the TMP36</strong></h4>&#13;
<p class="noindent">The TMP36 is one of the easiest temperature sensors to use. The sensor is encased in a small plastic shell shaped like a cylinder with a flat edge and has just three pins.</p>&#13;
<p class="indent">As we mentioned earlier, the TMP36 looks very similar to the transistor, which also comes in the SparkFun Inventor’s Kit, so check the flat side of the component by tilting it at an angle under a light source, and look for the letters <em>TMP</em>. If it says <em>2N2222</em> or anything else, it’s the wrong part.</p>&#13;
<p class="indent">The TMP36 provides a voltage output directly related to the temperature in Celsius of its surroundings. Since you already know how to measure voltages using the <code>analogRead()</code> command, this sensor will be easy to use.</p>&#13;
<p class="indent">The outer pins are for ground and power connections, and the center pin is the voltage signal for the sensor. To use the TMP36, simply connect one pin to 5 V, one pin to ground, and the sensing pin to an Arduino analog pin to read the temperature. Pay attention to how you connect the sensor. With the flat edge facing to the left, the top pin should connect to 5 V and the bottom pin should connect to ground. At 25 degrees Celsius, the sensing pin will have a voltage reading of 0.750 V (750 mV). As the temperature changes, the voltage on this pin will change at a rate of 0.010 V (10 mV) per degree Celsius. Now, this might seem like a lot of math-speak, but we’ll show you how to use this information to get an actual temperature reading in your code and convert it to degrees Fahrenheit. But first, let’s wire it up.</p>&#13;
<h4 class="h4" id="ch07lev2sec7"><strong>Connect the Temperature Sensor</strong></h4>&#13;
<p class="noindent"><a href="ch07.xhtml#ch07fig09">Figure 7-9</a> shows the temperature monitor circuit wired up on its own. Most of your components will be on the right side of the breadboard, <span epub:type="pagebreak" id="page_191"/>so connect a jumper wire from 5 V and GND on the Arduino board directly to the power rails on the right side of the breadboard. Next, insert the TMP36 sensor into the lower portion of the breadboard, with the flat side of the sensor facing left, as shown in <a href="ch07.xhtml#ch07fig09">Figure 7-9</a>.</p>&#13;
<p class="figuret"><a id="ch07fig09"/><strong>FIGURE 7-9:</strong> Simplified wiring diagram showing only the temperature sensor</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_9.jpg"/></div>&#13;
<p class="indent">Next, use two short jumper wires to connect the TMP36 sensor’s top pin to 5 V and lower pin to ground, making sure the flat side is facing left. The middle pin is the output voltage of the sensor. Run a jumper wire from this pin to pin A0 on the Arduino board, and that’s it!</p>&#13;
<p class="indent">Now let’s take a look at a code example to see how to get temperature readings from this sensor.</p>&#13;
<h4 class="h4" id="ch07lev2sec8"><strong>Program the Temperature Sensor</strong></h4>&#13;
<p class="noindent">The TMP36 sensor produces a voltage output relative to the ambient temperature. The datasheet for the TMP36 gives a couple of reference points for converting the voltage reading to a temperature: it shows that the voltage changes at a rate of 0.010 V per degree Celsius and that at 25 degrees Celsius, the sensor has a voltage of 0.750 V. Using this information, if you measure the output voltage from the sensor, you can convert this into a temperature reading in the code.</p>&#13;
<p class="indent">You may recall from <a href="ch05.xhtml#ch05">Project 5</a> that the <code>analogRead()</code> function reads voltage as a whole number, with <code>1023</code> for an input of 5 V and <code>0</code> for 0 V. To make sense of this, you’ll need to convert that number to a voltage, then convert that voltage to degrees Celsius, and finally translate that value into Fahrenheit. To keep the code clean, you’ll first write a custom function to do the conversion from the raw <code>analogRead()</code> number to volts.</p>&#13;
<h5 class="h5" id="ch07lev3sec1"><span epub:type="pagebreak" id="page_192"/><strong>Create a Custom Conversion Function</strong></h5>&#13;
<p class="noindent"><a href="ch07.xhtml#ch07ex01">Listing 7-1</a> shows an example of a custom function that will convert the raw <code>analogRead()</code> value and report back an answer that’s been converted to volts.</p>&#13;
<p class="ex-caption"><a id="ch07ex01"/><strong>LISTING 7-1:</strong> Custom function <code>volts()</code> to convert from raw analog value to voltage</p>&#13;
<div class="pre">&#13;
<pre><span class="ent">➊</span> <span class="green">float</span> <span class="ent">➋</span>volts(<span class="ent">➌</span><span class="green">int</span> rawValue)<br/>  {<br/><span class="ent">➍</span>   <span class="green">const</span> <span class="green">float</span> AREF = 5.0;<br/><span class="ent">➎</span>   <span class="green">float</span> calculatedVolts;<br/><span class="ent">➏</span>   calculatedVolts = rawValue * AREF / 1023;<br/><span class="ent">➐</span>   <span class="green1">return</span> <span class="ent">➑</span>calculatedVolts;<br/>  }</pre>&#13;
</div>&#13;
<p class="indent">In <a href="ch03.xhtml#ch03">Project 3</a>, we showed you how to write your own custom functions to shorten your code and make the <code>loop()</code> easier to read. In those examples, the data type of the function was always set as <code>void</code> because the function didn’t report back a value. In this case, you’ll want the function to report back the conversion of <code>analogRead()</code> to volts, so you’ll have to specify a data type. Use the data type <code>float</code> <span class="ent">➊</span>, because you’ll want this function to return the voltage with as many decimal places as possible for accuracy. Name the function <code>volts</code> <span class="ent">➋</span>, to be as descriptive yet concise as possible, and then define the parameter(s) <span class="ent">➌</span> that you pass to this function. In this example, it is the raw value from <code>analogRead()</code>.</p>&#13;
<p class="indent">The math needed to convert between raw <code>analogRead()</code> and voltage is pretty straightforward since, as we mentioned earlier, we already know that the <code>analogRead()</code> function returns <code>1023</code> for an input of 5 V and <code>0</code> for 0 V. This means that an <code>analogRead()</code> value of <code>1023</code> would be equal to 5 V. The custom <code>volts()</code> function uses this ratio to convert a raw <code>analogRead()</code> measurement to a voltage.</p>&#13;
<div class="noter">&#13;
<p class="notet"><strong>NOTE</strong></p>&#13;
<p class="notep"><em>It’s common practice to use ALL CAPS to designate objects or names that are constants.</em></p>&#13;
</div>&#13;
<p class="indent">First, declare a variable to use as a reference, named <code>AREF</code> <span class="ent">➍</span>, and use this to define the reference voltage, which is 5.0 V. Because you’ll want to use it throughout the code, set it as a constant using the keyword <code>const</code>.</p>&#13;
<p class="indent">Next, you’ll define a variable to store the result of the conversion, named <code>calculatedVolts</code> <span class="ent">➎</span>. Notice that the data type for this variable is set as a <code>float</code> as well. You’ll want to make sure that any math you perform is accurate beyond whole numbers. To calculate the voltage, simply multiply the <code>rawCount</code> by the ratio of <code>AREF</code> (5.0 V) to 1,023 <span class="ent">➏</span>.</p>&#13;
<p class="indent">The <code>return</code> instruction <span class="ent">➐</span> is a command we haven’t used in the previous projects. When the sketch gets to the <code>return</code> instruction, it exits the custom <code>volts()</code> function and <em>returns</em> to the point in the code <span epub:type="pagebreak" id="page_193"/>where it was called. When you put a value after the <code>return</code> instruction, the function returns and reports back that value. The <code>return</code> data type must match the data type of the function. For all the functions we’ve used to this point, we didn’t bother to include <code>return</code>, because those functions were defined as <code>void</code> data types and did not report back a value. Here, the <code>return</code> instruction is followed by the variable <code>calculatedVolts</code> <span class="ent">➑</span>. This tells the sketch to report the value of <code>calculatedVolts</code> back to the point in the code where it was called.</p>&#13;
<p class="indent">Note that the <code>return</code> instruction can also be used with functions that have a <code>void</code> data type to instruct the sketch to leave the function and return. In that case, <code>return</code> is left blank with no value following it (see <a href="ch07.xhtml#ch07ex02">Listing 7-2</a>).</p>&#13;
<p class="ex-caption"><a id="ch07ex02"/><strong>LISTING 7-2:</strong> A custom function with a <code>void</code> data type and a <code>return</code> instruction</p>&#13;
<div class="pre">&#13;
<pre><span class="green">void</span> <span class="orange">blink</span>()<br/>{<br/>  <span class="orange">digitalWrite</span>(13, <span class="green">HIGH</span>);<br/>  <span class="orange">delay</span>(500);<br/>  <span class="orange">digitalWrite</span>(13, <span class="green">LOW</span>);<br/>  <span class="orange">delay</span>(500);<br/>  <span class="green1">return</span>;<br/>}</pre>&#13;
</div>&#13;
<h5 class="h5" id="ch07lev3sec2"><strong>Test the Function</strong></h5>&#13;
<p class="noindent">Let’s test the new <code>volts()</code> function with an example sketch. Add a few lines in <code>setup()</code> and <code>loop()</code> to the code from <a href="ch07.xhtml#ch07ex01">Listing 7-1</a> to read the voltage on pin A0, and print it to the Serial Monitor. The complete code example is shown in <a href="ch07.xhtml#ch07ex03">Listing 7-3</a>.</p>&#13;
<p class="ex-caption"><a id="ch07ex03"/><strong>LISTING 7-3:</strong> Testing the analog-to-volts conversion</p>&#13;
<div class="pre">&#13;
<pre><span class="ash">//Example sketch – reads analog input from A0 and prints the</span><br/><span class="ash">//raw analog value and the voltage</span><br/><span class="green">int</span> rawSensorValue;<br/><span class="green">float</span> rawVolts;<br/><br/><span class="green">void</span> <span class="green1">setup</span>()<br/>{<br/>  <span class="orange"><strong>Serial</strong></span>.<span class="orange">begin</span>(9600);  <span class="ash">//initializes the serial communication</span><br/>  <span class="orange"><strong>Serial</strong></span>.<span class="orange">print</span>(<span class="blue1">"raw"</span>);<br/>  <span class="orange"><strong>Serial</strong></span>.<span class="orange">print</span>(<span class="blue1">"\t"</span>);  <span class="ash">//tab character</span><br/>  <span class="orange"><strong>Serial</strong></span>.<span class="orange">print</span>(<span class="blue1">"volts"</span>);<br/>  <span class="orange"><strong>Serial</strong></span>.<span class="orange">println</span>();    <span class="ash">//new line character</span><br/>}<br/><br/><span class="green">void</span> <span class="green1">loop</span>()<br/>{<br/>  rawSensorValue = <span class="orange">analogRead</span>(A0);   <span class="ash">//read in sensor value</span><br/><span epub:type="pagebreak" id="page_194"/>  rawVolts = volts(rawSensorValue);  <span class="ash">//convert sensor value</span><br/>                                     <span class="ash">//to volts</span><br/>  <span class="orange"><strong>Serial</strong></span>.<span class="orange">print</span>(rawSensorValue);  <span class="ash">//print raw sensor value</span><br/>  <span class="orange"><strong>Serial</strong></span>.<span class="orange">print</span>(<span class="blue1">"\t"</span>);<br/>  <span class="orange"><strong>Serial</strong></span>.<span class="orange">print</span>(rawVolts);  <span class="ash">//print raw voltage reading</span><br/>  <span class="orange"><strong>Serial</strong></span>.<span class="orange">println</span>();        <span class="ash">//new line character</span><br/>}<br/><br/><span class="ash">/***********************************************************/</span><br/><span class="green">float</span> volts(<span class="green">int</span> rawCount)<br/>{<br/>   <span class="green">float</span> AREF = 5.0;<br/>   <span class="green">float</span> calculatedVolts;<br/>   calculatedVolts = rawCount * AREF / 1023;<br/>   <span class="green1">return</span> calculatedVolts;<br/>}</pre>&#13;
</div>&#13;
<p class="indent">Connect your Arduino board to your computer with a USB cable, upload this example, and then open up the Serial Monitor. You should see text scroll up the screen like in <a href="ch07.xhtml#ch07fig10">Figure 7-10</a>. According to this, an analog value of 156 is equal to a voltage of 0.76. You can check the output voltage with this calculation: 156 × (5.0 / 1,023) = 0.762 V. It’s always good when the math works out!</p>&#13;
<p class="figuret"><a id="ch07fig10"/><strong>FIGURE 7-10:</strong> Serial Monitor output of raw sensor value and voltage</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_10.jpg"/></div>&#13;
<p class="indent">Without an additional <code>delay()</code> command in the <code>loop()</code>, the Arduino takes a sensor reading about 80–90 times per second and sends the information back to the computer. This is why you get a stream of readings rather than a single reading. If you want to slow down the rate at which the sketch prints the readings to the screen, <span epub:type="pagebreak" id="page_195"/>simply add a <code>delay(1000);</code> at the end of the <code>loop()</code>, just after the last <code>Serial.println();</code>. This will slow the loop to a single reading per second so it’s not streaming as fast. You’ll do that later in the code.</p>&#13;
<p class="indent">There’s one more step to get the sketch to show the temperature rather than volts.</p>&#13;
<h5 class="h5" id="ch07lev3sec3"><strong>Convert Voltage to Temperature</strong></h5>&#13;
<p class="noindent">Now you need a formula to convert the volts to temperature. You know that the voltage the TMP36 outputs varies linearly depending on the temperature it senses, meaning that as the temperature changes, the voltage changes proportionately. Therefore, to create a formula, you use the <em>slope-intercept</em> equation:</p>&#13;
<p class="center"><em>y</em> = <em>mx</em> + <em>b</em></p>&#13;
<p class="indent">This equation describes a line or, more generally, a relationship between two variables <em>x</em> and <em>y</em>, where <em>m</em> is the slope of the line describing the rate of change, and <em>b</em> is the y-intercept, showing where the line intercepts the y-axis. In this case, the two variables <em>x</em> and <em>y</em> are the voltage and temperature, respectively, and you’ll use the known variable <em>x</em> (volts) to calculate the unknown variable <em>y</em> (temperature).</p>&#13;
<p class="indent">As mentioned, the datasheet for the temperature sensor states that the voltage changes at a rate of 0.010 V per degree Celsius, or 1 V per 100 degrees Celsius. This rate is the slope of the line and so becomes <em>m</em> in the equation. If you plug in the variables, the equation looks like this:</p>&#13;
<div class="image"><img alt="Image" src="../images/195equ01.jpg"/></div>&#13;
<p class="indent">The datasheet for the TMP36 also provides a reference point for mapping voltage to degrees Celsius: at 25 degrees Celsius, the sensor has a voltage of 0.750 V. Substitute these numbers into the equation to solve for the y-intercept <em>b</em>:</p>&#13;
<div class="image"><img alt="Image" src="../images/195equ02.jpg"/></div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_196"/>So now you have values for <em>m</em> and <em>b</em>. Here’s the final equation:</p>&#13;
<div class="image"><img alt="Image" src="../images/196equ01.jpg"/></div>&#13;
<p class="indent">This is a technique that you can apply to any number of sensors that have a linear relationship with voltage. It’s also a nice reminder that math is important and useful. But, if none of that made any sense, don’t worry—all you need to know is that to find the temperature of the sensor, you simply plug the voltage reading into this equation.</p>&#13;
<p class="indent">Now, use this equation in the code to convert the <code>rawVolts</code> reading to a temperature. You’ll work from the example code in Listing 7-3 and add the new code in <a href="ch07.xhtml#ch07ex04">Listing 7-4</a> to show you the temperature reading from the sensor.</p>&#13;
<p class="ex-caption"><a id="ch07ex04"/><strong>LISTING 7-4:</strong> Converting from volts to temperature</p>&#13;
<div class="pre">&#13;
<pre>  <span class="ash">//Example sketch – calculates the temperature from the TMP36</span><br/>  <span class="ash">//sensor and prints it to the Serial Monitor</span><br/>  <span class="ash1">int rawSensorValue;</span><br/>  <span class="ash1">float rawVolts;</span><br/><span class="ent">➊</span> <span class="green">float</span> tempC;<br/>  <span class="green">float</span> tempF;<br/><br/>  <span class="ash1">void setup()</span><br/>  <span class="ash1">{</span><br/>    <span class="ash1">Serial.begin(9600);  //initializes the serial communication</span><br/>    <span class="ash1">Serial.print("raw");</span><br/>    <span class="ash1">Serial.print("\t");  //tab character</span><br/>    <span class="ash1">Serial.print("volts");</span><br/><span class="ent">➋</span>   <span class="orange"><strong>Serial</strong></span>.<span class="orange">print</span>(<span class="blue1">"\t"</span>);<br/>    <span class="orange"><strong>Serial</strong></span>.<span class="orange">print</span>(<span class="blue1">"degC"</span>);<br/>    <span class="orange"><strong>Serial</strong></span>.<span class="orange">print</span>(<span class="blue1">"\t"</span>);<br/>    <span class="orange"><strong>Serial</strong></span>.<span class="orange">print</span>(<span class="blue1">"degF"</span>);<br/>    <span class="ash1">Serial.println();</span><br/>  <span class="ash1">}</span><br/><br/>  <span class="ash1">void loop()</span><br/>  <span class="ash1">{</span><br/>    <span class="ash1">rawSensorValue = analogRead(A0);   //read in sensor value</span><br/>    <span class="ash1">rawVolts = volts(rawSensorValue);  //convert sensor value</span><br/>                                       <span class="ash1">//to volts</span><br/><br/><span class="ent">➌</span>   tempC = 100 * rawVolts – 50;  <span class="ash">//convert volts to deg. C</span><br/><span class="ent">➍</span>   tempF = 1.8 * tempC + 32;     <span class="ash">//convert deg. C to deg. F</span><br/><br/>  <span class="ash1">--<em>snip</em>--</span><br/>    <span class="ash1">Serial.print(rawVolts);  //print raw voltage reading</span><br/><span class="ent">➎</span>   <span class="orange"><strong>Serial</strong></span>.<span class="orange">print</span>(<span class="blue1">"\t"</span>);<br/><span epub:type="pagebreak" id="page_197"/>    <span class="orange"><strong>Serial</strong></span>.<span class="orange">print</span>(tempC);<br/>    <span class="orange"><strong>Serial</strong></span>.<span class="orange">print</span>(<span class="blue1">"\t"</span>);<br/>    <span class="orange"><strong>Serial</strong></span>.<span class="orange">print</span>(tempF);<br/>    <span class="ash1">Serial.println();        //new line character</span><br/><span class="ent">➏</span>   <span class="orange">delay</span>(1000);<br/>  }<br/><br/>  <span class="ash1">/***********************************************************/</span><br/>  <span class="ash1">float volts(int rawCount)</span><br/>  <span class="ash1">--<em>snip</em>--</span></pre>&#13;
</div>&#13;
<p class="indent">First, add two lines in the global namespace at the top to declare variables to store the temperature in degrees Celsius (<code>tempC</code>) and in degrees Fahrenheit (<code>tempF</code>) <span class="ent">➊</span>. Next, add a few lines in the <code>setup()</code> to use appropriate column headings for the readings printed to the Serial Monitor, separated by a tab character, which is represented by the control character <code>\t</code> <span class="ent">➋</span>. You can now use the slope-intercept equation to calculate the temperature in degrees Celsius <span class="ent">➌</span>. You’ll also add one last line that converts the temperature from Celsius to Fahrenheit <span class="ent">➍</span>.</p>&#13;
<p class="indent">And, for some additional feedback, add a few extra lines to <code>Serial.print()</code> to make sure you print the new variables <span class="ent">➎</span> to the Serial Monitor. Notice that the very last <code>Serial.print()</code> line is actually a <code>Serial.println()</code> command that inserts a newline character and moves the cursor to the next line. This will make sure each new reading starts on a new line. Finally, add the 1-second delay <span class="ent">➏</span> to slow down the loop so that the sensor is sampled only once per second and you have time to read the text.</p>&#13;
<p class="indent">Upload the updated code to your Arduino, and open the Serial Monitor. You should see four columns of data scroll up the screen, as shown in <a href="ch07.xhtml#ch07fig11">Figure 7-11</a>. As the new column headings denote, these figures represent raw data, voltage, temperature in degrees Celsius, and temperature in degrees Fahrenheit. If you squeeze the temperature sensor with your fingers, you should notice that the temperature increases. Congratulations, you have a working temperature monitor, the first big part of this project!</p>&#13;
<p class="figuret"><a id="ch07fig11"/><strong>FIGURE 7-11:</strong> Serial Monitor displaying temperatures from the TMP36</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_11.jpg"/></div>&#13;
<h3 class="h3" id="ch07lev1sec5"><span epub:type="pagebreak" id="page_198"/><strong>BUILD THE SERVO MOTOR AUTOVENT</strong></h3>&#13;
<p class="noindent">You’ll use a servo motor like the one you used in <a href="ch06.xhtml#ch06">Project 6</a> to open and close a window on the greenhouse. A servo is a simple motor that uses three wires for the control signal (yellow or white), power (red), and ground (black) connections, as shown in <a href="ch07.xhtml#ch07fig12">Figure 7-12</a>.</p>&#13;
<p class="figuret"><a id="ch07fig12"/><strong>FIGURE 7-12:</strong> Adding the servo motor to the circuit</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_12.jpg"/></div>&#13;
<p class="indent">Most standard servos have a three-pin female connector. Connect three male-to-male jumper wires to these three pins to extend these connections, as shown in <a href="ch07.xhtml#ch07fig13">Figure 7-13</a>. If possible, match the colors of your jumper wires to the leads on the servo connector. Then, connect the yellow (or white) signal wire to pin 9 on the Arduino board. Connect the red wire to 5 V and the black wire to GND on the right side of the breadboard.</p>&#13;
<p class="figuret"><a id="ch07fig13"/><strong>FIGURE 7-13:</strong> Inserting male-to-male jumper wires to connect the servo to the breadboard</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_13.jpg"/></div>&#13;
<h3 class="h3" id="ch07lev1sec6"><span epub:type="pagebreak" id="page_199"/><strong>PROGRAM THE AUTOVENT</strong></h3>&#13;
<p class="noindent">Add the servo code shown in <a href="ch07.xhtml#ch07ex05">Listing 7-5</a>.</p>&#13;
<p class="ex-caption"><a id="ch07ex05"/><strong>LISTING 7-5:</strong> Adding in the servo control</p>&#13;
<div class="pre">&#13;
<pre><span class="ent">➊</span> <span class="green1">#include</span>&lt;<span class="orange"><strong>Servo</strong></span>.h&gt;<br/><span class="ent">➋</span> <span class="orange"><strong>Servo</strong></span> myServo;<br/><br/>  <span class="ash1">//Example sketch – calculates the temperature from the TMP36</span><br/>  <span class="ash1">//sensor and prints it to the Serial Monitor</span><br/>  <span class="ash1">int rawSensorValue;</span><br/>  <span class="ash1">float rawVolts;</span><br/>  <span class="ash1">float tempC;</span><br/>  <span class="ash1">float tempF;</span><br/><span class="ent">➌</span> <span class="green">int</span> setPoint = 85;<br/>  <span class="green">int</span> returnPoint = 83;<br/><br/>  <span class="ash1">void setup()</span><br/>  <span class="ash1">{</span><br/>    myServo.<span class="orange">attach</span>(<span class="ent">➍</span>9, 1000, 2000); <span class="ash">//initializes myServo object</span><br/>    <span class="ash1">Serial.begin(9600);  //initializes the serial communication</span><br/>    <span class="ash1">--<em>snip</em>--</span><br/>  <span class="ash1">}</span><br/><br/>  <span class="ash1">void loop()</span><br/>  <span class="ash1">{</span><br/>    <span class="ash1">--<em>snip</em>--</span><br/>    <span class="ash1">Serial.println();</span>    <span class="ash1">//new line character</span><br/><br/><span class="ent">➎</span>   <span class="green1">if</span>(tempF &gt; setPoint)<br/>    {<br/>      myServo.<span class="orange">write</span>(180);<br/>    }<br/>    <span class="green1">else if</span>(tempF &lt; returnPoint)<br/>    {<br/>      myServo.<span class="orange">write</span>(0);<br/>    }<br/>    <span class="ash1">delay(1000);</span><br/>  <span class="ash1">}</span><br/><br/>  <span class="ash1">/***********************************************************/</span><br/>  <span class="ash1">float volts(int rawCount)</span><br/>  <span class="ash1">--<em>snip</em>--</span></pre>&#13;
</div>&#13;
<p class="indent">Remember from <a href="ch06.xhtml#ch06">Project 6</a> that to use the servo you need to include the Servo library <span class="ent">➊</span> and create a servo object named <code>myServo</code> <span class="ent">➋</span>. Next, create two variables <span class="ent">➌</span> to define the <em>set points</em> for the control system. These set points are the temperatures <span epub:type="pagebreak" id="page_200"/>at which the window will automatically open and close. Notice that <code>setPoint</code>, which opens the window, is 2 degrees higher than <code>returnPoint</code>, which closes the window, giving you 2 degrees where the window will not be opening or closing. This control technique, referred to as <em>hysteresis</em>, is useful for systems where the temperature might fluctuate slightly and keeps the window from constantly opening and closing at the smallest temperature variation.</p>&#13;
<p class="indent">Finally, you need to initialize the servo by telling the Arduino that the servo is connected to pin 9 <span class="ent">➍</span>. You might notice that this <code>myServo.attach()</code> command has two extra numbers, rather than the one number you used in <a href="ch06.xhtml#ch06">Project 6</a>. To understand why, take a look at “<a href="ch07.xhtml#ch07sb01">How Servos Really Work</a>” on page <a href="ch07.xhtml#page_201">201</a>.</p>&#13;
<p class="indent">Finally, for the control logic, you’ll use a nested <code>if()</code>–<code>else if()</code> control statement. Add the eight lines of code at <span class="ent">➎</span> just above the <code>delay()</code> to move the servo to a 180-degree position if the temperature is above 85 degrees Fahrenheit (the <code>setPoint</code>) and return the servo to the 0-degree position if the temperature drops below 83 degrees Fahrenheit (the <code>returnPoint</code>). This will open and close the autovent window.</p>&#13;
<p class="indent">Upload the updated code from <a href="ch07.xhtml#ch07ex05">Listing 7-5</a> to your Arduino, and open the Serial Monitor. Try it out by pinching the sensor between your fingers or cupping your hands around the sensor and blowing deeply to warm it above 85 degrees. Watch the Serial Monitor to see the temperature rise. As soon as it hits 85 degrees, you should hear the servo motor as it moves into position. Now, let the temperature sensor sit and cool down. As soon as it dips below the <code>returnPoint</code>, you should hear the servo motor again as it returns to the 0-degree position. Pretty neat, eh?</p>&#13;
<p class="indent">Now you’ll build the final component: the fan.</p>&#13;
<h3 class="h3" id="ch07lev1sec7"><strong>BUILD THE FAN MOTOR</strong></h3>&#13;
<p class="noindent">The fan, which will move air around in the greenhouse, is going to spin via a small DC hobby motor—a standard cylindrical device with two wires and a center axle that spins when you apply voltage to the leads. The servo motor you’ve been using so far has gearing inside that allows it to move very precisely in a tightly defined range of motion. Recall that it has only about 180 degrees of motion. You’ll use a DC motor here, rather than the servo motor, because you’ll need the fan blade to spin continuously the entire time you apply power to it. This makes it perfect for a fan function. The DC motor you’ll use is designed to operate between 3 V and 6 V but draws around 200–300 mA when it’s spinning. The Arduino <code>OUTPUT</code> pins are capable of driving only about 40 mA of current, so to provide enough amps for the DC motor, you’ll build an extra circuit called a <em>transistor amplifier circuit</em>—more technically known as a <em>common-emitter amplifier</em>.</p>&#13;
<div class="sidebar">&#13;
<p class="sidebart" id="ch07sb01"><span epub:type="pagebreak" id="page_201"/><strong>HOW SERVOS REALLY WORK</strong></p>&#13;
<p class="noindent">Servos are neat devices that move a motor to a specific position based on a signal from the microcontroller. A standard servo motor has a fixed range of motion of about 180 degrees.</p>&#13;
<p class="indent">All servo motors have three wires: a white (or sometimes yellow or orange) wire for receiving the signal, a red power wire, and a black ground wire. The signal is a unique pulse sent every 20 ms, or at a rate of 50 Hz. To encode a position, a microcontroller varies the width of the pulse to indicate the angle or position that the motor will turn to (see <a href="ch05.xhtml#ch05">Project 5</a> for more details on pulse width modulation). For most standard servo motors, a 1,000-microsecond (1,000 μs) pulse indicates the 0-degree position, and a 2,000 μs pulse indicates the full 180-degree position, so a 1,500 μs pulse indicates the midpoint of the servo, or the 90-degree position.</p>&#13;
<p class="indent">The Arduino’s <em>Servo.h</em> library maps the pulse widths to the motor positions, but the library has a slightly different definition for the servo positions and pulse widths, using a 544 μs pulse for the 0-degree position and a 2,400 μs pulse for the 180-degree position. This allows the library to work with <em>extended-range</em> servos, but it is outside the limits of most standard servos. So, when you use a command like <code>myServo.write(0);</code> the motor receives a 544 μs pulse and will try moving beyond its own physical limits. If that happens, the motor will shake, buzz, and heat up because it’s just not able to move to a position that coincides with a 544 μs pulse.</p>&#13;
<p class="indent">To counteract this, you can set limits for the servo in the code. As in <a href="ch06.xhtml#ch06">Project 6</a>, use the command <code>myServo.attach(9);</code> to initialize the servo on pin 9 of the Arduino. You can also add parameters to set lower and upper pulse width limits for the motor, with <code>myServo.attach(9, 1000, 2000);</code>. With this initialization, the command <code>myServo.write(0);</code> will move the motor to its 0-degree angle position and it won’t shake, buzz, or heat up.</p>&#13;
<p class="indent">If you want to know more about how servos work, take a look at the tutorial on SparkFun at <em><a href="https://www.sparkfun.com/tutorials/283/">https://www.sparkfun.com/tutorials/283/</a>.</em></p>&#13;
</div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_202"/>A transistor has three legs: the collector (C), base (B), and emitter (E). Any current that goes into the base is amplified on the collector pin. The base is like a control for a door that allows current to move from the collector to the emitter. The more you push on the base, the wider the door opens, and more current can pass through from the collector to the emitter. The amazing thing about transistors is that you need apply only a small amount of current at the base to let a large amount of current flow from the collector to the emitter. If you provide too much current to the base, you can burn the transistor out, so in the same way you’ve used resistors to limit the current flowing through LEDs, you’ll use a 330 Ω resistor in this circuit to limit the current flowing to the base.</p>&#13;
<p class="indent">There are many different applications for transistors, such as amplifiers and other devices, but here you’re just going to use it like a controllable switch. Even though the Arduino pin can only supply a small amount of current, when you send a <code>HIGH</code> signal to the base of the transistor, the transistor turns “on.” This allows current to flow between the collector and the emitter. It essentially connects these pins together, like closing a switch.</p>&#13;
<p class="indent">The emitter side of the transistor is connected to the ground rail. Notice that one side of the motor is connected to the 5 V rail, and the other side of the motor is connected to the collector of the transistor. When the transistor is turned “on,” this connects the collector to the emitter of the transistor, closing the switch between the motor and ground and making it spin. Engineers call this “operating a transistor between cut-off and saturation mode.” Power for the motor is coming directly from the power rails. That means you can use the limited current provided by the Arduino <code>OUTPUT</code> pins to control devices requiring a much larger current flow.</p>&#13;
<p class="indent">You’ll build the transistor circuit on the top part of the breadboard, as shown in <a href="ch07.xhtml#ch07fig14">Figure 7-14</a>.</p>&#13;
<p class="figuret"><span epub:type="pagebreak" id="page_203"/><a id="ch07fig14"/><strong>FIGURE 7-14:</strong> Adding the fan-motor transistor control circuit</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_14.jpg"/></div>&#13;
<p class="indent">Find the transistor in your kit. As you can see from <a href="ch07.xhtml#ch07fig15">Figure 7-15</a>, the transistor looks a lot like the temperature sensor, though if you look closely you should see 2N2222 or BC337 on the flat side of the casing. This is an <em>NPN transistor</em>, and it will act as the motor’s on/off switch that you control with the Arduino board.</p>&#13;
<p class="figuret"><a id="ch07fig15"/><strong>FIGURE 7-15:</strong> NPN transistors used in this project—the 2N2222 (left) and the replacement part BC337 (right)</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_15.jpg"/></div>&#13;
<p class="indent">Hold the transistor so that the flat edge is facing to the left, and insert it into the top part of the breadboard with the top pin about six rows down, as shown in <a href="ch07.xhtml#ch07fig14">Figure 7-14</a>. In this position, the top pin is the collector, the middle is the base, and the bottom is the emitter (<a href="ch07.xhtml#ch07fig15">Figure 7-15</a>).</p>&#13;
<p class="indent">Connect a 330 Ω resistor to the base pin and stretch it across the ditch in the breadboard, as shown in <a href="ch07.xhtml#ch07fig14">Figure 7-14</a>. Then, connect the other side of this resistor to pin 11 on your Arduino so that pin 11 connects to the base pin through the 330 Ω resistor. This is the low-current control signal from the Arduino that will switch the transistor on and off. When the transistor is switched on, current will flow through the motor, and it will spin.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_204"/>Connect a small jumper wire from the emitter of the transistor (lower pin) to the ground rail. Lastly, connect one of the wires of the motor to the collector (top) pin of the transistor. The motor will spin either clockwise or counterclockwise depending on which wire you use, but in this case it doesn’t matter which way it spins, so you can choose either motor wire. Connect the other motor wire to the power rail, and then use a jumper wire to connect the power rail of the breadboard to 5 V on the Arduino. When a small current signal is detected on the base pin, the connection between the collector and the emitter is closed. This connects a path from 5 V through the motor to GND and completes a circuit path that will cause the motor to spin. <a href="ch07.xhtml#ch07fig16">Figure 7-16</a> shows the circuit for the motor.</p>&#13;
<p class="figuret"><a id="ch07fig16"/><strong>FIGURE 7-16:</strong> Transistor circuit to drive the motor from an Arduino pin</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_16.jpg"/></div>&#13;
<p class="indent">The last piece in this circuit is a protection diode, sometimes called a <em>fly-back diode</em>, and it protects the transistor from damage that may be caused by the motor. Inside a motor are a bunch of coils that create an electromagnet that pushes and pulls against permanent magnets in the motor—this is what causes the axle to spin. Coils are a really interesting component used in electronics. The magnetic field that they create is actually a form of stored energy, and when the circuit is turned off, this stored energy can rebound and cause large voltage spikes that will damage the transistor. The fly-back diode creates a path for this voltage spike to dissipate without going through the transistor. It’s sometimes also called a <em>snubber circuit</em>.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_205"/>In order to wire this component in correctly, it is important to note that diodes are <em>polarized</em>, and the orientation makes a difference. The body of the diode has a line or band at one end of the body, as shown in <a href="ch07.xhtml#ch07fig17">Figure 7-17</a>. Make sure that the side with the band is connected to the positive (5 V) side of the motor.</p>&#13;
<p class="figuret"><a id="ch07fig17"/><strong>FIGURE 7-17:</strong> Fly-back diode used in the transistor circuit, with a quarter for size comparison</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_17.jpg"/></div>&#13;
<p class="indent">Add the diode to the motor, making sure that the side of the diode with the line is connected to the 5 V motor wire, as shown in the circuit diagram in <a href="ch07.xhtml#ch07fig16">Figure 7-16</a>. Connect the other leg of the diode to the other wire of the DC motor—the one connected to the collector pin of the transistor. This means that the two legs of the diode share the same connections as the two wires of the motor. When two devices are wired up like this, we say they’re wired <em>in parallel</em>.</p>&#13;
<p class="indent">You should now have a complete circuit that has each of the three subcircuits in <a href="ch07.xhtml#ch07fig06">Figure 7-6</a>. You’ll add a few more lines of code to control the motor.</p>&#13;
<h4 class="h4" id="ch07lev2sec9"><strong>Program the Fan Motor</strong></h4>&#13;
<p class="noindent">The code for controlling the motor is very simple, just like the code you used to turn an LED on and off. Add the code in <a href="ch07.xhtml#ch07ex06">Listing 7-6</a> to your current sketch.</p>&#13;
<p class="ex-caption"><a id="ch07ex06"/><strong>LISTING 7-6:</strong> Complete Tiny Desktop Greenhouse control code</p>&#13;
<div class="pre">&#13;
<pre>  <span class="ash1">#include&lt;Servo.h&gt;</span><br/>  <span class="ash1">Servo myServo;</span><br/>  <span class="ash1">--<em>snip</em>--</span><br/><br/>  <span class="ash1">void setup()</span><br/>  <span class="ash1">{</span><br/><span class="ent">➊</span>   <span class="orange">pinMode</span>(11, <span class="green">OUTPUT</span>);<br/>    <span class="ash1">myServo.attach(9, 1000, 2000);</span><br/>    <span class="ash1">Serial.begin(9600);  //initializes the serial communication</span><br/>    <span class="ash1">--<em>snip</em>--</span><br/>  <span class="ash1">}</span><br/><span epub:type="pagebreak" id="page_206"/><br/>  <span class="ash1">void loop()</span><br/>  <span class="ash1">{</span><br/>    <span class="ash1">--<em>snip</em>--</span><br/>    <span class="ash1">Serial.println();    //new line character</span><br/><br/>    <span class="ash1">if(tempF &gt; setPoint)</span><br/>    <span class="ash1">{</span><br/>      <span class="ash1">myServo.write(180);</span><br/><span class="ent">➋</span>     digitalWrite(11, <span class="green">HIGH</span>);  //turn the fan on<br/>    <span class="ash1">}</span><br/>    <span class="ash1">else if(tempF &lt; returnPoint)</span><br/>    <span class="ash1">{</span><br/>      <span class="ash1">myServo.write(0);</span><br/><span class="ent">➌</span>     digitalWrite(11, <span class="green">LOW</span>);   //turn the fan off<br/>    <span class="ash1">}</span><br/>    <span class="ash1">delay(1000);</span><br/>  <span class="ash1">}</span><br/><br/>  <span class="ash1">/***********************************************************/</span><br/>  <span class="ash1">float volts(int rawCount)</span><br/>  <span class="ash1">{</span><br/>    <span class="ash1">const float AREF = 5.0;</span><br/>    <span class="ash1">float calculatedVolts;</span><br/>    <span class="ash1">calculatedVolts = rawCount * AREF / 1023;</span><br/>    <span class="ash1">return calculatedVolts;</span><br/>  <span class="ash1">}</span></pre>&#13;
</div>&#13;
<p class="indent">There are just a few new lines of code. The first is in the <code>setup()</code>. This sets pin 11, to which the motor is attached via the transistor, as an <code>OUTPUT</code> <span class="ent">➊</span>. Next is the set of conditional <code>if()</code>–<code>else if()</code> blocks. Here, you add two commands to turn the motor on <span class="ent">➋</span> and off <span class="ent">➌</span>. Remember that the motor will really be the greenhouse fan. With these few extra lines of code, the fan will turn on at the same time as the window opens, and it will turn off when the window closes.</p>&#13;
<p class="indent">After you’ve added these lines of code, upload this latest version to your Arduino. Open the Serial Monitor, and test it again. Try warming up the temperature sensor by squeezing it between your fingers or using your breath, and watch what happens. As soon as the temperature readings get to about 85 degrees Fahrenheit, the servo motor should move and the hobby motor should kick in. You might notice that as soon as the motor turns on, the temperature readings go all out of whack. There is a lot going on here, but we have a quick fix for it.</p>&#13;
<h4 class="h4" id="ch07lev2sec10"><span epub:type="pagebreak" id="page_207"/><strong>Isolate the Motor Effect</strong></h4>&#13;
<p class="noindent">When the motor turns on, the voltage of the Arduino drops down to about 4.1–4.5 V because of the extra current load of the motor. You may see that as soon as the motor spins up, the temperature readings start changing sporadically, and the motor may continue to turn on and off several times before the temperature readings settle down. Earlier we said that when you use <code>analogRead()</code>, <code>1023</code> is equal to 5 V, but that’s only partially true. The full truth is that <code>1023</code> is equal to whatever the voltage from the source is, so if the source voltage drops to 4.1 V, <code>1023</code> is now equal to 4.1 V. This messes up the Arduino’s ability to take accurate measurements.</p>&#13;
<p class="indent">To rectify this, add two lines of code at the very beginning of the <code>loop()</code>, right after the first curly bracket, to tell the Arduino to turn off the motor before reading the temperature sensor:</p>&#13;
<div class="pre">&#13;
<pre><span class="orange">digitalWrite</span>(11, <span class="green">LOW</span>);  <span class="ash">//turn off the motor before</span><br/>                        <span class="ash">//reading sensor</span><br/><span class="orange">delay</span>(1);               <span class="ash">//short 1 ms delay before</span><br/>                        <span class="ash">//reading sensor</span></pre>&#13;
</div>&#13;
<p class="indent">Now the Arduino will turn the motor off for exactly 1 ms before reading the voltage on the temperature sensor. This isolates the voltage drop from the motor and the <code>analogRead()</code> without adding too much extra code.</p>&#13;
<p class="indent">After adding these two lines, upload the new sketch to your Arduino, and try heating up the sensor again. Now it should behave much more predictably. With the circuits built and the code working smoothly, it’s time to build the actual greenhouse structure.</p>&#13;
<h3 class="h3" id="ch07lev1sec8"><strong>BUILD THE TINY DESKTOP GREENHOUSE ENCLOSURE</strong></h3>&#13;
<p class="noindent">We provide a template for the greenhouse enclosure we created using cardboard, but you could use anything you want. In fact, IKEA sells a great little greenhouse called the SOCKER that you could easily modify to work with this project.</p>&#13;
<p class="indent">For the Tiny Desktop Greenhouse, the finished dimensions are roughly 4.5 × 4.5 inches for the base and 6 inches at the tallest point. In the resources available at <em><a href="https://www.nostarch.com/arduinoinventor/">https://www.nostarch.com/arduinoinventor/</a></em>, we have two template options: one is broken out into three sheets of 8.5 × 11-inch cardboard (shown in <a href="ch07.xhtml#ch07fig18">Figure 7-18</a>), and the other is on a single sheet of cardboard measuring 11 × 17 inches.</p>&#13;
<p class="figuret"><span epub:type="pagebreak" id="page_208"/><a id="ch07fig18"/><strong>FIGURE 7-18:</strong> Tiny Desktop Greenhouse cardboard enclosure template (not full size)</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_18.jpg"/></div>&#13;
<p class="indent">Carefully cut out the pieces of the template from the cardboard. There are four unique pieces: the pentagonal side pieces, the front/ back square walls, the roof window, and the fan-motor holder. Take one square side piece and one pentagonal front/back piece and lay them side by side, with the transparency side facing up. Use a narrow strip of masking tape to hold these two sides together, as shown in <a href="ch07.xhtml#ch07fig19">Figure 7-19</a>. Repeat this process until you have all four of the side wall pieces attached, but don’t tape the last two walls together; leave the enclosure lying flat until you’ve added the windows.</p>&#13;
<p class="figuret"><span epub:type="pagebreak" id="page_209"/><a id="ch07fig19"/><strong>FIGURE 7-19:</strong> Use a narrow strip of tape to hold the pieces together.</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_19.jpg"/></div>&#13;
<p class="indent">Now you need to cut six pieces of transparency film to be slightly larger than the opening in each of the wall pieces and the windows. For the template we provide, you will need four squares that measure 4.25 × 4.25 inches and two squares that measure 4.25 × 2.5 inches. You should be able to cut these six pieces out of a single sheet of transparency film; it’s a good idea to trace them on first to get the most out of the film. At this point, you only want to secure the windows for the side walls; you’ll add the roof windows at the very end. Using a bead of glue or small piece of tape, secure these windows to the inside of the greenhouse on the same side as the tape, as shown in <a href="ch07.xhtml#ch07fig20">Figure 7-20</a>.</p>&#13;
<p class="figuret"><a id="ch07fig20"/><strong>FIGURE 7-20:</strong> Carefully line up the transparency film window to adhere it to the cardboard.</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_20.jpg"/></div>&#13;
<p class="indent">Once those transparency panes are in place, run one more piece of tape along the last exposed edge, and connect it so that you have a square base and a structure that resembles a small greenhouse, as shown in <a href="ch07.xhtml#ch07fig21">Figure 7-21</a>. The top and bottom of the greenhouse should <span epub:type="pagebreak" id="page_210"/>still be open, and it may still feel a little unstable, but as soon as you add the roof, the entire structure will hold together.</p>&#13;
<p class="figuret"><a id="ch07fig21"/><strong>FIGURE 7-21:</strong> Four sides of the greenhouse complete</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_21.jpg"/></div>&#13;
<h4 class="h4" id="ch07lev2sec11"><strong>Add the Autovent Window Servo</strong></h4>&#13;
<p class="noindent">On our template, we made a small cutout for the servo motor as close as possible to the pivot point of the window, to maximize the amount the window opens when the servo horn moves. Disconnect the servo from your circuit, and attach a horn to the end of the servo if there isn’t one already there. We’d recommend using the single-sided horn, because it’s easier to tell where the servo is pointing. Gently rotate the servo clockwise with your fingers until it stops to set the motor at the 180-degree position. This is the position where the horn will be when the window is fully open. Remove and reposition the servo horn so that it is pointing up in the opposite direction from the wires that come out of the back of the servo, as shown in <a href="ch07.xhtml#ch07fig22">Figure 7-22</a>.</p>&#13;
<p class="figuret"><a id="ch07fig22"/><strong>FIGURE 7-22:</strong> Servo horn in the 180-degree position— rotated clockwise</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_22.jpg"/></div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_211"/>Now feed the servo through the hole in the template from the inside of the greenhouse so that the wires are pointing down and the servo horn is on the inside pointing up (see <a href="ch07.xhtml#ch07fig23">Figure 7-23</a>).</p>&#13;
<p class="figuret"><a id="ch07fig23"/><strong>FIGURE 7-23:</strong> Placing the servo into the greenhouse</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_23.jpg"/></div>&#13;
<p class="indent">The tabs of the servo should sit flush with the cardboard. You can screw in the servo using the screws that come with it and the two small screw holes in our template, or use a few dabs of hot glue to secure it in place.</p>&#13;
<h4 class="h4" id="ch07lev2sec12"><strong>Create the Paper Clip Linkage</strong></h4>&#13;
<p class="noindent">As in <a href="ch06.xhtml#ch06">Project 6</a>, you’ll need a linkage to connect the servo horn to the window. Take a medium-size paper clip and straighten out all but the small hook on the end. Now, grab a ruler and add a sharp 90-degree bend about 1 1/8 inches from the small hook end, pointing away from the hook, as shown in <a href="ch07.xhtml#ch07fig24">Figure 7-24</a>.</p>&#13;
<p class="figuret"><a id="ch07fig24"/><strong>FIGURE 7-24:</strong> Bending the paper clip linkage</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_24.jpg"/></div>&#13;
<h4 class="h4" id="ch07lev2sec13"><span epub:type="pagebreak" id="page_212"/><strong>Add the Roof</strong></h4>&#13;
<p class="noindent">The roof piece is a rectangular piece of cardboard. Cut out the windows, and score the centerline of the roof, as shown in <a href="ch07.xhtml#ch07fig25">Figure 7-25</a>. The scored edge will form a hinge for the window flap to open and close.</p>&#13;
<p class="figuret"><a id="ch07fig25"/><strong>FIGURE 7-25:</strong> The roof piece</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_25.jpg"/></div>&#13;
<p class="indent">Position the greenhouse so that the servo is on the left side. One half of the roof will be secured down with glue, and the other half will form a window flap that opens and closes. Using a small bead of hot glue, attach one half of the roof structure to the greenhouse. Only glue down three edges of the roof (that is, one half of the six edges) so that there’s still a flap that can open. Make sure that the side that opens coincides with the side that the servo horn moves against, as shown in <a href="ch07.xhtml#ch07fig26">Figure 7-26</a>.</p>&#13;
<p class="figuret"><a id="ch07fig26"/><strong>FIGURE 7-26:</strong> Gluing in the roof. Be sure to only glue one half of the roof so that the other side can open.</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_26.jpg"/></div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_213"/>Hook the paper clip linkage around the last hole in the servo horn, as shown in <a href="ch07.xhtml#ch07fig27">Figure 7-27</a>, with the rounded hook attached to the servo. Make sure that the opposing bend is pointing back toward the servo motor. This will hook into the frame of the roof piece.</p>&#13;
<p class="figuret"><a id="ch07fig27"/><strong>FIGURE 7-27:</strong> Servo horn and paper clip linkage</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_27.jpg"/></div>&#13;
<p class="indent">Keeping the window flap open, rotate the paper clip until you can insert it into the side of the frame through the cardboard itself. If the paper clip isn’t long enough to reach, you can either rebend it or reposition the servo horn at an angle rotated slightly higher to extend the reach of the linkage. It may be helpful to lift the greenhouse structure and reposition the servo horn from underneath. Once you’ve positioned the servo horn so it will reach, insert the end of the paper clip into the side of the window frame, as shown in <a href="ch07.xhtml#ch07fig28">Figure 7-28</a>.</p>&#13;
<p class="figuret"><a id="ch07fig28"/><strong>FIGURE 7-28:</strong> Servo arm linkage connected to the window flap</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_28.jpg"/></div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_214"/>Bend the portion of the paper clip that protrudes from the other side to create a hook so that the linkage does not fall out (see <a href="ch07.xhtml#ch07fig29">Figure 7-29</a>), and cut the remaining end off. Now carefully move the servo back and forth; you should be able to open and close the lid of your greenhouse!</p>&#13;
<p class="figuret"><a id="ch07fig29"/><strong>FIGURE 7-29:</strong> Bending the hook in the servo linkage</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_29.jpg"/></div>&#13;
<p class="indent">With the mechanism complete, you can glue or tape the transparency windows for the top of the greenhouse. A small dab of glue on the four corners will be just enough to hold the window pane down. The window panes should go on the outside of the greenhouse roof to allow room for the linkage to open and close the lid. Next, you’ll build a box to hold the motor and fan.</p>&#13;
<h4 class="h4" id="ch07lev2sec14"><strong>Build the Fan-Motor Box</strong></h4>&#13;
<p class="noindent">The motor will serve as a fan to move air around when the greenhouse gets too warm. To prevent the motor from moving as it spins and vibrates, we designed a small cardboard box to hold it in. The template has a design for a five-sided box with a small hole to allow the motor wires to come through, shown in <a href="ch07.xhtml#ch07fig30">Figure 7-30</a>.</p>&#13;
<p class="indent">Cut out this template from a piece of cardboard, and carefully score the dashed lines so that it can fold up into a box. Using either tape or hot glue, secure the four sides of the box so that it will hold the motor snugly (see <a href="ch07.xhtml#ch07fig31">Figure 7-31</a>).</p>&#13;
<p class="indent">To build a fan blade, you’ll glue a small piece of cardstock onto the end of the motor. Cut the fan blade so that it is no more than 1.25 inches wide. To help the fan move more air, fold the edges of the cardstock as shown in <a href="ch07.xhtml#ch07fig32">Figure 7-32</a>.</p>&#13;
<p class="figuret"><span epub:type="pagebreak" id="page_215"/><a id="ch07fig30"/><strong>FIGURE 7-30:</strong> The fan-motor box</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_30.jpg"/></div>&#13;
<p class="figuret"><a id="ch07fig31"/><strong>FIGURE 7-31:</strong> Completely assembled motor box with the motor inside</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_31.jpg"/></div>&#13;
<p class="figuret"><a id="ch07fig32"/><strong>FIGURE 7-32:</strong> Final fan blade</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_32.jpg"/></div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_216"/>This will ensure that the fan doesn’t hit the plant or anything else inside the tiny greenhouse. Using a small dab of hot glue, attach the fan blade to the motor as shown in <a href="ch07.xhtml#ch07fig33">Figures 7-33</a> and <a href="ch07.xhtml#ch07fig34">7-34</a>.</p>&#13;
<p class="figuret"><a id="ch07fig33"/><strong>FIGURE 7-33:</strong> Securing the fan blade to the motor</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_33.jpg"/></div>&#13;
<p class="figuret"><a id="ch07fig34"/><strong>FIGURE 7-34:</strong> Fan-motor assembly complete</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_34.jpg"/></div>&#13;
<h4 class="h4" id="ch07lev2sec15"><strong>Connect It Up</strong></h4>&#13;
<p class="noindent">Now you have all of the pieces you need for your Tiny Desktop Greenhouse, so it’s time to install the electronics. Remove the temperature sensor from the breadboard, and use three male-to-female jumper wires to extend the connections of the sensor, as shown in <a href="ch07.xhtml#ch07fig35">Figure 7-35</a>. Pay attention to which wires you move, and connect <span epub:type="pagebreak" id="page_217"/>them up again using the extended wires. When you hold the flat side of the temperature sensor facing you with the pins to the left, the top pin is power, the middle pin is the signal, and the bottom pin is ground. We used red, yellow, and black wires to show the power, signal, and ground connections, respectively.</p>&#13;
<p class="figuret"><a id="ch07fig35"/><strong>FIGURE 7-35:</strong> Extending the temperature sensor with male-to-female jumper wires</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_35.jpg"/></div>&#13;
<p class="indent">You’ll need to place the temperature sensor inside the greenhouse. Use a piece of masking tape to secure the temperature sensor directly to the plant before sticking it inside your new greenhouse, as shown in <a href="ch07.xhtml#ch07fig36">Figure 7-36</a>. You can now feed the wires out under one side of the greenhouse, or you could also make a small hole to feed the wires through.</p>&#13;
<p class="figuret"><a id="ch07fig36"/><strong>FIGURE 7-36:</strong> Secure the temperature sensor directly to your plant</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_36.jpg"/></div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_218"/>Similarly, move the fan-motor assembly so that it sits near the corner of the greenhouse. The motor wires should be long enough to reach the breadboard without extensions, but if you need to, you can add extra male-to-female extension wires to make wiring easier.</p>&#13;
<p class="indent">Now, you should still have enough room for a small plant to rest comfortably in this new cozy habitat. It’s time to get your new exotic house plant and put it inside your brand new greenhouse! To test out how effectively our autovent system regulated the temperature, we created our own indoor sun with some really big floodlights to heat the air.</p>&#13;
<p class="indent"><a href="ch07.xhtml#ch07fig37">Figure 7-37</a> shows one of our tests on the Tiny Desktop Greenhouse.</p>&#13;
<p class="figuret"><a id="ch07fig37"/><strong>FIGURE 7-37:</strong> Testing a Tiny Desktop Greenhouse</p>&#13;
<div class="image"><img alt="Image" src="../images/fig7_37.jpg"/></div>&#13;
<h3 class="h3" id="ch07lev1sec9"><strong>GOING FURTHER</strong></h3>&#13;
<p class="noindent">There are a lot of opportunities to take this project to the next level.</p>&#13;
<h4 class="h4" id="ch07lev2sec16"><strong>Hack</strong></h4>&#13;
<p class="noindent">At the moment, your greenhouse is pretty darn small. To make space for more plants, find a large cardboard box like the ones used for copy paper. Cut some windows in it, line them with transparency film, and move the electronics into this bigger and better greenhouse. Or, take a look at the plastic greenhouses they have over at IKEA. Where can you mount the servo motor so that you can open and close the window on this greenhouse?</p>&#13;
<h4 class="h4" id="ch07lev2sec17"><span epub:type="pagebreak" id="page_219"/><strong>Modify</strong></h4>&#13;
<p class="noindent">The current set point is 85 degrees Fahrenheit, and although that was a good temperature for us to test because we could easily increase it with our own body heat, it’s actually still pretty low for most plants. Look up the ideal growing temperature for your plant, and modify your code to use this new set point.</p>&#13;
<p class="indent">You can also modify how often the greenhouse samples the temperature with the delay. A delay of 1 second is pretty short. If your temperatures swing at all, the lid will be opening and closing every few seconds. This can quickly become annoying. Change this delay to something like 5 minutes, which would be 30,000 ms.</p>&#13;
</body></html>