<html><head></head><body>
<div id="book-content">
<div id="sbo-rt-content"><section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" title="301" id="Page_301"/><a class="XrefDestination" id="18"/><span class="XrefDestination" id="xref-503007c18-001"/>18</span><br/>
<span class="ChapterTitle"><a class="XrefDestination" id="ProtectingSalaryDatawithViews"/><span class="XrefDestination" id="xref-503007c18-002"/>Protecting Salary Data with Views</span></h1>
</header>
<figure class="opener">
<img src="image_fi/book_art/chapterart.png" alt="" width="200" height="200"/>
</figure>
<p class="ChapterIntro">In this project, you’ll use views to hide sensitive salary data in an employee table. The company in question has one database user from each department (Human Resources, Marketing, Accounting, Technology, and Legal) who is allowed access to most employee data. However, only users from Human Resources should be able to access the employees’ salaries.</p>
<p>Views can hide sensitive data, but they can also be used to simplify access to a complex query, or to select just the relevant data in a table—for example, to show just the table’s rows for a particular department.</p>
<h2 id="h1-503007c18-0001"><a class="XrefDestination" id="CreatingtheemployeeTable"/><span class="XrefDestination" id="xref-503007c18-003"/>Creating the employee Table</h2>
<p class="BodyFirst">Start by creating your <code>business</code> database:</p>
<pre><code>create database business;</code></pre>
<p><span epub:type="pagebreak" title="302" id="Page_302"/>Next, create an <code>employee</code> table that stores information about each employee in the company, including full name, job title, and salary:</p>
<pre><code>use business;

create table employee
(
  employee_id      int             primary key    auto_increment,
  first_name       varchar(100)    not null,
  last_name        varchar(100)    not null,
  department       varchar(100)    not null,
  job_title        varchar(100)    not null,
  salary           decimal(15,2)   not null
);</code></pre>
<p>Since you created the <code>employee_id</code> column as <code>auto_increment</code>, you don’t need to provide an <code>employee_id</code> value when inserting new rows into the <code>employee</code> table. MySQL keeps track of that for you, and makes sure that the <code>employee_id</code> value gets higher with each row you insert. Add the following data to your table:</p>
<pre><code>insert into employee(first_name, last_name, department, job_title, salary)
values ('Jean',' Unger', 'Accounting', 'Bookkeeper', 81200);

insert into employee(first_name, last_name, department, job_title, salary)
values ('Brock', 'Warren', 'Accounting', 'CFO', 246000);

insert into employee(first_name, last_name, department, job_title, salary)
values ('Ruth', 'Zito', 'Marketing', 'Creative Director', 178000);

insert into employee(first_name, last_name, department, job_title, salary)
values ('Ann', 'Ellis', 'Technology', 'Programmer', 119500);

insert into employee(first_name, last_name, department, job_title, salary)
values ('Todd', 'Lynch', 'Legal', 'Compliance Manager', 157000);</code></pre>
<p>Now, query the table to see the inserted rows:</p>
<pre><code>select * from employee;</code></pre>
<p>The result is as follows:</p>
<pre><code>employee_id  first_name  last_name  department      job_title         salary
-----------  ----------  ---------  ----------  ------------------  ---------
1            Jean        Unger      Accounting  Bookkeeper           81200.00
2            Brock       Warren     Accounting  CFO                 246000.00
3            Ruth        Zito       Marketing   Creative Director   178000.00
4            Ann         Ellis      Technology  Programmer          119500.00
5            Todd        Lynch      Legal       Compliance Manager  157000.00</code></pre>
<p>The <code>employee</code> table data looks good, but you want to hide the <code>salary</code> column from everyone except the Human Resources user so that coworkers can’t access one another’s sensitive information.</p>
<h2 id="h1-503007c18-0002"><span epub:type="pagebreak" title="303" id="Page_303"/><a class="XrefDestination" id="CreatingtheView"/><span class="XrefDestination" id="xref-503007c18-004"/>Creating the View</h2>
<p class="BodyFirst">Instead of allowing all database users to access the <code>employee</code> table, you’ll let them access a view called <code>v_employee</code> that has the columns from the <code>employee</code> table minus the <code>salary</code> column. As discussed in <a class="xref" href="c10.xhtml">Chapter 10</a>, a view is a virtual table based on a query. Create the view like so:</p>
<pre><code>create view v_employee as
select employee_id,
       first_name,
       last_name,
       department,
       job_title
from   employee;</code></pre>
<p>You’ve left out the <code>salary</code> column from the <code>select</code> statement, so it shouldn’t appear in your result once you query your view:</p>
<pre><code>select * from v_employee;</code></pre>
<p>The result is as follows:</p>
<pre><code>employee_id  first_name  last_name  department      job_title
-----------  ----------  ---------  ----------  ------------------
1            Jean        Unger      Accounting  Bookkeeper
2            Brock       Warren     Accounting  CFO
3            Ruth        Zito       Marketing   Creative Director
4            Ann         Ellis      Technology  Programmer
5            Todd        Lynch      Legal       Compliance Manager</code></pre>
<p>As expected, the <code>v_employee</code> view contains every column except for <code>salary</code>.</p>
<p>Next, you’ll change the permissions of the <code>employee</code> database to allow Human Resources to make changes in the underlying <code>employee</code> table. Since <code>v_employee</code> is a view, the changes to <code>employee</code> will be immediately reflected there.</p>
<h2 id="h1-503007c18-0003"><a class="XrefDestination" id="ControllingPermissions"/><span class="XrefDestination" id="xref-503007c18-005"/>Controlling Permissions</h2>
<p class="BodyFirst">To adjust the permissions in your database, you’ll use the <code>grant</code> command, which grants privileges to MySQL database users and controls which users can access which tables.</p>
<p>You have one database user per department: <code>accounting_user</code>, <code>marketing_user</code>, <code>legal_user</code>, <code>technology_user</code>, and <code>hr_user</code>. Grant access to the <code>employee</code> table to only <code>hr_user</code> by entering the following:</p>
<pre><code>grant select, delete, insert, update on business.employee to hr_user;</code></pre>
<p>You’ve granted <code>hr_user</code> the ability to select, delete, insert, and update rows in the <code>employee</code> table in the <code>business</code> database. You won’t grant that <span epub:type="pagebreak" title="304" id="Page_304"/>access to the users from other departments. For example, if <code>accounting_user</code> tries to query the <code>employee</code> table, they’ll get the following error message:</p>
<pre><code>Error Code: 1142. SELECT command denied to user 'accounting_user'@'localhost'
for table ‘employee’</code></pre>
<p>Now you’ll grant select access to your <code>v_employee</code> view to your users from all of your departments:</p>
<pre><code>grant select on business.v_employee to hr_user@localhost;
grant select on business.v_employee to accounting_user@localhost;
grant select on business.v_employee to marketing_user@localhost;
grant select on business.v_employee to legal_user@localhost;
grant select on business.v_employee to technology_user@localhost;</code></pre>
<p>All of your departments’ users can select from the <code>v_employee</code> view to access the employee data they need.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2><a class="XrefDestination" id="RevokingPrivileges"/><span class="XrefDestination" id="xref-503007c18-006"/>Revoking Privileges</h2>
<p class="BoxBodyFirst">If a user has already been granted access that you want to take away, you (or your DBA) can use the <code>revoke</code> command, like so:</p>
<pre><code>revoke select, delete, insert, update
on business.employee from legal_user@localhost;</code></pre>
<p>This command revokes select, delete, insert, and update access on the <code>employee</code> table for <code>legal_user</code>.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>For this project, you can grant privileges using the <code>root</code> superuser account that was created when you installed MySQL (see <a class="xref" href="c01.xhtml">Chapter 1</a>). In a live production environment, your DBA would typically create other accounts rather than using <code>root</code>, which has all privileges and can do anything. In a professional setting, very few people know the <code>root</code> password. A DBA can also define permissions to a <em>role</em> and then add or remove users as members of that role, but a detailed discussion of roles is beyond the scope of this book.</p>
<h2 id="h1-503007c18-0004"><a class="XrefDestination" id="UsingMySQLWorkbenchtoTestUserAccess"/><span class="XrefDestination" id="xref-503007c18-007"/>Using MySQL Workbench to Test User Access</h2>
<p class="BodyFirst">You’ll use MySQL Workbench with this project and connect as <code>root</code> to create the database, tables, and departments’ users. Then, you’ll create separate connections as <code>hr_user</code> and <code>accounting_user</code> to see how their access differs.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<span epub:type="pagebreak" title="305" id="Page_305"/><h2><span class="NoteHead">Note</span></h2>
<p>	You could use another tool, like the MySQL command line client or MySQL Shell, but I like the ease with which you can test different users’ access by clicking a MySQL Workbench connection and logging in as that user.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>First, create a connection for the <code>root</code> user, using the password that you created when you installed MySQL. To create the connection, click the <code>+</code> icon next to the text MySQL Connections on the Welcome to MySQL Workbench screen, as shown in <a href="#figure18-1" id="figureanchor18-1">Figure 18-1</a>.</p>
<figure>
<img src="image_fi/503007c18/f18001.png" class="keyline" alt="" width="692" height="314"/>
<figcaption><p><a id="figure18-1">Figure 18-1</a>: Creating a MySQL Workbench connection</p></figcaption>
</figure>
<p>The Setup New Connection window will open, as shown in <a href="#figure18-2" id="figureanchor18-2">Figure 18-2</a>. Here, enter a connection name (I chose to give the connection the same name as the user: <code>root</code>) and enter <code class="bold">root</code> as the username.</p>
<figure>
<img src="image_fi/503007c18/f18002.png" class="keyline" alt="" width="694" height="433"/>
<figcaption><p><a id="figure18-2">Figure 18-2</a>: Creating a MySQL Workbench connection for <span class="LiteralInCaption"><code>root</code></span></p></figcaption>
</figure>
<p><span epub:type="pagebreak" title="306" id="Page_306"/>To save the connection, click <b>OK</b>. Now you can log in as <code>root</code> in the future simply by clicking the connection.</p>
<p>Since <code>root</code> is a superuser account that has all privileges and can grant privileges to other users, you’ll use this connection to run the script to create the database, tables, view, and users for your departments. <a href="#figure18-3" id="figureanchor18-3">Figure 18-3</a> shows the end of that script, but you’ll need to run the full one at <a href="https://github.com/ricksilva/mysql_cc/blob/main/chapter_18.sql" class="LinkURL">https://github.com/ricksilva/mysql_cc/blob/main/chapter_18.sql</a>.</p>
<figure>
<img src="image_fi/503007c18/f18003.png" class="keyline" alt="" width="694" height="665"/>
<figcaption><p><a id="figure18-3">Figure 18-3</a>: Creating tables, view, and users and granting access using MySQL Workbench</p></figcaption>
</figure>
<p>Now that you’ve run the script to create usernames for your departments, you’ll create MySQL Workbench connections for <code>hr_user</code> and <code>accounting_user</code>. <a href="#figure18-4" id="figureanchor18-4">Figure 18-4</a> shows how to set up a new connection for <code>hr_user</code>.</p>
<p>To create the connection for <code>hr_user</code>, you entered a connection name and username of <code>hr_user</code>. You’ll create a connection for <code>accounting_user</code> the same way, using <code>accounting_user</code> for both the connection name and username.</p>
<span epub:type="pagebreak" title="307" id="Page_307"/><figure>
<img src="image_fi/503007c18/f18004.png" class="keyline" alt="" width="690" height="431"/>
<figcaption><p><a id="figure18-4">Figure 18-4</a>: Creating a MySQL Workbench connection for <span class="LiteralInCaption"><code>hr_user</code></span></p></figcaption>
</figure>
<p>Now you have three connections in MySQL Workbench that you can use, as shown in <a href="#figure18-5" id="figureanchor18-5">Figure 18-5</a>.</p>
<figure>
<img src="image_fi/503007c18/f18005.png" class="keyline" alt="" width="691" height="381"/>
<figcaption><p><a id="figure18-5">Figure 18-5</a>: MySQL Workbench connections for <span class="LiteralInCaption"><code>root</code></span>, <span class="LiteralInCaption"><code>hr_user</code></span>, and <span class="LiteralInCaption"><code>accounting_user</code></span></p></figcaption>
</figure>
<p>The connections appear with the names you used when you created them. You can log in to MySQL as each user by clicking the corresponding connection.</p>
<p>You can also open multiple connections at once. Open a connection as <code>hr_user</code>, then click the home icon at the top left to return to the welcome screen. From here, open another connection as <code>accounting_user</code> by clicking its connection.</p>
<p><span epub:type="pagebreak" title="308" id="Page_308"/>You now should see two tabs in MySQL Workbench, labeled <code>hr_user</code> and <code>accounting_user</code>, as shown in <a href="#figure18-6" id="figureanchor18-6">Figure 18-6</a>.</p>
<figure>
<img src="image_fi/503007c18/f18006.png" class="keyline" alt="" width="323" height="104"/>
<figcaption><p><a id="figure18-6">Figure 18-6</a>: You can have multiple connections open in MySQL Workbench.</p></figcaption>
</figure>
<p>Simply click the appropriate tab to run queries as that user. Click the <code>hr_user</code> tab to query the <code>employee</code> table as <code>hr_user</code> (<a href="#figure18-7" id="figureanchor18-7">Figure 18-7</a>).</p>
<figure>
<img src="image_fi/503007c18/f18007.png" class="keyline" alt="" width="690" height="434"/>
<figcaption><p><a id="figure18-7">Figure 18-7</a>: Querying the <span class="LiteralInCaption"><code>employee</code></span> table as <span class="LiteralInCaption"><code>hr_user</code></span></p></figcaption>
</figure>
<p>Now, click the <code>accounting_user</code> tab and query the <code>employee</code> table again, as shown in <a href="#figure18-8" id="figureanchor18-8">Figure 18-8</a>.</p>
<figure>
<img src="image_fi/503007c18/f18008.png" class="keyline" alt="" width="694" height="269"/>
<figcaption><p><a id="figure18-8">Figure 18-8</a>: The <span class="LiteralInCaption"><code>accounting_user</code></span> cannot view the <span class="LiteralInCaption"><code>employee</code></span> table.</p></figcaption>
</figure>
<p><span epub:type="pagebreak" title="309" id="Page_309"/>Because you as <code>root</code> haven’t granted access on the <code>employee</code> table to <code>accounting_user</code>, the error <code>SELECT command denied</code> is returned. The <code>accounting_user</code> can, however, select from the <code>v_employee</code> view, so the user can see employee data without the salaries (<a href="#figure18-9" id="figureanchor18-9">Figure 18-9</a>).</p>
<figure>
<img src="image_fi/503007c18/f18009.png" class="keyline" alt="" width="694" height="580"/>
<figcaption><p><a id="figure18-9">Figure 18-9</a>: The <span class="LiteralInCaption"><code>accounting_user</code></span> is able to query the <span class="LiteralInCaption"><code>v_employee</code></span> view.</p></figcaption>
</figure>
<p>Your other database users have the same privileges as <code>accounting_user</code>, meaning they can’t query the <code>employee</code> table either, because you haven’t granted them access.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="boxcustom1">
<h2>Try It Yourself</h2>
<p class="BoxListNumberCustom1"><b>18-1.</b>	Log in as <code>root</code> and create a view called <code>v_employee_fn_dept</code> that has just the <code>first_name</code> and <code>department</code> columns from the <code>employee</code> table. Query the view. Do you see the results you expected?</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-503007c18-0005"><span epub:type="pagebreak" title="310" id="Page_310"/><a class="XrefDestination" id="AnAlternativeApproach"/><span class="XrefDestination" id="xref-503007c18-009"/>An Alternative Approach</h2>
<p class="BodyFirst">There’s another way to hide data from particular users. MySQL allows you to grant permissions at the column level; for example, you could grant the <code>select</code> privilege on all the columns in the <code>employee</code> table except for <code>salary</code>:</p>
<pre><code>grant select(employee_id, first_name, last_name, department, job_title)
on employee
to technology_user@localhost;</code></pre>
<p>This allows <code>technology_user</code> to select any or all of the <code>employee_id</code>, <code>first_name</code>, <code>last_name</code>, <code>department</code>, or <code>job_title</code> columns from the table, like so:</p>
<pre><code>select employee_id,
       first_name,
       last_name
from   employee;</code></pre>
<p class="BodyContinued">The result is:</p>
<pre><code>employee_id  first_name  last_name
-----------  ----------  ---------
     1       Jean        Unger
     2       Brock       Warren
     3       Ruth        Zito
     4       Ann         Ellis
     5       Todd        Lynch</code></pre>
<p>Since you haven’t granted select access on the <code>salary</code> column, MySQL will prevent <code>technology_user</code> from selecting that column:</p>
<pre><code>select salary
from   employee;</code></pre>
<p class="BodyContinued">The result is an error message:</p>
<pre><code>SELECT command denied to user 'technology_user'@'localhost' for table 'employee'</code></pre>
<p>If <code>technology_user</code> tries to select all columns using the <code>*</code> wildcard, they will receive the same error message, because they cannot return the <code>salary</code> column. For this reason, I don’t favor this approach, as it can lead to confusion. It’s more straightforward to allow users to access all permissible tables through a view.</p>
<h2 id="h1-503007c18-0006"><span epub:type="pagebreak" title="311" id="Page_311"/><a class="XrefDestination" id="Summary"/><span class="XrefDestination" id="xref-503007c18-010"/>Summary</h2>
<p class="BodyFirst">In this project, you used a view to hide salary information from particular users. This technique could be used to hide any kind of sensitive data in your tables. You also learned how granting and revoking privileges for database users can help to create secure databases by exposing certain pieces of data to specific users.</p>
<p>With these three projects under your belt, you’ll be able to build your own databases, load data from files, create triggers to maintain the quality of your data, and use views to protect sensitive data.</p>
<p>Good luck on the next stage of your MySQL journey!</p>
</section>
</div>
</div>
</body></html>