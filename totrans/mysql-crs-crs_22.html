<html><head></head><body>
<div id="book-content">
<div id="sbo-rt-content"><section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" title="277" id="Page_277"/><a class="XrefDestination" id="17"/><span class="XrefDestination" id="xref-503007c17-001"/>17</span><br/>
<span class="ChapterTitle"><a class="XrefDestination" id="TrackingChangestoVoterDatawithtriggers"/><span class="XrefDestination" id="xref-503007c17-002"/>Tracking Changes to Voter Data with Triggers</span></h1>
</header>
<figure class="opener">
<img src="image_fi/book_art/chapterart.png" alt="" width="200" height="200"/>
</figure>
<p class="ChapterIntro">In this chapter, you’ll build a voting database that stores data for an election. You’ll improve the quality of your data by designing the database with constraints, including primary and foreign keys, and using triggers to prevent bad data from being entered. You’ll also use triggers to track changes to your database so that if data quality issues arise, you have a record of who made the changes and when.</p>
<p>You’ll allow poll workers to change data when appropriate, so it’s important to build a system that prevents errors from being made. The techniques in this chapter can be applied to a wide variety of applications and situations. The quality of your data is crucial, so it’s worth setting up your database in a way that keeps your data as accurate as possible.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	This is quite a large project, so you may want to approach it by tackling the sections on different days.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-503007c17-0001"><span epub:type="pagebreak" title="278" id="Page_278"/><a class="XrefDestination" id="SettingUptheDatabase"/><span class="XrefDestination" id="xref-503007c17-003"/>Setting Up the Database</h2>
<p class="BodyFirst">First, you’ll create the database and take a look at its tables. The ballot for your election has races for mayor, treasurer, school committee, the board of health, and the planning board. <a href="#figure17-1" id="figureanchor17-1">Figure 17-1</a> shows the ballot you’ll use for your database.</p>
<figure>
<img src="image_fi/503007c17/f17001.png" class="" alt="" width="483" height="613"/>
<figcaption><p><a id="figure17-1">Figure 17-1</a>: The ballot for your election</p></figcaption>
</figure>
<p>This election uses optical scan voting machines that read the ballots and save the voting data to your MySQL database.</p>
<p>Create the <code>voting</code> database:</p>
<pre><code>create database voting;</code></pre>
<p>Now you can begin adding tables.</p>
<h2 id="h1-503007c17-0002"><a class="XrefDestination" id="CreatingtheTables"/><span class="XrefDestination" id="xref-503007c17-004"/>Creating the Tables</h2>
<p class="BodyFirst">You’ll create the following tables within your <code>voting</code> database:</p>
<table id="tabular-503007c17-0001" border="1" class="TabularList">
<tbody>
<tr>
<td><code class="bold">beer</code></td>
<td>A table that contains data about beer.</td>
</tr>
<tr>
<td><code class="bold">voter</code></td>
<td>People who are eligible to vote in this election</td>
</tr>
<tr>
<td><code class="bold">ballot</code></td>
<td>The voter’s ballot</td>
</tr>
<tr>
<td><code class="bold"><span epub:type="pagebreak" title="279" id="Page_279"/>race</code></td>
<td>The races on the ballot (for example, Mayor, Treasurer)</td>
</tr>
<tr>
<td><code class="bold">candidate</code></td>
<td>The candidates running</td>
</tr>
<tr>
<td><code class="bold">ballot_candidate</code></td>
<td>The candidates that the voter selected on their ballot</td>
</tr>
</tbody>
</table>
<p>The <em>entity relationship diagram</em> <em>(ERD)</em> in <a href="#figure17-2" id="figureanchor17-2">Figure 17-2</a> shows these tables and their columns, as well as the primary and foreign key relationships between them.</p>
<figure>
<img src="image_fi/503007c17/f17002.png" class="" alt="" width="845" height="647"/>
<figcaption><p><a id="figure17-2">Figure 17-2</a>: The tables in your <span class="LiteralInCaption"><code>voting</code></span> database</p></figcaption>
</figure>
<p>Voters will cast a ballot with the candidates that they selected for each race.</p>
<h3 id="h2-503007c17-0001"><a class="XrefDestination" id="ThevoterTable"/><span class="XrefDestination" id="xref-503007c17-005"/>The voter Table</h3>
<p class="BodyFirst">The <code>voter</code> table will store information about each voter, such as name, address, and county. Create the table as follows:</p>
<pre><code>use voting;

create table voter
    (
    voter_id                int             primary key    auto_increment,
<span epub:type="pagebreak" title="280" id="Page_280"/>    voter_name              varchar(100)    not null,
    voter_address           varchar(100)    not null,
    voter_county            varchar(50)     not null,
    voter_district          varchar(10)     not null,
    voter_precinct          varchar(10)     not null,
    voter_party             varchar(20),
    voting_location         varchar(100)    not null,
    voter_registration_num  int             not null       unique
    );</code></pre>
<p>The <code>voter_id</code> column is the primary key for the table. Creating this primary key not only will speed up joins that use the <code>voter</code> table, but also will make sure that no two rows in the table have the same <code>voter_id</code> value.</p>
<p>You set <code>voter_id</code> to <code>auto_increment</code> so that MySQL will automatically increase the <code>voter_id</code> value with each new voter you add to the table.</p>
<p>You can’t have two voters with the same registration number, so you set the <code>voter_registration_num</code> column to <code>unique</code>. If a new voter is added to the table with the same <code>voter_registration_num</code> as an existing voter, that new row will be rejected.</p>
<p>All of the columns are defined as <code>not null</code> except for the <code>voter_party</code> column. You’ll allow a row to be saved in the table with a null <code>voter_party</code>, but if any other columns contain a null value, the row will be rejected.</p>
<h3 id="h2-503007c17-0002"><a class="XrefDestination" id="TheballotTable"/><span class="XrefDestination" id="xref-503007c17-006"/>The ballot Table</h3>
<p class="BodyFirst">The <code>ballot</code> table holds information about each ballot, including the ballot number, the voter who completed the ballot, when the ballot was cast, and whether the ballot was cast in person or absentee. Create the <code>ballot</code> table like so:</p>
<pre><code>create table ballot
    (
    ballot_id              int          primary key    auto_increment,
    voter_id               int          not null       unique,
    ballot_type            varchar(10)  not null,
    ballot_cast_datetime   datetime     not null       default now(),
    constraint foreign key (voter_id) references voter(voter_id),
    constraint check(ballot_type in ('in-person', 'absentee'))
    );</code></pre>
<p>The <code>ballot_id</code> column is your primary key in this table, and its values automatically increment as you insert new ballot rows into the table.</p>
<p>You use a <code>unique</code> constraint for the <code>voter_id</code> column to ensure there is only one ballot in the table per voter. If a voter tries to cast more than one ballot, only the first ballot will be counted; subsequent ballots will be rejected.</p>
<p>The <code>ballot_cast_datetime</code> column saves the date and time that the ballot was cast. You set a <code>default</code> so that if a value isn’t provided for this column, the <code>now()</code> function will write the current date and time to it.</p>
<p>You put a foreign key constraint on the <code>ballot</code> table’s <code>voter_id</code> column to reject any ballots submitted by a voter whose information is not in the <code>voter</code> table.</p>
<p><span epub:type="pagebreak" title="281" id="Page_281"/>Lastly, you add a <code>check</code> constraint to the <code>ballot_type</code> column that allows only the values <code>in-person</code> or <code>absentee</code>. Any rows with other ballot types will be rejected.</p>
<h3 id="h2-503007c17-0003"><a class="XrefDestination" id="TheraceTable"/><span class="XrefDestination" id="xref-503007c17-007"/>The race Table</h3>
<p class="BodyFirst">The <code>race</code> table stores information about each race in your election, including the name of the race and how many candidates voters can vote for in it. You’ll create it like so:</p>
<pre><code>create table race
    (
    race_id                 int             primary key     auto_increment,
    race_name               varchar(100)    not null        unique,
    votes_allowed           int             not null
    );</code></pre>
<p>The <code>race_id</code> column is the primary key for this table, and is set to automatically increment. You define the <code>race_name</code> column with a <code>unique</code> constraint so that two races of the same name, like <code>Treasurer</code>, can’t be inserted into the table.</p>
<p>The <code>votes_allowed</code> column holds the number of candidates voters can select in this race. For example, voters can choose one candidate for the mayoral race, and two for the school committee race.</p>
<h3 id="h2-503007c17-0004"><a class="XrefDestination" id="ThecandidateTable"/><span class="XrefDestination" id="xref-503007c17-008"/>The candidate Table</h3>
<p class="BodyFirst">Next, you’ll create the <code>candidate</code> table, which stores information about the candidates who are running:</p>
<pre><code>create table candidate
    (
    candidate_id            int             primary key     auto_increment,
    race_id                 int             not null,
    candidate_name          varchar(100)    not null        unique,
    candidate_address       varchar(100)    not null,
    candidate_party         varchar(20),
    incumbent_flag          bool,
    constraint foreign key (race_id) references race(race_id)
    );</code></pre>
<p>The <code>candidate_id</code> column is the primary key for this table. This not only prevents duplicate rows from being entered by mistake, but also enforces a <em>business rule</em>—a requirement or policy about the way your system operates—that a candidate can run for only one race. For example, if a candidate tries to run for both mayor and treasurer, the second row would be rejected. You also define the <code>candidate_id</code> column to automatically increment.</p>
<p>The <code>race_id</code> column stores the ID of the race in which the candidate is running. The <code>race_id</code> is defined as a foreign key to the <code>race_id</code> column in the <code>race</code> table. This means that there can’t be a <code>race_id</code> value in the <code>candidate</code> table that isn’t also in the <code>race</code> table.</p>
<p><span epub:type="pagebreak" title="282" id="Page_282"/>You define <code>candidate_name</code> as unique so that there can’t be two candidates in the table with the same name.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2><a class="XrefDestination" id="TheOrderofTableCreation"/><span class="XrefDestination" id="xref-503007c17-009"/>The Order of Table Creation</h2>
<p class="BoxBodyFirst">When you create tables that have foreign keys, the order of creation matters. For example, the <code>candidate</code> table has a foreign key column called <code>race_id</code> that references the <code>race_id</code> column of the <code>race</code> table. For that reason, you need to create the <code>race</code> table before you create the <code>candidate</code> table. If you try to create the <code>candidate</code> table first, you’ll get an error:</p>
<pre><code>Error Code: 1824. Failed to open the referenced table 'race'</code></pre>
<p>MySQL is letting you know that you defined a foreign key that points to the <code>race</code> table, which doesn’t exist yet.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-503007c17-0005"><a class="XrefDestination" id="Theballot_candidateTable"/><span class="XrefDestination" id="xref-503007c17-010"/>The ballot_candidate Table</h3>
<p class="BodyFirst">Now, you’ll create your final table, <code>ballot_candidate</code>. This table tracks which candidates received votes on which ballot.</p>
<pre><code>create table ballot_candidate
    (
    ballot_id       int,
    candidate_id    int,
    primary key (ballot_id, candidate_id),
    constraint foreign key (ballot_id) references ballot(ballot_id),
    constraint foreign key (candidate_id) references candidate(candidate_id)
    );</code></pre>
<p>This is an associative table that references both the <code>ballot</code> and <code>candidate</code> tables. The primary key for this table comprises both the <code>ballot_id</code> and <code>candidate_id</code> columns. This enforces a rule that no candidate can get more than one vote from the same ballot. If someone attempted to insert a duplicate row with the same <code>ballot_id</code> and <code>candidate_id</code>, the row would be rejected. Both columns are also foreign keys. The <code>ballot_id</code> column is used to join to the <code>ballot</code> table and <code>candidate_id</code> is used to join to the <code>candidate</code> table.</p>
<p>By defining your tables with these constraints, you’re improving the quality and integrity of the data in your database.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="boxcustom1">
<h2>Try It Yourself</h2>
<p class="BoxListNumberCustom1"><b>17-1.</b>	Create the <code>voting</code> database and its tables using the <code>create database</code> and <code>create table</code> statements shown previously.</p>
<p class="BoxListNumberCustom1"><span epub:type="pagebreak" title="283" id="Page_283"/><b>17-2.</b>	Add a row to the <code>voter</code> table using this <code>insert</code> statement:</p>
<pre><code>insert into voter
(
  voter_name,
  voter_address,
  voter_county,
  voter_district,
  voter_precinct,
  voter_party,
  voting_location,
  voter_registration_num
)
values
(
  'Susan King',
  '12 Pleasant St. Springfield',
  'Franklin',
  '12A',
  '4C',
  'Democrat',
  '523 Emerson St.',
  129756
);</code></pre>
<p class="BoxListNumberCustom1"><b>17-3.</b>	Query the <code>voter</code> table using the <code>select * from voter;</code> syntax. Notice that the row you inserted in Exercise 17-2 has a value for the <code>voter_id</code> column. You didn’t provide a <code>voter_id</code> value in your <code>insert</code> statement, so how do you think that value got there? Is there anything about the <code>create table</code> statement that would explain it?</p>
<p class="BoxListNumberCustom1"><b>17-4.</b>	Try to insert rows in the tables that violate your business rules. For example, insert a new <code>voter</code> row with the same <code>voter_registration_num</code> as an existing row in the <code>voter</code> table. Or insert a new row into the <code>ballot</code> table with a <code>voter_id</code> that doesn’t exist in the <code>voter</code> table.</p>
<p class="ListBody">Are the constraints you defined when you created the tables working to prevent bad data from being entered?</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-503007c17-0003"><a class="XrefDestination" id="AddingTriggers"/><span class="XrefDestination" id="xref-503007c17-012"/>Adding Triggers</h2>
<p class="BodyFirst">You’ll create several triggers on your tables to enforce business rules and track changes to your data for auditing purposes. These triggers will fire before or after a row is inserted, updated, or deleted from a table.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	In this chapter, you’ll focus mostly on building the triggers for the <code>voter</code> and <code>ballot</code> tables. The code for the other triggers (relating to the <code>race</code>, <code>candidate</code>, and <code>ballot_candidate</code> tables) is similar and can be found on GitHub at <a href="https://github.com/ricksilva/mysql_cc/blob/main/chapter_17.sql" class="LinkURL">https://github.com/ricksilva/mysql_cc/blob/main/chapter_17.sql</a>.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-503007c17-0006"><span epub:type="pagebreak" title="284" id="Page_284"/><a class="XrefDestination" id="BeforeTriggers"/><span class="XrefDestination" id="xref-503007c17-013"/>Before Triggers</h3>
<p class="BodyFirst">You’ll use triggers that fire <em>before</em> data gets changed to prevent data that doesn’t adhere to your business rules from being written to your tables. In <a class="xref" href="c12.xhtml">Chapter 12</a>, you created a trigger that changed credit scores that were below 300 to exactly 300 right before the data was saved to a table. For this project, you’ll use before triggers to make sure voters don’t <em>overvote</em>, or vote for more candidates than allowed for that race. You’ll also use before triggers to prevent particular users from making changes to some of your tables. Not every table will need a before trigger.</p>
<h4 id="h3-503007c17-0001"><a class="XrefDestination" id="BusinessRules"/><span class="XrefDestination" id="xref-503007c17-014"/>Business Rules</h4>
<p class="BodyFirst">You’ll enforce a few business rules using before triggers. First, although all poll workers are allowed to make changes to the <code>ballot</code> and <code>ballot_candidate</code> tables, only the secretary of state is allowed to make changes to data in the <code>voter</code>, <code>race</code>, and <code>candidate</code> tables. You’ll create the following before triggers to enforce this business rule:</p>
<table id="tabular-503007c17-0002" border="1" class="TabularList">
<tbody>
<tr>
<td><code class="bold">tr_voter_bi</code></td>
<td>Prevents other users from inserting voters</td>
</tr>
<tr>
<td><code class="bold">tr_race_bi</code></td>
<td>Prevents other users from inserting races</td>
</tr>
<tr>
<td><code class="bold">tr_candidate_bi</code></td>
<td>Prevents other users from inserting candidates</td>
</tr>
<tr>
<td><code class="bold">tr_voter_bu</code></td>
<td>Prevents other users from updating voters</td>
</tr>
<tr>
<td><code class="bold">tr_race_bu</code></td>
<td>Prevents other users from updating races</td>
</tr>
<tr>
<td><code class="bold">tr_candidate_bu</code></td>
<td>Prevents other users from updating candidates</td>
</tr>
<tr>
<td><code class="bold">tr_voter_bd</code></td>
<td>Prevents other users from deleting voters</td>
</tr>
<tr>
<td><code class="bold">tr_race_bd</code></td>
<td>Prevents other users from deleting races</td>
</tr>
<tr>
<td><code class="bold">tr_candidate_bd</code></td>
<td>Prevents other users from deleting candidates</td>
</tr>
</tbody>
</table>
<p>These triggers will prevent users from making changes and will display an error message explaining that only the secretary of state is allowed to change this data.</p>
<p>Second, voters are allowed to select a certain number of candidates for each race. It’s fine for voters to select no candidates for a race, or to select fewer than the maximum allowed number of candidates for a race, but they may not select more than the maximum number of candidates allowed. You’ll prevent overvoting by creating the <code>tr_ballot_candidate_bi</code> trigger.</p>
<p>These are all the before triggers you’ll need for this project. Remember, some tables won’t have before triggers.</p>
<h4 id="h3-503007c17-0002"><a class="XrefDestination" id="BeforeInsertTriggers"/><span class="XrefDestination" id="xref-503007c17-015"/>Before Insert Triggers</h4>
<p class="BodyFirst">You’ll need four <em>before insert</em> triggers for your project. Three of them will prevent users other than the secretary of state from inserting data in your <code>voter</code>, <code>race</code>, and <code>candidate</code> tables. The other before insert trigger will prevent voters from voting for too many candidates in a race.</p>
<p>In <a href="#listing17-1" id="listinganchor17-1">Listing 17-1</a>, you write the before insert trigger to prevent users other than the secretary of state from inserting new rows in your <code>voter</code> table.</p>
<span epub:type="pagebreak" title="285" id="Page_285"/>
<pre><code>drop trigger if exists tr_voter_bi;

delimiter //

create trigger tr_voter_bi
  before insert on voter
  for each row
begin
  if user() not like 'secretary_of_state%' then
  <span class="CodeAnnotationCode" aria-label="annotation1">❶</span> signal sqlstate '45000'
    set message_text = 'Voters can be added only by the Secretary of State';
  end if;
end//

delimiter ;</code></pre>
<p class="CodeListingCaption"><a id="listing17-1">Listing 17-1</a>: Defining the <code>tr_voter_bi</code> trigger</p>
<p>First, in case the trigger already exists, you drop it before you re-create it. You define the <code>tr_voter_bi</code> trigger as a <code>before insert</code> trigger. For each row being inserted into the <code>voter</code> table, you check that the name of the user inserting the new voter starts with the text <code>secretary_of_state</code>.</p>
<p>The <code>user()</code> function returns both the username and the hostname, like <code>secretary_of_state@localhost</code>. If that string doesn’t start with the text <code>secretary_of_state</code>, it means somebody other than the secretary of state is trying to insert a voter record. In that case, you’ll send an error message with the <code>signal</code> statement <span class="CodeAnnotation" aria-label="annotation1">❶</span>.</p>
<p>You might remember from <a class="xref" href="c12.xhtml">Chapter 12</a> that <code>sqlstate</code> is a five-character code that identifies errors and warnings. The value you used, <code>45000</code>, is an error condition that causes your trigger to exit. This prevents the row from being written to the <code>voter</code> table.</p>
<p>You can define the message to display by using the <code>set message_text</code> syntax. Notice that this line is a part of the <code>signal</code> command, as there is no semicolon at the end of the <code>signal</code> line. You could have combined these two lines into one, like this:</p>
<pre><code>signal sqlstate '45000' set message_text = 'Voters can be added only...';</code></pre>
<p>This <code>tr_voter_bi</code> trigger prevents users other than the secretary of state from inserting voter rows.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="boxcustom1">
<h2>Try It Yourself</h2>
<p class="BoxListNumberCustom1"><b>17-5.</b>	Write similar before insert triggers for the <code>race</code> and <code>candidate</code> tables to prevent users other than the secretary of state from inserting new races and candidates.</p>
<p class="ListBody"><span epub:type="pagebreak" title="286" id="Page_286"/>To test these triggers, first log in to MySQL Workbench and insert a row into the tables. For example, for the <code>race</code> table, you could run this SQL:</p>
<pre><code>insert into race (race_name, votes_allowed)
values ('Dog Catcher', 1);</code></pre>
<p class="ListBody">You should get the error message <code>Voters can be added only by the Secretary of State</code>.</p>
<p class="ListBody">Create a new MySQL user for the secretary of state like so:</p>
<pre><code>create user secretary_of_state@localhost identified by 'v0t3';</code></pre>
<p class="ListBody">This creates the <code>secretary_of_state@localhost</code> user with a password of <code>v0t3</code>.</p>
<p class="ListBody">Grant the new user permissions using this command:</p>
<pre><code>grant all privileges on *.* to secretary_of_state@localhost;</code></pre>
<p class="BoxBodyContinued">(Granting superuser privileges on everything is normally a bad idea, but we’ll do it just for this test.)</p>
<p class="ListBody">Now create a MySQL Workbench connection using <code>secretary_of_state@localhost</code> as shown in the following figure.</p>
<figure class="graphic"><img src="image_fi/503007c17/g17001.png" class="" alt="" width="550" height="475"/></figure>
<p class="ListBody">Run the SQL to add a new <code>race</code>:</p>
<pre><code>insert into race (race_name, votes_allowed)
values ('Dog Catcher', 1);</code></pre>
<p class="ListBody">Now, because you’re running the <code>insert</code> statement using the secretary of state's username, inserting the new race should succeed.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p><span epub:type="pagebreak" title="287" id="Page_287"/>Now, write your <code>tr_ballot_candidate_bi</code> trigger to prevent voters from voting for too many candidates in a race (<a href="#listing17-2" id="listinganchor17-2">Listing 17-2</a>).</p>
<pre><code>drop trigger if exists tr_ballot_candidate_bi;

delimiter //

create trigger tr_ballot_candidate_bi
  before insert on ballot_candidate
  for each row
begin
  declare v_race_id int;
  declare v_votes_allowed int;
  declare v_existing_votes int;
  declare v_error_msg varchar(100);
  declare v_race_name varchar(100);

<span class="CodeAnnotationCode" aria-label="annotation1">❶</span> select r.race_id,
         r.race_name,
         r.votes_allowed
<span class="CodeAnnotationCode" aria-label="annotation2">❷</span> into   v_race_id,
         v_race_name,
         v_votes_allowed
  from   race r
  join   candidate c
  on     r.race_id = c.race_id
  where  c.candidate_id = new.candidate_id;

<span class="CodeAnnotationCode" aria-label="annotation3">❸</span> select count(*)
  into   v_existing_votes
  from   ballot_candidate bc
  join   candidate c
  on     bc.candidate_id = c.candidate_id
  and    c.race_id = v_race_id
  where  bc.ballot_id = new.ballot_id;

  if v_existing_votes &gt;= v_votes_allowed then
     select concat('Overvoting error: The ',
              v_race_name,
              ' race allows selecting a maximum of ',
              v_votes_allowed,
              ' candidate(s) per ballot.'
            )
     into v_error_msg;

  <span class="CodeAnnotationCode" aria-label="annotation4">❹</span> signal sqlstate '45000' set message_text = v_error_msg;
  end if;
end//

delimiter ;</code></pre>
<p class="CodeListingCaption"><a id="listing17-2">Listing 17-2</a>: Defining the <code>tr_ballot_candidate_bi</code> trigger</p>
<p>Before a new row is inserted into the <code>ballot_candidate</code> table, your trigger finds the number of votes allowed for that race. Then, it checks how many <span epub:type="pagebreak" title="288" id="Page_288"/>existing rows are in the <code>ballot_candidate</code> table for this ballot and this race. If the number of existing votes is greater than or equal to the maximum allowed, the new row is prevented from being inserted. (The number of existing votes should never be greater than the maximum allowed, but you’ll check just for completeness.)</p>
<p>You declare five variables in your trigger: <code>v_race_id</code> holds the race ID, <code>v_race_name</code> holds the name of the race, <code>v_existing_votes</code> stores the number of votes that have already been cast on this ballot for candidates in this race, <code>v_votes_allowed</code> holds the number of candidates that voters are allowed to select in this race, and the <code>v_error_msg</code> variable holds an error message to display to the user in case too many candidates have been selected.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	In this example, you’ve declared each variable on its own line, but you could also declare groups of variables that have the same data types like so:</p>
<pre><code>declare v_race_id, v_votes_allowed, v_existing_votes int;
declare v_error_msg, v_race_name varchar(100);</code></pre>
<p class="Continued">Notice that all of the <code>int</code> variables are declared together on the same line, and all of the <code>varchar(100)</code> variables are declared together.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>In the first <code>select</code> statement <span class="CodeAnnotation" aria-label="annotation1">❶</span>, you use the <code>candidate_id</code> that is about to be inserted in the table—<code>new.candidate_id</code>—to get information about the race the candidate is running for. You join to the <code>race</code> table and get the <code>race_id</code>, <code>race_name</code>, and <code>votes_allowed</code> for the race and save them to variables <span class="CodeAnnotation" aria-label="annotation2">❷</span>.</p>
<p>In your second <code>select</code> statement, you get a count of how many votes already exist in the <code>ballot_candidate</code> table for this race and this ballot <span class="CodeAnnotation" aria-label="annotation3">❸</span>. You join to the <code>candidate</code> table to get the list of candidates that are running for this race. Then you count the number of rows in the <code>ballot_candidate</code> table with a row that has one of those candidates and this ballot ID.</p>
<p>If the <code>ballot_candidate</code> table already has the maximum number of votes for this ballot and this race, you’ll use the <code>signal</code> command with a <code>sqlstate</code> code of <code>45000</code> to exit from the trigger and prevent the new row from being written to the <code>ballot_candidate</code> table <span class="CodeAnnotation" aria-label="annotation4">❹</span>. You’ll display the error message that you stored in the <code>v_error_msg</code> variable to the user:</p>
<pre><code>Overvoting error: The Mayor race allows selecting a maximum of 1 candidate(s) per ballot.</code></pre>
<h4 id="h3-503007c17-0003"><a class="XrefDestination" id="BeforeUpdateTriggers"/><span class="XrefDestination" id="xref-503007c17-017"/>Before Update Triggers</h4>
<p class="BodyFirst">You also need to prevent users other than the secretary of state from updating voter rows by writing a <code>tr_voter_bu</code> trigger, as shown in <a href="#listing17-3" id="listinganchor17-3">Listing 17-3</a>.</p>
<pre><code>drop trigger if exists tr_voter_bu;

delimiter //

create trigger tr_voter_bu
  before update on voter
<span epub:type="pagebreak" title="289" id="Page_289"/>  for each row
begin
  if user() not like 'secretary_of_state%' then
    signal sqlstate '45000'
    set message_text = 'Voters can be updated only by the Secretary of State';
  end if;
end//

delimiter ;</code></pre>
<p class="CodeListingCaption"><a id="listing17-3">Listing 17-3</a>: Defining the <code>tr_voter_bu</code> trigger</p>
<p>This trigger will fire before a row is updated in the <code>voter</code> table.</p>
<p>Although the before insert and before update triggers are similar, there is no way to combine them into one trigger. MySQL doesn’t have a way to write a <code>before insert or update</code> trigger; it requires you to write two separate triggers instead. You can, however, call stored procedures from triggers. If two triggers shared similar functionality, you could add that functionality to a stored procedure and have each trigger call that procedure.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="boxcustom1">
<h2>Try It Yourself</h2>
<p class="BoxListNumberCustom1"><b>17-6.</b>	Using the <code>tr_voter_bu</code> trigger as a model, write the before update triggers for the <code>race</code> and <code>candidate</code> tables.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h4 id="h3-503007c17-0004"><a class="XrefDestination" id="BeforeDeleteTriggers"/><span class="XrefDestination" id="xref-503007c17-019"/>Before Delete Triggers</h4>
<p class="BodyFirst">Next you’ll write the <code>tr_voter_bd</code> trigger to prevent any user other than the secretary of state from deleting voter data (<a href="#listing17-4" id="listinganchor17-4">Listing 17-4</a>).</p>
<pre><code>drop trigger if exists tr_voter_bd;

delimiter //

create trigger tr_voter_bd
  before delete on voter
  for each row
begin
  if user() not like 'secretary_of_state%' then
    signal sqlstate '45000'
    set message_text = 'Voters can be deleted only by the Secretary of State';
  end if;
end//

delimiter ;</code></pre>
<p class="CodeListingCaption"><a id="listing17-4">Listing 17-4</a>: Defining the <code>tr_voter_bd</code> trigger</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="boxcustom1">
<h2><span epub:type="pagebreak" title="290" id="Page_290"/>Try It Yourself</h2>
<p class="BoxListNumberCustom1"><b>17-7.</b>	Using the <code>tr_voter_bd</code> trigger as a model, write the before delete triggers for the <code>race</code> and <code>candidate</code> tables.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-503007c17-0007"><a class="XrefDestination" id="AfterTriggers"/><span class="XrefDestination" id="xref-503007c17-021"/>After Triggers</h3>
<p class="BodyFirst">You’ll be writing triggers that fire <em>after</em> your data is inserted, updated, or deleted to track the changes made to your tables. But since the purpose of after triggers is to write rows to the audit tables, you need to create those audit tables first. These audit tables save a record of the changes made to the data in your tables, similar to those you saw in <a class="xref" href="c12.xhtml">Chapter 12</a>.</p>
<h4 id="h3-503007c17-0005"><a class="XrefDestination" id="AuditTables2"/><span class="XrefDestination" id="xref-503007c17-022"/>Audit Tables</h4>
<p class="BodyFirst">Name your audit tables with the <code>_audit</code> suffix. For example, you’ll track changes made to the <code>voter</code> table in the <code>voter_audit</code> table. You’ll name all audit tables this way so it’s clear what data they’re tracking.</p>
<p>Create the audit tables as shown in <a href="#listing17-5" id="listinganchor17-5">Listing 17-5</a>.</p>
<pre><code>create table voter_audit
(
  audit_datetime  datetime,
  audit_user      varchar(100),
  audit_change    varchar(1000)
);

create table ballot_audit
(
  audit_datetime  datetime,
  audit_user      varchar(100),
  audit_change    varchar(1000)
);

create table race_audit
(
  audit_datetime  datetime,
  audit_user      varchar(100),
  audit_change    varchar(1000)
);

create table candidate_audit
(
  audit_datetime  datetime,
  audit_user      varchar(100),
  audit_change    varchar(1000)
);

<span epub:type="pagebreak" title="291" id="Page_291"/>create table ballot_candidate_audit
(
  audit_datetime  datetime,
  audit_user      varchar(100),
  audit_change    varchar(1000)
);</code></pre>
<p class="CodeListingCaption"><a id="listing17-5">Listing 17-5</a>: Creating audit tables before defining your after triggers</p>
<p>All of your audit tables are defined with the same structure. Each table has an <code>audit_datetime</code> column that contains the date and time that the change was made, an <code>audit_user</code> column that contains the name of the user who made the changes, and an <code>audit_change</code> column that contains a description of the data that was changed. When you find data in your voting application that doesn’t seem right, you can look to these audit tables to find out more information.</p>
<p>Next, for each data table you’ll create three after triggers that fire after an <code>insert</code>, <code>update</code>, or <code>delete</code>. The names of the triggers are shown in <a href="#table17-1" id="tableanchor17-1">Table 17-1</a>.</p>
<figure>
<figcaption class="TableTitle"><p><a id="table17-1">Table 17-1</a>: After Trigger Names</p></figcaption>
<table id="table-503007c17-0003" border="1">
<thead>
<tr>
<td><b>Table</b></td>
<td><b>After insert triggers</b></td>
<td><b>After update triggers</b></td>
<td><b>After delete triggers</b></td>
</tr>
</thead>
<tbody>
<tr>
<td><code>voter</code></td>
<td><code>tr_voter_ai</code></td>
<td><code>tr_voter_au</code></td>
<td><code>tr_voter_ad</code></td>
</tr>
<tr>
<td><code>ballot</code></td>
<td><code>tr_ballot_ai</code></td>
<td><code>tr_ballot_au</code></td>
<td><code>tr_ballot_ad</code></td>
</tr>
<tr>
<td><code>race</code></td>
<td><code>tr_race_ai</code></td>
<td><code>tr_race_au</code></td>
<td><code>tr_race_ad</code></td>
</tr>
<tr>
<td><code>candidate</code></td>
<td><code>tr_candidate_ai</code></td>
<td><code>tr_candidate_au</code></td>
<td><code>tr_candidate_ad</code></td>
</tr>
<tr>
<td><code>ballot_candidate</code></td>
<td><code>tr_ballot_candidate_ai</code></td>
<td><code>tr_ballot_candidate_au</code></td>
<td><code>tr_ballot_candidate_ad</code></td>
</tr>
</tbody>
</table>
</figure>
<p>You’ll start with the <code>after_insert</code> trigger for each table.</p>
<h4 id="h3-503007c17-0006"><a class="XrefDestination" id="AfterInsertTriggers"/><span class="XrefDestination" id="xref-503007c17-023"/>After Insert Triggers</h4>
<p class="BodyFirst">The <code>tr_voter_ai</code> trigger will fire after new rows are inserted into the <code>voter</code> table, adding rows to the <code>voter_audit</code> table to track the new data (see <a href="#listing17-6" id="listinganchor17-6">Listing 17-6</a>).</p>
<pre><code>drop trigger if exists tr_voter_ai;

delimiter //

create trigger tr_voter_ai
  after insert on voter
<span class="CodeAnnotationCode" aria-label="annotation1">❶</span> for each row
begin
  insert into voter_audit
  (
    audit_datetime,
    audit_user,
    audit_change
<span epub:type="pagebreak" title="292" id="Page_292"/>  )
  values
  (
  <span class="CodeAnnotationHang" aria-label="annotation2">❷</span> now(),
    user(),
    concat(
    <span class="CodeAnnotationCode" aria-label="annotation3">❸</span> 'New Voter added -',
         ' voter_id: ',                   new.voter_id,
         ' voter_name: ',                 new.voter_name,
         ' voter_address: ',              new.voter_address,
         ' voter_county: ',               new.voter_county,
         ' voter_district: ',             new.voter_district,
         ' voter_precinct: ',             new.voter_precinct,
         ' voter_party: ',                new.voter_party,
         ' voting_location: ',            new.voting_location,
         ' voter_registration_num: ',     new.voter_registration_num
    )
  );
end//

delimiter ;</code></pre>
<p class="CodeListingCaption"><a id="listing17-6">Listing 17-6</a>: Defining the <code>tr_voter_ai</code> trigger</p>
<p>To create the trigger, you first check if the <code>tr_voter_ai</code> trigger already exists. If so, you drop it before re-creating it. Since a SQL <code>insert</code> statement can insert one row or many rows, you specify that for each row being inserted into the <code>voter</code> table, you want to write a single row to the <code>voter_audit</code> table <span class="CodeAnnotation" aria-label="annotation1">❶</span>.</p>
<p>In the <code>audit_datetime</code> column, you insert the current date and time using the <code>now()</code> function <span class="CodeAnnotation" aria-label="annotation2">❷</span>. In the <code>audit_user</code> column, you use the <code>user()</code> function to insert the name of the user who made the change. The <code>user()</code> function also returns the user’s hostname, so usernames are followed by an at sign (<code>@</code>) and a hostname, like <code>clerk_238@localhost</code>.</p>
<p>You use the <code>concat()</code> function in the <code>audit_change</code> column to build a string that shows the values that were inserted. You start with the text <code>New voter added -</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span> and get the inserted values by using the <code>new</code> keyword that’s available to you in <code>insert</code> triggers. For example, <code>new.voter_id</code> shows you the <code>voter_id</code> that was just inserted into the <code>voter</code> table.</p>
<p>After a new row is added to the <code>voter</code> table, the <code>tr_voter_ai</code> trigger fires and writes a row with values like the following to the <code>voter_audit</code> table:</p>
<pre><code>audit_datetime:  2024-05-04 14:13:04

audit_user:      secretary_of_state@localhost

audit_change:    New voter added – voter_id: 1 voter_name: Susan King
                 voter_address: 12 Pleasant St. Springfield
                 voter_county: Franklin voter_district: 12A voter_precinct: 4C
                 voter_party: Democrat voting_location: 523 Emerson St.
                 voter_registration_num: 129756</code></pre>
<p>The trigger writes the datetime, user (and hostname), and details about the new voter to the audit table.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="boxcustom1">
<h2><span epub:type="pagebreak" title="293" id="Page_293"/>Try It Yourself</h2>
<p class="BoxListNumberCustom1"><b>17-8.</b>	Using the <code>tr_voter_ai</code> trigger as a model, create the after insert trigger for the <code>ballot</code> table. The trigger should be called <code>tr_ballot_ai</code> and write to the <code>ballot_audit</code> table.</p>
<p class="ListBody">The trigger should use the <code>new</code> keyword to get the values for the columns. The columns in the <code>ballot</code> table are <code>ballot_id</code>, <code>voter_id</code>, <code>ballot_type</code>, and <code>ballot_cast_datetime</code>.</p>
<p class="ListBody">After you create the trigger, test it by inserting a new row into the <code>ballot</code> table, like so:</p>
<pre><code>insert into ballot
(
    voter_id,
    ballot_type,
    ballot_cast_datetime
)
values
(
    1,
    'in-person',
    now()
);</code></pre>
<p class="ListBody">For this <code>insert</code> statement to work, there must first be a row with a <code>voter_id</code> of <code>1</code> in the <code>voter</code> table, because <code>voter_id</code> in the <code>ballot</code> table is a foreign key that references <code>voter_id</code> in the <code>voter</code> table. For this reason, you need to do Exercise 17-2<span class="xref" itemid="xref_target_Exercise17-2"/> before you do this exercise to insert that voter row.</p>
<p class="ListBody">Did the new row you inserted into the <code>ballot</code> table get logged to the <code>ballot_audit</code> table? Query the <code>ballot_audit</code> table by typing <code class="bold">select * from ballot_audit;</code> and see if you get the results that you expected.</p>
<p class="BoxListNumberCustom1"><b>17-9.</b>	Write the after insert triggers for the <code>race</code>, <code>candidate</code>, and <code>ballot_candidate</code> tables. These triggers will be similar to the ones you’ve already written. You just need to change the trigger name, the data table name, the audit table name, and the list of columns.</p>
<p>To compare your code to the completed code in GitHub, go to <a href="https://github.com/ricksilva/mysql_cc/blob/main/chapter_17.sql" class="LinkURL">https://github.com/ricksilva/mysql_cc/blob/main/chapter_17.sql</a>.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h4 id="h3-503007c17-0007"><a class="XrefDestination" id="AfterDeleteTriggers"/><span class="XrefDestination" id="xref-503007c17-025"/>After Delete Triggers</h4>
<p class="BodyFirst">In <a href="#listing17-7" id="listinganchor17-7">Listing 17-7</a> you write the after delete trigger, called <code>tr_voter_ad</code>, which will fire after rows are deleted from the <code>voter</code> table and track the deletions in the <code>voter_audit</code> table.</p>
<pre><code>drop trigger if exists tr_voter_ad;

delimiter //

<span epub:type="pagebreak" title="294" id="Page_294"/>create trigger tr_voter_ad
<span class="CodeAnnotationCode" aria-label="annotation1">❶</span> after delete on voter
  for each row
begin
  insert into voter_audit
  (
    audit_datetime,
    audit_user,
    audit_change
  )
  values
  (
    now(),
    user(),
    concat(
      'Voter deleted -',
         ' voter_id: ',                   old.voter_id,
         ' voter_name: ',                 old.voter_name,
         ' voter_address: ',              old.voter_address,
         ' voter_county: ',               old.voter_county,
         ' voter_district: ',             old.voter_district,
         ' voter_precinct: ',             old.voter_precinct,
         ' voter_party: ',                old.voter_party,
         ' voting_location: ',            old.voting_location,
         ' voter_registration_num: ',     old.voter_registration_num
    )
  );
end//

delimiter ;</code></pre>
<p class="CodeListingCaption"><a id="listing17-7">Listing 17-7</a>: Defining the <code>tr_voter_ad</code> trigger</p>
<p>You define this trigger as <code>after delete</code> on the <code>voter</code> table <span class="CodeAnnotation" aria-label="annotation1">❶</span>. You use the <code>user()</code> and <code>now()</code> functions to get the user who deleted the <code>voter</code> row and the date and time at which the row was deleted. You build a string, using the <code>concat()</code> function, that shows the values that were deleted.</p>
<p>The after delete trigger looks similar to your after insert trigger, but you use the <code>old</code> keyword instead of <code>new</code>. You can precede your column names with <code>old</code> and a period to get their value. For example, use <code>old.voter_id</code> to get the value of the <code>voter_id</code> column for the row that was just deleted.</p>
<p>After a row is deleted from the <code>voter</code> table, the <code>tr_voter_ad</code> trigger fires and writes a row to the <code>voter_audit</code> table with values like the following:</p>
<pre><code>audit_datetime:  2024-05-04 14:28:54

audit_user:      secretary_of_state@localhost

audit_change:    Voter deleted – voter_id: 87 voter_name: Ruth Bain
                 voter_address: 887 Wyoming St. Centerville
                 voter_county: Franklin voter_district: 12A voter_precinct: 4C
                 voter_party: Republican voting_location: 523 Emerson St.
                 voter_registration_num: 45796</code></pre>
<p><span epub:type="pagebreak" title="295" id="Page_295"/>The trigger writes the datetime, user (and hostname), and details about the deleted voter record to the audit table.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="boxcustom1">
<h2>Try It Yourself</h2>
<p class="BoxListNumberCustom1"><b>17-10.</b>	Using the <code>tr_voter_ad</code> trigger as a model, create the after delete trigger for the <code>ballot</code> table. The trigger should be called <code>tr_ballot_ad</code> and should write to the <code>ballot_audit</code> table.</p>
<p class="ListBody">After you create the trigger, test it by deleting a row from the <code>ballot</code> table, like this:</p>
<pre><code>delete from ballot
where ballot_id = 1;</code></pre>
<p class="ListBody">Was the row that was deleted from the <code>ballot</code> table logged to the <code>ballot_audit</code> table? When you run the <code>select * from ballot_audit </code>query, do you see a record of the deleted row?</p>
<p class="BoxListNumberCustom1"><b>17-11.</b>	Create the after delete triggers for the other tables in your <code>voter</code> database. The triggers should be named <code>tr_race_ad</code>, <code>tr_candidate_ad</code>, and <code>tr_ballot_candidate_ad</code>. The triggers should write to the <code>race_audit</code>, <code>candidate_audit</code>, and <code>ballot_candidate_audit</code> tables, respectively.</p>
<p class="ListBody">You can test the triggers by deleting rows from the <code>race</code>, <code>candidate</code>, and <code>ballot_candidate</code> tables. When you query the audit tables, do you see a record of the deleted rows?</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h4 id="h3-503007c17-0008"><a class="XrefDestination" id="AfterUpdateTriggers"/><span class="XrefDestination" id="xref-503007c17-027"/>After Update Triggers</h4>
<p class="BodyFirst">Now you’ll write the after update trigger, <code>tr_voter_au</code>, which will fire after rows in the <code>voter</code> table are updated and track the change in the <code>voter_audit</code> table (<a href="#listing17-8" id="listinganchor17-8">Listing 17-8</a>).</p>
<pre><code>drop trigger if exists tr_voter_au;

delimiter //

create trigger tr_voter_au
  after update on voter
  for each row
begin
  set @change_msg = concat('Voter ',old.voter_id,' updated: ');

<span class="CodeAnnotationCode" aria-label="annotation1">❶</span> if (new.voter_name != old.voter_name) then
  <span class="CodeAnnotationCode" aria-label="annotation2">❷</span> set @change_msg =
        concat(
            @change_msg,
            'Voter name changed from ',
            old.voter_name,
            ' to ',
<span epub:type="pagebreak" title="296" id="Page_296"/>            new.voter_name
        );
  end if;

  if (new.voter_address != old.voter_address) then
    set @change_msg =
        concat(
            @change_msg,
            '. Voter address changed from ',
            old.voter_address,
            ' to ',
            new.voter_address
    );
  end if;

  if (new.voter_county != old.voter_county) then
    set @change_msg =
        concat(
            @change_msg,
            '. Voter county changed from ', old.voter_county, ' to ',
            new.voter_county
        );
  end if;

  if (new.voter_district != old.voter_district) then
    set @change_msg =
        concat(
            @change_msg,
            '. Voter district changed from ',
            old.voter_district,
            ' to ',
            new.voter_district
        );
  end if;

  if (new.voter_precinct != old.voter_precinct) then
    set @change_msg =
        concat(
            @change_msg,
            '. Voter precinct changed from ',
            old.voter_precinct,
            ' to ',
            new.voter_precinct
        );
  end if;

  if (new.voter_party != old.voter_party) then
    set @change_msg =
        concat(
            @change_msg,
            '. Voter party changed from ',
            old.voter_party,
            ' to ',
<span epub:type="pagebreak" title="297" id="Page_297"/>            new.voter_party
        );
  end if;

  if (new.voting_location != old.voting_location) then
    set @change_msg =
        concat(
            @change_msg,
            '. Voting location changed from ',
            old.voting_location, '
            to ',
            new.voting_location
        );
  end if;

  if (new.voter_registration_num != old.voter_registration_num) then
     set @change_msg =
         concat(
             @change_msg,
             '. Voter registration number changed from ',
             old.voter_registration_num,
             ' to ',
             new.voter_registration_num
         );
  end if;

insert into voter_audit(
    audit_datetime,
    audit_user,
    audit_change
    )
values (
    now(),
    user(),
  <span class="CodeAnnotationCode" aria-label="annotation3">❸</span> @change_msg
    );

end//

delimiter ;</code></pre>
<p class="CodeListingCaption"><a id="listing17-8">Listing 17-8</a>: Defining the <code>tr_voter_au</code> trigger</p>
<p>Because the after update trigger fires after a row gets updated in a table, it can take advantage of both the <code>new</code> and <code>old</code> keywords. For example, you can see if the <code>voter_name</code> column value was updated in the <code>voter</code> table by checking <code>new.voter_name != old.voter_name</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>. If the new value of the voter’s name isn’t the same as the old value, it was updated, and you’ll save that information to write to the <code>audit</code> table.</p>
<p>For your <code>insert</code> and <code>delete</code> triggers, you wrote the values for <em>all</em> the columns in the <code>voter</code> table to the <code>voter_audit</code> table, but for your <code>update</code> trigger, you’ll report only on the column values that changed.</p>
<p><span epub:type="pagebreak" title="298" id="Page_298"/>For example, if you ran this <code>update</code> statement</p>
<pre><code>update voter
set    voter_name = 'Leah Banks-Kennedy',
       voter_party = 'Democrat'
where  voter_id = 5876;</code></pre>
<p class="BodyContinued">your <code>update</code> trigger would write a row to the <code>voter_audit</code> table with just these changes:</p>
<pre><code>audit_datetime:  2024-05-08 11:08:04

audit_user:      secretary_of_state@localhost

audit_change:    Voter 5876 updated: Voter name changed from Leah Banks
                 to Leah Banks-Kennedy. Voter party changed from Republican
                 to Democrat</code></pre>
<p>Since there were only two column values that changed, <code>voter_name</code> and <code>voter_party</code>, you’ll write those two changes to your audit table.</p>
<p>To capture the changes that were made, you create a variable called <code>@change_msg</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Using <code>if</code> statements, you check if each column value changed. When a column’s value has changed, you use the <code>concat()</code> function to add information about that column’s changes to the end of the existing <code>@change_msg</code> string variable. Once you’ve checked all of the column values for changes, you write the value of <code>@change_msg</code> variable to the <code>audit_change</code> column of the audit table <span class="CodeAnnotation" aria-label="annotation3">❸</span>. You also write to the audit table the username of the person who made the change to the <code>audit_user</code> column, and the date and time that the change was made to the <code>audit_datetime</code> column.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="boxcustom1">
<h2>Try It Yourself</h2>
<p class="BoxListNumberCustom1"><b>17-12.</b>	Using the <code>tr_voter_au</code> trigger as a model, create the after update trigger for the <code>ballot</code> table. The trigger should be called <code>tr_ballot_au</code> and should write to the <code>ballot_audit</code> table.</p>
<p class="ListBody">After you create the trigger, you can test it by updating a row in the <code>ballot</code> table:</p>
<pre><code>update ballot
set    ballot_type = 'absentee'
where  ballot_id = 1;</code></pre>
<p class="ListBody">Was the value that was updated in the <code>ballot</code> table logged to the <code>ballot_audit</code> table? When you run the <code>select * from ballot_audit</code> query, do you see a record of the updated value?</p>
<p class="BoxListNumberCustom1"><span epub:type="pagebreak" title="299" id="Page_299"/><b>17-13.</b>	Create the after update triggers for the other tables in your <code>voter</code> database. The triggers should be named <code>tr_race_au</code>, <code>tr_candidate_au</code>, and <code>tr_ballot_candidate_au</code>. The triggers should write to the <code>race_audit</code>, <code>candidate_audit</code>, and <code>ballot_candidate_audit</code> tables, respectively.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>You’ve successfully built a database that not only stores your election data, but also includes constraints and triggers that keep the data at a high quality.</p>
<h2 id="h1-503007c17-0004"><a class="XrefDestination" id="AlternativeApproaches"/><span class="XrefDestination" id="xref-503007c17-029"/>Alternative Approaches</h2>
<p class="BodyFirst">As with the <code>weather</code> database project in the previous chapter, there are numerous approaches to writing this <code>voter</code> database.</p>
<h3 id="h2-503007c17-0008"><a class="XrefDestination" id="AuditTables"/><span class="XrefDestination" id="xref-503007c17-030"/>Audit Tables</h3>
<p class="BodyFirst">In this project, you created five different audit tables. Instead, you could have created just one audit table and written all of the audit records there. Alternatively, you could have created 15 audit tables: three for each table. For example, rather than auditing voter inserts, deletes, and updates to the <code>voter_audit</code> table, you could have audited new voters to a table called <code>voter_audit_insert</code>, changes to voters to <code>voter_audit_update</code>, and deletions to <code>voter_audit_delete</code>.</p>
<h3 id="h2-503007c17-0009"><a class="XrefDestination" id="TriggersvsPrivileges"/><span class="XrefDestination" id="xref-503007c17-031"/>Triggers vs. Privileges</h3>
<p class="BodyFirst">Rather than using triggers to control which users can update which tables, your database administrator could have done this by granting and revoking these privileges to and from your database users. The advantage of using triggers is that you’re able to display a customized message to the user explaining the problem, like <code>Voters can be added only by the Secretary of State</code>.</p>
<h3 id="h2-503007c17-0010"><a class="XrefDestination" id="ReplacingcheckConstraintswithNewTables"/><span class="XrefDestination" id="xref-503007c17-032"/>Replacing check Constraints with New Tables</h3>
<p class="BodyFirst">When you created the <code>ballot</code> table, you used the following <code>check</code> constraint to make sure that the <code>ballot_type</code> column has a value of <code>in-person</code> or <code>absentee</code>:</p>
<pre><code>constraint check(ballot_type in ('in-person', 'absentee'))</code></pre>
<p>Another approach would have been to create a <code>ballot_type</code> table that has rows for each ballot type, like this:</p>
<pre><code>ballot_type_id  ballot_type
--------------  ---------------
       1        in-person
       2        absentee</code></pre>
<p><span epub:type="pagebreak" title="300" id="Page_300"/>You could have added a table, named <code>ballot_type</code>, and made the <code>ballot_type_id</code> column the primary key. If you did, you would save the <code>ballot_type_id</code> instead of the <code>ballot_type</code> in the <code>ballot</code> table. This would look like <a href="#figure17-3" id="figureanchor17-3">Figure 17-3</a>.</p>
<figure>
<img src="image_fi/503007c17/f17003.png" class="" alt="" width="565" height="203"/>
<figcaption><p><a id="figure17-3">Figure 17-3</a>: Creating a <span class="LiteralInCaption"><code>ballot_type</code></span> table to store ballot types</p></figcaption>
</figure>
<p>One advantage to this approach is that you could add new ballot types, like <code>military</code> or <code>overseas</code>, without having to change the definition of the <code>ballot</code> table. It’s also more efficient for each row of the <code>ballot</code> table to save an ID representing the ballot type, like <code>3</code>, rather than saving the full name, like <code>absentee</code>.</p>
<p>You could have used a similar approach for the <code>voter</code> table. Instead of creating the <code>voter</code> table with the columns <code>voter_county</code>, <code>voter_district</code>, <code>voter_precinct</code>, and <code>voter_party</code>, you could have built the table to save just the IDs: <code>voter_county_id</code>, <code>voter_district_id</code>, <code>voter_precinct_id</code>, and <code>voter_party_id</code> and referenced new tables named <code>county</code>, <code>district</code>, <code>precinct</code>, and <code>party</code> to get the list of valid IDs.</p>
<p>There is plenty of room for creativity when creating databases, so don’t feel as though you need to strictly follow the approach I’ve used in this project. Try any of these alternative approaches and see how they work for you!</p>
<h2 id="h1-503007c17-0005"><a class="XrefDestination" id="Summary"/><span class="XrefDestination" id="xref-503007c17-033"/>Summary</h2>
<p class="BodyFirst">In this chapter, you built a voting database that stores data for an election. You prevented data integrity problems using constraints and triggers, and tracked changes to your data using audit tables. You also saw some possible alternative approaches to this project. In the third and final project, you’ll use views to hide sensitive salary data.</p>
</section>
</div>
</div>
</body></html>