<html><head></head><body>
<h2 class="h2" id="ch5"><span epub:type="pagebreak" id="page_109"/><span class="big"><strong>5</strong></span></h2>&#13;
<h2 class="h2a">POLISHING YOUR APP BY ADDING MENUS AND PREFERENCES</h2>&#13;
<div class="image21"><img src="../images/circle.jpg" alt="Image"/></div>&#13;
<p class="noindent">You’ve written a fun Android app, but it’s still missing a few things. You haven’t learned how to build a settings or options menu in Android or how to save high scores, game stats, and other information. In this chapter, we’ll add an options menu to our Hi-Lo guessing game app and the capability to store information.</p>&#13;
<h3 class="h3"><a id="toc_lev84"/>Adding an Options Menu in Android</h3>&#13;
<p class="noindent">Most apps and games have options or settings that the user can access through a menu. For the Hi-Lo guessing game, we might want to allow the user to change the game’s difficulty level, start over, see their game stats, or view an About screen, so we’ll create a menu that can perform all of these actions.</p>&#13;
<p class="indentb"><span epub:type="pagebreak" id="page_110"/>There are four general steps to adding an options menu in Android:</p>&#13;
<p class="order">1. Edit the app’s default XML menu file to create items that will serve as the options the user can select.</p>&#13;
<p class="order">2. Modify the app’s activity file to display the menu and options that we created in the previous step.</p>&#13;
<p class="order">3. Create an event handler to determine when the user selects an option.</p>&#13;
<p class="order">4. Write the code to execute for each option when the user selects it.</p>&#13;
<p class="indentt">Adding the options menu not only will make our app look and feel more professional but will also give the user greater control over their gaming experience. My sons loved being able to change the range of the guessing game from 1 to 10, then 1 to 100, then 1 to 1,000, but when we added the Game Stats option that displays the number of games won, I almost couldn’t get my device back from them—they wanted to keep running the number higher and higher! I hope you’ll find these extra features as fun (and maybe as addictive) as they did.</p>&#13;
<h4 class="h4"><em><a id="toc_lev85"/>Adding Items to the Menu’s XML File</em></h4>&#13;
<p class="noindent">Open your Hi-Lo guessing game project in Android Studio and, in the Project Explorer pane, change the view at the top left to <strong>Android</strong>. Then, open the default menu file by expanding <strong>app</strong> <span class="ent">▸</span> <strong>res</strong> <span class="ent">▸</span> <strong>menu</strong> and double-clicking <em>menu_main.xml</em>.</p>&#13;
<p class="indent">Change the XML code in your <em>menu_main.xml</em> file to match the following listing:</p>&#13;
<p class="pre">&lt;menu xmlns:android="http://schemas.android.com/apk/res/android"&gt;<br/>&#13;
    &lt;item<br/>&#13;
        android:id="@+id/action_settings"<br/>&#13;
        android:title="Settings" /&gt;<br/>&#13;
    &lt;item<br/>&#13;
        android:id="@+id/action_newgame"<br/>&#13;
        android:title="New Game" /&gt;<br/>&#13;
    &lt;item<br/>&#13;
        android:id="@+id/action_gamestats"<br/>&#13;
        android:title="Game Stats" /&gt;<br/>&#13;
    &lt;item<br/>&#13;
        android:id="@+id/action_about"<br/>&#13;
        android:title="About" /&gt;<br/>&#13;
&lt;/menu&gt;<br/>&#13;
</p>&#13;
<p class="indent">The <span class="literal">&lt;menu&gt;</span> tag creates a menu resource using the XML namespace for Android XML documents, identified by the uniform resource identifier (URI) <em>http://schemas.android.com/apk/res/android</em>. We can use XML to store or display everything from web pages to databases by connecting XML <span epub:type="pagebreak" id="page_111"/>tags to those elements. The <span class="literal">xmlns</span> (XML namespace) attribute in this code selects the main Android namespace so that the tags in this XML file will refer to common elements in an Android application. So, the <span class="literal">&lt;menu&gt;</span> tag refers to an Android menu, and each <span class="literal">&lt;item&gt;</span> tag describes an item or entry in that menu with attributes. This menu will have the four options Settings, New Game, Game Stats, and About, so we add four <span class="literal">&lt;item&gt;</span> tags. We assign those names to each item’s <span class="literal">title</span> attribute, which determines the text displayed for each option when the user opens the menu. We’ll use the <span class="literal">id</span> attribute later in our code to determine which option the user has selected.</p>&#13;
<p class="indent">Save the <em>menu_main.xml</em> file. Now it’s time to display our options menu in the Hi-Lo guessing game app.</p>&#13;
<h4 class="h4"><em><a id="toc_lev86"/>Displaying the Options Menu</em></h4>&#13;
<p class="noindent">We’ve set up the menu, but in order to display it, we need to add some Java code to our app’s <em>MainActivity.java</em> file. Open <em>MainActivity.java</em> in the Project Explorer pane under <strong>app</strong> <span class="ent">▸</span> <strong>java</strong> <span class="ent">▸</span> <strong>com.</strong><em><strong>yourdomain</strong></em><strong>.GuessingGame</strong>.</p>&#13;
<p class="indent">Near the middle or bottom of the <span class="literal">MainActivity</span> class, you should find a method called <span class="literal">onCreateOptionsMenu()</span>. Modify it to match the code snippet below. (If your code doesn’t have the <span class="literal">onCreateOptionsMenu()</span> method, add the following code after the closing brace of <span class="literal">onCreate()</span> but before the final closing brace for <span class="literal">MainActivity</span>.)</p>&#13;
<p class="pre">   public boolean onCreateOptionsMenu(Menu menu) {<br/>&#13;
       MenuInflater inflater = getMenuInflater();<br/>&#13;
       inflater.inflate(R.menu.<span class="codeitalic">menu_main</span>, menu);<br/>&#13;
       return true;<br/>&#13;
   } <br/>&#13;
<span class="ash">} // Final closing brace of the MainActivity.java file</span><br/>&#13;
</p>&#13;
<p class="indent">The <span class="literal">onCreateOptionsMenu()</span> method does exactly what its name implies—it tells Android what to do when creating the options menu for our app. In this case, we tell Android we want to expand the <em>menu_main.xml</em> file to serve as our options menu. The <em>menu_main.xml</em> file isn’t a menu yet, so we need to convert it into a menu using a class called a <span class="literal">MenuInflator</span>. We’ll create a <span class="literal">MenuInflator</span> instance, which we call <span class="literal">inflater</span>, by using the <span class="literal">getMenuInflator()</span> method. Once we have <span class="literal">inflater</span>, we call the <span class="literal">inflate()</span> method and pass it the XML file (<span class="literal">R.menu.menu_main</span>) and the menu we want the XML file’s items to inflate into (<span class="literal">menu</span>). You may need to press <small>ALT</small>-<small>ENTER</small> (on macOS, <small>OPTION</small>-<small>ENTER</small>) to correct any missing <span class="literal">import</span> statements as you add the code to your file.</p>&#13;
<p class="indent">After making this change, save and run the app. Android lets you know there’s an options menu available by displaying the three dots in the action bar of your app (see <a href="ch5.xhtml#ch5fig1">Figure 5-1</a>, top). Clicking the dots will display the options menu (see <a href="ch5.xhtml#ch5fig1">Figure 5-1</a>, bottom).</p>&#13;
<div class="imagef"><span epub:type="pagebreak" id="page_112"/><img src="../images/f0112-01.jpg" alt="Images"/></div>&#13;
<p class="fig-cap"><em><a id="ch5fig1"/>Figure 5-1: The options menu shows up as three dots in the app’s action bar (top). Clicking the three dots will expand the options menu (bottom).</em></p>&#13;
<p class="indent">You’ll notice that clicking the options doesn’t do anything yet because we haven’t added the code to respond to user selections. We’ll do that next.</p>&#13;
<h4 class="h4"><em><a id="toc_lev87"/>Responding to User Selections</em></h4>&#13;
<p class="noindent">When the user chooses an option from the menu, we want our app to perform the requested action. In order for our app to do that, we need to add an event handler that keeps track of which option was selected. We’ll use the <span class="literal">id</span> attribute associated with each item to tell selections apart.</p>&#13;
<p class="indent">In the <em>MainActivity.java</em> file, find and modify the <span class="literal">onOptionsItemSelected()</span> event handler method. Alternatively, you can add it right below the method <span class="literal">onCreateOptionsMenu()</span> that we modified in the previous section, but before the closing brace on the final line of the file.</p>&#13;
<p class="pre">   <span class="ash">public boolean onCreateOptionsMenu(Menu menu) {</span><br/>&#13;
       <span class="ash">MenuInflater inflater = getMenuInflater();</span><br/>&#13;
       <span class="ash">inflater.inflate(R.menu.<span class="codeitalic">menu_main</span>, menu);</span><br/>&#13;
       <span class="ash">return true;</span><br/>&#13;
   }<br/>&#13;
   public boolean onOptionsItemSelected(MenuItem item) {<br/>&#13;
       switch (item.getItemId()) {<br/>&#13;
           case R.id.<span class="codeitalic">action_settings</span>:<br/>&#13;
               return true;<br/>&#13;
           case R.id.<span class="codeitalic">action_newgame</span>:<br/>&#13;
               newGame();<br/>&#13;
               return true;<br/>&#13;
           case R.id.<span class="codeitalic">action_gamestats</span>:<br/>&#13;
               return true;<br/>&#13;
           case R.id.<span class="codeitalic">action_about</span>:<br/>&#13;
               return true;<br/>&#13;
           default:<br/>&#13;
               return super.onOptionsItemSelected(item);<br/>&#13;
       }<br/>&#13;
   }<br/>&#13;
<span class="ash">}</span></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_113"/>In this code, we use a <span class="literal">switch</span> statement to determine which of the options the user selected on the menu. A <span class="literal">switch</span> statement is another way of testing multiple conditions, similar to a long chain of <span class="literal">if-else</span> statements. Rather than chaining four <span class="literal">if-else</span> statements to test for each possible menu item selection, though, we can use a single <span class="literal">switch</span> statement, with the variable we’re testing inside parentheses after the <span class="literal">switch</span> keyword. In this example, we’re checking the <span class="literal">id</span> of the menu item the user selected, so we use <span class="literal">switch (item.getItemId())</span>. Then, inside the braces for the <span class="literal">switch</span> statement, we list the values we want to test as <span class="literal">case</span> statements (e.g., <span class="literal">case R.id.action_settings</span>), each of which is followed by a colon (<span class="literal">:</span>), the code to run for that selection, and either a <span class="literal">break</span> or <span class="literal">return</span> statement. This event handler returns a Boolean value, so we’ve used <span class="literal">return</span> statements instead of <span class="literal">break</span> statements in each <span class="literal">case</span> block. If we didn’t have <span class="literal">return</span> statements here, we would need to use a <span class="literal">break</span> command as the final statement of each case.</p>&#13;
<p class="indent">Each <span class="literal">case</span> statement in this code tests for one of the <span class="literal">id</span> values of the items we entered in the <em>menu_main.xml</em> file, and the code for each value will execute in response to the user’s selection. Right now, we have code only for the <span class="literal">action_newgame</span> case, which starts a new game using the <span class="literal">newGame()</span> method. The other cases require writing a bit more code, so we’ll define those one at a time.</p>&#13;
<h4 class="h4"><em><a id="toc_lev88"/>Creating an Alert Dialog Pop-up for the About Screen</em></h4>&#13;
<p class="noindent">For the About menu option, we’ll pop up a dialog window similar to other applications you’ve likely seen. To do this, we’ll use an <em>alert dialog</em>, a flexible pop-up used to inform the user about something or to prompt them for a response. This kind of pop-up is more adaptable than the Toast pop-up we used in <a href="ch4.xhtml#ch4">Chapter 4</a> (Programming Challenge #1 on <a href="ch4.xhtml#page_106">page 106</a>), because the <span class="literal">AlertDialog</span> class allows us to customize the properties of our dialog through the <span class="literal">Builder</span> subclass. In this case, we’ll use an alert dialog to respond to the user selecting the About option with a message telling them who created the awesome Hi-Lo guessing game they’ve been playing.</p>&#13;
<p class="indent">Add the following code to the <span class="literal">case</span> statement for the <span class="literal">action_about</span> item selection:</p>&#13;
<p class="pre"><span class="ash">case R.id.<span class="codeitalic">action_about</span>:</span><br/>&#13;
  <span class="ent">➊</span> AlertDialog aboutDialog = new AlertDialog.Builder(MainActivity.this).create();<br/>&#13;
  <span class="ent">➋</span> aboutDialog.setTitle("About Guessing Game");<br/>&#13;
  <span class="ent">➌</span> aboutDialog.setMessage("(c)2018 <span class="codestrong"><span class="codeitalic">Your Name</span></span>.");<br/>&#13;
  <span class="ent">➍</span> aboutDialog.setButton(AlertDialog.BUTTON_NEUTRAL, "OK",<br/>&#13;
             new DialogInterface.OnClickListener() {<br/>&#13;
                 public void onClick(DialogInterface dialog, int which) {<br/>&#13;
                   <span class="ent">➎</span> dialog.dismiss();<br/>&#13;
                 }<br/>&#13;
             });<br/>&#13;
  <span class="ent">➏</span> aboutDialog.show();&#13;
    <span class="ash">return true;</span><br/>&#13;
</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_114"/>We use the <span class="literal">AlertDialog.Builder</span> class <span class="ent">➊</span> to create a customized popup window. The code at <span class="ent">➋</span> sets the title of the pop-up window to <span class="literal">"About Guessing Game"</span>, and the line at <span class="ent">➌</span> displays a simple message with copyright information and your name (though you can write any text you’d like here). The <span class="literal">setButton()</span> method <span class="ent">➍</span> adds a button to the pop-up with the text <span class="literal">"OK"</span>, and the subsequent <span class="literal">onClick()</span> event listener closes the pop-up whenever the user clicks the OK button by calling the <span class="literal">dismiss()</span> method <span class="ent">➎</span>. Finally, the customized pop-up is shown with the <span class="literal">show()</span> command <span class="ent">➏</span>.</p>&#13;
<p class="indent">Use <small>ALT</small>-<small>ENTER</small> (or <small>OPTION</small>-<small>ENTER</small>) to import the <span class="literal">AlertDialog</span> class. Then save your updated code and run the new version of the app. When you click the options menu and select the About option, you should see a pop-up window like the one in <a href="ch5.xhtml#ch5fig2">Figure 5-2</a>.</p>&#13;
<div class="imagef"><img src="../images/f0114-01.jpg" alt="Images"/></div>&#13;
<p class="fig-cap"><em><a id="ch5fig2"/>Figure 5-2: A custom alert dialog pop-up</em></p>&#13;
<p class="indent">The Hi-Lo guessing game app is beginning to feel even more like a professional Android app! Now let’s knock it out of the park by allowing the user to choose the difficulty level of the game and to keep track of how many games they’ve won.</p>&#13;
<h3 class="h3"><a id="toc_lev89"/>Changing the Guessing Range</h3>&#13;
<p class="noindent">Letting the user choose the guessing range—say, from 1 to 10, 1 to 100, or 1 to 1,000—would be a huge enhancement. Now that you understand option menus and alert dialogs, let’s map out how we might upgrade the game to allow the user to change the range setting.</p>&#13;
<p class="indent">First, we’ll need to add a variable for the range so that instead of using a hardcoded value of <span class="literal">100</span>, we’ll use the user’s chosen range. Second, we’ll need to modify the app’s behavior in a couple of ways. We’ll change the <span class="literal">newGame()</span> method to use the new range variable. We’ll also make the <span class="literal">TextView</span> that currently reads, <span class="literal">"Enter a number between 1 and 100:"</span> display a different prompt depending on the range selected. Finally, we’ll need to give the user a method of choosing the range. We’ll do this by building another custom alert dialog with the three range selections: 1 to 10, 1 to 100, and 1 to 1,000.</p>&#13;
<h4 class="h4"><span epub:type="pagebreak" id="page_115"/><em><a id="toc_lev90"/>Adding a Variable for the Range</em></h4>&#13;
<p class="noindent">First, we’ll replace the hardcoded value of <span class="literal">100</span> we use in the random number calculation with a variable. At the top of the <span class="literal">MainActivity</span> class, add a variable for the <span class="literal">range</span> and set it to a default value of <span class="literal">100</span>:</p>&#13;
<p class="pre"><span class="ash">public class MainActivity extends AppCompatActivity {</span><br/>&#13;
    <span class="ash">private EditText txtGuess;</span><br/>&#13;
    <span class="ash">private Button btnGuess;</span><br/>&#13;
    <span class="ash">private TextView lblOutput;</span><br/>&#13;
    <span class="ash">private int theNumber;</span><br/>&#13;
    private int range = 100;<br/>&#13;
</p>&#13;
<p class="indent">While we’re adding variables, let’s also add a second <span class="literal">TextView</span> for the label that reads, <span class="literal">"Enter a number between 1 and 100:"</span>. When the user selects a range other than 1 to 100, this label will no longer be correct, so we need a variable to store the appropriate text to display. We’ll create the variable called <span class="literal">lblRange</span> to do this:</p>&#13;
<p class="pre">     <span class="ash">private int range = 100;</span><br/>&#13;
     private TextView lblRange;</p>&#13;
<p class="indent">To wire up the GUI to the <span class="literal">lblRange</span> variable, add the following line of code to the <br/><span class="literal">onCreate()</span> method:</p>&#13;
<p class="pre"><span class="ash">protected void onCreate(Bundle savedInstanceState) {</span><br/>&#13;
    <span class="ash">super.onCreate(savedInstanceState);</span><br/>&#13;
    <span class="ash">setContentView(R.layout.<span class="codeitalic">activity_main</span>);</span><br/>&#13;
    <span class="ash">txtGuess = (EditText) findViewById(R.id.<span class="codeitalic">txtGuess</span>);</span><br/>&#13;
    <span class="ash">btnGuess = (Button) findViewById(R.id.<span class="codeitalic">btnGuess</span>);</span><br/>&#13;
    <span class="ash">lblOutput = (TextView) findViewById(R.id.<span class="codeitalic">lblOutput</span>);</span><br/>&#13;
    lblRange = (TextView) findViewById(R.id.<span class="codeitalic">textView2</span>);<br/>&#13;
</p>&#13;
<p class="indent">If you get an error, check the name of your prompt’s <span class="literal">TextView</span> in the design view: open <strong>app</strong> <span class="ent">▸</span> <strong>res</strong> <span class="ent">▸</span> <strong>layout</strong> <span class="ent">▸</span> <em><strong>content_main.xml</strong></em> and click the label reading <span class="literal">"Enter a number between 1 and 100:"</span>. Change the label’s <span class="literal">id</span> property to <span class="literal">textView2</span>.</p>&#13;
<p class="indent">With the <span class="literal">range</span> and <span class="literal">lblRange</span> variables set up, it’s time to modify the behavior of the app to use these variables instead of hardcoded values.</p>&#13;
<h4 class="h4"><em><a id="toc_lev91"/>Using the range Variable</em></h4>&#13;
<p class="noindent">First, let’s modify the <span class="literal">newGame()</span> method to use the <span class="literal">range</span> variable. Let’s also add the code needed to change the prompt to let the user know the correct range to guess from:</p>&#13;
<p class="pre"><span class="ash">public void newGame() {</span><br/>&#13;
    theNumber = (int)(Math.<span class="codeitalic">random</span>() * range + 1);<br/>&#13;
    lblRange.setText("Enter a number between 1 and " + range + ".");<br/>&#13;
    txtGuess.setText("" + range/2);<br/>&#13;
    txtGuess.requestFocus();<br/>&#13;
    txtGuess.selectAll();<br/>&#13;
<span class="ash">}</span><br/>&#13;
</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_116"/>In addition to using <span class="literal">range</span> to set the random number correctly, we’ve changed the <span class="literal">lblRange</span> prompt to use the <span class="literal">range</span> variable as well. The last three lines are a finishing touch—I’ve taken the liberty of entering a default starting value in the <span class="literal">txtGuess</span> text box, one half of the <span class="literal">range</span>. So, if the user is guessing between 1 and 10, the guessing text field will show 5 as a default first guess; if the range is 1,000, the text field will recommend 500 for the first guess.</p>&#13;
<p class="indent">One last range-related change is found in the <span class="literal">checkGuess()</span> method. We added a <span class="literal">try-catch</span> statement to handle bad user input, and in the <span class="literal">catch</span> statement, we tell the user to enter a valid whole number in the range from 1 to 100. Let’s change just the <span class="literal">catch</span> statement to reflect the user’s selected range:</p>&#13;
<p class="pre"><span class="ash">public void checkGuess() {</span><br/>&#13;
<span class="ash"> --<span class="codeitalic">snip</span>--</span><br/>&#13;
       <span class="ash">}</span><br/>&#13;
   <span class="ash">} catch (Exception e) {</span><br/>&#13;
      message = "Enter a whole number between 1 and " + range + ".";<br/>&#13;
    <span class="ash">} finally {</span><br/>&#13;
<span class="ash">--<span class="codeitalic">snip</span>--</span><br/>&#13;
    <span class="ash">}</span><br/>&#13;
<span class="ash">}</span><br/>&#13;
</p>&#13;
<p class="indent">Now both <span class="literal">TextView</span> labels will display the user’s selected range correctly. It’s time to build the alert dialog to allow the user to select the difficulty level of their game.</p>&#13;
<h4 class="h4"><em><a id="toc_lev92"/>Building the Dialog to Allow the User to Select the Range</em></h4>&#13;
<p class="noindent">The range settings dialog should display all the range options (1 to 10, 1 to 100, and 1 to 1,000) to the user whenever they select the Settings option in the menu. To display the list of options, we’ll build another customized alert dialog, but this one will display a list view of the three range options.</p>&#13;
<p class="indent">First, scroll back down to your <span class="literal">onOptionsItemSelected()</span> method and add the following code inside the <span class="literal">case</span> statement for <span class="literal">action_settings</span>:</p>&#13;
<p class="pre"><span class="ash">public boolean onOptionsItemSelected(MenuItem item) {</span><br/>&#13;
    <span class="ash">switch (item.getItemId()) {</span><br/>&#13;
        <span class="ash">case R.id.<span class="codeitalic">action_settings</span>:</span><br/>&#13;
             final CharSequence[] items = {"1 to 10", "1 to 100", "1 to 1000"};<br/>&#13;
             AlertDialog.Builder builder = new AlertDialog.Builder(this);<br/>&#13;
             builder.setTitle("Select the Range:");<br/>&#13;
             builder.setItems(items, null);<br/>&#13;
             AlertDialog alert = builder.create();<br/>&#13;
             alert.show();<br/>&#13;
             <span class="ash">return true;</span><br/>&#13;
</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_117"/>These six lines of code will display an alert dialog with a list view of the three options for the guessing range, but we need to add just a bit more code to handle the user’s selection. The <span class="literal">builder.setItems()</span> method will accept both a list of items and an event listener to handle the user’s choice from the list.</p>&#13;
<p class="indent">If the user selects the first option, we need to change the value of the <span class="literal">range</span> variable to <span class="literal">10</span>, and likewise for the second and third options to <span class="literal">100</span> and <span class="literal">1000</span>, respectively. The code for the event listener goes inside the <span class="literal">builder.setItems()</span> statement:</p>&#13;
<p class="pre">   <span class="ash">case R.id.<span class="codeitalic">action_settings</span>:</span><br/>&#13;
      <span class="ash">final CharSequence[] items = {"1 to 10", "1 to 100", "1 to 1000"};</span><br/>&#13;
      <span class="ash">AlertDialog.Builder builder = new AlertDialog.Builder(this);</span><br/>&#13;
      <span class="ash">builder.setTitle("Select the Range:");</span><br/>&#13;
      builder.setItems(items, new DialogInterface.OnClickListener() {<br/>&#13;
          public void onClick(DialogInterface dialog, int item) {<br/>&#13;
             switch(item) {<br/>&#13;
                case 0:<br/>&#13;
                     range = 10;<br/>&#13;
                     newGame();<br/>&#13;
                     break;<br/>&#13;
                case 1:<br/>&#13;
                     range = 100;<br/>&#13;
                     newGame();<br/>&#13;
                     break;<br/>&#13;
                case 2:<br/>&#13;
                     range = 1000;<br/>&#13;
                     newGame();<br/>&#13;
                     break;<br/>&#13;
             }<br/>&#13;
             dialog.dismiss();<br/>&#13;
        }<br/>&#13;
    });<br/>&#13;
    <span class="ash">AlertDialog alert = builder.create();</span><br/>&#13;
    <span class="ash">alert.show();</span><br/>&#13;
    <span class="ash">return true;</span><br/>&#13;
</p>&#13;
<p class="indent">Notice that after we set the new range for each item selection, we call <span class="literal">newGame()</span> to create a new random number in that range and to change the prompt on the user’s screen to reflect the new range.</p>&#13;
<p class="indent">Save the file after making these changes and run the game to test the new options. Change the range from 1 to 10 and guess a few rounds, then go back to 1 to 100, and if you’re brave, go for 1 to 1,000.</p>&#13;
<p class="indent">Close the app and open it again, however, and you’ll notice that the game doesn’t remember your preferred range when it’s run a second time. The app also doesn’t remember how awesome you are at guessing the correct number. If only there were a way to have the app remember your preferred range and the number of games you’ve won. . . .</p>&#13;
<h3 class="h3"><span epub:type="pagebreak" id="page_118"/><a id="toc_lev93"/>Storing User Preferences and Game Stats</h3>&#13;
<p class="noindent">The key to remembering user preferences and game statistics from one session to another is the ability to save <em>persistent information</em> to your Android device. Persistent information is any data that remains on the device after the app is closed. In the Hi-Lo guessing game, we want to store the user’s preferred difficulty level and the number of games they’ve won as persistent information.</p>&#13;
<p class="indent">There are three ways to save persistent data to your Android device: storing shared preferences, saving files, and saving data in a database. <em>Shared preferences</em> are a type of object that stores a relatively short list of settings that your app needs to save for the next time you use the app. They’re called <em>shared</em> preferences because you can share the settings across several activities or screens in your app, such as an options menu and the main game screen in the guessing game. Saving a file to the device is useful when you need to store a large amount of data, such as a text document, and databases are necessary for apps such as an address book or contacts list. But for the guessing game, we just need to store a few numbers, so we’ll use shared preferences.</p>&#13;
<h4 class="h4"><em><a id="toc_lev94"/>Storing and Retrieving the User’s Preferred Range</em></h4>&#13;
<p class="noindent">Shared preferences are stored as sets of <em>key/value pairs</em> where each value has an associated key that is used to retrieve it. For example, you could have a pair like <span class="literal">"range"</span> and <span class="literal">"100"</span>, where <span class="literal">"range"</span> is the <em>key</em> and <span class="literal">"100"</span> is the <em>value</em> we’re storing under that key. Let’s write a method to store the user’s preferred range to shared preferences.</p>&#13;
<p class="indent">Near the bottom of your <em>MainActivity.java</em> file, add the following method after the <span class="literal">onOptionsItemSelected()</span> method and just before the closing brace:</p>&#13;
<p class="pre">          <span class="ash">default:</span><br/>&#13;
             <span class="ash">return super.onOptionsItemSelected(item);</span><br/>&#13;
       <span class="ash">}</span><br/>&#13;
  <span class="ash">}</span><br/>&#13;
  public void storeRange(int newRange) {<br/>&#13;
       SharedPreferences preferences =<br/>&#13;
           PreferenceManager.getDefaultSharedPreferences(this);<br/>&#13;
       SharedPreferences.Editor editor = preferences.edit();<br/>&#13;
       editor.putInt("range", newRange);<br/>&#13;
       editor.apply();<br/>&#13;
  }<br/>&#13;
}<br/>&#13;
</p>&#13;
<p class="indent">There is already a default shared preferences object for every app you make, which you can access by creating a <span class="literal">SharedPreferences</span> object to connect to it. To do this, access the default object by calling <span class="literal">getDefaultSharedPreferences()</span> on the <span class="literal">PreferenceManager</span> object that creates and maintains lists of shared preferences. Remember to import as you go, or press <small>ALT</small>-<small>ENTER</small> (or <small>OPTION</small>-<small>ENTER</small>).</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_119"/>To write to shared preferences, we must use an <span class="literal">Editor</span> object, which allows us to edit individual shared preference values. To store a specific key/value pair, we use a <span class="literal">put</span> method, such as <span class="literal">putString</span> to store a string value, <span class="literal">putInt</span> to store an integer, <span class="literal">putFloat</span> to store a floating-point decimal value, <span class="literal">putBoolean</span> to store a true/false value, and so on. Every time the user selects a new range, we’ll pass the <span class="literal">range</span> variable to the <span class="literal">storeRange()</span> method as <span class="literal">newRange</span>. In order to store <span class="literal">newRange</span> under the <span class="literal">"range"</span> key, we use editor .putInt("range", newRange); to store the user’s new range value (10, 100, or 1,000) under the shared preferences key name <span class="literal">"range"</span>. The <span class="literal">apply()</span> method tells Android you’re finished modifying the shared preferences values, and it can apply the changes.</p>&#13;
<p class="indent">Now that we can store the range to shared preferences, we need to add the <span class="literal">storeRange()</span> function to each <span class="literal">case</span> the user can select in the event listener in the <span class="literal">onOptionsItemSelected()</span> method:</p>&#13;
<p class="pre"><span class="ash">public boolean onOptionsItemSelected(MenuItem item) {</span><br/>&#13;
     <span class="ash">switch (item.getItemId()) {</span><br/>&#13;
        <span class="ash">case R.id.<span class="codeitalic">action_settings</span>:</span><br/>            <span class="ash">final CharSequence[] items = {"1 to 10", "1 to 100", "1 to 1000"};</span><br/>&#13;
            <span class="ash">AlertDialog.Builder builder = new AlertDialog.Builder(this);</span><br/>&#13;
            <span class="ash">builder.setTitle("Select the Range:");</span><br/>&#13;
            <span class="ash">builder.setItems(items, new DialogInterface.OnClickListener() {</span><br/>&#13;
               <span class="ash">public void onClick(DialogInterface dialog, int item) {</span><br/>&#13;
                  <span class="ash">switch(item) {</span><br/>&#13;
                       <span class="ash">case 0:</span><br/>&#13;
                         <span class="ash">range = 10;</span><br/>&#13;
                         storeRange(10);<br/>&#13;
                         <span class="ash">newGame();</span><br/>&#13;
                         <span class="ash">break;</span><br/>&#13;
                       <span class="ash">case 1:</span><br/>&#13;
                         <span class="ash">range = 100;</span><br/>&#13;
                         storeRange(100);<br/>&#13;
                         <span class="ash">newGame();</span><br/>&#13;
                         <span class="ash">break;</span><br/>&#13;
                       <span class="ash">case 2:</span><br/>&#13;
                         <span class="ash">range = 1000;</span><br/>&#13;
                         storeRange(1000);<br/>&#13;
                         <span class="ash">newGame();</span><br/>&#13;
                         <span class="ash">break;</span><br/>&#13;
                       <span class="ash">}</span><br/>&#13;
                       <span class="ash">dialog.dismiss();</span><br/>&#13;
                  <span class="ash">}</span><br/>&#13;
              <span class="ash">});</span><br/>&#13;
              <span class="ash">AlertDialog alert = builder.create();</span><br/>&#13;
              <span class="ash">alert.show();</span><br/>&#13;
              <span class="ash">return true;</span><br/>&#13;
</p>&#13;
<p class="indent">Finally, we need to retrieve the range when the game loads so that the user’s last selected range will be the range the game uses the next time it <span epub:type="pagebreak" id="page_120"/>runs. Scroll up to the <span class="literal">onCreate()</span> method and add the following two lines to retrieve the range from shared preferences:</p>&#13;
<p class="pre"><span class="ash">protected void onCreate(Bundle savedInstanceState) {</span><br/>&#13;
     <span class="ash">super.onCreate(savedInstanceState);</span><br/>&#13;
     <span class="ash">setContentView(R.layout.<span class="codeitalic">activity_main</span>);</span><br/>&#13;
     <span class="ash">txtGuess = (EditText) findViewById(R.id.<span class="codeitalic">txtGuess</span>);</span><br/>&#13;
     <span class="ash">btnGuess = (Button) findViewById(R.id.<span class="codeitalic">btnGuess</span>);</span><br/>&#13;
     <span class="ash">lblOutput = (TextView) findViewById(R.id.<span class="codeitalic">lblOutput</span>);</span><br/>&#13;
     <span class="ash">lblRange = (TextView) findViewById(R.id.<span class="codeitalic">textView2</span>);</span><br/>&#13;
     SharedPreferences preferences =<br/>&#13;
         PreferenceManager.getDefaultSharedPreferences(this);<br/>&#13;
     range = preferences.getInt("range", 100);<br/>&#13;
     <span class="ash">newGame();</span><br/>&#13;
</p>&#13;
<p class="indent">Notice that we’ve retrieved the shared preferences <em>before</em> we call the <span class="literal">newGame()</span> method to ensure that the user gets the range they last used whenever the app starts over. The <span class="literal">getInt()</span> method looks for the value stored in the key <span class="literal">"range"</span>, but if it doesn’t find a value, the second parameter tells it to default to <span class="literal">100</span>. We do this so that <span class="literal">range</span> has a value the first time the user runs the app.</p>&#13;
<p class="indent">Save the file, build, and run it. This time, choose a different range and then close the app entirely. The same range will be waiting for you the next time you start the app!</p>&#13;
<h4 class="h4"><em><a id="toc_lev95"/>Storing the Number of Games Won</em></h4>&#13;
<p class="noindent">High scores, leaderboards, winning streaks—anything that records our accomplishments tends to make us want to try harder, play longer, and beat the record. One finishing touch we’ll add to the game is the ability to track the number of games won. Once again, we can easily store these stats as shared preferences.</p>&#13;
<p class="indent">When the user wins a round of the game by guessing the correct number, we can use a shared preference to retrieve the number of games they’ve won, add 1 to it, and store the new value. Add this code to your <span class="literal">checkGuess()</span> method, putting it inside the <span class="literal">else</span> statement for a winning guess:</p>&#13;
<p class="pre"><span class="ash">public void checkGuess() {</span><br/>&#13;
     <span class="ash">String guessText = txtGuess.getText().toString();</span><br/>&#13;
     <span class="ash">String message = "";</span><br/>&#13;
     <span class="ash">try {</span><br/>&#13;
       <span class="ash">int guess = Integer.<span class="codeitalic">parseInt</span>(guessText);</span><br/>&#13;
       <span class="ash">if (guess &lt; theNumber)</span><br/>&#13;
         <span class="ash">message = guess + " is too low. Try again.";</span><br/>&#13;
       <span class="ash">else if (guess &gt; theNumber)</span><br/>&#13;
         <span class="ash">message = guess + " is too high. Try again.";</span><br/>&#13;
       <span class="ash">else {</span><br/>&#13;
          <span class="ash">message = guess +</span><br/>&#13;
                <span class="ash">" is correct. You win! Let's play again!";</span><br/>&#13;
       <span class="ent">➊</span> SharedPreferences preferences =<br/>&#13;
              PreferenceManager.getDefaultSharedPreferences(this);<br/>&#13;
       <span class="ent">➋</span> int gamesWon = preferences.getInt("gamesWon", 0) + 1;<br/>&#13;
       <span class="ent">➌</span> SharedPreferences.Editor editor = preferences.edit();<br/>&#13;
       <span class="ent">➍</span> editor.putInt("gamesWon", gamesWon);<br/>&#13;
       <span class="ent">➎</span> editor.apply();<br/>&#13;
         <span class="ash">newGame();</span><br/>&#13;
    }<br/>&#13;
</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_121"/>Here, we’ve accessed the default <span class="literal">SharedPreferences</span> at <span class="ent">➊</span>, and at <span class="ent">➋</span>, we’ve retrieved the value stored under the key name <span class="literal">"gamesWon"</span> (with a default of <span class="literal">0</span> if this is the first time the user has won) and added <span class="literal">1</span> to account for this win. At <span class="ent">➌</span>, we create an editor to write a new value to shared preferences. At <span class="ent">➍</span>, we put the integer value <span class="literal">gamesWon</span> into shared preferences under the corresponding key name for later use, and at <span class="ent">➎</span>, we tell Android to write the changes to the device.</p>&#13;
<p class="indent">That takes care of storing the number of games won, but how about displaying those stats to the user? To do that, we’ll need to add code for the <span class="literal">action_gamestats case</span> in the <span class="literal">onOptionsItemSelected()</span> method, as follows:</p>&#13;
<p class="pre"> <span class="ash">case R.id.<span class="codeitalic">action_gamestats</span>:</span><br/>   <span class="ent">➊</span> SharedPreferences preferences =<br/>        PreferenceManager.getDefaultSharedPreferences(this);<br/>   <span class="ent">➋</span> int gamesWon = preferences.getInt("gamesWon", 0);<br/>   <span class="ent">➌</span> AlertDialog statDialog = new AlertDialog.Builder(MainActivity.this).create();<br/>&#13;
     statDialog.setTitle("Guessing Game Stats");<br/>&#13;
   <span class="ent">➍</span> statDialog.setMessage("You have won "+gamesWon+" games. Way to go!");<br/>&#13;
     statDialog.setButton(AlertDialog.BUTTON_NEUTRAL, "OK",<br/>&#13;
          new DialogInterface.OnClickListener() {<br/>&#13;
              public void onClick(DialogInterface dialog, int which) {<br/>&#13;
                   dialog.dismiss();<br/>&#13;
              }<br/>&#13;
          });<br/>&#13;
     statDialog.show();<br/>&#13;
     <span class="ash">return true;</span><br/>&#13;
</p>&#13;
<p class="indent">At <span class="ent">➊</span>, we connect to the app’s default shared preferences, and at <span class="ent">➋</span>, we retrieve the number of games won (which we give a default value of <span class="literal">0</span> in case this is the first run of the program). At <span class="ent">➌</span>, we build an alert dialog to show the user the number of games they’ve won, and at <span class="ent">➍</span>, we display the number along with an encouraging message.</p>&#13;
<p class="indent">Save that final change and then build and run your app. Your last challenge may be trying to stop playing! <a href="ch5.xhtml#ch5fig3">Figure 5-3</a> shows how the Game Stats screen may look if you have a couple of math whizzes playing your game.</p>&#13;
<div class="imagef"><img src="../images/f0121-01.jpg" alt="Images"/></div>&#13;
<p class="fig-cap"><em><a id="ch5fig3"/>Figure 5-3: The Game Stats screen keeps track of the number of times you (or your friends) have guessed the correct number.</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_122"/>Adding options menus, saving game stats and user preferences, displaying alert dialogs—these are the kinds of finishing touches that can make your game or any other app really stand on its own as a professional-looking, fully functional mobile application. Keep making improvements to your app as you think of new features, and you’ll have an app worth sharing with friends—or with the world. Happy coding!</p>&#13;
<h3 class="h3"><a id="toc_lev96"/>What You Learned</h3>&#13;
<p class="noindent">You’ve built a professional-quality Android mobile game by adding several finishing touches to the Hi-Lo guessing game app, including:</p>&#13;
<p class="bull">• Adding an options menu to an Android app</p>&#13;
<p class="bull">• Designing the options menu by editing the menu’s XML file</p>&#13;
<p class="bull">• Displaying the options menu using a <span class="literal">MenuInflater</span></p>&#13;
<p class="bull">• Responding to user selections in a menu</p>&#13;
<p class="bull">• Using a <span class="literal">switch</span> statement with multiple <span class="literal">case</span> statements to replace long <span class="literal">if-else</span> chains</p>&#13;
<p class="bull">• Creating customized pop-ups in Android with the <span class="literal">AlertDialog</span> class</p>&#13;
<p class="bull">• Storing shared preferences and app statistics using the <span class="literal">SharedPreferences</span> class</p>&#13;
<p class="bull">• Retrieving the user’s shared preferences when an app starts</p>&#13;
<h3 class="h3"><a id="toc_lev97"/>Programming Challenges</h3>&#13;
<p class="noindent">Try these programming challenge exercises to review and practice what you’ve learned and to expand your programming skills. Visit the book’s website at <em><a href="https://www.nostarch.com/learnjava/">https://www.nostarch.com/learnjava/</a></em> to download sample solutions.</p>&#13;
<h4 class="h4"><em><a id="toc_lev98"/>#1: You Win Some, You Lose Some</em></h4>&#13;
<p class="noindent">Programming Challenge #1 in <a href="ch4.xhtml#ch4">Chapter 4</a> (<a href="ch4.xhtml#page_106">page 106</a>) asked you to give the user seven tries to guess a number between 1 and 100. Now that you’ve added the ability to change the range, you need to change the number of tries to match.</p>&#13;
<p class="indent">You learned in <a href="ch4.xhtml#ch4">Chapter 4</a> that we could guess a number between 1 and 100 using a binary search strategy (guessing in the middle of the remaining possible values each time) because 2<sup>7</sup>, or two to the seventh power, is equal to 128. This means that we should be able to guess a number between 1 and 128 in seven guesses every time using the binary search method. But how many guesses do we need to get a number between 1 and 10, or 1 and 1,000?</p>&#13;
<p class="indent">To figure out the number of tries needed, we need to know the lowest exponent we can raise 2 to that will give us a number greater than the range. For example, for a number between 1 and 10, 2<sup>4</sup> = 16, and 16 &gt; 10, so we need up to four guesses for that range; for a range from 1 to 1,000, 2<sup>10</sup> = 1,024, so we need 10 guesses.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_123"/>To find the exponent to which you need to raise a number to be equal to another number, you can use <em>logarithms</em>. A logarithm takes a number and a base to find the exponent the base should be raised to in order to result in the given number. Java has a <span class="literal">Math.log()</span> method that will take a number and find the exponent for base 10. When you divide the logarithm of one number by the logarithm of another number in base 10, the result is the same as taking the logarithm of the first number with the second number as a base. This means that dividing <span class="literal">Math.log(range)</span> by <span class="literal">Math.log(2)</span> will tell you what power of 2 will give you <span class="literal">range</span>. Because exponents can be decimals and you don’t want the user to have a noninteger number of guesses, like <span class="literal">7.25</span>, you’ll need to also round up and cast the result into an <span class="literal">int</span>. To find the exponent for the number of guesses needed for each range, you can use the expression <span class="literal">(int)(Math.log(range)/Math.log(2)+1)</span>.</p>&#13;
<p class="indent">Modify the Hi-Lo guessing game to adapt the maximum number of guesses to suit the range the user selects, both when the game starts and whenever the user selects a new range in the options menu. For example, you could create a variable called <span class="literal">maxTries</span> to use in place of the hardcoded number <span class="literal">7</span> when testing whether your user has run out of tries.</p>&#13;
<h4 class="h4"><em><a id="toc_lev99"/>#2: Ratio of Wins to Losses</em></h4>&#13;
<p class="noindent">After completing Programming Challenge #1, modify the Hi-Lo guessing game app to store both the number of games won <em>and</em> lost. Modify the game stats menu code to retrieve both numbers and show the number of games won, the total number of games played, and the winning percentage (games won divided by total games played, multiplied by 100). <a href="ch5.xhtml#ch5fig4">Figure 5-4</a> shows an example.</p>&#13;
<div class="imagef"><img src="../images/f0123-01.jpg" alt="Images"/></div>&#13;
<p class="fig-cap"><em><a id="ch5fig4"/>Figure 5-4: The Game Stats screen showing the percentage of games won</em><span epub:type="pagebreak" id="page_124"/></p>&#13;
</body></html>