<html><head></head><body>
<h2 class="h2"><a id="ch13"/><span epub:type="pagebreak" id="page_295"/><strong><span class="big">13</span></strong><br/><strong>WIRELESS PACKET ANALYSIS</strong></h2>&#13;
<div class="image"><img alt="image" src="../images/common.jpg"/></div>&#13;
<p class="noindent"><span class="big1">The world of wireless networking is a bit different from that of traditional wired networking. Although we are still dealing with common communication protocols such as TCP and IP, the game changes a bit when moving to the lowest levels of the OSI model. Here, the data</span> link layer is of special importance due to the nature of wireless networking and the physical layer. Instead of simple wired protocols such as Ethernet, which haven’t changed much over time, we have to consider the nuances of wireless protocols such as 802.11, which have evolved pretty quickly. This puts new restrictions on the data we access and how we capture it.</p>&#13;
<p class="indent">Given these extra considerations, it should come as no surprise that an entire chapter of this book is dedicated to packet capture and analysis on wireless networks. In this chapter, we will discuss exactly why wireless networks are unique when it comes to packet analysis and how to overcome any challenges. Of course, we will be doing this by looking at actual practical examples of wireless network captures.</p>&#13;
<h3 class="h3"><a id="ch13lev1sec1"/><span epub:type="pagebreak" id="page_296"/><strong>Physical Considerations</strong></h3>&#13;
<p class="noindent">The first thing to consider about capturing and analyzing data transmitted across a wireless network is the physical transmission medium. Until now, we haven’t considered the physical layer because we’ve been communicating over physical cabling. Now we’re communicating through invisible airwaves, with packets flying right by us.</p>&#13;
<h4 class="h4"><a id="ch13lev2sec1"/><strong><em>Sniffing One Channel at a Time</em></strong></h4>&#13;
<p class="noindent">A consideration distinct to capturing traffic from a wireless local area network (WLAN) is that the wireless spectrum is a shared medium. Unlike wired networks, where each client has its own network cable connected to a switch, the wireless communication medium is the airspace clients share, which is limited in size. A single WLAN will occupy only a portion of the 802.11 spectrum. This allows multiple systems to operate in the same physical area on different portions of the spectrum.</p>&#13;
<div class="note">&#13;
<p class="notet"><span class="box"><strong>NOTE</strong></span></p>&#13;
<p class="notep"><em>Wireless networking is based on the 802.11 standard, developed by the Institute of Electrical and Electronics Engineers (IEEE). Throughout this chapter, the terms</em> wireless network <em>and</em> WLAN <em>refer to networks that adhere to the 802.11 standard. The most popular versions of this standard are 802.11a, b, g, and n. Each offers a unique set of features and characteristics, with newer standards such as n offering faster speed. They all still use the same spectrum.</em></p>&#13;
</div>&#13;
<p class="indent">This separation of space is made possible by dividing the spectrum into operation channels. A <em>channel</em> is simply a portion of the 802.11 wireless spectrum. In the United States, 11 channels are available (more are allowed in some other countries). This is relevant because, just as a WLAN can operate on only one channel at a time, we can sniff packets on only one channel at a time, as illustrated in <a href="ch13.xhtml#ch13fig1">Figure 13-1</a>. Therefore, if you are troubleshooting a WLAN operating on channel 6, you must configure your system to capture traffic seen on channel 6.</p>&#13;
<div class="image"><img alt="image" src="../images/f296-01.jpg"/></div>&#13;
<p class="figcap"><a id="ch13fig1"/><em>Figure 13-1: Sniffing wirelessly can be tedious, since it can be done on only one channel at a time.</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_297"/>Traditional wireless sniffing can only be done one channel at a time, with an exception: certain wireless scanning applications use a technique called <em>channel hopping</em> to change channels rapidly in order to collect data. One of the most popular tools of this type, Kismet (<em><a href="http://www.kismetwireless.net/">http://www.kismetwireless.net/</a></em>), can hop up to 10 channels per second, a capability that makes it very effective at sniffing multiple channels at once.</p>&#13;
<h4 class="h4"><a id="ch13lev2sec2"/><strong><em>Wireless Signal Interference</em></strong></h4>&#13;
<p class="noindent">With wireless communications, we sometimes can’t rely on the integrity of the data being transmitted over the air. It’s possible that something will interfere with the signal. Wireless networks include some features to handle interference, but those features don’t always work. Therefore, when capturing packets over a wireless network, you must pay close attention to your environment to ensure that there are no significant sources of interference, such as big reflective surfaces, large rigid objects, microwaves, 2.4 GHz phones, thick walls, or high-density surfaces. These can cause packet loss, duplicated packets, and malformed packets.</p>&#13;
<p class="indent">Interference between channels is also a concern. Although you can sniff only one channel at a time, this comes with a small caveat: several transmission channels are available in the wireless networking spectrum, but because space is limited, there is a slight overlap between channels, as illustrated in <a href="ch13.xhtml#ch13fig2">Figure 13-2</a>. This means that if there is traffic present on channel 4 and channel 5, and you are sniffing on one of these channels, you will likely capture packets from the other channel. Typically, networks that coexist in the same area are designed to use nonoverlapping channels of 1, 6, and 11, so you probably won’t encounter this problem. But just in case, you should understand why it happens.</p>&#13;
<div class="image"><img alt="image" src="../images/f297-01.jpg"/></div>&#13;
<p class="figcap"><a id="ch13fig2"/><em>Figure 13-2: There is overlap between channels due to limited spectrum space.</em></p>&#13;
<h4 class="h4"><a id="ch13lev2sec3"/><strong><em>Detecting and Analyzing Signal Interference</em></strong></h4>&#13;
<p class="noindent">Troubleshooting wireless signal interference isn’t something that can be done by looking at packets in Wireshark. If you are going to make a habit or a career out of troubleshooting WLANs, you will surely need to check for signal interference regularly. This task is done with a <em>spectrum analyzer</em>, a tool that displays data or interference across the spectrum.</p>&#13;
<p class="indent">Commercial spectrum analyzers can cost upward of thousands of dollars, but there is a great solution for common everyday use. MetaGeek makes a <span epub:type="pagebreak" id="page_298"/>USB hardware device, the Wi-Spy, that monitors the entire 802.11 spectrum for signals. When paired with MetaGeek’s inSSIDer or Chanalyzer software, this hardware outputs the spectrum graphically to aid in the troubleshooting process. Sample output from Chanalyzer is shown in <a href="ch13.xhtml#ch13fig3">Figure 13-3</a>.</p>&#13;
<div class="image"><img alt="image" src="../images/f298-01.jpg"/></div>&#13;
<p class="figcap"><a id="ch13fig3"/><em>Figure 13-3: This Chanalyzer output shows four signals equally spaced along the Wi-Fi spectrum.</em></p>&#13;
<h3 class="h3"><a id="ch13lev1sec2"/><strong>Wireless Card Modes</strong></h3>&#13;
<p class="noindent">Before we start sniffing wireless packets, we need to look at the different modes in which a wireless card can operate as it pertains to packet capture.</p>&#13;
<p class="indenta">Four wireless NIC modes are available:</p>&#13;
<p class="noindentla"><strong>Managed mode</strong>   This mode is used when your wireless client connects directly to a wireless access point (WAP). In these cases, the driver associated with the wireless NIC relies on the WAP to manage the entire communication process.</p>&#13;
<p class="noindentla"><strong>Ad hoc mode</strong>   This mode is used when you have a wireless network setup in which devices connect directly to each other. In this mode, two wireless clients that want to communicate with each other share the responsibilities that a WAP would normally handle.</p>&#13;
<p class="noindentla"><strong>Master mode</strong>   Some higher-end wireless NICs also support master mode. This mode allows the wireless NIC to work in conjunction with specialized driver software in order to allow the computer to act as a WAP for other devices.</p>&#13;
<p class="noindentla"><strong>Monitor mode</strong>   This is the most important mode for our purposes. Monitor mode is used when you want your wireless client to stop transmitting and receiving data and instead only listen to the packets flying through the air. For Wireshark to capture wireless packets, your wireless NIC and accompanying driver must support monitor mode (also known as RFMON mode).</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_299"/>Most users use wireless cards in only managed mode or ad hoc mode. A graphical representation of the way each mode operates is shown in <a href="ch13.xhtml#ch13fig4">Figure 13-4</a>.</p>&#13;
<div class="image"><img alt="image" src="../images/f299-01.jpg"/></div>&#13;
<p class="figcap"><a id="ch13fig4"/><em>Figure 13-4: The different wireless card modes</em></p>&#13;
<div class="note">&#13;
<p class="notet"><span epub:type="pagebreak" id="page_300"/><span class="box"><strong>NOTE</strong></span></p>&#13;
<p class="notep"><em>I’m often asked which wireless card I recommend for wireless packet analysis. I use and highly recommend products from ALFA network. Their products are regarded as some of the best on the market for ensuring you are capturing every possible packet, and they’re cost-effective and portable. ALFA’s products are available through most online computer hardware retailers.</em></p>&#13;
</div>&#13;
<h3 class="h3"><a id="ch13lev1sec3"/><strong>Sniffing Wirelessly in Windows</strong></h3>&#13;
<p class="noindent">Even if you have a wireless NIC that supports monitor mode, most Windows-based wireless NIC drivers won’t allow you to change into this mode. This means that you’ll only be able to capture packets to and from the wireless interface on the device you’re using to connect to the network. To capture packets between all devices on a channel, you’ll need extra hardware.</p>&#13;
<h4 class="h4"><a id="ch13lev2sec4"/><strong><em>Configuring AirPcap</em></strong></h4>&#13;
<p class="noindent">AirPcap from Riverbed Technologies (<em><a href="http://www.riverbed.com/">http://www.riverbed.com/</a></em>) is designed to overcome the limitations that Windows places on wireless packet analysis. AirPcap is a small USB device that resembles a flash drive, as shown in <a href="ch13.xhtml#ch13fig5">Figure 13-5</a>. It is designed to capture wireless traffic from one or more specified channels. AirPcap uses the WinPcap driver and a special client configuration utility.</p>&#13;
<div class="image"><img alt="image" src="../images/f300-01.jpg"/></div>&#13;
<p class="figcap"><a id="ch13fig5"/><em>Figure 13-5: The AirPcap device is very compact, making it easy to tote along with a laptop.</em></p>&#13;
<p class="indenta">The AirPcap configuration program (shown in <a href="ch13.xhtml#ch13fig6">Figure 13-6</a>) is simple to use, with only a few configurable options:</p>&#13;
<p class="noindentla"><strong>Interface</strong>   You can select the device you are using for your capture here. Some advanced analysis scenarios may require you to use more than one AirPcap device to sniff simultaneously on multiple channels.</p>&#13;
<p class="noindentla"><strong>Blink Led</strong>   Clicking this button will make the LED lights on the AirPcap device blink. This is primarily used to identify the specific adapter you are using if you have multiple AirPcap devices.</p>&#13;
<p class="noindentla"><strong>Channel</strong>   In this field, you select the channel you want AirPcap to listen on.</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_301"/><img alt="image" src="../images/f301-01.jpg"/></div>&#13;
<p class="figcap"><a id="ch13fig6"/><em>Figure 13-6: The AirPcap configuration program</em></p>&#13;
<p class="noindentla"><strong>Extension Channel</strong>   Here you can select an extension channel, a feature of 802.11n adapters allowing for the creation of wider channels.</p>&#13;
<p class="noindentla"><strong>Include 802.11 FCS in Frames</strong>   By default, some systems strip the last four checksum bits from wireless packets. This checksum, known as a frame check sequence (FCS), is used to ensure that packets have not been corrupted during transmission. Unless you have a specific reason to do otherwise, check this box to include the FCS checksums.</p>&#13;
<p class="noindentla"><strong>Capture Type</strong>   The three options here are 802.11 Only, 802.11 + Radio, and 802.11 + PPI. The 802.11 Only option includes the standard 802.11 packet header on all captured packets. The 802.11 + Radio option includes this header and prepends it with a radiotap header, which contains additional information about the packet, such as data rate, frequency, signal level, and noise level. The 802.11 + PPI option adds the Per-Packet Information Header, which contains additional information about 802.11n packets.</p>&#13;
<p class="noindentla"><strong>FCS Filter</strong>   Even if you uncheck the Include 802.11 FCS in Frames box, this option lets you filter out packets that FCS determines are corrupted. Use the Valid Frames option to show only those packets that FCS thinks can be received successfully.</p>&#13;
<p class="noindentla"><strong>WEP Configuration</strong>   This area (accessible on the Keys tab of the AirPcap Control Panel) allows you to enter WEP decryption keys for the networks you will be sniffing. To be able to interpret data encrypted by WEP, you will need to enter the correct WEP keys into this field. WEP keys are discussed in “Successful WEP Authentication” on <a href="ch13.xhtml#page_309">page 309</a>.</p>&#13;
<h4 class="h4"><a id="ch13lev2sec5"/><span epub:type="pagebreak" id="page_302"/><strong><em>Capturing Traffic with AirPcap</em></strong></h4>&#13;
<p class="noindent">Once you have AirPcap installed and configured, the capture process should be familiar to you. Just start up Wireshark and select the AirPcap interface to start collecting packets from it (<a href="ch13.xhtml#ch13fig7">Figure 13-7</a>).</p>&#13;
<div class="image"><img alt="image" src="../images/f302-01.jpg"/></div>&#13;
<p class="figcap"><a id="ch13fig7"/><em>Figure 13-7: Selecting the AirPcap interface to capture packets</em></p>&#13;
<p class="indent">Remember that you will be capturing packets from whatever channel you selected in the AirPcap configuration utility. If you don’t see the packets you’re looking for, it’s probably because you’re looking on the wrong channel. Change the channel by stopping the active capture, selecting a new channel in the AirPcap configuration utility, and restarting the capture. You can’t actively capture packets while you attempt to change the channel.</p>&#13;
<p class="indent">If you need to verify what channel you’re capturing from within Wireshark, an easy way is to view wireless capture statistics. Do this by clicking <strong>Wireless</strong> ▶ <strong>WLAN Traffic</strong> from the main drop-down menu. The resulting window will show you the devices that were observed and information about them, including the 802.11 channel, as shown in <a href="ch13.xhtml#ch13fig8">Figure 13-8</a>.</p>&#13;
<div class="image"><img alt="image" src="../images/f302-02.jpg"/></div>&#13;
<p class="figcap"><a id="ch13fig8"/><em>Figure 13-8: The Wireless LAN Statistics window indicates this data was captured by listening to channel 11.</em></p>&#13;
<h3 class="h3"><a id="ch13lev1sec4"/><span epub:type="pagebreak" id="page_303"/><strong>Sniffing Wirelessly in Linux</strong></h3>&#13;
<p class="noindent">Sniffing in Linux is simply a matter of enabling monitor mode on the wireless NIC and firing up Wireshark. Unfortunately, the procedure for enabling monitor mode differs with each model of wireless NIC, so I can’t offer definitive advice for doing this. In fact, some wireless NICs don’t require you to enable monitor mode. Your best bet is to do a quick Google search for your NIC model to determine whether you need to enable it and, if so, how.</p>&#13;
<p class="indent">One of the more common ways to enable monitor mode in Linux is through its built-in wireless extensions. You can access these wireless extensions with the <code>iwconfig</code> command. If you type <code>iwconfig</code> from the console, you should see results like this:</p>&#13;
<pre>   $ <span class="codestrong">iwconfig</span><br/><span class="ent">➊</span> Eth0   no wireless extensions<br/>   Lo0    no wireless extensions<br/><span class="ent">➋</span> Eth1  IEEE 802.11g        ESSID: "Tesla Wireless Network"<br/>          Mode: Managed Frequency: 2.462 GHz Access Point: 00:02:2D:8B:70:2E<br/>          Bit Rate: 54 Mb/s Tx-Power-20 dBm Sensitivity=8/0<br/>          Retry Limit: 7 RTS thr: off Fragment thr: off<br/>          Power Management: off<br/>          Link Quality=75/100 Signal level=-71 dBm Noise level=-86 dBm<br/>          Rx invalid nwid: 0 Rx invalid crypt: 0 Rx invalid frag: 0<br/>          Tx excessive retries: 0 Invalid misc: 0 Missed beacon: 2</pre>&#13;
<p class="indent">The output from the <code>iwconfig</code> command shows that the <code>Eth1</code> interface can be configured wirelessly. This is apparent because it shows data for the 802.11g protocol <span class="ent">➋</span>, whereas the interfaces <code>Eth0</code> and <code>Lo0</code> return the phrase <code>no wireless extensions</code> <span class="ent">➊</span>.</p>&#13;
<p class="indent">Along with all the wireless information this command provides, such as the wireless extended service set ID (ESSID) and frequency, notice that the second line under <code>Eth1</code> shows that the mode is currently set to managed. This is what we want to change.</p>&#13;
<p class="indent">To change the <code>Eth1</code> interface to monitor mode, you must be logged in as the root user, either directly or via the switch user (<code>su</code>) command, as shown here:</p>&#13;
<pre>$ <span class="codestrong">su</span><br/>Password: &lt;enter root password here&gt;</pre>&#13;
<p class="indent">Once you’re root, you can type commands to configure the wireless interface options. To configure <code>Eth1</code> to operate in monitor mode, enter this:</p>&#13;
<pre># <span class="codestrong">iwconfig eth1 mode monitor</span></pre>&#13;
<p class="indent">Once the NIC is in monitor mode, running the <code>iwconfig</code> command again should reflect your changes. Now ensure that the <code>Eth1</code> interface is operational by entering the following:</p>&#13;
<pre># <span class="codestrong">iwconfig eth1 up</span></pre>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_304"/>We’ll also use the <code>iwconfig</code> command to change the channel we are listening on. Change the channel of the <code>Eth1</code> interface to channel 3 by entering this:</p>&#13;
<pre># <span class="codestrong">iwconfig eth1 channel 3</span></pre>&#13;
<div class="note">&#13;
<p class="notet"><span class="box"><strong>NOTE</strong></span></p>&#13;
<p class="notep"><em>You can change channels on the fly as you are capturing packets, so don’t hesitate to do so at will. The <code>iwconfig</code> command can also be scripted to make the process easier.</em></p>&#13;
</div>&#13;
<p class="indent">When you have completed these configurations, start Wireshark and begin your packet capture.</p>&#13;
<h3 class="h3"><a id="ch13lev1sec5"/><strong>802.11 Packet Structure</strong></h3>&#13;
<div class="note1">&#13;
<p class="noindent"><em>80211beacon.pcapng</em></p>&#13;
</div>&#13;
<p class="noindent">The primary difference between wireless and wired packets is the addition of the 802.11 header. This layer 2 header contains extra information about the packet and the medium by which it is transmitted. There are three types of 802.11 packets:</p>&#13;
<p class="noindentla"><strong>Management</strong>   These packets are used to establish connectivity between hosts at layer 2. Some important subtypes of management packets include authentication, association, and beacon packets.</p>&#13;
<p class="noindentla"><strong>Control</strong>   Control packets allow for delivery of management and data packets, and they are concerned with congestion management. Common subtypes include request-to-send and clear-to-send packets.</p>&#13;
<p class="noindentl"><strong>Data</strong>   These packets contain actual data and are the only types of packets that can be forwarded from the wireless network to the wired network.</p>&#13;
<p class="indent">The type and subtype of a wireless packet determine its structure, so there are a large number of possible structures. We’ll examine one such structure by looking at a single packet in the file <em>80211beacon.pcapng</em>. This file contains an example of a management packet called a <em>beacon</em>, as shown in <a href="ch13.xhtml#ch13fig9">Figure 13-9</a>.</p>&#13;
<p class="indent">A beacon is one of the most informative wireless packets you can find. It is sent as a broadcast packet from a WAP across a wireless channel to notify any listening wireless clients that the WAP is available and to define the parameters that must be set in order to connect to it. In our example file, you can see that this packet is defined as a beacon in the Type/Subtype field in the 802.11 header <span class="ent">➊</span>.</p>&#13;
<p class="indenta">A great deal of additional information is found in the 802.11 management frame header, including the following:</p>&#13;
<p class="noindentla"><strong>Timestamp</strong>   The time the packet was transmitted</p>&#13;
<p class="noindentla"><strong>Beacon Interval</strong>   The interval at which the beacon packet is retransmitted</p>&#13;
<p class="noindentla"><strong>Capabilities Information</strong>   Information about the hardware capabilities of the WAP</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_305"/><img alt="image" src="../images/f305-01.jpg"/></div>&#13;
<p class="figcap"><a id="ch13fig9"/><em>Figure 13-9: This is an 802.11 beacon packet.</em></p>&#13;
<p class="noindentla"><strong>SSID parameter set</strong>   The SSID (network name) broadcast by the WAP</p>&#13;
<p class="noindentla"><strong>Supported Rates</strong>   The data transfer rates supported by the WAP</p>&#13;
<p class="noindentl"><strong>DS Parameter set</strong>   The channel on which the WAP is broadcasting</p>&#13;
<p class="indent">The header also includes the source and destination addresses and vendor-specific information.</p>&#13;
<p class="indent">Based on this, we can determine quite a few things about the WAP transmitting the beacon in the example file. It is apparent that it is a D-Link device <span class="ent">➋</span> using the 802.11b standard <code>(B)</code> <span class="ent">➌</span> on channel 11 <span class="ent">➍</span>.</p>&#13;
<p class="indent">Although the exact contents and purpose of 802.11 management packets will change, the general structure remains similar to this example.</p>&#13;
<h3 class="h3"><a id="ch13lev1sec6"/><strong>Adding Wireless-Specific Columns to the Packet List Pane</strong></h3>&#13;
<p class="noindenta">In previous chapters, we’ve leveraged Wireshark’s flexible interface to add situationally appropriate columns. Before we proceed with any additional wireless analysis, it will be helpful to add the following three columns to the Packet List pane.</p>&#13;
<p class="bullet"><span epub:type="pagebreak" id="page_306"/>•     The Channel column, to show the channel on which the packet was collected</p>&#13;
<p class="bullet">•     The Signal Strength column, to show the signal strength of a captured packet in dBm</p>&#13;
<p class="bulleta">•     The Data Rate column, to show the throughput rate of a captured packet</p>&#13;
<p class="indent">These indicators can be of great help when troubleshooting wireless connections. For instance, even if your wireless client software says you have excellent signal strength, doing a capture and checking these columns may show you a number that does not support this claim.</p>&#13;
<p class="indent">To add these columns to the Packet List pane, follow these steps:</p>&#13;
<ol>&#13;
<li class="nump"><p class="number">Choose <strong>Edit</strong> ▶ <strong>Preferences</strong>.</p></li>&#13;
<li class="nump"><p class="number">Navigate to the Columns section and click +.</p></li>&#13;
<li class="nump"><p class="number">Type <strong>Channel</strong> in the Title field, select <strong>Custom</strong> in the Type drop-down list, and use the filter <strong>wlan_radio.channel</strong> in the Field Name box.</p></li>&#13;
<li class="nump"><p class="number">Repeat this process for the Signal Strength and Data Rate columns, titling them appropriately and selecting <strong>wlan_radio.signal_dbm</strong> and <strong>wlan_radio.data_rate</strong>, respectively, in the Field Name drop-down list. <a href="ch13.xhtml#ch13fig10">Figure 13-10</a> shows what the Preferences window should look like after you have added all three columns.</p>&#13;
<div class="image"><img alt="image" src="../images/f306-01.jpg"/></div>&#13;
<p class="figcap"><a id="ch13fig10"/><em>Figure 13-10: Adding the IEEE wireless-specific columns in the Packet List pane</em></p></li>&#13;
<li class="nump"><p class="number">Click <strong>OK</strong> to save your changes.</p></li>&#13;
</ol>&#13;
<h3 class="h3"><a id="ch13lev1sec7"/><span epub:type="pagebreak" id="page_307"/><strong>Wireless-Specific Filters</strong></h3>&#13;
<p class="noindent">We discussed the benefits of capture and display filters in <a href="ch04.xhtml#ch04">Chapter 4</a>. Filtering traffic in a wired infrastructure is a lot easier since each device has its own dedicated cable. In a wireless network, however, all traffic generated by wireless clients coexists on shared channels, meaning that a capture of any one channel may contain traffic from dozens of clients. This section is devoted to some packet filters that can be used to help you find specific traffic.</p>&#13;
<h4 class="h4"><a id="ch13lev2sec6"/><strong><em>Filtering Traffic for a Specific BSS ID</em></strong></h4>&#13;
<p class="noindent">Each WAP in a network has a unique identifying name called its <em>basic service set identifier (BSS ID)</em>. This name is sent in every wireless management packet and data packet that the access point transmits.</p>&#13;
<p class="indent">Once you know the name of the BSS ID you want to examine, all you really need to do is find a packet that has been sent from that particular WAP. Wireshark shows the transmitting WAP in the Info column of the Packet List pane, so finding this information is typically easy.</p>&#13;
<p class="indent">Once you have a packet from the WAP of interest, find its BSS ID field in the 802.11 header. This is the address on which you will base your filter. After you have found the BSS ID MAC address, you can use this filter:</p>&#13;
<pre>wlan.bssid == <span class="codeitalic">00:11:22:33:44:55</span></pre>&#13;
<p class="noindent">And you will see only the traffic flowing through the specified WAP.</p>&#13;
<h4 class="h4"><a id="ch13lev2sec7"/><strong><em>Filtering Specific Wireless Packet Types</em></strong></h4>&#13;
<p class="noindent">Earlier in this chapter, we discussed the different types of wireless packets you might see on a network. You’ll often need to filter based on these types and subtypes. This can be done with the filters <code>wlan.fc.type</code> for specific types and <code>wc.fc.type_subtype</code> for specific type or subtype combinations. For instance, to filter for a NULL data packet (a Type 2 Subtype 4 packet in hex), you could use the filter <code>wlan.fc.type_subtype == 0x24</code>. <a href="ch13.xhtml#ch13tab1">Table 13-1</a> provides a quick reference to some common filters you might need when filtering on 802.11 packet types and subtypes.</p>&#13;
<p class="tablecap"><a id="ch13tab1"/><strong>Table 13-1:</strong> Wireless Types/Subtypes and Associated Filter Syntax</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_th" style="vertical-align: top;"><p class="table"><strong>Frame type/subtype</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="table"><strong>Filter syntax</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table">Management frame</p></td>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table"><code>wlan.fc.type == 0</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table">Control frame</p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table"><code>wlan.fc.type == 1</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table">Data frame</p></td>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table"><code>wlan.fc.type == 2</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table"><span epub:type="pagebreak" id="page_308"/>Association request</p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table"><code>wlan.fc.type_subtype == 0x00</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table">Association response</p></td>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table"><code>wlan.fc.type_subtype == 0x01</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table">Reassociation request</p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table"><code>wlan.fc.type_subtype == 0x02</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table">Reassociation response</p></td>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table"><code>wlan.fc.type_subtype == 0x03</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table">Probe request</p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table"><code>wlan.fc.type_subtype == 0x04</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table">Probe response</p></td>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table"><code>wlan.fc.type_subtype == 0x05</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table">Beacon</p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table"><code>wlan.fc.type_subtype == 0x08</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table">Disassociate</p></td>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table"><code>wlan.fc.type_subtype == 0x0A</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table">Authentication</p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table"><code>wlan.fc.type_subtype == 0x0B</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table">Deauthentication</p></td>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table"><code>wlan.fc.type_subtype == 0x0C</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table">Action frame</p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table"><code>wlan.fc.type_subtype == 0x0D</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table">Block ACK requests</p></td>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table"><code>wlan.fc.type_subtype == 0x18</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table">Block ACK</p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table"><code>wlan.fc.type_subtype == 0x19</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table">Power save poll</p></td>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table"><code>wlan.fc.type_subtype == 0x1A</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table">Request to send</p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table"><code>wlan.fc.type_subtype == 0x1B</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table">Clear to send</p></td>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table"><code>wlan.fc.type_subtype == 0x1C</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table">ACK</p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table"><code>wlan.fc.type_subtype == 0x1D</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table">Contention free period end</p></td>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table"><code>wlan.fc.type_subtype == 0x1E</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table">NULL data</p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table"><code>wlan.fc.type_subtype == 0x24</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table">QoS data</p></td>&#13;
<td class="table_2c" style="vertical-align: top;"><p class="table"><code>wlan.fc.type_subtype == 0x28</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1b" style="vertical-align: top;"><p class="table">Null QoS data</p></td>&#13;
<td class="table_1b" style="vertical-align: top;"><p class="table"><code>wlan.fc.type_subtype == 0x2C</code></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<h4 class="h4"><a id="ch13lev2sec8"/><strong><em>Filtering a Specific Frequency</em></strong></h4>&#13;
<p class="noindent">If you are examining a compilation of traffic that includes packets from multiple channels, it can be very useful to filter based on each individual channel. For instance, if you are expecting to have traffic present on only channels 1 and 6, you can input a filter to show all channel 11 traffic. If you find any traffic, then you’ll know that something is wrong—perhaps a misconfiguration or a rogue device. To filter on a specific channel, use this filter syntax:</p>&#13;
<pre><span class="codestrong">wlan_radio.channel == 11</span></pre>&#13;
<p class="indent">This will show all traffic on channel 11. You can replace the <code>11</code> value with the channel you wish to filter. There are hundreds of additional useful filters that you can use for wireless network traffic. You can view additional wireless capture filters on the Wireshark wiki at <em><a href="http://wiki.wireshark.org/">http://wiki.wireshark.org/</a></em>.</p>&#13;
<h3 class="h3"><a id="ch13lev1sec8"/><span epub:type="pagebreak" id="page_309"/><strong>Saving a Wireless Profile</strong></h3>&#13;
<p class="noindent">It’s a fair bit of work to go through all the trouble of setting up specific columns and saving custom filters for wireless packet analysis. Instead of reconfiguring and removing columns and filters all the time, you can create and save a custom profile to quickly switch between configurations for wired and wireless analysis.</p>&#13;
<p class="indent">To save a custom profile, first configure wireless columns and filters to your liking. Then right-click the active profile listing at the bottom right of the screen and click <strong>New</strong>. Name the profile <strong>Wireless</strong> and click <strong>OK</strong>.</p>&#13;
<h3 class="h3"><a id="ch13lev1sec9"/><strong>Wireless Security</strong></h3>&#13;
<p class="noindent">The biggest concern when deploying and administering a wireless network is the security of the data transmitted across it. With data flying through the air, free for the taking by anyone who knows how, it’s crucial that the data be encrypted. Otherwise, anyone with Wireshark and an AirPcap can see it.</p>&#13;
<div class="note">&#13;
<p class="notet"><span class="box"><strong>NOTE</strong></span></p>&#13;
<p class="notep"><em>When another layer of encryption, such as SSL or SSH, is used, traffic will still be encrypted at that layer, and the user’s communication will still be unreadable by a person with a packet sniffer.</em></p>&#13;
</div>&#13;
<p class="indent">The original preferred method for securing data transmitted over wireless networks was in accordance with the Wired Equivalent Privacy (WEP) standard. WEP was mildly successful for years until several weaknesses were uncovered in its encryption key management. To improve security, new standards were created. These include the Wi-Fi Protected Access (WPA) and the more secure WPA2 standards. Although WPA and WPA2 are fallible, they are considered more secure than WEP.</p>&#13;
<p class="indent">In this section, we’ll look at some WEP and WPA traffic, along with examples of failed authentication attempts.</p>&#13;
<h4 class="h4"><a id="ch13lev2sec9"/><strong><em>Successful WEP Authentication</em></strong></h4>&#13;
<div class="note1">&#13;
<p class="noindent"><em>3e80211_WEPauth.pcapng</em></p>&#13;
</div>&#13;
<p class="noindent">The file <em>3e80211_WEPauth.pcapng</em> contains an example of a successful connection to a WEP-enabled wireless network. The security on this network is set up using a WEP key. This is a key you must provide to the WAP (the wireless access point) in order to authenticate to it and decrypt data sent from it. You can think of this WEP key as a wireless network password.</p>&#13;
<p class="indent">As shown in <a href="ch13.xhtml#ch13fig11">Figure 13-11</a>, the capture file begins with a challenge from the WAP (28:c6:8e:ab:96:16) to the wireless client (ac:cf:5c:78:6c:9c) in packet 3 <span class="ent">➊</span>. The purpose of this challenge is to determine whether the wireless client has the correct WEP key. You can see this challenge by expanding the 802.11 header and its tagged parameters.</p>&#13;
<p class="indent">The wireless client responds, as shown in <a href="ch13.xhtml#ch13fig12">Figure 13-12</a>, by decrypting the challenge text <span class="ent">➊</span> with the WEP key and returning it to the WAP in packet 4. The WEP key was provided by the user when attempting to connect to the wireless network.</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_310"/><img alt="image" src="../images/f310-01.jpg"/></div>&#13;
<p class="figcap"><a id="ch13fig11"/><em>Figure 13-11: The WAP issues challenge text to the wireless client.</em></p>&#13;
<div class="image"><img alt="image" src="../images/f310-02.jpg"/></div>&#13;
<p class="figcap"><a id="ch13fig12"/><em>Figure 13-12: The wireless client sends the unencrypted challenge text back to the WAP.</em></p>&#13;
<p class="indent">The WAP responds to the wireless client in packet 5, as shown in <a href="ch13.xhtml#ch13fig13">Figure 13-13</a>. The response contains a notification that the authentication process was successful <span class="ent">➊</span>.</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_311"/><img alt="image" src="../images/f311-01.jpg"/></div>&#13;
<p class="figcap"><a id="ch13fig13"/><em>Figure 13-13: The WAP alerts the client that authentication was successful.</em></p>&#13;
<p class="indent">Finally, after successful authentication, the client can transmit an association request, receive an acknowledgment, and complete the connection process, as shown in <a href="ch13.xhtml#ch13fig14">Figure 13-14</a>.</p>&#13;
<div class="image"><img alt="image" src="../images/f311-02.jpg"/></div>&#13;
<p class="figcap"><a id="ch13fig14"/><em>Figure 13-14: The authentication process is followed by a simple two-packet association request and response.</em></p>&#13;
<h4 class="h4"><a id="ch13lev2sec10"/><strong><em>Failed WEP Authentication</em></strong></h4>&#13;
<div class="note1">&#13;
<p class="noindent"><em>3e80211_WEPauthfail.pcapng.</em></p>&#13;
</div>&#13;
<p class="noindent">In our next example, a user enters a WEP key to connect to a WAP. After several seconds, the wireless client utility reports that it was unable to connect to the wireless network but fails to tell why. The resulting file is <em>3e80211_WEPauthfail.pcapng</em>.</p>&#13;
<p class="indent">As with the successful attempt, this communication begins with the WAP’s sending challenge text to the wireless client in packet 3. In packet 4, the wireless client sends its response using the WEP key provided by the user.</p>&#13;
<p class="indent">At this point, we would expect to see a notification that the authentication was successful, but we see something different in packet 5, as shown in <a href="ch13.xhtml#ch13fig15">Figure 13-15</a> <span class="ent">➊</span>.</p>&#13;
<div class="image"><img alt="image" src="../images/f311-03.jpg"/></div>&#13;
<p class="figcap"><a id="ch13fig15"/><em>Figure 13-15: This message tells us the authentication was unsuccessful.</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_312"/>This message tells us that the wireless client’s response to the challenge text was incorrect and suggests that the WEP key the client used to decrypt the text must have also been incorrect. As a result, the connection process has failed. It must be reattempted with the proper WEP key.</p>&#13;
<h4 class="h4"><a id="ch13lev2sec11"/><strong><em>Successful WPA Authentication</em></strong></h4>&#13;
<div class="note1">&#13;
<p class="noindent"><em>3e80211_WPAauth.pcapng</em></p>&#13;
</div>&#13;
<p class="noindent">WPA uses a very different authentication mechanism than WEP, but it still relies on the user to enter a key into the wireless client to connect to the network. An example of a successful WPA authentication is found in the file <em>3e80211_WPAauth.pcapng</em>.</p>&#13;
<p class="indent">The first packet in this file is a beacon broadcast from the WAP. Expand the 802.11 header of this packet, look under tagged parameters, and expand the Vendor Specific heading, as shown in <a href="ch13.xhtml#ch13fig16">Figure 13-16</a>. You should see a section devoted to the WPA attributes of the WAP <span class="ent">➊</span>. This lets us know the version and implementation of WPA that a WAP supports, if any.</p>&#13;
<div class="image"><img alt="image" src="../images/f312-01.jpg"/></div>&#13;
<p class="figcap"><a id="ch13fig16"/><em>Figure 13-16: This beacon lets us know that the WAP supports WPA authentication.</em></p>&#13;
<p class="indent">Once the beacon is received, the wireless client (ac:cf:5c:78:6c:9c) broadcasts a probe request in packet 2 that is received by the WAP (28:c6 :8e:ab:96:16), which responds in packet 3. After that, authentication and association requests and responses are generated between the wireless client and WAP in packets 4 through 7. These are similar to the authentication and association packets we saw in the WEP example earlier, but no challenge and response occur here. That exchange happens next.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_313"/>Things really start to pick up in packet 8. This is where the WPA handshake begins, continuing through packet 11. During the handshake, the WPA challenge and response take place, as shown in <a href="ch13.xhtml#ch13fig17">Figure 13-17</a>.</p>&#13;
<div class="image"><img alt="image" src="../images/f313-01.jpg"/></div>&#13;
<p class="figcap"><a id="ch13fig17"/><em>Figure 13-17: These packets are a part of the WPA handshake.</em></p>&#13;
<p class="indent">There are two challenges and responses. Each can be matched with the other based on the Replay Counter field under the 802.1x Authentication header, as shown in <a href="ch13.xhtml#ch13fig18">Figure 13-18</a>. Notice that the Replay Counter value for the first two handshake packets is <code>1</code> <span class="ent">➊</span> and for the second two handshake packets is <code>2</code> <span class="ent">➋</span>.</p>&#13;
<div class="image"><img alt="image" src="../images/f313-02.jpg"/></div>&#13;
<p class="figcap"><a id="ch13fig18"/><em>Figure 13-18: The Replay Counter field helps us pair challenges and responses.</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_314"/>After the WPA handshake is completed and authentication is successful, data begins transferring between the wireless client and the WAP.</p>&#13;
<div class="note">&#13;
<p class="notet"><span class="box"><strong>NOTE</strong></span></p>&#13;
<p class="notep"><em>This example is from a WAP using WPA with TKIP encryption. TKIP is just one method for encrypting data on WLANs. There are many other types of encryption, and different access points will support different techniques. A WAP using a different encryption method or WPA version will likely exhibit different characteristics at the packet level. You can read the RFC document relating to the technology being used to better decipher what the connection sequence should look like.</em></p>&#13;
</div>&#13;
<h4 class="h4"><a id="ch13lev2sec12"/><strong><em>Failed WPA Authentication</em></strong></h4>&#13;
<div class="note1">&#13;
<p class="noindent"><em>3e80211_WPAauthfail.pcapng</em></p>&#13;
</div>&#13;
<p class="noindent">As with WEP, we’ll look at what happens when a user enters a WPA key and the wireless client utility reports that it was unable to connect to the wireless network without indicating the problem. The resulting file is <em>3e80211_WPAauthfail.pcapng</em>.</p>&#13;
<p class="indent">The capture file begins in a manner identical to the file showing a successful WPA authentication and includes probe, authentication, and association requests. The WPA handshake begins in packet 8, but in this case, there are eight handshake packets instead of the four we saw in the successful authentication attempt.</p>&#13;
<p class="indent">Packets 8 and 9 represent the first two packets seen in the WPA handshake. In this case, however, the challenge text the client sends back to the WAP is incorrect. As a result, the sequence is repeated in packets 10 and 11, 12 and 13, and 14 and 15, as shown in <a href="ch13.xhtml#ch13fig19">Figure 13-19</a>. Each request and response can be paired using the Replay Counter value.</p>&#13;
<div class="image"><img alt="image" src="../images/f314-01.jpg"/></div>&#13;
<p class="figcap"><a id="ch13fig19"/><em>Figure 13-19: The additional EAPoL (Extensible Authentication Protocol over LAN) packets here indicate the failed WPA authentication.</em></p>&#13;
<p class="indent">Once the handshake process has been attempted and failed four times, the communication is aborted. As shown in <a href="ch13.xhtml#ch13fig20">Figure 13-20</a>, the wireless client deauthenticates from the WAP in packet 16 <span class="ent">➊</span>.</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_315"/><img alt="image" src="../images/f315-01.jpg"/></div>&#13;
<p class="figcap"><a id="ch13fig20"/><em>Figure 13-20: After failing the WPA handshake, the client deauthenticates.</em></p>&#13;
<h3 class="h3"><a id="ch13lev1sec10"/><strong>Final Thoughts</strong></h3>&#13;
<p class="noindent">Although wireless networks are still considered somewhat insecure, unless a plethora of additional security mechanisms are piled on, that concern hasn’t slowed their deployment in various organizational environments. As communication without wires is the new norm, it’s crucial to be able to capture and analyze data on wireless networks, as well as wired ones. The skills and concepts taught in this chapter are by no means exhaustive, but they should provide a jump-start for understanding the intricacies of troubleshooting wireless networks with packet analysis.<span epub:type="pagebreak" id="page_316"/></p>&#13;
</body></html>