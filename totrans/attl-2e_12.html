<html><head></head><body>
<h2 class="h2" id="ch12"><span epub:type="pagebreak" id="page_331"/><span class="big">12</span><br/>LOCALIZATION</h2>&#13;
<p class="quote"><em>When I’m working on a problem, I never think about beauty. I think only how to solve the problem. But when I have finished, if the solution is not beautiful, I know it is wrong.<br/>—R. Buckminster Fuller</em></p>&#13;
<div class="image1"><img src="../images/common.jpg" alt="Image"/></div>&#13;
<p class="noindent">Once you’ve accomplished the significant work involved in internationalizing your software, you can begin to consider building message catalogs for other languages and cultures. Building a language-specific message catalog is known as <em>localization</em>. You are localizing your software for a target locale. We will spend this chapter discussing the way GNU projects approach these topics, including how to hook message catalog management into an Autotools build system.</p>&#13;
<h3 class="h3" id="ch12sec1">Getting Started</h3>&#13;
<p class="noindent">Message catalogs must be located where applications can find them. It could have been decided that applications should just store their language-specific message catalogs in a location selected by each project, but Linux (and Unix, in general) has long practiced the subtle art of quietly guiding application developers by convention. Not only do such conventions keep <span epub:type="pagebreak" id="page_332"/>developers from having to make the same decisions over and over, but they also maximize the potential for reuse wherever possible. To these ends, the established convention for message catalogs is to place them in a common directory under the system data directory—what the <em>GNU Coding Standards</em> refers to as the <code>datadir</code>—most often defined as <code>$(prefix)</code><em>/share</em>.<sup><a id="ch12fn_1" href="footnote.xhtml#ch12fn1">1</a></sup> A special directory, <code>$(datadir)</code><em>/locale</em>, houses all application message catalogs in a format that provides some nice features for the user.</p>&#13;
<h4 class="h4" id="ch12sec1-1"><em>Language Selection</em></h4>&#13;
<p class="noindent">I mentioned in <a href="ch11.xhtml">Chapter 11</a> that application selection of the current language, and hence the message catalog used by the application, is done in two phases. I’ve discussed the programmer phase already. Now let’s turn to the user phase, which allows the user some choice over which message catalog is selected. As with the selection of locale, the selection of the message catalog can be directed through the use of environment variables. The following environment variables are used to select the message catalog an application will use:</p>&#13;
<ul>&#13;
<li class="noindent"><code>LANGUAGE</code></li>&#13;
<li class="noindent"><code>LC_ALL</code></li>&#13;
<li class="noindent"><code>LC_</code><em><code>xxx</code></em></li>&#13;
<li class="noindent"><code>LANG</code></li>&#13;
</ul>&#13;
<p class="indent">Up to this point, we’ve only focused on the <code>LC_ALL</code> variable, but, in actuality, the application’s global locale is selected by first examining <code>LC_ALL</code>, then a category-specific variable (<code>LC_TIME</code>, for example), and finally <code>LANG</code>, in that order. In other words, if <code>LC_ALL</code> is not set or is set to the empty string, <code>setlocale</code> will look for <code>LC_</code><em><code>xxx</code></em> variables (specifically, <code>LC_COLLATE</code>, <code>LC_CTYPE</code>, <code>LC_MESSAGES</code>, <code>LC_MONETARY</code>, <code>LC_NUMERIC</code>, and <code>LC_TIME</code>) and use their values to determine which locales are used for the associated areas of library functionality. Finally, if none of those are set, <code>LANG</code> is examined. If <code>LANG</code> is not set, you get an implementation-defined default, which is not always the same as the <code>C</code> locale.</p>&#13;
<p class="indent">On top of these variables used by <code>setlocale</code>, the <em>gettext</em> functions look at <code>LANGUAGE</code> first, which, if set, will override all the others for message catalog selection. Additionally, the <em>value</em> set in the <code>LANGUAGE</code> variable has some impact on the selection criteria. Before we get into value formats, let’s take a look at the directory structure beneath <code>$(datadir)</code><em>/locale</em>. If you look at this directory on your own system, you’d see something like this:</p>&#13;
<pre>$ <span class="codestrong1">ls -1p /usr/share/locale</span>&#13;
aa/&#13;
ab/&#13;
ace/&#13;
ach/&#13;
af/&#13;
<span epub:type="pagebreak" id="page_333"/>all_languages&#13;
<span class="codeitalic1">--snip--</span>&#13;
locale.alias&#13;
<span class="codeitalic1">--snip--</span>&#13;
sr@ijekavian/&#13;
sr@ijekavianlatin/&#13;
sr@latin/&#13;
sr@Latn/&#13;
<span class="codeitalic1">--</span><span class="codeitalic1">snip--</span>&#13;
zh_CN/&#13;
zh_HK/&#13;
zh_TW/&#13;
zu/&#13;
$</pre>&#13;
<p class="indent">The format of these directory names should look somewhat familiar—it’s the same format used by locale names defined in “Generating and Installing Locales” on <a href="ch11.xhtml#page_303">page 303</a>. Under each locale directory containing message catalogs (it’s rather sparse—application localization is not as prevalent as you might imagine), you’ll find a directory named <em>LC_MESSAGES</em>, containing one or more <em>message object</em> (<em>.mo</em>) files, which are compiled message catalogs. Here’s Spanish in Spain, for instance:</p>&#13;
<pre>$ <span class="codestrong1">tree --charset=ASCII /usr/share/locale/es_ES/LC_MESSAGES</span>&#13;
/usr/share/locale/es_ES/LC_MESSAGES&#13;
`-- libmateweather.mo&#13;
&#13;
0 directories, 1 file&#13;
$</pre>&#13;
<p class="indent">If you examine the region-independent Spanish locale directory, <em>/usr/share/locale/es</em>, you’ll see a lot more message catalogs. Most programs don’t bother differentiating regional locales when translating:</p>&#13;
<pre>$ <span class="codestrong1">tree --charset=ASCII /usr/share/locale/es/LC_MESSAGES</span>&#13;
/usr/share/locale/es/LC_MESSAGES/&#13;
|-- apt.mo&#13;
|-- apturl.mo&#13;
|-- bash.mo&#13;
|-- blueberry.mo&#13;
|-- brasero.mo&#13;
<span class="codeitalic1">--snip--</span>&#13;
|-- xreader.mo&#13;
|-- xviewer.mo&#13;
|-- xviewer-plugins.mo&#13;
|-- yelp.mo&#13;
`-- zvbi.mo&#13;
$</pre>&#13;
<p class="indent">As I mentioned earlier, the base name of a message object file is the domain of the owning application. When you call <code>textdomain</code> and <span epub:type="pagebreak" id="page_334"/><code>bindtextdomain</code>, the <em><code>domain</code></em> you specify selects a message object file by name. In this directory listing, <em>blueberry</em> is the message catalog domain of the application that uses the <em>blueberry.mo</em> message catalog.</p>&#13;
<h4 class="h4" id="ch12sec1-2"><em>Building Message Catalogs</em></h4>&#13;
<p class="noindent">The <em>gettext</em> library provides a set of utilities that help you build message catalogs from source code that’s been internationalized for message catalog selection. Figure 11-1 depicts the flow of data through the <em>gettext</em> utilities, from source code to binary message object.</p>&#13;
<div class="image"><img src="../images/12fig01.jpg" alt="Image"/></div>&#13;
<p class="figcap" id="ch12fig1"><em>Figure 12-1: The flow of data from source file to message object file</em></p>&#13;
<p class="indent">The <code>xgettext</code> utility extracts messages from programming language source files and builds a <em>portable object template</em> (<em>.pot</em>) file. This is done each time the message strings in source files are changed or updated in some way. Perhaps existing messages are modified or removed or new messages are added. In any case, the <em>.pot</em> file must be updated. The <em>.pot</em> file is usually named after the message catalog domain used by the package or program.</p>&#13;
<p class="indent">Assuming we created a message catalog in a project for a French locale, this process generates files in the current directory, but we’re going to follow a common convention by generating all of our message artifacts into a directory off the project root called <em>po</em>:</p>&#13;
<pre><span class="codeitalic1">project</span>/&#13;
   po/&#13;
      fr.mo&#13;
      fr.po&#13;
      <span class="codeitalic1">project</span>.pot</pre>&#13;
<p class="indent">The internal layout of the <em>po</em> directory in my examples is arbitrary—you can tell the <em>gettext</em> tools how to name output files, and you can put them anywhere you like. I chose this structure because it’s what we’re going to use when we integrate <em>gettext</em> with an Autotools project later in this chapter.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_335"/>Let’s generate a <em>.pot</em> file for the source code of the <code>gt</code> program in <a href="ch11.xhtml#ch11ex12">Listing 11-12</a> on <a href="ch11.xhtml#page_328">page 328</a>:</p>&#13;
<pre>$ <span class="codestrong1">mkdir po</span>&#13;
$ <span class="codestrong1">cd po</span>&#13;
$ <span class="codestrong1">xgettext -k_ -c -s -o gt.pot ../gt.c</span>&#13;
$ <span class="codestrong1">cat gt.pot</span>&#13;
# SOME DESCRIPTIVE TITLE.&#13;
# Copyright (C) YEAR THE PACKAGE'S COPYRIGHT HOLDER&#13;
# This file is distributed under the same license as the PACKAGE package.&#13;
# FIRST AUTHOR &lt;EMAIL@ADDRESS&gt;, YEAR.&#13;
#&#13;
#, fuzzy&#13;
msgid ""&#13;
msgstr ""&#13;
"Project-Id-Version: PACKAGE VERSION\n"&#13;
"Report-Msgid-Bugs-To: \n"&#13;
"POT-Creation-Date: 2018-07-12 17:22-0600\n"&#13;
"PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"&#13;
"Last-Translator: FULL NAME &lt;EMAIL@ADDRESS&gt;\n"&#13;
"Language-Team: LANGUAGE &lt;LL@li.org&gt;\n"&#13;
"Language: \n"&#13;
"MIME-Version: 1.0\n"&#13;
"Content-Type: text/plain; charset=CHARSET\n"&#13;
"Content-Transfer-Encoding: 8bit\n"&#13;
&#13;
#: ../gt.c:25&#13;
#, c-format&#13;
msgid "Hello, world!\n"&#13;
msgstr ""&#13;
$</pre>&#13;
<p class="indent">The <code>xgettext</code> utility is designed to build <em>.pot</em> files from the source files of many different programming languages, so it accepts <code>--language</code> or <code>-L</code> command line options as hints. However, it will also guess the language, based on the file extension, if no such option is given.</p>&#13;
<p class="indent">Because <code>xgettext</code> is designed to parse many different types of source file, it can sometimes require help locating the messages we want it to extract. It assumes text to be extracted is somehow associated with the <code>gettext</code> function in the C language. For other language source files, it looks for appropriate variations of this function name. Unfortunately, we threw a monkey wrench into the works when we replaced <code>gettext</code> with the underscore (<code>_</code>) macro name. This is where the <code>--keyword</code> (<code>-k</code>) option can be used to tell <code>xgettext</code> where to look for message text to be extracted. Our use of <code>-k_</code> causes <code>xgettext</code> to look for <code>_</code> instead of <code>gettext</code>. Without this option, <code>xgettext</code> won’t find any messages to extract and, therefore, won’t generate a <em>.pot</em> file.<sup><a id="ch12fn_2" href="footnote.xhtml#ch12fn2">2</a></sup></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_336"/>I’m also telling it to add comments (<code>-c</code>) and to sort the output messages (<code>-s</code>) as they’re added to the <em>.pot</em> file. If you don’t tell it otherwise (with the <code>-o</code> option), it’ll create a file called <em>messages.po</em>. Files not associated with a command line option are considered input files by <code>xgettext</code>.</p>&#13;
<p class="indent">At this point, though not strictly required, and depending on the workflow you choose to use, you may want to hand-edit <em>gt.pot</em> to update placeholder values that <code>xgettext</code> adds. For example, you may want to replace the <code>PACKAGE</code> and <code>VERSION</code> placeholder strings in the <code>Project-Id-Version</code> field and perhaps add an email address to the <code>Report-Msgid-Bugs-To</code> field. These can be added during generation by using the <code>--package-name</code>, <code>--package-version</code>, and <code>--msgid-bugs-address</code> command line options. There are a few others; you can look them up in the manual.</p>&#13;
<p class="indent">From this template, we can now generate <em>portable object</em> (<em>.po</em>) files for different locales. The <code>msginit</code> utility is used to create an initial version of a locale-specific <em>.po</em> file, while <code>msgmerge</code> is used to update an existing <em>.po</em> file that was previously generated with <code>msginit</code>.</p>&#13;
<p class="indent">Let’s create a French <em>fr.po</em> file from our template, <em>gt.pot</em>:</p>&#13;
<pre>$ <span class="codestrong1">msginit --no-translator --locale=fr</span>&#13;
Created fr.po.&#13;
$ <span class="codestrong1">cat fr.po</span>&#13;
# French translations for PACKAGE package.&#13;
# Copyright (C) 2019 THE PACKAGE'S COPYRIGHT HOLDER&#13;
# This file is distributed under the same license as the PACKAGE package.&#13;
# Automatically generated, 2019.&#13;
#&#13;
msgid ""&#13;
msgstr ""&#13;
"Project-Id-Version: PACKAGE VERSION\n"&#13;
"Report-Msgid-Bugs-To: \n"&#13;
"POT-Creation-Date: 2019-07-02 23:19-0600\n"&#13;
"PO-Revision-Date: 2019-07-02 23:19-0600\n"&#13;
"Last-Translator: Automatically generated\n"&#13;
"Language-Team: none\n"&#13;
"Language: fr\n"&#13;
"MIME-Version: 1.0\n"&#13;
"Content-Type: text/plain; charset=ASCII\n"&#13;
"Content-Transfer-Encoding: 8bit\n"&#13;
"Plural-Forms: nplurals=2; plural=(n &gt; 1);\n"&#13;
&#13;
#: ../gt.c:21&#13;
#, c-format&#13;
msgid "Hello, world!\n"&#13;
msgstr ""&#13;
$</pre>&#13;
<p class="indent">If you don’t specify any input or output files, it looks in the current directory for a <em>.pot</em> file and derives the output filename from the locale you specify with the <code>--locale</code> (<code>-l</code>) option. I’ve also added the <code>--no-translator</code> <span epub:type="pagebreak" id="page_337"/>option to suppress an interactive aspect of this utility. If you leave it off, <code>msginit</code> attempts to find your email address on the local host and use it. If it gets confused, it stops and asks you which address to use.</p>&#13;
<p class="indent">In addition to the specified or implied <em>.pot</em> file, it also examines makefiles and other build files within the near vicinity of the source files you specify to see what the project might be called. The project name, <code>PROJECT</code>, that you see in this output is the default it uses when it can’t find a project name, but it may surprise you how thorough <code>msginit</code> can be when searching for a project name.</p>&#13;
<p class="indent">Now, there’s nothing very French about this <em>.po</em> file yet—would that it were so simple! No, you still have to translate the strings from English to French manually. So what’s different about this <em>.po</em> file from its source template file? Essentially, everything related to a locale-specific implementation in the template has been filled in, including the title and copyright year in the comments at the top as well as the <code>PO-Revision-Date</code>, <code>Last-Translator</code>, <code>Language-Team</code>, <code>Language</code>, and <code>Plural-Forms</code> fields.</p>&#13;
<p class="indent">The next step in the process is to actually translate the file. Normally, I’d go find a native French speaker with a good grasp of English and ask them to fill in the blanks for me. Since there’s little chance of misusing an internet translator with gt’s one simple message, I’ll just look it up myself and set the <code>msgstr</code> field at the bottom of the file to <code>"Bonjour le monde!\n"</code>.</p>&#13;
<p class="indent">Once translated, the <em>.po</em> file is passed through the <code>msgfmt</code> utility to create the locale-specific <em>message object</em> (<em>.mo</em>) file. Let’s do this for <em>fr.po</em>:</p>&#13;
<pre>$ <span class="codestrong1">msgfmt -o fr.mo fr.po</span>&#13;
$ <span class="codestrong1">ls -1p</span>&#13;
fr.mo&#13;
fr.po&#13;
gt.pot&#13;
$</pre>&#13;
<p class="indent">There are lots of options you can use with <code>msgfmt</code>. For our example, the default functionality is quite sufficient. Still, I specified the output file (with <code>-o</code>) because the default output file is <em>messages.mo</em> and I wanted to be clear that this is the French language message file.</p>&#13;
<p class="indent">To test our French message catalog, we could copy <em>fr.mo</em> over to <em>/usr/local/share/locale/fr/LC_MESSAGES/gt.mo</em> as root and then execute <code>gt</code> with the <code>LANGUAGE</code> variable set to <code>fr</code>, but a simpler way is to use that hack I added to gt that lets us build a version that treats the current directory as the <code>localedir</code>.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>I named the output file</em> fr.mo, <em>but the installed message file must be named after the project’s or program’s message domain</em>—gt <em>in this case</em>—<em>so during installation</em> fr.mo <em>should be renamed to</em> gt.mo. <em>It’s installed into a language-specific subdirectory of <code>localedir</code>, so the French nature of the</em> .mo <em>file is maintained after installation by virtue of its location in the filesystem.</em></p>&#13;
</div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_338"/>First, let’s install our <em>fr.mo</em> file locally and then rebuild <code>gt</code> so that it looks in the current directory rather than the system data directory. Then we’ll run <code>gt</code> with English and French locales, as follows:</p>&#13;
<pre>$ <span class="codestrong1">cd ..</span>&#13;
$ <span class="codestrong1">mkdir -p fr/LC_MESSAGES</span>&#13;
$ <span class="codestrong1">cp po/fr.mo fr/LC_MESSAGES/gt.mo</span>&#13;
$ <span class="codestrong1">gcc -DTEST_L10N gt.c -o gt</span>&#13;
$ <span class="codestrong1">./gt</span>&#13;
Hello, world!&#13;
$ <span class="codestrong1">LANGUAGE=french ./gt</span>&#13;
Bonjour le monde!&#13;
$</pre>&#13;
<p class="indent">This console example should raise a few concerns: Why did I use <code>LANGUAGE</code> rather than <code>LC_ALL</code>? How was I able to use <code>french</code> instead of <code>fr</code> as the value of <code>LANGUAGE</code> without causing <code>gt</code> heartache while searching for the French version of <em>gt.mo</em>?</p>&#13;
<p class="indent">To answer the first question, I cannot use the <code>LC_*</code> or <code>LANG</code> variables here, because I don’t have any French locales installed on my system and these variables merely set the locale, leaving <code>textdomain</code> and <code>bindtextdomain</code> to determine the locale based on queries to the structure returned by <code>localeconv</code> (or, rather, a more extensive internal form of that structure) in the C library. Because I don’t have any French locales installed, <code>setlocale</code> will not be able to set a locale based on the values of the <code>LANG</code> or <code>LC_*</code> variables, so it will simply leave the current global locale set to the system default—English, on my host. Therefore, the language used will continue to be English.</p>&#13;
<p class="indent">The answer to the second question brings us back to an as yet unproven statement I made in “Language Selection” on <a href="ch12.xhtml#page_332">page 332</a>, where I said that the <em>value</em> the user sets in the <code>LANGUAGE</code> variable has some impact on the selection criteria used by <code>textdomain</code> and <code>bindtextdomain</code>. The <em>gettext</em> library allows the user to select <em>fallback</em> message catalogs when a requested locale is not available on the system. This is done by being <em>less specific</em> in the <code>LANGUAGE</code> variable (which is specifically used by <code>textdomain</code> and <code>bindtextdomain</code>) than in the other variables, which are examined by <code>setlocale</code>. The value format supported by <code>LANGUAGE</code> can exactly duplicate the strict format required in <code>LC_*</code> and <code>LANG</code>, but it also supports locale names with missing components and language aliases.</p>&#13;
<p class="indent">First, let’s consider what I mean by missing components. Recall the components of a locale name:</p>&#13;
<pre><span class="codeitalic1">language</span>[_<span class="codeitalic1">territory</span>][.<span class="codeitalic1">codeset</span>][@<span class="codeitalic1">modifier</span>]</pre>&#13;
<p class="indent">The <code>bindtextdomain</code> function attempts to find message catalogs in the specified locale directories that match this entire format, as specified either in the <code>LANGUAGE</code> variable or in the current locale string, as provided by <code>localeconv</code>. But then it backs off by dropping first the <em><code>codeset</code></em>, then a normalized form of the <em><code>codeset</code></em>,<sup><a id="ch12fn_3" href="footnote.xhtml#ch12fn3">3</a></sup> then the <em><code>territory</code></em>, and finally the <em><code>modifier</code></em>. <span epub:type="pagebreak" id="page_339"/>If all components are dropped, we’re left with just the <em><code>language</code></em> portion of the locale name (or whatever other random text was specified in <code>LANGUAGE</code>). If a match still cannot be found, <code>bindtextdomain</code> then looks at the <em>/usr/share/locale/locale.alias</em> file for an alias matching the value in <code>LANGUAGE</code> (<code>french</code> is an alias on my system for <code>fr_FR.ISO-8859-1</code>). This algorithm allows users to be rather vague about which message catalog they want to use and still obtain one that’s reasonably close to their native language, if an exact match for the current locale is not available.</p>&#13;
<h3 class="h3" id="ch12sec2">Integrating gettext with the Autotools</h3>&#13;
<p class="noindent">Up to this point in this chapter, I’ve been building little utilities and programs like <code>gt</code> by just using <code>gcc</code> from the command line. Now it’s time to turn gt into an Autotools project so we can add <em>Native Language Support (NLS)</em> functionality in the manner the GNU project recommends. It’s really best to go this route, because it allows translators out there—people who love to do this sort of thing, and who like your program—to more easily add a message catalog for their language.</p>&#13;
<p class="indent">The information in this section was mostly taken from Section 13, “The Maintainer’s View,” of the <em>GNU gettext Utilities Manual</em>.<sup><a id="ch12fn_4" href="footnote.xhtml#ch12fn4">4</a></sup> The <em>gettext</em> manual is a little out-of-date with respect to the Autotools and even the <em>gettext</em> package itself, but it’s otherwise well organized and very detailed on the topics of internationalization and localization. In fact, it’s so complete that it’s hard to get your head around it until you have some of the basics behind you. My goal in this chapter is to give you the background you need to dig into the <em>gettext</em> manual without fear. In fact, this chapter only lightly brushes over many topics that the manual covers in great detail.</p>&#13;
<p class="indent">Let’s move <em>gt.c</em> into a project <em>src</em> directory and create <em>configure.ac</em>, <em>Makefile.am</em>, and the other GNU-mandated text files. Assuming you’re in the directory where our original <em>gt.c</em> file was created, do the following:</p>&#13;
<p class="margin">Git tag 12.0</p>&#13;
<pre>$ <span class="codestrong1">mkdir -p gettext/src</span>&#13;
$ <span class="codestrong1">mv gt.c gettext/src</span>&#13;
$ <span class="codestrong1">cd gettext</span>&#13;
$ <span class="codestrong1">autoscan</span>&#13;
$ <span class="codestrong1">mv configure.scan configure.ac</span>&#13;
$ <span class="codestrong1">touch NEWS README AUTHORS ChangeLog</span>&#13;
$</pre>&#13;
<p class="indent">The <em>Makefile.am</em> file should look like the one shown in <a href="ch12.xhtml#ch12ex1">Listing 12-1</a>.</p>&#13;
<pre>bin_PROGRAMS = src/gt&#13;
src_gt_SOURCES = src/gt.c&#13;
src_gt_CPPFLAGS = -DLOCALE_DIR=\"$(datadir)/locale\"</pre>&#13;
<p class="caption" id="ch12ex1"><em>Listing 12-1:</em> Makefile.am: <em>The initial contents of this Automake input file</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_340"/>I’ve added target-specific <code>CPPFLAGS</code> to allow me to pass the <code>LOCALE_DIR</code> on the compiler command line. We should also edit our <em>src/gt.c</em> file and add the <em>config.h</em> header file to it so we’ll have access to the <code>LOCALE_DIR</code> variable we’re defining in there. <a href="ch12.xhtml#ch12ex2">Listing 12-2</a> shows the changes we need to make. You can also remove the <code>TEST_L10N</code> hack; we will no longer need this because we can test Autotools-built <code>gt</code> using a local installation.</p>&#13;
<pre>#include "config.h"&#13;
&#13;
<span class="ash">#include &lt;stdio.h&gt;</span>&#13;
<span class="ash">#include &lt;locale.h&gt;</span>&#13;
<span class="ash">#include &lt;libintl.h&gt;</span>&#13;
&#13;
<span class="ash">#ifndef LOCALE_DIR</span>&#13;
<span class="ash"># define LOCALE_DIR "/usr/local/share/locale"</span>&#13;
<span class="ash">#endif</span>&#13;
&#13;
<span class="ash">#define _(x) gettext(x)</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch12ex2"><em>Listing 12-2:</em> src/gt.c: <em>Changes required to configure the <code>LOCALE_DIR</code></em></p>&#13;
<p class="indent">Now edit the new <em>configure.ac</em> file and make the changes shown in <a href="ch12.xhtml#ch12ex3">Listing 12-3</a>.</p>&#13;
<pre><span class="ash">#                                               -*- Autoconf -*-</span>&#13;
<span class="ash"># Process this file with autoconf to produce a configure script.</span>&#13;
&#13;
<span class="ash">AC_PREREQ([2.69])</span>&#13;
<span class="ash">AC_INIT([</span>gt<span class="ash">], [</span>1.0<span class="ash">], [</span>gt-bugs@example.org<span class="ash">])</span>&#13;
AM_INIT_AUTOMAKE([subdir-objects])&#13;
<span class="ash">AC_CONFIG_SRCDIR([src/gt.c])</span>&#13;
<span class="ash">AC_CONFIG_HEADERS([config.h])</span>&#13;
AC_CONFIG_MACRO_DIRS([m4])&#13;
&#13;
<span class="ash"># Checks for programs.</span>&#13;
<span class="ash">AC_PROG_CC</span>&#13;
&#13;
<span class="ash"># Checks for libraries.</span>&#13;
&#13;
<span class="ash"># Checks for header files.</span>&#13;
<span class="ash">AC_CHECK_HEADERS([locale.h])</span>&#13;
&#13;
<span class="ash"># Checks for typedefs, structures, and compiler characteristics.</span>&#13;
&#13;
<span class="ash"># Checks for library functions.</span>&#13;
<span class="ash">AC_CHECK_FUNCS([setlocale])</span>&#13;
&#13;
AC_CONFIG_FILES([Makefile])&#13;
&#13;
<span class="ash">AC_OUTPUT</span></pre>&#13;
<p class="caption" id="ch12ex3"><em>Listing 12-3:</em> configure.ac: <em>Changes necessary to the <code>autoscan</code>-generated</em> .scan <em>file</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_341"/>Note that some header file references were removed in the <code>AC_CHECK_HEADERS</code> line in <a href="ch12.xhtml#ch12ex3">Listing 12-3</a>.</p>&#13;
<p class="indent">At this point, you should be able to execute <code>autoreconf -i</code>, followed by <code>configure</code> and <code>make</code> to build <code>gt</code>:</p>&#13;
<pre>$ <span class="codestrong1">mkdir m4</span>&#13;
$ <span class="codestrong1">autoreconf -i</span>&#13;
configure.ac:12: installing './compile'&#13;
configure.ac:6: installing './install-sh'&#13;
configure.ac:6: installing './missing'&#13;
Makefile.am: installing './INSTALL'&#13;
Makefile.am: installing './COPYING' using GNU General Public License v3 file&#13;
Makefile.am:     Consider adding the COPYING file to the version control system&#13;
Makefile.am:     for your code, to avoid questions about which license your project uses&#13;
Makefile.am: installing './depcomp'&#13;
$ <span class="codestrong1">./configure &amp;&amp; make</span>&#13;
<span class="codeitalic1">--snip--</span>&#13;
configure: creating ./config.status&#13;
config.status: creating Makefile&#13;
config.status: creating config.h&#13;
config.status: config.h is unchanged&#13;
config.status: executing depfiles commands&#13;
make  all-am&#13;
make[1]: Entering directory '/.../gettext'&#13;
depbase=`echo src/gt.o | sed 's|[^/]*$|.deps/&amp;|;s|\.o$||'`;\&#13;
gcc -DHAVE_CONFIG_H -I.      -g -O2 -MT src/gt.o -MD -MP -MF $depbase.Tpo -c -o src/gt.o src/gt.c &amp;&amp;\&#13;
mv -f $depbase.Tpo $depbase.Po&#13;
gcc  -g -O2   -o src/gt src/gt.o&#13;
make[1]: Leaving directory '/.../gettext'&#13;
$</pre>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>I created the m4 directory before running <em><code>autoreconf</code></em> because <em><code>autoreconf</code></em> complains about m4 not being present when it finds <em><code>AC_CONFIG_MACRO_DIRS</code></em> in</em> configure.ac. <em>It still works, but warns you that the directory is missing. Creating it in advance just reduces noise.</em></p>&#13;
</div>&#13;
<p class="indent">The first step in enhancing an existing Autotools project for NLS support with <em>gettext</em> is to add a bunch of <em>gettext</em>-specific files to your project. It’s actually kind of tedious, so the <em>gettext</em> people have created a little utility called <code>gettextize</code> that works pretty well. When you run <code>gettextize</code>, it does a small amount of analysis, dumps a bunch of files into your project’s <em>po</em> directory (it creates one if it’s not there yet), and then displays a six- or seven-step procedure on your console. To ensure you don’t ignore this output, it waits until you press enter to terminate the program, obtaining from you in the process a promise that you’ll read and perform those steps. Sadly, the instructions are a little out-of-date—not all of them are actually necessary, and some of them don’t apply if you’re using the full Autotools suite. Like many programs that integrate with the Autotools, <em>gettext</em> was written to be <span epub:type="pagebreak" id="page_342"/>usable by packages that use Autoconf alone and by programs that use the full Autotools suite. I’ll explain which ones are important as we go.</p>&#13;
<p class="indent">Let’s start by running <code>gettextize</code> on our gt project directory:</p>&#13;
<p class="margin">Git tag 12.1</p>&#13;
<pre>   $ <span class="codestrong1">gettextize</span>&#13;
<span class="ent">➊</span> Creating po/ subdirectory&#13;
   Copying file ABOUT-NLS&#13;
   Copying file config.rpath&#13;
   Not copying intl/ directory.&#13;
   Copying file po/Makefile.in.in&#13;
   Copying file po/Makevars.template&#13;
   Copying file po/Rules-quot&#13;
   Copying file po/boldquot.sed&#13;
   Copying file po/en@boldquot.header&#13;
   Copying file po/en@quot.header&#13;
   Copying file po/insert-header.sin&#13;
   Copying file po/quot.sed&#13;
   Copying file po/remove-potcdate.sin&#13;
   Creating initial po/POTFILES.in&#13;
   Creating po/ChangeLog&#13;
   Copying file m4/gettext.m4&#13;
   Copying file m4/iconv.m4&#13;
   Copying file m4/lib-ld.m4&#13;
   Copying file m4/lib-link.m4&#13;
   Copying file m4/lib-prefix.m4&#13;
   Copying file m4/nls.m4&#13;
   Copying file m4/po.m4&#13;
   Copying file m4/progtest.m4&#13;
<span class="ent">➋</span> Updating Makefile.am (backup is in Makefile.am~)&#13;
   Updating configure.ac (backup is in configure.ac~)&#13;
   Adding an entry to ChangeLog (backup is in ChangeLog~)&#13;
&#13;
<span class="ent">➌</span> Please use AM_GNU_GETTEXT([external]) in order to cause autoconfiguration&#13;
   to look for an external libintl.&#13;
&#13;
<span class="ent">➍</span> Please create po/Makevars from the template in po/Makevars.template.&#13;
   You can then remove po/Makevars.template.&#13;
&#13;
<span class="ent">➎</span> Please fill po/POTFILES.in as described in the documentation.&#13;
&#13;
<span class="ent">➏</span> Please run 'aclocal' to regenerate the aclocal.m4 file.&#13;
   You need aclocal from GNU automake 1.9 (or newer) to do this.&#13;
   Then run 'autoconf' to regenerate the configure file.&#13;
&#13;
<span class="ent">➐</span> You will also need config.guess and config.sub, which you can get from the&#13;
   CVS of the 'config' project at http://savannah.gnu.org/. The commands to fetch&#13;
   them are&#13;
   $ wget 'http://savannah.gnu.org/cgi-bin/viewcvs/*checkout*/config/config/&#13;
   config.guess'&#13;
   $ wget 'http://savannah.gnu.org/cgi-bin/viewcvs/*checkout*/config/config/&#13;
   config.sub'&#13;
&#13;
<span class="ent">➑</span> You might also want to copy the convenience header file gettext.h&#13;
   from the /usr/share/gettext directory into your package.&#13;
<span epub:type="pagebreak" id="page_343"/>   It is a wrapper around &lt;libintl.h&gt; that implements the configure --disable-nls&#13;
   option.&#13;
&#13;
   Press Return to acknowledge the previous 6 paragraphs.&#13;
   [ENTER]&#13;
   $</pre>&#13;
<p class="indent">The first thing <code>gettextize</code> does is create a <em>po</em> subdirectory (at <span class="ent">➊</span>) in the root of our project directory, if needed. This will be where all the NLS-related files are kept and managed by an NLS-specific makefile, which <code>gettextize</code> also provides, as you can see from the third <code>Copying file</code> message found in the first few lines of the output.</p>&#13;
<p class="indent">After copying files from your system’s <em>gettext</em> installation folder to the <em>po</em> directory, it then updates the root-level <em>Makefile.am</em> file and <em>configure.ac</em> (at <span class="ent">➋</span>). <a href="ch12.xhtml#ch12ex4">Listings 12-4</a> and <a href="ch12.xhtml#ch12ex5">12-5</a> show the changes it makes to these files.</p>&#13;
<pre><span class="ash">bin_PROGRAMS = src/gt</span>&#13;
<span class="ash">src_gt_SOURCES = src/gt.c</span> src/gettext.h&#13;
<span class="ash">src_gt_CPPFLAGS = -DLOCALE_DIR=\"</span>$(localedir)<span class="ash">\"</span>&#13;
&#13;
SUBDIRS = po&#13;
&#13;
ACLOCAL_AMFLAGS = -I m4&#13;
&#13;
EXTRA_DIST = config.rpath</pre>&#13;
<p class="caption" id="ch12ex4"><em>Listing 12-4:</em> Makefile.am: <em>Changes to this file made by <code>gettextize</code></em></p>&#13;
<p class="indent">A <code>SUBDIRS</code> variable is added (or updated, if one exists) to the top-level <em>Makefile.am</em> file so that <em>po/Makefile</em> will be processed by <code>make</code>, and <code>AC_LOCAL_AMFLAGS</code> is added to support the <em>m4</em> directory, which <code>gettextize</code> would have added had we not done so first. Finally, <code>gettextize</code> adds an <code>EXTRA_DIST</code> variable to ensure that <em>config.rpath</em> gets distributed.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Adding <em><code>AC_LOCAL_AMFLAGS = -I m4</code></em> is no longer necessary with later versions of Automake, because it provides the <em><code>AC_CONFIG_MACRO_DIRS</code></em> macro, which handles this include directive for <em><code>aclocal</code></em> transparently.</em></p>&#13;
</div>&#13;
<p class="indent">I manually changed <code>$(datadir)</code><em>/locale</em> to the Autoconf-provided <code>$(localedir)</code> in the <code>src_gt_CPPFLAGS</code> line.</p>&#13;
<pre><span class="ash">#                                               -*- Autoconf -*-</span>&#13;
<span class="ash"># Process this file with autoconf to produce a configure script.</span>&#13;
<span class="codeitalic1a">--snip--</span>&#13;
<span class="ash"># Checks for library functions.</span>&#13;
<span class="ash">AC_CHECK_FUNCS([setlocale])</span>&#13;
&#13;
<span class="ash">AC_CONFIG_FILES([Makefile</span> po/Makefile.in<span class="ash">])</span>&#13;
&#13;
<span class="ash">AC_OUTPUT</span></pre>&#13;
<p class="caption" id="ch12ex5"><em>Listing 12-5:</em> configure.ac: <em>Changes to this file made by <code>gettextize</code></em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_344"/>The only change made to <em>configure.ac</em> by <code>gettextize</code> is to add the <em>po/</em><em>Makefile.in</em> file to the <code>AC_CONFIG_FILES</code> file list. An astute reader would notice the <em>.in</em> on the end of this reference and perhaps believe that <code>gettextize</code> had made a mistake. Looking back at the list of files copied by the utility shows us, however, that the file copied into the <em>po</em> directory really is called <em>Makefile.in.in</em>. Autoconf processes the file first, and then <em>gettext</em> utilities process it again later to remove the second <em>.in</em> extension.</p>&#13;
<p class="indent">Referring back to the output of <code>gettextize</code>, we see at <span class="ent">➌</span> that <code>gettextize</code> is asking us to add a macro invocation, <code>AM_GNU_GETTEXT([external])</code>, to <em>configure.ac</em>. This may perhaps seem strange, given that it just finished editing <em>configure.ac</em> for us. The displayed text isn’t clear on this point, but the fact is, an entire copy of the <em>gettext</em> runtime used to be added to projects on demand. This line is simply telling us that if we do not intend to use such an internal version of the <em>gettext</em> library, we should indicate so by using the <code>external</code> option in a call to this macro so that <code>configure</code> will know to look outside the project for the <em>gettext</em> utilities and libraries. As it happens, using an internal version of the <em>gettext</em> library is no longer generally promoted—mainly because <em>gettext</em> is now integrated into <em>libc</em> (at least on Linux systems), so everyone has ready access to an external version of <em>gettext</em>. If you’re using another type of system with GNU tools, you should install the <em>gettext</em> package so you can use that external version.</p>&#13;
<p class="indent">I noticed also when I added this macro that <code>autoreconf</code> complained that I was using <code>AM_GNU_GETTEXT</code> but not <code>AM_GETTEXT_VERSION</code>, which indicates to the build system the lowest allowable version of <em>gettext</em> that may be used with this project. I added this macro as well, with a version value corresponding to the output of <code>gettext --version</code> on my system. I might have used a lower version value to allow my project to build on other, perhaps older systems, but I’d have had to do a bit of research to ensure that all the options I used were valid back to the version I chose to use.</p>&#13;
<p class="indent"><a href="ch12.xhtml#ch12ex6">Listing 12-6</a> shows this addition to <em>configure.ac</em>.</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash"># Checks for programs.</span>&#13;
<span class="ash">AC_PROG_CC</span>&#13;
AM_GNU_GETTEXT_VERSION([0.19.7])&#13;
AM_GNU_GETTEXT([external])&#13;
&#13;
<span class="ash"># Checks for libraries.</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch12ex6"><em>Listing 12-6:</em> configure.ac: <em>Adding <code>AM_GNU_GETTEXT</code></em></p>&#13;
<p class="indent">The next step, at <span class="ent">➍</span>, indicates that we should copy <em>po/Makevars.template</em> to <em>po/Makevars</em> and edit it to ensure the values are correct. I say “copy” rather than “move” because removing the template will just cause it to be replaced the next time you run <code>autoreconf -i</code> anyway, so there’s no point in being pedantic about it.</p>&#13;
<p class="indent"><a href="ch12.xhtml#ch12ex7">Listing 12-7</a> shows a pared-down version of this file—I’ve removed the comments so we can more easily see the functional content, but the comments are extensive and really quite useful, so please do examine the full file.</p>&#13;
<pre><span epub:type="pagebreak" id="page_345"/><span class="ash">DOMAIN = $(PACKAGE)</span>&#13;
<span class="ash">subdir = po</span>&#13;
<span class="ash">top_builddir = ..</span>&#13;
<span class="ash">XGETTEXT_OPTIONS = --keyword=_ --keyword=N_</span>&#13;
<span class="ash">COPYRIGHT_HOLDER =</span> John Calcote&#13;
<span class="ash">PACKAGE_GNU =</span> no&#13;
<span class="ash">MSGID_BUGS_ADDRESS =</span> gt-bugs@example.org&#13;
<span class="ash">EXTRA_LOCALE_CATEGORIES =</span>&#13;
<span class="ash">USE_MSGCTXT = no</span>&#13;
<span class="ash">MSGMERGE_OPTIONS =</span>&#13;
<span class="ash">MSGINIT_OPTIONS =</span>&#13;
<span class="ash">PO_DEPENDS_ON_POT =</span> no&#13;
<span class="ash">DIST_DEPENDS_ON_UPDATE_PO = yes</span></pre>&#13;
<p class="caption" id="ch12ex7"><em>Listing 12-7:</em> po/Makevars.template: <em>A list of variables that control the NLS build</em></p>&#13;
<p class="indent">I’ve highlighted the changes I made to gt’s version of this file. As you can see, the defaults are mostly just fine. I changed the copyright holder from the default, <code>Free Software Foundation</code>. I’ve also indicated that gt is not a GNU package—the default here was blank, which tells <em>gettext</em> to attempt to figure it out at runtime.</p>&#13;
<p class="indent">I’ve specified a value for <code>MSGID_BUGS_ADDRESS</code>, which is a value in the generated <em>.pot</em> file. The value generate by the <em>po</em> directory’s makefile will be the email address (or web link) you specify here. Finally, I’ve set <code>PO_DEPENDS_ON_POT</code> to <code>no</code> because otherwise, anytime the <em>gt.pot</em> file changes in insignificant ways, the locale-specific <em>.po</em> files all get regenerated, and I’d rather just generate the <em>.po</em> files in my project when a distribution is created. This is an arbitrary decision based on personal preference; you can choose to leave it at its default value of <code>yes</code>, if you want.</p>&#13;
<p class="indent">At <span class="ent">➎</span>, we see a request to add some text to <em>po/POTFILES.in</em>. This is a result of Automake’s requirement that all source files be specified in makefiles. We’re being asked to add all of the source files that must be processed by <code>xgettext</code> to extract messages. Files may be added one per line, and comments starting with a hash (<code>#</code>) mark may be used in this file if desired. <a href="ch12.xhtml#ch12ex8">Listing 12-8</a> highlights what I’ve added to gt’s version of <em>po/POTFILES.in</em>.</p>&#13;
<pre><span class="ash"># List of source files that contain translatable strings.</span>&#13;
src/gt.c</pre>&#13;
<p class="caption" id="ch12ex8"><em>Listing 12-8:</em> po/POTFILES.in: <em>Changes made to the generated version of this file</em></p>&#13;
<p class="indent">The files listed in <em>po/POTFILES.in</em> should be relative to the project directory root.</p>&#13;
<p class="indent">The steps listed at <span class="ent">➏</span> and <span class="ent">➐</span> are no longer necessary with late versions of the Autotools. The <code>configure</code> script will automatically run <code>aclocal</code> and rebuild itself for you when you execute it, if necessary. The <em>config.sub</em> and <em>config.guess</em> files are now automatically installed by <code>autoreconf</code> based on the use of the <em>gettext</em> macros. Unfortunately, <code>autoreconf</code> installs the versions of these files that ship with Autoconf; they’re likely out-of-date, so the advice to find and install the latest versions is still valid. If you need to, you can <span epub:type="pagebreak" id="page_346"/>pull the latest versions of these files from the GNU Savannah <em>config</em> repository using the supplied <code>wget</code> commands. You’ll know if you need to if <em>gettext</em> has problems figuring out your platform using the ones installed by <code>autoreconf</code>. Be sure to run <code>autoreconf -i</code> at least once more after these steps are completed.</p>&#13;
<p class="indent">The request to copy and consume <em>gettext.h</em> at <span class="ent">➑</span> is optional but helpful, in my opinion, because it enables a <code>configure</code> script option added by <em>gettext</em> Autoconf macros that allows the user to disable NLS processing while building from a distribution archive. I copied <em>/usr/share/gettext/gettext.h</em> into gt’s <em>src</em> directory and added it to the list of source files for the <code>gt</code> program in <em>Makefile.am</em>, as shown in <a href="ch12.xhtml#ch12ex9">Listing 12-9</a>.</p>&#13;
<pre><span class="ash">bin_PROGRAMS = src/gt</span>&#13;
<span class="ash">src_gt_SOURCES = src/gt.c</span> src/gettext.h&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch12ex9"><em>Listing 12-9:</em> Makefile.am: <em>Adding src/gettext.h to <code>src_gt_SOURCES</code></em></p>&#13;
<p class="indent">Let’s try building after all these changes:</p>&#13;
<pre>$ <span class="codestrong1">autoreconf -i</span>&#13;
Copying file ABOUT-NLS&#13;
Copying file config.rpath&#13;
Creating directory m4&#13;
Copying file m4/codeset.m4&#13;
Copying file m4/extern-inline.m4&#13;
Copying file m4/fcntl-o.m4&#13;
<span class="codeitalic1">--snip--</span>&#13;
Copying file po/insert-header.sin&#13;
Copying file po/quot.sed&#13;
Copying file po/remove-potcdate.sin&#13;
configure.ac:12: installing './compile'&#13;
configure.ac:13: installing './config.guess'&#13;
configure.ac:13: installing './config.sub'&#13;
configure.ac:6: installing './install-sh'&#13;
configure.ac:6: installing './missing'&#13;
Makefile.am: installing './depcomp'&#13;
$&#13;
$ <span class="codestrong1">./configure</span>&#13;
checking for a BSD-compatible install... /usr/bin/install -c&#13;
checking whether build environment is sane... yes&#13;
checking for a thread-safe mkdir -p... /bin/mkdir -p&#13;
<span class="codeitalic1">--snip--</span>&#13;
checking for locale.h... yes&#13;
checking for setlocale... yes&#13;
checking that generated files are newer than configure... done&#13;
configure: creating ./config.status&#13;
config.status: creating Makefile&#13;
config.status: creating po/Makefile.in&#13;
config.status: creating config.h&#13;
config.status: executing depfiles commands&#13;
config.status: executing po-directories commands&#13;
config.status: creating po/POTFILES&#13;
config.status: creating po/Makefile&#13;
<span epub:type="pagebreak" id="page_347"/>$&#13;
$ <span class="codestrong1">make</span>&#13;
make    all-recursive&#13;
make[1]: Entering directory '/.../gettext'&#13;
Making all in po&#13;
make[2]: Entering directory '/.../gettext/po'&#13;
make gt.pot-update&#13;
make[3]: Entering directory '/.../gettext/po'&#13;
<span class="codeitalic1">--snip--</span>&#13;
case `/usr/bin/xgettext --version | sed 1q | sed -e 's,^[^0-9]*,,'` in \&#13;
  ‘’ | 0.[0-9] | 0.[0-9].* | 0.1[0-5] | 0.1[0-5].* | 0.16 | 0.16.[0-1]*) \&#13;
    /usr/bin/xgettext --default-domain=gt --directory=.. \&#13;
      --add-comments=TRANSLATORS: --keyword=_ --keyword=N_    \&#13;
      --files-from=./POTFILES.in \&#13;
      --copyright-holder='John Calcote' \&#13;
      --msgid-bugs-address="$msgid_bugs_address" \&#13;
    ;; \&#13;
  *) \&#13;
    /usr/bin/xgettext --default-domain=gt --directory=.. \&#13;
      --add-comments=TRANSLATORS: --keyword=_ --keyword=N_    \&#13;
      --files-from=./POTFILES.in \&#13;
      --copyright-holder='John Calcote' \&#13;
      --package-name="${package_prefix}gt" \&#13;
      --package-version='1.0' \&#13;
      --msgid-bugs-address="$msgid_bugs_address" \&#13;
    ;; \&#13;
esac&#13;
<span class="codeitalic1">--snip--</span>&#13;
make[3]: Leaving directory '/.../gettext/po'&#13;
test ! -f ./gt.pot || \&#13;
  test -z "" || make&#13;
touch stamp-po&#13;
make[2]: Leaving directory '/.../gettext/po'&#13;
make[2]: Entering directory '/.../gettext'&#13;
gcc -DHAVE_CONFIG_H -I.  -DLOCALE_DIR=\"/usr/local/share/locale\"    -g -O2&#13;
-MT src/src_gt-gt.o -MD -MP -MF src/.deps/src_gt-gt.Tpo -c -o src/src_gt-gt.o&#13;
`test -f 'src/gt.c' || echo './'`src/gt.c&#13;
mv -f src/.deps/src_gt-gt.Tpo src/.deps/src_gt-gt.Po&#13;
gcc   -g -O2   -o src/gt src/src_gt-gt.o&#13;
make[2]: Leaving directory '/.../gettext'&#13;
make[1]: Leaving directory '/.../gettext'&#13;
$</pre>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Some corner-case conditions may cause files written by <em><code>autoreconf</code></em> to be considered “modified locally,” which would generate errors without the <em><code>-f</code></em> or <em><code>--force</code></em> flag. I recommend you try it first using only <em><code>-i</code></em>. If you get errors about files like</em> ABOUT-NLS <em>being modified locally, then re-execute it with the <em><code>-f</code></em> flag also. Just be aware that <em><code>-f</code></em> will overwrite some files you may have intentionally modified.</em></p>&#13;
</div>&#13;
<p class="indent">As you can see from this output, <code>xgettext</code> is run against our source code—specifically, the files we mentioned in <em>po/POTFILES.in</em>—whenever we build, if any of the files are missing at build time. If a file is found, it won’t be rebuilt automatically, but there is a manual <code>make</code> target I’ll mention shortly.</p>&#13;
<h4 class="h4" id="ch12sec2-1"><span epub:type="pagebreak" id="page_348"/><em>What Should Be Committed?</em></h4>&#13;
<p class="noindent">We’ve added a lot of new files to the gt project. In “A Word About the Utility Scripts” on <a href="ch06.xhtml#page_172">page 172</a>, I gave you my philosophy on what should be committed to a source repository, which is that people who check out your project from its repository should be willing to take on the role of maintainer or developer, rather than user. Users build from distribution archives, but maintainers and developers use a different set of tools. Therefore, people who check out source from repositories should be willing to use the Autotools.</p>&#13;
<p class="indent">It’s now time to consider which of these new files you should commit to gt’s repository. Following my philosophy, I would only commit those files that are actually assets of the project. Anything that can be easily regenerated or recopied from other sources during the Autotools bootstrap process (<code>autoreconf</code> <code>-i</code>) should be left out.</p>&#13;
<p class="indent">The <code>gettextize</code> utility runs a program called <code>autopoint</code>, which acts for NLS-enabled projects as <code>autoreconf -i</code> does for Autotools projects, copying files into the project directory structure as needed. The <code>AM_GETTEXT_*</code> macros we added to <em>configure.ac</em> earlier ensure that the appropriate <em>.m4</em> files are added to the <em>m4</em> directory, the appropriate NLS files are added to the <em>po</em> directory, and (if you were using an internal version of the <em>gettext</em> library) the <em>gettext</em> source and build files are added to the <em>intl</em> directory. In fact, <code>autopoint</code> is a sort of contraction of the phrase <em>auto-po-intl-m4</em>.<sup><a id="ch12fn_5" href="footnote.xhtml#ch12fn5">5</a></sup> More recent versions of <code>autoreconf</code> are aware of <code>autopoint</code> and will execute it for you if they notice you have an NLS-enabled project, but only if you provide the <code>-i</code> option to <code>autoreconf</code>, because <code>autopoint</code> only installs missing files and file installation is a function of the <code>-i</code> option.</p>&#13;
<p class="indent">Because <code>autopoint</code> installs all required non-asset files in your <em>po</em> directory, the only thing you need to commit in that directory are the files you modified, including <em>POTFILES.in</em>, <em>Makevars</em>, <em>ChangeLog</em>,<sup><a id="ch12fn_6" href="footnote.xhtml#ch12fn6">6</a></sup> and, of course, your <em>.po</em> files. You don’t need to commit your <em>.pot</em> file because the <em>po/Makefile</em> will regenerate that from your source code if it’s missing. You don’t need to commit your <em>.mo</em> files, as those get generated directly from <em>.po</em> files at install time. You don’t need the <em>ABOUT-NLS</em> file unless you’ve modified it. You don’t need anything in the <em>m4</em> directory except macro files you wrote and added yourself. You will need to commit the <em>src/gettext.h</em> file since you manually copied that file from your system <em>gettext</em> install directory.<sup><a id="ch12fn_7" href="footnote.xhtml#ch12fn7">7</a></sup></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_349"/>This leaves us with the following files in gt’s directory structure:</p>&#13;
<pre>$ <span class="codestrong1">tree --charset=ascii</span>&#13;
.&#13;
|-- AUTHORS&#13;
|-- ChangeLog&#13;
|-- configure.ac&#13;
|-- COPYING&#13;
|-- INSTALL&#13;
|-- Makefile.am&#13;
|-- NEWS&#13;
|-- po&#13;
|    |-- ChangeLog&#13;
|    |-- Makevars&#13;
|    `-- POTFILES.in&#13;
|-- README&#13;
`-- src&#13;
    |-- gettext.h&#13;
    `-- gt.c&#13;
&#13;
2 directories, 13 files&#13;
$</pre>&#13;
<h4 class="h4" id="ch12sec2-2"><em>Adding a Language</em></h4>&#13;
<p class="noindent">Let’s add our French language <em>.po</em> file:</p>&#13;
<p class="margin">Git tag 12.2</p>&#13;
<pre>2$ <span class="codestrong1">cd po</span>&#13;
$ <span class="codestrong1">msginit --locale fr_FR.utf8</span>&#13;
<span class="codeitalic1">--snip--</span>&#13;
$ <span class="codestrong1">echo "</span>&#13;
<span class="codestrong1">fr" &gt;&gt;LINGUAS</span>&#13;
$</pre>&#13;
<p class="indent">While we do run <code>msginit</code>, we don’t need to specify input and output files. Rather, <code>msginit</code> automatically discovers and uses all <em>.pot</em> files in the current directory as input files, and it automatically names the output <em>.po</em> file after the language specified. The only option we need to use is the <code>--locale</code> option to specify the target locale for which a <em>.po</em> file should be generated.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>I didn’t use the <em><code>--no-translator</code></em> option this time because when I run</em> msginit, <em>I’m acting in the role of the translator for the target language. That is to say, the person who runs <em><code>msginit</code></em> for a given locale or language</em> should <em>be the translator for that language. Therefore, that person should also be willing to provide contact information for the translation, which they can input at the interactive prompt for their email address when they run <em><code>msginit</code></em> in this manner.</em></p>&#13;
</div>&#13;
<p class="indent">We also need to add all supported languages to a file named <em>LINGUAS</em> in the <em>po</em> directory (and this new file should also be committed). This tells the build system which languages to support. We may actually have more languages in the <em>po</em> directory than we currently support. The languages <span epub:type="pagebreak" id="page_350"/>in the <em>LINGUAS</em> file are those for which <em>.mo</em> files will be generated and installed when we run <code>make install</code>. The format of <em>LINGUAS</em> is fairly loose; you only need some sort of whitespace between languages. You may also use hash-preceded comments, if you want.</p>&#13;
<p class="indent">You’ll find a file named <em>fr.po</em> in the <em>po</em> directory now. Of course, it still has to be translated by someone who speaks both languages fairly well. The contents should look something like that of <a href="ch12.xhtml#ch12ex10">Listing 12-10</a> after translation. I’ve updated mine, filling in all the blanks, so to speak.</p>&#13;
<pre># French translations for gt package.&#13;
# Copyright (C) 2019 John Calcote&#13;
# This file is distributed under the same license as the gt package.&#13;
# John Calcote &lt;john.calcote@gmail.com&gt;, 2019.&#13;
#&#13;
msgid ""&#13;
msgstr ""&#13;
"Project-Id-Version: gt 1.0\n"&#13;
"Report-Msgid-Bugs-To: gt-bugs@example.org\n"&#13;
"POT-Creation-Date: 2019-07-02 01:17-0600\n"&#13;
"PO-Revision-Date: 2019-07-02 01:35-0600\n"&#13;
"Last-Translator: John Calcote &lt;john.calcote@gmail.com&gt;\n"&#13;
"Language-Team: French\n"&#13;
"Language: fr\n"&#13;
"MIME-Version: 1.0\n"&#13;
"Content-Type: text/plain; charset=UTF-8\n"&#13;
"Content-Transfer-Encoding: 8bit\n"&#13;
"Plural-Forms: nplurals=2; plural=(n &gt; 1);\n"&#13;
&#13;
#: src/gt.c:21&#13;
#, c-format&#13;
msgid "Hello, world!\n"&#13;
msgstr "Bonjour le monde!\n"</pre>&#13;
<p class="caption" id="ch12ex10"><em>Listing 12-10:</em> po/fr.po: <em>The translated French portable object file</em></p>&#13;
<h4 class="h4" id="ch12sec2-3"><em>Installing Language Files</em></h4>&#13;
<p class="noindent">Installation of language files is no harder than running <code>make</code> with the usual Automake-provided <code>install</code> target:</p>&#13;
<pre>$ <span class="codestrong1">sudo make install</span>&#13;
<span class="codeitalic1">--snip--</span>&#13;
Making install in po&#13;
<span class="codeitalic1">--snip--</span>&#13;
$</pre>&#13;
<p class="indent">You may also use a <code>DESTDIR</code> variable on the <code>make</code> command line to test your installation in a local staging directory in order to see what gets installed. Of course you don’t need <code>sudo</code> when you do this, as long as you have write privileges in your <code>DESTDIR</code> location.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_351"/>Testing is not quite as simple as executing your program from the <em>src</em> directory after building, but neither is it that difficult. The problem is the entire Linux NLS system is designed to work with installed language files. You’ll need to install into a local prefix directory, such as <code>$PWD</code><em>/root</em>, for instance:</p>&#13;
<pre>$ <span class="codestrong1">./configure --prefix=$PWD/root</span>&#13;
<span class="codeitalic1">--snip--</span>&#13;
$ <span class="codestrong1">make</span>&#13;
<span class="codeitalic1">--snip</span><span class="codeitalic1">--</span>&#13;
$ <span class="codestrong1">make install</span>&#13;
<span class="codeitalic1">--snip--</span>&#13;
$ <span class="codestrong1">cd root/bin</span>&#13;
$ <span class="codestrong1">./gt</span>&#13;
Hello, world!&#13;
$ <span class="codestrong1">LANGUAGE=french ./gt</span>&#13;
Bonjour le monde!&#13;
$</pre>&#13;
<p class="indent">Why does this work? Because we’re passing the locale directory, based on <code>prefix</code>, into <em>gt.c</em> in the makefile on the <code>gcc</code> command line. Therefore, the <code>prefix</code> you use tells <code>gt</code> where the NLS files will be installed.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Don’t try this with the <em><code>DESTDIR</code></em> variable. The <em><code>prefix</code></em> will still be set to</em> /usr/local, <em>but the <em><code>install</code></em> target will put everything into <em><code>$(DESTDIR)/$(prefix)</code></em>. The locale directory is based only on <em><code>prefix</code></em>, which tricks built software into thinking it’s being installed into <em><code>$(prefix)</code></em>, while allowing packagers to stage the installation locally.</em></p>&#13;
</div>&#13;
<h4 class="h4" id="ch12sec2-4"><em>Manual make Targets</em></h4>&#13;
<p class="noindent">The <em>gettext</em> makefile provides a couple of targets that can be used manually from the <em>po</em> directory (in fact, they’ll only work from the <em>po</em> directory). If you want to manually update one of your <em>.pot</em> files, you can run <code>make</code> <em><code>domain</code></em><code>.update-pot</code>, where <em><code>domain</code></em> is the name of the NLS domain you specified when you called <code>textdomain</code> and <code>bindtextdomain</code> in your source code.</p>&#13;
<p class="indent">If you want to update the translated language files using <code>msgmerge</code>, which will merge new messages from the <em>.pot</em> files into the locale-specific <em>.po</em> files, you can run <code>make update-po</code>. This will update all of the <em>.po</em> files whose locales are specified in <em>LINGUAS</em>.</p>&#13;
<p class="indent">Note that <em>.mo</em> files are not created at build time but only at installation time. The reason for this is that they’re useless before they’re installed. If you really need to have the <em>.mo</em> files without installing your package, you can install into a local prefix or into a <code>DESTDIR</code> staging directory, in the manner outlined earlier.</p>&#13;
<h3 class="h3" id="ch12sec3"><span epub:type="pagebreak" id="page_352"/>Summary</h3>&#13;
<p class="noindent">In this chapter, I barely grazed the surface of the topic of adding NLS support to projects.</p>&#13;
<p class="indent">What did I skip? Well, for instance, there are dozens of options in the <em>gettext</em> tools that help localizers build language files for programs that cause the software to display messages sensibly.</p>&#13;
<p class="indent">For another example, in a typical <code>printf</code> statement in C, you might provide a format string in English such as <code>"There are %d files in the '%s' directory."</code> In this example, <code>%d</code> and <code>%s</code> are placeholders for a count and a directory name, of course, but in German, the translated string would become something like <code>"Im verzeichnis '%s' befinden sich %d dateien."</code> Even a non-German-speaking programmer can see what’s wrong here—the order of the format specifiers has changed. One solution, of course, is to use <code>printf</code>’s newer positional format specifiers.</p>&#13;
<p class="indent">There are dozens of other issues you will want to consider; the <em>GNU gettext Utilities Manual</em> is a great place to start.</p>&#13;
</body></html>