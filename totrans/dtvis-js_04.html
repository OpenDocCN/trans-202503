<html><head></head><body><section class="chapter" title="Chapter&#xA0;4.&#xA0;Creating Specialized Graphs" epub:type="chapter" id="creating_specialized_graphs"><div class="titlepage"><div><div><h2 class="title">Chapter 4. Creating Specialized Graphs</h2></div></div></div><p>The first three chapters looked at different ways to create many common types of charts with JavaScript. But if your data has unique properties or if you want to show it in an unusual way, a more specialized chart might be more appropriate than a typical bar, line, or scatter chart.</p><p><a id="iddle1098" class="indexterm"/><a id="iddle1420" class="indexterm"/><a id="iddle1470" class="indexterm"/><a id="iddle1794" class="indexterm"/><a id="iddle2075" class="indexterm"/><a id="iddle2077" class="indexterm"/><a id="iddle2078" class="indexterm"/><a id="iddle2117" class="indexterm"/>Fortunately, there are many JavaScript techniques and plug-ins to expand our visualization vocabulary beyond the standard charts. In this chapter, we’ll look at approaches for several specialized chart types, including the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>How to combine hierarchy and dimension with tree maps</p></li><li class="listitem"><p>How to highlight regions with heat maps</p></li><li class="listitem"><p>How to show links between elements with network graphs</p></li><li class="listitem"><p>How to reveal language patterns with word clouds</p></li></ul></div><div class="sect1" title="Visualizing Hierarchies with Tree Maps"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="visualizing_hierarchies_with_tree_maps">Visualizing Hierarchies with Tree Maps</h2></div></div></div><p>Data that we want to visualize can often be organized into a hierarchy, and in many cases that hierarchy is itself an important aspect of the visualization. This chapter considers several tools for visualizing hierarchical data, and we’ll begin the examples with one of the simplest approaches: tree maps. Tree maps represent numeric data with two-dimensional areas, and they indicate hierarchies by nesting subordinate areas within their parents.</p><p>There are several algorithms for constructing tree maps from hierarchical data; one of the most common is the squarified algorithm developed by Mark Bruls, Kees Huizing, and Jarke J. van Wijk (<span class="emphasis"><em><a class="ulink" href="http://www.win.tue.nl/~vanwijk/stm.pdf" target="_top">http://www.win.tue.nl/~vanwijk/stm.pdf</a></em></span>). This algorithm is favored for many visualizations because it usually generates visually pleasing proportions for the tree map area. To create the graphics in our example, we can use Imran Ghory’s treemap-squared library (<span class="emphasis"><em><a class="ulink" href="https://github.com/imranghory/treemap-squared" target="_top">https://github.com/imranghory/treemap-squared</a></em></span>). That library includes code for both calculating and drawing tree maps.</p><div class="sect2" title="Step 1: Include the Required Libraries"><div class="titlepage"><div><div><h3 class="title" id="step_1_include_the_required_libraries">Step 1: Include the Required Libraries</h3></div></div></div><p>The treemap-squared library itself depends on the Raphaël library (<span class="emphasis"><em><a class="ulink" href="http://raphaeljs.com/" target="_top">http://raphaeljs.com/</a></em></span>) for low-level drawing functions. Our markup, therefore, must include both libraries. The Raphaël library is popular enough for public CDNs to support.</p><a id="pro_id00157"/><pre class="programlisting">   <span class="dodgerblue">&lt;!DOCTYPE</span> html<span class="dodgerblue">&gt;</span>
   <span class="steelblue"><span class="strong"><strong>&lt;html</strong></span></span> <span class="steelblue">lang=</span><span class="maroon">"en"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;head&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;meta</strong></span></span> <span class="steelblue">charset=</span><span class="maroon">"utf-8"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;title&gt;&lt;/title&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;/head&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;body&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"treemap"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
➊     <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"//cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;/script&gt;</strong></span></span>
➋     <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"js/treemap-squared-0.5.min.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
   <span class="steelblue"><span class="strong"><strong>&lt;/body&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;/html&gt;</strong></span></span></pre><p><a id="iddle2076" class="indexterm"/><a id="iddle2079" class="indexterm"/>As you can see, we’ve set aside a <code class="literal">&lt;div&gt;</code> to hold our tree map. We’ve also included the JavaScript libraries as the last part of the <code class="literal">&lt;body&gt;</code> element, as that provides the best browser performance. In this example, we’re relying on CloudFlare’s CDN ➊. We’ll have to use our own resources, however, to host the treemap-squared library ➋.</p><div class="note" title="Note"><h3 class="title"><a id="ch04note01"/>Note</h3><p><span class="strong"><strong>See <a class="xref" href="ch02.html#step_1_include_the_required_javascript_l" title="Step 1: Include the Required JavaScript Libraries">Step 1: Include the Required JavaScript Libraries</a> for a more extensive discussion of CDNs and the tradeoffs involved in using them.</strong></span></p></div></div><div class="sect2" title="Step 2: Prepare the Data"><div class="titlepage"><div><div><h3 class="title" id="step_2_prepare_the_data-id00015">Step 2: Prepare the Data</h3></div></div></div><p>For our example we’ll show the population of the United States divided by region and then, within each region, by state. The data is available from the US Census Bureau (<span class="emphasis"><em><a class="ulink" href="http://www.census.gov/popest/data/state/totals/2012/index.html" target="_top">http://www.census.gov/popest/data/state/totals/2012/index.html</a></em></span>). We’ll follow its convention and divide the country into four regions. The resulting JavaScript array could look like the following snippet.</p><a id="pro_id00158"/><pre class="programlisting">census = [
  { <span class="dodgerblue">region</span>: <span class="maroon">"South"</span>, <span class="dodgerblue">state</span>: <span class="maroon">"AL"</span>, <span class="dodgerblue">pop2010</span>: <span class="red">4784762</span>, <span class="dodgerblue">pop2012</span>: <span class="red">4822023</span> },
  { <span class="dodgerblue">region</span>: <span class="maroon">"West"</span>,  <span class="dodgerblue">state</span>: <span class="maroon">"AK"</span>, <span class="dodgerblue">pop2010</span>:  <span class="red">714046</span>, <span class="dodgerblue">pop2012</span>:  <span class="red">731449</span> },
  { <span class="dodgerblue">region</span>: <span class="maroon">"West"</span>,  <span class="dodgerblue">state</span>: <span class="maroon">"AZ"</span>, <span class="dodgerblue">pop2010</span>: <span class="red">6410810</span>, <span class="dodgerblue">pop2012</span>: <span class="red">6553255</span> },
  <span class="indianred"><span class="emphasis"><em>// Data set continues...</em></span></span></pre><p>We’ve retained both the 2010 and the 2012 data.</p><p>To structure the data for the treemap-squared library, we need to create separate data arrays for each region. At the same time, we can also create arrays to label the data values using the two-letter state abbreviations.</p><a id="pro_id00159"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> south = {};
<span class="steelblue">south</span>.<span class="olive">data</span> = [];
<span class="steelblue">south</span>.<span class="olive">labels</span> = [];
<span class="steelblue"><span class="strong"><strong>for</strong></span></span> (<span class="steelblue"><span class="strong"><strong>var</strong></span></span> i=<span class="red">0</span>; i&lt;<span class="steelblue">census</span>.<span class="olive">length</span>; i++) {
    <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (census[i].<span class="olive">region</span> === <span class="maroon">"South"</span>) {
        <span class="steelblue">south</span>.<span class="steelblue">data</span>.<span class="olive">push</span>(census[i].<span class="olive">pop2012</span>);
        <span class="steelblue">south</span>.<span class="steelblue">labels</span>.<span class="olive">push</span>(census[i].<span class="olive">state</span>);
    }
}</pre><p>This code steps through the <code class="literal">census</code> array to build data and label arrays for the <code class="literal">"South"</code> region. The same approach works for the other three regions as well.</p></div><div class="sect2" title="Step 3: Draw the Tree Map"><div class="titlepage"><div><div><h3 class="title" id="step_3_draw_the_tree_map">Step 3: Draw the Tree Map</h3></div></div></div><p>Now we’re ready to use the library to construct our tree map. We need to assemble the individual data and label arrays and then call the library’s main function.</p><a id="pro_id00160"/><pre class="programlisting">   <span class="steelblue"><span class="strong"><strong>var</strong></span></span> data = [ <span class="steelblue">west</span>.<span class="olive">data</span>, <span class="steelblue">midwest</span>.<span class="olive">data</span>, <span class="steelblue">northeast</span>.<span class="olive">data</span>, <span class="steelblue">south</span>.<span class="olive">data</span> ];
   <span class="steelblue"><span class="strong"><strong>var</strong></span></span> labels = [ <span class="steelblue">west</span>.<span class="olive">labels</span>, <span class="steelblue">midwest</span>.<span class="olive">labels</span>, <span class="steelblue">northeast</span>.<span class="olive">labels</span>, <span class="steelblue">south</span>.<span class="olive">labels</span> ];
➊ <span class="steelblue">Treemap</span>.<span class="olive">draw</span>(<span class="maroon">"treemap"</span>, <span class="red">600</span>, <span class="red">450</span>, data, labels);</pre><p><a id="iddle1886" class="indexterm"/><a id="iddle2080" class="indexterm"/>The first two parameters at ➊ are the width and height of the map.</p><p>The resulting chart, shown in <a class="xref" href="ch04.html#tree_maps_show_the_relative_size_of_data" title="Figure 4-1. Tree maps show the relative size of data values using rectangular area.">Figure 4-1</a>, provides a simple visualization of the US population. Among the four regions, it is clear where most of the population resides. The bottom-right quadrant (the South) has the largest share of the population. And within the regions, the relative size of each state’s population is also clear. Notice, for example, how California dominates the West.</p><div class="figure"><a id="tree_maps_show_the_relative_size_of_data"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00063"/><img src="figs/web/04fig01.png.jpg" alt="Tree maps show the relative size of data values using rectangular area."/></div></div><div class="figure-title">Figure 4-1. Tree maps show the relative size of data values using rectangular area.</div></div></div><div class="sect2" title="Step 4: Vary the Shading to Show Additional Data"><div class="titlepage"><div><div><h3 class="title" id="step_4_vary_the_shading_to_show_addition">Step 4: Vary the Shading to Show Additional Data</h3></div></div></div><p>The tree map in <a class="xref" href="ch04.html#tree_maps_show_the_relative_size_of_data" title="Figure 4-1. Tree maps show the relative size of data values using rectangular area.">Figure 4-1</a> does a nice job of showing the US population distribution in 2012. The population isn’t static, however, and we can enhance our visualization to indicate trends by taking advantage of the 2010 population data that’s still lurking in our data set. When we iterate through the <code class="literal">census</code> array to extract individual regions, we can also calculate a few additional values.</p><p>Here’s an expanded version of our earlier code fragment that includes these additional calculations.</p><a id="pro_id00161"/><pre class="programlisting">   <span class="steelblue"><span class="strong"><strong>var</strong></span></span> total2010 = <span class="red">0</span>;
   <span class="steelblue"><span class="strong"><strong>var</strong></span></span> total2012 = <span class="red">0</span>;
   <span class="steelblue"><span class="strong"><strong>var</strong></span></span> south = {
       <span class="dodgerblue">data</span>: [],
       <span class="dodgerblue">labels</span>: [],
       <span class="dodgerblue">growth</span>: [],
       <span class="dodgerblue">minGrowth</span>: <span class="red">100</span>,
       <span class="dodgerblue">maxGrowth</span>: -<span class="red">100</span>
   };
   <span class="steelblue"><span class="strong"><strong>for</strong></span></span> (<span class="steelblue"><span class="strong"><strong>var</strong></span></span> i=<span class="red">0</span>; i&lt;<span class="steelblue">census</span>.<span class="olive">length</span>; i++) {
➊     total2010 += census[i].<span class="olive">pop2010;</span>
➋     total2012 += census[i].<span class="olive">pop2012;</span>
➌     <span class="steelblue"><span class="strong"><strong>var</strong></span></span> growth = (census[i].<span class="olive">pop2012</span> - census[i].<span class="olive">pop2010</span>)/census[i].<span class="olive">pop2010</span>;
       <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (census[i].<span class="olive">region</span> === <span class="maroon">"South"</span>) {
           <span class="steelblue">south</span>.<span class="steelblue">data</span>.<span class="olive">push</span>(census[i].<span class="olive">pop2012</span>);
           <span class="steelblue">south</span>.<span class="steelblue">labels</span>.<span class="olive">push</span>(census[i].<span class="olive">state</span>);
           <span class="steelblue">south</span>.<span class="steelblue">growth</span>.<span class="olive">push</span>(growth);
➍         <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (growth &gt; <span class="steelblue">south</span>.<span class="olive">maxGrowth</span>) { <span class="steelblue">south</span>.<span class="olive">maxGrowth</span> = growth; }
➎         <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (growth &lt; <span class="steelblue">south</span>.<span class="olive">minGrowth</span>) { <span class="steelblue">south</span>.<span class="olive">minGrowth</span> = growth; }
       }
       <span class="indianred"><span class="emphasis"><em>// Code continues...</em></span></span>
   }</pre><p><a id="iddle1158" class="indexterm"/><a id="iddle1750" class="indexterm"/>Let’s walk through those additional calculations:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>We accumulate the total population for all states, both in 2010 and in 2012, at ➊ and ➋, respectively. These values let us calculate the average growth rate for the entire country.</p></li><li class="listitem"><p>For each state, we can calculate its growth rate at ➌.</p></li><li class="listitem"><p>For each region, we save both the minimum and maximum growth rates at ➍ and ➎.</p></li></ul></div><p>In the same way that we created a master object for the data and the labels, we create another master object for the growth rates. Let’s also calculate the total growth rate for the country.</p><a id="pro_id00162"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> growth = [ <span class="steelblue">west</span>.<span class="olive">growth</span>, <span class="steelblue">midwest</span>.<span class="olive">growth</span>, <span class="steelblue">northeast</span>.<span class="olive">growth</span>, <span class="steelblue">south</span>.<span class="olive">growth</span> ];
<span class="steelblue"><span class="strong"><strong>var</strong></span></span> totalGrowth = (total2012 - total2010)/total2010;</pre><p>Now we need a function to calculate the color for a tree-map rectangle. We start by defining two color ranges, one for growth rates higher than the national average and another for lower growth rates. We can then pick an appropriate color for each state, based on that state’s growth rate. As an example, here’s one possible set of colors.</p><a id="pro_id00163"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> colorRanges = {
  <span class="dodgerblue">positive</span>: [ <span class="maroon">"#FFFFBF"</span>,<span class="maroon">"#D9EF8B"</span>,<span class="maroon">"#A6D96A"</span>,<span class="maroon">"#66BD63"</span>,<span class="maroon">"#1A9850"</span>,<span class="maroon">"#006837"</span> ],
  <span class="dodgerblue">negative</span>: [ <span class="maroon">"#FFFFBF"</span>,<span class="maroon">"#FEE08B"</span>,<span class="maroon">"#FDAE61"</span>,<span class="maroon">"#F46D43"</span>,<span class="maroon">"#D73027"</span>,<span class="maroon">"#A50026"</span> ]
};</pre><p>Next is the <code class="literal">pickColor()</code> function that uses these color ranges to select the right color for each box. The treemap-squared library will call it with two parameters—the coordinates of the rectangle it’s about to draw, and the index into the data <a id="iddle2081" class="indexterm"/>set. We don’t need the coordinates in our example, but we will use the index to find the value to model. Once we find the state’s growth rate, we can subtract the national average. That calculation determines which color range to use. States that are growing faster than the national average get the positive color range; states growing slower than the average get the negative range.</p><p>The final part of the code calculates where on the appropriate color range to select the color.</p><a id="pro_id00164"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>function</strong></span></span> <span class="olive">pickColor</span>(coordinates, index) {
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> regionIdx = index[<span class="red">0</span>];
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> stateIdx = index[<span class="red">1</span>];
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> growthRate = growth[regionIdx][stateIdx];
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> deltaGrowth = growthRate - totalGrowth;
    <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (deltaGrowth &gt; <span class="red">0</span>) {
        colorRange = <span class="steelblue">colorRanges</span>.<span class="olive">positive</span>;
    } <span class="steelblue"><span class="strong"><strong>else</strong></span></span> {
        colorRange = <span class="steelblue">colorRanges</span>.<span class="olive">negative</span>;
        deltaGrowth = -<span class="red">1</span> * deltaGrowth;
    }
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> colorIndex = <span class="steelblue">Math</span>.<span class="olive">floor</span>(<span class="steelblue">colorRange</span>.<span class="olive">length</span>*(deltaGrowth-minDelta)/
(maxDelta-minDelta));
    <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (colorIndex &gt;= <span class="steelblue">colorRange</span>.<span class="olive">length</span>) { colorIndex = <span class="steelblue">colorRange</span>.<span class="olive">length</span> - <span class="red">1</span>;
}
    color = colorRange[colorIndex];
    <span class="steelblue"><span class="strong"><strong>return</strong></span></span>{ <span class="maroon">"fill"</span> : color };
}</pre><p>The code uses a linear scale based on the extreme values from among all the states. So, for example, if a state’s growth rate is halfway between the overall average and the maximum growth rate, we’ll give it a color that’s halfway in the positive color range array.</p><p>Now when we call <code class="literal">TreeMap.draw()</code>, we can add this function to its parameters, specifically by setting it as the value for the <code class="literal">box</code> key of the options object. The treemap-squared library will then defer to our function for selecting the colors of the regions.</p><a id="pro_id00165"/><pre class="programlisting"><span class="steelblue">Treemap</span>.<span class="olive">draw</span>(<span class="maroon">"treemap"</span>, <span class="red">600</span>, <span class="red">450</span>, data, labels, {<span class="maroon">"box"</span> : pickColor});</pre><p>The resulting tree map of <a class="xref" href="ch04.html#tree_maps_can_use_color_as_well_as_area" title="Figure 4-2. Tree maps can use color as well as area to show data values.">Figure 4-2</a> still shows the relative populations for all of the states. Now, through the use of color shades, it also indicates the rate of population growth compared to the national average. The visualization clearly shows the migration from the Northeast and Midwest to the South and West.</p><div class="figure"><a id="tree_maps_can_use_color_as_well_as_area"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00064"/><img src="figs/web/04fig02.png.jpg" alt="Tree maps can use color as well as area to show data values."/></div></div><div class="figure-title">Figure 4-2. Tree maps can use color as well as area to show data values.</div></div></div></div><div class="sect1" title="Highlighting Regions with a Heat Map"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="highlighting_regions_with_a_heat_map">Highlighting Regions with a Heat Map</h2></div></div></div><p><a id="iddle1444" class="indexterm"/><a id="iddle1451" class="indexterm"/><a id="iddle2158" class="indexterm"/>If you work in the web industry, heat maps may already be a part of your job. Usability researchers often use heat maps to evaluate site designs, especially when they want to analyze which parts of a web page get the most attention from users. Heat maps work by overlaying values, represented as semitransparent colors, over a two-dimensional area. As the example in <a class="xref" href="ch04.html#heat_maps_traditionally_show_where_web_u" title="Figure 4-3. Heat maps traditionally show where web users focus their attention on a page.">Figure 4-3</a> shows, different colors represent different levels of attention. Users focus most on areas colored red, and less on yellow, green, and blue areas.</p><p>For this example, we’ll use a heat map to visualize an important aspect of a basketball game: from where on the court the teams are scoring most of their points. The software we’ll use is the heatmap.js library from Patrick Wied (<span class="emphasis"><em><a class="ulink" href="http://www.patrick-wied.at/static/heatmapjs/" target="_top">http://www.patrick-wied.at/static/heatmapjs/</a></em></span>). If you need to create traditional website heat maps, that library includes built-in support for capturing mouse movements and mouse clicks on a web page. Although we won’t use those features for our example, the general approach is much the same.</p><div class="figure"><a id="heat_maps_traditionally_show_where_web_u"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00065"/><img src="figs/web/04fig03.png.jpg" alt="Heat maps traditionally show where web users focus their attention on a page."/></div></div><div class="figure-title">Figure 4-3. Heat maps traditionally show where web users focus their attention on a page.</div></div><div class="sect2" title="Step 1: Include the Required JavaScript"><div class="titlepage"><div><div><h3 class="title" id="step_1_include_the_required_java-id00016">Step 1: Include the Required JavaScript</h3></div></div></div><p><a id="iddle1450" class="indexterm"/>For modern browsers, the heatmap.js library has no additional requirements. The library includes optional additions for real-time heat maps and for geographic integration, but we won’t need these in our example. Older browsers (principally IE8 and older) can use heatmap.js with the <span class="emphasis"><em>explorer canvas</em></span> library. Since we don’t need to burden all users with this library, we’ll use conditional comments to include it only when it’s needed. Following current best practices, we include all script files at the end of our <code class="literal">&lt;body&gt;</code>.</p><a id="pro_id00166"/><pre class="programlisting"><span class="dodgerblue">&lt;!DOCTYPE</span> html<span class="dodgerblue">&gt;</span>
<span class="steelblue"><span class="strong"><strong>&lt;html</strong></span></span> <span class="steelblue">lang=</span><span class="maroon">"en"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;head&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;meta</strong></span></span> <span class="steelblue">charset=</span><span class="maroon">"utf-8"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;title&gt;&lt;/title&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;/head&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;body&gt;</strong></span></span>
    <span class="indianred"><span class="emphasis"><em>&lt;!--[if lt IE 9]&gt;&lt;script src="js/excanvas.min.js"&gt;&lt;/script&gt;&lt;![endif]--&gt;</em></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"js/heatmap.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;/body&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/html&gt;</strong></span></span></pre></div><div class="sect2" title="Step 2: Define the Visualization Data"><div class="titlepage"><div><div><h3 class="title" id="step_2_define_the_visualization_data">Step 2: Define the Visualization Data</h3></div></div></div><p><a id="iddle1078" class="indexterm"/><a id="iddle1445" class="indexterm"/><a id="iddle1446" class="indexterm"/>For our example, we’ll visualize the NCAA Men’s Basketball game on February 13, 2013, between Duke University and the University of North Carolina. Our data set (<span class="emphasis"><em><a class="ulink" href="http://www.cbssports.com/collegebasketball/gametracker/live/NCAAB_20130213_UNC@DUKE" target="_top">http://www.cbssports.com/collegebasketball/gametracker/live/NCAAB_20130213_UNC@DUKE</a></em></span>) contains details about every point scored in the game. To clean the data, we convert the time of each score to minutes from the game start, and we define the position of the scorer in x- and y-coordinates. We’ve defined these coordinates using several important conventions:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>We’ll show North Carolina’s points on the left side of the court and Duke’s points on the right side.</p></li><li class="listitem"><p>The bottom-left corner of the court corresponds to position (0,0), and the top-right corner corresponds to (10,10).</p></li><li class="listitem"><p>To avoid confusing free throws with field goals, we’ve given all free throws a position of (–1, –1).</p></li></ul></div><p>Here’s the beginning of the data; the full data is available with the book’s source code (<span class="emphasis"><em><a class="ulink" href="http://jsDataV.is/source/" target="_top">http://jsDataV.is/source/</a></em></span>).</p><a id="pro_id00167"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> game = [
  { <span class="dodgerblue">team</span>: <span class="maroon">"UNC"</span>,  <span class="dodgerblue">points</span>: <span class="red">2</span>, <span class="dodgerblue">time</span>: <span class="red">0.85</span>, <span class="dodgerblue">unc</span>: <span class="red">2</span>, <span class="dodgerblue">duke</span>: <span class="red">0</span>, <span class="dodgerblue">x</span>: <span class="red">0.506</span>, <span class="dodgerblue">y</span>: <span class="red">5.039</span> },
  { <span class="dodgerblue">team</span>: <span class="maroon">"UNC"</span>,  <span class="dodgerblue">points</span>: <span class="red">3</span>, <span class="dodgerblue">time</span>: <span class="red">1.22</span>, <span class="dodgerblue">unc</span>: <span class="red">5</span>, <span class="dodgerblue">duke</span>: <span class="red">0</span>, <span class="dodgerblue">x</span>: <span class="red">1.377</span>, <span class="dodgerblue">y</span>: <span class="red">1.184</span> },
  { <span class="dodgerblue">team</span>: <span class="maroon">"DUKE"</span>, <span class="dodgerblue">points</span>: <span class="red">2</span>, <span class="dodgerblue">time</span>: <span class="red">1.65</span>  <span class="dodgerblue">unc</span>: <span class="red">5</span>, <span class="dodgerblue">duke</span>: <span class="red">2</span>, <span class="dodgerblue">x</span>: <span class="red">8.804</span>, <span class="dodgerblue">y</span>: <span class="red">7.231</span> },
  <span class="indianred"><span class="emphasis"><em>// Data set continues...</em></span></span></pre></div><div class="sect2" title="Step 3: Create the Background Image"><div class="titlepage"><div><div><h3 class="title" id="step_3_create_the_background_image">Step 3: Create the Background Image</h3></div></div></div><p>A simple diagram of a basketball court, like that in <a class="xref" href="ch04.html#background_image_sets_the_context_for_th" title="Figure 4-4. A background image sets the context for the visualization.">Figure 4-4</a>, works fine for our visualization. The dimensions of our background image are 600×360 pixels.</p><div class="figure"><a id="background_image_sets_the_context_for_th"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00066"/><img src="figs/web/04fig04.png.jpg" alt="A background image sets the context for the visualization."/></div></div><div class="figure-title">Figure 4-4. A background image sets the context for the visualization.</div></div></div><div class="sect2" title="Step 4: Set Aside an HTML Element to Contain the Visualization"><div class="titlepage"><div><div><h3 class="title" id="step_4_set_aside_an_html_element_to_cont">Step 4: Set Aside an HTML Element to Contain the Visualization</h3></div></div></div><p><a id="iddle1170" class="indexterm"/><a id="iddle1448" class="indexterm"/><a id="iddle1449" class="indexterm"/><a id="iddle1777" class="indexterm"/>In our web page, we need to define the element (generally a <code class="literal">&lt;div&gt;</code>) that will hold the heat map. When we create the element, we specify its dimensions, and we define the background. The following fragment does both of those using inline styles to keep the example concise. You might want to use a CSS style sheet in an actual implementation.</p><a id="pro_id00168"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"heatmap"</span>
    <span class="steelblue">style="</span><span class="maroon">position:relative;width:600px;height:360px;</span>
               <span class="maroon">background-image:url('img/basketball.png');"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/div&gt;</strong></span></span></pre><p>Notice that we’ve given the element a unique <code class="literal">id</code>. The heatmap.js library needs that <code class="literal">id</code> to place the map on the page. Most importantly, we also set the <code class="literal">position</code> property to <code class="literal">relative</code>. The heatmap.js library positions its graphics using absolute positioning, and we want to contain those graphics within the parent element.</p></div><div class="sect2" title="Step 5: Format the Data"><div class="titlepage"><div><div><h3 class="title" id="step_5_format_the_data">Step 5: Format the Data</h3></div></div></div><p>For our next step, we must convert the game data into the proper format for the library. The heatmap.js library expects individual data points to contain three properties:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The x-coordinate, measured in pixels from the left of the containing element</p></li><li class="listitem"><p>The y-coordinate, measured in pixels from the top of the containing element</p></li><li class="listitem"><p>The magnitude of the data point (specified by the <code class="literal">count</code> property)</p></li></ul></div><p>The library also requires the maximum magnitude for the entire map, and here things get a little tricky. With standard heat maps, the magnitudes of all the data points for any particular position sum together. In our case, that means that all the baskets scored from layups and slam dunks—which are effectively from the same position on the court—are added together by the heat-map algorithm. That one position, right underneath the basket, dominates the rest of the court. To counteract that effect, we specify a maximum value far less than what the heat map would expect. In our case, we’ll set the maximum value to <code class="literal">3</code>, which means that any location where at least three points were scored will be colored red, and we’ll easily be able to see all the baskets.</p><p>We can use JavaScript to transform the <code class="literal">game</code> array into the appropriate format.</p><a id="pro_id00169"/><pre class="programlisting">➊ <span class="steelblue"><span class="strong"><strong>var</strong></span></span> docNode = <span class="steelblue">document</span>.<span class="olive">getElementById</span>(<span class="maroon">"heatmap"</span>);
➋ <span class="steelblue"><span class="strong"><strong>var</strong></span></span> height = <span class="steelblue">docNode</span>.<span class="olive">clientHeight</span>;
➌ <span class="steelblue"><span class="strong"><strong>var</strong></span></span> width  = <span class="steelblue">docNode</span>.<span class="olive">clientWidth</span>;
➍ <span class="steelblue"><span class="strong"><strong>var</strong></span></span> dataset = {};
➎ <span class="steelblue">dataset</span>.<span class="olive">max</span> = <span class="red">3</span>;
➏ <span class="steelblue">dataset</span>.<span class="olive">data</span> = [];
   <span class="steelblue"><span class="strong"><strong>for</strong></span></span> (<span class="steelblue"><span class="strong"><strong>var</strong></span></span> i=<span class="red">0</span>; i&lt;<span class="steelblue">game</span>.<span class="olive">length</span>; i++) {
       <span class="steelblue"><span class="strong"><strong>var</strong></span></span> currentShot = game[<span class="red">1</span>];
➐      <span class="steelblue"><span class="strong"><strong>if</strong></span></span> ((<span class="steelblue">currentShot</span>.<span class="olive">x</span> !== -<span class="red">1</span>) &amp;&amp; (<span class="steelblue">currentShot</span>.<span class="olive">y</span> !== -<span class="red">1</span>)) {
           <span class="steelblue"><span class="strong"><strong>var</strong></span></span> x = <span class="steelblue">Math</span>.<span class="olive">round</span>(width * <span class="steelblue">currentShot</span>.<span class="olive">x</span>/<span class="red">10</span>);
           <span class="steelblue"><span class="strong"><strong>var</strong></span></span> y = height - <span class="steelblue">Math</span>.<span class="olive">round</span>(height * <span class="steelblue">currentShot</span>.<span class="olive">y</span>/<span class="red">10</span>);
           <span class="steelblue">dataset</span>.<span class="steelblue">data</span>.<span class="olive">push</span>({<span class="maroon">"x"</span>: x, <span class="maroon">"y"</span>: y, <span class="maroon">"count"</span>: <span class="steelblue">currentShot</span>.<span class="olive">points</span>});
       }
   }</pre><p><a id="iddle1248" class="indexterm"/><a id="iddle1447" class="indexterm"/><a id="iddle1666" class="indexterm"/>We start by fetching the height and width of the containing element at ➊, ➋, and ➌. If those dimensions change, our code will still work fine. Then we initialize the <code class="literal">dataset</code> object ➍, with a <code class="literal">max</code> property ➎ and an empty <code class="literal">data</code> array ➏. Finally, we iterate through the game data and add relevant data points to this array. Notice that we’re filtering out free throws at ➐.</p></div><div class="sect2" title="Step 6: Draw the Map"><div class="titlepage"><div><div><h3 class="title" id="step_6_draw_the_map">Step 6: Draw the Map</h3></div></div></div><p>With a containing element and a formatted data set, it’s a simple matter to draw the heat map. We create the heat-map object (the library uses the name <code class="literal">h337</code> in an attempt to be clever) by specifying the containing element, a radius for each point, and an opacity. Then we add the data set to this object.</p><a id="pro_id00170"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> heatmap = <span class="steelblue">h337</span>.<span class="olive">create</span>({
    <span class="dodgerblue">element</span>: <span class="maroon">"heatmap"</span>,
    <span class="dodgerblue">radius</span>: <span class="red">30</span>,
    <span class="dodgerblue">opacity</span>: <span class="red">50</span>
});
<span class="steelblue">heatmap</span>.<span class="steelblue">store</span>.<span class="olive">setDataSet</span>(dataset);</pre><p>The resulting visualization in <a class="xref" href="ch04.html#heat_map_shows_successful_shots_in_the_g" title="Figure 4-5. The heat map shows successful shots in the game.">Figure 4-5</a> shows where each team scored its points.</p><div class="figure"><a id="heat_map_shows_successful_shots_in_the_g"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00067"/><img src="figs/web/04fig05.png.jpg" alt="The heat map shows successful shots in the game."/></div></div><div class="figure-title">Figure 4-5. The heat map shows successful shots in the game.</div></div></div><div class="sect2" title="Step 7: Adjust the Heat Map z-index"><div class="titlepage"><div><div><h3 class="title" id="step_7_adjust_the_heat_map_z-index">Step 7: Adjust the Heat Map z-index</h3></div></div></div><p><a id="iddle1424" class="indexterm"/><a id="iddle1452" class="indexterm"/><a id="iddle1696" class="indexterm"/><a id="iddle1701" class="indexterm"/><a id="iddle1703" class="indexterm"/><a id="iddle1803" class="indexterm"/><a id="iddle1894" class="indexterm"/><a id="iddle2191" class="indexterm"/>The heatmap.js library is especially aggressive in its manipulation of the <code class="literal">z-index</code> property. To ensure that the heat map appears above all other elements on the page, the library explicitly sets this property to a value of <code class="literal">10000000000</code>. If your web page has elements that you don’t want the heat map to obscure (such as fixed-position navigation menus), that value is probably too aggressive. You can fix it by modifying the source code directly. Or, as an alternative, you can simply reset the value after the library finishes drawing the map.</p><p>If you’re using jQuery, the following code will reduce the <code class="literal">z-index</code> to a more reasonable value.</p><a id="pro_id00171"/><pre class="programlisting"><span class="olive">$</span>(<span class="maroon">"#heatmap canvas"</span>).<span class="olive">css</span>(<span class="maroon">"z-index"</span>, <span class="maroon">"1"</span>);</pre></div></div><div class="sect1" title="Showing Relationships with Network Graphs"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="showing_relationships_with_network_graph">Showing Relationships with Network Graphs</h2></div></div></div><p>Visualizations don’t always focus on the actual data values; sometimes the most interesting aspects of a data set are the relationships among its members. The relationships between members of a social network, for example, might be the most important feature of that network. To visualize these types of relationships, we can use a <span class="emphasis"><em>network graph.</em></span> Network graphs represent objects, generally known as <span class="emphasis"><em>nodes</em></span>, as points or circles. Lines or arcs (technically called <span class="emphasis"><em>edges</em></span>) connect these nodes to indicate relationships.</p><p>Constructing network graphs can be a bit tricky, as the underlying mathematics is not always trivial. Fortunately, the Sigma library (<span class="emphasis"><em><a class="ulink" href="http://sigmajs.org/" target="_top">http://sigmajs.org/</a></em></span>) takes care of most of the complicated calculations. By using that library, we can create full-featured network graphs with just a little bit of JavaScript. For our example, we’ll consider one critic’s list of the top 25 jazz albums of all time (<span class="emphasis"><em><a class="ulink" href="http://www.thejazzresource.com/top_25_jazz_albums.html" target="_top">http://www.thejazzresource.com/top_25_jazz_albums.html</a></em></span>). Several musicians performed on more than one of these albums, and a network graph lets us explore those connections.</p><div class="sect2" title="Step 1: Include the Required Libraries"><div class="titlepage"><div><div><h3 class="title" id="step_1_include_the_required_libr-id00017">Step 1: Include the Required Libraries</h3></div></div></div><p>The Sigma library does not depend on any other JavaScript libraries, so we don’t need any other included scripts. It is not, however, available on common content distribution networks. Consequently, we’ll have to serve it from our own web host.</p><a id="pro_id00172"/><pre class="programlisting">   <span class="dodgerblue">&lt;!DOCTYPE</span> html<span class="dodgerblue">&gt;</span>
   <span class="steelblue"><span class="strong"><strong>&lt;html</strong></span></span> <span class="steelblue">lang=</span><span class="maroon">"en"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;head&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;meta</strong></span></span> <span class="steelblue">charset=</span><span class="maroon">"utf-8"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;title&gt;&lt;/title&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;/head&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;body&gt;</strong></span></span>
➊     <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"graph"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
➋     <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"js/sigma.min.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;/body&gt;</strong></span></span>
   <span class="steelblue"><span class="strong"><strong>&lt;/html&gt;</strong></span></span></pre><p><a id="iddle1702" class="indexterm"/>As you can see, we’ve set aside a <code class="literal">&lt;div&gt;</code> to hold our graph at ➊. We’ve also included the JavaScript library as the last part of the <code class="literal">&lt;body&gt;</code> element at ➋, as that provides the best browser performance.</p><div class="note" title="Note"><h3 class="title"><a id="ch04note02"/>Note</h3><p><span class="strong"><strong>In most of the examples in this book, I included steps you can take to make your visualizations compatible with older web browsers such as IE8. In this case, however, those approaches degrade performance so severely that they are rarely workable. To view the network graph visualization, your users will need a modern browser.</strong></span></p></div></div><div class="sect2" title="Step 2: Prepare the Data"><div class="titlepage"><div><div><h3 class="title" id="step_2_prepare_the_data-id00018">Step 2: Prepare the Data</h3></div></div></div><p>Our data on the top 25 jazz albums looks like the following snippet. I’m showing only the first couple of albums, but you can see the full list in the book’s source code (<span class="emphasis"><em><a class="ulink" href="http://jsDataV.is/source/" target="_top">http://jsDataV.is/source/</a></em></span>).</p><a id="pro_id00173"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> albums = [
  {
    <span class="dodgerblue">album</span>: <span class="maroon">"Miles Davis - Kind of Blue"</span>,
    <span class="dodgerblue">musicians</span>: [
      <span class="maroon">"Cannonball Adderley"</span>,
      <span class="maroon">"Paul Chambers"</span>,
      <span class="maroon">"Jimmy Cobb"</span>,
      <span class="maroon">"John Coltrane"</span>,
      <span class="maroon">"Miles Davis"</span>,
      <span class="maroon">"Bill Evans"</span>
    ]
  },{
    <span class="dodgerblue">album</span>: <span class="maroon">"John Coltrane - A Love Supreme"</span>,
    <span class="dodgerblue">musicians</span>: [
      <span class="maroon">"John Coltrane"</span>,
      <span class="maroon">"Jimmy Garrison"</span>,
      <span class="maroon">"Elvin Jones"</span>,
      <span class="maroon">"McCoy Tyner"</span>
    ]
  <span class="indianred"><span class="emphasis"><em>// Data set continues...</em></span></span></pre><p>That’s not exactly the structure that Sigma requires. We could convert it to a Sigma JSON data structure in bulk, but there’s really no need. Instead, as we’ll see in the next step, we can simply pass data to the library one element at a time.</p></div><div class="sect2" title="Step 3: Define the Graph’s Nodes"><div class="titlepage"><div><div><h3 class="title" id="step_3_define_the_graphapostrophes_nodes">Step 3: Define the Graph’s Nodes</h3></div></div></div><p><a id="iddle1698" class="indexterm"/><a id="iddle1708" class="indexterm"/>Now we’re ready to use the library to construct our graph. We start by initializing the library and indicating where it should construct the graph. That parameter is the <code class="literal">id</code> of the <code class="literal">&lt;div&gt;</code> element set aside to hold the visualization.</p><a id="pro_id00174"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> s = <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="olive">sigma</span>(<span class="maroon">"graph"</span>);</pre><p>Now we can continue by adding the nodes to the graph. In our case, each album is a node. As we add a node to the graph, we give it a unique identifier (which must be a string), a label, and a position. Figuring out an initial position can be a bit tricky for arbitrary data. In a few steps, we’ll look at an approach that makes the initial position less critical. For now, though, we’ll simply spread our albums in a circle using basic trigonometry.</p><a id="pro_id00175"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>for</strong></span></span> (<span class="steelblue"><span class="strong"><strong>var</strong></span></span> idx=<span class="red">0</span>; idx&lt;<span class="steelblue">albums</span>.<span class="olive">length</span>; idx++) {
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> theta = idx*<span class="red">2</span>*<span class="steelblue">Math</span>.<span class="olive">PI</span> / <span class="steelblue">albums</span>.<span class="olive">length</span>;
    <span class="steelblue">s</span>.<span class="steelblue">graph</span>.<span class="olive">addNode</span>({
        <span class="dodgerblue">id</span>: <span class="maroon">""</span>+idx,    <span class="indianred"><span class="emphasis"><em>// Note: 'id' must be a string</em></span></span>
        <span class="dodgerblue">label</span>: albums[idx].<span class="olive">album</span>,
        <span class="dodgerblue">x</span>: radius*<span class="steelblue">Math</span>.<span class="olive">sin</span>(theta),
        <span class="dodgerblue">y</span>: radius*<span class="steelblue">Math</span>.<span class="olive">cos</span>(theta),
        <span class="dodgerblue">size</span>: <span class="red">1</span>
    });
}</pre><p>Here, the <code class="literal">radius</code> value is roughly half of the width of the container. We can also give each node a different size, but for our purposes it’s fine to set every album’s size to <code class="literal">1</code>.</p><p>Finally, after defining the graph, we tell the library to draw it.</p><a id="pro_id00176"/><pre class="programlisting"><span class="steelblue">s</span>.<span class="olive">refresh</span>();</pre><p>With <a class="xref" href="ch04.html#sigma_draws_graph_nodes_as_small_circles" title="Figure 4-6. Sigma draws graph nodes as small circles.">Figure 4-6</a>, we now have a nicely drawn circle of the top 25 jazz albums of all time. In this initial attempt, some of the labels may get in one another’s way, but we’ll address that shortly.</p><p>If you try out this visualization in the browser, you’ll notice that the Sigma library automatically supports panning the graph, and users can move their mouse pointer over individual nodes to highlight the node labels.</p><div class="figure"><a id="sigma_draws_graph_nodes_as_small_circles"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00068"/><img src="figs/web/04fig06.png.jpg" alt="Sigma draws graph nodes as small circles."/></div></div><div class="figure-title">Figure 4-6. Sigma draws graph nodes as small circles.</div></div></div><div class="sect2" title="Step 4: Connect the Nodes with Edges"><div class="titlepage"><div><div><h3 class="title" id="step_4_connect_the_nodes_with_edges">Step 4: Connect the Nodes with Edges</h3></div></div></div><p><a id="iddle1700" class="indexterm"/><a id="iddle1709" class="indexterm"/>Now that we have the nodes drawn in a circle, it’s time to connect them with edges. In our case, an edge—or connection between two albums—represents a musician who performed on both of the albums. Here’s the code that finds those edges.</p><a id="pro_id00177"/><pre class="programlisting">➊ <span class="steelblue"><span class="strong"><strong>for</strong></span></span> (<span class="steelblue"><span class="strong"><strong>var</strong></span></span> srcIdx=<span class="red">0</span>; srcIdx&lt;<span class="steelblue">albums</span>.<span class="olive">length</span>; srcIdx++) {
       <span class="steelblue"><span class="strong"><strong>var</strong></span></span> src = albums[srcIdx];
➋     <span class="steelblue"><span class="strong"><strong>for</strong></span></span> (<span class="steelblue"><span class="strong"><strong>var</strong></span></span> mscIdx=<span class="red">0</span>; mscIdx&lt;<span class="steelblue">src</span>.<span class="steelblue">musicians</span>.<span class="olive">length</span>; mscIdx++) {
           <span class="steelblue"><span class="strong"><strong>var</strong></span></span> msc = <span class="steelblue">src</span>.<span class="olive">musicians</span>[mscIdx];
➌         <span class="steelblue"><span class="strong"><strong>for</strong></span></span> (<span class="steelblue"><span class="strong"><strong>var</strong></span></span> tgtIdx=srcIdx<span class="red">+1</span>; tgtIdx&lt;<span class="steelblue">albums</span>.<span class="olive">length</span>; tgtIdx++) {
               <span class="steelblue"><span class="strong"><strong>var</strong></span></span> tgt = albums[tgtIdx];
➍             <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (<span class="steelblue">tgt</span>.<span class="steelblue">musicians</span>.<span class="olive">some</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(tgtMsc) {<span class="steelblue"><span class="strong"><strong>return</strong></span></span> tgtMsc === msc;}))
   {
                   <span class="steelblue">s</span>.<span class="steelblue">graph</span>.<span class="olive">addEdge</span>({
                       <span class="dodgerblue">id</span>: srcIdx + <span class="maroon">"."</span> + mscIdx + <span class="maroon">"-"</span> + tgtIdx,
                       <span class="dodgerblue">source</span>: <span class="maroon">""</span>+srcIdx,
                       <span class="dodgerblue">target</span>: <span class="maroon">""</span>+tgtIdx
                   })
               }
           }
       }
   }</pre><p><a id="iddle1699" class="indexterm"/><a id="iddle1904" class="indexterm"/>To find the edges, we iterate through the albums in four stages.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Loop through each album as a potential source of a connection at ➊.</p></li><li class="listitem"><p>For the source album, loop through all musicians at ➋.</p></li><li class="listitem"><p>For each musician, loop through all of the remaining albums as potential targets for a connection at ➌.</p></li><li class="listitem"><p>For each target album, loop through all the musicians at ➍, looking for a match.</p></li></ol></div><p>For the last step we’re using the .<code class="literal">some()</code> method of JavaScript arrays. That method takes a function as a parameter, and it returns <code class="literal">true</code> if that function itself returns <code class="literal">true</code> for any element in the array.</p><p>We’ll want to insert this code before we refresh the graph. When we’ve done that, we’ll have a connected circle of albums, as shown in <a class="xref" href="ch04.html#sigma_can_then_connect_graph_nodes_using" title="Figure 4-7. Sigma can then connect graph nodes using lines to represent edges.">Figure 4-7</a>.</p><div class="figure"><a id="sigma_can_then_connect_graph_nodes_using"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00069"/><img src="figs/web/04fig07.png.jpg" alt="Sigma can then connect graph nodes using lines to represent edges."/></div></div><div class="figure-title">Figure 4-7. Sigma can then connect graph nodes using lines to represent edges.</div></div><p>Again, you can pan and zoom in on the graph to focus on different parts.</p></div><div class="sect2" title="Step 5: Automate the Layout"><div class="titlepage"><div><div><h3 class="title" id="step_5_automate_the_layout">Step 5: Automate the Layout</h3></div></div></div><p>So far we’ve manually placed the nodes in our graph in a circle. That’s not a terrible approach, but it can make it hard to discern some of the connections. It would be better if we could let the library calculate a more optimal layout than the simple circle. That’s exactly what we’ll do now.</p><p><a id="iddle1388" class="indexterm"/><a id="iddle1389" class="indexterm"/><a id="iddle1390" class="indexterm"/><a id="iddle1425" class="indexterm"/><a id="iddle1531" class="indexterm"/><a id="iddle1852" class="indexterm"/><a id="iddle1903" class="indexterm"/><a id="iddle2120" class="indexterm"/>The mathematics behind this approach is known as <span class="emphasis"><em>force-directed graphing</em></span>. In a nutshell, the algorithm proceeds by treating the graph’s nodes and edges as physical objects subject to real forces such as gravity and electromagnetism. It simulates the effect of those forces, pushing and prodding the nodes into new positions on the graph.</p><p>The underlying algorithm may be complicated, but Sigma makes it easy to employ. First we have to add the optional <code class="literal">forceAtlas2</code> plug-in to the Sigma library.</p><a id="pro_id00178"/><pre class="programlisting"><span class="dodgerblue">&lt;!DOCTYPE</span> html<span class="dodgerblue">&gt;</span>
<span class="steelblue"><span class="strong"><strong>&lt;html</strong></span></span> <span class="steelblue">lang=</span><span class="maroon">"en"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;head&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;meta</strong></span></span> <span class="steelblue">charset=</span><span class="maroon">"utf-8"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;title&gt;&lt;/title&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;/head&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;body&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"graph"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"js/sigma.min.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"js/sigma.layout.forceAtlas2.min.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;/body&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/html&gt;</strong></span></span></pre><p>Mathieu Jacomy and Tommaso Venturini developed the specific force-direction algorithm employed by this plug-in; they document the algorithm, known as <span class="emphasis"><em>ForceAtlas2</em></span>, in the 2011 paper “ForceAtlas2, A Graph Layout Algorithm for Handy Network Visualization” (<span class="emphasis"><em><a class="ulink" href="http://webatlas.fr/tempshare/ForceAtlas2_Paper.pdf" target="_top">http://webatlas.fr/tempshare/ForceAtlas2_Paper.pdf</a>).</em></span> Although we don’t have to understand the mathematical details of the algorithm, knowing how to use its parameters does come in handy. There are three parameters that are important for most visualizations that use the plug-in:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: none"><p title="gravity"><span class="title"><strong><span class="strong"><strong><code class="literal">gravity</code></strong></span></strong></span>. This parameter determines how strongly the algorithm tries to keep isolated nodes from drifting off the edges of the screen. Without any gravity, the only force acting on isolated nodes will be one that repels them from other nodes; undeterred, that force will push the nodes off the screen entirely. Since our data includes several isolated nodes, we’ll want to set this value relatively high to keep those nodes on the screen.</p></li><li class="listitem" style="list-style-type: none"><p title="scalingRatio"><span class="title"><strong><span class="strong"><strong><code class="literal">scalingRatio</code></strong></span></strong></span>. This parameter determines how strongly nodes repel each other. A small value draws connected nodes closer together, while a large value forces all nodes farther apart.</p></li><li class="listitem" style="list-style-type: none"><p title="slowDown"><span class="title"><strong><span class="strong"><strong><code class="literal">slowDown</code></strong></span></strong></span>. This parameter decreases the sensitivity of the nodes to the repulsive forces from their neighbors. Reducing the sensitivity (by increasing this value) can help reduce the instability that may result when nodes face competing forces from multiple neighbors. In our data there are many connections that will tend to draw the nodes together and compete with the force pulling them apart. To dampen the wild oscillations that might otherwise ensue, we’ll set this value relatively high as well.</p></li></ul></div><p>The best way to settle on values for these parameters is to experiment with the actual data. The values we’ve settled on for this data set are shown in the following code.</p><a id="pro_id00179"/><pre class="programlisting"><span class="steelblue">s</span>.<span class="olive">startForceAtlas2</span>({<span class="dodgerblue">gravity</span>:<span class="red">100</span>,<span class="dodgerblue">scalingRatio</span>:<span class="red">70</span>,<span class="dodgerblue">slowDown</span>:<span class="red">100</span>});
<span class="olive">setTimeout</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>() { <span class="steelblue">s</span>.<span class="olive">stopForceAtlas2</span>(); }, <span class="red">10000</span>);</pre><p>Now, instead of simply refreshing the graph when we’re ready to display it, we start the force-directed algorithm, which periodically refreshes the display while it performs its simulation. We also need to stop the algorithm after it’s had a chance to run for a while. In our case, 10 seconds (<code class="literal">10000</code> milliseconds) is plenty of time.</p><p>As a result, our albums start out in their original circle, but quickly migrate to a position that makes it much easier to identify the connections. Some of the top albums are tightly connected, indicating that they have many musicians in common. A few, however, remain isolated. Their musicians make the list only once.</p><p>As you can see in <a class="xref" href="ch04.html#force_direction_positions_the_graph_node" title="Figure 4-8. Force direction positions the graph nodes automatically.">Figure 4-8</a>, the labels for the nodes still get in the way of one another; we’ll fix that in the next step. What’s important here, however, is that it’s much easier to identify the albums with lots of connections. The nodes representing those albums have migrated to the center of the graph, and they have many links to other nodes.</p><div class="figure"><a id="force_direction_positions_the_graph_node"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00070"/><img src="figs/web/04fig08.png.jpg" alt="Force direction positions the graph nodes automatically."/></div></div><div class="figure-title">Figure 4-8. Force direction positions the graph nodes automatically.</div></div></div><div class="sect2" title="Step 6: Add Interactivity"><div class="titlepage"><div><div><h3 class="title" id="step_6_add_interactivity">Step 6: Add Interactivity</h3></div></div></div><p><a id="iddle1144" class="indexterm"/><a id="iddle1311" class="indexterm"/><a id="iddle1559" class="indexterm"/><a id="iddle1697" class="indexterm"/><a id="iddle1884" class="indexterm"/>To keep the labels from interfering with one another, we can add some interactivity to the graph. By default, we’ll hide the labels entirely, giving users the chance to appreciate the structure of the graph without distractions. We’ll then allow them to click on individual nodes to reveal the album title and its connections.</p><a id="pro_id00180"/><pre class="programlisting">   <span class="steelblue"><span class="strong"><strong>for</strong></span></span> (<span class="steelblue"><span class="strong"><strong>var</strong></span></span> idx=<span class="red">0</span>; idx&lt;<span class="steelblue">albums</span>.<span class="olive">length</span>; idx++) {
       <span class="steelblue"><span class="strong"><strong>var</strong></span></span> theta = idx*<span class="red">2</span>*<span class="steelblue">Math</span>.<span class="olive">PI</span> / <span class="steelblue">albums</span>.<span class="olive">length</span>;
       <span class="steelblue">s</span>.<span class="steelblue">graph</span>.<span class="olive">addNode</span>({
           <span class="dodgerblue">id</span>: <span class="maroon">""</span>+idx, <span class="indianred"><span class="emphasis"><em>// Note: 'id' must be a string</em></span></span>
➊         <span class="dodgerblue">label</span>: <span class="maroon">""</span>,
➋         <span class="dodgerblue">album</span>: albums[idx].<span class="olive">album</span>,
           <span class="dodgerblue">x</span>: radius*<span class="steelblue">Math</span>.<span class="olive">sin</span>(theta),
           <span class="dodgerblue">y</span>: radius*<span class="steelblue">Math</span>.<span class="olive">cos</span>(theta),
           <span class="dodgerblue">size</span>: <span class="red">1</span>
       });
   }</pre><p>To suppress the initial label display, we modify the initialization code at ➊ so that nodes have blank labels. We save a reference to the album title, though, at ➋.</p><p>Now we need a function that responds to clicks on the node elements. The Sigma library supports exactly this sort of function with its interface. We simply bind to the <code class="literal">clickNode</code> event.</p><a id="pro_id00181"/><pre class="programlisting"><span class="steelblue">s</span>.<span class="olive">bind</span>(<span class="maroon">"clickNode"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev) {
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> nodeIdx = <span class="steelblue">ev</span>.<span class="steelblue">data</span>.<span class="steelblue">node</span>.<span class="olive">id</span>;
    <span class="indianred"><span class="emphasis"><em>// Code continues...</em></span></span>
});</pre><p>Within that function, the <code class="literal">ev.data.node.id</code> property gives us the index of the node that the user clicked. The complete set of nodes is available from the array returned by <code class="literal">s.graph.nodes()</code>. Since we want to display the label for the clicked node (but not for any other), we can iterate through the entire array. At each iteration, we either set the <code class="literal">label</code> property to an empty string (to hide it) or to the <code class="literal">album</code> property (to show it).</p><a id="pro_id00182"/><pre class="programlisting">   <span class="steelblue">s</span>.<span class="olive">bind</span>(<span class="maroon">"clickNode"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev) {
       <span class="steelblue"><span class="strong"><strong>var</strong></span></span> nodeIdx = <span class="steelblue">ev</span>.<span class="steelblue">data</span>.<span class="steelblue">node</span>.<span class="olive">id</span>;
       <span class="steelblue"><span class="strong"><strong>var</strong></span></span> nodes = <span class="steelblue">s</span>.<span class="steelblue">graph</span>.<span class="olive">nodes</span>();
       <span class="steelblue">nodes</span>.<span class="olive">forEach</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(node) {
➊         <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (nodes[nodeIdx] === node) {
               <span class="steelblue">node</span>.<span class="olive">label</span> = <span class="steelblue">node</span>.<span class="olive">album</span>;
           } <span class="steelblue"><span class="strong"><strong>else</strong></span></span> {
               <span class="steelblue">node</span>.<span class="olive">label</span> = <span class="maroon">""</span>;
           }
       });
   });</pre><p><a id="iddle1566" class="indexterm"/><a id="iddle1885" class="indexterm"/><a id="iddle1908" class="indexterm"/><a id="iddle1965" class="indexterm"/><a id="iddle1990" class="indexterm"/><a id="iddle1998" class="indexterm"/><a id="iddle2165" class="indexterm"/><a id="iddle2170" class="indexterm"/>Now that users have a way to show the title of an album, let’s give them a way to hide it. A small addition at ➊ is all it takes to let users toggle the album display with subsequent clicks.</p><a id="pro_id00183"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>if</strong></span></span> (nodes[nodeIdx] === node &amp;&amp; <span class="steelblue">node</span>.<span class="olive">label</span> !== <span class="steelblue">node</span>.<span class="olive">album</span>) {</pre><p>As long as we’re making the graph respond to clicks, we can also take the opportunity to highlight the clicked node’s connections. We do that by changing their color. Just as <code class="literal">s.graph.nodes()</code> returns an array of the graph nodes, <code class="literal">s.graph.edges()</code> returns an array of edges. Each edge object includes <code class="literal">target</code> and <code class="literal">source</code> properties that hold the index of the relevant node.</p><a id="pro_id00184"/><pre class="programlisting">   <span class="steelblue">s</span>.<span class="steelblue">graph</span>.<span class="olive">edges</span>().<span class="olive">forEach</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(edge) {
       <span class="steelblue"><span class="strong"><strong>if</strong></span></span> ((nodes[nodeIdx].<span class="olive">label</span> === nodes[nodeIdx].<span class="olive">album</span>) &amp;&amp;
➊         ((<span class="steelblue">edge</span>.<span class="olive">target</span> === nodeIdx) || (<span class="steelblue">edge</span>.<span class="olive">source</span> === nodeIdx))) {
➋         <span class="steelblue">edge</span>.<span class="olive">color</span> = <span class="maroon">"blue"</span>;
       } <span class="steelblue"><span class="strong"><strong>else</strong></span></span> {
➌         <span class="steelblue">edge</span>.<span class="olive">color</span> = <span class="maroon">"black"</span>;
       }
   });</pre><p>Here we scan through all the graph’s edges to see if they connect to the clicked node. If the edge does connect to the node, we change its color at ➋ to something other than the default. Otherwise, we change the color back to the default at ➌. You can see that we’re using the same approach to toggle the edge colors as we did to toggle the node labels on successive clicks at ➊.</p><p>Now that we’ve changed the graph properties, we have to tell Sigma to redraw it. That’s a simple matter of calling <code class="literal">s.refresh()</code>.</p><a id="pro_id00185"/><pre class="programlisting"><span class="steelblue">s</span>.<span class="olive">refresh</span>();</pre><p>Now we have a fully interactive network graph in <a class="xref" href="ch04.html#interactive_graph_gives_users_the_chance" title="Figure 4-9. An interactive graph gives users the chance to highlight specific nodes.">Figure 4-9</a>.</p></div></div><div class="sect1" title="Revealing Language Patterns with Word Clouds"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="revealing_language_patterns_with_word_cl">Revealing Language Patterns with Word Clouds</h2></div></div></div><p>Data visualizations don’t always focus on numbers. Sometimes the data for a visualization centers on words instead, and a <span class="emphasis"><em>word cloud</em></span> is often an effective way to present this kind of data. Word clouds can associate any quantity with a list of words; most often that quantity is a relative frequency. This type of word cloud, which we’ll create for our next example, reveals which words are common and which are rare.</p><div class="figure"><a id="interactive_graph_gives_users_the_chance"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00071"/><img src="figs/web/04fig09.png.jpg" alt="An interactive graph gives users the chance to highlight specific nodes."/></div></div><div class="figure-title">Figure 4-9. An interactive graph gives users the chance to highlight specific nodes.</div></div><p><a id="iddle1291" class="indexterm"/><a id="iddle1468" class="indexterm"/><a id="iddle2168" class="indexterm"/><a id="iddle2172" class="indexterm"/>To create this visualization, we’ll rely on the wordcloud2 library (<span class="emphasis"><em><a class="ulink" href="http://timdream.org/wordcloud2.js" target="_top">http://timdream.org/wordcloud2.js</a></em></span>), a spin-off from author Tim Dream’s HTML5 Word Cloud project (<span class="emphasis"><em><a class="ulink" href="http://timc.idv.tw/wordcloud/" target="_top">http://timc.idv.tw/wordcloud/</a></em></span>).</p><div class="note" title="Note"><h3 class="title"><a id="ch04note03"/>Note</h3><p><span class="strong"><strong>As is the case with a few of the more advanced libraries we’ve examined, wordcloud2 doesn’t function very well in older web browsers such as IE8 and earlier. Since wordcloud2 itself requires a modern browser, for this example we won’t worry about compatibility with older browsers. This will free us to use some other modern JavaScript features, too.</strong></span></p></div><div class="sect2" title="Step 1: Include the Required Libraries"><div class="titlepage"><div><div><h3 class="title" id="step_1_include_the_required_libr-id00019">Step 1: Include the Required Libraries</h3></div></div></div><p>The wordcloud2 library does not depend on any other JavaScript libraries, so we don’t need any other included scripts. It is not, however, available on common content distribution networks, so we’ll have to serve it from our own web host.</p><a id="pro_id00186"/><pre class="programlisting"><span class="dodgerblue">&lt;!DOCTYPE</span> html<span class="dodgerblue">&gt;</span>
<span class="steelblue"><span class="strong"><strong>&lt;html</strong></span></span> <span class="steelblue">lang=</span><span class="maroon">"en"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;head&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;meta</strong></span></span> <span class="steelblue">charset=</span><span class="maroon">"utf-8"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;title&gt;&lt;/title&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;/head&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;body&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"js/wordcloud2.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;/body&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/html&gt;</strong></span></span></pre><p><a id="iddle1966" class="indexterm"/><a id="iddle1996" class="indexterm"/><a id="iddle2171" class="indexterm"/><a id="iddle2173" class="indexterm"/>To keep our example focused on the visualization, we’ll use a word list that doesn’t need any special preparation. If you’re working with natural language as spoken or written, however, you might wish to process the text to identify alternate forms of the same word. For example, you might want to count <span class="emphasis"><em>hold</em></span>, <span class="emphasis"><em>holds</em></span>, and <span class="emphasis"><em>held</em></span> as three instances of <span class="emphasis"><em>hold</em></span> rather than three separate words. This type of processing obviously depends greatly on the particular language. If you’re working in English and Chinese, though, the same developer that created wordcloud2 has also released the WordFreq JavaScript library (<span class="emphasis"><em><a class="ulink" href="http://timdream.org/wordfreq/" target="_top">http://timdream.org/wordfreq/</a></em></span>), which performs exactly this type of analysis.</p></div><div class="sect2" title="Step 2: Prepare the Data"><div class="titlepage"><div><div><h3 class="title" id="step_2_prepare_the_data-id00020">Step 2: Prepare the Data</h3></div></div></div><p>For this example, we’ll look at the different tags users associate with their questions on the popular Stack Overflow (<span class="emphasis"><em><a class="ulink" href="http://stackoverflow.com/" target="_top">http://stackoverflow.com/</a></em></span>). That site lets users pose programming questions that the community tries to answer. Tags provide a convenient way to categorize the questions so that users can browse other posts related to the same topic. By constructing a word cloud (perhaps better named a <span class="emphasis"><em>tag cloud</em></span>), we can quickly show the relative popularity of different programming topics.</p><p>If you wanted to develop this example into a real application, you could access the Stack Overflow data in real time using the site’s API. For our example, though, we’ll use a static snapshot. Here’s how it starts:</p><a id="pro_id00187"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> tags = [
    [<span class="maroon">"c#"</span>, <span class="red">601251</span>],
    [<span class="maroon">"java"</span>, <span class="red">585413</span>],
    [<span class="maroon">"javascript"</span>, <span class="red">557407</span>],
    [<span class="maroon">"php"</span>, <span class="red">534590</span>],
    [<span class="maroon">"android"</span>, <span class="red">466436</span>],
    [<span class="maroon">"jquery"</span>, <span class="red">438303</span>],
    [<span class="maroon">"python"</span>, <span class="red">274216</span>],
    [<span class="maroon">"c++"</span>, <span class="red">269570</span>],
    [<span class="maroon">"html"</span>, <span class="red">259946</span>],
    <span class="indianred"><span class="emphasis"><em>// Data set continues...</em></span></span></pre><p>In this data set, the list of tags is an array, and each tag within the list is also an array. These inner arrays have the word itself as the first item and a count for that word as the second item. You can see the complete list in the book’s source code (<span class="emphasis"><em><a class="ulink" href="http://jsDataV.is/source/" target="_top">http://jsDataV.is/source/</a></em></span>).</p><p><a id="iddle1114" class="indexterm"/><a id="iddle1627" class="indexterm"/><a id="iddle2169" class="indexterm"/>The format that wordcloud2 expects is quite similar to how our data is already laid out, except that in each word array, the second value needs to specify the drawing size for that word. For example, the array element <code class="literal">["javascript", 56]</code> would tell wordcloud2 to draw <span class="emphasis"><em>javascript</em></span> with a height of 56 pixels. Our data, of course, isn’t set up with pixel sizes. The data value for <span class="emphasis"><em>javascript</em></span> is <code class="literal">557407</code>, and a word 557,407 pixels high wouldn’t even fit on a billboard. As a result, we must convert counts to drawing sizes. The specific algorithm for this conversion will depend both on the size of the visualization and on the raw values. A simple approach that works in this case is to divide the count values by 10,000 and round to the nearest integer.</p><a id="pro_id00188"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> list = <span class="steelblue">tags</span>.<span class="olive">map</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(word) {
    <span class="steelblue"><span class="strong"><strong>return</strong></span></span> [word[<span class="red">0</span>], <span class="steelblue">Math</span>.<span class="olive">round</span>(word[<span class="red">1</span>]/<span class="red">10000</span>)];
});</pre><p>In <a class="xref" href="ch02.html" title="Chapter 2. Making Charts Interactive">Chapter 2</a>, we saw how jQuery’s <code class="literal">.map()</code> function makes it easy to process all the elements in an array. It turns out that modern browsers have the same functionality built in, so here we use the native version of <code class="literal">.map()</code> even without jQuery. (This native version won’t work on older browsers like jQuery will, but we’re not worrying about that for this example.)</p><p>After this code executes, our <code class="literal">list</code> variable will contain the following:</p><a id="pro_id00189"/><pre class="programlisting">[
    [<span class="maroon">"c#"</span>, <span class="red">60</span>],
    [<span class="maroon">"java"</span>, <span class="red">59</span>],
    [<span class="maroon">"javascript"</span>, <span class="red">56</span>],
    [<span class="maroon">"php"</span>, <span class="red">53</span>],
    [<span class="maroon">"android"</span>, <span class="red">47</span>],
    [<span class="maroon">"jquery"</span>, <span class="red">44</span>],
    [<span class="maroon">"python"</span>, <span class="red">27</span>],
    [<span class="maroon">"c++"</span>, <span class="red">27</span>],
    [<span class="maroon">"html"</span>, <span class="red">26</span>],
    <span class="indianred"><span class="emphasis"><em>// Data set continues...</em></span></span></pre></div><div class="sect2" title="Step 3: Add the Required Markup"><div class="titlepage"><div><div><h3 class="title" id="step_3_add_the_required_markup">Step 3: Add the Required Markup</h3></div></div></div><p>The wordcloud2 library can build its graphics either using the HTML <code class="literal">&lt;canvas&gt;</code> interface or in pure HTML. As we’ve seen with many graphing libraries, <code class="literal">&lt;canvas&gt;</code> is a convenient interface for creating graphic elements. For word clouds, however, there aren’t many benefits to using <code class="literal">&lt;canvas&gt;</code>. Native HTML, on the other hand, lets us use all the standard HTML tools (such as CSS style sheets or JavaScript event handling). That’s the approach we’ll take in this example.</p><a id="pro_id00190"/><pre class="programlisting">   <span class="dodgerblue">&lt;!DOCTYPE</span> html<span class="dodgerblue">&gt;</span>
   <span class="steelblue"><span class="strong"><strong>&lt;html</strong></span></span> <span class="steelblue">lang=</span><span class="maroon">"en"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;head&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;meta</strong></span></span> <span class="steelblue">charset=</span><span class="maroon">"utf-8"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;title&gt;&lt;/title&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;/head&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;body&gt;</strong></span></span>
➊     <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"cloud"</span> <span class="steelblue">style=</span><span class="maroon">"position:relative;"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"js/wordcloud2.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;/body&gt;</strong></span></span>
   <span class="steelblue"><span class="strong"><strong>&lt;/html&gt;</strong></span></span></pre><p><a id="iddle1778" class="indexterm"/><a id="iddle2167" class="indexterm"/>When using native HTML, we do have to make sure that the containing element has a <code class="literal">position: relative</code> style, because wordcloud2 relies on that when placing the words in their proper location in the cloud. You can see that here we’ve set that style inline at ➊.</p></div><div class="sect2" title="Step 4: Create a Simple Cloud"><div class="titlepage"><div><div><h3 class="title" id="step_4_create_a_simple_cloud">Step 4: Create a Simple Cloud</h3></div></div></div><p>With these preparations in place, creating a simple word cloud is about as easy as it can get. We call the wordcloud2 library and tell it the HTML element in which to draw the cloud, and the list of words for the cloud’s data.</p><a id="pro_id00191"/><pre class="programlisting"><span class="olive">WordCloud</span>(<span class="steelblue">document</span>.<span class="olive">getElementById</span>(<span class="maroon">"cloud"</span>), {<span class="dodgerblue">list</span>: list});</pre><p>Even with nothing other than default values, wordcloud2 creates the attractive visualization shown in <a class="xref" href="ch04.html#word_cloud_can_show_a_list_of_words_with" title="Figure 4-10. A word cloud can show a list of words with their relative frequency.">Figure 4-10</a>.</p><p>The wordcloud2 interface also provides many options for customizing the visualization. As expected, you can set colors and fonts, but you can also change the shape of the cloud (even providing a custom polar equation), rotation limits, internal grid sizing, and many other features.</p><div class="figure"><a id="word_cloud_can_show_a_list_of_words_with"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00072"/><img src="figs/web/04fig10.png.jpg" alt="A word cloud can show a list of words with their relative frequency."/></div></div><div class="figure-title">Figure 4-10. A word cloud can show a list of words with their relative frequency.</div></div></div><div class="sect2" title="Step 5: Add Interactivity"><div class="titlepage"><div><div><h3 class="title" id="step_5_add_interactivity">Step 5: Add Interactivity</h3></div></div></div><p><a id="iddle1115" class="indexterm"/><a id="iddle2166" class="indexterm"/>If you ask wordcloud2 to use the <code class="literal">&lt;canvas&gt;</code> interface, it gives you a couple of callback hooks that your code can use to respond to user interactions. With native HTML, however, we aren’t limited to just the callbacks that wordcloud2 provides. To demonstrate, we can add a simple interaction to respond to mouse clicks on words in the cloud.</p><p>First we’ll let users know that interactions are supported by changing the cursor to a pointer when they hover the mouse over a cloud word.</p><a id="pro_id00192"/><pre class="programlisting"><span class="red">#cloud</span> span <span class="steelblue"><span class="strong"><strong>{</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>cursor:</strong></span></span> <span class="dodgerblue">pointer</span><span class="steelblue"><span class="strong"><strong>;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>}</strong></span></span></pre><p>Next let’s add an extra element to the markup where we can display information about any clicked word.</p><a id="pro_id00193"/><pre class="programlisting">   <span class="dodgerblue">&lt;!DOCTYPE</span> html<span class="dodgerblue">&gt;</span>
   <span class="steelblue"><span class="strong"><strong>&lt;html</strong></span></span> <span class="steelblue">lang=</span><span class="maroon">"en"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;head&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;meta</strong></span></span> <span class="steelblue">charset=</span><span class="maroon">"utf-8"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;title&gt;&lt;/title&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;/head&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;body&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"cloud"</span> <span class="steelblue">style=</span><span class="maroon">"position:relative;"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
➊     <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"details"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;div&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"js/wordcloud2.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;/body&gt;</strong></span></span>
   <span class="steelblue"><span class="strong"><strong>&lt;/html&gt;</strong></span></span></pre><p>Here we’ve added the <code class="literal">&lt;div&gt;</code> with the <code class="literal">id details</code> at ➊.</p><p>Then we define a function that can be called when the user clicks within the cloud.</p><a id="pro_id00194"/><pre class="programlisting">   <span class="steelblue"><span class="strong"><strong>var</strong></span></span> clicked = <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev) {
➊     <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (<span class="steelblue">ev</span>.<span class="steelblue">target</span>.<span class="olive">nodeName</span> === <span class="maroon">"SPAN"</span>) {
           <span class="indianred"><span class="emphasis"><em>// A &lt;span&gt; element was the target of the click</em></span></span>
       }
   }</pre><p>Because our function will be called for any clicks on the cloud (including clicks on empty space), it first checks to see if the target of the click was really a word. Words are contained in <code class="literal">&lt;span&gt;</code> elements, so we can verify that by looking at the <code class="literal">nodeName</code> property of the click target. As you can see at ➊, JavaScript node names are always uppercase.</p><p>If the user did click on a word, we can find out which word by looking at the <code class="literal">textContent</code> property of the event target.</p><a id="pro_id00195"/><pre class="programlisting">   <span class="steelblue"><span class="strong"><strong>var</strong></span></span> clicked = <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev) {
       <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (<span class="steelblue">ev</span>.<span class="steelblue">target</span>.<span class="olive">nodeName</span> === <span class="maroon">"SPAN"</span>) {
➊         <span class="steelblue"><span class="strong"><strong>var</strong></span></span> tag = <span class="steelblue">ev</span>.<span class="steelblue">target</span>.<span class="olive">textContent</span>;
       }
   }</pre><p><a id="iddle1143" class="indexterm"/><a id="iddle1346" class="indexterm"/><a id="iddle1428" class="indexterm"/><a id="iddle1707" class="indexterm"/>After ➊, the variable <code class="literal">tag</code> will hold the word on which the user clicked. So, for example, if a user clicks on the word <span class="emphasis"><em>javascript</em></span>, then the tag variable will have the value <code class="literal">"javascript"</code>.</p><p>Since we’d like to show users the total count when they click on a word, we’re going to need to find the word in our original data set. We have the word’s value, so that’s simply a matter of searching through the data set to find a match. If we were using jQuery, the <code class="literal">.grep()</code> function would do just that. In this example, we’re sticking with native JavaScript, so we can look for an equivalent method in pure JavaScript. Unfortunately, although there is such a native method defined—<code class="literal">.find()</code>—very few browsers, even modern ones, currently support it. We could resort to a standard <code class="literal">for</code> or <code class="literal">forEach</code> loop, but there is an alternative that many consider an improvement over that approach. It relies on the <code class="literal">.some()</code> method, an array method that modern browsers support. The <code class="literal">.some()</code> method passes every element of an array to an arbitrary function and stops when that function returns <code class="literal">true</code>. Here’s how we can use it to find the clicked tag in our <code class="literal">tags</code> array.</p><a id="pro_id00196"/><pre class="programlisting">   <span class="steelblue"><span class="strong"><strong>var</strong></span></span> clicked = <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev) {
       <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (<span class="steelblue">ev</span>.<span class="steelblue">target</span>.<span class="olive">nodeName</span> === <span class="maroon">"SPAN"</span>) {
           <span class="steelblue"><span class="strong"><strong>var</strong></span></span> tag = <span class="steelblue">ev</span>.<span class="steelblue">target</span>.<span class="olive">textContent</span>;
           <span class="steelblue"><span class="strong"><strong>var</strong></span></span> clickedTag;
➊        <span class="steelblue">tags</span>.<span class="olive">some</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(el) {
➋            <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (el[<span class="red">0</span>] === tag) {
                   clickedTag = el;
                   <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue"><span class="strong"><strong>true</strong></span></span>;  <span class="indianred"><span class="emphasis"><em>// This ends the .some() loop</em></span></span>
              }
➌            <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue"><span class="strong"><strong>false</strong></span></span>;
➍        });
       }
   }</pre><p>The function that’s the argument to <code class="literal">.some()</code> is defined beginning at ➊ and ending at ➍. It is called with the parameter <code class="literal">el</code>, short for an <span class="emphasis"><em>element</em></span> in the <code class="literal">tags</code> array. The conditional statement at ➋ checks to see if that element’s word matches the clicked node’s text content. If so, the function sets the <code class="literal">clickedTag</code> variable and returns <code class="literal">true</code> to terminate the <code class="literal">.some()</code> loop.</p><p>If the clicked word doesn’t match the element we’re checking in the <code class="literal">tags</code> array, then the function supplied to .<code class="literal">some()</code> returns <code class="literal">false</code> at ➌. When .<code class="literal">some()</code> sees a <code class="literal">false</code> return value, it continues iterating through the array.</p><p>We can use the return value of the <code class="literal">.some()</code> method to make sure the clicked element was found in the array. When that’s the case, <code class="literal">.some()</code> itself returns <code class="literal">true</code>.</p><a id="pro_id00197"/><pre class="programlisting">   <span class="steelblue"><span class="strong"><strong>var</strong></span></span> clicked = <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev) {
     <span class="steelblue"><span class="strong"><strong>var</strong></span></span> details = <span class="maroon">""</span>;

     <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (<span class="steelblue">ev</span>.<span class="steelblue">target</span>.<span class="olive">nodeName</span> === <span class="maroon">"SPAN"</span>) {
         <span class="steelblue"><span class="strong"><strong>var</strong></span></span> tag = <span class="steelblue">ev</span>.<span class="steelblue">target</span>.<span class="olive">textContent</span>,
             clickedTag;
         <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (<span class="steelblue">tags</span>.<span class="olive">some</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(el) {
             <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (el[<span class="red">0</span>] === tag) {
                   clickedTag = el;
                   <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue"><span class="strong"><strong>true</strong></span></span>;
             }
             <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue"><span class="strong"><strong>false</strong></span></span>;
         })) {
➊           details = <span class="maroon">"There were "</span> + clickedTag[<span class="red">1</span>] +
➋                     <span class="maroon">" Stack Overflow questions tagged \""</span> + tag + <span class="maroon">"\""</span>;
         }
     }
➌   <span class="steelblue">document</span>.<span class="olive">getElementById</span>(<span class="maroon">"details"</span>).<span class="olive">innerText</span> = details;
   }</pre><p><a id="iddle1905" class="indexterm"/><a id="iddle1997" class="indexterm"/>At ➊ and ➋ we update the <code class="literal">details</code> variable with extra information. At ➌ we update the web page with those details.</p><p>And finally we tell the browser to call our handler when a user clicks on anything in the cloud container.</p><a id="pro_id00198"/><pre class="programlisting"><span class="steelblue">document</span>.<span class="olive">getElementById</span>(<span class="maroon">"cloud"</span>).<span class="olive">addEventListener</span>(<span class="maroon">"click"</span>, clicked)</pre><p>With these few lines of code, our word cloud is now interactive, as shown in <a class="xref" href="ch04.html#because_our_word_cloud_consists_of_stand" title="Figure 4-11. Because our word cloud consists of standard HTML elements, we can make it interactive with simple JavaScript event handlers.">Figure 4-11</a>.</p><div class="figure"><a id="because_our_word_cloud_consists_of_stand"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00073"/><img src="figs/web/04fig11.png.jpg" alt="Because our word cloud consists of standard HTML elements, we can make it interactive with simple JavaScript event handlers."/></div></div><div class="figure-title">Figure 4-11. Because our word cloud consists of standard HTML elements, we can make it interactive with simple JavaScript event handlers.</div></div></div></div><div class="sect1" title="Summing Up"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="summing_up-id00021">Summing Up</h2></div></div></div><p><a id="iddle1268" class="indexterm"/>In this chapter, we’ve looked at several different special-purpose visualizations and some JavaScript libraries that can help us create them. Tree maps are handy for showing both hierarchy and dimension in a single visualization. Heat maps can highlight varying intensities throughout a region. Network graphs reveal the connections between objects. And word clouds show relative relationships between language properties in an attractive and concise visualization.</p></div></section></body></html>