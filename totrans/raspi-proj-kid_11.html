<html><head></head><body>
<h2 class="h2" id="ch11"><span epub:type="pagebreak" id="page_185"/>11<br/>NATURE BOX: MOTION-SENSING CAMERA</h2>&#13;
<p class="noindent"><span class="big1">IN THIS CHAPTER, YOU’LL BUILD AND CODE A NATURE BOX CAMERA THAT CAN SNAP A PHOTO WHEN IT SENSES MOVEMENT. YOU’LL THEN PLACE THE NATURE BOX IN THE WILD TO PHOTOGRAPH LOCAL WILDLIFE. YOU NEVER KNOW—YOU MAY SNAP A BIRD, A BADGER, OR EVEN A FOX!</span></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_186"/>The box will contain a motion sensor. Whenever animals come close to it, the sensor triggers the built-in Pi Camera to take a photo. The Raspberry Pi then uploads each image to an online Dropbox folder for you to view and share with your friends. You can leave the camera running from morning to evening and see what kind of visitors you get (<a href="ch11.xhtml#ch11fig01">Figure 11-1</a>).</p>&#13;
<div class="image"><img alt="Image" src="../images/11fig01.jpg"/></div>&#13;
<p class="figcap" id="ch11fig01"><strong>FIGURE 11-1</strong> Build a nature box that takes animal photos like this one.</p>&#13;
<h3 class="h3" id="ch11lev1sec1">WHAT YOU’LL NEED</h3>&#13;
<p class="noindent">Here are a few items you’ll need to complete the project:</p>&#13;
<ul>&#13;
<li class="noindent">Raspberry Pi (You can build the nature box with any of the Pi models. The Pi 2, 3 A+, and Zero W work well because they are small and can be hidden in a smaller space.)</li>&#13;
<li class="noindent">Pi Camera</li>&#13;
<li class="noindent">Passive infrared sensor (PIR)</li>&#13;
<li class="noindent">Jumper wires</li>&#13;
<li class="noindent">Clear plastic box to hold the hardware</li>&#13;
<li class="noindent">Dropbox account</li>&#13;
<li class="noindent">USB portable battery</li>&#13;
<li class="noindent">Drill</li>&#13;
</ul>&#13;
<h3 class="h3" id="ch11lev1sec2">SETTING UP THE PASSIVE INFRARED SENSOR</h3>&#13;
<p class="noindent">A PIR (<a href="ch11.xhtml#ch11fig02">Figure 11-2</a>) is more commonly referred to as a <em>movement detector</em>. It detects infrared light emitted from warm objects and bodies, such as humans, animals, and even vehicles; it measures changes in that light. You can write code to respond to the detection of certain levels of change and trigger events in response, such as turning on lights, sounding alarms, or opening doors automatically.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_187"/>As an object passes by the PIR, it emits heat that changes the surrounding temperature. This difference in the surrounding infrared radiation is picked up by the PIR and changes the internal voltage, which means it has detected something. Inside the sensor’s dome are small mirrors that help the PIR to detect changes in infrared light from as far away as 30 feet.</p>&#13;
<div class="image"><img alt="Image" src="../images/11fig02.jpg"/></div>&#13;
<p class="figcap" id="ch11fig02"><strong>FIGURE 11-2</strong> A PIR</p>&#13;
<h4 class="h4" id="ch11lev2sec1">Wiring the PIR</h4>&#13;
<p class="noindent">You need just three wires to connect the PIR to the Raspberry Pi. Connect the VCC PIR pin, which provides power, to the 5V GPIO pin located at the top of the Pi’s board. The diagram in <a href="ch11.xhtml#ch11fig03">Figure 11-3</a> uses the 5V pin, which is physical pin 2. Connect the OUT pin to GPIO pin 4, which is physical pin 7, on the Pi. Then connect the ground (GND) pin on the PIR to a ground pin on the Pi.</p>&#13;
<div class="image"><img alt="Image" src="../images/11fig03.jpg"/></div>&#13;
<p class="figcap" id="ch11fig03"><strong>FIGURE 11-3</strong> Wiring the PIR</p>&#13;
<h4 class="h4" id="ch11lev2sec2">Testing the PIR</h4>&#13;
<p class="noindent">Let’s write a simple program to test that your PIR works correctly. Your body gives off heat, and when you move about, you disturb and move the heat surrounding your body. The code in <a href="ch11.xhtml#ch11ex01">Listing 11-1</a> initializes the PIR and then checks for a change in heat. If the PIR detects a significant change, according to a threshold you’ll set, the program indicates that it has <em>seen you</em>. Open your Python editor and enter the code in <a href="ch11.xhtml#ch11ex01">Listing 11-1</a>. Save it as <em>PIR_test.py</em>.</p>&#13;
<pre><span class="ent">❶</span> <span class="codeorg">import</span> time&#13;
   <span class="codeorg">import</span> RPi.GPIO <span class="codeorg">as</span> GPIO&#13;
   GPIO.setmode(GPIO.BCM)&#13;
 &#13;
<span class="ent">❷</span> PIR = 4&#13;
   GPIO.setup(PIR, GPIO.IN)&#13;
  &#13;
   <span class="codepurple">print</span> (<span class="codegreen1">"Ready to find you"</span>)&#13;
   time.sleep(2)&#13;
 &#13;
<span class="ent">❸</span> <span class="codeorg">def</span> <span class="codeblue1">Motion_Sensing</span>(PIR):&#13;
       <span class="codepurple">print</span> (<span class="codegreen1">"We see you"</span>)&#13;
&#13;
<span class="ent">❹</span> <span class="codeorg">try</span>:&#13;
   <span class="ent">❺</span> GPIO.add_event_detect(PIR, GPIO.RISING, callback=Motion_Sensing)&#13;
   <span class="ent">❻</span> <span class="codeorg">while</span> 1:&#13;
          time.sleep(1)&#13;
<span class="ent">❼</span> <span class="codeorg">except</span> <span class="codepurple">KeyboardInterrupt</span>:&#13;
       <span class="codepurple">print</span> (<span class="codegreen1">"Quit"</span>)&#13;
       GPIO.cleanup()</pre>&#13;
<p class="caption"><span epub:type="pagebreak" id="page_188"/><a id="ch11ex01"/><strong>LISTING 11-1</strong> Detecting movement with the PIR</p>&#13;
<p class="indent">Import the <span class="literal">time</span> module and the <span class="literal">RPi.GPIO</span> module to control and code the GPIO pins <span class="ent">❶</span>. Because there are two GPIO pin numbering systems, define which one you’re using by setting the mode to <span class="literal">BCM</span>.</p>&#13;
<p class="indent">Next, declare a variable to define the GPIO pin number you’re using to check for a response. This is the GPIO 4 pin that you connected to the PIR <span class="ent">❷</span>. Tell the program to check for input on GPIO pin 4 by using <span class="literal">GPIO.IN</span>.</p>&#13;
<p class="indent">Because this is a test program, print a line indicating that the sensor is ready to find you and then provide a short time delay before retrieving the data from the PIR. This gives you a moment to prepare before you move about or wave your hands, triggering the sensor.</p>&#13;
<p class="indent">Then define a function that responds to any sensed movement or motion <span class="ent">❸</span>. In this test program, the response is a simple statement indicating that you’ve been seen.</p>&#13;
<p class="indent">Next, the program tries to detect motion <span class="ent">❹</span>. You use the <span class="literal">try</span> and <span class="literal">except</span> method to avoid causing an error if the PIR doesn’t work correctly or takes an odd data reading. This ensures that the program will continue to run if the PIR malfunctions.</p>&#13;
<p class="indent">Then you take the reading from the PIR <span class="ent">❺</span>. This code checks GPIO pin 4 to see whether the voltage is rising. If it is, something has triggered the PIR. So you use the <span class="literal">callback</span> method to run the function that responds to any sensed movement or motion <span class="ent">❸</span> and print <span class="literal">We see you</span>.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_189"/>To keep the PIR from reading the same input multiple times, you add a 1-second delay <span class="ent">❻</span>. This allows enough time for the PIR to reset before it checks for a change in temperature again. Remember that you’re looking for motion, not presence; therefore, the camera doesn’t have to be constantly active.</p>&#13;
<p class="indent">Finally, you need a way to stop the program. You add the <span class="literal">except</span> response, which checks whether any key on the keyboard has been pressed <span class="ent">❼</span>. If it detects a keypress, it prints <span class="literal">Quit</span>, resets the GPIO pins, and stops the program.</p>&#13;
<p class="indent">Save the program and press <strong>F5</strong> to run it. Alternate between moving and staying still to make sure the PIR detects you. If you want, you can turn this into a game. Can you stand so still that you don’t trigger the PIR? Can you walk into a room without having the PIR spot you?</p>&#13;
<h3 class="h3" id="ch11lev1sec3">SETTING UP THE PI CAMERA</h3>&#13;
<p class="noindent">With a working PIR that can detect motion, you can set up the Pi Camera to capture images of whatever triggers the sensor.</p>&#13;
<h4 class="h4" id="ch11lev2sec3">Attaching the Pi Camera</h4>&#13;
<p class="noindent">If you completed the Pi Camera projects in <a href="ch04.xhtml#ch04">Chapter 4</a>, you might already have the hardware set up. Use the ribbon cable to connect the camera to the Pi, as shown in <a href="ch11.xhtml#ch11fig04">Figure 11-4</a>, and remember to ensure that the Pi Camera is enabled in the Configuration tool. This requires you to restart the Raspberry Pi. If you get stuck or need more detailed instructions, refer to “Interfaces” on <a href="ch01.xhtml#page_16">page 16</a>.</p>&#13;
<div class="image"><img alt="Image" src="../images/11fig04.jpg"/></div>&#13;
<p class="figcap" id="ch11fig04"><strong>FIGURE 11-4</strong> Setting up the Pi Camera</p>&#13;
<h4 class="h4" id="ch11lev2sec4"><span epub:type="pagebreak" id="page_190"/>Creating a New Folder to Store the Images</h4>&#13;
<p class="noindent">To keep the nature box project organized, you’ll want to store the images and program files in one place. Create a new folder named <em>Nature_Box</em> by opening the terminal and entering the following command:</p>&#13;
<pre><span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span> <span class="codestrong1">mkdir Nature_Box</span></pre>&#13;
<p class="indent">Making a project folder will prevent your home folder from becoming cluttered with hundreds of images.</p>&#13;
<h3 class="h3" id="ch11lev1sec4">WRITING THE TEST CODE</h3>&#13;
<p class="noindent">With the Pi Camera attached, you can now start a new Python file or adapt the code in <a href="ch11.xhtml#ch11ex01">Listing 11-1</a> to make the camera take a picture each time the PIR senses movement. You can photograph birds, cats, or other native wildlife—maybe even a fox—as they move past your nature box setup. Enter the code in <a href="ch11.xhtml#ch11ex02">Listing 11-2</a> and save it as <em>Cam_PIR.py</em>.</p>&#13;
<pre><span class="ent">❶</span> <span class="codeorg">from</span> time <span class="codeorg">import</span> sleep&#13;
   <span class="codeorg">from</span> picamera <span class="codeorg">import</span> PiCamera&#13;
   <span class="codeorg">import</span> RPi.GPIO <span class="codeorg">as</span> GPIO&#13;
   GPIO.setmode(GPIO.BCM)&#13;
  &#13;
   PIR = 4&#13;
   GPIO.setup(PIR, GPIO.IN)&#13;
 &#13;
<span class="ent">❷</span> <span class="codeorg">global</span> Image_Number&#13;
   Image_Number = 0&#13;
   camera = PiCamera()&#13;
  &#13;
   <span class="codepurple">print</span> (<span class="codegreen1">"Ready to find you"</span>)&#13;
<span class="ent">❸</span> sleep(2)&#13;
  &#13;
   <span class="codeorg">def</span> <span class="codeblue1">Motion_Sensing</span>(PIR):&#13;
    <span class="ent">❹</span> <span class="codeorg">global</span> Image_Number&#13;
&#13;
    <span class="ent">❺</span> camera.resolution = (1024, 768)&#13;
&#13;
    <span class="ent">❻</span> camera.capture(<span class="codegreen1">"Nature"</span> + <span class="codepurple">str</span>(Image_Number) + <span class="codegreen1">".jpg"</span><span class="codestrong1">)</span>&#13;
    <span class="ent">❼</span> Image_Number = Image_Number + 1&#13;
  &#13;
   <span class="codeorg">try</span>:&#13;
      GPIO.add_event_detect(PIR, GPIO.RISING, callback=Motion_Sensing)&#13;
      <span class="codeorg">while</span> 1:&#13;
       <span class="ent">❽</span> sleep(1)&#13;
   <span class="codeorg">except</span> <span class="codepurple">KeyboardInterrupt</span>:&#13;
       <span class="codepurple">print</span> (<span class="codegreen1">"Quit"</span>)&#13;
       GPIO.cleanup()</pre>&#13;
<p class="caption"><a id="ch11ex02"/><strong>LISTING 11-2</strong> Taking a picture whenever the PIR detects motion</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_191"/>Edit the program code by importing the <span class="literal">sleep()</span> function from the <span class="literal">time</span> module and import the <span class="literal">picamera</span> class too <span class="ent">❶</span>.</p>&#13;
<p class="indent">Then, to stop each new image from overwriting the previous one, create a variable to hold the current <span class="literal">Image_Number</span> <span class="ent">❷</span>. Make this a global variable so you can use this data later in the main program function to save each file with a different name. Set the <span class="literal">Image_Number</span> variable to <span class="literal">0</span>, which means the first image taken will be named <em>Nature0.jpg</em>.</p>&#13;
<p class="indent">Then add the <span class="literal">PiCamera()</span> function to the <span class="literal">camera</span> variable. Replace <span class="literal">time.sleep(2)</span> with the simpler code <span class="literal">sleep(2)</span> <span class="ent">❸</span>. This is a better way of writing the code, as you have less text to type and therefore reduce the chance of an error. You can use this simpler code in your other programs and projects. It serves the same purpose: it pauses the program for 2 seconds, creating a small delay before the next line of code runs.</p>&#13;
<p class="indent">Next, within the <span class="literal">Motion_Sensing(PIR)</span> function, add the code to trigger the Pi Camera and take a picture. At <span class="ent">❹</span>, you add the global variable you created at <span class="ent">❷</span>. Then you set the camera resolution <span class="ent">❺</span> and add the code to capture the image <span class="ent">❻</span>.</p>&#13;
<p class="indent">Note that the code that captures the image <span class="ent">❻</span> combines the string <span class="literal">"Nature"</span> and the <span class="literal">Image_Number</span> value <span class="ent">❷</span>, which is currently set to <span class="literal">0</span>. This creates a file named <em>Nature0</em>, to which you add the <em>.jpg</em> file extension to save the image as <em>Nature0.jpg</em>.</p>&#13;
<p class="indent">Then add a value of <span class="literal">1</span> to the current image value <span class="ent">❼</span>, so the program will save the next file as <em>Nature1.jpg</em>, the following as <em>Nature2.jpg</em>, and so on until the program stops. You also change the final line from <span class="literal">time.sleep(1)</span> to <span class="literal">sleep(1)</span> <span class="ent">❽</span>.</p>&#13;
<p class="indent">Save the program in the <em>Nature_Box</em> folder so all the images will be stored there, making it easy to access them later. Press <strong>F5</strong> to run the program. Each time something triggers the PIR, the Pi Camera will take a picture and save it in the folder. You could set up your nature box near your most prized possessions or chocolate stash. If anyone steals from you, you’ll have photographic evidence of the culprit.</p>&#13;
<p class="indent">If the PIR triggers too easily, you can adjust its sensitivity. On warm days, tree branches can move infrared radiation around, which the PIR can pick up. If the box is near a road, cars driving past might alter the surrounding air.</p>&#13;
<p class="indent">To avoid triggering the camera in those cases, locate the two small dials (<a href="ch11.xhtml#ch11fig05">Figure 11-5</a>) on the back of the PIR (they’re usually orange). One is the <em>Delay Time Adjust</em> dial, which changes how <span epub:type="pagebreak" id="page_192"/>long it takes to reset the PIR each time it’s triggered. The other is the <em>Distance Adjust</em> dial, which increases or decreases the sensitivity; basically, it determines how much of a change in heat is required to trigger the PIR. Experiment with adjusting these dials to find the perfect settings for your nature box and your local environment.</p>&#13;
<div class="image"><img alt="Image" src="../images/11fig05.jpg"/></div>&#13;
<p class="figcap" id="ch11fig05"><strong>FIGURE 11-5</strong> Adjusting the PIR sensitivity on the back of the PIR</p>&#13;
<h3 class="h3" id="ch11lev1sec5">RETRIEVING THE IMAGES FROM THE RASPBERRY PI</h3>&#13;
<p class="noindent">Now you need to figure out how to retrieve your images. If you leave your hardware in the wild, you won’t be able to access the images until you collect your nature box. Depending on your setup or the type of wildlife you’re trying to monitor, you might want to leave it out for a few days. But waiting that long to view images isn’t ideal. The solution is to connect your nature box to the internet so that you can use the file-sharing website Dropbox and a simple Python program to upload each image in real time. You’ll be able to access the photos remotely by using a tablet, a laptop, or a mobile phone.</p>&#13;
<h4 class="h4" id="ch11lev2sec5">Setting Up a Dropbox Account</h4>&#13;
<p class="noindent">If you already have a Dropbox account, you can skip this step. If not, head over to the Dropbox website at <a href="https://www.dropbox.com/"><em>https://www.dropbox.com/</em></a> and register for a new account. Click <strong>Create an account</strong> and fill in the <span epub:type="pagebreak" id="page_193"/>sign-up form (<a href="ch11.xhtml#ch11fig06">Figure 11-6</a>). Alternatively, you can use your Google account details to sign up.</p>&#13;
&#13;
<div class="image"><img alt="Image" src="../images/11fig06.jpg"/></div>&#13;
<p class="figcap" id="ch11fig06"><strong>FIGURE 11-6</strong> Signing up or logging in to Dropbox</p>&#13;
<p class="indent">Once you’ve logged in, navigate to the Dropbox Developers page (<a href="ch11.xhtml#ch11fig07">Figure 11-7</a>) at <a href="https://www.dropbox.com/developers/"><em>https://www.dropbox.com/developers/</em></a> to create an app.</p>&#13;
<div class="image"><img alt="Image" src="../images/11fig07.jpg"/></div>&#13;
<p class="figcap" id="ch11fig07"><strong>FIGURE 11-7</strong> Going to the Dropbox Developers page</p>&#13;
<p class="indent">Click the <strong>Create your app</strong> option. Dropbox presents you with several options. When it prompts you to choose an API, select <strong>Dropbox API</strong>. Then select <strong>App folder</strong> as the access type. Name your app; I called mine <em>Nature Box</em>. Agree to the terms and conditions, and click the blue <strong>Confirm</strong> button to access the next page of configuration settings (<a href="ch11.xhtml#ch11fig08">Figure 11-8</a>).</p>&#13;
<div class="image"><img alt="Image" src="../images/11fig08.jpg"/></div>&#13;
<p class="figcap" id="ch11fig08"><strong>FIGURE 11-8</strong> Configuring your app’s settings</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_194"/>Keep the Status row set to <strong>Development</strong>, and the Development users row set to <strong>Only you</strong>. This means only you will have permission to edit the app. You can also edit the app folder name.</p>&#13;
<p class="indent">Ignore the App key and App secret rows; you don’t need these for this project.</p>&#13;
<p class="indent">Select the <strong>Generated access token</strong> box to create a code that will enable your Raspberry Pi to send image files to the Dropbox app. You’ll need to use this token in your Python program later. Remember that this token keeps your account secure, so don’t share it with others.</p>&#13;
<p class="indent">With your Dropbox app set up, you can now use it to upload the nature box images.</p>&#13;
<h4 class="h4" id="ch11lev2sec6">Installing Dropbox for Python</h4>&#13;
<p class="noindent">You need to install a Python Dropbox library so you can access your Dropbox app and folder from the Python program code. To install the required software, open the terminal and enter the following command:</p>&#13;
<pre><span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span>  <span class="codestrong1">sudo pip3 install dropbox</span></pre>&#13;
<p class="indent">Then, to make sure you’re using the newest updates, enter this command:</p>&#13;
<pre><span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span>  <span class="codestrong1">sudo pip3 install dropbox --upgrade</span></pre>&#13;
<h5 class="h5">Creating a Test Program</h5>&#13;
<p class="noindent">Before you connect the PIR and Pi Camera to Dropbox, you need to create a simple program to test whether the Dropbox app and token are functioning correctly. But first, save a JPEG image in the <em>Nature_Box</em> folder to test with. In the program in <a href="ch11.xhtml#ch11ex03">Listing 11-3</a>, I’ve used an image of a cute squirrel (<a href="ch11.xhtml#ch11fig09">Figure 11-9</a>) and named the file <em>squirrel.jpg</em>.</p>&#13;
<div class="image"><img alt="Image" src="../images/11fig09.jpg"/></div>&#13;
<p class="figcap" id="ch11fig09"><strong>FIGURE 11-9</strong> Saving an image in the <em>Nature_Box</em> folder</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_195"/>Open your Python editor, create a new file, and add the following code. Save it as <em>DB_uploader.py</em>.</p>&#13;
<pre><span class="ent">❶</span> <span class="codeorg">import</span> dropbox&#13;
 &#13;
<span class="ent">❷</span> token = <span class="codegreen1">"</span><span class="codegreen2">xxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class="codegreen1">"</span>&#13;
&#13;
<span class="ent">❸</span> dbx = dropbox.Dropbox(token)&#13;
&#13;
<span class="ent">❹</span> <span class="codeorg">with</span> <span class="codepurple">open</span>(<span class="codegreen1">"/home/pi/Nature_Box/squirrel.jpg"</span>, <span class="codegreen1">"rb"</span>) <span class="codeorg">as</span> file:&#13;
    <span class="ent">❺</span> dbx.files_upload(file.read(), <span class="codegreen1">'/squirrel.jpg'</span>, mute = <span class="codeorg">True</span>)&#13;
&#13;
<span class="ent">❻</span> <span class="codepurple">print</span> (<span class="codegreen1">"uploaded"</span>)</pre>&#13;
<p class="caption"><a id="ch11ex03"/><strong>LISTING 11-3</strong> Testing your Dropbox app and token</p>&#13;
<p class="indent">Import the <span class="literal">dropbox</span> module <span class="ent">❶</span>. Create a variable named <span class="literal">token</span>, and enter the app token you acquired earlier within quotation marks <span class="ent">❷</span>. Next, create another variable named <span class="literal">dbx</span> to hold the <span class="literal">Dropbox</span> class <span class="ent">❸</span>, which enables your Python program code to communicate with your Dropbox account.</p>&#13;
<p class="indent">Now you’re ready to locate and open the image file you want to upload <span class="ent">❹</span>. Open the folder where the image is stored by using <span class="literal">with open</span>. Next, read from the file and use the Dropbox API to upload the image to your account <span class="ent">❺</span>. Then print a short confirmation message <span class="ent">❻</span> so you know the file upload is complete.</p>&#13;
<h5 class="h5">Running the Program</h5>&#13;
<p class="noindent">Go to the Dropbox website, log in, and navigate to your app folder. Then return to your Raspberry Pi and run the test program. The test will attempt to upload your image file (in this example, the image of the squirrel), so check your Dropbox folder for the upload (<a href="ch11.xhtml#ch11fig10">Figure 11-10</a>).</p>&#13;
<div class="image"><img alt="Image" src="../images/11fig10.jpg"/></div>&#13;
<p class="figcap" id="ch11fig10"><strong>FIGURE 11-10</strong> The uploaded image in the <em>Nature_Box</em> folder</p>&#13;
<h3 class="h3" id="ch11lev1sec6">CODING THE FINAL NATURE BOX</h3>&#13;
<p class="noindent">So far, you’ve created three separate programs: a first to test that the PIR is working correctly, a second to trigger the Pi Camera whenever the PIR senses motion, and a third to allow the Raspberry Pi to upload the images to your linked Dropbox folder. Now let’s combine <span epub:type="pagebreak" id="page_196"/>everything you’ve learned so far in this chapter to make the final nature box program.</p>&#13;
<h4 class="h4" id="ch11lev2sec7">Setting Up the Final Program</h4>&#13;
<p class="noindent">Save and rename your previous <em>DB_uploader.py</em> file or start a new Python file and save it as <em>NatureBox.py</em>. Then enter the code in <a href="ch11.xhtml#ch11ex04">Listing 11-4</a>.</p>&#13;
<pre><span class="ent">❶</span> <span class="codeorg">import</span> dropbox&#13;
   <span class="codeorg">from</span> time <span class="codeorg">import</span> sleep&#13;
   <span class="codeorg">from</span> picamera <span class="codeorg">import</span> PiCamera&#13;
   <span class="codeorg">import</span> RPi.GPIO <span class="codeorg">as</span> GPIO&#13;
   GPIO.setmode(GPIO.BCM)</pre>&#13;
<p class="caption"><a id="ch11ex04"/><strong>LISTING 11-4</strong> Beginning the final nature box program</p>&#13;
<p class="indent">Import the <span class="literal">dropbox</span> module <span class="ent">❶</span>, which lets you interact with Dropbox via the Python code. Also import the usual <span class="literal">sleep()</span> function to add small delays, then the <span class="literal">picamera</span> library, and finally the <span class="literal">Rpi.GPIO</span> module to control the PIR. Then you set the GPIO numbering system to <span class="literal">BCM</span>.</p>&#13;
<h4 class="h4" id="ch11lev2sec8">Combining the Camera and Sensor</h4>&#13;
<p class="noindent">The next section of the code, shown in <a href="ch11.xhtml#ch11ex05">Listing 11-5</a>, combines the PIR code and the camera code, so when movement is sensed, the Pi Camera is triggered. It takes a picture and then creates and saves the image file. The first lines should be familiar to you because they’re from the <em>Cam_PIR.py</em> test program you created.</p>&#13;
<pre>PIR = 4&#13;
&#13;
GPIO.setup(PIR, GPIO.IN)&#13;
&#13;
<span class="codeorg">global</span> Image_Number&#13;
Image_Number = 0&#13;
camera = PiCamera()&#13;
&#13;
<span class="codepurple">print</span> (<span class="codegreen1">"Ready to find you"</span>)&#13;
sleep(2)&#13;
&#13;
<span class="codeorg">def</span> <span class="codeblue1">Motion_Sensing</span>(PIR):&#13;
    <span class="codeorg">global</span> Image_Number&#13;
    <span class="codepurple">print</span> (<span class="codegreen1">"We see you"</span>)&#13;
    camera.resolution = (1024, 768)&#13;
 <span class="ent">❶</span> Image_Number = Image_Number + 1&#13;
    camera.capture(<span class="codegreen1">"Nature"</span> + <span class="codepurple">str</span>(Image_Number) + <span class="codegreen1">".jpg"</span>)&#13;
  &#13;
 <span class="ent">❷</span> pic = (<span class="codegreen1">"Nature"</span> + <span class="codepurple">str</span>(Image_Number) + <span class="codegreen1">".jpg"</span>)</pre>&#13;
<p class="caption"><a id="ch11ex05"/><strong>LISTING 11-5</strong> Capturing and saving an image</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_197"/>Add a value of 1 to the image file variable <span class="ent">❶</span> (which you set to 0 earlier), so the first image saved is named <em>Nature1.jpg</em>.</p>&#13;
<p class="indent">After the Pi Camera captures an image, it saves the image file, but not the filename. To save the filename as well, create a new variable named <span class="literal">pic</span> <span class="ent">❷</span> to hold the image’s filename as a string. This means the program can access it later when it’s selecting and uploading the image file to Dropbox.</p>&#13;
<h4 class="h4" id="ch11lev2sec9">Creating the try and except</h4>&#13;
<p class="noindent">Next, in <a href="ch11.xhtml#ch11ex06">Listing 11-6</a>, you use the <span class="literal">try</span> and <span class="literal">except</span> method. The <span class="literal">try</span> part attempts to run the section of code responsible for uploading the image files to Dropbox. If for some reason the nature box is unable to access Dropbox—say, because the site is unavailable or because the nature box is no longer online—the program will bypass this section by using the <span class="literal">except</span> part and continue to run without halting or causing an error.</p>&#13;
<pre>   <span class="codeorg">try</span>:&#13;
     <span class="ent">❶</span> token = <span class="codegreen1">"</span><span class="codegreen2">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class="codegreen1">"</span>&#13;
     <span class="ent">❷</span> dbx = dropbox.Dropbox(token)&#13;
        <span class="codepurple">print</span> (<span class="codegreen1">"ready"</span>)&#13;
     <span class="ent">❸</span> <span class="codeorg">with</span> <span class="codepurple">open</span>(<span class="codegreen1">"/home/pi/Nature_Box/"</span> + pic, <span class="codegreen1">"rb"</span>) <span class="codeorg">as</span> file:&#13;
         <span class="ent">❹</span> dbx.files_upload(file.read(), <span class="codegreen1">'/Nature%s.jpg'</span> &#13;
            %(Image_Number), mute = <span class="codeorg">True</span>)&#13;
            <span class="codepurple">print</span> (<span class="codegreen1">"uploaded"</span>)&#13;
            file.close()&#13;
 <span class="ent">❺</span> <span class="codeorg">except</span>:&#13;
        <span class="codeorg">pass</span>&#13;
        <span class="codepurple">print</span>(<span class="codegreen1">"failed"</span>)</pre>&#13;
<p class="caption"><a id="ch11ex06"/><strong>LISTING 11-6</strong> Saving the image filename</p>&#13;
<p class="indent">Add your Dropbox token <span class="ent">❶</span> and assign it to a variable named <span class="literal">dbx</span> <span class="ent">❷</span>, which you use to authenticate your account credentials and enable interaction with Dropbox. At <span class="ent">❸</span>, open the image file that the camera just took by combining the folder location of the image and the <span class="literal">pic</span> variable, which holds the filename of the most recent image. The code <span class="literal">rb</span> opens the image as a binary file and reads the contents as bytes rather than strings. This is important because the file contains an image, not text. Then assign this data to a variable named <span class="literal">file</span>, as in the physical data that makes up the image in the file stored on your Raspberry Pi.</p>&#13;
<p class="indent">The program reads the bytes from <span class="literal">file</span> and tries to upload the data <span class="ent">❹</span>. The code <span class="literal">'/Nature%s.jpg' %(Image_Number)</span> adds the filename to Dropbox, because the binary data you uploaded doesn’t <span epub:type="pagebreak" id="page_198"/>contain a filename otherwise. The code <span class="literal">mute = True</span> prevents the user from being notified of the upload. You can imagine how distracting receiving hundreds of notifications about uploaded files would be.</p>&#13;
<p class="indent">After the upload, close the file: open files use processor resources and can slow your Raspberry Pi, especially if there are a lot of them. Finally, add the <span class="literal">except</span> section of the program’s <span class="literal">try</span> and <span class="literal">except</span> method <span class="ent">❺</span>. If the program can’t upload the image, it responds by passing and printing a notification before looping back, resetting the PIR, and waiting for the sensor to be triggered again. The image is still saved in the <em>Nature_Box</em> folder on the Pi but just won’t be uploaded.</p>&#13;
<h4 class="h4" id="ch11lev2sec10">Running the Motion Sensor</h4>&#13;
<p class="noindent">The final section of the program, shown in <a href="ch11.xhtml#ch11ex07">Listing 11-7</a>, is identical to the <em>PIR_test.py</em> program you created earlier. It tells the PIR to wait for an input and, upon receiving one, runs the <span class="literal">Motion_Sensing()</span> function.</p>&#13;
<pre><span class="codeorg">try</span>:&#13;
    GPIO.add_event_detect(PIR, GPIO.RISING, callback=Motion_Sensing)&#13;
    <span class="codeorg">while</span> 1:&#13;
        sleep(1)&#13;
<span class="codeorg">except</span> <span class="codepurple">KeyboardInterrupt</span>:&#13;
    <span class="codepurple">print</span> (<span class="codegreen1">"Quit"</span>)&#13;
    GPIO.cleanup()</pre>&#13;
<p class="caption"><a id="ch11ex07"/><strong>LISTING 11-7</strong> Ending the program</p>&#13;
<p class="indent">Once you’ve copied the complete program, save and run it. Test that it’s working by moving around to trigger the PIR. Open your internet browser and navigate to your Dropbox folder to check out the uploaded images (<a href="ch11.xhtml#ch11fig11">Figure 11-11</a>). Before you deploy your nature box into the wild, you can test your program in fun ways: compete with your friends to see who can walk into a room without triggering the sensor, or position your nature box at the front door and check to see who is knocking. Look for the evidence in the Dropbox folder before you decide to open the door!</p>&#13;
<div class="image"><img alt="Image" src="../images/11fig11.jpg"/></div>&#13;
<p class="figcap" id="ch11fig11"><strong>FIGURE 11-11</strong> Your photos should appear the Dropbox folder when you run the program.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_199"/>If the nature box doesn’t function correctly, consider the following common errors:</p>&#13;
<ul>&#13;
<li class="noindent">Is the Dropbox token used in your program correct?</li>&#13;
<li class="noindent">Is the Raspberry Pi connected to the internet? Otherwise, all image files will remain stored in the <em>Nature_Box</em> folder.</li>&#13;
<li class="noindent">Do the folder names in the code match the actual folder names?</li>&#13;
<li class="noindent">Do the filenames in the code match the actual filenames?</li>&#13;
<li class="noindent">Is the PIR’s sensitivity adjusted so the proper amount of motion triggers it?</li>&#13;
</ul>&#13;
<p class="indent">When uploading to Dropbox, you can’t overwrite the same file. Therefore, whenever you run the program again after the first time, make sure you’ve either moved the first batch of image files to a different folder or deleted them.</p>&#13;
<h3 class="h3" id="ch11lev1sec7">STARTING THE PROGRAM AUTOMATICALLY</h3>&#13;
<p class="noindent">Because you’ll set up the nature box outside, you won’t have a monitor attached to it. The program will need to execute whenever you plug power into the Raspberry Pi. Recall that I covered how to start programs automatically in <a href="ch07.xhtml#ch07">Chapters 7</a>, <a href="ch09.xhtml#ch09">9</a>, and <a href="ch10.xhtml#ch10">10</a>. Now you’ll do it again for the nature box program.</p>&#13;
<p class="indent">You’ll use cron to run the program automatically by creating instructions in the crontab file specifying what event you want to run and when you want to run it. Refer to <a href="ch09.xhtml#ch09">Chapter 9</a> if you need a refresher on using cron.</p>&#13;
<p class="indent">Open the terminal and enter the following command to open the cron console:</p>&#13;
<pre><span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span> <span class="codestrong1">sudo crontab –e</span></pre>&#13;
<p class="indent">The cron console presents you with three methods of editing the crontab file. Select option 2 and press <span class="small">ENTER</span> to open the crontab file with the nano text editor.</p>&#13;
<p class="indent">Scroll to the bottom of the text in the crontab file and locate the blank space. Then add the following code line to run the program automatically:</p>&#13;
<pre><span class="codestrong1">@reboot sudo python3 /home/pi/Nature_Box/NatureBox.py &amp;</span></pre>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_200"/>The command states that every time the Raspberry Pi reboots, it should run Python in super user mode, open the <em>/home/pi/Nature_Box</em> folder, and execute your <em>NatureBox.py</em> program.</p>&#13;
<p class="indent">If you named your code file something else, replace <em>NatureBox.py</em> with your filename. Also, check that the folder path is correct by opening the folder where your <em>NatureBox.py</em> program is stored and noting the file path.</p>&#13;
<p class="indent">The <span class="literal">&amp;</span> at the end of the code line tells your program to run in the background, so you can do other tasks with your Raspberry Pi at the same time.</p>&#13;
<p class="indent">Once you have checked the command details and are confident they’re correct, press <span class="small">CTRL</span>-X to save and exit the crontab file. Now, each time you turn on or reboot your Raspberry Pi, the crontab file will run, starting up the nature box.</p>&#13;
<p class="indent">If you want to stop the program from automatically running, reopen the crontab file from the terminal and delete the line of code you added, like this:</p>&#13;
<pre><span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span> <span class="codestrong1">crontab –e</span></pre>&#13;
<p class="indent">Then save the file and reboot.</p>&#13;
<p class="indent">The nature box is designed to run without a monitor, so you don’t need the Raspberry Pi to boot to the desktop interface and display the background wallpaper and icons. Because you won’t see the desktop, you don’t need to load it. Instead, you can configure the Pi to boot to the command line. Open the terminal window and enter this command:</p>&#13;
<pre><span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span> <span class="codestrong1">sudo raspi-config</span></pre>&#13;
<p class="indent">Select the third option, <strong>Boot Options</strong>, and press <span class="small">ENTER</span>. Then select the <strong>B1 Desktop / CLI</strong> option, followed by the <strong>B1 Console</strong> option. Click the <strong>Save</strong> option and then reboot your Raspberry Pi.</p>&#13;
<p class="indent">Once this is set, select the <strong>&lt;Finish&gt;</strong> option and press <span class="small">ENTER</span>: you’ll be prompted to save the config file and reboot. Press <strong>Yes</strong> to restart your Pi. As your Raspberry Pi boots up, the nature box will load. Before you place the box in the wild, run a quick test and check that it’s working and uploading images to your Dropbox account.</p>&#13;
<h3 class="h3" id="ch11lev1sec8"><span epub:type="pagebreak" id="page_201"/>PUTTING IT ALL TOGETHER</h3>&#13;
<p class="noindent">Now that you have a working program, you can set up your box and then leave it in your garden, at a local park, or elsewhere. Using a plastic case for the box is ideal (<a href="ch11.xhtml#ch11fig12">Figure 11-12</a>) because you can seal it with tape, and it will remain fairly watertight—although I don’t recommend that you lower the nature box into a pond or leave it out during a thunderstorm.</p>&#13;
<p class="indent">Preparing your nature box is fairly easy:</p>&#13;
<ol>&#13;
<li class="noindent">Use a drill to create a small hole for the camera lens to poke through.</li>&#13;
<li class="noindent">Use a drill to create a larger hole so that the PIR can poke through. It’s best to drill a small hole to start with and then increase the size of the drill bit so that you don’t split the plastic. If you’re using a wooden box, this shouldn’t be an issue. The hole needs to be just big enough for the PIR to poke through.&#13;
<div class="image"><img alt="Image" src="../images/11fig12.jpg"/></div>&#13;
<p class="figcap" id="ch11fig12"><strong>FIGURE 11-12</strong> An example of the finished nature box</p></li>&#13;
<li class="noindent">Use mounting putty or double-sided tape to secure the Pi Camera and PIR <em>inside</em> your box. Alternatively, the Pi Camera and some PIRs have small screw holes that you could use to mount them.&#13;
<p class="noindentt">Happy nature hunting!</p></li>&#13;
</ol>&#13;
<h3 class="h3" id="ch11lev1sec9"><span epub:type="pagebreak" id="page_202"/>WRAPPING UP</h3>&#13;
<p class="noindent">Well done, excellent work–you now have a nature box that can sense movement, triggering the Pi Camera to take a picture. This image is then uploaded to your Dropbox account for you to view and share. Now try the following:</p>&#13;
<ul>&#13;
<li class="noindent">Use your setup in your bedroom to see who goes in and hopefully out.</li>&#13;
<li class="noindent">Place it near the cookie jar or your stash of chocolate to gather photographic evidence of who keeps stealing from you.</li>&#13;
<li class="noindent">Purchase the Pi NoIR Camera, which can be used to take photos at night, in the dark.</li>&#13;
</ul>&#13;
</body></html>