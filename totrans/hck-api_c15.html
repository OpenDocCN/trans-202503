<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en">
<head>
<title>Chapter 15: Data Breaches and Bug Bounties</title>
<link href="NSTemplate_v1.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:4817cf93-40a6-403c-8355-e951c69da606" name="Adept.expected.resource"/>
</head>
<body epub:type="bodymatter chapter">
<section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" id="Page_307" title="307"/>15</span><br/>
<span class="ChapterTitle">Data Breaches and Bug Bounties</span></h1>
</header>
<figure class="opener">
<img alt="" src="image_fi/book_art/chapterart.png"/>
</figure>
<p class="ChapterIntro">The real-world API breaches and bounties covered in this chapter should illustrate how actual hackers have exploited API vulnerabilities, how vulnerabilities can be combined, and the significance of the weaknesses you might discover.</p>
<p>Remember that an app’s security is only as strong as the weakest link. If you’re facing the best firewalled, multifactor-based, zero-trust app but the blue team hasn’t dedicated resources to securing their APIs, there is a security gap equivalent to the Death Star’s thermal exhaust port. Moreover, these insecure APIs and exhaust ports are often intentionally exposed to the outside universe, offering a clear pathway to compromise and destruction. Use common API weaknesses like the following to your advantage when hacking.</p>
<h2 id="h1-502444c15-0001"><span epub:type="pagebreak" id="Page_308" title="308"/>The Breaches</h2>
<p class="BodyFirst">After a data breach, leak, or exposure, people often point fingers and cast blame. I like to think of them instead as costly learning opportunities. To be clear, a <em>data breach</em> refers to a confirmed instance of a criminal exploiting a system to compromise the business or steal data. A <em>leak</em> or <em>exposure</em> is the discovery of a weakness that could have led to the compromise of sensitive information, but it isn’t clear whether an attacker actually did compromise the data.</p>
<p>When data breaches take place, attackers generally don’t disclose their findings, as the ones who brag online about the details of their conquests often end up arrested. The organizations that were breached also rarely disclose what happened, either because they are too embarrassed, they’re protecting themselves from additional legal recourse, or (in the worst case) they don’t know about it. For that reason, I will provide my own guess as to how these compromises took place.</p>
<h3 id="h2-502444c15-0001">Peloton</h3>
<ol class="none">
<li><b>Data quantity:</b> More than three million Peloton subscribers</li>
<li><b>Type of data:</b> User IDs, locations, ages, genders, weights, and workout information</li>
</ol>
<p class="BodyContinued">In early 2021, security researcher Jan Masters disclosed that unauthenticated API users could query the API and receive information for all other users. This data exposure is particularly interesting, as US president Joe Biden was an owner of a Peloton device at the time of the disclosure.</p>
<p>As a result of the API data exposure, attackers could use three different methods to obtain sensitive user data: sending a request to the <em>/stats/workouts/details</em> endpoint, sending requests to the <em>/api/user/search</em> feature, and making unauthenticated GraphQL requests.</p>
<h4 id="h3-502444c15-0001">The /stats/workouts/details Endpoint</h4>
<p class="BodyFirst">This endpoint is meant to provide a user’s workout details based on their ID. If a user wanted their data to be private, they could select an option that was supposed to conceal it. The privacy feature did not properly function, however, and the endpoint returned data to any consumer regardless of authorization.</p>
<p>By specifying user IDs in the POST request body, an attacker would receive a response that included the user’s age, gender, username, workout ID, and Peloton ID, as well as a value indicating whether their profile was private:</p>
<pre><code>POST /stats/workouts/details HTTP/1.1
Host: api.onepeloton.co.uk
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:84.0) Gecko/20100101 Firefox/84.0
Accept: application/json, text/plain, */*
<var>--snip--</var>
{"ids":["10001","10002","10003","10004","10005","10006",]}</code></pre>
<p><span epub:type="pagebreak" id="Page_309" title="309"/>The IDs used in the attack could be brute-forced or, better yet, gathered by using the web application, which would automatically populate user IDs.</p>
<h4 id="h3-502444c15-0002">User Search</h4>
<p class="BodyFirst">User search features can easily fall prey to business logic flaws. A GET request to the <em>/api/user/search/:&lt;username&gt;</em> endpoint revealed the URL that led to the user’s profile picture, location, ID, profile privacy status, and social information such as their number of followers. Anyone could use this data exposure feature.</p>
<h4 id="h3-502444c15-0003">GraphQL</h4>
<p class="BodyFirst">Several GraphQL endpoints allowed the attacker to send unauthenticated requests. A request like the following would provide a user’s ID, username, and location:</p>
<pre><code>POST /graphql HTTP/1.1
Host: gql-graphql-gateway.prod.k8s.onepeloton.com
<var>--snip--</var>
{"query":
"query SharedTags($currentUserID: ID!) (\n  User: user(id: "currentUserID") (\r\n__typename\n  id\r\n  location\r\n  )\r\n)". "variables": ( "currentUserID": "<b>REDACTED</b>")}</code></pre>
<p>By using the <code>REDACTED</code><b> </b>user ID as a payload position, an unauthenticated attacker could brute-force user IDs to obtain private user data.</p>
<p>The Peloton breach is a demonstration of how using APIs with an adversarial mindset can result in significant findings. It also goes to show that if an organization is not protecting one of its APIs, you should treat this as a rallying call to test its other APIs for weaknesses.</p>
<h3 id="h2-502444c15-0002">USPS Informed Visibility API</h3>
<ol class="none">
<li><b>Data quantity:</b> Approximately 60 million exposed USPS users</li>
<li><b>Type of data:</b> Email, username, real-time package updates, mailing address, phone number</li>
</ol>
<p class="BodyContinued">In November 2018, <em>KrebsOnSecurity</em> broke the story that the US Postal Service (USPS) website had exposed the data of 60 million users. A USPS program called Informed Visibility made an API available to authenticated users so that consumers could have near real-time data about all mail. The only problem was that any USPS authenticated user with access to the API could query it for any USPS account details. To make things worse, the API accepted wildcard queries. This means an attacker could easily request the user data for, say, every Gmail user by using a query like this one: <em>/api/v1/find?email=*@gmail.com</em>.</p>
<p>Besides the glaring security misconfigurations and business logic vulnerabilities, the USPS API was also vulnerable to an excessive data exposure issue. When the data for an address was requested, the API would respond <span epub:type="pagebreak" id="Page_310" title="310"/>with all records associated with that address. A hacker could have detected the vulnerability by searching for various physical addresses and paying attention to the results. For example, a request like the following could have displayed the records of all current and past occupants of the address:</p>
<pre><code>POST /api/v1/container/status
Token: UserA
<var>--snip--</var>

{
"street": "475 L' Enfant Plaza SW",
"city": Washington DC"
}</code></pre>
<p>An API with this sort of excessive data exposure might respond with something like this:</p>
<pre><code>{
       "street":"475 L' Enfant Plaza SW",
       "City":"Washington DC",
       "customer": [
              {
                     "name":"Rufus Shinra",
                     "username":"novp4me",
                     "email":"rufus@shinra.com",
                     "phone":"123-456-7890",
              },
              {
                     "name":"Professor Hojo",
                     "username":"sep-father",
                     "email":"prof@hojo.com",
                     "phone":"102-202-3034",
              }
              ]
}</code></pre>
<p>The USPS data exposure is a great example of why more organizations need API-focused security testing, whether that be through a bug bounty program or penetration testing. In fact, the Office of Inspector General of the Informed Visibility program had conducted vulnerability assessment a month prior to the release of the <em>KrebsOnSecurity</em> article. The assessors failed to mention anything about any APIs, and in the Office of Inspector General’s “Informed Visibility Vulnerability Assessment,” the testers determined that “overall, the IV web application encryption and authentication were secure” (<a class="LinkURL" href="https://www.uspsoig.gov/sites/default/files/document-library-files/2018/IT-AR-19-001.pdf">https://www.uspsoig.gov/sites/default/files/document-library-files/2018/IT-AR-19-001.pdf</a>). The public report also includes a description of the vulnerability-scanning tools used in order to test the web application that provided the USPS testers with false-negative results. This means that their tools assured them that nothing was wrong when in fact there were massive problems.</p>
<p>If any security testing had focused on the API, the testers would have discovered glaring business logic flaws and authentication weaknesses. The <span epub:type="pagebreak" id="Page_311" title="311"/>USPS data exposure shows how APIs have been overlooked as a credible attack vector and how badly they need to be tested with the right tools and techniques.</p>
<h3 id="h2-502444c15-0003">T-Mobile API Breach</h3>
<ol class="none">
<li><b>Data quantity:</b> More than two million T-Mobile customers</li>
<li><b>Type of data:</b> Name, phone number, email, date of birth, account number, billing ZIP code</li>
</ol>
<p class="BodyContinued">In August 2018, T-Mobile posted an advisory to its website stating that its cybersecurity team had “discovered and shut down an unauthorized access to certain information.” T-Mobile also alerted 2.3 million customers over text message that their data was exposed. By targeting one of T-Mobile’s APIs, the attacker was able to obtain customer names, phone numbers, emails, dates of birth, account numbers, and billing ZIP codes.</p>
<p>As is often the case, T-Mobile has not publicly shared the specific details of the breach, but we can go out on a limb and make a guess. One year earlier, a YouTube user discovered and disclosed an API vulnerability that may have been similar to the vulnerability that was exploited. In a video titled “T-Mobile Info Disclosure Exploit,” user “moim” demonstrated how to exploit the T-Mobile Web Services Gateway API. This earlier vulnerability allowed a consumer to access data by using a single authorization token and then adding any user’s phone number to the URL. The following is an example of the data returned from the request:</p>
<pre><code>implicitPermissions:
0:
user:
IAMEmail:
"rafae1530116@yahoo.com"
userid:
"U-eb71e893-9cf5-40db-a638-8d7f5a5d20f0"
lines:
0:
accountStatus: "A"
ban:
"958100286"
customerType: "GMP_NM_P"
givenName: "Rafael"
insi:
"310260755959157"
isLineGrantable: "true"
msison:
"19152538993"
permissionType: "inherited"
1:
accountStatus: "A"
ban:
"958100286"
customerType: "GMP_NM_P"
givenName: "Rafael"
<span epub:type="pagebreak" id="Page_312" title="312"/>imsi:
"310260755959157"
isLineGrantable: "false"
msisdn:
"19152538993"
permissionType: "linked"</code></pre>
<p>As you look at the endpoint, I hope some API vulnerabilities are already coming to mind. If you can search for your own information using the <code>msisdn</code><em> </em>parameter, can you use it to search for other phone numbers? Indeed, you can! This is a BOLA vulnerability. What’s worse, phone numbers are very predictable and often publicly available. In the exploit video, moim takes a random T-Mobile phone number from a dox attack on Pastebin and successfully obtains that customer’s information.</p>
<p>This attack is only a proof of concept, but it has room for improvement. If you find an issue like this during an API test, I recommend working with the provider to obtain additional test accounts with separate phone numbers to avoid exposing actual customer data during your testing. Exploit the findings and then describe the impact a real attack could have on the client’s environment, particularly if an attacker brute-forces phone numbers and breaches a significant amount of client data.</p>
<p>After all, if this API was the one responsible for the breach, the attacker could have easily brute-forced phone numbers to gather the 2.3 million that were leaked.</p>
<h2 id="h1-502444c15-0002">The Bounties</h2>
<p class="BodyFirst">Not only do bug bounty programs reward hackers for finding and reporting weaknesses that criminals would have otherwise compromised, but their write-ups are also an excellent source of API hacking lessons. If you pay attention to them, you might learn new techniques to use in your own testing. You can find write-ups on bug bounty platforms such as HackerOne and Bug Crowd or from independent sources like Pentester Land, ProgrammableWeb, and APIsecurity.io.</p>
<p>The reports I present here represent a small sample of the bounties out there. I selected these three examples to capture the diverse range of issues bounty hunters come across and the sorts of attacks they use. As you’ll see, in some instances these hackers dive deep into an API by combining exploit techniques, following numerous leads, and implementing novel web application attacks. You can learn a lot from bounty hunters.</p>
<h3 id="h2-502444c15-0004">The Price of Good API Keys</h3>
<ol class="none">
<li><b>Bug bounty hunter:</b> Ace Candelario</li>
<li><b>Bounty:</b> $2,000</li>
</ol>
<p class="BodyContinued">Candelario began his bug hunt by investigating a JavaScript source file on his target, searching it for terms such as <em>api</em>, <em>secret</em>, and <em>key</em> that might have <span epub:type="pagebreak" id="Page_313" title="313"/>indicated a leaked secret. Indeed, he discovered an API key being used for BambooHR human resources software. As you can see in the JavaScript, the key was base64 encoded:</p>
<pre><code>function loadBambooHRUsers() {
var uri = 'https://api.bamboohr.co.uk/api/gateway.php/example/v1/employees/directory');
return $http.get(uri, { headers: {'Authorization': 'Basic <b>VXNlcm5hbWU6UGFzc3dvcmQ=</b>'};
}</code></pre>
<p>Because the code snippet includes the HR software endpoint as well, any attacker who discovered this code could try to pass this API key off as their own parameter in an API request to the endpoint. Alternatively, they could decode the base64-encoded key. In this example, you could do the following to see the encoded credentials:</p>
<pre><code>hAPIhacker@Kali:~$ <b>echo 'VXNlcm5hbWU6UGFzc3dvcmQ=' | base64 -d</b>
<var>Username</var>:<var>Password</var></code></pre>
<p>At this point, you would likely already have a strong case for a vulnerability report. Still, you could go further. For example, you could attempt to use the credentials on the HR site to prove that you could access the target’s sensitive employee data. Candelario did so and used a screen capture of the employee data as his proof of concept.</p>
<p>Exposed API keys like this one are an example of a broken authentication vulnerability, and you’ll typically find them during API discovery. Bug bounty rewards for the discovery of these keys will depend on the severity of the attack in which they can be used.</p>
<p class="ListHead"><b>Lessons Learned</b></p>
<ul>
<li>Dedicate time to researching your target and discovering APIs.</li>
<li>Always keep an eye out for credentials, secrets, and keys; then test what you can do with your findings.</li>
</ul>
<h3 id="h2-502444c15-0005">Private API Authorization Issues</h3>
<ol class="none">
<li><b>Bug bounty hunter:</b> Omkar Bhagwat</li>
<li><b>Bounty:</b> $440</li>
</ol>
<p class="BodyContinued">By performing directory enumeration, Bhagwat discovered an API and its documentation located at <em>academy.target.com/api/docs</em>. As an unauthenticated user, Omkar was able to find the API endpoints related to user and admin management. Moreover, when he sent a GET request for the <em>/ping </em>endpoint, Bhagwat noticed that the API responded to him without using any authorization tokens (see <a href="#figure15-1" id="figureanchor15-1">Figure 15-1</a>). This piqued Bhagwat’s interest in the API. He decided to thoroughly test its capabilities.</p>
<span epub:type="pagebreak" id="Page_314" title="314"/><figure>
<img alt="Screenshot of API documentation for the /ping endpoint" class="keyline" src="image_fi/502444c15/F15001.png"/>
<figcaption><p><a id="figure15-1">Figure 15-1</a>: An example Omkar Bhagwat provided for his bug bounty write-up that demonstrates the API responding to his <em>/ping</em> request with a “pong” response</p></figcaption>
</figure>
<p>While testing other endpoints, Bhagwat eventually received an API response containing the error “authorization parameters are missing.” He searched the site and found that many requests used an authorization Bearer token, which was exposed.</p>
<p>By adding that Bearer token to a request header, Bhagwat was able to edit user accounts (see <a href="#figure15-2" id="figureanchor15-2">Figure 15-2</a>). He could then perform administrative functions, such as deleting, editing, and creating new accounts.</p>
<figure>
<img alt="Screenshot of a POST request in Burp Suite submitting a token, ID, and username to the api/user/edit endpoint" class="keyline" src="image_fi/502444c15/F15002.png"/>
<figcaption><p><a id="figure15-2">Figure 15-2</a>: Omkar’s successful API request to edit a user’s account password</p></figcaption>
</figure>
<p><span epub:type="pagebreak" id="Page_315" title="315"/>Several API vulnerabilities led to this exploitation. The API documentation disclosed sensitive information about how the API operated and how to manipulate user accounts. There is no business purpose to making this documentation available to the public; if it weren’t available, an attacker would have likely moved on to the next target without stopping to investigate.</p>
<p>By thoroughly investigating the target, Bhagwat was able to discover a broken authentication vulnerability in the form of an exposed authorization Bearer token. Using the Bearer token and documentation, he then found a BFLA.</p>
<p class="ListHead"><b>Lessons Learned</b></p>
<ul>
<li>Launch a thorough investigation of a web application when something piques your interest.</li>
<li>API documentation is a gold mine of information; use it to your advantage.</li>
<li>Combine your findings to discover new vulnerabilities.</li>
</ul>
<h3 id="h2-502444c15-0006">Starbucks: The Breach That Never Was</h3>
<ol class="none">
<li><b>Bug bounty hunter:</b> Sam Curry</li>
<li><b>Bounty:</b> $4,000</li>
</ol>
<p class="BodyContinued">Curry is a security researcher and bug hunter. While participating in Starbucks’ bug bounty program, he discovered and disclosed a vulnerability that prevented a breach of nearly 100 million personally identifiable information (PII) records belonging to Starbucks’ customers. According to the Net Diligence breach calculator, a PII data breach of this size could have cost Starbucks $100 million in regulatory fines, $225 million in crisis management costs, and $25 million in incident investigation costs. Even at a conservative estimate of $3.50 per record, a breach of that size could have resulted in a bill of around $350 million. Sam’s finding was epic, to say the least.</p>
<p>On his blog at <a class="LinkURL" href="https://samcurry.net">https://samcurry.net</a>, Curry provides a play-by-play of his approach to hacking the Starbucks API. The first thing that caught his interest was the fact that the Starbucks gift card purchase process included API requests containing sensitive information to the endpoint <em>/bff/proxy</em>:</p>
<pre><code>POST /bff/proxy/orchestra/get-user HTTP/1.1
HOST: app.starbucks.com

{
"data":
"user": {
"exId": "77EFFC83-7EE9-4ECA-9849-A6A23BF1830F",
"firstName": "Sam",
"lastName": "Curry",
"email": "samwcurry@gmail.com",
"partnerNumber": null,
"birthDay": null,
"birthMonth": null,
<span epub:type="pagebreak" id="Page_316" title="316"/>"loyaltyProgram": null
}
}</code></pre>
<p>As Curry explains on his blog, <em>bff</em> stands for “backend for frontend,” meaning the application passes the request to another host to provide the functionality. In other words, Starbucks was using a proxy to transfer data between the external API and an internal API endpoint.</p>
<p>Curry attempted to probe this <em>/bff/proxy/orchestra</em> endpoint but found it wouldn’t transfer user input back to the internal API. However, he discovered a<em> /bff/proxy/user:id</em> endpoint that did allow user input to make it beyond the proxy:</p>
<pre><code>GET /bff/proxy/stream/v1/users/me/streamItems/..\ HTTP/1.1
Host: app.starbucks.com

{
"errors": [
{
"message": "Not Found",
"errorCode": 404
}]}</code></pre>
<p>By using <code>..\</code> at the end of the path, Curry was attempting to traverse the current working directory and see what else he could access on the server. He continued to test for various directory traversal vulnerabilities until he sent the following:</p>
<pre><code>GET /bff/proxy/stream/v1/me/stramItems/web\..\.\..\.\..\.\..\.\..\..\..\.\..\</code></pre>
<p>This request resulted in a different error message:</p>
<pre><code>"message": "Bad Request",
"errorCode": 400</code></pre>
<p>This sudden change in an error request meant Curry was onto something. He used Burp Suite Intruder to brute-force various directories until he came across a Microsoft Graph instance using <em>/search/v1/accounts</em>. Curry queried the Graph API and captured a proof of concept that demonstrated he had access to an internal customer database containing IDs, usernames, full names, emails, cities, addresses, and phone numbers.</p>
<p>Because he knew the syntax of the Microsoft Graph API, Curry found that he could include the query parameter <code>$count=true</code> to get a count of the number of entries, which came up to 99,356,059, just shy of 100 million.</p>
<p>Curry found this vulnerability by paying close attention to the API’s responses and filtering results in Burp Suite, allowing him to find a unique status code of 400 among all the standard 404 errors. If the API provider hadn’t disclosed this information, the response would have blended in with all the other 404 errors, and an attacker would likely have moved on to another target.</p>
<p><span epub:type="pagebreak" id="Page_317" title="317"/>By combining the information disclosure and security misconfiguration, he was able to brute-force the internal directory structure and find the Microsoft Graph API. The additional BFLA vulnerability allowed Curry to use administrative functionality to perform user account queries.</p>
<p class="ListHead"><b>Lessons Learned</b></p>
<ul>
<li>Pay close attention to subtle differences between API responses. Use Burp Suite Comparer or carefully compare requests and responses to identify potential weaknesses in an API.</li>
<li>Investigate how the application or WAF handles fuzzing and directory traversal techniques.</li>
<li>Leverage evasive techniques to bypass security controls.</li>
</ul>
<h3 id="h2-502444c15-0007">An Instagram GraphQL BOLA</h3>
<ul>
<li><b>Bug bounty hunter:</b> Mayur Fartade</li>
<li><b>Bounty:</b> $30,000</li>
</ul>
<p class="BodyContinued">In 2021, Fartade discovered a severe BOLA vulnerability in Instagram that allowed him to send POST requests to the GraphQL API located at <em>/api/v1/ads/graphql/</em> to view the private posts, stories, and reels of other users.</p>
<p>The issue stemmed from a lack of authorization security controls for requests involving a user’s media ID. To discover the media ID, you could use brute force or capture the ID through other means, such as social engineering or XSS. For example, Fartade used a POST request like the following:</p>
<pre><code>POST /api/v1/ads/graphql HTTP/1.1
Host: i.instagram.com
Parameters:
doc_id=[REDACTED]&amp;query_params={"query_params":{"access_token":"","id":"<b>[</b><b>MEDIA_ID]</b>"}}</code></pre>
<p>By targeting the <code>MEDIA_ID</code> parameter and providing a null value for <code>access_token</code>, Fartade was able to view the details of other users’ private posts:</p>
<pre><code>"data":{
"instagram_post_by_igid":{
"id":
"creation_time":1618732307,
"has_product_tags":false,
"has_product_mentions":false,
"instagram_media_id":
006",
"instagram_media_owner_id":"!
"instagram_actor": {
"instagram_actor_id":"!
"id":"1
},
<span epub:type="pagebreak" id="Page_318" title="318"/>"inline_insights_node":{
"state": null,
"metrics":null,
"error":null
},
"display_url":"https:\/\/scontent.cdninstagram.com\/VV/t51.29350-15\/
"instagram_media_type":"IMAGE",
"image":{
"height":640,
"width":360
},
"comment_count":
"like_count":
"save_count":
"ad_media": null,
"organic_instagram_media_id":"
<var>--snip--</var>
]
}
}</code></pre>
<p>This BOLA allowed Fartade to make requests for information simply by specifying the media ID of a given Instagram post. Using this weakness, he was able to gain access to details such as likes, comments, and Facebook-linked pages of any user’s private or archived posts.</p>
<p class="ListHead"><b>Lessons Learned</b></p>
<ul>
<li>Make an effort to seek out GraphQL endpoints and apply the techniques covered in this book; the payout could be huge.</li>
<li>When at first your attacks don’t succeed, combine evasive techniques, such as by using null bytes with your attacks, and try again.</li>
<li>Experiment with tokens to bypass authorization requirements.</li>
</ul>
<h2 id="h1-502444c15-0003">Summary</h2>
<p class="BodyFirst">This chapter used API breaches and bug bounty reports to demonstrate how you might be able to exploit common API vulnerabilities in real-world environments. Studying the tactics of adversaries and bug bounty hunters will help you expand your own hacking repertoire to better help secure the internet. These stories also reveal how much low-hanging fruit is out there. By combining easy techniques, you can create an API hacking masterpiece.</p>
<p>Become familiar with the common API vulnerabilities, perform thorough analysis of endpoints, exploit the vulnerabilities you discover, report your findings, and bask in the glory of preventing the next great API data breach.</p>
</section>
</body>
</html>