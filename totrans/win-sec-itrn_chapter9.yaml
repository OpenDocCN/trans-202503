- en: <hgroup>
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_Futura_Std_Bold_Condensed_B_11">9</samp> <samp class="SANS_Dogma_OT_Bold_B_11">SECURITY
    AUDITING</samp>
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: </hgroup>
  prefs: []
  type: TYPE_NORMAL
- en: '![](../images/chapter.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Intertwined with the access check process is the auditing process. An administrator
    can configure the system’s auditing mechanism to generate a log of accessed resources.
    Each log event will include details about the user and application that opened
    the resource and whether the access succeeded or failed. This information can
    help us identify incorrect security settings or detect malicious access to sensitive
    resources.
  prefs: []
  type: TYPE_NORMAL
- en: In this short chapter, we’ll first discuss where the resource access log gets
    stored once the kernel generates it. We’ll then describe how a system administrator
    can configure the audit mechanism. Finally, we’ll detail how to configure individual
    resources to generate audit log events through the SACL.
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_Futura_Std_Bold_B_11">The Security Event Log</samp>
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Windows generates log events whenever an access check succeeds or fails. The
    kernel writes these log events to the *security event log*, which only administrators
    can access.
  prefs: []
  type: TYPE_NORMAL
- en: 'When performing access checks on kernel resources, Windows will generate the
    following types of audit events. The security event log represents these by using
    the event ID included in parentheses:'
  prefs: []
  type: TYPE_NORMAL
- en: Object handle opened (<samp class="SANS_TheSansMonoCd_W5Regular_11">4656</samp>)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Object handle closed (<samp class="SANS_TheSansMonoCd_W5Regular_11">4658</samp>)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Object deleted (<samp class="SANS_TheSansMonoCd_W5Regular_11">4660</samp>)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Object handle duplicated (<samp class="SANS_TheSansMonoCd_W5Regular_11">4690</samp>)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: SACL changed (<samp class="SANS_TheSansMonoCd_W5Regular_11">4717</samp>)
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'When we access resources via kernel system calls such as <samp class="SANS_TheSansMonoCd_W5Regular_11">NtCreateMutant</samp>,
    the auditing mechanism generates these events automatically. But for the object-related
    audit events, we must first configure two aspects of the system: we must set the
    system policy to generate audit events, and we must enable audit ACEs in the resource’s
    SACL. Let’s discuss each of these configuration requirements in turn.'
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">Configuring the System
    Audit Policy</samp>
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: Most Windows users don’t need to capture audit information for kernel resources,
    so the audit policy is disabled by default. Enterprise environments commonly configure
    the audit policy through a *domain security policy*, which the enterprise network
    distributes to the individual devices.
  prefs: []
  type: TYPE_NORMAL
- en: 'Users not in an enterprise network can enable the audit policy manually. One
    way to do so is to edit the *local security policy*, which looks the same as the
    domain security policy but applies only to the current system. There are two types
    of audit policy: the legacy policy used prior to Windows 7 and the advanced audit
    policy. Using the advanced audit policy is recommended, as it provides more granular
    configuration; we won’t discuss the legacy policy further.'
  prefs: []
  type: TYPE_NORMAL
- en: If you open the local security policy editor by running the <samp class="SANS_TheSansMonoCd_W5Regular_11">secpol.msc</samp>
    command in PowerShell, you can view the current configuration of the advanced
    audit policy, as shown in [Figure 9-1](chapter9.xhtml#fig9-1).
  prefs: []
  type: TYPE_NORMAL
- en: '![](../images/Figure9-1.jpg)'
  prefs: []
  type: TYPE_IMG
- en: '<samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 9-1: The security policy
    editor showing the advanced audit policy</samp>'
  prefs: []
  type: TYPE_NORMAL
- en: As you can see, the categories in the audit policy aren’t currently configured.
    To explore how audit events are generated, we’ll use PowerShell to enable the
    required audit policy temporarily and run some example code. Any changes you make
    with PowerShell won’t be reflected in the local security policy, which will revert
    the next time it synchronizes (for example, during a reboot or when the group
    policy is updated on an enterprise network). You can force the settings to synchronize
    by running the command <samp class="SANS_TheSansMonoCd_W5Regular_11">gpupdate.exe
    /force</samp> as an administrator in PowerShell or at the command prompt.
  prefs: []
  type: TYPE_NORMAL
- en: 'Advanced audit policies have two levels: a top-level category and multiple
    subcategories. You can query for the top-level categories using <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-NtAuditPolicy</samp>,
    as in [Listing 9-1](chapter9.xhtml#Lis9-1).'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 'Listing 9-1: The top-level audit policy categories'
  prefs: []
  type: TYPE_NORMAL
- en: In the output, you can see the name of each category and a count of its subcategories.
    Each category also has an associated GUID, but this value is hidden by default.
    To see it, select the <samp class="SANS_TheSansMonoCd_W5Regular_11">Id</samp>
    property from the command’s output, as shown in [Listing 9-2](chapter9.xhtml#Lis9-2).
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: 'Listing 9-2: Displaying category GUIDs'
  prefs: []
  type: TYPE_NORMAL
- en: You can display the subcategories by using the <samp class="SANS_TheSansMonoCd_W5Regular_11">ExpandCategory</samp>
    parameter. In [Listing 9-3](chapter9.xhtml#Lis9-3), we specify the <samp class="SANS_TheSansMonoCd_W5Regular_11">System</samp>
    category by name and then expand the output to show its subcategories.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: 'Listing 9-3: Displaying the audit policy’s subcategories'
  prefs: []
  type: TYPE_NORMAL
- en: 'You can also select a category by specifying its GUID using the <samp class="SANS_TheSansMonoCd_W5Regular_11">CategoryGuid</samp>
    parameter. The audit policy is based on these subcategories. Each subcategory
    policy can have one or more of the following values:'
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_TheSansMonoCd_W7Bold_B_11">Unchanged</samp><samp class="SANS_TheSansMonoCd_W7Bold_B_11">  </samp>The
    policy is not configured and should not be changed.
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_TheSansMonoCd_W7Bold_B_11">Success  </samp>The policy should
    generate audit events when an auditable resource is opened successfully.
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_TheSansMonoCd_W7Bold_B_11">Failure  </samp>The policy should
    generate audit events when an auditable resource can’t be opened.
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_TheSansMonoCd_W7Bold_B_11">None  </samp>The policy should
    never generate an audit event.
  prefs: []
  type: TYPE_NORMAL
- en: In [Listing 9-3](chapter9.xhtml#Lis9-3) the subcategories all show the value
    <samp class="SANS_TheSansMonoCd_W5Regular_11">Unchanged</samp>, which means no
    policy has been configured. We can enable kernel object auditing by running the
    commands shown in [Listing 9-4](chapter9.xhtml#Lis9-4) as an administrator.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: 'Listing 9-4: Setting the policy and viewing the resulting ObjectAccess audit
    policy list'
  prefs: []
  type: TYPE_NORMAL
- en: Here, we’ve enabled the <samp class="SANS_TheSansMonoCd_W5Regular_11">Success</samp>
    and <samp class="SANS_TheSansMonoCd_W5Regular_11">Failure</samp> audit policies
    for all subcategories under <samp class="SANS_TheSansMonoCd_W5Regular_11">ObjectAccess</samp>.
    To make this modification, we need the <samp class="SANS_TheSansMonoCd_W5Regular_11">SeSecurityPrivilege</samp>
    privilege. We can set a single subcategory rather than the entire category by
    name by using the <samp class="SANS_TheSansMonoCd_W5Regular_11">SubCategoryName</samp>
    parameter or specifying the GUID using <samp class="SANS_TheSansMonoCd_W5Regular_11">SubCategoryGuid</samp>.
  prefs: []
  type: TYPE_NORMAL
- en: We confirm that the audit policy has been configured correctly by specifying
    the <samp class="SANS_TheSansMonoCd_W5Regular_11">PassThru</samp> parameter, which
    lists the modified <samp class="SANS_TheSansMonoCd_W5Regular_11">SubCategory</samp>
    objects. The output displays some important audit policies, including <samp class="SANS_TheSansMonoCd_W5Regular_11">File
    System</samp>, <samp class="SANS_TheSansMonoCd_W5Regular_11">Registry</samp>,
    and <samp class="SANS_TheSansMonoCd_W5Regular_11">Kernel Object</samp>, which
    enable auditing on files, registry keys, and other kernel objects, respectively.
  prefs: []
  type: TYPE_NORMAL
- en: 'You can run the following command as an administrator to disable the change
    we made in [Listing 9-4](chapter9.xhtml#Lis9-4):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: Unless you need to enable the audit policy for some reason, it’s best to disable
    it once you’re finished experimenting.
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">Configuring the Per-User
    Audit Policy</samp>
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: 'In addition to configuring a system-wide policy, it’s also possible to configure
    the audit policy on a per-user basis. You could use this feature to add auditing
    to a specific user account in cases when the system does not define an overall
    audit policy. You could also use it to exclude a specific user account from auditing.
    To facilitate this behavior, the policy settings differ slightly for per-user
    policies:'
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_TheSansMonoCd_W7Bold_B_11">Unchanged  </samp>The policy is
    not configured. When set, the policy should not be changed.
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_TheSansMonoCd_W7Bold_B_11">SuccessInclude  </samp>The policy
    should generate audit events on success, regardless of the system policy.
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_TheSansMonoCd_W7Bold_B_11">SuccessExclude  </samp>The policy
    should never generate audit events on success, regardless of the system policy.
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_TheSansMonoCd_W7Bold_B_11">FailureInclude  </samp>The policy
    should generate audit events on failure, regardless of the system policy.
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_TheSansMonoCd_W7Bold_B_11">FailureExclude</samp><samp class="SANS_TheSansMonoCd_W7Bold_B_11">  </samp>The
    policy should never generate audit events on failure, regardless of the system
    policy.
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_TheSansMonoCd_W7Bold_B_11">None  </samp>The policy should
    never generate an audit event.
  prefs: []
  type: TYPE_NORMAL
- en: To configure a per-user policy, you can specify a SID to the <samp class="SANS_TheSansMonoCd_W5Regular_11">User</samp>
    parameter when using the <samp class="SANS_TheSansMonoCd_W5Regular_11">Set-NtAuditPolicy</samp>
    command. This SID must represent a user account; it can’t represent a group, such
    as *Administrators*, or a service account, such as *SYSTEM*, or you’ll receive
    an error when setting the policy.
  prefs: []
  type: TYPE_NORMAL
- en: '[Listing 9-5](chapter9.xhtml#Lis9-5) configures a per-user policy for the current
    user. You must run these commands as an administrator.'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: 'Listing 9-5: Configuring a per-user audit policy'
  prefs: []
  type: TYPE_NORMAL
- en: 'Here, we specify the user’s SID to the <samp class="SANS_TheSansMonoCd_W5Regular_11">User</samp>
    parameter, then specify the <samp class="SANS_TheSansMonoCd_W5Regular_11">SuccessExclude</samp>
    user policy. This will exclude success audit events for only this user. If you
    want to remove the per-user policy for a user, you can specify the <samp class="SANS_TheSansMonoCd_W5Regular_11">None</samp>
    user policy:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: You can also enumerate all users who have configured policies using the <samp
    class="SANS_TheSansMonoCd_W5Regular_11">AllUser</samp> parameter of <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-NtAuditPolicy</samp>,
    as shown in [Listing 9-6](chapter9.xhtml#Lis9-6).
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: 'Listing 9-6: Querying per-user policies for all users'
  prefs: []
  type: TYPE_NORMAL
- en: You now know how to query and set policies for the system and for a specific
    user. Next, we’ll look at how to grant users the access needed to query and set
    these policies on the system.
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_Futura_Std_Bold_B_11">Audit Policy Security</samp>
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'To query or set a policy, the caller must have <samp class="SANS_TheSansMonoCd_W5Regular_11">SeSecurityPrivilege</samp>
    enabled on their token. If the privilege is not enabled, LSASS will perform an
    access check based on a security descriptor in the system configuration. We can
    configure the following access rights in the security descriptor to grant a user
    the ability to query or set the policy for the system or a single user:'
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_TheSansMonoCd_W7Bold_B_11">SetSystemPolicy  </samp>Enables
    setting the system audit policy
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_TheSansMonoCd_W7Bold_B_11">QuerySystemPolicy  </samp>Enables
    querying the system audit policy
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_TheSansMonoCd_W7Bold_B_11">SetUserPolicy</samp><samp class="SANS_TheSansMonoCd_W7Bold_B_11">  </samp>Enables
    setting a per-user audit policy
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_TheSansMonoCd_W7Bold_B_11">QueryUserPolicy  </samp>Enables
    querying a per-user audit policy
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_TheSansMonoCd_W7Bold_B_11">EnumerateUsers  </samp>Enables
    enumerating all per-user audit policies
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_TheSansMonoCd_W7Bold_B_11">SetMiscPolicy  </samp>Enables setting
    a miscellaneous audit policy
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_TheSansMonoCd_W7Bold_B_11">QueryMiscPolicy  </samp>Enables
    querying a miscellaneous audit policy
  prefs: []
  type: TYPE_NORMAL
- en: No standard auditing API seems to use the <samp class="SANS_TheSansMonoCd_W5Regular_11">SetMiscPolicy</samp>
    and <samp class="SANS_TheSansMonoCd_W5Regular_11">QueryMiscPolicy</samp> access
    rights, but because they are defined in the Windows SDK, I’ve included them here
    for completeness.
  prefs: []
  type: TYPE_NORMAL
- en: As an administrator, you can query the currently configured security descriptor
    by enabling <samp class="SANS_TheSansMonoCd_W5Regular_11">SeSecurityPrivilege</samp>
    and using the <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-NtAuditSecurity</samp>
    command, as shown in [Listing 9-7](chapter9.xhtml#Lis9-7).
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: 'Listing 9-7: Querying and displaying the audit security descriptor'
  prefs: []
  type: TYPE_NORMAL
- en: We pass the queried security descriptor to <samp class="SANS_TheSansMonoCd_W5Regular_11">Format-NtSecurityDescriptor</samp>
    to display the DACL. Notice that only *Administrators* and *SYSTEM* can access
    the policy ❶. Also, they’re limited to <samp class="SANS_TheSansMonoCd_W5Regular_11">GenericRead</samp>
    access, which allows users to query the policy but not modify it. Thus, even administrators
    will need to enable <samp class="SANS_TheSansMonoCd_W5Regular_11">SeSecurityPrivilege</samp>
    to modify the audit policy, as that privilege bypasses any access check.
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_Dogma_OT_Bold_B_15">NOTE</samp>
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: ''
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: '*A user who has not been granted read access to the policy can still query
    the advanced audit categories and subcategories, which ignore the security descriptor.
    However, they won’t be granted access to query the configured settings. Get-NtAuditPolicy
    will return the value of Unchanged for audit settings the user wasn’t able to
    query.*'
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: If you want to allow non-administrators to change the advanced audit policy,
    you can change the security descriptor using the <samp class="SANS_TheSansMonoCd_W5Regular_11">Set-NtAuditSecurity</samp>
    command. Run the commands in [Listing 9-8](chapter9.xhtml#Lis9-8) as an administrator.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: 'Listing 9-8: Modifying the audit security descriptor'
  prefs: []
  type: TYPE_NORMAL
- en: We first query the existing security descriptor for the audit policy and grant
    the local administrator all access rights. Then we set the modified security descriptor
    using the <samp class="SANS_TheSansMonoCd_W5Regular_11">Set-NtAuditSecurity</samp>
    command. Now the local administrator can query and modify the audit policy without
    needing to enable <samp class="SANS_TheSansMonoCd_W5Regular_11">SeSecurityPrivilege</samp>.
  prefs: []
  type: TYPE_NORMAL
- en: You shouldn’t normally reconfigure the security of the audit policy, and you
    certainly shouldn’t grant all users write access. Note that the security descriptor
    doesn’t affect who can query or set the security descriptor itself; only callers
    with <samp class="SANS_TheSansMonoCd_W5Regular_11">SeSecurityPrivilege</samp>
    enabled can do this, no matter the values in the security descriptor.
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">Configuring the Resource
    SACL</samp>
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: Just enabling the audit policies isn’t enough to start generating audit events.
    We also need to configure an object’s SACL to specify the auditing rules to use.
    To set the SACL on an object we’ll again need to enable <samp class="SANS_TheSansMonoCd_W5Regular_11">SeSecurityPrivilege</samp>,
    which can only be done as an administrator. [Listing 9-9](chapter9.xhtml#Lis9-9)
    demonstrates the process for creating a <samp class="SANS_TheSansMonoCd_W5Regular_11">Mutant</samp>
    object with a SACL.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: 'Listing 9-9: Creating a Mutant object with a SACL'
  prefs: []
  type: TYPE_NORMAL
- en: We start by creating an empty security descriptor, then add a single <samp class="SANS_TheSansMonoCd_W5Regular_11">Audit</samp>
    ACE to the SACL. Other ACE types we could add include <samp class="SANS_TheSansMonoCd_W5Regular_11">AuditObject</samp>
    and <samp class="SANS_TheSansMonoCd_W5Regular_11">AuditCallback</samp>.
  prefs: []
  type: TYPE_NORMAL
- en: The processing of <samp class="SANS_TheSansMonoCd_W5Regular_11">Audit</samp>
    ACEs looks a lot like the discretionary access check described in [Chapter 7](chapter7.xhtml).
    The SID must match a group in the calling token (including any <samp class="SANS_TheSansMonoCd_W5Regular_11">DenyOnly</samp>
    SIDs), and the access mask must match one or more bits of the granted access.
    The *Everyone* group’s SID is a special case; it will always match, regardless
    of whether the SID is available in the token.
  prefs: []
  type: TYPE_NORMAL
- en: In addition to any of the usual inheritance ACE flags, such as <samp class="SANS_TheSansMonoCd_W5Regular_11">InheritOnly</samp>,
    the <samp class="SANS_TheSansMonoCd_W5Regular_11">Audit</samp> ACE must specify
    one or both of the <samp class="SANS_TheSansMonoCd_W5Regular_11">SuccessfulAccess</samp>
    and <samp class="SANS_TheSansMonoCd_W5Regular_11">FailedAccess</samp> flags, which
    provide the auditing code with the conditions in which it should generate the
    audit entry.
  prefs: []
  type: TYPE_NORMAL
- en: We’ll create the <samp class="SANS_TheSansMonoCd_W5Regular_11">Mutant</samp>
    object with a security descriptor containing the SACL. Before creating the object,
    we need to enable <samp class="SANS_TheSansMonoCd_W5Regular_11">SeSecurityPrivilege</samp>.
    If we don’t do this, the creation will fail. To make it easier to see the generated
    audit event, we also clear the security event log. Next, we create the object,
    passing it the SACL we built, and then reopen it to trigger the generation of
    an audit log.
  prefs: []
  type: TYPE_NORMAL
- en: Now we can query the security event log using <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-WinEvent</samp>,
    passing it the event ID <samp class="SANS_TheSansMonoCd_W5Regular_11">4656</samp>
    to find the generated audit event ([Listing 9-10](chapter9.xhtml#Lis9-10)).
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: 'Listing 9-10: Viewing the open audit event for the Mutant object'
  prefs: []
  type: TYPE_NORMAL
- en: We first set up a filter for the security event log and event ID <samp class="SANS_TheSansMonoCd_W5Regular_11">4656</samp>,
    which corresponds to the opening of a handle. We then use the filter with <samp
    class="SANS_TheSansMonoCd_W5Regular_11">Get-WinEvent</samp> and select the event’s
    textual message.
  prefs: []
  type: TYPE_NORMAL
- en: The output begins with this textual description of the event, which confirms
    that it was generated in response to a handle being opened. After this comes the
    <samp class="SANS_TheSansMonoCd_W5Regular_11">Subject</samp>, which includes the
    user’s information, including their SID and username. To look up the username,
    the kernel sends the audit event to the LSASS process.
  prefs: []
  type: TYPE_NORMAL
- en: Next are the details of the opened object. These include the object server (<samp
    class="SANS_TheSansMonoCd_W5Regular_11">Security</samp>, representing the SRM),
    the object type (<samp class="SANS_TheSansMonoCd_W5Regular_11">Mutant</samp>),
    and the native path to the object, as well as the handle ID (the handle number
    for the object). If you query the handle value returned from the <samp class="SANS_TheSansMonoCd_W5Regular_11">NtCreateMutant</samp>
    system call, it should match this value. We then get some basic process information,
    and finally some information about the access granted to the handle.
  prefs: []
  type: TYPE_NORMAL
- en: How can we distinguish between success and failure events? The best way to do
    this is to extract the <samp class="SANS_TheSansMonoCd_W5Regular_11">KeywordsDisplayNames</samp>
    property, which contains either <samp class="SANS_TheSansMonoCd_W5Regular_11">Audit
    Success</samp> if the handle was opened or <samp class="SANS_TheSansMonoCd_W5Regular_11">Audit
    Failure</samp> if the handle could not be opened. [Listing 9-11](chapter9.xhtml#Lis9-11)
    shows an example.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: 'Listing 9-11: Extracting KeywordsDisplayNames to view the success or failure
    status'
  prefs: []
  type: TYPE_NORMAL
- en: When you close the handle to the object you’ll get another audit event, with
    the event ID <samp class="SANS_TheSansMonoCd_W5Regular_11">4658</samp>, as shown
    in [Listing 9-12](chapter9.xhtml#Lis9-12).
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: 'Listing 9-12: Viewing the audit event generated when the Mutant object handle
    is closed'
  prefs: []
  type: TYPE_NORMAL
- en: You might notice that the information provided about the closing of the object
    handle is slightly less detailed than the information generated when the handle
    was opened. You can manually correlate the open and close handle events by using
    the handle IDs, which should match.
  prefs: []
  type: TYPE_NORMAL
- en: It’s possible to generate object audit events manually from user mode using
    some additional system calls. However, to do so you need the <samp class="SANS_TheSansMonoCd_W5Regular_11">SeAuditPrivilege</samp>
    privilege, which is typically only granted to the *SYSTEM* account, not to normal
    administrators.
  prefs: []
  type: TYPE_NORMAL
- en: You can generate the audit event at the same time as an access check using the
    <samp class="SANS_TheSansMonoCd_W5Regular_11">NtAccessCheckAndAuditAlarm</samp>
    system call, which has all the same object ACE variants as the normal access checks
    do. You can access it using the <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-NtGrantedAccess</samp>
    PowerShell command with the <samp class="SANS_TheSansMonoCd_W5Regular_11">Audit</samp>
    parameter.
  prefs: []
  type: TYPE_NORMAL
- en: You can also generate events manually using the <samp class="SANS_TheSansMonoCd_W5Regular_11">NtOpenObjectAuditAlarm</samp>
    and <samp class="SANS_TheSansMonoCd_W5Regular_11">NtCloseObjectAuditAlarm</samp>
    system calls, which PowerShell exposes through the <samp class="SANS_TheSansMonoCd_W5Regular_11">Write-NtAudit</samp>
    command. Run the commands in [Listing 9-13](chapter9.xhtml#Lis9-13) as the *SYSTEM*
    user to manually generate audit log events.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: 'Listing 9-13: Manually generating audit log events'
  prefs: []
  type: TYPE_NORMAL
- en: We start by enabling <samp class="SANS_TheSansMonoCd_W5Regular_11">SeAuditPrivilege</samp>
    ❶, as otherwise the rest of the script will fail. This privilege must be enabled
    on the primary token; you can’t impersonate a token with the privilege, which
    is why you must run the PowerShell instance as the *SYSTEM* user.
  prefs: []
  type: TYPE_NORMAL
- en: After enabling the required privilege, we build a security descriptor with a
    SACL to audit successful and failed access attempts ❷. We generate a fake handle
    ID ❸; this value would be the kernel handle in a normal audit event, but when
    we generate an event from user mode it can be any value we like. We can then run
    the access check, specifying the <samp class="SANS_TheSansMonoCd_W5Regular_11">Audit</samp>
    parameter, which enables the other auditing parameters. We need to specify the
    <samp class="SANS_TheSansMonoCd_W5Regular_11">SubsystemName</samp>, <samp class="SANS_TheSansMonoCd_W5Regular_11">ObjectTypeName</samp>,
    and <samp class="SANS_TheSansMonoCd_W5Regular_11">ObjectName</samp> parameters,
    which can be completely arbitrary. We also specify the handle ID ❹.
  prefs: []
  type: TYPE_NORMAL
- en: 'In the output, we receive an access check result with one additional property:
    <samp class="SANS_TheSansMonoCd_W5Regular_11">GenerateOnClose</samp>, which indicates
    whether we need to write a closed handle event. Calling the <samp class="SANS_TheSansMonoCd_W5Regular_11">Write-NtAudit</samp>
    command and specifying the <samp class="SANS_TheSansMonoCd_W5Regular_11">Close</samp>
    parameter will call the <samp class="SANS_TheSansMonoCd_W5Regular_11">NtCloseObjectAuditAlarm</samp>
    system call to generate the event. We do so, specifying the <samp class="SANS_TheSansMonoCd_W5Regular_11">GenerateOnClose</samp>
    value from the result ❺. If <samp class="SANS_TheSansMonoCd_W5Regular_11">GenerateOnClose</samp>
    were <samp class="SANS_TheSansMonoCd_W5Regular_11">False</samp>, we would still
    need to write the close event to complete the audit, but the actual close event
    would not be written to the audit log.'
  prefs: []
  type: TYPE_NORMAL
- en: If you don’t receive any audit events when you run the commands in [Listing
    9-13](chapter9.xhtml#Lis9-13), ensure that you’ve enabled object auditing, as
    we did in [Listing 9-4](chapter9.xhtml#Lis9-4).
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">Configuring the Global
    SACL</samp>
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: Correctly configuring the SACL for every resource can be difficult, as well
    as time-consuming. For this reason, the advanced audit policy allows you to configure
    a global SACL for files or registry keys. The system will use this global SACL
    if no SACL exists for a resource, and for resources that already have a SACL,
    it will merge the global and resource SACLs. Because these broad auditing configurations
    can swamp your logging output and impede your ability to monitor events, I recommend
    that you use global SACLs sparingly.
  prefs: []
  type: TYPE_NORMAL
- en: You can query the global SACL by specifying either the <samp class="SANS_TheSansMonoCd_W5Regular_11">File</samp>
    or <samp class="SANS_TheSansMonoCd_W5Regular_11">Key</samp> value to the <samp
    class="SANS_TheSansMonoCd_W5Regular_11">GlobalSacl</samp> parameter of the <samp
    class="SANS_TheSansMonoCd_W5Regular_11">Get-NtAuditSecurity</samp> PowerShell
    command. You can also modify the global SACL with the <samp class="SANS_TheSansMonoCd_W5Regular_11">Set-NtAuditSecurity</samp>
    command, specifying the same <samp class="SANS_TheSansMonoCd_W5Regular_11">GlobalSacl</samp>
    parameter. To test this behavior, run the commands in [Listing 9-14](chapter9.xhtml#Lis9-14)
    as an administrator.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE15]'
  prefs: []
  type: TYPE_PRE
- en: 'Listing 9-14: Setting and querying the global file SACL'
  prefs: []
  type: TYPE_NORMAL
- en: We start by building a security descriptor containing a SACL with a single <samp
    class="SANS_TheSansMonoCd_W5Regular_11">Audit</samp> ACE. We then call <samp class="SANS_TheSansMonoCd_W5Regular_11">Set-NtAuditSecurity</samp>
    to set the global SACL for the <samp class="SANS_TheSansMonoCd_W5Regular_11">File</samp>
    type. Finally, we query the global SACL to make sure it’s set correctly.
  prefs: []
  type: TYPE_NORMAL
- en: 'You can remove the global SACL by passing a security descriptor with a NULL
    SACL to <samp class="SANS_TheSansMonoCd_W5Regular_11">Set-NtAuditSecurity</samp>.
    To create this security descriptor, use the following command:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE16]'
  prefs: []
  type: TYPE_PRE
- en: <samp class="SANS_Futura_Std_Bold_B_11">Worked Examples</samp>
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Let’s wrap up with some worked examples that use the commands you learned about
    in this chapter.
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">Verifying Audit Access
    Security</samp>
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: When you’re checking whether malicious code has compromised an untrusted Windows
    system, it’s a good idea to verify that the security settings haven’t been modified.
    One check you might want to perform is determining whether a non-administrator
    user has the access needed to change the audit policy on the system. If a non-administrator
    user can change the policy, they could disable auditing and hide their access
    to sensitive resources.
  prefs: []
  type: TYPE_NORMAL
- en: We can inspect the audit policy’s security descriptor manually, or do so using
    the <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-NtGrantedAccess</samp> PowerShell
    command. Run the commands in [Listing 9-15](chapter9.xhtml#Lis9-15) as an administrator.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE17]'
  prefs: []
  type: TYPE_PRE
- en: 'Listing 9-15: Performing an access check on the audit policy security descriptor'
  prefs: []
  type: TYPE_NORMAL
- en: We start by querying for the audit policy security descriptor and setting the
    <samp class="SANS_TheSansMonoCd_W5Regular_11">Owner</samp> and <samp class="SANS_TheSansMonoCd_W5Regular_11">Group</samp>
    fields. These fields are required for the access check process, but the security
    descriptor returned from the <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-NtAuditSecurity</samp>
    command does not contain them.
  prefs: []
  type: TYPE_NORMAL
- en: We can then pass the security descriptor to the <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-NtGrantedAccess</samp>
    command to check it against the current administrator token. The result indicates
    the caller has <samp class="SANS_TheSansMonoCd_W5Regular_11">GenericRead</samp>
    access to the audit policy, which allows them to query the policy but not set
    it without enabling <samp class="SANS_TheSansMonoCd_W5Regular_11">SeSecurityPrivilege</samp>.
  prefs: []
  type: TYPE_NORMAL
- en: Finally, we can remove the *Administrators* group from the token by creating
    a filtered token with the <samp class="SANS_TheSansMonoCd_W5Regular_11">LuaToken</samp>
    flag. Running the access check with the filtered token indicates that it has no
    granted access to the audit policy (not even read access). If this second check
    returns a status other than <samp class="SANS_TheSansMonoCd_W5Regular_11">STATUS_ACCESS_DENIED</samp>,
    you can conclude that the default audit policy security descriptor has been changed,
    and it’s worth checking whether this was done intentionally or maliciously.
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">Finding Resources
    with Audit ACEs</samp>
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: Most resources aren’t configured with a SACL, so you might want to enumerate
    the resources on the system that have one. This can help you understand what resources
    might generate audit log events. [Listing 9-16](chapter9.xhtml#Lis9-16) provides
    a simple example in which we find these resources. Run the commands as an administrator.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE18]'
  prefs: []
  type: TYPE_PRE
- en: 'Listing 9-16: Finding processes with configured SACLs'
  prefs: []
  type: TYPE_NORMAL
- en: We focus on <samp class="SANS_TheSansMonoCd_W5Regular_11">Process</samp> objects
    here, but you can apply this same approach to other resource types.
  prefs: []
  type: TYPE_NORMAL
- en: We first open all processes for <samp class="SANS_TheSansMonoCd_W5Regular_11">QueryLimitedInformation</samp>
    and <samp class="SANS_TheSansMonoCd_W5Regular_11">AccessSystemSecurity</samp>
    access ❶. We apply a filter to the processes, querying for the SACL from the <samp
    class="SANS_TheSansMonoCd_W5Regular_11">Process</samp> object, then returning
    the value of the <samp class="SANS_TheSansMonoCd_W5Regular_11">HasAuditAce</samp>
    property ❷. This property indicates whether the security descriptor has at least
    one audit ACE.
  prefs: []
  type: TYPE_NORMAL
- en: We then pipe the results returned from the <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-NtProcess</samp>
    command into <samp class="SANS_TheSansMonoCd_W5Regular_11">Format-NtSecurityDescriptor</samp>
    to display the SACLs ❸. In this case, there is only a single entry, for the LSASS
    process. We can see that the audit ACE logs an event whenever the LSASS process
    is opened for <samp class="SANS_TheSansMonoCd_W5Regular_11">VmRead</samp> access
    ❹.
  prefs: []
  type: TYPE_NORMAL
- en: This policy is a default audit configuration on Windows, used to detect access
    to the LSASS process. The <samp class="SANS_TheSansMonoCd_W5Regular_11">VmRead</samp>
    access right allows a caller to read the virtual memory of a process, and this
    ACE aims to detect the extraction of the LSASS memory contents, which can include
    passwords and other authentication credentials. If the process is opened for any
    other access right, no audit log entry will be generated.
  prefs: []
  type: TYPE_NORMAL
- en: <samp class="SANS_Futura_Std_Bold_B_11">Wrapping Up</samp>
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: In this chapter, we covered the basics of security auditing. We started with
    a description of the security event log and the types of log entries you might
    find when auditing resource access. Next, we looked at configuring the audit policy
    and setting advanced audit policies with the <samp class="SANS_TheSansMonoCd_W5Regular_11">Set-NtAuditPolicy</samp>
    command. We also discussed how Windows controls access to the audit policy and
    the importance of the <samp class="SANS_TheSansMonoCd_W5Regular_11">SeSecurityPrivilege</samp>
    privilege, used for almost all audit-related configuration.
  prefs: []
  type: TYPE_NORMAL
- en: To enable auditing on an object, we must modify the SACL to define rules for
    generating the events enabled by the policy. We walked through examples of generating
    audit events automatically, using the SACL, and manually, during a user-mode access
    check.
  prefs: []
  type: TYPE_NORMAL
- en: 'We’ve now covered all aspects of the SRM: security access tokens, security
    descriptors, access checking, and auditing. In the rest of this book, we’ll explore
    the various mechanisms to authenticate to a Windows system.'
  prefs: []
  type: TYPE_NORMAL
