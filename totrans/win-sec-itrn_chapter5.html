<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" epub:prefix="index: http://www.index.com/" xml:lang="en" lang="en">
<head>
<title>5. Security Descriptors</title>
<link href="../styles/stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="sbo-rt-content"><section aria-labelledby="ch5" epub:type="chapter" role="doc-chapter">
<hgroup>
<h2 class="CHAPTER" id="ch5">
<span class="CN"><span aria-label=" Page 143. " epub:type="pagebreak" id="pg_143" role="doc-pagebreak"></span><samp class="SANS_Futura_Std_Bold_Condensed_B_11">5</samp></span>
<span class="CT"><samp class="SANS_Dogma_OT_Bold_B_11">SECURITY DESCRIPTORS</samp></span>
</h2>
</hgroup>
<figure class="opener"><img alt="" class="opener" height="386" src="../images/chapter.jpg" width="386"/></figure>
<p class="ChapterIntro">In the preceding chapter, we discussed the security access token, which describes the user’s identity to the SRM. In this chapter, you’ll learn how <i>security descriptors</i> define a resource’s security. A security descriptor does several things. It specifies the owner of a resource, allowing the SRM to grant specific rights to users who are accessing their own data. It also contains the <i>discretionary access control (DAC)</i> and <i>mandatory access control (MAC)</i>, which grant or deny access to users and groups. Finally, it</p>
<p class="TNI1">can contain entries that generate audit events. Almost every kernel resource has a security descriptor, and user-mode applications can implement their own access control through security descriptors without needing to create a kernel resource.</p>
<p class="TX">Understanding the structure of security descriptors is crucial to understanding the security of Windows, as they’re used to secure every <span aria-label=" Page 144. " epub:type="pagebreak" id="pg_144" role="doc-pagebreak"></span>kernel object and many user-mode components, such as services. You’ll even find security descriptors used across network boundaries to secure remote resources. While developing a Windows application or researching Windows security, you’ll inevitably have to inspect or create a security descriptor, so having a clear understanding of what a security descriptor contains will save you a lot of time. To help with this, I’ll start by describing the structure of a security descriptor in more detail.</p>
<section aria-labelledby="sec1" epub:type="division">
<h3 class="H1" id="sec1"><span id="h1-44"></span><samp class="SANS_Futura_Std_Bold_B_11">The Structure of a Security Descriptor</samp></h3>
<p class="TNI1">Windows stores security descriptors as binary structures on disk or in memory. While you’ll rarely have to manually parse these structures, it’s worth understanding what they contain. A security descriptor consists of the following seven components:</p>
<ul class="ul">
<li class="ListBullet">The revision</li>
<li class="ListBullet">Optional resource manager flags</li>
<li class="ListBullet">Control flags</li>
<li class="ListBullet">An optional owner SID</li>
<li class="ListBullet">An optional group SID</li>
<li class="ListBullet">An optional discretionary access control list</li>
<li class="ListBullet">An optional system access control list</li>
</ul>
<p class="TX">Let’s look at each of these in turn. The first component of any security descriptor is the <i>revision</i>, which indicates the version of the security descriptor’s binary format. There is only one version, so the revision is always set to the value <samp class="SANS_TheSansMonoCd_W5Regular_11">1</samp>. Next is an optional set of flags for use by a resource manager. You’ll almost never encounter these flags being set; however, they are used by Active Directory, so we’ll talk more about them in <span class="Xref"><a href="chapter11.xhtml">Chapter 11</a></span>.</p>
<p class="TX">The resource manager flags are followed by a set of <i>control flags</i>. These have three uses: they define which optional components of the security descriptor are valid, how the security descriptors and components were created, and how to process the security descriptor when applying it to an object. <a href="chapter5.xhtml#tab5-1">Table 5-1</a> shows the list of valid flags and their descriptions. We’ll cover many of the terms in this table, such as inheritance, in more detail in the following chapter.</p>
<p class="Anchor"><span aria-label=" Page 145. " epub:type="pagebreak" id="pg_145" role="doc-pagebreak"></span></p>
<table class="Basic-Table">
<caption><p class="TT" id="tab5-1"><span class="Heavy"><samp class="SANS_Futura_Std_Heavy_B_11">Table 5-1:</samp></span> <samp class="SANS_Futura_Std_Book_11">Valid Control Flags</samp></p></caption>
<thead>
<tr>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Name</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Value</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Description</samp></p></th>
</tr>
</thead>
<tbody>
<tr>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">OwnerDefaulted</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x0001</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">The owner SID was assigned through a default method.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">GroupDefaulted</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x0002</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">The group SID was assigned through a default method.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">DaclPresent</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x0004</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">The DACL is present in the security descriptor.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">DaclDefaulted</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x0008</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">The DACL was assigned through a default method.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">SaclPresent</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x0010</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">The SACL is present in the security descriptor.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">SaclDefaulted</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x0020</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">The SACL was assigned through a default method.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">DaclUntrusted</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x0040</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">When combined with</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">ServerSecurity</samp><samp class="SANS_Futura_Std_Book_11">, the DACL is untrusted.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">ServerSecurity</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x0080</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">The DACL is replaced with a server ACL (more on the use of this in <a href="chapter6.xhtml">Chapter 6</a>).</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">DaclAutoInheritReq</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x0100</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">DACL auto-inheritance for child objects is requested.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">SaclAutoInheritReq</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x0200</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">SACL auto-inheritance for child objects is requested.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">DaclAutoInherited</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x0400</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">The DACL supports auto-inheritance.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">SaclAutoInherited</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x0800</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">The SACL supports auto-inheritance.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">DaclProtected</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x1000</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">The DACL is protected from inheritance.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">SaclProtected</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x2000</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">The SACL is protected from inheritance.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">RmControlValid</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x4000</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">The resource manager flags are valid.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">SelfRelative</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x8000</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">The security descriptor is in a relative format.</samp></p></td>
</tr>
</tbody>
</table>
<p class="TX">After the control flags comes the <i>owner SID</i>, which represents the owner of the resource. This is typically the user’s SID; however, ownership can also be assigned to a group, such as the <i>Administrators</i> group. Being the owner of a resource grants you certain privileges, including the ability to modify the resource’s security descriptor. By ensuring the owner has this capability, the system prevents a user from locking themselves out of their own resources.</p>
<p class="TX">The <i>group SID</i> is like the owner SID, but it’s rarely used. It exists primarily to ensure POSIX compatibility (a concern in the days when Windows still had a POSIX subsystem) and plays no part in access control for Windows applications.</p>
<p class="TX">The most important part of the security descriptor is the <i>discretionary access control list (DACL)</i>. The DACL contains a list of <i>access control entries (ACEs)</i>, which define what access a SID is given. It’s considered <i>discretionary</i> because the user or system administrator can choose the level of access granted. There are many different types of ACEs. We’ll discuss these further in <span class="Xref">“Access Control List Headers and Entries” on page 151</span>; for now, you just need to know that the basic information in each ACE includes the following:</p>
<ul class="ul">
<li class="ListBullet">The SID of the user or group to which the ACE applies</li>
<li class="ListBullet">The type of ACE</li>
<li class="ListBullet">The access mask to which the SID will be allowed or denied access</li>
</ul>
<p class="TX">The final component of the security descriptor is the <i>security access control list (SACL)</i>, which stores auditing rules. Like the DACL, it contains a list <span aria-label=" Page 146. " epub:type="pagebreak" id="pg_146" role="doc-pagebreak"></span>of ACEs, but rather than determining access based on whether a defined SID matches the current user’s, it determines the rules for generating audit events when the resource is accessed. Since Windows Vista, the SACL has also been the preferred location in which to store additional non-auditing ACEs, such as the resource’s mandatory label.</p>
<p class="TX">Two final elements to point out in the DACL and SACL are the <samp class="SANS_TheSansMonoCd_W5Regular_11">DaclPresent</samp> and <samp class="SANS_TheSansMonoCd_W5Regular_11">SaclPresent</samp> control flags. These flags indicate that the DACL and SACL, respectively, are present in the security descriptor. Using flags allows for the setting of a <i>NULL ACL</i>, where the present flag is set but no value has been specified for the ACL field in the security descriptor. A NULL ACL indicates that no security for that ACL has been defined and causes the SRM to effectively ignore it. This is distinct from an empty ACL, where the present flag is set and a value for the ACL is specified but the ACL contains no ACEs.</p>
</section>
<section aria-labelledby="sec2" epub:type="division">
<h3 class="H1" id="sec2"><span id="h1-45"></span><samp class="SANS_Futura_Std_Bold_B_11">The Structure of a SID</samp></h3>
<p class="TNI1">Until now, we’ve talked about SIDs as opaque binary values or strings of numbers. In this section, we’ll look more closely at what a SID contains. The diagram in <a href="chapter5.xhtml#fig5-1">Figure 5-1</a> shows a SID as it’s stored in memory.</p>
<figure class="IMG"><img alt="" class="img1" height="383" id="fig5-1" src="../images/Figure5-1.jpg" width="1290"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 5-1: The SID structure in memory</samp></p></figcaption>
</figure>
<p class="TX">There are four components to a binary SID:</p>
<p class="RunInPara1"><b>Revision    </b>A value that is always set to <samp class="SANS_TheSansMonoCd_W5Regular_11">1</samp>, as there is no other defined version number</p>
<p class="RunInPara"><b>Relative identifier count    </b>The number of RIDs in the SID</p>
<p class="RunInPara"><b>Security authority    </b>A value representing the party that issued the SID</p>
<p class="RunInPara2"><b>Relative identifiers    </b>Zero or more 32-bit numbers that represent the user or group</p>
<p class="TX">The security authority can be any value, but Windows has predefined some commonly used ones. All well-known authorities start with five <samp class="SANS_TheSansMonoCd_W5Regular_11">0</samp> bytes followed by a value from <a href="chapter5.xhtml#tab5-2">Table 5-2</a>.</p>
<p class="Anchor"><span aria-label=" Page 147. " epub:type="pagebreak" id="pg_147" role="doc-pagebreak"></span></p>
<table class="Basic-Table">
<caption><p class="TT" id="tab5-2"><span class="Heavy"><samp class="SANS_Futura_Std_Heavy_B_11">Table 5-2:</samp></span> <samp class="SANS_Futura_Std_Book_11">Well-Known Authorities</samp></p></caption>
<thead>
<tr>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Name</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Final value</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Example name</samp></p></th>
</tr>
</thead>
<tbody>
<tr>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Null</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_Futura_Std_Book_Oblique_I_11">NULL SID</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">World</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">1</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Everyone</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Local</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">2</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_Oblique_I_11">CONSOLE LOGON</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Creator</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">3</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_Oblique_I_11">CREATOR OWNER</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Nt</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">5</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_Oblique_I_11">BUILTIN\Users</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Package</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">15</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_Oblique_I_11">APPLICATION PACKAGE AUTHORITY\Your Internet connection</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">MandatoryLabel</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">16</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Mandatory Label\Medium Mandatory Level</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">ScopedPolicyId</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">17</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">N/A</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">ProcessTrust</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">19</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_Futura_Std_Book_Oblique_I_11">TRUST LEVEL\ProtectedLight-Windows</samp></p></td>
</tr>
</tbody>
</table>
<p class="TX">After the security authority come the relative identifiers. A SID can contain one or more RIDs, with the domain RIDs followed by the user RIDs.</p>
<p class="TX">Let’s walk through how the SID is constructed for a well-known group, <i>BUILTIN\Users</i>. Note that the domain component is separated from the group name with a backslash. In this case, the domain is <i>BUILTIN</i>. This is a predefined domain represented by a single RID, <samp class="SANS_TheSansMonoCd_W5Regular_11">32</samp>. <a href="chapter5.xhtml#Lis5-1">Listing 5-1</a> builds the domain SID for the <i>BUILTIN</i> domain from its components by using the <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-NtSid</samp> PowerShell command, then uses the <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-NtSidName</samp> command to retrieve the system-defined name for the SID.</p>
<span id="Lis5-1"></span><pre><code>PS&gt; <b>$domain_sid = Get-NtSid -SecurityAuthority Nt -RelativeIdentifier 32</b>
PS&gt; <b>Get-NtSidName $domain_sid</b>
Domain  Name<b>    </b>Source  NameUse Sddl
------  ----<b>    </b>------  ------- ----
BUILTIN BUILTIN Account Domain  S-1-5-32
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing 5-1: Querying for the</span> <samp class="SANS_Futura_Std_Book_11">BUILTIN</samp> <span class="Futura_Std_Book_Oblique_I_11">domain’s SID</span></p>
<p class="TX">The <i>BUILTIN</i> domain’s SID is a member of the <samp class="SANS_TheSansMonoCd_W5Regular_11">Nt</samp> security authority. We specify this security authority using the <samp class="SANS_TheSansMonoCd_W5Regular_11">SecurityAuthority</samp> parameter and specify the single RID using the <samp class="SANS_TheSansMonoCd_W5Regular_11">RelativeIdentifier</samp> parameter.</p>
<p class="TX">We then pass the SID to the <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-NtSidName</samp> command. The first two columns of the output show the domain name and the name of the SID. In this case, those values are the same; this is just a quirk of the <i>BUILTIN</i> domain’s registration.</p>
<p class="TX">The next column indicates the location from which the name was retrieved. In this example, the source, <samp class="SANS_TheSansMonoCd_W5Regular_11">Account</samp>, indicates that the name was retrieved from LSASS. If the source were <samp class="SANS_TheSansMonoCd_W5Regular_11">WellKnown</samp>, this would indicate that PowerShell knew the name ahead of time and didn’t need to query LSASS. The fourth column, <samp class="SANS_TheSansMonoCd_W5Regular_11">NameUse</samp>, indicates the SID’s type. In this case, it’s <samp class="SANS_TheSansMonoCd_W5Regular_11">Domain</samp>, which we might have expected. The final column is the SID in its SDDL format.</p>
<p class="TX"><span aria-label=" Page 148. " epub:type="pagebreak" id="pg_148" role="doc-pagebreak"></span>Any RIDs specified for SIDs following the domain SID identify a particular user or group. For the <i>Users</i> group, we use a single RID with the value <samp class="SANS_TheSansMonoCd_W5Regular_11">545</samp> (predefined by Windows). <a href="chapter5.xhtml#Lis5-2">Listing 5-2</a> creates a new SID by adding the <samp class="SANS_TheSansMonoCd_W5Regular_11">545</samp> RID to the base domain’s SID.</p>
<span id="Lis5-2"></span><pre><code>PS&gt; <b>$user_sid =</b> <b>Get-NtSid -BaseSid $domain_sid -RelativeIdentifier 545</b>
PS&gt; <b>Get-NtSidName $user_sid</b>
Domain  Name  Source  NameUse Sddl
------  ----  ------  ------- ----
BUILTIN Users Account Alias   S-1-5-32-545

PS&gt; <b>$user_sid.Name</b>
BUILTIN\Users
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing 5-2: Constructing a SID from a security authority and RIDs</span></p>
<p class="TX">The output now shows <i>Users</i> as the SID name. Also notice that <samp class="SANS_TheSansMonoCd_W5Regular_11">NameUse</samp> in this case is set to <samp class="SANS_TheSansMonoCd_W5Regular_11">Alias</samp>. This indicates that the SID represents a local, built-in group, as distinct from <samp class="SANS_TheSansMonoCd_W5Regular_11">Group</samp>, which represents a user-defined group. When we print the <samp class="SANS_TheSansMonoCd_W5Regular_11">Name</samp> property on the SID, it outputs the fully qualified name, with the domain and the name separated by a backslash.</p>
<p class="TX">You can find lists of known SIDs in Microsoft’s technical documentation and on other websites. However, Microsoft sometimes adds SIDs without documenting them. Therefore, I encourage you to test multiple security authority and RID values to see what other users and groups you can find. Merely checking for different SIDs won’t cause any damage. For example, try replacing the user RID in <a href="chapter5.xhtml#Lis5-2">Listing 5-2</a> with <samp class="SANS_TheSansMonoCd_W5Regular_11">544</samp>. This new SID represents the <i>BUILTIN\Administrators</i> group, as shown in <a href="chapter5.xhtml#Lis5-3">Listing 5-3</a>.</p>
<span id="Lis5-3"></span><pre><code>PS&gt; <b>Get-NtSid -BaseSid $domain_sid -RelativeIdentifier 544</b>
Name                   Sid
----                    ---
BUILTIN\Administrators S-1-5-32-544
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing 5-3: Querying the</span> <samp class="SANS_Futura_Std_Book_11">Administrators</samp> <span class="Futura_Std_Book_Oblique_I_11">group SID</span></p>
<p class="TX">Remembering the security authority and RIDs for a specific SID can be tricky, and you might not recall the exact name to query by using the <samp class="SANS_TheSansMonoCd_W5Regular_11">Name</samp> parameter, as described in <span class="Xref"><a href="chapter2.xhtml">Chapter 2</a></span>. Therefore, <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-NtSid</samp> implements a mode that can query a SID from a known set. For example, to query the SID of the <i>Administrators</i> group, you can use the command shown in <a href="chapter5.xhtml#Lis5-4">Listing 5-4</a>.</p>
<span id="Lis5-4"></span><pre><code>PS&gt; <b>Get-NtSid -KnownSid BuiltinAdministrators</b>
Name                   Sid
----                   ---
BUILTIN\Administrators S-1-5-32-544
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing 5-4: Querying the known</span> <samp class="SANS_Futura_Std_Book_11">Administrators</samp> <span class="Futura_Std_Book_Oblique_I_11">group SID</span></p>
<p class="TX"><span aria-label=" Page 149. " epub:type="pagebreak" id="pg_149" role="doc-pagebreak"></span>You’ll find SIDs used throughout the Windows operating system. It’s crucial that you understand how they’re structured, as this will allow you to quickly assess what a SID might represent. For example, if you identify a SID with the <samp class="SANS_TheSansMonoCd_W5Regular_11">Nt</samp> security authority and its first RID is <samp class="SANS_TheSansMonoCd_W5Regular_11">32</samp>, you can be sure it’s representing a built-in user or group. Knowing the structure also allows you to identify and extract SIDs from crash dumps or memory in cases where better tooling isn’t available.</p>
</section>
<section aria-labelledby="sec3" epub:type="division">
<h3 class="H1" id="sec3"><span id="h1-46"></span><samp class="SANS_Futura_Std_Bold_B_11">Absolute and Relative Security Descriptors</samp></h3>
<p class="TNI1">The kernel supports two binary representation formats for security descriptors: absolute and relative. We’ll examine both in this section, and consider the advantages and disadvantages of each.</p>
<p class="TX">Both formats start with the same three values: the revision, the resource manager flags, and the control flags. The <samp class="SANS_TheSansMonoCd_W5Regular_11">SelfRelative</samp> flag in the control flags determines which format to use, as shown in <a href="chapter5.xhtml#fig5-2">Figure 5-2</a>.</p>
<figure class="IMG"><img alt="" class="img1" height="756" id="fig5-2" src="../images/Figure5-2.jpg" width="1360"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 5-2: Selecting the security descriptor format</samp></p></figcaption>
</figure>
<p class="TX">The total size of the security descriptor’s header is 32 bits, split between two 8-bit values, the revision and <samp class="SANS_TheSansMonoCd_W5Regular_11">Sbz1</samp>, and the 16-bit control flags. The security descriptor’s resource manager flags are stored in <samp class="SANS_TheSansMonoCd_W5Regular_11">Sbz1</samp>; these are only valid if the <samp class="SANS_TheSansMonoCd_W5Regular_11">RmControlValid</samp> control flag is set, although the value will be present in either case. The rest of the security descriptor is stored immediately after the header.</p>
<p class="TX">The simplest format, the absolute security descriptor, is used when the <samp class="SANS_TheSansMonoCd_W5Regular_11">SelfRelative</samp> flag is not set. After the common header, the absolute format defines four pointers to reference in memory: the owner SID, the group SID, the DACL, and the SACL, in that order, as shown in <a href="chapter5.xhtml#fig5-3">Figure 5-3</a>.</p>
<span aria-label=" Page 150. " epub:type="pagebreak" id="pg_150" role="doc-pagebreak"></span>
<figure class="IMG"><img alt="" class="img7" height="553" id="fig5-3" src="../images/Figure5-3.jpg" width="876"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 5-3: The structure of an absolute security descriptor</samp></p></figcaption>
</figure>
<p class="TX">Each pointer references an absolute memory address at which the data is stored. The size of the pointer therefore depends on whether the application is 32 or 64 bits. It’s also possible to specify a NULL value for the pointer to indicate that the value is not present. The owner and group SID values are stored using the binary format defined in the previous section.</p>
<p class="TX">When the <samp class="SANS_TheSansMonoCd_W5Regular_11">SelfRelative</samp> flag is set, the security descriptor instead follows the relative format. Rather than referencing its values using absolute memory addresses, a relative security descriptor stores these locations as positive offsets relative to the start of its header. <a href="chapter5.xhtml#fig5-4">Figure 5-4</a> shows how a relative security descriptor is constructed.</p>
<figure class="IMG"><img alt="" class="img7" height="824" id="fig5-4" src="../images/Figure5-4.jpg" width="827"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 5-4: The structure of a relative security descriptor</samp></p></figcaption>
</figure>
<p class="TX"><span aria-label=" Page 151. " epub:type="pagebreak" id="pg_151" role="doc-pagebreak"></span>These values are stored in contiguous memory. The ACL format, which we’ll explore in the following section, is already a relative format and therefore doesn’t require any special handling when used in a relative security descriptor. Each offset is always 32 bits long, regardless of the system’s bit size. If an offset is set to <samp class="SANS_TheSansMonoCd_W5Regular_11">0</samp>, the value doesn’t exist, as in the case of NULL for an absolute security descriptor.</p>
<p class="TX">The main advantage of an absolute security descriptor is that you can easily update its individual components. For example, to replace the owner SID, you’d allocate a new SID in memory and assign its memory address to the owner pointer. In comparison, modifying a relative security descriptor in the same way might require adjusting its allocated memory if the new owner SID structure is larger than the old one.</p>
<p class="TX">On the other hand, the big advantage of a relative security descriptor is that it can be built in a single contiguous block of memory. This allows you to serialize the security descriptor to a persistent format, such as a file or a registry key. When you’re trying to determine the security of a resource, you might need to extract its security descriptor from memory or a persistent store. By understanding the two formats, you can determine how to read the security descriptor into something you can view or manipulate.</p>
<p class="TX">Most APIs and system calls accept either security descriptor format, determining how to handle a security descriptor automatically by checking the value of the <samp class="SANS_TheSansMonoCd_W5Regular_11">SelfRelative</samp> flag. However, you’ll find some exceptions in which an API takes only one format or another; in that case, if you pass the API a security descriptor in the wrong format, you’ll typically receive an error such as <samp class="SANS_TheSansMonoCd_W5Regular_11">STATUS_INVALID_SECURITY_DESCR</samp>. Security descriptors returned from an API will almost always be in relative format due to the simplicity of their memory management. The system provides the APIs <samp class="SANS_TheSansMonoCd_W5Regular_11">RtlAbsoluteToSelfRelativeSD</samp> and <samp class="SANS_TheSansMonoCd_W5Regular_11">RtlSelfRelativeToAbsoluteSD</samp> to convert between the two formats if needed.</p>
<p class="TX">The PowerShell module handles all security descriptors using a <samp class="SANS_TheSansMonoCd_W5Regular_11">SecurityDescriptor</samp> object, regardless of format. This object is written in .NET and converts to a relative or absolute security descriptor only when it’s required to interact with native code. You can determine whether a <samp class="SANS_TheSansMonoCd_W5Regular_11">SecurityDescriptor</samp> object was generated from a relative security descriptor by inspecting the <samp class="SANS_TheSansMonoCd_W5Regular_11">SelfRelative</samp> property.</p>
</section>
<section aria-labelledby="sec4" epub:type="division">
<h3 class="H1" id="sec4"><span id="h1-47"></span><samp class="SANS_Futura_Std_Bold_B_11">Access Control List Headers and Entries</samp></h3>
<p class="TNI1">The DACL and SACL make up most of the data in a security descriptor. While these elements have different purposes, they share the same basic structure. In this section we’ll cover how they’re arranged in memory, leaving the details of how they contribute to the access check process for <span class="Xref"><a href="chapter7.xhtml">Chapter 7</a></span>.</p>
<section aria-labelledby="sec5" epub:type="division">
<h4 class="H2" id="sec5"><span id="h2-58"></span><span aria-label=" Page 152. " epub:type="pagebreak" id="pg_152" role="doc-pagebreak"></span><samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">The Header</samp></h4>
<p class="TNI1">All ACLs consist of an ACL header followed by a list of zero or more ACEs in one contiguous block of memory. <a href="chapter5.xhtml#fig5-5">Figure 5-5</a> shows this top-level format.</p>
<figure class="IMG"><img alt="" class="img5" height="742" id="fig5-5" src="../images/Figure5-5.jpg" width="733"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 5-5: A top-level overview of the ACL structure</samp></p></figcaption>
</figure>
<p class="TX">The ACL header contains a revision, the total size of the ACL in bytes, and the number of ACE entries that follow the header. <a href="chapter5.xhtml#fig5-6">Figure 5-6</a> shows the header structure.</p>
<figure class="IMG"><img alt="" class="img5" height="503" id="fig5-6" src="../images/Figure5-6.jpg" width="626"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 5-6: The structure of the ACL header</samp></p></figcaption>
</figure>
<p class="TX">The ACL header also contains two reserved fields, <samp class="SANS_TheSansMonoCd_W5Regular_11">Sbz1</samp> and <samp class="SANS_TheSansMonoCd_W5Regular_11">Sbz2</samp>, both of which should always be <samp class="SANS_TheSansMonoCd_W5Regular_11">0</samp>. They serve no purpose in modern versions of Windows and are there in case the ACL structure needs to be extended. Currently, the <samp class="SANS_TheSansMonoCd_W5Regular_11">Revision</samp> field can have one of three values, which determine the ACL’s valid ACEs. If an ACL uses an ACE that the revision doesn’t <span aria-label=" Page 153. " epub:type="pagebreak" id="pg_153" role="doc-pagebreak"></span>support, the ACL won’t be considered valid. Windows supports the following revisions:</p>
<p class="RunInPara1"><b>Default    </b>The default ACL revision. Supports all the basic ACE types, such as <samp class="SANS_TheSansMonoCd_W5Regular_11">Allowed</samp> and <samp class="SANS_TheSansMonoCd_W5Regular_11">Denied</samp>. Specified with the <samp class="SANS_TheSansMonoCd_W5Regular_11">Revision</samp> value <samp class="SANS_TheSansMonoCd_W5Regular_11">2</samp>.</p>
<p class="RunInPara"><b>Compound    </b>Adds support for compound ACEs to the default ACL revision. Specified with the <samp class="SANS_TheSansMonoCd_W5Regular_11">Revision</samp> value <samp class="SANS_TheSansMonoCd_W5Regular_11">3</samp>.</p>
<p class="RunInPara2"><b>Object    </b>Adds support for object ACEs to the compound. Specified with the <samp class="SANS_TheSansMonoCd_W5Regular_11">Revision</samp> value <samp class="SANS_TheSansMonoCd_W5Regular_11">4</samp>.</p>
</section>
<section aria-labelledby="sec6" epub:type="division">
<h4 class="H2" id="sec6"><span id="h2-59"></span><samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">The ACE List</samp></h4>
<p class="TNI1">Following the ACL header is the list of ACEs, which determines what access the SID has. ACEs are of variable length but always start with a header that contains the ACE type, additional flags, and the ACE’s total size. The header is followed by data specific to the ACE type. <a href="chapter5.xhtml#fig5-7">Figure 5-7</a> shows this structure.</p>
<figure class="IMG"><img alt="" class="img5" height="544" id="fig5-7" src="../images/Figure5-7.jpg" width="722"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 5-7: The ACE structure</samp></p></figcaption>
</figure>
<p class="TX">The ACE header is common to all ACE types. This allows an application to safely access the header when processing an ACL. The ACE type value can then be used to determine the exact format of the ACE’s type-specific data. If the application doesn’t understand the ACE type, it can use the size field to skip the ACE entirely (we’ll discuss how types affect access checking in <span class="Xref"><a href="chapter7.xhtml">Chapter 7</a></span>).</p>
<p class="TX"><a href="chapter5.xhtml#tab5-3">Table 5-3</a> lists the supported ACE types, the minimum ACE revision they are valid in, and whether they are valid in the DACL or the SACL.</p>
<span aria-label=" Page 154. " epub:type="pagebreak" id="pg_154" role="doc-pagebreak"></span>
<table class="Basic-Table">
<caption><p class="TT" id="tab5-3"><span class="Heavy"><samp class="SANS_Futura_Std_Heavy_B_11">Table 5-3:</samp></span> <samp class="SANS_Futura_Std_Book_11">Supported ACE Types, Minimum ACL Revisions, and Locations</samp></p></caption>
<thead>
<tr>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">ACE type</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Value</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Minimum revision</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">ACL</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Description</samp></p></th>
</tr>
</thead>
<tbody>
<tr>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Allowed</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x0</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Default</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">DACL</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Grants access to a resource</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Denied</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x1</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Default</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">DACL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Denies access to a resource</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Audit</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x2</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Default</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">SACL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Audits access to a resource</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Alarm</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x3</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Default</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">SACL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Alarms upon access to a resource; unused</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AllowedCompound</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x4</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Compound</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">DACL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Grants access to a resource during impersonation</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AllowedObject</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x5</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Object</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">DACL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Grants access to a resource with an object type</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">DeniedObject</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x6</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Object</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">DACL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Denies access to a resource with an object type</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AuditObject</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x7</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Object</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">SACL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Audits access to a resource with an object type</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AlarmObject</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x8</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Object</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">SACL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Alarms upon access with an object type; unused</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AllowedCallback</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x9</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Default</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">DACL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Grants access to a resource with a callback</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">DeniedCallback</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0xA</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Default</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">DACL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Denies access to a resource with a callback</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AllowedCallbackObject</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0xB</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Object</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">DACL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Grants access with a callback and an object type</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">DeniedCallbackObject</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0xC</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Object</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">DACL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Denies access with a callback and an object type</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AuditCallback</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0xD</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Default</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">SACL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Audits access with a callback</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AlarmCallback</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0xE</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Default</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">SACL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Alarms upon access with a callback; unused</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AuditCallbackObject</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0xF</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Object</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">SACL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Audits access with a callback and an object type</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AlarmCallbackObject</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x10</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Object</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">SACL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Alarms upon access with a callback and an object type; unused</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">MandatoryLabel</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x11</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Default</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">SACL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Specifies a mandatory label</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">ResourceAttribute</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x12</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Default</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">SACL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Specifies attributes for the resource</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">ScopedPolicyId</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x13</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Default</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">SACL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Specifies a central access policy ID for the resource</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">ProcessTrustLabel</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x14</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Default</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">SACL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Specifies a process trust label to limit resource access</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AccessFilter</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x15</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Default</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">SACL</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Specifies an access filter for the resource</samp></p></td>
</tr>
</tbody>
</table>
<p class="TX">While Windows officially supports all these ACE types, the kernel does not use the <samp class="SANS_TheSansMonoCd_W5Regular_11">Alarm</samp> types. User applications can specify their own ACE types, but various APIs in user and kernel mode check for valid types and will generate an error if the ACE type isn’t known.</p>
<p class="TX">An ACE’s type-specific data falls primarily into one of three formats: normal ACEs, such as <samp class="SANS_TheSansMonoCd_W5Regular_11">Allowed</samp> and <samp class="SANS_TheSansMonoCd_W5Regular_11">Denied</samp>; compound ACEs; and object ACEs. A <i>normal ACE</i> contains the following fields after the header, with the field’s size indicated in parentheses:</p>
<p class="RunInPara1"><span aria-label=" Page 155. " epub:type="pagebreak" id="pg_155" role="doc-pagebreak"></span><b>Access mask (32-bit)    </b>The access mask to be granted or denied based on the ACE type</p>
<p class="RunInPara2"><b>SID (variable size)    </b>The SID, in the binary format described earlier in this chapter</p>
<p class="TX"><i>Compound ACEs</i> are for use during impersonation. These ACEs can grant access to both the impersonated caller and the process user at the same time. The only valid type for them is <samp class="SANS_TheSansMonoCd_W5Regular_11">AllowedCompound</samp>. Even though the latest versions of Windows still support compound ACEs, they’re effectively undocumented and presumably deprecated. I’ve included them in this book for completeness. Their format is as follows:</p>
<p class="RunInPara1"><b>Access mask (32-bit)    </b>The access mask to be granted</p>
<p class="RunInPara"><b>Compound ACE type (16-bit)    </b>Set to <samp class="SANS_TheSansMonoCd_W5Regular_11">1</samp>, which means the ACE is used for impersonation</p>
<p class="RunInPara"><b>Reserved (16-bit)    </b>Always <samp class="SANS_TheSansMonoCd_W5Regular_11">0</samp></p>
<p class="RunInPara"><b>Server SID (variable size)    </b>The server SID in binary format; matches the service user</p>
<p class="RunInPara2"><b>SID (variable size)    </b>The SID in a binary format; matches the impersonated user</p>
<p class="TX">Microsoft introduced the <i>object ACE</i> format to support access control for Active Directory Domain Services. Active Directory uses a 128-bit GUID to represent a directory service object type; the object ACE determines access for specific types of objects, such as computers or users. For example, using a single security descriptor, a directory could grant a SID the access needed to create one type of object but not another. The object ACE format is as follows:</p>
<p class="RunInPara1"><b>Access mask (32-bit)    </b>The access mask to be granted or denied based on the ACE type</p>
<p class="RunInPara"><b>Flags (32-bit)    </b>Used to indicate which of the following GUIDs are present</p>
<p class="RunInPara"><b>Object type (16-byte)    </b>The <samp class="SANS_TheSansMonoCd_W5Regular_11">ObjectType</samp> GUID; present only if the flag in bit 0 is set</p>
<p class="RunInPara"><b>Inherited object type (16-byte)    </b>The inherited object GUID; present only if the flag in bit 1 is set</p>
<p class="RunInPara2"><b>SID (variable size)    </b>The SID in a binary format</p>
<p class="TX">ACEs can be larger than their types’ defined structures, and they may use additional space to stored unstructured data. Most commonly, they use this unstructured data for the callback ACE types, such as <samp class="SANS_TheSansMonoCd_W5Regular_11">AllowedCallback</samp>, which defines a conditional expression that determines whether the ACE should be active during an access check. We can inspect the data that would be generated from a conditional expression using the <samp class="SANS_TheSansMonoCd_W5Regular_11">ConvertFrom -NtAceCondition</samp> PowerShell command, as shown in <a href="chapter5.xhtml#Lis5-5">Listing 5-5</a>.</p>
<span id="Lis5-5"></span><pre><code><span aria-label=" Page 156. " epub:type="pagebreak" id="pg_156" role="doc-pagebreak"></span>PS&gt; <b>ConvertFrom-NtAceCondition 'WIN://TokenId == "XYZ"' | Out-HexDump -ShowAll</b>
          00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F  - 0123456789ABCDEF
-----------------------------------------------------------------------------
00000000: 61 72 74 78 F8 1A 00 00 00 57 00 49 00 4E 00 3A  - artx.....W.I.N.:
00000010: 00 2F 00 2F 00 54 00 6F 00 6B 00 65 00 6E 00 49  - ././.T.o.k.e.n.I
00000020: 00 64 00 10 06 00 00 00 58 00 59 00 5A 00 80 00  - .d......X.Y.Z...
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing 5-5: Parsing a conditional expression and displaying binary data</span></p>
<p class="TX">We refer to these ACEs as <i>callback ACEs</i> because prior to Windows 8 an application needed to call the <samp class="SANS_TheSansMonoCd_W5Regular_11">AuthzAccessCheck</samp> API to handle them. The API accepted a callback function that would be invoked to determine whether to include a callback ACE in the access check. Since Windows 8, the kernel access check has built-in support for conditional ACEs in the format shown in <a href="chapter5.xhtml#Lis5-5">Listing 5-5</a>, although user applications are free to specify their own formats and handle these ACEs manually.</p>
<p class="TX">The primary use of the ACE flags is to specify inheritance rules for the ACE. <a href="chapter5.xhtml#tab5-4">Table 5-4</a> shows the defined ACE flags.</p>
<table class="Basic-Table">
<caption><p class="TT" id="tab5-4"><span class="Heavy"><samp class="SANS_Futura_Std_Heavy_B_11">Table 5-4:</samp></span> <samp class="SANS_Futura_Std_Book_11">ACE Flags</samp></p></caption>
<thead>
<tr>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">ACE flag</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Value</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Description</samp></p></th>
</tr>
</thead>
<tbody>
<tr>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">ObjectInherit</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x1</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">The ACE can be inherited by an object.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">ContainerInherit</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x2</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">The ACE can be inherited by a container.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">NoPropagateInherit</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x4</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">The ACE’s inheritance flags are not propagated to children.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">InheritOnly</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x8</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">The ACE is used only for inheritance and not for access checks.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Inherited</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x10</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">The ACE was inherited from a parent container.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Critical</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x20</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">The ACE is critical and can’t be removed. Applies only to</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">Allowed</samp> <samp class="SANS_Futura_Std_Book_11">ACEs.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">SuccessfulAccess</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x40</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">An audit event should be generated for a successful access.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">FailedAccess</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x80</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">An audit event should be generated for a failed access.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">TrustProtected</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x40</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">When used with an</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">AccessFilter</samp> <samp class="SANS_Futura_Std_Book_11">ACE, this flag prevents modification.</samp></p></td>
</tr>
</tbody>
</table>
<p class="TX">The inheritance flags take up only the lower 5 bits, leaving the top 3 bits for ACE-specific flags.</p>
</section>
</section>
<section aria-labelledby="sec7" epub:type="division">
<h3 class="H1" id="sec7"><span id="h1-48"></span><samp class="SANS_Futura_Std_Bold_B_11">Constructing and Manipulating Security Descriptors</samp></h3>
<p class="TNI1">Now that you’re familiar with the structure of a security descriptor, let’s look at how to construct and manipulate them using PowerShell. By far the most common reason to do this is to view a security descriptor’s contents so you can understand the access applied to a resource. Another important <span aria-label=" Page 157. " epub:type="pagebreak" id="pg_157" role="doc-pagebreak"></span>use case is if you need to construct a security descriptor to lock down a resource. The PowerShell module used in this book aims to make constructing and viewing security descriptors as simple as possible.</p>
<section aria-labelledby="sec8" epub:type="division">
<h4 class="H2" id="sec8"><span id="h2-60"></span><samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">Creating a New Security Descriptor</samp></h4>
<p class="TNI1">To create a new security descriptor, you can use the <samp class="SANS_TheSansMonoCd_W5Regular_11">New-NtSecurityDescriptor</samp> command. By default, it creates a new <samp class="SANS_TheSansMonoCd_W5Regular_11">SecurityDescriptor</samp> object with no owner, group, DACL, or SACL set. You can use the command’s parameters to add these parts of the security descriptor, as shown in <a href="chapter5.xhtml#Lis5-6">Listing 5-6</a>.</p>
<span id="Lis5-6"></span><pre><code>PS&gt; <b>$world = Get-NtSid -KnownSid World</b>
PS&gt; <b>$sd = New-NtSecurityDescriptor -Owner $world -Group $world -Type File</b>
PS&gt; <b>$sd | Format-Table</b>
Owner    DACL ACE Count SACL ACE Count Integrity Level
-----    -------------- -------------- ---------------
Everyone NONE           NONE           NONE
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing 5-6: Creating a new security descriptor with a specified owner</span></p>
<p class="TX">We first get the SID for the <i>World</i> group. When calling <samp class="SANS_TheSansMonoCd_W5Regular_11">New-NtSecurityDescriptor</samp> to create a new security descriptor, we use this SID to specify its <samp class="SANS_TheSansMonoCd_W5Regular_11">Owner</samp> and <samp class="SANS_TheSansMonoCd_W5Regular_11">Group</samp>. We also specify the name of the kernel object type this security descriptor will be associated with; this step makes some of the later commands easier to use. In this case, we’ll assume it’s a <samp class="SANS_TheSansMonoCd_W5Regular_11">File</samp> object’s security descriptor.</p>
<p class="TX">We then display the security descriptor, formatting the output as a table. As you can see, the <samp class="SANS_TheSansMonoCd_W5Regular_11">Owner</samp> field is set to <samp class="SANS_TheSansMonoCd_W5Regular_11">Everyone</samp>. The <samp class="SANS_TheSansMonoCd_W5Regular_11">Group</samp> value isn’t printed by default, as it’s not as important. Neither a DACL nor a SACL is currently present in the security descriptor, and there is no integrity level specified.</p>
<p class="TX">To add some ACEs, we can use the <samp class="SANS_TheSansMonoCd_W5Regular_11">Add-NtSecurityDescriptorAce</samp> command. For normal ACEs, we need to specify the ACE type, the SID, and the access mask. Optionally, we can also specify the ACE flags. The script in <a href="chapter5.xhtml#Lis5-7">Listing 5-7</a> adds some ACEs to our new security descriptor.</p>
<span id="Lis5-7"></span><pre><code><span aria-label="annotation1" class="CodeAnnotationHang1">❶</span> PS&gt; <b>$user = Get-NtSid</b>
<span aria-label="annotation2" class="CodeAnnotationHang1">❷</span> PS&gt; <b>Add-NtSecurityDescriptorAce $sd -Sid $user -Access WriteData, ReadData</b>
PS&gt; <b>Add-NtSecurityDescriptorAce $sd -KnownSid Anonymous -Access GenericAll</b>
<b>-Type Denied</b>
PS&gt; <b>Add-NtSecurityDescriptorAce $sd -Name "Everyone" -Access ReadData</b>
<span aria-label="annotation3" class="CodeAnnotationHang1">❸</span> PS&gt; <b>Add-NtSecurityDescriptorAce $sd -KnownSid World -Access Delete</b>
<b>-Type Audit -Flags FailedAccess</b>
<span aria-label="annotation4" class="CodeAnnotationHang1">❹</span> PS&gt; <b>Set-NtSecurityDescriptorIntegrityLevel $sd Low</b>
<span aria-label="annotation5" class="CodeAnnotationHang1">❺</span> PS&gt; <b>Set-NtSecurityDescriptorControl $sd DaclAutoInherited, SaclProtected</b>
<span aria-label="annotation6" class="CodeAnnotationHang1">❻</span> PS&gt; <b>$sd | Format-Table</b>
Owner    DACL ACE Count SACL ACE Count Integrity Level
-----    -------------- -------------- ---------------
Everyone 3              2              Low

<span aria-label=" Page 158. " epub:type="pagebreak" id="pg_158" role="doc-pagebreak"></span><span aria-label="annotation7" class="CodeAnnotationHang1">❼</span> PS&gt; <b>Get-NtSecurityDescriptorControl $sd</b>
DaclPresent, SaclPresent, DaclAutoInherited, SaclProtected

<span aria-label="annotation8" class="CodeAnnotationHang1">❽</span> PS&gt; <b>Get-NtSecurityDescriptorDacl $sd | Format-Table</b>
Type    User                         Flags Mask
----    ----                         ----- ----
Allowed GRAPHITE\user                None  00000003
Denied  NT AUTHORITY\ANONYMOUS LOGON None  10000000
Allowed Everyone                     None  00000001

<span aria-label="annotation9" class="CodeAnnotationHang1">❾</span> PS&gt; <b>Get-NtSecurityDescriptorSacl $sd | Format-Table</b>
Type           User                                Flags        Mask
----           ----                                -----        ----
Audit          Everyone                            FailedAccess 00010000
MandatoryLabel Mandatory Label\Low Mandatory Level None         00000001
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing 5-7: Adding ACEs to the new security descriptor</span></p>
<p class="TX">We start by getting the SID of the current user with <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-NtSid</samp> <span aria-label="annotation1" class="CodeAnnotationCode">❶</span>. We use this SID to add a new <samp class="SANS_TheSansMonoCd_W5Regular_11">Allowed</samp> ACE to the DACL <span aria-label="annotation2" class="CodeAnnotationCode">❷</span>. We also add a <samp class="SANS_TheSansMonoCd_W5Regular_11">Denied</samp> ACE for the anonymous user by specifying the <samp class="SANS_TheSansMonoCd_W5Regular_11">Type</samp> parameter, followed by another <samp class="SANS_TheSansMonoCd_W5Regular_11">Allowed</samp> ACE for the <i>Everyone</i> group. We then modify the SACL to add an audit ACE <span aria-label="annotation3" class="CodeAnnotationCode">❸</span> and set the mandatory label to the <samp class="SANS_TheSansMonoCd_W5Regular_11">Low</samp> integrity level <span aria-label="annotation4" class="CodeAnnotationCode">❹</span>. To finish creating the security descriptor, we set the <samp class="SANS_TheSansMonoCd_W5Regular_11">DaclAutoInherited</samp> and <samp class="SANS_TheSansMonoCd_W5Regular_11">SaclProtected</samp> control flags <span aria-label="annotation5" class="CodeAnnotationCode">❺</span>.</p>
<p class="TX">We can now print details about the security descriptor we’ve just created. Displaying the security descriptor <span aria-label="annotation6" class="CodeAnnotationCode">❻</span> shows that the DACL now contains three ACEs and the two SACLs, and the integrity level is <samp class="SANS_TheSansMonoCd_W5Regular_11">Low</samp>. We also display the control flags <span aria-label="annotation7" class="CodeAnnotationCode">❼</span> and the lists of ACEs in the DACL <span aria-label="annotation8" class="CodeAnnotationCode">❽</span> and SACL <span aria-label="annotation9" class="CodeAnnotationCode">❾</span>.</p>
</section>
<section aria-labelledby="sec9" epub:type="division">
<h4 class="H2" id="sec9"><span id="h2-61"></span><samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">Ordering the ACEs</samp></h4>
<p class="TNI1">Because of how access checking works, there is a canonical ordering to the ACEs in an ACL. For example, all <samp class="SANS_TheSansMonoCd_W5Regular_11">Denied</samp> ACEs should come before any <samp class="SANS_TheSansMonoCd_W5Regular_11">Allowed</samp> ACEs, as otherwise the system might grant access to a resource improperly, based on which ACEs come first. The SRM doesn’t enforce this canonical ordering; it trusts that any application has correctly ordered the ACEs before passing them for an access check. ACLs should order their ACEs according to the following rules:</p>
<p class="ListNumber1">  1.  All <samp class="SANS_TheSansMonoCd_W5Regular_11">Denied</samp>-type ACEs must come before <samp class="SANS_TheSansMonoCd_W5Regular_11">Allowed</samp> types.</p>
<p class="ListNumber">  2.  The <samp class="SANS_TheSansMonoCd_W5Regular_11">Allowed</samp> ACEs must come before <samp class="SANS_TheSansMonoCd_W5Regular_11">Allowed</samp> object ACEs.</p>
<p class="ListNumber">  3.  The <samp class="SANS_TheSansMonoCd_W5Regular_11">Denied</samp> ACEs must come before <samp class="SANS_TheSansMonoCd_W5Regular_11">Denied</samp> object ACEs.</p>
<p class="ListNumber2">  4.  All non-inherited ACEs must come before ACEs with the <samp class="SANS_TheSansMonoCd_W5Regular_11">Inherited</samp> flag set.</p>
<p class="TX">In <a href="chapter5.xhtml#Lis5-7">Listing 5-7</a>, we added a <samp class="SANS_TheSansMonoCd_W5Regular_11">Denied</samp> ACE to the DACL after we added an <samp class="SANS_TheSansMonoCd_W5Regular_11">Allowed</samp> ACE, failing the first order rule. We can ensure the DACL is canonicalized by using the <samp class="SANS_TheSansMonoCd_W5Regular_11">Edit-NtSecurity</samp> command with the <samp class="SANS_TheSansMonoCd_W5Regular_11">CanonicalizeDacl</samp> <span aria-label=" Page 159. " epub:type="pagebreak" id="pg_159" role="doc-pagebreak"></span>parameter. We can also test whether a DACL is already canonical by using the <samp class="SANS_TheSansMonoCd_W5Regular_11">Test-NtSecurityDescriptor</samp> PowerShell command with the <samp class="SANS_TheSansMonoCd_W5Regular_11">DaclCanonical</samp> parameter. <a href="chapter5.xhtml#Lis5-8">Listing 5-8</a> illustrates the use of both commands.</p>
<span id="Lis5-8"></span><pre><code>PS&gt; <b>Test-NtSecurityDescriptor $sd -DaclCanonical</b>
False

PS&gt; <b>Edit-NtSecurityDescriptor $sd -CanonicalizeDacl</b>
PS&gt; <b>Test-NtSecurityDescriptor $sd -DaclCanonical</b>
True

PS&gt; <b>Get-NtSecurityDescriptorDacl $sd | Format-Table</b>
Type    User                         Flags Mask
----    ----                         ----- ----
Denied  NT AUTHORITY\ANONYMOUS LOGON None  10000000
Allowed GRAPHITE\user                None  00000003
Allowed Everyone                     None  00000001
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing 5-8: Canonicalizing the DACL</span></p>
<p class="TX">If you compare the list of ACEs in <a href="chapter5.xhtml#Lis5-8">Listing 5-8</a> with the list in <a href="chapter5.xhtml#Lis5-7">Listing 5-7</a>, you’ll notice that the <samp class="SANS_TheSansMonoCd_W5Regular_11">Denied</samp> ACE has been moved from the middle to the start of the ACL. This ensures that it will be processed before any <samp class="SANS_TheSansMonoCd_W5Regular_11">Allowed</samp> ACEs.</p>
</section>
<section aria-labelledby="sec10" epub:type="division">
<h4 class="H2" id="sec10"><span id="h2-62"></span><samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">Formatting Security Descriptors</samp></h4>
<p class="TNI1">You can print the values in the security descriptor manually, through the <samp class="SANS_TheSansMonoCd_W5Regular_11">Format-Table</samp> command, but this is time-consuming. Another problem with manual formatting is that the access masks won’t be decoded, so instead of <samp class="SANS_TheSansMonoCd_W5Regular_11">ReadData</samp>, for example, you’ll see <samp class="SANS_TheSansMonoCd_W5Regular_11">00000001</samp>. It would be nice to have a simple way of printing out the details of a security descriptor and formatting them based on the object type. That’s what <samp class="SANS_TheSansMonoCd_W5Regular_11">Format-NtSecurityDescriptor</samp> is for. You can pass it a security descriptor, and the command will print it to the console. <a href="chapter5.xhtml#Lis5-9">Listing 5-9</a> provides an example.</p>
<span id="Lis5-9"></span><pre><code>PS&gt; <b>Format-NtSecurityDescriptor $sd -ShowAll</b>
Type: File
Control: DaclPresent, SaclPresent

&lt;Owner&gt;
 - Name  : Everyone
 - Sid   : S-1-1-0

&lt;Group&gt;
 - Name  : Everyone
 - Sid   : S-1-1-0

&lt;DACL&gt; (Auto Inherited)
 - Type  : Denied
 - Name  : NT AUTHORITY\ANONYMOUS LOGON
 - SID   : S-1-5-7
 - Mask  : 0x10000000
<span aria-label=" Page 160. " epub:type="pagebreak" id="pg_160" role="doc-pagebreak"></span> - Access: GenericAll
 - Flags : None

 - Type  : Allowed
 - Name  : GRAPHITE\user
 - SID   : S-1-5-21-2318445812-3516008893-216915059-1002
 - Mask  : 0x00000003
 - Access: ReadData|WriteData
 - Flags : None

 - Type  : Allowed
 - Name  : Everyone
 - SID   : S-1-1-0
 - Mask  : 0x00000001
 - Access: ReadData
 - Flags : None

&lt;SACL&gt; (Protected)
 - Type  : Audit
 - Name  : Everyone
 - SID   : S-1-1-0
 - Mask  : 0x00010000
 - Access: Delete
 - Flags : FailedAccess

&lt;Mandatory Label&gt;
 - Type  : MandatoryLabel
 - Name  : Mandatory Label\Low Mandatory Level
 - SID   : S-1-16-4096
 - Mask  : 0x00000001
 - Policy: NoWriteUp
 - Flags : None
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing 5-9: Displaying the security descriptor</span></p>
<p class="TX">We pass the <samp class="SANS_TheSansMonoCd_W5Regular_11">ShowAll</samp> parameter to <samp class="SANS_TheSansMonoCd_W5Regular_11">Format-NtSecurityDescriptor</samp> to ensure that it displays the entire contents of the security descriptor; by default it won’t output the SACL or less common ACEs, such as <samp class="SANS_TheSansMonoCd_W5Regular_11">ResourceAttribute</samp>. Note that the output kernel object type matches the <samp class="SANS_TheSansMonoCd_W5Regular_11">File</samp> type we specified when creating the security descriptor in <a href="chapter5.xhtml#Lis5-6">Listing 5-6</a>. Specifying the kernel object type allows the formatter to print the decoded access mask for the type rather than a generic hex value.</p>
<p class="TX">The next line in the output shows the current control flags. These are calculated on the fly based on the current state of the security descriptor; later, we’ll discuss how to change these control flags to change the security descriptor’s behavior. The control flags are followed by the owner and group SIDs and the DACL, which account for most of the output. Any DACL-specific flags appear next to the header; in this case, these indicate that we set the <samp class="SANS_TheSansMonoCd_W5Regular_11">DaclAutoInherited</samp> flag. Next, the output lists each of the ACEs in the ACL in order, starting with the type of ACE. Because the command knows the object type, it prints the decoded access mask for the type as well as the original access mask in hexadecimal.</p>
<p class="TX"><span aria-label=" Page 161. " epub:type="pagebreak" id="pg_161" role="doc-pagebreak"></span>Next is the SACL, which shows our single audit ACE as well as the <samp class="SANS_TheSansMonoCd_W5Regular_11">SaclProtected</samp> flag. The final component shown is the mandatory label. The access mask for a mandatory label is the mandatory policy, and it’s decoded differently from the rest of the ACEs that use the type-specific access rights. The mandatory policy can be set to one or more of the bit flags shown in <a href="chapter5.xhtml#tab5-5">Table 5-5</a>.</p>
<table class="Basic-Table">
<caption><p class="TT" id="tab5-5"><span class="Heavy"><samp class="SANS_Futura_Std_Heavy_B_11">Table 5-5:</samp></span> <samp class="SANS_Futura_Std_Book_11">Mandatory Policy Values</samp></p></caption>
<thead>
<tr>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Name</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Value</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Description</samp></p></th>
</tr>
</thead>
<tbody>
<tr>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">NoWriteUp</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00000001</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">A lower integrity level caller can’t write to this resource.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">NoReadUp</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00000002</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">A lower integrity level caller can’t read this resource.</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">NoExecuteUp</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00000004</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">A lower integrity level caller can’t execute this resource.</samp></p></td>
</tr>
</tbody>
</table>
<p class="TX">By default, <samp class="SANS_TheSansMonoCd_W5Regular_11">Format-NtSecurityDescriptor</samp> can be a bit verbose. To shorten its output, specify the <samp class="SANS_TheSansMonoCd_W5Regular_11">Summary</samp> parameter, which will remove as much data as possible while keeping the important information. <a href="chapter5.xhtml#Lis5-10">Listing 5-10</a> demonstrates.</p>
<span id="Lis5-10"></span><pre><code>PS&gt; <b>Format-NtSecurityDescriptor $sd -ShowAll -Summary</b>
&lt;Owner&gt; : Everyone
&lt;Group&gt; : Everyone
&lt;DACL&gt;
&lt;DACL&gt; (Auto Inherited)
NT AUTHORITY\ANONYMOUS LOGON: (Denied)(None)(GenericAll)
GRAPHITE\user: (Allowed)(None)(ReadData|WriteData)
Everyone: (Allowed)(None)(ReadData)
&lt;SACL&gt; (Protected)
Everyone: (Audit)(FailedAccess)(Delete)
&lt;Mandatory Label&gt;
Mandatory Label\Low Mandatory Level: (MandatoryLabel)(None)(NoWriteUp)
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing 5-10: Displaying the security descriptor in summary format</span></p>
<p class="TX">I mentioned in <span class="Xref"><a href="chapter2.xhtml">Chapter 2</a></span> that for ease of use the PowerShell module used in this book uses simple names for most common flags, but that you can display the full SDK names if you prefer (for example, to compare the output with native code). To display SDK names when viewing the contents of a security descriptor with <samp class="SANS_TheSansMonoCd_W5Regular_11">Format-NtSecurityDescriptor</samp>, use the <samp class="SANS_TheSansMonoCd_W5Regular_11">SDKName</samp> property, as shown in <a href="chapter5.xhtml#Lis5-11">Listing 5-11</a>.</p>
<span id="Lis5-11"></span><pre><code>PS&gt; <b>Format-NtSecurityDescriptor $sd -SDKName -SecurityInformation Dacl</b>
Type: File
Control: SE_DACL_PRESENT|SE_SACL_PRESENT|SE_DACL_AUTO_INHERITED|SE_SACL_PROTECTED
&lt;DACL&gt; (Auto Inherited)
 - Type  : ACCESS_DENIED_ACE_TYPE
 - Name  : NT AUTHORITY\ANONYMOUS LOGON
 - SID   : S-1-5-7
 - Mask  : 0x10000000
 - Access: GENERIC_ALL
 - Flags : NONE

<span aria-label=" Page 162. " epub:type="pagebreak" id="pg_162" role="doc-pagebreak"></span> - Type  : ACCESS_ALLOWED_ACE_TYPE
 - Name  : GRAPHITE\user
 - SID   : S-1-5-21-2318445812-3516008893-216915059-1002
 - Mask  : 0x00000003
 - Access: FILE_READ_DATA|FILE_WRITE_DATA
 - Flags : NONE

 - Type  : ACCESS_ALLOWED_ACE_TYPE
 - Name  : Everyone
 - SID   : S-1-1-0
 - Mask  : 0x00000001
 - Access: FILE_READ_DATA
 - Flags : NONE
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing 5-11: Formatting a security descriptor with SDK names</span></p>
<p class="TX">One quirk of <samp class="SANS_TheSansMonoCd_W5Regular_11">File</samp> objects is that their access masks have two naming conventions, one for files and one for directories. You can request that <samp class="SANS_TheSansMonoCd_W5Regular_11">Format-NtSecurityDescriptor</samp> print the directory version of the access mask by using the <samp class="SANS_TheSansMonoCd_W5Regular_11">Container</samp> parameter, or more generally, by setting the <samp class="SANS_TheSansMonoCd_W5Regular_11">Container</samp> property of the security descriptor object to <samp class="SANS_TheSansMonoCd_W5Regular_11">True</samp>. <a href="chapter5.xhtml#Lis5-12">Listing 5-12</a> shows the impact of setting the <samp class="SANS_TheSansMonoCd_W5Regular_11">Container</samp> parameter on the output.</p>
<span id="Lis5-12"></span><pre><code>PS&gt; <b>Format-NtSecurityDescriptor $sd -ShowAll -Summary -Container</b>
&lt;Owner&gt; : Everyone
&lt;Group&gt; : Everyone
&lt;DACL&gt;
NT AUTHORITY\ANONYMOUS LOGON: (Denied)(None)(GenericAll)
<span aria-label="annotation1" class="CodeAnnotationHang1">❶</span> GRAPHITE\user: (Allowed)(None)(ListDirectory|AddFile)
Everyone: (Allowed)(None)(ListDirectory)
<var>--snip--</var>
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing 5-12: Formatting the security descriptor as a container</span></p>
<p class="TX">Note how the output line changes from <samp class="SANS_TheSansMonoCd_W5Regular_11">ReadData|WriteData</samp> to <samp class="SANS_TheSansMonoCd_W5Regular_11">ListDirectory|AddFile</samp> <span aria-label="annotation1" class="CodeAnnotationCode">❶</span> when we format it as a container. The <samp class="SANS_TheSansMonoCd_W5Regular_11">File</samp> type is the only object type with this behavior in Windows. This is important to security, as you could easily misinterpret <samp class="SANS_TheSansMonoCd_W5Regular_11">File</samp> access rights if you formatted the security descriptor for a directory as a file, or vice versa.</p>
<p class="TX">If a GUI is more your thing, you can start a viewer using the following <samp class="SANS_TheSansMonoCd_W5Regular_11">Show-NtSecurityDescriptor</samp> command:</p>
<pre><code>PS&gt; <b>Show-NtSecurityDescriptor $sd</b>
</code></pre>
<p class="TX">Running the command should open the dialog shown in <a href="chapter5.xhtml#fig5-8">Figure 5-8</a>.</p>
<span aria-label=" Page 163. " epub:type="pagebreak" id="pg_163" role="doc-pagebreak"></span>
<figure class="IMG"><img alt="" class="img1" height="980" id="fig5-8" src="../images/Figure5-8.jpg" width="1688"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 5-8: A GUI displaying the security descriptor</samp></p></figcaption>
</figure>
<p class="TX">The dialog summarizes the security descriptor’s important data. At the top are the owner and group SIDs resolved into names, as well as the security descriptor’s integrity level and mandatory policy. These match the values we specified when creating the security descriptor. In the middle is the list of ACEs in the DACL (left) or SACL (right), depending on which tab you select, with the ACL flags at the top. Each entry in the list includes the type of ACE, the SID, the access mask in generic form, and the ACE flags. At the bottom is the decoded access. The list populates when you select an ACE in the ACL list.</p>
</section>
<section aria-labelledby="sec11" epub:type="division">
<h4 class="H2" id="sec11"><span id="h2-63"></span><samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">Converting to and from a Relative Security Descriptor</samp></h4>
<p class="TNI1">We can convert a security descriptor object to a byte array in the relative format using the <samp class="SANS_TheSansMonoCd_W5Regular_11">ConvertFrom-NtSecurityDescriptor</samp> command. We can then print its contents to see what the underlying structure really is, as shown in <a href="chapter5.xhtml#Lis5-13">Listing 5-13</a>.</p>
<span aria-label=" Page 164. " epub:type="pagebreak" id="pg_164" role="doc-pagebreak"></span>
<span id="Lis5-13"></span><pre><code>PS&gt; <b>$ba = ConvertFrom-NtSecurityDescriptor $sd</b>
PS&gt; <b>$ba | Out-HexDump -ShowAll</b>
          00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F  - 0123456789ABCDEF
-----------------------------------------------------------------------------
00000000: 01 00 14 A4 98 00 00 00 A4 00 00 00 14 00 00 00  - ................
00000010: 44 00 00 00 02 00 30 00 02 00 00 00 02 80 14 00  - D.....0.........
00000020: 00 00 01 00 01 01 00 00 00 00 00 01 00 00 00 00  - ................
00000030: 11 00 14 00 01 00 00 00 01 01 00 00 00 00 00 10  - ................
00000040: 00 10 00 00 02 00 54 00 03 00 00 00 01 00 14 00  - ......T.........
00000050: 00 00 00 10 01 01 00 00 00 00 00 05 07 00 00 00  - ................
00000060: 00 00 24 00 03 00 00 00 01 05 00 00 00 00 00 05  - ..$.............
00000070: 15 00 00 00 F4 AC 30 8A BD 09 92 D1 73 DC ED 0C  - ......0.....s...
00000080: EA 03 00 00 00 00 14 00 01 00 00 00 01 01 00 00  - ................
00000090: 00 00 00 01 00 00 00 00 01 01 00 00 00 00 00 01  - ................
000000A0: 00 00 00 00 01 01 00 00 00 00 00 01 00 00 00 00  - ................
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing 5-13: Converting an absolute security descriptor to relative format and displaying its bytes</span></p>
<p class="TX">We can convert the byte array back to a security descriptor object using <samp class="SANS_TheSansMonoCd_W5Regular_11">New-NtSecurityDescriptor</samp> and the <samp class="SANS_TheSansMonoCd_W5Regular_11">Byte</samp> parameter:</p>
<pre><code>PS&gt; <b>New-NtSecurityDescriptor -Byte $ba</b>
</code></pre>
<p class="TX">As an exercise, I’ll leave it to you to pick apart the hex output to find the various structures of the security descriptor based on the descriptions provided in this chapter. To get you started, <a href="chapter5.xhtml#fig5-9">Figure 5-9</a> highlights the major structures.</p>
<figure class="IMG"><img alt="" class="img1" height="957" id="fig5-9" src="../images/Figure5-9.jpg" width="1676"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 5-9: An outline of the major structures in the relative security descriptor hex output</samp></p></figcaption>
</figure>
<p class="TX">You’ll need to refer to the layout of the ACL and SID structures to manually decode the rest.</p>
</section>
</section>
<section aria-labelledby="sec12" epub:type="division">
<h3 class="H1" id="sec12"><span id="h1-49"></span><span aria-label=" Page 165. " epub:type="pagebreak" id="pg_165" role="doc-pagebreak"></span><samp class="SANS_Futura_Std_Bold_B_11">The Security Descriptor Definition Language</samp></h3>
<p class="TNI1">In <span class="Xref"><a href="chapter2.xhtml">Chapter 2</a></span>, we discussed the basics of the Security Descriptor Definition Language (SDDL) format for representing SIDs. The SDDL format can represent the entire security descriptor too. As the SDDL version of a security descriptor uses ASCII text, it’s somewhat human readable, and unlike the binary data shown in <a href="chapter5.xhtml#Lis5-13">Listing 5-13</a>, it can be easily copied. Because it’s common to see SDDL strings used throughout Windows, let’s look at how to represent a security descriptor in SDDL and how you can read it.</p>
<p class="TX">You can convert a security descriptor to SDDL format by specifying the <samp class="SANS_TheSansMonoCd_W5Regular_11">ToSddl</samp> parameter to <samp class="SANS_TheSansMonoCd_W5Regular_11">Format-NtSecurityDescriptor</samp>. This is demonstrated in <a href="chapter5.xhtml#Lis5-14">Listing 5-14</a>, where we pass the security descriptor we built in the previous section. You can also create a security descriptor from an SDDL string using <samp class="SANS_TheSansMonoCd_W5Regular_11">New-NtSecurityDescriptor</samp> with the <samp class="SANS_TheSansMonoCd_W5Regular_11">ToSddl</samp> parameter.</p>
<span id="Lis5-14"></span><pre><code>PS&gt; <b>$sddl =</b> <b>Format-NtSecurityDescriptor $sd -ToSddl -ShowAll</b>
PS&gt; <b>$sddl</b>
O:WDG:WDD:AI(D;;GA;;;AN)(A;;CCDC;;;S-1-5-21-2318445812-3516008893-216915059-
1002)(A;;CC;;;WD)S:P(AU;FA;SD;;;WD)(ML;;NW;;;LW)
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing 5-14: Converting a security descriptor to SDDL</span></p>
<p class="TX">The SDDL version of the security descriptor contains four optional components. You can identify the start of each component by looking for the following prefixes:</p>
<p class="RunInPara1"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">O:  </samp>Owner SID</p>
<p class="RunInPara"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">G:  </samp>Group SID</p>
<p class="RunInPara"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">D:  </samp>DACL</p>
<p class="RunInPara2"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">S:  </samp>SACL</p>
<p class="TX">In <a href="chapter5.xhtml#Lis5-15">Listing 5-15</a>, we split the output from <a href="chapter5.xhtml#Lis5-14">Listing 5-14</a> into its components to make it easier to read.</p>
<span id="Lis5-15"></span><pre><code>PS&gt; <b>$sddl -split "(?=O:)|(?=G:)|(?=D:)|(?=S:)|(?=\()"</b>
O:WD
G:WD
D:AI
  (D;;GA;;;AN)
  (A;;CCDC;;;S-1-5-21-2318445812-3516008893-216915059-1002)
  (A;;CC;;;WD)
S:P
  (AU;FA;SD;;;WD)
  (ML;;NW;;;LW)
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing 5-15: Splitting up the SDDL components</span></p>
<p class="TX">The first two lines represent the owner and group SIDs in SDDL format. You might notice that these don’t look like the SDDL SIDs we’re used to seeing, as they don’t start with <samp class="SANS_TheSansMonoCd_W5Regular_11">S-1-</samp>. That’s because these strings are two-character aliases that Windows uses for well-known SIDs to reduce the size <span aria-label=" Page 166. " epub:type="pagebreak" id="pg_166" role="doc-pagebreak"></span>of an SDDL string. For example, the owner string is <samp class="SANS_TheSansMonoCd_W5Regular_11">WD</samp>, which we could convert back to the full SID using <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-NtSid</samp> (<a href="chapter5.xhtml#Lis5-16">Listing 5-16</a>).</p>
<span id="Lis5-16"></span><pre><code>PS&gt; <b>Get-NtSid -Sddl "WD"</b>
Name     Sid
----     ---
Everyone S-1-1-0
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing 5-16: Converting an alias to a name and SID</span></p>
<p class="TX">As you can see, the <samp class="SANS_TheSansMonoCd_W5Regular_11">WD</samp> alias represents the <i>Everyone</i> group. <a href="chapter5.xhtml#tab5-6">Table 5-6</a> shows the aliases for a few well-known SIDs. You can find a more comprehensive list of all supported SDDL aliases in <span class="Xref"><a href="appendix-B.xhtml">Appendix B</a></span>.</p>
<table class="Basic-Table">
<caption><p class="TT" id="tab5-6"><span class="Heavy"><samp class="SANS_Futura_Std_Heavy_B_11">Table 5-6:</samp></span> <samp class="SANS_Futura_Std_Book_11">Well-Known SIDs and Their Aliases</samp></p></caption>
<thead>
<tr>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">SID alias</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Name</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">SDDL SID</samp></p></th>
</tr>
</thead>
<tbody>
<tr>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AU</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_Futura_Std_Book_Oblique_I_11">NT AUTHORITY\Authenticated Users</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">S-1-5-11</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">BA</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_Oblique_I_11">BUILTIN\Administrators</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">S-1-5-32-544</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">IU</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_Oblique_I_11">NT AUTHORITY\INTERACTIVE</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">S-1-5-4</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">SY</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_Oblique_I_11">NT AUTHORITY\SYSTEM</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">S-1-5-18</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">WD</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Everyone</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">S-1-1-0</samp></p></td>
</tr>
</tbody>
</table>
<p class="TX">If a SID has no alias, <samp class="SANS_TheSansMonoCd_W5Regular_11">Format-NtSecurityDescriptor</samp> will emit the SID in SDDL format, as shown in <a href="chapter5.xhtml#Lis5-15">Listing 5-15</a>. Even SIDs without aliases can have names defined by LSASS. For example, the SID in <a href="chapter5.xhtml#Lis5-15">Listing 5-15</a> belongs to the current user, as shown in <a href="chapter5.xhtml#Lis5-17">Listing 5-17</a>.</p>
<span id="Lis5-17"></span><pre><code>PS&gt; <b>Get-NtSid -Sddl "S-1-5-21-2318445812-3516008893-216915059-1002" -ToName</b>
GRAPHITE\user
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing 5-17: Looking up the name of the SID</span></p>
<p class="TX">Next in <a href="chapter5.xhtml#Lis5-15">Listing 5-15</a> is the representation of the DACL. After the <samp class="SANS_TheSansMonoCd_W5Regular_11">D:</samp> prefix, the ACL in SDDL format looks as follows:</p>
<pre><code>ACLFlags(ACE0)(ACE1)...(ACEn)
</code></pre>
<p class="TX">The ACL flags are optional; the DACL’s are set to <samp class="SANS_TheSansMonoCd_W5Regular_11">AI</samp> and the SACL’s are set to <samp class="SANS_TheSansMonoCd_W5Regular_11">P</samp>. These values map to security descriptor control flags and can be one or more of the strings in <a href="chapter5.xhtml#tab5-7">Table 5-7</a>.</p>
<table class="Basic-Table">
<caption><p class="TT" id="tab5-7"><span class="Heavy"><samp class="SANS_Futura_Std_Heavy_B_11">Table 5-7:</samp></span> <samp class="SANS_Futura_Std_Book_11">ACL Flag Strings Mapped to Security Descriptor Control Flags</samp></p></caption>
<thead>
<tr>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">ACL flag string</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">DACL control flag</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">SACL control flag</samp></p></th>
</tr>
</thead>
<tbody>
<tr>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">P</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">DaclProtected</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">SaclProtected</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AI</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">DaclAutoInherited</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">SaclAutoInherited</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AR</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">DaclAutoInheritReq</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">SaclAutoInheritReq</samp></p></td>
</tr>
</tbody>
</table>
<p class="TX"><span aria-label=" Page 167. " epub:type="pagebreak" id="pg_167" role="doc-pagebreak"></span>I’ll describe the uses of these three control flags in <span class="Xref"><a href="chapter6.xhtml">Chapter 6</a></span>. Each ACE is enclosed in parentheses and is made up of multiple strings separated by semicolons, following this general format:</p>
<pre><code>(Type;Flags;Access;ObjectType;InheritedObjectType;SID[;ExtraData])
</code></pre>
<p class="TX">The <samp class="SANS_TheSansMonoCd_W5Regular_11">Type</samp> is a short string that maps to an ACE type. <a href="chapter5.xhtml#tab5-8">Table 5-8</a> shows these mappings. Note that SDDL format does not support certain ACE types, so they’re omitted from the table.</p>
<table class="Basic-Table">
<caption><p class="TT" id="tab5-8"><span class="Heavy"><samp class="SANS_Futura_Std_Heavy_B_11">Table 5-8:</samp></span> <samp class="SANS_Futura_Std_Book_11">Mappings of Type Strings to ACE Types</samp></p></caption>
<thead>
<tr>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">ACE type string</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">ACE type</samp></p></th>
</tr>
</thead>
<tbody>
<tr>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">A</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Allowed</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">D</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Denied</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AU</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Audit</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Alarm</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">OA</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AllowedObject</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">OD</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">DeniedObject</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">OU</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AuditObject</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">OL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AlarmObject</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">XA</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AllowedCallback</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">XD</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">DeniedCallback</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">ZA</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AllowedCallbackObject</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">XU</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AuditCallback</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">ML</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">MandatoryLabel</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">RA</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">ResourceAttribute</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">SP</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">ScopedPolicyId</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">TL</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">ProcessTrustLabel</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">FL</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">AccessFilter</samp></p></td>
</tr>
</tbody>
</table>
<p class="TX">The next component is <samp class="SANS_TheSansMonoCd_W5Regular_11">Flags</samp>, which represents the ACE flags. The audit entry in the SACL from <a href="chapter5.xhtml#Lis5-15">Listing 5-15</a> shows the flag string <samp class="SANS_TheSansMonoCd_W5Regular_11">FA</samp>, which represents <samp class="SANS_TheSansMonoCd_W5Regular_11">FailedAccess</samp>. <a href="chapter5.xhtml#tab5-9">Table 5-9</a> shows other mappings.</p>
<p class="Anchor"><span aria-label=" Page 168. " epub:type="pagebreak" id="pg_168" role="doc-pagebreak"></span></p>
<table class="Basic-Table">
<caption><p class="TT" id="tab5-9"><span class="Heavy"><samp class="SANS_Futura_Std_Heavy_B_11">Table 5-9:</samp></span> <samp class="SANS_Futura_Std_Book_11">Mappings of Flag Strings to ACE Flags</samp></p></caption>
<thead>
<tr>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">ACE flag string</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">ACE flag</samp></p></th>
</tr>
</thead>
<tbody>
<tr>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">OI</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">ObjectInherit</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">CI</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">ContainerInherit</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">NP</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">NoPropagateInherit</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">IO</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">InheritOnly</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">ID</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Inherited</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">CR</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Critical</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">SA</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">SuccessfulAccess</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">FA</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">FailedAccess</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">TP</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">TrustProtected</samp></p></td>
</tr>
</tbody>
</table>
<p class="TX">Next is <samp class="SANS_TheSansMonoCd_W5Regular_11">Access</samp>, which represents the access mask in the ACE. This can be a number in hexadecimal (<samp class="SANS_TheSansMonoCd_W5Regular_11">0x1234</samp>), octal (<samp class="SANS_TheSansMonoCd_W5Regular_11">011064</samp>), or decimal (<samp class="SANS_TheSansMonoCd_W5Regular_11">4660</samp>) format, or a list of short access strings. If no string is specified, then an empty access mask is used. <a href="chapter5.xhtml#tab5-10">Table 5-10</a> shows the access strings.</p>
<table class="Basic-Table">
<caption><p class="TT" id="tab5-10"><span class="Heavy"><samp class="SANS_Futura_Std_Heavy_B_11">Table 5-10:</samp></span> <samp class="SANS_Futura_Std_Book_11">Mappings of Access Strings to Access Masks</samp></p></caption>
<thead>
<tr>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Access string</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Access name</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Access mask</samp></p></th>
</tr>
</thead>
<tbody>
<tr>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">GR</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Generic Read</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x80000000</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">GW</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Generic Write</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x40000000</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">GX</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Generic Execute</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x20000000</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">GA</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Generic All</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x10000000</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">WO</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Write Owner</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00080000</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">WD</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Write DAC</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00040000</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">RC</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Read Control</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00020000</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">SD</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Delete</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00010000</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">CR</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Control Access</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00000100</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">LO</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">List Object</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00000080</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">DT</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Delete Tree</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00000040</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">WP</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Write Property</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00000020</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">RP</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Read Property</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00000010</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">SW</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Self Write</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00000008</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">LC</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">List Children</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00000004</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">DC</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Delete Child</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00000002</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">CC</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Create Child</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00000001</samp></p></td>
</tr>
</tbody>
</table>
<p class="TX">Note that the available access strings do not cover the entire access mask range. This is because SDDL was designed to represent the masks for directory service objects, which don’t define access mask values outside of a limited range. This is also why the names of the rights are slightly confusing; for example, <samp class="SANS_TheSansMonoCd_W5Regular_11">Delete Child</samp> does not necessarily map to an arbitrary object type’s idea of deleting a child, and you can see in <a href="chapter5.xhtml#Lis5-15">Listing 5-15</a> that the <samp class="SANS_TheSansMonoCd_W5Regular_11">File</samp> type’s specific access maps to directory service object access, even though it has nothing to do with Active Directory.</p>
<p class="TX">To better support other types, the SDDL format provides access strings for common file and registry key access masks, as shown in <a href="chapter5.xhtml#tab5-11">Table 5-11</a>. If the <span aria-label=" Page 169. " epub:type="pagebreak" id="pg_169" role="doc-pagebreak"></span>available access strings can’t represent the entire mask, the only option is to represent it as a number string, typically in hexadecimal format.</p>
<table class="Basic-Table">
<caption><p class="TT" id="tab5-11"><span class="Heavy"><samp class="SANS_Futura_Std_Heavy_B_11">Table 5-11:</samp></span> <samp class="SANS_Futura_Std_Book_11">Access Strings for File and Registry Key Types</samp></p></caption>
<thead>
<tr>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Access string</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Access name</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Access mask</samp></p></th>
</tr>
</thead>
<tbody>
<tr>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">FA</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">File All Access</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x001F01FF</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">FX</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">File Execute</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x001200A0</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">FW</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">File Write</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00120116</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">FR</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">File Read</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00120089</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">KA</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Key All Access</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x000F003F</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">KR</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Key Read</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00020019</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">KX</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Key Execute</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00020019</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">KW</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Key Write</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00020006</samp></p></td>
</tr>
</tbody>
</table>
<p class="TX">For the <samp class="SANS_TheSansMonoCd_W5Regular_11">ObjectType</samp> and <samp class="SANS_TheSansMonoCd_W5Regular_11">InheritedObjectType</samp> components, used with object ACEs, SDDL uses a string format for the GUIDs. The GUIDs can be any value. For example, <a href="chapter5.xhtml#tab5-12">Table 5-12</a> contains a few well-known ones used by Active Directory.</p>
<table class="Basic-Table">
<caption><p class="TT" id="tab5-12"><span class="Heavy"><samp class="SANS_Futura_Std_Heavy_B_11">Table 5-12:</samp></span> <samp class="SANS_Futura_Std_Book_11">Well-Known</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">ObjectType</samp> <samp class="SANS_Futura_Std_Book_11">GUIDs Used in Active Directory</samp></p></caption>
<thead>
<tr>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">GUID</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Directory object</samp></p></th>
</tr>
</thead>
<tbody>
<tr>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">19195a5a-6da0-11d0-afd3-00c04fd930c9</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Domain</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">bf967a86-0de6-11d0-a285-00aa003049e2</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Computer</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">bf967aba-0de6-11d0-a285-00aa003049e2</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">User</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">bf967a9c-0de6-11d0-a285-00aa003049e2</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Group</samp></p></td>
</tr>
</tbody>
</table>
<p class="TX">Here is an example ACE string for an <samp class="SANS_TheSansMonoCd_W5Regular_11">AllowedObject</samp> ACE with the <samp class="SANS_TheSansMonoCd_W5Regular_11">ObjectType</samp> set:</p>
<pre><code>(OA;;CC;2f097591-a34f-4975-990f-00f0906b07e0;;WD)
</code></pre>
<p class="BodyContinued">After the <samp class="SANS_TheSansMonoCd_W5Regular_11">InheritedObjectType</samp> component in the ACE is the SID. As detailed earlier in this chapter, this can be a short alias if it’s a well-known SID, or the full SDDL format if not.</p>
<p class="TX">In the final component, which is optional for most ACE types, you can specify a conditional expression if using a callback ACE or a security attribute if using a <samp class="SANS_TheSansMonoCd_W5Regular_11">ResourceAttribute</samp> ACE. The conditional expression defines a Boolean expression that compares the values of a token’s security attribute. When evaluated, the result of the expression should be true or false. We saw a simple example in <a href="chapter5.xhtml#Lis5-5">Listing 5-5</a>: <samp class="SANS_TheSansMonoCd_W5Regular_11">WIN://TokenId</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">==</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">"XYZ"</samp>, which compares the value of the security attribute <samp class="SANS_TheSansMonoCd_W5Regular_11">WIN://TokenId</samp> with the string value <samp class="SANS_TheSansMonoCd_W5Regular_11">XYZ</samp> and evaluates to true if they’re equal. The SDDL expression syntax has <span aria-label=" Page 170. " epub:type="pagebreak" id="pg_170" role="doc-pagebreak"></span>four different attribute name formats for the security attribute you want to refer to:</p>
<p class="RunInPara1"><b>Simple    </b>For local security attributes; for example, <samp class="SANS_TheSansMonoCd_W5Regular_11">WIN://TokenId</samp></p>
<p class="RunInPara"><b>Device    </b>For device claims; for example, <samp class="SANS_TheSansMonoCd_W5Regular_11">@Device.ABC</samp></p>
<p class="RunInPara"><b>User    </b>For user claims; for example, <samp class="SANS_TheSansMonoCd_W5Regular_11">@User.XYZ</samp></p>
<p class="RunInPara2"><b>Resource    </b>For resource attributes; for example, <samp class="SANS_TheSansMonoCd_W5Regular_11">@Resource.QRS</samp></p>
<p class="TX">The comparison values in the conditional expressions can accept several different types, as well. When converting from SDDL to a security descriptor, the condition expression will be parsed, but because the type of the security attribute won’t be known at this time, no validation of the value’s type can occur. <a href="chapter5.xhtml#tab5-13">Table 5-13</a> shows examples for each conditional expression type.</p>
<table class="Basic-Table">
<caption><p class="TT" id="tab5-13"><span class="Heavy"><samp class="SANS_Futura_Std_Heavy_B_11">Table 5-13:</samp></span> <samp class="SANS_Futura_Std_Book_11">Example Values for Different Conditional Expression Types</samp></p></caption>
<thead>
<tr>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Type</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Examples</samp></p></th>
</tr>
</thead>
<tbody>
<tr>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Number</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Decimal:</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">100</samp><samp class="SANS_Futura_Std_Book_11">,</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">-100</samp><samp class="SANS_Futura_Std_Book_11">; octal:</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">0100</samp><samp class="SANS_Futura_Std_Book_11">; hexadecimal:</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">0x100</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">String</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">"ThisIsAString"</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Fully qualified binary name</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">{"O=MICROSOFT CORPORATION</samp><samp class="SANS_Futura_Std_Book_11">,</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">L=REDMOND</samp><samp class="SANS_Futura_Std_Book_11">,</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">S=WASHINGTON",1004}</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">SID</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">SID(BA)</samp><samp class="SANS_Futura_Std_Book_11">,</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">SID(S-1-0-0)</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Octet string</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">#0011223344</samp></p></td>
</tr>
</tbody>
</table>
<p class="TX">The syntax then defines operators to evaluate an expression, starting with the unary operators in <a href="chapter5.xhtml#tab5-14">Table 5-14</a>.</p>
<table class="Basic-Table">
<caption><p class="TT" id="tab5-14"><span class="Heavy"><samp class="SANS_Futura_Std_Heavy_B_11">Table 5-14:</samp></span> <samp class="SANS_Futura_Std_Book_11">Unary Operators for Conditional Expressions</samp></p></caption>
<thead>
<tr>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Operator</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Description</samp></p></th>
</tr>
</thead>
<tbody>
<tr>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Exists</samp> <samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">ATTR</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Checks whether the security attribute</samp> <samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">ATTR</samp> <samp class="SANS_Futura_Std_Book_11">exists</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Not_Exists</samp> <samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">ATTR</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Inverse of</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">Exists</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Member_of {</samp><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">SIDLIST</samp><samp class="SANS_TheSansMonoCd_W5Regular_11">}</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Checks whether the token groups contain all SIDs in</samp> <samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">SIDLIST</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Not_Member_of {</samp><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">SIDLIST</samp><samp class="SANS_TheSansMonoCd_W5Regular_11">}</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Inverse of</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">Member_of</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Device_Member_of {</samp><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">SIDLIST</samp><samp class="SANS_TheSansMonoCd_W5Regular_11">}</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Checks whether the token device groups contain all SIDs in</samp> <samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">SIDLIST</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Not_Device_Member_of {</samp><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">SIDLIST</samp><samp class="SANS_TheSansMonoCd_W5Regular_11">}</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Inverse of</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">Device_Member_of</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Member_of_Any {</samp><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">SIDLIST</samp><samp class="SANS_TheSansMonoCd_W5Regular_11">}</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Checks whether the token groups contain any SIDs in</samp> <samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">SIDLIST</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Not_Member_of_Any {</samp><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">SIDLIST</samp><samp class="SANS_TheSansMonoCd_W5Regular_11">}</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Inverse of</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">Not_Member_of_Any</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Device_Member_of_Any {</samp><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">SIDLIST</samp><samp class="SANS_TheSansMonoCd_W5Regular_11">}</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Checks whether the token device groups contain any SIDs in</samp> <samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">SIDLIST</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Not_Device_Member_of_Any {</samp><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">SIDLIST</samp><samp class="SANS_TheSansMonoCd_W5Regular_11">}</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Inverse of</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">Device_Member_of_Any</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">!(</samp><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">EXPR</samp><samp class="SANS_TheSansMonoCd_W5Regular_11">)</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">The logical NOT of an expression</samp></p></td>
</tr>
</tbody>
</table>
<p class="TX"><span aria-label=" Page 171. " epub:type="pagebreak" id="pg_171" role="doc-pagebreak"></span>In <a href="chapter5.xhtml#tab5-14">Table 5-14</a>, <samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">ATTR</samp> is the name of an attribute to test, <samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">SIDLIST</samp> is a list of SID values enclosed in braces <samp class="SANS_TheSansMonoCd_W5Regular_11">{}</samp>, and <samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">EXPR</samp> is another conditional subexpression. <a href="chapter5.xhtml#tab5-15">Table 5-15</a> shows the infix operators the syntax defines.</p>
<table class="Basic-Table">
<caption><p class="TT" id="tab5-15"><span class="Heavy"><samp class="SANS_Futura_Std_Heavy_B_11">Table 5-15:</samp></span> <samp class="SANS_Futura_Std_Book_11">Infix Operators for Conditional Expressions</samp></p></caption>
<thead>
<tr>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Operator</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Description</samp></p></th>
</tr>
</thead>
<tbody>
<tr>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">ATTR</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">Contains</samp> <samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">VALUE</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Checks whether the security attribute contains the value</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">ATTR</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">Not_Contains</samp> <samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">VALUE</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Inverse of</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">Contains</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">ATTR</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">Any_of {</samp><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">VALUELIST</samp><samp class="SANS_TheSansMonoCd_W5Regular_11">}</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Checks whether the security attribute contains any of the values</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">ATTR</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">Not_Any_of {</samp><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">VALUELIST</samp><samp class="SANS_TheSansMonoCd_W5Regular_11">}</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Inverse of</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">Any_of</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">ATTR</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">==</samp> <samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">VALUE</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Checks whether the security attribute equals the value</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">ATTR</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">!=</samp> <samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">VALUE</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Checks whether the security attribute does not equal the value</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">ATTR</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">&lt;</samp> <samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">VALUE</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Checks whether the security attribute is less than the value</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">ATTR</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">&lt;=</samp> <samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">VALUE</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Checks whether the security attribute is less than or equal to the value</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">ATTR</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">&gt;</samp> <samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">VALUE</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Checks whether the security attribute is greater than the value</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">ATTR</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">&gt;=</samp> <samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">VALUE</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Checks whether the security attribute is greater than or equal to the value</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">EXPR</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">&amp;&amp;</samp> <samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">EXPR</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">The logical AND between two expressions</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">EXPR</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">||</samp> <samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">EXPR</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">The logical OR between two expressions</samp></p></td>
</tr>
</tbody>
</table>
<p class="TX">In <a href="chapter5.xhtml#tab5-15">Table 5-15</a>, <samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">VALUE</samp> can be either a single value from <a href="chapter5.xhtml#tab5-13">Table 5-13</a> or a list of values enclosed in braces. The <samp class="SANS_TheSansMonoCd_W5Regular_11">Any_of</samp> and <samp class="SANS_TheSansMonoCd_W5Regular_11">Not_Any_of</samp> operators work only on lists, and the conditional expression must always be placed in parentheses in the SDDL ACE. For example, if you wanted to use the conditional expression shown back in <a href="chapter5.xhtml#Lis5-5">Listing 5-5</a> with an <samp class="SANS_TheSansMonoCd_W5Regular_11">AccessCallback</samp> ACE, the ACE string would be as follows:</p>
<pre><code>(ZA;;GA;;;WD;(WIN://TokenId == "XYZ"))
</code></pre>
<p class="TX">The final component represents a security attribute for the <samp class="SANS_TheSansMonoCd_W5Regular_11">ResourceAttribute</samp> ACE. Its general format is as follows:</p>
<pre><code>"AttrName",AttrType,AttrFlags,AttrValue(,AttrValue...)
</code></pre>
<p class="BodyContinued">The <samp class="SANS_TheSansMonoCd_W5Regular_11">AttrName</samp> value is the name of the security attribute, <samp class="SANS_TheSansMonoCd_W5Regular_11">AttrFlags</samp> is a hexadecimal number that represents the security attribute flags, and <samp class="SANS_TheSansMonoCd_W5Regular_11">AttrValue</samp> is one or more values specific to the <samp class="SANS_TheSansMonoCd_W5Regular_11">AttrType</samp>, separated by commas. The <samp class="SANS_TheSansMonoCd_W5Regular_11">AttrType</samp> is a short string that indicates the type of data contained in the security attribute. <a href="chapter5.xhtml#tab5-16">Table 5-16</a> shows the defined strings, with examples.</p>
<p class="Anchor"><span aria-label=" Page 172. " epub:type="pagebreak" id="pg_172" role="doc-pagebreak"></span></p>
<table class="Basic-Table">
<caption><p class="TT" id="tab5-16"><span class="Heavy"><samp class="SANS_Futura_Std_Heavy_B_11">Table 5-16:</samp></span> <samp class="SANS_Futura_Std_Book_11">Security Attribute SDDL Type Strings</samp></p></caption>
<thead>
<tr>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Attribute type</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Type name</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Example value</samp></p></th>
</tr>
</thead>
<tbody>
<tr>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">TI</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Int64</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Decimal:</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">100</samp><samp class="SANS_Futura_Std_Book_11">,</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">-100</samp><samp class="SANS_Futura_Std_Book_11">; octal:</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">0100</samp><samp class="SANS_Futura_Std_Book_11">; hexadecimal:</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">0x100</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">TU</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">UInt64</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Decimal:</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">100</samp><samp class="SANS_Futura_Std_Book_11">; octal:</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">0100</samp><samp class="SANS_Futura_Std_Book_11">; hexadecimal:</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">0x100</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">TS</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">String</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">"XYZ"</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">TD</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">SID</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">BA</samp><samp class="SANS_Futura_Std_Book_11">,</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">S-1-0-0</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">TB</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Boolean</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0</samp><samp class="SANS_Futura_Std_Book_11">,</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">1</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">RX</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">OctetString</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">#0011223344</samp></p></td>
</tr>
</tbody>
</table>
<p class="TX">To give an example, the following SDDL string represents a <samp class="SANS_TheSansMonoCd_W5Regular_11">ResourceAttribute</samp> ACE with the name <samp class="SANS_TheSansMonoCd_W5Regular_11">Classification</samp>. It contains two string values, <samp class="SANS_TheSansMonoCd_W5Regular_11">TopSecret</samp> and <samp class="SANS_TheSansMonoCd_W5Regular_11">MostSecret</samp>, and has the <samp class="SANS_TheSansMonoCd_W5Regular_11">CaseSensitive</samp> and <samp class="SANS_TheSansMonoCd_W5Regular_11">NonInheritable</samp> flags set:</p>
<pre><code>S:(RA;;;;;WD;("Classification",TS,0x3,"TopSecret","MostSecret"))
</code></pre>
<p class="TX">The last field in <a href="chapter5.xhtml#Lis5-15">Listing 5-15</a> to define is the SACL. The structure is the same as that described for the DACL, although the types of ACEs supported differ. If you try to use a type that is not allowed in the specific ACL, parsing the string will fail. In the SACL example in <a href="chapter5.xhtml#Lis5-15">Listing 5-15</a>, the only ACE is the mandatory label. The mandatory label ACE has its own access strings used to represent the mandatory policy, as shown in <a href="chapter5.xhtml#tab5-17">Table 5-17</a>.</p>
<table class="Basic-Table">
<caption><p class="TT" id="tab5-17"><span class="Heavy"><samp class="SANS_Futura_Std_Heavy_B_11">Table 5-17:</samp></span> <samp class="SANS_Futura_Std_Book_11">Mandatory Label Access Strings</samp></p></caption>
<thead>
<tr>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Access string</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Access name</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Access mask</samp></p></th>
</tr>
</thead>
<tbody>
<tr>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">NX</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">No Execute Up</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00000004</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">NR</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">No Read Up</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00000002</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">NW</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">No Write Up</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">0x00000001</samp></p></td>
</tr>
</tbody>
</table>
<p class="TX">The SID represents the integrity level of the mandatory label; again, special SID aliases are defined. Anything outside the list shown in <a href="chapter5.xhtml#tab5-18">Table 5-18</a> needs to be represented as a full SID.</p>
<table class="Basic-Table">
<caption><p class="TT" id="tab5-18"><span class="Heavy"><samp class="SANS_Futura_Std_Heavy_B_11">Table 5-18:</samp></span> <samp class="SANS_Futura_Std_Book_11">Mandatory Label Integrity Level SIDs</samp></p></caption>
<thead>
<tr>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">SID alias</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Name</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">SDDL SID</samp></p></th>
</tr>
</thead>
<tbody>
<tr>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">LW</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Low</samp> <samp class="SANS_Futura_Std_Book_11">integrity level</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">S-1-16-4096</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">ME</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Medium</samp> <samp class="SANS_Futura_Std_Book_11">integrity level</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">S-1-16-8192</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">MP</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">MediumPlus</samp> <samp class="SANS_Futura_Std_Book_11">integrity level</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">S-1-16-8448</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">HI</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">High</samp> <samp class="SANS_Futura_Std_Book_11">integrity level</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">S-1-16-12288</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">SI</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">System</samp> <samp class="SANS_Futura_Std_Book_11">integrity level</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">S-1-16-16384</samp></p></td>
</tr>
</tbody>
</table>
<p class="TX"><span aria-label=" Page 173. " epub:type="pagebreak" id="pg_173" role="doc-pagebreak"></span>The SDDL format doesn’t preserve all information you can store in a security descriptor. For example, the SDDL format can’t represent the <samp class="SANS_TheSansMonoCd_W5Regular_11">OwnerDefaulted</samp> or <samp class="SANS_TheSansMonoCd_W5Regular_11">GroupDefaulted</samp> control flag, so these are discarded. SDDL also doesn’t support some ACE types, so I omitted those from <a href="chapter5.xhtml#tab5-8">Table 5-8</a>.</p>
<p class="TX">As mentioned previously, if an unsupported ACE type is encountered while converting a security descriptor to SDDL, the conversion process will fail. To get around this problem, the <samp class="SANS_TheSansMonoCd_W5Regular_11">ConvertFrom-NtSecurityDescriptor</samp> PowerShell command can convert a security descriptor in relative format to base64, as shown in <a href="chapter5.xhtml#Lis5-18">Listing 5-18</a>. Using base64 preserves the entire security descriptor and allows it to be copied easily.</p>
<span id="Lis5-18"></span><pre><code>PS&gt; <b>ConvertFrom-NtSecurityDescriptor $sd -AsBase64 -InsertLineBreaks</b>
AQAUpJgAAACkAAAAFAAAAEQAAAACADAAAgAAAAKAFAAAAAEAAQEAAAAAAAEAAAAAEQAUAAEAAAAB
AQAAAAAAEAAQAAACAFQAAwAAAAEAFAAAAAAQAQEAAAAAAAUHAAAAAAAkAAMAAAABBQAAAAAABRUA
AAD0rDCKvQmS0XPc7QzqAwAAAAAUAAEAAAABAQAAAAAAAQAAAAABAQAAAAAAAQAAAAABAQAAAAAA
AQAAAAA=
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing 5-18: Converting a security descriptor to a base64 representation</span></p>
<p class="TX">To retrieve the security descriptor, you can pass <samp class="SANS_TheSansMonoCd_W5Regular_11">New-NtSecurityDescriptor</samp> the <samp class="SANS_TheSansMonoCd_W5Regular_11">Base64</samp> parameter.</p>
</section>
<section aria-labelledby="sec13" epub:type="division">
<h3 class="H1" id="sec13"><span id="h1-50"></span><samp class="SANS_Futura_Std_Bold_B_11">Worked Examples</samp></h3>
<p class="TNI1">Let’s finish this chapter with some worked examples that use the commands you’ve learned about here.</p>
<section aria-labelledby="sec14" epub:type="division">
<h4 class="H2" id="sec14"><span id="h2-64"></span><samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">Manually Parsing a Binary SID</samp></h4>
<p class="TNI1">The PowerShell module comes with commands you can use to parse SIDs that are structured in various forms. One of those forms is a raw byte array. You can convert an existing SID to a byte array using the <samp class="SANS_TheSansMonoCd_W5Regular_11">ConvertFrom-NtSid</samp> command:</p>
<pre><code>PS&gt; <b>$ba = ConvertFrom-NtSid -Sid "S-1-1-0"</b>
</code></pre>
<p class="TX">You can also convert the byte array back to a SID using the <samp class="SANS_TheSansMonoCd_W5Regular_11">Byte</samp> parameter to the <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-NtSid</samp> command, as shown here. The module will parse the byte array and return the SID:</p>
<pre><code>PS&gt; <b>Get-NtSid -Byte $ba</b>
</code></pre>
<p class="TX">Although PowerShell can perform these conversions for you, you’ll find it valuable to understand how the data is structured at a low level. For example, you might identify code that parses SIDs incorrectly, which could lead to memory corruption; through this discovery, you might find a security vulnerability.</p>
<p class="TX">The best way to learn how to parse a binary structure is to write a parser, as we do in <a href="chapter5.xhtml#Lis5-19">Listing 5-19</a>.</p>
<span id="Lis5-19"></span><pre><code><span aria-label=" Page 174. " epub:type="pagebreak" id="pg_174" role="doc-pagebreak"></span><span aria-label="annotation1" class="CodeAnnotationHang1">❶</span> PS&gt; <b>$sid = Get-NtSid -SecurityAuthority Nt -RelativeIdentifier 100, 200, 300</b>
PS&gt; <b>$ba = ConvertFrom-NtSid -Sid $sid</b>
PS&gt; <b>$ba | Out-HexDump -ShowAll</b>
          00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F  - 0123456789ABCDEF
-----------------------------------------------------------------------------
00000000: 01 03 00 00 00 00 00 05 64 00 00 00 C8 00 00 00  -........d.......
00000010: 2C 01 00 00                                      - ,...

PS&gt; <b>$stm = [System.IO.MemoryStream]::new($ba)</b>
<span aria-label="annotation2" class="CodeAnnotationHang1">❷</span> PS&gt; <b>$reader = [System.IO.BinaryReader]::new($stm)</b>

PS&gt; <b>$revision = $reader.ReadByte()</b>
<span aria-label="annotation3" class="CodeAnnotationHang1">❸</span> PS&gt; <b>if ($revision -ne 1) {</b>
<b>    throw "Invalid SID revision"</b>
<b>}</b>

<span aria-label="annotation4" class="CodeAnnotationHang1">❹</span> PS&gt; <b>$rid_count = $reader.ReadByte()</b>
<span aria-label="annotation5" class="CodeAnnotationHang1">❺</span> PS&gt; <b>$auth = $reader.ReadBytes(6)</b>
PS&gt; <b>if ($auth.Length -ne 6) {</b>
<b>    throw "Invalid security authority length"</b>
<b>}</b>

PS&gt; <b>$rids = @()</b>
<span aria-label="annotation6" class="CodeAnnotationHang1">❻</span> PS&gt; <b>while($rid_count -gt 0) {</b>
<b>    $rids += $reader.ReadUInt32()</b>
<b>    $rid_count--</b>
<b>}</b>

<span aria-label="annotation7" class="CodeAnnotationHang1">❼</span> PS&gt; <b>$new_sid = Get-NtSid -SecurityAuthorityByte $auth -RelativeIdentifier $rids</b>
PS&gt; <b>$new_sid -eq $sid</b>
True
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing 5-19: Manually parsing a binary SID</span></p>
<p class="TX">For demonstration purposes, we start by creating an arbitrary SID and converting it to a byte array <span aria-label="annotation1" class="CodeAnnotationCode">❶</span>. Typically, though, you’ll receive a SID to parse in some other way, such as from the memory of a process. We also print the SID as hex. (If you refer to the SID structure shown in <a href="chapter5.xhtml#fig5-1">Figure 5-1</a>, you might already be able to pick out its various components.)</p>
<p class="TX">Next, we create a <samp class="SANS_TheSansMonoCd_W5Regular_11">BinaryReader</samp> to parse the byte array in a structured form <span aria-label="annotation2" class="CodeAnnotationCode">❷</span>. Using the reader, we first check whether the revision value is set to <samp class="SANS_TheSansMonoCd_W5Regular_11">1</samp> <span aria-label="annotation3" class="CodeAnnotationCode">❸</span>; if it isn’t, we throw an error. Next in the structure is the RID count as a byte <span aria-label="annotation4" class="CodeAnnotationCode">❹</span>, followed by the 6-byte security authority <span aria-label="annotation5" class="CodeAnnotationCode">❺</span>. The <samp class="SANS_TheSansMonoCd_W5Regular_11">ReadBytes</samp> method can return a short reader, so you’ll want to check that you read all six bytes.</p>
<p class="TX">We now enter a loop to read the RIDs from the binary structure and append them to an array <span aria-label="annotation6" class="CodeAnnotationCode">❻</span>. Next, using the security authority and the RIDs, we can run <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-NtSid</samp> to construct a new SID object <span aria-label="annotation7" class="CodeAnnotationCode">❼</span> and verify that the new SID matches the one we started with.</p>
<p class="TX">This listing gives you an example of how to manually parse a SID (or, in fact, any binary structure) using PowerShell. If you’re adventurous, you could implement your own parser for the binary security descriptor <span aria-label=" Page 175. " epub:type="pagebreak" id="pg_175" role="doc-pagebreak"></span>formats, but that’s outside the scope of this book. It’s simpler to use the <samp class="SANS_TheSansMonoCd_W5Regular_11">New-NtSecurityDescriptor</samp> command to do the parsing for you.</p>
</section>
<section aria-labelledby="sec15" epub:type="division">
<h4 class="H2" id="sec15"><span id="h2-65"></span><samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">Enumerating SIDs</samp></h4>
<p class="TNI1">The LSASS service does not provide a publicly exposed method for querying every SID-to-name mapping it knows about. While the official Microsoft documentation provides a list of known SIDs, these aren’t always up to date and won’t include the SIDs specific to a computer or enterprise network. However, we can try to enumerate the mappings using brute force. <a href="chapter5.xhtml#Lis5-20">Listing 5-20</a> defines a function, <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-AccountSids</samp>, to brute-force a list of the SIDs for which LSASS has a name.</p>
<span id="Lis5-20"></span><pre><code>PS&gt; <b>function Get-AccountSids {</b>
<b>    param(</b>
<b>        [parameter(Mandatory)]</b>
<b>      </b><span aria-label="annotation1" class="CodeAnnotationCode2">❶</span><b> $BaseSid,</b>
<b>        [int]$MinRid = 0,</b>
<b>        [int]$MaxRid = 256</b>
<b>    )</b>

<b>    $i = $MinRid</b>

<b>    while($i -lt $MaxRid) {</b>
<b>        $sid = Get-NtSid -BaseSid $BaseSid -RelativeIdentifier $i</b>
<b>        $name = Get-NtSidName $sid</b>
<b>        </b><span aria-label="annotation2" class="CodeAnnotationHang1">❷</span><b> if ($name.Source -eq "Account") {</b>
<b>            [PSCustomObject]@{</b>
<b>                Sid = $sid;</b>
<b>                Name = $name.QualifiedName;</b>
<b>                Use = $name.NameUse</b>
<b>            }</b>
<b>        }</b>
<b>        $i++</b>
<b>    }</b>
<b>}</b>

<span aria-label="annotation3" class="CodeAnnotationHang1">❸</span> PS&gt; <b>$sid = Get-NtSid -SecurityAuthority Nt</b>
PS&gt; <b>Get-AccountSids -BaseSid $sid</b>
Sid          Name                   Use
----         ----                   ---
S-1-5-1      NT AUTHORITY\DIALUP    WellKnownGroup
S-1-5-2      NT AUTHORITY\NETWORK   WellKnownGroup
S-1-5-3      NT AUTHORITY\BATCH     WellKnownGroup
<var>--snip--</var>

<span aria-label="annotation4" class="CodeAnnotationHang1">❹</span> PS&gt; <b>$sid = Get-NtSid -BaseSid $sid -RelativeIdentifier 32</b>
PS&gt; <b>Get-AccountSids -BaseSid $sid -MinRid 512 -MaxRid 1024</b>
Sid          Name                   Use
----         ----                   ---
S-1-5-32-544 BUILTIN\Administrators Alias
S-1-5-32-545 BUILTIN\Users          Alias
<span aria-label=" Page 176. " epub:type="pagebreak" id="pg_176" role="doc-pagebreak"></span>S-1-5-32-546 BUILTIN\Guests         Alias
<var>--snip--</var>
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing 5-20: Brute-forcing known SIDs</span></p>
<p class="TX">The function accepts a base SID and the range of RID values to test <span aria-label="annotation1" class="CodeAnnotationCode">❶</span>. It then creates each SID in the list and queries for its name. If the name’s source is <samp class="SANS_TheSansMonoCd_W5Regular_11">Account</samp>, which indicates the name was retrieved from LSASS, we output the SID’s details <span aria-label="annotation2" class="CodeAnnotationCode">❷</span>.</p>
<p class="TX">To test the function, we call it with the base SID, which contains the <samp class="SANS_TheSansMonoCd_W5Regular_11">Nt</samp> authority but no RIDs <span aria-label="annotation3" class="CodeAnnotationCode">❸</span>. We get the list of retrieved names and SIDs from LSASS. Notice that the SIDs in the output are not domain SIDs, as you might expect, but <samp class="SANS_TheSansMonoCd_W5Regular_11">WellKnownGroup</samp> SIDs. For our purposes, the distinction between <samp class="SANS_TheSansMonoCd_W5Regular_11">WellKnownGroup</samp>, <samp class="SANS_TheSansMonoCd_W5Regular_11">Group</samp>, and <samp class="SANS_TheSansMonoCd_W5Regular_11">Alias</samp> is not important; they’re all groups.</p>
<p class="TX">Next, we try brute-forcing the <i>BUILTIN</i> domain SID <span aria-label="annotation4" class="CodeAnnotationCode">❹</span>. In this case, we’ve changed the RID range based on our preexisting knowledge of the valid range, but you’re welcome to try any other range you like. Note that you could automate the search by inspecting the <samp class="SANS_TheSansMonoCd_W5Regular_11">NameUse</samp> property in the returned objects and calling <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-AccountSids</samp> when its value is <samp class="SANS_TheSansMonoCd_W5Regular_11">Domain</samp>. I leave this as an exercise for the reader.</p>
</section>
</section>
<section aria-labelledby="sec16" epub:type="division">
<h3 class="H1" id="sec16"><span id="h1-51"></span><samp class="SANS_Futura_Std_Bold_B_11">Wrapping Up</samp></h3>
<p class="TNI1">We started this chapter by delving into the structure of the security descriptor. We detailed its binary structures, such as SIDs, and looked at access control lists and the access control entries that make up the discretionary and system ACLs. We then discussed the differences between absolute and relative security descriptors and why the two formats exist.</p>
<p class="TX">Next, we explored the use of the <samp class="SANS_TheSansMonoCd_W5Regular_11">New-NtSecurityDescriptor</samp> and <samp class="SANS_TheSansMonoCd_W5Regular_11">Add-NtSecurityDescriptorAce</samp> commands to create and modify a security descriptor so that it contains whatever entries we require. We also saw how to display security descriptors in a convenient form using the <samp class="SANS_TheSansMonoCd_W5Regular_11">Format-NtSecurityDescriptor</samp> command.</p>
<p class="TX">Finally, we covered the SDDL format used for representing security descriptors. We discussed how to represent the various types of security descriptor values, such as ACEs, and how you can write your own. Some tasks we haven’t yet covered are how to query a security descriptor from a kernel object and how to assign a new one. We’ll get to these topics in the next chapter.</p>
</section>
</section>
</div></body>
</html>