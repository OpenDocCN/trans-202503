<html><head></head><body>
<h2 class="h2" id="ch14"><span epub:type="pagebreak" id="page_367"/><span class="big">14</span><br/>FLAIM: AN AUTOTOOLS EXAMPLE</h2>&#13;
<p class="quote"><em>Uncle Abner said . . . a person that started in to carry  a cat home by the tail was gitting knowledge  that was always going to be useful to him</em>.<br/>—Mark Twain, Tom Sawyer Abroad</p>&#13;
<div class="image1"><img src="../images/common.jpg" alt="Image"/></div>&#13;
<p class="noindent">So far in this book, I’ve taken you on a whirlwind tour of the main features of Autoconf, Automake, and Libtool, as well as other tools that work well with the Autotools. I’ve done my best to explain them in a manner that is not only simple to digest but also easy to retain— especially if you’ve had the time and inclination to follow along with my examples on your own. I’ve always believed that no form of learning comes anywhere close to the learning that happens while doing.</p>&#13;
<p class="indent">In this chapter and the next, we’ll continue learning about the Auto­tools by studying the process I used to convert an existing, real-world, open source project from a complex handcoded makefile to a complete GNU Autotools build system. The examples I provide in these chapters illustrate the decisions I had to make during the conversion process as well as some concrete uses of Autotools features, including a few that I haven’t yet presented in previous chapters. These two chapters will round out our study of the Autotools by presenting real solutions to real problems.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_368"/>The project I chose to convert is called <em>FLAIM</em>, which stands for <em>FLexible Adaptable Information Management</em>.</p>&#13;
<h3 class="h3" id="ch14sec1">What Is FLAIM?</h3>&#13;
<p class="noindent">FLAIM is a highly scalable database-management library written in C++ and built on its own thin portability layer called the FLAIM toolkit. Some readers may recognize FLAIM as the database used by both Novell<sup><a id="ch14fn_1" href="footnote.xhtml#ch14fn1">1</a></sup> eDirectory and the Novell GroupWise server. FLAIM originated at WordPerfect in the late 1980s, and it became part of Novell’s software portfolio during the Novell/WordPerfect merger in 1994. Novell eDirectory used a spin-off of a then-late version of FLAIM to manage directory information bases that contain over a billion objects, and GroupWise used a much earlier spin-off to manage various server-side databases.</p>&#13;
<p class="indent">Novell made the FLAIM source code available as an open source project licensed under the GNU Lesser General Public License (LGPL) version 2<sup><a id="ch14fn_2" href="footnote.xhtml#ch14fn2">2</a></sup> in 2006. The FLAIM project is currently hosted by <a href="http://SourceForge.net">SourceForge.net</a>, and it is the result of 25 years of development and hardening in various WordPerfect and Novell products and projects.<sup><a id="ch14fn_3" href="footnote.xhtml#ch14fn3">3</a></sup></p>&#13;
<h3 class="h3" id="ch14sec2">Why FLAIM?</h3>&#13;
<p class="noindent">While FLAIM is far from a mainstream OSS project, it has several qualities that make it a perfect example for showing how to convert a project to use the Autotools. For one, FLAIM is currently built using a handcoded GNU makefile that contains over 2,000 lines of complex make script. The FLAIM makefile contains a number of GNU Make–specific constructs, and thus you can only process this makefile using GNU Make. Individual (but nearly identical) makefiles are used to build the <em>flaim</em>, <em>xflaim</em>, and <em>flaimsql</em> database libraries, and the FLAIM toolkit (<em>ftk</em>), as well as several utility and sample programs on Linux, various flavors of Unix, Windows, and NetWare.</p>&#13;
<p class="indent">The existing FLAIM build system targets several different flavors of Unix, including AIX, Solaris, and HP-UX, as well as Apple’s macOS. It also targets multiple compilers on these systems. These features make FLAIM ideal for this sample conversion project because I can show you how to handle differences in operating systems and toolsets in the new <em>configure.ac</em> files.</p>&#13;
<p class="indent">The existing build system also contains rules for many of the standard Automake targets, such as distribution tarballs. Additionally, it provides rules for building binary installation packages, as well as RPMs for systems that can build and install RPM packages. It even provides targets for <span epub:type="pagebreak" id="page_369"/>building Doxygen<sup><a id="ch14fn_4" href="footnote.xhtml#ch14fn4">4</a></sup> description files, which it then uses to build source documentation. I’ll spend a few paragraphs showing you how you can add these types of targets to the infrastructure provided by Automake.</p>&#13;
<p class="indent">The FLAIM toolkit is a portability library that third-party projects can incorporate and consume independently. We can use the toolkit to demonstrate Autoconf’s ability to manage separate subprojects as optional subdirectories within a project. If the user already has the FLAIM toolkit installed on their build machine, they can use the installed version or, optionally, override it with a local copy. On the other hand, if the toolkit is not installed, then the local, subdirectory-based copy will be used by default.</p>&#13;
<p class="indent">The FLAIM project also provides code to build both Java and C# language bindings, so I’ll delve into those esoteric realms a bit. I won’t go into great detail on building either Java or C# applications, but I will cover how to write <em>Makefile.am</em> files that generate both Java and C# programs and language-binding libraries.</p>&#13;
<p class="indent">The FLAIM project makes good use of unit tests. These are built as individual programs that run without command line options, so I can easily show you how to add real-world unit tests to the new FLAIM Autotools build system using Automake’s trivial test framework.</p>&#13;
<p class="indent">The FLAIM project and its original build system employ a reasonably modular directory layout, making it rather simple to convert to an Autotools modular build system. A simple pass of the <code>diff</code> utility over the directory tree should suffice.</p>&#13;
<h3 class="h3" id="ch14sec3">Logistics</h3>&#13;
<p class="noindent">When the first edition of this book was published in 2010, FLAIM had just been released as an open source project on <a href="http://SourceForge.net">SourceForge.net</a> using Subversion to manage its source code repository. Since that time, the FLAIM project has become, more or less, inactive. No one I’m aware of is actively using the code base. As I am the only remaining maintainer of the source code, I’ve made a GitHub repository for FLAIM specifically for <a href="ch14.xhtml">Chapters 14</a> and <a href="ch15.xhtml">15</a> of this second edition of this book. You can find this repository at the NSP-Autotools area on GitHub under the FLAIM project.<sup><a id="ch14fn_5" href="footnote.xhtml#ch14fn5">5</a></sup> I’ve updated the information in this chapter to be relevant to FLAIM’s storage in a git repository.</p>&#13;
<p class="indent">The source code repository for this chapter follows a somewhat different style than that for preceding chapters. The original Autotools build system changes I made to the FLAIM <a href="http://SourceForge.net">SourceForge.net</a> project are buried beneath, and intermixed with, several dozen unrelated changes. Rather than spend hours separating out these changes in an effort to provide you with proper before and after snapshots of the FLAIM code base, I simply <span epub:type="pagebreak" id="page_370"/>chose to commit the final FLAIM code, with its Autotools build system, to the GitHub project.<sup><a id="ch14fn_6" href="footnote.xhtml#ch14fn6">6</a></sup></p>&#13;
<p class="indent">Do not be discouraged about FLAIM’s current activity status—it continues to provide a wide variety of opportunities to learn about Autotools build system techniques in real-world projects.</p>&#13;
<h3 class="h3" id="ch14sec4">An Initial Look</h3>&#13;
<p class="noindent">Let me start by saying that converting FLAIM from GNU makefiles to an Autotools build system is not a trivial project. It took me a couple of weeks, and much of that time was spent determining exactly what to build and how to do it—in other words, analyzing the legacy build system. Another significant portion of my time was spent converting aspects that lay on the outer fringes of Autotools functionality. For example, I spent <em>much</em> more time converting build system rules for building C# language bindings than I did converting rules for building the core C++ libraries.</p>&#13;
<p class="indent">The first step in this conversion project is to analyze FLAIM’s existing directory structure and build system. What components are actually built, and which components depend on which others? Can individual components be built, distributed, and consumed independently? These types of component-level relationships are important because they’ll often determine how you’ll lay out your project directory structure.</p>&#13;
<p class="indent">The FLAIM project is actually several small projects under one umbrella project within its repository. There are three separate and distinct database products: <em>flaim</em>, <em>xflaim</em>, and <em>flaimsql</em>. The flaim subproject is the original FLAIM database library used by eDirectory and GroupWise. The xflaim project is a hierarchical XML database developed for internal projects at Novell; it is optimized for path-oriented, node-based access. The flaimsql project is an SQL layer on top of the FLAIM database. It was written as a separate library in order to optimize the lower-level FLAIM API for SQL access. This project was an experiment that, frankly, isn’t quite finished (but it does compile).</p>&#13;
<p class="indent">The point is that all three of these database libraries are separate and unrelated to each other, with no interlibrary dependencies. Since they may easily be used independently of one another, they can actually be shipped as individual distributions. You could consider each an open source project in its own right. This, then, will become one of my primary goals: to allow the FLAIM open source project to be easily broken up into smaller open source projects that can be managed independently of one another.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_371"/>The FLAIM toolkit is also an independent project. While it’s tailored specifically for the FLAIM database libraries, providing just the system service abstractions required for a DBMS, it depends on nothing but itself, and thus it may easily be used as the basis for portability within other projects without dragging along any unnecessary database baggage.<sup><a id="ch14fn_7" href="footnote.xhtml#ch14fn7">7</a></sup></p>&#13;
<p class="indent">The original FLAIM project was laid out in its repository as follows:</p>&#13;
<pre>$ <span class="codestrong1">tree -d --charset=ascii FLAIM</span>&#13;
FLAIM&#13;
|-- flaim&#13;
|   |-- debian&#13;
|   |-- docs&#13;
|   |-- sample&#13;
|   |-- src&#13;
|   `-- util&#13;
|-- ftk&#13;
|   |-- debian&#13;
|   |-- src&#13;
|   `-- util&#13;
|-- sql&#13;
|   `-- src&#13;
<span class="codeitalic1">--snip--</span>&#13;
`-- xflaim&#13;
    |-- csharp&#13;
    <span class="codeitalic1">--snip--</span>&#13;
    |-- java&#13;
    <span class="codeitalic1">--snip--</span>&#13;
    |-- sample&#13;
    <span class="codeitalic1">--snip--</span>&#13;
    |-- src&#13;
    `-- util&#13;
<span class="codeitalic1">--snip--</span></pre>&#13;
<p class="indent">The complete tree is fairly broad and somewhat deep in places, including significant utilities, tests, and other such binaries that are built by the legacy build system. At some point during the trek down into this hierarchy, I simply had to stop and consider whether it was worth converting that additional utility or layer. (If I hadn’t done that, this chapter would be twice as long and half as useful.) To this end, I’ve decided to convert the following elements:</p>&#13;
<ul>&#13;
<li class="noindent">The database libraries</li>&#13;
<li class="noindent">The unit and library interface tests</li>&#13;
<li class="noindent">The utilities and other such high-level programs found in various <em>util</em> directories</li>&#13;
<li class="noindent">The Java and C# language bindings found in the <em>xflaim</em> library</li>&#13;
</ul>&#13;
<p class="indent">I’ll also convert the C# unit tests, but I won’t go into the Java unit tests, because I’m already converting the Java language bindings using <span epub:type="pagebreak" id="page_372"/>Automake’s <code>JAVA</code> primary. Since Automake provides no help for C#, I have to provide everything myself anyway, so I’ll convert the entire C# code base. This will provide an example of writing the code for an entirely unsupported Automake product class.</p>&#13;
<h3 class="h3" id="ch14sec5">Getting Started</h3>&#13;
<p class="noindent">As stated earlier, my first true design decision was how to organize the original FLAIM project into subprojects. As it turns out, the existing directory layout is almost perfect. I’ve created a master <em>configure.ac</em> file in the top-level <em>flaim</em> directory, which is just under the repository root directory. This topmost <em>configure.ac</em> file acts as a sort of Autoconf control file for each of the four lower-level projects: ftk, flaim, flaimsql, and xflaim.</p>&#13;
<p class="indent">I’ve managed the database library dependencies on the FLAIM toolkit by treating the toolkit as a pure external dependency defined by the <code>make</code> variables <code>FTKINC</code> and <code>FTKLIB</code>. I’ve conditionally defined these variables to point to one of a few different sources, including installed libraries and even locations given in user-specified configuration script options.</p>&#13;
<h4 class="h4" id="ch14sec5-1"><em>Adding the configure.ac Files</em></h4>&#13;
<p class="noindent">In the following directory layout, I’ve used an annotation column to indicate the placement of individual <em>configure.ac</em> files. Each of these files represents a project that may be packaged and distributed independently.</p>&#13;
<pre>$ <span class="codestrong1">tree -d --charset=ascii FLAIM</span>&#13;
FLAIM                           configure.ac (flaim-projects)&#13;
|-- flaim                       configure.ac (flaim)&#13;
|   |-- debian&#13;
|   |-- docs&#13;
|   |-- sample&#13;
|   |-- src&#13;
|   `-- util&#13;
|-- ftk                         configure.ac (ftk)&#13;
|   |-- debian&#13;
|   |-- src&#13;
|   `-- util&#13;
|-- sql                         configure.ac (flaimsql)&#13;
|   `-- src&#13;
<span class="codeitalic1">--snip--</span>&#13;
`-- xflaim                      configure.ac (xflaim)&#13;
    |-- csharp&#13;
    <span class="codeitalic1">--snip--</span>&#13;
    |-- java&#13;
    <span class="codeitalic1">--snip--</span>&#13;
    |-- sample&#13;
    <span class="codeitalic1">--snip--</span>&#13;
    |-- src&#13;
    `-- util&#13;
<span class="codeitalic1">--snip--</span></pre>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_373"/>My next task was to create these <em>configure.ac</em> files. The top-level file was trivial, so I created it by hand. The project-specific files were more complex, so I allowed the <code>autoscan</code> utility to do the bulk of the work for me. <a href="ch14.xhtml#ch14ex1">Listing 14-1</a> shows the top-level <em>configure.ac</em> file.</p>&#13;
<pre>   #                                               -*- Autoconf -*-&#13;
   # Process this file with autoconf to produce a configure script.&#13;
&#13;
   AC_PREREQ([2.69])&#13;
<span class="ent">➊</span> AC_INIT([flaim-projects], [1.0])&#13;
<span class="ent">➋</span> AM_INIT_AUTOMAKE([-Wall -Werror foreign])&#13;
<span class="ent">➌</span> AM_PROG_AR&#13;
<span class="ent">➍</span> LT_PREREQ([2.4])&#13;
   LT_INIT([dlopen])&#13;
&#13;
<span class="ent">➎</span> AC_CONFIG_MACRO_DIRS([m4])&#13;
<span class="ent">➏</span> AC_CONFIG_SUBDIRS([ftk flaim sql xflaim])&#13;
   AC_CONFIG_FILES([Makefile])&#13;
   AC_OUTPUT</pre>&#13;
<p class="caption" id="ch14ex1"><em>Listing 14-1</em>: configure.ac: <em>The umbrella project’s Autoconf input file</em></p>&#13;
<p class="indent">This <em>configure.ac</em> file is short and simple because it doesn’t do much; nevertheless, there are some new and important concepts here. I invented the name <code>flaim-projects</code> and the version number <code>1.0</code> at <span class="ent">➊</span>. These are not likely to change unless really dramatic changes take place in the project directory structure or the maintainers decide to ship a complete bundle of the subprojects.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>For your own projects, consider using the optional third argument to the <em><code>AC_INIT</code></em> macro. You can add an email or web address here to indicate to users where they can submit a bug report. The contents of this argument show up in</em> configure <em>output.</em></p>&#13;
</div>&#13;
<p class="indent">The most important aspect of an umbrella project like this is the <code>AC_CONFIG_SUBDIRS</code> macro at <span class="ent">➏</span>, which I have yet to cover in this book. The argument is a whitespace-separated list of the subprojects to be built, where each is a complete <em>GCS</em>-compliant project in its own right. Here’s the prototype for this macro:</p>&#13;
<pre>AC_CONFIG_SUBDIRS(<span class="codeitalic1">dir</span>1[ <span class="codeitalic1">dir</span>2 ... <span class="codeitalic1">dir</span>N])</pre>&#13;
<p class="indent">It allows the maintainer to set up a hierarchy of projects in much the same way that Automake <code>SUBDIRS</code> configures the directory hierarchy for Automake within a single project.</p>&#13;
<p class="indent">Because the four subprojects contain all the actual build functionality, this <em>configure.ac</em> file acts merely as a control file, passing all specified configuration options to each of the subprojects in the order they’re given in the macro’s argument. The FLAIM toolkit project must be built first since the other projects depend on it.</p>&#13;
<h5 class="h5"><span epub:type="pagebreak" id="page_374"/>Automake in the Umbrella Project</h5>&#13;
<p class="noindent">Automake usually requires the existence of several text files in the top-level project directory, including the <em>AUTHORS</em>, <em>COPYING</em>, <em>INSTALL</em>, <em>NEWS</em>, <em>README</em>, and <em>ChangeLog</em> files. It would be nice not to have to deal with these files in the umbrella project. One way to accomplish this is to simply not use Automake in the umbrella project. I’d either have to write my own <em>Makefile.in</em> template for this directory or use Automake just once to generate a <em>Makefile.in</em> template that I could then check into the repository as part of the project, along with the <em>install-sh</em> and <em>missing</em> scripts added by <code>automake</code> <code>--add-missing</code> (or <code>autoreconf -i</code>). Once these files were in place, I could remove <code>AM_INIT_AUTOMAKE</code> from the master <em>configure.ac</em> file.</p>&#13;
<p class="indent">Another option would be to keep Automake and simply use the <code>foreign</code> option in <code>AM_INIT_AUTOMAKE</code> (which I did at <span class="ent">➋</span>) in the macro’s optional parameter. This parameter contains a string of whitespace-separated options that tell Automake how to act in lieu of specific Automake command line options. When <code>automake</code> parses the <em>configure.ac</em> file, it notes these options and enables them as if they’d been passed on the command line. The <code>foreign</code> option tells Automake that the project will not entirely follow GNU standards, and thus Automake will not require the usual GNU project text files.</p>&#13;
<p class="indent">I chose the latter of the two methods because I might want to alter the list of subordinate projects at some point and I don’t want to have to tweak a generated <em>Makefile.in</em> template by hand. I’ve also passed the <code>-Wall</code> and <code>-Werror</code> options in this list, which indicate that Automake should enable all Automake-specific warnings and report them as errors. These options have nothing to do with the user’s compilation environment—only Automake processing.</p>&#13;
<h5 class="h5">Why Add the Libtool Macros?</h5>&#13;
<p class="noindent">Why include those expensive Libtool macros at <span class="ent">➍</span>? Well, even though I don’t do anything with Libtool in the umbrella project, the lower-level projects expect a containing project to provide all the necessary scripts, and the <code>LT_INIT</code> macro provides the <em>ltmain.sh</em> script. If you don’t initialize Libtool in the umbrella project, tools like <code>autoreconf</code>, which actually looks in the <em>parent</em> directory to determine if the current project is itself a subproject, will fail when they can’t find scripts that the current project’s <em>configure.ac</em> file requires.</p>&#13;
<p class="indent">For instance, <code>autoreconf</code> expects to find a file called <em>../ltmain.sh</em> within the ftk project’s top-level directory. Note the reference to the parent directory here: <code>autoreconf</code> noticed, by examining the parent directory, that ftk was actually a subproject of a larger project. Rather than install all the auxiliary scripts multiple times, the Autotools generate code that looks for scripts in the project’s parent directory. This is done in an effort to reduce the number of copies of these scripts that are installed into multiproject <span epub:type="pagebreak" id="page_375"/>packages.<sup><a id="ch14fn_8" href="footnote.xhtml#ch14fn8">8</a></sup> If I don’t use <code>LT_INIT</code> in the umbrella project, I can’t successfully run <code>autoreconf</code> in the subprojects, because the <em>ltmain.sh</em> script won’t be in the project’s parent directory.</p>&#13;
<h5 class="h5">Adding a Macro Subdirectory</h5>&#13;
<p class="noindent">The <code>AC_CONFIG_MACRO_DIRS</code> macro at <span class="ent">➎</span> indicates the name of a subdirectory in which the <code>aclocal</code> utility can find all project-specific M4 macro files. Here’s the prototype:</p>&#13;
<pre>AC_CONFIG_MACRO_DIRS(<span class="codeitalic1">macro-dir</span>)</pre>&#13;
<p class="indent">The <em>.m4</em> macro files in this directory are ultimately referenced with an <code>m4_include</code> statement in the <code>aclocal</code>-generated <em>aclocal.m4</em> file, which <code>autoconf</code> reads. This macro replaces the original <em>acinclude.m4</em> file with a directory containing individual macros or smaller sets of macros, each defined in its own <em>.m4</em> file.<sup><a id="ch14fn_9" href="footnote.xhtml#ch14fn9">9</a></sup></p>&#13;
<p class="indent">I’ve indicated by the parameter to <code>AC_CONFIG_MACRO_DIRS</code> that all of the local macro files to be added to <em>aclocal.m4</em> are in a subdirectory called <em>m4</em>. As a bonus, when <code>autoreconf -i</code> is executed, and then when it executes the required Autotools with their respective <em>add-missing</em> options, these tools will note the use of this macro in <em>configure.ac</em> and add any required system macro files that are missing to the <em>m4</em> directory.</p>&#13;
<p class="indent">The reason I chose to use <code>AC_CONFIG_MACRO_DIRS</code> here is that Libtool will not add its additional macro files to the project if you haven’t enabled the macro directory option in this manner. Instead, it will complain that you should add these files to <em>acinclude.m4</em> yourself.<sup><a id="ch14fn_10" href="footnote.xhtml#ch14fn10">10</a></sup></p>&#13;
<p class="indent">Since this is a fairly complex project and I wanted the Autotools to do this job for me, I decided to use this macro-directory feature. Future releases of the Autotools will likely require this form because it’s considered the more modern way of adding macro files to <em>aclocal.m4</em>, as opposed to using a single user-generated <em>acinclude.m4</em> file.</p>&#13;
<p class="indent">One final thought on this macro: if you look for it in the Autoconf manual, you won’t find it—at least not yet, because it’s not an Autoconf macro but <span epub:type="pagebreak" id="page_376"/>an Automake macro. It’s prefixed with <code>AC_</code> because it was always intended that a future release of Autoconf would take on this macro. It’s more functional than its singular predecessor, which <em>is</em> documented in the Autoconf manual, but the functionality was not needed until Automake came along. In fact, I have it on pretty good authority (the pre-release Autoconf <em>ChangeLog</em>) that ownership will change hands when Autoconf 2.70 is published.</p>&#13;
<p class="indent">The one item that we haven’t yet covered here is the <code>AM_PROG_AR</code> macro at <span class="ent">➌</span>. This is a newer Automake macro. The first edition of this book didn’t use it. When I updated the Autotools, suddenly <code>autoreconf</code> complained that I needed it, so I added it and the complaint went away. The Autoconf manual says simply that you need it if you want to use an archiver (<code>ar</code>) that has an unusual interface (such as Microsoft <code>lib</code>). The fact is, the real complainer here was Libtool, which seems to have a habit of complaining about not including features of the other Autotools that it thinks you should be using. I added it to silence the warning.</p>&#13;
<h4 class="h4" id="ch14sec5-2"><em>The Top-Level Makefile.am File</em></h4>&#13;
<p class="noindent">The only other point to be covered regarding the umbrella project is the top-level <em>Makefile.am</em> file, shown in <a href="ch14.xhtml#ch14ex2">Listing 14-2</a>.</p>&#13;
<pre><span class="ent">➊</span> ACLOCAL_AMFLAGS = -I m4&#13;
&#13;
<span class="ent">➋</span> EXTRA_DIST = README.W32 tools win32&#13;
&#13;
<span class="ent">➌</span> SUBDIRS = ftk flaim sql xflaim&#13;
&#13;
<span class="ent">➍</span> rpms srcrpm:&#13;
          for dir in $(SUBDIRS); do \&#13;
            (cd $$dir &amp;&amp; $(MAKE) $(AM_MAKEFLAGS) $@) || exit 1; \&#13;
          done&#13;
  .PHONY: rpms srcrpm</pre>&#13;
<p class="caption" id="ch14ex2"><em>Listing 14-2</em>: Makefile.am: <em>The umbrella project Automake input file</em></p>&#13;
<p class="indent">According to the Automake documentation, the <code>ACLOCAL_AMFLAGS</code> variable at <span class="ent">➊</span> should be defined in the top-level <em>Makefile.am</em> file of any project that uses <code>AC_CONFIG_MACRO_DIR</code> (singular) in its <em>configure.ac</em> file. The flags specified on this line tell <code>aclocal</code> where it should look for macro files when it’s executed by rules defined in <em>Makefile.am</em>. The format of this option is similar to that of a C-compiler command line include (<code>-I</code>) directive; you can specify other <code>aclocal</code> command line options as well.</p>&#13;
<p class="indent">This variable used to be required when using a macro subdirectory with the older <code>AC_CONFIG_MACRO_DIR</code>, but with the advent of the newer <code>AC_CONFIG_MACRO_DIRS</code>, you no longer need this variable, as it generates code that allows Automake to understand which options it should pass to <code>aclocal</code>. Unfortunately, Libtool just can’t help but pipe up during <code>autoreconf</code> when it sees you using a macro directory without this variable in your <em>Makefile.am</em> files. I’m hoping this noise will go away when Autoconf takes ownership of the newer macro (with a subsequent release of Libtool, of course).</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_377"/>The Autotools use this variable in two unrelated places. The first is in a <code>make</code> rule generated to update the <em>aclocal.m4</em> file from all of its various input sources. This rule and its supporting variable definitions are shown in <a href="ch14.xhtml#ch14ex3">Listing 14-3</a>, which is a code snippet copied from an Autotools-generated makefile.</p>&#13;
<pre>ACLOCAL_M4 = $(top_srcdir)/aclocal.m4&#13;
ACLOCAL=${SHELL} .../flaim-ch8-10/missing --run aclocal-1.10&#13;
ACLOCAL_AMFLAGS = -I m4&#13;
$(ACLOCAL_M4): $(am__aclocal_m4_deps)&#13;
        cd $(srcdir) &amp;&amp; $(ACLOCAL) $(ACLOCAL_AMFLAGS)</pre>&#13;
<p class="caption" id="ch14ex3"><em>Listing 14-3: The <code>make</code> rule and the variables used to update</em> aclocal.m4 <em>from its various dependencies</em></p>&#13;
<p class="indent">The <code>ACLOCAL_AMFLAGS</code> definition is also used during execution of <code>autoreconf</code>, which scans the top-level <em>Makefile.am</em> file for this definition and passes the value text directly to <code>aclocal</code> on the command line. Be aware that <code>autoreconf</code> does no variable expansion on this string, so if you add shell or <code>make</code> variable references to the text, they won’t be expanded when <code>autoreconf</code> executes <code>aclocal</code>.</p>&#13;
<p class="indent">Returning to <a href="ch14.xhtml#ch14ex2">Listing 14-2</a>, I’ve used the <code>EXTRA_DIST</code> variable at <span class="ent">➋</span> to ensure that a few additional top-level files get distributed—these files and directories are specific to the Windows build system. This isn’t critical to the umbrella project, since I don’t intend to create distributions at this level, but I like to be complete.</p>&#13;
<p class="indent">The <code>SUBDIRS</code> variable at <span class="ent">➌</span> duplicates the information in the <em>configure.ac</em> file’s <code>AC_CONFIG_SUBDIRS</code> macro. I tried creating a shell substitution variable and exporting it with <code>AC_SUBST</code>, but it didn’t work—when I ran <code>autoreconf</code>, I got an error indicating that I should use literals in the <code>AC_CONFIG_SUBDIRS</code> macro argument.</p>&#13;
<p class="indent">The <code>rpms</code> and <code>srcrpm</code> targets at <span class="ent">➍</span> allow the end user to build RPM packages for RPM-based Linux systems. The shell commands in this rule simply pass the user-specified targets and variables down to each of the lower-level projects in succession, just as we did with our handcoded makefiles and <em>Makefile.in</em> templates in <a href="ch03.xhtml">Chapters 3</a>, <a href="ch04.xhtml">4</a>, and <a href="ch05.xhtml">5</a>.</p>&#13;
<p class="indent">When passing control to lower-level makefiles in the manner shown in the commands for these RPM targets, you should strive to follow this pattern. Passing the expansion of <code>AM_MAKEFLAGS</code> allows lower-level makefiles access to the same <code>make</code> flags defined in the current or parent makefile. However, you can add more functionality to such recursive <code>make</code> code. To see how Automake passes control down to lower-level makefiles for its own targets, open an Automake-generated <em>Makefile.in</em> template and search for the text “<code>$(am__recursive_targets):</code>”. The code beneath this target shows exactly how Automake does it. While it looks complex at first glance, the code performs only two additional tasks. First, it ensures that continue-after-error functionality (<code>make -k</code>) works properly. Second, it ensures that the current directory (<code>.</code>) is handled properly if found in the <code>SUBDIRS</code> variable.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_378"/>This brings me to my final point about this code: if you choose to write your own recursive targets in this manner (and we’ll see other examples of this later when we discuss conversion of the flaim build system), you should either avoid using a dot in the <code>SUBDIRS</code> variable or enhance the shell code to handle this special case. If you don’t, your users will likely find themselves in an endless recursion loop when they attempt to make one of these targets. For a more extensive treatise on this topic, see “Item 2: Implementing Recursive Extension Targets” on <a href="ch18.xhtml#page_505">page 505</a>.</p>&#13;
<h4 class="h4" id="ch14sec6">The FLAIM Subprojects</h4>&#13;
<p class="noindent">I used <code>autoscan</code> to generate a starting point for the ftk project. The <code>autoscan</code> utility is a bit finicky about where it will look for information. If your project doesn’t contain a makefile named exactly <em>Makefile</em>, or if your project already contains an Autoconf <em>Makefile.in</em> template, <code>autoscan</code> will not add any information about required libraries to the <em>configure.scan</em> output file. It has no way of determining this information except to look into your old build system, and it won’t do this unless conditions are just right.</p>&#13;
<p class="indent">Given the complexity of the ftk project’s legacy makefile, I was quite impressed with <code>autoscan</code>’s ability to parse it for library information. <a href="ch14.xhtml#ch14ex4">Listing 14-4</a> shows a portion of the resulting <em>configure.scan</em> file.</p>&#13;
<pre><span class="codeitalic1">--snip--</span>&#13;
AC_PREREQ([2.69])&#13;
AC_INIT(FULL-PACKAGE-NAME, VERSION, BUG-REPORT-ADDRESS)&#13;
AC_CONFIG_SRCDIR([src/ftktext.cpp])&#13;
AC_CONFIG_HEADERS([config.h])&#13;
&#13;
# Checks for programs.&#13;
AC_PROG_CXX&#13;
AC_PROG_CC&#13;
AC_PROG_INSTALL&#13;
&#13;
# Checks for libraries.&#13;
# FIXME: Replace `main' with a function in `-lc':&#13;
AC_CHECK_LIB([c], [main])&#13;
# FIXME: Replace `main' with a function in...&#13;
AC_CHECK_LIB([crypto], [main])&#13;
<span class="codeitalic1">--snip--</span>&#13;
AC_CONFIG_FILES([Makefile])&#13;
AC_OUTPUT</pre>&#13;
<p class="caption" id="ch14ex4"><em>Listing 14-4: A portion of the output from <code>autoscan</code> when run over the ftk project directory structure</em></p>&#13;
<h4 class="h4" id="ch14sec6-1"><span epub:type="pagebreak" id="page_379"/><em>The FLAIM Toolkit configure.ac File</em></h4>&#13;
<p class="noindent">After this <em>configure.scan</em> file was modified and renamed, the resulting <em>configure.ac</em> file contained many new constructs, which I’ll discuss in the next few sections. In order to facilitate the discussion, I split this file into two parts, the first half of which is shown in <a href="ch14.xhtml#ch14ex5">Listing 14-5</a>.</p>&#13;
<pre>   #                                               -*- Autoconf -*-&#13;
   # Process this file with autoconf to produce a configure script.&#13;
   AC_PREREQ([2.69])&#13;
<span class="ent">➊</span> AC_INIT([FLAIMTK],[1.2],[flaim-users@lists.sourceforge.net])&#13;
<span class="ent">➋</span> AM_INIT_AUTOMAKE([-Wall -Werror])&#13;
   AM_PROG_AR&#13;
   LT_PREREQ([2.4])&#13;
   LT_INIT([dlopen])&#13;
&#13;
<span class="ent">➌</span> AC_LANG([C++])&#13;
&#13;
<span class="ent">➍</span> AC_CONFIG_MACRO_DIRS([m4])&#13;
<span class="ent">➎</span> AC_CONFIG_SRCDIR([src/flaimtk.h])&#13;
   AC_CONFIG_HEADERS([config.h])&#13;
&#13;
   # Checks for programs.&#13;
   AC_PROG_CXX&#13;
   AC_PROG_INSTALL&#13;
&#13;
   # Checks for optional programs.&#13;
<span class="ent">➏</span> FLM_PROG_TRY_DOXYGEN&#13;
&#13;
   # Configure options: --enable-debug[=no].&#13;
<span class="ent">➐</span> AC_ARG_ENABLE([debug],&#13;
     [AS_HELP_STRING([--enable-debug],&#13;
       [enable debug code (default is no)])],&#13;
     [debug="$withval"], [debug=no])&#13;
&#13;
   # Configure option: --enable-openssl[=no].&#13;
   AC_ARG_ENABLE([openssl],&#13;
     [AS_HELP_STRING([--enable-openssl],&#13;
       [enable the use of openssl (default is no)])],&#13;
     [openssl="$withval"], [openssl=no])&#13;
&#13;
   # Create Automake conditional based on the DOXYGEN variable&#13;
<span class="ent">➑</span> AM_CONDITIONAL([HAVE_DOXYGEN], [test -n "$DOXYGEN"])&#13;
   #AM_COND_IF([HAVE_DOXYGEN], [AC_CONFIG_FILES([docs/doxyfile])])&#13;
<span class="ent">➒</span> AS_IF([test -n "$DOXYGEN"], [AC_CONFIG_FILES([docs/doxyfile])])&#13;
<span class="codeitalic1">--snip--</span></pre>&#13;
<p class="caption" id="ch14ex5"><em>Listing 14-5</em>: ftk/configure.ac: <em>The first half of the ftk project’s</em> configure.ac <em>file</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_380"/>At <span class="ent">➊</span>, you will see that I substituted real values for the placeholders <code>autoscan</code> left in the <code>AC_INIT</code> macro. I added calls to <code>AM_INIT_AUTOMAKE</code>, <code>LT_PREREQ</code>, and <code>LT_INIT</code> at <span class="ent">➋</span>, and I added a call to <code>AC_CONFIG_MACRO_DIRS</code> at <span class="ent">➍</span>. (For now, just ignore the <code>AM_PROG_AR</code> macro—I’ll explain it later in this chapter.)</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>I didn’t use the <em><code>foreign</code></em> keyword in <em><code>AM_INIT_AUTOMAKE</code></em> this time. Since it’s a real open source project, the FLAIM developers will (or at least, should) want these files. I used the <em><code>touch</code></em> command to create empty versions of the GNU project text files,<sup><a id="ch14fn_11" href="footnote.xhtml#ch14fn11">11</a></sup> except for</em> COPYING <em>and</em> INSTALL, <em>which <em><code>autoreconf</code></em> adds.</em></p>&#13;
</div>&#13;
<p class="indent">A new construct at <span class="ent">➌</span> is the <code>AC_LANG</code> macro, which indicates the programming language (and thus, the compiler) that Autoconf should use when generating compilation tests in <code>configure</code>. I’ve passed <code>C++</code> as the parameter so Autoconf will compile these tests using the C++ compiler via the <code>CXX</code> variable, rather than the default C compiler via the <code>CC</code> variable. I then deleted the <code>AC_PROG_CC</code> macro call, since the source code for this project is written entirely in C++.</p>&#13;
<p class="indent">I changed the <code>AC_CONFIG_SRCDIR</code> file argument at <span class="ent">➎</span> to one that made more sense to me than the one randomly chosen by <code>autoscan</code>.</p>&#13;
<p class="indent">The <code>FLM_PROG_TRY_DOXYGEN</code> macro at <span class="ent">➏</span> is a custom macro that I wrote. Here’s the prototype:</p>&#13;
<pre>FLM_PROG_TRY_DOXYGEN([quiet])</pre>&#13;
<p class="indent">I’ll cover the details of how this macro works in <a href="ch16.xhtml">Chapter 16</a>. For now, just know that it manages a precious variable called <code>DOXYGEN</code>. If the variable is already set, this macro does nothing; if the variable is not set, it scans the system search path for a <code>doxygen</code> program, setting the variable to the program name if it finds one. I’ll explain Autoconf precious variables when we get to the xflaim project.</p>&#13;
<p class="indent">At <span class="ent">➐</span>, I added a couple of configuration options to <code>configure</code>’s command line parser with <code>AC_ARG_ENABLE</code>. I’ll discuss the details of these calls more completely as we come to other new constructs that use the variables these macros define.</p>&#13;
<h5 class="h5">Automake Configuration Features</h5>&#13;
<p class="noindent">Automake provides the <code>AM_CONDITIONAL</code> macro I used at <span class="ent">➑</span>; it has the following prototype:</p>&#13;
<pre>AM_CONDITIONAL(<span class="codeitalic1">variable</span>, <span class="codeitalic1">condition</span>)</pre>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_381"/>The <em><code>variable</code></em> argument is an Automake conditional name that you can use in your <em>Makefile.am</em> files to test the associated condition. The <em><code>condition</code></em> argument is a <em>shell condition</em>—a bit of shell script that could be used as the condition in a shell <code>if-then</code> statement. In fact, this is exactly how the macro uses the <em><code>condition</code></em> argument internally, so it must be formatted as a proper <code>if-then</code> statement <em>condition</em> expression:</p>&#13;
<pre>if <span class="codeitalic1">condition</span>; then...</pre>&#13;
<p class="indent">The <code>AM_CONDITIONAL</code> macro always defines two Autoconf substitution variables named <em><code>variable</code></em><code>_TRUE</code> and <em><code>variable</code></em><code>_FALSE</code>. If <em><code>condition</code></em> is true, <em><code>variable</code></em><code>_TRUE</code> is empty and <em><code>variable</code></em><code>_FALSE</code> is defined as a hash mark (<code>#</code>), which indicates the beginning of a comment in a makefile. If <em><code>condition</code></em> is false, the definitions of these two substitution variables are reversed; that is, <em><code>variable</code></em><code>_FALSE</code> is empty, and <em><code>variable</code></em><code>_TRUE</code> becomes the hash mark. Automake uses these variables to conditionally comment out portions of your makefile script that are defined within Automake conditional statements.</p>&#13;
<p class="indent">This instance of <code>AM_CONDITIONAL</code> defines the conditional name <code>HAVE_DOXYGEN</code>, which you can use in the project’s <em>Makefile.am</em> files to do something conditionally, based on whether or not <code>doxygen</code> can be executed successfully (via the <code>DOXYGEN</code> variable). Any lines of <code>make</code> script found within a test for truth in <em>Makefile.am</em> are prefixed with <code>@</code><em><code>variable</code></em><code>_TRUE@</code> in the Automake-generated <em>Makefile.in</em> template. Conversely, any lines found within an Automake conditional test for falseness are prefixed with <code>@</code><em><code>variable</code></em><code>_FALSE@</code>. When <code>config.status</code> generates <em>Makefile</em> from <em>Makefile.in</em>, these lines are either commented out (prefixed with hash marks) or not, depending on the truth or falseness of the condition.</p>&#13;
<p class="indent">There’s just one caveat with using <code>AM_CONDITIONAL</code>: you cannot call it conditionally (for instance, within a shell <code>if-then-else</code> statement) in the <em>configure.ac</em> file. You can’t define substitution variables conditionally—you can define their contents differently based on the specified condition, but the variables themselves are either defined or not at the time Autoconf creates the <code>configure</code> script. Since Automake-generated template files are created long before the user executes <code>configure</code>, Automake must be able to rely on the existence of these variables, regardless of how they’re defined.</p>&#13;
<p class="indent">Within the <code>configure</code> script, you may want to perform other Autoconf operations based on the value of Automake conditionals. This is where the (commented) Automake-provided <code>AM_COND_IF</code> macro at <span class="ent">➒</span> comes into play.<sup><a id="ch14fn_12" href="footnote.xhtml#ch14fn12">12</a></sup> Its prototype is as follows:</p>&#13;
<pre>AM_COND_IF(<span class="codeitalic1">conditional-variable</span>, [<span class="codeitalic1">if-true</span>], [<span class="codeitalic1">if-false</span>])</pre>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_382"/>If <em><code>conditional-variable</code></em> is defined as true by a previous call to <code>AM_CONDITIONAL</code>, the <em><code>if-true</code></em> shell script (including any Autoconf macro calls) is executed. Otherwise, the <em><code>if-false</code></em> shell script is executed.</p>&#13;
<p class="indent">Now let’s suppose, for example, that you want to conditionally build a portion of your project directory structure—say, the <em>xflaim/docs/doxygen</em> directory—based on the Automake conditional <code>HAVE_DOXYGEN</code>. Perhaps you are appending the subdirectory in question onto the <code>SUBDIRS</code> variable within an Automake conditional statement in your <em>Makefile.am</em> file (I’m actually doing this, as you’ll see in “The FLAIM Toolkit Makefile.am File” on <a href="ch14.xhtml#page_388">page 388</a>). Since <code>make</code> won’t be building this portion of the project directory structure if the condition is false, there’s certainly little reason to have <code>config.status</code> process the <em>doxyfile.in</em> template within that directory during configuration. Therefore, you might use the code shown in <a href="ch14.xhtml#ch14ex6">Listing 14-6</a> in your <em>configure.ac</em> file.</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">AM_CONDITIONAL([HAVE_DOXYGEN], [test -n "$DOXYGEN"])</span>&#13;
AM_COND_IF([HAVE_DOXYGEN], [AC_CONFIG_FILES([docs/doxyfile])])&#13;
<span class="ash">#AS_IF([test -n "$DOXYGEN"], [AC_CONFIG_FILES([docs/doxyfile])])</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch14ex6"><em>Listing 14-6</em>: ftk/configure.ac: <em>Using <code>AM_COND_IF</code> to conditionally configure a template</em></p>&#13;
<p class="indent">With this code in place, <code>configure</code> simply will not process the <em>doxyfile.in</em> template at all within the <em>docs</em> directory if <code>doxygen</code> isn’t installed on the user’s system.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>The</em> docs/Makefile.in <em>template should not be included here because the <em><code>dist</code></em> target must be able to process all directories in the project—whether or not they’re conditionally built—during execution of build targets such as <em><code>all</code></em> and <em><code>clean</code></em>. Thus, you should never conditionally process</em> Makefile.in <em>templates within</em> configure.ac. <em>However, you can certainly process other types of templates conditionally.</em></p>&#13;
</div>&#13;
<p class="indent">The line following the line at <span class="ent">➒</span> is an alternative method of accomplishing the same thing using <em>M4sh</em>—a macro library built into Autoconf that’s designed to make it easier to write portable Bourne shell script. Here is the prototype:</p>&#13;
<pre>AS_IF(<span class="codeitalic1">test1</span>, [<span class="codeitalic1">run-if-true</span>], ..., [<span class="codeitalic1">run-if-false</span>])</pre>&#13;
<p class="indent">The optional, elided parameters between the second and last ones shown are pairs of <em><code>test</code></em><code>N</code> and <em><code>run-if-true</code></em> arguments. Ultimately, this macro works much like an <code>if-then-elif...</code> shell statement with a user-specified number of <code>elif</code> conditions.</p>&#13;
<p class="indent"><a href="ch14.xhtml#ch14ex7">Listing 14-7</a> shows the second half of ftk’s <em>configure.ac</em> file.</p>&#13;
<pre>   <span class="codeitalic1">--snip--</span>&#13;
   # Configure for large files, even in 32-bit environments&#13;
<span class="ent">➊</span> AC_SYS_LARGEFILE&#13;
   <span epub:type="pagebreak" id="page_383"/># Check for pthreads&#13;
<span class="ent">➋</span> AX_PTHREAD(&#13;
     [AC_DEFINE([HAVE_PTHREAD], [1],&#13;
       [Define if you have POSIX threads libraries and header files.])&#13;
     LIBS="$PTHREAD_LIBS $LIBS"&#13;
     CFLAGS="$CFLAGS $PTHREAD_CFLAGS"&#13;
     CXXFLAGS="$CXXFLAGS $PTHREAD_CXXFLAGS"])&#13;
&#13;
<span class="ent">➌</span> # Checks for libraries.&#13;
   AC_SEARCH_LIBS([initscr], [ncurses])&#13;
   AC_CHECK_HEADER([curses.h],,[echo "*** Error: curses.h not found - install&#13;
   curses devel package."; exit 1])&#13;
   AC_CHECK_LIB([rt], [aio_suspend])&#13;
   AS_IF([test "x$openssl" = xyes],&#13;
   <span class="ent">➍</span> [AC_DEFINE([FLM_OPENSSL], [1], [Define to use openssl])&#13;
      AC_CHECK_LIB([ssl], [SSL_new])&#13;
      AC_CHECK_LIB([crypto], [CRYPTO_add])&#13;
      AC_CHECK_LIB([dl], [dlopen])&#13;
      AC_CHECK_LIB([z], [gzopen])])&#13;
&#13;
<span class="ent">➎</span> # Checks for header files.&#13;
   AC_HEADER_RESOLV&#13;
   AC_CHECK_HEADERS([arpa/inet.h fcntl.h limits.h malloc.h netdb.h netinet/in.h&#13;
   stddef.h stdlib.h string.h strings.h sys/mount.h sys/param.h sys/socket.h sys/&#13;
   statfs.h sys/statvfs.h sys/time.h sys/vfs.h unistd.h utime.h])&#13;
&#13;
   # Checks for typedefs, structures, and compiler characteristics.&#13;
   AC_CHECK_HEADER_STDBOOL&#13;
   AC_C_INLINE&#13;
   AC_TYPE_INT32_T&#13;
   AC_TYPE_MODE_T&#13;
   AC_TYPE_PID_T&#13;
   AC_TYPE_SIZE_T&#13;
   AC_CHECK_MEMBERS([struct stat.st_blksize])&#13;
   AC_TYPE_UINT16_T&#13;
   AC_TYPE_UINT32_T&#13;
   AC_TYPE_UINT8_T&#13;
&#13;
   # Checks for library functions.&#13;
   AC_FUNC_LSTAT_FOLLOWS_SLASHED_SYMLINK&#13;
   AC_FUNC_MALLOC&#13;
   AC_FUNC_MKTIME&#13;
   AC_CHECK_FUNCS([atexit fdatasync ftruncate getcwd gethostbyaddr gethostbyname&#13;
   gethostname gethrtime gettimeofday inet_ntoa localtime_r memmove memset mkdir&#13;
   pstat_getdynamic realpath rmdir select socket strchr strrchr strstr])&#13;
&#13;
   # Configure DEBUG source code, if requested.&#13;
<span class="ent">➏</span> AS_IF([test "x$debug" = xyes],&#13;
     [AC_DEFINE([FLM_DEBUG], [1], [Define to enable FLAIM debug features])])&#13;
&#13;
<span class="ent">➐</span> <span class="codeitalic1">--snip--</span>&#13;
&#13;
<span class="ent">➑</span> AC_CONFIG_FILES([Makefile&#13;
                      docs/Makefile&#13;
                      obs/Makefile&#13;
<span epub:type="pagebreak" id="page_384"/>                      obs/flaimtk.spec&#13;
                      src/Makefile&#13;
                      util/Makefile&#13;
                      src/libflaimtk.pc])&#13;
&#13;
   AC_OUTPUT&#13;
&#13;
   # Fix broken libtool&#13;
   sed 's/link_all_deplibs=no/link_all_deplibs=yes/' libtool &gt;libtool.tmp &amp;&amp; \&#13;
     mv libtool.tmp libtool&#13;
&#13;
<span class="ent">➒</span> cat &lt;&lt;EOF&#13;
&#13;
     FLAIM toolkit ($PACKAGE_NAME) version $PACKAGE_VERSION&#13;
     Prefix.........: $prefix&#13;
     Debug Build....: $debug&#13;
     Using OpenSSL..: $openssl&#13;
     C++ Compiler...: $CXX $CXXFLAGS $CPPFLAGS&#13;
     Linker.........: $LD $LDFLAGS $LIBS&#13;
     Doxygen........: ${DOXYGEN:-NONE}&#13;
&#13;
   EOF</pre>&#13;
<p class="caption" id="ch14ex7"><em>Listing 14-7</em>: ftk/configure.ac: <em>The second half of the ftk project’s</em> configure.ac <em>file</em></p>&#13;
<p class="indent">At <span class="ent">➊</span>, I’ve called the <code>AC_SYS_LARGEFILE</code> macro. If the user has a 32-bit system, this macro ensures that appropriate C-preprocessor definitions (and possibly compiler options) that force the use of 64-bit file addressing (also called <em>large files</em>) are added to the <em>config.h.in</em> template. With these variables in place, C-library large-address-aware file I/O functions become available to the project source code. FLAIM, as a database system, cares very much about this feature.</p>&#13;
<p class="indent">In the last few years, 32-bit general-purpose computer systems have become less popular as companies like Intel and Microsoft have made media statements concerning future versions of their products that will no longer support 32-bit address spaces. However, market pressures caused by the millions of existing 32-bit systems have cause them to back off a bit on the rhetoric and return to a more pragmatic perspective. Nevertheless, 32-bit PCs are on their way out the door in the not-too-distant future. Even so, Linux will continue to run on 32-bit systems because many embedded systems still get significant benefits from using smaller, less-power-hungry 32-bit microprocessors.</p>&#13;
<h5 class="h5">Doing Threads the Right Way</h5>&#13;
<p class="noindent">There is another new construct, <code>AX_PTHREAD</code>, at <span class="ent">➋</span>. In the Jupiter project, I simply linked the <code>jupiter</code> program with the <em>pthreads</em> library via the <code>-lpthread</code> linker flag. But frankly, this is the wrong way to use <em>pthreads</em>.</p>&#13;
<p class="indent">In the presence of multiple threads of execution, you must configure many of the standard C-library functions to act in a thread-safe manner. You can do this by ensuring that one or more preprocessor definitions are visible to all of the standard library header files as they’re being compiled into the <span epub:type="pagebreak" id="page_385"/>program. These C-preprocessor definitions must be defined on the compiler command line, and they’re not standardized between compiler vendors.</p>&#13;
<p class="indent">Some vendors provide entirely different standard libraries for building single-threaded versus multithreaded programs, because adding thread safety to a library reduces performance to a degree. Compiler vendors believe (correctly) that they’re doing you a favor by giving you different versions of the standard library for these purposes. In this scenario, it’s necessary to tell the linker to use the correct runtime libraries.</p>&#13;
<p class="indent">Unfortunately, every vendor does multithreading in its own way, from compiler options to library names to preprocessor definitions. But there is a reasonable solution to the problem: the GNU Autoconf Archive<sup><a id="ch14fn_13" href="footnote.xhtml#ch14fn13">13</a></sup> provides a macro called <code>AX_PTHREAD</code> that checks out a user’s compiler and provides the correct flags and options for a wide variety of platforms.</p>&#13;
<p class="indent">This macro is very simple to use:</p>&#13;
<pre>AX_PTHREAD(<span class="codeitalic1">action-if-found</span>[, <span class="codeitalic1">action-if-not-found</span>])</pre>&#13;
<p class="indent">It sets several environment variables, including <code>PTHREAD_CFLAGS</code>, <code>PTHREAD</code><code>_CXXFLAGS</code>, and <code>PTHREAD_LIBS</code>. It’s up to the caller to use these variables properly by adding shell code to the <em><code>action-if-found</code></em> argument. If all of your project’s code is multithreaded, things are simpler: you need only append these variables to, or consume them from within, the standard <code>CFLAGS</code>, <code>CXXFLAGS</code>, and <code>LIBS</code> variables. The FLAIM project code base is completely multithreaded, so I chose to do this.</p>&#13;
<p class="indent">If you examine the contents of the <em>ax_pthread.m4</em> file in the <em>ftk/m4</em> directory, you might expect to find a large <code>case</code> statement that sets options for every compiler and platform combination known to man—but that’s not the Autoconf way.</p>&#13;
<p class="indent">Instead, the macro incorporates a long list of known <em>pthreads</em> compiler options, and the generated <code>configure</code> script uses the host compiler to compile a small <em>pthreads</em> program with each one of these options in turn. The flags that are recognized by the compiler, and that therefore properly build the test program, are added to the <code>PTHREAD_CFLAGS</code> and <code>PTHREAD_CXXFLAGS</code> variables. This way, <code>AX_PTHREAD</code> stands a good chance of continuing to work properly, even in the face of significant changes to compiler options in the future—and this <em>is</em> the Autoconf way.</p>&#13;
<h5 class="h5">Getting Just the Right Libraries</h5>&#13;
<p class="noindent">I deleted the <em>FIXME</em> comments (see <em>configure.scan</em> in <a href="ch14.xhtml#ch14ex4">Listing 14-4</a> on <a href="ch14.xhtml#page_378">page 378</a>) above each of the <code>AC_CHECK_LIB</code> macro calls at <span class="ent">➌</span> in <a href="ch14.xhtml#ch14ex7">Listing 14-7</a>. I started to replace the main placeholders in these macros with actual library function names, but then I began to wonder if all of those libraries were really necessary. I wasn’t as concerned about <code>autoscan</code>’s abilities as I was about the veracity of the original makefile. In handcoded build systems, I’ve <span epub:type="pagebreak" id="page_386"/>occasionally noticed that the author will cut and paste sets of library names from one makefile to another until the program builds without missing symbols.<sup><a id="ch14fn_14" href="footnote.xhtml#ch14fn14">14</a></sup></p>&#13;
<p class="indent">Instead of blindly continuing this trend, I chose to simply comment out all of the calls to <code>AC_CHECK_LIB</code> to see how far I could get in the build, adding them back in one at a time as required to resolve missing symbols. Unless your project consumes literally hundreds of libraries, this will only take a few extra minutes. I like to link only the libraries that are necessary for my project; it speeds up the link process and, when done religiously, provides a good form of project-level documentation.</p>&#13;
<p class="indent">The <em>configure.scan</em> file contained 14 such calls to <code>AC_CHECK_LIB</code>. As it turned out, the FLAIM toolkit on my 64-bit Linux system only required three of them—<em>pthread</em>, <em>ncurses</em>, and <em>rt</em>—so I deleted the remaining entries and swapped out the placeholder parameters for real functions in the <em>ncurses</em> and <em>rt</em> libraries. In retrospect, it appears that my gambit paid off rather handsomely, because I dropped from 14 libraries to 2. The third library was the POSIX Thread (<em>pthreads</em>) library, which is added via the <code>AX_PTHREAD</code> macro I discussed in the previous section.</p>&#13;
<p class="indent">I also converted the <em>ncurses</em> <code>AC_CHECK_LIB</code> call to <code>AC_SEARCH_LIBS</code> because I suspect that future FLAIM platforms may use different library names for <em>curses</em> functionality. I’d like to prepare the build system to have additional libraries searched on these platforms. The <em>ncurses</em> library is an optional library on most platforms, so I added the <code>AC_CHECK_HEADER</code> macro to check for <em>curses.h</em>, display a message in the <em><code>action-if-not-found</code></em> (third) argument that the user should install the <em>curses-development</em> package, and exit the configuration process with an error. The rule is to find problems early, during configuration, rather than during compilation.</p>&#13;
<h5 class="h5">Maintainer-Defined Command Line Options</h5>&#13;
<p class="noindent">The next four libraries are checked within an Autoconf conditional statement at <span class="ent">➍</span>. This statement is based on the end user’s use of the <code>--enable-openssl</code> command line argument, which <code>AC_ARG_ENABLE</code> provides (see <span class="ent">➐</span> in <a href="ch14.xhtml#ch14ex5">Listing 14-5</a> on <a href="ch14.xhtml#page_379">page 379</a>).</p>&#13;
<p class="indent">I use <code>AS_IF</code> here instead of a shell <code>if-then</code> statement because, if any of the macros called within the conditional statement require additional macros to be expanded in order to operate correctly, <code>AS_IF</code> will ensure that these dependencies are expanded first, outside of the conditional statement. As well as being part of the <em>M4sh</em> library, the <code>AS_IF</code> macro is part of the Autoconf auto-dependency framework (also discussed in detail in “Autoconf and M4” on <a href="ch16.xhtml#page_439">page 439</a>).</p>&#13;
<p class="indent">In this case, the <code>openssl</code> variable is defined to either <code>yes</code> or <code>no</code> based on the default value given to <code>AC_ARG_ENABLE</code> and on the end user’s command line choices.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_387"/>The <code>AC_DEFINE</code> macro, called in the first argument of <code>AS_IF</code>, ensures that the C-preprocessor variable <code>FLM_OPENSSL</code> is defined in the <em>config.h</em> header file. The <code>AC_CHECK_LIB</code> macros then ensure that <code>-lssl</code>, <code>-lcrypto</code>, <code>-ldl</code>, and <code>-lz</code> strings are added to the <code>LIBS</code> variable, but only if the <code>openssl</code> variable is set to <code>yes</code>. We don’t want to insist that the user have those libraries installed unless they have asked for features that need them.</p>&#13;
<p class="indent">You can get as sophisticated as you want when dealing with maintainer-defined command line options such as <code>--enable-openssl</code>. But be careful: some levels of automation can surprise your users. For instance, automatically enabling the option because your checks found that the OpenSSL libraries were installed and accessible can be a bit disconcerting.</p>&#13;
<p class="indent">I left all the header file and library function checks at <span class="ent">➎</span>, as specified by <code>autoscan</code>, because a simple text scan through the source code for header files and function names is probably pretty accurate.</p>&#13;
<p class="indent">Notice, however, that <code>autoscan</code> did not put <em>all</em> of the header files used by ftk source code into the <code>AC_CHECK_HEADERS</code> argument. The <code>autoscan</code> utility’s algorithm is simple but effective: it adds all header files included conditionally by your source code. This approach assumes that any header file you include conditionally might be included differently on different platforms due to portability issues. While this approach is usually correct, it’s not always correct, so you should look at each of the headers added, find the conditional inclusion in your source code, and make a more intelligent assessment of whether or not it should be added to <code>AC_CHECK_HEADERS</code> in <em>configure.ac</em>.</p>&#13;
<p class="indent">A good example in this project is the conditional inclusion of <em>stdlib.h</em>. As it happens, <em>stdlib.h</em> is included for Windows builds, and it’s also included for Unix builds. It is not, however, included for NetWare builds. Regardless, it doesn’t really need to be checked for in <code>AC_CHECK_HEADERS</code> for two reasons. First, it’s widely standardized across platforms, and second, this build system is specifically designed for Unix systems.<sup><a id="ch14fn_15" href="footnote.xhtml#ch14fn15">15</a></sup> The point is, you should carefully examine what <code>autoscan</code> does for you to determine if it should be done in your project.</p>&#13;
<p class="indent">At <span class="ent">➏</span>, we see the conditional (<code>AS_IF</code>) use of <code>AC_DEFINE</code> based on the contents of the <code>debug</code> variable. This is another environment variable that’s conditionally defined based on the results of a command line parameter given to <code>configure</code>. The <code>--enable-debug</code> option sets the debug variable to <code>yes</code>, which ultimately enables the <code>FLM_DEBUG</code> C-preprocessor definition within <em>config.h</em>. Both <code>FLM_OPENSSL</code> and <code>FLM_DEBUG</code> were already used within the FLAIM project source code. Using <code>AC_DEFINE</code> in this manner allows the end user to determine which features are compiled into the libraries.</p>&#13;
<p class="indent">I left a fairly large chunk of code out of the listing at <span class="ent">➐</span> that deals with compiler and tool optimizations, which I’ll present in the next chapter. This code is identical in all of the projects’ <em>configure.ac</em> files.</p>&#13;
<p class="indent">Finally, I added references to the makefiles in the <em>docs</em>, <em>obs</em>, <em>src</em>, and <em>util</em> directories, as well as the <em>obs/flaimtk.spec</em> and <em>src/libflaimtk.pc</em> files at <span class="ent">➑</span> to the <code>AC_CONFIG_FILES</code> macro call, and then I added my usual <code>cat</code> statement at <span class="ent">➒</span> <span epub:type="pagebreak" id="page_388"/>near the bottom for some visual verification of my configuration status. For now, just ignore the <code>sed</code> command right above the <code>cat</code> statement. I’ll cover that in “Transitive Dependencies” on <a href="ch14.xhtml#page_401">page 401</a>.</p>&#13;
<h4 class="h4" id="ch14sec6-2"><em>The FLAIM Toolkit Makefile.am File</em></h4>&#13;
<p class="noindent">If we ignore the commands for Doxygen- and RPM-specific targets (for now), the <em>ftk/Makefile.am</em> file is fairly trivial. <a href="ch14.xhtml#ch14ex8">Listing 14-8</a> shows the entire file.</p>&#13;
<pre>   ACLOCAL_AMFLAGS = -I m4&#13;
&#13;
   EXTRA_DIST = GNUMakefile README.W32 debian netware win32&#13;
&#13;
<span class="ent">➊</span> if HAVE_DOXYGEN&#13;
     DOXYDIR = docs&#13;
   endif&#13;
&#13;
   SUBDIRS = src util obs $(DOXYDIR)&#13;
&#13;
<span class="ent">➋</span> doc_DATA = AUTHORS ChangeLog COPYING INSTALL NEWS README&#13;
&#13;
   RPM = rpm&#13;
&#13;
<span class="ent">➌</span> rpms srcrpm: dist&#13;
          (cd obs &amp;&amp; $(MAKE) $(AM_MAKEFLAGS) $@) || exit 1&#13;
           rpmarch=`$(RPM) --showrc | \&#13;
             grep "^build arch" | sed 's/\(.*: \)\(.*\)/\2/'`; \&#13;
           test -z "obs/$$rpmarch" || \&#13;
             ( mv obs/$$rpmarch/* . &amp;&amp; rm -rf obs/$$rpmarch )&#13;
           rm -rf obs/$(distdir)&#13;
&#13;
<span class="ent">➍</span> #dist-hook:&#13;
   #        rm -rf `find $(distdir) -name .svn`&#13;
&#13;
   .PHONY: srcrpm rpms</pre>&#13;
<p class="caption" id="ch14ex8"><em>Listing 14-8</em>: ftk/Makefile.am: <em>The entire contents of the FLAIM toolkit’s top-level makefile</em></p>&#13;
<p class="indent">In this file you’ll find the usual <code>ACLOCAL_AMFLAGS</code>, <code>EXTRA_DIST</code>, and <code>SUBDIRS</code> variable definitions, but you can also see the use of an Automake conditional at <span class="ent">➊</span>. The <code>if</code> statement allows me to append another directory (<em>docs</em>) to the <code>SUBDIRS</code> list, but only if the <code>doxygen</code> program is available (according to <code>configure</code>). I used a separate variable here (<code>DOXYDIR</code>), but the Automake conditional could just as well have surrounded a statement that directly appends the directory name (<code>doc</code>) to the <code>SUBDIRS</code> variable using the Automake <code>+=</code> operator.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Don’t confuse Automake conditionals with GNU Make conditionals, which use the keywords <em><code>ifeq</code></em>, <em><code>ifneq</code></em>, <em><code>ifdef</code></em>, and <em><code>ifndef</code></em>. If you try to use an Automake conditional in</em> Makefile.am <em>without a corresponding <em><code>AM_CONDITIONAL</code></em> statement in</em> configure.ac, <em>Automake will complain about it. When this construct is used properly, Automake converts it to something that <em><code>make</code></em> understands before <em><code>make</code></em> sees it.</em></p>&#13;
</div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_389"/>Another new construct (at least in a top-level <em>Makefile.am</em> file) is the use of the <code>doc_DATA</code> variable at <span class="ent">➋</span>. The FLAIM toolkit provides some extra documentation files in its top-level directory that I’d like to have installed. By using the <code>doc</code> prefix on the <code>DATA</code> primary, I’m telling Automake that I’d like these files to be installed as data files in the <code>$(docdir)</code> directory, which ultimately resolves to the <code>$(prefix)</code><em>/share/doc</em> directory, by default.</p>&#13;
<p class="indent">Files mentioned in <code>DATA</code> variables that don’t already have special meaning to Automake are not automatically distributed (that is, they’re not added to distribution tarballs), so you have to manually distribute them by adding them to the files listed in the <code>EXTRA_DIST</code> variable.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>I did not have to list the standard GNU project text files in <em><code>EXTRA_DIST</code></em> because they’re always distributed automatically. However, I did have to mention theses files in the <em><code>doc_DATA</code></em> variable, because Automake makes no assumptions about which files you want to install.</em></p>&#13;
</div>&#13;
<p class="indent">I’ll defer a discussion of the RPM targets at <span class="ent">➌</span> to the next chapter.</p>&#13;
<h5 class="h5">Automake -hook and -local Rules</h5>&#13;
<p class="noindent">Automake recognizes two types of integrated extensions, which I call <code>-local</code> targets and <code>-hook</code> targets. Automake recognizes and honors <code>-local</code> extensions for the following standard targets:</p>&#13;
<table class="topbot-d">&#13;
<colgroup>&#13;
<col style="width:25%"/>&#13;
<col style="width:35%"/>&#13;
<col style="width:40%"/>&#13;
</colgroup>&#13;
<tbody>&#13;
<tr>&#13;
<td style="vertical-align: top;"><p class="para"><code>all</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>install-data</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>installcheck</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;"><p class="para"><code>check</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>install-dvi</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>installdirs</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;"><p class="para"><code>clean</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>install-exec</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>maintainer-clean</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;"><p class="para"><code>distclean</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>install-html</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>mostlyclean</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;"><p class="para"><code>dvi</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>install-info</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>pdf</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;"><p class="para"><code>html</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>install-pdf</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>ps</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;"><p class="para"><code>info</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>install-ps</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>uninstall</code></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<p class="indent">Appending <code>-local</code> to any of these in your <em>Makefile.am</em> files will cause the associated commands to be executed <em>before</em> the standard target. Automake does this by generating the rule for the standard target so that the <code>-local</code> version is one of its dependencies (if it exists).<sup><a id="ch14fn_16" href="footnote.xhtml#ch14fn16">16</a></sup> In “Cleaning Your Room” on <a href="ch14.xhtml#page_404">page 404</a>, I’ll show an example of this concept using a <code>clean-local</code> target.</p>&#13;
<p class="indent">The <code>-hook</code> targets are a bit different in that they are executed <em>after</em> the corresponding standard target is executed.<sup><a id="ch14fn_17" href="footnote.xhtml#ch14fn17">17</a></sup> Automake does this by adding another command to the end of the standard target command list. This command merely executes <code>$(MAKE)</code> on the containing makefile, with the <span epub:type="pagebreak" id="page_390"/><code>-hook</code> target as the command line target. Thus, the <code>-hook</code> target is executed at the end of the standard target commands in a recursive fashion.</p>&#13;
<p class="indent">The following standard Automake targets support <code>-hook</code> versions:</p>&#13;
<table class="topbot-d">&#13;
<colgroup>&#13;
<col style="width:40%"/>&#13;
<col style="width:40%"/>&#13;
<col style="width:20%"/>&#13;
</colgroup>&#13;
<tbody>&#13;
<tr>&#13;
<td style="vertical-align: top;"><p class="para"><code>dist</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>install-data</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>uninstall</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;"><p class="para"><code>distcheck</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>install-exec</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"> </p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<p class="indent">Automake automatically adds all existing <code>-local</code> and <code>-hook</code> targets to the <code>.PHONY</code> rule within the generated makefile.</p>&#13;
<p class="indent">In the first edition of this book, I used the <code>dist-hook</code> target at <span class="ent">➍</span> in <em>Makefile.am</em> (now commented out) to adjust the distribution directory after it’s built but before <code>make</code> builds a distribution archive from its contents. The <code>rm</code> command removed extraneous files and directories that became part of the distribution directory as a result of my adding entire directories to the <code>EXTRA_DIST</code> variable. When you add directory names to <code>EXTRA_DIST</code> (<em>debian</em>, <em>netware</em>, and <em>win32</em>, in this case), everything in those directories is added to the distribution—even hidden repository control files and directories.<sup><a id="ch14fn_18" href="footnote.xhtml#ch14fn18">18</a></sup></p>&#13;
<p class="indent"><a href="ch14.xhtml#ch14ex9">Listing 14-9</a> is a portion of the generated <em>Makefile</em> that shows how Automake incorporates <code>dist-hook</code> into the final makefile. The relevant portions are highlighted.</p>&#13;
<pre><span class="codeitalic1">--snip</span><span class="codeitalic1">--</span>&#13;
distdir: $(DISTFILES)&#13;
        <span class="ash">... # copy files into distdir</span>&#13;
        $(MAKE) $(AM_MAKEFLAGS) top_distdir="$(top_distdir)" \&#13;
            distdir="$(distdir)" dist-hook&#13;
        <span class="ash">... # change attributes of files in distdir</span>&#13;
<span class="codeitalic1a">--snip--</span>&#13;
dist <span class="ash">dist-all:</span> distdir&#13;
        <span class="ash">tardir=$(distdir) &amp;&amp; $(am__tar) | GZIP=$(GZIP_ENV) gzip -c \</span>&#13;
          &gt;<span class="ash">$(distdir).tar.gz</span>&#13;
        <span class="ash">$(am__remove_distdir)</span>&#13;
<span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">.PHONY: ...</span> dist-hook <span class="ash">...</span>&#13;
<span class="codeitalic1a">--snip--</span>&#13;
dist-hook:&#13;
        rm -rf `find $(distdir) -name .svn`&#13;
<span class="codeitalic1">--snip</span><span class="codeitalic1">--</span></pre>&#13;
<p class="caption" id="ch14ex9"><em>Listing 14-9: The results of defining the <code>dist-hook</code> target in</em> ftk/Makefile.am</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Don’t be afraid to dig into the generated makefiles to see exactly what Automake is doing with your code. While there is a fair amount of ugly shell code in the <em><code>make</code></em> commands, most of it is safe to ignore. You’re usually more interested in the <em><code>make</code></em> rules that Automake is generating, and it’s easy to separate these out.</em></p>&#13;
</div>&#13;
<h4 class="h4" id="ch14sec6-3"><span epub:type="pagebreak" id="page_391"/><em>Designing the ftk/src/Makefile.am File</em></h4>&#13;
<p class="noindent">I now need to create <em>Makefile.am</em> files in the <em>src</em> and <em>utils</em> directories for the FLAIM toolkit project. I want to ensure that all of the original functionality is preserved from the old build system as I’m creating these files. Basically, this includes:</p>&#13;
<ul>&#13;
<li class="noindent">Properly building the ftk shared and static libraries</li>&#13;
<li class="noindent">Properly specifying installation locations for all installed files</li>&#13;
<li class="noindent">Setting the ftk shared-library version information correctly</li>&#13;
<li class="noindent">Ensuring that all remaining unused files are distributed</li>&#13;
<li class="noindent">Ensuring that platform-specific compiler options are used</li>&#13;
</ul>&#13;
<p class="indent">The template shown in <a href="ch14.xhtml#ch14ex10">Listing 14-10</a> should cover most of these points, so I’ll be using it for all of the FLAIM library projects, with appropriate additions and subtractions, based on the needs of each individual library.</p>&#13;
<pre>EXTRA_DIST = ...&#13;
&#13;
lib_LTLIBRARIES = ...&#13;
include_HEADERS = ...&#13;
&#13;
<span class="codeitalic1">xxxxx</span>_la_SOURCES = ...&#13;
<span class="codeitalic1">xxxxx</span>_la_LDFLAGS = -version-info x:y:z</pre>&#13;
<p class="caption" id="ch14ex10"><em>Listing 14-10: A framework for the src and utils directory</em> Makefile.am <em>files</em></p>&#13;
<p class="indent">The original <em>GNUMakefile</em> told me that the library was named <em>libftk.so</em>. This is a bad name for a library on Linux, because most of the three-letter library names are already taken. Thus, I made an executive decision and renamed the <em>ftk</em> library to <em>flaimtk</em>.</p>&#13;
<p class="indent"><a href="ch14.xhtml#ch14ex11">Listing 14-11</a> shows most of the final <em>ftk/src/Makefile.am</em> file.</p>&#13;
<pre><span class="ent">➊</span> EXTRA_DIST = ftknlm.h&#13;
&#13;
<span class="ent">➋</span> lib_LTLIBRARIES = libflaimtk.la&#13;
<span class="ent">➌</span> include_HEADERS = flaimtk.h&#13;
&#13;
<span class="ent">➍</span> pkgconfigdir = $(libdir)/pkgconfig&#13;
   pkgconfig_DATA = libflaimtk.pc&#13;
&#13;
<span class="ent">➎</span> libflaimtk_la_SOURCES = \&#13;
   ftkarg.cpp \&#13;
   ftkbtree.cpp \&#13;
   ftkcmem.cpp \&#13;
   ftkcoll.cpp \&#13;
   <span class="codeitalic1">--snip--</span>&#13;
   ftksys.h \&#13;
   ftkunix.cpp \&#13;
   ftkwin.cpp \&#13;
   <span epub:type="pagebreak" id="page_392"/>ftkxml.cpp&#13;
&#13;
<span class="ent">➏</span> libflaimtk_la_LDFLAGS = -version-info 0:0:0</pre>&#13;
<p class="caption" id="ch14ex11"><em>Listing 14-11</em>: ftk/src/Makefile.am: <em>The entire file contents, minus a few dozen source files</em></p>&#13;
<p class="indent">I added the Libtool library name, <em>libflaimtk.la</em>, to the <code>lib_LTLIBRARIES</code> list at <span class="ent">➋</span> and changed the <em><code>xxxxx</code></em> portions of the remaining macros in <a href="ch14.xhtml#ch14ex10">Listing 14-10</a> to <code>libflaimtk</code>. I could have entered all the source files by hand, but I noticed while reading the original makefile that it used the GNU <code>make</code> function macro <code>$(wildcard src/*.cpp)</code> to build the file list from the contents of the <em>src</em> directory. This tells me that all of the <em>.cpp</em> files within the <em>src</em> directory are required (or at least consumed) by the library. To get the file list into <em>Makefile.am</em>, I used a simple shell command to concatenate it to the end of the <em>Makefile.am</em> file (assuming I’m in the <em>ftk/src</em> directory):</p>&#13;
<pre>$ <span class="codestrong1">printf '%s \\\n' *.cpp &gt;&gt; Makefile.am</span></pre>&#13;
<p class="indent">This left me with a single-column, backslash-terminated, alphabetized list of all of the <em>.cpp</em> files in the <em>ftk/src</em> directory at the bottom of <em>ftk/src/Makefile.am</em>.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Do not forget the single quotes around the <em><code>printf</code></em> argument, which are necessary to keep the first pair of backslashes from being interpreted by the shell as escape characters during generation of the list. Regardless of quoting, <em><code>printf</code></em> understands and interprets the <em><code>\n</code></em> character properly.</em></p>&#13;
</div>&#13;
<p class="indent">I moved the list up to just below the <code>libflaimtk_la_SOURCES</code> line at <span class="ent">➎</span>, added a backslash character after the equal sign, and removed the one after the last file. Another formatting technique is to simply wrap the line with a backslash and a carriage return approximately every 70 characters, but I prefer to put each file on a separate line, especially early in the conversion process, so I can easily extract files from or add files to the lists as needed. Leaving the files on separate lines also gets you the benefit of having source lists be easier to compare when reviewing differences in pull-request reviews and other <code>diff</code>-style output.</p>&#13;
<p class="indent">I had to manually examine each header file in the <em>src</em> directory in order to determine its use in the project. There were only four header files, and, as it turns out, the only one the FLAIM toolkit does <em>not</em> use on Unix and Linux platforms is <em>ftknlm.h</em>, which is specific to the NetWare build. I added this file to the <code>EXTRA_DIST</code> list at <span class="ent">➊</span> so it would be distributed; just because the build doesn’t use it doesn’t mean that users won’t want or need it.<sup><a id="ch14fn_19" href="footnote.xhtml#ch14fn19">19</a></sup></p>&#13;
<p class="indent">The (newly renamed) <em>flaimtk.h</em> file is the only public header file, so I moved it into the <code>include_HEADERS</code> list at <span class="ent">➌</span>. The other two files are used <span epub:type="pagebreak" id="page_393"/>internally in the library build, so I left them in the <code>libflaimtk_la_SOURCES</code> list. Had this been my own project, I would have moved <em>flaimtk.h</em> into an <em>include</em> directory off the project root directory, but remember that one of my goals here was to limit changes to the directory structure and the source code. Moving this header file is a philosophical decision that I decided to leave to the maintainers.<sup><a id="ch14fn_20" href="footnote.xhtml#ch14fn20">20</a></sup></p>&#13;
<p class="indent">Finally, I noticed in the original makefile that the last release of the <em>ftk</em> library published an interface version of 4.0. However, since I changed the name of the library from <em>libftk</em> to <em>libflaimtk</em>, I reset this value to 0.0 because it’s a different library. I replaced <em><code>x</code></em><code>:</code><em><code>y</code></em><code>:</code><em><code>z</code></em> with <code>0:0:0</code> in the <code>-version-info</code> option at <span class="ent">➏</span> within the <code>libflaimtk_la_LDFLAGS</code> variable.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>A version string of <em><code>0:0:0</code></em> is the default, so I could have removed the argument entirely and achieved the same result. However, including it gives new developers some insight into how to change the interface version in the future.</em></p>&#13;
</div>&#13;
<p class="indent">I added the <code>pkgconfigdir</code> and <code>pkgconfig_DATA</code> variables at <span class="ent">➍</span> in order to provide support for installing pkg-config metadata files for this project. For more on the pkg-config system, see <a href="ch10.xhtml">Chapter 10</a>.</p>&#13;
<h4 class="h4" id="ch14sec6-4"><em>Moving On to the ftk/util Directory</em></h4>&#13;
<p class="noindent">Properly designing <em>Makefile.am</em> for the <em>util</em> directory requires examining the original makefile again for more products. A quick glance at the <em>ftk/util</em> directory showed that there was only one source file: <em>ftktest.cpp</em>. This appeared to be some sort of testing program for the <em>ftk</em> library, but I know that the FLAIM developers use it all the time in various ways besides simply for testing a build. So I had a design decision to make here: should I build this as a normal program or as a check program?</p>&#13;
<p class="indent"><em>Check programs</em> are only built when <code>make check</code> is executed, and they’re never installed. If I want <code>ftktest</code> built as a regular program, but not installed, I have to use the <code>noinst</code> prefix rather than the usual <code>bin</code> prefix in the program list variable.</p>&#13;
<p class="indent">In either case, I probably want to add <code>ftktest</code> to the list of tests that are executed during <code>make check</code>, so the two questions here are (1) whether I want to automatically run <code>ftktest</code> during <code>make check</code> and (2) whether I want to install the <code>ftktest</code> program. Given that the FLAIM toolkit is a mature product, I opted to build <code>ftktest</code> during <code>make check</code> and leave it uninstalled.</p>&#13;
<p class="indent">Listing 14-12 shows my final <em>ftk/util/Makefile.am</em> file.</p>&#13;
<pre>FTK_INCLUDE = -I$(top_srcdir)/src&#13;
FTK_LTLIB = ../src/libflaimtk.la&#13;
&#13;
check_PROGRAMS = ftktest&#13;
<span epub:type="pagebreak" id="page_394"/>ftktest_SOURCES = ftktest.cpp&#13;
ftktest_CPPFLAGS = $(FTK_INCLUDE)&#13;
ftktest_LDADD = $(FTK_LTLIB)&#13;
&#13;
TESTS = ftktest</pre>&#13;
<p class="caption" id="ch14ex12"><em>Listing 14-12</em>: ftk/util/Makefile.am: <em>The final contents of this file</em></p>&#13;
<p class="indent">I hope that by now you can see the relationship between <code>TESTS</code> and <code>check_PROGRAMS</code>. To be blunt, there really is <em>no</em> relationship between the files listed in <code>check_PROGRAMS</code> and those listed in <code>TESTS</code>. The <code>check</code> target simply ensures that <code>check_PROGRAMS</code> are built before the <code>TESTS</code> programs and scripts are executed. <code>TESTS</code> can refer to anything that can be executed without command line parameters. This separation of duties makes for a very clean and flexible system.</p>&#13;
<p class="indent">And that’s it for the FLAIM toolkit library and utilities. I don’t know about you, but I’d much rather maintain this small set of short files than a single 2,200-line makefile!</p>&#13;
<h3 class="h3" id="ch14sec7">Designing the XFLAIM Build System</h3>&#13;
<p class="noindent">Now that I’ve finished with the FLAIM toolkit, I’ll move on to the xflaim project. I’m choosing to start with xflaim, rather than flaim, because it supplies the most build features that can be converted to the Autotools, including the Java and C# language bindings (which I won’t actually discuss in detail until the next chapter). After xflaim, covering the remaining database projects would be redundant, because the processes are identical, if not a little simpler. However, you can find the other build system files in this book’s GitHub repositories.</p>&#13;
<p class="indent">I generated the <em>configure.ac</em> file using <code>autoscan</code> once again. It’s important to use <code>autoscan</code> in each of the individual projects, because the source code for each project is different and will thus cause different macros to be written into each <em>configure.scan</em> file.<sup><a id="ch14fn_21" href="footnote.xhtml#ch14fn21">21</a></sup> I then used the same techniques I used on the FLAIM toolkit to create xflaim’s <em>configure.ac</em> file.</p>&#13;
<h4 class="h4" id="ch14sec7-1"><em>The XFLAIM configure.ac File</em></h4>&#13;
<p class="noindent">After hand-modifying the generated <em>configure.scan</em> file and renaming it <em>configure.ac</em>, I found it to be similar in many ways to the toolkit’s <em>configure.ac</em> file. It’s fairly long, so I’ll show you only the most significant differences in <a href="ch14.xhtml#ch14ex13">Listing 14-13</a>.</p>&#13;
<pre>   <span class="codeitalic1">--snip--</span>&#13;
<span class="ent">➊</span> # Checks for optional programs.&#13;
   FLM_PROG_TRY_CSC&#13;
   FLM_PROG_TRY_CSVM&#13;
   <span epub:type="pagebreak" id="page_395"/>FLM_PROG_TRY_JNI&#13;
   FLM_PROG_TRY_JAVADOC&#13;
   FLM_PROG_TRY_DOXYGEN&#13;
&#13;
<span class="ent">➋</span> # Configure variables: FTKLIB and FTKINC.&#13;
   AC_ARG_VAR([FTKLIB], [The PATH wherein libflaimtk.la can be found.])&#13;
   AC_ARG_VAR([FTKINC], [The PATH wherein flaimtk.h can be found.])&#13;
   <span class="codeitalic1">--snip--</span>&#13;
<span class="ent">➌</span> # Ensure that both or neither is specified.&#13;
   if (test -n "$FTKLIB" &amp;&amp; test -z "$FTKINC") || \&#13;
      (test -n "$FTKINC" &amp;&amp; test -z "$FTKLIB"); then&#13;
     AC_MSG_ERROR([Specify both FTK library and include paths, or neither.])&#13;
   fi&#13;
&#13;
   # Not specified? Check for FTK in standard places.&#13;
   if test -z "$FTKLIB"; then&#13;
   <span class="ent">➍</span> # Check for FLAIM toolkit as a sub-project.&#13;
      if test -d "$srcdir/ftk"; then&#13;
        AC_CONFIG_SUBDIRS([ftk])&#13;
        FTKINC='$(top_srcdir)/ftk/src'&#13;
        FTKLIB='$(top_builddir)/ftk/src'&#13;
      else&#13;
   <span class="ent">➎</span> # Check for FLAIM toolkit as a superproject.&#13;
        if test -d "$srcdir/../ftk"; then&#13;
          FTKINC='$(top_srcdir)/../ftk/src'&#13;
          FTKLIB='$(top_builddir)/../ftk/src'&#13;
        fi&#13;
      fi&#13;
    fi&#13;
&#13;
<span class="ent">➏</span> # Still empty? Check for *installed* FLAIM toolkit.&#13;
   if test -z "$FTKLIB"; then&#13;
     AC_CHECK_LIB([flaimtk], [ftkFastChecksum],&#13;
       [AC_CHECK_HEADERS([flaimtk.h])&#13;
          LIBS="-lflaimtk $LIBS"],&#13;
       [AC_MSG_ERROR([No FLAIM toolkit found. Terminating.])])&#13;
   fi&#13;
&#13;
<span class="ent">➐</span> # AC_SUBST command line variables from FTKLIB and FTKINC.&#13;
   if test -n "$FTKLIB"; then&#13;
     AC_SUBST([FTK_LTLIB], ["$FTKLIB/libflaimtk.la"])&#13;
     AC_SUBST([FTK_INCLUDE], ["-I$FTKINC"])&#13;
   fi&#13;
&#13;
<span class="ent">➑</span> # Automake conditionals&#13;
   AM_CONDITIONAL([HAVE_JAVA], [test "x$flm_prog_have_jni" = xyes])&#13;
   AM_CONDITIONAL([HAVE_CSHARP], [test -n "$CSC"])&#13;
   AM_CONDITIONAL([HAVE_DOXYGEN], [test -n "$DOXYGEN"])&#13;
   #AM_COND_IF([HAVE_DOXYGEN], [AC_CONFIG_FILES([docs/doxygen/doxyfile])])&#13;
   AS_IF([test -n "$DOXYGEN"], [AC_CONFIG_FILES([docs/doxygen/doxyfile])])&#13;
   <span class="codeitalic1">--snip--</span>&#13;
   AC_OUTPUT&#13;
   <span epub:type="pagebreak" id="page_396"/># Fix broken libtool&#13;
   sed 's/link_all_deplibs=no/link_all_deplibs=yes/' libtool &gt;libtool.tmp &amp;&amp; \&#13;
     mv libtool.tmp libtool&#13;
&#13;
   cat &lt;&lt;EOF&#13;
&#13;
     ($PACKAGE_NAME) version $PACKAGE_VERSION&#13;
     Prefix.........: $prefix&#13;
     Debug Build....: $debug&#13;
     C++ Compiler...: $CXX $CXXFLAGS $CPPFLAGS&#13;
     Linker.........: $LD $LDFLAGS $LIBS&#13;
     FTK Library....: ${FTKLIB:-INSTALLED}&#13;
     FTK Include....: ${FTKINC:-INSTALLED}&#13;
     CSharp Compiler: ${CSC:-NONE} $CSCFLAGS&#13;
     CSharp VM......: ${CSVM:-NONE}&#13;
     Java Compiler..: ${JAVAC:-NONE} $JAVACFLAGS&#13;
     JavaH Utility..: ${JAVAH:-NONE} $JAVAHFLAGS&#13;
     Jar Utility....: ${JAR:-NONE} $JARFLAGS&#13;
     Javadoc Utility: ${JAVADOC:-NONE}&#13;
     Doxygen........: ${DOXYGEN:-NONE}&#13;
&#13;
   EOF</pre>&#13;
<p class="caption" id="ch14ex13"><em>Listing 14-13</em>: xflaim/configure.ac: <em>The most significant portions of this Autoconf input file</em></p>&#13;
<p class="indent">First, notice that I’ve invented a few more <code>FLM_PROG_TRY_*</code> macros at <span class="ent">➊</span>. Here I’m checking for the existence of the following programs: a C# compiler, a C# virtual machine, a Java compiler, a JNI header and stub generator, a Javadoc generation tool, a Java archive tool, and Doxygen. I’ve written separate macro files for each of these checks and added them to my <em>xflaim/m4</em> directory.</p>&#13;
<p class="indent">As with the <code>FLM_PROG_TRY_DOXYGEN</code> macro used in the toolkit, each of these macros attempts to locate the associated program, but these macros don’t fail the configuration process if they can’t find the program. I want to be able to use these programs if they’re available, but I don’t want to require the user to have them in order to build the base libraries.</p>&#13;
<p class="indent">You’ll find a new macro, <code>AC_ARG_VAR</code>, at <span class="ent">➋</span>. Like the <code>AC_ARG_ENABLE</code> and <code>AC_ARG_WITH</code> macros, <code>AC_ARG_VAR</code> allows the project maintainer to extend the command line interface of the <code>configure</code> script. This macro is different, however, in that it adds a public variable, rather than a command line option, to the list of public variables that <code>configure</code> cares about. In this case, I’m adding two public variables, <code>FTKINC</code> and <code>FTKLIB</code>. These will show up in <code>configure</code>’s help text under the section “Some influential environment variables.” The <em>GNU Autoconf Manual</em> calls these variables <em>precious</em>. All of my <code>FLM_PROG_TRY_*</code> macros use the <code>AC_ARG_VAR</code> macro internally to make the associated variables both public and precious.<sup><a id="ch14fn_22" href="footnote.xhtml#ch14fn22">22</a></sup></p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><span epub:type="pagebreak" id="page_397"/><em>The lines of code from</em> <span class="ent">➋</span> <em>through</em> <span class="ent">➐</span> <em>are found in the GitHub repository under</em> xflaim/m4/flm_ftk_search.m4. <em>By the end of <a href="ch15.xhtml">Chapter 15</a>, all discrepancies are resolved between the listings in this chapter and the files in the GitHub repository.</em></p>&#13;
</div>&#13;
<p class="indent">The large chunk of code beginning at <span class="ent">➌</span> actually uses these variables to set other variables used in the build system. The user can set the public variables in the environment, or they can specify them on <code>configure</code>’s command line in this manner:</p>&#13;
<pre>$ <span class="codestrong1">./configure FTKINC="$HOME/dev/ftk/include" ...</span></pre>&#13;
<p class="indent">First, I’ll check to see that either both or neither of the <code>FTKINC</code> and <code>FTKLIB</code> variables is specified. If only one of them is given, I have to fail with an error. The user isn’t allowed to tell me where to find only <em>half</em> the toolkit; I need both the header file and the library.<sup><a id="ch14fn_23" href="footnote.xhtml#ch14fn23">23</a></sup> If neither of these variables is specified, I search for them at <span class="ent">➍</span> by looking for a subdirectory of the xflaim project directory called <em>ftk</em>. If I find one, I’ll configure that directory as a subproject to be processed by Autoconf, using the <code>AC_CONFIG_SUBDIRS</code> macro.<sup><a id="ch14fn_24" href="footnote.xhtml#ch14fn24">24</a></sup> I’ll also set both of these variables to point to the appropriate relative locations within the ftk subproject.</p>&#13;
<p class="indent">If I don’t find <em>ftk</em> as a subdirectory, I’ll look for it in the parent directory at <span class="ent">➎</span>. If I find it there, I’ll set the variables appropriately. This time, I don’t need to configure the located <em>ftk</em> directory as a subproject, because I’m assuming that the xflaim project is itself a subproject of the umbrella project. If I don’t find <em>ftk</em> as either a subproject or a sibling project, I’ll use the standard <code>AC_CHECK_LIB</code> and <code>AC_CHECK_HEADERS</code> macros at <span class="ent">➏</span> to see if the user’s host has the toolkit library installed. In that case, I need only add <code>-lflaimtk</code> to the <code>LIBS</code> variable. Also in that case, the header file will be in the standard location: usually <em>/usr(/local)/include</em>. The default functionality of the optional third argument to <code>AC_CHECK_LIB</code> would automatically add the library reference to the <code>LIBS</code> variable, but since I’ve overridden this default functionality, I have to manually add the toolkit library reference to <code>LIBS</code>.</p>&#13;
<p class="indent">If I don’t find the library, I give up with an error message indicating that xflaim can’t be built without the FLAIM toolkit. However, after making it through all these checks, if the <code>FTKLIB</code> variable is no longer empty, I use <code>AC_SUBST</code> at <span class="ent">➐</span> to publish the <code>FTK_INCLUDE</code> and <code>FTK_LTLIB</code> variables, which contain derivations of <code>FTKINC</code> and <code>FTKLIB</code> appropriate for use as command line options to the preprocessor and the linker.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em><a href="ch16.xhtml">Chapter 16</a> converts the large chunk of code between</em> <span class="ent">➌</span> <em>and</em> <span class="ent">➑</span> <em>into a custom M4 macro called <em><code>FLM_FTK_SEARCH</code></em></em>.</p>&#13;
</div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_398"/>The remaining code at <span class="ent">➑</span> calls <code>AM_CONDITIONAL</code> for Java, C#, and Doxygen in a manner similar to the way I handled Doxygen in the ftk project. These macros are configured to generate warning messages indicating that the Java or C# portions of the xflaim project will not be built if those tools can’t be found, but I allow the build to continue in any case.</p>&#13;
<h4 class="h4" id="ch14sec7-2"><em>Creating the xflaim/src/Makefile.am File</em></h4>&#13;
<p class="noindent">I’m skipping the <em>xflaim/Makefile.am</em> file, because it’s nearly identical to <em>ftk/Makefile.am</em>. Instead, we’ll move on to <em>xflaim/src/Makefile.am</em>, which I wrote by following the same design principles used with the <em>ftk/src</em> version. It looks very similar to its ftk counterpart, with one exception: according to the original build system makefile, the Java native interface (JNI) and C# native language–binding sources are compiled and linked right into the <em>xflaim</em> shared library.</p>&#13;
<p class="indent">This is not an uncommon practice, and it’s quite useful because it alleviates the need for extra library objects built specifically for these languages. Essentially, the <em>xflaim</em> shared library exports native interfaces for these languages, which are then consumed by their corresponding native wrappers.<sup><a id="ch14fn_25" href="footnote.xhtml#ch14fn25">25</a></sup></p>&#13;
<p class="indent">I’m going to ignore these language bindings for now, but later, when I’m finished with the entire xflaim project, I’ll turn my attention back to properly hooking them into the library. With this exception then, the <em>Makefile.am</em> file shown in <a href="ch14.xhtml#ch14ex14">Listing 14-14</a> looks almost identical to its ftk counterpart.</p>&#13;
<pre>if HAVE_JAVA&#13;
  JAVADIR = java&#13;
  JNI_LIBADD = java/libxfjni.la&#13;
endif&#13;
&#13;
if HAVE_CSHARP&#13;
  CSDIR = cs&#13;
  CSI_LIBADD = cs/libxfcsi.la&#13;
endif&#13;
&#13;
SUBDIRS = $(JAVADIR) $(CSDIR)&#13;
&#13;
pkgconfigdir = $(libdir)/pkgconfig&#13;
pkgconfig_DATA = libxflaim.pc&#13;
&#13;
lib_LTLIBRARIES = libxflaim.la&#13;
include_HEADERS = xflaim.h&#13;
&#13;
libxflaim_la_SOURCES = \&#13;
<span epub:type="pagebreak" id="page_399"/>  btreeinfo.cpp \&#13;
  f_btpool.cpp \&#13;
  f_btpool.h \&#13;
  <span class="codeitalic1">--snip--</span>&#13;
  rfl.h \&#13;
  scache.cpp \&#13;
  translog.cpp&#13;
&#13;
libxflaim_la_CPPFLAGS = $(FTK_INCLUDE)&#13;
libxflaim_la_LIBADD = $(JNI_LIBADD) $(CSI_LIBADD) $(FTK_LTLIB)&#13;
libxflaim_la_LDFLAGS = -version-info 3:2:0</pre>&#13;
<p class="caption" id="ch14ex14"><em>Listing 14-14</em>: xflaim/src/Makefile.am: <em>The xflaim project src directory Automake input file</em></p>&#13;
<p class="indent">I’ve conditionally defined the contents of the <code>SUBDIRS</code> variable here based on variables defined by corresponding Automake conditional statements in <em>configure.ac</em>. When <code>make all</code> is executed, the <code>SUBDIRS</code> variable conditionally recurses into the <em>java</em> and <em>cs</em> subdirectories. But when <code>make dist</code> is executed, a hidden <code>DIST_SUBDIRS</code> variable (which is created by Automake from <em>all of the possible contents</em> of the <code>SUBDIRS</code> variable) references all directories appended, either conditionally or unconditionally, to <code>SUBDIRS</code>.<sup><a id="ch14fn_26" href="footnote.xhtml#ch14fn26">26</a></sup></p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>The library interface version information was extracted from the original makefile.</em></p>&#13;
</div>&#13;
<h4 class="h4" id="ch14sec7-3"><em>Turning to the xflaim/util Directory</em></h4>&#13;
<p class="noindent">The <em>util</em> directory for xflaim is a bit more complex. According to the original makefile, it generates several utility programs as well as a convenience library that is consumed by these utilities.</p>&#13;
<p class="indent">It was somewhat more difficult to find out which source files belong to which utilities and which were not used at all. Several of the files in the <em>xflaim/util</em> directory are not used by any of the utilities. Do we distribute these extra source files? I chose to do so, because they were already being distributed by the original build system and adding them to the <code>EXTRA_DIST</code> list makes it obvious to later observers that they aren’t used.</p>&#13;
<p class="indent"><a href="ch14.xhtml#ch14ex15">Listing 14-15</a> shows a portion of the <em>xflaim/util/Makefile.am</em> file; the parts that are missing are redundant.</p>&#13;
<pre>   EXTRA_DIST = dbdiff.cpp dbdiff.h domedit.cpp diffbackups.cpp xmlfiles&#13;
&#13;
   XFLAIM_INCLUDE = -I$(top_srcdir)/src&#13;
   XFLAIM_LDADD = ../src/libxflaim.la&#13;
&#13;
<span class="ent">➊</span> AM_CPPFLAGS = $(XFLAIM_INCLUDE) $(FTK_INCLUDE)&#13;
   LDADD = libutil.la $(XFLAIM_LDADD)&#13;
&#13;
<span epub:type="pagebreak" id="page_400"/>   ## Utility Convenience Library&#13;
&#13;
   noinst_LTLIBRARIES = libutil.la&#13;
&#13;
   libutil_la_SOURCES = \&#13;
    flm_dlst.cpp \&#13;
    flm_dlst.h \&#13;
    flm_lutl.cpp \&#13;
    flm_lutl.h \&#13;
    sharutil.cpp \&#13;
    sharutil.h&#13;
&#13;
   ## Utility Programs&#13;
&#13;
   bin_PROGRAMS = xflmcheckdb xflmrebuild xflmview xflmdbshell&#13;
&#13;
   xflmcheckdb_SOURCES = checkdb.cpp&#13;
   xflmrebuild_SOURCES = rebuild.cpp&#13;
&#13;
   xflmview_SOURCES = \&#13;
    viewblk.cpp \&#13;
    view.cpp \&#13;
    <span class="codeitalic1">--snip--</span>&#13;
    viewmenu.cpp \&#13;
    viewsrch.cpp&#13;
&#13;
   xflmdbshell_SOURCES = \&#13;
    domedit.h \&#13;
    fdomedt.cpp \&#13;
    fshell.cpp \&#13;
    fshell.h \&#13;
    xshell.cpp&#13;
&#13;
   ## Check Programs&#13;
&#13;
   check_PROGRAMS = \&#13;
    ut_basictest \&#13;
    ut_binarytest \&#13;
    <span class="codeitalic1">--snip</span><span class="codeitalic1">--</span>&#13;
    ut_xpathtest \&#13;
    ut_xpathtest2&#13;
&#13;
<span class="ent">➋</span> check_DATA = copy-xml-files.stamp&#13;
   check_HEADERS = flmunittest.h&#13;
&#13;
   ut_basictest_SOURCES = flmunittest.cpp basictestsrv.cpp&#13;
<span class="ent">➌</span> <span class="codeitalic1">--snip--</span>&#13;
   ut_xpathtest2_SOURCES = flmunittest.cpp xpathtest2srv.cpp&#13;
&#13;
   ## Unit Tests&#13;
&#13;
   TESTS = \&#13;
    ut_basictest \&#13;
    <span epub:type="pagebreak" id="page_401"/><span class="codeitalic1">--snip--</span>&#13;
    ut_xpathtest2&#13;
&#13;
   ## Miscellaneous rules required by Check Programs&#13;
&#13;
<span class="ent">➍</span> copy-xml-files.stamp:&#13;
           cp $(srcdir)/xmlfiles/*.xml .&#13;
           echo Timestamp &gt; $@&#13;
&#13;
<span class="ent">➎</span> clean-local:&#13;
           rm -rf ix2.*&#13;
           rm -rf bld.*&#13;
           rm -rf tst.bak&#13;
           rm -f *.xml&#13;
           rm -f copy-xml-files.stamp</pre>&#13;
<p class="caption" id="ch14ex15"><em>Listing 14-15</em>: xflaim/util/Makefile.am: <em>The xflaim project’s</em> util <em>directory Automake input file</em></p>&#13;
<p class="indent">In this example, you can see by the elided sections that I left out several long lists of files and products. This makefile builds 22 unit tests, but because they’re all identical, except for naming differences and the source files from which they’re built, I only left the descriptions for two of them (at <span class="ent">➌</span>).</p>&#13;
<p class="indent">I’ve defined the file-global <code>AM_CPPFLAGS</code> and <code>LDADD</code> variables at <span class="ent">➊</span> in order to associate the <code>XFLAIM</code> and <code>FTK</code> include and library files with each of the projects listed in this <em>Makefile.am</em> file. This way, I don’t have to explicitly append this information to each product.</p>&#13;
<h5 class="h5">Transitive Dependencies</h5>&#13;
<p class="noindent">Notice, however, that the <code>AM_CPPFLAGS</code> variable uses both the <code>XFLAIM_INCLUDE</code> and <code>FTK_INCLUDE</code> variables—the xflaim utilities clearly require information from both sets of header files. So why doesn’t the <code>LDADD</code> variable reference the <em>ftk</em> library? This is because Libtool manages transitive dependencies for you and does so in a very portable manner, because some systems don’t have a native mechanism for managing transitive dependencies. Because I reference <em>libxflaim.la</em> through <code>XFLAIM_LDADD</code>, and because <em>libxflaim.la</em> lists <em>libflaimtk.la</em> as a dependency, Libtool is able to provide the transitive reference for me on the utility programs’ linker command lines.</p>&#13;
<p class="indent">For a clearer picture of this, examine the contents of <em>libxflaim.la</em> (in your build directory under <em>xflaim/src</em>—you will have to build the project first; run <code>autoreconf -i; ./configure &amp;&amp; make</code>). You’ll find a few lines near the middle of the file that look very much like the contents of <a href="ch14.xhtml#ch14ex16">Listing 14-16</a>.</p>&#13;
<pre><span class="codeitalic1">--snip--</span>&#13;
# Libraries that this one depends upon.&#13;
dependency_libs=' .../flaim/build/ftk/src/libflaimtk.la -lrt -lncurses'&#13;
<span class="codeitalic1">--snip--</span></pre>&#13;
<p class="caption" id="ch14ex16"><em>Listing 14-16: The portion of xflaim/src</em>/libxflaim.la <em>that shows dependency libraries</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_402"/>The path information for <em>libflaimtk.la</em> is listed here so we don’t have to specify it in the <code>LDADD</code> statement for the xflaim utilities.<sup><a id="ch14fn_27" href="footnote.xhtml#ch14fn27">27</a></sup></p>&#13;
<p class="indent">Like Libtool, the GNU linker and the Linux loader can manage transitive dependencies (TDs). This is done by having <code>ld</code> incorporate these indirect dependencies into the ELF binaries it generates when appropriate linker command line options are used. Libtool’s mechanism relies on a recursive search of a hierarchy of <em>.la</em> files, whereas Linux’s native mechanism simply recursively searches the library hierarchy at build time and embeds all required library references directly into the built program or library. The loader then sees and uses these references at load time. A nice aspect of using such native TD management is that, if a library is updated in a newer version of a package, the loader will immediately begin to reference the updated secondary symbols from the new library’s updated reference list, and projects built against that library will immediately begin using the new version’s transitive dependencies.</p>&#13;
<p class="indent">Recently, some distro vendors have decided it’s worth taking advantage of this feature on their platforms. The problem is, Libtool’s TD management reduces the perceived advantages of using <code>ld</code>’s (and the system loader’s) internal TD management—it gets in the way, so to speak. To solve this issue, these vendors have decided to release a modified version of Libtool on their platforms, wherein its TD management feature is effectively disabled. The result is that you must now specify all direct and indirect libraries on the linker (<code>libtool</code>) command line or modify your build system to use the non-portable native TD management linker options.</p>&#13;
<p class="indent">Since native TD management is not supported on all platforms, and Libtool’s text file–based approach is completely portable, we often rely heavily on Libtool to do the right thing when indirect dependencies are required while linking our programs and libraries on systems that don’t have a native TD management system. When you use a “distro-crippled” Libtool package to build projects designed to take advantage of Libtool’s TD management features, your build simply fails at the link stage with “missing DSO” (dynamic shared object) messages.<sup><a id="ch14fn_28" href="footnote.xhtml#ch14fn28">28</a></sup></p>&#13;
<p class="indent">The <code>sed</code> command in <em>configure.ac</em> searches for the text <code>link_all_deplibs=no</code> in the <em>libtool</em> script and replaces it with <code>link_all_deplibs=yes</code>. It’s in there twice, and the <code>sed</code> command will replace both occurrences. <code>AC_OUTPUT</code> executes <code>config.status</code>, which generates the <em>libtool</em> script in the project directory, so the <code>sed</code> command must follow <code>AC_OUTPUT</code> to be effective.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><span epub:type="pagebreak" id="page_403"/><em>It doesn’t hurt to use this <em><code>sed</code></em> command, even on systems that do not exhibit the problem—<em><code>sed</code></em> simply won’t find anything to replace in your</em> libtool <em>script. Be aware, however, that if your package is picked up for distribution by a Linux vendor that uses internal TD management, they’ll probably ship your package with these sorts of commands “patched out.”</em></p>&#13;
</div>&#13;
<p class="indent">Of course, another option is to forgo the use of automatic transitive dependency management entirely by simply specifying all of the link dependencies you know you’ll need on the linker’s command line for every program or library you build. Pkg-config actually does this for you anyway, so if you can rely on pkg-config for all your library management needs, then your projects are simply not affected by this issue. This can be done manually in the flaim, xflaim, and flaimsql projects by adding <code>$(FTK_LTLIB)</code> to the <code>LDADD</code> variables as, for example, at <span class="ent">➊</span> in <a href="ch14.xhtml#ch14ex15">Listing 14-15</a>.</p>&#13;
<p class="indent">Feel free to try this by commenting out the <code>sed</code> commands in <em>configure.ac</em> and then rebuilding the project. Assuming you’re building on a platform where Libtool has been modified,    your build will fail at the point where the flaim and xflaim projects try to link their utilities only against the <em>libflaim.la</em> and <em>libxflaim.la</em>. To make it work again, update your <code>LDADD</code> variables as I mentioned earlier.</p>&#13;
<h5 class="h5">Stamp Targets</h5>&#13;
<p class="noindent">In creating this makefile, I ran across another minor problem that I hadn’t anticipated. At least one of the unit tests seemed to require that some XML data files be present in the directory from which the test is executed. The test failed, and when I dug into it, I noticed that it failed while trying to open these files. Looking around a bit lead me to the <em>xflaim/util/xmldata</em> directory, which contained several dozen XML files.</p>&#13;
<p class="indent">I needed to copy those files into the build hierarchy’s <em>xflaim/util</em> directory before I could run the unit tests. I know that products prefixed with <code>check</code> are built before <code>TESTS</code> are executed, so it occurred to me that I might list these files at <span class="ent">➋</span> in a <code>check_DATA PLV</code>. The <code>check_DATA</code> variable refers to a file called <em>copy-xml-files.stamp</em>, which is a special type of file target called a <em>stamp</em> target. Its purpose is to replace a group of unspecified files, or a non-file-based operation, with one single, representative file. This stamp file is used to indicate to the build system that all the XML data files have been copied into the <em>util</em> directory. Automake often uses stamp files in its own generated rules.</p>&#13;
<p class="indent">The rule for generating the stamp file at <span class="ent">➍</span> also copies the XML data files into the test execution directory. The <code>echo</code> statement simply creates a file named <em>copy-xml-files.stamp</em> that contains a single word: <em>Timestamp</em>. The file may contain anything (or nothing at all). The important point here is that the file exists and has a time and date associated with it. The <code>make</code> utility uses this information to determine whether the copy operation needs to be executed. In this case, since <em>copy-xml-files.stamp</em> has no dependencies, its mere existence indicates to <code>make</code> that the operation has already been done. Delete the stamp file to get <code>make</code> to perform the copy operation on the next build.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_404"/>This is a sort of hybrid between a true file-based rule and a phony target. Phony targets are always executed—they aren’t real files, so <code>make</code> has no way of determining whether the associated operation should be performed based on file attributes. The timestamps of file-based rules can be checked against their dependency lists to determine whether they should be re-executed. Stamp rules like this are executed only if the stamp file is missing, because there are no dependencies against which the target’s time and date should be compared.<sup><a id="ch14fn_29" href="footnote.xhtml#ch14fn29">29</a></sup></p>&#13;
<h5 class="h5">Cleaning Your Room</h5>&#13;
<p class="noindent">All files placed in the build directory should be cleaned up when the user enters <code>make clean</code> at the command prompt. Since I placed XML data files into the build directory, I also need to clean them up. Files listed in <code>DATA</code> variables are not cleaned up automatically, because <code>DATA</code> files are not necessarily generated. Sometimes the <code>DATA</code> primary is used to list static project files that need to be installed. I “created” a bunch of XML files and a stamp file, so I needed to remove these during <code>make clean</code>. To this end, I added the <code>clean-local</code> target at <span class="ent">➎</span>, along with its associated <code>rm</code> commands.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Be careful when deleting files copied from the source tree into the corresponding location in the build tree—you may inadvertently delete source files when building from within the source tree. You can compare <em><code>$(srcdir)</code></em> to “<em><code>.</code></em>” within <em><code>make</code></em> commands to see if the user is building in the source tree.</em></p>&#13;
</div>&#13;
<p class="indent">There is another way to ensure that files created using your own <code>make</code> rules get cleaned up during execution of the <code>clean</code> target. You can define the <code>CLEANFILES</code> variable to contain a whitespace-separated list of files (or wildcard specifications) to be removed. I used a <code>clean-local</code> target in this case, because the <code>CLEANFILES</code> variable has one caveat: it won’t remove directories, only files. Each of the <code>rm</code> commands that removes a wildcard file specification refers to at least one directory. I’ll show you a proper use of <code>CLEANFILES</code> in <a href="ch15.xhtml">Chapter 15</a>.</p>&#13;
<p class="indent">Regardless of how well your unit tests clean up after themselves, you still might want to write <code>clean</code> rules that attempt to clean up intermediary test files. That way, your makefiles will clean up droppings from interrupted <span epub:type="pagebreak" id="page_405"/>tests and debug runs.<sup><a id="ch14fn_30" href="footnote.xhtml#ch14fn30">30</a></sup> Remember that the user may be building in the source directory. Try to make your wildcards as specific as possible so you don’t inadvertently remove source files.</p>&#13;
<p class="indent">I use the Automake-supported <code>clean-local</code> target here as a way to extend the <code>clean</code> target. The <code>clean-local</code> target is executed as a dependency of (and thus executed before) the <code>clean</code> target, if it exists. <a href="ch14.xhtml#ch14ex17">Listing 14-17</a> shows the corresponding code from the Automake-generated <em>Makefile.in</em> template, so you can see how this infrastructure is wired up. The interesting bits are highlighted.</p>&#13;
<pre>   <span class="ash">--</span><span class="codeitalic1">snip</span><span class="ash">--</span>&#13;
   clean: clean-am&#13;
<span class="ent">➊</span> clean-am: <span class="ash">clean-binPROGRAMS clean-checkPROGRAMS \</span>&#13;
     <span class="ash">clean-generic clean-libtool</span> clean-local <span class="ash">\</span>&#13;
     <span class="ash">clean-noinstLTLIBRARIES mostlyclean-am</span>&#13;
   <span class="codeitalic1a">--snip--</span>&#13;
<span class="ent">➋</span> <span class="ash">.PHONY: ...</span> clean-local<span class="ash">...</span>&#13;
   <span class="codeitalic1a">--snip--</span>&#13;
   clean-local:&#13;
           <span class="ash">rm -rf ix2.*</span>&#13;
           <span class="ash">rm -rf bld.*</span>&#13;
           <span class="ash">rm -rf tst.bak</span>&#13;
           <span class="ash">rm -f *.xml</span>&#13;
           <span class="ash">rm -f copy-xml-files.stamp</span>&#13;
   <span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch14ex17"><em>Listing 14-17</em>: xflaim/util/Makefile.in: <em>The clean rules generated by Automake from</em> xflaim/util/Makefile.am</p>&#13;
<p class="indent">Automake noted that I had a target named <code>clean-local</code> in <em>Makefile.am</em>, so it added <code>clean-local</code> to the dependency list for <code>clean-am</code> at <span class="ent">➊</span> and then added it to the <code>.PHONY</code> variable at <span class="ent">➋</span>. Had I not written a <code>clean-local</code> target, these references would have been missing from the generated <em>Makefile</em>.</p>&#13;
<h3 class="h3" id="ch14sec8">Summary</h3>&#13;
<p class="noindent">Well, those are the basics. If you’ve followed along and understood what we did in this chapter, then you should be able to convert nearly any project to use an Autotools-based build system. For more details on the topics covered here, I refer you to the Autotools manuals. Often just knowing the name of a concept so you can easily find it in the manual or in an online search is worth a great deal.</p>&#13;
<p class="indent">In <a href="ch15.xhtml">Chapter 15</a>, I’ll cover the stranger aspects of converting this project, including the details of building Java and C# code, adding compiler-specific optimization flags and command line options, and even building RPM packages using user-defined <code>make</code> targets in your <em>Makefile.am</em> files.<span epub:type="pagebreak" id="page_406"/></p>&#13;
</body></html>