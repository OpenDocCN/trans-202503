<html><head></head><body>
<div id="book-content">
<div id="sbo-rt-content"><section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" title="209" id="Page_209"/><a class="XrefDestination" id="13"/><span class="XrefDestination" id="xref-503007c13-001"/>13</span><br/>
<span class="ChapterTitle"><a class="XrefDestination" id="CreatingEvents"/><span class="XrefDestination" id="xref-503007c13-002"/>Creating Events</span></h1>
</header>
<figure class="opener">
<img src="image_fi/book_art/chapterart.png" alt="" width="200" height="200"/>
</figure>
<p class="ChapterIntro">In this chapter, you’ll create <em>events</em>. Also called scheduled events, these are database objects that fire based on a set schedule, executing the functionality you defined when creating them.</p>
<p>Events can be scheduled to run once or at some interval, like daily, weekly, or yearly; for example, you might create an event to perform weekly payroll processing. You can use events to schedule long-running processing during off-hours, like updating a billing table based on orders that came in that day. Sometimes you schedule off-hour events because your functionality needs to happen at a particular time, like making changes to the database at 2 <span class="Caps">AM</span> when Daylight Saving Time begins.</p>
<h2 id="h1-503007c13-0001"><span epub:type="pagebreak" title="210" id="Page_210"/><a class="XrefDestination" id="TheEventScheduler"/><span class="XrefDestination" id="xref-503007c13-003"/>The Event Scheduler</h2>
<p class="BodyFirst">MySQL has an <em>event scheduler</em> that manages the scheduling and execution of events. The event scheduler can be turned on or off, but should be on by default. To confirm that the scheduler is on, run the following command:</p>
<pre><code>show variables like 'event_scheduler';</code></pre>
<p>If your scheduler is on, the result should look as follows:</p>
<pre><code>Variable_name    Value
---------------  -----
event_scheduler    ON</code></pre>
<p>If the <code>Value</code> displayed is <code>OFF</code>, you (or your database administrator) need to turn the scheduler on with this command:</p>
<pre><code>set global event_scheduler = on;</code></pre>
<p>If the <code>Value</code> returned is <code>DISABLED</code>, your MySQL server was started with the scheduler disabled. Sometimes this is done to temporarily stop the scheduler. You can still schedule events, but no events will fire until the scheduler is enabled again. If the event scheduler is disabled, it needs to be changed in a configuration file managed by your database administrator.</p>
<h2 id="h1-503007c13-0002"><a class="XrefDestination" id="CreatingEventswithNoEndDate"/><span class="XrefDestination" id="xref-503007c13-004"/>Creating Events with No End Date</h2>
<p class="BodyFirst">In <a href="#listing13-1" id="listinganchor13-1">Listing 13-1</a> you create an event that removes old rows from the <code>payable_audit</code> table in the <code>bank</code> database.</p>
<pre><code>use bank;

drop event if exists e_cleanup_payable_audit;

delimiter //

<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> create event e_cleanup_payable_audit
<span class="CodeAnnotationCode" aria-label="annotation2">❷</span> on schedule every 1 month
<span class="CodeAnnotationCode" aria-label="annotation3">❸</span> starts '2024-01-01 10:00'
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span> do
begin
<span class="CodeAnnotationCode" aria-label="annotation5">❺</span> delete from payable_audit
  where audit_datetime &lt; date_sub(now(), interval 1 year);
end //

delimiter ;</code></pre>
<p class="CodeListingCaption"><a id="listing13-1">Listing 13-1</a>: Creating a monthly event</p>
<p><span epub:type="pagebreak" title="211" id="Page_211"/>To create the event in the <code>bank</code> database, first you set your current database to <code>bank</code> with the <code>use</code> command. Then you drop the old version of this event (if one exists) in order to create a new one. Next you create the event, <code>e_cleanup_payable_audit</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>, and set a schedule to run it once per month.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	Consider beginning events with <code>e_</code> to make their purpose clear.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>Every event begins with <code>on schedule</code>; for a one-time event, you’d follow this with the <code>at</code> keyword and the timestamp (the date and time) at which the event should fire. For a recurring event, <code>on schedule</code> should be followed by the word <code>every</code> and the interval at which it should fire. For example, <code>every 1 hour</code>, <code>every 2 week</code>, or <code>every 3 year</code>. (Intervals are expressed in the singular form, like <code>3 year</code> and not <code>3 year</code><code class="bold">s</code>.) In this case, you specify <code>every 1 month</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. You’ll also define the date and time when the recurring event <code>starts</code> and <code>ends</code>.</p>
<p>For your event, you define <code>starts</code> as <code>2024-01-01 10:00</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span>, meaning your event will start firing on 1/1/2024 at 10 <span class="Caps">AM</span> and will fire every month at this time. You didn’t use the <code>ends</code> keyword, so this event will fire monthly—theoretically forever—until the event is dropped with the <code>drop event</code> command.</p>
<p>Then, you define the event’s actions with the <code>do</code> command <span class="CodeAnnotation" aria-label="annotation4">❹</span>, and add the SQL statements that perform the functionality in the event body. Your event body starts with <code>begin</code> and ends with <code>end</code>. Here, you delete rows in the <code>payable_audit</code> table that are more than one year old <span class="CodeAnnotation" aria-label="annotation5">❺</span>. While you use only one statement here, it is possible to put multiple SQL statements in the event body.</p>
<p>The <code>show events</code> command displays a list of scheduled events in the current database, as in <a href="#figure13-1" id="figureanchor13-1">Figure 13-1</a>.</p>
<figure>
<img src="image_fi/503007c13/f13001.png" class="keyline" alt="" width="844" height="129"/>
<figcaption><p><a id="figure13-1">Figure 13-1</a>: The <span class="LiteralInCaption"><code>show events</code></span> command as seen in MySQL Workbench</p></figcaption>
</figure>
<p>The user account that defined the event is listed as the Definer. This gives you an audit trail that tells you who scheduled which events.</p>
<p>To show only events for a particular database (even if you aren’t currently in that database), use the <code>show events in </code><var>database</var> command. In this example, the command would be <code>show events in bank</code>.</p>
<p>To get a list of all events in all databases, you can use the following query:</p>
<pre><code>select * from information_schema.events;</code></pre>
<p>MySQL provides you with the <code>events</code> table in the <code>information_schema</code> database that you can query for this purpose.</p>
<h2 id="h1-503007c13-0003"><span epub:type="pagebreak" title="212" id="Page_212"/><a class="XrefDestination" id="CreatingEventswithanEndDate"/><span class="XrefDestination" id="xref-503007c13-005"/>Creating Events with an End Date</h2>
<p class="BodyFirst">For events that should run for a limited time, use the <code>ends</code> keyword. For example, you might want to create an event that runs at 1/1/2024 once an hour between 9 <span class="Caps">AM</span> and 5 <span class="Caps">PM</span>:</p>
<pre><code>on schedule every 1 hour
starts '2024-01-01 9:00'
ends '2024-01-01 17:00'</code></pre>
<p>To schedule an event that runs every 5 minutes for the next hour, you might enter the following:</p>
<pre><code>on schedule every 5 minute
starts current_timestamp
ends current_timestamp + interval 1 hour</code></pre>
<p>You started your event immediately. It will fire every 5 minutes, and will stop firing one hour from now.</p>
<p>Sometimes you need an event to fire just once at a particular date and time. For example, you may need to wait until after midnight to do some one-time account updates to your <code>bank</code> database so that interest rates are calculated first by another process. You could define an event like so:</p>
<pre><code>use bank;

drop event if exists e_account_update;

delimiter //

create event e_account_update
on schedule at '2024-03-10 00:01'
do
begin
  call p_account_update();
end //

delimiter ;</code></pre>
<p>Your <code>e_account_update</code> event is scheduled to run on 3/10/2024 at 1 minute past midnight.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	Events can call procedures. In this example, you moved the functionality that updates your account out of the event and into the <code>p_account_update()</code> procedure, which allows you to call it from your scheduled event but also call the procedure directly to execute it immediately.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>You might find it useful to schedule a one-time event when the clocks change to Daylight Saving Time. On 3/10/2024, for example, the clocks move <span epub:type="pagebreak" title="213" id="Page_213"/>forward one hour. On 11/6/2024, Daylight Saving Time ends and the clocks move back one hour. In many databases, data will need to change as a result.</p>
<p>Schedule a one-time event for March 10, 2024, so that the database makes changes when Daylight Saving Time begins. On that date at 2 <span class="Caps">AM</span>, your system clock will change to 3 <span class="Caps">AM</span>. Schedule your event for 1 minute before the clocks change:</p>
<pre><code>use bank;

drop event if exists e_change_to_dst;

delimiter //

create event e_change_to_dst
on schedule
at '2024-03-10 1:59'
do
begin
  -- Make any changes to your application needed for DST
  update current_time_zone
  set    time_zone = 'EDT';
end //

delimiter ;</code></pre>
<p>Rather than having to stay awake until 1:59 in the morning to change the clock, you can schedule an event to do it for you.</p>
<h2 id="h1-503007c13-0004"><a class="XrefDestination" id="CheckingforErrors"/><span class="XrefDestination" id="xref-503007c13-006"/>Checking for Errors</h2>
<p class="BodyFirst">To check for errors after your event runs, query a table in the <code>performance_schema</code> database called <code>error_log</code>.</p>
<p>The <code>performance_schema</code> database is used to monitor the performance of MySQL. The <code>error_log</code> table houses diagnostic messages like errors, warnings, and notifications of the MySQL server starting or stopping.</p>
<p>For example, you can check all event errors by finding rows where the <code>data</code> column contains the text <code>Event Scheduler</code>:</p>
<pre><code>select *
from   performance_schema.error_log
where  data like '%Event Scheduler%';</code></pre>
<p>This query finds all rows in the table that have the text <code>Event Scheduler</code> somewhere in the <code>data</code> column. Recall from <span class="xref" itemid="xref_target_C">Chapter 7</span> that the <code>like</code> operator allows you to check if a string matches some pattern. Here you’re using the <code>%</code> wildcard character to check that the <code>data</code> column contains a value that starts with any character(s), contains the text <code>Event Scheduler</code>, then ends with any character(s).</p>
<p><span epub:type="pagebreak" title="214" id="Page_214"/>To find errors for a particular event, search for the event name. Say the <code>e_account_update</code> event calls a procedure named <code>p_account_update()</code>, but that procedure doesn’t exist. You’ll find errors for the <code>e_account_update</code> event like so:</p>
<pre><code>select  *
from    performance_schema.error_log
where   data like '%e_account_update%';</code></pre>
<p>The query returns a row that shows the <code>logged</code> column with the date and time when the event fired, and the <code>data</code> column shows an error message (<a href="#figure13-2" id="figureanchor13-2">Figure 13-2</a>).</p>
<figure>
<img src="image_fi/503007c13/f13002.png" class="keyline" alt="" width="844" height="116"/>
<figcaption><p><a id="figure13-2">Figure 13-2</a>: Displaying event errors in MySQL Workbench</p></figcaption>
</figure>
<p>The message tells you that the <code>e_account_update</code> event in the <code>bank</code> database failed because <code>p_account_update</code> does not exist.</p>
<p>You can disable an event using the <code>alter</code> command:</p>
<pre><code>alter event e_cleanup_payable_audit disable;</code></pre>
<p>The event will not fire again until you re-enable it, like so:</p>
<pre><code>alter event e_cleanup_payable_audit enable;</code></pre>
<p>When an event is no longer needed, you can drop it from the database using the <code>drop event</code> command.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="boxcustom1">
<h2>Try it Yourself</h2>
<p class="BoxListNumberCustom1"><b>13-1.</b>	Create a recurring event in the <code>eventful</code> database called <code>e_write_timestamp</code> that starts firing now and stops firing in 5 minutes. Create the event so that every minute, the event writes the current timestamp into the <code>message</code> column of the <code>event_message</code> table, using this command:</p>
<pre><code>insert into event_message (message)
values (current_timestamp);</code></pre>
<p class="BoxListNumberCustom1"><b>13-2.</b>	Check if there were any errors for the event.</p>
<p class="BoxListNumberCustom1"><b>13-3.</b>	Over the next 5 minutes, check the contents of the <code>event_message</code> table using the <code>select * from event_message;</code> command. Are new timestamps being inserted into the table every minute?</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-503007c13-0005"><span epub:type="pagebreak" title="215" id="Page_215"/><a class="XrefDestination" id="Summary"/><span class="XrefDestination" id="xref-503007c13-008"/>Summary</h2>
<p class="BodyFirst">In this chapter, you scheduled events to fire once and on a recurring basis. You learned how to check for errors in your event scheduler, and disable and drop events. The next chapter will focus on assorted tips and tricks that can make MySQL more productive and enjoyable.</p>
</section>
</div>
</div>
</body></html>