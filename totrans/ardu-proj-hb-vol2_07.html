<html><head></head><body>
<h1 class="h1-part" id="part06"><span epub:type="pagebreak" id="page_189"/><strong><span class="red">Smart Machines</span></strong></h1>&#13;


<h2 class="h2s" id="ch22"><span epub:type="pagebreak" id="page_190"/><strong>22<br/>Ultrasonic Robot</strong></h2>&#13;
<p class="intro"><span class="red">In this project we’ll combine an ultrasonic sensor with two DC motors and a servomotor to create a simple object-avoiding robot.</span></p>&#13;
<div class="image"><img alt="Image" src="../images/p0190-01.jpg"/></div>&#13;
<div class="image"><span epub:type="pagebreak" id="page_191"/><img alt="Image" src="../images/p0191-01.jpg"/></div>&#13;
<p class="capb"><strong>PARTS REQUIRED</strong></p>&#13;
<p class="cap1"><strong>Arduino board</strong></p>&#13;
<p class="cap1"><strong>Jumper wires</strong></p>&#13;
<p class="cap1"><strong>L293d motor shield</strong></p>&#13;
<p class="cap1"><strong>2 DC motors and wheels<a id="note_01"/><a href="ch22.xhtml#note01">*</a></strong></p>&#13;
<p class="cap1"><strong>HC-SR04 ultrasonic sensor</strong></p>&#13;
<p class="cap1"><strong>9V AA battery pack</strong></p>&#13;
<p class="cap1"><strong>Robot base with fittings<a href="ch22.xhtml#note01">*</a></strong></p>&#13;
<p class="cap1"><strong>Center wheel<a href="ch22.xhtml#note01">*</a></strong></p>&#13;
<p class="cap1"><strong>Tower Pro SG90 9g servomotor</strong></p>&#13;
<p class="capb"><strong>LIBRARIES REQUIRED</strong></p>&#13;
<p class="cap1"><strong>Servo</strong></p>&#13;
<p class="cap1"><strong>NewPing</strong></p>&#13;
<p class="cap1"><strong>Adafruit Motor Shield V1</strong></p>&#13;
<p class="noindentt"><strong><a id="note01"/><a href="ch22.xhtml#note_01">*</a> These items can be purchased as part of a kit</strong></p>&#13;
<h3 class="h3" id="ch00lev1sec91"><span epub:type="pagebreak" id="page_192"/><span class="red"><strong>HOW IT WORKS</strong></span></h3>&#13;
<p class="noindent">The key parts of the ultrasonic robot are the HC-SR04 ultrasonic sensor, L293d motor shield, and the motors. The motors I used were purchased as part of a kit; if you search online for “Arduino robot kit,” you too should be able to find a kit that contains the motors and wheels, base, battery pack, center wheel, and fittings needed. The one I bought is called the “2WD Smart Motor Robot Car Chassis Kit for Arduino 1:48,” so try a few of those keywords until you find something similar to the kit in <a href="ch22.xhtml#ch22fig1">Figure 22-1</a>. Also try the suppliers listed in the “<a href="app02.xhtml#ch00lev1sec170">Retailer List</a>” on <a href="app02.xhtml#page_249">page 249</a>.</p>&#13;
<p class="figcap"><a id="ch22fig1"/><strong>FIGURE 22-1:</strong> Robot motor kit</p>&#13;
<div class="image"><img alt="Image" src="../images/f22-01.jpg"/></div>&#13;
<p class="indent">The ultrasonic sensor sends and receives a signal to determine the distance of an object. If there is an object less than 15 centimeters away, the robot will stop, look around, turn toward a direction in which it doesn’t sense anything, and move in that direction. The ultrasonic sensor is mounted on a servomotor so that the robot can move and search for a clear route. For more on how the HC-SR04 ultrasonic sensor works, see Project 13. The L293d motor shield fits on top of the Arduino and controls the DC motors using the Adafruit Motor Shield library.</p>&#13;
<h3 class="h3" id="ch00lev1sec92"><span class="red"><strong>THE BUILD</strong></span></h3>&#13;
<ol>&#13;
<li><p class="noindents">You will need to solder wires to the DC motors as shown in <a href="ch22.xhtml#ch22fig2">Figure 22-2</a>. See the “<a href="pref02.xhtml#ch00lev1sec123">Quick Soldering Guide</a>” on <a href="pref02.xhtml#page_12">page 12</a> if <span epub:type="pagebreak" id="page_193"/>you need a refresher on how to do this. Solder the red, positive power wire to the left pin of one DC motor and the black ground wire to the right pin; reverse this order for the other motor. DC motors do not have polarity, so it doesn’t matter which way you hold the motors to determine which is left and right, but power and GND need to be in opposite positions on the motors so the direction of the revolution will be the same.</p>&#13;
<p class="figcap"><a id="ch22fig2"/><strong>FIGURE 22-2:</strong> Solder the red, positive power wire to the left pin of one DC motor, and the black ground wire to the right pin. Reverse this order for the other motor.</p>&#13;
<div class="image"><img alt="Image" src="../images/f22-02.jpg"/></div></li>&#13;
<li><p class="noindents">Attach the single wheel to the front of the robot base and the two rear wheels to the back using the screws and fittings provided. The underside of the robot should resemble <a href="ch22.xhtml#ch22fig3">Figure 22-3</a>.</p>&#13;
<p class="figcap"><a id="ch22fig3"/><strong>FIGURE 22-3:</strong> Assemble the base of the Arduino robot.</p>&#13;
<div class="image"><img alt="Image" src="../images/f22-03.jpg"/></div></li>&#13;
<li><p class="noindents"><span epub:type="pagebreak" id="page_194"/>Now you need the L293d motor shield (<a href="ch22.xhtml#ch22fig4">Figure 22-4</a>); we’ll solder some wires to it to control the ultrasonic sensor.</p>&#13;
<p class="figcap"><a id="ch22fig4"/><strong>FIGURE 22-4:</strong> The L293d motor shield. We’ll solder four wires to the pins highlighted in the image.</p>&#13;
<div class="image"><img alt="Image" src="../images/f22-04.jpg"/></div></li>&#13;
<li><p class="noindents">Take four female jumper wires and strip about 5 millimeters from one end of each, as shown in <a href="ch22.xhtml#ch22fig5">Figure 22-5</a>.</p>&#13;
<p class="figcap"><a id="ch22fig5"/><strong>FIGURE 22-5:</strong> Strip the ends of four female jumper wires to solder onto the motor shield.</p>&#13;
<div class="image"><img alt="Image" src="../images/f22-05.jpg"/></div></li>&#13;
<li><p class="noindents">Solder the stripped ends to the highlighted pins on the motor shield, as shown in <a href="ch22.xhtml#ch22fig6">Figure 22-6</a>. This can be tricky, so take your time to create the best connection you can.</p>&#13;
<p class="figcap"><span epub:type="pagebreak" id="page_195"/><a id="ch22fig6"/><strong>FIGURE 22-6:</strong> Solder the jumper wires to the motor shield (shown in <a href="ch22.xhtml#ch22fig4">Figure 22-4</a>). The two pins below the power connections should connect to analog A4 and A5 to control the sensor.</p>&#13;
<div class="image"><img alt="Image" src="../images/f22-06.jpg"/></div></li>&#13;
<li><p class="noindents">Once you’ve soldered the wires to the motor shield, place the shield on top of the Arduino so that the pins of the shield line up with the holders in the Arduino below. The shield should fit exactly, but take care to align the pins to the holes and gently lower it in place.</p></li>&#13;
<li><p class="noindents">Next, connect the ultrasonic sensor to the female ends of the jumper wires you soldered to the motor shield. Connect VCC on the sensor to +5V on the motor shield, Trig to A4, Echo to A5, and GND to GND (see the following table).</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thre" style="vertical-align: top;"><p class="tablec"><strong>ULTRASONIC SENSOR</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>MOTOR SHIELD</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">VCC</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="red">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">Trig</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="red">Pin A4</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">Echo</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="red">Pin A5</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">GND</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="red">GND</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindents">Connect the wires from the DC motors to the motor shield as shown in the following tables and <a href="ch22.xhtml#ch22fig7">Figure 22-7</a>. You connect the wires by feeding them through the pin and using the screws to grip the wires in place.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thre" style="vertical-align: top;"><p class="tablec"><strong>LEFT MOTOR</strong></p></td>&#13;
<td class="table_thr" style="vertical-align: top;"><p class="tablec"><strong>MOTOR SHIELD</strong></p></td>&#13;
<td class="table_thre" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">Red wire</span></p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="tablec"><span class="red">M1</span></p></td>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">Black wire</span></p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="tablec"><span class="red">M1</span></p></td>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">GND</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thre" style="vertical-align: top;"><p class="tablec"><strong>RIGHT MOTOR</strong></p></td>&#13;
<td class="table_thr" style="vertical-align: top;"><p class="tablec"><strong>MOTOR SHIELD</strong></p></td>&#13;
<td class="table_thre" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">Red wire</span></p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="tablec"><span class="red">M3</span></p></td>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">Black wire</span></p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="tablec"><span class="red">M3</span></p></td>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">GND</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<p class="figcap"><span epub:type="pagebreak" id="page_196"/><a id="ch22fig7"/><strong>FIGURE 22-7:</strong> Connect the power wires of the DC motors as shown.</p>&#13;
<div class="image"><img alt="Image" src="../images/f22-07.jpg"/></div></li>&#13;
<li><p class="noindents">Next attach the servomotor to the shield, as shown in the following table and <a href="ch22.xhtml#ch22fig8">Figure 22-8</a>.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thre" style="vertical-align: top;"><p class="tablec"><strong>SERVOMOTOR</strong></p></td>&#13;
<td class="table_thr" style="vertical-align: top;"><p class="tablec"><strong>MOTOR SHIELD</strong></p></td>&#13;
<td class="table_thre" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">Brown wire</span></p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="tablec"><span class="red">Servo_2 -</span></p></td>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">Red wire</span></p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="tablec"><span class="red">Servo_2 +</span></p></td>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">Yellow wire</span></p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="tablec"><span class="red">Servo_2 s</span></p></td>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">Signal</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<p class="figcap"><a id="ch22fig8"/><strong>FIGURE 22-8:</strong> Connect the servomotor to the shield as shown.</p>&#13;
<div class="image"><img alt="Image" src="../images/f22-08.jpg"/></div></li>&#13;
<li><p class="noindents"><span epub:type="pagebreak" id="page_197"/>Attach the servomotor to the front of the robot using glue or tape. Then attach the ultrasonic sensor to the horn of the servomotor so it moves with the servo arm and your robot can look around. At this stage the robot should look something like <a href="ch22.xhtml#ch22fig9">Figure 22-9</a>.</p>&#13;
<p class="figcap"><a id="ch22fig9"/><strong>FIGURE 22-9:</strong> The completed robot with ultrasonic sensor attached to the servomotor</p>&#13;
<div class="image"><img alt="Image" src="../images/f22-09.jpg"/></div></li>&#13;
<li><p class="noindents">Make sure you’ve downloaded the NewPing and Adafruit Motor Shield libraries and added them to your IDE. The Servo library is already included in the IDE, so you don’t need to install it.</p></li>&#13;
<li><p class="noindents">Once you’ve confirmed that your setup matches the circuit diagram in <a href="ch22.xhtml#ch22fig10">Figure 22-10</a>, upload the code in “<a href="ch22.xhtml#ch00lev1sec93">The Sketch</a>” on <a href="ch22.xhtml#page_198">page 198</a> and connect the 9V battery pack to your Arduino to see your robot in action!</p>&#13;
<p class="figcap"><a id="ch22fig10"/><strong>FIGURE 22-10:</strong> The circuit diagram for the ultrasonic robot</p>&#13;
<div class="image"><img alt="Image" src="../images/f22-10.jpg"/></div></li>&#13;
</ol>&#13;
<h3 class="h3" id="ch00lev1sec93"><span epub:type="pagebreak" id="page_198"/><span class="red"><strong>THE SKETCH</strong></span></h3>&#13;
<p class="noindent">The sketch starts by calling on the Adafruit Motor Shield, NewPing, and Servo libraries. The Trig pin of the ultrasonic sensor is defined as Arduino A4 and the Echo pin as Arduino A5. The maximum distance of the ultrasonic sensor is set at 200 centimeters and the speed of the DC motors is set at a medium speed of 190 (out of 255). The DC motors are defined to use connections M1 and M3 of the motor shield.</p>&#13;
<p class="indent">The servo is given a name and attached to pin 9 on the Arduino (via the connection on the motor shield). The loops after that take a reading from the ultrasonic sensor and, if it detects that an object is less than 15 centimeters away, the motors stop and reverse slightly, the servo moves left and right once to look around, and the robot turns to the left and continues to move forward until it discovers another object.</p>&#13;
<p class="programs1"><span class="ash">// Reproduced with kind permission from Nick Koumaris</span><br/><span class="ash">// <a href="http://www.educ8s.tv">http://www.educ8s.tv</a></span><br/>#include &lt;AFMotor.h&gt;<br/>#include &lt;NewPing.h&gt;<br/>#include &lt;<span class="orange">Servo</span>.h&gt;<br/>#define TRIG_PIN A4<br/>#define ECHO_PIN A5<br/>#define MAX_DISTANCE 200<br/>#define MAX_SPEED 190 <span class="ash">// Sets speed of DC motors</span><br/>#define MAX_SPEED_OFFSET 20<br/><br/>NewPing sonar(TRIG_PIN, ECHO_PIN, MAX_DISTANCE);<br/>AF_DCMotor motor1(1, MOTOR12_1KHZ); <span class="ash">// First motor to connection 1</span><br/>AF_DCMotor motor2(3, MOTOR12_1KHZ); <span class="ash">// Second motor to connection 3</span><br/><span class="orange">Servo</span> myservo; <span class="ash">// Give the servo a name</span><br/><span class="green1">boolean</span> goesForward = false;<br/><span class="green1">int</span> distance = 100; <span class="ash">// Define an int for distance and speed</span><br/><span class="green1">int</span> speedSet = 0;<br/><br/><span class="green1">void</span> <span class="green2">setup</span>() {<br/>  myservo.<span class="orange">attach</span>(9); <span class="ash">// Servo attached to pin 9</span><br/>  myservo.<span class="orange">write</span>(115); <span class="ash">// Set servo at 115 degrees</span><br/>  <span class="orange">delay</span>(2000);<br/>  distance = readPing(); <span class="ash">// Read the distance from the sensor</span><br/>  <span class="orange">delay</span>(100);<br/>  distance = readPing();<br/>  <span class="orange">delay</span>(100);<br/>  distance = readPing();<br/>  <span class="orange">delay</span>(100);<br/>  distance = readPing();<br/>  <span class="orange">delay</span>(100);<br/>}<br/><span class="green1"><span epub:type="pagebreak" id="page_199"/>void</span> <span class="green2">loop</span>() {<br/>  <span class="green1">int</span> distanceR = 0;<br/>  <span class="green1">int</span> distanceL = 0;<br/>  <span class="orange">delay</span>(40);<br/>  <span class="ash">// If distance is less than 15 cm, carry out this function</span><br/>  <span class="green2">if</span> (distance &lt;= 15) {<br/>    moveStop();<br/>    <span class="orange">delay</span>(100);<br/>    moveBackward();<br/>    <span class="orange">delay</span>(300);<br/>    moveStop();<br/>    <span class="orange">delay</span>(200);<br/>    distanceR = lookRight();<br/>    <span class="orange">delay</span>(200);<br/>    distanceL = lookLeft();<br/>    <span class="orange">delay</span>(200);<br/>    <span class="green2">if</span> (distanceR &gt;= distanceL) {<br/>      turnRight();<br/>      moveStop();<br/>    } <span class="green2">else</span> { <span class="ash">// Or else carry on</span><br/>      turnLeft();<br/>      moveStop();<br/>    }<br/>  } <span class="green2">else</span> {<br/>    moveForward();<br/>  }<br/>  distance = readPing();<br/>}<br/><br/><span class="green1">int</span> lookRight() { <span class="ash">// The servo looks to the right</span><br/>  myservo.<span class="orange">write</span>(50);<br/>  <span class="orange">delay</span>(500);<br/>  <span class="green1">int</span> distance = readPing();<br/>  <span class="orange">delay</span>(100);<br/>  myservo.<span class="orange">write</span>(115);<br/>  <span class="green2">return</span> distance;<br/>}<br/><br/><span class="green1">int</span> lookLeft() { <span class="ash">// The servo looks to the left</span><br/>  myservo.<span class="orange">write</span>(170);<br/>  <span class="orange">delay</span>(500);<br/>  <span class="green1">int</span> distance = readPing();<br/>  <span class="orange">delay</span>(100);<br/>  myservo.<span class="orange">write</span>(115);<br/>  <span class="green2">return</span> distance;<br/>  <span class="orange">delay</span>(100);<br/>}<br/><br/><span class="green1">int</span> readPing() {<br/>  <span class="orange">delay</span>(70);<br/>  <span class="green1">int</span> cm = sonar.ping_cm();<br/>  <span class="green2">if</span> (cm == 0) {<br/>    cm = 250;<br/>  }<br/><span epub:type="pagebreak" id="page_200"/>  <span class="green2">return</span> cm;<br/>}<br/><br/><span class="green1">void</span> moveStop() {<br/>  motor1.<span class="orange">run</span>(RELEASE);<br/>  motor2.<span class="orange">run</span>(RELEASE);<br/>}<br/><br/><span class="green1">void</span> moveForward() {<br/>  <span class="green2">if</span> (!goesForward) { <span class="ash">// If area is clear, motors move forward</span><br/>    goesForward = true;<br/>    motor1.<span class="orange">run</span>(FORWARD);<br/>    motor2.<span class="orange">run</span>(FORWARD);<br/>    <span class="ash">// Slowly bring up speed to avoid loading down</span><br/>    <span class="ash">// batteries too quickly</span><br/>    <span class="green2">for</span> (speedSet = 0; speedSet &lt; MAX_SPEED; speedSet += 2) {<br/>      motor1.<span class="orange">setSpeed</span>(speedSet);<br/>      motor2.<span class="orange">setSpeed</span>(speedSet + MAX_SPEED_OFFSET);<br/>      <span class="orange">delay</span>(5);<br/>    }<br/>  }<br/>}<br/><br/><span class="green1">void</span> moveBackward() {<br/>  goesForward = false;<br/>  motor1.<span class="orange">run</span>(BACKWARD);<br/>  motor2.<span class="orange">run</span>(BACKWARD);<br/>  <span class="ash">// Slowly bring up speed to avoid loading down</span><br/>  <span class="ash">// batteries too quickly</span><br/>  <span class="green2">for</span> (speedSet = 0; speedSet &lt; MAX_SPEED; speedSet += 2) {<br/>    motor1.<span class="orange">setSpeed</span>(speedSet);<br/>    motor2.<span class="orange">setSpeed</span>(speedSet + MAX_SPEED_OFFSET);<br/>    <span class="orange">delay</span>(5);<br/>  }<br/>}<br/><br/><span class="green1">void</span> turnRight() { <span class="ash">// Movement for turning right</span><br/>  motor1.<span class="orange">run</span>(FORWARD);<br/>  motor2.<span class="orange">run</span>(BACKWARD);<br/>  <span class="orange">delay</span>(300);<br/>  motor1.<span class="orange">run</span>(FORWARD);<br/>  motor2.<span class="orange">run</span>(FORWARD);<br/>}<br/><br/><span class="green1">void</span> turnLeft() { <span class="ash">// Movement for turning left</span><br/>  motor1.<span class="orange">run</span>(BACKWARD);<br/>  motor2.<span class="orange">run</span>(FORWARD);<br/>  <span class="orange">delay</span>(300);<br/>  motor1.<span class="orange">run</span>(FORWARD);<br/>  motor2.<span class="orange">run</span>(FORWARD);<br/>}</p>&#13;
<h3 class="h3" id="ch00lev1sec94"><span epub:type="pagebreak" id="page_201"/><span class="red"><strong>TROUBLESHOOTING</strong></span></h3>&#13;
<p class="ques"><strong>Q.</strong> <em>The code compiles, but the Arduino robot does not function as expected.</em></p>&#13;
<p class="bull">• Make sure that your wiring matches the tables in steps 7, 8, and 9 and the circuit diagram in <a href="ch22.xhtml#ch22fig10">Figure 22-10</a>.</p>&#13;
<p class="bull">• If your robot spins around rather than moving forward, reverse the wiring on one of the DC motors—as mentioned earlier, they don’t have polarity but changing the power connections will reverse the motor’s rotation.</p>&#13;
<p class="bull">• Power the robot with a pack of 1.5V AA batteries in series rather than a 9V battery, which has less amperage and will drain quicker.</p>&#13;


<h2 class="h2s" id="ch23"><span epub:type="pagebreak" id="page_202"/><strong>23<br/>Internet-Controlled LED</strong></h2>&#13;
<p class="intro"><span class="red">In this project we’ll use an ethernet shield to connect our Arduino to the internet and control an LED from a web browser.</span></p>&#13;
<div class="image"><img alt="Image" src="../images/p0202-01.jpg"/></div>&#13;
<div class="image"><span epub:type="pagebreak" id="page_203"/><img alt="Image" src="../images/p0203-01.jpg"/></div>&#13;
<p class="capb"><strong>PARTS REQUIRED</strong></p>&#13;
<p class="cap1"><strong>Arduino board</strong></p>&#13;
<p class="cap1"><strong>Breadboard</strong></p>&#13;
<p class="cap1"><strong>Jumper wires</strong></p>&#13;
<p class="cap1"><strong>Ethernet shield W5100 LAN expansion board</strong></p>&#13;
<p class="cap1"><strong>Ethernet cable</strong></p>&#13;
<p class="cap1"><strong>LED</strong></p>&#13;
<p class="cap1"><strong>220-ohm resistor</strong></p>&#13;
<p class="capb"><strong>LIBRARIES REQUIRED</strong></p>&#13;
<p class="cap1"><strong>SPI</strong></p>&#13;
<p class="cap1"><strong>Ethernet</strong></p>&#13;
<p class="indentt"><span epub:type="pagebreak" id="page_204"/>The <em>Internet of Things (IoT)</em> is revolutionizing our use of everyday items. The term refers to objects or smart devices connected through a network, usually involving the internet. This allows us to control devices remotely, from inside or outside the house! Amazon Echo and Google Home are taking things further by allowing a multitude of devices to be connected and controlled via a central hub, even if you aren’t at home. We’ll create our own IoT project in its most basic form to demonstrate the principles involved.</p>&#13;
<h3 class="h3" id="ch00lev1sec95"><span class="red"><strong>HOW IT WORKS</strong></span></h3>&#13;
<p class="noindent">The Ethernet shield W5100 LAN expansion board, shown in <a href="ch23.xhtml#ch23fig1">Figure 23-1</a>, fits directly on top of the Arduino to provide additional functionality to the board. We’ll use the Ethernet library built into the Arduino IDE to connect our board to the internet via an Ethernet cable, as shown in <a href="ch23.xhtml#ch23fig2">Figure 23-2</a>.</p>&#13;
<p class="figcap"><a id="ch23fig1"/><strong>FIGURE 23-1:</strong> Ethernet shield</p>&#13;
<div class="image"><img alt="Image" src="../images/f23-01.jpg"/></div>&#13;
<p class="figcap"><a id="ch23fig2"/><strong>FIGURE 23-2:</strong> Ethernet cable</p>&#13;
<div class="image"><img alt="Image" src="../images/f23-02.jpg"/></div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_205"/>The library allows the Arduino to act as a server to accept incoming commands, a client to send them out, or both. The shield communicates with the Arduino using the <em>Serial Peripheral Interface (SPI)</em> connections. On the Arduino Uno the SPI connections are on digital pins 10, 11, 12, and 13. In our project the Arduino will use both functions to send information to the internet in the form of a simple web page and accept commands from this page to control an LED. Buttons on the web page will allow us to switch the LED on or off as long as the Arduino is powered and connected to the internet.</p>&#13;
<h3 class="h3" id="ch00lev1sec96"><span class="red"><strong>SETTING UP YOUR ETHERNET CONNECTION</strong></span></h3>&#13;
<p class="noindent">You need to know the MAC address of your shield for this project to work. A <em>MAC address</em> is a unique number assigned to devices for communication and is used as a network address for Ethernet and Wi-Fi. If you have a newer shield, the MAC address will be printed on a product sticker. If you have an older generic Ethernet shield like the one we are using, you can use the MAC address 0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0xED for this project.</p>&#13;
<p class="indent">For communication, we’ll use port 80, the default for HTTP. Short for HyperText Transfer Protocol, HTTP is the set of rules for transferring data over the internet. In this instance port 80 handles the transfer of data to a web page.</p>&#13;
<p class="indent">Our sketch includes some HTML (HyperText Markup Language) code, which tells a web browser how to display an internet page. If you right-click on any web page and select Inspect, you can see some of the HTML code behind that page.</p>&#13;
<p class="indent">The section of our sketch that includes HTML code is as follows and produces the web page displayed in <a href="ch23.xhtml#ch23fig3">Figure 23-3</a>.</p>&#13;
<p class="programs1">client.<span class="orange">println</span>(<span class="green1">"HTTP/1.1 200 OK"</span>);<br/>client.<span class="orange">println</span>(<span class="green1">"Content-Type: text/html"</span>);<br/>client.<span class="orange">println</span>();<br/>client.<span class="orange">print</span>(<span class="green1">"&lt;center&gt;&lt;br&gt;&lt;h1&gt;Internet Controlled LED&lt;/h1&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;FORM&gt;"</span>);<br/>client.<span class="orange">print</span>(<span class="green1">"&lt;P&gt; &lt;INPUT type=\"submit\" name=\"status\"value=\"ON\"&gt;"</span>);<br/>client.<span class="orange">print</span>(<span class="green1">"&lt;P&gt; &lt;INPUT type=\"submit\" name=\"status\"value=\"OFF\"&gt;"</span>);<br/>client.<span class="orange">print</span>(<span class="green1">"&lt;/FORM&gt;&lt;/center&gt;"</span>);</p>&#13;
<p class="figcap"><span epub:type="pagebreak" id="page_206"/><a id="ch23fig3"/><strong>FIGURE 23-3:</strong> Our simple web page to control the LED</p>&#13;
<div class="image"><img alt="Image" src="../images/f23-03.jpg"/></div>&#13;
<h3 class="h3" id="ch00lev1sec97"><span class="red"><strong>THE BUILD</strong></span></h3>&#13;
<ol>&#13;
<li><p class="noindents">Attach the Ethernet shield on top of the Arduino board as shown in <a href="ch23.xhtml#ch23fig4">Figure 23-4</a>. The board fits directly on top of the Arduino, so gently press the legs of the shield in place with the holes of the Arduino beneath.</p>&#13;
<p class="figcap"><a id="ch23fig4"/><strong>FIGURE 23-4:</strong> Attach the Ethernet shield on top of the Arduino board.</p>&#13;
<div class="image"><img alt="Image" src="../images/f23-04.jpg"/></div></li>&#13;
<li><p class="noindents">Insert the LED into the breadboard with the legs straddling the center break of the board. Then, as shown in the following table, connect the shorter, negative leg of the LED to the GND rail of the breadboard via a 220-ohm resistor, and connect the longer, positive leg of the LED to pin 7 on the Arduino/Ethernet shield. Connect the GND rail of the breadboard to Arduino GND.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thre" style="vertical-align: top;"><span epub:type="pagebreak" id="page_207"/><p class="tablec"><strong>LED</strong></p></td>&#13;
<td class="table_thr" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">Negative leg</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="red">GND via 220-ohm resistor</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">Positive leg</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="red">Pin 7</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindents">With the Ethernet shield attached on top of the Arduino, connect the shield to your router with the Ethernet cable.</p>&#13;
<div class="noter">&#13;
<p class="notet"><strong>NOTE</strong></p>&#13;
<p class="notep"><em>Take note of your IP address; it will be different from mine shown in <a href="ch23.xhtml#ch23fig5">Figure 23-5</a>.</em></p>&#13;
</div></li>&#13;
<li><p class="noindents">Attach the Arduino to your PC and upload the code at the end of the project using the IDE. Once the code is uploaded, open the IDE Serial Monitor in order to ascertain the <em>IP address</em>—a unique string of numbers to identify a device attached to the internet—of the Arduino, which is acting as our server. You should see something similar to <a href="ch23.xhtml#ch23fig5">Figure 23-5</a>.</p>&#13;
<p class="figcap"><a id="ch23fig5"/><strong>FIGURE 23-5:</strong> The IP address of the Arduino shield will be shown in the Serial Monitor.</p>&#13;
<div class="image"><img alt="Image" src="../images/f23-05.jpg"/></div></li>&#13;
<li><p class="noindents">Open any web browser and enter your IP address. You should see a web page with an On and an Off button, as shown earlier in <a href="ch23.xhtml#ch23fig3">Figure 23-3</a>. Press the On button to light the LED and press the Off button to switch it off.</p></li>&#13;
<li><p class="noindents">This project will also work when you are not connected to your local network, as long as you have port 80 open on your internet router. Many internet service providers (ISPs) have this port blocked for security reasons, so follow the instructions from your ISP to change this if required.</p>&#13;
<div class="noter">&#13;
<p class="notet"><strong>WARNING</strong></p>&#13;
<p class="notep"><em>Carry out this function only if you are aware of the security risks and how to minimize them.</em></p>&#13;
</div></li>&#13;
<li><p class="noindents">Confirm that your setup matches the circuit diagram in <a href="ch23.xhtml#ch23fig6">Figure 23-6</a>, and then upload the code in “<a href="ch23.xhtml#ch00lev1sec98">The Sketch</a>” on <a href="ch23.xhtml#page_208">page 208</a>.</p>&#13;
<p class="figcap"><span epub:type="pagebreak" id="page_208"/><a id="ch23fig6"/><strong>FIGURE 23-6:</strong> The circuit diagram for the internet-controlled LED</p>&#13;
<div class="image"><img alt="Image" src="../images/f23-06.jpg"/></div></li>&#13;
</ol>&#13;
<h3 class="h3" id="ch00lev1sec98"><span class="red"><strong>THE SKETCH</strong></span></h3>&#13;
<p class="noindent">The sketch calls on the SPI and Ethernet libraries to control communication with the internet. We define the MAC address for the shield. This is the line you need to change if your shield came with its own MAC address; if not, the address given earlier in this project and shown in the code should work for you. We then set the server to use port 80 and define pin 7 on the Arduino as the LED pin.</p>&#13;
<p class="indent">The setup defines the LED pin as an output, begins the Ethernet shield, and starts serial communication so we can see the IP address of our server. The loop sets up our web page to the browser once it is called and waits for an input on the browser task bar. When the On button is pressed, the server tells the Arduino to set the LED pin as <span class="literal">HIGH</span> and the LED will light. When the Off button is pressed, the power to the LED is <span class="literal">LOW</span> and the LED will turn off.</p>&#13;
<p class="indent">You could easily change the LED for a relay switch such as the one used in Project 12 to control a larger-voltage device.</p>&#13;
<p class="programs1"><span epub:type="pagebreak" id="page_209"/>#include &lt;<span class="orange">SPI</span>.h&gt;<br/>#include &lt;<span class="orange">Ethernet</span>.h&gt;<br/><br/><span class="ash">// MAC address for shield</span><br/><span class="green1">byte</span> mac[] = {0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0xED};<br/><span class="orange">EthernetServer</span> server(80);  <span class="ash">// Using port 80</span><br/><span class="green1">int</span> led = 7;  <span class="ash">// LED attached to pin 7</span><br/><br/><span class="green1">void</span> <span class="green2">setup()</span> {<br/>  <span class="orange">pinMode</span>(led, <span class="green1">OUTPUT</span>); <span class="ash">// LED set as an output</span><br/>  <span class="orange">Ethernet.begin</span>(mac);  <span class="ash">// Start the Ethernet shield</span><br/>  server.<span class="orange">begin</span>();<br/>  <span class="orange">Serial.begin</span>(9600);  <span class="ash">// Start serial communication</span><br/>  <span class="orange">Serial.println</span>(<span class="green1">"Server address:"</span>);  <span class="ash">// Print server address</span><br/>                                      <span class="ash">// (Arduino shield)</span><br/>  <span class="orange">Serial.println</span>(<span class="orange">Ethernet</span>.<span class="orange">localIP</span>());<br/>}<br/><br/><span class="green1">void</span> <span class="green2">loop</span>() {<br/>  <span class="orange">EthernetClient</span> client = server.<span class="orange">available</span>();<br/>  <span class="green2">if</span> (client) {<br/>    <span class="green1">boolean</span> currentLineIsBlank = true;<br/>    <span class="green1">String</span> <span class="orange">buffer</span> = <span class="green1">""</span>;<br/>    <span class="green2">while</span> (client.<span class="orange">connected</span>()) {<br/>      <span class="green2">if</span> (client.<span class="orange">available</span>()) {<br/>        <span class="green1">char</span> c = client.<span class="orange">read</span>(); <span class="ash">// Read from the Ethernet shield</span><br/>        <span class="orange">buffer</span> += c; <span class="ash">// Add character to string buffer</span><br/>        <span class="ash">// Client sent request, now waiting for response</span><br/>        <span class="green2">if</span> (c == <span class="green1">'\n'</span> &amp;&amp; currentLineIsBlank) {<br/>          client.<span class="orange">println</span>(<span class="green1">"HTTP/1.1 200 OK"</span>); <span class="ash">// HTTP response</span><br/>          client.<span class="orange">println</span>(<span class="green1">"Content-Type: text/html"</span>);<br/>          client.<span class="orange">println</span>(); <span class="ash">// HTML code</span><br/>          client.<span class="orange">print</span>(<span class="green1">"&lt;center&gt;&lt;br&gt;&lt;h1&gt;Internet Controlled LED&lt;/h1&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;FORM&gt;"</span>);<br/>          client.<span class="orange">print</span>(<span class="green1">"&lt;P&gt; &lt;INPUT type=\"submit\" name=\"status\"value=\"ON\"&gt;"</span>);<br/>          client.<span class="orange">print</span>(<span class="green1">"&lt;P&gt; &lt;INPUT type=\"submit\" name=\"status\"value=\"OFF\"&gt;");</span><br/>          client.<span class="orange">print</span>(<span class="green1">"&lt;/FORM&gt;&lt;/center&gt;");</span><br/>          <span class="green2">break</span>;<br/>        }<br/>        <span class="green2">if</span> (c == <span class="green1">'\n'</span>) {<br/>          currentLineIsBlank = true<span class="green1">;</span><br/>          <span class="orange">buffer</span> = <span class="green1">""</span>;<br/>        }<br/>        <span class="green2">else if</span> (c == <span class="green1">'\r')</span> { <span class="ash">// Command from webpage</span><br/>          <span class="ash">// Did the on button get pressed</span><br/>          <span class="green2">if</span> (<span class="orange">buffer.indexOf</span>(<span class="green1">"GET /?status=ON"</span>) &gt;= 0)<br/>            <span class="orange">digitalWrite</span>(led, <span class="green1">HIGH</span>);<br/>          <span class="ash">// Did the off button get pressed</span><br/>          <span class="green2">if</span> (<span class="orange">buffer.indexOf</span>(<span class="green1">"GET /?status=OFF</span>") &gt;= 0)<br/>            <span class="orange">digitalWrite</span>(led, <span class="green1">LOW</span>);<br/>        }<br/>        <span class="green2">else</span> {<br/>          currentLineIsBlank = false;<br/>        }<br/><span epub:type="pagebreak" id="page_210"/><br/>      }<br/>    }<br/>    client.<span class="orange">stop()</span>; <span class="ash">// End server</span><br/>  }<br/>}</p>&#13;
<h3 class="h3" id="ch00lev1sec99"><span class="red"><strong>TROUBLESHOOTING</strong></span></h3>&#13;
<p class="ques"><strong>Q.</strong> <em>The code compiles, but the LED does not light as expected.</em></p>&#13;
<p class="bull">• First, make sure you’ve connected the GND wire from the Arduino to the correct breadboard power rail and that the Arduino has power connected.</p>&#13;
<p class="bull">• Check that the resistor is inserted fully and lines up with the corresponding LED leg.</p>&#13;
<p class="bull">• Try checking that the project is working by connecting to your local area network and using that PC to connect to the Arduino.</p>&#13;
<p class="ques"><strong>Q.</strong> <em>You receive an error when calling the web page.</em></p>&#13;
<p class="bull">• Make sure you have entered the IP address of the server exactly as you read it in the steps given earlier.</p>&#13;
<p class="bull">• It is best to check the project is working by connecting to your local area network and using that PC to connect to the Arduino.</p>&#13;
<p class="bull">• If the project worked when you connected it to your local area network, but you receive an HTTP 403 error when connecting to the internet externally, then your ISP is blocking incoming traffic. You could add <em>port forwarding</em> to your router for port 80. This will differ for every device, so check with your ISP for detailed instructions. Do a quick internet search with your ISP and “port forwarding” as terms and follow the instructions, but be aware: this can compromise the security of your PC and should be done only if you understand the risks and are able to protect your network.</p>&#13;


<h2 class="h2s" id="ch24"><span epub:type="pagebreak" id="page_211"/><strong>24<br/>Voice-Controlled LED</strong></h2>&#13;
<p class="intro"><span class="red">In this project we’ll use a bluetooth module, a smartphone, and a voice recognition app to control an LED with vocal commands.</span></p>&#13;
<div class="image"><img alt="Image" src="../images/p0211-01.jpg"/></div>&#13;
<div class="image"><span epub:type="pagebreak" id="page_212"/><img alt="Image" src="../images/p0212-01.jpg"/></div>&#13;
<p class="capb"><strong>PARTS REQUIRED</strong></p>&#13;
<p class="cap1"><strong>Arduino board</strong></p>&#13;
<p class="cap1"><strong>Breadboard</strong></p>&#13;
<p class="cap1"><strong>Jumper wires</strong></p>&#13;
<p class="cap1"><strong>HC-06 Bluetooth module</strong></p>&#13;
<p class="cap1"><strong>LED</strong></p>&#13;
<p class="cap1"><strong>220-ohm resistor</strong></p>&#13;
<p class="cap1"><strong>Android smartphone</strong></p>&#13;
<h3 class="h3" id="ch00lev1sec100"><span epub:type="pagebreak" id="page_213"/><span class="red"><strong>HOW IT WORKS</strong></span></h3>&#13;
<p class="noindent">Bluetooth wireless technology uses radio waves to transmit and exchange data over short distances. Smartphones, laptops, and multimedia devices such as speakers use Bluetooth as a common standard. We’ll use the inexpensive HC-06 Bluetooth module (<a href="ch24.xhtml#ch24fig1">Figure 24-1</a>) to pair (connect) our Arduino to a smartphone so we can turn an LED on and off remotely using a voice recognition app. This module has six pins, but we’ll just use the middle four. The pins should be labeled on the front.</p>&#13;
<p class="figcap"><a id="ch24fig1"/><strong>FIGURE 24-1:</strong> The HC-06 Bluetooth module</p>&#13;
<div class="image"><img alt="Image" src="../images/f24-01.jpg"/></div>&#13;
<p class="indent">The app we’ll use is Arduino Bluetooth Control from BroxCode, available to download for free on the Google Play store for Android devices. There are many other similar free apps available for both Android and Apple devices and the principles of use should be the same for each, but the BroxCode app has some additional features that we’re using in this project, such as voice recognition through Google Assistant.</p>&#13;
<h3 class="h3" id="ch00lev1sec101"><span class="red"><strong>THE BUILD</strong></span></h3>&#13;
<p class="noindent">Before you build the Bluetooth controller, you need to upload the code to the Arduino. This is because the serial communication from your PC to the Arduino uses the same pins that we’ll be connecting to the Bluetooth module.</p>&#13;
<ol>&#13;
<li><p class="noindents">Upload the code in “<a href="ch24.xhtml#ch00lev1sec103">The Sketch</a>” on <a href="ch24.xhtml#page_220">page 220</a>, and then insert the Bluetooth module into the breadboard and connect VCC to the positive power rail of the breadboard, GND to the GND <span epub:type="pagebreak" id="page_214"/>power rail, TXD to Arduino pin 0 (RX), and RXD to Arduino pin 1 (TX), as shown in the following table.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thre" style="vertical-align: top;"><p class="tablec"><strong>HC-06 BLUETOOTH MODULE</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">VCC</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="red">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">GND</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="red">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">TXD</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="red">Pin 0 (RX)</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">RXD</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="red">Pin 1 (TX)</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindents">Insert the LED into the breadboard with the legs straddling the center break. Use a 220-ohm resistor to connect the shorter, negative leg of the LED to the GND rail of the breadboard. Connect the longer, positive leg of the LED to pin 9 of the Arduino using a jumper wire, as outlined in the following table.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><strong>LED</strong></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">Positive leg</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="red">Pin 9</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">Negative leg</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="red">GND</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindents">Connect the GND rail of the breadboard to Arduino GND and the positive rail to Arduino +5V.</p></li>&#13;
<li><p class="noindents">Check that your build matches the diagram in <a href="ch24.xhtml#ch24fig2">Figure 24-2</a>.</p>&#13;
<p class="figcap"><a id="ch24fig2"/><strong>FIGURE 24-2:</strong> The circuit diagram for the Bluetooth voice-controlled LED</p>&#13;
<div class="image"><img alt="Image" src="../images/f24-02.jpg"/></div></li>&#13;
</ol>&#13;
<h3 class="h3" id="ch00lev1sec102"><span epub:type="pagebreak" id="page_215"/><span class="red"><strong>ARDUINO BLUETOOTH CONTROL</strong></span></h3>&#13;
<p class="noindent">The Arduino Bluetooth Control app offers six control options, all of which send data to the Arduino via different methods (<a href="ch24.xhtml#ch24fig3">Figure 24-3</a>). You can customize each to your own preferences.</p>&#13;
<p class="figcap"><a id="ch24fig3"/><strong>FIGURE 24-3:</strong> The menu screen on the Arduino Bluetooth Control app</p>&#13;
<div class="image"><img alt="Image" src="../images/f24-03.jpg"/></div>&#13;
<p class="bulla">• <strong>Arrow Keys:</strong> Here you’ll find customizable arrow buttons.</p>&#13;
<p class="bulla">• <strong>Terminal:</strong> This is a classic terminal for sending and receiving data, displayed with a timestamp corresponding to each action.</p>&#13;
<p class="bulla">• <strong>Accelerometer:</strong> This tool reads movement using the gesture sensor of your phone.</p>&#13;
<p class="bulla">• <strong>Buttons and Slider:</strong> Here you’ll find six fully customizable buttons and a slider view that shows up when you rotate your device. You can set the range of the data for this slider.</p>&#13;
<p class="bulla">• <strong>Metrics:</strong> This tool is optimized to receive data via the <span class="literal">println()</span> function of the Arduino, which allows your paired phone to receive notifications by SMS from another phone. You only need to specify the number in the Settings section. This function is explained further shortly.</p>&#13;
<p class="bulla">• <strong>Voice Control:</strong> This great tool uses the Google voice command on your Android device to let you customize your own vocal commands and use them to control the Arduino.</p>&#13;
<p class="indentt"><span epub:type="pagebreak" id="page_216"/>Now you need to download the Arduino Bluetooth Control app from the Google Play app store and set it up.</p>&#13;
<ol>&#13;
<li><p class="noindents">Go to <em><a href="https://play.google.com/store/">https://play.google.com/store/</a></em> and search for “<a href="ch24.xhtml#ch00lev1sec102">Arduino Bluetooth Control</a>.” You’ll probably get several apps in your results, but the one you want is precisely named “<a href="ch24.xhtml#ch00lev1sec102">Arduino Bluetooth Control</a>,” as shown in <a href="ch24.xhtml#ch24fig4">Figure 24-4</a>. Click <strong>Install</strong> to download it to your device. The app is free but does include some ads.</p>&#13;
<p class="figcap"><a id="ch24fig4"/><strong>FIGURE 24-4:</strong> Arduino Bluetooth Control from BroxCode on Google Play</p>&#13;
<div class="image"><img alt="Image" src="../images/f24-04.jpg"/></div></li>&#13;
<li><p class="noindents">Once you’ve downloaded the app, power your Arduino to start the Bluetooth module. Go to your Bluetooth settings on your smartphone, turn on Bluetooth, and select <strong>MORE SETTINGS</strong> to view visible devices. You should see the HC-06 module as an available device. Select it to pair with your phone. You’ll be asked for a password to connect: the default for the module is 1234 or in some instances 0000, so try both if the first doesn’t work.</p></li>&#13;
<li><p class="noindents">When your device is paired, open the Arduino Bluetooth Control app. From the window that appears showing all available devices, select the HC-06 module, as shown in <a href="ch24.xhtml#ch24fig5">Figure 24-5</a>. You won’t need to choose the device every time you power up—the app will remember it.</p>&#13;
<p class="figcap"><span epub:type="pagebreak" id="page_217"/><a id="ch24fig5"/><strong>FIGURE 24-5:</strong> Pairing your device</p>&#13;
<div class="image"><img alt="Image" src="../images/f24-05.jpg"/></div></li>&#13;
<li><p class="noindents">You’re going to use the Voice Control function to turn the LED off and on when you speak certain commands into the smartphone. Select the Voice Control function, and you’ll be taken to the Settings menu, shown in <a href="ch24.xhtml#ch24fig6">Figure 24-6</a>. Choose <strong>Vocal commands configuration</strong>. We’ll use this to define our input and output functions.</p>&#13;
<p class="figcap"><a id="ch24fig6"/><strong>FIGURE 24-6:</strong> Selecting the Vocal commands configuration setting</p>&#13;
<div class="image"><img alt="Image" src="../images/f24-06.jpg"/></div></li>&#13;
<li><p class="noindents"><span epub:type="pagebreak" id="page_218"/>Select <strong>Vocal command n°1</strong>, as shown in <a href="ch24.xhtml#ch24fig7">Figure 24-7</a>.</p>&#13;
<p class="figcap"><a id="ch24fig7"/><strong>FIGURE 24-7:</strong> Setting your first voice command</p>&#13;
<div class="image"><img alt="Image" src="../images/f24-07.jpg"/></div></li>&#13;
<li><p class="noindents">Here you give the input that will trigger the first function. Enter <span class="literal"><span class="codestrong">light on</span></span> as text, as shown in the screen on the left in <a href="ch24.xhtml#ch24fig8">Figure 24-8</a>. The app will then ask for the output data to send to the Arduino when you give the input command. On this screen, enter <span class="literal"><span class="codestrong">1</span></span> for on or <span class="literal"><span class="codestrong">HIGH</span></span>, as we’ve seen in previous LED projects (shown in the screen on the right in <a href="ch24.xhtml#ch24fig8">Figure 24-8</a>). When the app hears the vocal command “light on” through the phone, the number <span class="literal">1</span> will be sent to the Arduino as an input, and power will be sent to the LED to light it up.</p></li>&#13;
<li><p class="noindents">Carry out the same steps to define Vocal command n°2 with the input <span class="literal">light off</span> and the output data <span class="literal">0</span>, as shown in <a href="ch24.xhtml#ch24fig9">Figure 24-9</a>. This command will switch the LED off.</p></li>&#13;
</ol>&#13;
<p class="indent">Now you’ve configured your commands so that when you press the voice command function and tap the microphone button on the screen, the app will listen for your command and, depending on the input, switch the LED on or off.</p>&#13;
<p class="figcap"><span epub:type="pagebreak" id="page_219"/><a id="ch24fig8"/><strong>FIGURE 24-8:</strong> Configuring our LED to turn on with the voice command “light on”</p>&#13;
<div class="image"><img alt="Image" src="../images/f24-08.jpg"/></div>&#13;
<p class="figcap"><a id="ch24fig9"/><strong>FIGURE 24-9:</strong> Configuring the “light off” function</p>&#13;
<div class="image"><img alt="Image" src="../images/f24-09.jpg"/></div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_220"/>The app also has a function to let you control the Arduino using SMS. Once the app is launched and connected to the Arduino, you can send data to the Arduino by sending an SMS text to the phone paired with the Bluetooth module, as long as the paired phone is in range of the module. Simply text <span class="literal"><span class="codestrong">Arduino 1</span></span> to the phone connected to the Arduino, and that phone will send <span class="literal">1</span> to the module to light your LED. Text <span class="literal"><span class="codestrong">Arduino 0</span></span>, and a <span class="literal">0</span> will be sent to switch your LED off. This way you can have control through Bluetooth from anywhere in the world!</p>&#13;
<h3 class="h3" id="ch00lev1sec103"><span class="red"><strong>THE SKETCH</strong></span></h3>&#13;
<p class="noindent">The sketch for this project is quite simple. It starts by creating a variable to hold the data from the Bluetooth module. It sets the data rate for serial communication to <span class="literal">9600</span> and sets pin 9 as an output for our LED. In the loop, it checks for data to be sent to the Arduino from the Bluetooth module. The loop reads the data, and also sends it to the Serial Monitor so we can check that it’s working correctly. If the Arduino receives a <span class="literal">1</span> from the app, pin 9 will be set to <span class="literal">HIGH</span>, which will turn on the LED. If the Arduino receives a <span class="literal">0</span>, pin 9 is set as <span class="literal">LOW</span> and the LED is turned off.</p>&#13;
<p class="indent">Using these principles, you could add numerous relays in place of the LED and begin to automate your home from anywhere. You could set it up to turn on your living room lights before you enter your house, set the thermostat when you’re on your way home, or have your favorite music already playing as you walk in the door.</p>&#13;
<p class="programs1"><span class="green1">char</span> data = 0; <span class="ash">// Create a variable for data</span><br/><span class="green1">void</span> <span class="green2">setup</span>() {<br/>  <span class="orange">Serial</span>.<span class="orange">begin</span>(9600); <span class="ash">// Data rate for serial communication</span><br/>  <span class="orange">pinMode</span>(9, <span class="green1">OUTPUT</span>); <span class="ash">// Set pin 9 as an output</span><br/>}<br/><span class="green1">void</span> <span class="green2">loop</span>() {<br/>  <span class="green2">if</span> <span class="orange">(Serial</span>.<span class="orange">available</span>() &gt; 0) { <span class="ash">// Send data</span><br/>    data = <span class="orange">Serial</span>.<span class="orange">read</span>(); <span class="ash">// Read incoming data and</span><br/>                          <span class="ash">// store it into variable data</span><br/>    <span class="orange">Serial</span>.<span class="orange">print</span>(data); <span class="ash">// Print data value to the Serial Monitor</span><br/>    <span class="orange">Serial</span>.<span class="orange">print</span>(<span class="green1">"\n"</span>); <span class="ash">// Start a new line</span><br/>    <span class="green2">if</span> (data == <span class="green1">'1'</span>) <span class="ash">// If value is 1, turn on LED</span><br/>      <span class="orange">digitalWrite</span>(9, <span class="green1">HIGH</span>);<br/>    <span class="green2">else if</span> (data == <span class="green1">'0'</span>) <span class="ash">// If value is 0, turn off LED</span><br/>      <span class="orange">digitalWrite</span>(9, <span class="green1">LOW</span>);<br/>  }<br/>}</p>&#13;
<h3 class="h3" id="ch00lev1sec104"><span epub:type="pagebreak" id="page_221"/><span class="red"><strong>TROUBLESHOOTING</strong></span></h3>&#13;
<p class="ques"><strong>Q.</strong> <em>The code compiles, but the LED does not light.</em></p>&#13;
<p class="bull">• Make sure you’ve connected the GND and power pins from the Arduino to the correct breadboard power rails and that the Arduino has power connected.</p>&#13;
<p class="bull">• Check that the LED is inserted the correct way, with the longer leg connected to the positive power and the shorter leg to GND. Check that the resistors are inserted fully and line up with the corresponding LED leg.</p>&#13;
<p class="bull">• With the project powered and connected to your PC, open the Arduino IDE Serial Monitor to see if the Arduino is receiving data from the app. If you don’t see data streaming in the Serial Monitor, double-check that the TXD of the module is connected to RX of the Arduino and the RXD of the module to Arduino TX.</p>&#13;
<p class="bull">• If the app does not work when opened on your smartphone, check the compatibility of your phone with the app on the developer’s site. You may need to use an alternative app.</p>&#13;
<p class="bull">• The data set in your app must match the data expected in the sketch, so make sure you’ve used <span class="literal">1</span> for on and <span class="literal">0</span> for off.</p>&#13;


<h2 class="h2s" id="ch25"><span epub:type="pagebreak" id="page_222"/><strong>25<br/>GPS Speedometer</strong></h2>&#13;
<p class="intro"><span class="red">In this project we’ll connect an OLED screen and GPS module to our Arduino to create a simple GPS speedometer that can track your speed from satellites.</span></p>&#13;
<div class="image"><img alt="Image" src="../images/p0222-01.jpg"/></div>&#13;
<div class="image"><span epub:type="pagebreak" id="page_223"/><img alt="Image" src="../images/p0223-01.jpg"/></div>&#13;
<p class="capb"><strong>PARTS REQUIRED</strong></p>&#13;
<p class="cap1"><strong>Arduino board</strong></p>&#13;
<p class="cap1"><strong>Female-to-male jumper wires</strong></p>&#13;
<p class="cap1"><strong>OLED monochrome screen (128×64)</strong></p>&#13;
<p class="cap1"><strong>Ublox NEO-6M GPS module aircraft flight controller and antenna</strong></p>&#13;
<p class="capb"><strong>LIBRARY REQUIRED</strong></p>&#13;
<p class="cap1"><strong>U8glib</strong></p>&#13;
<h3 class="h3" id="ch00lev1sec105"><span epub:type="pagebreak" id="page_224"/><span class="red"><strong>HOW IT WORKS</strong></span></h3>&#13;
<p class="noindent">The Ublox NEO-6M GPS module (<a href="ch25.xhtml#ch25fig1">Figure 25-1</a>) we’re using in this project is an inexpensive device generally used to track the position of model aircraft or drones. The module is widely available from the suppliers listed in the “<a href="app02.xhtml#ch00lev1sec170">Retailer List</a>” on <a href="app02.xhtml#page_249">page 249</a>, or you can search online for “Ublox NEO-6M GPS module.” Make sure to buy a module that also comes with a GPS antenna, as shown in <a href="ch25.xhtml#ch25fig2">Figure 25-2</a>.</p>&#13;
<p class="figcap"><a id="ch25fig1"/><strong>FIGURE 25-1:</strong> The Ublox NEO-6M GPS module</p>&#13;
<div class="image"><img alt="Image" src="../images/f25-01.jpg"/></div>&#13;
<p class="figcap"><a id="ch25fig2"/><strong>FIGURE 25-2:</strong> The GPS antenna</p>&#13;
<div class="image"><img alt="Image" src="../images/f25-02.jpg"/></div>&#13;
<p class="indent">The module uses <em>GPS (Global Positioning System)</em> technology to determine the exact location of the Arduino and display its speed in kilometers per hour on the OLED screen (see Project 19 for more on OLED screens). GPS consists of 32 satellites orbiting the earth, and it’s used across the globe in everyday technology such as car satellite navigation systems, smartphones, and trackers.</p>&#13;
<p class="indent">The Navstar Global Positioning System was created in the 1970s by the United States government initially for military purposes, but it’s now freely accessible for anyone with GPS receiver equipment, which probably includes you if you have a smartphone. To pinpoint the location of a receiver, the system uses the satellites, control stations on the ground, and your equipment to calculate distance, speed, and time for signals to be sent and received—with these, it can determine your location.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_225"/>The Ublox NEO-6M GPS module receives satellite signals continuously and sends them to the Arduino to pinpoint your location. As soon as you move, your speed is sent to the OLED screen in kilometers per hour, serving as our speedometer.</p>&#13;
<p class="indent">While the functionality of this project is quite complex, the build is very simple. The board comes with the header pins separate, so you need to solder these in place before beginning. See the “<a href="pref02.xhtml#ch00lev1sec123">Quick Soldering Guide</a>” on <a href="pref02.xhtml#page_12">page 12</a> if you need soldering guidance. The board has all the GPS circuitry built in, but you’ll need to clip the GPS antenna in place; I’ll show you how in a moment.</p>&#13;
<h3 class="h3" id="ch00lev1sec106"><span class="red"><strong>THE BUILD</strong></span></h3>&#13;
<ol>&#13;
<li><p class="noindents">Take the OLED monochrome screen shown in <a href="ch25.xhtml#ch25fig3">Figure 25-3</a> and, using female-to-male jumper wires, make the connections in the following table. The OLED screen uses 3.3V, so make sure you connect it to Arduino 3.3V, not 5V, or you could damage the screen.</p>&#13;
<p class="figcap"><a id="ch25fig3"/><strong>FIGURE 25-3:</strong> The OLED monochrome screen displays the speed of movement in kilometers per hour (digit on the right).</p>&#13;
<div class="image"><img alt="Image" src="../images/f25-03.jpg"/></div>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thre" style="vertical-align: top;"><span epub:type="pagebreak" id="page_226"/><p class="tablec"><strong>OLED SCREEN</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">VCC</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="red">+3.3V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">GND</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="red">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">SCL</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="red">Pin A5</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">SDA</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="red">Pin A4</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindents">The GPS module uses the RX and TX pins of the Arduino for communication, but you also need these pins when uploading a sketch from your PC. Upload the code in “<a href="ch25.xhtml#ch00lev1sec107">The Sketch</a>” on <a href="ch25.xhtml#page_227">page 227</a> now so those pins will be free. Connect the Arduino to your PC. Remember to first download the U8glib library and add it to the relevant folder in the Arduino IDE.</p></li>&#13;
<li><p class="noindents">With the sketch uploaded, disconnect the Arduino from your PC and attach the GPS VCC to Arduino +5V, GND to GND, GPS TX to Arduino pin 0 (RX), and GPS RX to Arduino pin 1 (TX), as indicated in the following table.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thre" style="vertical-align: top;"><p class="tablec"><strong>GPS MODULE</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">VCC</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="red">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">GND</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="red">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">TX</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="red">Pin 0 (RX)</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1r" style="vertical-align: top;"><p class="tablec"><span class="red">RX</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="red">Pin 1 (TX)</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindents">Clip the end of the antenna onto the module, as shown in <a href="ch25.xhtml#ch25fig4">Figure 25-4</a>.</p>&#13;
<p class="figcap"><a id="ch25fig4"/><strong>FIGURE 25-4:</strong> Clip the end of the antenna to the socket on the GPS module.</p>&#13;
<div class="image"><img alt="Image" src="../images/f25-04.jpg"/></div></li>&#13;
<li><p class="noindents"><span epub:type="pagebreak" id="page_227"/>Confirm your setup matches the circuit diagram in <a href="ch25.xhtml#ch25fig5">Figure 25-5</a>.</p>&#13;
<p class="figcap"><a id="ch25fig5"/><strong>FIGURE 25-5:</strong> The circuit diagram for the GPS speedometer</p>&#13;
<div class="image"><img alt="Image" src="../images/f25-05.jpg"/></div></li>&#13;
<li><p class="noindents">Connect power to your Arduino, and the GPS speedometer is ready to use. The antenna needs to be facing upward to work, as shown in <a href="ch25.xhtml#ch25fig4">Figure 25-4</a>, and works best outdoors because the GPS module requires line of sight with the orbiting satellites in order to function properly (though I’ve also had success when close to a window indoors, so experiment to see what works for you).</p></li>&#13;
<li><p class="noindents">The GPS module will take about 30 seconds or so to connect to the satellites. When the connection is successful, the module LED will blink and the symbol at the top left of the OLED screen will spin.</p></li>&#13;
</ol>&#13;
<h3 class="h3" id="ch00lev1sec107"><span class="red"><strong>THE SKETCH</strong></span></h3>&#13;
<p class="noindent">The sketch first calls on the U8glib library and then defines the OLED so we can control our screen. We define the GPS module as a serial connection, and tell it what information we want to receive from the satellites.</p>&#13;
<div class="noter">&#13;
<p class="notet"><strong>NOTE</strong></p>&#13;
<p class="notep"><em>Remember to disconnect the Arduino 0 (RX) pin of your build before uploading the sketch and then reconnect when running.</em></p>&#13;
</div>&#13;
<p class="indent">The next section of code contains a long list of data. This section is quite complex, and the data sheet for the Ublox NEO-6M details all the information that can be received by the module if you’re interested. For the purposes of our project, the code at <span class="ent">➊</span> contains the relevant data: the NAV-PVT data that includes the number of satellites the module is connecting to and the ground speed at which your GPS speedometer is moving. The remaining information requests are not used and are set as <span class="literal">off</span>.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_228"/>The section that follows defines the NAV-PVT settings with a number of calculations to check that the data being received from the satellites is valid.</p>&#13;
<p class="indent">The loop at the end of the sketch checks to see if data is being received, and if so, animates the symbols at the top left of the OLED. The first symbol shows that the screen is refreshing correctly, and the second shows that the GPS data packet is being received from the satellites. The screen also displays the number of satellites it’s connected to at the top left.</p>&#13;
<p class="indent">If all the data is being received as expected, the ground speed will be shown at the top right of the screen in kilometers per hour.</p>&#13;
<p class="programs12"><span class="ash">// Sketch reproduced with kind permission from Chris Campbell</span><br/><span class="ash">/*</span><br/>  <span class="ash">Connections:</span><br/>  <span class="ash">GPS TX -&gt; Arduino 0 // Disconnect Arduino 0 to upload this sketch</span><br/>  <span class="ash">GPS RX -&gt; Arduino 1</span><br/>  <span class="ash">Screen SDA -&gt; Arduino A4</span><br/>  <span class="ash">Screen SCL -&gt; Arduino A5</span><br/><span class="ash">*/</span><br/><br/>#include <span class="green1">"U8glib.h"</span> <span class="ash">// Call U8glib library to control OLED screen</span><br/><br/>U8GLIB_SSD1306_128X64 u8g(U8G_I2C_OPT_DEV_0|U8G_I2C_OPT_NO_ACK|U8G_I2C_OPT_FAST); <span class="ash">// Fast I2C/TWI</span><br/><br/>#define GPS <span class="orange">Serial</span> <span class="ash">// Define the serial connection as the GPS module</span><br/><br/><span class="green1">const unsigned char</span> UBLOX_INIT[] <span class="green1">PROGMEM</span> = {<br/>  <span class="ash">// These lines of code request data from the satellites. Most are disabled and turned off.</span><br/>  <span class="ash">// Disable NMEA</span><br/>  0xB5,0x62,0x06,0x01,0x08,0x00,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x24, <span class="ash">// GxGGA off</span><br/>  0xB5,0x62,0x06,0x01,0x08,0x00,0xF0,0x01,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x2B, <span class="ash">// GxGLL off</span><br/>  0xB5,0x62,0x06,0x01,0x08,0x00,0xF0,0x02,0x00,0x00,0x00,0x00,0x00,0x01,0x02,0x32, <span class="ash">// GxGSA off</span><br/>  0xB5,0x62,0x06,0x01,0x08,0x00,0xF0,0x03,0x00,0x00,0x00,0x00,0x00,0x01,0x03,0x39, <span class="ash">// GxGSV off</span><br/>  0xB5,0x62,0x06,0x01,0x08,0x00,0xF0,0x04,0x00,0x00,0x00,0x00,0x00,0x01,0x04,0x40, <span class="ash">// GxRMC off</span><br/>  0xB5,0x62,0x06,0x01,0x08,0x00,0xF0,0x05,0x00,0x00,0x00,0x00,0x00,0x01,0x05,0x47, <span class="ash">// GxVTG off</span><br/><br/>  <span class="ash">// Disable UBX</span><br/>  0xB5,0x62,0x06,0x01,0x08,0x00,0x01,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x17,0xDC, <span class="ash">// NAV-PVT off</span><br/>  0xB5,0x62,0x06,0x01,0x08,0x00,0x01,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x12,0xB9, <span class="ash">// NAV-POSLLH off</span><br/>  0xB5,0x62,0x06,0x01,0x08,0x00,0x01,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x13,0xC0, <span class="ash">// NAV-STATUS off</span><br/><br/>  <span class="ash">// Enable UBX—this is the key information we require</span><br/><span class="ent">➊</span>   0xB5,0x62,0x06,0x01,0x08,0x00,0x01,0x07,0x00,0x01,0x00,0x00,0x00,0x00,0x18,0xE1, <span class="ash">//NAV-PVT on</span><br/>  <span class="ash">//0xB5,0x62,0x06,0x01,0x08,0x00,0x01,0x02,0x00,0x01,0x00,0x00,0x00,0x00,0x13,0xBE, //NAV-POSLLH on</span><br/>  <span class="ash">//0xB5,0x62,0x06,0x01,0x08,0x00,0x01,0x03,0x00,0x01,0x00,0x00,0x00,0x00,0x14,0xC5, //NAV-STATUS on</span><br/><span epub:type="pagebreak" id="page_229"/><br/>  <span class="ash">// Rate</span><br/>  0xB5,0x62,0x06,0x08,0x06,0x00,0x64,0x00,0x01,0x00,0x01,0x00,0x7A,0x12,    <span class="ash">// (10Hz)</span><br/>  <span class="ash">// 0xB5,0x62,0x06,0x08,0x06,0x00,0xC8,0x00,0x01,0x00,0x01,0x00,0xDE,0x6A, // (5Hz)</span><br/>  <span class="ash">// 0xB5,0x62,0x06,0x08,0x06,0x00,0xE8,0x03,0x01,0x00,0x01,0x00,0x01,0x39  // (1Hz)</span><br/>};<br/><br/><span class="green1">const unsigned char</span> UBX_HEADER[] = { 0xB5, 0x62 };<br/><br/><span class="green2">struct</span> NAV_PVT { <span class="ash">// This sets the GPS navigation data</span><br/>  <span class="green1">unsigned char</span> cls;<br/>  <span class="green1">unsigned char</span> id;<br/>  <span class="green1">unsigned short</span> len;<br/>  <span class="green1">unsigned long</span> iTOW; <span class="ash">// GPS time of week of the navigation epoch (ms)</span><br/><br/>  <span class="green1">unsigned short</span> year;     <span class="ash">// Year (UTC)</span><br/>  <span class="green1">unsigned char</span> month;     <span class="ash">// Month, range 1..12 (UTC)</span><br/>  <span class="green1">unsigned char</span> day;       <span class="ash">// Day of month, range 1..31 (UTC)</span><br/>  <span class="green1">unsigned char</span> hour;      <span class="ash">// Hour of day, range 0..23 (UTC)</span><br/>  <span class="green1">unsigned char</span> minute;    <span class="ash">// Minute of hour, range 0..59 (UTC)</span><br/>  <span class="green1">unsigned char</span> second;    <span class="ash">// Seconds of minute, range 0..60 (UTC)</span><br/>  <span class="green1">char</span> valid;              <span class="ash">// Validity Flags (see graphic below)</span><br/>  <span class="green1">unsigned long</span> tAcc;      <span class="ash">// Time accuracy estimate (UTC) (ns)</span><br/>  <span class="green1">long</span> nano;               <span class="ash">// Fraction of second, range -1e9 .. 1e9 (UTC) (ns)</span><br/>  <span class="green1">unsigned char</span> fixType;   <span class="ash">// GNSSfix Type, range 0..5</span><br/>  <span class="green1">char</span> flags;              <span class="ash">// Fix Status Flags</span><br/>  <span class="green1">unsigned char</span> reserved1; <span class="ash">// Reserved</span><br/>  <span class="green1">unsigned char</span> numSV;     <span class="ash">// Number of satellites used in Nav Solution</span><br/><br/>  <span class="green1">long</span> lon;           <span class="ash">// Longitude (deg)</span><br/>  <span class="green1">long</span> lat;           <span class="ash">// Latitude (deg)</span><br/>  <span class="green1">long</span> height;        <span class="ash">// Height above Ellipsoid (mm)</span><br/>  <span class="green1">long</span> hMSL;          <span class="ash">// Height above mean sea level (mm)</span><br/>  <span class="green1">unsigned long</span> hAcc; <span class="ash">// Horizontal Accuracy Estimate (mm)</span><br/>  <span class="green1">unsigned long</span> vAcc; <span class="ash">// Vertical Accuracy Estimate (mm)</span><br/><br/>  <span class="green1">long</span> velN;                <span class="ash">// NED north velocity (mm/s)</span><br/>  <span class="green1">long</span> velE;                <span class="ash">// NED east velocity (mm/s)</span><br/>  <span class="green1">long</span> velD;                <span class="ash">// NED down velocity (mm/s)</span><br/>  <span class="green1">long</span> gSpeed;              <span class="ash">// Ground Speed (2-D) (mm/s)</span><br/>  <span class="green1">long</span> heading;             <span class="ash">// Heading of motion 2-D (deg)</span><br/>  <span class="green1">unsigned long</span> sAcc;       <span class="ash">// Speed accuracy estimate</span><br/>  <span class="green1">unsigned long</span> headingAcc; <span class="ash">// Heading accuracy estimate</span><br/>  <span class="green1">unsigned short</span> pDOP;      <span class="ash">// Position dilution of precision</span><br/>  <span class="green1">short</span> reserved2;          <span class="ash">// Reserved</span><br/>  <span class="green1">unsigned long</span> reserved3;  <span class="ash">// Reserved</span><br/>};<br/><br/>NAV_PVT pvt;<br/><br/><span class="green1">void</span> calcChecksum(<span class="green1">unsigned char</span>* CK) {<br/>  <span class="orange">memset</span>(CK, 0, 2);<br/><span class="green2"><span epub:type="pagebreak" id="page_230"/>for</span> (<span class="green1">int</span> i = 0; i &lt; (<span class="green1">int</span>)<span class="green2">sizeof</span>(NAV_PVT); i++) {<br/>  CK[0] += ((un<span class="green1">signed char*)</span>(&amp;pvt))[i];<br/>  CK[1] += CK[0];<br/>  }<br/>}<br/><br/><span class="green1">long</span> numGPSMessagesReceived = 0;<br/><br/><span class="green1">bool</span> processGPS() {<br/>  <span class="green1">static int</span> fpos = 0;<br/>  <span class="green1">static unsigned char</span> checksum[2];<br/>  <span class="green1">const int</span> payloadSize = <span class="green1">sizeof</span>(NAV_PVT);<br/><br/>  <span class="green2">while</span> ( GPS.<span class="orange">available</span>() ) {<br/>    <span class="green1">byte</span> c = GPS.<span class="orange">read</span>();<br/>    <span class="green2">if</span> ( fpos &lt; 2 ) {<br/>      <span class="green2">if</span> ( c == UBX_HEADER[fpos] )<br/>        fpos++;<br/>      <span class="green2">else</span><br/>        fpos = 0;<br/>  }<br/>  <span class="green2">else</span> {<br/>    <span class="green2">if</span> ( (fpos-2) &lt; payloadSize )<br/>      ((<span class="green1">unsigned char</span>*)(&amp;pvt))[fpos-2] = c;<br/><br/>    fpos++;<br/><br/>    <span class="green2">if</span> ( fpos == (payloadSize+2) ) {<br/>      calcChecksum(checksum);<br/>    }<br/>    <span class="green2">else if</span> ( fpos == (payloadSize+3) ) {<br/>      <span class="green2">if</span> ( c != checksum[0] )<br/>         fpos = 0;<br/>    }<br/>    <span class="green2">else if</span> ( fpos == (payloadSize+4) ) {<br/>      fpos = 0;<br/>      <span class="green2">if</span> ( c == checksum[1] ) {<br/>        <span class="green2">return</span> true;<br/>      }<br/>    }<br/>    <span class="green2">else if</span> ( fpos &gt; (payloadSize+4) ) {<br/>       fpos = 0;<br/>     }<br/>   }<br/> }<br/> <span class="green2">return</span> false;<br/>}<br/><br/><span class="green1">void</span> <span class="green2">setup</span>() {<br/>  GPS.<span class="orange">begin</span>(9600);<br/><br/>  u8g.setColorIndex(1);<br/><span epub:type="pagebreak" id="page_231"/><br/> <span class="ash">// Send configuration data in UBX protocol</span><br/> <span class="green2">for</span> <span class="green1">(unsigned int</span> i = 0; i &lt; <span class="green1">sizeof</span>(UBLOX_INIT); i++) {<br/>   GPS.wr<span class="orange">ite(</span> pgm_read_byte(UBLOX_INIT+i) );<br/>   <span class="orange">delay</span>(5); <span class="ash">// Simulate a 38400baud pace (or less),<br/>             // or otherwise commands are not accepted by the device</span><br/><br/>  }<br/>}<br/><br/><span class="green1">long</span> gSpeed = 0;<br/><span class="green1">int</span> numSV = 0;<br/><span class="green1">unsigned long</span> lastScreenUpdate = 0;<br/><span class="green1">char</span> speedBuf[16]; <br/><span class="green1">char</span> satsBuf[16];<br/><br/><span class="green1">char</span>* spinner = <span class="green1">"/-\\|"</span>; <span class="ash">// Symbol for the spinner on screen to</span><br/>                         <span class="ash">// show communication</span><br/><span class="green1">byte</span> screenRefreshSpinnerPos = 0;<br/><span class="green1">byte</span> gpsUpdateSpinnerPos = 0;<br/><br/><span class="green1">void</span> <span class="green2">loop</span>() {<br/>  <span class="green2">if</span> (processGPS()) {<br/>    numSV = pvt.numSV;<br/>    gSpeed = pvt.gSpeed;<br/>    gpsUpdateSpinnerPos = (gpsUpdateSpinnerPos + 1) % 4;<br/>  }<br/><br/>  <span class="green1">unsigned long</span> now = <span class="orange">millis</span>();<br/>  <span class="green2">if</span> (now - lastScreenUpdate &gt; 100) {<br/>     updateScreen();<br/>     lastScreenUpdate = now;<br/>     screenRefreshSpinnerPos = (screenRefreshSpinnerPos + 1) % 4;<br/>  }<br/>}<br/><br/><span class="green1">void</span> draw() {<br/>  u8g.setFont(u8g_font_courB24);<br/>  u8g.drawStr( 36, 45, speedBuf);<br/>  u8g.setFont(u8g_font_fur11);<br/>  u8g.drawStr( 2, 12, satsBuf);<br/>}<br/><br/><span class="green1">void</span> updateScreen() {<br/><br/>  <span class="green1">int</span> kmh = gSpeed * 0.0036;<br/>  <span class="orange">sprintf</span>(speedBuf, <span class="green1">"%3d</span>", kmh);<br/>  <span class="orange">sprintf</span>(satsBuf, <span class="green1">"%c %c %d</span>", spinner[screenRefreshSpinnerPos], spinner[gpsUpdateSpinnerPos], numSV);<br/> <br/>  u8g.firstPage();<br/>  <span class="green2">do</span> {<br/>    draw();<br/>  } <span class="green2">while</span>( u8g.nextPage() );<br/>}</p>&#13;
<h3 class="h3" id="ch00lev1sec108"><span epub:type="pagebreak" id="page_232"/><span class="red"><strong>TROUBLESHOOTING</strong></span></h3>&#13;
<p class="ques"><strong>Q.</strong> <em>The code compiles, but the expected information is not shown onscreen.</em></p>&#13;
<p class="bull">• If nothing shows on the OLED screen, recheck that your wiring matches <a href="ch25.xhtml#ch25fig5">Figure 25-5</a>; it’s quite easy to reverse the TX and RX wires accidentally.</p>&#13;
<p class="bull">• The symbols at the top left of the screen will rotate to show the screen is working correctly and that the GPS module is receiving data. If the far-left symbol spins but not the GPS symbol, you have your TX and RX wires crossed; recheck the wiring for the module.</p>&#13;
<p class="bull">• The GPS module works best outdoors and should have line of sight to the satellites orbiting the earth, so try repositioning the module until you get a reading. It can take 30–60 seconds to get a stable reading.</p>&#13;
<p class="bull">• Remember that the OLED screen should be connected to 3.3V and not 5V.</p>&#13;
</body></html>