<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" epub:prefix="index: http://www.index.com/" xml:lang="en" lang="en">
<head>
<title>A: Building a Windows Domain Network for Testing</title>
<link href="../styles/stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="sbo-rt-content"><section aria-labelledby="appA" epub:type="appendix" role="doc-appendix">
<hgroup>
<h1 class="CHAPTER" id="appA">
<span class="APN"><span aria-label=" Page 535. " epub:type="pagebreak" id="pg_535" role="doc-pagebreak"></span><samp class="SANS_Futura_Std_Bold_Condensed_B_11">A</samp></span>
<span class="APT"><samp class="SANS_Dogma_OT_Bold_B_11">BUILDING A WINDOWS DOMAIN NETWORK FOR TESTING</samp></span>
</h1>
</hgroup>
<figure class="opener"><img alt="" class="opener" height="386" src="../images/chapter.jpg" width="386"/></figure>
<p class="ChapterIntro">Several chapters in this book make reference to a Windows domain network you can use for testing purposes. While you don’t need to set up such a network to follow along with the chapters, you can use it to run the examples, then alter the provided commands to observe different outcomes. If you don’t already have a suitable Windows domain network on hand to use for testing, this appendix will walk you through setting one up with virtual machines.</p>
<p class="TX">Running Windows in a virtual machine has many advantages. First, it gives you complete flexibility to configure (or misconfigure) Windows without compromising the security of your everyday installation. Virtualization platforms typically allow you to snapshot your virtual machines so you can roll them back to a known good state if something goes wrong. You can <span aria-label=" Page 536. " epub:type="pagebreak" id="pg_536" role="doc-pagebreak"></span>also isolate network traffic to prevent it from affecting other systems on the same network. Lastly, you can use a virtual machine to run Windows in a non-Windows environment.</p>
<p class="TX">The domain configuration steps use PowerShell whenever possible. Note that, unless otherwise stated, you must run all of these PowerShell commands as an administrator user.</p>
<section aria-labelledby="sec1" epub:type="division">
<h2 class="H1" id="sec1"><span id="h1-122"></span><samp class="SANS_Futura_Std_Bold_B_11">The Domain Network</samp></h2>
<p class="TNI1"><a href="appendix-A.xhtml#figA-1">Figure A-1</a> is a diagram of the network we’ll build. For more information about the structure of domain networks in general, consult <span class="Xref"><a href="chapter10.xhtml">Chapter 10</a>.</span></p>
<figure class="IMG"><img alt="" class="img1" height="1110" id="figA-1" src="../images/FigureA-1.jpg" width="1381"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure A-1: The domain network configuration</samp></p></figcaption>
</figure>
<p class="TX">The network includes a forest made up of three domains. The root DNS name for the forest is <i>mineral.local</i>, and its two child domains are <i>engineering.mineral.local</i> and <i>sales.mineral.local</i>. To create a minimal functional domain for testing, you need only <i>PRIMARYDC</i>, which is the root domain controller, and <i>GRAPHITE</i>, a workstation joined to the domain. Anything included in dotted lines is optional. The next sections will show you how to set up the domain network and configure virtual machines for each of the Windows systems you want to include.</p>
</section>
<section aria-labelledby="sec2" epub:type="division">
<h2 class="H1" id="sec2"><span id="h1-123"></span><span aria-label=" Page 537. " epub:type="pagebreak" id="pg_537" role="doc-pagebreak"></span><samp class="SANS_Futura_Std_Bold_B_11">Installing and Configuring Windows Hyper-V</samp></h2>
<p class="TNI1">We’ll set up the Windows domain network using Hyper-V, which is virtualization software that comes for free on 64-bit versions of Windows Professional, Enterprise, and Education. If you’re not running Windows or don’t want to use Hyper-V, another good free option is Oracle’s VirtualBox (<i><a href="https://www.virtualbox.org">https://<wbr/>www<wbr/>.virtualbox<wbr/>.org</a></i>).</p>
<p class="TX">To install Hyper-V and its tools, start an administrator PowerShell console and run the following command. Make sure to restart the system after installation:</p>
<pre><code>PS&gt; <b>Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V -All</b>
</code></pre>
<p class="TX">The next step is to configure a new network for the virtual machines, as shown in <a href="appendix-A.xhtml#LisA-1">Listing A-1</a>. This allows you to have complete control over all aspects of the network configuration for the domain network and isolates it from your real network.</p>
<span id="LisA-1"></span><pre><code>PS&gt; <b>New-VMSwitch -Name "Domain Network" -SwitchType Internal</b>
PS&gt; <b>$index = (Get-NetAdapter |</b>
<b>Where-Object Name -Match "Domain Network").ifIndex</b>
PS&gt; <b>New-NetIPAddress -IPAddress 192.168.99.1 -PrefixLength 24</b>
<b>-InterfaceIndex $index</b>
PS&gt; <b>New-NetNat -Name DomNAT -InternalIPInterfaceAddressPrefix 192.168.99.0/24</b>
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing A-1: Creating a new virtual machine network switch</span></p>
<p class="TX">We first create a new switch for the domain network using the <samp class="SANS_TheSansMonoCd_W5Regular_11">New-VMSwitch</samp> command, which you need to do only once during this initial configuration process. We give the switch the name <samp class="SANS_TheSansMonoCd_W7Bold_B_11">"</samp><samp class="SANS_TheSansMonoCd_W5Regular_11">Domain Network</samp><samp class="SANS_TheSansMonoCd_W7Bold_B_11">"</samp> and set its type to <samp class="SANS_TheSansMonoCd_W5Regular_11">Internal</samp>, which means it’s a virtual network that can communicate with the virtual machine host.</p>
<p class="TX">Next, we need to assign the virtual network adapter that was created for the switch with an IP address. The <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-NetAdapter</samp> command lists all network adapters and finds the unique index number for the adapter for our domain network. We then assign the IP address of 192.168.99.1 to the adapter, with a subnet prefix of 24 bits (perhaps more commonly seen as the subnet mask 255.255.255.0). You’re welcome to set the IP address to any value you like, but keep in mind that if you change the address, you’ll also need to update it throughout the rest of this appendix.</p>
<p class="TX">The final step is to set up <i>network address translation (NAT)</i> for the IP address using the <samp class="SANS_TheSansMonoCd_W5Regular_11">New-NetNat</samp> command. This will allow computers on the network to access the internet by setting their default gateway to the adapter’s IP address, in this case 192.168.99.1.</p>
<blockquote>
<p class="NOTE"><span class="NoteHead"><samp class="SANS_Dogma_OT_Bold_B_15">NOTE</samp></span></p>
<p class="NOTE-TXT"><i>This configuration doesn’t set up a Dynamic Host Configuration Protocol (DHCP) server to automatically assign IP addresses to computers on the network. As the network is so small, we’ll just statically assign IP addresses to the computers as we go.</i></p>
</blockquote>
</section>
<section aria-labelledby="sec3" epub:type="division">
<h2 class="H1" id="sec3"><span id="h1-124"></span><span aria-label=" Page 538. " epub:type="pagebreak" id="pg_538" role="doc-pagebreak"></span><samp class="SANS_Futura_Std_Bold_B_11">Creating the Virtual Machines</samp></h2>
<p class="TNI1"><a href="appendix-A.xhtml#tabA-1">Table A-1</a> lists the virtual machines we’ll set up, along with the operating system type and IP address for each. I’ll walk through setting up the <i>PRIMARYDC</i>, <i>GRAPHITE</i>, and optional <i>SALESDC</i> virtual machines. The other virtual machines in the table are completely optional; if you want to create them, you can replace the specified values in the sections on setting up each virtual machine with the appropriate values from the table.</p>
<table class="Basic-Table">
<caption><p class="TT" id="tabA-1"><span class="Heavy"><samp class="SANS_Futura_Std_Heavy_B_11">Table A-1:</samp></span> <samp class="SANS_Futura_Std_Book_11">Virtual Machine Names and IP Addresses</samp></p></caption>
<thead>
<tr>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Virtual machine name</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Operating system</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">IP address</samp></p></th>
</tr>
</thead>
<tbody>
<tr>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_Futura_Std_Book_Oblique_I_11">PRIMARYDC</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Windows Server</samp></p></td>
<td class="Basic-Table TBF"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">192.168.99.10</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_Oblique_I_11">GRAPHITE</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Windows Professional or Enterprise</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">192.168.99.50</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_Oblique_I_11">CINNABAR</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Windows Server</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">192.168.99.20</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_Oblique_I_11">SALESDC</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Windows Server</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">192.168.99.110</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_Oblique_I_11">GOLD</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Windows Professional or Enterprise</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">192.168.99.150</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_Oblique_I_11">ENGDC</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Windows Server</samp></p></td>
<td class="Basic-Table TB"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">192.168.99.210</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_Futura_Std_Book_Oblique_I_11">STEEL</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Windows Professional or Enterprise</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">192.168.99.220</samp></p></td>
</tr>
</tbody>
</table>
<p class="TX">Microsoft provides trial editions of Windows Enterprise and Windows Server as virtual machines. I’d recommend using your favorite search engine to find the latest links on Microsoft’s website. For each machine, install the correct Windows version and then use PowerShell to configure it.</p>
<p class="TX">To use Windows virtual machines with Hyper-V, you’ll need the installation media and license keys for Windows Professional or Enterprise and Windows Server. A common way to get access to these is through a Microsoft Visual Studio subscription. The versions of Windows and Server you use won’t matter for the topics we’ll discuss.</p>
<blockquote>
<p class="NOTE"><span class="NoteHead"><samp class="SANS_Dogma_OT_Bold_B_15">NOTE</samp></span></p>
<p class="NOTE-TXT"><i>Server installations include a long-term service branch that comes with the Windows desktop and a more up-to-date version, called a</i> <span class="note_Italic">server core version</span><i>, that has only a command line. As we’ll configure the server installation with PowerShell, either version will work. However, if you’re more comfortable with a GUI, use the long-term service branch with a desktop instead.</i></p>
</blockquote>
<p class="TX"><a href="appendix-A.xhtml#LisA-2">Listing A-2</a> defines the function we’ll use to do most of the work of setting up a virtual machine, <samp class="SANS_TheSansMonoCd_W5Regular_11">New-TestVM</samp>.</p>
<span id="LisA-2"></span><pre><code>PS&gt; <b>function New-TestVM {</b>
<b>    param(</b>
<b>        [Parameter(Mandatory)]</b>
<b>        [string]$VmName,</b>
<b>        [Parameter(Mandatory)]</b>
<b>        [string]$InstallerImage,</b>
<b>        [Parameter(Mandatory)]</b>
<b>        [string]$VmDirectory</b>
<b>    )</b>
<span aria-label=" Page 539. " epub:type="pagebreak" id="pg_539" role="doc-pagebreak"></span><b>  </b><span aria-label="annotation1" class="CodeAnnotationCode2">❶</span><b> New-VM -Name $VmName -MemoryStartupBytes 2GB -Generation 2</b>
<b>-NewVHDPath "$VmDirectory\$VmName\$VmName.vhdx" -NewVHDSizeBytes 80GB</b>
<b>-Path "$VmDirectory" -SwitchName "Domain Network"</b>
<b>  </b><span aria-label="annotation2" class="CodeAnnotationCode2">❷</span><b> Set-VM -Name $VmName -ProcessorCount 2 -DynamicMemory</b>
<b>  </b><span aria-label="annotation3" class="CodeAnnotationCode2">❸</span><b> Add-VMScsiController -VMName $VmName</b>
<b>    Add-VMDvdDrive -VMName $VmName -ControllerNumber 1 -ControllerLocation 0</b>
<b>-Path $InstallerImage</b>
<b>    $dvd = Get-VMDvdDrive -VMName $VmName</b>
<b>    Set-VMFirmware -VMName $VmName -FirstBootDevice $dvd</b>
<b>}</b>
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing A-2: Defining the New-TestVM function</span></p>
<p class="TX">The <samp class="SANS_TheSansMonoCd_W5Regular_11">New-TestVM</samp> function takes the name of the virtual machine so it can create the path to the DVD image to install and the base directory for the virtual machine’s assets. We start by calling the <samp class="SANS_TheSansMonoCd_W5Regular_11">New-VM</samp> command to create the virtual machine <span aria-label="annotation1" class="CodeAnnotationCode">❶</span>. We set its memory to 4GB and create an 80GB virtual hard disk. (You can increase these sizes if you like.) We also assign the default network adapter to use the <samp class="SANS_TheSansMonoCd_W7Bold_B_11">"</samp><samp class="SANS_TheSansMonoCd_W5Regular_11">Domain Network</samp><samp class="SANS_TheSansMonoCd_W7Bold_B_11">"</samp> switch we created in <a href="appendix-A.xhtml#LisA-1">Listing A-1</a>.</p>
<p class="TX">Next, we use the <samp class="SANS_TheSansMonoCd_W5Regular_11">Set-VM</samp> command to configure some virtual machine options not exposed through <samp class="SANS_TheSansMonoCd_W5Regular_11">New-VM</samp> <span aria-label="annotation2" class="CodeAnnotationCode">❷</span>. We assign two CPUs to the virtual machine, as I find modern versions of Windows struggle with only one CPU. You can increase the number of CPUs if your base machine has many CPU cores.</p>
<p class="TX">We also enable dynamic memory. This allows Windows to scale the virtual machines’ memory usage as needed. I’ve found that typically a server installation uses only around 2GB of memory when running, but it could be more, especially for clients. Dynamic memory can both increase and decrease allocated memory as needed.</p>
<p class="TX">Finally, we set up a DVD drive on a virtual SCSI controller and assign the DVD image to it <span aria-label="annotation3" class="CodeAnnotationCode">❸</span>. We’ll use this as the primary boot drive, so we can install the operating system from the DVD image.</p>
<p class="TX">We now need to create each virtual machine using the function we defined and start the installation process.</p>
<section aria-labelledby="sec4" epub:type="division">
<h3 class="H2" id="sec4"><span id="h2-170"></span><samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">The PRIMARYDC Server</samp></h3>
<p class="TNI1">The <i>PRIMARYDC</i> machine is a Windows server that will act as the root domain controller for our forest. In <a href="appendix-A.xhtml#LisA-3">Listing A-3</a>, we start by creating the virtual machine as an administrator.</p>
<span id="LisA-3"></span><pre><code>PS&gt; <b>New-TestVM -VmName "PRIMARYDC" -InstallerImage "C:\iso\server.iso"</b>
<b>-VmDirectory "C:\vms"</b>
PS&gt; <b>vmconnect localhost PRIMARYDC</b>
PS&gt; <b>Start-VM -VmName "PRIMARYDC"</b>
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing A-3: Creating and starting the</span> <samp class="SANS_Futura_Std_Book_11">PRIMARYDC</samp> <span class="Futura_Std_Book_Oblique_I_11">virtual machine</span></p>
<p class="TX"><span aria-label=" Page 540. " epub:type="pagebreak" id="pg_540" role="doc-pagebreak"></span>We install the <i>PRIMARYDC</i> virtual machine from the DVD image file <i>C:\iso\server.iso</i> and create the virtual machine in the <i>C:\vms</i> directory. This should create a new directory under the virtual machine directory for the <i>PRIMARYDC</i> server’s files, which allows us to separate our resources for each of our virtual machines. Next, we start the virtual machine’s user interface so we can interact with the installation process, and then start the virtual machine.</p>
<p class="TX">Now that you can interact with the virtual machine, you can follow the installation steps as for any other Window Server installation. I won’t provide detailed instructions for this, as it’s mostly a case of selecting your region and the installation drive and following the default process.</p>
<p class="TX">When asked for the <i>Administrator</i> user’s password during the installation, you can set anything you like, but in this book I’ve assumed it will be set to <samp class="SANS_TheSansMonoCd_W5Regular_11">Passw0rd</samp>. As this is a weak password, do not expose these virtual machines to a network where untrusted users can access them. However, for testing and demonstration purposes, having easily memorable passwords is usually a good idea.</p>
<p class="TX">Once you’ve gained access to either a desktop (if using the long-term service branch version of the server) or a command line (if using the server core version), you can finish the basic setup. All subsequent PowerShell commands will be run on the VM itself, not the host. First start an administrator copy of PowerShell to run the commands in <a href="appendix-A.xhtml#LisA-4">Listing A-4</a>.</p>
<span id="LisA-4"></span><pre><code>PS&gt; <b>$index = (Get-NetAdapter).ifIndex</b>
PS&gt; <b>New-NetIPAddress -InterfaceIndex $index -IPAddress 192.168.99.10</b>
<b>-PrefixLength 24 -DefaultGateway 192.168.99.1</b>
PS&gt; <b>Set-DnsClientServerAddress -InterfaceIndex $index -ServerAddresses 8.8.8.8</b>
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing A-4: Setting up the</span> <samp class="SANS_Futura_Std_Book_11">PRIMARYDC</samp> <span class="Futura_Std_Book_Oblique_I_11">virtual machine network</span></p>
<p class="TX">As the network switch we created earlier doesn’t include support for DHCP, it won’t automatically assign an IP address during installation. Thus, we need to set up the network with static IP addresses. <a href="appendix-A.xhtml#LisA-4">Listing A-4</a> starts by setting the IP address of the network adapter; you should use the IP address from <a href="appendix-A.xhtml#tabA-1">Table A-1</a> for the virtual machine you’re configuring. The <samp class="SANS_TheSansMonoCd_W5Regular_11">DefaultGateway</samp> parameter should be the IP address you set on the host in <a href="appendix-A.xhtml#LisA-1">Listing A-1</a> so that traffic can be routed to the external network.</p>
<p class="TX">You’ll also need to specify a DNS server address for the network adapter. In <a href="appendix-A.xhtml#LisA-4">Listing A-4</a> we set this to the address of the public Google DNS server, 8.8.8.8. If you know the IP address of your internet provider or another preferred DNS server, use that instead. Once we’ve finished setting up the domain controller, we’ll no longer need this DNS server, as the domain controller has its own DNS server.</p>
<p class="TX">You should now be able to access an external network. At this point, you might need to activate your copy of Windows Server if you’re not using a trial version. You’ll also want to ensure that the copy of Windows is up to date, including all security patches. While the network will isolate the virtual machines from external networks to a degree, this doesn’t mean they can’t be compromised, so it’s best to be certain.</p>
<p class="TX"><span aria-label=" Page 541. " epub:type="pagebreak" id="pg_541" role="doc-pagebreak"></span>Next, rename the computer using the <samp class="SANS_TheSansMonoCd_W5Regular_11">Rename-Computer</samp> command, as shown in <a href="appendix-A.xhtml#LisA-5">Listing A-5</a>.</p>
<span id="LisA-5"></span><pre><code>PS&gt; <b>Rename-Computer -NewName "PRIMARYDC" -Restart</b>
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing A-5: Renaming the computer</span></p>
<p class="TX">This name will be used on the domain network, so it helps to have memorable names. Replace <i>PRIMARYDC</i> with your own name if you prefer.</p>
<p class="TX">Once you’ve renamed the computer, you need to configure the server as the domain controller for the <i>mineral.local</i> domain. Log in to the server as an administrator and run the commands in <a href="appendix-A.xhtml#LisA-6">Listing A-6</a>.</p>
<span id="LisA-6"></span><pre><code>PS&gt; <b>Install-WindowsFeature AD-Domain-Services</b>
PS&gt; <b>Install-ADDSForest -DomainName mineral.local -DomainNetbiosName MINERAL</b>
<b>-InstallDns -Force</b>
SafeModeAdministratorPassword: <b>********</b>
Confirm SafeModeAdministratorPassword: <b>********</b>
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing A-6: Installing and configuring the Active Directory domain services</span></p>
<p class="TX">First, we install the <samp class="SANS_TheSansMonoCd_W5Regular_11">AD-Domain-Services</samp> feature. This feature installs the Active Directory server and associated services to run the server as a domain controller. Next, we run the <samp class="SANS_TheSansMonoCd_W5Regular_11">Install-ADDSForest</samp> command to set up the forest and create the root domain. We specify the DNS name of the domain, which in this case is <i>mineral.local</i>. We also specify the simple name of the domain as <i>MINERAL</i> and request that a local DNS server be installed. Active Directory can’t work without a DNS server, and as this is an isolated network, it makes sense to run the DNS server on the domain controller server.</p>
<p class="TX">When setting up the forest, you’ll be asked to specify a safe-mode administrator password. This password allows you to recover the Active Directory database. In such a small, non-production domain, you’re unlikely to need this feature, but you should still specify a password you can remember. You’re likely to see a few warnings during the installation; you can safely ignore these. Once the command has completed, the server will reboot automatically.</p>
<p class="TX">When it has finished rebooting you should reauthenticate to the server, but make sure to use the username <i>MINERAL\Administrator</i> so that you can use the domain administrator account. The password for the domain administrator should be the same as the one you initially configured when installing the server. Then, start an instance of PowerShell and run the commands in <a href="appendix-A.xhtml#LisA-7">Listing A-7</a> to do some basic user setup.</p>
<span id="LisA-7"></span><pre><code><span aria-label="annotation1" class="CodeAnnotationHang1">❶</span> PS&gt; <b>Set-ADDefaultDomainPasswordPolicy -Identity mineral.local </b>
<b>-MaxPasswordAge 0</b>
<span aria-label="annotation2" class="CodeAnnotationHang1">❷</span> PS&gt; <b>$pwd = ConvertTo-SecureString -String "Passw0rd1" -AsPlainText -Force</b>
PS&gt; <b>New-ADUser -Name alice -Country USA -AccountPassword $pwd</b>
<b>-GivenName "Alice Bombas" -Enabled $true</b>
PS&gt; <b>$pwd = ConvertTo-SecureString -String "Passw0rd2" -AsPlainText -Force</b>
PS&gt; <b>New-ADUser -Name bob -Country JP -AccountPassword $pwd</b>
<b>-GivenName "Bob Cordite" -Enabled $true</b>

<span aria-label=" Page 542. " epub:type="pagebreak" id="pg_542" role="doc-pagebreak"></span><span aria-label="annotation3" class="CodeAnnotationHang1">❸</span> PS&gt; <b>New-ADGroup -Name 'Local Resource' -GroupScope DomainLocal</b>
PS&gt;<b> Add-ADGroupMember -Identity 'Local Resource' -Members 'alice'</b>
PS&gt;<b> New-ADGroup -Name 'Universal Group' -GroupScope Universal</b>
PS&gt; <b>Add-ADGroupMember -Identity 'Universal Group' -Members 'bob'</b>
PS&gt;<b> New-ADGroup -Name 'Global Group' -GroupScope Global</b>
PS&gt;<b> Add-ADGroupMember -Identity 'Global Group' -Members 'alice','bob'</b>
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing A-7: Configuring the domain password policy and adding users and groups</span></p>
<p class="TX">First, we set the domain’s password policy to prevent passwords from expiring <span aria-label="annotation1" class="CodeAnnotationCode">❶</span>. There’s nothing worse than coming back to your virtual machines after a few months and being faced with changing the passwords, which you immediately forget.</p>
<blockquote>
<p class="NOTE"><span class="NoteHead"><samp class="SANS_Dogma_OT_Bold_B_15">NOTE</samp></span></p>
<p class="NOTE-TXT"><i>Even though the default password expiry for a new domain is 42 days, Microsoft no longer recommends having forced password expiry enabled. This is because making users change their password frequently can cause more harm than good by encouraging them to use trivial passwords, so they don’t forget them.</i></p>
</blockquote>
<p class="TX">We then create two domain users, <i>alice</i> and <i>bob</i>, assigning each of them a password <span aria-label="annotation2" class="CodeAnnotationCode">❷</span>. We also set a few Active Directory attributes for each user: specifically, their name and country. I’ve summarized the values to specify in <a href="appendix-A.xhtml#tabA-2">Table A-2</a>. Of course, you can set the names and values to anything you prefer.</p>
<table class="Basic-Table0">
<caption><p class="TT" id="tabA-2"><span class="Heavy"><samp class="SANS_Futura_Std_Heavy_B_11">Table A-2:</samp></span> <samp class="SANS_Futura_Std_Book_11">Default Users for the Root Domain</samp></p></caption>
<thead>
<tr>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Username</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Given name</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Country</samp></p></th>
<th class="Basic-Table TCH" scope="col"><p class="TableHeader"><samp class="SANS_Futura_Std_Heavy_B_11">Password</samp></p></th>
</tr>
</thead>
<tbody>
<tr>
<td class="TBL0"><p class="TableBody"><samp class="SANS_Futura_Std_Book_Oblique_I_11">alice</samp></p></td>
<td class="TBL0"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Alice Bombas</samp></p></td>
<td class="TBL0"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">USA</samp></p></td>
<td class="TBL0"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Passw0rd1</samp></p></td>
</tr>
<tr>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_Futura_Std_Book_Oblique_I_11">bob</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">Bob Cordite</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_Futura_Std_Book_11">JP</samp></p></td>
<td class="Basic-Table TBL"><p class="TableBody"><samp class="SANS_TheSansMonoCd_W5Regular_11">Passw0rd2</samp></p></td>
</tr>
</tbody>
</table>
<p class="TX">The final task in <a href="appendix-A.xhtml#LisA-7">Listing A-7</a> is to create three Active Directory groups <span aria-label="annotation3" class="CodeAnnotationCode">❸</span>, one for each group scope. We also assign the two users to a combination of these groups.</p>
</section>
<section aria-labelledby="sec5" epub:type="division">
<h3 class="H2" id="sec5"><span id="h2-171"></span><samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">The GRAPHITE Workstation</samp></h3>
<p class="TNI1">With the domain controller configured, we can now set up a workstation. Run the script in <a href="appendix-A.xhtml#LisA-8">Listing A-8</a> to create the virtual machine, as we did with <i>PRIMARYDC</i>.</p>
<span id="LisA-8"></span><pre><code>PS&gt; <b>New-TestVM -VmName "GRAPHITE" -InstallerImage "C:\iso\client.iso"</b>
<b>-VmDirectory "C:\vms"</b>
PS&gt; <b>vmconnect localhost GRAPHITE</b>
PS&gt; <b>Start-VM -VmName "GRAPHITE"</b>
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing A-8: Creating and starting the</span> <samp class="SANS_Futura_Std_Book_11">GRAPHITE</samp> <span class="Futura_Std_Book_Oblique_I_11">virtual machine</span></p>
<p class="TX">In this case, you’ll use a disk image of Windows Professional or Enterprise, rather than a server installation. Any currently supported version of Windows 10 or greater is sufficient. Proceed with the installation as <span aria-label=" Page 543. " epub:type="pagebreak" id="pg_543" role="doc-pagebreak"></span>you normally would, creating the machine’s username and password. This book assumes you’ll use the username <i>admin</i> and a password of <samp class="SANS_TheSansMonoCd_W5Regular_11">Passw0rd</samp>, but you can pick any username and password you prefer.</p>
<p class="TX"><a href="appendix-A.xhtml#LisA-9">Listing A-9</a> sets up the network, as in <a href="appendix-A.xhtml#LisA-4">Listing A-4</a>.</p>
<span id="LisA-9"></span><pre><code>PS&gt; <b>$index = (Get-NetAdapter).ifIndex</b>
PS&gt; <b>New-NetIPAddress -InterfaceIndex $index -IPAddress 192.168.99.50</b>
<b>-PrefixLength 24 -DefaultGateway 192.168.99.1</b>
PS&gt; <b>Set-DnsClientServerAddress -InterfaceIndex $index</b>
<b>-ServerAddresses 192.168.99.10</b>
PS&gt; <b>Resolve-DnsName primarydc.mineral.local</b>
Name<b>                     </b>Type   TTL   Section    IPAddress
----<b>                     </b>----   ---   -------    ---------
primarydc.mineral.local  A      3600  Answer     192.168.99.10

PS&gt; <b>Rename-Computer -NewName "GRAPHITE" -Restart</b>
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing A-9: Setting the domain DNS server and checking that it resolves</span></p>
<p class="TX">The only difference here is that we configure the DNS server to use the one we installed on the domain controller at 192.168.99.10. You can verify that the DNS server is working correctly by attempting to resolve the <i>primarydc.mineral.local</i> server address. You should also be able to resolve internet domain names, as the domain controller will forward the requests onward.</p>
<p class="TX">Again, once you’ve configured this network, you’ll want to ensure that you’ve activated your Windows installation if necessary and downloaded any updates. If desired, you can rename the workstation to your chosen name before continuing.</p>
<p class="TX">In <a href="appendix-A.xhtml#LisA-10">Listing A-10</a>, we join the workstation to the domain.</p>
<span id="LisA-10"></span><pre><code>PS&gt; <b>$creds = Get-Credential</b>
PS&gt; <b>Add-Computer -DomainName MINERAL -Credential $creds</b>
WARNING: The changes will take effect after you restart the computer GRAPHITE.

PS&gt; <b>Add-LocalGroupMember -Group 'Administrators' -Member 'MINERAL\alice'</b>
PS&gt; <b>Restart-Computer</b>
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing A-10: Joining the</span> <samp class="SANS_Futura_Std_Book_11">GRAPHITE</samp> <span class="Futura_Std_Book_Oblique_I_11">workstation to the domain</span></p>
<p class="TX">The first thing we need are the credentials for a user in the domain. As I explained in <span class="Xref"><a href="chapter11.xhtml">Chapter 11</a></span>, this user doesn’t need to be a domain administrator; it can be a normal user. For example, you can enter the credentials for the <i>alice</i> user when prompted by the <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-Credential</samp> command’s GUI.</p>
<p class="TX">Next, we call the <samp class="SANS_TheSansMonoCd_W5Regular_11">Add-Computer</samp> command to join the workstation to the <i>MINERAL</i> domain with the user’s credentials. If this succeeds, it will print a warning telling you to restart the computer. However, don’t restart it just yet; you first need to add a domain user, such as <i>alice</i>, to the local <i>Administrators</i> group using the <samp class="SANS_TheSansMonoCd_W5Regular_11">Add-LocalGroupMember</samp> command. If you don’t do this step, you’ll subsequently have to authenticate to the workstation using either a domain administrator or the original local administrator account. Adding a user to this group allows you to authenticate as that user and be a local administrator. Once this is done, you can reboot.</p>
<p class="TX"><span aria-label=" Page 544. " epub:type="pagebreak" id="pg_544" role="doc-pagebreak"></span>That’s all there is to setting up a workstation. You can configure the rest of the workstation’s settings through the group policy on the domain controller. Once the workstation has restarted, you should be able to authenticate as any domain user.</p>
</section>
<section aria-labelledby="sec6" epub:type="division">
<h3 class="H2" id="sec6"><span id="h2-172"></span><samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">The SALESDC Server</samp></h3>
<p class="TNI1">The <i>SALESDC</i> virtual machine is a Windows server that serves a domain controller for the <i>sales.mineral.local</i> domain within the forest. Setting up this machine (or its sibling, <i>ENGDC</i>) is optional: you don’t need multiple domain forests to run most of the examples in this book. However, it will allow you to test different behaviors.</p>
<p class="TX"><a href="appendix-A.xhtml#LisA-11">Listing A-11</a> includes the same commands as those run for the <i>PRIMARYDC</i> virtual machine, with different values.</p>
<span id="LisA-11"></span><pre><code>PS&gt; <b>New-TestVM -VmName "SALESDC" -InstallerImage "C:\iso\server.iso"</b>
<b>-VmDirectory "C:\vms"</b>
PS&gt; <b>vmconnect localhost SALESDC</b>
PS&gt; <b>Start-VM -VmName "SALESDC"</b>
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing A-11: Creating and starting the</span> <samp class="SANS_Futura_Std_Book_11">SALESDC</samp> <span class="Futura_Std_Book_Oblique_I_11">virtual machine</span></p>
<p class="TX">Follow the normal installation process, and when asked for the <i>Administrator</i> user’s password, set it to anything you like. In this book, I’ve assumed it will be set to <samp class="SANS_TheSansMonoCd_W5Regular_11">Passw0rd</samp>.</p>
<p class="TX"><a href="appendix-A.xhtml#LisA-12">Listing A-12</a> configures the virtual machine’s network using the DNS server on <i>PRIMARYDC.</i></p>
<span id="LisA-12"></span><pre><code>PS&gt; <b>$index = (Get-NetAdapter).ifIndex</b>
PS&gt; <b>New-NetIPAddress -InterfaceIndex $index -IPAddress 192.168.99.110</b>
<b>-PrefixLength 24 -DefaultGateway 192.168.99.1</b>
PS&gt; <b>Set-DnsClientServerAddress -InterfaceIndex $index</b>
<b>-ServerAddresses 192.168.99.10</b>
PS&gt; <b>Rename-Computer -NewName "SALESDC" -Restart</b>
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing A-12: Setting up the</span> <samp class="SANS_Futura_Std_Book_11">SALESDC</samp> <span class="Futura_Std_Book_Oblique_I_11">virtual machine network</span></p>
<p class="TX">It’s crucial that the DNS client point to the root domain controller when creating a new domain in the forest so that you can resolve the root domain information. Once you’ve renamed the computer, you’ll need to configure the server as the domain controller for the <i>sales.mineral.local</i> domain. Log in to the server as an administrator and run the commands in <a href="appendix-A.xhtml#LisA-13">Listing A-13</a>.</p>
<span id="LisA-13"></span><pre><code>PS&gt; <b>Install-WindowsFeature AD-Domain-Services</b>
PS&gt; <b>Install-ADDSDomain -NewDomainName sales -ParentDomainName mineral.local</b>
<b>-NewDomainNetbiosName SALES -InstallDns -Credential (Get-Credential) -Force</b>
SafeModeAdministratorPassword: <b>********</b>
Confirm SafeModeAdministratorPassword: <b>********</b>
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing A-13: Installing and configuring the Active Directory domain services for a child domain</span></p>
<p class="TX"><span aria-label=" Page 545. " epub:type="pagebreak" id="pg_545" role="doc-pagebreak"></span>Here, you first install the <samp class="SANS_TheSansMonoCd_W5Regular_11">AD-Domain-Services</samp> feature as before, then run the <samp class="SANS_TheSansMonoCd_W5Regular_11">Install-ADDSDomain</samp> command to create a new domain in an existing forest. You’ll be prompted for the safe-mode password, as with the root domain. You must also specify an administrator account in the root domain to establish the trust relationship. You can use the existing <i>MINERAL\Administrator</i> account for this.</p>
<p class="TX">If this succeeds, the server should reboot. When you can reauthenticate as the <i>SALES\Administrator</i> user, you can verify that you’ve set up a trusted connection by using the <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-ADTrust</samp> command, as shown in <a href="appendix-A.xhtml#LisA-14">Listing A-14</a>.</p>
<span id="LisA-14"></span><pre><code>PS&gt; <b>Get-ADTrust -Filter * | Select Target, Direction</b>
Target            Direction
------            ---------
mineral.local     BiDirectional
</code></pre>
<p class="ListingCaption"><span class="Futura_Std_Book_Oblique_I_11">Listing A-14: Verifying the trust relationship between the</span> <samp class="SANS_Futura_Std_Book_11">SALES</samp> <span class="Futura_Std_Book_Oblique_I_11">and root domains</span></p>
<p class="TX">You should see a single entry for the root <i>mineral.local</i> domain. If the command fails, wait a few minutes for everything to start and retry.</p>
<p class="TX">At this point, you can add your own users and groups to the <i>SALES</i> domain, which will be separate from the root domain, although the users should be able to authenticate across domains due to the configured trust relationship. You can also install your own workstations using the steps outlined for <i>GRAPHITE</i>, making sure to specify the DNS server using the <i>SALESDS</i> IP address.</p>
<p class="TX">You can also create a separate engineering domain in the forest, or anything else you’d like. Just repeat these steps, changing the IP addresses and names you assign. You should then have a basic domain and forest configuration with which to run the examples in this book.</p>
<p class="TX">While we’ve configured every system you’ll need for the book, you are free to configure and customize these domains further if you wish. Bear in mind that changing certain configurations, such as names or passwords, might change the input you’ll need to provide in the book’s examples.</p>
</section>
</section>
</section>
</div></body>
</html>