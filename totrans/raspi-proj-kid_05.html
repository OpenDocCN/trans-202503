<html><head></head><body>
<h2 class="h2" id="ch05"><span epub:type="pagebreak" id="page_83"/>5<br/>PI SPY PART 1: HACKING WEBCAMS FOR SECRET SURVEILLANCE</h2>&#13;
<p class="noindent"><span class="big1">IN THIS CHAPTER, YOU’LL USE THE RASPBERRY PI WITH A CLASSIC USB WEBCAM TO SPY FOR YOU. YOU’LL LEARN HOW TO SET UP THE WEBCAM WITH YOUR PI. THEN YOU’LL STREAM THE FEED FROM THE CAMERA TO A REMOTE DEVICE, LIKE YOUR PHONE, TO MAKE A CHEAP HOME-SURVEILLANCE SYSTEM. <span epub:type="pagebreak" id="page_84"/>WITH THE WEBCAM, YOU CAN KEEP AN EYE ON YOUR PET, YOUR GARDEN, OR YOUR SIBLING. YOU CAN EVEN HIDE IT SOMEWHERE INCONSPICUOUS AND FIND OUT WHO KEEPS EATING ALL THE CHOCOLATE IN YOUR HOUSE!</span></p>&#13;
<h3 class="h3" id="ch05lev1sec1">WHAT YOU’LL NEED</h3>&#13;
<p class="noindent">Here are the items you’ll need for this project:</p>&#13;
<ul>&#13;
<li class="noindent">Raspberry Pi</li>&#13;
<li class="noindent">USB portable battery</li>&#13;
<li class="noindent">USB webcam</li>&#13;
</ul>&#13;
<p class="indent">Nowadays, most computers or computer monitors come with a built-in webcam, so the original USB models tend to be available online for a low cost. You might even find one hidden away at the back of a drawer. If you’re buying a webcam for this project, choose one from the list at <em><a href="https://elinux.org/RPi_USB_Webcams">https://elinux.org/RPi_USB_Webcams</a></em> that’s proven to work with the Pi.</p>&#13;
<p class="indent">You’ll use a USB battery supply to provide power and make the spy camera portable—so it’s worth buying a branded battery. Even though they’re slightly more expensive, they’re of higher quality and will last longer than the budget options. You can hide the webcam in the shed or an empty cereal box in the house without having to worry about plugging it into a power socket. That way, a wire won’t be on display and give the game away.</p>&#13;
<h3 class="h3" id="ch05lev1sec2">SETTING UP YOUR WEBCAM</h3>&#13;
<p class="noindent">You’ll start by attaching the webcam to your Pi and testing their compatibility. Boot up your Raspberry Pi and attach your monitor, keyboard, and mouse. You’ll remove these after you’ve completed the setup. Simply take the USB end of the webcam wire and plug it into one of the spare USB ports, as shown in <a href="ch05.xhtml#ch05fig01">Figure 5-1</a>.</p>&#13;
<p class="indent">Now check that the webcam is working using the following steps.</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_85"/><img alt="Image" src="../images/05fig01.jpg"/></div>&#13;
<p class="figcap" id="ch05fig01"><strong>FIGURE 5-1</strong> Attaching the webcam</p>&#13;
<ol>&#13;
<li class="noindent"><strong>Recognize the webcam:</strong> You can check that the Raspberry Pi has picked up the webcam by opening the terminal and entering the <span class="literal">ls</span> command. This command lists all the devices currently connected to the USB ports and looks something like this:&#13;
<pre><span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span> <span class="codestrong1">lsusb</span>&#13;
Bus 001 Device 007: ID 1908:2311 GEMBIRD&#13;
Bus 001 Device 006: ID 093a:2510 Pixart Imaging, Inc. Optical&#13;
Mouse&#13;
Bus 001 Device 005: ID 0e6f:0149 Logic3&#13;
Bus 001 Device 004: ID 05e3:0610 Genesys Logic, Inc. 4-port hub&#13;
Bus 001 Device 003: ID 0424:ec00 Standard Microsystems Corp.&#13;
SMSC9512/9514 Fast Ethernet Adapter &#13;
Bus 001 Device 002: ID 0424:9514 Standard Microsystems Corp.&#13;
SMC9514 Hub&#13;
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub</pre>&#13;
<p class="indent">My webcam is a Logic3, which you can see on the third line of the output. You can look for the brand name of your webcam or remove all other connected USB devices (except the keyboard) and see which device is still listed. If your webcam is not listed in the output, try restarting your Raspberry Pi and running the code again. If the webcam still doesn’t appear in the output, your model is probably incompatible and you’ll need another. The website provided earlier has a list of webcams that do and don’t work with the Pi.</p></li>&#13;
<li class="noindent"><span epub:type="pagebreak" id="page_86"/><strong>Install the webcam software:</strong> Now you’ll install a program called <em>fswebcam</em> that will test that the camera is working correctly before moving on to the main project program. There’s nothing worse than typing your program and then finding it doesn’t work because the hardware is incompatible! Return to the terminal window and enter the following line to download and install the required software:&#13;
<pre><span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span> <span class="codestrong1">sudo apt-get install fswebcam</span></pre></li>&#13;
<li class="noindent"><strong>Take a test image:</strong> Once the program has finished installing, you can test the webcam by taking an image. In the terminal, enter the following command to take a picture from the webcam and save it as an image file called <em>test</em>:&#13;
<pre><span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span> <span class="codestrong1">fswebcam test.jpg</span></pre>&#13;
<p class="indent">To view the image, open your Pi <em>home</em> folder, find the <em>test.jpg</em> file, and double-click it. If it has taken a picture, the webcam is working correctly! <a href="ch05.xhtml#ch05fig02">Figure 5-2</a> shows the output to the terminal window when an image is successfully captured. If it hasn’t taken a picture, you might need to use a different webcam. Also, check that the webcam is connected and ensure that the code is correct.</p></li>&#13;
</ol>&#13;
<div class="image"><img alt="Image" src="../images/05fig02.jpg"/></div>&#13;
<p class="figcap" id="ch05fig02"><strong>FIGURE 5-2</strong> Capturing the image from the webcam</p>&#13;
<h3 class="h3" id="ch05lev1sec3"><span epub:type="pagebreak" id="page_87"/>STREAMING A VIDEO FROM THE WEBCAM</h3>&#13;
<p class="noindent">Now that you know your webcam is installed and working correctly, you can write a short program to stream the image from the webcam to the Raspberry Pi. You’ll use a code package called <em>PyGame</em>, which is a set of Python modules designed for writing video games. However, it also includes computer graphics, videos, and sound libraries designed to be used with Python. You’ll borrow some functions and tools from PyGame to save you the trouble of writing them yourself.</p>&#13;
<p class="indent">PyGame comes preinstalled on the Raspberry Pi operating system, so you don’t need to download it. Open a new Python file and save it as <em>pi_spy.py</em>. Then enter the code in <a href="ch05.xhtml#ch05ex01">Listing 5-1</a>, which is the first part of the code.</p>&#13;
<pre><span class="ent">❶</span> <span class="codeorg">import</span> sys&#13;
<span class="ent">❷</span> <span class="codeorg">import</span> pygame&#13;
   <span class="codeorg">import</span> pygame.camera&#13;
<span class="ent">❸</span> pygame.init()&#13;
   pygame.camera.init()&#13;
   <span class="codered"># set the size of the window</span>&#13;
<span class="ent">❹</span> screen = pygame.display.set_mode((320,240),0)</pre>&#13;
<p class="caption" id="ch05ex01"><strong>LISTING 5-1</strong> The first part of the Pi spy code</p>&#13;
<p class="indent">As with most programs, you begin by importing the required modules and PyGame libraries. First, you import the system module <span class="ent">❶</span>, and then you import <span class="literal">pygame</span>. From <span class="literal">pygame</span>, you import the <span class="literal">pygame.camera</span> module <span class="ent">❷</span>.</p>&#13;
<p class="indent">Next, you initialize <span class="literal">pygame</span> and the camera commands <span class="ent">❸</span>. This prepares <span class="literal">pygame</span> to run. The last line of code sets the size of the <span class="literal">pygame</span> window <span class="ent">❹</span>. PyGame runs its programs in a separate window, and this line creates that window when you run the program. You can adjust the size by changing the width and height measurements, which are currently set to 320 × 240. <a href="ch05.xhtml#ch05fig03">Figure 5-3</a> shows that the window takes up only a small part of the screen. Some webcams will support higher resolutions. You’ll find several options at <em><a href="https://elinux.org/RPi_USB_Webcams">https://elinux.org/RPi_USB_Webcams</a></em>.</p>&#13;
<div class="image"><img alt="Image" src="../images/05fig03.jpg"/></div>&#13;
<p class="figcap" id="ch05fig03"><strong>FIGURE 5-3</strong> The webcam window</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_88"/>Next, you’ll use PyGame to find the attached webcam and start it running. To do this, add the code in <a href="ch05.xhtml#ch05ex02">Listing 5-2</a> to your program.</p>&#13;
<pre>   <span class="codered"># locate the camera and turn it on</span>&#13;
<span class="ent">❶</span> cam_list = pygame.camera.list_cameras()&#13;
<span class="ent">❷</span> <span class="codepurple">print</span> (cam_list)&#13;
<span class="ent">❸</span> webcam = pygame.camera.Camera(cam_list[0],(32,24))&#13;
<span class="ent">❹</span> webcam.start()</pre>&#13;
<p class="caption" id="ch05ex02"><strong>LISTING 5-2</strong> The second part of the program: turning on the webcam</p>&#13;
<p class="indent">First, you need PyGame to find the webcam by asking it to list available cameras. You create a variable to hold the results of the camera search <span class="ent">❶</span>, which should return your single webcam. These results are stored in a list of one item, because there’s only one webcam.</p>&#13;
<p class="indent">You then print the list of results <span class="ent">❷</span> to make sure your camera was found. If you have only one webcam connected to your Pi, it should be listed in position 0. Remember that list numbering always starts at 0 not 1.</p>&#13;
<p class="indent">Then you set up the webcam and store the details in a variable named <span class="literal">webcam</span> so you can call it again more easily later in the program <span class="ent">❸</span>. The name of the camera is pulled from the <span class="literal">cam_list</span> you got earlier by passing the list name with <span class="literal">[0]</span>, which tells Python to take the first item in the list held in position 0.</p>&#13;
<p class="indent">You also specify the dimensions of the webcam image. You can see that these dimensions are in parentheses, not square brackets, with a comma between values: this is a data type known as a <em>tuple</em>, and it’s like a list but with values that don’t change. Tuples are often referred to as <em>immutable</em>, which means that the data held inside them <span epub:type="pagebreak" id="page_89"/>cannot be changed while the program is running. The code at <span class="ent">❸</span> changes the quality of the image displayed in the stream window. If you set the dimensions to 32 × 24, the video stream will look more pixelated, but the PyGame window remains the original size of 320 × 240. To change it, you’d have to return to the code, edit the sizes, and then rerun the program.</p>&#13;
<p class="indent">The last line of code tells the camera to start <span class="ent">❹</span>, which turns it on.</p>&#13;
<p class="indent">Now for the final part of the program. Add the code in <a href="ch05.xhtml#ch05ex03">Listing 5-3</a> to your program.</p>&#13;
<pre><span class="ent">❶</span> <span class="codeorg">while True</span>:&#13;
       <span class="codered"># stream the images and scale to a set size</span>&#13;
    <span class="ent">❷</span> stream = webcam.get_image()&#13;
    <span class="ent">❸</span> stream = pygame.transform.scale(stream,(320,240))&#13;
    <span class="ent">❹</span> screen.blit(stream,(0,0))&#13;
       <span class="codered"># update the display</span>&#13;
    <span class="ent">❺</span> pygame.display.update()</pre>&#13;
<p class="caption" id="ch05ex03"><strong>LISTING 5-3</strong> The final code for the Pi spy: streaming the video</p>&#13;
<p class="indent">You begin by creating a <span class="literal">while</span> loop to keep the program running the instructions that follow <span class="ent">❶</span>. The loop tells PyGame to keep pulling images from the webcam and displaying them onscreen.</p>&#13;
<p class="indent">You then create a variable to store the image from the attached webcam <span class="ent">❷</span>. The next line of code <span class="ent">❸</span> scales each image so it fits the screen size you entered earlier. In this case, it scales the image to 320 × 240 to match the dimensions you set at the start of the program in the <span class="literal">screen = pygame.display.set_mode((320,240),0)</span> variable. If you change either the window size or the scale, make sure those measurements match.</p>&#13;
<p class="indent">To draw the video image on your screen, you use a PyGame function called <span class="literal">blit()</span> <span class="ent">❹</span>. Your display is made up of millions of tiny dots called <em>pixels</em>, which can be turned on or off. When you display an image onscreen, your software manages which pixels are on or off as well as their colors. Pixels also make up your image. The video from your webcam is made up of lots of still images played together one after the other, similar to a flip book or animation. <em>Blitting</em> takes a full copy of the pixels from one of the images and copies them to the pixels on your screen, displaying the image. Then, when the program loops, the next image is captured from the webcam and saved. The pixels are updated using the <span class="literal">blit()</span> function to make a video.</p>&#13;
<p class="indent">The final line of code <span class="ent">❺</span> updates the PyGame window, displaying the webcam stream for you to watch. The program then loops again, collects a new image, blits it, and then displays it on your screen.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_90"/>Save your program and run it! Remember that pressing <strong>F5</strong> will save and execute the program. A small PyGame window will pop open, and you’ll see a live stream from the webcam.</p>&#13;
<h3 class="h3" id="ch05lev1sec4">LIVE STREAMING TO A DEVICE</h3>&#13;
<p class="noindent">So far, your Pi streaming video is from the same location as your Pi, which is fine if you’re sitting at your desk with your Pi and can watch the PyGame window. But say you want to spy at a different location. For example, what if you want to set up a webcam at a window that overlooks the front door of your house so you can see visitors approach? Or perhaps you want to hide the webcam in the kitchen and watch what your pets do when you leave them home alone. You could even use the webcam as a simple bedroom monitor. This next program shows you how to make a portable spy camera for such projects.</p>&#13;
<p class="indent">Make sure your webcam is still plugged into the Pi USB port. Then you’ll need to download and configure a handy piece of software called <em>motion</em>, which enables you to stream images from your webcam to a particular device, like your phone or tablet. For this, you need to make sure your Raspberry Pi <em>and</em> the viewing device are connected to your home network. Follow these steps:</p>&#13;
<ol>&#13;
<li class="noindent"><strong>Install the software:</strong> To download and install the <em>motion</em> program, open the terminal and enter the following command:&#13;
<pre><span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span> <span class="codestrong1">sudo apt install motion</span></pre></li>&#13;
<li class="noindent"><strong>Find your IP address:</strong> To access the live stream from another device, you’ll need your Raspberry Pi’s IP address. An <em>IP address</em> identifies each device on a network. This is how your Pi, games console, and smart TV can all be online at the same time and not accidentally receive the wrong data. To find your Pi’s IP address in the terminal, enter the following:&#13;
<pre><span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span> <span class="codestrong1">ip addr show</span></pre>&#13;
<p class="indent">Or enter this:</p>&#13;
<pre><span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span> <span class="codestrong1">hostname -I</span></pre>&#13;
<p class="indent">This command will list lots of data related to the network connections. Look for the line that begins with <span class="literal">wlan0</span>. On the <span epub:type="pagebreak" id="page_91"/>second line, you’ll find the IP address, which begins with <span class="literal">inet</span> and looks like this: <span class="literal">192.168.1.751</span>. This is your Pi’s personal IP address. Write it down, because you’ll need it later.</p></li>&#13;
<li class="noindent"><strong>Create a daemon to run the program:</strong> In computing terms, a <em>daemon</em> is a program that runs in the background, doing its thing. You, the user, don’t need to control it directly. The webcam stream doesn’t require any user interaction and can run as a background process; so you’ll set it to run as a daemon by adding a line to the motion code file. In the terminal window, enter this command:&#13;
<pre><span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span> <span class="codestrong1">sudo nano /etc/default/motion</span></pre>&#13;
<p class="indent">This command opens a text file called <em>motion</em> that you can add instructions to. The motion software will recognize the <em>motion</em> file. At the bottom of the file, add the following line of code:</p>&#13;
<pre><span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span> <span class="codestrong1">start_motion_daemon=yes</span></pre>&#13;
<p class="indent">This code tells the daemon to start the webcam server and run it as a background process, as shown in <a href="ch05.xhtml#ch05fig04">Figure 5-4</a>. Press <span class="small">CTRL-</span>X to exit, and then when prompted, press <strong>Y</strong> to save the file.</p></li>&#13;
</ol>&#13;
<div class="image"><img alt="Image" src="../images/05fig04.jpg"/></div>&#13;
<p class="figcap" id="ch05fig04"><strong>FIGURE 5-4</strong> The webcam server window</p>&#13;
<ol start="4">&#13;
<li class="noindent"><span epub:type="pagebreak" id="page_92"/><strong>Change settings in the configuration file:</strong> Before you start the stream, you need to make a few more changes in the motion <em>configuration</em> file, <em>motion.conf</em>. Here you can add or alter the code to change the program’s behavior. This file is large and contains lots of settings, so let’s walk through it so you don’t get lost. Enter the following command in the terminal to open <em>motion.conf</em>:&#13;
<pre><span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span> <span class="codestrong1">sudo nano /etc/motion/motion.conf</span></pre>&#13;
<p class="indent">Configure these settings:</p>&#13;
<p class="noindentt"><strong>Turn on the daemon:</strong> To turn on the daemon, find the <span class="literal">daemon off</span> entry near the start of the file and change it to <span class="codestrong">daemon on</span>.</p>&#13;
<p class="noindentt"><strong>Adjust the quality:</strong> Adjust the image quality of the stream to somewhere between 1 and 50, where 50 is the highest quality. A higher quality streams clearer images but will put more strain on the Raspberry Pi and your network. If the value is too high for the Pi to handle, it might crash. I recommend setting the quality to 20 to begin with. Then you can change it later if you want a clearer image. Locate the <span class="literal">Live Stream Server</span> section, find the <span class="literal">stream_quality</span> line, and set it to <span class="codestrong">20</span> so it reads as follows:</p>&#13;
<pre><span class="codestrong1">stream_quality 20</span></pre>&#13;
<p class="noindentt"><strong>Adjust the frame rate:</strong> Adjusting the <em>frame rate</em> affects the number of frames is displayed each second. The higher the number of frames is, the smoother the video will play. The lower the number is, the jerkier the image will appear. However, sometimes setting it too high can use up too much bandwidth and make the connection slow, especially if other people are using your network. Adjust the frame capture to around <span class="codestrong">25</span>, which will give you a near-live stream with a delay of 0.2 seconds. Locate the setting <span class="literal">stream_maxrate</span> and set it to <span class="codestrong">50</span>. Again, you can adjust these settings later to suit your network capability.</p>&#13;
<p class="noindentt"><strong>Change the size of the video displayed (optional):</strong> If you’re viewing the feed on a smartphone or tablet, you might need to make the video window size smaller. In that case, locate the <span class="literal">width</span> and <span class="literal">height</span> entries in the configuration file and adjust the numbers to suit your device. You might have to experiment with a few numbers before you get the right size.</p>&#13;
<p class="noindentt"><span epub:type="pagebreak" id="page_93"/><strong>Final settings:</strong> Set the <span class="literal">stream_localhost</span> line to <span class="codestrong">off</span> to stream the webcam images to your mobile device rather than just the Raspberry Pi, which is the local host. After completing these changes, press <span class="small">CTRL</span>-X. You’ll be prompted to save the changes to the configuration file. Press <strong>Y</strong> to select <em>yes</em>. To change some of the settings shown in <a href="ch05.xhtml#ch05fig05">Figure 5-5</a> again later, just open the file using the <span class="literal">sudo nano /etc/motion/motion.conf</span> command. Then make your required adjustments, exit, and save the file.</p></li>&#13;
</ol>&#13;
<div class="image"><img alt="Image" src="../images/05fig05.jpg"/></div>&#13;
<p class="figcap" id="ch05fig05"><strong>FIGURE 5-5</strong> The settings window</p>&#13;
<ol start="5">&#13;
<li class="noindent"><strong>Start motion:</strong> To start the web server and capture a video feed, enter this command:&#13;
<pre><span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span> <span class="codestrong1">sudo service motion start</span></pre></li>&#13;
<li class="noindent"><strong>Access the video stream:</strong> To access the video, open a browser window on the device you’re streaming to. In the address bar, enter the Raspberry Pi’s IP address (the one you wrote down earlier); at the end of the address, add the port number <span class="codestrong">:8081</span>. The complete address should look similar to <span class="literal">192.168.1.56:8081</span>. When you press <span class="small">ENTER</span>, the browser should look up your Pi’s IP address and connect to it. The Pi and motion program will respond and start streaming the live video from the webcam to your device, as shown in <a href="ch05.xhtml#ch05fig06">Figure 5-6</a>.</li>&#13;
</ol>&#13;
<div class="image"><span epub:type="pagebreak" id="page_94"/><img alt="Image" src="../images/05fig06.jpg"/></div>&#13;
<p class="figcap" id="ch05fig06"><strong>FIGURE 5-6</strong> Streaming live video to a browser</p>&#13;
<p class="indent">Now you need to find somewhere you can hide your Pi and the camera to start spying; just make your camera has a clear view! You can remove the monitor, mouse, and keyboard and place your Raspberry Pi spy cam in a suitable location. Remember to ensure that your Raspberry Pi stays within range of your Wi-Fi signal so the images can be streamed to your mobile device.</p>&#13;
<h3 class="h3" id="ch05lev1sec5">STOPPING AND RESTARTING MOTION</h3>&#13;
<p class="noindent">Once you’ve finished using the web stream, you can return to your Raspberry Pi and reconnect the monitor, mouse, and keyboard. Then open the terminal and enter this command to stop the program and end the stream:</p>&#13;
<pre><span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span> <span class="codestrong1">sudo service motion stop</span></pre>&#13;
<p class="indent">If you can’t access a monitor and keyboard, just remove the power from the Raspberry Pi to halt the stream.</p>&#13;
<p class="indent">Sometimes your motion software might stall, and the video will stop streaming. If this occurs, the image will be static or frozen. In that case, restart the software by using the following command:</p>&#13;
<pre><span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span> <span class="codestrong1">sudo service motion restart</span></pre>&#13;
<p class="indent">You should also restart anytime you adjust the configuration file settings.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_95"/>If you’re using your webcam covertly, remember to make sure that no one is around before accessing your Pi and restarting the program. Otherwise, you’ll give away the location of your hidden camera.</p>&#13;
<h3 class="h3" id="ch05lev1sec6">WRAPPING UP</h3>&#13;
<p class="noindent">Now you have a compact spy camera to do with what you will. You’ll be using the Pi’s image capabilities again in <a href="ch11.xhtml#ch11">Chapter 11</a> to set up a nature box that will take surreptitious photos of anything that triggers its sensors. For now, try playing with the settings to see what resolution, frame rate, and size work best for your system.<span epub:type="pagebreak" id="page_96"/></p>&#13;
</body></html>