<html><head></head><body>
		<section>&#13;
			<header>&#13;
				<h1 class="chapter"><span class="ChapterNumber"><span epub:type="pagebreak" id="Page_291" title="291"/>16</span><br/><span class="ChapterTitle">Wireless Data</span></h1>&#13;
			</header>&#13;
			<p class="ChapterIntro">In this chapter, you’ll learn how to send and receive instructions and data using various types of wireless transmission hardware. Specifically, you’ll learn how to</p>&#13;
			<ul>&#13;
				<li>Send digital output signals using low-cost wireless modules</li>&#13;
				<li>Create a simple and inexpensive wireless remote control system</li>&#13;
				<li>Use LoRa wireless data receivers and transceivers</li>&#13;
				<li>Create a remote control temperature sensor</li>&#13;
			</ul>&#13;
			<h2 id="h1-500587c16-0001">Using Low-Cost Wireless Modules</h2>&#13;
			<p class="BodyFirst">It’s easy to send text information in one direction using a wireless link between two Arduino-controlled systems that have inexpensive radio frequency (RF) data modules, such as the transmitter and receiver modules shown in <a href="#figure16-1" id="figureanchor16-1">Figure 16-1</a>. These modules are usually sold in pairs and are known as <em>RF Link</em> modules or kits. Good examples are part 44910433 from PMD Way or parts WRL-10534 and WRL-10532 from SparkFun. We’ll use the most common module types that run on the 433 MHz radio frequency in our projects.</p>&#13;
			<p><span epub:type="pagebreak" id="Page_292" title="292"/>The connections shown at the bottom of the transmitter in <a href="#figure16-2" id="figureanchor16-2">Figure 16-2</a> are, from left to right, data in, 5 V, and GND. A connection for an external antenna is at the top-right corner of the board. The antenna can be a single length of wire, or it can be omitted entirely for short transmission distances. (Each brand of module can vary slightly, so check the connections on your particular device before moving forward.)</p>&#13;
			<figure>&#13;
				<img alt="f16001" src="image_fi/500587c16/f16001.png"/>&#13;
				<figcaption>&#13;
					<p><a id="figure16-1">Figure 16-1</a>: RF Link transmitter and receiver set</p>&#13;
				</figcaption>&#13;
			</figure>&#13;
			<figure>&#13;
				<img alt="f16002" src="image_fi/500587c16/f16002.png"/>&#13;
				<figcaption>&#13;
					<p><a id="figure16-2">Figure 16-2</a>: Transmitter RF Link module</p>&#13;
				</figcaption>&#13;
			</figure>&#13;
			<p><a href="#figure16-3" id="figureanchor16-3">Figure 16-3</a> shows the receiver module, which is slightly larger than the transmitter module.</p>&#13;
			<figure>&#13;
				<img alt="f16003" src="image_fi/500587c16/f16003.png"/>&#13;
				<figcaption>&#13;
					<p><a id="figure16-3">Figure 16-3</a>: Receiver RF Link module</p>&#13;
				</figcaption>&#13;
			</figure>&#13;
			<p>The connections on the receiver are straightforward: the V+ and V− pins connect to 5 V and GND, respectively, and DATA connects to the Arduino pin allocated to receive the data. These pins are usually labeled on the other side of the module. If they’re not labeled or you’re not sure, look for the module’s data sheet or contact the supplier.</p>&#13;
			<p><span epub:type="pagebreak" id="Page_293" title="293"/>Before you can use these modules, you also need to download and install the latest version of the VirtualWire library from <a class="LinkURL" href="http://www.airspayce.com/mikem/arduino/VirtualWire/">http://www.airspayce.com/mikem/arduino/VirtualWire/</a> using the method described in <span class="xref" itemid="xref_target_Chapter 7">Chapter 7</span>. This library is also included with the sketch download file for this book, which is available at <a class="LinkURL" href="https://nostarch.com/arduino-workshop-2nd-edition/">https://nostarch.com/arduino-workshop-2nd-edition/</a>. After you’ve installed the library, you’ll be ready to move on to the next section.</p>&#13;
			<aside epub:type="sidebar">&#13;
				<div class="top hr">&#13;
					<hr/>&#13;
				</div>&#13;
				<section class="note">&#13;
					<h2><span class="NoteHead">NOTE</span></h2>&#13;
					<p>	The RF Link modules are inexpensive and easy to use, but they have no error-checking capability to ensure that the data being sent is received correctly. Therefore, I recommend that you use them only for simple tasks such as this basic remote control project. If your project calls for more accurate and reliable data transmission, use something like the LoRa modules instead, which are discussed later in this chapter.</p>&#13;
					<div class="bottom hr">&#13;
						<hr/>&#13;
					</div>&#13;
				</section>&#13;
			</aside>&#13;
			<h2 class="HeadProject" id="h1-500587c16-0002"><span>Project #46: Creating a Wireless Remote Control</span></h2>&#13;
			<p class="BodyFirst">We’ll remotely control two digital outputs: you’ll press buttons connected to one Arduino board to control matching digital output pins on another Arduino located some distance away. This project will show you how to use the RF Link modules. You’ll also learn how to determine how far away you can be and remotely control the Arduino. It’s important to know this before you commit to using the modules for more complex tasks. (In open air, the distance you can achieve is generally about 100 meters, but the distance will be less when you are indoors or when the modules are separated by obstacles.)</p>&#13;
			<h3 id="h2-500587c16-0001">The Transmitter Circuit Hardware</h3>&#13;
			<p class="BodyFirst">The following hardware is required for the transmitter circuit:</p>&#13;
			<ul>&#13;
				<li>Arduino and USB cable</li>&#13;
				<li>&#13;
					AA battery holder and wiring (as used in <span class="xref" itemid="xref_target_Chapter 14">Chapter 14</span>)</li>&#13;
				<li>One 433 MHz RF Link transmitter module</li>&#13;
				<li>Two 10 kΩ resistors (R1 and R2)</li>&#13;
				<li>Two 100 nF capacitors (C1 and C2)</li>&#13;
				<li>Two push buttons</li>&#13;
				<li>One breadboard</li>&#13;
			</ul>&#13;
			<h3 id="h2-500587c16-0002">The Transmitter Schematic</h3>&#13;
			<p class="BodyFirst">The transmitter circuit consists of two push buttons with debounce circuitry connected to digital pins 2 and 3, as well as the transmitter module wired as described earlier (<a href="#figure16-4" id="figureanchor16-4">Figure 16-4</a>).</p>&#13;
			<span epub:type="pagebreak" id="Page_294" title="294"/>&#13;
			<figure>&#13;
				<img alt="f16004" src="image_fi/500587c16/f16004.png"/>&#13;
				<figcaption>&#13;
					<p><a id="figure16-4">Figure 16-4</a>: Transmitter schematic for Project 46</p>&#13;
				</figcaption>&#13;
			</figure>&#13;
			<h3 id="h2-500587c16-0003">The Receiver Circuit Hardware</h3>&#13;
			<p class="BodyFirst">The following hardware is required for the receiver circuit:</p>&#13;
			<ul>&#13;
				<li>Arduino and USB cable</li>&#13;
				<li>&#13;
					AA battery holder and wiring (as used in <span class="xref" itemid="xref_target_Chapter 14">Chapter 14</span>)</li>&#13;
				<li>One 433 MHz RF Link receiver module</li>&#13;
				<li>One breadboard</li>&#13;
				<li>Two LEDs of your choice</li>&#13;
				<li>&#13;
					Two 560 <span class="NSSymbol">Ω</span> resistors (R1 and R2)</li>&#13;
			</ul>&#13;
			<h3 id="h2-500587c16-0004">The Receiver Schematic</h3>&#13;
			<p class="BodyFirst">The receiver circuit consists of two LEDs on digital pins 6 and 7 and the data pin from the RF Link receiver module connected to digital pin 8, as shown in <a href="#figure16-5" id="figureanchor16-5">Figure 16-5</a>.</p>&#13;
			<span epub:type="pagebreak" id="Page_295" title="295"/>&#13;
			<figure>&#13;
				<img alt="f16005" src="image_fi/500587c16/f16005.png"/>&#13;
				<figcaption>&#13;
					<p><a id="figure16-5">Figure 16-5</a>: Receiver schematic for Project 46</p>&#13;
				</figcaption>&#13;
			</figure>&#13;
			<p>&#13;
				You can substitute the breadboard, LEDs, resistors, and receiver module with a Freetronics 433 MHz receiver shield, shown in <a href="#figure16-6" id="figureanchor16-6">Figure 16-6</a>.</p>&#13;
			<figure>&#13;
				<img alt="f16006" src="image_fi/500587c16/f16006.png"/>&#13;
				<figcaption>&#13;
					<p><a id="figure16-6">Figure 16-6</a>: A Freetronics 433 MHz receiver shield</p>&#13;
				</figcaption>&#13;
			</figure>&#13;
			<h3 id="h2-500587c16-0005"><span epub:type="pagebreak" id="Page_296" title="296"/>The Transmitter Sketch</h3>&#13;
			<p class="BodyFirst">Now let’s examine the sketch for the transmitter. Enter and upload the following sketch to the Arduino with the transmitter circuit:</p>&#13;
			<pre><code>// Project 46 - Creating a Wireless Remote Control, Transmitter Sketch<span aria-label="annotation1" class="CodeAnnotationHang">1</span> #include &lt;VirtualWire.h&gt; &#13;
uint8_t buf[VW_MAX_MESSAGE_LEN]; &#13;
uint8_t buflen = VW_MAX_MESSAGE_LEN;<span aria-label="annotation2" class="CodeAnnotationHang">2</span> const char *on2 = "a"; &#13;
const char *off2 = "b"; &#13;
const char *on3 = "c"; &#13;
const char *off3 = "d"; &#13;
void setup()&#13;
{<span aria-label="annotation3" class="CodeAnnotationHang">3</span>     vw_set_ptt_inverted(true);      // Required for RF Link modules  vw_setup(300);                  // set data speed <span aria-label="annotation4" class="CodeAnnotationHang">4</span>     vw_set_tx_pin(8);              pinMode(2, INPUT); pinMode(3, INPUT);&#13;
}&#13;
void loop()&#13;
{<span aria-label="annotation5" class="CodeAnnotationHang">5</span>   if (digitalRead(2)==HIGH) {   vw_send((uint8_t *)on2, strlen(on2));  // send data out to the world vw_wait_tx();                          // wait a moment  delay(200); } if (digitalRead(2)==LOW) {<span aria-label="annotation6" class="CodeAnnotationHang">6</span>        vw_send((uint8_t *)off2, strlen(off2));    vw_wait_tx();                            delay(200); } if (digitalRead(3)==HIGH) { vw_send((uint8_t *)on3, strlen(on3));    vw_wait_tx();                            delay(200); }  if (digitalRead(3)==LOW) { vw_send((uint8_t *)off3, strlen(off3));  vw_wait_tx();                            delay(200); }&#13;
}</code></pre>&#13;
			<p><span epub:type="pagebreak" id="Page_297" title="297"/>We include the VirtualWire library at <span aria-label="annotation1" class="CodeAnnotation">1</span> and use its functions at <span aria-label="annotation3" class="CodeAnnotation">3</span> to set up the RF Link transmitter module and set the data speed. At <span aria-label="annotation4" class="CodeAnnotation">4</span>, we set digital pin 8, which is used to connect the Arduino to the data pin of the transmitter module and to control the speed of the data transmission. (You can use any other digital pins if necessary, except 0 and 1, which would interfere with the serial line.)</p>&#13;
			<p>&#13;
				The transmitter sketch reads the status of the two buttons connected to digital pins 2 and 3 and sends a single text character to the RF Link module that matches the state of the buttons. For example, when the button on digital pin 2 is <code>HIGH</code>, the Arduino sends the character <em>a</em>, and when the button is <code>LOW</code>, it sends the character <em>b</em>. When the button on digital pin 3 is <code>HIGH</code>, the Arduino sends the character <em>c</em>, and when the button is <code>LOW</code>, it sends the character <em>d</em>. The four states are declared starting at <span aria-label="annotation2" class="CodeAnnotation">2</span>.</p>&#13;
			<p>&#13;
				The transmission of the text character is handled using one of the four sections’ <code>if</code> statements, starting at <span aria-label="annotation5" class="CodeAnnotation">5</span>—for example, the contents of the <code>if-then</code> statement at <span aria-label="annotation6" class="CodeAnnotation">6</span>. The variable transmitted is used twice, as shown here with <code>on2</code>, for example:</p>&#13;
			<pre><code>vw_send((uint8_t *)on2, strlen(on2)); </code></pre>&#13;
			<p>&#13;
				The function <code>vw_send()</code> sends the contents of the variable <code>on2</code>, but it needs to know the length of the variable in characters, so we use <code>strlen()</code> to accomplish this.</p>&#13;
			<h3 id="h2-500587c16-0006">The Receiver Sketch</h3>&#13;
			<p class="BodyFirst">Now let’s add the receiver sketch. Enter and upload the following sketch to the Arduino with the receiver circuit:</p>&#13;
			<pre><code>// Project 46 - Creating a Wireless Remote Control, Receiver Sketch&#13;
#include &lt;VirtualWire.h&gt; &#13;
uint8_t buf[VW_MAX_MESSAGE_LEN]; &#13;
uint8_t buflen = VW_MAX_MESSAGE_LEN;&#13;
void setup()&#13;
{<span aria-label="annotation1" class="CodeAnnotationHang">1</span>   vw_set_ptt_inverted(true);    // Required for RF Link modules  vw_setup(300); <span aria-label="annotation2" class="CodeAnnotationHang">2</span>   vw_set_rx_pin(8);             vw_rx_start();                 pinMode(6, OUTPUT);  pinMode(7, OUTPUT);&#13;
}&#13;
void loop()&#13;
{<span aria-label="annotation3" class="CodeAnnotationHang">3</span>   if (vw_get_message(buf, &amp;buflen))  {<span epub:type="pagebreak" id="Page_298" title="298"/><span aria-label="annotation4" class="CodeAnnotationHang">4</span>     switch(buf[0])   { case 'a': digitalWrite(6, HIGH); break; case 'b':  digitalWrite(6, LOW); break; case 'c':  digitalWrite(7, HIGH); break; case 'd':  digitalWrite(7, LOW); break; } }&#13;
}</code></pre>&#13;
			<p>&#13;
				As with the transmitter circuit, we use the VirtualWire functions at <span aria-label="annotation1" class="CodeAnnotation">1</span> to set up the RF Link receiver module and set the data speed. At <span aria-label="annotation2" class="CodeAnnotation">2</span> we set the Arduino digital pin to which the link’s data output pin is connected (pin 8).</p>&#13;
			<p>&#13;
				When the sketch is running, the characters sent from the transmitter circuit are received by the RF Link module and sent to the Arduino. The function <code>vw_get_message()</code> at <span aria-label="annotation3" class="CodeAnnotation">3</span> takes the characters received by the Arduino, which are interpreted by the <code>switch case</code> statement at <span aria-label="annotation4" class="CodeAnnotation">4</span>. For example, pressing button S1 on the transmitter circuit will send the character <em>a</em>. This character is received by the transmitter, which sets digital pin 6 to <code>HIGH</code>, turning on the LED.</p>&#13;
			<p>You can use this simple pair of demonstration circuits to create more complex controls for Arduino systems by sending codes as basic characters to be interpreted by a receiver circuit.</p>&#13;
			<h2 id="h1-500587c16-0003">Using LoRa Wireless Data Modules for Greater Range and Faster Speed</h2>&#13;
			<p class="BodyFirst">When you need a wireless data link with greater range and a faster data speed than what the basic wireless modules used earlier can provide, LoRa data modules may be the right choice. LoRa is short for “long range,” and these modules work at long range with low power consumption. The modules are <em>transceivers</em>, which are devices that can both transmit and receive data, so you don’t need a separate transmitter and receiver. A further benefit of using LoRa modules is that different types of modules can communicate, allowing you, the designer, to create control and data networks that range from the simple to the complex. In this chapter, you will create several basic modules that can be built upon for various purposes.</p>&#13;
			<span epub:type="pagebreak" id="Page_299" title="299"/>&#13;
			<figure>&#13;
				<img alt="f16007" src="image_fi/500587c16/f16007.png"/>&#13;
				<figcaption>&#13;
					<p><a id="figure16-7">Figure 16-7</a>: A LoRa shield for Arduino</p>&#13;
				</figcaption>&#13;
			</figure>&#13;
			<p>&#13;
				For convenience, we’ll be using two LoRa shields for Arduino, such as PMD Way part number 14290433, shown in <a href="#figure16-7" id="figureanchor16-7">Figure 16-7</a>.</p>&#13;
			<p>When purchasing your LoRa shields, you will need to select an operating frequency. The correct frequency will vary depending on your country of use. This is to ensure that your data transmissions don’t interfere with other devices in your area. LoRa products are available in three operating frequency bands:</p>&#13;
			<ol class="none">&#13;
				<li><span class="RunInHead">433 MHz </span>  Used in United States and Canada</li>&#13;
				<li><span class="RunInHead">868 MHz </span>  Used in United Kingdom and Europe</li>&#13;
				<li><span class="RunInHead">915 MHz </span>  Used in Australia and New Zealand</li>&#13;
			</ol>&#13;
			<p>&#13;
				You can find a full list of countries and the frequency ranges you need to use in each at <a class="LinkURL" href="https://www.thethingsnetwork.org/docs/lorawan/frequencies-by-country.html">https://www.thethingsnetwork.org/docs/lorawan/frequencies-by-country.html</a>.</p>&#13;
			<p>&#13;
				Finally, you need to download and install the Arduino library, which can be found at <a class="LinkURL" href="https://github.com/sandeepmistry/arduino-LoRa/archive/master.zip">https://github.com/sandeepmistry/arduino-LoRa/archive/master.zip</a>.</p>&#13;
			<h2 class="HeadProject" id="h1-500587c16-0004"><span>Project #47: Remote Control over LoRa Wireless</span></h2>&#13;
			<p class="BodyFirst">This project will demonstrate simple data transmission from one LoRA-equipped Arduino to another to allow remote control of a digital output pin. Our transmitter has two buttons to turn the receiver circuit’s output pin on and off.</p>&#13;
			<h3 id="h2-500587c16-0007">The Transmitter Circuit Hardware</h3>&#13;
			<p class="BodyFirst">The following hardware is required for the transmitter circuit:</p>&#13;
			<ul>&#13;
				<li>Arduino and USB cable</li>&#13;
				<li>LoRa shield for Arduino</li>&#13;
				<li>Two 10 kΩ resistors (R1 and R2)</li>&#13;
				<li>Two 100 nF capacitors (C1 and C2)</li>&#13;
				<li>Two push buttons</li>&#13;
				<li>&#13;
					AA battery holder and wiring (as used in <span class="xref" itemid="xref_target_Chapter 14">Chapter 14</span>)</li>&#13;
			</ul>&#13;
			<h3 id="h2-500587c16-0008">The Transmitter Schematic</h3>&#13;
			<p class="BodyFirst">The transmitter circuit, as shown in <a href="#figure16-8" id="figureanchor16-8">Figure 16-8</a>, consists of two push buttons with debounce circuitry connected to digital pins 2 and 3. The LoRa shield is placed on the Arduino Uno. Once the sketch has been uploaded, power is provided by the AA battery holder and wiring.</p>&#13;
			<span epub:type="pagebreak" id="Page_300" title="300"/>&#13;
			<figure>&#13;
				<img alt="f16008" src="image_fi/500587c16/f16008.png"/>&#13;
				<figcaption>&#13;
					<p><a id="figure16-8">Figure 16-8</a>: Transmitter schematic for Project 47</p>&#13;
				</figcaption>&#13;
			</figure>&#13;
			<p>&#13;
				Before using your LoRa shield, there are three header jumpers, shown in <a href="#figure16-9" id="figureanchor16-9">Figure 16-9</a>, that need to be removed from the shield. If you don’t remove them, they will interfere with other digital pins. You can remove them completely or just connect the headers to one of the two pins.</p>&#13;
			<figure>&#13;
				<img alt="f16009" src="image_fi/500587c16/f16009.png"/>&#13;
				<figcaption>&#13;
					<p><a id="figure16-9">Figure 16-9</a>: Header jumpers to remove from the LoRa shield</p>&#13;
				</figcaption>&#13;
			</figure>&#13;
			<h3 id="h2-500587c16-0009"><span epub:type="pagebreak" id="Page_301" title="301"/>The Receiver Circuit Hardware</h3>&#13;
			<p class="BodyFirst">The following hardware is required for the receiver circuit:</p>&#13;
			<ul>&#13;
				<li>Arduino and USB cable</li>&#13;
				<li>LoRa shield for Arduino</li>&#13;
				<li>One LED</li>&#13;
				<li>One 560 Ω resistor (R1)</li>&#13;
			</ul>&#13;
			<h3 id="h2-500587c16-0010">The Receiver Schematic</h3>&#13;
			<p class="BodyFirst">The receiver circuit, shown in <a href="#figure16-10" id="figureanchor16-10">Figure 16-10</a>, consists of one LED and a current-limiting resistor connected between digital pin 7 and GND. We leave this connected to the PC via USB, so no external power is required.</p>&#13;
			<figure>&#13;
				<img alt="f16010" src="image_fi/500587c16/f16010.png"/>&#13;
				<figcaption>&#13;
					<p><a id="figure16-10">Figure 16-10</a>: Receiver schematic for Project 47</p>&#13;
				</figcaption>&#13;
			</figure>&#13;
			<h3 id="h2-500587c16-0011"><span epub:type="pagebreak" id="Page_302" title="302"/>The Transmitter Sketch</h3>&#13;
			<p class="BodyFirst">Now let’s examine the sketch for the transmitter. Enter and upload the following sketch to the Arduino with the transmitter circuit:</p>&#13;
			<pre><code>// Project 47 - Remote Control over LoRa Wireless, Transmitter Sketch<span aria-label="annotation1" class="CodeAnnotationHang">1</span> #define LORAFREQ (915000000L)<span aria-label="annotation2" class="CodeAnnotationHang">2</span> #include &lt;LoRa.h&gt;&#13;
#include &lt;SPI.h&gt;<span aria-label="annotation3" class="CodeAnnotationHang">3</span> void loraSend(int controlCode)&#13;
{<span aria-label="annotation4" class="CodeAnnotationHang">4</span>   LoRa.beginPacket();      // start sending data LoRa.print("ABC");       // "ABC" is our three-character code for receiver LoRa.print(controlCode); // send our instructions (controlCode codes)<span aria-label="annotation5" class="CodeAnnotationHang">5</span>   LoRa.endPacket();        // finished sending data<span aria-label="annotation5" class="CodeAnnotationHang">5</span>   LoRa.receive();          // start listening&#13;
}&#13;
void setup()&#13;
{ pinMode(4, INPUT);    // on button pinMode(3, INPUT);    // off button<span aria-label="annotation6" class="CodeAnnotationHang">6</span>   LoRa.begin(LORAFREQ); // start up LoRa at specified frequency&#13;
}&#13;
void loop()&#13;
{ // check for button presses to control receiver if (digitalRead(4) == HIGH) { loraSend(1); // '1' is code for turn receiver digital pin 5 HIGH delay(500);  // allow time to send } if (digitalRead(3) == HIGH) { loraSend(0); // '0' is code for turn receiver digital pin 5 LOW delay(500);  // allow time to send }&#13;
}</code></pre>&#13;
			<p>&#13;
				The operating frequency is selected at <span aria-label="annotation1" class="CodeAnnotation">1</span>. Our example is using 915 MHz, so you may need to change this to either <code>433000000L</code> or <code>868000000L</code> depending on your country and shield. We include the Arduino LoRa library at <span aria-label="annotation2" class="CodeAnnotation">2</span>, and it’s activated at <span aria-label="annotation4" class="CodeAnnotation">4</span>. The SPI library is also included, as the LoRa shield uses the SPI bus to communicate with the Arduino. At <span aria-label="annotation6" class="CodeAnnotation">6</span>, the LoRa transceiver is activated at the appropriate frequency, after the digital pins are prepared to be inputs for the buttons.</p>&#13;
			<p>&#13;
				At <span aria-label="annotation3" class="CodeAnnotation">3</span>, we have the custom function <code>loraSend(int controlCode)</code>. This is called when a button is pressed. It first sends a three-character code—in this case <code>ABC</code>—out on the LoRa airwaves, followed by a control code. The character code allows you to direct the control to a particular receiver circuit. Otherwise, if you’re using two or more receivers, there would be confusion as to which one would be controlled by the transmitter. You will see that the receiver will act only if <code>ABC</code> is sent. The control codes in our example are <code>1</code> and <code>0</code> (to turn the receiver’s digital output on or off, respectively).</p>&#13;
			<p><span epub:type="pagebreak" id="Page_303" title="303"/>At <span aria-label="annotation4" class="CodeAnnotation">4</span>, the LoRa module is switched to transmit mode, and then the character and control codes are sent over the airwaves. At <span aria-label="annotation5" class="CodeAnnotation">5</span>, the LoRa module is told to stop transmitting and gets switched back to receiving data. Once you have uploaded the transmitter sketch, the transmitter hardware can be disconnected from the computer and powered using the battery pack.</p>&#13;
			<h3 id="h2-500587c16-0012">The Receiver Sketch</h3>&#13;
			<p class="BodyFirst">Now let’s examine the receiver sketch. Enter and upload the following sketch to the Arduino with the receiver circuit:</p>&#13;
			<pre><code>// Project 47 - Remote Control over LoRa Wireless, Receiver Sketch<span aria-label="annotation1" class="CodeAnnotationHang">1</span> #define LORAFREQ (915000000L)<span aria-label="annotation2" class="CodeAnnotationHang">2</span> #include &lt;LoRa.h&gt;&#13;
#include &lt;SPI.h&gt;&#13;
void takeAction(int packetSize)&#13;
// things to do when data received over LoRa wireless&#13;
{<span aria-label="annotation3" class="CodeAnnotationHang">3</span>   char incoming[4] = ""; int k; for (int i = 0; i &lt; packetSize; i++) { k = i; if (k &gt; 6) { k = 6; // make sure we don't write past end of string } incoming[k] = (char)LoRa.read();<span aria-label="annotation4" class="CodeAnnotationHang">4</span>   } // check the three-character code sent from transmitter is correct<span aria-label="annotation5" class="CodeAnnotationHang">5</span>   if (incoming[0] != 'A') { return; // if not 'A', stop function and go back to void loop() }<span aria-label="annotation5" class="CodeAnnotationHang">5</span>   if (incoming[1] != 'B') { return; // if not 'B', stop function and go back to void loop() }<span aria-label="annotation5" class="CodeAnnotationHang">5</span>   if (incoming[2] != 'C') { return; // if not 'C', stop function and go back to void loop() } // If made it this far, correct code has been received from transmitter.  // Now to do something... if (incoming[3] == '1') { digitalWrite(7, HIGH); } if (incoming[3] == '0') { digitalWrite(7, LOW); }<span epub:type="pagebreak" id="Page_304" title="304"/>}&#13;
void setup()&#13;
{ pinMode(7, OUTPUT);<span aria-label="annotation6" class="CodeAnnotationHang">6</span>   LoRa.begin(LORAFREQ);       // start up LoRa at specified frequency<span aria-label="annotation7" class="CodeAnnotationHang">7</span>   LoRa.onReceive(takeAction); // call function "takeAction" when data received <span aria-label="annotation8" class="CodeAnnotationHang">8</span>   LoRa.receive();             // start receiving&#13;
}&#13;
void loop()&#13;
{&#13;
}</code></pre>&#13;
			<p>&#13;
				Once again we include the Arduino LoRa library at <span aria-label="annotation2" class="CodeAnnotation">2</span>, and it’s activated at <span aria-label="annotation6" class="CodeAnnotation">6</span>. The operating frequency is also selected at <span aria-label="annotation1" class="CodeAnnotation">1</span>. Our example is using 915 MHz, so you may need to change this to either <code>433000000L</code> or <code>868000000L</code> depending on your country and shield. The SPI library is also included, as the LoRa shield uses the SPI bus to communicate with the Arduino. At <span aria-label="annotation7" class="CodeAnnotation">7</span>, we tell the sketch to run a certain function—in this case <code>void takeAction()</code>—when data is received over the airwaves. Then at <span aria-label="annotation8" class="CodeAnnotation">8</span>, the LoRa module is switched to receive mode.</p>&#13;
			<p>&#13;
				When operating, the receiver simply waits for data to be received by the LoRa module. At that point, the function <code>takeAction()</code> is called. This takes each character of data from the transmitter and places it into an array of characters called <code>incoming[4]</code> between <span aria-label="annotation3" class="CodeAnnotation">3</span> and <span aria-label="annotation4" class="CodeAnnotation">4</span>. Next, the receiver checks each character of the code (in our case <code>ABC</code>) at <span aria-label="annotation5" class="CodeAnnotation">5</span> to ensure the transmission is for this particular receiver. Finally, if this is successful, the control character is checked. If it’s a <code>1</code>, digital pin 7 is set to <code>HIGH</code>, and if it’s a <code>0</code>, digital pin 7 is set to <code>LOW</code>.</p>&#13;
			<p>Now you have the basic framework for a longer-distance remote control. Furthermore, by assigning different character codes to multiple receivers, you can expand your system to control more than one receiver unit from one transmitter.</p>&#13;
			<p>However, for serious applications, you may want confirmation that an instruction from the transmitter has been successfully completed by the receiver, so we’ll add a confirmation function in the next project.</p>&#13;
			<h2 class="HeadProject" id="h1-500587c16-0005"><span>Project #48: Remote Control over LoRa Wireless with Confirmation</span></h2>&#13;
			<p class="BodyFirst">This project adds a confirmation system to the receiver-transmitter setup created in Project 47, creating a two-way data system. An LED on the transmitter circuit will turn on when the receiver output is set to <code>HIGH</code> and turn off when the receiver output is set to <code>LOW</code>.</p>&#13;
			<h3 id="h2-500587c16-0013">The Transmitter Circuit Hardware</h3>&#13;
			<p class="BodyFirst">The following hardware is required for the transmitter circuit:</p>&#13;
			<ul>&#13;
				<li>Arduino and USB cable</li>&#13;
				<li>LoRa Shield for Arduino</li>&#13;
				<li><span epub:type="pagebreak" id="Page_305" title="305"/>Two 10 kΩ resistors (R1 and R2)</li>&#13;
				<li>One 560 Ω resistor (R3)</li>&#13;
				<li>One LED</li>&#13;
				<li>Two 100 nF capacitors (C1 and C2)</li>&#13;
				<li>Two push buttons</li>&#13;
				<li>&#13;
					AA battery holder and wiring (as used in <span class="xref" itemid="xref_target_Chapter 14">Chapter 14</span>)</li>&#13;
			</ul>&#13;
			<h3 id="h2-500587c16-0014">The Transmitter Schematic</h3>&#13;
			<p class="BodyFirst">The transmitter circuit, shown in <a href="#figure16-11" id="figureanchor16-11">Figure 16-11</a>, consists of two push buttons with debounce circuitry connected to digital pins 3 and 4, and an LED and current-limiting resistor on digital pin 6. The LoRa shield is placed on the Arduino Uno. Once the sketch has been uploaded, power is provided by the AA battery holder and wiring.</p>&#13;
			<figure>&#13;
				<img alt="f16011" src="image_fi/500587c16/f16011.png"/>&#13;
				<figcaption>&#13;
					<p><a id="figure16-11">Figure 16-11</a>: Transmitter schematic for Project 48</p>&#13;
				</figcaption>&#13;
			</figure>&#13;
			<p>The receiver circuit and schematic for this project are identical to those used for Project 47.</p>&#13;
			<h3 id="h2-500587c16-0015"><span epub:type="pagebreak" id="Page_306" title="306"/>The Transmitter Sketch</h3>&#13;
			<p class="BodyFirst">Now let’s examine the sketch for the transmitter. Enter and upload the following sketch to the Arduino with the transmitter circuit:</p>&#13;
			<pre><code>// Project 48 - Remote Control over LoRa Wireless with Confirmation, &#13;
// Transmitter Sketch&#13;
#define LORAFREQ (915000000L)&#13;
#include &lt;SPI.h&gt;&#13;
#include &lt;LoRa.h&gt;&#13;
void loraSend(int controlCode)&#13;
{ LoRa.beginPacket(); // start sending data LoRa.print("DEF");  // "DEF" is our three-character code for the receiver.  // Needs to be matched on RX. LoRa.print(controlCode); // send our instructions (controlCode codes) LoRa.endPacket();   // finished sending data LoRa.receive();     // start listening&#13;
}<span aria-label="annotation1" class="CodeAnnotationHang">1</span> void takeAction(int packetSize)&#13;
// things to do when data received over LoRa wireless&#13;
{ char incoming[4] = ""; int k; for (int i = 0; i &lt; packetSize; i++) { k = i; if (k &gt; 6) { k = 18; // make sure we don't write past end of string } incoming[k] = (char)LoRa.read(); } // check the three-character code sent from receiver is correct if (incoming[0] != 'D') { return; // if not 'D', stop function and go back to void loop() } if (incoming[1] != 'E') { return; // if not 'E', stop function and go back to void loop() } if (incoming[2] != 'F') { return; // if not 'F', stop function and go back to void loop() } // If made it this far, correct code has been received from receiver.  // Now to do something...<span aria-label="annotation2" class="CodeAnnotationHang">2</span>   if (incoming[3] == '1') { digitalWrite(6, HIGH); // receiver has turned output on and has sent a signal confirming this }<span aria-label="annotation2" class="CodeAnnotationHang">2</span>   if (incoming[3] == '0')<span epub:type="pagebreak" id="Page_307" title="307"/>  { digitalWrite(6, LOW); // receiver has turned output off and has sent a signal confirming this }&#13;
}&#13;
void setup()&#13;
{ pinMode(4, INPUT);          // on button pinMode(3, INPUT);          // off button pinMode(6, OUTPUT);         // status LED LoRa.begin(LORAFREQ);       // start up LoRa at specified frequency LoRa.onReceive(takeAction); // call function "takeAction" when data received // over LoRa wireless&#13;
}&#13;
void loop()&#13;
{ // check for button presses to control receiver if (digitalRead(4) == HIGH) { loraSend(1); // '1' is code for turn receiver digital pin 7 HIGH delay(500);  // button debounce } if (digitalRead(3) == HIGH) { loraSend(0); // '0' is code for turn receiver digital pin 7 LOW delay(500);  // button debounce }&#13;
}</code></pre>&#13;
			<p>Our transmitter circuit operates in the same way as in Project 47, by first sending a character code for identification and then a control code to turn the receiver’s output on or off. In this project, however, the transmitter listens for a signal from the receiver, and once the receiver has completed the control instruction from the transmitter, the receiver sends a character code and control code back to the transmitter.</p>&#13;
			<p>&#13;
				So at <span aria-label="annotation1" class="CodeAnnotation">1</span>, we have a new function, <code>takeAction()</code>, that checks for the character code <code>DEF</code> from the receiver circuit. The receiver then sends a <code>1</code> if it has turned on its output pin or a <code>0</code> if the output has been turned off. Our transmitter circuit can then display this status by controlling the LED on digital pin 6 via the code at <span aria-label="annotation2" class="CodeAnnotation">2</span>.</p>&#13;
			<h3 id="h2-500587c16-0016">The Receiver Sketch</h3>&#13;
			<p class="BodyFirst">Finally, let’s examine the sketch for the receiver. Enter and upload the following sketch to the Arduino with the receiver circuit:</p>&#13;
			<pre><code>// Project 48 - Remote Control over LoRa Wireless with Confirmation, Receiver &#13;
// Sketch&#13;
#define LORAFREQ (915000000L)&#13;
#include &lt;SPI.h&gt;&#13;
#include &lt;LoRa.h&gt;&#13;
void loraSend(int controlCode)<span epub:type="pagebreak" id="Page_308" title="308"/>{ LoRa.beginPacket();      // start sending data LoRa.print("DEF");       // "DEF" is our three-character code for the // transmitter LoRa.print(controlCode); // send our instructions (controlCode codes) LoRa.endPacket();        // finished sending data LoRa.receive();          // start listening&#13;
}&#13;
void takeAction(int packetSize)&#13;
// things to do when data received over LoRa wireless&#13;
{ char incoming[4] = ""; int k; for (int i = 0; i &lt; packetSize; i++) { k = i; if (k &gt; 6) { k = 18; // make sure we don't write past end of string } incoming[k] = (char)LoRa.read(); } // check the three-character code sent from transmitter is correct if (incoming[0] != 'A') { return; // if not 'A', stop function and go back to void loop() } if (incoming[1] != 'B') { return; // if not 'B', stop function and go back to void loop() } if (incoming[2] != 'C') { return; // if not 'C', stop function and go back to void loop() } // If made it this far, correct code has been received from transmitter.  // Now to do something... if (incoming[3] == '1') { digitalWrite(7, HIGH);<span aria-label="annotation1" class="CodeAnnotationHang">1</span>     loraSend(1); // tell the transmitter that the output has been turned on } if (incoming[3] == '0') { digitalWrite(7, LOW);<span aria-label="annotation1" class="CodeAnnotationHang">1</span>     loraSend(0); // tell the transmitter that the output has been turned off }&#13;
}&#13;
void setup()&#13;
{ pinMode(7, OUTPUT); LoRa.begin(LORAFREQ);       // start up LoRa at specified frequency LoRa.onReceive(takeAction); // call function "takeAction" when data received // over LoRa wireless<span epub:type="pagebreak" id="Page_309" title="309"/>  LoRa.receive(); // start receiving&#13;
}&#13;
void loop()&#13;
{&#13;
}</code></pre>&#13;
			<p>&#13;
				Our receiver operates in the same manner as the one for Project 47, except in this case, the receiver sends back the character code <code>DEF</code> to the transmitter, followed by a <code>1</code> or a <code>0</code> to indicate that the output pin has been turned on or off. This is done at <span aria-label="annotation1" class="CodeAnnotation">1</span> using the <code>loraSend()</code> function.</p>&#13;
			<p>At this point, you have two example projects that show how you can not only control digital output pins wirelessly across a greater distance than with the earlier projects but also confirm that the actions have taken place. You can now expand on these examples to create your own remote-control projects. But next, we’ll experiment with sending sensor data over a LoRa wireless link with Project 49.</p>&#13;
			<h2 class="HeadProject" id="h1-500587c16-0006"><span>Project #49: Sending Remote Sensor Data Using LoRa Wireless</span></h2>&#13;
			<p class="BodyFirst">This project builds on our previous efforts by using your computer to request temperature data from a remote sensor.</p>&#13;
			<h3 id="h2-500587c16-0017">The Transmitter Circuit Hardware</h3>&#13;
			<p class="BodyFirst">The following hardware is required for the transmitter circuit:</p>&#13;
			<ul>&#13;
				<li>Arduino and USB cable</li>&#13;
				<li>LoRa shield for Arduino</li>&#13;
			</ul>&#13;
			<p>This project uses the Serial Monitor on your PC for control, so the transmitter circuit is simply the Arduino and LoRa shield connected to the PC via the USB cable.</p>&#13;
			<h3 id="h2-500587c16-0018">The Receiver Circuit Hardware</h3>&#13;
			<p class="BodyFirst">The following hardware is required for the receiver circuit:</p>&#13;
			<ul>&#13;
				<li>Arduino and USB cable</li>&#13;
				<li>LoRa shield for Arduino</li>&#13;
				<li>TMP36 temperature sensor</li>&#13;
				<li>Solderless breadboard</li>&#13;
				<li>External power for Arduino</li>&#13;
				<li>Male-to-male jumper wires</li>&#13;
			</ul>&#13;
			<h3 id="h2-500587c16-0019">The Receiver Schematic</h3>&#13;
			<p class="BodyFirst">Our circuit is simply the TMP36 temperature sensor connected to analog pin A0, along with the LoRa shield placed on the Arduino, as shown in <a href="#figure16-12" id="figureanchor16-12">Figure 16-12</a>.</p>&#13;
			<span epub:type="pagebreak" id="Page_310" title="310"/>&#13;
			<figure>&#13;
				<img alt="f16012" src="image_fi/500587c16/f16012.png"/>&#13;
				<figcaption>&#13;
					<p><a id="figure16-12">Figure 16-12</a>: Receiver schematic for Project 49</p>&#13;
				</figcaption>&#13;
			</figure>&#13;
			<p>The receiver circuit may be some distance from the computer, so you can harness a USB power supply or the battery solution used in earlier projects.</p>&#13;
			<h3 id="h2-500587c16-0020">The Transmitter Sketch</h3>&#13;
			<p class="BodyFirst">Now let’s examine the sketch for the transmitter. Enter and upload the following sketch to the Arduino with the transmitter circuit:</p>&#13;
			<pre><code>// Project 49 - Sending Remote Sensor Data Using LoRa Wireless, Transmitter &#13;
// Sketch&#13;
#define LORAFREQ (915000000L)&#13;
#include &lt;SPI.h&gt;&#13;
#include &lt;LoRa.h&gt;&#13;
char command;&#13;
void loraSend(int controlCode)&#13;
{ LoRa.beginPacket();      // start sending data<span aria-label="annotation1" class="CodeAnnotationHang">1</span>   LoRa.print("ABC");       // "ABC" is our three-character code for the // transmitter LoRa.print(controlCode); // send our instructions (controlCode codes) LoRa.endPacket();        // finished sending data LoRa.receive();          // start listening&#13;
}&#13;
void takeAction(int packetSize)&#13;
// send text received from sensor Arduino via LoRa to Serial Monitor<span epub:type="pagebreak" id="Page_311" title="311"/>{ char incoming[31] = ""; int k; for (int i = 0; i &lt; packetSize; i++) { k = i; if (k &gt; 31) { k = 31; // make sure we don't write past end of string } incoming[k] = (char)LoRa.read(); Serial.print(incoming[k]); // display temp information from sensor board } Serial.println();&#13;
}&#13;
void setup()&#13;
{<span aria-label="annotation2" class="CodeAnnotationHang">2</span>   LoRa.begin(LORAFREQ);       // start up LoRa at specified frequency LoRa.onReceive(takeAction); // call function "takeAction" when data received // over LoRa wireless LoRa.receive();             // start receiving Serial.begin(9600);&#13;
}&#13;
void loop()&#13;
{<span aria-label="annotation3" class="CodeAnnotationHang">3</span>   Serial.print("Enter 1 for Celsius or 2 for Fahrenheit then Enter: "); Serial.flush(); // clear any "junk" out of the serial buffer before waiting<span aria-label="annotation4" class="CodeAnnotationHang">4</span>   while (Serial.available() == 0) { // do nothing until something enters the serial buffer } while (Serial.available() &gt; 0) { command = Serial.read() - '0'; // read the number in the serial buffer, // remove the ASCII text offset for zero: '0' } Serial.println();<span aria-label="annotation5" class="CodeAnnotationHang">5</span>   loraSend(command); delay(2000);&#13;
}</code></pre>&#13;
			<p>&#13;
				As with the earlier projects in this chapter, we initialize the LoRa hardware and the Serial Monitor at <span aria-label="annotation2" class="CodeAnnotation">2</span>. However, instead of hardware buttons, we use the Serial Monitor to accept commands from the user and send those to the receiver hardware. In this project, the user is prompted to enter <code>1</code> or <code>2</code> in the Serial Monitor’s input box to retrieve the temperature from the receiver hardware in Celsius or Fahrenheit, respectively. This happens at <span aria-label="annotation3" class="CodeAnnotation">3</span>. The computer waits for user input at <span aria-label="annotation4" class="CodeAnnotation">4</span>, then sends out either command to the receiver hardware via <code>loraSend()</code> at <span aria-label="annotation5" class="CodeAnnotation">5</span>. Again, we use a three-character code to keep the transmission exclusively for the receiver board at <span aria-label="annotation1" class="CodeAnnotation">1</span>.</p>&#13;
			<h3 id="h2-500587c16-0021"><span epub:type="pagebreak" id="Page_312" title="312"/>The Receiver Sketch</h3>&#13;
			<p class="BodyFirst">Now let’s examine the sketch for the receiver. Enter and upload the following sketch to the Arduino with the receiver circuit:</p>&#13;
			<pre><code>// Project 49 - Sending Remote Sensor Data Using LoRa Wireless, Receiver&#13;
// Sketch&#13;
#define LORAFREQ (915000000L)&#13;
#include &lt;SPI.h&gt;&#13;
#include &lt;LoRa.h&gt;&#13;
float sensor = 0;&#13;
float voltage = 0;&#13;
float celsius = 0;&#13;
float fahrenheit = 0;&#13;
void loraSendC()&#13;
{ LoRa.beginPacket(); // start sending data sensor = analogRead(0); voltage = ((sensor * 5000) / 1024); voltage = voltage - 500; celsius = voltage / 10; fahrenheit = ((celsius * 1.8) + 32);<span aria-label="annotation1" class="CodeAnnotationHang">1</span>   LoRa.print("Temperature: "); LoRa.print(celsius, 2); LoRa.print(" degrees C");<span aria-label="annotation2" class="CodeAnnotationHang">2</span>   LoRa.endPacket(); // finished sending data LoRa.receive();   // start listening&#13;
}&#13;
void loraSendF()&#13;
// send temperature in Fahrenheit&#13;
{ LoRa.beginPacket(); // start sending data sensor = analogRead(0); voltage = ((sensor * 5000) / 1024); voltage = voltage - 500; celsius = voltage / 10; fahrenheit = ((celsius * 1.8) + 32);<span aria-label="annotation1" class="CodeAnnotationHang">1</span>   LoRa.print("Temperature: "); LoRa.print(fahrenheit, 2); LoRa.print(" degrees F");<span aria-label="annotation2" class="CodeAnnotationHang">2</span>   LoRa.endPacket(); // finished sending data LoRa.receive();   // start listening&#13;
}&#13;
void takeAction(int packetSize)&#13;
// things to do when data received over LoRa wireless&#13;
{ char incoming[6] = ""; int k; for (int i = 0; i &lt; packetSize; i++) { k = i; if (k &gt; 6)<span epub:type="pagebreak" id="Page_313" title="313"/>    { k = 6; // make sure we don't write past end of string } incoming[k] = (char)LoRa.read(); }<span aria-label="annotation3" class="CodeAnnotationHang">3</span>   // check the three-character code sent from transmitter is correct if (incoming[0] != 'A') { return; // if not 'A', stop function and go back to void loop() } if (incoming[1] != 'B') { return; // if not 'B', stop function and go back to void loop() } if (incoming[2] != 'C') { return; // if not 'C', stop function and go back to void loop() } // If made it this far, correct code has been received from transmitter  if (incoming[3] == '1') {<span aria-label="annotation4" class="CodeAnnotationHang">4</span>     loraSendC(); } if (incoming[3] == '2') {<span aria-label="annotation5" class="CodeAnnotationHang">5</span>     loraSendF(); }&#13;
}&#13;
void setup()&#13;
{ LoRa.begin(LORAFREQ);       // start up LoRa at specified frequency LoRa.onReceive(takeAction); // call function "takeAction" when data received  LoRa.receive();             // start receiving&#13;
}&#13;
void loop()&#13;
{&#13;
}</code></pre>&#13;
			<p>&#13;
				Using the same method as in Project 48, our receiver hardware decodes the transmission from the transmitter to ensure the data is meant for it by checking the character code sent at <span aria-label="annotation3" class="CodeAnnotation">3</span>. If this is correct, the receiver board calls one of either <code>loraSendC()</code> or <code>loraSendF()</code> at <span aria-label="annotation4" class="CodeAnnotation">4</span> or <span aria-label="annotation5" class="CodeAnnotation">5</span>, respectively. Those two functions calculate the temperature from the TMP36 sensor and, between <span aria-label="annotation1" class="CodeAnnotation">1</span> and <span aria-label="annotation2" class="CodeAnnotation">2</span>, send a string of text back to the transmitter board containing the temperature and measurement type.</p>&#13;
			<p>&#13;
				Once you have assembled the hardware for both circuits and uploaded both sketches, place the powered receiver circuit (with the sensor) where you’d like to measure temperature from your computer. Ensure the transmitter circuit is connected to the computer. Open the Serial Monitor in the IDE and follow the instructions to check the temperature. An example is shown in <a href="#figure16-13" id="figureanchor16-13">Figure 16-13</a>.</p>&#13;
				<span epub:type="pagebreak" id="Page_314" title="314"/>&#13;
				<figure>&#13;
				<img alt="f16013" src="image_fi/500587c16/f16013.png"/>&#13;
				<figcaption>&#13;
					<p><a id="figure16-13">Figure 16-13</a>: Example output for Project 49</p>&#13;
				</figcaption>&#13;
			</figure>&#13;
			<h2 id="h1-500587c16-0007">Looking Ahead</h2>&#13;
			<p class="BodyFirst">This chapter showed how simple it is to control multi-Arduino systems remotely. For example, you can control digital outputs by sending characters from one Arduino to another, and you can use LoRa wireless technology to create more complex, multi-Arduino control systems that include data return. With the knowledge you’ve gained so far, many creative options are available to you.</p>&#13;
			<p>But there’s still much more to investigate in terms of wireless data transmission, so keep reading and working along with the examples as you learn to use simple television remote controls with the Arduino in the next chapter.</p>&#13;
		</section>&#13;
	</body></html>