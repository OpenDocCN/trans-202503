<html><head></head><body><section class="chapter" title="Chapter&#xA0;3.&#xA0;Integrating Charts on a Page" epub:type="chapter" id="integrating_charts_on_a_page"><div class="titlepage"><div><div><h2 class="title">Chapter 3. Integrating Charts on a Page</h2></div></div></div><p>You might expect a data visualization for the Web to be featured very prominently on the page, or even make up the entire web page. That’s not always the right approach, though. The best visualizations are effective because they help the user understand the data, not because they “look pretty” on the page.</p><p><a id="iddle1953" class="indexterm"/><a id="iddle2084" class="indexterm"/><a id="iddle2125" class="indexterm"/>Some data may be straightforward enough to present without context, but meaningful data probably isn’t. And if our presentation requires context, its visualizations are likely sharing the page with other content. When we design web pages, we should take care to balance any individual component with the page as a whole. If a single visualization is not the entire story, it shouldn’t take up all (or even most) of the space on the page. It can be challenging, however, to minimize the space a traditional chart requires. There are, after all, axes, labels, titles, legends, and more to place.</p><p>Edward Tufte considered this problem in his groundbreaking work <span class="emphasis"><em>The Visual Display of Quantitative Information</em></span> (Graphics Press, 1983), and he proposed a novel solution he called sparklines. <span class="emphasis"><em>Sparklines</em></span> are charts stripped to their bare essentials, presented without the aforementioned elements we often see in a chart. Sparklines can present a lot of information in very little space, even to the point where it is possible to include a chart right in the middle of a sentence. There is no need for “See figure below” or “Click for larger view.” One of Tufte’s earliest examples presents the glucose level of a medical patient; <a class="xref" href="ch03.html#tufteapostrophes_classic_sparkline_examp" title="Figure 3-1. Tufte’s classic sparkline example shows a lot of information in a small space.">Figure 3-1</a> shows a reproduction.</p><div class="figure"><a id="tufteapostrophes_classic_sparkline_examp"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00044"/><img src="figs/web/03fig01.png.jpg" alt="Tufte’s classic sparkline example shows a lot of information in a small space."/></div></div><div class="figure-title">Figure 3-1. Tufte’s classic sparkline example shows a lot of information in a small space.</div></div><p>In a mere 154×20 pixels, we’ve shown the patient’s current glucose level, its trend for more than two months, high and low values, and the range of normal values. This high information density makes sparklines effective anytime space is a premium—inline in textual paragraphs, as cells in tables, or as part of information dashboards. Sparklines do have disadvantages, of course. They cannot provide as much fine-grained detail as a full-size chart with axes and labels. They also cannot support significant interactivity, so we can’t give users a lot of flexibility in selecting data or zooming in for detail. But for many visualizations, these aren’t major concerns. Plus, as we’ll see in this chapter’s examples, the Web gives us the chance to augment sparklines in ways that aren’t possible in print. There are a few JavaScript libraries and toolkits for creating sparklines, but we’ll focus on the most popular of them: jQuery sparklines (<span class="emphasis"><em><a class="ulink" href="http://omnipotent.net/jquery.sparkline/" target="_top">http://omnipotent.net/jquery.sparkline/</a></em></span>). As the name implies, this open source library is an extension to jQuery. The examples in this chapter look closely at how to use these tools to incorporate dense visualizations into your web page. Here’s what you’ll learn:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>How to create a classic sparkline for integration directly into text</p></li><li class="listitem"><p>How to combine multiple sparklines to show comparisons</p></li><li class="listitem"><p>How to annotate sparklines with additional details</p></li><li class="listitem"><p>How to create composite charts</p></li><li class="listitem"><p>How to respond to click events on the page</p></li><li class="listitem"><p>How to update charts in real time</p></li></ul></div><div class="sect1" title="Creating a Classic Sparkline"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="creating_a_classic_sparkline">Creating a Classic Sparkline</h2></div></div></div><p><a id="iddle1950" class="indexterm"/><a id="iddle1952" class="indexterm"/>As later examples will demonstrate, the sparklines library is both flexible and powerful, and we can use it in many different contexts. As a start, though, we’ll use the library to create a sparkline exactly as Edward Tufte first defined it. The process is quite straightforward and takes only four simple steps.</p><div class="sect2" title="Step 1: Include the Required JavaScript Libraries"><div class="titlepage"><div><div><h3 class="title" id="step_1_include_the_required_java-id00012">Step 1: Include the Required JavaScript Libraries</h3></div></div></div><p>Since we’re using the jQuery sparklines library to create the chart, we need to include that library in our web pages, along with jQuery. Both jQuery and sparklines are available on public CDNs. For this example (and the others in this chapter), we’ll use the CloudFlare CDN. For some notes on the advantages and disadvantages of using CDNs, see <a class="xref" href="ch02.html#step_1_include_the_required_javascript_l" title="Step 1: Include the Required JavaScript Libraries">Step 1: Include the Required JavaScript Libraries</a>.</p><p>Here’s the skeleton with which we start:</p><a id="pro_id00114"/><pre class="programlisting">   <span class="dodgerblue">&lt;!DOCTYPE</span> html<span class="dodgerblue">&gt;</span>
   <span class="steelblue"><span class="strong"><strong>&lt;html</strong></span></span> <span class="steelblue">lang=</span><span class="maroon">"en"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;head&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;meta</strong></span></span> <span class="steelblue">charset=</span><span class="maroon">"utf-8"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;title&gt;&lt;/title&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;/head&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;body&gt;</strong></span></span>
       <span class="indianred"><span class="emphasis"><em>&lt;!-- Content goes here --&gt;</em></span></span>
➊     <span class="indianred"><span class="emphasis"><em>&lt;!--[if lt IE 9]&gt;&lt;script src="js/excanvas.min.js"&gt;&lt;/script&gt;&lt;![endif]--&gt;</em></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"//cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;/script&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"//cdnjs.cloudflare.com/ajax/libs/jquery-sparklines/2.0.0/</span>
   <span class="maroon">jquery.sparkline.min.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
     <span class="steelblue"><span class="strong"><strong>&lt;/body&gt;</strong></span></span>
   <span class="steelblue"><span class="strong"><strong>&lt;/html&gt;</strong></span></span></pre><p>As you can see, we’re including the JavaScript libraries at the end of the document. This approach lets the browser load all of the document’s HTML markup and begin laying out the page while waiting for the server to provide the JavaScript libraries.</p><p>In addition to the jQuery library, sparklines rely on the HTML <span class="emphasis"><em>canvas</em></span> feature. Since Internet Explorer didn’t support canvas until version 9, we use some special markup at ➊ to ensure that IE 8 and earlier will load an additional library (excanvas .min.js), just like we did in <a class="xref" href="ch02.html" title="Chapter 2. Making Charts Interactive">Chapter 2</a>.</p></div><div class="sect2" title="Step 2: Create the HTML Markup for the Sparkline"><div class="titlepage"><div><div><h3 class="title" id="step_2_create_the_html_markup_for_the_sp">Step 2: Create the HTML Markup for the Sparkline</h3></div></div></div><p>Because we’re closely integrating the sparkline chart with other elements, we simply use a <code class="literal">&lt;span&gt;</code> tag to hold the HTML markup for our visualization, rather than using a <code class="literal">&lt;div&gt;</code>. In addition to the chart itself, we include the final value and a label as standard HTML. Here is the HTML for the glucose sparkline:</p><a id="pro_id00115"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;p&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;span</strong></span></span> <span class="steelblue">class=</span><span class="maroon">"sparkline"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    170,134,115,128,168,166,122,81,56,39,97,114,114,130,151,
    184,148,145,134,145,145,145,143,148,224,181,112,111,129,
    151,131,131,131,114,112,112,112,124,187,202,200,203,237,
    263,221,197,184,185,203,290,330,330,226,113,148,169,148,
    78,96,96,96,77,59,22,22,70,110,128
  <span class="steelblue"><span class="strong"><strong>&lt;/span&gt;</strong></span></span>
  128 Glucose
<span class="steelblue"><span class="strong"><strong>&lt;/p&gt;</strong></span></span></pre><p><a id="iddle1475" class="indexterm"/><a id="iddle1944" class="indexterm"/>Compared to other visualizations, two characteristics of our sparkline chart are unusual.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>We include the data right in the HTML itself, not in the JavaScript that creates the chart.</p></li><li class="listitem"><p>The <code class="literal">&lt;span&gt;</code> for the chart does not have a unique <code class="literal">id</code> attribute.</p></li></ul></div><p>Both of these differences are optional; we could construct the chart as in other visualizations by passing data to a JavaScript function and identifying its container with a unique <code class="literal">id</code>. For sparklines, however, the approach we’re using here often makes more sense. By including the chart data directly in the HTML, we can easily see the data’s relation to other content on the page. It’s clear, for example, that the final value of our chart (<code class="literal">128</code>) is the same as the value we’re using for the label. If we had made a mistake and used a different value for the label, the error would be much easier to spot and correct. Using a common <code class="literal">class</code> for all sparklines instead of unique <code class="literal">id</code>s simplifies how we might use the library to create multiple charts on one page. With unique <code class="literal">id</code>s, we would have to call a library function for every chart. With a common <code class="literal">class</code>, on the other hand, we need only call a single library function to create multiple charts. That’s especially helpful when a web page contains a lot of sparklines.</p></div><div class="sect2" title="Step 3: Draw the Sparkline"><div class="titlepage"><div><div><h3 class="title" id="step_3_draw_the_sparkline">Step 3: Draw the Sparkline</h3></div></div></div><p>Now that we’ve included the necessary libraries and set up our HTML, it’s remarkably easy to draw the charts. In fact, a single line of JavaScript is sufficient. We simply select the containing element(s) using jQuery—<code class="literal">$(".sparkline")</code>—and call the sparklines plug-in.</p><a id="pro_id00116"/><pre class="programlisting"><span class="olive">$</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {
    <span class="olive">$</span>(<span class="maroon">".sparkline"</span>).<span class="olive">sparkline</span>();
}</pre><p>As you can see in <a class="xref" href="ch03.html#default_sparkline_options_differ_slightl" title="Figure 3-2. The default sparkline options differ slightly from the classic example.">Figure 3-2</a>, the sparklines library creates a standard sparkline from our data.</p><div class="figure"><a id="default_sparkline_options_differ_slightl"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00045"/><img src="figs/web/03fig02.png.jpg" alt="The default sparkline options differ slightly from the classic example."/></div></div><div class="figure-title">Figure 3-2. The default sparkline options differ slightly from the classic example.</div></div><p><a id="iddle1341" class="indexterm"/><a id="iddle1614" class="indexterm"/><a id="iddle1927" class="indexterm"/><a id="iddle2085" class="indexterm"/>The library’s default options differ from Tufte’s classic sparkline in color, chart type, and density. We’ll tweak those next.</p></div><div class="sect2" title="Step 4: Adjust the Chart Style"><div class="titlepage"><div><div><h3 class="title" id="step_4_adjust_the_chart_style">Step 4: Adjust the Chart Style</h3></div></div></div><p>To make our sparkline match Tufte’s definition exactly, we can specify new values for some of the default options. To pass these options to sparklines, we construct a JavaScript object and include it as the second parameter in the <code class="literal">sparkline</code> function call. The function’s first parameter is the data itself, which here we specify with <code class="literal">"html"</code> because our data is included in the HTML markup.</p><a id="pro_id00117"/><pre class="programlisting">   <span class="olive">$</span>(<span class="maroon">".sparkline"</span>).<span class="olive">sparkline</span>(<span class="maroon">"html"</span>,{
➊     <span class="dodgerblue">lineColor</span>: <span class="maroon">"dimgray"</span>,
➋     <span class="dodgerblue">fillColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
➌     <span class="dodgerblue">defaultPixelsPerValue</span>: <span class="red">1</span>,
➍     <span class="dodgerblue">spotColor</span>: <span class="maroon">"red"</span>,
       <span class="dodgerblue">minSpotColor</span>: <span class="maroon">"red"</span>,
       <span class="dodgerblue">maxSpotColor</span>: <span class="maroon">"red"</span>,
➎     <span class="dodgerblue">normalRangeMin</span>: <span class="red">82</span>,
       <span class="dodgerblue">normalRangeMax</span>: <span class="red">180</span>,
   });</pre><p>To complete our transformation to Tufte’s original, we can style the HTML content as well. Making the final value the same color as the key data points clarifies that connection, and making the chart label bold emphasizes it as a title.</p><a id="pro_id00118"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;p&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;span</strong></span></span> <span class="steelblue">class=</span><span class="maroon">"sparkline"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    170,134,115,128,168,166,122,81,56,39,97,114,114,130,151,
    184,148,145,134,145,145,145,143,148,224,181,112,111,129,
    151,131,131,131,114,112,112,112,124,187,202,200,203,237,
    263,221,197,184,185,203,290,330,330,226,113,148,169,148,
    78,96,96,96,77,59,22,22,70,110,128
  <span class="steelblue"><span class="strong"><strong>&lt;/span&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;span</strong></span></span> <span class="steelblue">style=</span><span class="maroon">"color:red"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span> 128 <span class="steelblue"><span class="strong"><strong>&lt;/span&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;strong&gt;</strong></span></span> Glucose <span class="steelblue"><span class="strong"><strong>&lt;/strong&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/p&gt;</strong></span></span></pre><p>Let’s walk through the changes we just made:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Tufte’s classic sparklines are black and white except for key data points (minimum, maximum, and final values). His color scheme adds extra emphasis to those points. To change the library’s default (blue), we can set a <code class="literal">lineColor</code>. For screen displays, we might choose a dark gray rather than pure black. That’s what we’re using at ➊.</p></li><li class="listitem"><p>Tufte doesn’t fill the area below the line so that he can use shading to indicate a normal range. To eliminate the library’s light blue shading, we set <code class="literal">fillColor</code> to <code class="literal">false</code> ➋.</p></li><li class="listitem"><p><a id="iddle1253" class="indexterm"/><a id="iddle1670" class="indexterm"/><a id="iddle1678" class="indexterm"/><a id="iddle1711" class="indexterm"/><a id="iddle1918" class="indexterm"/><a id="iddle1935" class="indexterm"/><a id="iddle1940" class="indexterm"/><a id="iddle1941" class="indexterm"/><a id="iddle1964" class="indexterm"/><a id="iddle1989" class="indexterm"/><a id="iddle2118" class="indexterm"/>By default, the library uses 3 pixels as the width for each data point. To maximize information density, Tufte would likely suggest using only a single pixel. Setting the <code class="literal">defaultPixelsPerValue</code> option at ➌ makes that change.</p></li><li class="listitem"><p>Tufte uses red for key data points. To change the library’s default (orange), we set <code class="literal">spotColor</code>, <code class="literal">minSpotColor</code>, and <code class="literal">maxSpotColor</code> at ➍.</p></li><li class="listitem"><p>Finally, Tufte’s sparklines can include shading to mark the normal range for a value. To show, for example, a range of 82–180 mg/dL, we set the <code class="literal">normalRangeMin</code> and <code class="literal">normalRangeMax</code> options at ➎.</p></li></ul></div><p>With these changes, we have the classic Tufte sparkline on our web page. We can even include it within a text paragraph, like this, <span class="inlinemediaobject"><a id="inline_id00001"/><img src="figs/web/094fig01.png.jpg" alt=""/></span>, so that the visualization enhances the content of the text.</p></div></div><div class="sect1" title="Charting Many Variables"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="charting_many_variables">Charting Many Variables</h2></div></div></div><p>By design, sparklines take up very little space on a page, and that makes them ideal for another visualization challenge: showing many variables at once. Of course, regular line charts and bar charts can plot multiple data sets simultaneously; however, these multiple-series charts rapidly grow unwieldy if the number of data sets exceeds four or five. Some visualization projects show dozens of different variables, far beyond what a multiple-series chart can accommodate. A <span class="emphasis"><em>small-multiples</em></span> approach turns the standard chart approach completely around. Instead of showing one chart with multiple data sets, we can show multiple charts, each with a single data set. Placing lots of charts on a page means that each individual chart cannot take up much space. That is exactly the problem that sparklines solve.</p><p>We won’t go too crazy here, to keep the code examples manageable, but it’s easy to extend this approach to many more variables. In our case, we’ll construct a visualization for analyzing stock market performance. The companies in our analysis will include the 10 largest American companies in 2012 (<span class="emphasis"><em><a class="ulink" href="http://money.cnn.com/magazines/fortune/fortune500/2012/full_list/" target="_top">http://money.cnn.com/magazines/fortune/fortune500/2012/full_list/</a></em></span>), also known as the Fortune 500 Top 10; Barclay’s best technology stocks for 2012 (<span class="emphasis"><em><a class="ulink" href="http://www.marketwatch.com/story/barclays-best-tech-stocks-for-2012-2011-12-20/" target="_top">http://www.marketwatch.com/story/barclays-best-tech-stocks-for-2012-2011-12-20/</a></em></span>), as identified in December 2011; and Bristol-Myers Squibb, which <span class="emphasis"><em>CR Magazine</em></span> named the top company in America for corporate responsibility (<span class="emphasis"><em><a class="ulink" href="http://www.thecro.com/files/100Best2012_List_3.8.pdf/" target="_top">http://www.thecro.com/files/100Best2012_List_3.8.pdf/</a></em></span>). Those selections are completely arbitrary, but the example is designed to include three different cases that we will style differently in our visualization. We’ll treat one as a general case (the Fortune 500 Top 10 list), one as a special class (the Barclay’s list), and one as a unique variable (Bristol-Myers Squibb). Just as in this chapter’s first example, we need to include the sparklines and jQuery libraries in our web page.</p><div class="sect2" title="Step 1: Prepare the HTML Markup"><div class="titlepage"><div><div><h3 class="title" id="step_1_prepare_the_html_markup">Step 1: Prepare the HTML Markup</h3></div></div></div><p>The sparklines library makes it easy to embed the data directly inside the HTML markup. For this example, an HTML table is the most appropriate structure for the data. Here’s how such a table could begin. (For brevity’s sake, the following <a id="iddle1938" class="indexterm"/>excerpt doesn’t include the full HTML, but the complete example is available in the book’s source code at <span class="emphasis"><em><a class="ulink" href="http://jsDataV.is/source/" target="_top">http://jsDataV.is/source/</a></em></span>.)</p><a id="pro_id00119"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;table&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;thead&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;tr&gt;</strong></span></span>
            <span class="steelblue"><span class="strong"><strong>&lt;th&gt;</strong></span></span>Symbol<span class="steelblue"><span class="strong"><strong>&lt;/th&gt;</strong></span></span>
            <span class="steelblue"><span class="strong"><strong>&lt;th&gt;</strong></span></span>Company<span class="steelblue"><span class="strong"><strong>&lt;/th&gt;</strong></span></span>
            <span class="steelblue"><span class="strong"><strong>&lt;th&gt;</strong></span></span>2012 Performance<span class="steelblue"><span class="strong"><strong>&lt;/th&gt;</strong></span></span>
            <span class="steelblue"><span class="strong"><strong>&lt;th&gt;</strong></span></span>Gain<span class="steelblue"><span class="strong"><strong>&lt;/th&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;/tr&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;/thead&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;tbody&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;tr</strong></span></span> <span class="steelblue">class=</span><span class="maroon">"barclays"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
            <span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>AAPL<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
            <span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>Apple Inc.<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
            <span class="steelblue"><span class="strong"><strong>&lt;td</strong></span></span> <span class="steelblue">class=</span><span class="maroon">"sparkline"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
                418.68,416.11,416.6,443.34,455.63,489.08,497.7,517.81,...
            <span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
            <span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>27%<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;/tr&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;tr</strong></span></span> <span class="steelblue">class=</span><span class="maroon">"barclays"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
            <span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>ALTR<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
            <span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>Altera Corporation<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
            <span class="steelblue"><span class="strong"><strong>&lt;td</strong></span></span> <span class="steelblue">class=</span><span class="maroon">"sparkline"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
                37.1,36.92,39.93,39.81,40.43,39.76,39.73,38.55,36.89,...
            <span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
            <span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>-7%<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;/tr&gt;</strong></span></span>
        <span class="indianred"><span class="emphasis"><em>// Markup continues...</em></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;/tbody&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/table&gt;</strong></span></span></pre><p>The table has three important characteristics relevant to our visualization.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Each stock is a single table row (<code class="literal">&lt;tr&gt;</code>).</p></li><li class="listitem"><p>Stocks from Barclay’s technology list have the class attribute <code class="literal">"barclays"</code> added to that <code class="literal">&lt;tr&gt;</code> element.</p></li><li class="listitem"><p>The top corporate responsibility stock has no special attributes or characteristics (yet).</p></li></ul></div></div><div class="sect2" title="Step 2: Draw the Charts"><div class="titlepage"><div><div><h3 class="title" id="step_2_draw_the_charts">Step 2: Draw the Charts</h3></div></div></div><p>Just as in this chapter’s first example, creating the sparklines using default options is amazingly simple: it takes only a single line of JavaScript. We use jQuery to select all the elements that contain sparkline data, and we call the <code class="literal">sparkline()</code> function to generate the charts.</p><a id="pro_id00120"/><pre class="programlisting"><span class="olive">$</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {
    <span class="olive">$</span>(<span class="maroon">".sparkline"</span>).<span class="olive">sparkline</span>();
}</pre><p><a id="iddle1937" class="indexterm"/>Notice that we only have to make one call to <code class="literal">sparkline()</code>, even though each chart has unique data. That’s a major benefit of placing the data within the HTML itself.</p><p>The resulting charts, shown in <a class="xref" href="ch03.html#sparklines_can_be_a_good_visualization_t" title="Figure 3-3. Sparklines can be a good visualization to include within page elements such as tables.">Figure 3-3</a>, all have identical styles, but we’ll fix that in the next few steps.</p><div class="figure"><a id="sparklines_can_be_a_good_visualization_t"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00046"/><img src="figs/web/03fig03.png.jpg" alt="Sparklines can be a good visualization to include within page elements such as tables."/></div></div><div class="figure-title">Figure 3-3. Sparklines can be a good visualization to include within page elements such as tables.</div></div></div><div class="sect2" title="Step 3: Establish a Default Style for the Charts"><div class="titlepage"><div><div><h3 class="title" id="step_3_establish_a_default_style_for_the">Step 3: Establish a Default Style for the Charts</h3></div></div></div><p>If we don’t like the sparklines library’s default style, it’s easy to change it using an options object, as shown next.</p><a id="pro_id00121"/><pre class="programlisting"><span class="olive">$</span>(<span class="maroon">".sparkline"</span>).<span class="olive">sparkline</span>(<span class="maroon">"html"</span>,{
    <span class="dodgerblue">lineColor</span>: <span class="maroon">"#006363"</span>,
    <span class="dodgerblue">fillColor</span>: <span class="maroon">"#2D9999"</span>,
    <span class="dodgerblue">spotColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
    <span class="dodgerblue">minSpotColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
    <span class="dodgerblue">maxSpotColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>
});</pre><p>The object is the second parameter to the <code class="literal">sparkline()</code> function, and here it changes the color for the charts and disables the highlights on the minimum, maximum, and final values. The first parameter, the string <code class="literal">"html"</code>, indicates to the library that the data is already present in our HTML.</p><p><a id="iddle1320" class="indexterm"/><a id="iddle1919" class="indexterm"/><a id="iddle1939" class="indexterm"/><a class="xref" href="ch03.html#sparkline_options_let_us_adjust_the_char" title="Figure 3-4. The sparkline options let us adjust the chart styles.">Figure 3-4</a> shows the result for one row. We’ll use this style as the default for all our charts.</p><div class="figure"><a id="sparkline_options_let_us_adjust_the_char"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00047"/><img src="figs/web/03fig04.png.jpg" alt="The sparkline options let us adjust the chart styles."/></div></div><div class="figure-title">Figure 3-4. The sparkline options let us adjust the chart styles.</div></div></div><div class="sect2" title="Step 4: Modify the Default Style for Special Classes"><div class="titlepage"><div><div><h3 class="title" id="step_4_modify_the_default_style_for_spec">Step 4: Modify the Default Style for Special Classes</h3></div></div></div><p>With a default style in place, we can turn our attention to the special class of charts for stocks in Barclay’s technology list. For our example, let’s change the color of the chart without any other changes to our default style. That final clause is important. We could just copy and paste the options, but that would be setting ourselves up for problems in the future. You can see why in the following example code.</p><a id="pro_id00122"/><pre class="programlisting"><span class="olive">$</span>(<span class="maroon">"tr:not(.barclays) .sparkline"</span>).<span class="olive">sparkline</span>(<span class="maroon">"html"</span>,{
    <span class="dodgerblue">lineColor</span>: <span class="maroon">"#006363"</span>,
    <span class="dodgerblue">fillColor</span>: <span class="maroon">"#2D9999"</span>,
    <span class="dodgerblue">spotColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
    <span class="dodgerblue">minSpotColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
    <span class="dodgerblue">maxSpotColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>
});
<span class="olive">$</span>(<span class="maroon">"tr.barclays .sparkline"</span>).<span class="olive">sparkline</span>(<span class="maroon">"html"</span>,{
    <span class="dodgerblue">lineColor</span>: <span class="maroon">"#A50000"</span>,
    <span class="dodgerblue">fillColor</span>: <span class="maroon">"#FE4C4C"</span>,
    <span class="dodgerblue">spotColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
    <span class="dodgerblue">minSpotColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
    <span class="dodgerblue">maxSpotColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>
});</pre><p>Notice that the second call to <code class="literal">sparklines()</code> duplicates options from the first call that haven’t changed, specifically for the spot colors. This makes the code harder to maintain if, in the future, we decide to turn spot colors back on for all our charts, since we would have to make changes to our code in two places. There is a better way.</p><p>To avoid duplication, we first define a variable that holds our default options.</p><a id="pro_id00123"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> sparkline_default = {
    <span class="dodgerblue">lineColor</span>: <span class="maroon">"#006363"</span>,
    <span class="dodgerblue">fillColor</span>: <span class="maroon">"#2D9999"</span>,
    <span class="dodgerblue">spotColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
    <span class="dodgerblue">minSpotColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
    <span class="dodgerblue">maxSpotColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>
};</pre><p>Next we create a new variable for the Barclay’s styles. To create this new variable, we can use the jQuery <code class="literal">.extend()</code> function to avoid duplication.</p><a id="pro_id00124"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> sparkline_barclays = <span class="steelblue">$</span>.<span class="olive">extend</span>( {}, sparkline_default, {
    <span class="dodgerblue">lineColor</span>: <span class="maroon">"#A50000"</span>,
    <span class="dodgerblue">fillColor</span>: <span class="maroon">"#FE4C4C"</span>
});</pre><p><a id="iddle1615" class="indexterm"/>In this code, we pass three parameters to <code class="literal">.extend()</code>. The first parameter is the target. It’s an object that the function will modify, and we start with an empty object (<code class="literal">{}</code>). The next parameters are objects that <code class="literal">.extend()</code> will merge into the target. The merge process adds new properties to the target and updates any properties in the target object with new values. Since we’re passing two additional parameters, we’re asking for two merges.</p><p>You can think of the call to <code class="literal">.extend()</code> as a two-stage process.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Since our target is initially empty, the first merge will add all of the properties from <code class="literal">sparkline_default</code> to the target.</p></li><li class="listitem"><p>Our target now has the same properties as <code class="literal">sparkline_default</code>, and the second merge will modify it by updating the two properties in the last parameter, <code class="literal">lineColor</code> and <code class="literal">fillColor</code>.</p></li></ol></div><p>The resulting object will hold the options we want for charts of Barclay’s technology stocks. Here’s a complete code listing, using these objects to create the charts.</p><a id="pro_id00125"/><pre class="programlisting">   <span class="steelblue"><span class="strong"><strong>var</strong></span></span> sparkline_default = {
       <span class="dodgerblue">lineColor</span>: <span class="maroon">"#006363"</span>,
       <span class="dodgerblue">fillColor</span>: <span class="maroon">"#2D9999"</span>,
       <span class="dodgerblue">spotColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
       <span class="dodgerblue">minSpotColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
       <span class="dodgerblue">maxSpotColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>
   };
   <span class="steelblue"><span class="strong"><strong>var</strong></span></span> sparkline_barclays = <span class="steelblue">$</span>.<span class="olive">extend</span>( {}, sparkline_default, {
       <span class="dodgerblue">lineColor</span>: <span class="maroon">"#A50000"</span>,
       <span class="dodgerblue">fillColor</span>: <span class="maroon">"#FE4C4C"</span>
   });
➊ <span class="olive">$</span>(<span class="maroon">"tr:not(.barclays) .sparkline"</span>).<span class="olive">sparkline</span>(<span class="maroon">"html"</span>,sparkline_default);
➋ <span class="olive">$</span>(<span class="maroon">"tr.barclays .sparkline"</span>).<span class="olive">sparkline</span>(<span class="maroon">"html"</span>,sparkline_barclays);</pre><p>Notice at ➊ that we create the nontechnology sparklines by selecting table rows (<code class="literal">&lt;tr&gt;</code>) that don’t have the <code class="literal">"barclays"</code> class. At ➋ we create the technology sparklines. Because we’ve defined the technology options based on the default, we have an easy way to maintain both default styles and styles for special classes. The chart colors in <a class="xref" href="ch03.html#different_visual_styles_distinguish_diff" title="Figure 3-5. Different visual styles distinguish different types of data.">Figure 3-5</a> clearly distinguish the stock types in our table.</p><div class="figure"><a id="different_visual_styles_distinguish_diff"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00048"/><img src="figs/web/03fig05.png.jpg" alt="Different visual styles distinguish different types of data."/></div></div><div class="figure-title">Figure 3-5. Different visual styles distinguish different types of data.</div></div></div><div class="sect2" title="Step 5: Create a Unique Style for a Specific Chart"><div class="titlepage"><div><div><h3 class="title" id="step_5_create_a_unique_style_for_a_speci">Step 5: Create a Unique Style for a Specific Chart</h3></div></div></div><p><a id="iddle1240" class="indexterm"/><a id="iddle1308" class="indexterm"/><a id="iddle1920" class="indexterm"/><a id="iddle1923" class="indexterm"/><a id="iddle1936" class="indexterm"/><a id="iddle1995" class="indexterm"/>For the final step in this example, let’s consider the single stock at the top of <span class="emphasis"><em>CR Magazine</em></span>’s list. Suppose we want to add distinct styles to its chart, and we know those styles only when we’re generating the HTML, not when we’re writing the JavaScript. How can we adjust the chart style if we can’t modify any JavaScript?</p><p>Sparklines let you add special attributes directly to the HTML element containing a chart. To set the line color, for example, you need to specify the attribute <code class="literal">sparkLineColor</code>. The problem is that if we were to enter this attribute directly in the HTML, the result wouldn’t be valid HTML, because the HTML specification doesn’t recognize the <code class="literal">sparkLineColor</code> attribute. To conform to the HTML standard, custom attributes must have names that begin with the prefix <code class="literal">data-</code>.</p><a id="pro_id00126"/><pre class="programlisting">   <span class="steelblue"><span class="strong"><strong>&lt;tr&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>BMY<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>Bristol Meyers Squibb Co.<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
➊     <span class="steelblue"><span class="strong"><strong>&lt;td</strong></span></span> <span class="steelblue">class=</span><span class="maroon">"sparkline"</span> <span class="steelblue">data-LineColor=</span><span class="maroon">"#679A00"</span>
           <span class="steelblue">data-FillColor=</span><span class="maroon">"#B6ED47"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>32.86,32.46,31.36,...<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>(2%)<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
   <span class="steelblue"><span class="strong"><strong>&lt;/tr&gt;</strong></span></span></pre><p>To use HTML-compliant names to refer to sparklines’ custom attributes, we just need to tell the sparklines library how to find those names. For our HTML, we use the standard <code class="literal">data-</code> prefix instead of <code class="literal">spark</code> in at ➊.</p><p>Now we have to add a couple more options in our call to <code class="literal">sparkline()</code>. First we set <code class="literal">enableTagOptions</code> to <code class="literal">true</code> to tell the library that we’re including options directly in the HTML. Then we set <code class="literal">tagOptionsPrefix</code> to <code class="literal">"data-"</code> to specify the prefix we’re using for those attributes.</p><div class="note" title="Note"><h3 class="title"><a id="ch03note01"/>Note</h3><p><span class="strong"><strong>As of this writing, the jQuery sparklines documentation for <code class="literal">tagOptionsPrefix</code> is not correct. The documentation lists the option as <code class="literal">tagOptionPrefix</code>, where <span class="emphasis"><em>option</em></span> is singular instead of plural. The library’s code, however, expects the plural form.</strong></span></p></div><p><a id="iddle1921" class="indexterm"/>If we use these options correctly, one of our charts will have the distinct color in <a class="xref" href="ch03.html#sparklines_library_supports_unique_styli" title="Figure 3-6. The sparklines library supports unique styling options for individual charts.">Figure 3-6</a>.</p><div class="figure"><a id="sparklines_library_supports_unique_styli"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00049"/><img src="figs/web/03fig06.png.jpg" alt="The sparklines library supports unique styling options for individual charts."/></div></div><div class="figure-title">Figure 3-6. The sparklines library supports unique styling options for individual charts.</div></div><p>To pass the appropriate options to <code class="literal">sparkline()</code>, we can take advantage of the work we did in Step 5. Since we created a special object for default options, that’s the only object we have to change.</p><a id="pro_id00127"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> sparkline_default = {
    <span class="dodgerblue">lineColor</span>: <span class="maroon">"#006363"</span>,
    <span class="dodgerblue">fillColor</span>: <span class="maroon">"#2D9999"</span>,
    <span class="dodgerblue">spotColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
    <span class="dodgerblue">minSpotColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
    <span class="dodgerblue">maxSpotColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
    <span class="dodgerblue">enableTagOptions</span>: <span class="steelblue"><span class="strong"><strong>true</strong></span></span>,
    <span class="dodgerblue">tagOptionsPrefix</span>: <span class="maroon">"data-"</span>
};</pre><p>We only need to make the change in one place, and all of our calls to <code class="literal">sparkline()</code> use the new options. Here is the final, complete JavaScript code for this example.</p><a id="pro_id00128"/><pre class="programlisting"><span class="olive">$</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> sparkline_default = {
        <span class="dodgerblue">lineColor</span>: <span class="maroon">"#006363"</span>,
        <span class="dodgerblue">fillColor</span>: <span class="maroon">"#2D9999"</span>,
        <span class="dodgerblue">spotColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
        <span class="dodgerblue">minSpotColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
        <span class="dodgerblue">maxSpotColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
        <span class="dodgerblue">enableTagOptions</span>: <span class="steelblue"><span class="strong"><strong>true</strong></span></span>,
        <span class="dodgerblue">tagOptionsPrefix</span>: <span class="maroon">"data-"</span>
    };
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> sparkline_barclays = <span class="steelblue">$</span>.<span class="olive">extend</span>( {}, sparkline_default, {
        <span class="dodgerblue">lineColor</span>: <span class="maroon">"#A50000"</span>,
        <span class="dodgerblue">fillColor</span>: <span class="maroon">"#FE4C4C"</span>
    });
    <span class="olive">$</span>(<span class="maroon">"tr:not(.barclays) .sparkline"</span>).<span class="olive">sparkline</span>(<span class="maroon">"html"</span>,sparkline_default);
    <span class="olive">$</span>(<span class="maroon">"tr.barclays .sparkline"</span>).<span class="olive">sparkline</span>(<span class="maroon">"html"</span>,sparkline_barclays);
}</pre><p><a class="xref" href="ch03.html#complete_example_distinguishes_different" title="Figure 3-7. A complete example distinguishes different individual data sets in a larger collection.">Figure 3-7</a> shows the final result. We have a table that integrates text and charts, and we can style those charts appropriately and efficiently for the default case, for a special class, and for a unique value.</p><div class="figure"><a id="complete_example_distinguishes_different"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00050"/><img src="figs/web/03fig07.png.jpg" alt="A complete example distinguishes different individual data sets in a larger collection."/></div></div><div class="figure-title">Figure 3-7. A complete example distinguishes different individual data sets in a larger collection.</div></div><p><a id="iddle1028" class="indexterm"/><a id="iddle1031" class="indexterm"/><a id="iddle1928" class="indexterm"/><a id="iddle1931" class="indexterm"/><a id="iddle1959" class="indexterm"/><a id="iddle2055" class="indexterm"/><a class="xref" href="ch02.html#tracking_data_values" title="Tracking Data Values">Tracking Data Values</a> uses a full-featured charting package for a similar result. If you don’t need the space efficiency of sparklines, consider that approach as an alternative.</p></div></div><div class="sect1" title="Annotating Sparklines"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="annotating_sparklines">Annotating Sparklines</h2></div></div></div><p>Because they’re designed to maximize information density, sparklines omit many traditional chart components such as axes and labels. This approach certainly focuses on the data itself, but it can sometimes leave users without enough context to understand the data. Print versions usually rely on traditional text to supply this context, but on the Web we have more flexibility. We can present the data by itself in a sparkline, and we can give users the chance to explore the data’s context through interactions. <span class="emphasis"><em>Tool tips</em></span>, which show additional information as a user hovers their mouse pointer over sections of a web page, can be an effective way to annotate a sparkline, so long as the users are accessing the page from a desktop computer. (Touch-based devices such as smartphones and tablets don’t typically support the concept of hover.) We’ll walk through a visualization that includes tool tips in this example; other examples in the chapter consider alternative approaches that may be more effective for touch devices. Let’s see how we can use a customized form of tool tips by enhancing the charts in the previous example. Just as in this chapter’s first example, we need to include the sparklines and jQuery libraries in our web page.</p><div class="sect2" title="Step 1: Prepare the Data"><div class="titlepage"><div><div><h3 class="title" id="step_1_prepare_the_data">Step 1: Prepare the Data</h3></div></div></div><p><a id="iddle1029" class="indexterm"/><a id="iddle1032" class="indexterm"/><a id="iddle1033" class="indexterm"/><a id="iddle1624" class="indexterm"/><a id="iddle1671" class="indexterm"/><a id="iddle1679" class="indexterm"/><a id="iddle1929" class="indexterm"/><a id="iddle1932" class="indexterm"/><a id="iddle1933" class="indexterm"/>In the previous examples, we’ve embedded the data directly in the HTML markup. That’s convenient since it lets us separate the data from our code. In this example, however, the JavaScript code will need more-detailed knowledge of the data so it can present the right tool tip information. This time we’ll use a JavaScript array to store our data so that all the relevant information is in one place. For this example, we can focus on a single stock. And even though we’re graphing only the adjusted closing price, the array will track additional data that we can include in the tool tips. Here’s an excerpt of the data for one of the stocks.</p><a id="pro_id00129"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> stock = [
  { <span class="dodgerblue">date</span>: <span class="maroon">"2012-01-03"</span>, <span class="dodgerblue">open</span>: <span class="red">409.40</span>, <span class="dodgerblue">high</span>: <span class="red">422.75</span>, <span class="dodgerblue">low</span>: <span class="red">409.00</span>, <span class="dodgerblue">close</span>: <span class="red">422.40</span>,
    <span class="dodgerblue">volume</span>: <span class="red">10283900</span>, <span class="dodgerblue">adj_close</span>: <span class="red">416.26</span> },
  { <span class="dodgerblue">date</span>: <span class="maroon">"2012-01-09"</span>, <span class="dodgerblue">open</span>: <span class="red">425.50</span>, <span class="dodgerblue">high</span>: <span class="red">427.75</span>, <span class="dodgerblue">low</span>: <span class="red">418.66</span>, <span class="dodgerblue">close</span>: <span class="red">419.81</span>,
    <span class="dodgerblue">volume</span>: <span class="red">9327900</span>, <span class="dodgerblue">adj_close</span>: <span class="red">413.70</span> },
  { <span class="dodgerblue">date</span>: <span class="maroon">"2012-01-17"</span>, <span class="dodgerblue">open</span>: <span class="red">424.20</span>, <span class="dodgerblue">high</span>: <span class="red">431.37</span>, <span class="dodgerblue">low</span>: <span class="red">419.75</span>, <span class="dodgerblue">close</span>: <span class="red">420.30</span>,
    <span class="dodgerblue">volume</span>: <span class="red">10673200</span>, <span class="dodgerblue">adj_close</span>: <span class="red">414.19</span> },
  <span class="indianred"><span class="emphasis"><em>// Data set continues...</em></span></span></pre></div><div class="sect2" title="Step 2: Prepare the HTML Markup"><div class="titlepage"><div><div><h3 class="title" id="step_2_prepare_the_html_markup">Step 2: Prepare the HTML Markup</h3></div></div></div><p>Our visualization will include three distinct areas, each in a <code class="literal">&lt;div&gt;</code> element.</p><a id="pro_id00130"/><pre class="programlisting">   <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"stock"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">style=</span><span class="maroon">"float:left"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
➊         <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">class=</span><span class="maroon">"chart"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
➋         <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">class=</span><span class="maroon">"info"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;/div&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">style=</span><span class="maroon">"float:left"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
➌         <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">class=</span><span class="maroon">"details"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;/div&gt;</strong></span></span>
   <span class="steelblue"><span class="strong"><strong>&lt;/div&gt;</strong></span></span></pre><p>The primary <code class="literal">&lt;div&gt;</code> created at ➊ will hold the chart. Underneath the chart we’ll add the primary tool tip information in its own <code class="literal">&lt;div&gt;</code> ➋, and we’ll include supplementary details to the right ➌. This example uses inline styles for clarity; a production site might prefer to use CSS style sheets.</p></div><div class="sect2" title="Step 3: Add the Chart"><div class="titlepage"><div><div><h3 class="title" id="step_3_add_the_chart">Step 3: Add the Chart</h3></div></div></div><p>Adding the chart to our markup is easy with the sparklines library. We can use the jQuery <code class="literal">.map()</code> function to extract the adjusted close value from our <code class="literal">stock</code> array. The <code class="literal">minSpotColor</code> and <code class="literal">maxSpotColor</code> options tell the library how to highlight the lowest and highest values for the year.</p><a id="pro_id00131"/><pre class="programlisting"><span class="olive">$</span>(<span class="maroon">"#stock .chart"</span>).<span class="olive">sparkline</span>(
    <span class="steelblue">$</span>.<span class="olive">map</span>(stock, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(wk) { <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue">wk</span>.<span class="olive">adj_close</span>; }),
    {
        <span class="dodgerblue">lineColor</span>: <span class="maroon">"#006363"</span>,
        <span class="dodgerblue">fillColor</span>: <span class="maroon">"#2D9999"</span>,
        <span class="dodgerblue">spotColor</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
        <span class="dodgerblue">minSpotColor</span>: <span class="maroon">"#CA0000"</span>,
        <span class="dodgerblue">maxSpotColor</span>: <span class="maroon">"#CA0000"</span>
    }
);</pre><p><a id="iddle1030" class="indexterm"/><a id="iddle1272" class="indexterm"/><a id="iddle1924" class="indexterm"/><a id="iddle1930" class="indexterm"/><a id="iddle1963" class="indexterm"/>The static chart of <a class="xref" href="ch03.html#static_sparkline_shows_the_change_in_the" title="Figure 3-8. A static sparkline shows the change in the data set over time.">Figure 3-8</a> shows the stock performance nicely.</p><div class="figure"><a id="static_sparkline_shows_the_change_in_the"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00051"/><img src="figs/web/03fig08.png.jpg" alt="A static sparkline shows the change in the data set over time."/></div></div><div class="figure-title">Figure 3-8. A static sparkline shows the change in the data set over time.</div></div></div><div class="sect2" title="Step 4: Add the Primary Annotation"><div class="titlepage"><div><div><h3 class="title" id="step_4_add_the_primary_annotation">Step 4: Add the Primary Annotation</h3></div></div></div><p>The sparklines library adds a simple tool tip to all of its charts by default. Although that tool tip shows the value over which the user’s mouse is hovering, the presentation isn’t particularly elegant, and, more importantly, it doesn’t provide as much information as we would like. Let’s enhance the default behavior to meet our needs.</p><p>Looking at the library’s defaults, we can retain the vertical marker, but we don’t want the default tool tip. Adding the option <code class="literal">disableTooltips</code> with a value of <code class="literal">true</code> will turn off the undesired tool tip.</p><p>For our own custom tool tip, we can rely on a handy feature of the sparklines library. The library generates a custom event whenever the user’s mouse moves over a chart region. That event is the <code class="literal">sparklineRegionChange</code> event. The library attaches a custom property, <code class="literal">sparklines</code>, to those events. By analyzing that property, we can determine the mouse’s location relative to the data.</p><a id="pro_id00132"/><pre class="programlisting">   <span class="olive">$</span>(<span class="maroon">".chart"</span>)
       .<span class="olive">on</span>(<span class="maroon">"sparklineRegionChange"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev) {
           <span class="steelblue"><span class="strong"><strong>var</strong></span></span> idx = <span class="steelblue">ev</span>.<span class="olive">sparklines</span>[<span class="red">0</span>].<span class="olive">getCurrentRegionFields</span>().<span class="olive">offset</span>;
➊         <span class="indianred"><span class="emphasis"><em>/* If it's defined, idx has the index into the</em></span></span>
              <span class="indianred"><span class="emphasis"><em>data array corresponding to the mouse pointer */</em></span></span>
       });</pre><p>As the comment at ➊ indicates, the library sometimes generates the event when the mouse leaves the chart area. In those cases, a defined value for the offset will not exist.</p><p>Once we have the mouse position, we can place our tool tip information in the <code class="literal">&lt;div&gt;</code> we set aside for it.</p><a id="pro_id00133"/><pre class="programlisting">   <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (idx) {
       <span class="olive">$</span>(<span class="maroon">".info"</span>).<span class="olive">html</span>(
➊         <span class="maroon">"Week of "</span> + stock[idx].<span class="olive">date</span>
         + <span class="maroon">"&amp;nbsp;&amp;nbsp;&amp;nbsp; "</span>
➋       + <span class="maroon">"Close: $"</span> + stock[idx].<span class="olive">adj_close</span>);
   }</pre><p><a id="iddle1690" class="indexterm"/><a id="iddle1710" class="indexterm"/><a id="iddle1912" class="indexterm"/>We get the information at ➊ and ➋ from the <code class="literal">stock</code> array using the index value from the <code class="literal">sparklineRegionChange</code> event.</p><p>The sparklines library isn’t completely reliable in generating events when the mouse leaves the chart area. Instead of using the custom event, therefore, we can use the standard JavaScript <code class="literal">mouseout</code> event. When the user moves the mouse off the chart, we’ll turn off the custom tool tip by setting its content to a blank space. We use the HTML nonbreaking space (<code class="literal">&amp;nbsp;</code>) so the browser doesn’t think the <code class="literal">&lt;div&gt;</code> is completely empty. If we used a standard space character, the browser would treat the <code class="literal">&lt;div&gt;</code> as empty and recalculate the height of the page, causing an annoying jump in the page contents. (For the same reason, we should initialize that <code class="literal">&lt;div&gt;</code> with <code class="literal">&amp;nbsp;</code> instead of leaving it blank.)</p><a id="pro_id00134"/><pre class="programlisting">.<span class="olive">on</span>(<span class="maroon">"mouseout"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {
    <span class="olive">$</span>(<span class="maroon">".info"</span>).<span class="olive">html</span>(<span class="maroon">"&amp;nbsp;"</span>);
});</pre><p>For the cleanest implementation, we combine all of these steps using method chaining. (To keep it concise, I’ve omitted the chart styling options in the following excerpt.)</p><a id="pro_id00135"/><pre class="programlisting"><span class="olive">$</span>(<span class="maroon">"#stock .chart"</span>)
    .<span class="olive">sparkline</span>(
        <span class="steelblue">$</span>.<span class="olive">map</span>(stock, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(wk) { <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue">wk</span>.<span class="olive">adj_close</span>; }),
        { <span class="dodgerblue">disableTooltips</span>: <span class="steelblue"><span class="strong"><strong>true</strong></span></span> }
    ).<span class="olive">on</span>(<span class="maroon">"sparklineRegionChange"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev) {
        <span class="steelblue"><span class="strong"><strong>var</strong></span></span> idx = <span class="steelblue">ev</span>.<span class="olive">sparklines</span>[<span class="red">0</span>].<span class="olive">getCurrentRegionFields</span>().<span class="olive">offset</span>;
        <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (idx) {
            <span class="olive">$</span>(<span class="maroon">".info"</span>).<span class="olive">html</span>(
                <span class="maroon">"Week of "</span> + stock[idx].<span class="olive">date</span>
              + <span class="maroon">"&amp;nbsp;&amp;nbsp;&amp;nbsp; "</span>
              + <span class="maroon">"Close: $"</span> + stock[idx].<span class="olive">adj_close</span>);
        }
    }).<span class="olive">on</span>(<span class="maroon">"mouseout"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {
        <span class="olive">$</span>(<span class="maroon">".info"</span>).<span class="olive">html</span>(<span class="maroon">"&amp;nbsp;"</span>);
    });</pre><p>Now with <a class="xref" href="ch03.html#interactive_sparkline_tracks_the_userapo" title="Figure 3-9. An interactive sparkline tracks the user’s mouse and provides information relevant to the mouse position.">Figure 3-9</a> we have a nice, interactive tool tip that tracks the user’s mouse as it moves across the chart.</p><div class="figure"><a id="interactive_sparkline_tracks_the_userapo"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00052"/><img src="figs/web/03fig09.png.jpg" alt="An interactive sparkline tracks the user’s mouse and provides information relevant to the mouse position."/></div></div><div class="figure-title">Figure 3-9. An interactive sparkline tracks the user’s mouse and provides information relevant to the mouse position.</div></div></div><div class="sect2" title="Step 5: Provide Additional Information"><div class="titlepage"><div><div><h3 class="title" id="step_5_provide_additional_information">Step 5: Provide Additional Information</h3></div></div></div><p><a id="iddle1034" class="indexterm"/><a id="iddle1160" class="indexterm"/><a id="iddle1934" class="indexterm"/><a id="iddle1943" class="indexterm"/><a id="iddle1948" class="indexterm"/>The tool tip information we’ve added so far shows the immediately relevant information to the user: the week and the adjusted closing price of the stock. Our data, however, contains additional information that might be useful to the user. We can expand on the original tool tip by displaying that as well.</p><p>At the same time we update the primary tool tip region, let’s add the extra data.</p><a id="pro_id00136"/><pre class="programlisting"><span class="olive">$</span>(<span class="maroon">".details"</span>).<span class="olive">html</span>(
    <span class="maroon">"Open: $"</span> + stock[idx].<span class="olive">open</span> + <span class="maroon">"&lt;br/&gt;"</span>
  + <span class="maroon">"High: $"</span> + stock[idx].<span class="olive">high</span> + <span class="maroon">"&lt;br/&gt;"</span>
  + <span class="maroon">"Low: $"</span> + stock[idx].<span class="olive">low</span> + <span class="maroon">"&lt;br/&gt;"</span>
  + <span class="maroon">"Volume: "</span> + stock[idx].<span class="olive">volume</span>
);</pre><p>When we clear the primary tool tip region, we’ll clear this area as well.</p><a id="pro_id00137"/><pre class="programlisting"><span class="olive">$</span>(<span class="maroon">".details"</span>).<span class="olive">html</span>(<span class="maroon">""</span>);</pre><p>Because it won’t affect the vertical size of the page, we don’t need to fill this <code class="literal">&lt;div&gt;</code> with a dummy <code class="literal">&amp;nbsp;</code>.</p><p>With <a class="xref" href="ch03.html#interactive_sparklines_can_show_addition" title="Figure 3-10. Interactive sparklines can show additional information in many ways.">Figure 3-10</a> we have the visualization we want. The chart clearly shows the overall trend for the stock during the year, but it takes up only a small amount of space on the web page. At first glance the chart is also free of distracting elements such as labels and axes. For users who just want a general sense of the stock’s performance, those elements are superfluous. Users who want the full details need only hover their mouse over the chart, and it reveals the complete market information.</p><div class="figure"><a id="interactive_sparklines_can_show_addition"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00053"/><img src="figs/web/03fig10.png.jpg" alt="Interactive sparklines can show additional information in many ways."/></div></div><div class="figure-title">Figure 3-10. Interactive sparklines can show additional information in many ways.</div></div><p>Because we’ve managed to display the information while retaining the compact nature of sparklines, the technique in this example works well when combined with the small-multiples approach of this chapter’s second example. The next example includes an alternate method for showing the extra details.</p></div></div><div class="sect1" title="Drawing Composite Charts"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="drawing_composite_charts">Drawing Composite Charts</h2></div></div></div><p>So far in this chapter, we’ve seen how sparklines can provide a lot of visual information in a very small space. That characteristic makes them perfect for integrating charts in a complete web page that includes text, tables, and other elements. We <a id="iddle1161" class="indexterm"/><a id="iddle1625" class="indexterm"/><a id="iddle1946" class="indexterm"/><a id="iddle1947" class="indexterm"/><a id="iddle2074" class="indexterm"/><a id="iddle2128" class="indexterm"/>haven’t yet exhausted the capabilities of sparklines, however. We can increase the information density of our visualizations still further by creating composite charts—in effect, drawing multiple charts in the same space.</p><p>To see an example of this technique, we can build on the previous example. In that example we used a sparkline to show the closing price of a stock over an entire year. Price is indeed the most relevant data about a stock, but there’s another quantity that many investors like to see: the stock’s trading volume. And just as with price, it can be important to understand the trend for trading volume at a glance. That makes the value an excellent candidate for a chart.</p><p>Just as in this chapter’s first example, we need to include the sparklines and jQuery libraries in our web page. Because we’re visualizing the same data as in the previous example, we’ll also want to set up the data array and the HTML markup exactly as in that example.</p><div class="sect2" title="Step 1: Draw the Trading Volume Chart"><div class="titlepage"><div><div><h3 class="title" id="step_1_draw_the_trading_volume_chart">Step 1: Draw the Trading Volume Chart</h3></div></div></div><p>Even though we’re including a chart of trading volume, the most important quantity is the stock price. To keep the emphasis on stock price, we want to draw that chart <span class="emphasis"><em>on top of</em></span> the chart for trading volume. That means we need to draw the trading volume chart first.</p><p>The code for trading volume is very similar to that of the stock price from the previous example. Instead of an area chart, however, we’ll use a bar chart.</p><a id="pro_id00138"/><pre class="programlisting">   <span class="olive">$</span>(<span class="maroon">"#stock .chart"</span>).<span class="olive">sparkline</span>(
       <span class="steelblue">$</span>.<span class="olive">map</span>(stock, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(wk) { <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue">wk</span>.<span class="olive">volume</span>; }),
➊     { <span class="dodgerblue">type</span>: <span class="maroon">"bar"</span> }
   );</pre><p>We use the jQuery <code class="literal">.map()</code> function to extract the <code class="literal">volume</code> property from our data array. Setting the <code class="literal">type</code> option to <code class="literal">"bar"</code> at ➊ is all it takes to tell the sparklines library to create a bar chart.</p><p><a class="xref" href="ch03.html#sparklines_library_can_create_bar_charts" title="Figure 3-11. The sparklines library can create bar charts as well as line charts.">Figure 3-11</a> shows the results.</p><div class="figure"><a id="sparklines_library_can_create_bar_charts"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00054"/><img src="figs/web/03fig11.png.jpg" alt="The sparklines library can create bar charts as well as line charts."/></div></div><div class="figure-title">Figure 3-11. The sparklines library can create bar charts as well as line charts.</div></div></div><div class="sect2" title="Step 2: Add the Closing Price Chart"><div class="titlepage"><div><div><h3 class="title" id="step_2_add_the_closing_price_chart">Step 2: Add the Closing Price Chart</h3></div></div></div><p>To add the price chart on top of the volume chart, we can call the sparklines library once again.</p><a id="pro_id00139"/><pre class="programlisting">   <span class="olive">$</span>(<span class="maroon">"#stock .chart"</span>)
       .<span class="olive">sparkline</span>(
           <span class="steelblue">$</span>.<span class="olive">map</span>(stock, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(wk) { <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue">wk</span>.<span class="olive">volume</span>; }),
       {
           <span class="dodgerblue">type</span>: <span class="maroon">"bar"</span>
       }
   ).<span class="olive">sparkline</span>(
       <span class="steelblue">$</span>.<span class="olive">map</span>(stock, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(wk) { <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue">wk</span>.<span class="olive">adj_close</span>; }),
       {
➊         <span class="dodgerblue">composite</span>: <span class="steelblue"><span class="strong"><strong>true</strong></span></span>,
           <span class="dodgerblue">lineColor</span>: <span class="maroon">"#006363"</span>,
           <span class="dodgerblue">fillColor</span>: <span class="maroon">"rgba(45, 153, 153, 0.3)"</span>,
           <span class="dodgerblue">disableTooltips</span>: <span class="steelblue"><span class="strong"><strong>true</strong></span></span>
       }
   );</pre><p><a id="iddle1945" class="indexterm"/>We give it the same containing element and, most importantly, set the <code class="literal">composite</code> option to <code class="literal">true</code> at ➊. This parameter tells the library not to erase any existing chart in the element but to simply draw over it.</p><p>Notice the way we specify the fill color for the second chart. We set a transparency (or <span class="emphasis"><em>alpha</em></span>) value of <code class="literal">0.3</code>. This value makes the chart area nearly transparent, so the volume chart will show through. Note, though, that some older web browsers, notably IE8 and earlier, do not support the transparency standard. If your site has a significant number of users with those browsers, you might consider simply setting the <code class="literal">fillColor</code> option to <code class="literal">false</code>, which will disable filling the area entirely.</p><p>As <a class="xref" href="ch03.html#multiple_charts_may_be_combined_in_the_s" title="Figure 3-12. Multiple charts may be combined in the same space.">Figure 3-12</a> shows, the result combines both charts in the same space.</p><div class="figure"><a id="multiple_charts_may_be_combined_in_the_s"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00055"/><img src="figs/web/03fig12.png.jpg" alt="Multiple charts may be combined in the same space."/></div></div><div class="figure-title">Figure 3-12. Multiple charts may be combined in the same space.</div></div></div><div class="sect2" title="Step 3: Add the Annotations"><div class="titlepage"><div><div><h3 class="title" id="step_3_add_the_annotations">Step 3: Add the Annotations</h3></div></div></div><p>We can add annotations to the chart using the same approach as in the previous example. Because our charts now include the trading volume, it’s appropriate to move that value from the details area into the primary annotation <code class="literal">&lt;div&gt;</code>. The code to do that is a simple adjustment from the prior example.</p><a id="pro_id00140"/><pre class="programlisting">   .<span class="olive">on</span>(<span class="maroon">"sparklineRegionChange"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev) {
➊     <span class="steelblue"><span class="strong"><strong>var</strong></span></span> idx = <span class="steelblue">ev</span>.<span class="olive">sparklines</span>[<span class="red">1</span>].<span class="olive">getCurrentRegionFields</span>().<span class="olive">offset</span>;
       <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (idx) {
           <span class="olive">$</span>(<span class="maroon">".info"</span>).<span class="olive">html</span>(
             <span class="maroon">"Week of "</span> + stock[idx].<span class="olive">date</span>
           + <span class="maroon">"&amp;nbsp;&amp;nbsp;&amp;nbsp; Close: $"</span> + stock[idx].<span class="olive">adj_close</span>
➋         + <span class="maroon">"&amp;nbsp;&amp;nbsp;&amp;nbsp; Volume: "</span>
           + <span class="steelblue">Math</span>.<span class="olive">round</span>(stock[idx].<span class="olive">volume</span>/<span class="red">10000</span>)/<span class="red">100</span> + <span class="maroon">"M"</span>
           );
           <span class="olive">$</span>(<span class="maroon">".details"</span>).<span class="olive">html</span>(
               <span class="maroon">"Open: $"</span> + stock[idx].<span class="olive">open</span> + <span class="maroon">"&lt;br/&gt;"</span>
             + <span class="maroon">"High: $"</span> + stock[idx].<span class="olive">high</span> + <span class="maroon">"&lt;br/&gt;"</span>
             + <span class="maroon">"Low: $"</span> + stock[idx].<span class="olive">low</span>
           );
       }</pre><p><a id="iddle1686" class="indexterm"/><a id="iddle1925" class="indexterm"/><a id="iddle1949" class="indexterm"/><a id="iddle2063" class="indexterm"/>In addition to moving the text from one area to the other, we’ve made two significant changes.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>We get the <code class="literal">idx</code> value from the second element of the event’s <code class="literal">sparklines</code> array (<code class="literal">sparklines[1]</code>) at ➊. That’s because the first element of that array is the first chart. The sparklines library doesn’t really return any useful information about bar charts in the <code class="literal">sparklineRegionChange</code> event. Fortunately, we can get all the information we need from the line bchart.</p></li><li class="listitem"><p>We show the trading volume in millions, rounded to two decimal places. The calculation is in at ➋. It’s much easier for users to quickly grasp “24.4M” than “24402100.”</p></li></ul></div><p>As in the previous example, the annotations in our chart (shown in <a class="xref" href="ch03.html#tracking_the_mouse_position_makes_it_pos" title="Figure 3-13. Tracking the mouse position makes it possible to interactively annotate the charts.">Figure 3-13</a>) provide additional details.</p><div class="figure"><a id="tracking_the_mouse_position_makes_it_pos"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00056"/><img src="figs/web/03fig13.png.jpg" alt="Tracking the mouse position makes it possible to interactively annotate the charts."/></div></div><div class="figure-title">Figure 3-13. Tracking the mouse position makes it possible to interactively annotate the charts.</div></div></div><div class="sect2" title="Step 4: Show Details as a Chart"><div class="titlepage"><div><div><h3 class="title" id="step_4_show_details_as_a_chart">Step 4: Show Details as a Chart</h3></div></div></div><p>So far we’ve shown the additional details for the stock (open, close, high, and low) as text values. As long as we’re drawing multiple charts, we can show those values graphically as well. The statistical box plot serves as a useful model for us. Traditionally, that plot type shows the range of a distribution, including deviations, quartiles, and medians. Visually, however, it provides a perfect model of a stock’s trading performance. We can use it to show the opening and closing prices, as well as the high and low values during the period.</p><p>The sparklines library can draw a box plot for us, but normally it calculates the values to display given the distribution as input data. In our case we don’t want to use the standard statistical calculations. Instead, we can use an option that tells the library to use precomputed values. The library expects at least five values:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The lowest sample value</p></li><li class="listitem"><p>The first quartile</p></li><li class="listitem"><p>The median</p></li><li class="listitem"><p>The third quartile</p></li><li class="listitem"><p>The highest sample value</p></li></ul></div><p><a id="iddle1926" class="indexterm"/>For our example, we’ll provide the following values instead:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The lowest price</p></li><li class="listitem"><p>Whichever is less of the opening and closing prices</p></li><li class="listitem"><p>The adjusted closing price</p></li><li class="listitem"><p>Whichever is greater of the opening and closing prices</p></li><li class="listitem"><p>The highest price</p></li></ul></div><p>We’ll also color the median bar red or green depending on whether the stock gained or lost value during the period.</p><p>This code creates that chart in response to the <code class="literal">sparklineRegionChange</code> event:</p><a id="pro_id00141"/><pre class="programlisting">   <span class="olive">$</span>(<span class="maroon">"#composite-chart4 .details"</span>)
       .<span class="olive">sparkline</span>([
➊         stock[idx].<span class="olive">low</span>,
           <span class="steelblue">Math</span>.<span class="olive">min</span>(stock[idx].<span class="olive">open</span>,stock[idx].<span class="olive">close</span>),
           stock[idx].<span class="olive">adj_close</span>,
           <span class="steelblue">Math</span>.<span class="olive">max</span>(stock[idx].<span class="olive">open</span>,stock[idx].<span class="olive">close</span>),
           stock[idx].<span class="olive">high</span>
       ], {
           <span class="dodgerblue">type</span>: <span class="maroon">"box"</span>,
           <span class="dodgerblue">showOutliers</span>: <span class="steelblue"><span class="strong"><strong>false</strong></span></span>,
➋         <span class="dodgerblue">medianColor</span>: (stock[idx].<span class="olive">open</span> &lt; stock[idx].<span class="olive">close</span>)
➌          ? <span class="maroon">"green"</span> : <span class="maroon">"red"</span>
       });</pre><p>The data for the chart (shown at ➊) is simply the five values extracted from the stock data for the appropriate week. As ➋ and ➌ demonstrate, we can change the color of the median bar depending on whether the stock finished higher or lower for the day.</p><p>When the mouse leaves the chart region, we can remove the box plot by emptying its container.</p><a id="pro_id00142"/><pre class="programlisting"><span class="olive">$</span>(<span class="maroon">".details"</span>).<span class="olive">empty</span>();</pre><p>Now as our users mouse over the chart area, they can see a visual representation of the stock’s price range during each period (<a class="xref" href="ch03.html#interactive_annotations_can_be_charts_th" title="Figure 3-14. Interactive annotations can be charts themselves in addition to text.">Figure 3-14</a>).</p><div class="figure"><a id="interactive_annotations_can_be_charts_th"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00057"/><img src="figs/web/03fig14.png.jpg" alt="Interactive annotations can be charts themselves in addition to text."/></div></div><div class="figure-title">Figure 3-14. Interactive annotations can be charts themselves in addition to text.</div></div></div></div><div class="sect1" title="Responding to Click Events"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="responding_to_click_events">Responding to Click Events</h2></div></div></div><p><a id="iddle1145" class="indexterm"/><a id="iddle1626" class="indexterm"/><a id="iddle1942" class="indexterm"/><a id="iddle1954" class="indexterm"/><a id="iddle1958" class="indexterm"/>Throughout this chapter we’ve looked at how to include a lot of visual information in a small space, making it easier to integrate a visualization within a web page. The basic sparkline by itself is very efficient, and previous examples have added annotations and composites to increase the information density further. Sometimes, however, there’s just no way to fit all the possible data in a small enough space. Even in these cases, though, the interactive nature of the Web can help us out. Our web page can start with a compact visualization but expand to a different view—one with richer details—with a simple click or tap.</p><p>Indeed, the compact quality of sparklines seems to invite interaction. In every usability test I’ve performed that included sparklines on a web page, the participants invariably clicked on the chart. That was true even when there were no other details that the page could provide and the participants had no idea what to expect in response to their clicks. They clicked just to see what would happen.</p><p>This example continues our stock market example. We’ll begin with the same basic stock price chart we’ve seen before, but enhance it to provide details when users click on the chart region.</p><p>Just as in this chapter’s first example, we need to include the sparklines and jQuery libraries in our web page. Because we’re visualizing the same data as in the previous example, we’ll also want to set up the data array exactly as in that example. The HTML markup, however, can be much simpler. All we need is a <code class="literal">&lt;div&gt;</code> to hold the chart.</p><a id="pro_id00143"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"stock"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span></pre><div class="sect2" title="Step 1: Add the Chart"><div class="titlepage"><div><div><h3 class="title" id="step_1_add_the_chart">Step 1: Add the Chart</h3></div></div></div><p>Adding the chart to our markup is easy with the sparklines library. We can use the jQuery <code class="literal">.map()</code> function to extract the adjusted close value from our <code class="literal">stock</code> array.</p><a id="pro_id00144"/><pre class="programlisting"><span class="olive">$</span>(<span class="maroon">"#stock"</span>).<span class="olive">sparkline</span>(<span class="steelblue">$</span>.<span class="olive">map</span>(stock, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(wk) { <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue">wk</span>.<span class="olive">adj_close</span>; }));</pre><p>The static chart of <a class="xref" href="ch03.html#starting_with_a_static_chart_ensures_tha" title="Figure 3-15. Starting with a static chart ensures that the visualization is sound.">Figure 3-15</a>, which shows the stock performance, probably looks familiar by now.</p><div class="figure"><a id="starting_with_a_static_chart_ensures_tha"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00058"/><img src="figs/web/03fig15.png.jpg" alt="Starting with a static chart ensures that the visualization is sound."/></div></div><div class="figure-title">Figure 3-15. Starting with a static chart ensures that the visualization is sound.</div></div></div><div class="sect2" title="Step 2: Handle Click Events"><div class="titlepage"><div><div><h3 class="title" id="step_2_handle_click_events">Step 2: Handle Click Events</h3></div></div></div><p><a id="iddle1275" class="indexterm"/><a id="iddle1478" class="indexterm"/><a id="iddle1922" class="indexterm"/><a id="iddle1956" class="indexterm"/><a id="iddle2164" class="indexterm"/>The sparklines library makes it easy for us to handle click events. When users click on a chart region, the library generates a custom <code class="literal">sparklineClick</code> event. The event data includes all of the normal click properties, plus information about where on the chart the user clicked. To be notified of clicks, we define a handler for that custom event.</p><a id="pro_id00145"/><pre class="programlisting"><span class="olive">$</span>(<span class="maroon">"#stock"</span>)
    .<span class="olive">sparkline</span>(<span class="steelblue">$</span>.<span class="olive">map</span>(stock, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(wk) { <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue">wk</span>.<span class="olive">adj_close</span>; }))
    .<span class="olive">on</span>(<span class="maroon">"sparklineClick"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev) {
        <span class="steelblue"><span class="strong"><strong>var</strong></span></span> sparkline = <span class="steelblue">ev</span>.<span class="olive">sparklines</span>[<span class="red">0</span>],
        region = <span class="steelblue">sparkline</span>.<span class="olive">getCurrentRegionFields</span>();
        <span class="indianred"><span class="emphasis"><em>/* region.x and region.y are the coordinates of the click */</em></span></span>
    });</pre><p>Now that we’re set up to receive <code class="literal">sparklineClick</code> events, we can write the code to respond to them. For our example, let’s reveal a detailed financial analysis widget. Many web services, including Yahoo and Google, have similar widgets, but we’ll use one from WolframAlpha. As is typical, WolframAlpha provides code for the widget as an HTML <code class="literal">&lt;iframe&gt;</code>. We can wrap that <code class="literal">&lt;iframe&gt;</code> in our own <code class="literal">&lt;div&gt;</code> and place it immediately after the chart. We set a <code class="literal">display</code> property of <code class="literal">none</code> so that the contents are initially hidden. (The following snippet omits the details of the <code class="literal">&lt;iframe&gt;</code> element for clarity.)</p><a id="pro_id00146"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"stock"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"widget"</span> <span class="steelblue">style=</span><span class="maroon">"display:none"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;iframe&gt;&lt;/iframe&gt;&lt;/div&gt;</strong></span></span></pre><p>Now our event handling code can reveal the widget using the jQuery <code class="literal">show()</code> function.</p><a id="pro_id00147"/><pre class="programlisting">.<span class="olive">on</span>(<span class="maroon">"sparklineClick"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev) {
  <span class="olive">$</span>(<span class="maroon">"#widget"</span>).<span class="olive">show</span>();
});</pre><p>That works to reveal the details, but as <a class="xref" href="ch03.html#mouse_clicks_can_reveal_more_details_for" title="Figure 3-16. Mouse clicks can reveal more details for a chart.">Figure 3-16</a> shows, the resulting presentation isn’t as elegant as it could be since the details appear so abruptly.</p><div class="figure"><a id="mouse_clicks_can_reveal_more_details_for"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00059"/><img src="figs/web/03fig16.png.jpg" alt="Mouse clicks can reveal more details for a chart."/></div></div><div class="figure-title">Figure 3-16. Mouse clicks can reveal more details for a chart.</div></div></div><div class="sect2" title="Step 3: Improve the Transitions"><div class="titlepage"><div><div><h3 class="title" id="step_3_improve_the_transitions">Step 3: Improve the Transitions</h3></div></div></div><p><a id="iddle1957" class="indexterm"/>Instead of simply revealing the widget beneath the chart, it would be better to have the widget replace the chart. And if we’re going to do that, we’ll also want to give users a chance to restore the chart and hide the widget.</p><a id="pro_id00148"/><pre class="programlisting">   <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"stock"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
➊ <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"widget-control"</span> <span class="steelblue">style=</span><span class="maroon">"width:600px;display:none"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;a</strong></span></span> <span class="steelblue">href=</span><span class="maroon">"#"</span> <span class="steelblue">style=</span><span class="maroon">"float:right"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span><span class="red">&amp;times;</span><span class="steelblue"><span class="strong"><strong>&lt;/a&gt;</strong></span></span>
   <span class="steelblue"><span class="strong"><strong>&lt;/div&gt;</strong></span></span>
   <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"widget"</span> <span class="steelblue">style=</span><span class="maroon">"width:600px;display:none"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;iframe&gt;&lt;/iframe&gt;</strong></span></span>
   <span class="steelblue"><span class="strong"><strong>&lt;/div&gt;</strong></span></span></pre><p>Here, we include a <code class="literal">"widget-control" &lt;div&gt;</code> ➊ for controlling the widget’s visibility. The only content we need for this controller is a close symbol floated right. Just like the widget itself, the controller is initially hidden.</p><p>Now when the user clicks on the chart, we reveal the widget, reveal the controller, and hide the chart.</p><a id="pro_id00149"/><pre class="programlisting">.<span class="olive">on</span>(<span class="maroon">"sparklineClick"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev) {
    <span class="olive">$</span>(<span class="maroon">"#widget"</span>).<span class="olive">show</span>();
    <span class="olive">$</span>(<span class="maroon">"#widget-control"</span>).<span class="olive">show</span>();
    <span class="olive">$</span>(<span class="maroon">"#stock"</span>).<span class="olive">hide</span>();
});</pre><p><a id="iddle1901" class="indexterm"/><a id="iddle1902" class="indexterm"/><a id="iddle2044" class="indexterm"/><a id="iddle2072" class="indexterm"/>Next we intercept clicks on the close symbol in the widget controller. We first prevent default event handling; otherwise, the browser will jump disconcertingly to the top of the page. Then we hide the widget and its controller while revealing the chart again.</p><a id="pro_id00150"/><pre class="programlisting"><span class="olive">$</span>(<span class="maroon">"#widget-control a"</span>).<span class="olive">click</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev) {
    <span class="steelblue">ev</span>.<span class="olive">preventDefault</span>();
    <span class="olive">$</span>(<span class="maroon">"#widget"</span>).<span class="olive">hide</span>();
    <span class="olive">$</span>(<span class="maroon">"#widget-control"</span>).<span class="olive">hide</span>();
    <span class="olive">$</span>(<span class="maroon">"#stock"</span>).<span class="olive">show</span>();
})</pre><p>Finally, we need to give the user some indication that this interaction is possible.</p><a id="pro_id00151"/><pre class="programlisting">   <span class="olive">$</span>(<span class="maroon">"#stock"</span>)
       .<span class="olive">sparkline</span>(
           <span class="steelblue">$</span>.<span class="olive">map</span>(stock, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(wk) { <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue">wk</span>.<span class="olive">adj_close</span>; }),
➊         { <span class="dodgerblue">tooltipFormatter</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {<span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="maroon">"Click for details"</span>; } }
       );</pre><p>On the chart, we override the sparklines library’s default tool tip at ➊ to let users know that more details are available.</p><p>And now for the widget controller:</p><a id="pro_id00152"/><pre class="programlisting">   <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"stock"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
   <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"widget-control"</span> <span class="steelblue">style=</span><span class="maroon">"width:600px;display:none"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
➊     <span class="steelblue"><span class="strong"><strong>&lt;a</strong></span></span> <span class="steelblue">href=</span><span class="maroon">"#"</span> <span class="steelblue">title=</span><span class="maroon">"Click to hide"</span> <span class="steelblue">style=</span><span class="maroon">"float:right;"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span><span class="red">&amp;times;</span><span class="steelblue"><span class="strong"><strong>&lt;/a&gt;</strong></span></span>
   <span class="steelblue"><span class="strong"><strong>&lt;/div&gt;</strong></span></span>
   <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"widget"</span> <span class="steelblue">style=</span><span class="maroon">"width:600px;display:none"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
       <span class="steelblue"><span class="strong"><strong>&lt;iframe&gt;&lt;/iframe&gt;</strong></span></span>
   <span class="steelblue"><span class="strong"><strong>&lt;/div&gt;</strong></span></span></pre><p>Here, we simply add a <code class="literal">title</code> attribute at ➊ to tell users how to hide the widget.</p><p>These additions give us the simple sparkline chart in <a class="xref" href="ch03.html#mouse_clicks_can_reveal_more_det-id00013" title="Figure 3-17. Mouse clicks can reveal more details for a chart.">Figure 3-17</a>, which expands to offer a wealth of details with a single click. The close symbol in the upper-right corner lets users return to the more compact sparkline.</p><div class="figure"><a id="mouse_clicks_can_reveal_more_det-id00013"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00060"/><img src="figs/web/03fig17.png.jpg" alt="Mouse clicks can reveal more details for a chart."/></div></div><div class="figure-title">Figure 3-17. Mouse clicks can reveal more details for a chart.</div></div></div><div class="sect2" title="Step 4: Animate"><div class="titlepage"><div><div><h3 class="title" id="step_4_animate">Step 4: Animate</h3></div></div></div><p><a id="iddle1955" class="indexterm"/>For the final touch to our visualization, let’s do something about the abrupt hiding and revealing of the visualization components. A smoother animation will help our users follow the transition, and jQuery makes it easy enough to implement. There are lots of animation effects available in the jQuery UI library, but the basic functionality of jQuery’s core is fine for this example. We simply replace the <code class="literal">show()</code> and <code class="literal">hide()</code> functions with <code class="literal">slideDown()</code> and <code class="literal">slideUp()</code>, respectively.</p><a id="pro_id00153"/><pre class="programlisting">.<span class="olive">on</span>(<span class="maroon">"sparklineClick"</span>, <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev) {
    <span class="olive">$</span>(<span class="maroon">"#widget"</span>).<span class="olive">slideDown</span>();
    <span class="olive">$</span>(<span class="maroon">"#widget-control"</span>).<span class="olive">slideDown</span>();
    <span class="olive">$</span>(<span class="maroon">"#stock"</span>).<span class="olive">slideUp</span>();
});
<span class="olive">$</span>(<span class="maroon">"#widget-control a"</span>).<span class="olive">click</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(ev) {
    <span class="steelblue">ev</span>.<span class="olive">preventDefault</span>();
    <span class="olive">$</span>(<span class="maroon">"#widget"</span>).<span class="olive">slideUp</span>();
    <span class="olive">$</span>(<span class="maroon">"#widget-control"</span>).<span class="olive">slideUp</span>();
    <span class="olive">$</span>(<span class="maroon">"#stock"</span>).<span class="olive">slideDown</span>();
})</pre><p>At this point we can call our visualization complete; the final product is shown in <a class="xref" href="ch03.html#animating_transitions_can_make_the_visua" title="Figure 3-18. Animating transitions can make the visualization less jarring to users.">Figure 3-18</a>. The compact sparkline smoothly transitions to reveal detailed information when the user clicks, and those details transition back to the sparkline when the user closes them.</p><div class="figure"><a id="animating_transitions_can_make_the_visua"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00061"/><img src="figs/web/03fig18.png.jpg" alt="Animating transitions can make the visualization less jarring to users."/></div></div><div class="figure-title">Figure 3-18. Animating transitions can make the visualization less jarring to users.</div></div></div></div><div class="sect1" title="Updating Charts in Real Time"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="updating_charts_in_real_time">Updating Charts in Real Time</h2></div></div></div><p><a id="iddle1216" class="indexterm"/><a id="iddle1483" class="indexterm"/><a id="iddle1797" class="indexterm"/><a id="iddle1951" class="indexterm"/><a id="iddle1960" class="indexterm"/>As we’ve seen in this chapter’s other examples, sparklines are great for integrating visualizations in a complete web page. They can be embedded in text content or used as table elements. Another application that suits sparklines well is an information dashboard. Effective dashboards summarize the health of the underlying system <span class="emphasis"><em>at a glance</em></span>. When users don’t have the time to read through pages of texts or detailed graphics, the information density of sparklines makes them an ideal tool.</p><p>In addition to high information density, most dashboards have another requirement: they must be up-to-date. For web-based dashboards, that means the contents should be continuously updated, even while users are viewing the page. There is no excuse for requiring users to refresh their browsers. Fortunately, the sparklines library makes it easy to accommodate this requirement as well.</p><p>Just as in this chapter’s first example, we need to include the sparklines and jQuery libraries in our web page. For this visualization we’ll show both a chart and the most recent value of the data. We define <code class="literal">&lt;div&gt;</code> elements for each and place both in a containing <code class="literal">&lt;div&gt;</code>. The following code includes some styles inline, but you could place them in an external style sheet. Here the styles are just meant to position the value immediately to the right of the chart rather than on a separate line.</p><a id="pro_id00154"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"dashboard"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"chart"</span> <span class="steelblue">style=</span><span class="maroon">"float:left"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;div</strong></span></span> <span class="steelblue">id=</span><span class="maroon">"value"</span> <span class="steelblue">style=</span><span class="maroon">"float:left"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/div&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/div&gt;</strong></span></span></pre><div class="sect2" title="Step 1: Retrieve the Data"><div class="titlepage"><div><div><h3 class="title" id="step_1_retrieve_the_data">Step 1: Retrieve the Data</h3></div></div></div><p><a id="iddle1415" class="indexterm"/><a id="iddle1881" class="indexterm"/><a id="iddle1882" class="indexterm"/><a id="iddle1961" class="indexterm"/><a id="iddle1962" class="indexterm"/>In a real dashboard example, the server would provide the data to display and updates to that data. As long as the frequency of the updates was modest (not faster than once every five seconds or so), we could simply poll the server for updates on a regular interval. It’s probably not a good idea, however, to use the JavaScript <code class="literal">setInterval()</code> function to control the polling interval. That may seem strange at first because <code class="literal">setInterval()</code> executes a function periodically, which would seem to meet the requirements exactly. The situation is not quite that simple, however. If the server or network encounters a problem, then requests triggered by <code class="literal">setInterval()</code> will continue unabated, stacking up in a queue. Then, when communication with the server is restored, all of the pending requests will immediately finish, and we’d have a flood of data to handle.</p><p>To avoid this problem, we can use the <code class="literal">setTimeout()</code> function instead. That function executes only once, so we’ll have to keep calling it explicitly. By doing that, though, we can make sure that we send a request to the server only after the current one finishes. This approach avoids stacking up a queue of requests.</p><a id="pro_id00155"/><pre class="programlisting">   (<span class="steelblue"><span class="strong"><strong>function</strong></span></span> <span class="olive">getData</span>(){
       <span class="olive">setTimeout</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(){
           <span class="indianred"><span class="emphasis"><em>// Request the data from the server</em></span></span>
           <span class="steelblue">$</span>.<span class="olive">ajax</span>({ <span class="dodgerblue">url</span>: <span class="maroon">"/api/data"</span>, <span class="dodgerblue">success</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(data) {

               <span class="indianred"><span class="emphasis"><em>// Data has the response from the server</em></span></span>

               <span class="indianred"><span class="emphasis"><em>// Now prepare to ask for updated data</em></span></span>
➊             <span class="olive">getData</span>();
           }, <span class="dodgerblue">dataType</span>: <span class="maroon">"json"</span>});
       }, <span class="red">30000</span>); <span class="indianred"><span class="emphasis"><em>// 30000: wait 30 seconds to make the request</em></span></span>
➋ })();</pre><p>Notice that the structure of the code defines the <code class="literal">getData()</code> function and immediately executes it. The closing pair of parentheses at ➋ triggers the immediate execution.</p><p>Within the <code class="literal">success</code> callback, we set up a recursive call to <code class="literal">getData()</code> at ➊ so the function executes again whenever the server responds with data.</p></div><div class="sect2" title="Step 2: Update the Visualization"><div class="titlepage"><div><div><h3 class="title" id="step_2_update_the_visualization">Step 2: Update the Visualization</h3></div></div></div><p>Whenever we receive updated information from the server, we can simply update the chart and value.</p><a id="pro_id00156"/><pre class="programlisting">   (<span class="steelblue"><span class="strong"><strong>function</strong></span></span> <span class="olive">getData</span>(){
       <span class="olive">setTimeout</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(){
           <span class="indianred"><span class="emphasis"><em>// Request the data from the server</em></span></span>
           <span class="steelblue">$</span>.<span class="olive">ajax</span>({ <span class="dodgerblue">url</span>: <span class="maroon">"/api/data"</span>, <span class="dodgerblue">success</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(data) {

➊             <span class="olive">$</span>(<span class="maroon">"#chart"</span>).<span class="olive">sparkline</span>(data);
➋             <span class="olive">$</span>(<span class="maroon">"#value"</span>).<span class="olive">text</span>(<span class="steelblue">data</span>.<span class="olive">slice</span>(-<span class="red">1</span>));
               <span class="olive">getData</span>();
           }, <span class="dodgerblue">dataType</span>: <span class="maroon">"json"</span>});
       }, <span class="red">30000</span>); <span class="indianred"><span class="emphasis"><em>// 30000: wait 30 seconds to make the request</em></span></span>
   })();</pre><p>The code needs only a straightforward call to the sparklines library and a jQuery function to update the value. We’ve added that to the code here at ➊ and ➋.</p><p><a class="xref" href="ch03.html#live_updating_chart_can_show_real-time_d" title="Figure 3-19. A live updating chart can show real-time data.">Figure 3-19</a> shows what a default chart looks like. Of course, you can specify both the chart and text styles as appropriate for your own dashboard.</p><div class="figure"><a id="live_updating_chart_can_show_real-time_d"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00062"/><img src="figs/web/03fig19.png.jpg" alt="A live updating chart can show real-time data."/></div></div><div class="figure-title">Figure 3-19. A live updating chart can show real-time data.</div></div></div></div><div class="sect1" title="Summing Up"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="summing_up-id00014">Summing Up</h2></div></div></div><p>In this chapter, we’ve considered various techniques for integrating visualizations within a web page. We’ve seen that sparklines are an excellent tool. Because they provide a lot of visual information in a small space, they leave room for other elements of the page, including text blocks, tables, and dashboards. We’ve considered several ways to increase the information density even further with annotations, composite charts, and click events. Finally, we looked at how to create charts that update in real time, accurately visualizing the up-to-the-minute status of an underlying system.</p></div></section></body></html>