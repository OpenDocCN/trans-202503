<html><head></head><body><div class="chapter" title="Chapter&#xA0;1.&#xA0;Preparation and Setup"><div class="titlepage"><div><div><h1 class="title"><a id="preparation_and_setup"/>Chapter 1. Preparation and Setup</h1></div></div></div><p><a id="iddle1907" class="indexterm"/><a id="iddle2054" class="indexterm"/><a id="iddle2180" class="indexterm"/><a id="iddle2643" class="indexterm"/>In this chapter, we’ll begin to develop a full game using HTML, CSS, and JavaScript. Our simple bubble shooter game will demonstrate a range of development techniques, but it won’t need extensive logic to control the mechanics. <span class="emphasis"><em>Game logic</em></span> includes systems for interaction between in-game elements, events that result from the player’s actions, simulation of artificial intelligence in characters, and so on. Developing intricate game logic can be time-consuming, so for learning purposes, we’ll stick with basic principles, such as how to render graphics and animation, respond to user input, and play sounds.</p><p>We’ll start with the user interface and page layout, then load scripts, and finally add some basic interaction. During development, we’ll also explore some browser tools that will prove helpful (especially when debugging), as well as Modernizr and jQuery—two main libraries that will speed up development. We’ll use Modernizr to load scripts and detect whether a user’s browser supports a given feature, and we’ll use jQuery when working with HTML and JavaScript together.</p><p><a id="iddle1048" class="indexterm"/><a id="iddle1232" class="indexterm"/><a id="iddle1289" class="indexterm"/><a id="iddle1308" class="indexterm"/><a id="iddle1432" class="indexterm"/><a id="iddle1433" class="indexterm"/><a id="iddle1891" class="indexterm"/>If you’re experienced in web application development using HTML, CSS, JavaScript, and jQuery, much of the code in this chapter will be familiar to you. My aim is to demonstrate what you can achieve with relatively little code and how easy it is to create basic interactive elements.</p><div class="sect1" title="How the Game Is Played"><div class="titlepage"><div><div><h1 class="title"><a id="how_the_game_is_played"/>How the Game Is Played</h1></div></div></div><p>If you’ve ever played <span class="emphasis"><em>Puzzle Bobble</em></span>, <span class="emphasis"><em>Bust-a-Move</em></span>, <span class="emphasis"><em>Snood</em></span>, or any of the many mobile bubble-shooting games, you already know the basic mechanics of a bubble shooter. <a class="xref" href="ch01.html#screenshot_of_the_finished_bubble_shoote" title="Figure 1-1. A screenshot of the finished Bubble Shooter game">Figure 1-1</a> shows a screenshot of the finished game.</p><div class="figure"><a id="screenshot_of_the_finished_bubble_shoote"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00002"/><img src="httpatomoreillycomsourcenostarchimages2184491.png.jpg" alt="A screenshot of the finished Bubble Shooter game"/></div></div><p class="title">Figure 1-1. A screenshot of the finished <span class="emphasis"><em>Bubble Shooter</em></span> game</p></div><p>The goal of the game is to clear all of the bubbles hanging from the top of the screen. The player aims with the mouse and clicks to fire a bubble from the bottom of the screen into the bubbles at the top, in hopes of forming groups of three or more bubbles of the same color. Once a matching color group of at least three bubbles is formed, all of the bubbles in the group burst, as shown in <a class="xref" href="ch01.html#blue_bubble_is_fired_at_the_groupcomma_c" title="Figure 1-2. The blue bubble is fired at the group, creating a match, and all of the highlighted bubbles will pop.">Figure 1-2</a>.</p><p>If a bubble is fired and doesn’t form a group that matches by color, it is added to the display, as shown in <a class="xref" href="ch01.html#blue_bubble_fired_here_wonapostrophet_ca" title="Figure 1-3. The blue bubble fired here won’t cause the green group above it to pop. Instead, it will be added to the board.">Figure 1-3</a>.</p><div class="figure"><a id="blue_bubble_is_fired_at_the_groupcomma_c"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00003"/><img src="httpatomoreillycomsourcenostarchimages2184493.png.jpg" alt="The blue bubble is fired at the group, creating a match, and all of the highlighted bubbles will pop."/></div></div><p class="title">Figure 1-2. The blue bubble is fired at the group, creating a match, and all of the highlighted bubbles will pop.</p></div><div class="figure"><a id="blue_bubble_fired_here_wonapostrophet_ca"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00004"/><img src="httpatomoreillycomsourcenostarchimages2184495.png.jpg" alt="The blue bubble fired here won’t cause the green group above it to pop. Instead, it will be added to the board."/></div></div><p class="title">Figure 1-3. The blue bubble fired here won’t cause the green group above it to pop. Instead, it will be added to the board.</p></div><p><a id="iddle1233" class="indexterm"/><a id="iddle1290" class="indexterm"/><a id="iddle1309" class="indexterm"/><a id="iddle1330" class="indexterm"/><a id="iddle1434" class="indexterm"/><a id="iddle2347" class="indexterm"/><a id="iddle1051" class="indexterm"/><a id="iddle1075" class="indexterm"/><a id="iddle1079" class="indexterm"/><a id="iddle1303" class="indexterm"/><a id="iddle1310" class="indexterm"/><a id="iddle1324" class="indexterm"/><a id="iddle1325" class="indexterm"/><a id="iddle1331" class="indexterm"/><a id="iddle1435" class="indexterm"/><a id="iddle1658" class="indexterm"/><a id="iddle1662" class="indexterm"/><a id="iddle1735" class="indexterm"/><a id="iddle1898" class="indexterm"/><a id="iddle1900" class="indexterm"/><a id="iddle1913" class="indexterm"/><a id="iddle1999" class="indexterm"/><a id="iddle2026" class="indexterm"/><a id="iddle2069" class="indexterm"/><a id="iddle2290" class="indexterm"/><a id="iddle2291" class="indexterm"/><a id="iddle2316" class="indexterm"/><a id="iddle2442" class="indexterm"/><a id="iddle2607" class="indexterm"/><a id="iddle2645" class="indexterm"/>Fired bubbles that don’t form a matching group of three or more stick in the bubble grid. Because bubbles behave as if they’re all hanging from the top row, if a set of bubbles can’t trace a connection back to the top after a matching color group is created and removed, we need to remove those “orphaned” bubbles from the screen. An example of an orphaned bubble is shown <a class="xref" href="ch01.html#red_bubble_is_orphaneddot_we_donapostrop" title="Figure 1-4. The red bubble is orphaned. We don’t want to leave orphaned bubbles hanging, so we’ll need some logic to detect them and an animation to remove them from the screen.">Figure 1-4</a>.</p><div class="figure"><a id="red_bubble_is_orphaneddot_we_donapostrop"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00005"/><img src="httpatomoreillycomsourcenostarchimages2184497.png.jpg" alt="The red bubble is orphaned. We don’t want to leave orphaned bubbles hanging, so we’ll need some logic to detect them and an animation to remove them from the screen."/></div></div><p class="title">Figure 1-4. The red bubble is orphaned. We don’t want to leave orphaned bubbles hanging, so we’ll need some logic to detect them and an animation to remove them from the screen.</p></div><p>Players can fire only a limited number of bubbles (<a class="xref" href="ch01.html#screenshot_of_the_finished_bubble_shoote" title="Figure 1-1. A screenshot of the finished Bubble Shooter game">Figure 1-1</a> shows 70), and they must clear the board before they run out of bubbles to shoot. At the end of each level, the player scores points for popping bubbles and progresses to the next level. The game ends when the player fails to clear a level.</p><p>Short of a couple of enhancements that we’ll add later, that’s the main flow of the game.</p><p>We’ll build the game mechanics using HTML, CSS, and JavaScript—core tools that are well suited to creating many simple games, especially two-dimensional games that don’t require detailed pixel manipulation. In <span class="emphasis"><em>Bubble Shooter</em></span>, we’re essentially firing a circle (the bubble) into a grid of other circles (bubbles) and then either popping a group, as in <a class="xref" href="ch01.html#blue_bubble_is_fired_at_the_groupcomma_c" title="Figure 1-2. The blue bubble is fired at the group, creating a match, and all of the highlighted bubbles will pop.">Figure 1-2</a>, or adding the bubble to the board, as in <a class="xref" href="ch01.html#blue_bubble_fired_here_wonapostrophet_ca" title="Figure 1-3. The blue bubble fired here won’t cause the green group above it to pop. Instead, it will be added to the board.">Figure 1-3</a>. The demands of the game’s layout are fairly simple, and we can use CSS and JavaScript to perform all of the animation we’ll need.</p><p>We’ll build the user interface in HTML and CSS because like most HTML games, <span class="emphasis"><em>Bubble Shooter</em></span> will take advantage of the tasks the browser can do well, such as laying out text and rendering simple graphics. In later <a id="iddle1102" class="indexterm"/><a id="iddle1198" class="indexterm"/><a id="iddle1268" class="indexterm"/><a id="iddle1319" class="indexterm"/><a id="iddle1436" class="indexterm"/><a id="iddle1443" class="indexterm"/><a id="iddle1445" class="indexterm"/><a id="iddle1462" class="indexterm"/><a id="iddle1567" class="indexterm"/><a id="iddle1738" class="indexterm"/><a id="iddle1815" class="indexterm"/><a id="iddle1968" class="indexterm"/><a id="iddle2157" class="indexterm"/><a id="iddle2482" class="indexterm"/><a id="iddle2579" class="indexterm"/><a id="iddle2684" class="indexterm"/>chapters, we’ll explore using the <code class="literal">canvas</code> element to display the game area, but I’ll first demonstrate what you can achieve with regular Document Object Model (DOM)–based development.</p></div><div class="sect1" title="Building the Game"><div class="titlepage"><div><div><h1 class="title"><a id="building_the_game"/>Building the Game</h1></div></div></div><p>Now that we have an idea of the game we want to create, let’s break it down into manageable tasks. We’ll need to solve a number of high-level challenges to create <span class="emphasis"><em>Bubble Shooter</em></span>. Specifically, we need to do the following:</p><div class="variablelist"><dl><dt><span class="term"><span class="strong"><strong>Randomize and render the game board</strong></span></span></dt><dd><p>The bubble grid must be randomly generated and drawn onscreen for each new level.</p></dd><dt><span class="term"><span class="strong"><strong>Calculate the firing angle and stopping point for a bubble</strong></span></span></dt><dd><p>The player will fire bubbles by clicking on the screen. We’ll calculate the angle at which to fire the bubble, move it along that path, and either stop it when it hits something or let it continue.</p></dd><dt><span class="term"><span class="strong"><strong>Resolve collisions</strong></span></span></dt><dd><p>When the fired bubble hits another bubble and does not form a matching group of three or more, it will add itself to the board. Otherwise, when it does form a group of at least three bubbles of the same color, it will pop all bubbles of that color contiguous with the one it strikes. If the fired bubble does pop bubbles, we’ll check to see if we’ve created any orphaned bubbles, such as those shown in <a class="xref" href="ch01.html#red_bubble_is_orphaneddot_we_donapostrop" title="Figure 1-4. The red bubble is orphaned. We don’t want to leave orphaned bubbles hanging, so we’ll need some logic to detect them and an animation to remove them from the screen.">Figure 1-4</a>.</p></dd><dt><span class="term"><span class="strong"><strong>Keep track of score and levels</strong></span></span></dt><dd><p>The game ends when all the bubbles are cleared. Because the player has only a limited number of bubbles to fire, we’ll track the number of bubbles fired. We’ll also add a scoring system to give the player a reason to play again (to beat a high score, for example).</p></dd><dt><span class="term"><span class="strong"><strong>Handle the game’s end and new levels</strong></span></span></dt><dd><p>If a player completes a level, we’ll indicate that (using certain interface elements) and give the player an option to progress to the next level. Changing levels clears the board and tidies up the internal game state, and then the game starts again.</p></dd></dl></div></div><div class="sect1" title="Development and Testing Environment"><div class="titlepage"><div><div><h1 class="title"><a id="development_and_testing_environment"/>Development and Testing Environment</h1></div></div></div><p>Let’s set up our development environment and make sure we have the right tools to complete the game. To start developing games for the Web, you’ll need access to a range of browsers to test in and software that allows you to edit code. You’ll also need to set up a web server to view the game in <a id="iddle1106" class="indexterm"/><a id="iddle1189" class="indexterm"/><a id="iddle1190" class="indexterm"/><a id="iddle1199" class="indexterm"/><a id="iddle1536" class="indexterm"/><a id="iddle1861" class="indexterm"/><a id="iddle2057" class="indexterm"/><a id="iddle2187" class="indexterm"/><a id="iddle2295" class="indexterm"/><a id="iddle2432" class="indexterm"/><a id="iddle2578" class="indexterm"/><a id="iddle2671" class="indexterm"/><a id="iddle2704" class="indexterm"/>development. Although you can run <span class="emphasis"><em>Bubble Shooter</em></span> locally (simply by opening its <span class="emphasis"><em>index.html</em></span> file), you should regularly test your games in situations that match those of your end users as closely as possible.</p><div class="note" title="Note"><h3 class="title"><a id="ch01note01"/>Note</h3><p><span class="emphasis"><em>The process of setting up a server varies by operating system. The Apache web server (available at</em></span> <a class="ulink" href="http://httpd.apache.org/">http://httpd.apache.org/</a><span class="emphasis"><em>) has good installation packages and instructions for setting up on most system configurations.</em></span></p></div><div class="sect2" title="Web Browser Testing"><div class="titlepage"><div><div><h2 class="title"><a id="web_browser_testing"/>Web Browser Testing</h2></div></div></div><p>One rule of web development is to test on all browsers that you expect your target audience to use. Although this is essential for released software, while developing you can usually use a slightly smaller subset of browsers to identify most potential problems. The list of browsers you need to test on changes constantly, but when you release a game onto the Web, those discussed next are essential.</p><div class="sect3" title="Desktop Browsers"><div class="titlepage"><div><div><h3 class="title"><a id="desktop_browsers"/>Desktop Browsers</h3></div></div></div><p>Users of a desktop PC or laptop could end up playing your game in various browsers on any operating system, so be sure to test at least the latest versions of Internet Explorer (IE), Firefox, Chrome, and Safari for Windows and OS X. Depending on your target audience, you may need to test earlier browser versions as well.</p><p>Not everyone updates their web browsers, so when coding for a mass web audience, be sure not to ignore users who might be using earlier versions. Some versions of IE do not play well together on the same operating system (due to IE’s tight integration with Windows), so when testing, you’ll need multiple Windows installations available, either on different PCs or on virtual machines. I strongly suggest you install and use virtual machine software, such as VMWare (<span class="emphasis"><em><a class="ulink" href="http://www.vmware.com/">http://www.vmware.com/</a></em></span>), VirtualBox (<span class="emphasis"><em><a class="ulink" href="http://www.virtualbox.org/">http://www.virtualbox.org/</a></em></span>), or Virtual PC (<span class="emphasis"><em><a class="ulink" href="http://www.microsoft.com/download/">http://www.microsoft.com/download/</a></em></span>; search in the Download Center). Virtual machines allow you to run operating systems within your regular operating system, essentially simulating an entire system from your desktop. Virtual machines preinstalled with different versions of IE can be downloaded from <span class="emphasis"><em><a class="ulink" href="http://www.modern.ie/en-us/virtualization-tools/">http://www.modern.ie/en-us/virtualization-tools/</a></em></span>.</p><p>Because Firefox now updates regularly, you should be able to safely test your games on the latest release. Earlier versions have patchy HTML5 support, but later versions rarely have major changes from one release to the next. Chrome updates automatically and regularly as well, so you don’t need to worry about versions; just make sure you’re running the latest one.</p><p>And, of course, you should also test your game on a Mac in at least one version of Safari. It’s also possible to run an OS X virtual machine within Windows, although the setup is slightly more complex than running Windows within Windows or Windows within OS X. Tutorials are available online for achieving this setup within the virtual machine applications listed earlier.</p></div><div class="sect3" title="Mobile Browsers"><div class="titlepage"><div><div><h3 class="title"><a id="mobile_browsers"/>Mobile Browsers</h3></div></div></div><p><a id="iddle1026" class="indexterm"/><a id="iddle1028" class="indexterm"/><a id="iddle1103" class="indexterm"/><a id="iddle1104" class="indexterm"/><a id="iddle1186" class="indexterm"/><a id="iddle1194" class="indexterm"/><a id="iddle1594" class="indexterm"/><a id="iddle1598" class="indexterm"/><a id="iddle1719" class="indexterm"/><a id="iddle1737" class="indexterm"/><a id="iddle1992" class="indexterm"/><a id="iddle2031" class="indexterm"/><a id="iddle2062" class="indexterm"/><a id="iddle2063" class="indexterm"/><a id="iddle2073" class="indexterm"/><a id="iddle2074" class="indexterm"/><a id="iddle2086" class="indexterm"/><a id="iddle2092" class="indexterm"/><a id="iddle2179" class="indexterm"/><a id="iddle2204" class="indexterm"/><a id="iddle2205" class="indexterm"/><a id="iddle2207" class="indexterm"/><a id="iddle2210" class="indexterm"/><a id="iddle2379" class="indexterm"/><a id="iddle2414" class="indexterm"/><a id="iddle2454" class="indexterm"/><a id="iddle2577" class="indexterm"/><a id="iddle2656" class="indexterm"/><a id="iddle2705" class="indexterm"/>If you’re deploying on mobile devices or tablets, testing on a wide range of devices (iOS, Android, and Windows mobile) and multiple browsers is more important than ever. For basic mobile development, access to one iOS device and one Android device may be sufficient for testing, but when you’re considering wider distribution, the plot thickens. Apple’s iOS versions vary in their behavior, and Android comes in so many flavors on so many devices with differing screen resolutions and hardware configurations that you should have access to multiple devices (perhaps through a limited beta testing group) for testing. We won’t be packaging <span class="emphasis"><em>Bubble Shooter</em></span> for release in the Apple App Store or Google Play Store, but by virtue of writing the game using HTML5 and JavaScript, we’ll produce an app that’s playable on mobile devices without extra coding.</p><p>Ultimately, due to the fragmentation of the Android platform, it’s impossible for a single developer to test on every device; therefore, you may find it more viable to use a third-party testing service. Testing on iOS devices is slightly simpler because Apple controls its operating system and device specifications, but iPhones and iPads can be costly. When you add Windows tablets into the mix and consider the growing range of tablets and other portable devices that can run a web browser, you’ll realize that the mobile testing battle is difficult to win.</p></div></div><div class="sect2" title="Debugging in the Web Browser"><div class="titlepage"><div><div><h2 class="title"><a id="debugging_in_the_web_browser"/>Debugging in the Web Browser</h2></div></div></div><p>With your test browsers set up, you can then use several developer tools to make debugging easy. Each browser has its own development tool set, but fortunately, they all operate along similar lines, provide ways to inspect HTML elements on the page, and add breakpoints and logging to JavaScript. Learn how to access your browser’s developer tools and experiment with them to become familiar with their capabilities.</p><p>All browser debugging tools are useful, but you’ll likely use the JavaScript console the most during development. You’ll interact with your code through the console in two main ways:</p><div class="variablelist"><dl><dt><span class="term"><span class="strong"><strong>Logging to the console with the <code class="literal">console.log</code> command</strong></span></span></dt><dd><p>Call the <span class="strong"><strong><code class="literal">console.log</code></strong></span> function, and the console should display the contents of whatever you pass into the function. For example, <code class="literal">console.log("Hello")</code> should display the string <code class="literal">Hello</code>. Even better, call <code class="literal">console.log</code> with a JavaScript object or array, and you’ll get a limited listing of the object’s contents that you can use to explore entire object trees.</p></dd><dt><span class="term"><span class="strong"><strong>Running ad hoc code to interrogate variable states</strong></span></span></dt><dd><p>You can enter JavaScript code into the console to evaluate it immediately. Enter <span class="strong"><strong><code class="literal">alert(1)</code></strong></span> into the console to see how it works. If your game code exposes object properties publicly, you can use this feature to examine properties or trigger methods. You can even paste in multiple lines of code to create and run entire functions in the context of the page.</p></dd></dl></div><p><a id="iddle1275" class="indexterm"/><a id="iddle1438" class="indexterm"/><a id="iddle1439" class="indexterm"/><a id="iddle1674" class="indexterm"/><a id="iddle1905" class="indexterm"/><a id="iddle1906" class="indexterm"/><a id="iddle2029" class="indexterm"/><a id="iddle2146" class="indexterm"/><a id="iddle2147" class="indexterm"/><a id="iddle2162" class="indexterm"/><a id="iddle2163" class="indexterm"/><a id="iddle2444" class="indexterm"/><a id="iddle2566" class="indexterm"/><a id="iddle2608" class="indexterm"/><a id="iddle2646" class="indexterm"/>Now that we have some of the tools we need, let’s start building the game. We’ll begin by setting up the basic code and implementing the start screen user interface.</p></div></div><div class="sect1" title="Laying Out the Game Screen"><div class="titlepage"><div><div><h1 class="title"><a id="laying_out_the_game_screen"/>Laying Out the Game Screen</h1></div></div></div><p>Before we can program the fun parts of animation and gameplay, we need to lay out the user interface. We’ll use HTML and CSS to place the main interface elements; the game screen will consist of three major areas, shown in <a class="xref" href="ch01.html#sections_of_the_game_screen" title="Figure 1-5. Sections of the game screen">Figure 1-5</a>.</p><div class="figure"><a id="sections_of_the_game_screen"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00006"/><img src="httpatomoreillycomsourcenostarchimages2184499.png.jpg" alt="Sections of the game screen"/></div></div><p class="title">Figure 1-5. Sections of the game screen</p></div><p>At the top of the game screen, you can see the status bar ➊, which will show score and level information. The next (and largest) section contains the game area ➋, which will contain all the bubbles. The game area is also where the actual gameplay will happen. The footer ➌ at the bottom of the game screen frames the game area.</p><p>Now, let’s lay out these three <span class="emphasis"><em>Bubble Shooter</em></span> components.</p><div class="sect2" title="Creating Panels with HTML and CSS"><div class="titlepage"><div><div><h2 class="title"><a id="creating_panels_with_html_and_css"/>Creating Panels with HTML and CSS</h2></div></div></div><p><a id="iddle1108" class="indexterm"/><a id="iddle1440" class="indexterm"/><a id="iddle1751" class="indexterm"/><a id="iddle1878" class="indexterm"/><a id="iddle2033" class="indexterm"/><a id="iddle2081" class="indexterm"/><a id="iddle2148" class="indexterm"/><a id="iddle2200" class="indexterm"/><a id="iddle2452" class="indexterm"/><a id="iddle2457" class="indexterm"/><a id="iddle2462" class="indexterm"/><a id="iddle2475" class="indexterm"/><a id="iddle2573" class="indexterm"/><a id="iddle2674" class="indexterm"/><a id="iddle2685" class="indexterm"/><a id="iddle2708" class="indexterm"/>Using straightforward HTML and CSS to lay out the game screen is the easiest way to create the three panels and define where the action happens. The approach and techniques used here are identical to those used in building a regular website or web application.</p><p>We’ll start by creating a wrapper <code class="literal">div</code> for the entire page. Because the <code class="literal">div</code> tag has no semantic meaning, we’ll use it to denote a division on the page. Make a new folder in your web server’s root directory to build the game in and call it <span class="emphasis"><em>bubbleshoot</em></span>. Every file needed to run the game will be stored in this folder or within a subdirectory of it. Next, create a new file called <span class="emphasis"><em>index.html</em></span> and add the following code:</p><p><span class="emphasis"><em>index.html</em></span></p><a id="pro_id00001"/><pre class="programlisting">  &lt;!DOCTYPE HTML&gt;
  &lt;html lang="en-US"&gt;
    &lt;head&gt;
      &lt;meta charset="utf8"&gt;
      &lt;title&gt;Bubble Shooter&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
➊    &lt;div id="page"&gt;
      &lt;/div&gt;
    &lt;/body&gt;
  &lt;/html&gt;</pre><p>The entire game will run within this single HTML page, and the <code class="literal">"page" div</code> ➊ will constrain the area in which the game happens. If we ever need to center the game or move it to fit into unusual screen aspect ratios, we need only change the position of the wrapper element.</p><div class="note" title="Note"><h3 class="title"><a id="ch01note02"/>Note</h3><p><span class="emphasis"><em>Many HTML tags have been simplified in version 5, in contrast to the relative strictness in versions 3 to 4 and XHTML. For example, the doctype declaration is now vastly simplified because many tags are assigned a default type. The <code class="literal">&lt;script&gt;</code> tag actually defaults to JavaScript in HTML5, which is why we don’t need to specify <code class="literal">type="text/javascript"</code> or <code class="literal">language="javascript"</code> in our page.</em></span></p></div><p>Next, we’ll create three new <code class="literal">div</code> elements, one for each of the three page sections, and place them inside our page <code class="literal">div</code>:</p><a id="pro_id00002"/><pre class="programlisting">&lt;div id="page"&gt;
  <span class="strong"><strong>&lt;div id="top_bar"&gt;&lt;/div&gt;</strong></span>
  <span class="strong"><strong>&lt;div id="game"&gt;&lt;/div&gt;</strong></span>
  <span class="strong"><strong>&lt;div id="footer_bar"&gt;&lt;/div&gt;</strong></span>
&lt;/div&gt;</pre><p>Now, we need to assign some CSS to our page and the three sections we just added.</p><p><a id="iddle1117" class="indexterm"/><a id="iddle2243" class="indexterm"/><a id="iddle2358" class="indexterm"/><a id="iddle2570" class="indexterm"/><a id="iddle2585" class="indexterm"/>Create a folder called <span class="emphasis"><em>_css</em></span> in the game folder to contain all the style sheets we’ll use for the game. In the <span class="emphasis"><em>_css</em></span> folder, make a new file called <span class="emphasis"><em>main.css</em></span> that contains the following code:</p><p><span class="emphasis"><em>main.css</em></span></p><a id="pro_id00003"/><pre class="programlisting">  body
  {
    margin: 0;
  }
  #page
  {
    position: absolute;
    left: 0;
    top: 0;
    width: 1000px;
➊  height: 738px;
  }
  #top_bar
  {
    position: absolute;
    left: 0;
    top: 0;
    width: 1000px;
➋  height: 70px;
    background-color: #369;
    color: #fff;
  }
  #game
  {
    position: absolute;
    left: 0px;
    top: 70px;
    width: 1000px;
➌  height: 620px;
    background-color: #fff;
    clip: auto;
➍  overflow: hidden;
  }
  #footer_bar
  {
    position: absolute;
    left: 0;
    top: 690px;
    width: 1000px;
➎  height: 48px;
    background-color: #369;
  }</pre><p>We’ll make the top banner 70 pixels high ➋ and the bottom one 48 pixels high ➎. We want the game to fit in a standard monitor size, so we set the total game area to be 620 pixels high ➌, resulting in a total page height of 738 pixels ➊, which should fit within a 1024×768 display and even allow for a browser taskbar.</p><div class="sidebar"><a id="dimensions_fluid_vsdot_fixed"/><p class="title">Dimensions: Fluid vs. Fixed</p><p><a id="iddle1564" class="indexterm"/><a id="iddle1630" class="indexterm"/><a id="iddle1670" class="indexterm"/><a id="iddle1728" class="indexterm"/><a id="iddle1875" class="indexterm"/><a id="iddle1877" class="indexterm"/><a id="iddle1908" class="indexterm"/><a id="iddle2055" class="indexterm"/><a id="iddle2181" class="indexterm"/><a id="iddle2208" class="indexterm"/><a id="iddle2212" class="indexterm"/><a id="iddle2214" class="indexterm"/><a id="iddle2261" class="indexterm"/><a id="iddle2314" class="indexterm"/><a id="iddle2415" class="indexterm"/><a id="iddle2453" class="indexterm"/><a id="iddle2455" class="indexterm"/><a id="iddle2569" class="indexterm"/><a id="iddle2669" class="indexterm"/><a id="iddle2675" class="indexterm"/>To keep the game simple, I used a fixed width of 1000 pixels in the CSS, which should provide a large screen area that fits within the majority of desktop and mobile displays. Typically, the screen dimension situation is more complex; mobile devices in particular have a wide range of pixel dimensions and aspect ratios. However, we want to concentrate on development principles rather than design decisions, and 1000 pixels should work well for a prototype game.</p></div><p>These values set the size and position of the entire usable display area. Also, notice that <code class="literal">game</code> has <code class="literal">overflow:</code> set to <code class="literal">hidden</code> ➍, which means that the bubbles in the game will never accidentally display over the header or footer.</p><p>To link up the CSS file, we’ll add a file link for <span class="emphasis"><em>main.css</em></span> to the HTML header:</p><p><span class="emphasis"><em>index.html</em></span></p><a id="pro_id00004"/><pre class="programlisting">&lt;head&gt;
  &lt;meta charset="utf8"&gt;
  &lt;title&gt;Bubble Shooter&lt;/title&gt;
  <span class="strong"><strong>&lt;link href="_css/main.css" rel="stylesheet"&gt;</strong></span>
&lt;/head&gt;</pre><p>Now that we’ve created the basic structure for <span class="emphasis"><em>Bubble Shooter</em></span> with HTML and CSS, load the page in a browser and keep it open. There’s no interaction yet, so next we’ll add basic interactivity, such as a <span class="emphasis"><em>start game</em></span> dialog, before we work on the game logic. The first step is to set up the coding structure.</p></div><div class="sect2" title="Code Structure"><div class="titlepage"><div><div><h2 class="title"><a id="code_structure"/>Code Structure</h2></div></div></div><p>Let’s take a high-level look at the main concepts of the game and interface, which will guide how we’ll structure the code. With a number of significant elements to implement, we’ll structure the code in a way similar to the Model/View/Controller (MVC) principles that you may be familiar with from web application development. If MVC is new to you, here’s the basic setup:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The <span class="strong"><strong>Model</strong></span> consists of data and maintains the state of the application. In a web application, this might be user’s details or shopping cart contents, for example.</p></li><li class="listitem"><p>The <span class="strong"><strong>View</strong></span> renders what’s on the screen and intercepts user input. For web applications, this is generally HTML output. For example, a view might read the contents of an online shopping cart from the <span class="emphasis"><em>Model</em></span> and then display those items in a list.</p></li><li class="listitem"><p>The <span class="strong"><strong>Controller</strong></span> manages the logic and processing. For example, clicking an item in a <span class="emphasis"><em>View</em></span> sends a message to the <span class="emphasis"><em>Controller</em></span> to add a new item to a shopping cart <span class="emphasis"><em>Model</em></span>.</p></li></ul></div><p><a id="iddle1545" class="indexterm"/><a id="iddle1896" class="indexterm"/><a id="iddle1969" class="indexterm"/><a id="iddle2082" class="indexterm"/><a id="iddle2090" class="indexterm"/><a id="iddle2164" class="indexterm"/><a id="iddle2215" class="indexterm"/><a id="iddle2221" class="indexterm"/><a id="iddle2279" class="indexterm"/><a id="iddle2280" class="indexterm"/><a id="iddle2383" class="indexterm"/><a id="iddle2445" class="indexterm"/><a id="iddle2458" class="indexterm"/><a id="iddle2463" class="indexterm"/>With some alterations, this MVC principle will work for structuring <span class="emphasis"><em>Bubble Shooter</em></span>.</p><div class="sect3" title="Game Controller"><div class="titlepage"><div><div><h3 class="title"><a id="game_controller"/>Game Controller</h3></div></div></div><p>The game controller will keep track of the game state and act as a director to determine outcomes in response to user actions.</p><p>The game controller is similar to a controller in the MVC system; it will run the game and manage all the functions. In a more complex game, a single controller would become too big and complicated to handle every task, because there would be too much code in one place and one set of code would have too many responsibilities, making the code more prone to bugs that would be harder to find. In that case, we’d probably need to subdivide the tasks further. Fortunately, because <span class="emphasis"><em>Bubble Shooter</em></span> is so simple, using one controller to manage all tasks should work well.</p></div><div class="sect3" title="User Interface Code"><div class="titlepage"><div><div><h3 class="title"><a id="user_interface_code"/>User Interface Code</h3></div></div></div><p>The game needs to display all kinds of information for the user, including score updates, level end screens, and so on. Instead of the game controller handling these tasks, it will instruct a set of user interface functions to control the way the user interface elements appear and disappear.</p><p>You could put much of the UI code into the game controller, but you’ll often end up writing as much animation and UI code as game logic, so it’s best to separate the code for readability. Generally, if you’re not changing the state of the game in some way but instead are managing a function in the display, you should do that in the UI code.</p></div><div class="sect3" title="Game Elements as Objects"><div class="titlepage"><div><div><h3 class="title"><a id="game_elements_as_objects"/>Game Elements as Objects</h3></div></div></div><p>We’ll code a few game elements as objects, including the bubbles and the game board. The reason is that we’ll have properties—<span class="emphasis"><em>x</em></span>- and <span class="emphasis"><em>y</em></span>-coordinates for the bubbles, for example—and methods to apply, such as bubbles popping. Following object-oriented programming convention, we’ll split those objects into separate classes so the code structure maps to the conceptual elements involved in making the game.</p><p>The game’s objects will also align closely with the idea of a model in the MVC web pattern. Objects will have properties and state, but they really shouldn’t interact with the display or make significant gameplay decisions.</p></div></div></div><div class="sect1" title="Adding the First Scripts"><div class="titlepage"><div><div><h1 class="title"><a id="adding_the_first_scripts"/>Adding the First Scripts</h1></div></div></div><p>We’ll use <span class="emphasis"><em>Modernizr</em></span>, a JavaScript library, to load in all of the JavaScript files the game will need, such as the game controller and the UI class mentioned earlier. Using Modernizr has some advantages over using conventional <code class="literal">&lt;script&gt;</code> tags, and I’ll explain those later in this chapter. Modernizr has other useful features as well, but we’ll start by loading in the script files we need.</p><div class="sect2" title="The Modernizr and jQuery Libraries"><div class="titlepage"><div><div><h2 class="title"><a id="modernizr_and_jquery_libraries"/>The Modernizr and jQuery Libraries</h2></div></div></div><p><a id="iddle1021" class="indexterm"/><a id="iddle1110" class="indexterm"/><a id="iddle1204" class="indexterm"/><a id="iddle1217" class="indexterm"/><a id="iddle1470" class="indexterm"/><a id="iddle1485" class="indexterm"/><a id="iddle1490" class="indexterm"/><a id="iddle1611" class="indexterm"/><a id="iddle1651" class="indexterm"/><a id="iddle1761" class="indexterm"/><a id="iddle1769" class="indexterm"/><a id="iddle1849" class="indexterm"/><a id="iddle1979" class="indexterm"/><a id="iddle1984" class="indexterm"/><a id="iddle2089" class="indexterm"/><a id="iddle2101" class="indexterm"/><a id="iddle2106" class="indexterm"/><a id="iddle2119" class="indexterm"/><a id="iddle2218" class="indexterm"/><a id="iddle2225" class="indexterm"/><a id="iddle2471" class="indexterm"/><a id="iddle2686" class="indexterm"/>To short-cut some common tasks throughout the development of the game, we’ll rely heavily on two libraries. Both libraries solve many cross-browser problems and provide high-level functions in a simple and consistent instruction set.</p><p>Modernizr will load scripts and detect whether a given feature is available in a browser. As an example, let’s write some code to detect whether the <code class="literal">canvas</code> element is supported. To code this by hand, you would create a <code class="literal">canvas</code> node within the DOM and then check whether or not it supports a given method. In this example, we’ll use the <code class="literal">canvas</code> element’s <code class="literal">getContext</code> method, which is supported everywhere that <code class="literal">canvas</code> is supported, although you could try any <code class="literal">canvas</code> method you like:</p><a id="pro_id00005"/><pre class="programlisting">var element = document.createElement("canvas");
var canvasSupported = !!element.getContext;</pre><p>With Modernizr, we don’t have to do as much work. We can simply write:</p><a id="pro_id00006"/><pre class="programlisting">var canvasSupported = Modernizr.canvas;</pre><p>The Modernizr object contains a set of properties whose values are set at load time to either <code class="literal">true</code> or <code class="literal">false</code>, depending on whether a particular feature is supported or not by the browser. As such, the variable <code class="literal">canvasSupported</code> should now contain either <code class="literal">true</code> or <code class="literal">false</code>, depending on the value of <code class="literal">Modernizr.canvas</code>. Using Modernizr to check for features is helpful because if a browser changes how it implements a feature, Modernizr will likely receive new detection routines faster than you can detect and implement the change within your codebase.</p><p>jQuery also provides useful shorthand functions, but these largely involve detecting and responding to events, making Asynchronous JavaScript and XML (AJAX) requests to communicate with a server or accessing and manipulating HTML elements in the browser’s DOM.</p><p>The DOM is the browser’s internal organization of an HTML document, and we’ll primarily use jQuery’s DOM access methods to simplify much of the animation code. The DOM provides a way for you to manipulate the structure of the HTML by exposing each element in the HTML as a DOM node. To manipulate the DOM, we first use JavaScript to select a node. We can then change one or more of its properties, which is possible and relatively straightforward with regular JavaScript. But using jQuery makes the code more likely to work as intended without writing code to handle browsers that implement individual features differently.</p><p>The most trivial example of jQuery in action is selecting a DOM node with an ID, such as the <code class="literal">game div</code> we’ve created. In conventional JavaScript, we would write this as</p><a id="pro_id00007"/><pre class="programlisting">var element = document.getElementById("game");</pre><p><a id="iddle1001" class="indexterm"/><a id="iddle1004" class="indexterm"/><a id="iddle1678" class="indexterm"/><a id="iddle1782" class="indexterm"/><a id="iddle1978" class="indexterm"/><a id="iddle2039" class="indexterm"/><a id="iddle2103" class="indexterm"/><a id="iddle2122" class="indexterm"/><a id="iddle2133" class="indexterm"/><a id="iddle2467" class="indexterm"/>This line of code retrieves a single DOM element, which will have various properties, such as its CSS formatting and methods that allow it to be interrogated. For example, <code class="literal">element.getAttribute("id")</code> will return the string <code class="literal">game</code>.</p><p>jQuery provides a way to wrap this functionality, and more, in a simpler, more compact syntax. To achieve the same result as the preceding code line with jQuery, we use jQuery selectors. <span class="emphasis"><em>Selectors</em></span> are syntax for selecting a node or nodes within the DOM, and their format—including dot notation and using <code class="literal">#</code> to select unique elements—is borrowed from CSS selectors. The values returned from jQuery’s selectors aren’t DOM nodes but rather custom objects that contain a reference to the DOM nodes and add a range of other methods. The equivalent of <code class="literal">document.getElementById("game").getAttribute("id")</code> using a jQuery selector is <code class="literal">$("#game").attr("id")</code>.</p><p>Selectors are a core jQuery concept, and you’ll become very familiar with using them by the end of this book. Nearly all of jQuery is used to manipulate DOM elements, so calls to jQuery almost always specify which element or elements should be changed, and that’s where selectors come in. They let you choose an HTML node set using a range of factors, such as the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>A unique ID for selecting single elements</p></li><li class="listitem"><p>A CSS class for selecting all the DOM elements with that class</p></li><li class="listitem"><p>The tag that defines the node (<code class="literal">div</code>, <code class="literal">img</code>, <code class="literal">span</code>, and so on), which allows you, for example, to select all the images on a page</p></li><li class="listitem"><p>Many other options, including combinations of the previous items in this list, the element’s position in a list, parent-child relationships, or nearly any other way you can traverse a DOM</p></li></ul></div><p>The jQuery object that the call to <code class="literal">$</code> returns lets you manipulate the DOM object.</p><p>So in jQuery, the <code class="literal">document.getElementById</code> call is shortened to</p><a id="pro_id00008"/><pre class="programlisting">var element = jQuery("#game").get(0);</pre><p>We require the <code class="literal">.get(0)</code> function call to retrieve the DOM object from within the jQuery object, although generally it’s more useful to work with jQuery objects than with DOM objects directly. This can be further shortened to</p><a id="pro_id00009"/><pre class="programlisting">var element = $("#game").get(0);</pre><p>The value <code class="literal">$</code> is defined as an alias to the <code class="literal">jQuery</code> function, which does one of several tasks based on what you pass into it. For a selector, we pass a string value (in this case, <code class="literal">"#game"</code>) to jQuery. As in CSS, the hash symbol tells jQuery that we want to select a single element by its ID. The value <code class="literal">$("#game")</code> returns the jQuery object containing a reference to the DOM node.</p><p>You can use jQuery selectors to retrieve multiple DOM nodes, which are stored internally as an array. If you want to access the DOM node, you can <a id="iddle1486" class="indexterm"/><a id="iddle1652" class="indexterm"/><a id="iddle1681" class="indexterm"/><a id="iddle2036" class="indexterm"/><a id="iddle2117" class="indexterm"/><a id="iddle2216" class="indexterm"/><a id="iddle2217" class="indexterm"/><a id="iddle2228" class="indexterm"/><a id="iddle2236" class="indexterm"/><a id="iddle2464" class="indexterm"/><a id="iddle2586" class="indexterm"/><a id="iddle2697" class="indexterm"/>retrieve the <span class="emphasis"><em>n</em></span>th element returned from a query by calling <code class="literal">.get(n)</code> on the jQuery object. Because we have only one element with the ID <code class="literal">game</code>, we want the first (zero index) element, which we can retrieve by adding <code class="literal">.get(0)</code> onto the end of <code class="literal">$("#game")</code>.</p><p>We don’t save much coding in this simple case, but more important, we can use the objects that jQuery returns from selection queries with cross-browser methods that abstract away a lot of the hard work of DOM manipulation.</p><p>jQuery objects let us query the DOM node for various CSS properties, as in these examples:</p><a id="pro_id00010"/><pre class="programlisting">var top = $("#game").css("top");
var width = $("#game").width();
var divs = $("div");</pre><p>The first two lines query the DOM node for the game <code class="literal">div</code>’s <code class="literal">top</code> position and width, respectively, and the last line is a selector that returns a jQuery object containing all the <code class="literal">div</code> tags on a page. jQuery is a powerful library, and although we’ll use quite a few of its features in the game, covering it in great detail is beyond the scope of this book. The jQuery documentation at <span class="emphasis"><em><a class="ulink" href="http://api.jquery.com/">http://api.jquery.com/</a></em></span> provides an in-depth look at how it works.</p></div><div class="sect2" title="Adding the Modernizr Library"><div class="titlepage"><div><div><h2 class="title"><a id="adding_the_modernizr_library"/>Adding the Modernizr Library</h2></div></div></div><p>To get started with Modernizr, download it from its official website (<span class="emphasis"><em><a class="ulink" href="http://modernizr.com/download/">http://modernizr.com/download/</a></em></span>). Modernizr lets you choose individual features to download so you don’t waste bandwidth on code that you’ll never use. We’ll need a few specific features, so make sure you select the following boxes on the download page to include them:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>CSS Transitions (under CSS3)</p></li><li class="listitem"><p>Canvas and HTML5 Audio (under HTML5)</p></li><li class="listitem"><p>Modernizr.load (under Extra)</p></li><li class="listitem"><p>Modernizr.prefixed (under Extensibility)</p></li></ul></div><p>Then, click <span class="strong"><strong>Generate</strong></span> and <span class="strong"><strong>Download</strong></span>.</p><p>Create a new folder in the game folder called <span class="emphasis"><em>_js</em></span> and save the file there as <span class="emphasis"><em>modernizr.js</em></span>. Also add the file to the HTML document, as shown here:</p><p><span class="emphasis"><em>index.html</em></span></p><a id="pro_id00011"/><pre class="programlisting">&lt;head&gt;
  &lt;meta charset="utf8"&gt;
  &lt;title&gt;Bubble Shooter&lt;/title&gt;
  &lt;link href="_css/main.css" rel="stylesheet"&gt;
  <span class="strong"><strong>&lt;script src="_js/modernizr.js"&gt;&lt;/script&gt;</strong></span>
&lt;/head&gt;</pre><p>Now that we’ve added Modernizr with a <code class="literal">&lt;script&gt;</code> tag, we’ll use it to load the rest of the JavaScript game files.</p></div><div class="sect2" title="Loading Scripts with Modernizr"><div class="titlepage"><div><div><h2 class="title"><a id="loading_scripts_with_modernizr"/>Loading Scripts with Modernizr</h2></div></div></div><p><a id="iddle1126" class="indexterm"/><a id="iddle1188" class="indexterm"/><a id="iddle1533" class="indexterm"/><a id="iddle1601" class="indexterm"/><a id="iddle2083" class="indexterm"/><a id="iddle2170" class="indexterm"/><a id="iddle2171" class="indexterm"/><a id="iddle2222" class="indexterm"/><a id="iddle2296" class="indexterm"/><a id="iddle2459" class="indexterm"/><a id="iddle2469" class="indexterm"/><a id="iddle2687" class="indexterm"/><a id="iddle2710" class="indexterm"/>Rather than just adding <code class="literal">&lt;script&gt;</code> tags to the document, we use Modernizr to load scripts for two main reasons. First, we can trigger functions to run immediately after a script is loaded rather than waiting until the entire page, including HTML and images, has loaded. Second, Modernizr allows us to load scripts in on a conditional basis (for example, <span class="emphasis"><em>if this condition is satisfied, load in this script</em></span>) without writing much code to do it.</p><div class="note" title="Note"><h3 class="title"><a id="ch01note03"/>Note</h3><p><span class="emphasis"><em>Modernizr actually uses another library called</em></span> yepnope.js <span class="emphasis"><em>for its script-loading functionality. You can learn more about that library at</em></span> <a class="ulink" href="http://yepnopejs.com">http://yepnopejs.com</a><span class="emphasis"><em>/</em></span>.</p></div><p>A simple example of this is to load jQuery from Google’s Content Delivery Network (CDN) to expedite load times. The potential flaw with using a third-party CDN is that the CDN could be down or inaccessible, or, more likely, your own server could be unavailable. However, relying on a service that you can’t control is never a good idea. Fortunately, Modernizr lets you add a test during the loading process and then call a backup function if that test fails. As a result, we can attempt to load the file from the CDN, and if it doesn’t work, load a local version instead.</p><div class="sidebar"><a id="why_use_googleapostrophes_hosted_jqueryq"/><p class="title">Why Use Google’s Hosted jQuery?</p><p>Although it may seem odd to rely on someone else’s server to obtain a critical file, using Google’s version of jQuery offers a few advantages, and I don’t just mean saving money or using someone else’s bandwidth should you create a popular game.</p><p>One advantage is that because the file comes from Google’s Content Delivery Network, users will almost always download it from a server closer to them than your server.</p><p>Another advantage is that, because the file comes from a server other than the one your game is hosted on, users can actually download it faster. Browsers often limit the number of connections they’ll open to a single server, so files wait in a queue to be downloaded, even if plenty of bandwidth is available. By hosting files on a different server, you increase the number of files that are downloaded in parallel and decrease the download time.</p><p>An additional advantage is that other sites are using the same copy of jQuery; therefore, if users have visited any of them recently, they’ll most likely have a copy of the file in their browser cache and won’t have to download the file at all!</p></div><p><a id="iddle2105" class="indexterm"/><a id="iddle2123" class="indexterm"/>Download the latest jQuery build from <span class="emphasis"><em><a class="ulink" href="http://jquery.com/download/">http://jquery.com/download/</a></em></span> and place it in the <span class="emphasis"><em>_js</em></span> folder. Then add the following code block in bold just before the closing <code class="literal">&lt;/head&gt;</code> tag. Be sure to change the version of jQuery in the URLs to match the version that you’ve downloaded.</p><p><span class="emphasis"><em>index.html</em></span></p><a id="pro_id00012"/><pre class="programlisting">  &lt;head&gt;
    &lt;meta charset="utf8"&gt;
    &lt;title&gt;Bubble Shooter&lt;/title&gt;
    &lt;link href="_css/main.css" rel="stylesheet"&gt;
    &lt;script src="_js/modernizr.js"&gt;&lt;/script&gt;
    <span class="strong"><strong>&lt;script&gt;</strong></span>
➊  <span class="strong"><strong>Modernizr.load({</strong></span>
      <span class="strong"><strong>load: "//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.js",</strong></span>
➋      <span class="strong"><strong>complete: function () {</strong></span>
➌        <span class="strong"><strong>if(!window.jQuery){</strong></span>
➍          <span class="strong"><strong>Modernizr.load("_js/jquery-1.8.2.min.js");</strong></span>
        <span class="strong"><strong>}</strong></span>
      <span class="strong"><strong>}</strong></span>
    <span class="strong"><strong>});</strong></span>
    <span class="strong"><strong>&lt;/script&gt;</strong></span>
  &lt;/head&gt;</pre><p>This example shows the compact script loading Modernizr provides. In short, it attempts to load jQuery from the Google CDN ➊. When loading is finished ➋ (either when the file has loaded or the script returns from a failure to load), the <code class="literal">complete</code> property’s function call checks for the existence of <code class="literal">window.jQuery</code> ➌, and if that object doesn’t exist, loads the jQuery library from the local folder ➍.</p><p>The reason that <code class="literal">Modernizr.load</code> is called with two different sets of parameters is that the file can accept the following types of arguments: a single file (as a string), an object with name/value pairs, or an array containing a set of either strings or objects. Consequently, we can load in multiple files with a single <code class="literal">Modernizr.load</code> call. In the first call ➊, we pass in an object with <code class="literal">load</code> and <code class="literal">complete</code> properties. (The Modernizr website documents other properties available to use.) At the second call ➍, we only pass in a string. This line</p><a id="pro_id00013"/><pre class="programlisting"><span class="strong"><strong>Modernizr.load("_js/jquery-1.8.2.min.js");</strong></span></pre><p>is equivalent to writing</p><a id="pro_id00014"/><pre class="programlisting"><span class="strong"><strong>Modernizr.load({load : "_js/jquery-1.8.2.min.js"});</strong></span></pre><p>The first version uses the filename string as a convenient shorthand for loading just that file without any other configuration options.</p><p><a id="iddle1897" class="indexterm"/><a id="iddle2087" class="indexterm"/><a id="iddle2088" class="indexterm"/><a id="iddle2240" class="indexterm"/><a id="iddle2241" class="indexterm"/><a id="iddle2262" class="indexterm"/>We also want to load in the game scripts with Modernizr. Create a new file called <span class="emphasis"><em>game.js</em></span> in the <span class="emphasis"><em>_js</em></span> folder. To add the new file to <code class="literal">.load</code>, wrap the first <code class="literal">Modernizr.load</code> call in array brackets and add a new entry, shown here in bold:</p><p><span class="emphasis"><em>index.html</em></span></p><a id="pro_id00015"/><pre class="programlisting">Modernizr.load(<span class="strong"><strong>[</strong></span>{
    load: "//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.js",
    complete: function () {
      if(!window.jQuery){
        Modernizr.load("_js/jquery-1.8.2.min.js");
      }
    },
  },
  <span class="strong"><strong>{</strong></span>
    <span class="strong"><strong>load: "_js/game.js"</strong></span>
  <span class="strong"><strong>}]</strong></span>);</pre><p>We can continue adding new files to the <code class="literal">Modernizr.load</code> call as new elements in the array at any point before we load <span class="emphasis"><em>game.js</em></span>.</p><p>Modernizr will load <span class="emphasis"><em>game.js</em></span>, but the file doesn’t contain any code yet. The next task is to set up the main game controller class and run it when loading is complete.</p></div><div class="sect2" title="Modular JavaScript"><div class="titlepage"><div><div><h2 class="title"><a id="modular_javascript"/>Modular JavaScript</h2></div></div></div><p>To minimize global variables and the potential for duplicate variable name conflicts, we’ll use a modular approach for the JavaScript code. Using a <span class="emphasis"><em>module</em></span> is a way of wrapping all the objects and variables of the game within a single containing namespace. The namespace will be called <span class="emphasis"><em>BubbleShoot</em></span>. A class named <code class="literal">Game</code> will be contained within the module <code class="literal">BubbleShoot.Game</code> and can be accessed from anywhere else in the application by writing <code class="literal">BubbleShoot.Game</code>. This namespace is a safeguard: If we add another JavaScript library later in development that also has a variable named <code class="literal">Game</code>, both can exist simultaneously without conflict.</p><p>We’ll start with the game module, which will run much of the game. Enter the following code into <span class="emphasis"><em>game.js</em></span>:</p><p><span class="emphasis"><em>game.js</em></span></p><a id="pro_id00016"/><pre class="programlisting">➊ var BubbleShoot = window.BubbleShoot || {};
➋ BubbleShoot.Game = (function($){
➌   var Game = function(){};
➍   return Game;
➎ })(jQuery);</pre><p>First, we check to see whether the object <code class="literal">BubbleShoot</code> exists ➊. Naming our code <code class="literal">BubbleShoot.Game</code> is roughly equivalent to using a namespace in languages such as Java or C#. All of the classes will be properties of the <code class="literal">BubbleShoot</code> object. Naming collisions aren’t likely to happen in small games like <span class="emphasis"><em>Bubble Shooter</em></span> but can become a problem with larger projects. If <code class="literal">window.BubbleShoot</code> doesn’t exist, it will be created as an empty object. We’ll include this line at the top of every class file so we don’t have to think about the order in which scripts are loaded.</p><p><a id="iddle1118" class="indexterm"/><a id="iddle1451" class="indexterm"/><a id="iddle1671" class="indexterm"/><a id="iddle1741" class="indexterm"/><a id="iddle1747" class="indexterm"/><a id="iddle1990" class="indexterm"/><a id="iddle2040" class="indexterm"/><a id="iddle2050" class="indexterm"/><a id="iddle2268" class="indexterm"/><a id="iddle2359" class="indexterm"/><a id="iddle2438" class="indexterm"/><a id="iddle2587" class="indexterm"/><a id="iddle2652" class="indexterm"/>The next code line defines <code class="literal">BubbleShoot.Game</code> ➋. This structure—a function inside brackets—may look strange if you’re not familiar with it, but it’s a common approach to use when you’re writing JavaScript modules.</p><p>The structure uses an <span class="emphasis"><em>Immediately Invoked Function Expression (IIFE)</em></span>, which is a piece of code that creates a function and runs it immediately. Usually, you will assign the returned results to a variable. The benefit is that the function block creates a variable scope within JavaScript, meaning that any variables created inside it won’t pollute the global scope.</p><p>The variable declaration contains a function definition followed by parentheses ➎. The function is created, run, and instantly destroyed, but not before returning its contents ➍, which will be the object <code class="literal">Game</code> created at ➌. The bracket-wrapped function call ➋ is inside the new scope. Once this function has run, we can access the <code class="literal">Game</code> class from the global scope as <code class="literal">BubbleShoot.Game</code>.</p><p>Now we have a stub of a class, so we need to add some useful code to run. Let’s start by hooking up a New Game button. Add the following to <span class="emphasis"><em>index.html</em></span> inside the page <code class="literal">div</code>:</p><p><span class="emphasis"><em>index.html</em></span></p><a id="pro_id00017"/><pre class="programlisting">  &lt;div id="page"&gt;
    &lt;div id="top_bar"&gt;&lt;/div&gt;
    &lt;div id="game"&gt;&lt;/div&gt;
    &lt;div id="footer_bar"&gt;&lt;/div&gt;
➊    <span class="strong"><strong>&lt;div id="start_game" class="dialog"&gt;</strong></span>
➋      <span class="strong"><strong>&lt;div id="start_game_message"&gt;</strong></span>
        <span class="strong"><strong>&lt;h2&gt;Start a new game&lt;/h2&gt;</strong></span>
      <span class="strong"><strong>&lt;/div&gt;</strong></span>
➌    <span class="strong"><strong>&lt;div class="but_start_game button"&gt;</strong></span>
        <span class="strong"><strong>New Game</strong></span>
      <span class="strong"><strong>&lt;/div&gt;</strong></span>
    <span class="strong"><strong>&lt;/div&gt;</strong></span>
  &lt;/div&gt;</pre><p>The new <code class="literal">div</code> elements will create a dialog that displays information to players before they start the game ➊. The dialog will contain a heading with a message ➋ and a New Game button ➌. We still need to add some styling for them to the end of <span class="emphasis"><em>main.css</em></span>, so let’s do that now.</p><p><span class="emphasis"><em>main.css</em></span></p><a id="pro_id00018"/><pre class="programlisting">.dialog
{
  position: absolute;
  left: 300px;
  top: 110px;
  height: 460px;
  width: 320px;
  background-color: #369;
  border-radius: 30px;
  border: 2px solid #99f;
  padding: 20px 50px;
  color: #fff;
  text-align: center;
  display: none;
}
.dialog h2
{
  font-size: 28px;
  color: #fff;
  margin: 20px 0 20px;
}
.but_start_game
{
  position: absolute;
  left: 100px;
  top: 360px;
  height: 60px;
  width: 200px;
  background-color: #f00;
  cursor: pointer;
  border-radius: 15px;
  border: 2px solid #f66;
  font-size: 28px;
  line-height: 60px;
  font-weight: bold;
  text-shadow: 0px 1px 1px #f99;
}
.but_start_game:hover
{
  background-color: #f33;
}
#start_game
{
  display: block;
}</pre><p><a id="iddle1132" class="indexterm"/><a id="iddle1546" class="indexterm"/><a id="iddle1816" class="indexterm"/><a id="iddle1823" class="indexterm"/><a id="iddle1880" class="indexterm"/><a id="iddle1943" class="indexterm"/><a id="iddle1956" class="indexterm"/><a id="iddle2023" class="indexterm"/><a id="iddle2124" class="indexterm"/><a id="iddle2172" class="indexterm"/><a id="iddle2297" class="indexterm"/><a id="iddle2549" class="indexterm"/>With this styling in place in <span class="emphasis"><em>main.css</em></span>, reload the page to see the dialog. But note that there’s no way for the player to remove it yet. This will happen inside the <code class="literal">Game</code> class.</p><p>Next, we need some code to run when the page has finished loading so we can attach an event handler to the New Game button. One function will initialize the objects and set up the game after the page has loaded, and another will run every time a new game starts. Make the following changes to <span class="emphasis"><em>game.js</em></span>:</p><p><span class="emphasis"><em>game.js</em></span></p><a id="pro_id00019"/><pre class="programlisting">  BubbleShoot.Game = (function($){
    var Game = function(){
➊    <span class="strong"><strong>this.init = function(){</strong></span>
➋      <span class="strong"><strong>$(".but_start_game").bind("click",startGame);</strong></span>
      <span class="strong"><strong>};</strong></span>
➌    <span class="strong"><strong>var startGame = function(){</strong></span>
      <span class="strong"><strong>};</strong></span>
    };
    return Game;
  })(jQuery);</pre><p><a id="iddle1002" class="indexterm"/><a id="iddle1562" class="indexterm"/><a id="iddle1771" class="indexterm"/><a id="iddle2041" class="indexterm"/><a id="iddle2045" class="indexterm"/><a id="iddle2051" class="indexterm"/><a id="iddle2104" class="indexterm"/><a id="iddle2229" class="indexterm"/><a id="iddle2378" class="indexterm"/><a id="iddle2703" class="indexterm"/>This new code sets up one public method, called <code class="literal">init</code> ➊, and one private method, called <code class="literal">startGame</code> ➌. The <code class="literal">init</code> method is public because it’s attached as a property of the <code class="literal">Game</code> object. Inside <code class="literal">init</code>, we add a jQuery event handler called <code class="literal">bind</code> to the New Game button ➋, which will call the <code class="literal">startGame</code> function whenever the button is clicked.</p><p>We know the IIFE has a short life and isn’t attached as a property of any object, and yet the <code class="literal">startGame</code> function can be called here. The reason is due to a JavaScript feature called <span class="emphasis"><em>closure</em></span>. Closure means that a variable exists within the code block that defined it and persists inside that code block. Therefore, the <code class="literal">startGame</code> function can be used within other functions inside <code class="literal">Game</code>, including <code class="literal">init</code>, but can’t be accessed by any JavaScript outside of this scope.</p><p>We want to call <code class="literal">init</code> after the page has loaded, so back in <span class="emphasis"><em>index.html</em></span> we’ll add a <code class="literal">complete</code> call in <code class="literal">Modernizr.load</code> once <span class="emphasis"><em>game.js</em></span> has finished loading:</p><p><span class="emphasis"><em>index.html</em></span></p><a id="pro_id00020"/><pre class="programlisting">  Modernizr.load([{
      load: "//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.js",
      complete: function(){
        if(!window.jQuery){
          Modernizr.load("_js/jquery-1.8.2.min.js");
        }
      }
    },
    {
      load: "_js/game.js",
      <span class="strong"><strong>complete: function(){</strong></span>
➊      <span class="strong"><strong>$(function(){</strong></span>
➋        <span class="strong"><strong>var game = new BubbleShoot.Game();</strong></span>
➋        <span class="strong"><strong>game.init();</strong></span>
        <span class="strong"><strong>})</strong></span>
      <span class="strong"><strong>}</strong></span>
    }]};</pre><p>Recall that the <code class="literal">$</code> function ➊ is shorthand for the <code class="literal">jQuery</code> function, which can do one of several tasks based on what you pass into it. Previously, we’ve passed in a string (<code class="literal">#game</code>), which jQuery interpreted as a selector. In this case, we’re passing in a function, which jQuery stores to run once the DOM is ready to be manipulated.</p><p>This bit of jQuery functionality is incredibly useful, especially for a game, because from this point we know that we can safely manipulate the DOM with JavaScript even if all of the game’s other assets (such as images and sounds) haven’t finished loading. Traditionally, client-side interaction has been triggered by waiting for a <code class="literal">window.onload</code> event to fire from within JavaScript, which signifies that the HTML has loaded, the DOM is ready, and all of the images are loaded. However, waiting for the images can leave <a id="iddle1653" class="indexterm"/><a id="iddle2093" class="indexterm"/><a id="iddle2439" class="indexterm"/><a id="iddle2484" class="indexterm"/><a id="iddle2653" class="indexterm"/>users staring at screens they can’t interact with for too long. The preferable alternative is to allow users to interact with the application as soon as the DOM is ready without waiting for the images to load, which produces more responsive interfaces. But determining when the DOM is ready often involves code unique to each browser vendor and frequently changes from one version of a browser to the next. jQuery’s <code class="literal">$</code> function smoothes over any browser inconsistencies and lets you achieve that responsiveness without having to determine exactly when the DOM is ready.</p><p>Look back at the <code class="literal">$</code> function. Inside it we created an instance of the <code class="literal">Game</code> class ➋ and then called the public <code class="literal">init</code> method ➌ of that class. Based on what we know about the <code class="literal">$</code> function, anything we do inside <code class="literal">init</code> should happen after jQuery has loaded and the DOM is ready for us to work with it.</p><p>Now we have an instance of <code class="literal">Game</code> that binds its <code class="literal">startGame</code> function to the New Game button. However, the <code class="literal">startGame</code> function still doesn’t do anything. Let’s change that!</p><div class="sidebar"><a id="introducing_closure"/><p class="title">Introducing Closure</p><p>One of JavaScript’s most powerful features, <span class="emphasis"><em>closure</em></span> means that variables that have been defined within a function are stored in the function’s scope. These variables persist within the scope even when the function has exited, so long as the JavaScript interpreter determines that it still has to make use of them. Reasons for persisting in the scope could include an event handler that requires one of the values when it is triggered or a <code class="literal">setTimeout</code> call that will need access to a variable at some time in the future. A simple example will help to explain how this works, but it’s worth reading up on closure in order to better make use of it within your own functions.</p><p>The following example shows how scope works in JavaScript (and many other languages). The three <code class="literal">alert</code> calls in this example should display alerts of 1, 2, and 1 respectively, because the value of <code class="literal">myVar</code> inside the function does not overwrite the value in the parent scope. You can run this code from the JavaScript console:</p><a id="pro_id00021"/><pre class="programlisting">var myVar = 1;
alert(myVar);
function innerMyVar(){
  var myVar = 2;
  alert(myVar);
};
innerMyVar();
alert(myVar);</pre><p><a id="iddle1742" class="indexterm"/><a id="iddle1839" class="indexterm"/><a id="iddle2091" class="indexterm"/><a id="iddle2281" class="indexterm"/><a id="iddle2565" class="indexterm"/><a id="iddle2611" class="indexterm"/><a id="iddle2629" class="indexterm"/><a id="iddle2631" class="indexterm"/><a id="iddle2649" class="indexterm"/>To demonstrate how the scope is retained even when a function is executed, we can add a timeout inside the <code class="literal">innerMyVar</code> function:</p><a id="pro_id00022"/><pre class="programlisting">var myVar = 1;
alert(myVar);
function innerMyVar(){
  var myVar = 2;
  setTimeout(function(){
    alert(myVar);
  },1000);
  myVar++;
};
innerMyVar();
alert(myVar);</pre><p>This code should display alerts of 1, 1, and 3. The scope of <code class="literal">innerMyVar</code> retains the value of <code class="literal">myVar</code> defined inside it, including the increment that occurs after the timeout has been defined.</p><p>You can read more about scope at <span class="emphasis"><em><a class="ulink" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Closures/">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Closures/</a></em></span>.</p></div></div><div class="sect2" title="User Interface and Display Scripts"><div class="titlepage"><div><div><h2 class="title"><a id="user_interface_and_display_scripts"/>User Interface and Display Scripts</h2></div></div></div><p>Let’s create a class to handle the user interface and some of the other page display functionality. Create a new file called <span class="emphasis"><em>ui.js</em></span> in the <span class="emphasis"><em>_js</em></span> folder and add the following code:</p><p><span class="emphasis"><em>ui.js</em></span></p><a id="pro_id00023"/><pre class="programlisting">  var BubbleShoot = window.BubbleShoot || {};
  BubbleShoot.ui = (function($){
➊  var ui = {
      init : function(){
      },
➋    hideDialog : function(){
➌      $(".dialog").fadeOut(300);
      }
    };
    return ui;
  })(jQuery);</pre><p>Although not much is in this code, notice that the UI object follows the same pattern as the previous <code class="literal">Game</code> class. The <code class="literal">hideDialog</code> function ➋ contains a simple bit of jQuery that fades out any HTML element with the CSS class <code class="literal">dialog</code> ➌. The structural difference that <code class="literal">ui</code> has from the <code class="literal">Game</code> class pattern is that rather than making a <code class="literal">ui</code> class, we’re just creating a single object ➊ and attaching methods to it. This structure is similar to the way static classes are used in other languages.</p><p><a id="iddle1659" class="indexterm"/><a id="iddle1672" class="indexterm"/><a id="iddle1673" class="indexterm"/><a id="iddle1676" class="indexterm"/><a id="iddle1748" class="indexterm"/><a id="iddle1762" class="indexterm"/><a id="iddle1817" class="indexterm"/><a id="iddle1850" class="indexterm"/><a id="iddle1957" class="indexterm"/><a id="iddle2027" class="indexterm"/><a id="iddle2067" class="indexterm"/><a id="iddle2125" class="indexterm"/><a id="iddle2128" class="indexterm"/><a id="iddle2230" class="indexterm"/><a id="iddle2287" class="indexterm"/>The call to <code class="literal">fadeOut</code> takes a parameter that specifies the number of milliseconds to fade out the dialog. We use a value of 300, which is fast enough to not slow down users but not so fast that they won’t notice it. The <code class="literal">fadeOut</code> method is built into jQuery, but other ways are available to combine selectors and manipulate DOM elements. For now, let’s quickly run through what jQuery actually does in the <code class="literal">fadeOut</code> call:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Reduces the CSS opacity by a small, fixed amount and repeats in a loop for 300 milliseconds. At the end of this time, the opacity should be zero.</p></li><li class="listitem"><p>Sets the <code class="literal">display</code> CSS property of the element to <code class="literal">none</code>.</p></li></ul></div><p>We could have created this effect by hand by stringing together some <code class="literal">setTimeout</code> calls, but jQuery handles it for us with <code class="literal">fadeOut</code>. Using jQuery saves us a lot of code here because, as with many CSS properties, manipulating opacity is not straightforward across browsers (earlier versions of IE use a filter instead of the <code class="literal">opacity</code> property, for example).</p><p>Note that at the moment we’re not doing anything particular to CSS3 or HTML5. We’re using old HTML tags and manipulating relatively old CSS properties through JavaScript loops. Later in this book, you’ll learn whether you should do this in a more modern way, but for now, the code does the job well. As you develop games, you’ll realize that a lot of code runs just as well on earlier browsers as it does on later ones and that, unless you’re exclusively rendering to the canvas, your HTML5 games look similar to regular web applications.</p><p>Now we need to load our newly created UI file into <span class="emphasis"><em>index.html</em></span> by adding it to the <code class="literal">Modernizr.load</code> call:</p><p><span class="emphasis"><em>index.html</em></span></p><a id="pro_id00024"/><pre class="programlisting">  Modernizr.load([{
      load: "//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.js",
      complete: function(){
        if(!window.jQuery){
          Modernizr.load("_js/jquery-1.8.2.min.js");
        }
      }
    },
➊  <span class="strong"><strong>"_js/ui.js",</strong></span>
    {
      load: "_js/game.js",
      complete: function(){
        $(function(){
          var game = new BubbleShoot.Game();
          game.init();
        })
      }
    }
  ]);</pre><p><a id="iddle1133" class="indexterm"/><a id="iddle1452" class="indexterm"/><a id="iddle1547" class="indexterm"/><a id="iddle1824" class="indexterm"/><a id="iddle1944" class="indexterm"/><a id="iddle2084" class="indexterm"/><a id="iddle2113" class="indexterm"/><a id="iddle2135" class="indexterm"/><a id="iddle2223" class="indexterm"/><a id="iddle2269" class="indexterm"/><a id="iddle2460" class="indexterm"/><a id="iddle2550" class="indexterm"/><a id="iddle2642" class="indexterm"/>To add a new <span class="emphasis"><em>.js</em></span> file to the load call ➊, simply add the URL to your script file as an extra array item after <span class="emphasis"><em>ui.js</em></span> but before loading <span class="emphasis"><em>game.js</em></span>. We’ll need to add each new script file we create to <span class="emphasis"><em>index.html</em></span>, so remember this process.</p><p>To call <code class="literal">hideDialog</code> when we click the New Game button, add the following lines in bold to <span class="emphasis"><em>game.js</em></span>:</p><p><span class="emphasis"><em>game.js</em></span></p><a id="pro_id00025"/><pre class="programlisting">  BubbleShoot.Game = (function($){
    var Game = function(){
      this.init = function(){
➊      $(".but_start_game").bind("click",startGame);
      };
      var startGame = function(){
➋      <span class="strong"><strong>$(".but_start_game").unbind("click");</strong></span>
➌      <span class="strong"><strong>BubbleShoot.ui.hideDialog();</strong></span>
      };
    };
    return Game;
  })(jQuery);</pre><p>Using the <code class="literal">bind</code> method in jQuery ➊ is a cross-browser way to add event handlers. This method binds a function to an object that triggers when an event occurs. In this game application, the trigger occurs when the user clicks the New Game button, which calls the <code class="literal">startGame</code> function.</p><p>Note that we unbind the event ➋ when the button is clicked to prevent double-clicks from being registered while the button is fading out and trying to start a game twice. If you reload the page and click the New Game button, the dialog should disappear due to the <code class="literal">hideDialog</code> function ➌.</p><p>The <span class="emphasis"><em>Bubble Shooter</em></span> game still doesn’t do much, but at least now we have some structure to add code to.</p></div></div><div class="sect1" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="summary-id00001"/>Summary</h1></div></div></div><p>We now have the foundation in place to start building the game. Modernizr is loading in files, and we can easily add to this task when we create more classes and functions. An instance of the <code class="literal">Game</code> class is created when the DOM has finished loading, and clicking on a button starts the game.</p><p>In the next chapter, we’ll create our first sprites for the bubble object, forming the core of the game, and you’ll learn how to animate the sprites on the screen.</p></div><div class="sect1" title="Further Practice"><div class="titlepage"><div><div><h1 class="title"><a id="further_practice-id00002"/>Further Practice</h1></div></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>The dialog is being hidden with a jQuery <code class="literal">fadeOut</code> function, but you can apply other effects to remove the dialog from the screen. Try using <code class="literal">slideUp</code> or <code class="literal">hide</code> instead of <code class="literal">fadeOut</code>, for example. Alternatively, start the dialog offscreen and move it into place with an <code class="literal">animate</code> call.</p></li><li class="listitem"><p>The colors and styling of the dialogs and the header and footer are quite simple. Change the colors in those areas (or even experiment with graphics) until you find a combination you like.</p></li><li class="listitem"><p>Learn how to use your browser’s debugging tools. It’s likely you’ll have access to breakpoints, watch variables, and the variable stack, so read about and experiment with them. Learning your way around the tools now can be quite a time-saver when you’re debugging later. Try adding breakpoints within the <code class="literal">init</code> and <code class="literal">startGame</code> functions in <span class="emphasis"><em>game.js</em></span> and trace the code as it runs.</p></li></ol></div></div></div></body></html>