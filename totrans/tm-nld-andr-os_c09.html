<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en">
<head>
<title>Chapter 9: Core Libraries</title>
<link href="NSTemplate_v1.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:c2f206e1-36e8-4f89-b533-508263d6ec16" name="Adept.expected.resource"/>
</head>
<body epub:type="bodymatter chapter">
<section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" id="Page_85" title="85"/>9</span><br/>
<span class="ChapterTitle">Core Libraries</span></h1>
</header>
<figure class="graphic">
<img alt="g09001" src="image_fi/502680c09/g09001.png"/></figure>

<p class="ChapterIntro"><span class="dropCap">H</span>aving a programming language for the platform is one thing. And it’s a pretty big thing, especially when it’s a language that most developers already know. But programmers also want to have standard utility functions so that they don’t have to reinvent everything every time they write an app. A programming language gives you the ability to encode logic (like condition statements, loops, equations). But higher-level functionality like data structures, or networking, or file reading and writing is the job of the core libraries.</p>
<p>Although the Android team adopted the Java language, they were explicitly not using the implementation of the libraries that shipped with Sun Microsystems’<sup class="FootnoteReference"><a href="#c09-footnote-1" id="c09-footnoteref-1">1</a></sup> version of Java, called the Java Development Kit (JDK). The JDK comes with, say, an <code>ArrayList</code> class that implements a simple data structure that is common in programming. But Android didn’t use those classes, so they needed to provide their own.</p>
<h2 id="h1-502680c09-0001">Bob Lee and the Java Libraries</h2>
<p class="BodyFirst">When Android needed standard Java libraries, they brought in a Java expert working elsewhere at Google: Bob Lee.</p>
<p><span epub:type="pagebreak" id="Page_86" title="86"/>Bob (also known as “Crazy Bob”<sup class="FootnoteReference"><a href="#c09-footnote-2" id="c09-footnoteref-2">2</a></sup>) started programming in middle school, in the early 90s, mostly because he wanted to write video games. He soon picked up various programming languages and in high school moved on from video games to building a website for a nearby college. The college was so impressed that they gave him a full ride to the school to continue that effort. But college didn’t suit Bob, so he left and started consulting, along with writing books and popular Java libraries, which eventually landed him a job at Google in 2004.</p>
<p>Bob wanted to work on mobile technology, so after a couple years on the Ads team, he switched to the Android team, starting in March of 2007.</p>
<p>When Bob joined, Android was still using the JamVM runtime, before the Dalvik runtime came online. The <em>core libraries</em> were basically a collection of random utilities that people wrote for one-off purposes. “They were totally incompatible. Somebody would need something and they would just implement what they needed. They kind of resembled the Java libraries, but they were obviously missing a lot.”</p>
<p>Fortunately, there were a couple existing options for more standard libraries, so Bob and the team evaluated them. “We looked at GNU Classpath, but we ended up going with Apache Harmony.<sup class="FootnoteReference"><a href="#c09-footnote-3" id="c09-footnoteref-3">3</a></sup> There was a lot of stuff that wasn’t great about it, so it was a matter of rewriting parts of it, and we would contribute those back. Like we rewrote <code>ThreadLocal</code> [and] <code>Runtime.exec()</code>. Rewriting that stuff and merging it back was a big part of it.</p>
<p>“There were also APIs added to the core Android platform by other engineers on the team just because it seemed like a good idea at the time. If someone thought something might be potentially useful, they would put it in there. And there was some really bad stuff.”</p>
<p>An example of this was <code>WeakHashMap</code>, a data structure class that developers use in memory-constrained situations, like Android at that time. It offers an advantage over the traditional <code>HashMap</code> class by automatically cleaning up (garbage-collecting) objects which are no longer used. Like a Roomba for your memory heap, cleaning up the trash you leave behind. Note that “weak” <span epub:type="pagebreak" id="Page_87" title="87"/>here is taken from the term “weak reference,” which is an object that can be garbage-collected when it is no longer in use.</p>
<p>Joe Onorato, on the framework team, added the <code>WeakHashMap</code> API. Sort of. He said, “I had this library that depended on <code>WeakHashMap</code>, and I needed to link<sup class="FootnoteReference"><a href="#c09-footnote-4" id="c09-footnoteref-4">4</a></sup> it, so I created a class called <code>WeakHashMap</code>.” The problem was, Joe’s class wasn’t a “weak” <code>HashMap</code>, it was just a standard <code>HashMap</code>. It subclassed <code>HashMap</code> and didn’t add any of the logic that would have made it weak. Sometime later, Jeff Hamilton (also on the framework team) was writing code that needed the functionality of <code>WeakHashMap</code>. He saw that the class existed in the core libraries, used it, and had memory problems that required a lot of debugging until Jeff discovered that Joe’s <code>WeakHashMap</code> class wasn’t cleaning up memory at all. It was just a regular <code>HashMap</code>, which didn’t do the garbage-collecting work that Jeff expected.</p>
<p>Bob continued, “I know the Android APIs could be a lot better . . . but they could also have been so much worse.” Much of Bob’s time was spent preventing these APIs from becoming public. “I would find and just remove all that stuff from the API. If there was a class that was only used by one app, I would move it back out into that app—if you weren’t going to use it [from multiple apps], it didn’t belong in the framework libraries.”</p>
<p>As part of making the core libraries work, Bob implemented significant networking functionality, fixing bugs along the way. One of those problems prevented every phone from starting up at all. “The first time you started a phone, it had to connect to a time server, but the time [on the device] was set to sometime in 2004.” The phone would try to connect to the server through a secure connection, which requires a security certificate on the server. But the initial time on the phone was before the time that the certificate was issued on the server, so the connection would fail and the phone wouldn’t boot. Bob’s fix was to catch that failure condition and set the initial time on the phone to the day that he fixed the bug.</p>
<p>Bob also tracked down a networking problem that was specific to mobile data. Android phones were experiencing severe outages that seemed like a problem with bad carrier network infrastructure.</p>
<p><span epub:type="pagebreak" id="Page_88" title="88"/>Networking protocols have built in fault-tolerance, because networks can go down, or packets of data can get lost or delayed. Android was using the <em>congestion window</em> approach in Linux that responds to an outage by halving the size of the data packet, and halving it again, and again, until it gets a response from the server that packets are going through. Then it doubles the packet sizes each time they succeed until packets are eventually back to the full size.</p>
<p>This algorithm is reasonable for regular internet traffic, where latency (the delay between sending a message and receiving a response) is measured in milliseconds and outages are infrequent. But it doesn’t work well for cellular data, where it’s common to have high latencies of a second or more, and where brief outages are common. Bob did some profiling and investigation to track down the problem. After failures decreased the packet size, “it would double the size of the buffer every time it had a successful packet. But with high latencies over mobile networks, you had one or two second round trip times over 2.5G or 3G back then. So it was only scaling up the buffer every time it made a successful round trip. It’d take like 30 seconds to scale the buffer back up after you had some kind of outage.”</p>
<h2 id="h1-502680c09-0002">Jesse Wilson and the Terrible APIs</h2>
<blockquote class="Epigraph" epub:type="epigraph">
<p class="Epigraph">We spent a long time taking these APIs and re-implementing them from scratch to be good, while maintaining their existing terrible APIs.</p>
<p class="EpigraphSource">—Jesse Wilson</p>
</blockquote>
<p class="BodyFirst">Bob worked by himself on core libraries for a while, but eventually, after 1.0 shipped, he got some help. Josh Bloch<sup class="FootnoteReference"><a href="#c09-footnote-5" id="c09-footnoteref-5">5</a></sup> joined his team in late 2008, and Jesse Wilson joined in early 2009.</p>
<p>Jesse Wilson was working on the Google AdWords product with Bob before Bob joined Android. “Bob got out of AdWords to go work on Android <span epub:type="pagebreak" id="Page_89" title="89"/>when Android did not seem like a responsible job decision. I followed him there, more to work with Bob than to work on Android.”</p>
<p>Bob and Jesse would eventually leave Android and Google. Bob became the CTO of Square. Jesse followed Bob once again and joined Square.<sup class="FootnoteReference"><a href="#c09-footnote-6" id="c09-footnoteref-6">6</a></sup> “He’s got something on me, I guess.”</p>
<p>Jesse described life on the core libraries team: “In the first year of Android, people just brought in whatever libraries they thought they needed, and put them in the public APIs. We have something called kXML, which is the pull parser. We have the org.json JSON library. The ApacheHttp client. We basically have 2006-vintage snapshots of all of these libraries, which have since gone on to introduce ten thousand features that make them too big for Android. Their current versions are incompatible in big, meaningful ways. If you’re shipping a web server, you can control which version of the thing you’re including; if you change it in an incompatible way, your client just changes it. Android’s versioning is such that if we change an API in, say, the JSON library, even if the new API is better, the apps don’t get to opt in or out of the API change, and so you have to be 100 percent backwards-compatible. So we spent a long time taking these APIs and re-implementing them from scratch to be good, while maintaining their existing terrible APIs.</p>
<p>“We inherited all the Apache Harmony code, and Apache Harmony was never really a shipping product. It was much more of an inventory to build a shipping product with. There was so much work to take something that was half-baked and make it correct.</p>
<p>“It was a lot of re-implement-and-optimize. The org.json code in the standard library, 100 percent of it was brand new. One day Dan Morrill came to me and said, ‘Hey, heads up, the open source library for the JSON library we’re using has this, ‘The Software shall be used for Good, not Evil’ clause<sup class="FootnoteReference"><a href="#c09-footnote-7" id="c09-footnoteref-7">7</a></sup> in it. That means it’s not open source because open source has no discrimination against any endeavor.’ So I got to go and re-implement it.”</p>
</section>
<section class="footnotes">
<aside class="FootnoteEntry"><p><sup class="FootnoteReference"><a href="#c09-footnoteref-1" id="c09-footnote-1">1.</a></sup>  Sun was acquired by Oracle in April of 2009. But the company was still independent at the time of this work on Android, so I’ll continue to refer to it as Sun.</p></aside>
<aside class="FootnoteEntry"><p><sup class="FootnoteReference"><a href="#c09-footnoteref-2" id="c09-footnote-2">2.</a></sup>  Bob had used this nickname since high school and even used it as his corporate email address.</p></aside>
<aside class="FootnoteEntry"><p><sup class="FootnoteReference"><a href="#c09-footnoteref-3" id="c09-footnote-3">3.</a></sup>  GNU Classpath and Apache Harmony were both open source libraries for the Java programming language.</p></aside>
<aside class="FootnoteEntry"><p><sup class="FootnoteReference"><a href="#c09-footnoteref-4" id="c09-footnote-4">4.</a></sup>  Compiling code involves a <em>link</em> step, in which the code is built along with all of its dependencies. So if code refers to a class, then that class must be reachable by the compiler for compilation to succeed.</p></aside>
<aside class="FootnoteEntry"><p><sup class="FootnoteReference"><a href="#c09-footnoteref-5" id="c09-footnote-5">5.</a></sup> Josh is famous in the software world for a couple of reasons. For one thing, he is the father of many of the APIs in Java itself, having worked at Sun Microsystems during the early days of Java’s development. Also, Josh wrote <em>Effective Java</em>, which is perhaps one of the last programming books that people still buy and read (programmers having moved to a model of online search/copy/paste for most software problems).</p></aside>
<aside class="FootnoteEntry"><p><sup class="FootnoteReference"><a href="#c09-footnoteref-6" id="c09-footnote-6">6.</a></sup>  It’s only fitting that in this chapter Jesse once again follows Bob.</p></aside>
<aside class="FootnoteEntry"><p><sup class="FootnoteReference"><a href="#c09-footnoteref-7" id="c09-footnote-7">7.</a></sup>  <a class="LinkURL" href="https://www.json.org/license.html">https://www.json.org/license.html</a></p></aside>
</section>
</body>
</html>