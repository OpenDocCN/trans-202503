<html><head></head><body>
<h2 class="h2" id="ch10"><span epub:type="pagebreak" id="page_279"/><strong><span class="big">10</span><br/>THE CHROMATIC THERMOMETER</strong></h2>&#13;
<div class="image"><img alt="image" src="../images/common-01.jpg"/></div>&#13;
<p class="noindent">This project was initially created to provide a quick visual indication of local temperature. At its simplest, it is a thermometer that displays the temperature by turning on a sequence of LEDs of different colors. During development, however, the project gained more features, including an LCD readout to supplement the basic color readout. And while experimenting, I came across an IC that provides extremely accurate measurement without special calibration, which improved the device greatly.</p>&#13;
<p class="indent">The Chromatic Thermometer includes 10 different colored LEDs, each of which lights up when the sensor detects a particular temperature. The original version was designed to measure from 68 to 78°F, and each LED represented a 1-degree Fahrenheit change in temperature. I subsequently varied that for different applications. The finished project shown in <a href="ch10.xhtml#ch10fig10-1">Figure 10-1</a> can measure a wide range of temperatures. It also includes a waterproof probe for measuring the temperature in liquids, which is useful for fish tanks, <span epub:type="pagebreak" id="page_280"/>swimming pools, and so forth, and can be constructed in a variety of physical configurations. In the version that appears in the sketch, the temperature ranges from 76 to 86°F in 1-degree increments.</p>&#13;
<div class="image"><img alt="image" src="../images/fig10_1.jpg"/></div>&#13;
<p class="figcap" id="ch10fig10-1"><em>Figure 10-1: The finished Chromatic Thermometer</em></p>&#13;
<p class="indent">You could also program an alarm by flashing a lamp at a specific temperature, or with a minor hardware addition, you could add an audible alarm. I am sure you can think of even more hardware or software modifications to make this thermometer a very practical device.</p>&#13;
<h3 class="h3" id="ch10lev1sec1"><strong>Choosing a Temperature Sensor</strong></h3>&#13;
<p class="noindent">The key ingredient in any electronic thermometer is the temperature sensor. There are many kinds of temperature sensors available to choose from.</p>&#13;
<p class="indent"><em>Thermistors</em> change resistance with temperature and range from inexpensive to very pricey, depending on how they are made and tested. <em>Resistance temperature detectors (RTDs)</em> employ a coil of pure wire, such as silver, platinum, or copper, wrapped around a glass core. Combined in a resistance bridge, RTDs can be extremely accurate, but they’re somewhat expensive. <em>Thermocouples</em> are still an industry-standard sensing technology, particularly at higher temperatures (that is, greater than 500°C). At lower temperatures, thermocouples are being replaced by RTDs because of accuracy, precision, consistency, and linearity.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_281"/><em>Semiconductor temperature sensors</em>—that is, dedicated integrated silicon sensor circuits—continue to gain popularity because of their accuracy, precision, ruggedness, and convenience. In preparing for this project, I looked at virtually all the approaches and elected to use a semiconductor sensor, as it provided sufficient accuracy with a relatively simple hookup and a modest price.</p>&#13;
<p class="indent">With any thermometer, <em>accuracy</em> and <em>precision</em> are issues. Consider accuracy the ability to measure temperature as close to some standard value established by the NIST, with some deviation. For this casual definition, precision can be referred to as <em>repeatability</em>—that is, the ability to read the same temperature consistently in the same environment.</p>&#13;
<p class="indent">The Custom pH Meter in <a href="ch07.xhtml#ch07">Chapter 7</a> used the temperature of boiling water and ice in solution to set boundaries of 100°C and 0°C, respectively, to calibrate a thermometer. I checked the Chromatic Thermometer with the same approach, but I used the high-accuracy MCP9808 module described here as a standard because it was extremely close.</p>&#13;
<p class="indent">Accuracy and precision are ultimately a system—not necessarily a sensor—issue. This project discusses two different sensors with essentially the same accuracy and precision. The simplest sensor, an LM35 analog temperature sensor, depends on other parts of the system for its accuracy and precision. The second sensor, an MCP9808 IC, provides accurate results with or without the associated breakout board because it includes the other variable components as an on-chip subsystem.</p>&#13;
<p class="indent">Both the LM35 and the MCP9808 boast a maximum accuracy of 0.25°C and a precision of 0.0625°C. To achieve this kind of accuracy, they use a <em>silicon band-gap temperature sensor</em>, which takes advantage of the forward voltage of a silicon diode. However, in addition to the sensor, the MCP9808 includes its own on-chip ADC, voltage reference, and other internal circuitry to assure accuracy.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="bgblack">NOTE</span></strong></p>&#13;
<p class="notep"><em>If you want to dig deeper on the band-gap sensor technology, there is a wealth of information on the web, including background on Bob Widler, who is largely credited with discovering the phenomenon</em>.</p>&#13;
</div>&#13;
<p class="indent">In this project, the LM35 depends on the ADC and voltage reference of the Arduino, which, while pretty good, does not match that of the MCP9808’s monolithic system and thus can require calibration, as illustrated in “<a href="ch10.xhtml#ch10lev2sec1">Sketch for the LM35 System</a>” on <a href="ch10.xhtml#page_289">page 289</a>. When I built a version with the MCP9808 instead, I used an Adafruit breakout board for the chip because it significantly simplified assembly—no need to fuss with the MicroSMT package’s tiny leads.</p>&#13;
<p class="indent">While the MCP9808 does cost more than the LM35D, it’s worked out well. I included traces in the project’s PCB shield for the chip itself, if you elect to solder it using one of the techniques suggested in “<a href="ch00.xhtml#ch00lev1sec7">Using SOICs</a>” on <a href="ch00.xhtml#page_20">page 20</a>.</p>&#13;
<h3 class="h3" id="ch10lev1sec2"><span epub:type="pagebreak" id="page_282"/><strong>Required Tools</strong></h3>&#13;
<p class="noindent">Soldering iron and solder (Optional) Electric drill with bits for 1/4 inches (used to drill a hole for the jack in order to connect a remote temperature sensor or to make a hole for a power adapter)</p>&#13;
<h3 class="h3" id="ch10lev1sec3"><strong>Parts List</strong></h3>&#13;
<p class="noindentb">First, decide which temperature sensor you want to use: the LM35 or the MCP9808. If you just want to use an LM35, here’s what you’ll need to make a basic Chromatic Thermometer:</p>&#13;
<p class="noindenti">One Arduino Nano or clone</p>&#13;
<p class="noindenti">One LM35 temperature sensor</p>&#13;
<p class="noindenti">Ten different colored LEDs (see “<a href="ch10.xhtml#ch10sd1">Mod: Try Different LEDs</a>” on <a href="ch10.xhtml#page_300">page 300</a>)</p>&#13;
<p class="noindenti">Ten ZTX649 transistors Ten 470-ohm resistors</p>&#13;
<p class="noindenti">One 7.5 to 9V wall adapter, or equivalent (or 9V battery)</p>&#13;
<p class="noindenti">One plastic enclosure (see “<a href="ch01.xhtml#ch01lev1sec9">Construction</a>” on <a href="ch10.xhtml#page_298">page 298</a>) 28- or 30-gauge hookup wire</p>&#13;
<p class="noindentib">One printed circuit board (Use the provided shield template, design your own shield, or use any other prototyping board you feel comfortable working with.)</p>&#13;
<p class="indentb">I also describe several variations on the Chromatic Thermometer in this chapter. Give the project a skim before you go shopping, and if you want to make one of the variations, also buy the following:</p>&#13;
<p class="noindenti">If you plan to use the temperature sensor as described in “Design Decision: Remote the Temperature Sensor,” get one 3.5 mm stereo jack. For a Chromatic Thermometer with a digital readout, also buy one 16×2 I<sup>2</sup>C LCD.</p>&#13;
<p class="noindenti">For a high-accuracy Chromatic Thermometer, replace the LM35 with either one MCP9808 Adafruit Breakout Board or one Microchip MCP9808 IC with a 100 nF capacitor and two 10-kilohm resistors.</p>&#13;
<p class="noindenti">For the breadboard prototype, make sure you have one large breadboard (as opposed to the smaller ones used in much of this book) and at least 30 jumper wires.</p>&#13;
<div class="sidebar">&#13;
<p class="stitle"><span epub:type="pagebreak" id="page_283"/><strong>DESIGN DECISION: REMOTE THE TEMPER ATURE SENSOR</strong></p>&#13;
<p class="noindent">If your application takes you in another direction, you can modify the shield to <em>remote the chip</em>. That is, you can connect long wires directly to the chip (you’d need only four wires) and place the chip in a location separate from the readout. If you remote the chip, just include a small capacitor (around 100 nF) between pins 4 and 8, very close to the chip, as shown in <a href="ch10.xhtml#ch10fig10-2">Figure 10-2</a>.</p>&#13;
<div class="image"><img alt="image" src="../images/fig10_2.jpg"/></div>&#13;
<p class="figcap" id="ch10fig10-2"><em>Figure 10-2: The MCP9808 with wires soldered directly</em></p>&#13;
<p class="indent">However, remember that I<sup>2</sup>C stands for <em>inter-integrated circuit</em> and is intended for chip-to-chip communications. Therefore, the MCP9808 can be moved only a limited distance from the Arduino. While some hobbyists online claim success with wires as long as 100 cm, the longest that I have been able to do reliably is about 50 cm. The LM35, on the other hand, can be remoted and made waterproof for longer distances with only three wires and without needing miniature hands and the dexterity of a watchmaker. (If you can tolerate only two wires, there’s a solution to that; check the data sheet for the LM35.)</p>&#13;
<p class="indent">The MCP9808 could likely be encapsulated as I did with the LM35 in the Custom pH Meter from <a href="ch07.xhtml#ch07">Chapter 7</a>, though I have not tried that. Trying to insulate the connections from each other and keep the delicate pins of the chip from breaking off can be a problem when making a remote sensor with the MCP9808.</p>&#13;
<p class="indent">This is a design decision to make before you build the final Chromatic Thermometer, so I suggest reading through the full chapter to decide before you put the device together.</p>&#13;
</div>&#13;
<h3 class="h3" id="ch10lev1sec4"><span epub:type="pagebreak" id="page_284"/><strong>Downloads</strong></h3>&#13;
<p class="indenth"><strong>Sketch for the LM35 version</strong> <em>LM35Thermo.ino</em></p>&#13;
<p class="indenth"><strong>Sketch for the MCP9808 version</strong> <em>9808Thermo.ino</em></p>&#13;
<p class="indenth"><em><strong>Adafruit_MCP9808</strong></em> <strong>library</strong> <em><a href="https://www.adafruit.com/product/1782">https://www.adafruit.com/product/1782</a></em>(for the MCP9808 temperature sensor only)</p>&#13;
<p class="indenth"><strong>PCB pattern for the shield</strong> <em>Thermo.pcb</em></p>&#13;
<h3 class="h3" id="ch10lev1sec5"><strong>How the Chromatic Thermometer Works</strong></h3>&#13;
<p class="noindent">In operation, the Chromatic Thermometer is quite straightforward. For starters, let’s look at the basic configuration using the LM35 sensor.</p>&#13;
<p class="indent">The sensor generates a voltage of 10mV/°C. For example, at 28°C (around 82°F), the chip outputs 0.280V. You can easily check that with your multimeter. To make a usable Arduino thermometer, all you have to do is change that voltage to something the Arduino can understand and then have the Arduino translate it to something you want to see on the LEDs or LCD.</p>&#13;
<p class="indent">The first step is to convert the analog voltage to a digital value so the Arduino can work with it. To do that, connect the output of the sensor to one of the Nano’s analog inputs. (I tend to use A0, but any analog input can be used. Just don’t use analog pins A4 or A5, which are used for the I<sup>2</sup>C portion of this project.) The output voltage of the LM35 is pretty low compared with the 5V the Nano is working with, and the ADC divides the 5V of the supply into 1,024 parts (range = 0 to 1,023) to determine the analog value of an incoming voltage. If you use the LM35 output as is, each degree Celsius change in temperature will change the output voltage by 0.010V and therefore change the result of the ADC by 2.046 parts (units) out of the 1,024 total.</p>&#13;
<p class="indent">That works, but small increments of the ADC at the very low end of the reference voltage are subject to random amounts of error. There is also significant error from rounding, as the Nano’s ADC outputs only whole digits.</p>&#13;
<p class="indent">To reduce the impact of error, you’ll change the reference voltage of the ADC from 5V, where each increment in the 1,024 represents 0.004882V, to 1.1V, where each increment represents only 0.00107V. A single degree Celsius change will then represent only 9.345 of the 1,024 units. Thus, the 0.280V the LM35 outputs at 28°C will correspond to about 261 of the 1,024 units, rather than only 52.</p>&#13;
<h3 class="h3" id="ch10lev1sec6"><strong>The Schematic</strong></h3>&#13;
<p class="noindent"><a href="ch10.xhtml#ch10fig10-3">Figure 10-3</a> shows the schematic for this project.</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_285"/><img alt="image" src="../images/fig10_3.jpg"/></div>&#13;
<p class="figcap" id="ch10fig10-3"><em>Figure 10-3: Schematic for the Chromatic Thermometer</em></p>&#13;
<p class="indent">Note that both the LM35 and the MCP9808 sensors are wired up in this sketch. That is not a problem, as you can select which one to use in software by changing the code that you upload to the Arduino. You can wire up either one or both. This schematic also shows the Chromatic Thermometer with an LCD, though that is optional if you just want to read the temperature based on the LEDs.</p>&#13;
<p class="indent">The Arduino processor could probably drive the LEDs unaided, but I elected to use transistor drivers for each LED. This assures that if you elect to use higher-output LEDs—or even incandescent lamps—there will be no problem driving them. The transistors used are capable of sinking as much as 1 A.</p>&#13;
<p class="indent">An 11th LED-transistor-resistor group (Q11) is shown connected to pin D12 on the Nano, though the final Chromatic Thermometer uses only 10 LEDs. I show this extra pair and even include it in the shield PCB file to give you a built-in customization option. You can add another temperature digit, a buzzer alarm, or any other output you like.</p>&#13;
<h3 class="h3" id="ch10lev1sec7"><span epub:type="pagebreak" id="page_286"/><strong>The Breadboard</strong></h3>&#13;
<p class="noindent">As in the other projects in this book, I suggest starting with a breadboard to sound out the design and exercise the sketch before committing to the final assembly. Because the project uses 10 LEDs and 10 driver transistors, I used a large-format breadboard to comfortably fit all the components (see <a href="ch10.xhtml#ch10fig10-4">Figure 10-4</a>).</p>&#13;
<div class="image"><img alt="image" src="../images/fig10_4.jpg"/></div>&#13;
<p class="figcap" id="ch10fig10-4"><em>Figure 10-4: The Chromatic Thermometer’s completed breadboard</em></p>&#13;
<p class="indent">The LEDs are along the middle of the breadboard, and one is shown lit. I assembled a wire harness for the LCD. The LM35 temperature sensor (left) is on a tether and held in heat shrink tubing so it is waterproof.</p>&#13;
<p class="indentb">These are the steps I used to assemble the breadboard:</p>&#13;
<ol>&#13;
<li><p class="order">Place the Arduino Nano toward the top left of the breadboard.</p></li>&#13;
<li><p class="order">Connect VIN (pin 30) of the Nano to where the 9V input from the battery or other power source will go.</p></li>&#13;
<li><p class="order">Connect the 5V pin of the Nano to the red positive rail.</p></li>&#13;
<li><p class="order"><span epub:type="pagebreak" id="page_287"/>Connect GND (pin 4) of the Nano to the blue negative rail on the breadboard.</p></li>&#13;
<li><p class="order">Identify locations for the 10 driver transistors (Q1 to Q10), and place them on the breadboard. I placed them so the beveled edge of the transistor faced right when looking from the bottom of the board.</p></li>&#13;
<li><p class="order">Connect the collector of all the transistors to where the 9V input will go (VIN of the Nano). See <a href="ch10.xhtml#ch10fig10-5">Figure 10-5</a> for the pinout of the transistor.</p>&#13;
<div class="image"><img alt="image" src="../images/fig10_5.jpg"/></div>&#13;
<p class="figcap" id="ch10fig10-5"><em>Figure 10-5: Pinout of the ZTX649 transistor</em></p></li>&#13;
<li><p class="order">Connect the base of Q1 to D2 (pin 5) on the Nano.</p></li>&#13;
<li><p class="order">Connect the base of Q2 to D3 (pin 6) on the Nano.</p></li>&#13;
<li><p class="order">Connect the base of Q3 to D4 (pin 7) on the Nano.</p></li>&#13;
<li><p class="order1">Connect the base of Q4 to D5 (pin 8) on the Nano.</p></li>&#13;
<li><p class="order1">Connect the base of Q5 to D6 (pin 9) on the Nano.</p></li>&#13;
<li><p class="order1">Connect the base of Q6 to D7 (pin 10) on the Nano.</p></li>&#13;
<li><p class="order1">Connect the base of Q7 to D8 (pin 11) on the Nano.</p></li>&#13;
<li><p class="order1">Connect the base of Q8 to D9 (pin 12) on the Nano.</p></li>&#13;
<li><p class="order1">Connect the base of Q9 to D10 (pin 13) on the Nano.</p></li>&#13;
<li><p class="order1">Connect the base of Q10 to D11 (pin 14) on the Nano.</p></li>&#13;
<li><p class="order1">Connect each of the emitters for all the transistors Q1 through Q10 to the positive lead of each colored LED.</p></li>&#13;
<li><p class="order1">Connect the negative lead of the LEDs to an empty location on the breadboard.</p></li>&#13;
<li><p class="order1">Connect one side of the 470-ohm resistors to the negative leads of each LED.</p></li>&#13;
<li><p class="order1">Connect the other side of the 470-ohm resistors to ground (the blue negative rail).</p></li>&#13;
<li><p class="order1">Connect pin 1 (4–20V) of the LM35 to the red positive rail. (See <a href="ch10.xhtml#ch10fig10-6">Figure 10-6</a> for the pinout of the LM35.)</p>&#13;
<div class="image"><img alt="image" src="../images/fig10_6.jpg"/></div>&#13;
<p class="figcap" id="ch10fig10-6"><em>Figure 10-6: Pinout of the LM35 temperature sensor</em></p></li>&#13;
<li><p class="order1">Connect pin 3 (GND) of the LM35 to the blue negative rail.</p></li>&#13;
<li><p class="order1">Connect the output pin (center) of the LM35 to pin A0 (26) on the Nano.</p></li>&#13;
<li><p class="order1"><span epub:type="pagebreak" id="page_288"/>24. Connect power and ground to the respective red positive and blue negative rails.</p></li>&#13;
</ol>&#13;
<p class="indentb">Now, you’re all set to go with the most basic configuration. To add the digital display:</p>&#13;
<ol>&#13;
<li><p class="order">Connect the power and ground of the LCD’s I<sup>2</sup>C adapter to the respective red positive and blue negative rails.</p></li>&#13;
<li><p class="order">Connect the SDA pin of the LCD’s I<sup>2</sup>C adapter to A4 (22) on the Nano.</p></li>&#13;
<li><p class="order">Connect the SCL pin of the LCD’s I<sup>2</sup>C adapter to A5 (21) of the Nano.</p></li>&#13;
<li><p class="order">Upload the appropriate software code to the Nano.</p></li>&#13;
</ol>&#13;
<p class="indentb">If you want to play with the high-accuracy temperature sensor:</p>&#13;
<ol>&#13;
<li><p class="order">Remove the LM35 from the circuit (or you can leave it in—it will not affect anything).</p></li>&#13;
<li><p class="order">Place the high-accuracy sensor in a location where the pins will not be affected by anything.</p></li>&#13;
<li><p class="order">Connect the power pins of the I<sup>2</sup>C connection on the MCP9808 sensor to the blue negative rail and 5V—pin 27, or the red positive rail—on the Nano, respectively.</p></li>&#13;
<li><p class="order">Connect the SDA pin of the I<sup>2</sup>C connection on the MCP9808 sensor to A4 (22) on the Nano.</p></li>&#13;
<li><p class="order">Connect the SCL pin of the I<sup>2</sup>C connection on the MCP9808 sensor to A5 (21) on the Nano.</p></li>&#13;
<li><p class="order">Upload the software to the Nano with the high-accuracy sensor version of code.</p></li>&#13;
</ol>&#13;
<p class="indent">Now you’re all set to go.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="bgblack">NOTE</span></strong></p>&#13;
<p class="notep"><em>This particular breadboard’s positive and negative power rails are not continuous. The first 15 are connected, the next 20 are connected, and the last 15 are connected—but not to each other. I used jumpers to connect the rails as needed</em>.</p>&#13;
</div>&#13;
<h3 class="h3" id="ch10lev1sec8"><strong>The Sketches</strong></h3>&#13;
<p class="indent">There are two versions of the sketch: one for the LM35 version of this project and one for the MCP9808 version. You can pick a sketch to use based on which version of the Chromatic Thermometer you’d like to build, but both sketches comprise three basic sections.</p>&#13;
<p class="indent">After the boilerplate section of loading libraries and preliminary setup, the first component of each sketch deals with the temperature sensor itself. The second section deals with setting up the temperature and LCD readout (if used). The final element of each sketch details the conditions to turn the LEDs on and off to indicate the temperature. I have annotated the code with comments where appropriate.</p>&#13;
<h4 class="h4" id="ch10lev2sec1"><span epub:type="pagebreak" id="page_289"/><em><strong>Sketch for the LM35 System</strong></em></h4>&#13;
<p class="noindent">Here is the sketch for the Chromatic Thermometer with the LM35 sensor, including the digital LCD readout.</p>&#13;
<p class="programs"><br/>    //Chromatic Thermometer sketch for the LM35, with an alarm<br/>    //around 78 to 79 degrees Fahrenheit (26 degrees Celsius) <br/><br/>    #include &lt;Wire.h&gt;              //Set up Comm wire library <br/>    #include &lt;LiquidCrystal_I2C.h&gt; //Set up LCD library with I2C <br/><br/>    LiquidCrystal_I2C lcd(0x27, 16, 2); //16x2 display I2C address 0x27 <br/>    <br/>    //Establish the number of readings to average at 10<br/><span class="ent">➊</span>  const int numReadings = 10; <br/>    float readings[numReadings];        //The readings from the analog input <br/>    int index = 0;                      //The index of the current reading <br/>    float total = 0;                    //The running total<br/>    float average = 0;                  //The average<br/>    int tempPin = A0;<br/>    float TempC; <br/>    float tempF; <br/>    <br/>    void setup() {<br/>      lcd.init();                       //Initialize LCD and turn on backlight<br/>      lcd.backlight(); <br/>    <br/>      //Initialize serial communication with computer:<br/>      Serial.begin(9600); <br/>    <br/>      //Initialize all the readings to 0:<br/>      for(int thisReading = 0; thisReading &lt; numReadings; thisReading++)<br/>      readings[thisReading] = 0; <br/>    <br/>      analogReference(INTERNAL);        //Set voltageReference = 1.1V <br/>    } <br/>    <br/>    void loop() {<br/>      total = total - readings[index];          //Subtract the last reading<br/>      readings[index] = analogRead(tempPin);    //Read from the sensor<br/>      total = total + readings[index];          //Add the reading to the total <br/>    <br/>      //Advance to the next position in the array:<br/>      index = index + 1; <br/>    <br/>      if(index &gt;= numReadings)     //If we're at the end of the array…<br/>        index = 0;                    //…wrap around to the beginning <br/>    <br/>      average = total / numReadings;  //Calculate the average temperature<br/>      TempC = average / 9.81;         //Adjust/calibrate average <br/>                                      //based on empirical measurement<br/>    <br/>      tempF = (TempC * 9 / 5) + 32;   //Convert to Fahrenheit<br/>    <span epub:type="pagebreak" id="page_290"/><br/>      //Set up serial readout if desired<br/>      Serial.println();<br/>      Serial.print("TempC  ");<br/>      Serial.println(TempC);<br/>      Serial.print("TempF  ");<br/>      Serial.println(tempF);<br/>      Serial.print("Average  ");<br/>      Serial.println(average);<br/>      delay(10);                    //Delay in between reads for stability <br/>    <br/>      //Set up for LCD<br/>      lcd.setCursor(0, 0);<br/>      lcd.print("Temp                  ");<br/>      lcd.setCursor(7, 0);<br/>      lcd.print(TempC, 1);<br/>      lcd.print((char)223);         //Degree symbol see below<br/>      lcd.print(" C");<br/>      lcd.setCursor(0, 1);<br/>      lcd.print("Temp  ");  <br/>      lcd.setCursor(7, 1);<br/>      lcd.print(tempF, 1);          //Truncate second decimal place<br/>      lcd.print((char)223); <br/>    /*May need to use (char) 178 if LCD displays the greek alpha character. <br/>    Different LCDs display different special characters*/ <br/>    <br/>      lcd.print(" F");<br/>      delay(50); <br/>    <br/>      //Beginning of conditional statements for display<br/>      if((tempF &gt; 85.00 ) &amp;&amp; (tempF &lt; 200)) {<br/>        //85 degrees and 200 degrees are arbitrary.<br/>        digitalWrite(2, HIGH);<br/>      }<br/>      else {<br/>        digitalWrite(2, LOW);<br/>      } <br/>    <br/>      if((tempF &gt; 84) &amp;&amp; (tempF &lt; 85)) {<br/>        digitalWrite(3, HIGH);<br/>      }<br/>      else {<br/>        digitalWrite(3, LOW);<br/>      } <br/>    <br/>      if((tempF &gt; 83.00 ) &amp;&amp; (tempF &lt; 84)) {<br/>        digitalWrite(4, HIGH);<br/>      }<br/>      else {<br/>        digitalWrite(4, LOW);<br/>      } <br/>    <br/>    <span epub:type="pagebreak" id="page_291"/><br/>      if((tempF &gt; 82) &amp;&amp; (tempF &lt; 83)) {<br/>        digitalWrite(5, HIGH);<br/>      }<br/>      else {<br/>        digitalWrite(5, LOW);<br/>      } <br/>    <br/>      if((tempF &gt; 81.00 ) &amp;&amp; (tempF &lt; 82)) {<br/>        digitalWrite(6, HIGH);<br/>      }<br/>      else {<br/>        digitalWrite(6, LOW);<br/>      } <br/>    <br/>      if((tempF &gt; 80) &amp;&amp; (tempF &lt; 81)) {<br/>        digitalWrite(7, HIGH);<br/>      }<br/>      else {<br/>        digitalWrite(7, LOW);<br/>      } <br/>    <br/>      if((tempF &gt; 79.00 ) &amp;&amp; (tempF &lt; 80)) {<br/>        digitalWrite(8, HIGH);<br/>      }<br/>      else {<br/>        digitalWrite(8, LOW);<br/>      } <br/>    <br/>      if((tempF &gt; 78) &amp;&amp; (tempF &lt; 79)) {<br/>        //Code for blinking LED as an alarm<br/>        digitalWrite(9, HIGH);<br/>        delay(50);<br/>        digitalWrite(9, LOW);<br/>        delay(50);<br/>      }<br/>      else {<br/>        digitalWrite(9, LOW);<br/>      } <br/>    <br/>      if((tempF &gt; 77.00 ) &amp;&amp; (tempF &lt; 78)) {<br/>        digitalWrite(10, HIGH);<br/>      }<br/>      else {<br/>        digitalWrite(10, LOW);<br/>      }<br/>    <br/>     <br/>      if(tempF &lt; 76) {<br/>        digitalWrite(11, HIGH);<br/>      }<br/>      else {<br/>        digitalWrite(11, LOW);<br/>      }<br/>  }</p>&#13;
<p class="indent">After including libraries, the LM35 sketch defines the number of samples to keep track of at <span class="ent">➊</span>. The higher the number, the more the readings will be <span epub:type="pagebreak" id="page_292"/>smoothed, but the longer it will take to settle. Using a constant rather than a normal variable for the number of samples allows this value to determine the size of the <span class="literal">readings</span> array.</p>&#13;
<p class="indent">The <span class="literal">setup()</span> code initializes the LCD, turns on serial communication for debugging, initializes the readings array with all zeros (because the sketch hasn’t read anything yet), and sets the ADC reference voltage to 1.1V. The <span class="literal">loop()</span> code stores sensor data in the <span class="literal">readings</span> array and averages the readings to calculate a temperature to display. If you have an LCD, the sketch shows the temperature on it, and then it checks various temperature ranges with <span class="literal">if</span> statements to see which LEDs to turn on.</p>&#13;
<p class="indent">The big difference between this sketch and the next is that the LM35 version sets up the system to accept the analog voltage from the sensor and direct it to an analog input. It also establishes a reference voltage of 1.1V with the <span class="literal">analogReference(INTERNAL)</span> command.</p>&#13;
<h4 class="h4" id="ch10lev2sec2"><em><strong>Sketch for the MCP9808 System</strong></em></h4>&#13;
<p class="noindent">The sketch for the version with the high-accuracy MCP9808 chip (or the board from Adafruit) uses much of the same code; the conditional statements that turn on the LEDs are identical. The only part that differs is how the Arduino gets the temperature information from the sensor. Here is the full sketch:</p>&#13;
<p class="programs"><br/>/*Sketch for MCP9808 version of Chromatic Thermometer<br/><br/> This version of the Chromatic Thermometer uses the Adafruit MCP9808 breakout<br/> Board (or Microchip MCP9808 chip) and the Adafruit_MCP9808 library<br/> available from Adafruit ----&gt; https://www.adafruit.com/product/1782<br/><br/> The averaging may not be necessary. It tends to slow the<br/> response a little, but smoothes out the display.<br/><br/> The result is truncated to a single decimal for both Celsius and Fahrenheit.<br/> This version includes the code to turn on and off 10 LEDs.<br/>*/ <br/><br/>#include &lt;Wire.h&gt;               //Set up wire/serial library <br/>#include "Adafruit_MCP9808.h" //Set up MCP9808 library <br/>#include &lt;LiquidCrystal_I2C.h&gt;  //Set up library for LCD <br/><br/>LiquidCrystal_I2C lcd(0x27, 16, 2);   //16x2 display; define LCD <br/><br/>// Create the MCP9808 temperature sensor object <br/>Adafruit_MCP9808 tempsensor = Adafruit_MCP9808(); <br/><br/>const int numReadings = 10;     //Once again averaging 10 readings <br/>float readings[numReadings];    //The readings from the analog input<br/>int index = 0;                  //The index of the current reading<br/>float TempC = 0;<br/>float tempF = 0;<br/>float total = 0;                //The running total <br/>float average = 0;              //The average<br/><br/><span epub:type="pagebreak" id="page_293"/><br/>void setup() {<br/>  Serial.begin(9600); <br/><br/>  lcd.init();  //Initiate LCD and backlight<br/>  lcd.backlight(); <br/><br/><br/><br/>/*Make sure the sensor is found. You can also pass a different I2C address<br/>from the default, as in tempsensor.begin(0x19).*/   <br/>  if(!tempsensor.begin()) { <br/>    Serial.println("Couldn't find MCP9808!");<br/>    while(1);<br/>  }<br/>} <br/>void loop() {<br/>  //Read and print out the temperature; then convert to Fahrenheit<br/>  float c = tempsensor.readTempC();<br/>  total = total - readings[index];<br/>  //Read from the sensor<br/>  readings[index] = c;<br/>  //Add the reading to the total<br/>  total = total + readings[index];<br/>  //Advance to the next position in the array<br/>  index = index + 1;<br/>  if(index &gt;= numReadings)        //If we're at the end of the array… <br/>    index = 0;                        //…wrap around to the beginning:<br/>  //Calculate the average<br/>  average = total / numReadings; <br/><br/>  TempC = average;<br/>  tempF = (TempC * 9 / 5) + 32;<br/>  delay(100); <br/><br/>  //Set up LCD to print out temperatures<br/>  lcd.setCursor(0, 0);<br/>  lcd.print("Temp          ");<br/>  lcd.setCursor(6, 0);<br/>  lcd.print(TempC, 1);                //Truncate to one decimal place<br/>  lcd.print((char)223);<br/>  lcd.print(" C");<br/>  lcd.setCursor(0, 1);<br/>  lcd.print("Temp  ");  <br/>  lcd.setCursor(6, 1);<br/>  lcd.print(tempF, 1);               //Truncate to one decimal place<br/>  lcd.print((char)223); <br/>/*May need to use (char) 178 if LCD displays the greek alpha character. Different LCDs display different special characters*/<br/><br/>  lcd.print(" F");<br/>  delay(100); <br/><br/>  //Beginning of conditional statements for display<br/>  if((tempF &gt; 85.00 ) &amp;&amp; (tempF &lt; 100)) {<br/>  digitalWrite(2, HIGH);<br/>  }<br/><span epub:type="pagebreak" id="page_294"/><br/>  else {<br/>  digitalWrite(2, LOW);<br/>  } <br/><br/>  if((tempF &gt; 84) &amp;&amp; (tempF &lt; 85)) {<br/>  digitalWrite(3, HIGH);<br/>  }<br/>  else {<br/>  digitalWrite(3, LOW);<br/>  } <br/><br/>  if((tempF &gt; 83.00 ) &amp;&amp; (tempF &lt; 84)) {<br/>  digitalWrite(4, HIGH);<br/>  }<br/>  else {<br/>  digitalWrite(4, LOW);<br/>  } <br/><br/>  if((tempF &gt; 82) &amp;&amp; (tempF &lt; 83)) {<br/>  digitalWrite(5, HIGH);<br/>  }<br/>  else {<br/>  digitalWrite(5, LOW);<br/>  } <br/><br/>  if((tempF &gt; 81.00 ) &amp;&amp; (tempF &lt; 82)) {<br/>  digitalWrite(6, HIGH);<br/>  }<br/>  else {<br/>  digitalWrite(6, LOW);<br/>  } <br/><br/>  if((tempF &gt; 80) &amp;&amp; (tempF &lt; 81)) {<br/>  digitalWrite(7, HIGH);<br/>  }<br/>  else {<br/>  digitalWrite(7, LOW);<br/>  } <br/><br/>  if((tempF &gt; 79.00 ) &amp;&amp; (tempF &lt; 80)) {<br/>  digitalWrite(8, HIGH);<br/>  }<br/>  else {<br/>  digitalWrite(8, LOW);<br/>  } <br/><br/>  if((tempF &gt; 78) &amp;&amp; (tempF &lt; 79)) {  //Code for blinking LED<br/>  digitalWrite(9, HIGH);<br/>  delay(50);<br/>  digitalWrite(9, LOW);<br/>  delay(50);<br/>  }<br/>  else {<br/>  digitalWrite(9, LOW);<br/>  }<br/> <br/><span epub:type="pagebreak" id="page_295"/><br/><br/>  if((tempF &gt; 77.00 ) &amp;&amp; (tempF &lt; 78)) {<br/>  digitalWrite(10, HIGH);<br/>  }<br/>  else {<br/>  digitalWrite(10, LOW);<br/>  } <br/><br/>  if(tempF &lt; 76) {<br/>  digitalWrite(11, HIGH);<br/>  }<br/>  else {<br/>  digitalWrite(11, LOW);<br/>  } <br/>}</p>&#13;
<p class="indent">The MCP9808 sketch’s version of the <span class="literal">setup()</span> code checks to make sure you have the MCP9808 temperature sensor plugged in. In the <span class="literal">loop()</span> section, it calls the <span class="literal">readTempC()</span> function from the <em>Adafruit_MCP9808</em> library to fetch the current temperature, instead of calling <span class="literal">analogRead()</span> directly, as the LM35 code does. Unlike the LM35 code, this sketch doesn’t need to set up an external voltage reference: one advantage of using the MCP9808 is that the chip contains its own internal reference. Otherwise, apart from a few differences in variable names, the rest of the sketch is the same as the LM35 code.</p>&#13;
<h4 class="h4" id="ch10lev2sec3"><em><strong>How the Temperature Readouts Work</strong></em></h4>&#13;
<p class="noindent">In both sketches, the basic temperature readout comprises a series of 10 different colored LEDs with transistors driven in an emitter-follower configuration from outputs D2 through D11 on the Nano.</p>&#13;
<p class="indent">The outputs of the Nano are activated by the sketch, and each output corresponds to a conditional statement of the form, “If temperature is between <em>X</em> degrees and <em>Y</em> degrees, turn on an LED. If not, turn off the LED.” The <span class="literal">if</span> statements for these commands are the same in both the LM35 and the MCP9808 high-accuracy version.</p>&#13;
<p class="indent">When I first completed the project, I used it in a saltwater fish tank, where I wanted to accurately view the temperature at a glance and at a distance. I set up the LEDs to blink at unacceptable temperature extremes to get my attention so I could take corrective action. The blinking effect required only turning the LED off and on with a delay in between. I modified the sketch to read as follows for the warning condition:</p>&#13;
<p class="programs"><br/>  if((tempF &gt; 78) &amp;&amp; (tempF &lt; 79)) {<br/>    digitalWrite(9, HIGH);<br/>    delay(50);<br/>    digitalWrite(9, LOW);<br/>    delay(50);<br/>  }<br/>    else {<br/>      digitalWrite(9, LOW);<br/>  }</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_296"/>This example blinks the display when, and only when, the temperature is between 78 and 79°F, as indicated in the full sketch. The length of the delay, combined with any further delays you might add, determines the blinking rate.</p>&#13;
<p class="indent">The general readout system and this simple, silent alarm worked extremely well together. I could set alarms to make sure that the temperature was above or below the threshold temperature.</p>&#13;
<p class="indentb">I also thought it might be valuable to have a digital readout, however, for two reasons:</p>&#13;
<ol>&#13;
<li><p class="order">I wanted the option to see exactly what the temperature was.</p></li>&#13;
<li><p class="order">Should the temperature go out of range and the “blink” alarm execute, I wanted to see how far from the limit the temperature was.</p></li>&#13;
</ol>&#13;
<p class="indent">Adding the digital display was relatively easy, as I used a standard 16×2 LCD with I<sup>2</sup>C interface requiring only four wires. I bought an LCD with a built-in I<sup>2</sup>C adapter this time. It was larger than I had hoped for, but I was unable to find a smaller display easily. If you can find one, go for it.</p>&#13;
<h3 class="h3" id="ch10lev1sec9"><strong>The Shield</strong></h3>&#13;
<p class="noindent">The PCB shield for this project was designed with two copper layers rather than a single layer. The extra layer makes fabricating the board a little more difficult, but it saves a lot of effort in identifying and wiring jumpers. I initially etched the board in-house, but I had the finished board produced by Express PCB. The plated through-holes on the professionally finished board made assembly a lot easier. The layers of the PCB are shown in <a href="ch10.xhtml#ch10fig10-7">Figure 10-7</a>.</p>&#13;
<p class="indent">Notice that the LED driver transistors are located below the Nano board to save on surface area. The only penalty to this is that the Nano sits a little higher on the board. You can see the transistors in <a href="ch10.xhtml#ch10fig10-8">Figure 10-8</a>, which shows the populated PCB with the Nano board next to it.</p>&#13;
<p class="indent">The shield also includes provisions for two I<sup>2</sup>C devices—one at either end of the board. Because I thought this board might find its way into many different projects, I made it as flexible as possible. The I<sup>2</sup>C <span epub:type="pagebreak" id="page_297"/>connections make it easy to hook up both the high-accuracy Adafruit breakout board as well as a digital display. You can either wire them in directly or solder a straight or right-angle female header into the board for use with a crimped-connector housing with cable (see <a href="ch10.xhtml#ch10fig10-9">Figure 10-9</a>).</p>&#13;
<div class="image"><img alt="image" src="../images/fig10_7.jpg"/></div>&#13;
<p class="figcap" id="ch10fig10-7"><em>Figure 10-7: The top layer of the PCB shield with silkscreen image. You can see the pattern for the MCP9808 in the bottom left</em>.</p>&#13;
<div class="image"><img alt="image" src="../images/fig10_8.jpg"/></div>&#13;
<p class="figcap" id="ch10fig10-8"><em>Figure 10-8: Populated shield next to an Arduino Nano. Notice that I used full-length female headers for the Nano. Also note the holes and traces for an 11th LED in the top right</em>.</p>&#13;
<div class="image"><img alt="image" src="../images/fig10_9.jpg"/></div>&#13;
<p class="figcap" id="ch10fig10-9"><em>Figure 10-9: The assembled thermometer using the MCP9808 chip soldered directly to the shield (lower right). One I<sup>2</sup>C connector is above and to the right of the MCP9808 chip; connections for another I<sup>2</sup>C connector are at the lower left</em>.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_298"/>The shield includes pads for the MCP9808 chip (installed in <a href="ch10.xhtml#ch10fig10-9">Figure 10-9</a>) if you elect to solder the chip directly to the board. If you use the MCP9808 chip rather than the breakout board without another connection to the I<sup>2</sup>C interface, you will have to provide 10-kilohm pull-up resistors to the SDA and SCL lines. These are not included in the shield layout but can easily be added to the I<sup>2</sup>C port connections since they would be unused. In the implementation in <a href="ch10.xhtml#ch10fig10-9">Figure 10-9</a>, the 10-kilohm resistors are on the LCD adapter because there will be an LCD adapter plugged into the I<sup>2</sup>C port, eliminating the need for the pull-up resistors.</p>&#13;
<p class="indent">While the shield files included for this project provide for direct attachment of the LEDs to the PCB, there are many instances where you may want to separate the PCB from the LEDs. For example, I made one version where I spaced out high-intensity, 10 mm LEDs an inch apart on a decorative piece of wood to create a more dramatic look. To do something like that, you’d want to solder long wires to the LED leads and then solder those to the PCB. The cathodes of all the LEDs can be wired together, and only the anodes need be connected to the board individually.</p>&#13;
<h3 class="h3" id="ch10lev1sec10"><strong>Construction</strong></h3>&#13;
<p class="indent">If you haven’t soldered your components to the shield PCB or a prototyping board, do so now, and remember to assemble the LEDs with the correct polarity. The final configuration of the Chromatic Thermometer depends very much on your final application, so I will not go into a lot of specific detail on constructing this project.</p>&#13;
<p class="indent">For example, if you want to use a remote temperature sensor, you will want a jack or another appropriate connector. You may also want to cut a slit in the enclosure to accommodate a wire for the sensor, as well as another for a long power connection. And if you are going to build the Chromatic Thermometer with only the LEDs and no LCD, you would probably mount the electronics inside the enclosure differently. Similarly, if you build the high-accuracy version, you may need to adjust how you fit your parts into the enclosure. The Chromatic Thermometer shown in <a href="ch10.xhtml#ch10fig10-10">Figure 10-10</a> uses the LM35 sensor with the 16×2 LCD.</p>&#13;
<p class="indent">I used a small box I found on Amazon (originally sold to hold baseball cards) to enclose the whole thing and mounted the sensor directly to the shield in the three holes to accommodate it in the PCB. If you don’t want the LED on the Nano to show, you can unsolder it, or simply cover it with a small piece of black electrical tape.</p>&#13;
<p class="indent">Whether you use the 3 mm LEDs or the heftier, high-output 5 mm LEDs, using some kind of spacer works well for making sure the LEDs are lined up at the height you like. When I mounted the readout LEDs to the shield, I placed a sliver of unused PCB material to hold all of the LEDs at a uniform height (see <a href="ch10.xhtml#ch10fig10-11">Figure 10-11</a>). You could use cardboard just as easily, and if you want a different height, just use a taller or shorter spacer.</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_299"/><img alt="image" src="../images/fig10_10.jpg"/></div>&#13;
<p class="figcap" id="ch10fig10-10"><em>Figure 10-10: The completed Chromatic Thermometer in an acrylic enclosure, monitoring the temperature of medicine in a cooler when traveling. This version uses a 9V battery, which is inside the enclosure. I used a display with a backlight, but the battery will last a lot longer without the backlight. Turn on/off thresholds for LEDs were modified for cold temperature use</em>.</p>&#13;
<div class="image"><img alt="image" src="../images/fig10_11.jpg"/></div>&#13;
<p class="figcap" id="ch10fig10-11"><em>Figure 10-11: I used a discarded strip of PCB material to hold LEDs at uniform height</em></p>&#13;
<p class="indent">If you use 5 mm LEDs, you may have difficulty fitting them through the holes in a standard PCB, as some 5 mm LEDs have wider leads. I expanded the holes with a drill to fit the larger LEDs; because there were no connections on the other side of the PCB, the plate-through was not needed.</p>&#13;
<div class="sidebar">&#13;
<p class="sidebar"><span epub:type="pagebreak" id="page_300"/><a id="ch10sd1"/><strong>MOD: TRY DIFFERENT LEDS</strong></p>&#13;
<p class="noindent">The Chromatic Thermometer shown in <a href="ch10.xhtml#ch10fig10-8">Figure 10-8</a> uses 3 mm LEDs. I ordered 3 mm LEDs on eBay in 10 different colors, but the leads were a little short. Subsequently, I ordered 200 5 mm LEDs in a selection of 10 different colors. These also had short leads, but they were brighter and worked well. I did have to file the edges of some of the LEDs where there was a little extra flashing from the mold so they would fit within the 0.200-inch spacing (a little more than 5 mm) on the PCB. However, I could not find enough different-colored high-output 5 mm LEDs.</p>&#13;
<p class="indent">For one experimental version, I used six different-colored high-output 5 mm LEDs, repeated the colors at the extremes, and went back to the sketch to create blinking patterns to differentiate the similar colors. That version of the Chromatic Thermometer worked well, and the high-output LEDs made it quite noticeable.</p>&#13;
<p class="indent">To attract even more attention, you can use high-output 10 mm LEDs. They will not fit on the shield PCB shown here, however, as I only spaced the LEDs out by 0.200 inches. That spacing allows for most 3 mm and 5 mm LEDs, but not 10 mm ones. See <a href="ch10.xhtml#ch10fig10-12">Figure 10-12</a> for a size comparison.</p>&#13;
<div class="image"><img alt="image" src="../images/fig10_12.jpg"/></div>&#13;
<p class="figcap" id="ch10fig10-12"><em>Figure 10-12: From left to right, 10 mm, 5 mm, and 3 mm LEDs shown next to a metric ruler</em></p>&#13;
<p class="indent">To use 10 mm LEDs, you will have to mount them elsewhere and connect them to the PCB with wires. For inspiration, look at the lightbar for the Watch Winder in <a href="ch04.xhtml#ch04">Chapter 4</a>.</p>&#13;
</div>&#13;
<h3 class="h3" id="ch10lev1sec11"><span epub:type="pagebreak" id="page_301"/><strong>Using the Chromatic Thermometer</strong></h3>&#13;
<p class="noindent">How you place the thermometer in the environment you want to monitor is limited only by your imagination. The version I use on my fish tank had no LCD at first, so I simply attached a couple of wire hooks to the bare board and hung it from the edge of the tank with the LEDs facing out. (I could have mounted the entire thing in a small acrylic box, but I had difficulty finding a box with the right dimensions.) This configuration worked well.</p>&#13;
<p class="indent">I eventually replaced that Chromatic Thermometer with a version including an LCD that I enclosed in an acrylic box. I’m thinking of modifying it again to use high-intensity LEDs that shine through the tank. That should create an interesting effect!<span epub:type="pagebreak" id="page_302"/></p>&#13;
</body></html>