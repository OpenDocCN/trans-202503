<html><head></head><body>
<div id="sbo-rt-content"><section aria-labelledby="ch14" epub:type="chapter" role="doc-chapter">
<span aria-label="261" epub:type="pagebreak" id="pg_261" role="doc-pagebreak"/>
<hgroup>
<h2 class="CHAPTER" id="ch14">
<span class="CN"><span class="SANS_Futura_Std_Bold_Condensed_B_11">14</span></span>
<span class="CT"><span class="SANS_Dogma_OT_Bold_B_11">WORKING WITH SESSIONS</span></span>
</h2>
</hgroup>
<figure class="opener"><img alt="" class="opener" height="380" src="../images/opener.jpg" width="380"/>
</figure>
<p class="INTRO">This chapter introduces browser sessions, which allow a web client and server to remember user information over time. When browsing an online store, for example, you expect to be able to add items into a shopping cart and for those items to be remembered a few minutes later, or even across browser tabs. Similarly, if you enter a username and password to access a web-based email system, you expect your successful login to be remembered as you click through pages to display email, draft messages, and so on. Sessions make this kind of memory possible.</p>
<p class="TX">This chapter discusses how to work with browser sessions in PHP, including storing and retrieving values, and resetting or destroying sessions <span aria-label="262" epub:type="pagebreak" id="pg_262" role="doc-pagebreak"/>entirely. We’ll develop a general pattern for writing code that uses sessions, which will be applicable to most situations, such as shopping carts and login authentication.</p>
<section aria-labelledby="sec1" epub:type="division">
<h3 class="H1" id="sec1"><span id="toc-link_191"/><span class="SANS_Futura_Std_Bold_B_11">A Web Browser Session</span></h3>
<p class="TNI1">A <i>browser session</i> is a temporary information exchange between a web client, such as a browser or phone app, and a web server. A session begins at a certain point in time and will terminate at a later point in time. Sessions often begin when a user directs their web browser to a new website; the browser and server agree on a unique session ID, and this ID will be used in the subsequent HTTP requests and responses exchanged between the client and server to indicate that they are all part of the same session. <a href="#fig14-1">Figure 14-1</a> illustrates a web client making repeated requests by continuing to use the session ID created after its first request.</p>
<figure class="IMG"><a id="fig14-1"/><img alt="" class="img80" height="1131" src="../images/figure14-1.jpg" width="1137"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 14-1: Repeated requests from a web client, each including the same session ID</span></p></figcaption>
</figure>
<p class="TX">You can find the session IDs behind real-world web interactions by using your browser’s developer tools to examine HTTP requests. For example, <a href="#fig14-2">Figure 14-2</a> shows the Amazon UK website agreeing on a session ID with my web browser.</p>
<span aria-label="263" epub:type="pagebreak" id="pg_263" role="doc-pagebreak"/>
<figure class="IMG"><a id="fig14-2"/><img alt="" class="img100" height="841" src="../images/figure14-2.jpg" width="1390"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 14-2: The Chrome browser tools showing a session ID from Amazon</span></p></figcaption>
</figure>
<p class="TX">Both the server and the client need to keep a record of the agreed-upon session ID, since this unique token must be included in each HTTP request. This way, when the server receives an incoming request, it can immediately tell which session it belongs to out of the potentially thousands of sessions the server might be tracking. The server also uses the session ID to store and manage the data for each session, such as shopping carts, successful logins, and so on. PHP web servers automatically create these session IDs, and the PHP language provides several functions for working with sessions. Web clients usually use an HTTP cookie to temporarily store session IDs.</p>
<p class="TX">Sessions can be ended in several ways, depending on the web server settings, the PHP code, and sometimes additional JavaScript code running on the web clients. Sessions are closed when the user quits the browser application. Sessions can also be terminated by PHP server code, such as when a user chooses to log out of their account. Some websites have JavaScript running in the web browser to detect when the user closes or navigates away from the website browsing tab, at which point the JavaScript sends a message to the server requesting that the session be ended.</p>
<p class="TX">Sessions might also time out; the server can set a time limit that starts with the latest client request so that if no new request is received within the designated time period, the server will automatically terminate the session. Time-outs help keep sites secure: if a user walks away from their computer, the session can time out and prevent a nonauthorized person from continuing the authorized session. (Even with time-outs, though, logging out or quitting the browser <i>before</i> walking away from your computer is always a good idea.)</p>
<aside aria-labelledby="box-10" class="box">
<span aria-label="264" epub:type="pagebreak" id="pg_264" role="doc-pagebreak"/>
<h4 class="BoxTitle" id="box-10"><span class="SANS_Dogma_OT_Bold_B_11">LOCALLY STORED SESSION COOKIES</span></h4>
<p class="BoxBodyFirst"><span class="SANS_Futura_Std_Book_11">An</span> <span class="SANS_Futura_Std_Book_Oblique_11">HTTP cookie</span><span class="SANS_Futura_Std_Book_11">, often just called a</span> <span class="SANS_Futura_Std_Book_Oblique_11">cookie</span><span class="SANS_Futura_Std_Book_11">, is a small piece of data stored on the system that runs the client (for example, a laptop or mobile phone running a web browser). Cookies can store temporary data such as the session ID, shopping cart items, open pages or tabs, and authentication status (whether a user is logged in).</span></p>
<p class="BoxBodyLast"><span class="SANS_Futura_Std_Book_11">Cookies can also be used to store data for longer periods so certain information, such as usernames, can be automatically prefilled into websites that are visited frequently. Currently, almost all websites use cookies to track users’ behavior across multiple sites and for long periods of time in order to deliver targeted advertising. This has sparked concerns about privacy that are being addressed through various laws around the world (especially in Europe), often requiring users to be informed of and to give consent to the use of tracking cookies.</span></p>
</aside>
</section>
<section aria-labelledby="sec2" epub:type="division">
<h3 class="H1" id="sec2"><span id="toc-link_192"/><span class="SANS_Futura_Std_Bold_B_11">The session_start() and session_id() Functions</span></h3>
<p class="TNI1">PHP provides the <span class="SANS_TheSansMonoCd_W5Regular_11">session_start()</span> function, which starts a new session if none currently exists, or renews an existing session if a valid session ID is included in the received HTTP request. When renewing an existing session, the function restarts the time-out timer. Although you rarely need to know the unique session ID when writing PHP scripts, the language does provide a function to retrieve it: <span class="SANS_TheSansMonoCd_W5Regular_11">session_id()</span>.</p>
<p class="TX">Listing 14-1 shows a two-statement PHP script that first calls <span class="SANS_TheSansMonoCd_W5Regular_11">session _start()</span> and then prints the value returned by <span class="SANS_TheSansMonoCd_W5Regular_11">session_id()</span>.</p>
<span id="lis14-1"/>
<pre><code>&lt;?php&#13;
session_start();&#13;
print session_id();</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 14-1: Starting (or restarting) a session and printing its ID</span></p>
<p class="TX">If you run this script, the output will be a long string of letters and numbers similar to <span class="SANS_TheSansMonoCd_W5Regular_11">d98rqmn9amvtf3cqbpifv95bdd</span>. This is the unique session ID generated by <span class="SANS_TheSansMonoCd_W5Regular_11">session_start()</span> and retrieved by <span class="SANS_TheSansMonoCd_W5Regular_11">session_id()</span>.</p>
<blockquote>
<p class="Note"><span class="SANS_Dogma_OT_Bold_B_15">NOTE</span></p>
</blockquote>
<p class="NOTE-TXT"><i>An alternative to using the</i> <span class="SANS_TheSansMonoCd_W5Regular_Italic_11">session_start()</span> <i>function in your PHP code is to enable automatic session starting through a configuration setting for the PHP engine (</i><span class="SANS_TheSansMonoCd_W5Regular_Italic_11">session.auto_start = 1</span> <i>in the</i> <span class="note">php.ini</span> <i>file) or for the web server (</i><span class="SANS_TheSansMonoCd_W5Regular_Italic_11">php_value session .auto_start 1</span> <i>in</i> <span class="note">.htaccess</span> <i>for Apache web servers). However, when learning to use sessions or if your web hosting makes configuration changes difficult, the best approach is to use the</i> <span class="SANS_TheSansMonoCd_W5Regular_Italic_11">session_start()</span> <i>function, as illustrated throughout this chapter.</i></p>
</section>
<section aria-labelledby="sec3" epub:type="division">
<span aria-label="265" epub:type="pagebreak" id="pg_265" role="doc-pagebreak"/>
<h3 class="H1" id="sec3"><span id="toc-link_193"/><span class="SANS_Futura_Std_Bold_B_11">The $_SESSION Superglobal Array</span></h3>
<p class="TNI1">You don’t usually need to reference a specific session ID in your PHP code to work with sessions. Instead, you primarily work with session data through the built-in <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array. This is another of PHP’s <i>superglobals</i>, like <span class="SANS_TheSansMonoCd_W5Regular_11">$_GET</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">$_POST</span> that we met in <span class="Xref"><a href="chapter11.xhtml">Chapter 11</a></span>.</p>
<p class="TX">The <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array holds data related to the current session using string keys. This array is automatically provided by the PHP engine when an HTTP request with a session ID is received from a client. It’s there so PHP web programmers have a variable for storing any values that need to be remembered for the current client’s session from one request to another.</p>
<p class="TX">One way to understand this is to consider that a typical web server might be maintaining tens, hundreds, or thousands of <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> arrays, one for each session with each of the clients currently communicating with the server. (Think of the thousands of people using eBay or Amazon at any given time.) When the server executes a PHP script for a particular client request that has been received (containing a unique session ID), the PHP engine retrieves data stored on the server associated with that session ID and puts it in the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array for that copy of the script to work with. (Many copies of the script may be being executed at any point in time, one for each of the clients using the website.) This process allows that copy of the script to remember any values from previous client/server interactions during the session.</p>
<p class="TX">To see how this all works, let’s write a script that attempts to both store and retrieve a value from the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array. One common use of sessions is to store login authentication tokens, so we’ll work with the username of the currently logged-in user as an example. <a href="#lis14-2">Listing 14-2</a> shows the code.</p>
<span id="lis14-2"/>
<pre><code>&lt;?php&#13;
session_start();&#13;
$message = '(no username found in session)';&#13;
&#13;
if (isset($_SESSION['username'])) {&#13;
    $message = 'username value in session = ' . $_SESSION['username'];&#13;
}&#13;
&#13;
$_SESSION['username'] = 'matt';&#13;
&#13;
print $message;</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 14-2: Attempting to retrieve, then store, a value in the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">$_SESSION</span> <span class="SANS_Futura_Std_Book_Oblique_11">array</span></p>
<p class="TX">After (re)starting the session with <span class="SANS_TheSansMonoCd_W5Regular_11">session_start()</span>, we store the default string value <span class="SANS_TheSansMonoCd_W5Regular_11">(no username found in session)</span> in the <span class="SANS_TheSansMonoCd_W5Regular_11">$message</span> variable. Then we use the <span class="SANS_TheSansMonoCd_W5Regular_11">isset()</span> function to test whether any value can be found in the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array under the <span class="SANS_TheSansMonoCd_W5Regular_11">'username'</span> key. If a value is found, we update <span class="SANS_TheSansMonoCd_W5Regular_11">$message</span> with a new string including that value. Next, we store the value <span class="SANS_TheSansMonoCd_W5Regular_11">'matt'</span> into <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION['username']</span>. This will overwrite any existing value in the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array for the <span class="SANS_TheSansMonoCd_W5Regular_11">'username'</span> key. Finally, we print out whatever string is stored in <span class="SANS_TheSansMonoCd_W5Regular_11">$message</span>. <a href="#fig14-3">Figure 14-3</a> shows the result of visiting this web page twice in a row.</p>
<span aria-label="266" epub:type="pagebreak" id="pg_266" role="doc-pagebreak"/>
<figure class="IMG"><a id="fig14-3"/><img alt="" class="img70" height="322" src="../images/figure14-3.jpg" width="1036"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 14-3: Retrieving the username from the session on the second request</span></p></figcaption>
</figure>
<p class="TX">The first time the page is visited, no value is found in the session for <span class="SANS_TheSansMonoCd_W5Regular_11">'username'</span> at the time the <span class="SANS_TheSansMonoCd_W5Regular_11">if</span> statement is executed, so the default message is displayed. The second time the page is visited, however, the value <span class="SANS_TheSansMonoCd_W5Regular_11">'matt'</span> that was stored to the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array the first time through the script is retrieved and displayed back. In this way, the session allows us to remember a value from one execution of the script to the next.</p>
<section aria-labelledby="sec4" epub:type="division">
<h4 class="H2" id="sec4"><span id="toc-link_194"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Updating a Stored Value</span></h4>
<p class="TNI1">One benefit of the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array is that its values can be updated as needed. For example, if you were using the session to keep track of a user’s shopping cart, you’d need to make updates each time the user adds or removes an item. We’ll explore that exact scenario in <span class="Xref"><a href="chapter15.xhtml">Chapter 15</a></span>, but for now we’ll consider a simpler example of updating a value in the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array: a hit counter that stores and displays the number of HTTP requests made to a website. When personal websites first became popular, having such a hit counter was common.</p>
<p class="TX">A caveat here: in reality, sessions aren’t an appropriate mechanism for storing data from different website visitors or for storing values for time periods of more than seconds or minutes. As we’ve discussed, a separate set of data is stored for each user’s session, so a session-based hit counter can count only the number of website visits made by the <i>same user</i>. Also, sessions are terminated when the user quits the browser or the session times out, so visiting the site later in the day (or on another day) will mean the session-based hit counter will restart at 1, having “forgotten” the previous visits. Still, a session-based hit counter is a helpful project for introducing some of the core logic involved in session storage operations.</p>
<p class="TX"><a href="#fig14-4">Figure 14-4</a> illustrates the counter we’re aiming to create. The first time the page is visited, the counter is 1. Then, with each page refresh, the previous total is remembered and incremented by one.</p>
<span aria-label="267" epub:type="pagebreak" id="pg_267" role="doc-pagebreak"/>
<figure class="IMG"><a id="fig14-4"/><img alt="" class="img100" height="542" src="../images/figure14-4.jpg" width="1374"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 14-4: A hit counter incrementing after each page refresh</span></p></figcaption>
</figure>
<p class="TX">Listing 14-3 shows the <i>public/index.php</i> script needed to create the session- based hit counter.</p>
<span id="lis14-3"/>
<pre><code>&lt;link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABC&#13;
AIAAACQd1PeAAAADElEQVQI12P4//8/AAX+Av7czFnnAAAAAElFTkSuQmCC"&gt;&#13;
&#13;
&lt;?php&#13;
session_start();&#13;
&#13;
<span aria-label="annotation1" class="codeannotated_CodeAnnotation">❶</span> $pageHits = 0;&#13;
<span aria-label="annotation2" class="codeannotated_CodeAnnotation">❷</span> if (isset($_SESSION['counter'])) {&#13;
  <span aria-label="annotation3" class="Code_CodeAnnotation">❸</span> $pageHits = $_SESSION['counter'];&#13;
}&#13;
&#13;
<span aria-label="annotation4" class="codeannotated_CodeAnnotation">❹</span> $pageHits++;&#13;
&#13;
<span aria-label="annotation5" class="codeannotated_CodeAnnotation">❺</span> $_SESSION['counter'] = $pageHits;&#13;
&#13;
<span aria-label="annotation6" class="codeannotated_CodeAnnotation">❻</span> print "&lt;p&gt;Counter (number of page hits): $pageHits&lt;/p&gt;";</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 14-3: Using a session variable to simulate a website hit counter</span></p>
<p class="TX">The first part of the script is HTML for a dummy favicon. Since modern browsers will send an extra request for a favicon image if one isn’t defined in the HTML received, adding this <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;link&gt;</span> element at the beginning of the script keeps the browser happy and prevents it from making twice as many requests, which would make the hit counter confusing.</p>
<p class="TX"><span aria-label="268" epub:type="pagebreak" id="pg_268" role="doc-pagebreak"/>This script hinges on the typical logic of first testing whether any value exists in the session before attempting to retrieve and update it. We use a local PHP variable called <span class="SANS_TheSansMonoCd_W5Regular_11">$pageHits</span> to represent the number of page hits when the script is executed, while we use the <span class="SANS_TheSansMonoCd_W5Regular_11">'counter'</span> key to store the running total in the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array. (The distinct names help avoid any confusion between these two values.)</p>
<p class="TX">After starting the session, we set <span class="SANS_TheSansMonoCd_W5Regular_11">$pageHits</span> to a default value of <span class="SANS_TheSansMonoCd_W5Regular_11">0</span> to represent the case when there’s no existing value stored in the session <span aria-label="annotation1" class="CodeAnnotation">❶</span>. Next, we test whether any value can be found in the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array under the <span class="SANS_TheSansMonoCd_W5Regular_11">'counter'</span> key <span aria-label="annotation2" class="CodeAnnotation">❷</span>. If a value is found, we retrieve it from the array and store it in the <span class="SANS_TheSansMonoCd_W5Regular_11">$pageHits</span> variable, overwriting the default value <span aria-label="annotation3" class="CodeAnnotation">❸</span>.</p>
<p class="TX">At this point, whether or not a value is found in the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array, we know we have an appropriate value in the <span class="SANS_TheSansMonoCd_W5Regular_11">$pageHits</span> variable: either <span class="SANS_TheSansMonoCd_W5Regular_11">0</span> or the running total of hits up to but not including the current page visit. In either case, we add <span class="SANS_TheSansMonoCd_W5Regular_11">1</span> to <span class="SANS_TheSansMonoCd_W5Regular_11">$pageHits</span> to account for the current visit to the page <span aria-label="annotation4" class="CodeAnnotation">❹</span>. Then we store the updated value of <span class="SANS_TheSansMonoCd_W5Regular_11">$pageHits</span> into the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array under the <span class="SANS_TheSansMonoCd_W5Regular_11">'counter'</span> key, either overwriting the key’s existing value or creating it if this is the first page visit <span aria-label="annotation5" class="CodeAnnotation">❺</span>. Finally, we output a message stating the number of times the page has been visited <span aria-label="annotation6" class="CodeAnnotation">❻</span>.</p>
<p class="TX">The flowchart in <a href="#fig14-5">Figure 14-5</a> illustrates the general logic behind our hit-counter script. You can correlate this flowchart with points <span aria-label="annotation1" class="CodeAnnotation">❶</span> through <span aria-label="annotation6" class="CodeAnnotation">❻</span> in <a href="#lis14-3">Listing 14-3</a>.</p>
<figure class="IMG"><a id="fig14-5"/><img alt="" class="img60" height="761" src="../images/figure14-5.jpg" width="879"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 14-5: How to update (or set) a session variable</span></p></figcaption>
</figure>
<p class="TX">The logic in the flowchart generalizes to just about any work you may need to do with session values. First, you set a variable to a default value in the local script. Then you check whether a previously stored value can be found in the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array and use that to overwrite the default if appropriate. Next, you update the local variable and store the updated value back in the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array. Usually, you’ll also want to do something with the updated variable. This approach works whether it’s the beginning of <span aria-label="269" epub:type="pagebreak" id="pg_269" role="doc-pagebreak"/>the session (meaning nothing is stored in the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array) or the code is being executed upon the second, third, or <i>n</i>th request during the session (meaning a value is stored in the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array from a previous run of the script).</p>
</section>
<section aria-labelledby="sec5" epub:type="division">
<h4 class="H2" id="sec5"><span id="toc-link_195"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Unsetting a Value</span></h4>
<p class="TNI1">At times you’ll want to remove a particular value stored in the session. As we discussed in <span class="Xref"><a href="chapter8.xhtml">Chapter 8</a></span>, you can delete a value from an array by using the <span class="SANS_TheSansMonoCd_W5Regular_11">unset()</span> function. This is different from setting an array element to something like <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span>, an empty string, or <span class="SANS_TheSansMonoCd_W5Regular_11">0</span>, since unsetting an element removes <i>any</i> value associated with the string key. Using our hit-counter example, we would remove any session value associated with the <span class="SANS_TheSansMonoCd_W5Regular_11">'counter'</span> key by calling <span class="SANS_TheSansMonoCd_W5Regular_11">unset($_SESSION['counter'])</span>. We might do this, for example, if the page had a Reset button that cleared the hit counter.</p>
<p class="TX">Let’s implement such a Reset button now, as well as add a link to revisit the hit-counter page (and therefore increment the counter). <a href="#fig14-6">Figure 14-6</a> shows the page we’ll try to create.</p>
<figure class="IMG"><a id="fig14-6"/><img alt="" class="img70" height="529" src="../images/figure14-6.jpg" width="1103"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 14-6: The hit-counter page with revisit and reset links</span></p></figcaption>
</figure>
<p class="TX">To add this functionality, update your <i>index.php</i> script to match <a href="#lis14-4">Listing 14-4</a>.</p>
<span id="lis14-4"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABC</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">AIAAACQd1PeAAAADElEQVQI12P4//8/AAX+Av7czFnnAAAAAElFTkSuQmCC"&gt;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">session_start();</span>&#13;
&#13;
$action = filter_input(INPUT_GET, 'action');&#13;
if ('reset' === $action) {&#13;
  <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> unset($_SESSION['counter']);&#13;
}&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$pageHits = 0;</span>&#13;
<span aria-label="annotation2" class="codeannotated_CodeAnnotation">❷</span> <span class="TheSansMonoCd_W5Regular_Grey_11">if (isset($_SESSION['counter'])) {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    $pageHits = $_SESSION['counter'];</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span>&#13;
&#13;
<span aria-label="270" epub:type="pagebreak" id="pg_270" role="doc-pagebreak"/><span class="TheSansMonoCd_W5Regular_Grey_11">$pageHits++;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$_SESSION['counter'] = $pageHits;</span>&#13;
?&gt;&#13;
&#13;
&lt;p&gt;Counter (number of page hits): &lt;?= $pageHits ?&gt;&#13;
&lt;p&gt;&lt;a href="/index.php"&gt;visit page again&lt;/a&gt;&#13;
<span aria-label="annotation3" class="codeannotated_CodeAnnotation">❸</span> &lt;p&gt;&lt;a href="/index.php?action=reset"&gt;(reset counter)&lt;/a&gt;</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 14-4: Adding a reset link to the hit counter</span></p>
<p class="TX">After (re)starting the session, we retrieve and test the value of the <span class="SANS_TheSansMonoCd_W5Regular_11">'action'</span> query-string variable. If its value is <span class="SANS_TheSansMonoCd_W5Regular_11">'reset'</span>, we unset the <span class="SANS_TheSansMonoCd_W5Regular_11">'counter'</span> element in the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array <span aria-label="annotation1" class="CodeAnnotation">❶</span>. Then the script proceeds as before. In the event that the user has clicked the Reset button and the <span class="SANS_TheSansMonoCd_W5Regular_11">'counter'</span> element was unset, it will be as if this element never existed, so the <span class="SANS_TheSansMonoCd_W5Regular_11">isset()</span> test <span aria-label="annotation2" class="CodeAnnotation">❷</span> will fail and the <span class="SANS_TheSansMonoCd_W5Regular_11">'counter'</span> element will end up with a fresh value of <span class="SANS_TheSansMonoCd_W5Regular_11">1</span> (after the default value of <span class="SANS_TheSansMonoCd_W5Regular_11">0</span> is incremented).</p>
<p class="TX">At the end of the file, we add two links. The first is simply to revisit <i>index.php</i> (and so increment the counter). The second link is also to <i>index.php</i> but includes an <span class="SANS_TheSansMonoCd_W5Regular_11">'action'</span> query-string variable with a value of <span class="SANS_TheSansMonoCd_W5Regular_11">'reset'</span>, which will trigger the script to reset the counter <span aria-label="annotation3" class="CodeAnnotation">❸</span>.</p>
</section>
<section aria-labelledby="sec6" epub:type="division">
<h4 class="H2" id="sec6"><span id="toc-link_196"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Destroying the Session and Emptying the Session Array</span></h4>
<p class="TNI1">Sometimes you might want to destroy the entire session and so invalidate the session ID and delete all stored session data. The deletion may be a security requirement, for example, since destroying a session should result in the server session data being <i>immediately</i> destroyed rather than waiting for a garbage-collection process (such as after a session time-out). That said, completely destroying a session is generally not recommended, since it may interfere with ongoing concurrent requests, such as asynchronous JavaScript. If all you want to do is clear the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array, you can do so without entirely killing the session: use <span class="SANS_TheSansMonoCd_W5Regular_11">unset($_SESSION)</span> or <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION = []</span> to turn <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> into an empty array.</p>
<p class="TX">If you <i>do</i> need to completely destroy a session, take these steps:</p>
<p class="ListNumberF">1.   (Re)start the session with <span class="SANS_TheSansMonoCd_W5Regular_11">session_start()</span>.</p>
<p class="ListNumber">2.   Set the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array to an empty array.</p>
<p class="ListNumber">3.   If using cookies, invalidate (time out) the session cookie.</p>
<p class="ListNumberL">4.   Destroy the PHP session by executing the <span class="SANS_TheSansMonoCd_W5Regular_11">session_destroy()</span> function.</p>
<p class="BodyContinued">See the PHP documentation at <i><a href="https://www.php.net/manual/en/function.session-destroy.php">https://www.php.net/manual/en/function.session-destroy.php</a></i> for more information about this process.</p>
<p class="TX">Next, let’s add a link for killing the session to our hit-counter page. <a href="#fig14-7">Figure 14-7</a> shows the page with the added link, which passes the <span class="SANS_TheSansMonoCd_W5Regular_11">action=kill</span> query-string variable when the user wants to completely destroy the session.</p>
<span aria-label="271" epub:type="pagebreak" id="pg_271" role="doc-pagebreak"/>
<figure class="IMG"><a id="fig14-7"/><img alt="" class="img70" height="680" src="../images/figure14-7.jpg" width="1103"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 14-7: The hit-counter page with a new link to kill the session</span></p></figcaption>
</figure>
<p class="TX">To keep our <i>index.php</i> file from getting too complex, we’ll encapsulate the code to kill the session in a separate function. <a href="#lis14-5">Listing 14-5</a> shows the code for this <span class="SANS_TheSansMonoCd_W5Regular_11">killSession()</span> function; it implements steps 2 through 4 of the session-killing process outlined previously (step 1 happens at the beginning of the <i>index.php</i> file). Add a <i>src/usefulFunctions.php</i> file to your hit-counter project and enter the code in the listing.</p>
<span id="lis14-5"/>
<pre><code>function killSession() {&#13;
    $_SESSION = [];&#13;
&#13;
    if (ini_get("session.use_cookies")) {&#13;
        $params = session_get_cookie_params();&#13;
        setcookie(session_name(), '', time() - 42000,&#13;
            $params["path"], $params["domain"],&#13;
            $params["secure"], $params["httponly"]&#13;
        );&#13;
    }&#13;
&#13;
    session_destroy();&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 14-5: A function for killing a session</span></p>
<p class="TX">The function starts by setting <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> to an empty array (step 2) and ends by calling <span class="SANS_TheSansMonoCd_W5Regular_11">session_destroy()</span> (step 4). In between, the <span class="SANS_TheSansMonoCd_W5Regular_11">if</span> statement implements step 3 of the session-killing process: invalidating the session cookie. For this, we check whether cookies are in use, then change the cookie with the current session name to an empty string, also setting an expiring time that’s in the past (<span class="SANS_TheSansMonoCd_W5Regular_11">time() - 42000</span>), effectively deleting the cookie.</p>
<p class="TX"><span aria-label="272" epub:type="pagebreak" id="pg_272" role="doc-pagebreak"/>With the <span class="SANS_TheSansMonoCd_W5Regular_11">killSession()</span> function declared, update the <i>public/index.php</i> script as shown in <a href="#lis14-6">Listing 14-6</a> in order to offer a kill-session link to the hit- counter page.</p>
<span id="lis14-6"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABC</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">AIAAACQd1PeAAAADElEQVQI12P4//8/AAX+Av7czFnnAAAAAElFTkSuQmCC"&gt;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
require_once __DIR__ . '/../src/usefulFunctions.php';&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">session_start();</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$action = filter_input(INPUT_GET, 'action');</span>&#13;
&#13;
<span aria-label="annotation1" class="codeannotated_CodeAnnotation">❶</span> switch ($action) {&#13;
    case 'reset':&#13;
        unset($_SESSION['counter']);&#13;
        break;&#13;
&#13;
    case 'kill':&#13;
        killSession();&#13;
        break;&#13;
}&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$pageHits = 0;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">if (isset($_SESSION['counter'])) {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    $pageHits = $_SESSION['counter'];</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$pageHits++;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$_SESSION['counter'] = $pageHits;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">?&gt;</span>&#13;
&#13;
<span aria-label="annotation2" class="codeannotated_CodeAnnotation">❷</span> &lt;p&gt;Session ID = &lt;?= session_id() ?&gt;&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;p&gt;Counter (number of page hits): &lt;?= $pageHits ?&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;p&gt;&lt;a href="/index.php"&gt;visit page again&lt;/a&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;p&gt;&lt;a href="/index.php?action=reset"&gt;(reset counter)&lt;/a&gt;</span>&#13;
&lt;p&gt;&lt;a href="/index.php?action=kill"&gt;(kill session)&lt;/a&gt;</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 14-6: Adding a kill-session link to the hit-counter page</span></p>
<p class="TX">First, we read in the declaration of the <span class="SANS_TheSansMonoCd_W5Regular_11">killSession()</span> function from its source file. Then, since we need to check for multiple values of the <span class="SANS_TheSansMonoCd_W5Regular_11">'action'</span> query-string variable, we use a <span class="SANS_TheSansMonoCd_W5Regular_11">switch</span> statement <span aria-label="annotation1" class="CodeAnnotation">❶</span> to decide how to process the incoming HTTP request. If the action is <span class="SANS_TheSansMonoCd_W5Regular_11">'reset'</span>, we unset the <span class="SANS_TheSansMonoCd_W5Regular_11">'counter'</span> key of the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array as before, or if the action is <span class="SANS_TheSansMonoCd_W5Regular_11">'kill'</span>, we invoke <span class="SANS_TheSansMonoCd_W5Regular_11">killSession()</span>. In the HTML at the end of the script, we add a kill-session link that passes the <span class="SANS_TheSansMonoCd_W5Regular_11">action=kill</span> query-string variable to <i>index.php</i>. We also add a line displaying the current session ID to prove that the session is indeed being destroyed <span aria-label="annotation2" class="CodeAnnotation">❷</span>; if you click the kill-session link, this field should come up blank, in addition to the hit counter resetting to 1.</p>
</section>
</section>
<section aria-labelledby="sec7" epub:type="division">
<span aria-label="273" epub:type="pagebreak" id="pg_273" role="doc-pagebreak"/>
<h3 class="H1" id="sec7"><span id="toc-link_197"/><span class="SANS_Futura_Std_Bold_B_11">Summary</span></h3>
<p class="TNI1">This chapter introduced you to sessions, which provide a mechanism for a web server to remember information about a user across multiple HTTP requests. You learned how to start a session with <span class="SANS_TheSansMonoCd_W5Regular_11">session_start()</span>, how to store and update values in the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> superglobal array, and how to clear values from this array or destroy a session entirely. We outlined a basic pattern for working with session data, whereby you first set a default value, then overwrite this default with a value from the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array (if one exists) before updating the value and storing it back in the array.</p>
</section>
<section aria-labelledby="sec8" epub:type="division">
<h3 class="H1" id="sec8"><span id="toc-link_198"/><span class="SANS_Futura_Std_Bold_B_11">Exercises</span></h3>
<p class="ListNumber">1.   Visit a website where you think sessions are being used, such as an e-commerce website with a shopping cart feature or a site with a login page. Use your browser developer tools to find the session ID that has been agreed upon by the server and client and is being stored as a cookie on your client device.</p>
<p class="ListNumber">2.   Write a PHP script that looks in the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array for a value with the key <span class="SANS_TheSansMonoCd_W5Regular_11">'guess'</span>. If it isn’t found, store <span class="SANS_TheSansMonoCd_W5Regular_11">0</span> for this key and display a message to the user stating no previous value was found. If a value <i>is</i> found in the session, add a random number from 1 to 10 to that value. Store the result back in the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array and display it to the user.</p>
<p class="ListNumber">3.   Write a script to display a form that has a text box in which the user can enter a number, along with two Submit buttons. One Submit button should take the value from the text box and store it in the session. The second button should simply display the current value stored in the session, or a message stating no value was found in the session, as appropriate.</p>
</section>
</section>
</div></body></html>