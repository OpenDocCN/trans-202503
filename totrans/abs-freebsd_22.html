<html><head></head><body>
<h2 class="h2" id="ch22"><span epub:type="pagebreak" id="page_563"/><strong><span class="big">22</span><br/>JAILS</strong></h2>
<div class="image1"><img src="../images/common01.jpg" alt="image"/></div>
<p class="noindent">Virtualization separates an operating system instance from the underlying hardware. Virtualization allows you to move operating system installs from one piece of hardware to another by copying a file. Virtualization needs an operating system installed on the hardware, but that install is normally very minimal, has no public-facing services, and is easily reproduced on new hardware. It’s perhaps the biggest change in system administration in decades.</p>
<p class="indent">Virtualization is something like a client-server environment. The hardware and its core operating system instance is the <em>host</em>, while the <em>clients</em> are all virtualized operating system instances. The clients rely on the host to provide basic services, such as storage, processor power, and memory. Changes to the host can be reflected in the virtualized clients, but changes on the client have no effect on the host beyond consuming resources.</p>
<p class="indent">FreeBSD supports two types of virtualization: jails and bhyve.</p>
<p class="indent"><em>Jails</em> are a lightweight virtualization method, sometimes called <em>OS-level virtualization</em>. A jail normally contains a complete operating system userland <span epub:type="pagebreak" id="page_564"/>that runs on top of an existing FreeBSD system. The jail relies on the host’s filesystem but is limited to a subset of the directory tree. It might even have a chunk of dedicated space in a ZFS pool. A jail doesn’t have its own kernel and instead runs in a restricted portion of the host’s kernel. The host can manage jailed processes without entering the jail, or it can run processes inside the jail if preferred. Jails don’t get a graphical console. Use jails to virtualize FreeBSD installs of the same version or older, or to run simple virtual Linux systems.</p>
<p class="indent"><em>Bhyve</em> is a heavier virtualization system. Rather than using the host’s kernel and filesystem, bhyve simulates hardware. The host provides a chunk of disk space for the virtual machine to use as a disk. A bhyve virtual machine must bring along its own filesystem, kernel, and supporting infrastructure. Bhyve virtual machines require more resources than jails, but they also offer a console via virtual network computing (VNC) and can run truly foreign operating systems, like Microsoft Windows. Bhyve is changing rapidly thanks to its rapid development, so this book doesn’t cover it. I’ll write about bhyve once it stabilizes.</p>
<p class="indent">Before considering bhyve, see whether a jail will meet your needs.</p>
<h3 class="h3" id="lev1021"><strong>Jail Basics</strong></h3>
<p class="noindent">A jail is a supercharged chroot that applies not only to the filesystem but also to processes and the network stack. A jailed system can access only a narrow part of the filesystem and can’t see processes outside the jail. Traditionally, each jail is assigned a dedicated IP address, and the jail can view only traffic to that particular IP. Each jail even has its own user accounts. The root account in a jail completely controls that jail but has no access to anything beyond the jail.</p>
<p class="indent">To a user given root access to a jail, the jail looks like a nearly complete FreeBSD system, missing only a few device nodes. The user can install whatever software she likes without interfering with the host or other jails. All processes running in the jail can affect only the jail’s files and processes. The jailed user has no visibility of anything beyond the jail; she’s confined. If the jail is hacked, the intruder is also confined to the jail.</p>
<p class="indent">Jails can use a virtual network stack, based on vnet(9). That’s an advanced use we won’t cover here, but if you need to provide a jail with its own routing table, that’s how you do it.</p>
<p class="indent">As of FreeBSD 9, multiple jails can share a single IP address, but the sysadmin needs to configure each jail to use unique TCP/IP ports for every network service. You can’t run multiple SSH instances on port 22 of a single IP! For simplicity, the following examples use a single IP for each jail, but remember that you have other options.</p>
<p class="indent">Many people put all of their services in jails, even when a host is dedicated to a particular purpose. A ZFS snapshot of the jail dataset, or a tarball of the directory tree, is a complete backup of the jail. Restoration after a failed software upgrade becomes a simple matter of extracting a tarball or rolling back to the snapshot.</p>
<p class="indent"><span epub:type="pagebreak" id="page_565"/>A jail is also useful for software development and testing. Deploying a new service often requires installing and testing quite a few packages. Doing the testing in a jail before selecting a solution and proceeding to production prevents polluting the host with abandoned files and unneeded software.</p>
<p class="indent">Depending on your hardware and the system load, a single FreeBSD host can support dozens or even hundreds of jails. If you want to seriously run that many jails, though, make sure your host has two separate network interfaces. Dedicate one to jails and the other to managing the host.</p>
<p class="indent">Everything starts with configuring your jail host.</p>
<h3 class="h3" id="lev1022"><strong>Jail Host Server Setup</strong></h3>
<p class="noindent">A server meant as a jail host must work within a few annoying constraints. Configure your host correctly before building your first jail.</p>
<p class="indent">The jail system has its own sysctl tree, <code>security.jail</code>. You can change these sysctls only from the host system. Some sysctls affect all jails running on the host. Sysctls that begin with <code>security.jail.param</code> can be set on a per-jail basis. We’ll touch on these throughout this chapter.</p>
<h4 class="h4" id="lev1023"><strong><em>Jail Host Storage</em></strong></h4>
<p class="noindent">I strongly advise you to use your jail host only for the purpose of running jails and to put all services inside a jail. Start by configuring the host’s storage to separate jails and the host operating system.</p>
<p class="indent">Many hosts intended for virtualization include SATA DOM flash drives on the mainboard for the operating system. These drives are usually less than 100GB in size, but a base install of FreeBSD fits in much less than a gigabyte. If you have a SATA DOM or similar, use it for the host operating system. If you have multiple sets of redundant hard drives, use a pair to mirror the operating system and dedicate everything else to jails.</p>
<p class="indent">If you don’t have such hardware, dedicate space to the host operating system. Use either a partition for UFS filesystems or a dataset reservation for ZFS. In either case, 10GB of space should be sufficient. If you need additional space for an emergency, you can borrow some from the jail space.</p>
<p class="indent">While ZFS is highly useful for jails, it’s not necessary. I ran jails on UFS for many years. Use what works for you and fits your environment.</p>
<p class="indent">Once you have your host partitioned and the operating system installed, look at the network.</p>
<h4 class="h4" id="lev1024"><strong><em>Jail Networking</em></strong></h4>
<p class="noindent">There are two seemingly conflicting aspects of jail networking: first, each jail expects full control of any IP addresses assigned to it; and second, jails can share IP addresses with other jails and even the host. You can start a jail using any IP address on the host, but that jail can’t coordinate any network-facing services with other services running on that IP. If your jail shares the host’s IP address, and the host runs SSH on port 22, the jail can’t use port 22. If you try to start sshd(8) in the jail, the program will complain that it can’t <span epub:type="pagebreak" id="page_566"/>use port 22 and crash. Sharing IP addresses between jails, or even between jails and the host, requires the sysadmin to coordinate which ports belong to which hosts and to configure everything accordingly.</p>
<p class="indent">The simplest way to configure jails is to assign each its own IP address and give the host its own IP address. Each jail can then completely control its own IP address. Once you get the hang of this, you can start sharing addresses between jails. That means the host can’t have daemons listening on IP addresses assigned to jails. Having a host’s daemons listening on the jail’s IP won’t prevent the jail from starting, but it will prevent the jail from starting its own services on that port. Users like Bert will complain if they can’t SSH to their private jails!</p>
<p class="indent">The cleanest way to configure a jail host is to decide that the host only provides jails. Any services run on the host must be in a jail. If you need simple services, like a nameserver or a mail exchanger, configure them in a jail. Not only is this easier than properly reconfiguring all these servers to attach only to the selected IP address; it also provides an additional layer of security for your other jails. An intrusion on the host automatically grants the intruder access to all of your jails, while an intrusion on a single jail confines the intruder to that jail.</p>
<p class="indent">Use sockstat(1) to identify programs listening on your network, as discussed in <a href="ch09.xhtml#ch09">Chapter 9</a>. Add the <code>-46</code> flags to show only IPv4 and IPv6 traffic, and <code>-l</code> to show only listening sockets.</p>
<pre># <span class="codestrong1">sockstat -46l</span><br/>USER     COMMAND  PID   FD PROTO  LOCAL ADDRESS     FOREIGN ADDRESS<br/>root     ntpd     19776 20 udp6   *:123             *:*<br/>root     ntpd     19776 21 udp4   *:123             *:*<br/>--<span class="codeitalic1">snip</span>--<br/>root     sshd     2846  3  tcp6   *:22              *:*<br/>root     sshd     2846  4  tcp4   *:22              *:*</pre>
<p class="indent">This fairly default FreeBSD install has two programs listening to the network: ntpd and sshd. Both are listening to all IP addresses. We must configure all of these daemons to listen only to the main server address.</p>
<p class="indent">Here are some common daemons that cause problems on host servers. In all of these, I’ll assume that the jail host has an IP of 198.51.100.50.</p>
<h5 class="h5" id="lev1025"><strong>syslogd</strong></h5>
<p class="noindent">The system logger syslogd(8) opens a UDP socket so that it can send messages to other hosts. If you don’t log remotely, or if you use a different logging solution, use the <code>-ss</code> flag in <em>rc.conf</em> to turn off the network component.</p>
<pre>syslogd_flags="-ss"</pre>
<p class="indent">If you need to send syslogd messages, use the <code>-b</code> flag to force syslogd to attach to only a single IP address.</p>
<pre>syslogd_flags="-b 198.51.100.50"</pre>
<p class="indent"><span epub:type="pagebreak" id="page_567"/>Either solution lets your jails’ administrators individually decide whether or not they’re going to log across the network. See <a href="ch21.xhtml#ch21">Chapter 21</a> for a full discussion of syslogd.</p>
<h5 class="h5" id="lev1026"><strong>inetd</strong></h5>
<p class="noindent">If you need inetd (see <a href="ch20.xhtml#ch20">Chapter 20</a>), you should almost certainly run it from within a jail rather than the host. If you can’t weasel out of running inetd on the host, though, use the <code>-a</code> flag to restrict it to a single IP address, as in the following <em>rc.conf</em> snippet.</p>
<pre>inetd_flags="-a 198.51.100.50 -wW -C 60"</pre>
<p class="indent">If I had only specified the <code>-a</code> flag and the IP address, it would’ve overwritten inetd’s default flags from <em>/etc/defaults/rc.conf</em>. Every release of FreeBSD from the last few decades has used the default flags of <code>-wW -C 60</code>; I added my <code>-a</code> and the IP address to those flags.</p>
<h5 class="h5" id="lev1027"><strong>sshd</strong></h5>
<p class="noindent">The option <code>ListenAddress</code> in <em>/etc/ssh/sshd_config</em> tells sshd(8) which addresses to bind to. Restrict it to only your host IP.</p>
<pre>ListenAddress 198.51.100.50</pre>
<p class="indent">If the only service your jail host offers is sshd(8), you’ve done well.</p>
<h5 class="h5" id="lev1028"><strong>NFS</strong></h5>
<p class="noindent">Network filesystem programs, such as rpcbind(8) and nfsd(8), bind to all IP addresses on a host, no matter what you do. Don’t run these programs inside a jail, and don’t run NFS from within a jail. If your clients need NFS mounts, have the host run these programs and provide the NFS mounts.</p>
<h5 class="h5" id="lev1029"><strong>Network Time Protocol</strong></h5>
<p class="noindent">The most problematic service on a jail host is timekeeping. All jails get their system clock from the host. FreeBSD’s included time daemon, ntpd(8), listens to all IP addresses on the host—including the jailed ones. As the lone rare exception, though, I’m going to tell you to go ahead and run ntpd on the host.</p>
<p class="indent">A jail lacks the proper access to change the kernel’s time. While you could run ntpd in a jail, it couldn’t actually <em>do</em> anything. Go ahead and run ntpd on your jail host, and don’t worry about it<sup><a href="footnote.xhtml#ch22fn1" id="ch22fn1a">1</a></sup> listening to all IP addresses. Anyone who tries to run a UDP-based service other than ntpd on port 123 is probably trying to evade a packet filter. Make them work harder.</p>
<p class="indent"><span epub:type="pagebreak" id="page_568"/>If you want to avoid even the chance of a collision, install the <code>openntpd</code> package. Unlike the base system ntpd(8), OpenNTPD can be configured to listen to a single IP address.</p>
<h5 class="h5" id="lev1030"><strong>IP Addresses</strong></h5>
<p class="noindent">Each jail can have one or more IP addresses. These addresses must be attached to the host before you start the jail. A jail will run without any networking, but it won’t be accessible beyond the host. Add any necessary IP addresses as aliases in <em>/etc/rc.conf</em>.</p>
<h4 class="h4" id="lev1031"><strong><em>Jails at Boot</em></strong></h4>
<p class="noindent">To have FreeBSD start your jails at boot, set <code>jail_enable</code> in <em>rc.conf</em>.</p>
<pre>jail_enable=YES</pre>
<p class="indent">FreeBSD defaults to starting all jails listed in <em>/etc/jail.conf</em>. If you want the system to start only a subset of those jails at boot, use the <code>jail_list</code> <em>rc.conf</em> option. Here, I have two jails, called <em>mariadb</em> and <em>httpd</em>. I want them started in this order so that my database jail is running before the web server that calls it.</p>
<pre>jail_list="mariadb httpd"</pre>
<p class="indent">During system shutdown, FreeBSD stops jails in the same order it starts them. Your application might not like that. In my example, I want the web server to turn off before the database backend. I’d rather have a website be flat-out unavailable than have users see the dreaded “database server is kaput” error.</p>
<pre>jail_reverse_stop=YES</pre>
<p class="indent">If the jail startup order is unimportant, you can start and stop all jails simultaneously.</p>
<pre>jail_parallel_start="YES"</pre>
<p class="indent">Now you can configure a jail.</p>
<h3 class="h3" id="lev1032"><strong>Jail Setup</strong></h3>
<p class="noindent">Now that I have a host, I can install some jails. I’ll start with a jail called <em>mariadb</em>, for running . . . wait for it . . . MariaDB.</p>
<p class="indent">Each jail needs a dedicated root directory. All of my example jails live under <em>/jail</em>. I normally put each jail in a directory named after the jail name—in this case, <em>/jail/mariadb</em>.</p>
<p class="indent">Each jail needs a primary IP. It can also have other IPs, as we’ll see later, but let’s start with one. The jail mariadb gets 203.0.113.51.</p>
<p class="indent"><span epub:type="pagebreak" id="page_569"/>Each jail needs an internet hostname, just as if it were a real host. This jail will become <em>mariadb.mwl.io</em>.</p>
<p class="indent">Now we can put a userland in the jail.</p>
<h4 class="h4" id="lev1033"><strong><em>Jail Userland</em></strong></h4>
<p class="noindent">While you can install any userland components in a jail, all a jail requires is the base system. Grab the <em>base.txz</em> distribution set for your desired FreeBSD release and extract it in your jail’s root directory.</p>
<pre># <span class="codestrong1">tar -xpf base.txz -C /jail/mariadb</span></pre>
<p class="indent">That’s a complete install of the base operating system. If you want additional distribution sets, such as the debugging symbols, extract them the same way.</p>
<p class="indent">If you’ve built your own FreeBSD base system, you can install it in the jail.</p>
<pre># <span class="codestrong1">cd /usr/src</span><br/># <span class="codestrong1">make installworld DESTDIR=/jail/mariadb</span></pre>
<p class="indent">Jails also need supporting directories and assorted detritus created by the install process, but not by <code>make installworld</code>. The <code>make distribution</code> command creates those files. If you already have these directories and files, though, don’t rerun <code>make distribution</code>: it’ll overwrite any local changes. And don’t forget the DESTDIR setting, unless you like resetting the host’s configuration!</p>
<pre># <span class="codestrong1">make distribution DESTDIR=/jail/mariadb</span></pre>
<p class="indent">You can also build a custom userland with only enough binaries for running a single program, much as you would for a traditionally chrooted program. For most of us, that’s too much work, but if you want to break out ldd(1) and go wild, don’t let me stop you.</p>
<p class="indent">Once you have a jail userland, tell FreeBSD about your jail in <em>/etc/jail.conf</em>.</p>
<h4 class="h4" id="lev1034"><strong><em>/etc/jail.conf</em></strong></h4>
<p class="noindent">Traditionally, FreeBSD configured jails in <em>/etc/rc.conf</em>. This was clunky and unwieldy. While FreeBSD still supports <em>rc.conf</em> configuration of jails, I recommend using the more flexible <em>/etc/jail.conf</em> instead. This file isn’t in UCL, although it looks like something UCL could support. Define each jail by a name. Give the jail parameters in braces after the jail name. Each parameter definition ends in a semicolon.</p>
<p class="indent">Many jail parameters have an equal sign, where we assign a parameter a value. Here, I set the parameter <code>path</code> to the value <code>/jail/mariadb</code>:</p>
<pre>path="/jail/mariadb";</pre>
<p class="indent"><span epub:type="pagebreak" id="page_570"/>Other parameters enable or disable a feature with their mere presence. Here, I tell this jail to turn on the <code>mount.devfs</code> feature:</p>
<pre>mount.devfs;</pre>
<p class="indent">Jails support a whole bunch of “mount” parameters, with subparameters for different filesystems. This particular parameter specifically addresses mounting devfs.</p>
<p class="indent">Toggles can be turned off for a jail by adding <em>no</em> in front of the specific parameter. If I don’t want to enable devfs, I wouldn’t turn off the whole mount parameter; I’d put the <em>no</em> in front of the <em>devfs</em>.</p>
<pre>mount.nodevfs;</pre>
<p class="indent">Here’s how I define a jail named <em>mariadb</em>:</p>
<pre>mariadb {<br/> host.hostname="mariadb.mwl.io";<br/> ip4.addr="203.0.113.51";<br/> path="/jail/mariadb";<br/> mount.devfs;<br/> exec.clean;<br/> exec.start="sh /etc/rc";<br/> exec.stop="sh /etc/rc.shutdown";<br/>}</pre>
<p class="indent">The parameter <code>host.hostname</code> gives the jail’s hostname. While the jail name is <em>mariadb</em>, this host identifies itself by the internet hostname <em>mariadb.mwl.io</em>.</p>
<p class="indent">The IP address is in <code>ip4.addr</code>. I’ve assigned the address 203.0.113.51 to this jail. This IP must be on the host first.</p>
<p class="indent">The jail’s root directory goes in the <code>path</code> variable. Here, it’s set to <em>/jail/mariadb</em>.</p>
<p class="indent">Almost every jail needs access to specific device nodes in <em>/dev</em>, which requires mounting devfs (see <a href="ch13.xhtml#ch13">Chapter 13</a>) in the jail. Enable devfs with the <code>mount.devfs</code> setting. A jail defaults to getting only a few very specific device nodes. An untrusted user can sometimes use device nodes to escape a jail, so don’t add additional devices without careful research. You can allow other device nodes with a custom devfs ruleset. Assign a custom devfs ruleset to the jail with the devfs_ruleset <em>jail.conf</em> parameter. I strongly recommend using the default jail devfs rules as a base and unhiding the additional devices this jail needs, rather than trying to build a custom devfs ruleset from scratch.</p>
<p class="indent">A jailed process can inherit parts of its environment from the parent process. The <code>exec.clean</code> option tells jail(8) to strip away all of the environment except for $TERM. The environment variables $HOME, $USER, and $SHELL get set to the target environment, normally that of the jail’s root account. You’ll almost always want <code>exec.clean</code>.</p>
<p class="indent">The <code>exec.start</code> and <code>exec.stop</code> options tell FreeBSD how to start and stop the jail.</p>
<h5 class="h5" id="lev1035"><span epub:type="pagebreak" id="page_571"/><strong>In-Jail Startup</strong></h5>
<p class="noindent">Jails can emulate a full-running FreeBSD userland, run a single process, or anything in between. You must either use the <code>exec.start</code> <em>jail.conf</em> parameter to tell FreeBSD what process to run in the jail or the <code>persist</code> parameter to declare you want the jail to exist even without any processes in it. Here, I start a full FreeBSD userland, using the normal FreeBSD startup script:</p>
<pre>exec.start="/bin/sh /etc/rc"</pre>
<p class="indent">If you need only a single command to run inside the jail, you can write your own startup script and use <code>exec.start</code> to run it when the jail boots. Your brand-new jail won’t have an <em>rc.conf</em> yet, so it won’t start any additional processes.</p>
<p class="indent">Instead of <code>exec.start</code>, you could set the <code>persist</code> option. This tells FreeBSD that a jail can exist without any processes running inside it. Including both <code>persist</code> and <code>exec.start</code> means that FreeBSD will start a process for the jail, but when the process stops running, the jail won’t shut itself down.</p>
<p class="indent">You can tell the jail to run an additional command after it starts with the <code>exec.poststart</code> option. Any command or script listed with <code>exec.poststart</code> gets run in the host once the normal <em>/etc/rc</em> startup process (including any enabled packages) finishes. This lets you write scripts to glue jails together.</p>
<p class="indent">Similarly, you can use the <code>exec.prestop</code> option to run a command on the host before stopping the jail. When the sysadmin turns the jail off, the host first runs this command, and then the jail runs the normal shutdown command.</p>
<p class="indent">The <code>exec.stop</code> command tells FreeBSD what command to run inside the jail to shut the jail down. If you’re simulating a full jail, you’ll probably run <code>/</code><code>bin/sh /etc/rc.shutdown</code> as in our example in the previous section.</p>
<h5 class="h5" id="lev1036"><strong>Jail Defaults</strong></h5>
<p class="noindent">You’ll find that many of your jails share common settings. You can define those settings in the front of the configuration. All jails will use those settings unless you override them. This doesn’t seem to make much sense when using a single jail.</p>
<pre>exec.start="/bin/sh /etc/rc";<br/>exec.stop="/bin/sh /etc/rc.shutdown";<br/>exec.clean;<br/>mount.devfs;<br/><br/>mariadb {<br/>        host.hostname="mariadb.mwl.io";<br/>        ip4.addr="203.0.113.221";<br/>        path="/jail/mariadb";<br/>}</pre>
<p class="indent">Given this configuration, though, adding another jail becomes five lines including the braces.</p>
<pre><span epub:type="pagebreak" id="page_572"/>httpd {<br/>        host.hostname="httpd.mwl.io";<br/>        ip4.addr="203.0.113.222";<br/>        path="/jail/httpd";<br/>}</pre>
<p class="indent">Over dozens of jails, it saves a lot of trouble.</p>
<p class="indent">You can override the defaults within a jail’s definition. If I don’t want to mount devfs(5) in a jail, I would set <code>mount.nodevfs</code> for that specific jail.</p>
<h5 class="h5" id="lev1037"><strong>jail.conf Variables</strong></h5>
<p class="noindent">You can use variable substitutions in jails. While you can define some of these variables, you can also pull some from the jail’s settings. Variables are expanded in double quotes and in unquoted strings, but not in single-quoted strings.</p>
<p class="indent">Here, I define a variable for the directory that contains all of my jails and use that inside my jail definition:</p>
<pre>$j="/jail";<br/>mariadb {<br/>        path="$j/mariadb";<br/>--<span class="codeitalic1">snip</span>--<br/>}</pre>
<p class="indent">If I must move my jails to a new filesystem or pool, I can update <em>jail.conf</em> by changing the one variable rather than editing every definition.</p>
<h5 class="h5" id="lev1038"><strong>Parameters as Variables</strong></h5>
<p class="noindent">Once you define a jail parameter, you can use it as a variable. Every jail has at least one parameter, <code>name</code>. You can use these parameters to further expand default settings.</p>
<pre>$j="/jail";<br/>path="$j/$name";<br/>host.hostname="$name.mwl.io";<br/><br/>mariadb {<br/>        ip4.addr="203.0.113.221";<br/>}</pre>
<p class="indent">By setting the global default <code>path</code> to <code>$j/$name</code>, I’ve removed the need to define path for each individual jail.</p>
<p class="indent">You can use multiterm parameters with a period in them by enclosing the parameter in braces. While this doesn’t make sense for parameters like <code>mount.devfs</code>, it’s useful for per-jail parameters, like <code>host.hostname</code>.</p>
<pre>path = "/jail/${host.hostname}";</pre>
<p class="indent"><span epub:type="pagebreak" id="page_573"/>I prefer to put my jails in directories named after the shorter name, rather than the hostname, but feel free to indulge your own biases.</p>
<p class="indent">Combining parameters and variables with a coherent directory layout lets you squeeze each jail definition down into a single configuration statement.</p>
<h4 class="h4" id="lev1039"><strong><em>Testing and Configuring a Jail</em></strong></h4>
<p class="noindent">Once you have files for a jail, lock yourself in. Run the jail(8) command to run a single command inside the jail. You’ll need four arguments: the path, the jail name, the primary IP, and the command to run.</p>
<pre># <span class="codestrong1">jail</span><span class="codestrongitalic1"> &lt;path to jail&gt; &lt;jail name&gt; &lt;jail IP&gt; &lt;command&gt;</span></pre>
<p class="indent">Here, I use the jail in <em>/jail/mariadb</em>, named <em>mariadb</em>, with the IP address 203.0.113.51, to run the command <em>/bin/sh</em>:</p>
<pre># <span class="codestrong1">jail /jail/mariadb/ mariadb 203.0.113.51 /bin/sh</span><br/>#</pre>
<p class="indent">Run ls(1). You’re in the root directory of your jail filesystem. This jail isn’t quite in single-user mode, but no programs other than <em>/bin/sh</em> are running here. You can do some basic setup, but not even devfs(5) is mounted.</p>
<pre># <span class="codestrong1">ps</span><br/>ps: /dev/null: No such file or directory</pre>
<p class="indent">Yes, the normal jail startup process would mount <em>/dev</em>—but the jail has no user accounts, no root password, no daemons running, and absolutely nothing optional. Configure the jail before starting it.</p>
<h5 class="h5" id="lev1040"><strong>Stuff to Steal from the Host</strong></h5>
<p class="noindent">Some host setup information is also useful within the jail. You can copy this information from the host to the jail, but you must do this from the host, not the jail.</p>
<p class="indent">Each jail performs its own DNS resolution. You can probably copy the host’s <em>/etc/resolv.conf</em> into the jail.</p>
<p class="indent">Your jail probably shares the same time zone as the host. Copy the host’s <em>/etc/localtime</em> into the jail or run tzsetup(8) inside the jail to select a new time zone.</p>
<h5 class="h5" id="lev1041"><strong>Create /etc/fstab</strong></h5>
<p class="indent">Many programs and scripts, including <em>/etc/rc</em>, expect to find <em>/etc/fstab</em> and have a tantrum if it’s not there. Requiring <em>/etc/fstab</em> is perfectly sensible in a real server, but a jailed machine has no need for a filesystem table. Create an empty filesystem table.</p>
<pre># <span class="codestrong1">touch /etc/fstab</span></pre>
<p class="indent"><span epub:type="pagebreak" id="page_574"/>I don’t mind unhappy programs. I just don’t want to listen to them whinge.</p>
<h5 class="h5" id="lev1042"><strong>Create /etc/rc.conf</strong></h5>
<p class="noindent">Either you’ll do all jail management from the host, or you’ll manage jails via SSH. You’ll need an <em>/etc/rc.conf</em> entry for sshd.</p>
<pre>sshd_enable="YES"</pre>
<p class="indent">Add any other settings you want while creating this file. If you know some of the settings packages will need, it won’t hurt to set them before they’re needed.</p>
<h5 class="h5" id="lev1043"><strong>User Accounts and Root Password</strong></h5>
<p class="noindent">You can add user accounts and change passwords only from within the jail. Set a root password with passwd(1) and run adduser(8) to add at least one user, for SSH. While SSH is not the only way to access the host, it’s far easier in most cases.</p>
<h4 class="h4" id="lev1044"><strong><em>Jail Startup and Shutdown</em></strong></h4>
<p class="noindent">The host considers each jail an independent service, much like sshd(8), a web server, or any other daemon. Yes, each jail might run a whole bunch of services that need managing independently, but from the host’s perspective, each jail is a single entity containing a group of processes. That’s part of the separation between the host and the jail.</p>
<p class="indent">Use service(8) to start, stop, and restart jails. You’ll need to provide one additional argument, the name of the jail. FreeBSD automatically starts them at boot, but you can stop, start, and restart them individually once the system is running. Let’s shut down my database jail and fire it up again.</p>
<pre># <span class="codestrong1">service jail stop mariadb</span><br/># <span class="codestrong1">service jail start mariadb</span></pre>
<p class="indent">I could use the restart command, but that wouldn’t look nearly so impressive here on the page.</p>
<p class="indent">If you omit the jail name, the service(8) command affects all jails that FreeBSD starts at boot.</p>
<pre># <span class="codestrong1">service jail restart</span><br/>Stopping jails: httpd mariadb.<br/>Starting jails: mariadb httpd</pre>
<p class="indent">This lets you coherently reinitialize your production jail infrastructure.</p>
<p class="indent">FreeBSD defaults to starting all jails listed in <em>/etc/jail.conf</em>. As discussed in “<a href="ch22.xhtml#lev1031">Jails at Boot</a>” on <a href="ch22.xhtml#page_568">page 568</a>, you can change that in <em>/etc/rc.conf</em>. The service(8) command can control jails that aren’t autostarted, but you must specify them by name.</p>
<h4 class="h4" id="lev1045"><span epub:type="pagebreak" id="page_575"/><strong><em>Jail Dependencies</em></strong></h4>
<p class="noindent">If you have a whole bunch of jails, listing the start order in <em>/etc/rc.conf</em> can get tedious. You’ll most often need to set a start order to maintain service dependencies. Rather than defining the order in <em>rc.conf</em>, though, you can tell a jail that it requires another jail with the <code>depend</code> option.</p>
<pre>httpd {<br/>        ip4.addr="203.0.113.232";<br/>        depend=mariadb;<br/>}</pre>
<p class="indent">The jail httpd won’t start until the jail mariadb is running. A <code>depend</code> statement overrides a <em>rc.conf</em> <code>jail_list</code> entry.</p>
<h3 class="h3" id="lev1046"><strong>Managing Jails</strong></h3>
<p class="noindent">Virtualization doesn’t make system administration tasks evaporate; it only adds options for performing typical sysadmin tasks. Here’s some of those options.</p>
<h4 class="h4" id="lev1047"><strong><em>Viewing Jails and Jail IDs</em></strong></h4>
<p class="noindent">Use jls(8) to see all jails currently running on the system.</p>
<pre># jls<br/>   JID  IP Address      Hostname        Path<br/>    29  203.0.113.221   mariadb.mwl.io  /jail/mariadb<br/>    30  203.0.113.222   httpd.mwl.io    /jail/httpd<br/>    31  203.0.113.223   test.mwl.io     /jail/test</pre>
<p class="indent">Each jail has a unique jail ID, or JID. The JID is much like a process ID; while each jail has one, the exact JID issued to a jail changes each time the jail is started. We’ll use the jail ID or name to execute various jail-management tasks.</p>
<p class="indent">We also get each jail’s IP address, hostname, and the path to the jail’s files. You don’t get the jail name, but those of us who use a hostname based on the jail name have no trouble figuring it out.</p>
<h4 class="h4" id="lev1048"><strong><em>Jailed Processes</em></strong></h4>
<p class="noindent">Jailed processes all get a process ID, like any other Unix process. Process IDs are not unique to jails; they’re shared between the host, the jail, and all the other jails. You won’t find repeated process IDs.</p>
<p class="indent">Jailed processes show up in ps(1) with the <code>-J</code> flag.</p>
<pre># <span class="codestrong1">ps -ax</span><br/>  PID TT  STAT        TIME COMMAND<br/>    0  -  DLs      2:56.24 [kernel]<br/>    1  -  ILs      0:00.07 /sbin/init –<br/><span epub:type="pagebreak" id="page_576"/>--<span class="codeitalic1">snip</span>--<br/>35002  -  SsJ      0:00.01 /usr/sbin/syslogd -s<br/>35129  -  IsJ      0:00.00 /usr/sbin/sshd<br/>--<span class="codeitalic1">snip</span>--</pre>
<p class="indent">Process IDs 35002 and 35129 are jailed.</p>
<p class="indent">View a particular jail’s processes with ps(1) using the <code>-J</code> flag and the jail name.</p>
<pre># <span class="codestrong1">ps -ax -J test</span><br/>  PID TT  STAT    TIME COMMAND<br/>35561  -  IsJ  0:00.01 /usr/sbin/syslogd -s<br/>35652  -  IsJ  0:00.00 /usr/sbin/sshd<br/>35661  -  SsJ  0:00.03 sendmail: accepting connections (sendmail)<br/>--<span class="codeitalic1">snip</span>--</pre>
<p class="indent">Using <code>-J 0</code> excludes all jailed processes from ps(1) output, letting you more easily debug the host.</p>
<p class="indent">Commands like pgrep(1), pkill(1), and killall(1) all accept a <code>-j</code> argument to let you specify a jail. If you prefer using pgrep(1) to view process information, use <code>pgrep -lfj</code> and the jail name or JID.</p>
<pre># <span class="codestrong1">pgrep -lf -j mariadb</span><br/>  PID TT  STAT    TIME COMMAND<br/>35002  -  SsJ  0:00.01 /usr/sbin/syslogd -s<br/>35129  -  IsJ  0:00.00 /usr/sbin/sshd<br/>35158  -  SsJ  0:00.02 sendmail: accepting connections (sendmail)<br/>--<span class="codeitalic1">snip</span>--</pre>
<p class="indent">Why is Sendmail running inside this jail? Let’s kill it.</p>
<pre># <span class="codestrong1">pkill -9 -j mariadb sendmail</span></pre>
<p class="indent">Running pgrep again shows that Sendmail is dead.</p>
<p class="indent">This works well if you want to get information about which processes are running in a jail, but sometimes you have a process ID and must identify which jail it belongs to. That’s where you need the <code>-O</code> option to ps(1). This option supports a bunch of keywords that adjust the output of ps(1) in ways not supported by the regular command line flags—specifically, <code>-O jail</code> adds a column for the name of the jail the process is running in.</p>
<pre># <span class="codestrong1">ps -ax -O jail | grep 39415</span><br/>39415 mariadb  -  IsJ    0:00.00 /usr/local/libexec/mysqld</pre>
<p class="indent">This process is running inside the jail mariadb.</p>
<h4 class="h4" id="lev1049"><strong><em>Running Commands in Jails</em></strong></h4>
<p class="noindent">The jexec(8) command lets the jail host administrator execute commands within a jail without going to the trouble of logging into the jail. This helps <span epub:type="pagebreak" id="page_577"/>preserve the jail owner’s sense of privacy.<sup><a href="footnote.xhtml#ch22fn2" id="ch22fn2a">2</a></sup> When jail owner Bert calls to beg for help, I don’t need his root password or even an account on his system. Using jexec requires knowing the jail’s name or JID. Here, I use the host’s root account to run <code>ps -ax</code> inside my jail mariadb.</p>
<pre># <span class="codestrong1">jexec mariadb ps -ax</span><br/>  PID TT  STAT    TIME COMMAND<br/>35002  -  SsJ  0:00.00 /usr/sbin/syslogd -s<br/>35129  -  IsJ  0:00.00 /usr/sbin/sshd<br/>--<span class="codeitalic1">snip</span>--</pre>
<p class="indent">This command runs as root inside the jail. I might want to run the command as another jailed user, though. Give that username with the <code>-U</code> flag.</p>
<pre># <span class="codestrong1">jexec -U xistence mariadb ps</span><br/>jexec: xistence: no such user</pre>
<p class="indent">Well, that’s not good. I’m expecting Bert to run my database. Let’s make him a user account.</p>
<pre># <span class="codestrong1">jexec mariadb adduser</span><br/>Username: xistence<br/>Full name: Bert JW Regeer<br/>Uid (Leave empty for default):<br/>Login group [bert]:<br/>Login group is bert. Invite bert into other groups? []: <span class="codestrong1">wheel</span><br/>--<span class="codeitalic1">snip</span>--</pre>
<p class="indent">This jail now has an account for Bert, using his preferred username and everything. I’ve added it to the wheel group within the jail. Remember, root access within a jail doesn’t equal root access on the host. That’s the whole point of jails.</p>
<p class="indent">I can now run commands as that user in that jail.</p>
<pre># <span class="codestrong1">jexec -U xistence mariadb sh</span><br/>$</pre>
<p class="indent">I’m locked up in jail! Specifically, in Bert’s jail cell.</p>
<p class="indent">This jailed process will behave a little oddly, though. A process retains its environment. In this case, while I’m running as the user xistence, I retain all the environment settings I had in my nonjailed process. This includes stuff like $SSH_AUTH_SOCK, my IRC server setting, and more. I don’t want this stuff in my jailed environment. If I’m logged in as Bert, I want to <em>be</em> Bert.</p>
<p class="indent">To strip your environment before entering a jail, use jexec’s <code>-l</code> flag. This simulates a clean login.</p>
<pre># <span class="codestrong1">jexec -lU xistence mariadb sh</span></pre>
<p class="indent"><span epub:type="pagebreak" id="page_578"/>Should you always strip your environment before running a command in a jail? No, not always. It depends entirely on what you’re doing.</p>
<p class="indent">Many commands include support for running them on the host but targeting a jail. Always check the man page for such an option. One good example is sysrc(8), which lets you specify a jail with <code>-j</code>. Here, I enable MariaDB on the jail mariadb. MariaDB has chosen to continue to use MySQL naming conventions, so it’s enabled with the <em>rc.conf</em> option <code>mysql_enable</code>.</p>
<pre># <span class="codestrong1">sysrc -j mariadb mysql_enable=YES</span><br/>mysql_enable:  -&gt; YES</pre>
<p class="indent">This jail is now ready to run MariaDB.</p>
<p class="indent">Except for the bit where MariaDB isn’t installed, of course. Let’s take care of that next.</p>
<h4 class="h4" id="lev1050"><strong><em>Installing Jail Packages</em></strong></h4>
<p class="noindent">FreeBSD’s package tools let you manage software either from within the jail or from the host. If the host administrator has allocated you a jail to configure, you probably want to manage packages from the jail. Jail packages work exactly as packages on any other FreeBSD host, as discussed in <a href="ch15.xhtml#ch15">Chapter 15</a>. If you’re responsible for the whole system, including the host and all the jails on that host, you probably want to manage each jail’s packages from the host rather than logging into each jail. Let’s spend some time on that.</p>
<p class="indent">The pkg(8) command’s <code>-j</code> flag lets you specify a jail to manage. You’ll need one argument, the jail’s name or JID. The <code>-j</code> flag must be given before the pkg(8) subcommand. Here, I install the MariaDB server on its dedicated jail:</p>
<pre># <span class="codestrong1">pkg -j mariadb install mariadb101-server</span><br/>Updating FreeBSD repository catalogue...<br/>FreeBSD repository is up to date.<br/>All repositories are up to date.<br/>The following 9 package(s) will be affected (of 0 checked):<br/>--<span class="codeitalic1">snip</span>--</pre>
<p class="indent">Note that pkg(8) offers no notice that it’s installing packages within a jail. It assumes that if you’re using <code>-j</code>, you know you’re working in a jail.</p>
<p class="indent">When you manage a jail’s packages from the host, the package tools don’t get installed on the jail. The jail has its own package database, stored within the jail, but the jail has no way to use that database directly.</p>
<p class="indent">Don’t switch between managing packages on the host and from within the jail. Choose one method and stick with it.</p>
<h4 class="h4" id="lev1051"><strong><em>Updating Jails</em></strong></h4>
<p class="noindent">So you have umpteen bajillion jails on your host, each dedicated to performing its own task in perfect isolation. That’s grand, until you have to <span epub:type="pagebreak" id="page_579"/>apply security patches to all of the hosts. If you’ve built your FreeBSD from source, you’ll need to install a new world in each jail. If you’re running releases, though, freebsd-update(8) (see <a href="ch18.xhtml#ch18">Chapter 18</a>) can handle jails.</p>
<p class="indent">You can’t use freebsd-update(8) <em>inside</em> a jail. The same things that isolate a jail from compromising the host system disallow some of the functionality freebsd-update(8) needs. Instead, you update the jail from the host.</p>
<p class="indent">Any time you need to update your system, update your host before updating your jails. The host must be running a version of FreeBSD equal to or newer than any jail.</p>
<p class="indent">Start by copying <em>/etc/freebsd-update.conf</em> to an alternate file, such as <em>/etc/jail-freebsd-update.conf</em>. Remove all components that aren’t installed on the jail. Jails don’t have kernels, and most of them don’t have source code, so you’ll probably wind up with an entry like this:</p>
<pre>Components world</pre>
<p class="indent">When you run freebsd-update(8), it checks the version of FreeBSD you’re running on. It does this by querying the kernel. If you have FreeBSD 12.0 jails on a FreeBSD 13.0 system, the update program gets confused, chokes, and dies with mysterious errors. You need freebsd-update to use the release installed in the jail, not the version the host is running. Use the <code>--currently-running</code> option to tell freebsd-update(8) what version the jail is running. You must use the jail’s release, including the patch level. While you could easily enough extract that information from the jail, I encourage you to let freebsd-update ask the jail what version it’s currently running. Do this by using jexec(8) to query the version of FreeBSD running in the jail.</p>
<p class="indent">You’ll also use the <code>-b</code> flag to tell freebsd-update(8) the directory the jail lives in.</p>
<p class="indent">Here, I update the jail called <em>test</em>. The jail’s files are in <em>/jail/test</em>. I use a jexec(8) command in backticks to check the current FreeBSD version.</p>
<pre># <span class="codestrong1">freebsd-update -f /etc/jail-freebsd-update.conf -b /jail/test/ --currently-running `jexec -l test freebsd-version` fetch install</span></pre>
<p class="indent">Once freebsd-update finishes running, restart your jail. It’s upgraded.</p>
<p class="indent">Many people have written scripts to run through <em>/etc/jail.conf</em> and upgrade all of their jails. If you have more than a couple jails, you find or write such a script.</p>
<h3 class="h3" id="lev1052"><strong>More Jail Options</strong></h3>
<p class="noindent">You can customize jails in all sorts of ways. The jail(8) man page includes the current list of jail options, but here’s a few features I commonly use.</p>
<p class="indent">Rather than letting jail(8) assign jail IDs, you can assign each jail a permanent ID with the <code>jid</code> option.</p>
<pre>jid=101;</pre>
<p class="indent"><span epub:type="pagebreak" id="page_580"/>The <code>securelevel</code> option lets you raise the securelevel (see <a href="ch09.xhtml#ch09">Chapter 9</a>) within a jail. The jail’s securelevel can never be lower than that of the host.</p>
<p class="indent">You can view a jail’s startup messages by manually running a <em>/etc/rc</em> with a jail command. That’s inconvenient for routine troubleshooting, though. Direct the jail’s console messages to a file with the <code>exec.consolelog</code> option.</p>
<pre>exec.consolelog="$j/logs/$name.log";</pre>
<p class="indent">In addition to mounting <em>/dev</em>, a jail can have its own fdescfs(5) and procfs(5) with the <code>mount.fdescfs</code> and <code>mount.procfs</code> options.</p>
<h3 class="h3" id="lev1053"><strong>Jailing Ancient FreeBSD</strong></h3>
<p class="noindent">In my experience, the phrase <em>enterprise network</em> is synonymous with “we have lots of ancient stuff that nobody dares touch.” Jails can help you cope with some of these systems. In 2014, I worked at a company that ran a critical custom-built PHP and MySQL application on FreeBSD 4.10. I don’t know when this server was installed, but FreeBSD 4.11 came out in January 2005, so: before then. This application used ancient versions of Perl, PHP, OpenSSL, and more.</p>
<p class="indent">Worse, this application lived on a repurposed desktop machine. With a standard-issue, high-quality desktop hard drive. I hid a spare desktop machine of the same vintage under my desk, just so I had a hope of getting FreeBSD 4.10 onto it. The most proper solution was to rewrite or replace this application. Several sysadmins had faced that task—and failed. I decided to virtualize it. FreeBSD 4.10 doesn’t run well on VMWare—yes, you can find de(4) and fxp(4) drivers, but they’re for versions of those cards over a decade old. Here’s how I got this ancient FreeBSD system into a jail.</p>
<p class="indent">Drop to single-user mode. Unmount <em>/proc</em>—yes, FreeBSD 4 still used <em>/proc</em>. Those were the days. Tar up the entire filesystem, including temporary directories, like <em>/usr/obj</em>, <em>/usr/ports</em>, <em>/var/tmp</em>, and suchforth. By modern standards, they won’t use much space at all, and you have no way to know what files you might need later. You can probably find an old PHP 5.0.whatever tarball out on the internet, but that would involve work.</p>
<p class="indent">Copy the tar file to your jail host and extract it in your jail directory.</p>
<pre># <span class="codestrong1">tar -C /jail/oldserver -xvpf oldserver.tgz</span></pre>
<p class="indent">Be sure to use the <code>-p</code> flag to preserve permissions.</p>
<p class="indent">Now look at <em>/etc/rc.conf</em>. The jail host will handle all networking functions, so turn off any statements that set IP addresses or set routes. Get rid of daemons that provide services the jail host offers, such as time, packet filters, and SSH. Your jailed host needs only the functions that directly support the application. In this case, I needed Apache and MySQL.</p>
<p class="indent">Consider the jail’s <em>/etc/fstab</em>. Do you need a NFS filesystem or some other special mount? Remove everything you don’t need. If this application needs <em>/proc</em>, provide it with the jail option <code>mount.procfs</code>.</p>
<p class="indent"><span epub:type="pagebreak" id="page_581"/>Remove the old <em>/dev</em>. You can’t use FreeBSD 4 device nodes on a modern FreeBSD.</p>
<p class="indent">Configure the host to protect the jail. While people can write perfectly fine applications in Apache and PHP, not even the most ardent Apache and MySQL fan would encourage you to expose 15-year-old versions of these servers to the internet. Use the host’s packet filter to protect the jail. Don’t even consider using the migrated host’s OpenSSH server.</p>
<p class="indent">You won’t be able to use some FreeBSD 4 commands inside the jail, as the interfaces have diverged too far. A FreeBSD 4 ps(1) can’t successfully query a modern FreeBSD kernel. You can copy statically linked versions of most of those programs from the host’s <em>/rescue</em> and copy them into the jail, however.</p>
<p class="indent">Is it this simple? No, not really. The older the source system is, the more problems you’ll have. Most of the problems I had in this particular migration meant changing a configuration file to account for the new underlying filesystem. You’ll need to perform your usual sysadmin debugging. But it’s one way to get a modern network interface on a system lacking a device driver for it, and it’s the only way to get ZFS on a FreeBSD 4 system.</p>
<h3 class="h3" id="lev1054"><strong>Last Jail Notes</strong></h3>
<p class="noindent">People have evolved many ways of using jails. Fully covering all of these features would pretty much require a book of its own, but here are some pointers.</p>
<p class="indent">You can use ZFS features to delegate a dataset entirely to the jail administrator so that jail owners can take their own snapshots and create their own child datasets. With the VIMAGE kernel option, you can give a jail its own routing table. If you’re brave, nullfs(5) lets you recycle an operating system install and minimize disk utilization. You can establish per-jail resource limits with the RCTL kernel option.</p>
<p class="indent">If you have many jails, you might prefer using a jail management program, such as iocage or ezjail. Both are available in the Ports Collection.</p>
<p class="indent">Successfully using jails requires automating your maintenance. Each jail requires separate security patches, both for the userland and for installed packages. The more you can automate this process, the more likely it is that you’ll actually perform such maintenance. I recommend using Ansible’s jail modules or at least writing your own shell script to apply patches.</p>
<p class="indent">The jail(8) command will let you modify, create, and destroy jails without a command line. If you’re doing extensive jail work, definitely read the man page.</p>
<p class="indent">Now let’s look at some of FreeBSD’s less well-known corners.<span epub:type="pagebreak" id="page_582"/></p>
</body></html>