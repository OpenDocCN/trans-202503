<html><head></head><body>
<div id="sbo-rt-content" class="calibre1"><section aria-labelledby="ch7" epub:type="chapter" role="doc-chapter">
<hgroup>
<h2 class="title" id="ch7">
<span class="tpt"><span aria-label=" Page 113. " epub:type="pagebreak" id="pg_113" role="doc-pagebreak" class="calibre2"/><span class="sans_dogma_ot_bold_b_">7</span></span>
<span class="ct"><span class="sans_dogma_ot_bold_b_">PARAMETERIZED REPORTING</span></span>
</h2>
</hgroup>
<figure class="opener"><img alt="" class="opener1" height="407" src="../images/chapter.jpg" width="407"/>
</figure>
<p class="cos"><i class="calibre15">Parameterized reporting</i> is a technique that allows you to generate multiple reports simultaneously. By using parameterized reporting, you can follow the same process to make 3,000 reports as you would to make one report. The technique also makes your work more accurate, as it avoids copy-and-paste errors.</p>
<p class="tx">Staff at the Urban Institute, a think tank based in Washington, DC, used parameterized reporting to develop fiscal briefs for all US states, as well as the District of Columbia. Each report required extensive text and multiple charts, so creating them by hand wasn’t feasible. Instead, employees Safia Sayed, Livia Mucciolo, and Aaron Williams automated the process. This chapter explains how parameterized reporting works and walks you through a simplified version of the code that the Urban Institute used.</p>
<section aria-labelledby="sec1" epub:type="division">
<h3 class="h1" id="sec1"><span id="h1-41"/><span aria-label=" Page 114. " epub:type="pagebreak" id="pg_114" role="doc-pagebreak"/><span class="sans_dogma_ot_bold_b_1">Report Templates in R Markdown</span></h3>
<p class="tni">If you’ve ever had to create multiple reports at the same time, you know how frustrating it can be, especially if you’re using the multi-tool workflow described in <span class="xref"><a href="chapter6.xhtml" class="calibre3">Chapter 6</a></span>. Making just one report can take a long time. Multiply that work by 10, 20, or, in the case of the Urban Institute team, 51, and it can quickly feel overwhelming. Fortunately, with parameterized reporting, you can generate thousands of reports at once using the following workflow:</p>
<div class="top">
<p class="listnumber">  1.  Make a report template in R Markdown.</p>
<p class="listnumber">  2.  Add a parameter (for example, one representing US states) in the YAML of your R Markdown document to represent the values that will change between reports.</p>
<p class="listnumber">  3.  Use that parameter to generate a report for one state, to make sure you can knit your document.</p>
<p class="listnumber">  4.  Create a separate R script file that sets the value of the parameter and then knits a report.</p>
<p class="listnumber">  5.  Run this script for all states.</p>
</div>
<p class="tx">You’ll begin by creating a report template for one state. I’ve taken the code that the Urban Institute staff used to make their state fiscal briefs and simplified it significantly. All of the packages used are ones you’ve seen in previous chapters, with the exception of the <span class="sans_thesansmonocd_w5regular_">urbnthemes</span> package. This package contains a custom ggplot theme. It can be installed by running <span class="sans_thesansmonocd_w5regular_">remotes::install_github("UrbanInstitute/urbnthemes")</span> in the console. Instead of focusing on fiscal data, I’ve used data you may be more familiar with: COVID-19 rates from mid-2022. Here’s the R Markdown document:</p>
<pre id="pre-127" class="calibre10"><code class="calibre11">---
title: "Urban Institute COVID Report"
output: html_document
params:
  state: "Alabama"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)
```

```{r}
library(tidyverse)
library(urbnthemes)
library(scales)
```

# `r params$state`

```{r}
<span aria-label=" Page 115. " epub:type="pagebreak" id="pg_115" role="doc-pagebreak"/>cases &lt;- tibble(state.name) %&gt;%
  rbind(state.name = "District of Columbia") %&gt;%
  left_join(
    read_csv(
      "https://data.rfortherestofus.com/united_states_covid19_cases_deaths_and_testing_by_state.csv",
      skip = 2
    ),
    by = c("state.name" = "State/Territory")
  ) %&gt;%
  select(
    total_cases = `Total Cases`,
    state.name,
    cases_per_100000 = `Case Rate per 100000`
  ) %&gt;%
  mutate(cases_per_100000 = parse_number(cases_per_100000)) %&gt;%
  mutate(case_rank = rank(-cases_per_100000, ties.method = "min"))
```

```{r}
state_text &lt;- if_else(params$state == "District of Columbia", str_glue(
"the District of Columbia"), str_glue("state of {params$state}"))

state_cases_per_100000 &lt;- cases %&gt;%
  filter(state.name == params$state) %&gt;%
  pull(cases_per_100000) %&gt;%
  comma()

state_cases_rank &lt;- cases %&gt;%
  filter(state.name == params$state) %&gt;%
  pull(case_rank)
```

In `r state_text`, there were `r state_cases_per_100000` cases per 100,000
people in the last seven days. This puts `r params$state` at number
`r state_cases_rank` of 50 states and the District of Columbia.

```{r fig.height = 8}
set_urbn_defaults(style = "print")

cases %&gt;%
  mutate(highlight_state = if_else(state.name == params$state, "Y", "N")) %&gt;%
  mutate(state.name = fct_reorder(state.name, cases_per_100000)) %&gt;%
  ggplot(aes(
    x = cases_per_100000,
    y = state.name,
    fill = highlight_state
  )) +
  geom_col() +
  scale_x_continuous(labels = comma_format()) +
  theme(legend.position = "none") +
  labs(
    y = NULL,
    x = "Cases per 100,000"
  )
```
</code></pre>
<p class="tx"><span aria-label=" Page 116. " epub:type="pagebreak" id="pg_116" role="doc-pagebreak"/>The text and charts in the report come from the <span class="sans_thesansmonocd_w5regular_">cases</span> data frame, shown here:</p>
<pre id="pre-128" class="calibre10"><code class="calibre11">#&gt; # A tibble: 51 × 4
#&gt;    total_cases state.name  cases_per_100000 case_rank
#&gt;    &lt;chr&gt;       &lt;chr&gt;                  &lt;dbl&gt;     &lt;int&gt;
#&gt;  1 1302945     Alabama                26573        18
#&gt;  2 246345      Alaska                 33675         2
#&gt;  3 2025435     Arizona                27827        10
#&gt;  4 837154      Arkansas               27740        12
#&gt;  5 9274208     California             23472        35
#&gt;  6 1388702     Colorado               24115        33
#&gt;  7 766172      Connecticut            21490        42
#&gt;  8 264376      Delaware               27150        13
#&gt;  9 5965411     Florida                27775        11
#&gt; 10 2521664     Georgia                23750        34
#&gt; # ... with 41 more rows
</code></pre>
<p class="tx">When you knit the document, you end up with the simple HTML file shown in <a href="chapter7.xhtml#fig7-1" class="calibre3">Figure 7-1</a>.</p>
<figure class="img"><img alt="" class="img2" height="1325" id="fig7-1" src="../images/fig7-1.jpg" width="1282"/>
<figcaption><p class="cap"><span class="sans_futura_std_book_oblique_i_">Figure 7-1: The Alabama report generated via R Markdown</span></p></figcaption>
</figure>
<p class="tx"><span aria-label=" Page 117. " epub:type="pagebreak" id="pg_117" role="doc-pagebreak"/>You should recognize the R Markdown document’s YAML, R code chunks, inline code, and Markdown text from <span class="xref"><a href="chapter6.xhtml" class="calibre3">Chapter 6</a></span>.</p>
<section aria-labelledby="sec2" epub:type="division">
<h4 class="h2" id="sec2"><span id="h2-52"/><span class="sans_futura_std_heavy_oblique_bi_">Defining Parameters</span></h4>
<p class="tni">In R Markdown, <i class="calibre4">parameters</i> are variables that you set in the YAML to allow you to create multiple reports. Take a look at these two lines in the YAML:</p>
<pre id="pre-129" class="calibre10"><code class="calibre11">params:
  state: "Alabama"
</code></pre>
<p class="tx">This code defines a variable called <span class="sans_thesansmonocd_w5regular_">state</span>. You can use the <span class="sans_thesansmonocd_w5regular_">state</span> variable throughout the rest of the R Markdown document with the <span class="sans_thesansmonocd_w5regular_">params$</span><span class="sans_thesansmonocd_w5regular_italic_i_">variable_name</span> syntax, replacing <span class="sans_thesansmonocd_w5regular_italic_i_">variable_name</span> with <span class="sans_thesansmonocd_w5regular_">state</span> or any other name you set in the YAML. For example, consider this inline R code:</p>
<pre id="pre-130" class="calibre10"><code class="calibre11"># `r params$state`
</code></pre>
<p class="tx">Any instance of the <span class="sans_thesansmonocd_w5regular_">params$state</span> parameter will be converted to <span class="sans_thesansmonocd_w5regular_">"Alabama"</span> when you knit it. This parameter and several others appear in the following code, which sets the first-level heading visible in <a href="chapter7.xhtml#fig7-1" class="calibre3">Figure 7-1</a>:</p>
<pre id="pre-131" class="calibre10"><code class="calibre11">In `r state_text`, there were `r state_cases_per_100000` cases per 100,000
people in the last seven days. This puts `r <b class="calibre9">params$state</b>` at number
`r state_cases_rank` of 50 states and the District of Columbia.
</code></pre>
<p class="tx">After knitting the document, you should see the following text:</p>
<blockquote class="calibre13">
<p class="extractpara">In the state of Alabama, there were 26,573 cases per 100,000 people in the last seven days. This puts Alabama at number 18 of 50 states and the District of Columbia.</p>
</blockquote>
<p class="tx">This text is automatically generated. The inline R code <span class="sans_thesansmonocd_w5regular_">`r state_text`</span> prints the value of the variable <span class="sans_thesansmonocd_w5regular_">state_text</span>, which is determined by a previous call to <span class="sans_thesansmonocd_w5regular_">if_else()</span>, shown in this code chunk:</p>
<pre id="pre-132" class="calibre10"><code class="calibre11">state_text &lt;- if_else(params$state == "District of Columbia",
str_glue("the District of Columbia"), str_glue("state of {params$state}"))
</code></pre>
<p class="tx">If the value of <span class="sans_thesansmonocd_w5regular_">params$states</span> is <span class="sans_thesansmonocd_w5regular_">"District of Columbia"</span>, this code sets <span class="sans_thesansmonocd_w5regular_">state_text</span> equal to <span class="sans_thesansmonocd_w5regular_">"the District of Columbia"</span>. If <span class="sans_thesansmonocd_w5regular_">params$state</span> isn’t <span class="sans_thesansmonocd_w5regular_">"District of Columbia"</span>, then <span class="sans_thesansmonocd_w5regular_">state_text</span> gets the value <span class="sans_thesansmonocd_w5regular_">"state of"</span>, followed by the state name. This allows you to put <span class="sans_thesansmonocd_w5regular_">state_text</span> in a sentence and have it work no matter whether the state parameter is a state or the District of Columbia.</p>
</section>
<section aria-labelledby="sec3" epub:type="division">
<h4 class="h2" id="sec3"><span id="h2-53"/><span class="sans_futura_std_heavy_oblique_bi_">Generating Numbers with Parameters</span></h4>
<p class="tni">You can also use parameters to generate numeric values to include in the text. For example, to calculate the values of the <span class="sans_thesansmonocd_w5regular_">state_cases_per_100000</span> <span aria-label=" Page 118. " epub:type="pagebreak" id="pg_118" role="doc-pagebreak"/>and <span class="sans_thesansmonocd_w5regular_">state_cases_rank</span> variables dynamically, use the state parameter, as shown here:</p>
<pre id="pre-133" class="calibre10"><code class="calibre11">state_cases_per_100000 &lt;- cases %&gt;%
  filter(state.name == params$state) %&gt;%
  pull(cases_per_100000) %&gt;%
  comma()

state_cases_rank &lt;- cases %&gt;%
  filter(state.name == params$state) %&gt;%
  pull(case_rank)
</code></pre>
<p class="tx">First, this code filters the <span class="sans_thesansmonocd_w5regular_">cases</span> data frame (which contains data for all states) to keep only the data for the state in <span class="sans_thesansmonocd_w5regular_">params$state</span>. Then, the <span class="sans_thesansmonocd_w5regular_">pull()</span> function gets a single value from that data, and the <span class="sans_thesansmonocd_w5regular_">comma()</span> function from the <span class="sans_thesansmonocd_w5regular_">scales</span> package applies formatting to make <span class="sans_thesansmonocd_w5regular_">state_cases_per_100000</span> display as 26,573 (rather than 26573). Finally, the <span class="sans_thesansmonocd_w5regular_">state_cases_per_100000</span> and <span class="sans_thesansmonocd_w5regular_">state_case_rank</span> variables are integrated into the inline R code.</p>
</section>
<section aria-labelledby="sec4" epub:type="division">
<h4 class="h2" id="sec4"><span id="h2-54"/><span class="sans_futura_std_heavy_oblique_bi_">Including Parameters in Visualization Code</span></h4>
<p class="tni">The <span class="sans_thesansmonocd_w5regular_">params$state</span> parameter is used in other places as well, such as to highlight a state in the report’s bar chart. To see how to accomplish this, look at the following section from the last code chunk:</p>
<pre id="pre-134" class="calibre10"><code class="calibre11">cases %&gt;%
  mutate(highlight_state = if_else(state.name == params$state, "Y", "N"))
</code></pre>
<p class="tx">This code creates a variable called <span class="sans_thesansmonocd_w5regular_">highlight_state</span>. Within the <span class="sans_thesansmonocd_w5regular_">cases</span> data frame, the code checks whether <span class="sans_thesansmonocd_w5regular_">state.name</span> is equal to <span class="sans_thesansmonocd_w5regular_">params$state</span>. If it is, <span class="sans_thesansmonocd_w5regular_">highlight_state</span> gets the value <span class="sans_thesansmonocd_w5regular_">Y</span>. If not, it gets <span class="sans_thesansmonocd_w5regular_">N</span>. Here’s what the relevant columns look like after you run these two lines:</p>
<pre id="pre-135" class="calibre10"><code class="calibre11">#&gt; # A tibble: 51 × 2
#&gt;    state.name  highlight_state
#&gt;    &lt;chr&gt;       &lt;chr&gt;
#&gt;  1 Alabama     Y
#&gt;  2 Alaska      N
#&gt;  3 Arizona     N
#&gt;  4 Arkansas    N
#&gt;  5 California  N
#&gt;  6 Colorado    N
#&gt;  7 Connecticut N
#&gt;  8 Delaware    N
#&gt;  9 Florida     N
#&gt; 10 Georgia     N
#&gt; #  ... with 41 more rows
</code></pre>
<p class="tx">Later, the ggplot code uses the <span class="sans_thesansmonocd_w5regular_">highlight_state</span> variable for the bar chart’s <span class="sans_thesansmonocd_w5regular_">fill</span> aesthetic property, highlighting the state in <span class="sans_thesansmonocd_w5regular_">params$state</span> in yellow and coloring the other states blue. <a href="chapter7.xhtml#fig7-2" class="calibre3">Figure 7-2</a> shows the chart with Alabama highlighted.<span aria-label=" Page 119. " epub:type="pagebreak" id="pg_119" role="doc-pagebreak"/></p>
<figure class="img"><img alt="" class="img1" height="1561" id="fig7-2" src="../images/fig7-2.jpg" width="1346"/>
<figcaption><p class="cap"><span class="sans_futura_std_book_oblique_i_">Figure 7-2: Highlighting data in a bar chart using parameters</span></p></figcaption>
</figure>
<p class="tx">As you’ve seen, setting a parameter in the YAML allows you to dynamically generate text and charts in the knitted report. But you’ve generated only one report so far. How can you create all 51 reports? Your first thought might be to manually update the YAML by changing the parameter’s value from <span class="sans_thesansmonocd_w5regular_">"Alabama"</span> to, say, <span class="sans_thesansmonocd_w5regular_">"Alaska"</span> and then knitting the document again. While you <i class="calibre4">could</i> follow this process for all states, it would be tedious, which is what you’re trying to avoid. Instead, you can automate the report generation.</p>
</section>
</section>
<section aria-labelledby="sec5" epub:type="division">
<h3 class="h1" id="sec5"><span id="h1-42"/><span class="sans_dogma_ot_bold_b_1">Creating an R Script</span></h3>
<p class="tni">To automatically generate multiple reports based on the template you’ve created, you’ll use an R script that changes the value of the parameters in <span aria-label=" Page 120. " epub:type="pagebreak" id="pg_120" role="doc-pagebreak"/>the R Markdown document and then knits it. You’ll begin by creating an R script file named <i class="calibre4">render.R</i>.</p>
<section aria-labelledby="sec6" epub:type="division">
<h4 class="h2" id="sec6"><span id="h2-55"/><span class="sans_futura_std_heavy_oblique_bi_">Knitting the Document with Code</span></h4>
<p class="tni">Your script needs to be able to knit an R Markdown document. While you’ve seen how to do this using the Knit button, you can do the same thing with code. Load the <span class="sans_thesansmonocd_w5regular_">rmarkdown</span> package and then use its <span class="sans_thesansmonocd_w5regular_">render()</span> function as shown here:</p>
<pre id="pre-136" class="calibre10"><code class="calibre11"><b class="calibre9">library(rmarkdown)</b>

<b class="calibre9">render(</b>
<b class="calibre9">  input = "urban-covid-budget-report.Rmd",</b>
<b class="calibre9">  output_file = "Alaska.xhtml",</b>
<b class="calibre9">  params = list(state = "Alaska")</b>
<b class="calibre9">)</b>
</code></pre>
<p class="tx">This function generates an HTML document called <i class="calibre4">urban-covid-budget-report.xhtml</i>. By default, the generated file has the same name as the R Markdown (<i class="calibre4">.Rmd</i>) document, with a different extension. The <span class="sans_thesansmonocd_w5regular_">output_file</span> argument assigns the file a new name, and the <span class="sans_thesansmonocd_w5regular_">params</span> argument specifies parameters that will override those in the R Markdown document itself. For example, this code tells R to use Alaska for the <span class="sans_thesansmonocd_w5regular_">state</span> parameter and save the resulting HTML file as <i class="calibre4">Alaska.xhtml</i>.</p>
<p class="tx">This approach to generating reports works, but to create all 51 reports, you’d have to manually change the state name in the YAML and update the <span class="sans_thesansmonocd_w5regular_">render()</span> function before running it for each report. In the next section, you’ll update your code to make it more efficient.</p>
</section>
<section aria-labelledby="sec7" epub:type="division">
<h4 class="h2" id="sec7"><span id="h2-56"/><span class="sans_futura_std_heavy_oblique_bi_">Creating a Tibble with Parameter Data</span></h4>
<p class="tni">To write code that generates all your reports automatically, first you must create a <i class="calibre4">vector</i> (in colloquial terms, a list of items) of all the state names and the District of Columbia. To do this, you’ll use the built-in dataset <span class="sans_thesansmonocd_w5regular_">state.name</span>, which has all 50 state names in a vector:</p>
<pre id="pre-137" class="calibre10"><code class="calibre11"><b class="calibre9">state &lt;- tibble(state.name) %&gt;%</b>
<b class="calibre9">  rbind("District of Columbia") %&gt;%</b>
<b class="calibre9">  pull(state.name)</b>
</code></pre>
<p class="tx">This code turns <span class="sans_thesansmonocd_w5regular_">state.name</span> into a tibble and then uses the <span class="sans_thesansmonocd_w5regular_">rbind()</span> function to add the District of Columbia to the list. The <span class="sans_thesansmonocd_w5regular_">pull()</span> function gets one single column and saves it as <span class="sans_thesansmonocd_w5regular_">state</span>. Here’s what the <span class="sans_thesansmonocd_w5regular_">state</span> vector looks like:</p>
<pre id="pre-138" class="calibre10"><code class="calibre11">#&gt;  [1] "Alabama"              "Alaska"
#&gt;  [3] "Arizona"              "Arkansas"
#&gt;  [5] "California"           "Colorado"
#&gt;  [7] "Connecticut"          "Delaware"
#&gt;  [9] "Florida"              "Georgia"
<span aria-label=" Page 121. " epub:type="pagebreak" id="pg_121" role="doc-pagebreak"/>#&gt; [11] "Hawaii"               "Idaho"
#&gt; [13] "Illinois"             "Indiana"
#&gt; [15] "Iowa"                 "Kansas"
#&gt; [17] "Kentucky"             "Louisiana"
#&gt; [19] "Maine"                "Maryland"
#&gt; [21] "Massachusetts"        "Michigan"
#&gt; [23] "Minnesota"            "Mississippi"
#&gt; [25] "Missouri"             "Montana"
#&gt; [27] "Nebraska"             "Nevada"
#&gt; [29] "New Hampshire"        "New Jersey"
#&gt; [31] "New Mexico"           "New York"
#&gt; [33] "North Carolina"       "North Dakota"
#&gt; [35] "Ohio"                 "Oklahoma"
#&gt; [37] "Oregon"               "Pennsylvania"
#&gt; [39] "Rhode Island"         "South Carolina"
#&gt; [41] "South Dakota"         "Tennessee"
#&gt; [43] "Texas"                "Utah"
#&gt; [45] "Vermont"              "Virginia"
#&gt; [47] "Washington"           "West Virginia"
#&gt; [49] "Wisconsin"            "Wyoming"
#&gt; [51] "District of Columbia"
</code></pre>
<p class="tx">Rather than use <span class="sans_thesansmonocd_w5regular_">render()</span> with the <span class="sans_thesansmonocd_w5regular_">input</span> and <span class="sans_thesansmonocd_w5regular_">output_file</span> arguments, as you did earlier, you can pass it the <span class="sans_thesansmonocd_w5regular_">params</span> argument to give it parameters to use when knitting. To do so, create a tibble with the information needed to render all 51 reports and save it as an object called <span class="sans_thesansmonocd_w5regular_">reports</span>, which you’ll pass to the <span class="sans_thesansmonocd_w5regular_">render()</span> function, as follows:</p>
<pre id="pre-139" class="calibre10"><code class="calibre11"><b class="calibre9">reports &lt;- tibble(</b>
<b class="calibre9">  input = "urban-covid-budget-report.Rmd",</b>
<b class="calibre9">  output_file = str_glue("{state}.xhtml"),</b>
<b class="calibre9">  params = map(state, ~ list(state = .))</b>
<b class="calibre9">)</b>
</code></pre>
<p class="tx">This code generates a tibble with 51 rows and 3 variables. In all rows, the <span class="sans_thesansmonocd_w5regular_">input</span> variable is set to the name of the R Markdown document. The value of <span class="sans_thesansmonocd_w5regular_">output_file</span> is set with <span class="sans_thesansmonocd_w5regular_">str_glue()</span> to be equal to the name of the state, followed by.<i class="calibre4">html</i> (for example, <i class="calibre4">Alabama.xhtml</i>).</p>
<p class="tx">The <span class="sans_thesansmonocd_w5regular_">params</span> variable is the most complicated of the three. It is what’s known as a <i class="calibre4">named list</i>. This data structure puts the data in the <span class="sans_thesansmonocd_w5regular_">state:</span> <span class="sans_thesansmonocd_w5regular_italic_i_">state_name</span> format needed for the R Markdown document’s YAML. The <span class="sans_thesansmonocd_w5regular_">map()</span> function from the <span class="sans_thesansmonocd_w5regular_">purrr</span> package creates the named list, telling R to set the value of each row as <span class="sans_thesansmonocd_w5regular_">state = "Alabama"</span>, then <span class="sans_thesansmonocd_w5regular_">state = "Alaska"</span>, and so on, for all of the states. You can see these variables in the <span class="sans_thesansmonocd_w5regular_">reports</span> tibble:</p>
<pre id="pre-140" class="calibre10"><code class="calibre11">#&gt; # A tibble: 51 × 3
#&gt;    input                         output_file    params
#&gt;    &lt;chr&gt;                         &lt;glue&gt;         &lt;list&gt;
#&gt;  1 urban-covid-budget-report.Rmd Alabama.xhtml   &lt;named list&gt;
#&gt;  2 urban-covid-budget-report.Rmd Alaska.xhtml    &lt;named list&gt;
#&gt;  3 urban-covid-budget-report.Rmd Arizona.xhtml   &lt;named list&gt;
#&gt;  4 urban-covid-budget-report.Rmd Arkansas.xhtml  &lt;named list&gt;
<span aria-label=" Page 122. " epub:type="pagebreak" id="pg_122" role="doc-pagebreak"/>#&gt;  5 urban-covid-budget-report.Rmd California...  &lt;named list&gt;
#&gt;  6 urban-covid-budget-report.Rmd Colorado.xhtml  &lt;named list&gt;
#&gt;  7 urban-covid-budget-report.Rmd Connecticut... &lt;named list&gt;
#&gt;  8 urban-covid-budget-report.Rmd Delaware.xhtml  &lt;named list&gt;
#&gt;  9 urban-covid-budget-report.Rmd Florida.xhtml   &lt;named list&gt;
#&gt; 10 urban-covid-budget-report.Rmd Georgia.xhtml   &lt;named list&gt;
#&gt; # ... with 41 more rows
</code></pre>
<p class="tx">The <span class="sans_thesansmonocd_w5regular_">params</span> variable shows up as <span class="sans_thesansmonocd_w5regular_">&lt;named list&gt;</span>, but if you open the tibble in the RStudio viewer (click <b class="calibre9">reports</b> in the Environment tab), you can see the output more clearly, as shown in <a href="chapter7.xhtml#fig7-3" class="calibre3">Figure 7-3</a>.</p>
<figure class="img"><img alt="" class="img1" height="936" id="fig7-3" src="../images/fig7-3.jpg" width="1391"/>
<figcaption><p class="cap"><span class="sans_futura_std_book_oblique_i_">Figure 7-3: The named list column in the RStudio viewer</span></p></figcaption>
</figure>
<p class="tx">This view allows you to see the named list in the <span class="sans_thesansmonocd_w5regular_">params</span> variable, with the <span class="sans_thesansmonocd_w5regular_">state</span> variable equal to the name of each state.</p>
<p class="tx">Once you’ve created the <span class="sans_thesansmonocd_w5regular_">reports</span> tibble, you’re ready to render the reports. The code to do so is only one line long:</p>
<pre id="pre-141" class="calibre10"><code class="calibre11"><b class="calibre9">pwalk(reports, render)</b>
</code></pre>
<p class="tx">This <span class="sans_thesansmonocd_w5regular_">pwalk()</span> function (from the <span class="sans_thesansmonocd_w5regular_">purrr</span> package) has two arguments: a data frame or tibble (<span class="sans_thesansmonocd_w5regular_">reports</span>, in this case) and a function that runs for each row of this tibble, <span class="sans_thesansmonocd_w5regular_">render()</span>.</p>
<blockquote class="calibre13">
<p class="note"><span class="sans_dogma_ot_bold_b_2">NOTE</span></p>
</blockquote>
<p class="note-txt"><i class="calibre4">You don’t include the open and closing parentheses when passing the <span class="sans_thesansmonocd_w5regular_italic_i_">render()</span> function to <span class="sans_thesansmonocd_w5regular_italic_i_">pwalk()</span>.</i></p>
<p class="tx"><span aria-label=" Page 123. " epub:type="pagebreak" id="pg_123" role="doc-pagebreak"/>Running this code runs the <span class="sans_thesansmonocd_w5regular_">render()</span> function for each row in <span class="sans_thesansmonocd_w5regular_">reports</span>, passing in the values for <span class="sans_thesansmonocd_w5regular_">input</span>, <span class="sans_thesansmonocd_w5regular_">output_file</span>, and <span class="sans_thesansmonocd_w5regular_">params</span>. This is equivalent to entering code like the following to run the <span class="sans_thesansmonocd_w5regular_">render()</span> function 51 times (for 50 states plus the District of Columbia):</p>
<pre id="pre-142" class="calibre10"><code class="calibre11">render(
  input = "urban-covid-budget-report.Rmd",
  output_file = "Alabama.xhtml",
  params = list(state = "Alabama")
)

render(
  input = "urban-covid-budget-report.Rmd",
  output_file = "Alaska.xhtml",
  params = list(state = "Alaska")
)

render(
  input = "urban-covid-budget-report.Rmd",
  output_file = "Arizona.xhtml",
  params = list(state = "Arizona")
)
</code></pre>
<p class="tx">Here’s the full R script file:</p>
<pre id="pre-143" class="calibre10"><code class="calibre11"># Load packages
library(tidyverse)
library(rmarkdown)

# Create a vector of all states and the District of Columbia
state &lt;- tibble(state.name) %&gt;%
  rbind("District of Columbia") %&gt;%
  pull(state.name)

# Create a tibble with information on the:
# input R Markdown document
# output HTML file
# parameters needed to knit the document
reports &lt;- tibble(
  input = "urban-covid-budget-report.Rmd",
  output_file = str_glue("{state}.xhtml"),
  params = map(state, ~ list(state = .))
)

# Generate all of our reports
pwalk(reports, render)
</code></pre>
<p class="tx">After running the <span class="sans_thesansmonocd_w5regular_">pwalk(reports, render)</span> code, you should see 51 HTML documents appear in the files pane in RStudio. Each document consists of a report for that state, complete with a customized graph and accompanying text.</p>
</section>
</section>
<section aria-labelledby="sec8" epub:type="division">
<h3 class="h1" id="sec8"><span id="h1-43"/><span aria-label=" Page 124. " epub:type="pagebreak" id="pg_124" role="doc-pagebreak"/><span class="sans_dogma_ot_bold_b_1">Best Practices</span></h3>
<p class="tni">While powerful, parameterized reporting can present some challenges. For example, make sure to consider outliers in your data. In the case of the state reports, Washington, DC, is an outlier because it isn’t technically a state. The Urban Institute team altered the language in the report text so that it didn’t refer to Washington, DC, as a state by using an <span class="sans_thesansmonocd_w5regular_">if_else()</span> statement, as you saw at the beginning of this chapter.</p>
<p class="tx">Another best practice is to manually generate and review the reports whose parameter values have the shortest (Iowa, Ohio, and Utah in the state fiscal briefs) and longest (District of Columbia) text lengths. This way, you can identify places where the text length may have unexpected results, such as cut-off chart titles or page breaks disrupted by text running onto multiple lines. A few minutes of manual review can make the process of autogenerating multiple reports much smoother.</p>
</section>
<section aria-labelledby="sec9" epub:type="division">
<h3 class="h1" id="sec9"><span id="h1-44"/><span class="sans_dogma_ot_bold_b_1">Summary</span></h3>
<p class="tni">In this chapter, you re-created the Urban Institute’s state fiscal briefs using parameterized reporting. You learned how to add a parameter to your R Markdown document, then use an R script to set the value of that parameter and knit the report.</p>
<p class="tx">Automating report production can be a huge time-saver, especially as the number of reports you need to generate grows. Consider another project at the Urban Institute: making county-level reports. With over 3,000 counties in the United States, creating these reports by hand isn’t realistic. Not only that, but if the Urban Institute employees were to make their reports using SPSS, Excel, and Word, they would have to copy and paste values between programs. Humans are fallible, and mistakes occur, no matter how hard we try to avoid them. Computers, on the other hand, never make copy-and-paste errors. Letting computers handle the tedious work of generating multiple reports reduces the chance of error significantly.</p>
<p class="tx">When you’re starting out, parameterized reporting might feel like a heavy lift, as you have to make sure that your code works for every version of your report. But once you have your R Markdown document and accompanying R script file, you should find it easy to produce multiple reports at once, saving you work in the end.</p>
</section>
<section aria-labelledby="sec10" epub:type="division">
<h3 class="h1" id="sec10"><span id="h1-45"/><span class="sans_dogma_ot_bold_b_1">Additional Resources</span></h3>
<ul class="ul">
<li class="listbullet">Data@Urban Team, “Iterated Fact Sheets with R Markdown,” Medium, July 24, 2018, <i class="calibre4"><a href="https://urban-institute.medium.com/iterated-fact-sheets-with-r-markdown-d685eb4eafce" class="calibre3">https://urban-institute.medium.com/iterated-fact-sheets-with-r-markdown-d685eb4eafce</a></i>.</li>
<li class="listbullet">Data@Urban Team, “Using R Markdown to Track and Publish State Data,” Medium, April 21, 2021, <i class="calibre4"><a href="https://urban-institute.medium.com/using-r-markdown-to-track-and-publish-state-data-d1291bfa1ec0" class="calibre3">https://urban-institute.medium.com/using-r-markdown-to-track-and-publish-state-data-d1291bfa1ec0</a></i>.</li>
</ul>
</section>
</section>
</div></body></html>