<html><head></head><body>
<h2 class="h2"><a id="ch06"/><span epub:type="pagebreak" id="page_103"/><strong><span class="big">6</span></strong><br/><strong>PACKET ANALYSIS ON THE COMMAND LINE</strong></h2>&#13;
<div class="image"><img alt="image" src="../images/common.jpg"/></div>&#13;
<p class="noindenta"><span class="big1">While many scenarios can be addressed using a GUI, in some cases, using command line tools—such as TShark or tcpdump—is necessary or preferable. Here are some situations in which a command line tool might be used instead of Wireshark:</span></p>&#13;
<p class="bullet">•     Wireshark provides a lot of information at once. By using a command line tool, you can limit displayed information to only pertinent data, such as a single line showing IP addresses.</p>&#13;
<p class="bullet">•     Command line tools are best suited for filtering a packet capture file and providing the results directly to another tool using Unix pipes.</p>&#13;
<p class="bullet">•     Dealing with a very large capture file can often overwhelm Wireshark because the entire file must be loaded into RAM. Stream processing of large capture files with command line tools can allow you to quickly filter the file down to the relevant packets.</p>&#13;
<p class="bulleta">•     If you are dealing with a server and don’t have access to a graphical tool, you may be forced to rely on command line tools.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_104"/>In this chapter, I’ll demonstrate the features of two common command line packet analysis tools, TShark and tcpdump. I think it’s helpful to be familiar with both, but I generally find myself using TShark on Windows systems and tcpdump on Unix systems. If you exclusively use Windows, you may want to skip the parts on tcpdump.</p>&#13;
<h3 class="h3"><a id="ch06lev1sec1"/><strong>Installing TShark</strong></h3>&#13;
<p class="noindent">Terminal-based Wireshark, or TShark, is a packet analysis application that provides a lot of the same functionality as Wireshark but exclusively from a command line interface with no GUI. If you’ve installed Wireshark, then you likely have TShark as well unless you explicitly chose not to install it during Wireshark installation. You can verify that TShark is installed by following these steps:</p>&#13;
<ol>&#13;
<li class="nump"><p class="number">Open a command prompt. Click the <strong>Start Menu</strong>, enter <span class="codestrong">cmd</span>, and click <strong>Command Prompt</strong>.</p></li>&#13;
<li class="nump"><p class="number">Browse to the directory where Wireshark is installed. If you installed it to the default location, you can go there by entering <span class="codestrong">cd C:\Program Files\ Wireshark</span> in the command prompt.</p></li>&#13;
<li class="nump"><p class="number">Run TShark and print its version information by entering <span class="codestrong">tshark –v</span>. If TShark isn’t installed, you’ll get an error saying the command is not recognized. If TShark is installed on your system, you’ll get an output with the TShark version information:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark –v</span><br/>TShark (Wireshark) 2.0.0 (v2.0.0-0-g9a73b82 from master-2.0<br/>--<span class="codeitalic">snip--</span></p></li>&#13;
</ol>&#13;
<p class="indent">If you didn’t install TShark and would like to use it now, you can simply rerun the Wireshark installation and make sure TShark is selected. (It is by default.)</p>&#13;
<p class="indent">If you’d like to immediately start learning more about TShark’s capabilities, you can print the available commands with the <span class="literal">–h</span> argument. We’ll cover some of these commands in this chapter.</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark -h</span></p>&#13;
<p class="indent">Like Wireshark, TShark can run on multiple operating systems, but since it’s not dependent on OS-specific graphics libraries, the user experience is more consistent across different OS platforms. Because of this, TShark operates very similarly on Windows, Linux, and OS X. However, there are still some differences in how TShark runs on each platform. In this book, we’ll focus on running TShark on Windows because that is the primary operating system it was designed to work with.</p>&#13;
<h3 class="h3"><a id="ch06lev1sec2"/><span epub:type="pagebreak" id="page_105"/><strong>Installing tcpdump</strong></h3>&#13;
<p class="noindent">While Wireshark is the most popular graphical packet analysis application in the world, tcpdump is by far the most popular command line packet analysis application. Designed to work on Unix-based operating systems, tcpdump is very easy to install via popular package management applications and even comes preinstalled on many flavors of Linux.</p>&#13;
<p class="indent">Even though the majority of this book is Windows focused, sections on tcpdump are included for Unix users. Specifically, we’ll be using Ubuntu 14.04 LTS. If you would like to use tcpdump on a Windows device, then you can download and install its Windows counterpart, WinDump, from <em><a href="http://www.winpcap.org/windump/">http://www.winpcap.org/windump/</a></em>. While the experience of tcpdump and that of WinDump aren’t entirely the same, these packet analyzers function similarly. Note, however, that WinDump isn’t nearly as actively maintained as tcpdump. As a result, a few newer features might be missing, and security vulnerabilities may exist. (We won’t be covering WinDump in this book.)</p>&#13;
<p class="indent">Ubuntu doesn’t come with tcpdump preinstalled, but installing it is very easy thanks to the APT package management system. To install tcpdump, follow these steps:</p>&#13;
<ol>&#13;
<li class="nump"><p class="number">Open a terminal window and run the command <span class="codestrong">sudo apt-get update</span> to ensure that your package repositories are up-to-date with the latest package versions.</p></li>&#13;
<li class="nump"><p class="number">Run the command <span class="codestrong">sudo apt-get install tcpdump</span>.</p></li>&#13;
<li class="nump"><p class="number">You’ll be asked to install a number of prerequisites that are needed to run tcpdump. Allow these installations by typing <span class="codestrong">Y</span> and pressing <small><span class="literal">ENTER</span></small> when prompted.</p></li>&#13;
<li class="nump"><p class="number">Once the installation has completed, run the command <span class="codestrong">tcpdump –h</span> to execute tcpdump and print its version information. You’re ready to start using tcpdump if the command is successful and you see text like this in the terminal window:</p>&#13;
<p class="programs">sanders@ppa:~$ <span class="codestrong">tcpdump -h</span><br/>tcpdump version 4.5.1<br/>libpcap version 1.5.3<br/>Usage: tcpdump [-aAbdDefhHIJKlLnNOpqRStuUvxX#] [ -B size ] [ -c count ]<br/>            [ -C file_size ] [ -E algo:secret ] [ -F file ] [ -G seconds ]<br/>            [ -i interface ] [ -j tstamptype ] [ -M secret ]<br/>            [ -Q metadata-filter-expression ]<br/>            [ -r file ] [ -s snaplen ] [ -T type ] [ --version ] [ -V file ]<br/>            [ -w file ] [ -W filecount ] [ -y datalinktype ] [ -z command ]<br/>            [ -Z user ] [ expression ]</p>&#13;
</li>&#13;
</ol>&#13;
<p class="indent">You can print all of tcpdump’s available commands by invoking the <span class="literal">man tcpdump</span> command, like this:</p>&#13;
<p class="programs">sanders@ppa:~$ <span class="codestrong">man tcpdump</span></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_106"/>We’ll talk about how to use several of these commands.</p>&#13;
<h3 class="h3"><a id="ch06lev1sec3"/><strong>Capturing and Saving Packets</strong></h3>&#13;
<p class="noindent">The first order of business is to capture packets from the wire and display them on the screen. To start a capture in TShark, simply execute the command <span class="codestrong">tshark</span>. This command will start the process of capturing packets from a network interface and dumping them on screen in your terminal window, which will look something like this:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark</span><br/>  1   0.000000 172.16.16.128 -&gt; 74.125.95.104 TCP 66 1606      80 [SYN]<br/>Seq=0 Win=8192 Len=0 MSS=1460 WS=4 SACK_PERM=1<br/>  2   0.030107 74.125.95.104 -&gt; 172.16.16.128 TCP 66 80      1606 [SYN, ACK]<br/>Seq=0 Ack=1 Win=5720 Len=0 MSS=1406 SACK_PERM=1 WS=64<br/>  3   0.030182 172.16.16.128 -&gt; 74.125.95.104 TCP 54 1606      80 [ACK]<br/>Seq=1 Ack=1 Win=16872 Len=0<br/>  4   0.030248 172.16.16.128 -&gt; 74.125.95.104 HTTP 681 GET / HTTP/1.1<br/>  5   0.079026 74.125.95.104 -&gt; 172.16.16.128 TCP 60 80      1606 [ACK]<br/>Seq=1 Ack=628 Win=6976 Len=0</p>&#13;
<p class="indent">To start a capture in tcpdump, execute the command <span class="codestrong">tcpdump</span>. After you run this command, your terminal window should look something like this:</p>&#13;
<p class="programs">sanders@ppa:~$ <span class="codestrong">tcpdump</span><br/>tcpdump: verbose output suppressed, use -v or -vv for full protocol decode<br/>listening on eth0, link-type EN10MB (Ethernet), capture size 65535 bytes<br/>21:18:39.618072 IP 172.16.16.128.slm-api &gt; 74.125.95.104.http: Flags [S],<br/>seq 2082691767, win 8192, options [mss 1460,nop,wscale 2,nop,nop,sackOK],<br/>length 0<br/>21:18:39.648179 IP 74.125.95.104.http &gt; 172.16.16.128.slm-api:<br/>Flags [S.], seq 2775577373, ack 2082691768, win 5720, options [mss<br/>1406,nop,nop,sackOK,nop,wscale 6], length 0<br/>21:18:39.648254 IP 172.16.16.128.slm-api &gt; 74.125.95.104.http: Flags [.],<br/>ack 1, win 4218, length 0<br/>21:18:39.648320 IP 172.16.16.128.slm-api &gt; 74.125.95.104.http: Flags [P.],<br/>seq 1:628, ack 1, win 4218, length 627: HTTP: GET / HTTP/1.1<br/>21:18:39.697098 IP 74.125.95.104.http &gt; 172.16.16.128.slm-api: Flags [.],<br/>ack 628, win 109, length 0</p>&#13;
<div class="note">&#13;
<p class="notet"><span class="box"><span class="box"><strong>NOTE</strong></span></span></p>&#13;
<p class="notep"><em>Since administrative privileges are required to capture packets on Unix systems, you’ll likely either have to execute <span class="literal">tcpdump</span> as the root user or use the <span class="literal">sudo</span> command in front of the commands listed in this book. In many cases, you’ll probably be accessing your Unix-based system as a user with limited privileges. If you encounter a permissions error while following along, this is probably the reason why.</em></p>&#13;
</div>&#13;
<p class="indent">Depending on how your system is configured, TShark or tcpdump may not default to the network interface you want to capture traffic from. If that <span epub:type="pagebreak" id="page_107"/>happens, you will need to specify it. You can list the interfaces available to TShark by using the <span class="literal">–D</span> argument, which outputs the interfaces as a numbered list, as shown here:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark -D</span><br/>1. \Device\NPF_{1DE095C2-346D-47E6-B855-11917B74603A} (Local Area Connection*<br/>2)<br/>2. \Device\NPF_{1A494418-97D3-42E8-8C0B-78D79A1F7545} (Ethernet 2)</p>&#13;
<p class="indent">To use a specific interface, use the <span class="literal">–i</span> argument with the interface’s assigned number from the interface list, like this:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark –i 1</span></p>&#13;
<p class="indent">This command will capture packets exclusively from the interface named Local Area Connection 2, which is assigned the number 1 in the interface list. I recommend always specifying which interface you are capturing from. It’s common for virtual machine tools or VPNs to add interfaces, and you want to be certain that the packets you are capturing are coming from the correct source.</p>&#13;
<p class="indent">On a Linux or OS X system running tcpdump, use the <span class="literal">ifconfig</span> command to list the available interfaces:</p>&#13;
<p class="programs">sanders@ppa:~$ <span class="codestrong">ifconfig</span><br/>eth0      Link encap:Ethernet HWaddr 00:0c:29:1f:a7:55<br/>          inet addr:172.16.16.139 Bcast:172.16.16.255 Mask:255.255.255.0<br/>          inet6 addr: fe80::20c:29ff:fe1f:a755/64 Scope:Link<br/>          UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1<br/>          RX packets:5119 errors:0 dropped:0 overruns:0 frame:0<br/>          TX packets:3088 errors:0 dropped:0 overruns:0 carrier:0<br/>          collisions:0 txqueuelen:1000<br/>          RX bytes:876746 (876.7 KB) TX bytes:538083 (538.0 KB)</p>&#13;
<p class="indent">Specifying the interface is also done by using the <span class="literal">–i</span> argument:</p>&#13;
<p class="programs">sanders@ppa:~$ <span class="codestrong">tcpdump –i eth0</span></p>&#13;
<p class="indent">This command will capture packets exclusively from the eth0 interface.</p>&#13;
<p class="indent">Once you have everything properly configured, you can start capturing packets. If the device you’re capturing traffic from is even remotely busy on the network, then you’ll probably notice that lines representing individual packets are flying by rather quickly—potentially too quickly for you to read. We can remedy this by saving the packets to a file and then reading only a few of them from that file.</p>&#13;
<p class="indent">To save collected packets to a file in both tools, use the <span class="literal">–w</span> argument along with the name of the file. The capture will continue running until you stop it by pressing <small>CTRL</small>-C. The file will be saved to whatever directory the program was executed from, unless otherwise specified.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_108"/>Here’s an example of this command in TShark:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark –i 1 –w packets.pcap</span></p>&#13;
<p class="indent">This command will write all of the packets captured from the first interface in the interface list to <em>packets.pcap</em>.</p>&#13;
<p class="indent">In tcpdump, the same command would look like this:</p>&#13;
<p class="programs">sanders@ppa:~$ <span class="codestrong">tcpdump –i eth0 –w packets.pcap</span></p>&#13;
<p class="indent">To read packets back from a saved file, use the <span class="literal">–r</span> argument along with the name of the file:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark –r packets.pcap</span></p>&#13;
<p class="indent">This command will read all the packets from <em>packets.pcap</em> onto the screen.</p>&#13;
<p class="indent">The tcpdump command is nearly identical:</p>&#13;
<p class="programs">sanders@ppa:~$ <span class="codestrong">tcpdump –r packets.pcap</span></p>&#13;
<p class="indent">You may notice that if the file you are attempting to read from contains a lot of packets, you’ll encounter a situation similar to the one just described, with the packets scrolling across your screen too fast for you to read. You can limit the number of packets displayed when reading from a file by using the <span class="literal">–c</span> argument.</p>&#13;
<p class="indent">For example, the following command will show only the first 10 packets of the capture file in TShark:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark –r packets.pcap –c10</span></p>&#13;
<p class="indent">In tcpdump, the same argument can be used:</p>&#13;
<p class="programs">sanders@ppa:~$ <span class="codestrong">tcpdump –r packets.pcap –c10</span></p>&#13;
<p class="indent">The <span class="literal">–c</span> argument can also be used at capture time. Executing this command will capture only the first 10 packets that are observed. They can also be saved when <span class="literal">–c</span> is combined with the <span class="literal">–w</span> argument.</p>&#13;
<p class="indent">Here’s what this command looks like in TShark:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark –i 1 –w packets.pcap –c10</span></p>&#13;
<p class="indent">And in tcpdump:</p>&#13;
<p class="programs">sanders@ppa:~$ <span class="codestrong">tcpdump –i eth0 –w packets.pcap –c10</span></p>&#13;
<h3 class="h3"><a id="ch06lev1sec4"/><span epub:type="pagebreak" id="page_109"/><strong>Manipulating Output</strong></h3>&#13;
<p class="noindent">A benefit of using command line tools is that the output is usually considered more carefully. A GUI typically shows you everything and it’s up to you to find what you want. Command line tools typically only show the bare minimum and force you to use additional commands to dig deeper. TShark and tcpdump are no different. They both show a single line of output for each packet, requiring you to use additional commands to view information such as protocol details or individual bytes.</p>&#13;
<p class="indent">In the TShark output, each line represents a single packet, and the format of the line depends on the protocols used in that packet. TShark uses the same dissectors as Wireshark and analyzes packet data in the same way, so TShark output will mirror Wireshark’s Packet List pane when the two are run side by side. Because TShark has dissectors for layer 7 protocols, it can provide a lot more information about packets containing headers than can tcpdump.</p>&#13;
<p class="indent">In tcpdump, each line also represents one packet, which is formatted differently based on the protocol being used. Since tcpdump doesn’t use Wireshark’s protocol dissectors, layer 7 protocol information isn’t interpreted by the tool. This is one of tcpdump’s biggest limitations. Instead, single-line packets are formatted based on their transport layer protocol, which is either TCP or UDP (we’ll learn more about these in <a href="ch08.xhtml#ch08">Chapter 8</a>).</p>&#13;
<p class="noindent">TCP packets use this format:</p>&#13;
<p class="programs">[Timestamp] [Layer 3 Protocol] [Source IP].[Source Port] &gt; [Destination IP].<br/>[Destination Port]: [TCP Flags], [TCP Sequence Number], [TCP Acknowledgement<br/>Number], [TCP Windows Size], [Data Length]</p>&#13;
<p class="indent">While UDP packets use this format:</p>&#13;
<p class="programs">[Timestamp] [Layer 3 Protocol] [Source IP].[Source Port] &gt; [Destination IP].<br/>[Destination Port]: [Layer 4 Protocol], [Data Length]</p>&#13;
<p class="indent">These basic one-line summaries are great for quick analysis, but you’ll eventually need to perform a deep dive into a packet. In Wireshark, you would do this by clicking a packet in the Packet List pane, which would display information in the Packet Details and Packet Bytes panes. You can access the same information on the command line using a few options.</p>&#13;
<p class="indent">The simplest way to gain more information about each packet is to increase the verbosity of the output.</p>&#13;
<p class="indent">In TShark, a capital <span class="literal">V</span> is used to increase verbosity:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark –r packets.pcap –V</span></p>&#13;
<p class="indent">This will provide an output similar to Wireshark’s Packet Details pane for packets read from the <em>packets.pcap</em> capture file. Examples of a packet with normal verbosity (a basic summary) and expanded verbosity (more detailed summaries obtained through the <span class="literal">–V</span> argument) are shown here.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_110"/>First the standard output:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark -r packets.pcap -c1</span><br/>  1   0.000000 172.16.16.172 -&gt; 4.2.2.1      ICMP Echo (ping) request<br/>id=0x0001, seq=17/4352, ttl=128</p>&#13;
<p class="indent">And now a portion of the more in-depth information produced with expanded verbosity:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark -r packets.pcap -V -c1</span><br/>Frame 1: 74 bytes on wire (592 bits), 74 bytes captured (592 bits) on<br/>interface 0<br/>    Interface id: 0 (\Device\NPF_{C30671C1-579D-4F33-9CC0-73EFFFE85A54})<br/>    Encapsulation type: Ethernet (1)<br/>    Arrival Time: Dec 21, 2015 12:52:43.116551000 Eastern Standard Time<br/>    [Time shift for this packet: 0.000000000 seconds]<br/>--<span class="codeitalica">snip</span>--</p>&#13;
<p class="indent">In tcpdump, the lowercase <span class="literal">v</span> is used to increase verbosity. Unlike TShark, tcpdump allows multiple levels of verbosity to be displayed for each packet. You can add up to three levels of verbosity by appending additional <span class="literal">v</span>s, as seen here:</p>&#13;
<p class="programs">sanders@ppa:~$ <span class="codestrong">tcpdump –r packets.pcap –vvv</span></p>&#13;
<p class="indent">An example of the same packet displayed with normal verbosity and one level of expanded verbosity is shown below. Even with full verbosity, this output isn’t nearly as verbose as what TShark produces.</p>&#13;
<p class="programs">sanders@ppa:~$ <span class="codestrong">tcpdump -r packets.pcap -c1</span><br/>reading from file packets.pcap, link-type EN10MB (Ethernet)<br/>13:26:25.265937 IP 172.16.16.139 &gt; a.resolvers.level3.net: ICMP echo request,<br/>id 1759, seq 150, length 64<br/>sanders@ppa:~$ <span class="codestrong">tcpdump -r packets.pcap -c1 -v</span><br/>reading from file packets.pcap, link-type EN10MB (Ethernet)<br/>13:26:25.265937 IP (tos 0x0, ttl 64, id 37322, offset 0, flags [DF], proto<br/>ICMP (1), length 84)<br/>    172.16.16.139 &gt; a.resolvers.level3.net: ICMP echo request, id 1759, seq<br/>150, length 64</p>&#13;
<p class="indent">The levels of verbosity available will depend on the protocol of the packet you’re examining. While expanded verbosity is useful, it still doesn’t show us everything there is to see. TShark and tcpdump store the entire contents of each packet, which can also be viewed in hexadecimal or ASCII form.</p>&#13;
<p class="indent">In TShark, you can view the hex and ASCII representation of packets by using the <span class="literal">–x</span> argument, which can be combined with the <span class="literal">r</span> argument to read and display a packet from file:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark –xr packets.pcap</span></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_111"/>This view, which is similar to Wireshark’s Packet Bytes pane, is shown in <a href="ch06.xhtml#ch06fig1">Figure 6-1</a>.</p>&#13;
<div class="image"><img alt="image" src="../images/f111-01.jpg"/></div>&#13;
<p class="figcap"><a id="ch06fig1"/><em>Figure 6-1: Viewing raw packets in hex and ASCII in TShark</em></p>&#13;
<p class="indent">In tcpdump, you can view the hex and ASCII representation by using the <span class="literal">–X</span> switch. You can also combine <span class="literal">–X</span> with the <span class="literal">r</span> argument to read from a packet file, like this:</p>&#13;
<p class="programs">sanders@ppa:~$ <span class="codestrong">tcpdump –Xr packets.pcap</span></p>&#13;
<p class="indent">The output from this command is shown in <a href="ch06.xhtml#ch06fig2">Figure 6-2</a>.</p>&#13;
<div class="image"><img alt="image" src="../images/f111-02.jpg"/></div>&#13;
<p class="figcap"><a id="ch06fig2"/><em>Figure 6-2: Viewing raw packets in hex and ASCII in tcpdump</em></p>&#13;
<p class="indent">tcpdump also lets you get a bit more granular if you need to. You can view only the hexadecimal output using the <span class="literal">–x</span> (lowercase) argument or only the ASCII output using the <span class="literal">–A</span> argument.</p>&#13;
<p class="indent">It’s easy to become overwhelmed with data when you start experimenting with these data output options. I find it most efficient to use the least amount of information needed when doing analysis from the command line. Start by viewing packets in their default list view and use more verbose output when you narrow your analysis down to a few interesting packets. This approach will keep you from being overwhelmed with data.</p>&#13;
<h3 class="h3"><a id="ch06lev1sec5"/><strong>Name Resolution</strong></h3>&#13;
<p class="noindent">Like Wireshark, TShark and tcpdump will attempt to perform name resolution to convert addresses and port numbers to names. If you followed along with any of the earlier examples, you may have noticed that this occurs by default. As mentioned previously, I typically prefer to disable this functionality to prevent the possibility of my analysis generating more packets on the wire.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_112"/>You can disable name resolution in TShark by using the <span class="literal">–n</span> argument. This argument, like many others, can be combined with other commands to enhance readability:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark –ni 1</span></p>&#13;
<p class="indent">You can enable or disable certain aspects of name resolution with the <span class="literal">–N</span> argument. If you use the <span class="literal">–N</span> argument, all name resolution will be disabled except for any you explicitly enable using the appropriate values. For instance, the following command will enable only transport layer (port name) resolution:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark –i 1 –Nt</span></p>&#13;
<p class="indent">You can combine multiple values. This command will enable transport layer and MAC resolution:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark –i 1 -Ntm</span></p>&#13;
<p class="indent">The following values are available when using this option:</p>&#13;
<p class="indent"><span class="codestrong">m</span>  MAC address resolution</p>&#13;
<p class="indent"><span class="codestrong">n</span>  Network address resolution</p>&#13;
<p class="indent"><span class="codestrong">t</span>  Transport layer (port name) resolution</p>&#13;
<p class="indent"><span class="codestrong">N</span>  Use external resolvers</p>&#13;
<p class="indent"><span class="codestrong">C</span>  Concurrent DNS lookups</p>&#13;
<p class="indent">In tcpdump, using <span class="literal">–n</span> will disable IP name resolution, and using <span class="literal">–nn</span> will disable port name resolution as well.</p>&#13;
<p class="indent">This argument can also be combined with other commands, like this:</p>&#13;
<p class="programs">sanders@ppa:~$ <span class="codestrong">tcpdump –nni eth1</span></p>&#13;
<p class="indent">The following examples show a packet capture first with port resolution enabled and then with it disabled (<span class="literal">-n</span>).</p>&#13;
<p class="programs">sanders@ppa:~$ <span class="codestrong">tcpdump -r tcp_ports.pcap -c1</span><br/>reading from file tcp_ports.pcap, link-type EN10MB (Ethernet)<br/>14:38:34.341715 IP 172.16.16.128.2826 &gt; 212.58.226.142. <span class="ent">➊</span>http: Flags [S], seq<br/>3691127924, win 8192, options [mss 1460,nop,wscale 2,nop,nop,sackOK], length 0<br/>sanders@ppa:~$ <span class="codestrong">tcpdump -nr tcp_ports.pcap -c1</span><br/>reading from file tcp_ports.pcap, link-type EN10MB (Ethernet)<br/>14:38:34.341715 IP 172.16.16.128.2826 &gt; 212.58.226.142. <span class="ent">➋</span>80: Flags [S], seq<br/>3691127924, win 8192, options [mss 1460,nop,wscale 2,nop,nop,sackOK], length 0</p>&#13;
<p class="indent">Both of these commands read just the first packet from the capture file <em>tcp_ports.pcap</em>. With the first command, port name resolution is on and resolves port 80 to http <span class="ent">➊</span>, but with the second command, the port is just displayed by number <span class="ent">➋</span>.</p>&#13;
<h3 class="h3"><a id="ch06lev1sec6"/><span epub:type="pagebreak" id="page_113"/><strong>Applying Filters</strong></h3>&#13;
<p class="noindent">Filtering in TShark and tcpdump is very flexible because both allow the use of BPF capture filters. TShark can also use Wireshark display filters. Just as with Wireshark, capture filters in TShark can be used only at capture time, and display filters can be used at capture time or while displaying already captured packets. We’ll start by looking at TShark filters.</p>&#13;
<p class="indent">Capture filters can be applied using the <span class="literal">–f</span> argument, followed by the BPF syntax you wish to use in quotation marks. This command will only capture and save packets with a destination of port 80 and using the TCP protocol:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark –ni 1 –w packets.pcap –f "tcp port 80"</span></p>&#13;
<p class="indent">Display filters can be applied using the <span class="literal">–Y</span> argument, followed by the Wireshark filter syntax you wish to use in quotation marks. This can be applied at capture time like this:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark –ni 1 –w packets.pcap –Y "tcp.dstport == 80"</span></p>&#13;
<p class="indent">Display filters can be applied on already captured packets using the same argument. This command will display only packets from <em>packets.pcap</em> that match the filter:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark –r packets.pcap –Y "tcp.dstport == 80"</span></p>&#13;
<p class="indent">With tcpdump, you specify filters inline at the end of a command within single quotes. This command will also capture and save only packets destined to TCP port 80:</p>&#13;
<p class="programs">sanders@ppa:~$ <span class="codestrong">tcpdump –nni eth0 –w packets.pcap "tcp dst port 80"</span></p>&#13;
<p class="indent">You can specify a filter when reading packets as well. This command will display only packets from <em>packets.pcap</em> that match the filter:</p>&#13;
<p class="programs">sanders@ppa:~$ <span class="codestrong">tcpdump –r packets.pcap 'tcp dst port 80'</span></p>&#13;
<p class="indent">It’s important to keep in mind that if the original capture file was created without a filter, then it still contains other packets; you are just limiting what is shown on the screen when reading from an existing file.</p>&#13;
<p class="indent">What if you have a capture file that contains a large variety of packets, but you want to filter out a subset of them and save that subset to a separate file? You can do this by combining the <span class="literal">–w</span> and <span class="literal">–r</span> arguments:</p>&#13;
<p class="programs">sanders@ppa:~$ <span class="codestrong">tcpdump –r packets.pcap 'tcp dst port 80' –w http_packets.pcap</span></p>&#13;
<p class="indent">This command will read the file <em>packets.pcap</em>, filter out only the traffic destined for TCP port 80 (which is used for http), and write those packets to a new file called <em>http_packets.pcap</em>. This is a very common technique to <span epub:type="pagebreak" id="page_114"/>use when you want to maintain a larger source .<em>pcap</em> file but only analyze a small portion of it at a time. I frequently use this technique to whittle down very large capture files with tcpdump so that I can analyze a subset of the packets in Wireshark. Smaller capture files are much easier to wrangle.</p>&#13;
<p class="indent">In addition to specifying a filter inline, tcpdump allows you to reference a BPF file containing a series of filters. This is handy when you’d like to apply an extremely large or complex filter that might otherwise be unwieldy to edit and maintain inline with the tcpdump command. You can specify a filter file using the <span class="literal">–F</span> argument, like this:</p>&#13;
<p class="programs">sanders@ppa:~$ <span class="codestrong">tcpdump –nni eth0 –F dns_servers.bpf</span></p>&#13;
<p class="indent">If your file gets too large, you might be tempted to add notes or comments to it to keep track of what each part of the filter does. Keep in mind that a BPF filter file does not allow for comments and will generate an error if anything other than a filtering statement is encountered. Since comments are very helpful for deciphering large filter files, I usually maintain two copies of every file: one for use with tcpdump that doesn’t contain comments and one that contains comments for reference.</p>&#13;
<h3 class="h3"><a id="ch06lev1sec7"/><strong>Time Display Formats in TShark</strong></h3>&#13;
<p class="noindent">One thing that often confuses new analysts is the default timestamp used by TShark. It shows packet timestamps in relation to the start of the packet capture. There are times when such timestamping is preferable, but in many cases you may want to see the time the packet was captured, as is the default for tcpdump timestamps. You can get this same output from TShark by using the <span class="literal">–t</span> argument with the value <span class="literal">ad</span> for absolute date:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark –r packets.pcap –t ad</span></p>&#13;
<p class="indent">Here’s a comparison of the same packets as before with the default relative timestamps <span class="ent">➊</span> and absolute timestamps <span class="ent">➋</span>:</p>&#13;
<p class="programs"><span class="ent">➊</span> C:\Program Files\Wireshark&gt;<span class="codestrong">tshark -r packets.pcap -c2</span><br/>    1   0.000000 172.16.16.172 -&gt; 4.2.2.1      ICMP Echo (ping)<br/>  request  id=0x0001, seq=17/4352, ttl=128<br/>    2   0.024500 4.2.2.1 -&gt; 172.16.16.172      ICMP Echo (ping)<br/>  reply    id=0x0001, seq=17/4352, ttl=54 (request in 1)<br/><br/><span class="ent">➋</span> C:\Program Files\Wireshark&gt;<span class="codestrong">tshark -r packets.pcap -t ad -c2</span><br/>    1 2015-12-21 12:52:43.116551 172.16.16.172 -&gt; 4.2.2.1      ICMP Echo (ping)<br/>  request  id=0x0001, seq=17/4352, ttl=128<br/>    2 2015-12-21 12:52:43.141051      4.2.2.1 -&gt; 172.16.16.172 ICMP Echo (ping)<br/>  reply    id=0x0001, seq=17/4352, ttl=54 (request in 1)</p>&#13;
<p class="indent">By using the <span class="literal">–t</span> argument, you can specify any time display format you would find in Wireshark. These formats are shown in <a href="ch06.xhtml#ch06tab1">Table 6-1</a>.</p>&#13;
<p class="tablecap"><span epub:type="pagebreak" id="page_115"/><a id="ch06tab1"/><strong>Table 6-1:</strong> Time Display Formats Available in TShark</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_th" style="vertical-align: top;"><p class="table"><strong>Value</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="table"><strong>Timestamp</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="table"><strong>Example</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table"><span class="literal">a</span></p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table">Absolute time the packet was captured (in your time zone)</p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table"><span class="literal">15:47:58.004669</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_2a" style="vertical-align: top;"><p class="table"><span class="literal">ad</span></p></td>&#13;
<td class="table_2a" style="vertical-align: top;"><p class="table">Absolute time the packet was captured with date (in your time zone)</p></td>&#13;
<td class="table_2a" style="vertical-align: top;"><p class="table"><span class="literal">2015-10-09 15:47:58.004669</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table"><span class="literal">d</span></p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table">Delta (time difference) since previous captured packet</p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table"><span class="literal">0.000140</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_2a" style="vertical-align: top;"><p class="table"><span class="literal">dd</span></p></td>&#13;
<td class="table_2a" style="vertical-align: top;"><p class="table">Delta since previous displayed packet</p></td>&#13;
<td class="table_2a" style="vertical-align: top;"><p class="table"><span class="literal">0.000140</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table"><span class="literal">e</span></p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table">Epoch time (seconds since January 1, 1970, UTC)</p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table"><span class="literal">1444420078.004669</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_2a" style="vertical-align: top;"><p class="table"><span class="literal">r</span></p></td>&#13;
<td class="table_2a" style="vertical-align: top;"><p class="table">Elapsed time between the first packet and the current packet</p></td>&#13;
<td class="table_2a" style="vertical-align: top;"><p class="table"><span class="literal">0.000140</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table"><span class="literal">u</span></p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table">Absolute time the packet was captured (UTC)</p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="table"><span class="literal">19:47:58.004669</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_2ba" style="vertical-align: top;"><p class="table"><span class="literal">ud</span></p></td>&#13;
<td class="table_2ba" style="vertical-align: top;"><p class="table">Absolute time the packet was captured with date (UTC)</p></td>&#13;
<td class="table_2ba" style="vertical-align: top;"><p class="table"><span class="literal">2015-10-09 19:47:58.004669</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<p class="indent">Unfortunately, tcpdump doesn’t provide this level of control for manipulating how timestamps are shown.</p>&#13;
<h3 class="h3"><a id="ch06lev1sec8"/><strong>Summary Statistics in TShark</strong></h3>&#13;
<p class="noindent">Another useful TShark feature (and one that sets it apart from tcpdump) is its ability to generate a subset of statistics from a capture file. These statistics mirror many of the capabilities found in Wireshark but provide easy command line access. Statistics are generated by using the <span class="literal">–z</span> argument and specifying the name of the output you would like to generate. You can view a full listing of available statistics by using this command:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark –z help</span></p>&#13;
<p class="indent">Many of the features we’ve already covered are available using the <span class="literal">–z</span> argument. They include the ability to output endpoint and conversation statistics using this command:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark -r packets.pcap –z conv,ip</span></p>&#13;
<p class="indent">This command prints a table of statistics with information about the IP conversations in the file <em>packets.pcap</em>, as shown in <a href="ch06.xhtml#ch06fig3">Figure 6-3</a>.</p>&#13;
<p class="indent">You can also use this argument to view protocol-specific information. As shown in <a href="ch06.xhtml#ch06fig4">Figure 6-4</a>, you can use the <span class="literal">http,tree</span> option to see a breakdown of HTTP requests and responses in table form.</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark -r packets.pcap –z http,tree</span></p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_116"/><img alt="image" src="../images/f116-01.jpg"/></div>&#13;
<p class="figcap"><a id="ch06fig3"/><em>Figure 6-3: Using TShark to view conversation statistics</em></p>&#13;
<div class="image"><img alt="image" src="../images/f116-02.jpg"/></div>&#13;
<p class="figcap"><a id="ch06fig4"/><em>Figure 6-4: Using TShark to view HTTP request and response statistics</em></p>&#13;
<p class="indent">Another useful feature is the ability to view reassembled stream output, similar to what we did earlier by right-clicking packets in Wireshark and choosing the Follow TCP Stream option. To get this output, we have to use the <span class="literal">follow</span> option and specify the type of stream, the output mode, and which stream we want to display. You can identify a stream with the number assigned to it in the leftmost column when outputting conversation statistics (as seen in <a href="ch06.xhtml#ch06fig3">Figure 6-3</a>). A command might look like this:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark -r http_google.pcap -z follow,tcp,ascii,0</span></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_117"/>This command will print TCP stream 0 to the screen in ASCII format from the file <em>http_google.pcap</em>. The output for this command looks like this:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark -r http_google.pcap -z</span><br/><br/>--<span class="codeitalic">snip</span>--<br/>===================================================================<br/>Follow: tcp,ascii<br/>Filter: tcp.stream eq 0<br/>Node 0: 172.16.16.128:1606<br/>Node 1: 74.125.95.104:80<br/>627<br/>GET / HTTP/1.1<br/>Host: www.google.com<br/>User-Agent: Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US; rv:1.9.1.7)<br/>Gecko/20091221 Firefox/3.5.7<br/>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8<br/>Accept-Language: en-us,en;q=0.5<br/>Accept-Encoding: gzip,deflate<br/>Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7<br/>Keep-Alive: 300<br/>Connection: keep-alive<br/>Cookie: PREF=ID=257913a938e6c248:U=267c896b5f39fb0b:FF=4:LD=e<br/>n:NR=10:TM=1260730654:LM=1265479336:GM=1:S=h1UBGonTuWU3D23L;<br/>NID=31=Z-nhwMjUP63e0tYMTp-3T1igMSPnNS1eM1kN1_DUrnO2zW1cPM4JE3AJec9b_<br/>vG-YFibFXszOApfbhBA1BOX4dKx4L8ZDdeiKwqekgP5_kzELtC2mUHx7RHx3PIttcuZ<br/><br/>        1406<br/>HTTP/1.1 200 OK<br/>Date: Tue, 09 Feb 2010 01:18:37 GMT<br/>Expires: -1<br/>Cache-Control: private, max-age=0<br/>Content-Type: text/html; charset=UTF-8<br/>Content-Encoding: gzip<br/>Server: gws<br/>Content-Length: 4633<br/>X-XSS-Protection: 0</p>&#13;
<p class="indent">You can also specify which stream you’d like to view by providing the address details. For example, the following command will retrieve a UDP stream for the specified endpoints and ports:</p>&#13;
<p class="programs">C:\Program Files\Wireshark&gt;<span class="codestrong">tshark –r packets.pcap –z follow,udp,ascii,192.168.</span><br/><span class="codestrong">1.5:23429</span><span class="ent">➊</span><span class="codestrong">,4.2.2.1:53</span><span class="ent">➋</span></p>&#13;
<p class="indent">This command will print the UDP stream for the endpoints 192.168.1.5 on port 23429 <span class="ent">➊</span> and 4.2.2.1 on port 53 <span class="ent">➋</span> from <em>packets.pcap</em>.</p>&#13;
<p class="indenta">Here are some of my favorite statistical options:</p>&#13;
<p class="noindentla"><span class="codestrong">ip_hosts,tree</span>   Displays every IP address in a capture, along with the rate and percentage of traffic each address is responsible for</p>&#13;
<p class="noindentla"><span class="codestrong">io,phs</span>   Displays a protocol hierarchy showing all protocols found within the capture file</p>&#13;
<p class="noindentla"><span epub:type="pagebreak" id="page_118"/><span class="codestrong">http,tree</span>   Displays statistics related to HTTP requests and responses</p>&#13;
<p class="noindentla"><span class="codestrong">http_req,tree</span>   Displays statistics for every HTTP request</p>&#13;
<p class="noindentla"><span class="codestrong">smb,srt</span>   Displays statistics related to SMB commands for analyzing Windows communication</p>&#13;
<p class="noindentla"><span class="codestrong">endpoints,wlan</span>   Displays wireless endpoints</p>&#13;
<p class="noindentl"><span class="codestrong">expert</span>   Displays expert information (chats, errors, and so on) from the capture</p>&#13;
<p class="indent">There are a lot of useful options available using the <span class="literal">–z</span> argument. It would take far too many pages to cover them all here, but if you plan to use TShark frequently, you should invest time in reviewing the official documentation to learn more about everything that is available. You can find that documentation here: <em><a href="https://www.wireshark.org/docs/man-pages/tshark.html">https://www.wireshark.org/docs/man-pages/tshark.html</a></em>.</p>&#13;
<h3 class="h3"><a id="ch06lev1sec9"/><strong>Comparing TShark and tcpdump</strong></h3>&#13;
<p class="noindenta">Both command line packet analysis applications we’ve examined in this chapter are well suited to their respective tasks, and either of them will allow you to accomplish whatever task is at hand with varying degrees of effort. There are a few differences worth highlighting so you can choose the best tool for the job:</p>&#13;
<p class="noindentla"><strong>Operating system</strong>   tcpdump is only available for Unix-based operating systems, while TShark can function on Windows and Unix-based systems.</p>&#13;
<p class="noindentla"><strong>Protocol support</strong>   Both tools support common layer 3 and 4 protocols, but tcpdump has limited layer 7 protocol support. TShark provides a rich level of layer 7 protocol support because it has access to Wireshark’s protocol dissectors.</p>&#13;
<p class="noindentl"><strong>Analysis features</strong>   Both tools rely heavily on human analysis to produce meaningful results, but TShark also provides a robust set of analytical and statistical features, similar to those in Wireshark, that can aid analysis when a GUI isn’t available.</p>&#13;
<p class="indent">Tool availability and personal preference are usually the ultimate deciders of which application to use. Fortunately, the tools are similar enough that learning one will inherently teach you something about the other, making you more versatile and increasing the size of your tool kit.</p>&#13;
</body></html>