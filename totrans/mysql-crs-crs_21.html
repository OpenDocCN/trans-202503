<html><head></head><body>
<div id="book-content">
<div id="sbo-rt-content"><section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" title="261" id="Page_261"/><a class="XrefDestination" id="16"/><span class="XrefDestination" id="xref-503007c16-001"/>16</span><br/>
<span class="ChapterTitle"><a class="XrefDestination" id="buildingaWeatherDatabase"/><span class="XrefDestination" id="xref-503007c16-002"/>Building a Weather Database</span></h1>
</header>
<figure class="opener">
<img src="image_fi/book_art/chapterart.png" alt="" width="200" height="200"/>
</figure>
<p class="ChapterIntro">In this project, you’ll build a weather database for a trucking company. The company transports items up and down the East Coast of the United States and needs a way to get the current weather for the major cities its drivers travel to.</p>
<p>The company already has a MySQL database set up that contains trucking data, but you need to add a new database detailing the current weather conditions for areas the truckers drive through. This will allow you to incorporate weather data into the existing trucking application to show the weather’s impact on scheduling and warn drivers of hazardous conditions like black ice, snow, and extreme temperatures.</p>
<p>You’ll get these weather data files from a third-party company that provides weather data. That company has agreed to send you a CSV file every hour. Recall from <a class="xref" href="c14.xhtml">Chapter 14</a> that a CSV file is a text file that contains data and uses a comma as the delimiter between fields.</p>
<p>The company providing the weather data will use FTP (File Transfer Protocol), a standard communication protocol that allows files to be transferred between computers, to deliver the <em>weather.csv</em> file to your <em/><span epub:type="pagebreak" title="262" id="Page_262"/>/home/weather_load/ directory on one of your Linux servers. The data file will arrive approximately every hour, but there can be delays, meaning the files may not arrive exactly at hourly intervals. For that reason, you’ll write a program that will run every 5 minutes to check for the file and load it into your database when it’s available.</p>
<p>Once you’ve reviewed the necessary technologies, you’ll begin your project by creating a new database called <code>weather</code> with two tables: <code>current_weather_load</code> and <code>current_weather</code>. You’ll load the data from the file into the <code>current_weather_load</code> table. Once you ensure that the data loads without any problems, you’ll copy the data from <code>current_weather_load</code> to the <code>current_weather</code> table, which is the table that your trucking application will use. You can find the <em>weather.csv</em> data file at <a href="https://github.com/ricksilva/mysql_cc/tree/main/chapter_16" class="LinkURL">https://github.com/ricksilva/mysql_cc/tree/main/chapter_16</a>.</p>
<h2 id="h1-503007c16-0001"><a class="XrefDestination" id="TechnologiesYou’llUse"/><span class="XrefDestination" id="xref-503007c16-003"/>Technologies You’ll Use</h2>
<p class="BodyFirst">For this project, you’ll use other technologies in addition to MySQL, including cron and Bash. These technologies allow you to schedule the loading of your weather data, check whether the data file is available, and create a logfile containing any load errors.</p>
<h3 id="h2-503007c16-0001"><a class="XrefDestination" id="cron"/><span class="XrefDestination" id="xref-503007c16-004"/>cron</h3>
<p class="BodyFirst">In order to schedule a script to run every 5 minutes, you’ll use <em>cron</em>, a scheduler available on Unix-like operating systems (Unix, Linux, and macOS). It is also available on Windows through the Windows Subsystem for Linux (WSL), which lets you run a Linux environment on a Windows computer. To install WSL, enter <code class="bold">wsl --install</code> on the command line.</p>
<p>The tasks that you schedule in cron are called <em>cron jobs</em>, and they run in the background, not attached to a terminal. You can schedule jobs by adding them to a configuration file called the <em>crontab</em> (<em>cron table</em>) file.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2><a class="XrefDestination" id="LearningMoreaboutCron"/><span class="XrefDestination" id="xref-503007c16-005"/>Learning More about Cron</h2>
<p class="BoxBodyFirst">If you’d like to learn more about cron, type <code>man cron</code> at your command prompt. The <code>man</code> command is used to display a manual of commands that can be run, and <code>cron</code> specifies that you want information about cron, including a list of options you can use with it.</p>
<p>If cron isn’t installed on your computer, you’ll need to search online for the command to install it in your particular environment.</p>
<p>You can start and stop cron, but the commands to do so vary, so try searching for the command using <code>man cron</code>. You should also find the command to get cron’s status in order to see if it’s started or stopped.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p><span epub:type="pagebreak" title="263" id="Page_263"/>You can get a list of your scheduled cron jobs by typing <code>crontab -l</code>. If you need to edit your crontab configuration file, type <code>crontab -e</code>. The <code>-e</code> option will open a text editor where you can add, modify, or delete jobs from your crontab file.</p>
<p>To schedule a cron job, you must provide six pieces of information, in this order:</p>
<ol class="decimal">
<li value="1">Minute (0–59)</li>
<li value="2">Hour (0–23)</li>
<li value="3">Day of the month (1–31)</li>
<li value="4">Month (1–12)</li>
<li value="5">Day of the week (0–6) (Sunday to Saturday)</li>
<li value="6">The command or script to run</li>
</ol>
<p>For example, if you wanted to schedule a script called <em>pi_day.sh</em> to run, you’d type <code>crontab -e</code> and add a crontab entry that looks like this:</p>
<pre><code>14 3 14 3 * /usr/local/bin/pi_day.sh</code></pre>
<p>With this cron job in place, the <em>pi_day.sh</em> script in the <em>/usr/local/bin/</em> directory will execute every year on March 14 at 3:14 <span class="Caps">AM</span>. Since the day of the week has been set to <code>*</code> (the wildcard), the job will execute on whatever day of the week March 14th happens to be on that year.</p>
<h3 id="h2-503007c16-0002"><a class="XrefDestination" id="Bash"/><span class="XrefDestination" id="xref-503007c16-006"/>Bash</h3>
<p class="BodyFirst"><em>Bash</em> is a shell and command language available in Unix and Linux environments. You could use any number of tools or languages, but I’ve chosen Bash because of its popularity and relative simplicity. Bash scripts usually have the extension <em>.sh</em>, like <em>pi_day.sh</em> in the preceding example. In this chapter’s project, you’ll write a Bash script called <em>weather.sh</em> that cron will run every 5 minutes. This script will check if a new data file has arrived and call SQL scripts to load the data into your database if it has.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	You can learn more about Bash at <a href="https://linuxconfig.org/bash-scripting-tutorial-for-beginners" class="LinkURL">https://linuxconfig.org/bash-scripting-tutorial-for-beginners</a> or in <em>The Linux Command Line, 2nd edition</em>, by William Shotts (No Starch Press, 2019).</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-503007c16-0003"><a class="XrefDestination" id="SQLScripts"/><span class="XrefDestination" id="xref-503007c16-007"/>SQL Scripts</h3>
<p class="BodyFirst">SQL scripts are text files that contain SQL commands. For this project, you’ll write two SQL scripts called <em>load_weather.sql</em> and <em>copy_weather.sql</em>. The <em>load_weather.sql</em> script will load the data from the CSV file into the <code>current_weather_load</code> table and alert you to any load issues. The <em>copy_weather.sql</em> script will copy the weather data from the <code>current_weather_load</code> table to the <code>current_weather</code> table.</p>
<h2 id="h1-503007c16-0002"><span epub:type="pagebreak" title="264" id="Page_264"/><a class="XrefDestination" id="ProjectOverview"/><span class="XrefDestination" id="xref-503007c16-008"/>Project Overview</h2>
<p class="BodyFirst">You’ll schedule a cron job to run the <em>weather.sh</em> script every 5 minutes. If a new <em>weather.csv</em> data file exists, it will be loaded into the <code>current_weather_load</code> table. If it is loaded without errors, the data in the <code>current_weather_load</code> table will be copied to the <code>current_weather</code> table, where it will be used by your application. <a href="#figure16-1" id="figureanchor16-1">Figure 16-1</a> shows the flow of the project.</p>
<figure>
<img src="image_fi/503007c16/f16001.png" class="" alt="" width="643" height="744"/>
<figcaption><p><a id="figure16-1">Figure 16-1</a>: An overview of your weather project</p></figcaption>
</figure>
<p>If there isn’t a new <em>weather.csv</em> file available, the <em>weather.sh</em> script exits without running the rest of the commands in the Bash script that load the data and log errors. If the file was loaded and there aren’t any errors in <em>load_weather.log</em>, the Bash script will call <em>copy_weather.sql</em> to copy the data you just loaded in the <code>current_weather_load</code> table to the <code>current_weather</code> table.</p>
<h2 id="h1-503007c16-0003"><span epub:type="pagebreak" title="265" id="Page_265"/><a class="XrefDestination" id="TheDataFile"/><span class="XrefDestination" id="xref-503007c16-009"/>The Data File</h2>
<p class="BodyFirst">Since the trucking company travels up and down the US East Coast, you’ve requested the weather for the following locations:</p>
<ul class="disc">
<li>Portland, Maine</li>
<li>Boston, Massachusetts</li>
<li>Providence, Rhode Island</li>
<li>New York, New York</li>
<li>Philadelphia, Pennsylvania</li>
<li>Washington, DC</li>
<li>Richmond, Virginia</li>
<li>Raleigh, North Carolina</li>
<li>Charleston, South Carolina</li>
<li>Jacksonville, Florida</li>
<li>Miami, Florida</li>
</ul>
<p>The CSV data file will include the fields listed in <a href="#table16-1" id="tableanchor16-1">Table 16-1</a>.</p>
<figure>
<figcaption class="TableTitle"><p><a id="table16-1">Table 16-1</a>: Fields in the CSV Data File</p></figcaption>
<table id="table-503007c16-0001" border="1">
<thead>
<tr>
<td><b>Field name</b></td>
<td><b>Description</b></td>
</tr>
</thead>
<tbody>
<tr>
<td><code>station_id</code></td>
<td>The ID for the weather station where this data originated</td>
</tr>
<tr>
<td><code>station_city </code></td>
<td>The city where the weather station is located</td>
</tr>
<tr>
<td><code>station_state </code></td>
<td>A two-character code for the state where the weather station is located</td>
</tr>
<tr>
<td><code>station_lat</code></td>
<td>The latitude of this weather station</td>
</tr>
<tr>
<td><code>station_lon</code></td>
<td>The longitude of this weather station</td>
</tr>
<tr>
<td><code>as_of_datetime</code></td>
<td>The date and time that the data was gathered</td>
</tr>
<tr>
<td><code>temp</code></td>
<td>The temperature</td>
</tr>
<tr>
<td><code>feels_like  </code></td>
<td>The temperature that it currently “feels like” </td>
</tr>
<tr>
<td><code>wind</code></td>
<td>The wind velocity (in kilometers per hour)</td>
</tr>
<tr>
<td><code>wind_direction</code></td>
<td>The direction of the wind</td>
</tr>
<tr>
<td><code>precipitation </code></td>
<td>Precipitation in the last hour (in millimeters)</td>
</tr>
<tr>
<td><code>pressure</code></td>
<td>Barometric pressure</td>
</tr>
<tr>
<td><code>visibility </code></td>
<td>The distance that can be clearly seen (in miles)</td>
</tr>
<tr>
<td><code>humidity</code></td>
<td>The percentage of relative humidity in the air</td>
</tr>
<tr>
<td><code>weather_desc</code></td>
<td>A text description of the current weather</td>
</tr>
<tr>
<td><code>sunrise</code></td>
<td>The time that the sun rises at this location today</td>
</tr>
<tr>
<td><code>sunset</code></td>
<td>The time that the sun sets at this location today</td>
</tr>
</tbody>
</table>
</figure>
<p><span epub:type="pagebreak" title="266" id="Page_266"/>Approximately every hour, a CSV file containing the data for the locations that you requested will be delivered to you. The CSV file should look similar to <a href="#figure16-2" id="figureanchor16-2">Figure 16-2</a>.</p>
<figure>
<img src="image_fi/503007c16/f16002.png" class="keyline" alt="" width="694" height="162"/>
<figcaption><p><a id="figure16-2">Figure 16-2</a>: The <em>weather.csv</em> data file</p></figcaption>
</figure>
<p>The file has one row for each of the 11 weather stations you requested, with every field delimited by a comma.</p>
<h2 id="h1-503007c16-0004"><a class="XrefDestination" id="CreatingtheWeatherTables"/><span class="XrefDestination" id="xref-503007c16-010"/>Creating the Weather Tables</h2>
<p class="BodyFirst">Create a MySQL database called <code>weather</code> to store the weather data:</p>
<pre><code>create database weather;</code></pre>
<p>Now you’ll create a table called <code>current_weather_load</code> to load the CSV file data into. The <code>_load</code> suffix makes it clear that this table is for loading data about the current weather.</p>
<p><a href="#listing16-1" id="listinganchor16-1">Listing 16-1</a> shows the SQL statement to create the <code>current_weather_load</code> table.</p>
<pre><code>create table current_weather_load
(
  station_id      int             primary key,
  station_city    varchar(100),
  station_state   char(2),
  station_lat     decimal(6,4)    not null,
  station_lon     decimal(7,4)    not null,
  as_of_dt        datetime,
  temp            int             not null,
  feels_like      int,
  wind            int,
  wind_direction  varchar(3),
  precipitation   decimal(3,1),
  pressure        decimal(6,2),
  visibility      decimal(3,1)    not null,
  humidity        int,
  weather_desc    varchar(100)    not null,
  sunrise         time,
  sunset          time,
  constraint check(station_lat between -90 and 90),
  constraint check(station_lon between -180 and 180),
  constraint check(as_of_dt between (now() - interval 1 day) and now()),
  constraint check(temp between -50 and 150),
<span epub:type="pagebreak" title="267" id="Page_267"/>  constraint check(feels_like between -50 and 150),
  constraint check(wind between 0 and 300),
  constraint check(station_lat between -90 and 90),
  constraint check(wind_direction in
    (
     'N','S','E','W','NE','NW','SE','SW',
     'NNE','ENE','ESE','SSE','SSW','WSW','WNW','NNW'
    )
  ),
  constraint check(precipitation between 0 and 400),
  constraint check(pressure between 0 and 1100),
  constraint check(visibility between 0 and 20),
  constraint check(humidity between 0 and 100)
);</code></pre>
<p class="CodeListingCaption"><a id="listing16-1">Listing 16-1</a>: Creating the <code>current_weather_load</code> table</p>
<p>Now create a second table called <code>current_weather</code> with the same structure as <code>current_weather_load</code>:</p>
<pre><code>create table current_weather like current_weather_load;</code></pre>
<p>With these two tables in place, you now have a table that you can load the CSV file to, as well as a final, user-facing table that you’ll copy the weather data to once you are confident it has loaded cleanly.</p>
<p>Let’s go over <a href="#listing16-1">Listing 16-1</a> in more detail.</p>
<h3 id="h2-503007c16-0004"><a class="XrefDestination" id="DataTypes"/><span class="XrefDestination" id="xref-503007c16-011"/>Data Types</h3>
<p class="BodyFirst">You should always choose data types for the columns that match the data in the CSV file as closely as possible. For example, you define the <code>station_id</code>, <code>temp</code>, <code>feels_like</code>, <code>wind</code>, and <code>humidity</code> columns as <code>int</code> data types since they will come to you as numeric values without a decimal point. You define <code>station_lat</code>, <code>station_lon</code>, <code>precipitation</code>, <code>pressure</code>, and <code>visibility</code> as <code>decimal</code> data types because they will contain decimal points.</p>
<p>You should also consider how large the column values could be. For example, you define the <code>station_lat</code> column as <code>decimal(6,4)</code> because latitudes need to store numbers with up to two digits before the decimal point and four digits after the decimal point. You define <code>station_lon</code> as <code>decimal(7,4)</code> because it represents a longitude, which needs to store up to <em>three</em> digits before the decimal point and four digits after it. A longitude column needs to be able to hold a larger value than a latitude column.</p>
<p>You have to get creative with the <code>as_of_dt</code> column. Its data comes to you in the format <code>YYYYMMDD hh:mm</code>. MySQL doesn’t have a data type that stores data in this format, so you create the <code>as_of_dt</code> column with a data type of <code>datetime</code>. When you load the data file into your load table, you’ll convert this value to the <code>datetime</code> format. (We’ll discuss how in the next section.)</p>
<p>The <code>station_state</code> column will always contain two characters, so you define it as <code>char(2)</code>. Since the <code>station_city</code> and <code>weather_desc</code> columns will have a variable number of characters, you define both as a <code>varchar</code> containing up to 100 characters. No city or description should have more than <span epub:type="pagebreak" title="268" id="Page_268"/>100 characters, so if you get a value for those columns that is larger than 100, you can safely say the data is incorrect.</p>
<p>The <code>sunrise</code> and <code>sunset</code> values come to you formatted as times with the hour and the minute provided. You use the <code>time</code> data type for those values, even though you aren’t being sent the seconds in the data file. You’ll load the values into columns with the <code>time</code> data type and let the seconds automatically default to zeros. For example, you’ll load the value <code>17:06</code> and it will be saved in the table as <code>17:06:00</code>. This will work fine for your purposes since your application doesn’t need to track the sunrise and sunset time down to the second.</p>
<h3 id="h2-503007c16-0005"><a class="XrefDestination" id="Constraints"/><span class="XrefDestination" id="xref-503007c16-012"/>Constraints</h3>
<p class="BodyFirst">You create a primary key on the <code>station_id</code> column to enforce uniqueness. If the data file comes to you with two records for the same weather station, you don’t want to load both records. Setting <code>station_id</code> as the primary key will prevent the second row from being loaded and will produce a warning message alerting you to a problem in the data file.</p>
<p>You add some other constraints to your columns as quality checks of the data that will be loaded into the table.</p>
<p>The <code>station_lat</code> column must be in the range of a valid latitude value: –90.0000 to 90.0000. You already defined <code>station_lat</code> with a data type of <code>decimal(6,4)</code> so there can be only six total digits, with four digits after the decimal point, but that won’t prevent an invalid value like <code>95.5555</code> from being written to the column. Adding a <code>check</code> constraint will enforce that the value is in the appropriate range. This allows you to store all legitimate latitude values in your column and reject any values outside of that range. Similarly, the <code>station_lon</code> column must be in the range of a valid longitude value: –180.0000 to 180.0000.</p>
<p>The <code>wind_direction</code> column also has a <code>check</code> constraint to ensure that it contains only one of 16 possible values that you provided in a list (<code>N</code> for North, <code>SE</code> for Southeast, <code>NNW</code> for North-Northwest, and so on).</p>
<p>The other <code>check</code> constraints ensure that your data is within reasonable ranges for weather data. For example, a temperature outside of the range of –50 degrees to 150 degrees Fahrenheit is likely a mistake, so you’ll reject it. Humidity is a percentage, so you enforce that it must be within the range of 0 to 100.</p>
<p>You also declare some of the columns in your load table with the <code>not null</code> constraint. These columns are so important that you want your load to fail if they are not provided. The <code>station_id</code> column must not be null since it is the primary key of the table.</p>
<p>You define <code>station_lat</code> and <code>station_lon</code> as <code>not null</code> because you want to plot the weather station’s location on a map in your trucking application. You want to show each weather station’s current temperature, visibility, and conditions at the right map location, and you can’t do that if the station’s latitude and longitude aren’t provided.</p>
<p><span epub:type="pagebreak" title="269" id="Page_269"/>The <code>temperature</code>, <code>visibility</code>, and <code>weather_desc</code> columns are also key pieces of data for this project, and thus you define them as <code>not null</code> as well.</p>
<h2 id="h1-503007c16-0005"><a class="XrefDestination" id="LoadingtheDataFile"/><span class="XrefDestination" id="xref-503007c16-013"/>Loading the Data File</h2>
<p class="BodyFirst">Before you create the <em>weather.sh</em> Bash script that checks if a new CSV weather file is available, you’ll write the <em>load_weather.sql</em> SQL script that will load the CSV file into your <code>current_weather_load</code> table (see <a href="#listing16-2" id="listinganchor16-2">Listing 16-2</a>).</p>
<pre><code>use weather;

delete from current_weather_load;

load data local infile '/home/weather_load/weather.csv'
into table current_weather_load
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> fields terminated by ','
(
    station_id,
    station_city,
    station_state,
    station_lat,
    station_lon,
  <span class="CodeAnnotationCode" aria-label="annotation2">❷</span> @aod,
    temp,
    feels_like,
    wind,
    wind_direction,
    precipitation,
    pressure,
    visibility,
    humidity,
    weather_desc,
    sunrise,
    sunset
)
<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> set as_of_dt = str_to_date(@aod,'%Y%m%d %H:%i');

<span class="CodeAnnotationHang" aria-label="annotation4">❹</span> show warnings;

<span class="CodeAnnotationHang" aria-label="annotation5">❺</span> select concat('No data loaded for ',station_id,': ',station_city)
from    current_weather cw
where   cw.station_id not in
(
    select cwl.station_id
    from   current_weather_load cwl
);</code></pre>
<p class="CodeListingCaption"><a id="listing16-2">Listing 16-2</a>: The <em>load_weather.sql</em> script</p>
<p>First, you set your current database to the <code>weather</code> database and delete all rows from the <code>current_weather_load</code> table that may have been left over from a previous load.</p>
<p><span epub:type="pagebreak" title="270" id="Page_270"/>Then you use the <code>load data</code> command you saw in Chapter 14<a class="xref" href="c14.xhtml"/> to load the <em>weather.csv</em> file into the <code>current_weather_load</code> table. Because you’re loading a comma-separated file, you need to specify <code>fields terminated by ','</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span> so that <code>load data</code> knows where one field ends and the next field begins. You specify that the data file is called <em>weather.csv</em> and is in the <em>/home/weather_load/</em> directory.</p>
<p>Within parentheses, you list all the columns in the table that you want the data fields loaded into, with one exception: instead of loading a value directly from the file into the <code>as_of_dt</code> column, you load it into a variable called <code>@aod</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. This variable holds the value of the <code>as of date</code> as it is formatted in the CSV file, which, as mentioned earlier, is <code>YYYYMMDD hh:mm</code>. You convert the value of the <code>@aod</code> variable from a string to a <code>datetime</code> data type using MySQL’s <code>str_to_date()</code> function <span class="CodeAnnotation" aria-label="annotation3">❸</span>. You use the format specifiers <code>%Y</code>, <code>%m</code>, <code>%d</code>, <code>%H</code>, and <code>%i</code> to specify the format of the string. By specifying <code>str_to_date(@aod,'%Y%m%d %H:%i')</code>, you’re saying the <code>@aod</code> variable is made up of the following parts:</p>
<ul class="disc">
<li><code>%Y</code>, a four-digit year</li>
<li><code>%m</code>, a two-digit month</li>
<li><code>%d</code>, a two-digit day</li>
<li>A space</li>
<li><code>%H</code>, a two-digit hour (0–23)</li>
<li>A colon</li>
<li><code>%i</code>, a two-digit minute (0–59)</li>
</ul>
<p>With this information, the <code>str_to_date()</code> function has what it needs to convert the <code>@aod</code> string to the <code>as_of_date datetime</code> field in the <code>current_weather_load</code> table.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	The <code>str_to_date()</code> function can convert a string to a <code>date</code>, <code>time</code>, or <code>datetime</code> value, depending upon the format you provide. In this case, it returns a <code>datetime</code>.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>Next, you check if there were any problems loading the data. The <code>show warnings</code> command <span class="CodeAnnotation" aria-label="annotation4">❹</span> lists any errors, warnings, or notes from the last command that you ran. If problems in the data file caused your <code>load data</code> command to fail, <code>show warnings</code> will tell you what the problem was.</p>
<p>Then, you add a query as a second check that the data loaded properly <span class="CodeAnnotation" aria-label="annotation5">❺</span>. In this query, you get a list of all the weather stations that had data the last time you wrote data into the <code>current_weather</code> table. If any of those weather stations aren’t in the <code>current_weather_load</code> table you just loaded, that likely means weather station data was missing from your data file or there was a problem with that weather station’s data that caused it not to load. In either case, you want to be notified.</p>
<p>You’ve now written your <em>load_weather.sql</em> script to notify you of any problems with loading the data. If <em>load_weather.sql</em> runs and no output is created, the data was loaded into the <code>current_weather_load</code> table without a problem.</p>
<h2 id="h1-503007c16-0006"><span epub:type="pagebreak" title="271" id="Page_271"/><a class="XrefDestination" id="CopyingtheDatatoYourFinalTable"/><span class="XrefDestination" id="xref-503007c16-014"/>Copying the Data to Your Final Table</h2>
<p class="BodyFirst">Once the data is loaded from the CSV data file into your <code>current_weather_load</code> table without issue, you’ll run another SQL script called <em>copy_weather.sql</em> to copy the data to your final <code>current_weather</code> table (<a href="#listing16-3" id="listinganchor16-3">Listing 16-3</a>).</p>
<pre><code>use weather;

delete from current_weather;

insert into current_weather
(
       station_id,
       station_city,
       station_state,
       station_lat,
       station_lon,
       as_of_dt,
       temp,
       feels_like,
       wind,
       wind_direction,
       precipitation,
       pressure,
       visibility,
       humidity,
       weather_desc,
       sunrise,
       sunset
)
select station_id,
       station_city,
       station_state,
       station_lat,
       station_lon,
       as_of_dt,
       temp,
       feels_like,
       wind,
       wind_direction,
       precipitation,
       pressure,
       visibility,
       humidity,
       weather_desc,
       sunrise,
       sunset
from   current_weather_load;</code></pre>
<p class="CodeListingCaption"><a id="listing16-3">Listing 16-3</a>: The <em>copy_weather.sql</em> script</p>
<p>This SQL script sets your current database to the <code>weather</code> database, deletes all old rows from the <code>current_weather</code> table, and loads the <code>current_weather</code> table with the data from the <code>current_weather_load</code> table.</p>
<p><span epub:type="pagebreak" title="272" id="Page_272"/>Now that you have your SQL scripts written, you can write the Bash script that calls them (<a href="#listing16-4" id="listinganchor16-4">Listing 16-4</a>).</p>
<pre><code>#!/bin/bash <span class="CodeAnnotationCode" aria-label="annotation1">❶</span>
cd /home/weather/ <span class="CodeAnnotationCode" aria-label="annotation2">❷</span>

if [ ! -f weather.csv ]; then <span class="CodeAnnotationCode" aria-label="annotation3">❸</span>
   exit 0
fi

mysql --local_infile=1 -h 127.0.0.1 -D weather -u trucking -pRoger -s \
       &lt; load_weather.sql &gt; load_weather.log <span class="CodeAnnotationCode" aria-label="annotation4">❹</span>

if [ ! -s load_weather.log ]; then <span class="CodeAnnotationCode" aria-label="annotation5">❺</span>
   mysql -h 127.0.0.1 -D weather -u trucking -pRoger -s &lt; copy_weather.sql &gt; copy_weather.log
fi

mv weather.csv weather.csv.$(date +%Y%m%d%H%M%S) <span class="CodeAnnotationCode" aria-label="annotation6">❻</span></code></pre>
<p class="CodeListingCaption"><a id="listing16-4">Listing 16-4</a>: The <em>weather.sh</em> script</p>
<p>The first line of a Bash script <span class="CodeAnnotation" aria-label="annotation1">❶</span> is known as a<em> shebang</em>. It tells the system that the interpreter to use for the commands in this file is in the <em>/bin/bash</em> directory.</p>
<p>Next, you use the <code>cd</code> command to change directories to <em>/home/weather/</em> <span class="CodeAnnotation" aria-label="annotation2">❷</span>.</p>
<p>In your first <code>if</code> statement <span class="CodeAnnotation" aria-label="annotation3">❸</span>, you check if the <em>weather.csv</em> file exists. In Bash scripts, <code>if</code> statements start with <code>if</code> and end with <code>fi</code>. The <code>-f</code> command checks if a file exists, and <code>!</code> is the syntax for <code>not</code>. The statement <code>if [ ! -f weather.csv ]</code> checks if the <em>weather.csv</em> file does not exist. If it doesn’t, that means you don’t have a new CSV data file to load, so you <code>exit</code> the Bash script and provide an exit code of <code>0</code>. By convention, you provide an exit code of <code>0</code> for success or <code>1</code> to signal an error. Exiting the Bash script here prevents the rest of the script from running; you don’t need to run the rest of the script, since you don’t have a data file to process.</p>
<p>You use the MySQL command line client <span class="CodeAnnotation" aria-label="annotation4">❹</span> (the <code>mysql</code> command, described in <a class="xref" href="c14.xhtml">Chapter 14</a>) to run the <em>load_weather.sql</em> SQL script. If the <em>load_weather.sql</em> script has any problems loading the data to the <code>current_weather_load</code> table, you’ll log those problems to a file called <em>load_weather.log</em>.</p>
<p>In Bash, the left arrow (<code>&lt;</code>) and right arrow (<code>&gt;</code>) are used for <em>redirection</em>, which lets you take your input from a file and write your output to another file. The syntax <code>&lt; load_weather.sql</code> tells the MySQL command line client to run the commands from the <em>load_weather.sql</em> script. The syntax <code>&gt; load_weather.log</code> says to write any output to the <em>load_weather.log</em> file.</p>
<p>The <code>local_infile=1</code> option lets you run the <code>load data</code> command (used in the <em>load_weather.sql</em> script) using data files on your local computer, as opposed to data files on the server where MySQL is installed. This may be unnecessary in your environment, depending upon your configuration settings. (Your DBA can set this option as a configuration parameter using the command <code>set global local_infile = on</code>.)</p>
<p><span epub:type="pagebreak" title="273" id="Page_273"/>The <code>-h</code> option tells the MySQL command line client which host server MySQL is installed on. In this case, <code>-h 127.0.0.1</code> indicates that your MySQL host server is the same computer that you’re currently using to run the script. Also known as <em>localhost</em>, 127.0.0.1 is the IP address for the current (local) computer. You could also simply type <code>-h</code> <code>localhost</code> here.</p>
<p>Next, you provide the database name, <code>weather</code>; your MySQL user ID, <code>trucking</code>; and your password, <code>Roger</code>. Oddly, MySQL doesn’t allow a space after the <code>-p</code>, so enter your password without a preceding space.</p>
<p>You use the <code>-s</code> option to run your SQL script in <em>silent mode</em>. This prevents the script from giving you too much information in your output. For example, if no data gets loaded for the Boston weather station, you want to see the message <code>No data loaded for 375: Boston</code> in your <em>load_weather.log</em> file. But without the <code>-s</code>, the logfile will also show the beginning of the <code>select</code> statement that produced that message:</p>
<pre><code>concat('No data loaded for ',station_id,': ',station_city)
No data loaded for 375: Boston</code></pre>
<p>Using <code>-s</code> prevents the text <code>concat('No data loaded for ',station_id,': ',station_city)</code> from being written to <em>load_weather.log</em>.</p>
<p>In Bash, the backslash character (<code>\</code>) lets you continue your command on the next line. After the <code>-s</code>, you use a backslash and continue on the next line because your line of code was so long.</p>
<p>Next, your Bash script checks to see if any load problems are listed in the <em>load_weather.log</em> file <span class="CodeAnnotation" aria-label="annotation5">❺</span>. In an <code>if</code> statement, <code>-s</code> checks to see if the file size is greater than 0 bytes. You only want to load the data into your final table, <code>current_weather</code>, if there were no problems loading the data into your load table, <code>current_weather_load</code>. In other words, you’ll only copy the data to the <code>current_weather</code> table when the <em>load_weather.log</em> file is empty, or 0 bytes. You check that the logfile doesn’t have a size greater than 0 using the syntax <code>if [ ! -s load_weather.log ]</code>.</p>
<p>Finally, in the last line of the <em>weather.sh</em> Bash script, you rename the <em>weather.csv</em> file, adding the current date and time as a suffix. For example, you’ll rename <em>weather.csv</em> to <em>weather.csv.20240412210125</em> so that the next time your Bash script is run, it won’t try to reload the same <em>weather.csv</em> file <span class="CodeAnnotation" aria-label="annotation6">❻</span>. The <code>mv</code> command stands for <em>move</em>, and is used to rename or move files to another directory.</p>
<p>Now let’s check out the results. If you are sent a <em>weather.csv</em> data file with valid data, running the <em>load_weather.sql</em> script will result in the <code>current_weather_load</code> table getting populated with values. This should look similar to <a href="#figure16-3" id="figureanchor16-3">Figure 16-3</a>.</p>
<p>The data in your <code>current_weather_load</code> table looks good. All 11 rows that were in the CSV data file are now in the table, and the values look reasonable for all of your columns.</p>
<p>On the other hand, if you’re sent a <em>weather.csv</em> data file with duplicate values, or with values that are in the wrong format or out of range, the result of running the <em>load_weather.sql</em> script will be that your <em>load_weather.log</em> file will contain a list of the problems.</p>
<span epub:type="pagebreak" title="274" id="Page_274"/><figure>
<img src="image_fi/503007c16/f16003.png" class="keyline" alt="" width="844" height="152"/>
<figcaption><p><a id="figure16-3">Figure 16-3</a>: The <span class="LiteralInCaption"><code>current_weather_load</code></span> table</p></figcaption>
</figure>
<p>Assuming you got valid data and <em>copy_weather.sql</em> ran, the <code>current_weather</code> table should match <a href="#figure16-3">Figure 16-3</a>.</p>
<p>Next, you’ll create the schedule to run this Bash script using cron.</p>
<h2 id="h1-503007c16-0007"><a class="XrefDestination" id="SchedulingtheBashScriptoncron"/><span class="XrefDestination" id="xref-503007c16-015"/>Scheduling the Bash Script on cron</h2>
<p class="BodyFirst">Using the command <code>crontab -e</code>, create the following crontab entry:</p>
<pre><code>*/5 * * * * /home/weather/weather.sh</code></pre>
<p>The <code>*/5</code> in the <code>minutes</code> column tells cron to run this job every 5 minutes. You can use the wildcard (<code>*</code>) character for all the other values (hour, day of month, month, and day of week, respectively), since you want the script to run for all hours, months, days, and days of the week. <a href="#figure16-4" id="figureanchor16-4">Figure 16-4</a> shows what each piece of the crontab entry means.</p>
<figure>
<img src="image_fi/503007c16/f16004.png" class="" alt="" width="406" height="199"/>
<figcaption><p><a id="figure16-4">Figure 16-4</a>: Scheduling <em>weather.sh</em> on cron to run every 5 minutes</p></figcaption>
</figure>
<p>You then save the crontab file and exit the text editor that was launched by the <code>crontab -e</code> command.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="boxcustom1">
<h2>Try It Yourself</h2>
<p class="BoxBodyFirst">The <em>weather.csv</em> file contains valid weather data that will load into your <code>current_weather_load</code> table without a problem:</p>
<pre><code>4589,Portland,ME,43.6591,70.2568,20240211 13:26,22,14,13,NNE,2.5,29.91,1.7,34,Heavy Snow,6:45,17:06
<span epub:type="pagebreak" title="275" id="Page_275"/>375,Boston,MA,42.3601,71.0589,20240211 13:27,24,15,11,NE,3.4,30.01,2.1,37,Snow,6:46,17:11
459,Providence,RI,41.8241,71.4128,20240211 13:26,25,15,11,SSW,3.1,27.32,1.7,38,Heavy Snow,6:47,17:14
778,New York,NY,40.7128,74.006,20240211 13:29,31,22,10,NE,2.2,29.83,3.3,34,Snow,6:55,17:26
4591,Philadelphia,PA,39.9526,75.1652,20240211 13:30,33,27,12,NW,2,29.85,5.7,88,Rain,6:58,17:32
753,Washington,DC,38.9072,77.0369,20240211 13:27,35,31,8,SSW,.3,30.51,8.1,74,Drizzle,7:04,17:41
507,Richmond,VA,37.5407,77.4361,20240211 13:28,43,38,10,S,0,28.14,9.1,64,Partly Cloudy,7:04,17:45
338,Raleigh,NC,35.7796,78.6382,20240211 13:27,52,51,4,ESE,0,29.33,9.2,56,Partly Sunny,7:06,17:52
759,Charleston,SC,32.7765,79.9311,20240211 13:28,61,59,6,W,0,29.74,9.5,54,Sunny,7:07,18:02
103,Jacksonville,FL,30.3322,81.6557,20240211 13:26,67,62,3,WSW,0,29.77,10,55,Sunny,7:10,18:12
2746,Miami,FL,25.7617,80.1918,20240211 13:28,76,78,1,SW,0,28.14,10,67,Sunny,6:59,18:12</code></pre>
<p class="BoxListNumberCustom1"><b>16-1.</b>	Edit the CSV file using a text editor and add some invalid data. Remove a line of data, duplicate a line of data, or replace a numeric value with a non-numeric value like an <code>X</code>. Rerun the <em>weather.sh </em>Bash script, either using cron or by changing directories to <em>/home/weather/</em> and typing <code>./weather.sh</code> to manually run the script.</p>
<p class="ListBody">Check the contents of the <em>load_weather.log </em>file. Does it list the data issues that you put in the CSV file?</p>
<p class="ListBody">In the <code>weather</code> database, check the contents of the <code>current_weather_load</code> and <code>current_weather</code> tables using the <code>select * from</code> syntax. Does the <code>current_weather</code> table still contain the data from the last valid data load?</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-503007c16-0008"><a class="XrefDestination" id="AlternativeApproaches"/><span class="XrefDestination" id="xref-503007c16-017"/>Alternative Approaches</h2>
<p class="BodyFirst">As the saying goes, there are many ways to skin a cat. Likewise, there are many other ways you could have approached this project using what you’ve learned so far.</p>
<p>You could have loaded the data from the CSV file directly to the final <code>current_weather</code> table, but using an interim load table enables you to correct any data issues behind the scenes without affecting user-facing data. If the CSV file comes to you with data problems like duplicate records, incorrectly formatted column values, or out-of-range values, your load into the <code>current_weather_load</code> table will fail. While you work with the CSV file supplier to get a corrected file, your application will continue using the existing data in the <code>current_weather</code> table and your users won’t be affected (though the weather data they see won’t be as up to date as it normally would be).</p>
<p>If your weather data provider had an <em>application programming interface (API)</em> available, you could have received this weather data from an API rather than <span epub:type="pagebreak" title="276" id="Page_276"/>loading a CSV data file. An API is another way to exchange data between two systems, but an in-depth discussion is beyond the scope of this book.</p>
<p>You created a primary key and several other constraints on your <code>current_weather_load</code> table. You wouldn’t do this in cases where you need to load a large number of records from a file into a table. For performance reasons, you’d choose to load the data into a table that has no constraints. As each row is being written into the table, MySQL needs to check that the constraints aren’t being violated, which takes time. In your weather project, however, there were only 11 rows being loaded, so the load time was almost instantaneous even with the constraints.</p>
<p>You could have added a line of code to the Bash script, <em>weather.sh</em>, to have it notify you and the data provider by email or text whenever there’s a problem loading the data. This wasn’t included in the project because it requires a bit of setup. To learn more, use the <code>man</code> command to look up the <code>mailx</code>, <code>mail</code>, or <code>sendmail</code> commands (for example, <code>man mailx</code>).</p>
<p>Also, your database credentials are hardcoded in your <em>weather.sh</em> Bash script so that the script can call the MySQL command line client. When you load the data, MySQL gives you the warning <code>Using a password on the command line interface can be insecure</code>. It would be worth restructuring the code so that it hides your database user ID and password or using the <code>mysql_config_editor</code> utility shown in <a class="xref" href="c14.xhtml">Chapter 14</a>.</p>
<h2 id="h1-503007c16-0009"><a class="XrefDestination" id="Summary"/><span class="XrefDestination" id="xref-503007c16-018"/>Summary</h2>
<p class="BodyFirst">In this project, you scheduled a cron job to execute a Bash script that checks for the arrival of a CSV data file containing current weather data. When the file arrived, you loaded it into your MySQL database. You also checked for problems loading the data and, once it loaded cleanly, transferred the data to your final weather table.</p>
<p>In the next project, you’ll use triggers to track changes to voter data in a MySQL database.</p>
</section>
</div>
</div>
</body></html>