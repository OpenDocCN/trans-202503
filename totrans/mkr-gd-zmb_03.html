<html><head></head><body>
<h2 class="h2" id="ch03"><a id="page_45"/><strong>3</strong></h2>
<p class="h2a"><strong>USING ELECTRICITY</strong></p>
<div class="image1"><img src="graphics/f0001-01.jpg" alt="image"/></div>
<p class="noindent">Now that you have a neat row of car batteries all charged up and ready to use, it’s time to use them to improve your standard of living (see <a href="ch03.html#ch03fig1">Figure 3-1</a>). First, you’ll learn how to connect those batteries to something useful, and then in this chapter’s first project, you’ll build a simple lighting circuit.</p>
<p class="indent">The second project in this chapter will show you how to use an Arduino microcontroller board and a few extra components to make a simple battery monitor. You wouldn’t want to lose your brains just because your defenses’ batteries died!</p>
<div class="image"><a id="page_46"/><img src="graphics/f03-01.jpg" alt="image"/></div>
<p class="figuret"><a id="ch03fig1">Figure 3-1:</a> Car batteries have a variety of uses in the postapocalyptic world.</p>
<h3 class="h3" id="ch00lev1sec52"><strong>POWERING DEVICES FROM A CAR BATTERY</strong></h3>
<p class="noindent">Let’s look at how you can use all that energy to make your life more comfortable while you keep those pesky zombies at bay. Of course, you first have to get the electricity from the battery to your device. There are two common connectors you’ll want to have on hand.</p>
<h4 class="h4" id="ch00lev1sec53"><strong>CIGARETTE LIGHTER SOCKETS</strong></h4>
<p class="noindent">As DC voltages go, 12V is pretty useful. It’s the same voltage you find in the cigarette lighter socket of a car, and there are lots of 12V appliances that you can just connect straight to the battery. This includes various types of lighting, fans, drink warmers, air compressors, DVD players, mini fridges, and more.</p>
<p class="indent">In fact, there are so many 12V appliances with a cigarette lighter plug on the end that it’s worth making an adapter lead that will allow you to plug them right in, without having to modify them.</p>
<p class="indent">You can buy a cigarette lighter socket adapter, like the one on the left in <a href="ch03.html#ch03fig2">Figure 3-2</a>, at your local auto parts store. Having acquired it, you can strip the leads and attach alligator clips so you can hook the adapter up to the battery. For info about how to join the wires/attach the alligator clip, see Project 1, “<a href="ch02.html#ch00lev1sec40">Step 3: Wire Up the Battery and Charge Controller</a>” on <a href="ch02.html#page_30">page 30</a>.</p>
<div class="image"><a id="page_47"/><img src="graphics/f03-02.jpg" alt="image"/></div>
<p class="figuret"><a id="ch03fig2">Figure 3-2:</a> Making a cigarette lighter socket adapter</p>
<div class="note">
<p class="notet"><span class="font1"><strong>WARNING</strong></span></p>
<p class="noindent">Never assume that a car battery is harmless just because it’s only 12V! While you can’t get an electric shock from 12V, you can most certainly receive nasty burns from it. If a wrench or screwdriver accidentally shorts across the terminals of a car battery, hundreds of amps will flow through it, turning the tool into flying molten metal that can easily burn or even blind you. Just remember: Car batteries store a lot of energy, which can easily be released by such an accident.</p>
</div>
<p class="indent">Now that you’re starting to connect things to your battery, you need to make sure the battery is protected from accidental damage. Some adapters may already incorporate a fuse, but if yours doesn’t have a fuse, you should include a fuse holder in the circuit. A 10A fuse, like the one used in “<a href="ch02.html#ch00lev1sec43">Project 2: Bicycle Generator</a>” on <a href="ch02.html#page_34">page 34</a>, will work just fine. Always remember to keep spare fuses around. It’s not so easy to nip out to the shops if the neighborhood is overrun with zombies. Notice that I’ve included a fuse in the design in <a href="ch03.html#ch03fig2">Figure 3-2</a>; the fuse will prevent any problems of a fiery nature, should an accidental short circuit occur.</p>
<p class="indent">An alternative (or supplementary) way to protect your battery is to position the solar charge controller from “<a href="ch02.html#ch00lev1sec33">Project 1: Solar Recharging</a>” on <a href="ch02.html#page_26">page 26</a> between the battery and the <em>load</em>, or anything you want to power from that battery (<a href="ch03.html#ch03fig3">Figure 3-3</a>).</p>
<p class="indent">When set up this way, the charge controller monitors the battery voltage and will automatically disconnect the load when the battery voltage drops below a certain threshold. This is advantageous because if the battery is discharged too much beyond this point, then it can be so damaged that it will no longer accept charge, and then good luck recharging it.</p>
<div class="image"><a id="page_48"/><img src="graphics/f03-03.jpg" alt="image"/></div>
<p class="figuret"><a id="ch03fig3">Figure 3-3:</a> Use a charge controller to protect your battery. The solar panel is optional.</p>
<p class="indent">In “<a href="ch03.html#ch00lev1sec63">Project 4: Battery Monitor</a>” on <a href="ch03.html#page_53">page 53</a>, you will learn how to build a battery monitor that will alert you when your battery runs low.</p>
<h4 class="h4" id="ch00lev1sec54"><strong>USB POWER</strong></h4>
<p class="noindent">Largely due to the influence of the USB charger lead, 5V has become the most common operating voltage for small DC devices. Jumping from 12V to 5V is much easier than from 120V AC to 5V DC. At the auto parts store, you will find 12V cigarette lighter to 5V USB power adapters.</p>
<p class="indent">The adapter in <a href="ch03.html#ch03fig4">Figure 3-4</a> has the benefit of combining both 12V sockets and 5V USB sockets. Another type of adapter just has a 12V cigarette lighter–shaped plug with one or two USB sockets built into the end of the plug. You could either plug the type of adapter shown in <a href="ch03.html#ch03fig4">Figure 3-4</a> into the adapter of <a href="ch03.html#ch03fig2">Figure 3-2</a>. Alternatively, you could chop off the plug from the adapter of <a href="ch03.html#ch03fig4">Figure 3-4</a> and add alligator clips to it, just as you did to the adapter in <a href="ch03.html#ch03fig2">Figure 3-2</a>.</p>
<div class="image"><a id="page_49"/><img src="graphics/f03-04.jpg" alt="image"/></div>
<p class="figuret"><a id="ch03fig4">Figure 3-4:</a> 12V to USB adapter</p>
<p class="indent">You could, of course, use this adapter to charge your cell phone. But the cellular network will probably be one of the first services to collapse during the zombie apocalypse, first suffering overload from callers flooding the network, trying to get in touch with loved ones, and then succumbing to system failures due to power outages and lack of maintenance.</p>
<h4 class="h4" id="ch00lev1sec55"><strong>AC INVERTERS</strong></h4>
<p class="noindent">It’s possible to convert the 12V DC of a battery into 120V (or 220V) AC using an <em>inverter</em>. This device has terminals that connect to a 12V battery and an AC outlet, which you can plug regular AC appliances into.</p>
<p class="indent">You cannot, however, plug in very high-powered AC devices. A wattage rating printed on the inverter will specify the maximum power load it can handle. Small models intended for powering laptops may only be 50W, but 200W or 400W inverters are neither hard to find nor particularly expensive.</p>
<p class="indent">Where possible, using DC devices is much better, as inverters aren’t very efficient. They generate high-voltage AC and waste quite a lot of energy as heat; just look at the large heat sinks on the sides of most inverters. They also often use significant amounts of current even when nothing is plugged into them, so you have to remember to turn them off when not in use.</p>
<p class="indent">In the next section, you’ll learn how to make a low-voltage lighting setup that can provide lighting intensity similar to that of AC lighting but by using 12V DC lamps powered directly by a car battery.</p>
<h3 class="h3" id="ch00lev1sec56"><strong>PROJECT 3: LED LIGHTING</strong></h3>
<p class="noindent">LEDs offer the most light per watt of any type of illumination and are a natural choice for postapocalyptic lighting. This project uses three 12V, MR16 LED light bulbs. These bulbs are available in powers from 2W to 10W or more, and any of these wattages are suitable for this project.</p>
<p class="indent"><a id="page_50"/>You can string together more than three of these bulbs if you like. Just use a longer lead and more bulbs. You may, for example, have a long corridor that you wish to defend, and good illumination is essential for effective zombie fighting.</p>
<p class="indent">In fact, almost any 12V light source could be used, including high-power halogen light bulbs of 50W or more. However, the higher the wattage, the faster the battery will drain.</p>
<h4 class="h4" id="ch00lev1sec57"><strong>WHAT YOU WILL NEED</strong></h4>
<p class="noindent">To make this project, you’ll need the following items.</p>
<table border="0" cellpadding="0" cellspacing="0" class="topbot" width="100%">
<thead>
<tr>
<th valign="top" class="table_th"><p class="table1"><strong>ITEM</strong></p></th>
<th valign="top" class="table_th"><p class="table1"><strong>NOTES</strong></p></th>
<th valign="top" class="table_th"><p class="table1"><strong>SOURCE</strong></p></th>
</tr>
</thead>
<tbody>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> Car Battery</p></td>
<td valign="top" class="table"><p class="table">12V</p></td>
<td valign="top" class="table"><p class="table">Auto parts store, scavenge</p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> 2x heavy-duty alligator clip</p></td>
<td valign="top" class="table"><p class="table">7A or more</p></td>
<td valign="top" class="table"><p class="table">Auto parts store</p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> LED lamps MR16</p></td>
<td valign="top" class="table"><p class="table">12V 2W-10W</p></td>
<td valign="top" class="table"><p class="table">Hardware store</p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> MR16 lamp sockets</p></td>
<td valign="top" class="table"><p class="table">Sockets with trailing leads</p></td>
<td valign="top" class="table"><p class="table">Hardware store</p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> Switch</p></td>
<td valign="top" class="table"><p class="table">Inline switch (5A)</p></td>
<td valign="top" class="table"><p class="table">Hardware store</p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> Electrical cable</p></td>
<td valign="top" class="table"><p class="table">7A</p></td>
<td valign="top" class="table"><p class="table">Scavenge</p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> Fuse</p></td>
<td valign="top" class="table"><p class="table">10A fuse and holder</p></td>
<td valign="top" class="table"><p class="table">Auto parts store</p></td>
</tr>
</tbody>
</table>
<h4 class="h4" id="ch00lev1sec58"><strong>CONSTRUCTION</strong></h4>
<p class="noindent">The LED lights for this project are wired in parallel (<a href="ch03.html#ch03fig5">Figure 3-5</a>). In this arrangement, each of the lights gets the full 12V from the battery, and if one of the lights fails for any reason, the other lights will keep working.</p>
<div class="image"><img src="graphics/f03-05.jpg" alt="image"/></div>
<p class="figuret"><a id="ch03fig5">Figure 3-5:</a> 12V lighting system</p>
<h5 class="h5" id="ch00lev1sec59"><a id="page_51"/><strong>STEP 1: PREPARE THE ELECTRICAL CABLE</strong></h5>
<p class="noindent">If you’re using a fairly small number of low-power LED light bulbs (up to five, at up to 5W each), then double-core bell wire will be just fine. Cable designed for speakers is also a good choice. In my design (<a href="ch03.html#ch03fig5">Figure 3-5</a>), I used three bulbs, so I cut three lengths of cable, stripping half an inch (15 mm) of the insulation off the ends.</p>
<p class="indent">The first of these leads (labeled <span class="ent">➊</span> in <a href="ch03.html#ch03fig5">Figure 3-5</a>) will go from the battery’s positive terminal to the switch and then to the first lamp. The second length will continue on to the second lamp (<span class="ent">➋</span>), and the final lead (<span class="ent">➌</span>) will go to the last lamp.</p>
<p class="indent">Where the wires join, there needs to be a three-way twisting of each wire of the cable with both the next length of cable and the lamp holder (<a href="ch03.html#ch03fig6">Figure 3-6</a>).</p>
<div class="image"><img src="graphics/f03-06.jpg" alt="image"/></div>
<p class="figuret"><a id="ch03fig6">Figure 3-6:</a> Connecting the lamp holder</p>
<p class="indent">For a more permanent connection, solder the twisted connection. Whether you solder them or not, wrap the connections in electrical tape. For a guide on how to make this kind of twisted-wire connection, see “<a href="app02.html#ch00lev1sec226">Joining Wires by Twisting</a>” on <a href="app02.html#page_229">page 229</a>.</p>
<h5 class="h5" id="ch00lev1sec60"><strong>STEP 2: WIRE UP THE FUSE AND SWITCH</strong></h5>
<p class="noindent">Complete the wiring by attaching the fuse and alligator clip to the start of the wiring. Note that these MR16 light bulbs include a circuit to automatically switch the polarity of the LED. This means you can connect them either way around. If you use a different type of 12V LED, check whether it has separate positive and negative connections. If so, make sure that you connect the positive side to the switch lead and the negative side to the lead you’ll attach to the negative terminal on the battery.</p>
<p class="indent"><a id="page_52"/>The alligator clip attaches to the fuse lead, which is attached to the switch (<a href="ch03.html#ch03fig7">Figure 3-7</a>). Once again, these leads can be twisted together, and for a more reliable finish, you can solder the twisted joint. The in-line switch uses screw terminals to attach the wires. One side is just a metal connector that passes straight through, and the other side has spring contacts, which connect with each other when the switch is in the on position.</p>
<div class="image"><img src="graphics/f03-07.jpg" alt="image"/></div>
<p class="figuret"><a id="ch03fig7">Figure 3-7:</a> Connecting the fuse and alligator clip for a lighting system</p>
<h5 class="h5" id="ch00lev1sec61"><strong>STEP 3: INSTALL THE LAMPS</strong></h5>
<p class="noindent">Now that everything is wired up, attach the alligator clips to the battery and make sure that the bulbs light when the switch is flicked. Once you know the lights turn on, just affix them to the ceiling, the wall, or wherever you want them.</p>
<h4 class="h4" id="ch00lev1sec62"><strong>USING THE LIGHTING</strong></h4>
<p class="noindent">Murphy’s law dictates that batteries will run out of juice and shut off the lights just as the zombies attack. To anticipate and avoid this situation, it’s good to know roughly how many hours of light you’re going to get from your battery before you need to do some more pedaling or otherwise put some juice into it.</p>
<p class="indent">That number of hours depends on the size and quality of your battery. Looking back at <a href="ch02.html#ch02tab1">Table 2-1</a> on <a href="ch02.html#page_21">page 21</a>, you can see that a 5W LED is expected to last 120 hours. Therefore, a string of six 5W LEDs should be good for about 20 hours. If you go all out and put up a string of three 60W 12V halogen lamps, you’ll only get about 4 hours of light before needing another charge.</p>
<p class="indent"><a id="page_53"/>Whatever your lighting setup, it would be great to have advance notice that the battery is getting low—and this is the goal of the next project.</p>
<h3 class="h3" id="ch00lev1sec63"><strong>PROJECT 4: BATTERY MONITOR</strong></h3>
<p class="noindent">I recommend keeping a good stock of car batteries charged up and ready to go at all times. That way, if zombies damage your solar panels, or you fall ill and can’t pedal your generator, you won’t be plunged into darkness and left powerless (in both senses of the word). It is therefore of paramount importance that you have an early warning system that will monitor the battery, telling you when it starts to get low so you can swap in a new one.</p>
<p class="indent">This project uses an Arduino, a useful little board that’s great for putting together electronic projects that require a bit of logic. In this case, the logic is simply to measure the battery voltage, display it, and sound a buzzer when it falls below a certain critical level.</p>
<p class="indent">The Arduino will be powered from the same car battery that it’s monitoring. The Arduino uses less than 1W to operate, so it’s okay to leave the board connected to the battery continuously.</p>
<p class="indent">In the battery monitor setup (<a href="ch03.html#ch03fig8">Figure 3-8</a>), alligator clips connect the battery monitor to the battery. If the battery has large alligator clips attached to it, then these smaller clips can be attached to the handles of the big clips.</p>
<div class="image"><img src="graphics/f03-08.jpg" alt="image"/></div>
<p class="figuret"><a id="ch03fig8">Figure 3-8:</a> Battery monitor</p>
<p class="indent"><a id="page_54"/>The left lead of the left resistor (<a href="ch03.html#ch03fig8">Figure 3-8</a>) is connected to the positive battery terminal, and the right lead of the right resistor is connected to the negative battery terminal.</p>
<h4 class="h4" id="ch00lev1sec64"><strong>WHAT YOU WILL NEED</strong></h4>
<p class="noindent">To make this project, you’ll need the following items.</p>
<table border="0" cellpadding="0" cellspacing="0" class="topbot" width="100%">
<thead>
<tr>
<th valign="top" class="table_th"><p class="table1"><strong>ITEM</strong></p></th>
<th valign="top" class="table_th"><p class="table1"><strong>NOTES</strong></p></th>
<th valign="top" class="table_th"><p class="table1"><strong>SOURCE</strong></p></th>
</tr>
</thead>
<tbody>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> Arduino</p></td>
<td valign="top" class="table"><p class="table">Arduino Uno R3</p></td>
<td valign="top" class="table"><p class="table">Adafruit, Fry’s (7224833), Sparkfun</p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> Arduino screwshield</p></td>
<td valign="top" class="table"><p class="table">Screwshield</p></td>
<td valign="top" class="table"><p class="table">Adafruit (196)</p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> LCD shield</p></td>
<td valign="top" class="table"><p class="table">LCD 16x2 display shield</p></td>
<td valign="top" class="table"><p class="table">eBay, Sparkfun (DEV-11851)</p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> Buzzer</p></td>
<td valign="top" class="table"><p class="table">Small piezo buzzer</p></td>
<td valign="top" class="table"><p class="table">Adafruit (1740), eBay</p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> 270Ω resistor</p></td>
<td valign="top" class="table"><p class="table"> </p></td>
<td valign="top" class="table"><p class="table">Mouser (293-270-RC)</p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> 470Ω resistor</p></td>
<td valign="top" class="table"><p class="table"> </p></td>
<td valign="top" class="table"><p class="table">Mouser (293-470-RC)</p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> Small alligator clip leads</p></td>
<td valign="top" class="table"><p class="table"> </p></td>
<td valign="top" class="table"><p class="table">Auto parts store</p></td>
</tr>
</tbody>
</table>
<p class="indent">One great thing about using an Arduino is that there are many different ready-made modules, called <em>shields</em>, that fit on top of the Arduino and add extra features to it without any complex electronic construction. This project uses two such shields that are stacked on top of each other.</p>
<p class="indent">The first shield that fits on top of the Arduino is a <em>screwshield</em>, sometimes called a <em>wing shield</em>. This shield allows you to attach wires to the Arduino using screw terminals and a screw driver. The second and topmost shield that you’ll attach to the Arduino is an LCD display shield. This shield will tell you the battery level as a measurement of voltage and as a bar graph display of the state of charge (SOC) of the battery. The project also has an option to mute the buzzer to avoid attracting zombies, if you suspect they are shuffling about nearby.</p>
<p class="indent">The only other electronic components in this project are a pair of resistors and a buzzer. The resistors are needed because although the Arduino has inputs to measure voltage, it can only measure voltages up to 5V. Any more than that would damage the Arduino. You’ll use the pair of resistors in an arrangement called a <em>voltage divider</em>. The resistors I’ve chosen for my divider reduce the voltage to the Arduino by a factor of 2.74 so that the 12V or 13V that we might find at the battery will be reduced to 4.7V or less.</p>
<div class="sidebar">
<p class="sidebart"><a id="page_55"/><strong>VOLTAGE DIVIDERS</strong></p>
<p class="noindent">Using two resistors as a voltage divider (<a href="ch03.html#ch03fig9">Figure 3-9</a>) is a great way to reduce the voltage you are trying to measure to a level where it can be directly measured by, say, an Arduino.</p>
<div class="image"><img src="graphics/f03-09.jpg" alt="image"/></div>
<p class="figuret"><a id="ch03fig9">Figure 3-9:</a> Voltage divider</p>
<p class="indent">The formula to calculate V<sub>out</sub> if you know V<sub>in</sub>, R1, and R2 is</p>
<div class="image"><img src="graphics/f0055-01.jpg" alt="image"/></div>
<p class="indent">For example, if R1 is 470 Ω, R2 is 270 Ω, and the maximum voltage of V<sub>in</sub> is 13V, then</p>
<div class="image"><img src="graphics/f0055-02.jpg" alt="image"/></div>
<p class="indent">In other words, even if your battery is fully charged and managing to provide 13V, only a maximum of 4.74V (below the critical 5V level) will find its way to the Arduino. If the input voltage is lower than this, then V<sub>out</sub> will scale proportionally. For example, if the battery voltage is 6.5V (which would indicate a bit of a problem, by the way), V<sub>out</sub> would be 2.37V.</p>
</div>
<h4 class="h4" id="ch00lev1sec65"><strong>CONSTRUCTION</strong></h4>
<p class="noindent">Remarkably, no soldering at all is needed to make this project. The only tool you need is a screwdriver.</p>
<h5 class="h5" id="ch00lev1sec66"><strong>STEP 1: PROGRAM THE ARDUINO</strong></h5>
<p class="noindent">Arduino programs, which are called <em>sketches</em>, can change whether a connection, or <em>pin</em>, on the Arduino is an input or an output. The Arduino remembers whether each pin was set to input or output, even after you disconnect it from the rest of the circuit. Thus, if one of your Arduino pins was an output the last time you used it, connecting the Arduino to new hardware that expects <a id="page_56"/>the pin to be an input could damage the Arduino or the circuit you’re connecting it to. By uploading the program to the Arduino before doing anything else, you’ll ensure that each pin functions the way your circuit expects it to.</p>
<p class="indent">You’ll find detailed instructions on getting started with the Arduino, connecting it to your computer, and uploading a sketch to it in <a href="app02.html#app02">Appendix B</a>. In this case, the sketch is called <em>Project_04_Battery_monitor</em> and can be found with all the other program files used in this book at <em><a href="http://nostarch.com/zombies/">http://nostarch.com/zombies/</a></em>.</p>
<h5 class="h5" id="ch00lev1sec67"><strong>STEP 2: BUILD THE ARDUINO SANDWICH</strong></h5>
<p class="noindent">When used with the two shields, the Arduino Uno is on the bottom, the screwshield is plugged into that, and, finally, the LCD display shield goes on top of the screwshield (<a href="ch03.html#ch03fig10">Figure 3-10</a>). The LCD shield has to be at the top of the stack or you won’t be able to see what it says!</p>
<div class="image"><img src="graphics/f03-10.jpg" alt="image"/></div>
<p class="figuret"><a id="ch03fig10">Figure 3-10:</a> An Arduino “sandwich”</p>
<p class="indent">When pushing the pins of a shield into an Arduino or the screwshield, be careful to check that all the pins meet the holes correctly so you don’t damage them. It’s quite easy for one of the pins to splay out as you are pushing the pins in.</p>
<h5 class="h5" id="ch00lev1sec68"><strong>STEP 3: ATTACH THE RESISTORS AND BUZZER</strong></h5>
<p class="noindent">You’ll attach the resistors and buzzer to the screw terminals of the screwshield (<a href="ch03.html#ch03fig11">Figure 3-11</a>).</p>
<div class="image"><a id="page_57"/><img src="graphics/f03-11.jpg" alt="image"/></div>
<p class="figuret"><a id="ch03fig11">Figure 3-11:</a> Connecting components to the screwshield</p>
<p class="indent">The two resistors can be identified either by measuring their resistance using a multimeter (see “Using a Multimeter” on <a href="app02.html#page_237">page 237</a>) or by reading the colored stripes on the resistor body. The 470 Ω resistor will have stripes of yellow, purple, and brown; the 270 Ω resistor will have red, purple, and brown stripes. In “<a href="app01.html#ch00lev1sec224">Resistor Color Codes</a>” on <a href="app01.html#page_225">page 225</a>, you will find a resistor color code table and instructions on how to identify resistors by their stripes.</p>
<p class="indent">Some buzzers will have a positive red lead and a negative black lead. If this is the case, connect the black lead to GND (ground) and the red lead to D11 on the Arduino. Other buzzers will have identical leads; if this is the case, it doesn’t matter which way around they are connected.</p>
<h4 class="h4" id="ch00lev1sec69"><strong>SOFTWARE</strong></h4>
<p class="noindent">The sketch for this program is mostly concerned with making sure that the right text is displayed on the LCD at the right time. I’ll walk you through it in full, though you don’t have to understand or follow how this sketch works to finish the project. You can just upload it exactly as it is into the Arduino board, following the steps explained in “<a href="app03.html#ch00lev1sec241">Installing the Antizombie Sketches</a>” on <a href="app03.html#page_248">page 248</a>.</p>
<p class="indent"><a id="page_58"/>If you want to learn more about Arduino programming, see <a href="app03.html#app03">Appendix C</a> or take a look at my book <em>Programming Arduino: Getting Started with Sketches</em> (McGraw-Hill, 2012).</p>
<p class="indent">The sketch starts by importing the <em>LiquidCrystal</em> library, which is responsible for controlling the LCD shield. Because this library is included as a standard part of the Arduino software, there is nothing to download and install for this library.</p>
<pre>#include &lt;LiquidCrystal.h&gt;</pre>
<p class="indent">After the library command, three constants are defined for key battery voltages.</p>
<pre>const float maxV = 12.6;<br/>const float minV = 11.7;<br/>const float warnV = 11.7;</pre>
<p class="indent">These voltages are, in order, the fully charged battery voltage, the minimum voltage that you want the battery to be allowed to discharge to, and the voltage at which the buzzer should sound. These last two are both set to 11.7V. These values are pretty standard for a lead-acid car battery, but if you use a different type of battery, you can tweak them. Because they hold decimal values, the variables are of a type called <em>float</em>. You can find out more about Arduino data types in <a href="app03.html#app03">Appendix C</a>.</p>
<p class="indent">The next few lines define constants for the Arduino pins that are used.</p>
<pre>const int buzzerPin = 11;<br/>const int voltagePin = A3;<br/>const int backlightPin = 10;<br/>const int switchPin = A0;</pre>
<p class="indent">The Arduino’s various pins are normally identified simply by a number, so these constants give them meaningful names. You don’t need to change these pin designations unless you decide to wire up your battery monitor differently.</p>
<p class="indent">The final section defines constants for the values of the resistors used in the potential divider.</p>
<pre>const float R1 = 470.0;<br/>const float R2 = 270.0;<br/>const float k = (R1 + R2) / R2;</pre>
<p class="indent"><a id="page_59"/>The constant <code>k</code> is the resulting factor the input voltage will be reduced by in order to fit into the 5V measurement range of the Arduino. The next line of code initializes the LCD display, specifying which pins are used.</p>
<pre>//                RS,E,D4,D5,D6,D7<br/>LiquidCrystal lcd(8, 9, 4, 5, 6, 7);<br/>boolean mute = false;</pre>
<p class="indent">The comment line starting with <code>//</code> just identifies which of the Arduino pin numbers on the line beneath it correspond to which pins on the LCD module. The line after that defines a <em>Boolean</em> (a value that can be true or false) variable, <code>mute</code>, which is used to mute the buzzer.</p>
<p class="indent">The setup function that comes next is run just once, when the Arduino starts. In this case, it begins by setting the backlight pin (D10) to be an input.</p>
<pre>void setup()<br/>{<br/>  // Because of a defect in common cheap LCD displays,<br/>  // backlight controlled by transistor D10 high can<br/>  // burn out Arduino pin<br/>  pinMode(backlightPin, INPUT);<br/>  lcd.begin(16, 2);<br/>  lcd.setCursor(0, 0);<br/>  lcd.print("Battery ");<br/>}</pre>
<p class="indent">The backlight pin is used only on some LCD shields, but a significant number of LCD shields have a design flaw that can destroy the Arduino they are connected to if this pin is set to an output and also set high. To be on the safe side, D10 is set to an input. The rest of the function initializes the LCD display and writes out the word <code>Battery</code>, which will be a permanent fixture of the message displayed.</p>
<p class="indent">The loop function that follows the setup function is run repeatedly. That is, as soon as all the commands in the function have been executed, the function will start again from the top.</p>
<pre>void loop()<br/>{<br/>  displayVoltage();<br/>  displayBar();<br/>  if (readVoltage() &lt; warnV &amp;&amp; ! mute)<br/>  {<br/>     tone(buzzerPin, 1000);<br/>  }<br/><a id="page_60"/><br/>  if (analogRead(switchPin) &lt; 1000) // any key pressed<br/>  {<br/>    mute = ! mute;<br/>    if (mute) noTone(buzzerPin);<br/>    delay(300);<br/>  }<br/>  delay(100);<br/>}</pre>
<p class="indent">The display is updated inside the loop function. This is also where you’ll check that the battery voltage hasn’t dropped below the warning voltage and check for key presses to toggle the battery monitor’s mute mode.</p>
<p class="indent">This loop function makes use of a number of other functions further down in the file. The first of these is <code>displayVoltage</code>.</p>
<pre>   void displayVoltage()<br/>   {<br/>     lcd.setCursor(8, 0); <br/><span class="ent">➊</span>    lcd.print(" ");<br/>     lcd.setCursor(8, 0); <br/><span class="ent">➋</span>    lcd.print(readVoltage());<br/>     lcd.setCursor(14, 0);<br/>     lcd.print("V");<br/>   }</pre>
<p class="indent">This function starts at column 8 and overwrites the eight character positions on the top line by printing eight spaces <span class="ent">➊</span>. It then moves the cursor back to column 8 and writes the battery voltage in that gap <span class="ent">➋</span> before writing the <em>V</em> character at the end of the line.</p>
<p class="indent">The <code>displayVoltage</code> function makes use of the <code>readVoltage</code> function to convert the raw reading from the Arduino’s analog input into a voltage.</p>
<pre>float readVoltage()<br/>{<br/>  int raw = analogRead(voltagePin);<br/>  float vout = (float(raw) / 1023.0) * 5.0;<br/>  float vin = (vout * k);<br/>  return vin;<br/>}</pre>
<p class="indent">Readings from an Arduino analog pin give a result between 0 and 1,023, where 0 means 0V and 1,023 means 5V. So, the value of <code>vout</code> in <code>readVoltage</code> is the output voltage of the potential divider—that is, the reduced voltage. You need to work backward to calculate the original battery voltage <code>vin</code>, then return this value to be displayed.</p>
<p class="indent">The final function in the sketch displays the bar graph showing how much power is left in the battery and, if the battery monitor is in mute mode, the <code>MUTE</code> notification.</p>
<pre><a id="page_61"/>void displayBar()<br/>{<br/>  float v = readVoltage();<br/>  float range = maxV - minV;<br/>  float fullness = (v - minV) / range;<br/><br/>  int numBars = fullness * 16;<br/>  lcd.setCursor(0, 1);<br/>  for (int i = 0; i &lt; 16; i++)<br/>  {<br/>    if (numBars &gt; i)<br/>    {<br/>      lcd.print("*");<br/>    }<br/>    else<br/>    {<br/>      lcd.print(" ");<br/>    }<br/>  }<br/>  if (mute)<br/>  {<br/>   lcd.setCursor(12, 1);<br/>   lcd.print("MUTE");<br/>  }<br/>}</pre>
<p class="indent">The <code>displayBar</code> function steps through each of the 16 character positions of the second row of the display and then displays either a <code>*</code> or a space character, depending on the measure of <code>fullness</code> of the battery.</p>
<h4 class="h4" id="ch00lev1sec70"><strong>USING THE BATTERY MONITOR</strong></h4>
<p class="noindent">As soon as you connect the battery monitor to the battery, the LCD should light up and show a readout of the battery voltage on the top row of the display. The second row of the display will show a number of <code>*</code> characters to indicate the juice remaining in the battery. Also, if you press any of the button switches below the display to disable the buzzer, the message <code>MUTE</code> should toggle on and off.</p>
<p class="indent">If your display appears blank or difficult to read, then you may need to adjust the contrast. Just use a small, flat-headed screwdriver to turn the small variable resistor at the top right of the LCD shield (<a href="ch03.html#ch03fig11">Figure 3-11</a>).</p>
<p class="indent">Now that you have the basics of power generation and lighting sorted out, turn your attention to detecting zombies. You’ll find out how to know they’re coming in <a href="ch04.html#ch04">Chapter 4</a>.<a id="page_62"/></p>
</body></html>