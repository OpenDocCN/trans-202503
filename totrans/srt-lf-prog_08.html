<html><head></head><body>
<h2 class="h2" id="ch08"><span epub:type="pagebreak" id="page_217"/><strong><span class="big">8</span><br/>LANGUAGE PROCESSING</strong></h2>
<div class="image1"><img src="../images/common.jpg" alt="Image"/></div>
<p class="noindent">It’s pretty clear that only crazy people would try to write computer programs. That’s always been true, but <em>programming languages</em> at least make the job a lot easier.</p>
<p class="indent">This chapter examines how programming languages are implemented. Its aim is to help you develop an understanding of what happens with your code. You’ll also learn how the code you write is transformed into an executable form called <em>machine language</em>.</p>
<h3 class="h3" id="ch08lev1sec1"><strong>Assembly Language</strong></h3>
<p class="noindent">We saw a machine language implementation of a program to compute Fibonacci numbers back in <a href="ch04.xhtml#ch04tab04">Table 4-4</a> on <a href="ch04.xhtml#page_108">page 108</a>. As you might imagine, figuring out all the bit combinations for instructions is pretty painful. Primitive computer programmers got tired of this and came up with a better way to write computer programs, called <em>assembly language</em>.</p>
<p class="indent"><span epub:type="pagebreak" id="page_218"/>Assembly language did a few amazing things. It let programmers use <em>mnemonics</em> for instructions so they didn’t have to memorize all the bit combinations. It allowed them to give names or <em>labels</em> to addresses. And it allowed them to include <em>comments</em> that can help other people read and understand the program.</p>
<p class="indent">A program called an <em>assembler</em> reads assembly language programs and produces <em>machine code</em> from them, filling in the values of the labels or <em>symbols</em> as it goes. This is especially helpful because it prevents dumb errors caused by moving things around.</p>
<p class="indent"><a href="ch08.xhtml#ch08list01">Listing 8-1</a> shows what the Fibonacci program from <a href="ch04.xhtml#ch04tab04">Table 4-4</a> looks like in the hypothetical assembly language from <a href="ch04.xhtml#ch04">Chapter 4</a>.</p>
<pre>          load     #0         ; zero the first number in the sequence<br/>
          store    first<br/>
          load     #1        ; set the second number in the sequence to 1<br/>
          store    second<br/>
again:    load     first     ; add the first and second numbers to get the<br/>
          add      second    ; next number in the sequence<br/>
          store    next<br/>
                             ; do something interesting with the number<br/>
          load     second    ; move the second number to be the first number<br/>
          store    first<br/>
          load     next      ; make the next number the second number<br/>
          store    second<br/>
          cmp      #200      ; are we done yet?<br/>
          ble      again     ; nope, go around again<br/>
first:    bss      1         ; where the first number is stored<br/>
second:   bss      1         ; where the second number is stored<br/>
next:     bss      1         ; where the next number is stored</pre>
<p class="listing" id="ch08list01"><em>Listing 8-1: Assembly language program to compute the Fibonacci sequence</em></p>
<p class="indent">The <code>bss</code> (which stands for <em>block started by symbol</em>) <em>pseudo-instruction</em> reserves a chunk of memory—in this case, one address—without putting anything in that location. Pseudo-instructions don’t have a direct correspondence with machine language instructions; they’re instructions to the assembler. As you can see, assembly language is much easier to deal with than machine language, but it’s still pretty tedious stuff.</p>
<p class="indent">Early programmers had to pull themselves up by their own bootstraps. There <em>was</em> no assembler to use when the first computer was made, so programmers had to write the first one the hard way, by figuring out all the bits by hand. This first assembler was quite primitive, but once it worked, it could be used to make a better one, and so on.</p>
<p class="indent">The term <em>bootstrap</em> has stuck around, although it’s often shortened to <em>boot</em>. Booting a computer often involves loading a small program, which loads a bigger one, which in turn loads an even bigger one. On early computers, people had to enter the initial bootstrap program by hand, using switches and lights on the front panel.</p>
<h3 class="h3" id="ch08lev1sec2"><span epub:type="pagebreak" id="page_219"/><strong>High-Level Languages</strong></h3>
<p class="noindent">Assembly language helped a lot, but as you can see, doing simple things with it still takes a lot of work. We’d really like to be able to use fewer words to describe more complicated tasks. Fred Brooks’s 1975 book <em>The Mythical Man-Month: Essays on Software Engineering</em> (Addison-Wesley) claims that on average, a programmer can write 3 to 10 lines of documented, debugged code per day. So a lot more work could get done if a line of code did more.</p>
<p class="indent">Enter <em>high-level languages</em>, which operate at a higher level of abstraction than assembly language. Source code in high-level languages is run through a program called a <em>compiler</em>, which translates or <em>compiles</em> it into machine language, also known as <em>object</em> code.</p>
<p class="indent">Thousands of high-level languages have been invented. Some are very general, and some are designed for specific tasks. One of the first high-level languages was called FORTRAN, which stood for “formula translator.” You could use it to easily write programs that solved formulas like <em>y</em> = <em>m</em> × <em>x</em> + <em>b</em>. <a href="ch08.xhtml#ch08list02">Listing 8-2</a> shows what our Fibonacci sequence program would look like in FORTRAN.</p>
<pre>C   SET THE INITIAL TWO SEQUENCE NUMBERS IN I and J<br/>
    I=0<br/>
    J=1<br/>
C   GET NEXT SEQUENCE NUMBER<br/>
5   K=I+J<br/>
C   DO SOMETHING INTERESTING WITH THE NUMBER<br/>
C   SHIFT THE SEQUENCE NUMBERS TO I AND J<br/>
    I=J<br/>
    J=K<br/>
C   DO IT AGAIN IF THE LAST NUMBER WAS LESS THAN 200<br/>
    IF (J .LT. 200) GOTO 5<br/>
C   ALL DONE</pre>
<p class="listing" id="ch08list02"><em>Listing 8-2: Fibonacci sequence program in FORTRAN</em></p>
<p class="indent">Quite a bit simpler than assembly language, isn’t it? Note that lines that begin with the letter <code>C</code> are comments. And although we have labels, they must be numbers. Also note that we don’t have to explicitly declare memory that we want to use—it just magically appears when we use <em>variables</em> such as <em>I</em> and <em>J</em>. FORTRAN did something interesting (or ugly, depending on your point of view) that still reverberates today. Any variable name that began with the letter <em>I</em>, <em>J</em>, <em>K</em>, <em>L</em>, <em>M</em>, or <em>N</em> was an integer, which was borrowed from the way mathematicians write proofs. Variables beginning with any other letter were floating-point, or REAL in FORTRAN-speak. Generations of former FORTRAN programmers still use <em>i</em>, <em>j</em>, <em>k</em>, <em>l</em>, <em>m</em>, and <em>n</em> or their upper-case equivalents as names for integer variables.</p>
<p class="indent">FORTRAN was a pretty cumbersome language that ran on the really big machines of the time. As smaller, cheaper machines became available (that is, ones that only took up a small room), people came up with other languages. Most of these new languages, such as BASIC (which stood for <span epub:type="pagebreak" id="page_220"/>“Beginner’s All-purpose Symbolic Instruction Code”), were variations on the FORTRAN theme. All of these languages suffered from the same problem. As programs increased in complexity, the network of line numbers and <code>GOTO</code>s became an unmanageable tangle. People would write programs with the label numbers all in order and then have to make a change that would mess it up. Many programmers started off by using labels 10 or 100 apart so that they’d have room to backfill later, but even that didn’t always work.</p>
<h3 class="h3" id="ch08lev1sec3"><strong>Structured Programming</strong></h3>
<p class="noindent">Languages like FORTRAN and BASIC are called <em>unstructured</em> because there is no structure to the way that labels and <code>GOTO</code>s are arranged. You can’t build a house by throwing a pile of lumber on the ground in real life, but you can in FORTRAN. I’m talking about original FORTRAN; over time, the language has evolved and incorporated structured programming. It’s still the most popular scientific language.</p>
<p class="indent"><em>Structured</em> programming languages were developed to address this <em>spaghetti code</em> problem by eliminating the need for the nasty <code>GOTO</code>. Some went too far. For example, Pascal got rid of it completely, resulting in a programming language that was useful only for teaching elementary structured programming. To be fair, that’s actually what it was designed to do. C, the successor to the Ken Thompson’s B, was originally developed by Dennis Ritchie at Bell Telephone Laboratories. It was very pragmatic and became one of the most widely used programming languages. A large number of later languages—including C++, Java, PHP, Python, and JavaScript—copied elements from C.</p>
<p class="indent"><a href="ch08.xhtml#ch08list03">Listing 8-3</a> shows how our Fibonacci program might appear in JavaScript. Note the absence of explicit branching.</p>
<pre>var first;   // first number<br/>
var second;  // second number<br/>
var next;    // next number in sequence<br/>
<br/>
first = 0;<br/>
second = 1;<br/>
<br/>
while ((next = first + second) &lt; 200) {<br/>
    // do something interesting with the number<br/>
    first = second;<br/>
    second = next;<br/>
}</pre>
<p class="listing" id="ch08list03"><em>Listing 8-3: JavaScript program to compute Fibonacci sequence</em></p>
<p class="indent">The statements inside the curly brackets <code>{}</code> are executed as long as the <code>while</code> condition in the parentheses is true. Execution continues after the <code>}</code> when that condition becomes false. The flow of control is cleaner, making the program easier to understand.</p>
<h3 class="h3" id="ch08lev1sec4"><span epub:type="pagebreak" id="page_221"/><strong>Lexical Analysis</strong></h3>
<p class="noindent">Now let’s look at what it takes to process a language. We’ll start with <em>lexical analysis</em>, the process of converting <em>symbols</em> (characters) into <em>tokens</em> (words).</p>
<p class="indent">A simple way of looking at lexical analysis is to say that a language has two types of tokens: words and separators. For example, using the above rules, <em>lex luthor</em> (the author of all evil programming languages) has two word tokens (<em>lex</em> and <em>luthor</em>) and one separator token (the space). <a href="ch08.xhtml#ch08fig01">Figure 8-1</a> shows a simple algorithm that divides its input into tokens.</p>
<div class="image"><a id="ch08fig01"/><img src="../images/08fig01.jpg" alt="Image"/></div>
<p class="figcap"><em>Figure 8-1: Simple lexical analysis</em></p>
<p class="indent">It’s not enough to just extract tokens; we need to classify them because practical languages have many different types of tokens, such as names, numbers, and operators. Languages typically have operators and operands, just like math, and operands can be variables or constants (numbers). The free-form nature of many languages also complicates things—for example, when separators are implied, as in <code>A+B</code> as opposed to <code>A + B</code> (note the spaces). Both forms have the same interpretation, but the first form doesn’t have any explicit separators.</p>
<p class="indent">Numeric constants are astonishingly hard to classify, even if we ignore the distinctions among octal, hexadecimal, integer, and floating-point numbers. Let’s diagram what constitutes a legitimate floating-point number. There are many ways to specify a floating-point number, including <code>1.</code>, <code>.1</code>, <code>1.2</code>, <code>+1.2</code>, <code>–.1</code>, <code>1e5</code>, <code>1e+5</code>, <code>1e–5</code>, and <code>1.2E5</code>, as shown in <a href="ch08.xhtml#ch08fig02">Figure 8-2</a>.</p>
<span epub:type="pagebreak" id="page_222"/>
<div class="image"><a id="ch08fig02"/><img src="../images/08fig02.jpg" alt="Image"/></div>
<p class="figcap"><em>Figure 8-2: Diagram for floating-point numbers</em></p>
<p class="indent">We start at the bubble labeled 1. A <code>+</code> or <code>–</code> character brings us to bubble 2, while a <code>.</code> sends us to bubble 4. We leave bubble 2 for bubble 4 when we get a <code>.</code> character, but we go to bubble 3 when we receive a digit. Bubbles 3 and 4 accumulate digits. We’re done if we get a character for which no transition is shown. For example, if we received a space while at any of the bubbles, we’d be done. Of course, leaving bubble 2 without a digit or decimal point, bubble 6 without a digit, or bubble 5 without a sign or digit is an error because it doesn’t produce a complete floating-point number. These paths are absent from the diagram for simplicity’s sake.</p>
<p class="indent">This is a lot like trying to find treasure using a pirate map. As long as you’re following directions, you can get from one place to another. If you don’t follow directions—for example, with a Z at bubble 1—you fall off the map and get lost.</p>
<p class="indent">You could view <a href="ch08.xhtml#ch08fig02">Figure 8-2</a> as the specification for floating-point numbers and write software to implement it. There are other, more formal ways to write specifications, however, such as Backus-Naur form.</p>
<div class="sidebar">
<p class="sidebart" id="ch08sb01">BACKUS-NAUR FORM</p>
<p class="spara"><em>Backus-Naur form (BNF)</em> has its roots in the work of Indian Sanskrit scholar P<span class="ent">āṇ</span>ini (approximately fifth century <small>BCE</small>). BNF is named after American computer scientist John Backus (1924–2007), who was also the inventor of FORTRAN, and Danish computer scientist Peter Naur (1928–2016). It’s a formal way to specify languages. We’re not going to go into great detail about it here, but it’s something you should be familiar with because it’s used in the <em>RFC</em> (request for comments) documents that define internet protocols, among other things. Here’s the BNF for a floating-point number:</p>
<pre>&lt;digit&gt;              ::= "0" | "1" | "2" | "3" | "4" | "5" | "6" | "7" | "8" | "9"<br/>
&lt;digits&gt;             ::= &lt;digit&gt; | &lt;digits&gt; &lt;digit&gt;<br/>
<br/>
&lt;e&gt;                  ::= "e" | "E"<br/>
&lt;sign&gt;               ::= "+" | "-"<br/>
&lt;optional-sign&gt;      ::= &lt;sign&gt; | ""<br/>
&lt;exponent&gt;           ::= &lt;e&gt; &lt;optional-sign&gt; &lt;digits&gt;<br/>
&lt;optional-exponent&gt;  ::= &lt;exponent&gt; | ""<br/>
<br/>
&lt;mantissa&gt;           ::= &lt;digits&gt; | &lt;digits&gt; "." | "." &lt;digits&gt; | &lt;digits&gt; "." &lt;digits&gt;<br/>
&lt;floating-point&gt;     ::= &lt;optional-sign&gt; &lt;mantissa&gt; &lt;optional-exponent&gt;</pre>
<p class="sparai">Things on the left of the <code>::=</code> can be substituted for things on the right. The <code>|</code> indicates a choice, and things inside of quotes are literals, meaning that they must appear exactly as written.</p>
</div>
<h4 class="h4" id="ch08lev2sec1"><span epub:type="pagebreak" id="page_223"/><strong><em>State Machines</em></strong></h4>
<p class="noindent">Based just on the complexity of numbers, you can imagine that it would take a substantial amount of special case code to extract language tokens from input. <a href="ch08.xhtml#ch08fig02">Figure 8-2</a> gave us a hint that there’s another approach. We can construct a <em>state machine</em>, which consists of a set of states and a list of what causes a transition from one state to another—exactly what we saw in <a href="ch08.xhtml#ch08fig02">Figure 8-2</a>. We can arrange this information as shown in <a href="ch08.xhtml#ch08tab01">Table 8-1</a>.</p>
<p class="tabcap" id="ch08tab01"><strong>Table 8-1:</strong> State Table for Floating-Point Numbers</p>
<table class="topbot-d">
<colgroup>
<col style="width:12%"/>
<col style="width:12%"/>
<col style="width:12%"/>
<col style="width:12%"/>
<col style="width:12%"/>
<col style="width:12%"/>
<col style="width:14%"/>
<col style="width:14%"/>
</colgroup>
<thead>
<tr>
<td style="vertical-align: top;" class="tablel-h" rowspan="2"><p class="tab_th"><strong>Input</strong></p></td>
<td style="vertical-align: top;" class="table-h" colspan="7"><p class="tab_thc"><strong>State</strong></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>1</strong></p></td>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>2</strong></p></td>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>3</strong></p></td>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>4</strong></p></td>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>5</strong></p></td>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>6</strong></p></td>
<td style="vertical-align: top;" class="table-h"><p class="tab_th"><strong>7</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="tablel-v"><p class="taba">0</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">4</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">7</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">7</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">7</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="tablel-b"><p class="taba">1</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">4</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">7</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">7</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">7</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="tablel-v"><p class="taba">2</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">4</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">7</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">7</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">7</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="tablel-b"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">4</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">7</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">7</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">7</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="tablel-v"><p class="taba">4</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">4</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">7</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">7</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">7</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="tablel-b"><p class="taba">5</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">4</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">7</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">7</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">7</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="tablel-v"><p class="taba">6</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">4</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">7</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">7</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">7</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="tablel-b"><p class="taba">7</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">4</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">7</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">7</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">7</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="tablel-v"><p class="taba">8</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">4</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">7</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">7</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">7</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="tablel-b"><p class="taba">9</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">3</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">4</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">7</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">7</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">7</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="tablel-v"><p class="taba">e</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">error</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">error</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">5</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">5</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">error</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">error</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">done</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="tablel-b"><p class="taba">E</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">error</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">error</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">5</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">5</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">error</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">error</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">done</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="tablel-v"><p class="taba">+</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">2</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">error</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">done</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">done</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">6</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">error</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">done</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="tablel-b"><p class="taba">–</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">2</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">error</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">done</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">done</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">6</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">error</p></td>
<td style="vertical-align: top;" class="table-b"><p class="taba">done</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="tablel-v"><p class="taba">.</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">4</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">4</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">4</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">done</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">error</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">error</p></td>
<td style="vertical-align: top;" class="table-v"><p class="taba">done</p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="tablel-ba"><p class="taba">other</p></td>
<td style="vertical-align: top;" class="table-ba"><p class="taba">error</p></td>
<td style="vertical-align: top;" class="table-ba"><p class="taba">error</p></td>
<td style="vertical-align: top;" class="table-ba"><p class="taba">done</p></td>
<td style="vertical-align: top;" class="table-ba"><p class="taba">done</p></td>
<td style="vertical-align: top;" class="table-ba"><p class="taba">error</p></td>
<td style="vertical-align: top;" class="table-ba"><p class="taba">error</p></td>
<td style="vertical-align: top;" class="table-ba"><p class="taba">done</p></td>
</tr>
</tbody>
</table>
<p class="indent"><span epub:type="pagebreak" id="page_224"/>Looking at the table, you can see that when we’re in state 1, digits move us to state 3, <code>e</code> or <code>E</code> moves us to state 5, <code>+</code> or <code>–</code> to state 2, and <code>.</code> to state 4—anything else is an error.</p>
<p class="indent">Using a state machine allows us to classify the input using a simple piece of code, as shown in <a href="ch08.xhtml#ch08list04">Listing 8-4</a>. Let’s use <a href="ch08.xhtml#ch08tab01">Table 8-1</a>, replacing <code>done</code> with <code>0</code> and <code>error</code> with <code>-1</code>. For simplicity, we’ll have an <code>other</code> row in the table for each of the other characters.</p>
<pre>state = 1;<br/>
while (state &gt; 0)<br/>
    state = state_table[state][next_character];</pre>
<p class="listing" id="ch08list04"><em>Listing 8-4: Using a state machine</em></p>
<p class="indent">This approach could easily be expanded to other types of tokens. Rather than have a single value for <code>done</code>, we could have a different value for each type of token.</p>
<h4 class="h4" id="ch08lev2sec2"><strong><em>Regular Expressions</em></strong></h4>
<p class="noindent">Building tables like <a href="ch08.xhtml#ch08tab01">Table 8-1</a> from diagrams like <a href="ch08.xhtml#ch08fig02">Figure 8-2</a> is very cumbersome and error-prone for complicated languages. The solution is to create languages for specifying languages. American mathematician Stephen Cole Kleene (1909–1994) supplied the mathematical foundation for this approach way back in 1956. Ken Thompson first converted it into software in 1968 as part of a text editor and then created the UNIX <code>grep</code> (which stands for “globally search a regular expression and print”) utility in 1974. This popularized the term <em>regular expression</em>, which is now ubiquitous. Regular expressions are languages themselves, and of course there are now several incompatible regular expression languages. Regular expressions are a mainstay of <em>pattern matching</em>. <a href="ch08.xhtml#ch08fig03">Figure 8-3</a> shows a regular expression that matches the pattern for a floating-point number.</p>
<div class="image"><a id="ch08fig03"/><img src="../images/08fig03.jpg" alt="Image"/></div>
<p class="figcap"><em>Figure 8-3: Regular expression for floating-point number</em></p>
<p class="indent"><span epub:type="pagebreak" id="page_225"/>This looks like gibberish but really only relies on a few simple rules. It’s processed from left to right, meaning that the expression <code>abc</code> would match the string of characters “abc”. If something in the pattern is followed by <code>?</code>, it means zero or one of those things, <code>*</code> means zero or more, and <code>+</code> means one or more. A set of characters enclosed in square brackets matches any single character in that set, so <code>[abc]</code> matches <code>a</code>, <code>b</code>, or <code>c</code>. The <code>.</code> matches any single character and so needs to be <em>escaped</em> with a backslash (<code>\</code>) so that it matches the <code>.</code> character only. The <code>|</code> means either the thing on the left or the thing on the right. Parentheses <code>()</code> are for grouping, just like in math.</p>
<p class="indent">Reading from left to right, we start with an optional plus or minus sign. This is followed by either zero or more digits, an optional decimal point, and one or more digits (which handles cases like <code>1.2</code> and <code>.2</code>), or by one or more digits, an optional decimal point, and zero or more digits (which handles the <code>1</code> and <code>1.</code> cases). This is followed by the exponent, which begins with an <code>E</code> or <code>e</code>, followed by an optional sign and one or more digits. Not as horrible as it first looked, is it?</p>
<p class="indent">Having a regular expression language that processed input into tokens would be more useful if it automatically generated state tables. And we have one, thanks again to research at Bell Telephone Laboratories. In 1975, American physicist Mike Lesk—along with intern Eric Schmidt, who today is executive chairman of Google’s parent company, Alphabet—wrote a program called <code>lex</code>, short for “lexical analyzer.” As The Beatles said in “Penny Lane:” “It’s a <em>Kleene</em> machine.” An open source version called <code>flex</code> was later produced by the GNU project. These tools do exactly what we want. They produce a state table driven program that executes user-supplied program fragments when input matches regular expressions. For example, the simple <code>lex</code> program fragment in <a href="ch08.xhtml#ch08list05">Listing 8-5</a> prints <code>ah</code> whenever it encounters either <code>ar</code> or <code>er</code> in the input and prints <code>er</code> whenever it encounters an <code>a</code> at the end of a word.</p>
<pre>[ae]r       printf("ah");<br/>
a/[ .,;!?]  printf("er");</pre>
<p class="listing" id="ch08list05"><em>Listing 8-5: Bostonian lex program fragment</em></p>
<p class="indent">The <code>/</code> in the second pattern means “only match the thing on its left if it is followed by the thing on its right.” Things not matched are just printed. You can use this program to convert regular American English to Bostonian: for example, inputting the text <code>Park the car in Harvard yard and sit on the sofa</code> would produce <code>Pahk the cah in Hahvahd yahd and sit on the sofer</code> as output.</p>
<p class="indent">Classifying tokens is a piece of cake in <code>lex</code>. For example, <a href="ch08.xhtml#ch08list06">Listing 8-6</a> shows some <code>lex</code> that matches all of our number forms plus variable names and some operators. Instead of printing out what we find, we return some values defined elsewhere for each type of token. Note that several of the characters have special meaning to <code>lex</code> and therefore require the backslash escape character so that they’re treated as literals.</p>
<span epub:type="pagebreak" id="page_226"/>
<pre>0[0-7]*                                                       return (INTEGER);<br/>
[+-]?[0-9]+                                                   return (INTEGER);<br/>
[+-]?(([0-9]*\.?[0-9]+)|([0-9]+\.?[0-9]*))([Ee][+-]?[0-9]+)?  return (FLOAT);<br/>
0x[0-9a-fA-F]+                                                return (INTEGER);<br/>
[A-Za-z][A-Za-z0-9]*                                          return (VARIABLE);<br/>
\+                                                            return (PLUS);<br/>
-                                                             return (MINUS);<br/>
\*                                                            return (TIMES);<br/>
\/                                                            return (DIVIDE);<br/>
=                                                             return (EQUALS);</pre>
<p class="listing" id="ch08list06"><em>Listing 8-6: Classifying tokens using <span class="codeitalic">lex</span></em></p>
<p class="indent">Not shown in the listing is the mechanism by which <code>lex</code> supplies the actual values of the tokens. When we find a number, we need to know its value; likewise, when we find a variable name, we need to know that name.</p>
<p class="indent">Note that <code>lex</code> doesn’t work for all languages. As computer scientist Stephen C. Johnson (introduced shortly) explained, “Lex can be easily used to produce quite complicated lexical analyzers, but there remain some languages (such as FORTRAN) which do not fit any theoretical framework, and whose lexical analyzers must be crafted by hand.”</p>
<h3 class="h3" id="ch08lev1sec5"><strong>From Words to Sentences</strong></h3>
<p class="noindent">So far, we’ve seen how we can turn sequences of characters into words. But that’s not enough for a language. We now need to turn those words into sentences according to some <em>grammar</em>.</p>
<p class="indent">Let’s use the tokens from <a href="ch08.xhtml#ch08list06">Listing 8-6</a> to create a simple four-function calculator. Expressions such as <code>1 + 2</code> and <code>a = 5</code> are legal, whereas <code>1 + + + 2</code> isn’t. We once again find ourselves in need of pattern matching, but this time for token types. Maybe somebody has already thought about this.</p>
<p class="indent">That somebody would be Stephen C. Johnson, who also—unsurprisingly—worked at Bell Labs. He created <code>yacc</code> (for “yet another compiler compiler”) in the early 1970s. The name should give you an idea of how many people were playing with these sorts of things back then. It’s still in use today; an open source version, called <code>bison</code>, is available from the GNU project. Just like <code>lex</code>, <code>yacc</code> and <code>bison</code> generate state tables and the code to operate on them.</p>
<p class="indent">The program <code>yacc</code> generates is a <em>shift-reduce</em> parser using a stack (see “<a href="ch05.xhtml#ch05lev1sec3">Stacks</a>” on <a href="ch05.xhtml#page_122">page 122</a>). In this context, <em>shift</em> means pushing a token onto the stack, and <em>reduce</em> means replacing a matched set of tokens on the stack with a token for that set. Look at the BNF for the calculator in <a href="ch08.xhtml#ch08list07">Listing 8-7</a>—it uses the token values produced by <code>lex</code> in <a href="ch08.xhtml#ch08list06">Listing 8-6</a>.</p>
<pre>&lt;operator&gt;     ::= PLUS | MINUS | TIMES | DIVIDE<br/>
&lt;operand&gt;      ::= INTEGER | FLOAT | VARIABLE<br/>
&lt;expression&gt;   ::= &lt;operand&gt; | &lt;expression&gt; PLUS &lt;operand&gt;<br/>
                             | &lt;expression&gt; MINUS &lt;operand&gt;<br/>
                             | &lt;expression&gt; TIMES &lt;operand&gt;<br/>
                             | &lt;expression&gt; DIVIDE &lt;operand&gt;<br/>
<span epub:type="pagebreak" id="page_227"/>&lt;assignment&gt;   ::= &lt;variable&gt; EQUALS &lt;expression&gt;<br/>
&lt;statement&gt;    ::= &lt;expression&gt; | &lt;assignment&gt;<br/>
&lt;statements&gt;   ::= "" | &lt;statements&gt; &lt;statement&gt;<br/>
&lt;calculator&gt;   ::= &lt;statements&gt;</pre>
<p class="listing" id="ch08list07"><em>Listing 8-7: Simple calculator BNF</em></p>
<p class="indent">Shift-reduce is easy to understand once you see it in action. Look at what happens when our simple calculator is presented with the input <code>4 + 5 – 3</code> in <a href="ch08.xhtml#ch08fig04">Figure 8-4</a>. Referring back to “<a href="ch05.xhtml#ch05sb01">Different Equation Notations</a>” on <a href="ch05.xhtml#page_125">page 125</a>, you can see that processing infix notion equations requires a deeper stack than postfix (RPN) requires because more tokens, such as parentheses, must be shifted before anything can be reduced.</p>
<div class="image"><a id="ch08fig04"/><img src="../images/08fig04.jpg" alt="Image"/></div>
<p class="figcap"><em>Figure 8-4: Shift-reduce in action</em></p>
<p class="indent"><a href="ch08.xhtml#ch08list08">Listing 8-8</a> shows what our calculator would look like when coded in <code>yacc</code>. Note the similarity to the BNF. This is for illustration only; it’s not a fully working example, as that would introduce far too many nitpicky distractions.</p>
<pre>calculator  : statements<br/>
            ;<br/>
<br/>
statements  : /* empty */<br/>
            | statement statements<br/>
            ;<br/>
<br/>
operand     : INTEGER<br/>
            | FLOAT<br/>
            | VARIABLE<br/>
            ;<br/>
<br/>
expression  : expression PLUS operand<br/>
            | expression MINUS operand<br/>
            | expression TIMES operand<br/>
            | expression DIVIDE operand<br/>
            | operand<br/>
            ;<br/>
<br/>
assignment  : VARIABLE EQUALS expression<br/>
            ;<br/>
<br/>
statement   : expression<br/>
            | assignment<br/>
            ;</pre>
<p class="listing" id="ch08list08"><em>Listing 8-8: Partial <span class="codeitalic">yacc</span> for a simple calculator</em></p>
<h3 class="h3" id="ch08lev1sec6"><span epub:type="pagebreak" id="page_228"/><strong>The Language-of-the-Day Club</strong></h3>
<p class="noindent">Languages used to be difficult. In 1977, Canadian computer scientist Alfred Aho and American computer scientist Jeffrey Ullman at Bell Labs published <em>Principles of Compiler Design</em>, one of the first computer-typeset books published using the <code>troff</code> typesetting language. One can summarize the book as follows: “languages are hard, and you had better dive into the heavy math, set theory, and so on.” The second edition, published in 1986 along with Indian computer scientist Ravi Sethi, had a completely different feel. Its attitude was more like “languages are a done thing, and here’s how to do them.” And people did.</p>
<p class="indent">That edition popularized <code>lex</code> and <code>yacc</code>. All of a sudden, there were languages for everything—and not just programming languages. One of my favorite small languages was <code>chem</code>, by Canadian computer scientist Brian Kernighan at Bell Labs, which drew pretty chemical structure diagrams from input like <code>C double bond O</code>. The diagrams in the book you’re reading, in fact, were created using Brian Kernighan’s picture-drawing language <code>pic</code>.</p>
<p class="indent">Creating new languages is fun. Of course, people started making new languages without understanding their history and reintroduced old mistakes. For example, many consider the handling of <em>whitespace</em> (the spaces between words) in the Ruby language to be a replay of a mistake in the original C language that was fixed long ago. (Note that one of the classic ways to deal with a mistake is to call it a feature.)</p>
<p class="indent">The result of all this history is that a huge number of languages are now available. Most don’t really add much value and are just demonstrations of the designer’s taste. It’s worth paying attention to <em>domain-specific</em> languages, particularly <em>little languages</em> such as <code>pic</code> and <code>chem</code>, to see how specific applications are addressed. American computer scientist Jon Bentley published a wonderful column about little languages called “Programming Pearls” in <em>Communications of the ACM</em> back in 1986. These columns were collected and published in updated book form in 1999 as <em>Programming Pearls</em> (Addison-Wesley).</p>
<h3 class="h3" id="ch08lev1sec7"><strong>Parse Trees</strong></h3>
<p class="noindent">Earlier I talked about compiling high-level languages, but that’s not the only option. High-level languages can be compiled or <em>interpreted</em>. The choice is not a function of the design of the language but rather of its implementation.</p>
<p class="indent">Compiled languages produce machine code like you saw back in <a href="ch04.xhtml#ch04tab04">Table 4-4</a> <a href="ch04.xhtml#page_108">page 108</a>. The compiler takes the source code and converts it into machine language for a particular machine. Many compilers allow you to compile the same program for different target machines. Once a program is compiled, it’s ready to run.</p>
<p class="indent">Interpreted languages don’t result in machine language for a real machine (“real” as in hardware). Instead, interpreted languages run on <span epub:type="pagebreak" id="page_229"/><em>virtual machines</em>, which are machines written in software. They may have their own machine language, but it’s not a computer instruction set implemented in hardware. Note that the term <em>virtual machine</em> has become overloaded recently; I’m using it to mean an abstract computing machine. Some interpreted languages are executed directly by the <em>interpreter</em>. Others are compiled into an <em>intermediate language</em> for later interpretation.</p>
<p class="indent">In general, compiled code is faster because once it’s compiled, it’s in machine language. It’s like translating a book. Once it’s done, anyone who speaks that language can read it. Interpreted code is ephemeral, like someone reading a book aloud while translating it into the listener’s language. If another person later wants the book read to them in their own language, it must be translated again. However, interpreted code allows languages to have features that are really difficult to build in hardware. Computers are fast enough that we can often afford the speed penalty that comes with interpreters.</p>
<p class="indent"><a href="ch08.xhtml#ch08fig04">Figure 8-4</a> depicted the calculator directly executing the input. Although this is fine for something like a calculator, it skips a major step used for compilers and interpreters. For those cases, we construct a <em>parse tree</em>, which is a DAG (directed acyclic graph) data structure from the calculator grammar. We’ll build this tree out of node structures, as depicted in <a href="ch08.xhtml#ch08fig05">Figure 8-5</a>.</p>
<div class="image"><a id="ch08fig05"/><img src="../images/08fig05.jpg" alt="Image"/></div>
<p class="figcap"><em>Figure 8-5: Parse tree node layout</em></p>
<p class="indent">Each node includes a <code>code</code> that indicates the type of node. There is also an array of leaves; the interpretation of each <code>leaf</code> is determined by the <code>code</code>. Each <code>leaf</code> is a union since it can hold more than one type of data. We’re using C language syntax for the member naming, so, for example, <code>.i</code> is used if we’re interpreting a <code>leaf</code> as an integer.</p>
<p class="indent">We’ll assume the existence of a <code>makenode</code> function that makes new nodes. It takes a <code>leaf</code> count as its first argument, a <code>code</code> as its second, and the values for each <code>leaf</code> afterward.</p>
<p class="indent">Let’s flesh out the code from <a href="ch08.xhtml#ch08list08">Listing 8-8</a> a bit more while still omitting some of the picky details. To keep things simple, we’ll only handle integer numbers. What was missing earlier was code to execute when matching grammar rules. In <code>yacc</code>, the value of each of the right-hand-side elements is available as <code>$1</code>, <code>$2</code>, and so on, and <code>$$</code> is what gets returned by the rule. <a href="ch08.xhtml#ch08list09">Listing 8-9</a> shows a more complete version of our <code>yacc</code> calculator.</p>
<span epub:type="pagebreak" id="page_230"/>
<pre>calculator      : statements                    { do_something_with($1); }<br/>
                ;<br/>
statements      : /* empty */<br/>
                | statement statements          { $$.n = makenode(2, LIST, $1, $2); }<br/>
                ;<br/>
operand         : INTEGER                       { $$ = makenode(1, INTEGER, $1); }<br/>
                | VARIABLE                      { $$ = makenode(1, VARIABLE, $1); }<br/>
                ;<br/>
expression      : expression PLUS operand       { $$.n = makenode(2, PLUS, $1, $3); }<br/>
                | expression MINUS operand      { $$.n = makenode(2, MINUS, $1, $3); }<br/>
                | expression TIMES operand      { $$.n = makenode(2, TIMES, $1, $3); }<br/>
                | expression DIVIDE operand     { $$.n = makenode(2, DIVIDE, $1, $3); }<br/>
                | operand                       { $$ = $1; }<br/>
                ;<br/>
assignment      : VARIABLE EQUALS expression    { $$.n = makenode(2, EQUALS, $1, $3); }<br/>
                ;<br/>
statement       : expression                    { $$ = $1; }<br/>
                | assignment                    { $$ = $1; }<br/>
                ;</pre>
<p class="listing" id="ch08list09"><em>Listing 8-9: Simple calculator parse tree construction using <span class="codeitalic">yacc</span></em></p>
<p class="indent">Here, all the simple rules just return their values. The more complicated rules for <code>statements</code>, <code>expression</code>, and <code>assignment</code> create a node, attach the children, and return that node. <a href="ch08.xhtml#ch08fig06">Figure 8-6</a> shows what gets produced for some sample input.</p>
<div class="image"><a id="ch08fig06"/><img src="../images/08fig06.jpg" alt="Image"/></div>
<p class="figcap"><em>Figure 8-6: Simple calculator parse tree</em></p>
<p class="indent">As you can see, the code generates a tree. At the top level, we use the <code>calculator</code> rule to create a linked list of statements out of tree nodes. The remainder of the tree consists of <code>statement</code> nodes that contain the <code>operator</code> and <code>operand</code>s.</p>
<h3 class="h3" id="ch08lev1sec8"><span epub:type="pagebreak" id="page_231"/><strong>Interpreters</strong></h3>
<p class="noindent"><a href="ch08.xhtml#ch08list09">Listing 8-9</a> includes a mysterious <code>do_something_with</code> function invocation that is passed the root of the parse tree. That function causes an interpreter to “execute” the parse tree. The first part of this execution is the linked-list traversal, as shown in <a href="ch08.xhtml#ch08fig07">Figure 8-7</a>.</p>
<p class="indent">The second part is the evaluation, which we do recursively using depth-first traversal. This function is diagrammed in <a href="ch08.xhtml#ch08fig08">Figure 8-8</a>.</p>
<div class="image"><a id="ch08fig07"/><img src="../images/08fig07.jpg" alt="Image"/></div>
<p class="figcap"><em>Figure 8-7: Parse tree linked-list traversal</em></p>
<div class="image"><a id="ch08fig08"/><img src="../images/08fig08.jpg" alt="Image"/></div>
<p class="figcap"><em>Figure 8-8: Parse tree evaluation</em></p>
<p class="indent"><span epub:type="pagebreak" id="page_232"/>As you can see, it’s easy to decide what to do since we have a <code>code</code> in our <code>node</code>. Observe that we need an additional function to store a variable (symbol) name and value in a <em>symbol table</em> and another to look up the value associated with a variable name. These are commonly implemented using hash tables (see “<a href="ch07.xhtml#ch07lev1sec19">Making a Hash of Things</a>” on <a href="ch07.xhtml#page_213">page 213</a>).</p>
<p class="indent">Gluing the list traversal and evaluation code into <code>yacc</code> allows us to immediately execute the parse tree. Another option is to save the parse tree in a file where it can be read and executed later. This is how languages such as Java and Python work. For all intents and purposes, this is a set of machine language instructions, but for a machine implemented in software instead of hardware. A program that executes the saved parse tree must exist for every target machine. Often the same interpreter source code can be compiled and used for multiple targets.</p>
<p class="indent"><a href="ch08.xhtml#ch08fig09">Figure 8-9</a> summarizes interpreters.</p>
<p class="indent">The front end generates the parse tree, which is represented by some <em>intermediate language</em>, and the back ends are for various machines to execute that language in their target environments.</p>
<div class="image"><a id="ch08fig09"/><img src="../images/08fig09.jpg" alt="Image"/></div>
<p class="figcap"><em>Figure 8-9: Interpreter structure</em></p>
<h3 class="h3" id="ch08lev1sec9"><strong>Compilers</strong></h3>
<p class="noindent">Compilers look a lot like interpreters, but they have code generators instead of backend execution code, as shown in <a href="ch08.xhtml#ch08fig10">Figure 8-10</a>.</p>
<div class="image"><a id="ch08fig10"/><img src="../images/08fig10.jpg" alt="Image"/></div>
<p class="figcap"><em>Figure 8-10: Compiler structure</em></p>
<p class="indent"><span epub:type="pagebreak" id="page_233"/>A <em>code generator</em> generates machine language for a particular target machine. The tools for some languages, such as C, can generate the actual assembly language (see “<a href="ch08.xhtml#ch08lev1sec1">Assembly Language</a>” on <a href="ch08.xhtml#page_217">page 217</a>) for the target machine, and the assembly language is then run through that machine’s assembler to produce machine language.</p>
<p class="indent">A code generator looks exactly like the parse tree traversal and evaluation we saw in <a href="ch08.xhtml#ch08fig07">Figures 8-7</a> and <a href="ch08.xhtml#ch08fig08">8-8</a>. The difference is that the rectangles in <a href="ch08.xhtml#ch08fig08">Figure 8-8</a> are replaced by ones that generate assembly language instead of executing the parse tree. A simplified version of a code generator is shown in <a href="ch08.xhtml#ch08fig11">Figure 8-11</a>; things shown in bold monospace font (like <span class="codestrong">add tmp</span>) are emitted machine language instructions for our toy machine from <a href="ch04.xhtml#ch04">Chapter 4</a>. Note that the machine there didn’t have multiply and divide instructions but, for this example, we pretend that it does.</p>
<div class="image"><a id="ch08fig11"/><img src="../images/08fig11.jpg" alt="Image"/></div>
<p class="figcap"><em>Figure 8-11: Assembler generation from parse tree</em></p>
<p class="indent">Applying <a href="ch08.xhtml#ch08fig11">Figure 8-11</a> to the parse tree in <a href="ch08.xhtml#ch08fig06">Figure 8-6</a>, we get the assembly language program shown in <a href="ch08.xhtml#ch08list10">Listing 8-10</a>.</p>
<span epub:type="pagebreak" id="page_234"/>
<pre>                           ; first list element<br/>
       load      #3        ; grab the integer 3<br/>
       store     tmp       ; save it away<br/>
       load      #2        ; grab the integer 2<br/>
       mul       tmp       ; multiply the values subtree nodes<br/>
       store     tmp       ; save it away<br/>
       load      #1        ; grab the integer 1<br/>
       add       tmp       ; add it to the result of 2 times 3<br/>
       store     tmp       ; save it away<br/>
                           ; second list element<br/>
       load      #5        ; grab the integer 5<br/>
       store     foo       ; save it in the space for the "foo" variable<br/>
       store     tmp       ; save it away<br/>
                           ; third list element<br/>
       load      foo       ; get contents of "foo" variable<br/>
       store     tmp       ; save it away<br/>
       load      #6        ; grab the integer 6<br/>
       div       tmp       ; divide them<br/>
       store     tmp       ; save it away<br/>
tmp:   bss       1         ; storage space for temporary variable<br/>
foo:   bss       1         ; storage space for "foo" variable</pre>
<p class="listing" id="ch08list10"><em>Listing 8-10: Machine language output from code generator</em></p>
<p class="indent">As you can see, this generates fairly bad-looking code; there are a lot of unnecessary loads and stores. But what can you expect from a contrived simple example? This code would be much improved via optimization, which is discussed in the next section.</p>
<p class="indent">This code can be executed once it’s assembled into machine language. It will run much faster than the interpreted version because it’s a much smaller and more efficient piece of code.</p>
<h3 class="h3" id="ch08lev1sec10"><strong>Optimization</strong></h3>
<p class="noindent">Many language tools include an additional step called an <em>optimizer</em> between the parse tree and the code generator. The optimizer analyzes the parse tree and performs transformations that result in more efficient code. For example, an optimizer might notice that all the operands in the parse tree on the left in <a href="ch08.xhtml#ch08fig12">Figure 8-12</a> are constants. It can then evaluate the expression in advance at compile time so that evaluation doesn’t have to be done at runtime.</p>
<div class="image"><a id="ch08fig12"/><img src="../images/08fig12.jpg" alt="Image"/></div>
<p class="figcap"><em>Figure 8-12: Optimizing a parse tree</em></p>
<p class="indent"><span epub:type="pagebreak" id="page_235"/>The preceding example is trivial because our example calculator doesn’t include any way to do conditional branching. Optimizers have a whole bag of tricks. For example, consider the code shown in <a href="ch08.xhtml#ch08list11">Listing 8-11</a> (which happens to be in C).</p>
<pre>for (i = 0; i &lt; 10; i++) {<br/>
    x = a + b;<br/>
    result[i] = 4 * i + x * x;<br/>
}</pre>
<p class="listing" id="ch08list11"><em>Listing 8-11: C loop code with assignment in loop</em></p>
<p class="indent"><a href="ch08.xhtml#ch08list12">Listing 8-12</a> shows how an optimizer might restructure it.</p>
<pre>x = a + b;<br/>
optimizer_created_temporary_variable = x * x;<br/>
for (i = 0; i &lt; 10; i++) {<br/>
    result[i] = 4 * i + optimizer_created_temporary_variable;<br/>
}</pre>
<p class="listing" id="ch08list12"><em>Listing 8-12: Loop code with loop invariant optimization</em></p>
<p class="indent">This example gives the same results as <a href="ch08.xhtml#ch08list11">Listing 8-11</a> but is more efficient. The optimizer determined that <code>a + b</code> was <em>loop invariant</em>, meaning that its value didn’t change inside the loop. The optimizer moved it outside the loop so it would need to be computed only once instead of 10 times. It also determined that <code>x * x</code> was constant inside the loop and moved that outside.</p>
<p class="indent"><a href="ch08.xhtml#ch08list13">Listing 8-13</a> shows another optimizer trick called <em>strength reduction</em>, which is the process of replacing expensive operations with cheaper ones—in this case, multiplication with addition.</p>
<pre>x = a + b;<br/>
optimizer_created_temporary_variable = x * x;<br/>
optimizer_created_4_times_i = 0;<br/>
for (i = 0; i &lt; 10; i++) {<br/>
    result[i] = optimizer_created_4_times_i + optimizer_created_temporary_variable;<br/>
    optimizer_created_4_times_i = optimizer_created_4_times_i + 4;<br/>
}</pre>
<p class="listing" id="ch08list13"><em>Listing 8-13: C loop code with loop-invariant optimization and strength reduction</em></p>
<p class="indent">Strength reduction could also take advantage of relative addressing to make the calculation of <code>result[i]</code> more efficient. Going back to <a href="ch07.xhtml#ch07fig02">Figure 7-2</a>, <code>result[i]</code> is the address of <code>result</code> plus <code>i</code> times the size of the array element. Just like with the <code>optimizer_created_4_times_i</code>, we could start with the address of <code>result</code> and add the size of the array element on each loop iteration instead of using a slower multiplication.</p>
<h3 class="h3" id="ch08lev1sec11"><span epub:type="pagebreak" id="page_236"/><strong>Be Careful with Hardware</strong></h3>
<p class="noindent">Optimizers are wonderful, but they can cause unexpected problems with code that manipulates hardware. <a href="ch08.xhtml#ch08list14">Listing 8-14</a> shows a variable that’s actually a hardware register that turns on a light when bit 0 is set, like we saw back in <a href="ch06.xhtml#ch06fig01">Figure 6-1</a>.</p>
<pre>void<br/>
lights_on()<br/>
{<br/>
    PORTB = 0x01;<br/>
    return;<br/>
}</pre>
<p class="listing" id="ch08list14"><em>Listing 8-14: Example of code that shouldn’t be optimized</em></p>
<p class="indent">This looks great, but what’s the optimizer going to do? It will say, “Hey, this is being written but never read, so I can just get rid of it.” Likewise, say we have the code in <a href="ch08.xhtml#ch08list15">Listing 8-15</a>, which turns on the light and then tests to see whether or not it’s on. The optimizer would likely just rewrite the function to return 0x01 without ever storing it in PORTB.</p>
<pre>unsigned int<br/>
lights_on()<br/>
{<br/>
    PORTB = 0x01;<br/>
    return (PORTB);<br/>
}</pre>
<p class="listing" id="ch08list15"><em>Listing 8-15: Another example of code that shouldn’t be optimized</em></p>
<p class="indent">These examples demonstrate that you need to be able to turn off optimization in certain cases. Traditionally, you’d do so by splitting up the software into general and hardware-specific files and running the optimizer only on the general ones. However, some languages now include mechanisms that allow you to tell the optimizer to leave certain things alone. For example, in C the <code>volatile</code> keyword says not to optimize access to a variable.</p>
<h3 class="h3" id="ch08lev1sec12"><strong>Summary</strong></h3>
<p class="noindent">So far in this book, you’ve learned how computers work and how they run programs. In this chapter, you saw how programs get transformed so that they can be run on machines and learned that programs can be compiled or interpreted.</p>
<p class="indent">In the next chapter, you’ll meet a monster of an interpreter called a <em>web browser</em> and the languages that it interprets.</p>
</body></html>