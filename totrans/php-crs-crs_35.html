<html><head></head><body>
<div id="sbo-rt-content"><section aria-labelledby="ch29" epub:type="chapter" role="doc-chapter">
<span aria-label="569" epub:type="pagebreak" id="pg_569" role="doc-pagebreak"/>
<hgroup>
<h2 class="CHAPTER" id="ch29">
<span class="CN"><span class="SANS_Futura_Std_Bold_Condensed_B_11">29</span></span>
<span class="CT"><span class="SANS_Dogma_OT_Bold_B_11">PROGRAMMING CRUD OPERATIONS</span></span>
</h2>
</hgroup>
<figure class="opener"><img alt="" class="opener" height="380" src="../images/opener.jpg" width="380"/>
</figure>
<p class="INTRO">In the preceding chapter, we began developing a database-driven web application, with a focus on learning how to read data from the database. However, reading is just one of the four primary database operations known collectively as <i>CRUD</i>, short for <i>create, read, update, delete</i>. In this chapter, we’ll look at the other components of CRUD as we expand our web application. We’ll write code that allows users to change the database data by deleting, adding, or updating entries through interactive links and web forms.</p>
<p class="TX">Just about any database-driven mobile or web application revolves around the four CRUD operations. Take an email app as an example: when you write a new email and send it, this <i>creates</i> an item in the database <span aria-label="570" epub:type="pagebreak" id="pg_570" role="doc-pagebreak"/>representing the receiver of the email, as well as an item in your own system’s Sent mailbox database. It’s common to <i>read</i> or <i>delete</i> email in your inbox, and you may also draft an email and then <i>update</i> it later before sending (or deleting) it.</p>
<p class="TX">As we start adding the remaining CRUD features to our web application, you’ll notice a pattern. Each change will begin with a new case in the front-controller <span class="SANS_TheSansMonoCd_W5Regular_11">switch</span> statement inside the <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class, invoking a new method in the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span> class. This method, in turn, will call a new repository class method, where the actual database interaction will take place. Finally, we’ll update the appropriate page templates to add the necessary user interface for the new feature.</p>
<section aria-labelledby="sec1" epub:type="division">
<h3 class="H1" id="sec1"><span id="toc-link_372"/><span class="SANS_Futura_Std_Bold_B_11">Deleting Data</span></h3>
<p class="TNI1">Sometimes we need to delete data from a database table. For example, a car manufacturer may stop making a particular model of a car. The model’s details might be copied into an archive database table, and then the model is deleted from the main table of car models. To delete data from a table, we use the <span class="SANS_TheSansMonoCd_W5Regular_11">DELETE</span> SQL keyword. If no criteria are given, all records are deleted from the named table.</p>
<p class="TX">When deleting a specific row or rows matching certain criteria, we need to provide an SQL <span class="SANS_TheSansMonoCd_W5Regular_11">WHERE</span> clause. For example, to delete the row with an ID of <span class="SANS_TheSansMonoCd_W5Regular_11">4</span> from a <span class="SANS_TheSansMonoCd_W5Regular_11">model</span> table, the SQL statement would be as follows:</p>
<pre><code>DELETE FROM model WHERE id = 4</code></pre>
<p class="TX">We’ll look at examples of deleting an entire table and selectively deleting entries from a table in this section.</p>
<section aria-labelledby="sec2" epub:type="division">
<h4 class="H2" id="sec2"><span id="toc-link_373"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Deleting Everything from a Table</span></h4>
<p class="TNI1">Let’s first add a feature to our web application from the previous chapter that deletes all the products from the <span class="SANS_TheSansMonoCd_W5Regular_11">products</span> table in the database. <a href="#fig29-1">Figure 29-1</a> shows the Delete All Products link we’ll create, along with a pop-up confirmation dialog. It’s always a good idea to offer users a chance to reconsider and cancel destructive operations such as permanently deleting data (assuming they have the option to delete data at all).</p>
<figure class="IMG"><a id="fig29-1"/><img alt="" class="img80" height="415" src="../images/figure29-1.jpg" width="892"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 29-1: Deleting all products</span></p></figcaption>
</figure>
<p class="TX"><span aria-label="571" epub:type="pagebreak" id="pg_571" role="doc-pagebreak"/>First, we’ll add a new route to detect a <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> submission with the <span class="SANS_TheSansMonoCd_W5Regular_11">action =deleteAll</span> variable. Update the <span class="SANS_TheSansMonoCd_W5Regular_11">run()</span> method in the <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class to match <a href="#lis29-1">Listing 29-1</a>.</p>
<span id="lis29-1"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class Application</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    public function run(): void</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $action = filter_input(INPUT_GET, 'action');</span>&#13;
<b>        </b>$isPostSubmission = ($_SERVER['REQUEST_METHOD'] === 'POST');&#13;
&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        switch ($action)</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">        --snip--</span>&#13;
          <b>  </b>case 'deleteAll':&#13;
                if ($isPostSubmission) {&#13;
                    $this-&gt;productController-&gt;deleteAll();&#13;
                } else {&#13;
                    $this-&gt;defaultController-&gt;&#13;
                        error('error - not a POST request');&#13;
                }&#13;
                break;&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            default:</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">                $this-&gt;defaultController-&gt;homepage();</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        }</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    }</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-1: The updated</span> <span class="TheSansMonoCd_W5Regular_Italic_11">Application</span> <span class="SANS_Futura_Std_Book_Oblique_11">class to act on the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">deleteAll</span> <span class="SANS_Futura_Std_Book_Oblique_11">action</span></p>
<p class="TX">We add a new <span class="SANS_TheSansMonoCd_W5Regular_11">$isPostSubmission</span> variable that will be <span class="SANS_TheSansMonoCd_W5Regular_11">true</span> if the received request uses the <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> method. While it’s technically possible to write a web application that changes the server state (such as the database contents) in response to <span class="SANS_TheSansMonoCd_W5Regular_11">GET</span> messages, this would violate the definition of the HTTP <span class="SANS_TheSansMonoCd_W5Regular_11">GET</span> method. For this reason, we’ll use the <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> method and an HTML <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;form&gt;</span> element for any database-changing requests (deletions, creations, or updates) in this chapter.</p>
<p class="TX">We next add a new case to the front-controller <span class="SANS_TheSansMonoCd_W5Regular_11">switch</span> statement for when the value of <span class="SANS_TheSansMonoCd_W5Regular_11">action</span> in the URL is <span class="SANS_TheSansMonoCd_W5Regular_11">'deleteAll'</span>. When this action is received through a <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> request, we invoke the <span class="SANS_TheSansMonoCd_W5Regular_11">deleteAll()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span> object. If <span class="SANS_TheSansMonoCd_W5Regular_11">$isPostSubmission</span> is <span class="SANS_TheSansMonoCd_W5Regular_11">false</span>, we instead use the <span class="SANS_TheSansMonoCd_W5Regular_11">defaultController</span> to return an error message to the user.</p>
<p class="TX">We’ll define the <span class="SANS_TheSansMonoCd_W5Regular_11">deleteAll()</span> method next. Update <i>src/ProductController.php</i> to match the contents of <a href="#lis29-2">Listing 29-2</a>.</p>
<span id="lis29-2"/>
<pre><code><span aria-label="572" epub:type="pagebreak" id="pg_572" role="doc-pagebreak"/><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class ProductController extends Controller</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private ProductRepository $productRepository;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">    --snip--</span>&#13;
&#13;
    public function deleteAll(): void&#13;
    {&#13;
        $this-&gt;productRepository-&gt;deleteAll();&#13;
&#13;
        $this-&gt;list();&#13;
    }&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-2: Adding the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">deleteAll()</span> <span class="SANS_Futura_Std_Book_Oblique_11">method to</span> <span class="TheSansMonoCd_W5Regular_Italic_11">ProductController</span></p>
<p class="TX">We declare the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span> class’s <span class="SANS_TheSansMonoCd_W5Regular_11">deleteAll()</span> method to in turn invoke the <span class="SANS_TheSansMonoCd_W5Regular_11">deleteAll()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> class (which manages communication with the database). Then we invoke the <span class="SANS_TheSansMonoCd_W5Regular_11">list()</span> method to make the application display the Product List page, using the <span class="SANS_TheSansMonoCd_W5Regular_11">header()</span> function and location URL <span class="SANS_TheSansMonoCd_W5Regular_11">/?action=products</span>. The user should therefore see an empty list of products after they’ve all been deleted.</p>
<p class="TX">Now we’ll add the <span class="SANS_TheSansMonoCd_W5Regular_11">deleteAll()</span> method to the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> class. Update <i>src/ProductRepository.php</i> as shown in <a href="#lis29-3">Listing 29-3</a>.</p>
<span id="lis29-3"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class ProductRepository</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private ?\PDO $connection = NULL;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">    --snip--</span>&#13;
&#13;
    public function deleteAll(): int&#13;
    {&#13;
        if (NULL == $this-&gt;connection) return 0;&#13;
&#13;
        $sql = 'DELETE FROM product';&#13;
        $stmt = $this-&gt;connection-&gt;prepare($sql);&#13;
        $stmt-&gt;execute();&#13;
      <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> $numRowsAffected = $stmt-&gt;rowCount();&#13;
&#13;
        return $numRowsAffected;&#13;
    }&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-3: Adding the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">deleteAll()</span> <span class="SANS_Futura_Std_Book_Oblique_11">method to</span> <span class="TheSansMonoCd_W5Regular_Italic_11">ProductRepository</span></p>
<p class="TX"><span aria-label="573" epub:type="pagebreak" id="pg_573" role="doc-pagebreak"/>We declare the <span class="SANS_TheSansMonoCd_W5Regular_11">deleteAll()</span> method to return an integer value indicating the number of rows deleted from the database. If the connection is <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span>, we return <span class="SANS_TheSansMonoCd_W5Regular_11">0</span>. Otherwise, we declare, prepare, and execute the <span class="SANS_TheSansMonoCd_W5Regular_11">'DELETE FROM product'</span> SQL query string, which deletes every entry from the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> table. Then we invoke the <span class="SANS_TheSansMonoCd_W5Regular_11">rowCount()</span> method of the PDO statement object <span aria-label="annotation1" class="CodeAnnotation">❶</span>, which returns the number of rows affected by the most recently executed query. We return this integer value at the end of the method.</p>
<p class="TX">Finally, we need to update the template for the Product List page to offer a link for deleting all the products. Update <i>templates/product/list.xhtml.twig</i> to match the contents of <a href="#lis29-4">Listing 29-4</a>.</p>
<span id="lis29-4"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">{% extends 'base.xhtml.twig' %}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{% block title %}product list page{% endblock %}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{% block productLink %}active{% endblock %}</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{% block body %}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;h1&gt;Product list page&lt;/h1&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;ul&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        {% for product in products %}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">        --snip--</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        {% endfor %}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;/ul&gt;</span>&#13;
    &lt;p&gt;&#13;
        &lt;form method="POST" action="/?action=deleteAll"&gt;&#13;
            &lt;button class="btn btn-danger m-1"&#13;
            onclick="return confirm('Delete ALL products: Are you sure?');"&gt;&#13;
            Delete ALL products&lt;/button&gt;&#13;
        &lt;/form&gt;&#13;
    &lt;/p&gt;&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{% endblock %}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-4: The</span> <span class="SANS_Futura_Std_Book_11">list.xhtml.twig</span> <span class="SANS_Futura_Std_Book_Oblique_11">template for listing all products</span></p>
<p class="TX">Here we add a paragraph to the end of the template declaring a <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> method form containing a Bootstrap-styled button with the text <span class="SANS_TheSansMonoCd_W5Regular_11">Delete ALL products</span>. The action for our controller to receive (<span class="SANS_TheSansMonoCd_W5Regular_11">deleteAll</span>) is sent through the form’s <span class="SANS_TheSansMonoCd_W5Regular_11">action</span> attribute. This button includes a pop-up confirmation message (launched by the JavaScript <span class="SANS_TheSansMonoCd_W5Regular_11">confirm()</span> function) declared in its <span class="SANS_TheSansMonoCd_W5Regular_11">onclick</span> attribute, so the user will be able to confirm or cancel the request.</p>
</section>
<section aria-labelledby="sec3" epub:type="division">
<h4 class="H2" id="sec3"><span id="toc-link_374"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Deleting Individual Items by ID</span></h4>
<p class="TNI1">Just as we can show a particular product based on its ID, we can also use an ID to specify which individual product to delete from the database. Let’s add that feature now. <a href="#fig29-2">Figure 29-2</a> shows a screenshot of the page we’ll create: each product in the Product List page will get its own Show and Delete button-styled links, each triggering a database action based on the product’s ID.</p>
<span aria-label="574" epub:type="pagebreak" id="pg_574" role="doc-pagebreak"/>
<figure class="IMG"><a id="fig29-2"/><img alt="" class="img80" height="839" src="../images/figure29-2.jpg" width="1000"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 29-2: The Show and Delete buttons for an individual product</span></p></figcaption>
</figure>
<p class="TX">We first need to add a new route URL pattern of <span class="SANS_TheSansMonoCd_W5Regular_11">action=delete</span>, where the ID of the product to be deleted is passed through a POST form submission as a variable <span class="SANS_TheSansMonoCd_W5Regular_11">id</span>. Update the <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class code to match <a href="#lis29-5">Listing 29-5</a>.</p>
<span id="lis29-5"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class Application</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    public function run(): void</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $action = filter_input(INPUT_GET, 'action');</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $isPostSubmission = ($_SERVER['REQUEST_METHOD'] === 'POST');</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        switch ($action)</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">        --snip--</span>&#13;
&#13;
            case 'delete':&#13;
              <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> $id = filter_input(INPUT_POST, 'id',&#13;
                                   FILTER_SANITIZE_NUMBER_INT);&#13;
                if ($isPostSubmission &amp;&amp; !empty($id)) {&#13;
                    $this-&gt;productController-&gt;delete($id);&#13;
                } else {&#13;
                    $this-&gt;defaultController-&gt;error('error - to delete a&#13;
                           product an integer id must be provided by a&#13;
                           POST request');&#13;
                }&#13;
                break;&#13;
&#13;
<span aria-label="575" epub:type="pagebreak" id="pg_575" role="doc-pagebreak"/><span class="TheSansMonoCd_W5Regular_Grey_11">            default:</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">                $this-&gt;defaultController-&gt;homepage();</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        }</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    }</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-5: The</span> <span class="TheSansMonoCd_W5Regular_Italic_11">Application</span> <span class="SANS_Futura_Std_Book_Oblique_11">class, updated to act on the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">delete</span> <span class="SANS_Futura_Std_Book_Oblique_11">action</span></p>
<p class="TX">Here we add a new case in the front-controller <span class="SANS_TheSansMonoCd_W5Regular_11">switch</span> statement for when the value of <span class="SANS_TheSansMonoCd_W5Regular_11">action</span> in the URL is <span class="SANS_TheSansMonoCd_W5Regular_11">'delete'</span>. In this case, we attempt to extract an integer variable <span class="SANS_TheSansMonoCd_W5Regular_11">id</span> from the <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> variables received in the request <span aria-label="annotation1" class="CodeAnnotation">❶</span>. If <span class="SANS_TheSansMonoCd_W5Regular_11">$isPostSubmission</span> is <span class="SANS_TheSansMonoCd_W5Regular_11">true</span> and the ID isn’t empty, we pass the ID to the <span class="SANS_TheSansMonoCd_W5Regular_11">delete()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span> object. Otherwise, we pass an appropriate error message to the <span class="SANS_TheSansMonoCd_W5Regular_11">error()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">DefaultController</span> object for display.</p>
<p class="TX">To define the <span class="SANS_TheSansMonoCd_W5Regular_11">delete()</span> method, update <i>src/ProductController.php</i> according to <a href="#lis29-6">Listing 29-6</a>.</p>
<span id="lis29-6"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class ProductController extends Controller</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private ProductRepository $productRepository;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">    --snip--</span>&#13;
&#13;
    public function delete(int $id): void&#13;
    {&#13;
        $this-&gt;productRepository-&gt;delete($id);&#13;
&#13;
        $this-&gt;list();&#13;
    }&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-6: Adding the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">delete()</span> <span class="SANS_Futura_Std_Book_Oblique_11">method to</span> <span class="TheSansMonoCd_W5Regular_Italic_11">ProductController</span></p>
<p class="TX">The <span class="SANS_TheSansMonoCd_W5Regular_11">delete()</span> method takes in an integer product ID and passes it to the <span class="SANS_TheSansMonoCd_W5Regular_11">delete()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> object. Then it makes the application display the Product List page via the <span class="SANS_TheSansMonoCd_W5Regular_11">list()</span> method. The user should therefore see the list of products, less the one deleted, after clicking the link to delete an item.</p>
<p class="TX">Now we’ll add the <span class="SANS_TheSansMonoCd_W5Regular_11">delete()</span> method to the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> class in <i>src/ProductRepository.php</i>. <a href="#lis29-7">Listing 29-7</a> shows how.</p>
<span id="lis29-7"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class ProductRepository</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private ?\PDO $connection = NULL;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">    --snip--</span>&#13;
&#13;
<span aria-label="576" epub:type="pagebreak" id="pg_576" role="doc-pagebreak"/>    public function delete(int $id): bool&#13;
    {&#13;
        if (NULL == $this-&gt;connection) return false;&#13;
&#13;
        $sql = 'DELETE FROM product WHERE id = :id';&#13;
        $stmt = $this-&gt;connection-&gt;prepare($sql);&#13;
        $stmt-&gt;bindParam(':id', $id);&#13;
        $success = $stmt-&gt;execute();&#13;
&#13;
        return $success;&#13;
    }&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-7: Adding the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">delete()</span> <span class="SANS_Futura_Std_Book_Oblique_11">method to</span> <span class="TheSansMonoCd_W5Regular_Italic_11">ProductRepository</span></p>
<p class="TX">The <span class="SANS_TheSansMonoCd_W5Regular_11">delete()</span> method takes in an integer argument (the ID) and returns a Boolean indicating the success of the deletion. If the connection is <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span>, we return <span class="SANS_TheSansMonoCd_W5Regular_11">false</span>. Otherwise, we declare the SQL query string <span class="SANS_TheSansMonoCd_W5Regular_11">'DELETE FROM product WHERE id = :id'</span> to delete just the product with the specified ID. We then prepare the statement and bind the <span class="SANS_TheSansMonoCd_W5Regular_11">$id</span> argument to the <span class="SANS_TheSansMonoCd_W5Regular_11">:id</span> placeholder. Executing the statement then produces a Boolean success value, which we store and return.</p>
<p class="TX">Finally, we need to update the Product List template to offer the button-styled Show and Delete links for each product. Modify <i>templates/product/list.xhtml.twig</i> to match the contents of <a href="#lis29-8">Listing 29-8</a>.</p>
<span id="lis29-8"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">{% extends 'base.xhtml.twig' %}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{% block title %}product list page{% endblock %}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{% block productLink %}active{% endblock %}</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{% block body %}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;h1&gt;Product list page&lt;/h1&gt;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;ul&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        {% for product in products %}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        &lt;li class="mt-5"&gt;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            id: {{product.id}}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            &lt;br&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            description: {{product.description}}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            &lt;br&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            price: $ {{product.price | number_format(2)}}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            &lt;br&gt;</span>&#13;
            &lt;a href="/?action=show&amp;id={{product.id}}"&#13;
<span aria-label="annotation1" class="codeannotated_CodeAnnotation">❶</span> class="btn btn-secondary m-1"&gt;Show&lt;/a&gt;&#13;
            &lt;br&gt;&#13;
            &lt;form method="POST" action="/?action=delete"&gt;&#13;
              <span aria-label="annotation2" class="Code_CodeAnnotation">❷</span> &lt;input type="hidden" name="id" value="{{product.id}}"&gt;&#13;
                &lt;button class="btn btn-danger m-1"&#13;
                        onclick="return confirm(&#13;
                                'Delete product with ID = {{product.id}}:&#13;
                                Are you sure?');"&#13;
                &gt;&#13;
<span aria-label="577" epub:type="pagebreak" id="pg_577" role="doc-pagebreak"/>                Delete&lt;/button&gt;&#13;
            &lt;/form&gt;&#13;
        &lt;/li&gt;&#13;
      <span aria-label="annotation3" class="Code_CodeAnnotation">❸</span> {% else %}&#13;
            &lt;li&gt;&#13;
                (there are no products to display)&#13;
            &lt;/li&gt;&#13;
        {% endfor %}&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;/ul&gt;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;p&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        &lt;form method="POST" action="/?action=deleteAll"&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-8: The</span> <span class="SANS_Futura_Std_Book_11">list.xhtml.twig</span> <span class="SANS_Futura_Std_Book_Oblique_11">template offering deletion by ID</span></p>
<p class="TX">We style the existing <span class="SANS_TheSansMonoCd_W5Regular_11">Show</span> link as a secondary button <span aria-label="annotation1" class="CodeAnnotation">❶</span>. Then we declare a <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> submission form with <span class="SANS_TheSansMonoCd_W5Regular_11">action=delete</span> and a button <span class="SANS_TheSansMonoCd_W5Regular_11">Delete</span>, passing <span class="SANS_TheSansMonoCd_W5Regular_11">id</span> as a hidden variable filling in the product ID with the Twig <span class="SANS_TheSansMonoCd_W5Regular_11">{{product.id}}</span> placeholder <span aria-label="annotation2" class="CodeAnnotation">❷</span>. As with the <span class="SANS_TheSansMonoCd_W5Regular_11">Delete ALL products</span> form, this form button includes a pop-up confirmation message declared in an <span class="SANS_TheSansMonoCd_W5Regular_11">onclick</span> attribute, so the user will be able to confirm or cancel the request. We also add a Twig <span class="SANS_TheSansMonoCd_W5Regular_11">else</span> block <span aria-label="annotation3" class="CodeAnnotation">❸</span> so that the message <span class="SANS_TheSansMonoCd_W5Regular_11">(there are no products to display)</span> is shown if no products are found in the database.</p>
</section>
</section>
<section aria-labelledby="sec4" epub:type="division">
<h3 class="H1" id="sec4"><span id="toc-link_375"/><span class="SANS_Futura_Std_Bold_B_11">Creating New Database Entries</span></h3>
<p class="TNI1">Let’s turn to the <i>C</i> in CRUD: creating new database entries by using SQL <span class="SANS_TheSansMonoCd_W5Regular_11">INSERT</span> statements. For example, here’s an SQL statement that inserts a new row into a table called <span class="SANS_TheSansMonoCd_W5Regular_11">cat</span>:</p>
<pre><code>INSERT INTO cat (name, gender, age) VALUES ('fluffy', 'female', 4)</code></pre>
<p class="TX">Three values are provided for the <span class="SANS_TheSansMonoCd_W5Regular_11">name</span>, <span class="SANS_TheSansMonoCd_W5Regular_11">gender</span>, and <span class="SANS_TheSansMonoCd_W5Regular_11">age</span> columns. The <span class="SANS_TheSansMonoCd_W5Regular_11">INSERT</span> SQL statement requires us to first list the sequence of column names, and then follow this with the values to be inserted into those columns.</p>
<p class="TX">We touched on how to create new database entries when we first set up our application’s database with its two initial products in <span class="Xref">“Setting Up the Database Schema” on <a href="chapter28.xhtml#pg_543">page 543</a></span>. Now we’ll make the process interactive by adding a form to our application that allows users to define new products and submit them to the database. <a href="#fig29-3">Figure 29-3</a> shows the form we’ll create.</p>
<span aria-label="578" epub:type="pagebreak" id="pg_578" role="doc-pagebreak"/>
<figure class="IMG"><a id="fig29-3"/><img alt="" class="img100" height="514" src="../images/figure29-3.jpg" width="1207"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 29-3: The link to create a new product and its associated form</span></p></figcaption>
</figure>
<p class="TX">We’ll add a button link at the bottom of the Product List page to create a new product. This link will launch a Create NEW Product page with form fields for submitting the new product’s description and price.</p>
<section aria-labelledby="sec5" epub:type="division">
<h4 class="H2" id="sec5"><span id="toc-link_376"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Adding Products Through a Web Form</span></h4>
<p class="TNI1">To offer the Create NEW Product page form feature, we first need to add two new route actions to the application, one to display the form (<span class="SANS_TheSansMonoCd_W5Regular_11">action=create</span>) and one to process the form submission (<span class="SANS_TheSansMonoCd_W5Regular_11">action=processCreate</span>). <a href="#lis29-9">Listing 29-9</a> shows how to add cases for these actions to the front controller in the <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class.</p>
<span id="lis29-9"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class Application</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
--snip--&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    public function run(): void</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $action = filter_input(INPUT_GET, 'action');</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $isPostSubmission = ($_SERVER['REQUEST_METHOD'] === 'POST');</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        switch ($action)</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        {</span>&#13;
        <span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
&#13;
            case 'create': <span aria-label="annotation1" class="codewide_CodeAnnotation">❶</span>&#13;
                $this-&gt;productController-&gt;create();&#13;
                break;&#13;
&#13;
            case 'processCreate': <span aria-label="annotation2" class="codewide_CodeAnnotation">❷</span>&#13;
                $description = filter_input(INPUT_POST, 'description');&#13;
                $price = filter_input(INPUT_POST, 'price', FILTER_SANITIZE_NUMBER_FLOAT,&#13;
                                      FILTER_FLAG_ALLOW_FRACTION);&#13;
&#13;
<span aria-label="579" epub:type="pagebreak" id="pg_579" role="doc-pagebreak"/>                if ($isPostSubmission &amp;&amp; !empty($description) &amp;&amp; !empty($price)) {<span aria-label="annotation3" class="codewide_CodeAnnotation">❸</span>&#13;
                    $this-&gt;productController-&gt;processCreate($description, $price);&#13;
                } else {&#13;
                    $this-&gt;defaultController-&gt;error(&#13;
                    'error - new product needs a description and price (via a POST request)');&#13;
                }&#13;
                break;&#13;
&#13;
            default:&#13;
                $this-&gt;defaultController-&gt;homepage();&#13;
        }&#13;
    }&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-9: Adding the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">'create'</span> <span class="SANS_Futura_Std_Book_Oblique_11">and</span> <span class="TheSansMonoCd_W5Regular_Italic_11">'processCreate'</span> <span class="SANS_Futura_Std_Book_Oblique_11">routes to the front controller</span></p>
<p class="TX">First, we add a new case in the front-controller <span class="SANS_TheSansMonoCd_W5Regular_11">switch</span> statement for when the value of <span class="SANS_TheSansMonoCd_W5Regular_11">action</span> in the URL is <span class="SANS_TheSansMonoCd_W5Regular_11">'create'</span> <span aria-label="annotation1" class="CodeAnnotation">❶</span>. This invokes the <span class="SANS_TheSansMonoCd_W5Regular_11">create()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span> object.</p>
<p class="TX">Next, we declare the case for the <span class="SANS_TheSansMonoCd_W5Regular_11">'processCreate'</span> action <span aria-label="annotation2" class="CodeAnnotation">❷</span>. For that, we retrieve the <span class="SANS_TheSansMonoCd_W5Regular_11">description</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">price</span> values from the <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> submission variables. Notice the use of two filters for the float <span class="SANS_TheSansMonoCd_W5Regular_11">price</span> variable; the <span class="SANS_TheSansMonoCd_W5Regular_11">FILTER_FLAG_ALLOW_FRACTION</span> argument is required to permit the decimal-point character.</p>
<p class="TX">If <span class="SANS_TheSansMonoCd_W5Regular_11">$isPostSubmission</span> is <span class="SANS_TheSansMonoCd_W5Regular_11">true</span> and both <span class="SANS_TheSansMonoCd_W5Regular_11">$description</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">$price</span> are not empty <span aria-label="annotation3" class="CodeAnnotation">❸</span>, the description and price are passed to the <span class="SANS_TheSansMonoCd_W5Regular_11">processCreate()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span> object. Otherwise, an appropriate error message will be displayed using the <span class="SANS_TheSansMonoCd_W5Regular_11">error()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">DefaultController</span> object.</p>
<p class="TX">This example is assuming that the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> database table uses auto-incrementing to choose a new, unique integer ID when a new row is added, as demonstrated in <span class="note_Xref"><a href="chapter28.xhtml">Chapter 28</a></span>. Without this feature, we’d also have to supply an ID for the new product, perhaps using logic that first finds the highest current ID in the database and then adds 1 to it.</p>
<p class="TX">We’ll now add the <span class="SANS_TheSansMonoCd_W5Regular_11">create()</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">processCreate()</span> methods to the <span class="SANS_TheSansMonoCd_W5Regular_11">Product Controller</span> class. Update <i>src/ProductController.php</i> to match <a href="#lis29-10">Listing 29-10</a>.</p>
<span id="lis29-10"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class ProductController extends Controller</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private ProductRepository $productRepository;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">    --snip--</span>&#13;
&#13;
<b>  </b><span aria-label="annotation1" class="Code_CodeAnnotation">❶</span><b> </b>public function create(): void&#13;
    {&#13;
        $template = 'product/create.xhtml.twig';&#13;
        $args = [];&#13;
        print $this-&gt;twig-&gt;render($template, $args);&#13;
    }&#13;
&#13;
<span aria-label="580" epub:type="pagebreak" id="pg_580" role="doc-pagebreak"/>  <span aria-label="annotation2" class="Code_CodeAnnotation">❷</span> public function processCreate(string $description, float $price): void&#13;
    {&#13;
        $this-&gt;productRepository-&gt;insert($description, $price);&#13;
&#13;
        $this-&gt;list();&#13;
    }&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-10: Adding the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">create()</span> <span class="SANS_Futura_Std_Book_Oblique_11">and</span> <span class="TheSansMonoCd_W5Regular_Italic_11">processCreate()</span> <span class="SANS_Futura_Std_Book_Oblique_11">methods to</span> <span class="TheSansMonoCd_W5Regular_Italic_11">ProductController</span></p>
<p class="TX">The <span class="SANS_TheSansMonoCd_W5Regular_11">create()</span> method <span aria-label="annotation1" class="CodeAnnotation">❶</span> simply renders the <i>templates/product/create.xhtml.twig</i> template to display the new product form (we’ll create this template shortly). The <span class="SANS_TheSansMonoCd_W5Regular_11">processCreate()</span> method <span aria-label="annotation2" class="CodeAnnotation">❷</span> takes in a string for the new description and a float for the new price and passes them along to the <span class="SANS_TheSansMonoCd_W5Regular_11">insert()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> object for insertion into the database. Then <span class="SANS_TheSansMonoCd_W5Regular_11">processCreate()</span> invokes the Product List page via the <span class="SANS_TheSansMonoCd_W5Regular_11">list()</span> method so that the user will see the updated list of products, including the newly created one.</p>
<p class="TX">If we were being completely correct, our <span class="SANS_TheSansMonoCd_W5Regular_11">processCreate()</span> method would not call the <span class="SANS_TheSansMonoCd_W5Regular_11">list()</span> method, but instead would force a redirect, sending a new request to the server to list all products. By not redirecting, we’ll get a problem: if the user refreshes their browser page after submitting a form, the form will be submitted a second time. However, adding redirects now would make our work in the next section more complex, so we’ll just call the <span class="SANS_TheSansMonoCd_W5Regular_11">list()</span> method for now and formulate a better redirect solution at the end of this chapter.</p>
<p class="TX">To add the <span class="SANS_TheSansMonoCd_W5Regular_11">insert()</span> method to the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> class, update <i>src/ProductRepository.php</i> as shown in <a href="#lis29-11">Listing 29-11</a>.</p>
<span id="lis29-11"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class ProductRepository</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private ?\PDO $connection = NULL;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">    --snip--</span>&#13;
&#13;
    public function insert(string $description, float $price): int&#13;
    {&#13;
        if (NULL == $this-&gt;connection) return -1;&#13;
&#13;
        $sql = 'INSERT INTO product (description, price)'&#13;
            . ' VALUES (:description, :price)';&#13;
        $stmt = $this-&gt;connection-&gt;prepare($sql);&#13;
&#13;
        $stmt-&gt;bindParam(':description', $description);&#13;
        $stmt-&gt;bindParam(':price', $price);&#13;
&#13;
        $success = $stmt-&gt;execute();&#13;
&#13;
<span aria-label="581" epub:type="pagebreak" id="pg_581" role="doc-pagebreak"/>      <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> if ($success) {&#13;
            return $this-&gt;connection-&gt;lastInsertId();&#13;
        } else {&#13;
            return -1;&#13;
        }&#13;
    }&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-11: Adding the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">insert()</span> <span class="SANS_Futura_Std_Book_Oblique_11">method to</span> <span class="TheSansMonoCd_W5Regular_Italic_11">ProductRepository</span></p>
<p class="TX">The new <span class="SANS_TheSansMonoCd_W5Regular_11">insert()</span> method takes in a string argument (<span class="SANS_TheSansMonoCd_W5Regular_11">$description</span>) and a float argument (<span class="SANS_TheSansMonoCd_W5Regular_11">$price</span>) and returns an integer—either the ID of the newly created database record or <span class="SANS_TheSansMonoCd_W5Regular_11">-1</span> if no record is created. If the database connection is <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span>, we return <span class="SANS_TheSansMonoCd_W5Regular_11">-1</span> right away. Otherwise, we declare and prepare the SQL query string <span class="SANS_TheSansMonoCd_W5Regular_11">'INSERT INTO product (description, price) VALUES (:description, :price)'</span> to add a new entry to the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> table.</p>
<p class="TX">We then bind the <span class="SANS_TheSansMonoCd_W5Regular_11">$description</span> argument to the <span class="SANS_TheSansMonoCd_W5Regular_11">:description</span> placeholder and the <span class="SANS_TheSansMonoCd_W5Regular_11">$price</span> argument to the <span class="SANS_TheSansMonoCd_W5Regular_11">:price</span> placeholder before executing the statement. Finally, we test the Boolean <span class="SANS_TheSansMonoCd_W5Regular_11">$success</span> value from the execution <span aria-label="annotation1" class="CodeAnnotation">❶</span>. If <span class="SANS_TheSansMonoCd_W5Regular_11">true</span>, we use the <span class="SANS_TheSansMonoCd_W5Regular_11">lastInsertId()</span> method of the PDO <span class="SANS_TheSansMonoCd_W5Regular_11">connection</span> object to return the ID of the most recently inserted database entry, which should correspond to the new product. If <span class="SANS_TheSansMonoCd_W5Regular_11">false</span>, we return <span class="SANS_TheSansMonoCd_W5Regular_11">-1</span> instead.</p>
<p class="TX">Now let’s revise the Product List page template to include the link for adding a new product. Update <i>templates/product/list.xhtml.twig</i> to match the contents of <a href="#lis29-12">Listing 29-12</a>.</p>
<span id="lis29-12"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">{% extends 'base.xhtml.twig' %}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{% block title %}product list page{% endblock %}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{% block productLink %}active{% endblock %}</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{% block body %}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">    --snip--</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            Delete ALL products&lt;/button&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        &lt;/form&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;/p&gt;</span>&#13;
&#13;
    &lt;p&gt;&#13;
        &lt;a href="/?action=create" class="btn btn-secondary m-1"&gt;&#13;
            Create NEW product&#13;
        &lt;/a&gt;&#13;
    &lt;/p&gt;&#13;
{% endblock %}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-12: Adding the new product link to the</span> <span class="SANS_Futura_Std_Book_11">list.xhtml.twig</span> <span class="SANS_Futura_Std_Book_Oblique_11">template</span></p>
<p class="TX">Here we add a paragraph to the end of the template containing a Bootstrap button–styled link with the text <span class="SANS_TheSansMonoCd_W5Regular_11">Create NEW product</span>. The link triggers the <span class="SANS_TheSansMonoCd_W5Regular_11">create</span> URL action.</p>
<p class="TX">Now let’s add the Twig template to display the Create NEW Product page form. Create the <i>templates/product/create.xhtml.twig</i> template file containing the code shown in <a href="#lis29-13">Listing 29-13</a>.</p>
<span id="lis29-13"/>
<pre><code><span aria-label="582" epub:type="pagebreak" id="pg_582" role="doc-pagebreak"/>{% extends 'base.xhtml.twig' %}&#13;
&#13;
{% block title %}create product page{% endblock %}&#13;
&#13;
{% block body %}&#13;
    &lt;h1&gt;Create NEW Product page&lt;/h1&gt;&#13;
&#13;
  <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> &lt;form method="POST" action="/?action=processCreate"&gt;&#13;
        &lt;p&gt;&#13;
        Description:&#13;
        &lt;input name="description"&gt;&#13;
        &lt;/p&gt;&#13;
        &lt;p&gt;&#13;
        Price:&#13;
        &lt;input name="price" type="number" min="0" step="0.01"&gt;&#13;
        &lt;/p&gt;&#13;
        &lt;input type="submit"&gt;&#13;
    &lt;/form&gt;&#13;
{% endblock %}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-13: The</span> <span class="SANS_Futura_Std_Book_11">create.xhtml.twig</span> <span class="SANS_Futura_Std_Book_Oblique_11">template for the new product form</span></p>
<p class="TX">This template presents an HTML form <span aria-label="annotation1" class="CodeAnnotation">❶</span> whose submit action is <span class="SANS_TheSansMonoCd_W5Regular_11">action=processCreate</span>, so the submitted values will be passed along to the <span class="SANS_TheSansMonoCd_W5Regular_11">processCreate()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span> class described earlier. The form contains two paragraphs, for the description and price, and then a Submit button.</p>
</section>
<section aria-labelledby="sec6" epub:type="division">
<h4 class="H2" id="sec6"><span id="toc-link_377"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Highlighting the Newly Created Product</span></h4>
<p class="TNI1">When something is changed, it’s helpful to highlight the change to the user. Let’s update our application to highlight the new product in the product list after it’s been added to the database. <a href="#fig29-4">Figure 29-4</a> shows the effect we want to achieve; it shows we’ve added a very expensive bag of nails costing $999!</p>
<span aria-label="583" epub:type="pagebreak" id="pg_583" role="doc-pagebreak"/>
<figure class="IMG"><a id="fig29-4"/><img alt="" class="img60" height="879" src="../images/figure29-4.jpg" width="652"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 29-4: Displaying the newly created product with a highlighted background</span></p></figcaption>
</figure>
<p class="TX">To implement this feature, we can take advantage of the return value from the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> class’s <span class="SANS_TheSansMonoCd_W5Regular_11">insert()</span> method, which we declared in the preceding section. This value indicates the ID of the newly created product, so we can add logic to the application to highlight the product whose ID matches this value. First, we need to update the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span> class, shown in <a href="#lis29-14">Listing 29-14</a>.</p>
<span id="lis29-14"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class ProductController extends Controller</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private ProductRepository $productRepository;</span>&#13;
&#13;
    public function list(?int $newProductId = NULL): void&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $products = $this-&gt;productRepository-&gt;findAll();</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $template = 'product/list.xhtml.twig';</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $args = [</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            'products' =&gt; $products,</span>&#13;
          <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> 'id' =&gt; $newProductId&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        ]</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        print $this-&gt;twig-&gt;render($template, $args);</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    }</span>&#13;
&#13;
<span aria-label="584" epub:type="pagebreak" id="pg_584" role="doc-pagebreak"/>    <span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    public function processCreate(string $description, float $price): void</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    {</span>&#13;
        $newProductId =&#13;
            $this-&gt;productRepository-&gt;insert($description, $price);&#13;
&#13;
        $this-&gt;list($newProductId);&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    }</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-14: Updating the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">list()</span> <span class="SANS_Futura_Std_Book_Oblique_11">and</span> <span class="TheSansMonoCd_W5Regular_Italic_11">update()</span> <span class="SANS_Futura_Std_Book_Oblique_11">methods in the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">ProductController</span> <span class="SANS_Futura_Std_Book_Oblique_11">class</span></p>
<p class="TX">We update the <span class="SANS_TheSansMonoCd_W5Regular_11">list()</span> method (which displays the complete product list) to take in an optional <span class="SANS_TheSansMonoCd_W5Regular_11">$newProductId</span> parameter with a default value of <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span>. We pass this parameter to the Twig Product List template, along with the array of products <span aria-label="annotation1" class="CodeAnnotation">❶</span>. Next, we update the <span class="SANS_TheSansMonoCd_W5Regular_11">processCreate()</span> method to receive the new product ID returned from <span class="SANS_TheSansMonoCd_W5Regular_11">insert()</span> and pass it along to the <span class="SANS_TheSansMonoCd_W5Regular_11">list()</span> method.</p>
<p class="TX">Now we can update the Product List template to highlight the product matching the <span class="SANS_TheSansMonoCd_W5Regular_11">id</span> variable passed to the template. Since the product IDs start at <span class="SANS_TheSansMonoCd_W5Regular_11">1</span> and auto-increment, a value of <span class="SANS_TheSansMonoCd_W5Regular_11">-1</span> will never match an object retrieved from the database, so the <span class="SANS_TheSansMonoCd_W5Regular_11">list()</span> method’s default <span class="SANS_TheSansMonoCd_W5Regular_11">$newProductId</span> parameter value of <span class="SANS_TheSansMonoCd_W5Regular_11">-1</span> will result in no products being highlighted. Modify <i>templates/product/list.xhtml.twig</i> as shown in <a href="#lis29-15">Listing 29-15</a>.</p>
<span id="lis29-15"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">{% extends 'base.xhtml.twig' %}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{% block title %}product list page{% endblock %}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{% block productLink %}active{% endblock %}</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{% block body %}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;h1&gt;Product list page&lt;/h1&gt;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;ul&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        {% for product in products %}</span>&#13;
&#13;
<b>          </b><span aria-label="annotation1" class="Code_CodeAnnotation">❶</span><b> </b>{% if id == product.id %}&#13;
                {% set highlight = 'active' %}&#13;
            {% else %}&#13;
                {% set highlight = '' %}&#13;
            {% endif %}&#13;
&#13;
<b>      </b><span aria-label="annotation2" class="Code_CodeAnnotation">❷</span><b> </b>&lt;li class="{{highlight}}"&gt;&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            id: {{product.id}}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            &lt;br&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{% endblock %}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-15: Updating the</span> <span class="SANS_Futura_Std_Book_11">list.xhtml.twig</span> <span class="SANS_Futura_Std_Book_Oblique_11">template to highlight the newly added product within the list</span></p>
<p class="TX"><span aria-label="585" epub:type="pagebreak" id="pg_585" role="doc-pagebreak"/>We’ve added a Twig <span class="SANS_TheSansMonoCd_W5Regular_11">if</span> statement inside the loop through the products that sets the Twig <span class="SANS_TheSansMonoCd_W5Regular_11">highlight</span> variable to <span class="SANS_TheSansMonoCd_W5Regular_11">'active'</span> if the ID of the current product matches the received Twig variable <span class="SANS_TheSansMonoCd_W5Regular_11">id</span> <span aria-label="annotation1" class="CodeAnnotation">❶</span>. Otherwise, the <span class="SANS_TheSansMonoCd_W5Regular_11">highlight</span> variable is set to an empty string. We include the value of <span class="SANS_TheSansMonoCd_W5Regular_11">highlight</span> in the CSS style classes for each list item <span aria-label="annotation2" class="CodeAnnotation">❷</span>, so each product will either be highlighted or not, as appropriate.</p>
<p class="TX">Finally, we need to add a <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;style&gt;</span> element for the <span class="SANS_TheSansMonoCd_W5Regular_11">active</span> CSS class in the base template. Update <i>/templates/product/base.xhtml.twig</i> according to <a href="#lis29-16">Listing 29-16</a>.</p>
<span id="lis29-16"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;!doctype html&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;html lang="en"&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;head&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;title&gt;MG- - {% block title %}{% endblock %}&lt;/title&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;meta name="viewport" content="width=device-width"&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;link rel="stylesheet"</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">          href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"&gt;</span>&#13;
    &lt;style&gt;&#13;
        li.active {background-color: pink;}&#13;
    &lt;/style&gt;&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;/head&gt;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;body class="container"&gt;</span>&#13;
--snip--</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-16: Declaring a</span> <span class="SANS_TheSansMonoCd_W5Regular_Italic_11">&lt;style&gt;</span> <span class="SANS_Futura_Std_Book_Oblique_11">element in the</span> <span class="SANS_Futura_Std_Book_11">base.xhtml.twig</span> <span class="SANS_Futura_Std_Book_Oblique_11">Twig template</span></p>
<p class="TX">In the <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;head&gt;</span> element, we add a CSS rule that <span class="SANS_TheSansMonoCd_W5Regular_11">active</span> list items should have a pink background.</p>
</section>
</section>
<section aria-labelledby="sec7" epub:type="division">
<h3 class="H1" id="sec7"><span id="toc-link_378"/><span class="SANS_Futura_Std_Bold_B_11">Updating a Database Entry</span></h3>
<p class="TNI1">The last CRUD operation to explore is the <i>U</i> for <i>update</i>. This operation is necessary since the data in a database constantly needs to be changed to reflect changes in the real world, such as a person’s new address, the increase in the price of a product, a user changing their subscription status, and so on. To modify an existing record in a table, we can use the SQL <span class="SANS_TheSansMonoCd_W5Regular_11">UPDATE</span> keyword. For example, here’s an SQL statement that changes the age of a cat to <span class="SANS_TheSansMonoCd_W5Regular_11">5</span>, for the row whose ID is <span class="SANS_TheSansMonoCd_W5Regular_11">1</span>:</p>
<pre><code>UPDATE cat SET age = 5 WHERE id = 1</code></pre>
<p class="TX">Let’s add a way to update an existing product to our web application. Much like creating a new product, we’ll do this through a web form. <a href="#fig29-5">Figure 29-5</a> shows how this new feature will work.</p>
<span aria-label="586" epub:type="pagebreak" id="pg_586" role="doc-pagebreak"/>
<figure class="IMG"><a id="fig29-5"/><img alt="" class="img100" height="584" src="../images/figure29-5.jpg" width="1651"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 29-5: Updating an existing product</span></p></figcaption>
</figure>
<p class="TX">We’ll add an Edit button to each product in the Product List page, which will take the user to an Edit Product page with form fields to modify the product’s description and price (the ID will be read-only). These fields will start out with the current values filled in. Once the changes are submitted, the newly updated product will be highlighted on the Product List page.</p>
<p class="TX">To implement this feature, we must first add two new route actions, one to display the editing form (<span class="SANS_TheSansMonoCd_W5Regular_11">action=edit</span>) and one to process the form submission (<span class="SANS_TheSansMonoCd_W5Regular_11">action=processEdit</span>). <a href="#lis29-17">Listing 29-17</a> adds these two new cases to the front controller in the <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class.</p>
<span id="lis29-17"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class Application</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    public function run(): void</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $action = filter_input(INPUT_GET, 'action');</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $isPostSubmission = ($_SERVER['REQUEST_METHOD'] === 'POST');</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        switch ($action)</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        {</span>&#13;
        <span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
&#13;
            case 'edit': <span aria-label="annotation1" class="codewide_CodeAnnotation">❶</span>&#13;
                $id = filter_input(INPUT_GET, 'id', FILTER_SANITIZE_NUMBER_INT);&#13;
                if (empty($id)) {&#13;
                    $this-&gt;defaultController-&gt;error(&#13;
                          'error - To edit a product, an integer ID must be provided');&#13;
                } else {&#13;
                    $this-&gt;productController-&gt;edit($id);&#13;
                }&#13;
                break;&#13;
&#13;
            case 'processEdit': <span aria-label="annotation2" class="codewide_CodeAnnotation">❷</span>&#13;
                $id = filter_input(INPUT_POST, 'id', FILTER_SANITIZE_NUMBER_INT);&#13;
<span aria-label="587" epub:type="pagebreak" id="pg_587" role="doc-pagebreak"/>                $description = filter_input(INPUT_POST, 'description');&#13;
                $price = filter_input(INPUT_POST, 'price', FILTER_SANITIZE_NUMBER_FLOAT,&#13;
                                      FILTER_FLAG_ALLOW_FRACTION);&#13;
&#13;
                if ($isPostSubmission &amp;&amp; !empty($id) &amp;&amp; !empty($description)&#13;
                                      &amp;&amp; !empty($price)) {&#13;
                    $this-&gt;productController-&gt;processEdit($id, $description, $price);&#13;
                } else {&#13;
                    $this-&gt;defaultController-&gt;error(&#13;
                    'error - Missing data (or not POST method) when trying to update product');&#13;
                }&#13;
                break;&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            default:</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">                $this-&gt;defaultController-&gt;homepage();</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        }</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    }</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-17: Adding the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">'edit'</span> <span class="SANS_Futura_Std_Book_Oblique_11">and</span> <span class="TheSansMonoCd_W5Regular_Italic_11">'processEdit'</span> <span class="SANS_Futura_Std_Book_Oblique_11">routes to the front controller</span></p>
<p class="TX">We add a new case in the front-controller <span class="SANS_TheSansMonoCd_W5Regular_11">switch</span> statement for when the value of <span class="SANS_TheSansMonoCd_W5Regular_11">action</span> in the URL is <span class="SANS_TheSansMonoCd_W5Regular_11">'edit'</span> <span aria-label="annotation1" class="CodeAnnotation">❶</span>. As with the <span class="SANS_TheSansMonoCd_W5Regular_11">'show'</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">'delete'</span> cases, we attempt to extract an integer <span class="SANS_TheSansMonoCd_W5Regular_11">id</span> variable from the URL-encoded variables received in the request. If the value of <span class="SANS_TheSansMonoCd_W5Regular_11">id</span> is empty, we display an appropriate error message by passing a string message to the <span class="SANS_TheSansMonoCd_W5Regular_11">error()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">DefaultController</span> object. If the value isn’t empty, we pass it to the <span class="SANS_TheSansMonoCd_W5Regular_11">edit()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span> object.</p>
<p class="TX">Next, we add the <span class="SANS_TheSansMonoCd_W5Regular_11">'processEdit'</span> case <span aria-label="annotation2" class="CodeAnnotation">❷</span>, which starts by retrieving <span class="SANS_TheSansMonoCd_W5Regular_11">id</span>, <span class="SANS_TheSansMonoCd_W5Regular_11">description</span>, and <span class="SANS_TheSansMonoCd_W5Regular_11">price</span> from the <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> submitted variables. If <span class="SANS_TheSansMonoCd_W5Regular_11">$isPostSubmission</span> is <span class="SANS_TheSansMonoCd_W5Regular_11">true</span> and all three variables (<span class="SANS_TheSansMonoCd_W5Regular_11">id</span>, <span class="SANS_TheSansMonoCd_W5Regular_11">description</span>, and <span class="SANS_TheSansMonoCd_W5Regular_11">price</span>) aren’t empty, we pass the values to the <span class="SANS_TheSansMonoCd_W5Regular_11">processEdit()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span> object. Otherwise, we again display an appropriate error message by using the <span class="SANS_TheSansMonoCd_W5Regular_11">error()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">DefaultController</span> object.</p>
<p class="TX">Now we’ll add the new methods to the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span> class. Update <i>src/ProductController.php</i> to match the contents of <a href="#lis29-18">Listing 29-18</a>.</p>
<span id="lis29-18"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class ProductController extends Controller</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
    <span class="TheSansMonoCd_W5Regular_Grey_11">private ProductRepository $productRepository;</span>&#13;
&#13;
    <span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
&#13;
    public function edit(int $id): void&#13;
    {&#13;
      <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> $product = $this-&gt;productRepository-&gt;find($id);&#13;
&#13;
        $template = 'product/edit.xhtml.twig';&#13;
        $args = [&#13;
            'product' =&gt; $product&#13;
        ];&#13;
<span aria-label="588" epub:type="pagebreak" id="pg_588" role="doc-pagebreak"/>        print $this-&gt;twig-&gt;render($template, $args);&#13;
    }&#13;
&#13;
    public function processEdit(int $id, string $description,&#13;
                                float $price): void&#13;
    {&#13;
      <span aria-label="annotation2" class="Code_CodeAnnotation">❷</span> $this-&gt;productRepository-&gt;update($id, $description, $price);&#13;
&#13;
        $this-&gt;list($id);&#13;
    }&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-18: Adding the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">edit()</span> <span class="SANS_Futura_Std_Book_Oblique_11">and</span> <span class="TheSansMonoCd_W5Regular_Italic_11">processEdit()</span> <span class="SANS_Futura_Std_Book_Oblique_11">methods to</span> <span class="TheSansMonoCd_W5Regular_Italic_11">ProductController</span></p>
<p class="TX">The <span class="SANS_TheSansMonoCd_W5Regular_11">edit()</span> method uses the provided integer <span class="SANS_TheSansMonoCd_W5Regular_11">$id</span> argument to retrieve a single <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> object from the database <span aria-label="annotation1" class="CodeAnnotation">❶</span>. Then it passes this object to the <i>/templates/product/edit.xhtml.twig</i> template, which displays the form for editing the product. The <span class="SANS_TheSansMonoCd_W5Regular_11">processEdit()</span> method takes in an <span class="SANS_TheSansMonoCd_W5Regular_11">$id</span> integer, <span class="SANS_TheSansMonoCd_W5Regular_11">$description</span> string, and <span class="SANS_TheSansMonoCd_W5Regular_11">$price</span> float and passes them to the <span class="SANS_TheSansMonoCd_W5Regular_11">update()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> object <span aria-label="annotation2" class="CodeAnnotation">❷</span>. Then it makes the application display to the Product List page via the <span class="SANS_TheSansMonoCd_W5Regular_11">list()</span> method. As with the <span class="SANS_TheSansMonoCd_W5Regular_11">processCreate()</span> method, we pass the ID of the updated product to <span class="SANS_TheSansMonoCd_W5Regular_11">list()</span> so that product will be highlighted.</p>
<p class="TX">Listing 29-19 shows how to add the new <span class="SANS_TheSansMonoCd_W5Regular_11">update()</span> method to the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> class.</p>
<span id="lis29-19"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class ProductRepository</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private ?\PDO $connection = NULL;</span>&#13;
&#13;
    <span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
&#13;
    public function update(int $id, string $description, float $price): bool&#13;
    {&#13;
        if (NULL == $this-&gt;connection) return false;&#13;
        $sql = 'UPDATE product SET description = :description, price = :price WHERE id=:id';&#13;
&#13;
        $stmt = $this-&gt;connection-&gt;prepare($sql);&#13;
&#13;
        $stmt-&gt;bindParam(':id', $id);&#13;
        $stmt-&gt;bindParam(':description', $description);&#13;
        $stmt-&gt;bindParam(':price', $price);&#13;
&#13;
        $success = $stmt-&gt;execute();&#13;
&#13;
        return $success;&#13;
    }&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-19: Adding the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">update()</span> <span class="SANS_Futura_Std_Book_Oblique_11">method to the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">ProductRepository</span> <span class="SANS_Futura_Std_Book_Oblique_11">class</span></p>
<p class="TX"><span aria-label="589" epub:type="pagebreak" id="pg_589" role="doc-pagebreak"/>The <span class="SANS_TheSansMonoCd_W5Regular_11">update()</span> method takes in a product’s ID, description, and price, and returns a Boolean value indicating the success or failure of the update. If the database connection is <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span>, then <span class="SANS_TheSansMonoCd_W5Regular_11">false</span> is returned. Otherwise, we declare the SQL query string <span class="SANS_TheSansMonoCd_W5Regular_11">'UPDATE product SET description = :description, price = :price WHERE id=:id'</span>, using the <span class="SANS_TheSansMonoCd_W5Regular_11">WHERE</span> clause with the object’s ID to specify the particular database row to be updated. After preparing the statement, we bind the <span class="SANS_TheSansMonoCd_W5Regular_11">$id</span>, <span class="SANS_TheSansMonoCd_W5Regular_11">$description</span>, and <span class="SANS_TheSansMonoCd_W5Regular_11">$price</span> variables to their corresponding placeholders.</p>
<p class="TX">Then we execute the statement and return the resulting Boolean success value. Note that we’re returning a Boolean here, rather than the product ID as we did previously for the <span class="SANS_TheSansMonoCd_W5Regular_11">insert()</span> method. The difference here is that the calling method already knows the product ID in question, so it’s sufficient to simply return the true/false success of executing the database update statement.</p>
<p class="TX">Now we need to offer an Edit button for each product on the Product List page. Update the <i>templates/product/list.xhtml.twig</i> file as shown in <a href="#lis29-20">Listing 29-20</a>.</p>
<span id="lis29-20"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{% block body %}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;h1&gt;Product list page&lt;/h1&gt;</span>&#13;
    <span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        &lt;li class="{{highlight}}"&gt;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            id: {{product.id}}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            &lt;br&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            description: {{product.description}}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            &lt;br&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            price: $ {{product.price | number_format(2)}}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            &lt;br&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            &lt;a href="/?action=show&amp;id={{product.id}}"</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">                class="btn btn-secondary m-1"&gt;Show&lt;/a&gt;</span>&#13;
            &lt;br&gt;&#13;
            &lt;a href="/?action=edit&amp;id={{product.id}}"&#13;
                class="btn btn-secondary m-1"&gt;Edit&lt;/a&gt;&#13;
            <span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{% endblock %}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-20: Adding an Edit button to the</span> <span class="SANS_Futura_Std_Book_11">list.xhtml.twig</span> <span class="SANS_Futura_Std_Book_Oblique_11">template</span></p>
<p class="TX">Inside the Twig <span class="SANS_TheSansMonoCd_W5Regular_11">for</span> loop for the current product, we add a Bootstrap button–styled link with the text <span class="SANS_TheSansMonoCd_W5Regular_11">Edit</span>. This link for the <span class="SANS_TheSansMonoCd_W5Regular_11">edit</span> action includes the <span class="SANS_TheSansMonoCd_W5Regular_11">id</span> of the current product.</p>
<p class="TX">Finally, let’s add the Twig template to display the form to edit the details of a product. Create <i>templates/product/edit.xhtml.twig</i> containing the code shown in <a href="#lis29-21">Listing 29-21</a>.</p>
<span id="lis29-21"/>
<pre><code><span aria-label="590" epub:type="pagebreak" id="pg_590" role="doc-pagebreak"/>{% extends 'base.xhtml.twig' %}&#13;
&#13;
{% block title %}edit product page{% endblock %}&#13;
&#13;
{% block body %}&#13;
    &lt;h1&gt;Edit Product page&lt;/h1&gt;&#13;
&#13;
  <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> &lt;form method="POST" action="/?action=processEdit"&gt;&#13;
        &lt;p&gt;&#13;
            ID:&#13;
          <span aria-label="annotation2" class="Code_CodeAnnotation">❷</span> &lt;input name="id" value="{{product.id}}" readonly&gt;&#13;
        &lt;/p&gt;&#13;
        &lt;p&gt;&#13;
            Description:&#13;
            &lt;input name="description" value="{{product.description}}"&gt;&#13;
        &lt;/p&gt;&#13;
        &lt;p&gt;&#13;
        Price:&#13;
        &lt;input name="price" value="{{product.price}}" type="number"&#13;
               min="0" step="0.01"&gt;&#13;
        &lt;/p&gt;&#13;
        &lt;input type="submit"&gt;&#13;
    &lt;/form&gt;&#13;
{% endblock %}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-21: The</span> <span class="SANS_Futura_Std_Book_11">edit.xhtml.twig</span> <span class="SANS_Futura_Std_Book_Oblique_11">template for the form to edit a product</span></p>
<p class="TX">The main work of this template is to present an HTML form <span aria-label="annotation1" class="CodeAnnotation">❶</span> whose submit action is <span class="SANS_TheSansMonoCd_W5Regular_11">action=processEdit</span>, so the submitted values will go to the <span class="SANS_TheSansMonoCd_W5Regular_11">processEdit()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span> class described earlier. This form contains three paragraphs, for the ID, description, and price, and then a Submit button. The ID, description, and price form inputs are populated with the values of the <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> object for those properties. The ID input has the <span class="SANS_TheSansMonoCd_W5Regular_11">readonly</span> attribute; since we don’t want the user to be able to edit this value, it’s displayed but isn’t editable <span aria-label="annotation2" class="CodeAnnotation">❷</span>.</p>
</section>
<section aria-labelledby="sec8" epub:type="division">
<h3 class="H1" id="sec8"><span id="toc-link_379"/><span class="SANS_Futura_Std_Bold_B_11">Avoiding Double Form Submission with Redirects</span></h3>
<p class="TNI1">In our current implementation, we call the <span class="SANS_TheSansMonoCd_W5Regular_11">list()</span> method after processing a form submission to add or edit a product. By passing a product ID to this method, we can make our template highlight the product that’s been created or updated. If the user were to refresh their browser page after submitting a form, however, the browser would attempt to submit the form data a second time by repeating the HTTP <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> request. We can avoid this problem by making the server <i>redirect</i> to request the Product List page after a form submission (a <span class="SANS_TheSansMonoCd_W5Regular_11">GET</span> request for the URL <span class="SANS_TheSansMonoCd_W5Regular_11">/?action=products</span>). If the page is refreshed, this <span class="SANS_TheSansMonoCd_W5Regular_11">GET</span> request to list all products will be repeated rather than the <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> request. This technique is sometimes called the <i>post-redirect-get (PRG) pattern</i>.</p>
<p class="TX">Let’s update our application to use this redirect approach. Rather than passing the product ID as an argument to the <span class="SANS_TheSansMonoCd_W5Regular_11">list()</span> method, we’ll need to <span aria-label="591" epub:type="pagebreak" id="pg_591" role="doc-pagebreak"/>store the ID in the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array. As we discussed in <span class="Xref"><a href="chapter14.xhtml">Chapter 14</a></span>, this is a special array for storing data about the user’s current browser session. First, we’ll update the <span class="SANS_TheSansMonoCd_W5Regular_11">list()</span> method and add a new session helper method in <i>src/ProductController.php</i>, as shown in <a href="#lis29-22">Listing 29-22</a>.</p>
<span id="lis29-22"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class ProductController extends Controller</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private ProductRepository $productRepository;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">    --snip--</span>&#13;
&#13;
    public function list(): void&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $products = $this-&gt;productRepository-&gt;findAll();</span>&#13;
      <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> $id = $this-&gt;getIdFromSession();&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $template = 'product/list.xhtml.twig';</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $args = [</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            'products' =&gt; $products,</span>&#13;
            'id' =&gt; $id&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        ];</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        print $this-&gt;twig-&gt;render($template, $args);</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    }</span>&#13;
&#13;
    private function getIdFromSession(): ?int&#13;
    {&#13;
        $id = NULL;&#13;
      <span aria-label="annotation2" class="Code_CodeAnnotation">❷</span> if (isset($_SESSION['id'])) {&#13;
            $id = $_SESSION['id'];&#13;
&#13;
            // Remove it now that it's been retrieved&#13;
            unset($_SESSION['id']);&#13;
        }&#13;
&#13;
        return $id;&#13;
    }&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-22: Updating the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">list()</span> <span class="SANS_Futura_Std_Book_Oblique_11">method and adding</span> <span class="TheSansMonoCd_W5Regular_Italic_11">getIdFromSession()</span> <span class="SANS_Futura_Std_Book_Oblique_11">to the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">ProductController</span> <span class="SANS_Futura_Std_Book_Oblique_11">class</span></p>
<p class="TX">The <span class="SANS_TheSansMonoCd_W5Regular_11">list()</span> method no longer has any parameters as input. Instead we attempt to retrieve an ID from the session by using the <span class="SANS_TheSansMonoCd_W5Regular_11">getIdFromSession()</span> method <span aria-label="annotation1" class="CodeAnnotation">❶</span>. This method initializes the <span class="SANS_TheSansMonoCd_W5Regular_11">$id</span> variable to <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span>, then tests whether the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array contains a variable with a key of <span class="SANS_TheSansMonoCd_W5Regular_11">'id'</span> <span aria-label="annotation2" class="CodeAnnotation">❷</span>. If such a key exists, its value is retrieved and stored in <span class="SANS_TheSansMonoCd_W5Regular_11">$id</span>, then that element of the array is unset so that it will no longer be stored in the session once <span aria-label="592" epub:type="pagebreak" id="pg_592" role="doc-pagebreak"/>retrieved. The method returns the value of <span class="SANS_TheSansMonoCd_W5Regular_11">$id</span>, which will be either <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span> or the value retrieved from the session.</p>
<p class="TX">Now we can update the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span> class methods to use redirects after storing the ID in the session. Update these methods in <i>src/ProductController.php</i> as shown in <a href="#lis29-23">Listing 29-23</a>.</p>
<span id="lis29-23"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class ProductController extends Controller</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
    <span class="TheSansMonoCd_W5Regular_Grey_11">private ProductRepository $productRepository;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">    --snip--</span>&#13;
&#13;
    public function delete(int $id): void&#13;
    {&#13;
        <span class="TheSansMonoCd_W5Regular_Grey_11">$this-&gt;productRepository-&gt;delete($id);</span>&#13;
&#13;
      <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> $location = '/?action=products';&#13;
        header("Location: $location");&#13;
    }&#13;
&#13;
    public function deleteAll(): void&#13;
    {&#13;
        <span class="TheSansMonoCd_W5Regular_Grey_11">$this-&gt;productRepository-&gt;deleteAll();</span>&#13;
&#13;
        $location = '/?action=products';&#13;
        header("Location: $location");&#13;
    }&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">    --snip--</span>&#13;
&#13;
    public function processCreate(string $description, float $price): void&#13;
    {&#13;
        <span class="TheSansMonoCd_W5Regular_Grey_11">$newObjectId =</span>&#13;
            <span class="TheSansMonoCd_W5Regular_Grey_11">$this-&gt;productRepository-&gt;insert($description, $price);</span>&#13;
&#13;
      <span aria-label="annotation2" class="Code_CodeAnnotation">❷</span> $_SESSION['id'] = $newObjectId;&#13;
&#13;
        $location = '/?action=products';&#13;
        header("Location: $location");&#13;
    }&#13;
&#13;
    <span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
&#13;
    public function processEdit(&#13;
        int $id, string $description, float $price): void&#13;
    {&#13;
        <span class="TheSansMonoCd_W5Regular_Grey_11">$this-&gt;productRepository-&gt;update($id, $description, $price);</span>&#13;
&#13;
        // Store ID of product to highlight in the SESSION&#13;
      <span aria-label="annotation3" class="Code_CodeAnnotation">❸</span> $_SESSION['id'] = $id;&#13;
&#13;
<span aria-label="593" epub:type="pagebreak" id="pg_593" role="doc-pagebreak"/>        $location = '/?action=products';&#13;
        header("Location: $location");&#13;
    }&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-23: Updating the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">POST</span> <span class="SANS_Futura_Std_Book_Oblique_11">action methods to use redirects in</span> <span class="TheSansMonoCd_W5Regular_Italic_11">ProductController</span></p>
<p class="TX">Both the <span class="SANS_TheSansMonoCd_W5Regular_11">delete()</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">deleteAll()</span> methods have been updated to use the built-in <span class="SANS_TheSansMonoCd_W5Regular_11">header()</span> function to redirect the server to process a <span class="SANS_TheSansMonoCd_W5Regular_11">GET</span> request for the URL <span class="SANS_TheSansMonoCd_W5Regular_11">/?action=products</span> <span aria-label="annotation1" class="CodeAnnotation">❶</span>. This value of <span class="SANS_TheSansMonoCd_W5Regular_11">action</span> will result in the products being listed by our <span class="SANS_TheSansMonoCd_W5Regular_11">list()</span> method.</p>
<p class="TX">We’ve also updated <span class="SANS_TheSansMonoCd_W5Regular_11">processCreate()</span> to store the ID of the newly created product (<span class="SANS_TheSansMonoCd_W5Regular_11">$newObjectId</span>) in the session with key <span class="SANS_TheSansMonoCd_W5Regular_11">'id'</span> <span aria-label="annotation2" class="CodeAnnotation">❷</span>. Then it redirects the server to process a <span class="SANS_TheSansMonoCd_W5Regular_11">GET</span> request for the URL <span class="SANS_TheSansMonoCd_W5Regular_11">/?action=products</span>. Likewise, we’ve updated the <span class="SANS_TheSansMonoCd_W5Regular_11">processEdit()</span> method to store the ID of the edited product’s ID (<span class="SANS_TheSansMonoCd_W5Regular_11">$id</span>) in the session with the key <span class="SANS_TheSansMonoCd_W5Regular_11">'id'</span> <span aria-label="annotation3" class="CodeAnnotation">❸</span> and to redirect to <span class="SANS_TheSansMonoCd_W5Regular_11">/?action=products</span> in the same way. We’ve now improved our web application to properly redirect after processing a <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> form submission, so a refresh of the browser will not result in a repeat submission of the form data.</p>
<p class="TX">Since we’re storing the ID in the session, we have to ensure that the session is started by our front-controller index script each time a request is received. Update <i>/public/index.php</i> as shown in <a href="#lis29-24">Listing 29-24</a>.</p>
<span id="lis29-24"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">require_once __DIR__ . '/../vendor/autoload.php';</span>&#13;
&#13;
session_start();&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">use Mattsmithdev\Application;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$app = new Application();</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$app-&gt;run();</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 29-24: Updating</span> <span class="SANS_Futura_Std_Book_11">index.php</span> <span class="SANS_Futura_Std_Book_Oblique_11">to ensure that sessions are active for our web application</span></p>
<p class="TX">We now call the <span class="SANS_TheSansMonoCd_W5Regular_11">session_start()</span> function before any actions are taken. This ensures that our web application can store and retrieve values from the user’s HTTP session.</p>
</section>
<section aria-labelledby="sec9" epub:type="division">
<h3 class="H1" id="sec9"><span id="toc-link_380"/><span class="SANS_Futura_Std_Bold_B_11">Summary</span></h3>
<p class="TNI1">In this chapter, we explored the full range of standard database operations: creating, reading, updating, and deleting entries, collectively known as <i>CRUD</i>. As in the preceding chapter, we used prepared statements for all our database queries, making it easy to bind parameters to the four actions such as deleting a row by its ID or inserting new values into multiple fields of a database entry.</p>
<p class="TX">We continued to see how much of the architecture of a database-driven web application is identical to that of a non-database application. The core of our code is focused around a front controller interrogating the requests <span aria-label="594" epub:type="pagebreak" id="pg_594" role="doc-pagebreak"/>received from the web client and invoking appropriate controller methods. By encapsulating our database actions in a repository class, we were able to keep the logic in our controller classes focused on responding to requests by arranging data and rendering the appropriate Twig template.</p>
<p class="TX">We also saw how forms for creating and updating database rows are presented and processed just like any other web form, only now the data is passed to the repository method to work with the database. We then saw how to improve the system by using redirects after processing form submissions to avoid a repeat of the form actions if the browser page happens to be refreshed.</p>
</section>
<section aria-labelledby="sec10" epub:type="division">
<h3 class="H1" id="sec10"><span id="toc-link_381"/><span class="SANS_Futura_Std_Bold_B_11">Exercises</span></h3>
<p class="ListNumber">1.   Open a web application you regularly use, such as a social media app or e-commerce site. Explore the actions available to you as a user and reflect on which CRUD operations are being executed for each action. How is data coming from and being saved to the database sitting behind the web application you’re using?</p>
<p class="ListNumber">2.   Create a CRUD web application for <span class="SANS_TheSansMonoCd_W5Regular_11">Book</span> objects with these properties:</p>
<p class="ListPlainSub"><span class="SANS_TheSansMonoCd_W5Regular_11">id</span> (integer), an auto-incrementing primary key</p>
<p class="ListPlainSub"><span class="SANS_TheSansMonoCd_W5Regular_11">title</span> (string)</p>
<p class="ListPlainSub"><span class="SANS_TheSansMonoCd_W5Regular_11">author</span> (string)</p>
<p class="ListPlainSub"><span class="SANS_TheSansMonoCd_W5Regular_11">price</span> (float)</p>
<p class="ListBody">You can either create a new project from scratch or reuse classes from this chapter and the <span class="Xref"><a href="chapter28.xhtml">Chapter 28</a></span> exercises. I suggest you follow this sequence when incrementally adding CRUD features to your application:</p>
<p class="ListLetterSub">a.   List all objects.</p>
<p class="ListLetterSub">b.   List one object, given an ID.</p>
<p class="ListLetterSub">c.   Delete all objects.</p>
<p class="ListLetterSub">d.   Delete one object, given an ID.</p>
<p class="ListLetterSub">e.   Create a new object.</p>
<p class="ListLetterSub">f.   Edit an object, given an ID.</p>
</section>
</section>
</div></body></html>