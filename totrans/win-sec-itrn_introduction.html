<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" epub:prefix="index: http://www.index.com/" xml:lang="en" lang="en">
<head>
<title>Introduction</title>
<link href="../styles/stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="sbo-rt-content"><section aria-labelledby="int" epub:type="introduction" role="doc-introduction">
<hgroup>
<h1 class="FMH" id="int"><span aria-label=" Page xxiii. " epub:type="pagebreak" id="pg_xxiii" role="doc-pagebreak"></span><samp class="SANS_Dogma_OT_Bold_B_11">INTRODUCTION</samp></h1>
</hgroup>
<figure class="opener"><img alt="" class="opener" height="386" src="../images/chapter.jpg" width="386"/></figure>
<p class="ChapterIntro">Hundreds of millions of devices use the Microsoft Windows platform. Many of the world’s largest companies rely on its security to protect their data and communications, as does anyone hosting their code in the Azure cloud. But because Windows is so important to the security of the modern internet, it’s also a popular target for attack.</p>
<p class="TX">The Windows NT operating system began including security in its design in 1993, when it introduced user accounts, control over resources, and remote access from a network. In the more than 20 years since then, much has changed in Windows security. Microsoft has replaced its original authentication process with modern technology, granted the access control mechanism additional capabilities, and significantly hardened the platform against attack.</p>
<p class="TX"><span aria-label=" Page xxiv. " epub:type="pagebreak" id="pg_xxiv" role="doc-pagebreak"></span>Today, the security of the Windows platform is surprisingly complex, and many attacks rely on abusing this complexity. Unfortunately, Microsoft’s documentation in this area can be lacking. As Windows is not open source, sometimes the only way to understand its security is through deep research and analysis.</p>
<p class="TX">This is where I come in. I’ve spent more than 20 years as a developer and security researcher on Windows platforms, cultivating an understanding of the operating system’s undocumented corners. In this book, I share some of my extensive expertise in an easy-to-understand form. By mastering the principles of Windows security, you’ll be able to kick-start your own research project or improve your software product.</p>
<section aria-labelledby="sec1" epub:type="division">
<h2 class="H1" id="sec1"><span id="h1-2"></span><samp class="SANS_Futura_Std_Bold_B_11">Who Is This Book For?</samp></h2>
<p class="TNI1">I wrote this book for people who work with Windows security. Perhaps you’re a developer of Windows software and want to ensure that your product is secure. Or maybe you’re a system administrator tasked with securing Windows across an enterprise and don’t fully understand how various security features combine to protect the platform. Or you might want to poke holes in the operating system to find security vulnerabilities as a researcher.</p>
<p class="TX">This book assumes reasonable familiarity with the Windows user interface and its basic operations, such as manipulating files. That said, you don’t need to be a low-level Windows expert: for those who need a little more grounding, <span class="Xref"><a href="chapter2.xhtml">Chapters 2</a></span> and <span class="Xref"><a href="chapter3.xhtml">3</a></span> provide an overview of the operating system and how it’s put together.</p>
<p class="TX">I rely heavily on the use of PowerShell scripting, so you’ll find it helpful to have some experience with the language, as well as with the .NET framework on which it’s based. To get you up to speed, <span class="Xref"><a href="chapter1.xhtml">Chapter 1</a></span> gives a very quick overview of some of PowerShell’s features. Elsewhere, I’ll do my best to avoid using esoteric features of the language, to keep the code accessible to readers with knowledge of other scripting languages or shell environments (such as bash).</p>
</section>
<section aria-labelledby="sec2" epub:type="division">
<h2 class="H1" id="sec2"><span id="h1-3"></span><samp class="SANS_Futura_Std_Bold_B_11">What Is in This Book?</samp></h2>
<p class="TNI1">In each chapter, we’ll cover core security features implemented in modern versions of Windows. We’ll also walk through several worked examples written in PowerShell, which should give you a better understanding of the commands introduced in the chapter. Here’s a brief summary of what each chapter covers.</p>
<p class="TX"><span class="Xref"><a href="part1.xhtml">Part I</a></span> surveys the Windows operating system from a programming perspective. It should provide you with the foundation needed to understand the material in the rest of the book.</p>
<p class="RunInPara1"><b><a href="chapter1.xhtml">Chapter 1</a>: Setting Up a PowerShell Testing Environment    </b>In this chapter, you’ll set up PowerShell to run the examples included in the <span aria-label=" Page xxv. " epub:type="pagebreak" id="pg_xxv" role="doc-pagebreak"></span>subsequent chapters. This includes installing a PowerShell module I’ve written to interact with Windows and its security features. The chapter also provides an overview of the PowerShell scripting language.</p>
<p class="RunInPara"><b><a href="chapter2.xhtml">Chapter 2</a>: The Windows Kernel    </b>This chapter covers the basics of the Windows kernel and its system call interface, a topic crucial to developing a solid understanding of Windows security. I also describe the object manager, used to manage resources.</p>
<p class="RunInPara2"><b><a href="chapter3.xhtml">Chapter 3</a>: User-Mode Applications    </b>Most applications don’t directly use the system call interface from the kernel; instead, they use a set of higher-level programming interfaces. This chapter covers Windows features such as file handling and the registry.</p>
<p class="TX"><span class="Xref"><a href="part2.xhtml">Part II</a></span> covers the most important component of the Windows kernel for security, the Security Reference Monitor. We’ll look at all aspects of access control, from constructing the user’s identity to securing an individual resource, such as a file.</p>
<p class="RunInPara1"><b><a href="chapter4.xhtml">Chapter 4</a>: Security Access Tokens    </b>Windows assigns every running process an access token, which represents the user’s identity to the system. This chapter describes the various components stored in the token that are used to check access.</p>
<p class="RunInPara"><b><a href="chapter5.xhtml">Chapter 5</a>: Security Descriptors    </b>Each securable resource needs a description of who is allowed to access it and what type of access they are granted. This is the purpose of security descriptors. In this chapter, we’ll cover their internal structure and how you can create and manipulate them.</p>
<p class="RunInPara"><b><a href="chapter6.xhtml">Chapter 6</a>: Reading and Assigning Security Descriptors    </b>To inspect the security of the system, you need to be able to query the security descriptor of a resource. This chapter explains how this querying happens for different types of resources. It also covers the many complex ways that Windows assigns security descriptors to resources.</p>
<p class="RunInPara"><b><a href="chapter7.xhtml">Chapter 7</a>: The Access Check Process    </b>Windows uses the access check to determine what access to grant a user to a resource. This operation takes the token and the security descriptor and follows an algorithm to determine the granted access. This chapter works through a PowerShell implementation of the algorithm to explore its design in depth.</p>
<p class="RunInPara"><b><a href="chapter8.xhtml">Chapter 8</a>: Other Access Checking Use Cases    </b>Although Windows primarily uses access checks to grant access to resources, it sometimes uses them to determine other security properties, such as the visibility of resources and whether a process is running with a low level of privilege. This chapter covers these alternative use cases for the access check.</p>
<p class="RunInPara2"><b><a href="chapter9.xhtml">Chapter 9</a>: Security Auditing    </b>The access check process can also create logs of the resources a user has accessed, and with what level of access. This chapter covers these system auditing policies.</p>
<p class="TX"><span aria-label=" Page xxvi. " epub:type="pagebreak" id="pg_xxvi" role="doc-pagebreak"></span><span class="Xref"><a href="part3.xhtml">Part III</a></span> contains details of Windows authentication, the mechanisms that verify a user’s identity for the purposes of access control.</p>
<p class="RunInPara1"><b><a href="chapter10.xhtml">Chapter 10</a>: Windows Authentication    </b>As the topic of authentication is quite complex, this chapter summarizes the authentication structure and services on which the rest of the authentication mechanisms depend.</p>
<p class="RunInPara"><b><a href="chapter11.xhtml">Chapter 11</a>: Active Directory    </b>Windows 2000 introduced a new model for networking Windows systems in an enterprise, with all authentication information stored in a network directory that users and administrators could query and modify. This chapter covers how Active Directory stores information and secures it from malicious modification.</p>
<p class="RunInPara"><b><a href="chapter12.xhtml">Chapter 12</a>: Interactive Authentication    </b>The most common authentication scenario on Windows occurs when a user enters their username and password into their computer and gains access to the desktop. This chapter covers how the operating system implements this authentication process.</p>
<p class="RunInPara"><b><a href="chapter13.xhtml">Chapter 13</a>: Network Authentication    </b>When a user wants to access a network service in a Windows enterprise network, they typically must authenticate to it. Windows provides special network protocols to implement this authentication without disclosing the user’s credentials to a potentially hostile network. This chapter explains the network authentication process, focusing on the New Technology LAN Manager (NTLM) authentication protocol.</p>
<p class="RunInPara"><b><a href="chapter14.xhtml">Chapter 14</a>: Kerberos    </b>Along with Active Directory, Windows 2000 also introduced the use of the open Kerberos authentication protocol for enterprise network authentication. This chapter explains how Kerberos works in Windows to authenticate a user interactively and over a network.</p>
<p class="RunInPara2"><b><a href="chapter15.xhtml">Chapter 15</a>: Negotiate Authentication and Other Security Packages    </b>Over the years, Windows has added other types of network authentication protocols. This chapter covers these new types, including Negotiate, to supplement those discussed in <span class="runinpara_Xref"><a href="chapter13.xhtml">Chapters 13</a></span> and <span class="runinpara_Xref"><a href="chapter14.xhtml">14</a></span>.</p>
<p class="TX">Finally, the two appendices provide configuration details and further resources.</p>
<p class="RunInPara1"><b><a href="appendix-A.xhtml">Appendix A</a>: Building a Windows Domain Network for Testing    </b>To run some of the examples in the book, you’ll need a Windows domain network. This appendix provides some steps for using PowerShell to configure a network for testing.</p>
<p class="RunInPara2"><b><a href="appendix-B.xhtml">Appendix B</a>: SDDL SID Alias Mapping    </b>This appendix provides a table of constants referenced in <span class="runinpara_Xref"><a href="chapter5.xhtml">Chapter 5</a></span>.</p>
</section>
<section aria-labelledby="sec3" epub:type="division">
<h2 class="H1" id="sec3"><span id="h1-4"></span><span aria-label=" Page xxvii. " epub:type="pagebreak" id="pg_xxvii" role="doc-pagebreak"></span><samp class="SANS_Futura_Std_Bold_B_11">PowerShell Conventions Used in This Book</samp></h2>
<p class="TNI1">The PowerShell scripting language, which is included with all versions of Windows, is one of the best ways to flexibly experiment with the internals of the operating system without needing to install much additional software. As PowerShell is based on the .NET runtime, this book will use a .NET library I’ve written for interacting with Windows, making it easy to develop complex scripts. All example scripts in the book will be available to download from <i><a href="https://github.com/tyranid/windows-security-internals">https://<wbr/>github<wbr/>.com<wbr/>/tyranid<wbr/>/windows<wbr/>-security<wbr/>-internals</a></i>.</p>
<p class="TX">The PowerShell examples in each chapter follow a common set of style conventions that should help you understand how to use them. Each example is provided as a listing, of which there are two types: interactive and non-interactive. Interactive PowerShell listings are those you should enter on the command line to observe the results. Here is an example of an interactive listing:</p>
<pre><code><span aria-label="annotation1" class="CodeAnnotationHang1">❶</span> PS&gt; <b>ls C:\</b>
<span aria-label="annotation2" class="CodeAnnotationHang1">❷</span> Directory: C:\
Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-r---               4/17  11:45 AM        Program Files
<span aria-label="annotation3" class="CodeAnnotationHang1">❸</span> <var>--snip--</var>
</code></pre>
<p class="TX">An interactive listing precedes each command to enter with a PowerShell- style prompt (<samp class="SANS_TheSansMonoCd_W5Regular_11">PS&gt;</samp>) and shows the command in bold <span aria-label="annotation1" class="CodeAnnotationCode">❶</span>. You’ll see the resulting output below the command <span aria-label="annotation2" class="CodeAnnotationCode">❷</span>. Sometimes the output can be quite long, so to save space, I use <samp class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">--snip--</samp> to indicate that the output has been truncated <span aria-label="annotation3" class="CodeAnnotationCode">❸</span>. Also note that in some examples the output is indicative; it might be subtly different depending on your operating system or network configuration.</p>
<p class="TX">Most of the interactive listings are designed to be executed from a normal user account. However, some must run under an administrator account to access certain protected features. If you don’t run the commands as an administrator, the results won’t be correct. The text preceding each listing will clarify whether you must run the command as an administrator.</p>
<p class="TX">A non-interactive listing contains PowerShell code that you can copy into a script file for reuse, like this:</p>
<pre><code>function Get-Hello {
    "Hello"
}
</code></pre>
<p class="BodyContinued">Non-interactive listings don’t include the PowerShell prompt and aren’t in bold.</p>
<p class="TX">If you’ve written any scripts in PowerShell, you’ll know that the language is notorious for verbose command and parameter names. This makes it difficult to fit certain commands on a single line in the book. Here is an <span aria-label=" Page xxviii. " epub:type="pagebreak" id="pg_xxviii" role="doc-pagebreak"></span>example of a long PowerShell line and a few ways the book might split it to make it fit on the page:</p>
<pre><code>PS&gt; <b>Get-ChildItem -LiteralPath "C:\" -Filter "*.exe" -Recurse -Hidden</b>
<span aria-label="annotation1" class="CodeAnnotationHang1">❶</span> <b>-System</b> <b>-Depth 5 | Where-Object {</b>
  <span aria-label="annotation2" class="CodeAnnotationCode">❷</span> <b>$_.Name -eq "Hello"</b>
<b>}</b>
</code></pre>
<p class="TX">The first line, using the <samp class="SANS_TheSansMonoCd_W5Regular_11">Get-ChildItem</samp> command, is too long to fit on the page, so it wraps onto a subsequent line <span aria-label="annotation1" class="CodeAnnotationCode">❶</span>. You can’t just add a newline in the middle of such a command, so when you’re entering it into the shell or a file, you should treat it as a single line. The key indicator that the line continues, instead of being part of the output, is that there’s a bold character in the first column.</p>
<p class="TX">PowerShell can break long lines on certain characters, such as the pipe (<samp class="SANS_TheSansMonoCd_W5Regular_11">|</samp>), the comma (<samp class="SANS_TheSansMonoCd_W5Regular_11">,</samp>), or braces (<samp class="SANS_TheSansMonoCd_W5Regular_11">{}</samp>). In this listing, I’ve added a newline following the opening brace (<samp class="SANS_TheSansMonoCd_W5Regular_11">{</samp>) and placed the subsequent commands in the braced block, indented one level <span aria-label="annotation2" class="CodeAnnotationCode">❷</span>. In this case, the shell will handle the introduction of the new line. Note that the closing brace (<samp class="SANS_TheSansMonoCd_W5Regular_11">}</samp>) is in the first column, so you might assume it needs to be placed on the previous line. While moving the brace to the previous line will still work in this specific case, it’s unnecessary.</p>
<p class="TX">Note that the Windows operating system is still under active development. While all the PowerShell examples have been tested on the latest versions of Windows available at the time of writing, there is a chance that new security features will have been introduced, or older ones deprecated, by the time you come to read this book. The following is a list of the versions on which the examples were tested, along with the major OS build number:</p>
<ul class="ul">
<li class="ListBullet">Windows 11 (OS build 22631)</li>
<li class="ListBullet">Windows 10 (OS build 19045)</li>
<li class="ListBullet">Windows Server 2022 (OS build 20384)</li>
<li class="ListBullet">Windows Server 2019 (OS build 17763)</li>
</ul>
<p class="BodyContinued">Any mentions of “the latest versions” in the text refer to these versions.</p>
</section>
<section aria-labelledby="sec4" epub:type="division">
<h2 class="H1" id="sec4"><span id="h1-5"></span><samp class="SANS_Futura_Std_Bold_B_11">Getting in Touch</samp></h2>
<p class="TNI1">I’m always interested in receiving feedback, both positive and negative, on my work, and this book is no exception. You can email me at <i>winsecinternals.book@gmail.com</i>. You can also subscribe to my blog at <i><a href="https://www.tiraniddo.dev">https://<wbr/>www<wbr/>.tiraniddo<wbr/>.dev</a></i>, where I post some of my latest advanced security research.</p>
</section>
</section>
</div></body>
</html>