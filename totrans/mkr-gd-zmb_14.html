<html><head></head><body>
<h2 class="h2" id="app03"><a id="page_243"/><strong>C</strong></h2>
<p class="h2a"><strong>ARDUINO PRIMER</strong></p>
<div class="image1"><img src="graphics/f0001-01.jpg" alt="image"/></div>
<p class="noindent">Arduino microcontroller boards are perfectly suited to a postapocalyptic world. They’re robust, they’re reliable, and they use very little power. If you’re new to Arduino, this appendix will get you started with this great little board so you can begin to make your end-of-the-world preparations now and greatly enhance your chances of survival.</p>
<h3 class="h3" id="ch00lev1sec237"><strong>WHAT IS AN ARDUINO?</strong></h3>
<p class="noindent">There are various types of Arduino board, but by far the most common is the Arduino Uno, and this is the one used for all the projects in this book (see <a href="app03.html#app03fig1">Figure C-1</a>).</p>
<div class="image"><a id="page_244"/><img src="graphics/f0c-01.jpg" alt="image"/></div>
<p class="figuret"><a id="app03fig1">Figure C-1:</a> An Arduino Uno R3</p>
<p class="indent">The Arduino Uno shown in <a href="app03.html#app03fig1">Figure C-1</a> is a revision 3 (R3) board, which is the latest at the time of writing. We’ll have a look at each of the components and their uses.</p>
<p class="indent">Let’s start our tour with the USB socket. This serves several purposes: it can be used to provide power to the Arduino or to connect the Arduino to your computer for programming. It can also serve as a communications link to other computers, as in “<a href="ch08.html#ch00lev1sec137">Project 13: A Raspberry Pi Control Center</a>” on <a href="ch08.html#page_140">page 140</a> where it sends data from the Arduino to a Raspberry Pi. The little red button on the Arduino is the Reset button. Pressing it will cause the program that is installed on the Arduino to restart.</p>
<p class="indent">The connection sockets along both the top and bottom edges of the Arduino are where you attach electronics. On the top side of <a href="app03.html#app03fig1">Figure C-1</a> are digital input and output pins, numbered 0 to 13 and configurable as either inputs or outputs. Inputs read messages coming in; for example, if you connect a switch to a digital input, the input will detect whether the switch is pressed. Outputs send information or power out; if you connect an LED to a digital output, you can turn it on by switching the output from <em>low</em> to <em>high</em>. In fact, one LED, called the <em>L</em> LED, is built onto the board and connected to digital pin 13.</p>
<p class="indent">On the right, the power LED indicates whether the board is powered. The ICSP (In-Circuit Serial Programming) header is only for advanced programming of the Arduino, and most casual users of Arduino will never use it.</p>
<p class="indent"><a id="page_245"/>The ATMega328 is a microcontroller integrated circuit (IC) and the brains of the Arduino. The chip contains 32KB of flash memory, where you store the program you want the Arduino to run.</p>
<p class="indent">On the bottom right of <a href="app03.html#app03fig1">Figure C-1</a> is a row of analog input pins labeled A0 to A5. Digital inputs can only tell whether something is on or off, but analog inputs can actually measure the voltage at the pin, as long as the voltage is between 0V and 5V. Analog input pins could be used, for example, to measure voltage from a temperature sensor like the one used in “<a href="ch07.html#ch00lev1sec130">Project 12: Temperature Alarm</a>” on <a href="ch07.html#page_131">page 131</a>.</p>
<p class="indent">The final row of sockets provides miscellaneous power connections. In “<a href="ch03.html#ch00lev1sec63">Project 4: Battery Monitor</a>” on <a href="ch03.html#page_53">page 53</a>, we use <em>V<sub>in</sub></em> (volts in) to provide power to the Arduino; 5V and GND (or ground), which means 0V, are also power connections that you will need when connecting external electronics.</p>
<p class="indent">At the bottom left, we have a DC power jack, which is another power connection. This can accept anything between 7V and 12V DC. The Arduino will automatically accept power from the USB socket and power from the DC connector or <em>V<sub>in</sub></em> socket, too.</p>
<h3 class="h3" id="ch00lev1sec238"><strong>ARDUINO SOFTWARE</strong></h3>
<p class="noindent">The Arduino might not be what you would expect from a computer. It has no operating system and no keyboard, monitor, or mouse. This is, of course, good news for the survivor who needs to travel light. And while you can reprogram an Arduino as many times as you like, it also only ever runs a single program (called a <em>sketch</em>) at a time. To program the Arduino, you must have the Arduino IDE software installed on your normal computer, so we’ll first cover installation and then talk about writing programs.</p>
<h4 class="h4" id="ch00lev1sec239"><strong>INSTALLING THE ARDUINO IDE</strong></h4>
<p class="noindent">The Arduino IDE is easy to use, making it one major reason for the Arduino’s great popularity. It is available for Windows, Mac, and Linux computers, and it programs the Arduino over a USB connection without any need for special programming hardware.</p>
<div class="note">
<p class="notet"><span class="font1"><strong>NOTE</strong></span></p>
<p class="noindent">You will need an Internet connection to download the Arduino IDE, so do this before you start hearing about zombies on the news!</p>
</div>
<p class="indent">To install the Arduino IDE for your platform, download the software from the Arduino site at <em><a href="http://www.arduino.cc/">http://www.arduino.cc/</a></em> (click <strong>Download</strong> at the top and install the version that’s appropriate for your system). Then follow the <a id="page_246"/>instructions from the Getting Started link. Windows and Mac users will need to install USB drivers for the Arduino IDE to be able to communicate with the Arduino.</p>
<p class="indent">Once you have everything installed, run the Arduino IDE. <a href="app03.html#app03fig2">Figure C-2</a> shows the Arduino IDE window with some code in it.</p>
<div class="image"><img src="graphics/f0c-02.jpg" alt="image"/></div>
<p class="figuret"><a id="app03fig2">Figure C-2:</a> The Arduino IDE window</p>
<p class="indent">The Upload button, as the name suggests, uploads the current sketch to the Arduino board. Before uploading, however, it converts the textual programming code into executable code for the Arduino and displays any errors in the Log area. The Verify button checks the code for errors without uploading the program to the board.</p>
<p class="indent"><a id="page_247"/>The serial monitor button opens the serial monitor window, which is used for two-way communication between the Arduino and another computer, as in “<a href="ch08.html#ch00lev1sec137">Project 13: A Raspberry Pi Control Center</a>” on <a href="ch08.html#page_140">page 140</a>. You can type in text messages to send to the Arduino, and you should see any responses that come back in the same window. The Status area at the bottom of the screen gives information on the type of Arduino you’re using and the corresponding serial port that will be programmed when the Upload button is pressed. The Status area in <a href="app03.html#app03fig2">Figure C-2</a> also shows the type of port you would expect to see when using a Mac or Linux computer (something like <span class="literal">/dev/cu.usbmodem411</span>). If you’re using a Windows computer, this will display <span class="literal">COM</span> followed by a number.</p>
<p class="indent">The large, white area of the IDE is the Program Area, where you type the program code you want uploaded to the Arduino.</p>
<p class="indent">The File menu allows you to Open and Save sketches as you would in a word processor, and it has an Examples submenu from which you can load example sketches.</p>
<h3 class="h3" id="ch00lev1sec240"><strong>UPLOADING A SKETCH</strong></h3>
<p class="noindent">To test out your Arduino board and make sure the Arduino IDE is properly installed, click <strong>File</strong> <span class="ent">▸</span> <strong>Examples</strong> <span class="ent">▸</span> <strong>01. Basics</strong> to open the example sketch called <em>Blink</em> (shown in <a href="app03.html#app03fig2">Figure C-2</a>).</p>
<p class="indent">Use a USB cable to attach your Arduino to your computer. The power LED of the Arduino should light up as it’s plugged in, and a few other LEDs should flicker as well.</p>
<p class="indent">Now that the Arduino is connected, you need to tell the IDE the type of board being programmed and the serial port it’s connected to. Set the board using the menu <strong>Tools</strong> <span class="ent">▸</span> <strong>Board</strong> and then select Arduino Uno from the list of boards.</p>
<p class="indent">Set the serial port using the menu <strong>Tools</strong> <span class="ent">▸</span> <strong>Port</strong>. If you’re using a Windows computer, you probably won’t have many options there; you may find only the option COM4. On a Mac or Linux computer, there are generally more serial connections listed, many of which are internal devices, and it can be difficult to work out which one refers to your Arduino board.</p>
<p class="indent">Usually, the correct port is one that starts <span class="literal">dev/ttyusbmodem<span class="codeitalic">NNNN</span></span>, where <span class="codeitalic">NNNN</span> is a number. In <a href="app03.html#app03fig3">Figure C-3</a>, the Arduino attached to my Mac has been selected.</p>
<div class="image"><a id="page_248"/><img src="graphics/f0c-03.jpg" alt="image"/></div>
<p class="figuret"><a id="app03fig3">Figure C-3:</a> Selecting the Arduino serial port</p>
<p class="indent">If your Arduino doesn’t show up in the list, this usually means you have a problem with the USB drivers, so try reinstalling them. If you’re a Windows user, try rebooting.</p>
<p class="indent">You should now be ready to upload the sketch to the Arduino, so press the <strong>Upload</strong> button. Messages should appear in Log area, and then the TX and RX LEDs on the Arduino should flicker as the program is uploaded onto the board.</p>
<p class="indent">When the upload is complete, you should see a message like the one shown in <a href="app03.html#app03fig4">Figure C-4</a>.</p>
<div class="image"><img src="graphics/f0c-04.jpg" alt="image"/></div>
<p class="figuret"><a id="app03fig4">Figure C-4:</a> A successful upload</p>
<p class="indent">The <span class="literal">Done uploading</span> message tells you that the sketch has uploaded, and the last line in the console tells you that you’ve used 1,084 bytes of the 32,256 bytes available on your Arduino.</p>
<p class="indent">Once the sketch is uploaded, the built-in <em>L</em> LED on the Arduino should blink slowly on and off, which is just what the <em>Blink</em> program is expected to do.</p>
<h4 class="h4" id="ch00lev1sec241"><strong>INSTALLING THE ANTIZOMBIE SKETCHES</strong></h4>
<p class="noindent">All the sketches for the book are available via the book’s website (<em><a href="http://www.nostarch.com/zombies/">http://www.nostarch.com/zombies/</a></em>). Click on the Download Code link to download a ZIP file called <em>zombies-master.zip</em>. Make sure to do this <em>before</em> the apocalypse begins, <a id="page_249"/>because your broadband is likely to be a low priority once the infection has begun to spread. This folder will contain all the Arduino and Raspberry Pi programs for the projects in this book.</p>
<p class="indent">Install the Arduino sketches so that you can use them directly from your Arduino IDE by copying the subfolders from the <em>Arduino</em> folder into <em>Documents/Arduino</em> folder for Mac and Linux users and <em>My Documents\Arduino</em> for Windows users. Exit and reopen the Arduino IDE. Now when you view <strong>File</strong> <span class="ent">▸</span> <strong>Sketchbook</strong>, you should find all the book’s sketches listed.</p>
<h3 class="h3" id="ch00lev1sec242"><strong>ARDUINO PROGRAMMING BASICS</strong></h3>
<p class="noindent">This section contains an overview of the main Arduino programming commands to help you understand the sketches used to do with zombies. If you’re interested in learning the Arduino C programming language, consider getting a copy of my book <em>Programming Arduino: Getting Started with Sketches</em> (Tab Books, 2012). The technical reviewer for the book you’re reading now (Jeremy Blum) has also written a very good book on Arduino and has produced a superb series of video tutorials. You can find links to all this from his website (<em><a href="http://www.jeremyblum.com/">http://www.jeremyblum.com/</a></em>).</p>
<h4 class="h4" id="ch00lev1sec243"><strong>STRUCTURE OF AN ARDUINO SKETCH</strong></h4>
<p class="noindent">All Arduino sketches must have two basic <em>functions</em> (units of program code that perform a task): <span class="literal">setup</span> and <span class="literal">loop</span>. To see how they work, let’s dissect the <em>Blink</em> example that we looked at earlier.</p>
<p class="programs">int led = 13;<br/><br/>// the setup routine runs once when you press reset<br/>void setup() { <br/><br/>  // initialize the digital pin as an output<br/>  pinMode(led, OUTPUT);<br/>}<br/><br/>// the loop routine runs over and over again forever<br/>void loop() {<br/>  digitalWrite(led, HIGH); // turn the LED on (HIGH is the voltage level)<br/>  delay(1000);             // wait for a second<br/>  digitalWrite(led, LOW);  // turn the LED off by making the voltage LOW<br/>  delay(1000);             // wait for a second<br/>}</p>
<p class="indent">Your <em>Blink</em> sketch might be slightly different if you have a newer version of the Arduino IDE, so for the purposes of this discussion, refer to the sketch printed here rather than the one loaded in your IDE.</p>
<p class="indent"><a id="page_250"/>The text preceded by a double slash (<span class="literal">//</span>) is called a <em>comment</em>. It’s not executable program code but rather a description of what’s happening at that point in the sketch.</p>
<p class="indent">Just after the words <span class="literal">setup()</span> and <span class="literal">loop()</span>, we have a <span class="literal">{</span> symbol. (Sometimes this is put on the same line as the preceding word and sometimes on the next line. Where it goes is just a matter of personal preference and has no effect on the running of the code.) The <span class="literal">{</span> symbol marks the start of a block of code, which ends with a corresponding <span class="literal">}</span> symbol. You’ll use curly brackets to group together all lines of code that belong to a particular function or other control structure.</p>
<p class="indent">The lines of code inside the <span class="literal">setup</span> function run just once, when power is applied to the Arduino or the Reset button is pressed. You use <span class="literal">setup</span> to perform all the tasks that need doing just once when the program starts. In <em>Blink</em>, the code inside the <span class="literal">setup</span> function just sets the LED pin as an output.</p>
<p class="indent">The commands inside the <span class="literal">loop</span> function will be run over and over again; in other words, when the last line inside <span class="literal">loop</span> has run, the first line will start again.</p>
<p class="indent">Now, let’s parse this sketch, starting from the top line.</p>
<h4 class="h4" id="ch00lev1sec244"><strong>CREATING VARIABLES AND CONSTANTS</strong></h4>
<p class="noindent"><em>Variables</em> are a way of giving names to values; for example, the first line of <em>Blink</em> labels pin 13 <span class="literal">led</span>:</p>
<p class="programs">int led = 13;</p>
<p class="indent">This defines an <span class="literal">int</span> variable called <span class="literal">led</span> and gives it an initial value of 13, because 13 is the number of the Arduino pin that the <em>L</em> LED is connected to. The word <span class="literal">int</span> is short for integer and means that this variable returns a whole number without decimals.</p>
<p class="indent">In some of the book’s other sketches, variables like this, that define a specific pin to be used, are preceded by a <span class="literal">const</span> keyword:</p>
<p class="programs">const int led = 13;</p>
<p class="indent">The <span class="literal">const</span> keyword tells the Arduino IDE that the value of <span class="literal">led</span> is never going to change from 13, making it a <em>constant</em>. Assigning values this way results in slightly smaller and quicker sketches and is generally considered a good habit.</p>
<h4 class="h4" id="ch00lev1sec245"><a id="page_251"/><strong>CONFIGURING DIGITAL OUTPUTS</strong></h4>
<p class="noindent">The <span class="literal">Blink</span> sketch also shows a good example of a setting a pin up to be a <em>digital output</em>. Pin 13, having been defined as <span class="literal">led</span>, is configured as an output in the <span class="literal">setup</span> function by this line:</p>
<p class="programs"> pinMode(led, OUTPUT); </p>
<p class="indent">As this only needs to be done once, it is placed inside the <span class="literal">setup</span> function. Once the pin is set as an output, it will stay an output until we tell it to be something else.</p>
<p class="indent">For it to blink, the LED needs to turn on and off repeatedly, so the code for this goes inside <span class="literal">loop</span>:</p>
<p class="programs">digitalWrite(led, HIGH); // turn the LED on (HIGH is the voltage level)<br/>delay(1000);             // wait for a second<br/>digitalWrite(led, LOW);  // turn the LED off by making the voltage LOW<br/>delay(1000);             // wait for a second</p>
<p class="indent">The command <span class="literal">digitalWrite</span> takes two <em>parameters</em> (pieces of data that the function needs to run), which are passed to the function inside parentheses and separated by a comma. The first parameter defines which Arduino pin to write to (in this case, pin 13, as specified by <span class="literal">led</span>), and the second parameter gives the value to be written to the pin. A value of <span class="literal">HIGH</span> sets the output to 5V, turning the LED on, and a value of <span class="literal">LOW</span> sets the pin to 0V, turning the LED off.</p>
<p class="indent">The <span class="literal">delay</span> function holds the parameter that defines how long the Arduino should continue with its current function. In this case, a value of <span class="literal">1000</span> delays the program for one second before changing the state of the LED.</p>
<h4 class="h4" id="ch00lev1sec246"><strong>CONFIGURING DIGITAL INPUTS</strong></h4>
<p class="noindent">Digital pins can also be set as input pins using the <span class="literal">pinMode</span> command. The <em>Blink</em> sketch doesn’t do this, so here’s an example:</p>
<p class="programs">pinMode(7, INPUT)</p>
<p class="indent">This <span class="literal">pinMode</span> function sets pin 7 as an input. Just as with an output, you’ll rarely need to change the mode of a pin, so define input pins in the <span class="literal">setup</span> function.</p>
<p class="indent"><a id="page_252"/>Having set the pin as an input, you can then <span class="literal">read</span> the voltage at that pin, as in this example <span class="literal">loop</span> function:</p>
<p class="programs">loop()<br/>{<br/>  if (digitalRead(7) == HIGH)<br/>  {<br/>    digitalWrite(led, LOW)<br/>  }<br/>}</p>
<p class="indent">Here, the LED will be turned off if the input at pin 7 is read as <span class="literal">HIGH</span> at the time it is tested. The Arduino decides whether to turn the LED on with an <em>if statement</em>, which starts with the <span class="literal">if</span> command. Immediately after the word <span class="literal">if</span> is a <em>condition</em>. In this case, the condition is <span class="literal">(digitalRead(7) == HIGH)</span>. The double equal sign (<span class="literal">==</span>) tells the machine to compare the two values on either side. In this case, if pin 7 is <span class="literal">HIGH</span>, then the block of code surrounded by <span class="literal">{</span> and <span class="literal">}</span> after the <span class="literal">if</span> will run; otherwise it won’t. We have already met the code to be run if the condition is true. This is the <span class="literal">digitalWrite</span> command to turn the LED on.</p>
<div class="note">
<p class="notet"><span class="font1"><strong>NOTE</strong></span></p>
<p class="noindent">Lining up the <span class="codestrong">{</span> and <span class="codestrong">}</span> makes it easier to see which <span class="codestrong">}</span> belongs to which <span class="codestrong">{</span>.</p>
</div>
<h4 class="h4" id="ch00lev1sec247"><strong>STABILIZING DIGITAL INPUTS WITH PULL-UP RESISTORS</strong></h4>
<p class="noindent">The preceding example code in assumes that the digital input is definitely either high or low. A switch connected to a digital input can only close a connection. You’ll typically connect switches in such a way that when flipped, the digital input is connected to GND (0V). While the switch’s connection is open, the digital input is said to be <em>floating</em>. That means the input isn’t electrically connected to anything, but a floating input can still pick up electrical noise from the circuitry around it, causing the voltage on the pin to oscillate between high and low.</p>
<p class="indent">This behavior is undesirable because the code could be activated unexpectedly. To prevent input pins from floating, just add a pull-up resistor (<a href="app03.html#app03fig5">Figure C-5</a>). We use just such a resistor in “<a href="ch04.html#ch00lev1sec81">Project 6: PIR Zombie Detector</a>” on <a href="ch04.html#page_72">page 72</a>.</p>
<p class="indent">When the switch is open (as shown in <a href="app03.html#app03fig5">Figure C-5</a>), the resistor connects the input pin to a voltage source, pulling up the voltage at the input pin to 5V and holding it there. Pressing the button to close the switch overrides the weak pulling up of the input, connecting the digital input to GND instead.</p>
<div class="image"><a id="page_253"/><img src="graphics/f0c-05.jpg" alt="image"/></div>
<p class="figuret"><a id="app03fig5">Figure C-5:</a> Schematic for using a pull-up resistor with a digital input</p>
<p class="indent">Arduino inputs have built-in pull-up resistors of about 40 kΩ that you can enable as follows:</p>
<p class="programs">pinMode(switchPin, INPUT_PULLUP);</p>
<p class="indent">This example shows how you would set the pin mode of a digital input to be used with a switch using the Arduino pull-up resistor: just set the pin mode to <span class="literal">INPUT_PULLUP</span> rather than <span class="literal">INPUT</span>.</p>
<h4 class="h4" id="ch00lev1sec248"><strong>READING ANALOG INPUTS</strong></h4>
<p class="noindent">Analog inputs allow you to measure a voltage between 0V and 5V on any of the A0 to A5 analog input pins on the Arduino. Unlike with digital inputs and outputs, you don’t need to include the <span class="literal">pinMode</span> command in <span class="literal">setup</span> when using an analog input.</p>
<p class="indent">You use <span class="literal">analogRead</span> to read the value of an analog input, and you supply the name of the pin you want to read as a parameter. Unlike <span class="literal">digitalRead</span>, <span class="literal">analogRead</span> returns a number rather than just <span class="literal">true</span> or <span class="literal">false</span> values. The returned number will be between 0 (0V) and 1,023 (5V). To convert the number into an applicable voltage, multiply the value by 5 and then divide it by 1,023, which amounts to dividing it by 204.6.</p>
<p class="indent">Here’s how you’d read an analog value and convert it in Arduino code:</p>
<p class="programs">int raw = analogRead(A0);<br/>float volts = raw / 204.6;</p>
<p class="indent"><a id="page_254"/>The variable <span class="literal">raw</span> is an <span class="literal">int</span> (whole number) because the reading from an analog input is always a whole number. To scale the raw reading as a decimal number, the variable needs to be a <span class="literal">float</span> (floating point) type of variable.</p>
<h4 class="h4" id="ch00lev1sec249"><strong>WRITING TO ANALOG OUTPUTS</strong></h4>
<p class="indent">Digital outputs only allow you to turn a component (like an LED) on and off, but analog outputs allow you to control the level of power supplied to a component incrementally. This control allows you to, for example, control the brightness of an LED or the speed of a motor. This is used in “<a href="ch11.html#ch00lev1sec206">Project 20: Silent Haptic Communication with Arduino</a>” on <a href="ch11.html#page_209">page 209</a> to reduce the power to the motor so that it doesn’t attract zombies by making too much noise.</p>
<p class="indent">Only the pins D3, D5, D6, D9, D10, or D11 are capable of being used as analog outputs. These pins are marked with a little tilde (~) beside the pin number on the Arduino.</p>
<p class="indent">To control an analog output, use the command <span class="literal">analogWrite</span> with a number between 0 and 255 as the parameter, as in the following line:</p>
<p class="programs">analogWrite(3, 127);</p>
<p class="indent">A value of 0 is 0V and fully off, while a value of 255 is 5V and fully on. In this example, we set the output of pin D3 to 127, which would be half power.</p>
<h4 class="h4" id="ch00lev1sec250"><strong>REPEATING CODE IN CONTROL LOOPS</strong></h4>
<p class="noindent">Control loops (not to be confused with the <span class="literal">loop</span> function) allow you to repeat an action a set number of times or until some condition changes. There are two commands you can use for looping: <span class="literal">for</span> and <span class="literal">while</span>. You would use the <span class="literal">for</span> command for repeating something a fixed number of times and <span class="literal">while</span> for repeating something until a condition changes.</p>
<p class="indent">The following code makes an LED blink 10 times and then stops:</p>
<p class="programs">void setup() {<br/>  pinMode(led, OUTPUT);<br/>  for (int i = 0; i &lt; 10; i++)<br/>  {<br/>    digitalWrite(led, HIGH);<br/>    delay(1000);<br/>    digitalWrite(led, LOW);<br/>    delay(1000);<br/>  }<br/>void loop() {<br/>}</p>
<div class="sidebar21">
<p class="sidebart"><a id="page_255"/><strong>HOW ANALOG OUTPUTS GENERATE VOLTAGES</strong></p>
<p class="noindent">It is tempting to think of an analog output as being capable of a voltage between 0V and 5V, and if you attach a voltmeter between an analog output pin and GND, the voltage will indeed seem to take on values between 0V and 5V as you change the parameter to <span class="codestrong">analogWrite</span>. In fact, things are a little more complex than that. This kind of output is using <span class="underline">pulse width modulation (PWM)</span>. <a href="app03.html#app03fig6">Figure C-6</a> shows what is really going on.</p>
<div class="image"><img src="graphics/f0c-06.jpg" alt="image"/></div>
<p class="figuret"><a id="app03fig6">Figure C-6:</a> Analog output’s pulse width modulation</p>
<p class="indent">An analog output pin generates 490 pulses per second with varied pulse widths. The larger the proportion of the time that the pulse stays high, the greater the power delivered to the output, and hence the brighter the LED or faster the motor.</p>
<p class="indent">A voltmeter reports this as a change in voltage because the voltmeter cannot respond fast enough and therefore does a kind of averaging (integration).</p>
</div>
<p class="indent"><a id="page_256"/>In this example, we place the blinking code in <span class="literal">setup</span> rather than <span class="literal">loop</span>, because <span class="literal">loop</span> would repeat the blink cycle immediately so the LED would not stop after 10 times.</p>
<p class="indent">If you wanted to keep an LED blinking as long as a button connected to a digital input was pressed, you would use a <span class="literal">while</span> command:</p>
<p class="programs"><span class="ent">➊</span> while (digitalRead(9) == LOW)<br/>   {<br/>      digitalWrite(led, HIGH);<br/>      delay(1000);<br/>      digitalWrite(led, LOW);<br/>      delay(1000);<br/>   }</p>
<p class="indent">This code says that while pin 9 detects that a button is being pressed <span class="ent">➊</span>, the LED should be lit.</p>
<h4 class="h4" id="ch00lev1sec251"><strong>SETTING TWO CONDITIONS WITH IF/ELSE</strong></h4>
<p class="noindent">In “<a href="app03.html#ch00lev1sec245">Configuring Digital Outputs</a>” on <a href="app03.html#page_251">page 251</a>, we used an <span class="literal">if</span> command to tell the Arduino IDE to do something if a certain condition was met. You can also use <span class="literal">if</span> in conjunction with the <span class="literal">else</span> command to instruct the IDE to perform one set of code if the condition is true and a different set of commands if it is false. Here’s an example:</p>
<p class="programs">if (analogRead(A0) &gt; 500)<br/>{<br/>  digitalWrite(led, HIGH);<br/>}<br/>else<br/>{<br/> digitalWrite(led, LOW);<br/>}</p>
<p class="indent">This <span class="literal">if</span> statement turns the <span class="literal">led</span> pin on if an analog reading is greater than 500 or off if the reading is less than or equal to 500.</p>
<h4 class="h4" id="ch00lev1sec252"><strong>MAKING LOGICAL COMPARISONS</strong></h4>
<p class="noindent">So far we have used two types of comparison: <span class="literal">==</span> (equal to) and <span class="literal">&gt;</span> (greater than). Here are some more comparisons you can make:</p>
<p class="noindenta"><span class="codestrong">&lt;=</span>  less than or equal to</p>
<p class="noindenta"><span class="codestrong">&gt;=</span>  greater than or equal to</p>
<p class="noindenta"><span class="codestrong">!=</span>  not equal to</p>
<p class="indentt"><a id="page_257"/>You can also make more complicated comparisons using <em>logical operators</em> like <span class="literal">&amp;&amp;</span> (and) and <span class="literal">||</span> (or). For example, to turn an LED on if a reading is between 300 and 400, you could write the following:</p>
<p class="programs">int reading = analogRead(A0);<br/>if ((reading &gt;= 300) &amp;&amp; (reading &lt;= 400))<br/>{<br/>  digitalWrite(led, HIGH);<br/>}<br/>{<br/> digitalWrite(led, LOW);<br/>}</p>
<p class="indent">In English, this code might read, “If the reading is greater than or equal to 300 <em>and</em> the reading is less than or equal to 400, then turn the LED on.” Since we’re using the <span class="literal">&amp;&amp;</span> operator to specify that both conditions must be true, if either condition is not met, the LED remains dark.</p>
<h4 class="h4" id="ch00lev1sec253"><strong>GROUPING CODE INTO FUNCTIONS</strong></h4>
<p class="noindent">Functions can be confusing if you’re new to programming. Functions are best thought of as ways to group together lines of code and give them a name so that the block of code is easy to use over and over again.</p>
<p class="indent">Built-in functions such as <span class="literal">digitalWrite</span> are more complicated than they first seem. Here is the code for the <span class="literal">digitalWrite</span> function:</p>
<p class="programs">void digitalWrite(uint8_t pin, uint8_t val)<br/>{<br/>    uint8_t timer = digitalPinToTimer(pin);<br/>    uint8_t bit = digitalPinToBitMask(pin);<br/>    uint8_t port = digitalPinToPort(pin);<br/>    volatile uint8_t *out;<br/><br/>    if (port == NOT_A_PIN) return;<br/><br/>    // If the pin that support PWM output, we need to turn it off<br/>    // before doing a digital write.<br/>    if (timer != NOT_ON_TIMER) turnOffPWM(timer);<br/><br/>    out = portOutputRegister(port);<br/><br/>    uint8_t oldSREG = SREG;<br/>    cli();<br/><br/>    if (val == LOW) {<br/>        *out &amp;= ~bit;<br/>    } else {<br/>        *out |= bit;<br/>    }<br/>    SREG = oldSREG;<br/>}</p>
<p class="indent"><a id="page_258"/>Since someone already wrote the <span class="literal">digitalWrite</span> function, we don’t have to worry about what all this code does; we can just be glad that we don’t have to type it all out every time we want to change <span class="literal">pin</span> from <span class="literal">high</span> to <span class="literal">low</span>. By giving that big chunk of code a name, we can just call the name to use this code.</p>
<p class="indent">You can create your own functions to use as shortcuts for more complicated chunks of code. For example, to create a function that makes an LED blink the number of times you specify as a parameter, with the LED pin also specified as a parameter, you could use the sketch below. This function is named <span class="literal">blink</span>, and you can call it during startup so that the Arduino <em>L</em> LED blinks five times after a reset.</p>
<p class="programs"><span class="ent">➊</span> const int ledPin = 13;<br/><br/><span class="ent">➋</span> void setup()<br/>   {<br/>     pinMode(ledPin, OUTPUT);<br/><span class="ent">➌</span>   blink(ledPin, 5);<br/>   }<br/><br/>   void loop() {}<br/><br/><span class="ent">➍</span> void blink(int pin, int n)<br/>   {<br/><span class="ent">➎</span>   for (int i = 0; i &lt; n; i++)<br/>     {<br/>       digitalWrite(ledPin, HIGH);<br/>       delay(500);<br/>       digitalWrite(ledPin, LOW);<br/>       delay(500);<br/>     }<br/>   }</p>
<p class="indent">At <span class="ent">➊</span>, we define the pin being used. The <span class="literal">setup</span> function at <span class="ent">➋</span> sets <span class="literal">ledPin</span> as an output and then calls the function <span class="literal">blink</span> <span class="ent">➌</span>, passing it the relevant pin and the number of times to blink (<span class="literal">5</span>). The <span class="literal">loop</span> function is empty and does nothing, but the Arduino IDE insists that we include it even if it serves no purpose. If you don’t include it, you will get an error message when you install the program.</p>
<p class="indent">The <span class="literal">blink</span> function itself begins at <span class="ent">➍</span> with <span class="literal">void</span>. <span class="literal">void</span> indicates that the function does not return any value, so you cannot assign the result of calling that function to a variable, as you might want to do if the function performed some kind of calculation. Then follows the name of the function (<span class="literal">blink</span>) and the parameters the function takes, enclosed within parentheses and separated by commas. When you define a function, you must specify the <a id="page_259"/>type of each of the parameters (for example, whether they are <span class="literal">int</span> or <span class="literal">float</span>). In this case, both the pin (<span class="literal">pin</span>) and the number of times to blink (<span class="literal">n</span>) are <span class="literal">int</span> values. Lastly, at <span class="ent">➎</span>, we have a <span class="literal">for</span> loop that repeats the <span class="literal">digitalWrite</span> and <span class="literal">delay</span> commands inside it <span class="literal">n</span> times.</p>
<p class="indent">That’s it for the software crash course. If you want to learn more about programming for Arduinos, visit <em><a href="http://www.arduino.cc/">http://www.arduino.cc/</a></em> before everyone at your Internet service provider becomes a zombie.</p>
<h3 class="h3" id="ch00lev1sec254"><strong>ASSEMBLING A SCREWSHIELD</strong></h3>
<p class="noindent">Many of the projects in this book use a screwshield that fits over the Arduino sockets and allows you to connect wires to Arduino pins using screw terminals. Not all wires will fit into the normal Arduino sockets, but almost any thickness of wire will fit securely in a screw terminal and won’t come loose. There are various screwshields on the market, all with slightly different layouts. In this book, I use the popular model from Adafruit (the proto-screwshield, part number 196), which is provided as a kit that you have to solder together. There are lots of connections to make, but none of them are difficult. The component parts of the proto-screwshield are shown in <a href="app03.html#app03fig7">Figure C-7</a>.</p>
<div class="image"><img src="graphics/f0c-07.jpg" alt="image"/></div>
<p class="figuret"><a id="app03fig7">Figure C-7:</a> The parts of Adafruit’s Proto-Screwshield</p>
<p class="indent">The screw terminals line the edge of the board and Arduino pass-through headers. The screwshield pass-through headers slot through the shield into the PCB. You can plug wires into these as you would in the Arduino Uno, and they have sockets on the top side so you can plug still another shield on top.</p>
<p class="indent"><a id="page_260"/>Of the two LEDs, one is a power LED that indicates when the board is powered up, and the other is for you to use in your build. You don’t have to solder either LED in place if you don’t need them. The push button is a reset switch, which can be useful as it’s hard to get at the Arduino’s reset button when the screwshield is in place. Again, it is by no means essential.</p>
<p class="indent"><a href="app03.html#app03fig8">Figure C-8</a> shows the board being assembled.</p>
<div class="image"><img src="graphics/f0c-08.jpg" alt="image"/></div>
<p class="figuret"><a id="app03fig8">Figure C-8:</a> Assembling the screwshield</p>
<p class="indentb"><a id="page_261"/>To assemble the screwshield, follow these steps:</p>
<p class="order">1. Solder the LEDs, resistors, and switch (assuming you want them) in place (<a href="app03.html#app03fig8">Figure C-8a</a>).</p>
<p class="order">2. Put all the screw terminals in place along the outermost edges of the screwshield (<a href="app03.html#app03fig8">Figure C-8b</a>) and flip the board over to solder them on the underside of the PCB. Make sure they are the right way around so that the openings where the wires enter are facing outward, away from the board.</p>
<p class="order">3. Push the pass-through headers through from the top of the board (<a href="app03.html#app03fig8">Figure C-8c</a>) and solder them. Notice that there are two rows of holes on each side of the board where they are able to go; place them in the outer sets of holes. The inner sets are used to wire things up to the pins on the central prototyping area of the board.</p>
<p class="indentt">If you need a refresher on how to solder to a PCB, review “<a href="app02.html#ch00lev1sec227">Soldering Basics</a>” on <a href="app02.html#page_230">page 230</a>. With your components in place, make sure your solder joints look sound (also described in “<a href="app02.html#ch00lev1sec227">Soldering Basics</a>”). You should be ready to deploy this handy shield in all of your antizombie base defense endeavors and conserve precious solder for devices you intend to last a long time.</p>
<h3 class="h3" id="ch00lev1sec255"><strong>FURTHER RESOURCES</strong></h3>
<p class="noindent">There are many great online resources and books that will tell you more about how to use the Arduino in your projects. Here are a few links to get you started:</p>
<p class="bull">• I have written a number of books on Arduino, including <em>Programming Arduino: Getting Started with Sketches</em> (Tab Books, 2012) and various Arduino project books. You can find a full list of my books at <em><a href="http://www.simonmonk.org/">http://www.simonmonk.org/</a>.</em></p>
<p class="bull">• Jeremy Blum, the technical editor of this book, has made a great series of introductory videos on the Arduino, which you can find here: <em><a href="https://www.youtube.com/playlist?list=PLA567CE235D39FA84">https://www.youtube.com/playlist?list=PLA567CE235D39FA84</a></em>.</p>
<p class="bull">• Jeremy also has written a great book on Arduino, called <em>Exploring Arduino</em> (Wiley, 2013).</p>
<p class="bull">• I have written a series of online Arduino lessons, the Adafruit “Learn Arduino” series, which you can find here: <em><a href="https://learn.adafruit.com/series/learn-arduino/">https://learn.adafruit.com/series/learn-arduino/</a></em>.<a id="page_262"/></p>
</body></html>