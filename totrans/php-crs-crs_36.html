<html><head></head><body>
<div id="sbo-rt-content"><section aria-labelledby="ch30" epub:type="chapter" role="doc-chapter">
<span aria-label="595" epub:type="pagebreak" id="pg_595" role="doc-pagebreak"/>
<hgroup>
<h2 class="CHAPTER" id="ch30">
<span class="CN"><span class="SANS_Futura_Std_Bold_Condensed_B_11">30</span></span>
<span class="CT"><span class="SANS_Dogma_OT_Bold_B_11">ORM LIBRARIES AND DATABASE SECURITY</span></span>
</h2>
</hgroup>
<figure class="opener"><img alt="" class="opener" height="380" src="../images/opener.jpg" width="380"/>
</figure>
<p class="INTRO">In this chapter, we’ll explore techniques that make working with databases easier and more secure. First, much of the CRUD code in repository classes can become tedious and repetitive to write, varying only in terms of the names of the model classes and their properties. <i>Object-relational mapping (ORM) libraries</i> relieve this problem, automating lower-level work like preparing and executing SQL queries based on the way an application’s model classes are named and structured. You’ll see how to use such a library to simplify or replace our repository classes with just a few lines of code. We’ll start by adding a simple ORM library to our example web application, then later integrate the professional-grade Doctrine ORM library with the project.</p>
<p class="TX"><span aria-label="596" epub:type="pagebreak" id="pg_596" role="doc-pagebreak"/>On the security front, adopting on ORM library will push us to remove any hardcoded database credentials from our code, instead placing those credentials in a separate data file. We’ll also explore best practices for handling login information in a web application, including using <i>password hashing</i> to avoid storing plaintext passwords in a database. As you’ll see, PHP provides built-in functions that make this process straightforward.</p>
<section aria-labelledby="sec1" epub:type="division">
<h3 class="H1" id="sec1"><span id="toc-link_382"/><span class="SANS_Futura_Std_Bold_B_11">Simplifying Database Code with an ORM Library</span></h3>
<p class="TNI1">One approach to making web applications communicate with databases is to design and write the necessary low-level code from scratch for each project. This includes the code to connect to database servers, create schemas and tables, and perform the four CRUD operations so that the database tables can store the data to support the application. Implementing this code requires careful analysis of the project requirements, especially the requirements for which data needs to be persisted to a database. The result is code that’s tailored to the application at hand and can be written for computational efficiency to maximize speed.</p>
<p class="TX">We’ve followed this approach of designing and writing custom, application-specific database code in the last few chapters. It’s been helpful for learning about how to work with a database, but it also comes with disadvantages. First, it takes time to design, write, and test code for every new application. Second, if the application requirements change, both the web application’s database communication code and the database structure itself need to be changed accordingly. Finally, any new developers joining a software team for an ongoing project will have to learn all the details of the system’s design to communicate with the database.</p>
<p class="TX">An alternative approach is to use an ORM library to abstract away the lower-level work of communication with the database. ORM libraries use the structure and associations of an application’s model classes (often with a little additional metadata) to automatically create and update the structure of the corresponding database tables. If changes in the application requirements lead to changes in the model classes (perhaps new model classes are added, or existing classes are given new properties or associations), then the ORM library can automatically update the database table structures accordingly and manage updated database queries based on the new model class declarations.</p>
<p class="TX">ORM libraries can be less computationally efficient than custom-written low-level database communication code. If speed isn’t the most important feature for a web application, however, they have several strengths. For one, the database structure and queries are updated as soon as the model classes are updated, which streamlines the coding process. Also, if the project uses a well-known, industrial-standard ORM library, new developers joining a project will likely already be familiar with the abstracted ways to use the ORM library to handle database operations.</p>
<p class="TX"><span aria-label="597" epub:type="pagebreak" id="pg_597" role="doc-pagebreak"/>Before we get into the details of how to use an ORM library, let’s consider an example that illustrates this approach’s benefits, compared to using custom code. <a href="#lis30-1">Listing 30-1</a> shows an excerpt of the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> class developed in the previous two chapters.</p>
<span id="lis30-1"/>
<pre><code>&lt;?php&#13;
namespace Mattsmithdev;&#13;
&#13;
class ProductRepository&#13;
{&#13;
    private ?\PDO $connection = NULL;&#13;
&#13;
    public function __construct()&#13;
    {&#13;
        $db = new Database();&#13;
        $this-&gt;connection = $db-&gt;getConnection();&#13;
    }&#13;
&#13;
    public function findAll(): array&#13;
    {&#13;
        if (NULL == $this-&gt;connection) return [];&#13;
&#13;
        $sql = 'SELECT * FROM product';&#13;
        $stmt = $this-&gt;connection-&gt;prepare($sql);&#13;
        $stmt-&gt;execute();&#13;
        $stmt-&gt;setFetchMode(\PDO::FETCH_CLASS, 'Mattsmithdev\\Product');&#13;
        $products = $stmt-&gt;fetchAll();&#13;
&#13;
        return $products;&#13;
    }&#13;
&#13;
    public function find(int $id): ?Product&#13;
    {&#13;
        if (NULL == $this-&gt;connection) return NULL;&#13;
&#13;
        $sql = 'SELECT * FROM product WHERE id = :id';&#13;
        $stmt = $this-&gt;connection-&gt;prepare($sql);&#13;
&#13;
        $stmt-&gt;bindParam(':id', $id);&#13;
        $stmt-&gt;execute();&#13;
&#13;
        $stmt-&gt;setFetchMode(\PDO::FETCH_CLASS, 'Mattsmithdev\\Product');&#13;
        $product = $stmt-&gt;fetch();&#13;
&#13;
        return $product;&#13;
    }&#13;
&#13;
    <span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-1: Some of the contents of the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">ProductRepository</span> <span class="SANS_Futura_Std_Book_Oblique_11">class</span></p>
<p class="TX"><span aria-label="598" epub:type="pagebreak" id="pg_598" role="doc-pagebreak"/>We developed this class manually, meaning we had to implement lower-level methods such as a constructor to retrieve a database connection and CRUD methods such as <span class="SANS_TheSansMonoCd_W5Regular_11">findAll()</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">find()</span> to prepare and execute SQL queries. Compare this code with <a href="#lis30-2">Listing 30-2</a>, which declares an equivalent <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> class with the help of an ORM library.</p>
<span id="lis30-2"/>
<pre><code>&lt;?php&#13;
namespace Mattsmithdev;&#13;
&#13;
use Mattsmithdev\PdoCrudRepo\DatabaseTableRepository;&#13;
&#13;
class ProductRepository extends DatabaseTableRepository&#13;
{&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-2: A</span> <span class="TheSansMonoCd_W5Regular_Italic_11">ProductRepository</span> <span class="SANS_Futura_Std_Book_Oblique_11">class inheriting from an ORM library</span></p>
<p class="TX">For straightforward database interactions, an ORM library can do almost all the work for us. Instead of implementing custom methods in the repository class, we simply inherit those methods from an ORM library superclass (in this case, <span class="SANS_TheSansMonoCd_W5Regular_11">DatabaseTableRepository</span>). The superclass is designed to use <i>reflection</i>, a technique of inspecting the classes and objects it interacts with, such as the <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> model class. Then the superclass uses what it finds to generate SQL queries suitable for objects of those classes.</p>
<p class="TX">In the coming sections, we’ll explore how this works in more detail by using a simple ORM library, one that I maintain as an open source project on GitHub. Later we’ll also try out an industrial-strength ORM library called Doctrine, one of the most popular ORM libraries available for modern PHP. For now, though, take a moment to appreciate how much shorter the ORM-assisted <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> class declaration is than the manually coded version.</p>
<section aria-labelledby="sec2" epub:type="division">
<h4 class="H2" id="sec2"><span id="toc-link_383"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Adding an ORM Library to a Project</span></h4>
<p class="TNI1">Let’s extend our database-driven web application from the previous chapters to work with a simple ORM library called <span class="SANS_TheSansMonoCd_W5Regular_11">pdo-crud-for-free-repositories</span> that I maintain (<i><a href="https://github.com/dr-matt-smith/pdo-crud-for-free-repositories">https://github.com/dr-matt-smith/pdo-crud-for-free-repositories</a></i>). It has limited features but is straightforward to use, making it a good tool for introducing the basics of ORM libraries. To get started, enter the following at the command line to add the library to the project:</p>
<pre><code>$ <b>composer require mattsmithdev/pdo-crud-for-free-repositories</b></code></pre>
<p class="BodyContinued">This will add a <i>mattsmithdev</i> folder inside <i>vendor</i> containing the library code.</p>
<p class="TX">At the time of this writing, the released version of the <span class="SANS_TheSansMonoCd_W5Regular_11">pdo-crud-for-free -repositories</span> is compatible only with MySQL, so we’ll focus on the MySQL version of our web application rather than the SQLite version.</p>
</section>
<section aria-labelledby="sec3" epub:type="division">
<h4 class="H2" id="sec3"><span id="toc-link_384"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Moving Database Credentials to a .env File</span></h4>
<p class="TNI1">The ORM library we’re using requires all our database credentials to be declared in a file named <i>.env</i>, commonly known as a <i>dotenv file</i>, rather than <span aria-label="599" epub:type="pagebreak" id="pg_599" role="doc-pagebreak"/>hardcoded in the <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span> class where we currently have them. Dotenv files are human-readable text files defining name/value pairs necessary for a program to run; other common file types for such variables include XML and YAML. This requirement is not a bad thing, since it also makes the application more secure.</p>
<p class="TX">Typically, we’d exclude dotenv files when using version-control systems such as Git so that when code is archived or pushed to open source projects, sensitive database credentials won’t be included. This reduces the chance of a security breach from code being published or distributed to unauthorized people. Another advantage of this approach is that different environments can be set up in multiple dotenv files, such as for local development, remote development, testing, and live production systems.</p>
<p class="TX">To satisfy this ORM library requirement, create a file called <i>.env</i> and save it in the main project directory. Enter the contents of <a href="#lis30-3">Listing 30-3</a> into the file, changing values such as the password and port to match the MySQL server properties running on your computer.</p>
<span id="lis30-3"/>
<pre><code>MYSQL_USER=<span class="TheSansMonoCd_W5Regular_Italic_11">root</span>&#13;
MYSQL_PASSWORD=<span class="TheSansMonoCd_W5Regular_Italic_11">password</span>&#13;
MYSQL_HOST=<span class="TheSansMonoCd_W5Regular_Italic_11">127.0.0.1</span>&#13;
MYSQL_PORT=<span class="TheSansMonoCd_W5Regular_Italic_11">3306</span>&#13;
MYSQL_DATABASE=<span class="TheSansMonoCd_W5Regular_Italic_11">demo1</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-3: The database credentials in the</span> <span class="SANS_Futura_Std_Book_11">.env</span> <span class="SANS_Futura_Std_Book_Oblique_11">file</span></p>
<p class="TX">These MySQL attributes were all previously defined as constants in our <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span> class. We can now delete the <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span> class from our project, since the ORM library comes with its own class for managing the connection with the database, based on the information in the dotenv file.</p>
</section>
<section aria-labelledby="sec4" epub:type="division">
<h4 class="H2" id="sec4"><span id="toc-link_385"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Relegating Product Operations to the ORM Library</span></h4>
<p class="TNI1">Now that the ORM library has access to the database, we can shift responsibility for all CRUD operations relating to the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> table from our <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> class to the ORM library. We’ll still use the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> class, but as hinted earlier, instead of manually filling it with methods that prepare and execute SQL statements, we’ll simply declare it to be a subclass of one of the ORM library classes. Replace the contents of <i>src/ProductRepository.php</i> with the code shown in <a href="#lis30-4">Listing 30-4</a>.</p>
<span id="lis30-4"/>
<pre><code>&lt;?php&#13;
namespace Mattsmithdev;&#13;
&#13;
use Mattsmithdev\PdoCrudRepo\DatabaseTableRepository;&#13;
&#13;
class ProductRepository extends DatabaseTableRepository&#13;
{&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-4: The much-simplified</span> <span class="TheSansMonoCd_W5Regular_Italic_11">ProductRepository</span> <span class="SANS_Futura_Std_Book_Oblique_11">class</span></p>
<p class="TX"><span aria-label="600" epub:type="pagebreak" id="pg_600" role="doc-pagebreak"/>The <span class="SANS_TheSansMonoCd_W5Regular_11">use</span> statement specifies that we want to refer to the <span class="SANS_TheSansMonoCd_W5Regular_11">DatabaseTableRepository</span> class in the <span class="SANS_TheSansMonoCd_W5Regular_11">Mattsmithdev\PdoCrudRepo</span> namespace. Then we declare <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> as a subclass of <span class="SANS_TheSansMonoCd_W5Regular_11">DatabaseTableRepository</span>, with no code whatsoever in the class body. And that’s it! We now have a working <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> class with just those few lines of code. It will inherit all the methods declared in the <span class="SANS_TheSansMonoCd_W5Regular_11">DatabaseTableRepository</span> superclass that happen to follow the same naming convention we used previously: <span class="SANS_TheSansMonoCd_W5Regular_11">find()</span>, <span class="SANS_TheSansMonoCd_W5Regular_11">findAll()</span>, <span class="SANS_TheSansMonoCd_W5Regular_11">delete()</span>, <span class="SANS_TheSansMonoCd_W5Regular_11">deleteAll()</span>, and so on.</p>
<p class="TX">But how does the <span class="SANS_TheSansMonoCd_W5Regular_11">DatabaseTableRepository</span> class know that we want it to work with a <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> table with <span class="SANS_TheSansMonoCd_W5Regular_11">id</span>, <span class="SANS_TheSansMonoCd_W5Regular_11">description</span>, and <span class="SANS_TheSansMonoCd_W5Regular_11">price</span> fields? This is where reflection comes into play. The <span class="SANS_TheSansMonoCd_W5Regular_11">DatabaseTableRepository</span> class uses this technique to infer the details about how to construct appropriate SQL statements based on the classes and objects it comes into contact with. In this case, the reflection code assumes that the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> repository class manages database methods for a model class in the same namespace called <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span>, and that a corresponding <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> table in the database has fields matching the property names of the <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> class. As long as all the names align, the ORM library will be able to do its job.</p>
<p class="TX">For the reflection process to work, the <span class="SANS_TheSansMonoCd_W5Regular_11">DatabaseTableRepository</span> methods need to receive objects of the appropriate model class, rather than free- floating variables as we’d previously designed the CRUD methods in <span class="Xref"><a href="chapter29.xhtml">Chapter 29</a></span>. To finalize the shift to the ORM library, we therefore need to refactor our <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span> class to pass in <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> objects when calling the <span class="SANS_TheSansMonoCd_W5Regular_11">insert()</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">update()</span> methods to process new and updated products. Change the <i>src/ProductController.php</i> file as shown in <a href="#lis30-5">Listing 30-5</a>.</p>
<span id="lis30-5"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class ProductController extends Controller</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private ProductRepository $productRepository;</span>&#13;
&#13;
    <span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    public function processCreate(string $description, float $price): void</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    {</span>&#13;
        $product = new Product();&#13;
        $product-&gt;setDescription($description);&#13;
        $product-&gt;setPrice($price);&#13;
&#13;
      <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> $newObjectId = $this-&gt;productRepository-&gt;insert($product);&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $_SESSION['id'] = $newObjectId;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $location = '/?action=products';</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        header("Location: $location");</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    }</span>&#13;
&#13;
    <span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
&#13;
<span aria-label="601" epub:type="pagebreak" id="pg_601" role="doc-pagebreak"/><span class="TheSansMonoCd_W5Regular_Grey_11">    public function processEdit(int $id, string $description,</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">                                float $price): void</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    {</span>&#13;
      <span aria-label="annotation2" class="Code_CodeAnnotation">❷</span> $product = $this-&gt;productRepository-&gt;find($id);&#13;
        $product-&gt;setDescription($description);&#13;
        $product-&gt;setPrice($price);&#13;
&#13;
        $this-&gt;productRepository-&gt;update($product);&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $_SESSION['id'] = $id;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $location = '/?action=products';</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        header("Location: $location");</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    }</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-5: The updated</span> <span class="SANS_Futura_Std_Book_11">src/ProductController.php</span> <span class="SANS_Futura_Std_Book_Oblique_11">class</span></p>
<p class="TX">In the revised <span class="SANS_TheSansMonoCd_W5Regular_11">processCreate()</span> method, we first create a new <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> object and set its <span class="SANS_TheSansMonoCd_W5Regular_11">description</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">price</span> properties to the values passed into the method. We then pass this <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> object to the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> object’s <span class="SANS_TheSansMonoCd_W5Regular_11">insert()</span> method to add the new product to the database <span aria-label="annotation1" class="CodeAnnotation">❶</span>. The ORM library assumes that every database table has an auto-incrementing primary key named <span class="SANS_TheSansMonoCd_W5Regular_11">id</span>, so no value for the product ID is needed when creating a new row in the database. We make a similar change to the <span class="SANS_TheSansMonoCd_W5Regular_11">processEdit()</span> method, using the <span class="SANS_TheSansMonoCd_W5Regular_11">id</span> to get a reference to the <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> object to be updated <span aria-label="annotation2" class="CodeAnnotation">❷</span>, setting the other properties received from the form, and passing the object reference to the repository class’s <span class="SANS_TheSansMonoCd_W5Regular_11">update()</span> method.</p>
<p class="TX">Run the web server and you should now see the web application is working just as before, but with significantly less code! In this way, working with an ORM library greatly simplified the task of executing standard database CRUD operations.</p>
<blockquote>
<p class="Note"><span class="SANS_Dogma_OT_Bold_B_15">NOTE</span></p>
</blockquote>
<p class="NOTE-TXT"><i>Before moving on, make a copy of your project at this point. In “The Doctrine ORM Library” on <a href="#pg_615">page 615</a>, we’ll modify that copy to use Doctrine.</i></p>
</section>
<section aria-labelledby="sec5" epub:type="division">
<h4 class="H2" id="sec5"><span id="toc-link_386"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Adding a New Database Table</span></h4>
<p class="TNI1">Now that we’ve incorporated the ORM library into the project, let’s expand our web application by adding another table to the database. With the library handling all the CRUD operations, the process will be much more efficient than our effort in <span class="Xref"><a href="chapter29.xhtml">Chapter 29</a></span> to get CRUD working for the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> table. When we look at security in <span class="Xref">“Security Best Practices” on <a href="#pg_608">page 608</a></span>, we’ll discuss best practices for handling passwords, so we’ll go ahead and add a <span class="SANS_TheSansMonoCd_W5Regular_11">user</span> table storing username and password information.</p>
<p class="TX">Along with the new database table, we’ll need a <span class="SANS_TheSansMonoCd_W5Regular_11">User</span> model class, a <span class="SANS_TheSansMonoCd_W5Regular_11">UserRepository</span> repository class (so named to match the ORM library’s requirements), a <span class="SANS_TheSansMonoCd_W5Regular_11">UserController</span> controller class, and a page for displaying all the users. <a href="#fig30-1">Figure 30-1</a> shows that page. Of course, this page exists just to <span aria-label="602" epub:type="pagebreak" id="pg_602" role="doc-pagebreak"/>illustrate that the database methods are working; displaying a list of usernames and passwords is <i>not</i> an example of secure web development.</p>
<figure class="IMG"><a id="fig30-1"/><img alt="" class="img80" height="869" src="../images/figure30-1.jpg" width="1100"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 30-1: The User List page</span></p></figcaption>
</figure>
<p class="TX">We’ll start by declaring the <span class="SANS_TheSansMonoCd_W5Regular_11">User</span> model class. Add a <i>src/User.php</i> file containing the code in <a href="#lis30-6">Listing 30-6</a> to the project.</p>
<span id="lis30-6"/>
<pre><code>&lt;?php&#13;
namespace Mattsmithdev;&#13;
&#13;
class User&#13;
{&#13;
    private int $id;&#13;
    private string $username;&#13;
    private string $password;&#13;
&#13;
    public function getId(): int&#13;
    {&#13;
        return $this-&gt;id;&#13;
    }&#13;
&#13;
    public function setId(int $id): void&#13;
    {&#13;
        $this-&gt;id = $id;&#13;
    }&#13;
&#13;
    public function getUsername(): string&#13;
    {&#13;
        return $this-&gt;username;&#13;
    }&#13;
&#13;
<span aria-label="603" epub:type="pagebreak" id="pg_603" role="doc-pagebreak"/>    public function setUsername(string $username): void&#13;
    {&#13;
        $this-&gt;username = $username;&#13;
    }&#13;
&#13;
    public function getPassword(): string&#13;
    {&#13;
        return $this-&gt;password;&#13;
    }&#13;
&#13;
    public function setPassword(string $password): void&#13;
    {&#13;
        $this-&gt;password = $password;&#13;
    }&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-6: The</span> <span class="TheSansMonoCd_W5Regular_Italic_11">User</span> <span class="SANS_Futura_Std_Book_Oblique_11">class</span></p>
<p class="TX">The class has an integer <span class="SANS_TheSansMonoCd_W5Regular_11">id</span> property (a requirement for the ORM library) and string properties for <span class="SANS_TheSansMonoCd_W5Regular_11">username</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">password</span>. We declare standard getter and setter methods for each of these properties.</p>
<p class="TX">Now we’ll create the <span class="SANS_TheSansMonoCd_W5Regular_11">UserRepository</span> class in <i>src/UserRepository.php</i>. As with <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span>, we’ll have this class extend the ORM library’s <span class="SANS_TheSansMonoCd_W5Regular_11">DatabaseTableRepository</span> class. <a href="#lis30-7">Listing 30-7</a> shows the code.</p>
<span id="lis30-7"/>
<pre><code>&lt;?php&#13;
namespace Mattsmithdev;&#13;
&#13;
use Mattsmithdev\PdoCrudRepo\DatabaseTableRepository;&#13;
&#13;
class UserRepository extends DatabaseTableRepository&#13;
{&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-7: The simple</span> <span class="TheSansMonoCd_W5Regular_Italic_11">UserRepository</span> <span class="SANS_Futura_Std_Book_Oblique_11">class</span></p>
<p class="TX">We don’t need to declare any methods for this repository class, since it will inherit all the necessary CRUD methods from the <span class="SANS_TheSansMonoCd_W5Regular_11">DatabaseTableRepository</span> class. Thanks to the naming of the <span class="SANS_TheSansMonoCd_W5Regular_11">UserRepository</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">User</span> classes, these CRUD methods will know to work with the <span class="SANS_TheSansMonoCd_W5Regular_11">user</span> table in the database.</p>
<p class="TX">Next, let’s create a <span class="SANS_TheSansMonoCd_W5Regular_11">UserController</span> class, with a method to retrieve all users from the database and display them with a Twig template. Create <i>src/UserController.php</i> containing the code in <a href="#lis30-8">Listing 30-8</a>.</p>
<span id="lis30-8"/>
<pre><code>&lt;?php&#13;
namespace Mattsmithdev;&#13;
&#13;
class UserController extends Controller&#13;
{&#13;
    private UserRepository $userRepository;&#13;
&#13;
<span aria-label="604" epub:type="pagebreak" id="pg_604" role="doc-pagebreak"/>    public function __construct()&#13;
    {&#13;
        parent::__construct();&#13;
        $this-&gt;userRepository = new UserRepository();&#13;
    }&#13;
&#13;
    public function list(): void&#13;
    {&#13;
      <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> $users = $this-&gt;userRepository-&gt;findAll();&#13;
&#13;
        $template = 'user/list.xhtml.twig';&#13;
        $args = [&#13;
            'users' =&gt; $users,&#13;
        ];&#13;
        print $this-&gt;twig-&gt;render($template, $args);&#13;
    }&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-8: The</span> <span class="TheSansMonoCd_W5Regular_Italic_11">UserController</span> <span class="SANS_Futura_Std_Book_Oblique_11">class declaring a</span> <span class="TheSansMonoCd_W5Regular_Italic_11">list()</span> <span class="SANS_Futura_Std_Book_Oblique_11">method</span></p>
<p class="TX">We declare <span class="SANS_TheSansMonoCd_W5Regular_11">UserController</span> as a subclass of <span class="SANS_TheSansMonoCd_W5Regular_11">Controller</span> so that it will inherit a <span class="SANS_TheSansMonoCd_W5Regular_11">twig</span> property for rendering templates. We declare a private <span class="SANS_TheSansMonoCd_W5Regular_11">userRepository</span> property and initialize it in the constructor (where we also must first invoke the parent <span class="SANS_TheSansMonoCd_W5Regular_11">Controller</span> class’s constructor to set up the <span class="SANS_TheSansMonoCd_W5Regular_11">twig</span> property). We then declare a <span class="SANS_TheSansMonoCd_W5Regular_11">list()</span> method, which uses the <span class="SANS_TheSansMonoCd_W5Regular_11">UserRepository</span> object’s <span class="SANS_TheSansMonoCd_W5Regular_11">findAll()</span> method (inherited from the ORM library) to retrieve all users from the database <span aria-label="annotation1" class="CodeAnnotation">❶</span>. The results are returned as an array of objects, which we store as <span class="SANS_TheSansMonoCd_W5Regular_11">$users</span>. We pass this array as the Twig variable <span class="SANS_TheSansMonoCd_W5Regular_11">users</span> for rendering by the <i>templates/user/list.xhtml.twig</i> template.</p>
<p class="TX">Now we’ll add a navigation bar link for the User List page to the base Twig template that all other templates inherit from. Update <i>templates/base.xhtml.twig</i> to match the contents of <a href="#lis30-9">Listing 30-9</a>.</p>
<span id="lis30-9"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;!doctype html&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;html lang="en"&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;body class="container"&gt;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;ul class="nav nav-pills"&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;li class="nav-item"&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        &lt;a class="nav-link {% block homeLink %}{% endblock %}"</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            href="/"&gt;Home page&lt;/a&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;/li&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;li class="nav-item"&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        &lt;a class="nav-link {% block productLink %}{% endblock %}"</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            href="/?action=products"&gt;Product List page&lt;/a&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;/li&gt;</span>&#13;
    &lt;li class="nav-item"&gt;&#13;
        &lt;a class="nav-link {% block userLink %}{% endblock %}"&#13;
            href="/?action=users"&gt;User List page&lt;/a&gt;&#13;
    &lt;/li&gt;&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;/ul&gt;</span>&#13;
&#13;
<span aria-label="605" epub:type="pagebreak" id="pg_605" role="doc-pagebreak"/><span class="TheSansMonoCd_W5Regular_Grey_11">{% block body %}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{% endblock %}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;/body&gt;&lt;/html&gt;</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-9: Adding a user list link to</span> <span class="SANS_Futura_Std_Book_11">/templates/base.xhtml.twig</span></p>
<p class="TX">Here we add a navigation list item with the text <span class="SANS_TheSansMonoCd_W5Regular_11">User List page</span>. The anchor element has an action of <span class="SANS_TheSansMonoCd_W5Regular_11">users</span>, and its CSS class attribute declares an empty Twig block called <span class="SANS_TheSansMonoCd_W5Regular_11">userLink</span>. As with the other navigation bar items, this block can be overridden with the text <span class="SANS_TheSansMonoCd_W5Regular_11">active</span> to highlight the link.</p>
<p class="TX">With the base template updated, we can now create the <i>templates/user/list.xhtml.twig</i> child template for the User List page. <a href="#lis30-10">Listing 30-10</a> shows how.</p>
<span id="lis30-10"/>
<pre><code>{% extends 'base.xhtml.twig' %}&#13;
&#13;
{% block title %}User List page{% endblock %}&#13;
&#13;
<span aria-label="annotation1" class="codeannotated_CodeAnnotation">❶</span> {% block userLink %}active{% endblock %}&#13;
&#13;
{% block body %}&#13;
    &lt;h1&gt;User List page&lt;/h1&gt;&#13;
&#13;
    &lt;ul&gt;&#13;
      <span aria-label="annotation2" class="Code_CodeAnnotation">❷</span> {% for user in users %}&#13;
        &lt;li class="mt-5"&gt;&#13;
            id: {{user.id}}&#13;
            &lt;br&gt;&#13;
            username: {{  user.username}}&#13;
            &lt;br&gt;&#13;
            password: {{  user.password}}&#13;
        &lt;/li&gt;&#13;
        {% endfor %}&#13;
    &lt;/ul&gt;&#13;
{% endblock %}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-10: The</span> <span class="SANS_Futura_Std_Book_11">list.xhtml.twig</span> <span class="SANS_Futura_Std_Book_Oblique_11">template</span></p>
<p class="TX">In this template, we override the <span class="SANS_TheSansMonoCd_W5Regular_11">userLink</span> block to contain the text <span class="SANS_TheSansMonoCd_W5Regular_11">active</span> <span aria-label="annotation1" class="CodeAnnotation">❶</span>, highlighting the User List page link in the navigation bar. In the <span class="SANS_TheSansMonoCd_W5Regular_11">body</span> block, we use a Twig <span class="SANS_TheSansMonoCd_W5Regular_11">for</span> loop <span aria-label="annotation2" class="CodeAnnotation">❷</span> to iterate through the <span class="SANS_TheSansMonoCd_W5Regular_11">users</span> array, creating a list item for each user displaying the associated ID, username, and password.</p>
<p class="TX">Now we need to add a case for the <span class="SANS_TheSansMonoCd_W5Regular_11">action=users</span> route to our front-controller <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class. Update <i>src/Application.php</i> to match the contents of <a href="#lis30-11">Listing 30-11</a>.</p>
<span id="lis30-11"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class Application</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
<span aria-label="606" epub:type="pagebreak" id="pg_606" role="doc-pagebreak"/><span class="TheSansMonoCd_W5Regular_Grey_11">    private DefaultController $defaultController;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private ProductController $productController;</span>&#13;
    private UserController $userController;&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    public function __construct()</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $this-&gt;defaultController = new DefaultController();</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $this-&gt;productController = new ProductController();</span>&#13;
        $this-&gt;userController = new UserController();&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    }</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    public function run(): void</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $action = filter_input(INPUT_GET, 'action');</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $isPostSubmission = ($_SERVER['REQUEST_METHOD'] === 'POST');</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        switch ($action)</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            case 'products':</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">                $this-&gt;productController-&gt;list();</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">                break;</span>&#13;
&#13;
            case 'users':&#13;
                $this-&gt;userController-&gt;list();&#13;
                break;&#13;
&#13;
            <span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-11: Adding a route to the user list in the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">Application</span> <span class="SANS_Futura_Std_Book_Oblique_11">class</span></p>
<p class="TX">We declare a <span class="SANS_TheSansMonoCd_W5Regular_11">userController</span> property and initialize it as a new <span class="SANS_TheSansMonoCd_W5Regular_11">UserController</span> object in the constructor. Then, in the <span class="SANS_TheSansMonoCd_W5Regular_11">switch</span> statement, we declare a case for when the action is <span class="SANS_TheSansMonoCd_W5Regular_11">'users'</span>, invoking the <span class="SANS_TheSansMonoCd_W5Regular_11">list()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">UserController</span> object.</p>
<p class="TX">All we need to do now is add the <span class="SANS_TheSansMonoCd_W5Regular_11">user</span> table to the database schema and insert user rows into the table. Create a new helper script, <i>db/setup_users.php</i>, as shown in <a href="#lis30-12">Listing 30-12</a>.</p>
<span id="lis30-12"/>
<pre><code>&lt;?php&#13;
require_once __DIR__ . '/../vendor/autoload.php';&#13;
&#13;
use Mattsmithdev\User;&#13;
use Mattsmithdev\UserRepository;&#13;
&#13;
$userRepository = new UserRepository();&#13;
&#13;
<span aria-label="annotation1" class="codeannotated_CodeAnnotation">❶</span> $userRepository-&gt;resetTable();&#13;
&#13;
$user1 = new User();&#13;
$user1-&gt;setUsername('matt');&#13;
$user1-&gt;setPassword('password1');&#13;
$userRepository-&gt;insert($user1);&#13;
&#13;
<span aria-label="607" epub:type="pagebreak" id="pg_607" role="doc-pagebreak"/>$user2 = new User();&#13;
$user2-&gt;setUsername('john');&#13;
$user2-&gt;setPassword('password2');&#13;
$userRepository-&gt;insert($user2);&#13;
&#13;
$users = $userRepository-&gt;findAll();&#13;
print '&lt;pre&gt;';&#13;
var_dump($users);&#13;
print '&lt;/pre&gt;';</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-12: The setup script for the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">user</span> <span class="SANS_Futura_Std_Book_Oblique_11">table in</span> <span class="SANS_Futura_Std_Book_11">/db/setup_users.php</span></p>
<p class="TX">When we first set up the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> table in <span class="Xref"><a href="chapter28.xhtml">Chapter 28</a></span>, we had to manually type out and execute each SQL statement to add a new row to the database. Now we can instead build each row as an instance of the <span class="SANS_TheSansMonoCd_W5Regular_11">User</span> class and add it to the table by calling the <span class="SANS_TheSansMonoCd_W5Regular_11">insert()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">UserRepository</span> class (inherited from the ORM library). In this script, we do that for two users, assigning them usernames and passwords.</p>
<p class="TX">First, though, we invoke the <span class="SANS_TheSansMonoCd_W5Regular_11">UserRepository</span> class’s <span class="SANS_TheSansMonoCd_W5Regular_11">resetTable()</span> method <span aria-label="annotation1" class="CodeAnnotation">❶</span>, which drops any existing table mapped to the <span class="SANS_TheSansMonoCd_W5Regular_11">User</span> class and creates a new table based on the names and data types of the <span class="SANS_TheSansMonoCd_W5Regular_11">User</span> class. This is another “free” method automatically available to our repository class through inheritance from the ORM library’s <span class="SANS_TheSansMonoCd_W5Regular_11">DatabaseTableRepository</span> class. To confirm the database table has been created and two <span class="SANS_TheSansMonoCd_W5Regular_11">User</span> records have been inserted, the script ends by retrieving all users from the database with the <span class="SANS_TheSansMonoCd_W5Regular_11">findAll()</span> method and printing them with <span class="SANS_TheSansMonoCd_W5Regular_11">var_dump()</span>.</p>
<p class="TX">Enter <span class="SANS_TheSansMonoCd_W7Bold_11">php db/setup_users.php</span> at the terminal to run this setup script. You should see the following output:</p>
<pre><code>$ <b>php db/setup_users.php</b>&#13;
&lt;pre&gt;array(2) {&#13;
  [0]=&gt;  object(Mattsmithdev\User)#8 (3) {&#13;
    ["id":"Mattsmithdev\User":private]=&gt; int(1)&#13;
    ["username":"Mattsmithdev\User":private]=&gt; string(4) "matt"&#13;
    ["password":"Mattsmithdev\User":private]=&gt; string(9) "password1"&#13;
  }&#13;
  [1]=&gt;  object(Mattsmithdev\User)#9 (3) {&#13;
    ["id":"Mattsmithdev\User":private]=&gt; int(2)&#13;
    ["username":"Mattsmithdev\User":private]=&gt; string(4) "john"&#13;
    ["password":"Mattsmithdev\User":private]=&gt; string(9) "password2"&#13;
  }&#13;
}</code></pre>
<p class="TX">The terminal output shows an array containing two <span class="SANS_TheSansMonoCd_W5Regular_11">User</span> objects, proof that the <span class="SANS_TheSansMonoCd_W5Regular_11">user</span> database table has been added to the database schema, complete with two users. At this point, you can also launch the web application again and visit the User List page. It should look like <a href="#fig30-1">Figure 30-1</a>.</p>
<p class="TX">By working with my <span class="SANS_TheSansMonoCd_W5Regular_11">pdo-crud-for-free-repositories</span> library, we’ve seen how using an ORM library can remove the need to code low-level database queries. This reduces the amount of code required for each individual web application, simplifying the development process. We’ll continue to use this <span aria-label="608" epub:type="pagebreak" id="pg_608" role="doc-pagebreak"/>library as we turn our attention to application security, but later we’ll return to the topic of ORM libraries to see the added benefits of working with a more sophisticated library like Doctrine.</p>
</section>
</section>
<section aria-labelledby="sec6" epub:type="division">
<h3 class="H1" id="sec6"><span id="toc-link_387"/><span class="SANS_Futura_Std_Bold_B_11">Security Best Practices</span></h3>
<p class="TNI1">Security is an essential part of software development, both in your local development environment and when deploying web applications to the real world as public websites. Perhaps the most common manifestation of security a user meets these days is a username/password login form. We’ll explore best practices for securing login information in this section.</p>
<section aria-labelledby="sec7" epub:type="division">
<h4 class="H2" id="sec7"><span id="toc-link_388"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Storing Hashed Passwords</span></h4>
<p class="TNI1">You should never store plaintext passwords in your application’s database. Otherwise, if someone gets access to the database, all those accounts would be compromised. One option for securely storing data is to <i>encrypt</i> it, encoding data in such a way that it can be decoded back to its original form at a later time. When sending confidential messages, for example, it’s common to encrypt them first and to provide the intended recipient with the method for decrypting the message once received. For passwords, however, encryption isn’t the best solution; if the database were accessed, brute-force techniques could allow attackers to eventually decrypt the data (although depending on the speed of their computers, it might take a long time).</p>
<p class="TX">A better technique for password storage is <i>hashing</i>. This is an irreversible way of creating a new piece of data from the original data; there’s no way to reconstruct the plaintext password from the hashed version. The same password passed through the same hash algorithm will always yield the same hash, however. When a user is logging into an application, you can therefore test whether their password is valid by hashing what they’ve entered and comparing it with the hash stored in the database. With this mechanism, there’s no need to ever store the original plaintext password.</p>
<p class="TX">Let’s make our web application more secure by storing hashes rather than plaintext passwords in the <span class="SANS_TheSansMonoCd_W5Regular_11">user</span> database table. Conveniently, modern PHP offers a built-in <span class="SANS_TheSansMonoCd_W5Regular_11">password_hash()</span> function for calculating the hash of a string. We’ll change the <span class="SANS_TheSansMonoCd_W5Regular_11">setPassword()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">User</span> entity class to take advantage of this function. Update <i>src/User.php</i> to match the contents of <a href="#lis30-13">Listing 30-13</a>.</p>
<span id="lis30-13"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class User</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private int $id;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private string $username;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private string $password;</span>&#13;
&#13;
    <span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
&#13;
<span aria-label="609" epub:type="pagebreak" id="pg_609" role="doc-pagebreak"/><span class="TheSansMonoCd_W5Regular_Grey_11">    public function setPassword(string $password): void</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    {</span>&#13;
        $hashedPassword = password_hash($password, PASSWORD_DEFAULT);&#13;
        $this-&gt;password = $hashedPassword;&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    }</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-13: Storing a hashed password in the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">User</span> <span class="SANS_Futura_Std_Book_Oblique_11">class</span></p>
<p class="TX">The revised <span class="SANS_TheSansMonoCd_W5Regular_11">setPassword()</span> method takes in the plaintext password for a new user and passes it to the <span class="SANS_TheSansMonoCd_W5Regular_11">password_hash()</span> function for hashing. The <span class="SANS_TheSansMonoCd_W5Regular_11">PASSWORD_DEFAULT</span> constant means the function will use the strongest hashing algorithm available in the installed version of PHP, though there are other constants for explicitly choosing a particular hashing algorithm. We store the hash in the <span class="SANS_TheSansMonoCd_W5Regular_11">$hashedPassword</span> variable and assign this as the value of the <span class="SANS_TheSansMonoCd_W5Regular_11">User</span> object’s <span class="SANS_TheSansMonoCd_W5Regular_11">password</span> property.</p>
<p class="TX">With this change, any new <span class="SANS_TheSansMonoCd_W5Regular_11">User</span> objects created and passed to the database will contain hashed rather than plaintext passwords. To prove it, rerun our <span class="SANS_TheSansMonoCd_W5Regular_11">user</span> table setup script by entering <span class="SANS_TheSansMonoCd_W7Bold_11">php db/setup_users.php</span> at the command line. This will delete and re-create the table with the modified <span class="SANS_TheSansMonoCd_W5Regular_11">User</span> class. Here’s the resulting <span class="SANS_TheSansMonoCd_W5Regular_11">var_dump()</span> output in the terminal:</p>
<pre><code>$ <b>php db/setup_users.php</b>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;pre&gt;array(2) {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">  [0]=&gt;  object(Mattsmithdev\User)#8 (3) {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    ["id":"Mattsmithdev\User":private]=&gt; int(1)</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    ["username":"Mattsmithdev\User":private]=&gt; string(4) "matt"</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    ["password":"Mattsmithdev\User":private]=&gt; string(60)</span>&#13;
    "$2y$10$k25neEiR.2k8j4gM7Gn6aeiHK8T7ZNgS18QUVsTdm592fGfN23SZG"&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">  }</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">  [1]=&gt;  object(Mattsmithdev\User)#9 (3) {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    ["id":"Mattsmithdev\User":private]=&gt; int(2)</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    ["username":"Mattsmithdev\User":private]=&gt; string(4) "john"</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    ["password":"Mattsmithdev\User":private]=&gt; string(60)</span>&#13;
    "$2y$10$telY8TmtAD7a/niym3/W5OvlKIFbu.CYOfrX0u3yRKdPEyD1V6KRi"&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">  }</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="TX">The black text lines show the hashes in each <span class="SANS_TheSansMonoCd_W5Regular_11">password</span> field. Each hash is a long character string that has no discernible relationship with the original password.</p>
</section>
<section aria-labelledby="sec8" epub:type="division">
<h4 class="H2" id="sec8"><span id="toc-link_389"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Verifying Hashed Passwords at Login</span></h4>
<p class="TNI1">Another useful built-in PHP function is <span class="SANS_TheSansMonoCd_W5Regular_11">password_verify()</span>, which takes in a plaintext password, hashes it, and compares it with an existing hash to determine whether the password is correct. With this function, we can implement a login page for our application, where the user inputs a username and password for verification against their record in the <span class="SANS_TheSansMonoCd_W5Regular_11">user</span> database table. <a href="#fig30-2">Figure 30-2</a> shows the login page we’ll create.</p>
<span aria-label="610" epub:type="pagebreak" id="pg_610" role="doc-pagebreak"/>
<figure class="IMG"><a id="fig30-2"/><img alt="" class="img80" height="456" src="../images/figure30-2.jpg" width="996"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 30-2: The new login page</span></p></figcaption>
</figure>
<p class="TX">Our application will need two new routes, one to request display of the login page (<span class="SANS_TheSansMonoCd_W5Regular_11">action=login</span>) and one to request processing of the submitted data from the login form (<span class="SANS_TheSansMonoCd_W5Regular_11">action=processLogin</span>). First, we’ll add cases for these routes to our front-controller <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class. Update the <span class="SANS_TheSansMonoCd_W5Regular_11">switch</span> statement in <i>src/Application.php</i> to match <a href="#lis30-14">Listing 30-14</a>.</p>
<span id="lis30-14"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class Application</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
    <span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    public function run(): void</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $action = filter_input(INPUT_GET, 'action');</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $isPostSubmission = ($_SERVER['REQUEST_METHOD'] === 'POST');</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        switch ($action)</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        {</span>&#13;
            case 'login':&#13;
                $this-&gt;userController-&gt;loginForm(); <span aria-label="annotation1" class="codewide_CodeAnnotation">❶</span>&#13;
                break;&#13;
&#13;
            case 'processLogin':&#13;
                $username = filter_input(INPUT_POST, 'username');&#13;
                $password = filter_input(INPUT_POST, 'password');&#13;
                if (empty($username) || empty($password)) {<span aria-label="annotation2" class="codewide_CodeAnnotation">❷</span>&#13;
                    $this-&gt;defaultController-&gt;error(&#13;
                        'error - you must enter both a username and a password to login');&#13;
                } else {&#13;
                    $this-&gt;userController-&gt;processLogin($username, $password); <span aria-label="annotation3" class="codewide_CodeAnnotation">❸</span>&#13;
                }&#13;
                break;&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-14: Adding login routes to the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">Application</span> <span class="SANS_Futura_Std_Book_Oblique_11">class</span></p>
<p class="TX">For the <span class="SANS_TheSansMonoCd_W5Regular_11">'login'</span> case, we invoke the <span class="SANS_TheSansMonoCd_W5Regular_11">loginForm()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">UserController</span> object <span aria-label="annotation1" class="CodeAnnotation">❶</span>. For the <span class="SANS_TheSansMonoCd_W5Regular_11">'processLogin'</span> case, we first attempt to extract <span aria-label="611" epub:type="pagebreak" id="pg_611" role="doc-pagebreak"/>the <span class="SANS_TheSansMonoCd_W5Regular_11">'username'</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">'password'</span> values from the variables received in the <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> request. If either is empty <span aria-label="annotation2" class="CodeAnnotation">❷</span>, an appropriate error message is displayed by passing a string message to the <span class="SANS_TheSansMonoCd_W5Regular_11">error()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">DefaultController</span> object. Otherwise, the username and password are passed to the <span class="SANS_TheSansMonoCd_W5Regular_11">processLogin()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">UserController</span> object <span aria-label="annotation3" class="CodeAnnotation">❸</span>.</p>
<p class="TX">Now we need to add the new methods to the <span class="SANS_TheSansMonoCd_W5Regular_11">UserController</span> class. Update <i>src/UserController.php</i> as shown in <a href="#lis30-15">Listing 30-15</a>.</p>
<span id="lis30-15"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class UserController extends Controller</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
&#13;
    public function loginForm(): void&#13;
    {&#13;
        $template = 'user/login.xhtml.twig';&#13;
        $args = [];&#13;
        print $this-&gt;twig-&gt;render($template, $args);&#13;
    }&#13;
&#13;
    public function processLogin(string $username, string $password): void&#13;
    {&#13;
      <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> $loginSuccess = $this-&gt;isValidUsernamePassword($username, $password);&#13;
        if ($loginSuccess) {&#13;
            print 'success - username and password found in database';&#13;
        } else {&#13;
            print 'sorry - there was an error with your username/password';&#13;
        }&#13;
    }&#13;
&#13;
    private function isValidUsernamePassword($username, $password): bool&#13;
    {&#13;
      <span aria-label="annotation2" class="Code_CodeAnnotation">❷</span> $user = $this-&gt;userRepository-&gt;findOneByUsername($username);&#13;
&#13;
        // False if no user for username&#13;
        if ($user == NULL) {&#13;
            return false;&#13;
        }&#13;
&#13;
        // See if entered password matches stored (hashed) one&#13;
      <span aria-label="annotation3" class="Code_CodeAnnotation">❸</span> return password_verify($password, $user-&gt;getPassword());&#13;
    }&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-15: Adding login methods to the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">UserController</span> <span class="SANS_Futura_Std_Book_Oblique_11">class</span></p>
<p class="TX"><span aria-label="612" epub:type="pagebreak" id="pg_612" role="doc-pagebreak"/>For the <span class="SANS_TheSansMonoCd_W5Regular_11">loginForm()</span> method, we simply render the appropriate Twig template, which doesn’t require any arguments. For the <span class="SANS_TheSansMonoCd_W5Regular_11">processLogin()</span> method, we take in the received <span class="SANS_TheSansMonoCd_W5Regular_11">$username</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">$password</span> variables and pass them to the <span class="SANS_TheSansMonoCd_W5Regular_11">isValidUsernamePassword()</span> helper method <span aria-label="annotation1" class="CodeAnnotation">❶</span>, which returns a Boolean. If <span class="SANS_TheSansMonoCd_W5Regular_11">true</span>, we print a success message, or an error message if <span class="SANS_TheSansMonoCd_W5Regular_11">false</span>. In a full web application, at this stage, we would store the login success in the session as we did in <span class="Xref"><a href="chapter16.xhtml">Chapter 16</a></span>.</p>
<p class="TX">The <span class="SANS_TheSansMonoCd_W5Regular_11">isValidUsernamePassword()</span> helper is responsible for determining whether the database holds a record matching the received username and password. First, we call the <span class="SANS_TheSansMonoCd_W5Regular_11">UserRepository</span> class method <span class="SANS_TheSansMonoCd_W5Regular_11">findOneByUsername()</span>, which attempts to retrieve a record (in the form of a <span class="SANS_TheSansMonoCd_W5Regular_11">User</span> object) from the <span class="SANS_TheSansMonoCd_W5Regular_11">user</span> table matching the provided username <span aria-label="annotation2" class="CodeAnnotation">❷</span>. If a single user can’t be retrieved, <span class="SANS_TheSansMonoCd_W5Regular_11">findOneByUsername()</span> returns <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span>, in which case the validation method returns <span class="SANS_TheSansMonoCd_W5Regular_11">false</span>. Otherwise, we call PHP’s built-in <span class="SANS_TheSansMonoCd_W5Regular_11">password_verify()</span> function, passing it the submitted password (<span class="SANS_TheSansMonoCd_W5Regular_11">$password</span>) and the correct password hash (accessed with the <span class="SANS_TheSansMonoCd_W5Regular_11">User</span> object’s <span class="SANS_TheSansMonoCd_W5Regular_11">getPassword()</span> method) <span aria-label="annotation3" class="CodeAnnotation">❸</span>. The <span class="SANS_TheSansMonoCd_W5Regular_11">password_verify()</span> function hashes the provided plaintext password and returns a Boolean indicating whether it matches the provided hash.</p>
<aside aria-labelledby="box-16" class="box">
<h5 class="BoxTitle" id="box-16"><span class="SANS_Dogma_OT_Bold_B_11">TIMING ATTACKS</span></h5>
<p class="BoxBodyFirst"><span class="SANS_Futura_Std_Book_11">You may be wondering why PHP’s</span> <span class="SANS_TheSansMonoCd_W5Regular_11">password_verify()</span> <span class="SANS_Futura_Std_Book_11">function exists. Couldn’t we just use</span> <span class="SANS_TheSansMonoCd_W5Regular_11">password_hash()</span> <span class="SANS_Futura_Std_Book_11">on the submitted password and compare the resulting string with the correct password hash stored in the database? We could, but that would open up the application to a security vulnerability known as a</span> <span class="SANS_Futura_Std_Book_Oblique_11">timing attack</span><span class="SANS_Futura_Std_Book_11">.</span></p>
<p class="BoxBody"><span class="SANS_Futura_Std_Book_11">Simple string-comparison functions examine two strings character by character and return</span> <span class="SANS_TheSansMonoCd_W5Regular_11">false</span> <span class="SANS_Futura_Std_Book_11">as soon as they encounter a pair of characters that don’t match. The longer the function takes before returning</span> <span class="SANS_TheSansMonoCd_W5Regular_11">false</span><span class="SANS_Futura_Std_Book_11">, the more characters at the start of the strings must have matched. In timing attacks, hackers use this fact to their advantage by deliberately entering incorrect passwords with known hashes and measuring how long the application takes to report these passwords as incorrect. Based on the timings, they can infer information about the correct hash.</span></p>
<p class="BoxBody"><span class="SANS_Futura_Std_Book_11">The</span> <span class="SANS_TheSansMonoCd_W5Regular_11">password_verify()</span> <span class="SANS_Futura_Std_Book_11">function is specially designed to guard against timing attacks. After hashing the input password, it uses a</span> <span class="SANS_Futura_Std_Book_Oblique_11">constant-time function</span> <span class="SANS_Futura_Std_Book_11">to compare it with the stored hash. The comparison takes the same amount of time no matter how many characters do or don’t match, so no information about the stored hash is exposed.</span></p>
</aside>
<p class="TX"><span aria-label="613" epub:type="pagebreak" id="pg_613" role="doc-pagebreak"/>Now let’s write the <span class="SANS_TheSansMonoCd_W5Regular_11">findOneByUsername()</span> method for the <span class="SANS_TheSansMonoCd_W5Regular_11">UserRepository</span> class. Update <i>src/UserRepository.php</i> to match the code in <a href="#lis30-16">Listing 30-16</a>.</p>
<span id="lis30-16"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">use Mattsmithdev\PdoCrudRepo\DatabaseTableRepository;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class UserRepository extends DatabaseTableRepository</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
    public function findOneByUsername(string $username): ?User&#13;
    {&#13;
        $users = $this-&gt;searchByColumn('username', $username);&#13;
&#13;
        if (count($users) != 1) {&#13;
            return NULL;&#13;
        }&#13;
&#13;
        return $users[0];&#13;
    }&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-16: Adding the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">findOneByUsername()</span> <span class="SANS_Futura_Std_Book_Oblique_11">method to the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">UserRepository</span> <span class="SANS_Futura_Std_Book_Oblique_11">class</span></p>
<p class="TX">The new <span class="SANS_TheSansMonoCd_W5Regular_11">findOneByUsername()</span> method has a nullable <span class="SANS_TheSansMonoCd_W5Regular_11">?User</span> return type. It uses the <span class="SANS_TheSansMonoCd_W5Regular_11">searchByColumn()</span> method inherited from the ORM library, which takes in a column name (<span class="SANS_TheSansMonoCd_W5Regular_11">'username'</span>) and a value (in the <span class="SANS_TheSansMonoCd_W5Regular_11">$username</span> variable) and returns an array of records where the value in that column of the database table is a match. If the resulting array doesn’t have a length of exactly <span class="SANS_TheSansMonoCd_W5Regular_11">1</span> (either because it’s empty or because multiple records were retrieved), <span class="SANS_TheSansMonoCd_W5Regular_11">findOneByUsername()</span> returns <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span>. However, if a single user matches the submitted username string, the corresponding <span class="SANS_TheSansMonoCd_W5Regular_11">User</span> object is returned.</p>
<p class="TX">Note that the logic in this method could have been made part of the <span class="SANS_TheSansMonoCd_W5Regular_11">isValidUsernamePassword()</span> method in <span class="SANS_TheSansMonoCd_W5Regular_11">UserController</span>, but what’s needed is a query for a user with a given username, which is a model database query. It therefore makes sense to create this as a custom method in our <span class="SANS_TheSansMonoCd_W5Regular_11">UserRepository</span> class, where all the code for querying the <span class="SANS_TheSansMonoCd_W5Regular_11">user</span> database table lives. It’s also worth highlighting that even though we’re relying on an ORM library for generic methods such as <span class="SANS_TheSansMonoCd_W5Regular_11">find()</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">findAll()</span>, it’s often still necessary to extend a repository class with custom database methods that support the more specialized controller logic specific to the application at hand. In this case, we need to search by the <span class="SANS_TheSansMonoCd_W5Regular_11">username</span> column rather than <span class="SANS_TheSansMonoCd_W5Regular_11">id</span>, so the inherited <span class="SANS_TheSansMonoCd_W5Regular_11">find()</span> method wouldn’t do. The ORM library is still helping us through the <span class="SANS_TheSansMonoCd_W5Regular_11">searchByColumn()</span> method, but we still need the custom logic of verifying that exactly one <span class="SANS_TheSansMonoCd_W5Regular_11">User</span> object has been retrieved.</p>
<p class="TX">Next, we’ll add a login page link to the navigation bar in the base template. Update <i>templates/base.xhtml.twig</i> as shown in <a href="#lis30-17">Listing 30-17</a>.</p>
<span id="lis30-17"/>
<pre><code><span aria-label="614" epub:type="pagebreak" id="pg_614" role="doc-pagebreak"/><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;!doctype html&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;html lang="en"&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;body class="container"&gt;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;ul class="nav nav-pills"&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">    --snip--</span>&#13;
    &lt;li class="nav-item"&gt;&#13;
        &lt;a class="nav-link" href="/?action=login"&gt;Login&lt;/a&gt;&#13;
    &lt;/li&gt;&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;/ul&gt;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{% block body %}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{% endblock %}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;/body&gt;&lt;/html&gt;</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-17: Adding a login link to the</span> <span class="SANS_Futura_Std_Book_11">base.xhtml.twig</span> <span class="SANS_Futura_Std_Book_Oblique_11">template</span></p>
<p class="TX">Here we add a navigation list item with the text <span class="SANS_TheSansMonoCd_W5Regular_11">Login</span> and a URL route of <span class="SANS_TheSansMonoCd_W5Regular_11">action=login</span>. With that added, we can create the child template for the login page itself in <i>/templates/user/login.xhtml.twig</i>. <a href="#lis30-18">Listing 30-18</a> shows the code.</p>
<span id="lis30-18"/>
<pre><code>{% extends 'base.xhtml.twig' %}&#13;
&#13;
{% block title %}login page{% endblock %}&#13;
&#13;
{% block body %}&#13;
    &lt;h1&gt;Login&lt;/h1&gt;&#13;
&#13;
    &lt;form method="POST" action="/?action=processLogin"&gt;&#13;
        &lt;p&gt;&#13;
            Username:&#13;
            &lt;input name="username"&gt;&#13;
        &lt;/p&gt;&#13;
        &lt;p&gt;&#13;
            Password:&#13;
          <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> &lt;input name="password" type="password"&gt;&#13;
        &lt;/p&gt;&#13;
        &lt;input type="submit"&gt;&#13;
    &lt;/form&gt;&#13;
{% endblock %}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-18: The</span> <span class="SANS_Futura_Std_Book_11">login.xhtml.twig</span> <span class="SANS_Futura_Std_Book_Oblique_11">template</span></p>
<p class="TX">The body of the page features a <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;form&gt;</span> element with a <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> action of <span class="SANS_TheSansMonoCd_W5Regular_11">processLogin</span>. The form features fields for a username and password, along with a Submit button. Notice that the password input is of type <span class="SANS_TheSansMonoCd_W5Regular_11">"password"</span> <span aria-label="annotation1" class="CodeAnnotation">❶</span>. With this setting, the browser will display placeholder characters such as dots or asterisks, hiding the actual characters the user enters.</p>
<p class="TX">Try testing out the new login form with the username <span class="SANS_TheSansMonoCd_W5Regular_11">matt</span> and password <span class="SANS_TheSansMonoCd_W5Regular_11">password1</span>, or with any incorrect username/password combination. Thanks to PHP’s secure, handy <span class="SANS_TheSansMonoCd_W5Regular_11">password_verify()</span> function, you should find <span aria-label="615" epub:type="pagebreak" id="pg_615" role="doc-pagebreak"/>that the form works, even though the database is storing password hashes rather than plaintext passwords.</p>
</section>
<section aria-labelledby="sec9" epub:type="division">
<h4 class="H2" id="sec9"><span id="toc-link_390"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Securing Database Credentials</span></h4>
<p class="TNI1">Another important security measure for web applications is to avoid exposing your database credentials. Whether you declare these credentials as class constants or in a completely separate file such as <i>.env</i>, as we did earlier in the chapter, it’s important not to have them in any public-facing files.</p>
<p class="TX">To begin, you should have only a single file for your credentials. If you’re using class constants rather than a <i>.env</i> file, I recommend having a completely separate class that just declares the constants. Then you can reference this class from your <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span> class (or whatever other class is responsible for establishing the database connection).</p>
<p class="TX">Next, mark the file containing your credentials to be ignored by any backup or archiving system. For example, if you’re using the Git distributed version control system, you’d list this file in your project’s <i>.gitignore</i> file.</p>
</section>
</section>
<section aria-labelledby="sec10" epub:type="division">
<h3 class="H1" id="sec10"><span id="toc-link_391"/><span class="SANS_Futura_Std_Bold_B_11">The Doctrine ORM Library</span></h3>
<p class="TNI1">The open source Doctrine project is a well-maintained, fully featured PHP ORM library. It’s widely used; for example, the Symfony framework uses Doctrine for all database communications. My small ORM library is fine for small projects and for learning the basics, but for larger projects with many interrelated model classes, Doctrine is a more robust, sophisticated solution. Some of its features include easily facilitating object-to-object references that become foreign keys in the database schema and providing low-level control of the database table and column names beyond the default naming conventions.</p>
<p class="TX">After <a href="#lis30-5">Listing 30-5</a> (before adding the <span class="SANS_TheSansMonoCd_W5Regular_11">User</span> model class), you were asked to make a copy of your project. (Don’t worry if you didn’t make a copy of your project at that point; you can copy my <span class="SANS_TheSansMonoCd_W5Regular_11">listing30-05</span> from the book codes at <i><a href="https://github.com/dr-matt-smith/php-crash-course">https://github.com/dr-matt-smith/php-crash-course</a></i>.) The coming sections will show you how to adapt that copy of the project to use Doctrine rather than my <span class="SANS_TheSansMonoCd_W5Regular_11">pdo-crud-for-free-repositories</span> ORM library.</p>
<section aria-labelledby="sec11" epub:type="division">
<h4 class="H2" id="sec11"><span id="toc-link_392"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Removing the Previous ORM Library</span></h4>
<p class="TNI1">First, let’s remove the previous ORM library features from the project. Enter the following at the command line to remove the <span class="SANS_TheSansMonoCd_W5Regular_11">pdo-crud-for-free -repositories</span> library from the project’s <i>/vendor</i> folder and <i>composer.json</i> project dependencies file:</p>
<pre><code>$ <b>composer remove mattsmithdev/pdo-crud-for-free-repositories</b></code></pre>
<p class="TX">We also need to remove the references to the old library’s <span class="SANS_TheSansMonoCd_W5Regular_11">DatabaseTableRepository</span> class from the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> class declaration. <a href="#lis30-19">Listing 30-19</a> shows how to update the <i>src/UserRepository.php</i> file.</p>
<span id="lis30-19"/>
<pre><code><span aria-label="616" epub:type="pagebreak" id="pg_616" role="doc-pagebreak"/><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
class ProductRepository&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-19: The</span> <span class="TheSansMonoCd_W5Regular_Italic_11">ProductRepository</span> <span class="SANS_Futura_Std_Book_Oblique_11">class, without inheriting from the ORM library</span></p>
<p class="TX">For now, we’re left with an empty class declaration, but later we’ll return to the class and integrate it with Doctrine.</p>
</section>
<section aria-labelledby="sec12" epub:type="division">
<h4 class="H2" id="sec12"><span id="toc-link_393"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Adding Doctrine</span></h4>
<p class="TNI1">Now we’ll use Composer to add the Doctrine ORM library to the project, along with two other required libraries. Enter the following at the command line:</p>
<pre><code>$ <b>composer require doctrine/orm</b>&#13;
$ <b>composer require symfony/cache</b>&#13;
$ <b>composer require symfony/dotenv</b></code></pre>
<p class="TX">Doctrine requires a cache to aid its performance, and <span class="SANS_TheSansMonoCd_W5Regular_11">symfony/cache</span> is the recommended choice. Additionally, <span class="SANS_TheSansMonoCd_W5Regular_11">symfony/dotenv</span> will make it easy to access values from the project’s <i>.env</i> file.</p>
<p class="TX">Next, we need to connect Doctrine with the database. Create a script in the project’s top-level directory named <i>bootstrap.php</i>, containing the code in <a href="#lis30-20">Listing 30-20</a>. This script is based on Doctrine’s documentation pages at <i><a href="https://www.doctrine-project.org">https://www.doctrine-project.org</a></i>.</p>
<span id="lis30-20"/>
<pre><code>&lt;?php&#13;
require_once "vendor/autoload.php";&#13;
&#13;
use Doctrine\DBAL\DriverManager;&#13;
use Doctrine\ORM\EntityManager;&#13;
use Doctrine\ORM\ORMSetup;&#13;
use Symfony\Component\Dotenv\Dotenv;&#13;
&#13;
<span aria-label="annotation1" class="codeannotated_CodeAnnotation">❶</span> $dotenv = new Dotenv();&#13;
$dotenv-&gt;load(__DIR__ . '/.env');&#13;
&#13;
// Get Doctrine to create DB connection&#13;
$connectionParams = [&#13;
    'dbname' =&gt; $_ENV['MYSQL_DATABASE'],&#13;
    'user' =&gt; $_ENV['MYSQL_USER'],&#13;
    'password' =&gt; $_ENV['MYSQL_PASSWORD'],&#13;
    'host' =&gt; $_ENV['MYSQL_HOST'],&#13;
    'driver' =&gt; 'pdo_mysql',&#13;
];&#13;
&#13;
$config = ORMSetup::createAttributeMetadataConfiguration(&#13;
    paths: [__DIR__.'/src'],&#13;
<span aria-label="617" epub:type="pagebreak" id="pg_617" role="doc-pagebreak"/>    isDevMode: true,&#13;
);&#13;
<span aria-label="annotation2" class="codeannotated_CodeAnnotation">❷</span> $connection = DriverManager::getConnection($connectionParams, $config);&#13;
<span aria-label="annotation3" class="codeannotated_CodeAnnotation">❸</span> $entityManager = new EntityManager($connection, $config);</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-20: The</span> <span class="SANS_Futura_Std_Book_11">bootstrap.php</span> <span class="SANS_Futura_Std_Book_Oblique_11">script to set up Doctrine</span></p>
<p class="TX">We read in the Composer autoloader, create a <span class="SANS_TheSansMonoCd_W5Regular_11">Dotenv</span> object to load the database credentials from the project’s <i>.env</i> file <span aria-label="annotation1" class="CodeAnnotation">❶</span>, and package those credentials into a <span class="SANS_TheSansMonoCd_W5Regular_11">$connectionParams</span> array. We then use this array and some Doctrine static methods to establish a database connection <span aria-label="annotation2" class="CodeAnnotation">❷</span> and create an <span class="SANS_TheSansMonoCd_W5Regular_11">EntityManager</span> object <span aria-label="annotation3" class="CodeAnnotation">❸</span>. The <span class="SANS_TheSansMonoCd_W5Regular_11">EntityManager</span> class is key to the way Doctrine works; the class maintains the link between the model class objects in the PHP code and their corresponding database table rows defined with unique primary keys.</p>
<p class="TX">Any other script that reads in <i>bootstrap.php</i> will now have access to a database connection through the <span class="SANS_TheSansMonoCd_W5Regular_11">$connection</span> variable and to Doctrine’s entity manager through the <span class="SANS_TheSansMonoCd_W5Regular_11">$entityManager</span> variable.</p>
</section>
<section aria-labelledby="sec13" epub:type="division">
<h4 class="H2" id="sec13"><span id="toc-link_394"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Verifying That Doctrine Is Working</span></h4>
<p class="TNI1">Before we go any further, let’s make sure Doctrine is successfully linked with the project’s database. <a href="#lis30-21">Listing 30-21</a> shows a simple script that tests Doctrine by retrieving <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> objects from the database as an associative array. Save this script as <i>public/doctrine1.php</i>.</p>
<span id="lis30-21"/>
<pre><code>&lt;?php&#13;
require_once __DIR__ . '/../vendor/autoload.php';&#13;
require_once __DIR__ . '/../bootstrap.php';&#13;
&#13;
$sql = 'SELECT * FROM product';&#13;
$stmt = $connection-&gt;executeQuery($sql);&#13;
$result = $stmt-&gt;fetchAllAssociative();&#13;
&#13;
// Print results&#13;
foreach ($result as $row) {&#13;
    print "ID: {$row['id']}, Description: {$row['description']}\n";&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-21: The</span> <span class="SANS_Futura_Std_Book_11">doctrine1.php</span> <span class="SANS_Futura_Std_Book_Oblique_11">script to retrieve existing rows from the database</span></p>
<p class="TX">After reading in the autoloader and the Doctrine bootstrap script, we create an SQL query to select all rows from the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> database table, then execute the query by using the Doctrine database connection (in the <span class="SANS_TheSansMonoCd_W5Regular_11">$connection</span> variable). The results are returned as a nested array; each inner array maps the column names to the values in a particular row of the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> database table. We loop through this array and print each row. If you run this <i>public/doctrine1.php</i> script, you should see the following output:</p>
<pre><code>ID: 1, Description: bag of nails&#13;
ID: 2, Description: bucket</code></pre>
<p class="TX"><span aria-label="618" epub:type="pagebreak" id="pg_618" role="doc-pagebreak"/>We’ve successfully retrieved the two products from the database, indicating that Doctrine is up and running.</p>
</section>
<section aria-labelledby="sec14" epub:type="division">
<h4 class="H2" id="sec14"><span id="toc-link_395"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Creating Database Tables</span></h4>
<p class="TNI1">One of Doctrine’s strengths is its ability to update the structure of a database based on the classes it encounters in the application’s PHP code, creating new tables and columns as needed. To see how this works, let’s switch our project over to a new, empty database. Then we can use Doctrine to create the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> table from scratch.</p>
<p class="TX">To begin, open the project’s <i>.env</i> file and change the value associated with the <span class="SANS_TheSansMonoCd_W5Regular_11">MYSQL_DATABASE</span> key to <span class="SANS_TheSansMonoCd_W5Regular_11">demo2</span>. Next, we need to write a script to create this new <span class="SANS_TheSansMonoCd_W5Regular_11">demo2</span> database schema. Create <i>db/create_database.php</i> and enter the contents of <a href="#lis30-22">Listing 30-22</a>.</p>
<span id="lis30-22"/>
<pre><code>&lt;?php&#13;
require_once __DIR__ . '/../vendor/autoload.php';&#13;
&#13;
use Symfony\Component\Dotenv\Dotenv;&#13;
use Doctrine\DBAL\DriverManager;&#13;
&#13;
$dotenv = new Dotenv(); <span aria-label="annotation1" class="codewide_CodeAnnotation">❶</span>&#13;
$dotenv-&gt;load(__DIR__ . '/../.env');&#13;
&#13;
$connectionParams = [&#13;
    'user' =&gt; $_ENV['MYSQL_USER'],&#13;
    'password' =&gt; $_ENV['MYSQL_PASSWORD'],&#13;
    'host' =&gt; "{$_ENV['MYSQL_HOST']}:{$_ENV['MYSQL_PORT']}",&#13;
    'driver' =&gt; 'pdo_mysql',&#13;
];&#13;
&#13;
try {&#13;
    // Get connection&#13;
    $connection = DriverManager::getConnection($connectionParams); <span aria-label="annotation2" class="codewide_CodeAnnotation">❷</span>&#13;
&#13;
    $databaseNames = $connection-&gt;createSchemaManager()-&gt;listDatabases();&#13;
    $databaseExists = array_search($_ENV['MYSQL_DATABASE'], $databaseNames); <span aria-label="annotation3" class="codewide_CodeAnnotation">❸</span>&#13;
    // Drop database if exists already&#13;
    if ($databaseExists) {&#13;
        $connection-&gt;createSchemaManager()-&gt;dropDatabase($_ENV['MYSQL_DATABASE']);&#13;
    }&#13;
&#13;
    // Create database&#13;
    $connection-&gt;createSchemaManager()-&gt;createDatabase($_ENV['MYSQL_DATABASE']); <span aria-label="annotation4" class="codewide_CodeAnnotation">❹</span>&#13;
&#13;
    print "succeeded in (re)creating database: {$_ENV['MYSQL_DATABASE']}\n";&#13;
} catch (Exception $e) {<span aria-label="annotation5" class="codewide_CodeAnnotation">❺</span>&#13;
    print "there was a problem creating the database: $e";&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-22: The</span> <span class="SANS_Futura_Std_Book_11">db/create_database.php</span> <span class="SANS_Futura_Std_Book_Oblique_11">script to create the database named in the</span> <span class="SANS_Futura_Std_Book_11">.env</span> <span class="SANS_Futura_Std_Book_Oblique_11">file</span></p>
<p class="TX"><span aria-label="619" epub:type="pagebreak" id="pg_619" role="doc-pagebreak"/>We use a <span class="SANS_TheSansMonoCd_W5Regular_11">Dotenv</span> object <span aria-label="annotation1" class="CodeAnnotation">❶</span> to read the database credentials from the <i>.env</i> file and create an array of connection parameters. Then, inside a <span class="SANS_TheSansMonoCd_W5Regular_11">try...catch</span> block, we create a connection to the MySQL database server by using Doctrine’s <span class="SANS_TheSansMonoCd_W5Regular_11">DriverManager::getConnection()</span> method <span aria-label="annotation2" class="CodeAnnotation">❷</span>. We then get an array of all the database names and search that array for the database name from our <i>.env</i> file, storing the result (<span class="SANS_TheSansMonoCd_W5Regular_11">true</span> or <span class="SANS_TheSansMonoCd_W5Regular_11">false</span>) in the <span class="SANS_TheSansMonoCd_W5Regular_11">$databaseExists</span> variable <span aria-label="annotation3" class="CodeAnnotation">❸</span>.</p>
<p class="TX">If the database exists, we drop it by using the <span class="SANS_TheSansMonoCd_W5Regular_11">dropDatabase()</span> method. Then we create the database anew by using the <span class="SANS_TheSansMonoCd_W5Regular_11">createDatabase()</span> method <span aria-label="annotation4" class="CodeAnnotation">❹</span> and print a success message. If any <span class="SANS_TheSansMonoCd_W5Regular_11">Exception</span> is caught <span aria-label="annotation5" class="CodeAnnotation">❺</span>, we print an error message instead. Run this script and you should now have a new, empty database schema called <span class="SANS_TheSansMonoCd_W5Regular_11">demo2</span>.</p>
<p class="TX">The basic usage of Doctrine is to run a command line script that reads metadata about model classes in the PHP code (called <i>entity classes</i> in Doctrine’s parlance) and executes SQL statements to create corresponding structures in the database schema. The command line script is usually placed in a file called <i>/bin/doctrine</i> (without the.<i>php</i> file extension). Create this file as shown in <a href="#lis30-23">Listing 30-23</a>.</p>
<span id="lis30-23"/>
<pre><code>&lt;?php&#13;
require_once __DIR__ . '/../bootstrap.php';&#13;
&#13;
use Doctrine\ORM\Tools\Console\ConsoleRunner;&#13;
use Doctrine\ORM\Tools\Console\EntityManagerProvider\SingleManagerProvider;&#13;
&#13;
ConsoleRunner::run(new SingleManagerProvider($entityManager), []);</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-23: The</span> <span class="SANS_Futura_Std_Book_11">/bin/doctrine</span> <span class="SANS_Futura_Std_Book_Oblique_11">command line script</span></p>
<p class="TX">This script invokes the <span class="SANS_TheSansMonoCd_W5Regular_11">run()</span> method of Doctrine’s <span class="SANS_TheSansMonoCd_W5Regular_11">ConsoleRunner</span> class. The method takes in the arguments from the command line and uses them to run whatever Doctrine command has been entered after <span class="SANS_TheSansMonoCd_W5Regular_11">bin/doctrine</span> in the terminal. Let’s run this script to try updating the new database schema. Enter <span class="SANS_TheSansMonoCd_W7Bold_11">php bin/doctrine orm:schema-tool:create</span> at the command line. You should see the following output:</p>
<pre><code>$ <b>php bin/doctrine orm:schema-tool:create</b>&#13;
[OK] No Metadata Classes to process.</code></pre>
<p class="TX">The script hasn’t done anything because we haven’t yet added any of the necessary metadata for Doctrine to know which model classes and properties should be mapped to which database tables and columns. We’ll now add metadata to the <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> model class so that Doctrine will have a table to create in the database. As you’ll see, each metadata tag is preceded by a hash mark (<span class="SANS_TheSansMonoCd_W5Regular_11">#</span>) and enclosed in square brackets. Modify the <i>src/Product.php</i> file as shown in <a href="#lis30-24">Listing 30-24</a>.</p>
<span id="lis30-24"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
use Doctrine\ORM\Mapping as ORM;&#13;
&#13;
<span aria-label="620" epub:type="pagebreak" id="pg_620" role="doc-pagebreak"/><span aria-label="annotation1" class="codeannotated_CodeAnnotation">❶</span> #[ORM\Entity]&#13;
#[ORM\Table(name: 'product')]&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class Product</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
<b>  </b><span aria-label="annotation2" class="Code_CodeAnnotation">❷</span><b> </b>#[ORM\Id]&#13;
    #[ORM\Column(type: 'integer')]&#13;
    #[ORM\GeneratedValue]&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private ?int $id;</span>&#13;
&#13;
<b>    </b>#[ORM\Column(type: 'string')]&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private string $description;</span>&#13;
&#13;
<b>    </b>#[ORM\Column()]&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private float $price;</span>&#13;
&#13;
    <span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-24: Adding Doctrine metadata to the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">Product</span> <span class="SANS_Futura_Std_Book_Oblique_11">class</span></p>
<p class="TX">To keep the metadata easier to read, we start with a <span class="SANS_TheSansMonoCd_W5Regular_11">use</span> statement aliasing the <span class="SANS_TheSansMonoCd_W5Regular_11">Doctrine\ORM\Mapping</span> class as <span class="SANS_TheSansMonoCd_W5Regular_11">ORM</span>. Then we add metadata to the class itself and to each of its properties. We declare the class as an <span class="SANS_TheSansMonoCd_W5Regular_11">Entity</span> <span aria-label="annotation1" class="CodeAnnotation">❶</span>, indicating that it should correspond to a database table, and specify that this table should be named <span class="SANS_TheSansMonoCd_W5Regular_11">product</span>. Without the latter, Doctrine would default to <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> (starting with a capital letter) as the table name, to match the class name.</p>
<p class="TX">For the class’s <span class="SANS_TheSansMonoCd_W5Regular_11">id</span> property, the <span class="SANS_TheSansMonoCd_W5Regular_11">Id</span> tag indicates that this property should be used as the primary key <span aria-label="annotation2" class="CodeAnnotation">❷</span>, <span class="SANS_TheSansMonoCd_W5Regular_11">Column</span> indicates the property should correspond to a column in the database table, and <span class="SANS_TheSansMonoCd_W5Regular_11">GeneratedValue</span> means the property should be auto-incremented in the database system. For the remaining properties, all we need is the <span class="SANS_TheSansMonoCd_W5Regular_11">Column</span> tag. Notice that we can either specify the database column’s data type as part of the <span class="SANS_TheSansMonoCd_W5Regular_11">Column</span> tag or let Doctrine guess the appropriate data type.</p>
<p class="TX">With this metadata added, we can run our Doctrine command line script again. First, let’s add the <span class="SANS_TheSansMonoCd_W5Regular_11">--dump-sql</span> option, which will show the SQL that Doctrine <i>would</i> execute, without actually executing it yet:</p>
<pre><code>$ <b>php bin/doctrine orm:schema-tool:create --dump-sql</b>&#13;
CREATE TABLE product (id INT AUTO_INCREMENT NOT NULL, description VARCHAR(255)&#13;
NOT NULL, price DOUBLE PRECISION NOT NULL, PRIMARY KEY(id)) DEFAULT CHARACTER&#13;
SET utf8 COLLATE `utf8_unicode_ci` ENGINE = InnoDB;</code></pre>
<p class="TX">This shows that Doctrine will issue SQL code to create a <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> table with an auto-incrementing integer primary key <span class="SANS_TheSansMonoCd_W5Regular_11">id</span>, a text <span class="SANS_TheSansMonoCd_W5Regular_11">description</span>, and a floating-point <span class="SANS_TheSansMonoCd_W5Regular_11">price</span>. Exactly what we want! Now run the command line script again without the <span class="SANS_TheSansMonoCd_W5Regular_11">--dump-sql</span> option to execute that SQL:</p>
<pre><code>$ <b>php bin/doctrine orm:schema-tool:create</b>&#13;
! [CAUTION] This operation should not be executed in a production environment!&#13;
Creating database schema...&#13;
[OK] Database schema created successfully!</code></pre>
<p class="TX">Doctrine has now created the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> table in the <span class="SANS_TheSansMonoCd_W5Regular_11">demo2</span> database schema.</p>
</section>
<section aria-labelledby="sec15" epub:type="division">
<span aria-label="621" epub:type="pagebreak" id="pg_621" role="doc-pagebreak"/>
<h4 class="H2" id="sec15"><span id="toc-link_396"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Adding Records to a Table</span></h4>
<p class="TNI1">Now that we’ve used Doctrine to map our <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> class to the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> database table, we can create new <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> objects and store their data in the database. <a href="#lis30-25">Listing 30-25</a> shows the <i>public/doctrine2.php</i> script to do this. Add this file to the project.</p>
<span id="lis30-25"/>
<pre><code>&lt;?php&#13;
require_once __DIR__ . '/../vendor/autoload.php';&#13;
require_once __DIR__ . '/../bootstrap.php';&#13;
&#13;
use Mattsmithdev\Product;&#13;
&#13;
<span aria-label="annotation1" class="codeannotated_CodeAnnotation">❶</span> $product1 = new Product();&#13;
$product1-&gt;setDescription("small hammer");&#13;
$product1-&gt;setPrice(4.50);&#13;
&#13;
$entityManager-&gt;persist($product1);&#13;
$entityManager-&gt;flush();&#13;
&#13;
// Retrieve products from Database&#13;
<span aria-label="annotation2" class="codeannotated_CodeAnnotation">❷</span> $productRepository = $entityManager-&gt;getRepository(Product::class);&#13;
$products = $productRepository-&gt;findAll();&#13;
foreach ($products as $product) {&#13;
    print "Product OBJECT = ID: {$product-&gt;getId()}, "&#13;
        . "Description: {$product-&gt;getDescription()}\n";&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-25: The</span> <span class="SANS_Futura_Std_Book_11">public/doctrine2.php</span> <span class="SANS_Futura_Std_Book_Oblique_11">script to insert and retrieve a database row</span></p>
<p class="TX">We create a <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> object <span aria-label="annotation1" class="CodeAnnotation">❶</span> and set its description and price. Then we use the Doctrine <span class="SANS_TheSansMonoCd_W5Regular_11">EntityManager</span> object to add this product’s data to a queue (the <span class="SANS_TheSansMonoCd_W5Regular_11">persist()</span> method) and insert the object into the database (the <span class="SANS_TheSansMonoCd_W5Regular_11">flush()</span> method).</p>
<p class="TX">To confirm this has worked, we use <span class="SANS_TheSansMonoCd_W5Regular_11">EntityManager</span> to create and get a reference to a Doctrine repository object for the <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> class <span aria-label="annotation2" class="CodeAnnotation">❷</span>. This is a custom repository object linking the <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> class with the records in the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> database table. We use this repository object to retrieve all the records (in this case, just the one) from the table with the object’s <span class="SANS_TheSansMonoCd_W5Regular_11">findAll()</span> method. Then we loop through the resulting <span class="SANS_TheSansMonoCd_W5Regular_11">$products</span> array and print each object. Here’s the output of running this script:</p>
<pre><code>Product OBJECT = ID: 1, Description: small hammer</code></pre>
<p class="TX">This output confirms that Doctrine has successfully added the <span class="SANS_TheSansMonoCd_W5Regular_11">"small hammer"</span> object to the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> database table.</p>
</section>
<section aria-labelledby="sec16" epub:type="division">
<span aria-label="622" epub:type="pagebreak" id="pg_622" role="doc-pagebreak"/>
<h4 class="H2" id="sec16"><span id="toc-link_397"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Integrating Doctrine into the Application Code</span></h4>
<p class="TNI1">All the code is in place now to integrate the Doctrine ORM library into our main web application so that we can easily map objects and database table rows. First, to minimize changes required throughout the application code, we’ll add a helper class called <span class="SANS_TheSansMonoCd_W5Regular_11">OrmHelper</span> that manages access to the Doctrine <span class="SANS_TheSansMonoCd_W5Regular_11">EntityManager</span> instance. <a href="#lis30-26">Listing 30-26</a> shows how to declare this class in <i>src/OrmHelper.php</i>.</p>
<span id="lis30-26"/>
<pre><code>&lt;?php&#13;
namespace Mattsmithdev;&#13;
&#13;
use Doctrine\ORM\EntityManager;&#13;
&#13;
class OrmHelper&#13;
{&#13;
    private static EntityManager $entityManager;&#13;
&#13;
    public static function getEntityManager(): EntityManager&#13;
    {&#13;
        return self::$entityManager;&#13;
    }&#13;
&#13;
    public static function setEntityManager(&#13;
        EntityManager $entityManager): void&#13;
    {&#13;
        self::$entityManager = $entityManager;&#13;
    }&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-26: The</span> <span class="TheSansMonoCd_W5Regular_Italic_11">OrmHelper</span> <span class="SANS_Futura_Std_Book_Oblique_11">class storing and providing access to the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">$entityManager</span> <span class="SANS_Futura_Std_Book_Oblique_11">property</span></p>
<p class="TX">This class declares a private static <span class="SANS_TheSansMonoCd_W5Regular_11">entityManager</span> property, with public static getters and setters. We use static members to allow retrieval of a reference to the Doctrine <span class="SANS_TheSansMonoCd_W5Regular_11">EntityManager</span> object from anywhere in our application code (after the variable has been set), without having to create an object or pass an object reference down through several constructor methods when creating the application, controller, or repository classes.</p>
<p class="TX">Notice that the setter method takes in a reference to an <span class="SANS_TheSansMonoCd_W5Regular_11">EntityManager</span> object and passes it along to the class’s <span class="SANS_TheSansMonoCd_W5Regular_11">entityManager</span> property. We’ve already created that reference in the <i>bootstrap.php</i> script, so we just need to read in the bootstrap script before invoking the setter method. We’ll do that now by updating the <i>public/index.php</i> script as shown in <a href="#lis30-27">Listing 30-27</a>.</p>
<span id="lis30-27"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">require_once __DIR__ . '/../vendor/autoload.php';</span>&#13;
<span aria-label="annotation1" class="codeannotated_CodeAnnotation">❶</span> require_once __DIR__ . '/../bootstrap.php';&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">session_start();</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">use Mattsmithdev\Application;</span>&#13;
<span aria-label="annotation2" class="codeannotated_CodeAnnotation">❷</span> use Mattsmithdev\OrmHelper;&#13;
&#13;
<span aria-label="623" epub:type="pagebreak" id="pg_623" role="doc-pagebreak"/>OrmHelper::setEntityManager($entityManager);&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$app = new Application();</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$app-&gt;run();</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-27: Updating the</span> <span class="SANS_Futura_Std_Book_11">index.php</span> <span class="SANS_Futura_Std_Book_Oblique_11">script to bootstrap Doctrine and store the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">EntityManager</span> <span class="SANS_Futura_Std_Book_Oblique_11">object reference</span></p>
<p class="TX">We add a <span class="SANS_TheSansMonoCd_W5Regular_11">require_once</span> statement to read and run our Doctrine bootstrap script <span aria-label="annotation1" class="CodeAnnotation">❶</span>. We add a <span class="SANS_TheSansMonoCd_W5Regular_11">use</span> statement so that we can refer to the <span class="SANS_TheSansMonoCd_W5Regular_11">OrmHelper</span> class in our code <span aria-label="annotation2" class="CodeAnnotation">❷</span>. Then we store a reference to the script’s <span class="SANS_TheSansMonoCd_W5Regular_11">EntityManager</span> object by calling the <span class="SANS_TheSansMonoCd_W5Regular_11">setEntityManager()</span> static method of our <span class="SANS_TheSansMonoCd_W5Regular_11">OrmHelper</span> class. This means the <span class="SANS_TheSansMonoCd_W5Regular_11">EntityManager</span> object is now available anywhere in our web application logic via the public static method <span class="SANS_TheSansMonoCd_W5Regular_11">OrmHelper::getEntityManager()</span>.</p>
<p class="TX">Finally, we need to fill out our <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> class, which we left as an empty class declaration when we switched over to Doctrine. Our <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span> class expects <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> to have CRUD methods like <span class="SANS_TheSansMonoCd_W5Regular_11">find()</span>, <span class="SANS_TheSansMonoCd_W5Regular_11">findAll()</span>, <span class="SANS_TheSansMonoCd_W5Regular_11">insert()</span>, <span class="SANS_TheSansMonoCd_W5Regular_11">delete()</span>, and so on. <a href="#lis30-28">Listing 30-28</a> shows how to update <i>src/ProductRepository.php</i> accordingly.</p>
<span id="lis30-28"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
use Doctrine\ORM\EntityManager;&#13;
use Doctrine\ORM\EntityRepository;&#13;
use Mattsmithdev\Product;&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class ProductRepository</span> extends EntityRepository&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
    private EntityManager $entityManager;&#13;
&#13;
    public function __construct()&#13;
    {&#13;
      <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> $this-&gt;entityManager = OrmHelper::getEntityManager();&#13;
        $entityClass = Product::class;&#13;
        $entityMetadata = $this-&gt;entityManager-&gt;&#13;
            getClassMetadata($entityClass);&#13;
      <span aria-label="annotation2" class="Code_CodeAnnotation">❷</span> parent::__construct($this-&gt;entityManager, $entityMetadata);&#13;
    }&#13;
&#13;
    public function insert(Product $product): int&#13;
    {&#13;
        $this-&gt;entityManager-&gt;persist($product);&#13;
        $this-&gt;entityManager-&gt;flush();&#13;
&#13;
        return $product-&gt;getId();&#13;
    }&#13;
&#13;
    public function update(Product $product): void&#13;
    {&#13;
        $this-&gt;entityManager-&gt;persist($product);&#13;
        $this-&gt;entityManager-&gt;flush();&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    }</span>&#13;
&#13;
<span aria-label="624" epub:type="pagebreak" id="pg_624" role="doc-pagebreak"/>    public function delete(int $id): void&#13;
    {&#13;
        $product = $this-&gt;find($id);&#13;
        $this-&gt;entityManager-&gt;remove($product);&#13;
        $this-&gt;entityManager-&gt;flush();&#13;
    }&#13;
&#13;
    public function deleteAll(): void&#13;
    {&#13;
        $products = $this-&gt;findAll();&#13;
        foreach ($products as $product) {&#13;
            $this-&gt;entityManager-&gt;remove($product);&#13;
        }&#13;
        $this-&gt;entityManager-&gt;flush();&#13;
    }&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-28: Updating</span> <span class="TheSansMonoCd_W5Regular_Italic_11">ProductRepository</span> <span class="SANS_Futura_Std_Book_Oblique_11">with Doctrine-based CRUD methods</span></p>
<p class="TX">We declare <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> as a subclass of <span class="SANS_TheSansMonoCd_W5Regular_11">Doctrine\ORM\EntityRepository</span>. This means it will inherit methods such as <span class="SANS_TheSansMonoCd_W5Regular_11">find()</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">findAll()</span> from its parent. The class declares one instance variable, an <span class="SANS_TheSansMonoCd_W5Regular_11">EntityManager</span> object, which is assigned its value in the constructor via our <span class="SANS_TheSansMonoCd_W5Regular_11">OrmHelper</span> class <span aria-label="annotation1" class="CodeAnnotation">❶</span>. The remaining lines in the constructor retrieve the required metadata about the <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> class and pass it along to the parent class’s constructor to tailor the repository class to the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> table <span aria-label="annotation2" class="CodeAnnotation">❷</span>.</p>
<p class="TX">We continue the class by declaring the remaining CRUD methods our application expects. For <span class="SANS_TheSansMonoCd_W5Regular_11">insert()</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">update()</span>, we use the <span class="SANS_TheSansMonoCd_W5Regular_11">persist()</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">flush()</span> methods of the <span class="SANS_TheSansMonoCd_W5Regular_11">EntityManager</span> object methods to add or modify a database record. The <span class="SANS_TheSansMonoCd_W5Regular_11">delete()</span> method uses the <span class="SANS_TheSansMonoCd_W5Regular_11">remove()</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">flush()</span> methods of the <span class="SANS_TheSansMonoCd_W5Regular_11">EntityManager</span> object to remove a record. Finally, the <span class="SANS_TheSansMonoCd_W5Regular_11">deleteAll()</span> method retrieves all objects with the inherited <span class="SANS_TheSansMonoCd_W5Regular_11">findAll()</span> method, then loops through them to remove each one from the database.</p>
</section>
<section aria-labelledby="sec17" epub:type="division">
<h4 class="H2" id="sec17"><span id="toc-link_398"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Creating Foreign-Key Relationships</span></h4>
<p class="TNI1">It may seem like we’ve done a lot of work to incorporate Doctrine while gaining little or no functionality beyond the previous ORM library. However, we can begin to see some of the real power of the Doctrine ORM library when we start creating foreign-key relationships between database tables and their corresponding model classes. In our code, we establish this relationship by adding a property to a model class whose value is a reference to an object of another model class. With the right metadata, Doctrine can see this relationship and generate all the SQL needed to realize it in the database.</p>
<p class="TX">To illustrate, let’s add a <span class="SANS_TheSansMonoCd_W5Regular_11">Category</span> model class to our project along with the equivalent <span class="SANS_TheSansMonoCd_W5Regular_11">category</span> database table. Then we’ll modify the <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> model class so that each product is associated with a category. In the process, we’ll see how Doctrine manages the foreign-key relationship behind this association. <a href="#lis30-29">Listing 30-29</a> shows the <i>src/Category.php</i> script declaring the new <span class="SANS_TheSansMonoCd_W5Regular_11">Category</span> class.</p>
<span id="lis30-29"/>
<pre><code><span aria-label="625" epub:type="pagebreak" id="pg_625" role="doc-pagebreak"/>&lt;?php&#13;
namespace Mattsmithdev;&#13;
&#13;
use Doctrine\ORM\Mapping as ORM;&#13;
&#13;
#[ORM\Entity]&#13;
<span aria-label="annotation1" class="codeannotated_CodeAnnotation">❶</span> #[ORM\Table(name: 'category')]&#13;
class Category&#13;
{&#13;
    #[ORM\Id]&#13;
    #[ORM\Column(type: 'integer')]&#13;
  <span aria-label="annotation2" class="Code_CodeAnnotation">❷</span> #[ORM\GeneratedValue]&#13;
    private ?int $id;&#13;
&#13;
    #[ORM\Column(type: 'string')]&#13;
    private string $name;&#13;
&#13;
    public function getId(): ?int&#13;
    {&#13;
        return $this-&gt;id;&#13;
    }&#13;
&#13;
    public function setId(?int $id): void&#13;
    {&#13;
        $this-&gt;id = $id;&#13;
    }&#13;
&#13;
    public function getName(): string&#13;
    {&#13;
        return $this-&gt;name;&#13;
    }&#13;
&#13;
    public function setName(string $name): void&#13;
    {&#13;
        $this-&gt;name = $name;&#13;
    }&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-29: The</span> <span class="TheSansMonoCd_W5Regular_Italic_11">Category</span> <span class="SANS_Futura_Std_Book_Oblique_11">model class, including Doctrine ORM metadata</span></p>
<p class="TX">The initial metadata before the class name indicates that this simple model class (or Doctrine entity) should correspond to a database table called <span class="SANS_TheSansMonoCd_W5Regular_11">category</span> <span aria-label="annotation1" class="CodeAnnotation">❶</span>. The class has two properties: a unique integer <span class="SANS_TheSansMonoCd_W5Regular_11">id</span> and a string <span class="SANS_TheSansMonoCd_W5Regular_11">name</span>. As with the <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> class, we include a tag specifying that <span class="SANS_TheSansMonoCd_W5Regular_11">id</span> is to be autogenerated by the database <span aria-label="annotation2" class="CodeAnnotation">❷</span>. For each property, we declare basic getter and setter methods.</p>
<p class="TX">Now let’s add a <span class="SANS_TheSansMonoCd_W5Regular_11">category</span> property to the <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> class so that each <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> object will be associated with one <span class="SANS_TheSansMonoCd_W5Regular_11">Category</span> object. <a href="#lis30-30">Listing 30-30</a> shows how to modify <i>src/Product.php</i>.</p>
<span id="lis30-30"/>
<pre><code><span aria-label="626" epub:type="pagebreak" id="pg_626" role="doc-pagebreak"/><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">use Doctrine\ORM\Mapping as ORM;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">#[ORM\Entity]</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">#[ORM\Table(name: 'product')]</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class Product</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    #[ORM\Id]</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    #[ORM\Column(type: 'integer')]</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    #[ORM\GeneratedValue]</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private ?int $id;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    #[ORM\Column(type: 'string')]</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private string $description;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    #[ORM\Column()]</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private float $price;</span>&#13;
&#13;
<b>  </b><span aria-label="annotation1" class="Code_CodeAnnotation">❶</span><b> </b>#[ORM\ManyToOne(targetEntity: Category::class)]&#13;
    private Category|NULL $category = NULL;&#13;
&#13;
    public function getCategory(): ?Category&#13;
    {&#13;
        return $this-&gt;category;&#13;
    }&#13;
&#13;
    public function setCategory(?Category $category): void&#13;
    {&#13;
        $this-&gt;category = $category;&#13;
    }&#13;
    <span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-30: Adding a</span> <span class="TheSansMonoCd_W5Regular_Italic_11">category</span> <span class="SANS_Futura_Std_Book_Oblique_11">property to the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">Product</span> <span class="SANS_Futura_Std_Book_Oblique_11">class</span></p>
<p class="TX">We declare the <span class="SANS_TheSansMonoCd_W5Regular_11">category</span> property as either <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span> or a reference to a <span class="SANS_TheSansMonoCd_W5Regular_11">Category</span> object, and give it public getter and setter methods. The metadata attribute preceding the property <span aria-label="annotation1" class="CodeAnnotation">❶</span> tells Doctrine that this field in the database should hold a foreign-key reference to a row in the <span class="SANS_TheSansMonoCd_W5Regular_11">category</span> table. Here <span class="SANS_TheSansMonoCd_W5Regular_11">ManyToOne</span> indicates that the foreign key establishes a <i>many-to-one</i> relationship, where many products can be of the same category, and <span class="SANS_TheSansMonoCd_W5Regular_11">targetEntity</span> sets the model class (and database table) on the other end of the relationship.</p>
<p class="TX">Since we’ve changed the structure of the <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> model class, as well as adding the new <span class="SANS_TheSansMonoCd_W5Regular_11">Category</span> class, we need Doctrine to update the structure of the database accordingly. First, let’s use our <i>bin/doctrine</i> command-line script to drop the old <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> table from the database schema:</p>
<pre><code>$ <b>php bin/doctrine orm:schema-tool:drop --force</b>&#13;
[OK] Database schema dropped successfully!</code></pre>
<p class="TX"><span aria-label="627" epub:type="pagebreak" id="pg_627" role="doc-pagebreak"/>This drops <i>all</i> tables from the schema (in our case, that’s just the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> table). Now we’ll use the command-line script again to create the database schema anew, complete with the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">category</span> tables and the foreign-key relationship between them. As before, we’ll first use the <span class="SANS_TheSansMonoCd_W5Regular_11">--dump-sql</span> option to view the SQL statements Doctrine wants to run:</p>
<pre><code>$ <b>php bin/doctrine orm:schema-tool:create --dump-sql</b>&#13;
CREATE TABLE category (id INT AUTO_INCREMENT NOT NULL, name VARCHAR(255)&#13;
NOT NULL, PRIMARY KEY(id))&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
CREATE TABLE product (id INT AUTO_INCREMENT NOT NULL, category_id INT DEFAULT&#13;
NULL, description VARCHAR(255) NOT NULL, price DOUBLE PRECISION NOT NULL,&#13;
INDEX IDX_1x (category_id), PRIMARY KEY(id))&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
ALTER TABLE product ADD CONSTRAINT FK_1x FOREIGN KEY (category_id) REFERENCES&#13;
category (id);</code></pre>
<p class="TX">This shows that Doctrine will issue SQL code to create the <span class="SANS_TheSansMonoCd_W5Regular_11">category</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">product tables</span>, where <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> has a <span class="SANS_TheSansMonoCd_W5Regular_11">category_id</span> field with a foreign-key reference to a <span class="SANS_TheSansMonoCd_W5Regular_11">category</span> database row. Real-world databases abound with foreign-key references like this, and here we see how Doctrine excels at managing the SQL for these relationships so we don’t have to.</p>
<p class="TX">Run the command-line script once more without the <span class="SANS_TheSansMonoCd_W5Regular_11">--dump-sql</span> option to execute the SQL statements and create these related database tables. To make sure the related tables have been successfully created in the database, we’ll write a one-off script creating related <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">Category</span> objects, saving them to the database, and retrieving them. <a href="#lis30-31">Listing 30-31</a> shows <i>public/doctrine3.php</i> implementing these actions. Add this file to your project.</p>
<span id="lis30-31"/>
<pre><code>&lt;?php&#13;
require_once __DIR__ . '/../vendor/autoload.php';&#13;
require_once __DIR__ . '/../bootstrap.php';&#13;
&#13;
use Mattsmithdev\ProductRepository;&#13;
use Mattsmithdev\OrmHelper;&#13;
&#13;
OrmHelper::setEntityManager($entityManager);&#13;
&#13;
// -- Create 2 categories ---&#13;
$category1 = new \Mattsmithdev\Category();&#13;
$category1-&gt;setName('HARDWARE');&#13;
$entityManager-&gt;persist($category1);&#13;
&#13;
$category2 = new \Mattsmithdev\Category();&#13;
$category2-&gt;setName('APPLIANCES');&#13;
$entityManager-&gt;persist($category2);&#13;
&#13;
// Push category objects into DB&#13;
<span aria-label="annotation1" class="codeannotated_CodeAnnotation">❶</span> $entityManager-&gt;flush();&#13;
&#13;
// -- Create 2 products ---&#13;
$productRepository = new ProductRepository();&#13;
<span aria-label="628" epub:type="pagebreak" id="pg_628" role="doc-pagebreak"/>$productRepository-&gt;deleteAll();&#13;
&#13;
$product1 = new \Mattsmithdev\Product();&#13;
$product1-&gt;setDescription("small hammer");&#13;
$product1-&gt;setPrice(4.50);&#13;
$product1-&gt;setCategory($category1);&#13;
$productRepository-&gt;insert($product1);&#13;
&#13;
$product2 = new \Mattsmithdev\Product();&#13;
$product2-&gt;setDescription("fridge");&#13;
$product2-&gt;setPrice(200);&#13;
$product2-&gt;setCategory($category2);&#13;
$productRepository-&gt;insert($product2);&#13;
&#13;
// Retrieve products from Database&#13;
<span aria-label="annotation2" class="codeannotated_CodeAnnotation">❷</span> $products = $productRepository-&gt;findAll();&#13;
if (empty($products)) {&#13;
    print 'no products found in DB';&#13;
} else {&#13;
    foreach ($products as $product) {&#13;
        print "Product OBJECT = ID: {$product-&gt;getId()}, "&#13;
            . "Description: {$product-&gt;getDescription()} // "&#13;
            . "Category = {$product-&gt;getCategory()-&gt;getName()}\n";&#13;
&#13;
    }&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 30-31: The</span> <span class="SANS_Futura_Std_Book_11">public/doctrine3.php</span> <span class="SANS_Futura_Std_Book_Oblique_11">script to insert related records into the database</span></p>
<p class="TX">We create two <span class="SANS_TheSansMonoCd_W5Regular_11">Category</span> objects for <span class="SANS_TheSansMonoCd_W5Regular_11">HARDWARE</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">APPLIANCES</span>, then store them in the database by using the Doctrine <span class="SANS_TheSansMonoCd_W5Regular_11">EntityManager</span> object from the bootstrap script. Notice that we call the <span class="SANS_TheSansMonoCd_W5Regular_11">persist()</span> method on each <span class="SANS_TheSansMonoCd_W5Regular_11">Category</span> object individually, then call the <span class="SANS_TheSansMonoCd_W5Regular_11">flush()</span> method once <span aria-label="annotation1" class="CodeAnnotation">❶</span>; <span class="SANS_TheSansMonoCd_W5Regular_11">flush()</span> will batch-process any operations that have been queued up for it with methods like <span class="SANS_TheSansMonoCd_W5Regular_11">persist()</span>. We next use our <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> class to create and insert two <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> objects into the database, one for each category. Then we retrieve an array of all the products from the database with the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> class’s <span class="SANS_TheSansMonoCd_W5Regular_11">findAll()</span> method <span aria-label="annotation2" class="CodeAnnotation">❷</span>. If the array isn’t empty, we loop through it and print each product. Here’s the output of running this script:</p>
<pre><code>Product OBJECT = ID: 1, Description: small hammer // Category = HARDWARE&#13;
Product OBJECT = ID: 2, Description: fridge // Category = APPLIANCES</code></pre>
<p class="TX">Each product is shown with its associated category. With just a little bit of metadata in the <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> model classes (the Doctrine <span class="SANS_TheSansMonoCd_W5Regular_11">ManyToOne</span> attribute added before the <span class="SANS_TheSansMonoCd_W5Regular_11">category</span> property), we’ve created a whole database of foreign-key declaration and storage mapping.</p>
<p class="TX">Overall, although switching from my simple ORM library to Doctrine added complexity to the code, such as the need for a bootstrap script and metadata tags in the model classes, Doctrine comes with added benefits like increased flexibility and support for foreign-key relationships. Using a popular ORM library like Doctrine for a project also means that developers <span aria-label="629" epub:type="pagebreak" id="pg_629" role="doc-pagebreak"/>you collaborate with will be more likely to already be familiar with its operations, which can save time in code development and maintenance. Another advantage of ORM libraries like Doctrine is that they allow you to seamlessly switch from one DBMS to another (such as from MySQL to PostgreSQL), without any of your core web application code having to change. The only downside may be the effort of learning the library in the first place, and perhaps some performance reduction due to the extra layer of abstraction. Still, the advantages will in many cases outweigh any minor performance reduction.</p>
</section>
</section>
<section aria-labelledby="sec18" epub:type="division">
<h3 class="H1" id="sec18"><span id="toc-link_399"/><span class="SANS_Futura_Std_Bold_B_11">Summary</span></h3>
<p class="TNI1">In this chapter, we used my <span class="SANS_TheSansMonoCd_W5Regular_11">pdo-crud-for-free-repositories</span> library to explore the basics of ORM libraries, seeing how they can simplify the process of working with a database by eliminating the need for writing a lot of repetitive code for CRUD applications. When we transitioned to the Doctrine ORM library, we saw that this more robust and feature-complete library has added benefits like greater flexibility and support for foreign-key associations between model classes and their corresponding database tables.</p>
<p class="TX">This chapter also outlined important practices in web application security. In previous chapters, we were already using prepared SQL statements, which help protect against SQL injection attacks. Now we’ve added the ability to store and verify against hashed passwords, so we never need to store plaintext passwords in a database. We’ve also emphasized the importance of keeping database credentials in a separate file so that they won’t be published or archived and accidentally exposed.</p>
</section>
<section aria-labelledby="sec19" epub:type="division">
<h3 class="H1" id="sec19"><span id="toc-link_400"/><span class="SANS_Futura_Std_Bold_B_11">Exercises</span></h3>
<p class="ListNumber">1.   I’ve created a publicly shared sample project to help explore the <span class="SANS_TheSansMonoCd_W5Regular_11">pdo-crud -for-free-repositories</span> library. The project uses PHP templates (not Twig) to illustrate how to use the ORM library for a <span class="SANS_TheSansMonoCd_W5Regular_11">Movie</span> model class and its associated <span class="SANS_TheSansMonoCd_W5Regular_11">MovieRepository</span> class. To check out the project, do the following:</p>
<p class="ListLetterSub">a.   Enter the following at the command line to create a new project named <i>demo1</i> based on my published project template:</p>
<pre><code>$ <b>composer create-project mattsmithdev/pdo-repo-project demo1</b></code></pre>
<p class="ListLetterSub">b.   In the <i>demo1</i> directory that was created, edit the MySQL credentials in the <i>.env</i> file to match your computer’s setup.</p>
<p class="ListLetterSub">c.   Run the database setup script in <i>db/migrateAndLoadFixtures.php.</i></p>
<p class="ListLetterSub">d.   Run a web server and visit the home page and movie list page.</p>
<p class="ListLetterSub">e.   Examine the <span class="SANS_TheSansMonoCd_W5Regular_11">Movie</span> model class, and the <span class="SANS_TheSansMonoCd_W5Regular_11">listMovies()</span> method in the <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class.</p>
<p class="ListNumber"><span aria-label="630" epub:type="pagebreak" id="pg_630" role="doc-pagebreak"/>2.   Use the <span class="SANS_TheSansMonoCd_W5Regular_11">pdo-crud-for-free-repositories</span> library to create a MySQL CRUD web application for <span class="SANS_TheSansMonoCd_W5Regular_11">Book</span> objects with these properties:</p>
<p class="ListPlainSub"><span class="SANS_TheSansMonoCd_W5Regular_11">id</span> (integer), an auto-incrementing primary key</p>
<p class="ListPlainSub"><span class="SANS_TheSansMonoCd_W5Regular_11">title</span> (string)</p>
<p class="ListPlainSub"><span class="SANS_TheSansMonoCd_W5Regular_11">author</span> (string)</p>
<p class="ListPlainSub"><span class="SANS_TheSansMonoCd_W5Regular_11">price</span> (float)</p>
<p class="ListBody">You can either create a new project from scratch, extend the demo project from the previous exercise, or adapt your work from Exercise 2 of the previous chapter. You may find it helpful to adapt the database schema creation and initial data script from <a href="#lis30-12">Listing 30-12</a>, or if you’re using the demo project, you can adapt the database setup script in <i>db/migrateAndLoadFixtures.php</i>.</p>
<p class="ListNumber">3.   Web application security is an enormous topic (the subject of entire books), and covering it exhaustively here would be impossible. Learn more about PHP security best practices by exploring the following resources:</p>
<p class="ListPlainSub">The Paragon Initiative Enterprises PHP security guide, <i><a href="https://paragonie.com/blog/2017/12/2018-guide-building-secure-php-software">https://paragonie.com/blog/2017/12/2018-guide-building-secure-php-software</a></i></p>
<p class="ListPlainSub">The Open Web Application Security Project, <i><a href="https://owasp.org">https://owasp.org</a></i></p>
<p class="ListPlainSub">PHP The Right Way’s security chapters, by Josh Lockhart (codeguy), <i><a href="https://phptherightway.com/#security">https://phptherightway.com/#security</a></i></p>
</section>
</section>
</div></body></html>