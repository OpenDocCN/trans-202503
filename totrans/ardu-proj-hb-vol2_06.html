<html><head></head><body>
<h1 class="h1-part" id="part05"><span epub:type="pagebreak" id="page_167"/><strong><span class="green3">Security</span></strong></h1>&#13;


<h2 class="h2s" id="ch20"><span epub:type="pagebreak" id="page_168"/><strong>20<br/>Ultrasonic Soaker</strong></h2>&#13;
<p class="intro"><span class="green3">In this project we’ll use an ultrasonic sensor to trigger a toy water pistol. You could set this up to soak unsuspecting victims when they venture into forbidden territory!</span></p>&#13;
<div class="image"><img alt="Image" src="../images/p0168-01.jpg"/></div>&#13;
<div class="image"><span epub:type="pagebreak" id="page_169"/><img alt="Image" src="../images/p0169-01.jpg"/></div>&#13;
<p class="capg3"><strong>PARTS REQUIRED</strong></p>&#13;
<p class="cap1"><strong>Arduino board</strong></p>&#13;
<p class="cap1"><strong>Breadboard</strong></p>&#13;
<p class="cap1"><strong>Jumper wires</strong></p>&#13;
<p class="cap1"><strong>HC-SR04 ultrasonic sensor</strong></p>&#13;
<p class="cap1"><strong>WLtoys V959-18 Water Jet Pistol</strong></p>&#13;
<p class="capg3"><strong>LIBRARY REQUIRED</strong></p>&#13;
<p class="cap1"><strong>NewPing</strong></p>&#13;
<h3 class="h3" id="ch00lev1sec82"><span epub:type="pagebreak" id="page_170"/><span class="green3"><strong>HOW IT WORKS</strong></span></h3>&#13;
<p class="noindent">For our soaker, we’ll use the WLtoys V959-18 Water Jet Pistol (<a href="ch20.xhtml#ch20fig1">Figure 20-1</a>) attachment for RC helicopters, which is inexpensive and widely available online. The pistol has a small reservoir to hold water and a mini-pump that shoots the water through a nozzle at the front. The pistol has only two wires: red is positive power and white is ground. It requires only a little current, which lets us trigger the pump using the current supplied by the Arduino.</p>&#13;
<p class="figcap"><a id="ch20fig1"/><strong>FIGURE 20-1:</strong> The WLtoys V959-18 Water Jet Pistol</p>&#13;
<div class="image"><img alt="Image" src="../images/f20-01.jpg"/></div>&#13;
<div class="noter">&#13;
<p class="notet"><strong>NOTE</strong></p>&#13;
<p class="notep"><em>Remember that water and electricity do not mix well, so try to keep your Arduino away from the water jet to minimize the chance of water short-circuiting your</em> <em>Arduino board.</em></p>&#13;
</div>&#13;
<p class="indent">As we discussed in Project 13, the ultrasonic sensor sends out a burst of ultrasound and listens for the echo that bounces off an object to determine its distance. Here, the ultrasonic sensor looks for a bounceback that indicates an object is less than 15 centimeters away, in which case the Arduino sends power to the soaker to squirt water on our victims.</p>&#13;
<h3 class="h3" id="ch00lev1sec83"><span class="green3"><strong>THE BUILD</strong></span></h3>&#13;
<ol>&#13;
<li><p class="noindents">Add the ultrasonic sensor module (<a href="ch20.xhtml#ch20fig2">Figure 20-2</a>) to your breadboard and connect VCC to +5V, Trig to Arduino pin 12, Echo to Arduino pin 13, and GND to GND, as shown in the following table.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thg3" style="vertical-align: top;"><p class="tablec"><strong>ULTRASONIC SENSOR</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1g3" style="vertical-align: top;"><p class="tablec"><span class="green3">VCC</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="green3">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1g3" style="vertical-align: top;"><p class="tablec"><span class="green3">Trig</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="green3">Pin 12</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1g3" style="vertical-align: top;"><p class="tablec"><span class="green3">Echo</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="green3">Pin 13</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1g3" style="vertical-align: top;"><p class="tablec"><span class="green3">GND</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="green3">GND</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<p class="figcap"><span epub:type="pagebreak" id="page_171"/><a id="ch20fig2"/><strong>FIGURE 20-2:</strong> The ultrasonic sensor</p>&#13;
<div class="image"><img alt="Image" src="../images/f20-02.jpg"/></div></li>&#13;
<li><p class="noindents">Connect the pistol’s red power wire to Arduino pin 3 and its white wire to Arduino GND via the breadboard power rail. Connect the power rails of the breadboard to Arduino power. The pistol comes with a small pipette to help you fill the reservoir. <a href="ch20.xhtml#ch20fig3">Figure 20-3</a> shows where to fill the reservoir.</p>&#13;
<p class="figcap"><a id="ch20fig3"/><strong>FIGURE 20-3:</strong> Use the pipette provided to fill the reservoir shown with water through the opening at the top.</p>&#13;
<div class="image"><img alt="Image" src="../images/f20-03.jpg"/></div></li>&#13;
<li><p class="noindents">Once you’ve confirmed that your setup matches the circuit diagram in <a href="ch20.xhtml#ch20fig4">Figure 20-4</a>, upload the code in “<a href="ch20.xhtml#ch00lev1sec84">The Sketch</a>” on <a href="ch20.xhtml#page_172">page 172</a> to your Arduino, making sure to add the NewPing library to the Arduino IDE.</p>&#13;
<p class="figcap"><span epub:type="pagebreak" id="page_172"/><a id="ch20fig4"/><strong>FIGURE 20-4:</strong> The circuit diagram for the ultrasonic soaker</p>&#13;
<div class="image"><img alt="Image" src="../images/f20-04.jpg"/></div></li>&#13;
</ol>&#13;
<h3 class="h3" id="ch00lev1sec84"><span class="green3"><strong>THE SKETCH</strong></span></h3>&#13;
<p class="noindent">Before entering the sketch, download the NewPing library from <em><a href="http://www.nostarch.com/arduinohandbook2/">http://www.nostarch.com/arduinohandbook2/</a></em>. The sketch calls on the NewPing library and defines the Arduino pin connections. Arduino pin 12 is connected to the sensor’s trigger pin and sends out an ultrasonic signal, and Arduino pin 13, connected to the sensor’s Echo pin, receives the returning signal. The Arduino converts the time between sending and receiving the signal into distance. The soaker is attached to Arduino pin 3, and a loop checks the distance to the detected object. If the distance is less than 15 centimeters, power is sent to pin 3 and the soaker shoots water at your unsuspecting friends!</p>&#13;
<p class="programs1">#include &lt;NewPing.h&gt;   <span class="ash">// This calls the NewPing library</span><br/>#define trigPin 12     <span class="ash">// Trig pin attached to Arduino 12</span><br/>#define echoPin 13     <span class="ash">// Echo pin attached to Arduino 13</span><br/>#define soakerPin 3<br/>#define MAX_DISTANCE 500<br/><br/>NewPing sonar(trigPin, echoPin, MAX_DISTANCE);<br/><br/><span class="green1">void</span> <span class="green2">setup</span>() {<br/>  <span class="orange">Serial.begin</span>(9600);<br/>  <span class="orange">pinMode</span>(soakerPin, <span class="green1">OUTPUT</span>);<br/>}<br/><span class="green1"><span epub:type="pagebreak" id="page_173"/>void</span> <span class="green2">loop</span>() {<br/>  <span class="green1">int</span> distance;<br/>  distance = sonar.ping_cm();<br/>  <span class="orange">Serial.print</span>(distance);<br/>  <span class="orange">Serial.println</span>(<span class="green1">" cm"</span>);<br/><br/>  <span class="green2">if</span> (distance &lt;= 15) { <span class="ash">// If distance is less than 15</span><br/>    <span class="orange">digitalWrite</span>(soakerPin, <span class="green1">HIGH</span>); <span class="ash">// Soaker shoots water</span><br/>    <span class="orange">delay</span>(250);<br/>    <span class="orange">digitalWrite</span>(soakerPin, <span class="green1">LOW</span>);  <span class="ash">// Short pulse of water</span><br/>  }<br/>  <span class="green2">else</span> {<br/>    <span class="orange">digitalWrite</span>(soakerPin, <span class="green1">LOW</span>);  <span class="ash">// Soaker will remain off</span><br/>  }<br/>  <span class="orange">delay</span>(500);<br/>}</p>&#13;
<h3 class="h3" id="ch00lev1sec85"><span class="green3"><strong>TROUBLESHOOTING</strong></span></h3>&#13;
<p class="ques"><strong>Q.</strong> <em>The ultrasonic soaker does not shoot.</em></p>&#13;
<p class="bull">• Make sure the connections match the setup for the ultrasonic sensor by rechecking this chapter’s tables and the circuit diagram in <a href="ch20.xhtml#ch20fig4">Figure 20-4</a>.</p>&#13;
<p class="bull">• Remember that the water will shoot only when the sensor detects someone or something in front of it.</p>&#13;
<p class="bull">• Make sure you have added power to the breadboard power rails.</p>&#13;
<p class="bull">• Check that the water jet is working correctly by disconnecting it from the circuit and then connecting the wires to +5V and GND on the Arduino directly. You should hear the buzz of the pump motor; if you don’t, your component may be faulty.</p>&#13;


<h2 class="h2s" id="ch21"><span epub:type="pagebreak" id="page_174"/><strong>21<br/>Fingerprint Scanner</strong></h2>&#13;
<p class="intro"><span class="green3">In this project we’ll use a fingerprint sensor, a servomotor, and some LEDs to create a cool biometric entry system.</span></p>&#13;
<div class="image"><img alt="Image" src="../images/p0174-01.jpg"/></div>&#13;
<div class="image"><span epub:type="pagebreak" id="page_175"/><img alt="Image" src="../images/p0175-01.jpg"/></div>&#13;
<p class="capg3"><strong>PARTS REQUIRED</strong></p>&#13;
<p class="cap1"><strong>Arduino board</strong></p>&#13;
<p class="cap1"><strong>Breadboard</strong></p>&#13;
<p class="cap1"><strong>Jumper wires</strong></p>&#13;
<p class="cap1"><strong>Red LED</strong></p>&#13;
<p class="cap1"><strong>Green LED</strong></p>&#13;
<p class="cap1"><strong>2 220-ohm resistors</strong></p>&#13;
<p class="cap1"><strong>Tower Pro SG90 9g servomotor</strong></p>&#13;
<p class="cap1"><strong>Optical fingerprint sensor (ZFM-20 Series)</strong></p>&#13;
<p class="capg3"><strong>LIBRARIES REQUIRED</strong></p>&#13;
<p class="cap1"><strong>Adafruit_Fingerprint</strong></p>&#13;
<p class="cap1"><strong>Servo</strong></p>&#13;
<p class="cap1"><strong>SoftwareSerial</strong></p>&#13;
<div class="noter">&#13;
<p class="notet"><span epub:type="pagebreak" id="page_176"/><strong>NOTE</strong></p>&#13;
<p class="notep"><em>The software we’re using in this project operates only on Windows.</em></p>&#13;
</div>&#13;
<h3 class="h3" id="ch00lev1sec86"><span class="green3"><strong>HOW IT WORKS</strong></span></h3>&#13;
<p class="noindent">Biometric identification is used to identify a person from a specific biological characteristic that remains the same even over a long period of time, such as a fingerprint or iris pattern. Since fingerprints are unique to each person, they’re often used to help identify individuals for purposes like criminal investigations and security authentication. In this project, we’ll use a fingerprint sensor to read a fingerprint and, if it matches a print on record with the right security clearance, allow access by moving a servomotor.</p>&#13;
<p class="indent">The sensor we’ll use is the ZFM-20 Series Fingerprint Identification Module (see <a href="ch21.xhtml#ch21fig1">Figure 21-1</a>) but will generally be referred to as an <em>optical fingerprint sensor module</em>. The sensor takes a photograph of a fingerprint, adds it to the module’s database, and then checks the scanned fingerprint for a match. It can hold up to 162 fingerprints. The sensor is available online and from retailers such as Adafruit, which has also created a specific Arduino library for the module that we’ll use in the sketch.</p>&#13;
<p class="figcap"><a id="ch21fig1"/><strong>FIGURE 21-1:</strong> The ZFM-20 Series Fingerprint Identification Module is an optical fingerprint sensor.</p>&#13;
<div class="image"><img alt="Image" src="../images/f21-01.jpg"/></div>&#13;
<h3 class="h3" id="ch00lev1sec87"><span class="green3"><strong>PREPARING THE FINGERPRINT SENSOR</strong></span></h3>&#13;
<p class="noindent">To use the sensor, we must first get the SFG Demo software, available to download from <em><a href="http://www.adafruit.com/datasheets/SFGDemoV2.0.rar">http://www.adafruit.com/datasheets/SFGDemoV2.0.rar</a></em>. The SFG Demo software is a simple, free program that connects your PC to the Fingerprint ID module via an Arduino so you can control it, add or delete fingerprints, and assign an ID for each one.</p>&#13;
<ol>&#13;
<li><p class="noindents">Download the <em>SFGDemoV2.0.rar</em> file and unzip to a destination of your choice.</p></li>&#13;
<li><p class="noindents"><span epub:type="pagebreak" id="page_177"/>Once you have unzipped the <em>.rar</em> file, double-click the <em>SFGDemo.exe</em> file to run the program, and you’ll see the screen shown in <a href="ch21.xhtml#ch21fig2">Figure 21-2</a>.</p>&#13;
<p class="figcap"><a id="ch21fig2"/><strong>FIGURE 21-2:</strong> The SFGDemo control screen</p>&#13;
<div class="image"><img alt="Image" src="../images/f21-02.jpg"/></div></li>&#13;
<li><p class="noindents">Now you need to connect the fingerprint sensor module to your PC via the Arduino. The connections for the module to Arduino are shown in the following table.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thg3" style="vertical-align: top;"><p class="tablec"><strong>FINGERPRINT SENSOR</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1g3" style="vertical-align: top;"><p class="tablec"><span class="green3">GND (black wire)</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="green3">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1g3" style="vertical-align: top;"><p class="tablec"><span class="green3">RX (white wire)</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="green3">Pin 0 (RX)</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1g3" style="vertical-align: top;"><p class="tablec"><span class="green3">TX (green wire)</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="green3">Pin 1 (TX)</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1g3" style="vertical-align: top;"><p class="tablec"><span class="green3">+5V (red wire)</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="green3">+5V</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindents">You’ll be using the Arduino as a bypass to connect the fingerprint scanner to your PC via the USB cable, so you need to load a blank sketch to get the Arduino to connect to the PC without carrying out a function. The easiest way to do this is to open the latest version of the Arduino IDE and upload the default sketch, shown next.</p>&#13;
<p class="programs1"><span epub:type="pagebreak" id="page_178"/><span class="green1">void</span> <span class="green2">setup</span>() {<br/>  <span class="ash">// put your setup code here, to run once:</span><br/><br/>}<br/><span class="green1">void</span> <span class="green2">loop</span>() {<br/>  <span class="ash">// put your main code here, to run repeatedly:</span><br/><br/>}</p></li>&#13;
<li><p class="noindents">Next, connect the Arduino to your PC and in the SFGDemo program, select the <strong>Open Device</strong> button. From the <strong>Com Port</strong> drop-down menu that opens, choose the port your Arduino is connected to and click <strong>OK</strong>. You’ll see a message indicating that your module is connected and recognized, as shown in <a href="ch21.xhtml#ch21fig3">Figure 21-3</a>. Here my module is connected to the Arduino through com port 4, but you might need to use a different port.</p>&#13;
<p class="figcap"><a id="ch21fig3"/><strong>FIGURE 21-3:</strong> When the device is connected correctly, the program shows the message “Open Device Success!”</p>&#13;
<div class="image"><img alt="Image" src="../images/f21-03.jpg"/></div></li>&#13;
<li><p class="noindents">Next, you’ll add a fingerprint to the database. Click <strong>Enroll</strong> on the SFGDemo control screen. When you see the message “Waiting for fingerprint,” press a finger firmly against the fingerprint sensor module window and wait a few seconds. When the print is registered, you’ll see the message “Success!” (as shown in <a href="ch21.xhtml#ch21fig4">Figure 21-4</a>).</p>&#13;
<p class="figcap"><span epub:type="pagebreak" id="page_179"/><a id="ch21fig4"/><strong>FIGURE 21-4:</strong> The module has successfully captured a fingerprint and shows a preview of the print in the top-left window.</p>&#13;
<div class="image"><img alt="Image" src="../images/f21-04.jpg"/></div></li>&#13;
<li><p class="noindents">Now you’ll test whether the module recognizes the fingerprint you just recorded. Click the <strong>Match</strong> button on the SFGDemo control screen. When prompted, press your finger against the window firmly for a few seconds. If the demo finds a match, you’ll see the “Pass!” message shown in <a href="ch21.xhtml#ch21fig5">Figure 21-5</a>.</p>&#13;
<p class="figcap"><a id="ch21fig5"/><strong>FIGURE 21-5:</strong> The fingerprint matches and a “Pass!” message displays in the information panel of the SFGDemo control panel.</p>&#13;
<div class="image"><img alt="Image" src="../images/f21-05.jpg"/></div></li>&#13;
<li><p class="noindents"><span epub:type="pagebreak" id="page_180"/>Now you need to check that the module recognizes your fingerprint when it’s attached to the Arduino and not the PC. Close the SFGDemo program and, from the resources you downloaded from <em><a href="https://www.nostarch.com/arduinohandbook2/">https://www.nostarch.com/arduinohandbook2/</a></em>, add the Adafruit Fingerprint Sensor library to your IDE. If you need a refresher on adding libraries, check out the library section at the start of this book.</p></li>&#13;
<li><p class="noindents">Once you’ve added the Adafruit Fingerprint Sensor library, open the IDE and select <strong>Files</strong> ▸ <strong>Examples</strong> ▸ <strong>Adafruit-fingerprint-sensor-master</strong> ▸ <strong>Fingerprint</strong> to choose the library fingerprint sketch shown in <a href="ch21.xhtml#ch21fig6">Figure 21-6</a>. Upload this sketch to your Arduino.</p>&#13;
<p class="figcap"><a id="ch21fig6"/><strong>FIGURE 21-6:</strong> The fingerprint demo sketch from the Adafruit Fingerprint Sensor library</p>&#13;
<div class="image"><img alt="Image" src="../images/f21-06.jpg"/></div>&#13;
<div class="noter">&#13;
<p class="notet"><strong>NOTE</strong></p>&#13;
<p class="notep"><em>Your sensor may come with six wires, two of which aren’t necessary for the demo.</em></p>&#13;
</div></li>&#13;
<li><p class="noindents">Once you’ve uploaded the fingerprint sketch to your Arduino, disconnect from the PC. You now need to change your module/ Arduino pin setup. Instead of connecting the module to the TX and RX pins, change these connections to pins 2 and 3 on the Arduino, respectively, as shown in the following table. This keeps the TX and RX serial communication free to use the Arduino IDE Serial Monitor in the next step.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thg3" style="vertical-align: top;"><span epub:type="pagebreak" id="page_181"/><p class="tablec"><strong>FINGERPRINT SENSOR</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1g3" style="vertical-align: top;"><p class="tablec"><span class="green3">GND (black wire)</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="green3">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1g3" style="vertical-align: top;"><p class="tablec"><span class="green3">TX (green wire)</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="green3">Pin 2</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1g3" style="vertical-align: top;"><p class="tablec"><span class="green3">RX (white wire)</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="green3">Pin 3</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1g3" style="vertical-align: top;"><p class="tablec"><span class="green3">+5V (red wire)</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="green3">+5V</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindents">Now, reconnect your Arduino to the PC and open the Arduino IDE. Open the Serial Monitor of the IDE. When you press your finger to the module window, you should see something like <a href="ch21.xhtml#ch21fig7">Figure 21-7</a>.</p>&#13;
<p class="figcap"><a id="ch21fig7"/><strong>FIGURE 21-7:</strong> The module processes are displayed in the Arduino IDE serial screen.</p>&#13;
<div class="image"><img alt="Image" src="../images/f21-07.jpg"/></div></li>&#13;
</ol>&#13;
<h3 class="h3" id="ch00lev1sec88"><span class="green3"><strong>THE BUILD</strong></span></h3>&#13;
<p class="noindent">Now that you know the module is working as expected, you’ll use what you’ve learned to create the fingerprint entry system.</p>&#13;
<ol>&#13;
<li><p class="noindents">The fingerprint module should now be connected to the Arduino, but if you’re starting at this point, follow the connections given in step 10 before proceeding.</p></li>&#13;
<li><p class="noindents">Connect the servomotor to the GND and +5V power rails on the breadboard and connect the signal pin to Arduino pin 9, as shown in the following table.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thg3" style="vertical-align: top;"><p class="tablec"><strong>SERVO</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1g3" style="vertical-align: top;"><p class="tablec"><span class="green3">Signal (yellow wire)</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="green3">Pin 9</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1g3" style="vertical-align: top;"><p class="tablec"><span class="green3">Positive power (red wire)</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="green3">Breadboard +5V rail</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1g3" style="vertical-align: top;"><p class="tablec"><span class="green3">Negative power (black wire)</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="green3">Breadboard GND rail</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindents"><span epub:type="pagebreak" id="page_182"/>Insert the LEDs into the breadboard so that the shorter, negative leg is connected to the GND power rail of the breadboard and the positive, longer leg is connected to Arduino pins 7 and 8 via a 220-ohm resistor, as shown in the following table. The resistors should straddle the center of the breadboard, as shown in <a href="ch21.xhtml#ch21fig8">Figure 21-8</a>.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thg3" style="vertical-align: top;"><p class="tablec"><strong>LEDS</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1g3" style="vertical-align: top;"><p class="tablec"><span class="green3">Green LED (positive, longer leg)</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="green3">Pin 7 via 220-ohm resistor</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1g3" style="vertical-align: top;"><p class="tablec"><span class="green3">Red LED (positive, longer leg)</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="green3">Pin 8 via 220-ohm resistor</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1g3" style="vertical-align: top;"><p class="tablec"><span class="green3">Negative power of both LEDs (shorter leg)</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="green3">Breadboard GND rail</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<p class="figcap"><a id="ch21fig8"/><strong>FIGURE 21-8:</strong> The LEDs are connected to the Arduino pins via 220-ohm resistors.</p>&#13;
<div class="image"><img alt="Image" src="../images/f21-08.jpg"/></div></li>&#13;
<li><p class="noindents">Connect the power rails of the breadboard to +5V and GND on the Arduino, and then check that your circuit matches <a href="ch21.xhtml#ch21fig9">Figure 21-9</a>.</p></li>&#13;
<li><p class="noindents">Upload the code in “<a href="ch21.xhtml#ch00lev1sec89">The Sketch</a>” on <a href="ch21.xhtml#page_183">page 183</a>.</p>&#13;
<p class="figcap"><span epub:type="pagebreak" id="page_183"/><a id="ch21fig9"/><strong>FIGURE 21-9:</strong> The circuit diagram for the fingerprint scanner</p>&#13;
<div class="image"><img alt="Image" src="../images/f21-09.jpg"/></div></li>&#13;
</ol>&#13;
<h3 class="h3" id="ch00lev1sec89"><span class="green3"><strong>THE SKETCH</strong></span></h3>&#13;
<p class="noindent">The sketch first calls on the Servo, SoftwareSerial, and Adafruit_ Fingerprint libraries. The LED and servo pins are defined as 7, 8, and 9, respectively, and pins 2 and 3 are defined for serial connection to the fingerprint sensor module. The fingerprint library handles the functionality of the module, and the sketch has a series of steps to read and store a fingerprint.</p>&#13;
<p class="indent">The sensor automatically scans every 5 seconds and reads the fingerprint when it is pressed to the window. If the fingerprint matches one in the module memory (which we stored earlier in the project), the red LED will turn off, the green LED will light, and the servomotor will turn 180 degrees. This state will continue for 5 seconds, and the setup will reset and wait for another valid entry.</p>&#13;
<p class="programs1"><span class="ash">// Fingerprint Sensor Library reproduced with kind permission</span><br/><span class="ash">// from Adafruit Industries</span><br/><span class="ash">/***************************************************</span><br/> <span class="ash">This is an example sketch for our optical Fingerprint sensor</span><br/><br/> <span class="ash">Designed specifically to work with the Adafruit BMP085 Breakout</span><br/> <span class="ash">----&gt; <a href="http://www.adafruit.com/products/751">http://www.adafruit.com/products/751</a></span><br/><span epub:type="pagebreak" id="page_184"/><br/> <span class="ash">These displays use TTL Serial to communicate, 2 pins are required to</span><br/> <span class="ash">interface</span><br/> <span class="ash">Adafruit invests time and resources providing this open source code,</span><br/> <span class="ash">please support Adafruit and open-source hardware by purchasing</span><br/> <span class="ash">products from Adafruit!</span><br/><br/> <span class="ash">Written by Limor Fried/Ladyada for Adafruit Industries.</span><br/> <span class="ash">BSD license, all text above must be included in any redistribution</span><br/> <span class="ash">****************************************************/</span><br/><br/>#include &lt;<span class="orange">Servo</span>.h&gt;<br/>#include &lt;Adafruit_Fingerprint.h&gt;<br/>#if ARDUINO &gt;= 100<br/>#include &lt;<span class="orange">SoftwareSerial</span>.h&gt;<br/>#else<br/>#include &lt;NewSoftSerial.h&gt;<br/>#endif<br/><br/><span class="green1">int</span> getFingerprintIDez();<br/><span class="green1">int</span> ledaccess = 7; <span class="ash">// Green LED pin</span><br/><span class="green1">int</span> leddeny = 8; <span class="ash">// Red LED pin</span><br/><span class="green1">int</span> servoPin = 9; <span class="ash">// Servo pin</span><br/><br/><span class="orange">Servo</span> doorLock;<br/><br/><span class="ash">// Pin #2 is IN from sensor (GREEN wire)</span><br/><span class="ash">// Pin #3 is OUT from arduino (WHITE wire)</span><br/>#if ARDUINO &gt;= 100<br/><span class="orange">SoftwareSerial</span> mySerial(2, 3); <span class="ash">// Pins for the fingerprint sensor</span><br/><span class="green2">#else</span><br/>NewSoftSerial mySerial(2, 3);<br/><span class="green2">#endif</span><br/><br/>Adafruit_Fingerprint finger = Adafruit_Fingerprint(&amp;mySerial);<br/><br/><span class="green1">void</span> <span class="green2">setup()</span> {<br/>  doorLock.<span class="orange">attach</span>(servoPin); <span class="ash">// We define the servo pin</span><br/>  <span class="orange">pinMode</span>(ledaccess, <span class="green1">OUTPUT</span>); <span class="ash">// Green LED pin set as an ouput</span><br/>  <span class="orange">pinMode</span>(leddeny, <span class="green1">OUTPUT</span>); <span class="ash">// Red LED pin set as an output</span><br/>  <span class="orange">pinMode</span>(servoPin, <span class="green1">OUTPUT</span>); <span class="ash">// Servo pin set as an output</span><br/>  <span class="orange">Serial</span>.<span class="orange">begin</span>(9600); <span class="ash">// Start sending messages to the Serial Monitor</span><br/>  <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"fingertest"</span>);<br/>  finger.<span class="orange">begin</span>(57600); <span class="ash">// Set data rate for the sensor serial port</span><br/><br/><span class="ash">// Start the module and checking for fingerprint</span><br/>  <span class="green2">if</span> (finger.verifyPassword()) {<br/>    <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"Found fingerprint sensor!"</span>);<br/>  } <span class="green2">else</span> {<br/>    <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"Did not find fingerprint sensor :(")</span>;<br/>    <span class="green2">while</span> (1);<br/>  }<br/>  <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"Waiting for valid finger..."</span>);<br/>}<br/><span class="green1"><span epub:type="pagebreak" id="page_185"/>void</span> <span class="green2">loop</span>() {<br/>  <span class="green1">int</span> ID = getFingerprintIDez(); <span class="ash">// Get the fingerprint ID#</span><br/>  <span class="ash">// Reset the device to the test state</span><br/>  <span class="orange">digitalWrite</span>(ledaccess, <span class="green1">HIGH</span>);<br/>  <span class="orange">digitalWrite</span>(leddeny, <span class="green1">HIGH</span>);<br/>  doorLock.<span class="orange">write</span>(0);<br/>  <span class="green2">if</span> (ID &gt;= 0) { <span class="ash">// Valid ID. Unlocked state</span><br/>    <span class="ash">// Enable the access LED, turn off the deny LED</span><br/>    <span class="orange">digitalWrite</span>(ledaccess, <span class="green1">HIGH</span>);<br/>    <span class="orange">digitalWrite</span>(leddeny, <span class="green1">LOW</span>);<br/>    <span class="ash">// Unlock the servo</span><br/>    doorLock.<span class="orange">write</span>(180);<br/>  }<br/>  <span class="green2">else if</span> (ID == -3) { <span class="ash">// ID doesn't match any registed print</span><br/>                       <span class="ash">// Locked state</span><br/>    <span class="ash">// Enable the deny LED, turn off the access LED</span><br/>    <span class="orange">digitalWrite</span>(ledaccess, <span class="green1">LOW</span>);<br/>    <span class="orange">digitalWrite</span>(leddeny, <span class="green1">HIGH</span>);<br/>  }<br/>  <span class="orange">delay</span>(5000);<br/>}<br/><br/><span class="green1">uint8_t</span> getFingerprintID() {<br/>  <span class="green1">uint8_t p</span> = finger.getImage();<br/>  <span class="green2">switch</span> (p) {<br/>    <span class="green2">case</span> FINGERPRINT_OK: <span class="ash">// Sensor takes a photo when a finger is</span><br/>                         <span class="ash">// placed on the module window</span><br/>      <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"Image taken"</span>);<br/>      <span class="green2">break</span>;<br/>    <span class="green2">case</span> FINGERPRINT_NOFINGER:<br/>      <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"No finger detected"</span>);<br/>      <span class="green2">return</span> p;<br/>    <span class="green2">case</span> FINGERPRINT_PACKETRECIEVEERR:<br/>      <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"Communication error"</span>);<br/>      <span class="green2">return</span> p;<br/>    <span class="green2">case</span> FINGERPRINT_IMAGEFAIL:<br/>      <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"Imaging error"</span>);<br/>      <span class="green2">return</span> p;<br/>    <span class="green2">default</span>:<br/>      <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"Unknown error"</span>);<br/>      <span class="green2">return</span> p;<br/>  }<br/><br/>  p = finger.image2Tz(); <span class="ash">// OK success! We have a fingerprint and</span><br/>                         <span class="ash">// now check that it can be read</span><br/>  <span class="green2">switch</span> (p) {<br/>    <span class="green2">case</span> FINGERPRINT_OK:<br/>      <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"Image converted"</span>);<br/>      <span class="green2">break</span>;<br/>    <span class="green2">case</span> FINGERPRINT_IMAGEMESS:<br/>      <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"Image too messy"</span>);<br/>      <span class="green2">return</span> p;<br/><span epub:type="pagebreak" id="page_186"/><br/>    <span class="green2">case</span> FINGERPRINT_PACKETRECIEVEERR:<br/>      <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"Communication error"</span>);<br/>      <span class="green2">return</span> p;<br/>    <span class="green2">case</span> FINGERPRINT_FEATUREFAIL:<br/>      <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"Could not find fingerprint features"</span>);<br/>      <span class="green2">return</span> p;<br/>    <span class="green2">case</span> FINGERPRINT_INVALIDIMAGE:<br/>      <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"Could not find fingerprint features"</span>);<br/>      <span class="green2">return</span> p;<br/>    <span class="green2">default</span>:<br/>      <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"Unknown error"</span>);<br/>      <span class="green2">return</span> p;<br/>  }<br/><br/>  p = finger.fingerFastSearch(); <span class="ash">// OK converted! It's valid, so</span><br/>                                 <span class="ash">// check it against module memory</span><br/>  <span class="green2">if</span> (p == FINGERPRINT_OK) {<br/>    <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"Found a print match!"</span>);<br/>  } <span class="green2">else if</span> (p == FINGERPRINT_PACKETRECIEVEERR) {<br/>    <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"Communication error"</span>);<br/>    <span class="green2">return</span> p;<br/>  } <span class="green2">else if</span> (p == FINGERPRINT_NOTFOUND) {<br/>    <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"Did not find a match"</span>); <span class="ash">// No match found,</span><br/>                                            <span class="ash">// back to the start</span><br/>    <span class="green2">return</span> p;<br/>  } <span class="green2">else</span> {<br/>    <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"Unknown error"</span>);<br/>    <span class="green2">return</span> p;<br/>  }<br/>  <span class="ash">// We found a match! So the following will run:</span><br/>  <span class="orange">Serial</span>.<span class="orange">print</span>(<span class="green1">"Found ID #"</span>); <span class="orange">Serial</span>.<span class="orange">print</span>(finger.fingerID);<br/>  <span class="orange">Serial</span>.<span class="orange">print</span>(<span class="green1">" with confidence of "</span>); <span class="orange">Serial</span>.<span class="orange">println</span>(finger.confidence);<br/>  <span class="green2">return</span> finger.fingerID;<br/>}<br/><span class="ash">// Returns -1 if failed, otherwise returns ID #</span><br/><span class="green1">int</span> getFingerprintIDez() {<br/>  <span class="green1">int</span> p = finger.getImage();<br/>  <span class="green2">if</span> (p != FINGERPRINT_OK) <span class="green2">return</span> -1;<br/><br/>  p = finger.image2Tz();<br/>  <span class="green2">if</span> (p != FINGERPRINT_OK) <span class="green2">return</span> -2;<br/><br/>  p = finger.fingerFastSearch();<br/>  <span class="green2">if</span> (p != FINGERPRINT_OK) ; {<br/>    <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"No match found"</span>);<br/>    <span class="green2">return</span> -3;<br/>  }<br/><br/>  <span class="ash">// Found a match!</span><br/>  <span class="orange">Serial</span>.<span class="orange">print</span>(<span class="green1">"Found ID #"</span>); <span class="orange">Serial</span>.<span class="orange">print</span>(finger.fingerID);<br/>  <span class="orange">Serial</span>.<span class="orange">print</span>(<span class="green1">" with confidence of "</span>); <span class="orange">Serial</span>.<span class="orange">println</span>(finger.confidence);<br/>  return finger.fingerID;<br/>}</p>&#13;
<h3 class="h3" id="ch00lev1sec90"><span epub:type="pagebreak" id="page_187"/><span class="green3"><strong>TROUBLESHOOTING</strong></span></h3>&#13;
<p class="ques"><strong>Q.</strong> <em>The code compiles, but the fingerprint sensor does not light up or function.</em></p>&#13;
<p class="bull">• Make sure that your wiring matches the tables on <a href="ch21.xhtml#page_181">page 181</a> and <a href="ch21.xhtml#page_182">page 182</a>. This code will work only with the fingerprint sensor I’ve used in this project.</p>&#13;
<p class="bull">• If your sensor has six wires instead of the expected four and the wire colors don’t match as described, it is the first four pins you need: GND, TX, RX, and +5V. The other two connections are not used in this project, so you can remove these wires.</p>&#13;
<p class="bull">• If your module still does not light up, check the data sheet for the actual pin configuration and reconnect the wires according to that.</p>&#13;
<p class="bull">• Remember you need to set up the module first and test it as described in “<a href="ch21.xhtml#ch00lev1sec87">Preparing the Fingerprint Sensor</a>” on <a href="ch21.xhtml#page_176">page 176</a>.</p>&#13;
<p class="ques"><strong>Q.</strong> <em>The LEDs do not light up as expected.</em></p>&#13;
<p class="bull">• Ensure the LEDs are firmly inserted into the breadboard and the resistors line up with the connections to the Arduino.</p>&#13;
<p class="bull">• Remember to connect power to the breadboard rails.</p>&#13;
<p class="ques"><strong>Q.</strong> <em>The servomotor does not move as expected.</em></p>&#13;
<p class="bull">• Double-check that the wiring matches the servo connections shown in <a href="ch21.xhtml#ch21fig9">Figure 21-9</a>.</p>&#13;
<p class="bull">• The module, servo, and LEDs combined draw a fair amount of power from your battery pack, and while the Arduino can still function at a lower voltage, the servomotor cannot. Change to fresh batteries.<span epub:type="pagebreak" id="page_188"/></p>&#13;
</body></html>