<html><head></head><body>
<p id="filepos420379" class="calibre_"><span class="calibre6"><span class="bold">
</span></span><span class="calibre1"><span class="bold">5</span></span><br class="calibre5"/><span class="calibre6"><span class="bold">AUTOMATING NESSUS</span></span></p><p class="calibre_12"><img src="images/00010.jpg" class="calibre_13"/></p><p class="calibre_6">Nessus is a popular and powerful <span class="italic">vulnerability scanner</span> that uses a database of known vulnerabilities to assess whether a given system on a network is missing any patches or is vulnerable to known exploits. In this chapter, I’ll show you how to write classes to interact with the Nessus API to automate, configure, and run a vulnerability scan.</p><p class="calibre_6">Nessus was first developed as an open source vulnerability scanner, but it became closed source in 2005 after being purchased by Tenable Network Security. As of this writing, Tenable offers a seven-day trial of Nessus Professional and a limited version called Nessus Home. The biggest difference between the two is that Nessus Home allows you to scan only 16 IP addresses at once, but Home should be sufficient for you to run the examples in this chapter and become familiar with the program. Nessus is particularly popular with professionals who help scan and manage other companies’ networks. Follow the instructions on the Tenable site <a href="https://www.tenable.com/products/nessus-home/"><span class="italic">https://www.tenable.com/products/nessus-home/</span></a> to install and configure Nessus Home.</p><p class="calibre_6"> Many organizations require regular vulnerability and patch scanning in order to manage and identify risks on their network, as well as for compliance purposes. We’ll use Nessus to accomplish these goals by building classes to help us perform unauthenticated vulnerability scans against hosts on a network.</p><p id="filepos422253" class="calibre_10"><span class="calibre3"><span class="bold">REST and the Nessus API</span></span></p><p class="calibre_11">The advent of web applications and APIs has given rise to an architecture of APIs called REST APIs. <span class="italic">REST (representational state transfer)</span> is a way of accessing and interacting with resources (such as user accounts or vulnerability scans) on the server, usually over HTTP, using a variety of HTTP methods (GET, POST, DELETE, and PUT). HTTP methods describe our intent in making the HTTP request (for example, do we want to create a resource or modify a resource?), kind of like CRUD (Create, Read, Update, Delete) operations in databases.</p><p class="calibre_6">For instance, take a look at the following simple GET HTTP request, which is like a read operation for a database (like <span class="calibre4">SELECT * FROM users WHERE id = 1</span>): GET /users/➊1 HTTP/1.0<br class="calibre5"/>Host: 192.168.0.11</p><p class="calibre_6">In this example, we’re requesting information for the user with an ID of 1. To get the information for another user’s ID, you could replace the 1 ➊ at the end of the URI with that user’s ID.</p><p class="calibre_6">To update the information for the first user, the HTTP request might look like this: POST /users/1 HTTP/1.0<br class="calibre5"/>Host: 192.168.0.11<br class="calibre5"/>Content-Type: application/json<br class="calibre5"/>Content-Length: 24<br class="calibre5"/><br class="calibre5"/>{"name": "Brandon Perry"}</p><p class="calibre_6">In our hypothetical RESTful API, the preceding POST request would update the first user’s name to Brandon Perry. Commonly, POST requests are used to update a resource on the web server.</p><p class="calibre_6">To delete the account entirely, use DELETE, like so: DELETE /users/1 HTTP/1.0<br class="calibre5"/>Host: 192.168.0.11</p><p class="calibre_6">The Nessus API will behave similarly. When consuming the API, we’ll send JSON to and receive JSON from the server, as in these examples. The classes we’ll write in this chapter are designed to handle the ways that we communicate and interact with the REST API.</p><p class="calibre_6"> Once you have Nessus installed, you can find the Nessus REST API documentation at <span class="italic">https://&lt;IP address&gt;:8834/api</span>. We’ll cover only a few of the core API calls used to drive Nessus to perform vulnerability scans.</p><p id="filepos424729" class="calibre_10"><span class="calibre3"><span class="bold">The NessusSession Class</span></span></p><p class="calibre_11">To automate sending commands and receiving responses from Nessus, we’ll create a session with the <span class="calibre4">NessusSession</span> class and execute API commands, as shown in <a href="#filepos426644">Listing 5-1</a>.</p><blockquote class="calibre_14"><span class="calibre4">public class NessusSession : ➊IDisposable</span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4"> public ➋NessusSession(string host, string username, string password)</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> ServicePointManager.ServerCertificateValidationCallback =</span><br class="calibre5"/><span class="calibre4"> (Object obj, X509Certificate certificate, X509Chain chain, SslPolicyErrors errors) =&gt; true;</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> this.Host = ➌host;</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> if (➍!Authenticate(username, password))</span><br class="calibre5"/><span class="calibre4"> throw new Exception("Authentication failed");</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> public bool ➎Authenticate(string username, string password)</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> JObject obj = ➏new JObject();</span><br class="calibre5"/><span class="calibre4"> obj["username"] = username;</span><br class="calibre5"/><span class="calibre4"> obj["password"] = password;</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> JObject ret = ➐MakeRequest(WebRequestMethods.Http.Post, "/session", obj);</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> if (ret ["token"] == null)</span><br class="calibre5"/><span class="calibre4"> return false;</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> this.➑Token = ret["token"].Value&lt;string&gt;();</span><br class="calibre5"/><span class="calibre4"> this.Authenticated = true;</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> return true;</span><br class="calibre5"/><span class="calibre4"> }</span></blockquote><p id="filepos426644" class="calibre_15"><span class="calibre4"><span class="italic">Listing 5-1: The beginning of the</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">NessusSession</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">class showing the constructor and</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">Authenticate()</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">method</span></span></p><p class="calibre_6">As you can see in <a href="#filepos426644">Listing 5-1</a>, this class implements the <span class="calibre4">IDisposable</span> interface ➊ so that we can use the <span class="calibre4">NessusSession</span> class within a <span class="calibre4">using</span> statement. As you may recall from earlier chapters, the <span class="calibre4">IDisposable</span> interface allows us to automatically clean up our session with Nessus by calling <span class="calibre4">Dispose()</span>, which we’ll implement shortly, when the currently instantiated class in the <span class="calibre4">using</span> statement is disposed during garbage collection.</p><p class="calibre_6">At ➌, we assign the <span class="calibre4">Host</span> property to the value of the <span class="calibre4">host</span> parameter passed to the <span class="calibre4">NessusSession</span> constructor ➋, and then we try to authenticate ➍ since any subsequent API calls will require an authenticated session. If authentication fails, we throw an exception and print the alert "<span class="calibre4">Authentication failed"</span>. If authentication succeeds, we store the API key for later use.</p><p class="calibre_6">In the <span class="calibre4">Authenticate()</span> method ➎, we create a <span class="calibre4">JObject</span> ➏ to hold the credentials passed in as arguments. We’ll use these to attempt to authenticate, and then we’ll call the <span class="calibre4">MakeRequest()</span> method ➐ (discussed next) and pass the HTTP method, the URI of the target host, and the <span class="calibre4">JObject</span>. If authentication succeeds, <span class="calibre4">MakeRequest()</span> should return a <span class="calibre4">JObject</span> with an authentication token; if authentication fails, it should return an empty <span class="calibre4">JObject</span>.</p><p class="calibre_6">When we receive the authentication token, we assign its value to the <span class="calibre4">Token</span> property ➑, assign the <span class="calibre4">Authenticated</span> property to <span class="calibre4">true</span>, and return <span class="calibre4">true</span> to the caller method to tell the programmer that authentication succeeded. If authentication fails, we return <span class="calibre4">false</span>.</p><p id="filepos429247" class="calibre_10"><span class="calibre3"><span class="italic"><span class="bold">Making the HTTP Requests</span></span></span></p><p class="calibre_11">The <span class="calibre4">MakeRequest()</span> method makes the actual HTTP requests and then returns the responses, as shown in <a href="#filepos431563">Listing 5-2</a>.</p><blockquote class="calibre_14"><span class="calibre4">public JObject MakeRequest(string method, string uri, ➊JObject data = null, string token = null)</span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4"> string url = ➋"https://" + this.Host + ":8834" + uri;</span><br class="calibre5"/><span class="calibre4"> HttpWebRequest request = (HttpWebRequest)WebRequest.Create(url);</span><br class="calibre5"/><span class="calibre4"> request.➌Method = method;</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> if (!string.IsNullOrEmpty(token))</span><br class="calibre5"/><span class="calibre4"> request.Headers ["X-Cookie"] = ➍"token=" + token;</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> request.➎ContentType = "application/json";</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> if (data != null)</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> byte[] bytes = System.Text.Encoding.ASCII.➏GetBytes(data.ToString());</span><br class="calibre5"/><span class="calibre4"> request.ContentLength = bytes.Length;</span><br class="calibre5"/><span class="calibre4"> using (Stream requestStream = request.GetRequestStream())</span><br class="calibre5"/><span class="calibre4"> requestStream.➐Write(bytes, 0, bytes.Length);</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><span class="calibre4"> else</span><br class="calibre5"/><span class="calibre4"> request.ContentLength = 0;</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> string response = string.Empty;</span><br class="calibre5"/><span class="calibre4"> try ➑</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> using (StreamReader reader = new ➒StreamReader(request.GetResponse().GetResponseStream()))</span><br class="calibre5"/><span class="calibre4"> response = reader.ReadToEnd();</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><span class="calibre4"> catch</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> return new JObject();</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> if (string.IsNullOrEmpty(response))</span><br class="calibre5"/><span class="calibre4"> return new JObject();</span><br class="calibre5"/><span class="calibre4"> return JObject.➓Parse(response);</span><br class="calibre5"/><span class="calibre4">}</span></blockquote><p id="filepos431563" class="calibre_15"><span class="calibre4"><span class="italic">Listing 5-2: The</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">MakeRequest()</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">method from the</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">NessusSession</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">class</span></span></p><p class="calibre_6">The <span class="calibre4">MakeRequest()</span> method has two required parameters (HTTP and URI) and two optional ones (the <span class="calibre4">JObject</span> and the authentication token). The default value for each is null.</p><p class="calibre_6">To create <span class="calibre4">MakeRequest()</span>, we first create the base URL for the API calls ➋ by combining the host and URI parameters and passing in the result as the second argument; then we use <span class="calibre4">HttpWebRequest</span> to build the HTTP request and set the property of <span class="calibre4">HttpWebRequest Method</span> ➌ to the value of the <span class="calibre4">method</span> variable passed into <span class="calibre4">MakeRequest()</span> method. Next, we test whether the user supplied an authentication token in <span class="calibre4">JObject</span>. If so, we assign the HTTP request header <span class="calibre4">X-Cookie</span> to the value of the <span class="calibre4">token</span> parameter ➍, which Nessus will look for when we authenticate. We set the <span class="calibre4">ContentType</span> property ➎ of the HTTP request to <span class="calibre4">application/json</span> to ensure that the API server knows how to deal with the data we are sending in the body of the request (otherwise, it will refuse to accept the request).</p><p class="calibre_6">If a <span class="calibre4">JObject</span> is passed to <span class="calibre4">MakeRequest()</span> in the third argument ➊, we convert it to a byte array using <span class="calibre4">GetBytes()</span> ➏, because the <span class="calibre4">Write()</span> method can only write bytes. We assign the <span class="calibre4">ContentLength</span> property to the size of the array and then use <span class="calibre4">Write()</span> ➐ to write the JSON to the request stream. If the <span class="calibre4">JObject</span> passed to <span class="calibre4">MakeRequest()</span> is null, we simply assign the value 0 to <span class="calibre4">ContentLength</span> and move on, since we will not be putting any data in the request body.</p><p class="calibre_6">Having declared an empty string to hold the response from the server, we begin a <span class="calibre4">try</span>/<span class="calibre4">catch</span> block at ➑ to receive the response. Within a <span class="calibre4">using</span> statement, we create a <span class="calibre4">StreamReader</span> ➒ to read the HTTP response by passing the server’s HTTP response stream to the <span class="calibre4">StreamReader</span> constructor; then we call <span class="calibre4">ReadToEnd()</span> to read the full response body into our empty string. If reading the response causes an exception, we can expect that the response body is empty, so we catch the exception and return an empty <span class="calibre4">JObject</span> to <span class="calibre4">ReadToEnd()</span>. Otherwise, we pass the response to <span class="calibre4">Parse()</span> ➓ and return the resulting <span class="calibre4">JObject</span>.</p><p id="filepos434808" class="calibre_10"><span class="calibre3"><span class="italic"><span class="bold">Logging Out and Cleaning Up</span></span></span></p><p class="calibre_11">To finish the <span class="calibre4">NessusSession</span> class, we’ll create <span class="calibre4">LogOut()</span> to log us out of the server and <span class="calibre4">Dispose()</span> to implement the <span class="calibre4">IDisposable</span> interface, as shown in <a href="#filepos436162">Listing 5-3</a>.</p><blockquote class="calibre_14"><span class="calibre4"> public void ➊LogOut()</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> if (this.Authenticated)</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> MakeRequest("DELETE", "/session", null, this.Token);</span><br class="calibre5"/><span class="calibre4"> this.Authenticated = false;</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><span class="calibre4"> public void ➋Dispose()</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> if (this.Authenticated)</span><br class="calibre5"/><span class="calibre4"> this.LogOut();</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> public string Host { get; set; }</span><br class="calibre5"/><span class="calibre4"> public bool Authenticated { get; private set; }</span><br class="calibre5"/><span class="calibre4"> public string Token { get; private set; }</span><br class="calibre5"/><span class="calibre4">}</span></blockquote><p id="filepos436162" class="calibre_15"><span class="calibre4"><span class="italic">Listing 5-3: The last two methods of the</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">NessusSession</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">class, as well as the</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">Host</span></span><span class="calibre4">, </span><span class="calibre4"><span class="italic">Authenticated, and</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">Token</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">properties</span></span></p><p class="calibre_6">The <span class="calibre4">LogOut()</span> method ➊ tests whether we’re authenticated with the Nessus server. If so, we call <span class="calibre4">MakeRequest()</span> by passing <span class="calibre4">DELETE</span> as the HTTP method; <span class="calibre4">/session</span> as the URI; and the authentication token, which sends a DELETE HTTP request to the Nessus server, effectively logging us out. Once the request is complete, we set the <span class="calibre4">Authenticated</span> property to <span class="calibre4">false</span>. In order to implement the <span class="calibre4">IDisposable</span> interface, we create <span class="calibre4">Dispose()</span> ➋ to log us out if we are authenticated.</p><p id="filepos437355" class="calibre_10"><span class="calibre3"><span class="italic"><span class="bold">Testing the NessusSession Class</span></span></span></p><p class="calibre_11">We can easily test the <span class="calibre4">NessusSession</span> class with a small <span class="calibre4">Main()</span> method, as shown in <a href="#filepos438162">Listing 5-4</a>.</p><blockquote class="calibre_14"><span class="calibre4">public static void ➊Main(string[] args)</span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4">➋using (NessusSession session = new ➌NessusSession("192.168.1.14", "admin", "password"))</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> Console.➍WriteLine("Your authentication token is: " + session.Token);</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><span class="calibre4">}</span></blockquote><p id="filepos438162" class="calibre_15"><span class="calibre4"><span class="italic">Listing 5-4: Testing the</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">NessusSession</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">class to authenticate with</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">NessusManager</span></span></p><p class="calibre_6">In the <span class="calibre4">Main()</span> method ➊, we create a new <span class="calibre4">NessusSession</span> ➌ and pass the IP address of the Nessus host, the username, and the Nessus password as the arguments. With the authenticated session, we print the authentication token ➍ Nessus gave us on successful authentication and then exit.</p><p class="calibre_16"><span class="calibre3"><span class="bold"><span class="calibre_17"><span class="calibre_18">  NOTE </span></span></span></span></p><blockquote class="calibre_7"><span class="italic">The</span>
<span class="calibre4"><span class="italic">NessusSession</span></span>
<span class="italic">is created in the context of a</span>
<span class="calibre4"><span class="italic">using</span></span>
<span class="italic">statement</span> ➋<span class="italic">, so the</span>
<span class="calibre4"><span class="italic">Dispose()</span></span>
<span class="italic">method we implemented in the</span>
<span class="calibre4"><span class="italic">NessusSession</span></span>
<span class="italic">class will be automatically called when the</span>
<span class="calibre4"><span class="italic">using</span></span>
<span class="italic">block ends. This logs out the</span>
<span class="calibre4"><span class="italic">NessusSession</span></span><span class="italic">, invalidating the authentication token we were given by Nessus.</span></blockquote><p class="calibre_6">Running this code should print an authentication token similar to the one in <a href="#filepos440028">Listing 5-5</a>.</p><blockquote class="calibre_14"><span class="calibre4"> $ </span><span class="calibre4"><span class="bold">mono ./ch5_automating_nessus.exe</span></span><br class="calibre5"/><span class="calibre4">Your authentication token is: 19daad2f2fca99b2a2d48febb2424966a99727c19252966a</span><br class="calibre5"/><span class="calibre4">$</span></blockquote><p id="filepos440028" class="calibre_15"><span class="calibre4"><span class="italic">Listing 5-5: Running the</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">NessusSession</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">test code to print the authentication token</span></span></p><p id="filepos440286" class="calibre_10"><span class="calibre3"><span class="bold">The NessusManager Class</span></span></p><p class="calibre_11"><a href="#filepos442874">Listing 5-6</a> shows the methods we need to implement in the <span class="calibre4">NessusManager</span> class, which will wrap common API calls and functionality for Nessus in easy-to-use methods we can call later.</p><blockquote class="calibre_14"><span class="calibre4">public class NessusManager : ➊IDisposable</span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4"> NessusSession _session;</span><br class="calibre5"/><span class="calibre4"> public NessusManager(NessusSession session)</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> _session = ➋session;</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> public JObject GetScanPolicies()</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> return _session.➌MakeRequest("GET", "/editor/policy/templates", null, _session.Token);</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> public JObject CreateScan(string policyID, string cidr, string name, string description)</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> JObject data = ➍new JObject();</span><br class="calibre5"/><span class="calibre4"> data["uuid"] = policyID;</span><br class="calibre5"/><span class="calibre4"> data["settings"] = new JObject();</span><br class="calibre5"/><span class="calibre4"> data["settings"]["name"] = name;</span><br class="calibre5"/><span class="calibre4"> data["settings"]["text_targets"] = cidr;</span><br class="calibre5"/><span class="calibre4"> data["settings"]["description"] = description;</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> return _session.➎MakeRequest("POST", "/scans", data, _session.Token);</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> public JObject StartScan(int scanID)</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> return _session.MakeRequest("POST", "/scans/" + scanID + "/launch", null, _session.Token);</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> public JObject ➏GetScan(int scanID)</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> return _session.MakeRequest("GET", "/scans/" + scanID, null, _session.Token);</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> public void Dispose()</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> if (_session.Authenticated)</span><br class="calibre5"/><span class="calibre4"> _session.➐LogOut();</span><br class="calibre5"/><span class="calibre4"> _session = null;</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><span class="calibre4">}</span></blockquote><p id="filepos442874" class="calibre_15"><span class="calibre4"><span class="italic">Listing 5-6: The</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">NessusManager</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">class</span></span></p><p class="calibre_6">The <span class="calibre4">NessusManager</span> class implements <span class="calibre4">IDisposable</span> ➊ so that we can use <span class="calibre4">NessusSession</span> to interact with the Nessus API and log out automatically if necessary. The <span class="calibre4">NessusManager</span> constructor takes one argument, a <span class="calibre4">NessusSession</span>, and assigns it to the private <span class="calibre4">_session</span> variable ➋, which any method in <span class="calibre4">NessusManager</span> can access.</p><p class="calibre_6">Nessus is preconfigured with a few different scan policies. We’ll sort through these policies using <span class="calibre4">GetScanPolicies()</span> and <span class="calibre4">MakeRequest()</span> ➌ to retrieve a list of policies and their IDs from the <span class="italic">/editor/policy/templates</span> URI. The first argument to <span class="calibre4">CreateScan()</span> is the scan policy ID, and the second is the CIDR range to scan. (You can also enter a newline-delimited string of IP addresses in this argument.) The third and fourth arguments can be used to hold a name and description of the scan, respectively. We’ll use a unique <span class="calibre4">Guid</span> (<span class="italic">globally unique ID</span>, long strings of unique letters and numbers) for each names since our scan is only for testing purposes, but as you build more sophisticated automation, you may want to adopt a system of naming scans in order to make them easier to track. We use the arguments passed to <span class="calibre4">CreateScan()</span> to create a new <span class="calibre4">JObject</span> ➍ containing the settings for the scan to create. We then pass this <span class="calibre4">JObject</span> to <span class="calibre4">MakeRequest()</span> ➎, which will send a POST request to the <span class="italic">/scans</span> URI and return all relevant information about the particular scan, showing that we successfully created (but did not start!) a scan. We can use the scan ID to report the status of a scan.</p><p class="calibre_6">Once we’ve created the scan with <span class="calibre4">CreateScan()</span>, we’ll pass its ID to the <span class="calibre4">StartScan()</span> method, which will create a POST request to the <span class="italic">/scans/&lt;scanID&gt;/launch</span> URI and return the JSON response telling us whether the scan was launched. We can use <span class="calibre4">GetScan()</span> ➏ to monitor the scan.</p><p class="calibre_6">To complete <span class="calibre4">NessusManager</span>, we implement <span class="calibre4">Dispose()</span> to log out of the session ➐ and then clean up by setting the <span class="calibre4">_session</span> variable to null.</p><p id="filepos445707" class="calibre_10"><span class="calibre3"><span class="bold">Performing a Nessus Scan</span></span></p><p class="calibre_11"><a href="#filepos447170">Listing 5-7</a> shows how to begin using <span class="calibre4">NessusSession</span> and <span class="calibre4">NessusManager</span> to run a scan and print the results.</p><blockquote class="calibre_14"><span class="calibre4">public static void Main(string[] args)</span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4"> ServicePointManager.➊ServerCertificateValidationCallback =</span><br class="calibre5"/><span class="calibre4"> (Object obj, X509Certificate certificate, X509Chain chain, SslPolicyErrors errors) =&gt; true;</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> using (NessusSession session = ➋new NessusSession("192.168.1.14", "admin", "password"))</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> using (NessusManager manager = new NessusManager(session))</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> JObject policies = manager.➌GetScanPolicies();</span><br class="calibre5"/><span class="calibre4"> string discoveryPolicyID = string.Empty;</span><br class="calibre5"/><span class="calibre4"> foreach (JObject template in policies["templates"])</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> if (template ["name"].Value&lt;string&gt;() == ➍"basic")</span><br class="calibre5"/><span class="calibre4"> discoveryPolicyID = template ["uuid"].Value&lt;string&gt;();</span><br class="calibre5"/><span class="calibre4"> }</span></blockquote><p id="filepos447170" class="calibre_15"><span class="calibre4"><span class="italic">Listing 5-7: Retrieving the list of scan policies so we can start a scan with the correct scan policy</span></span></p><p class="calibre_6">We begin our automation by first disabling SSL certificate verification (because the Nessus server’s SSL keys are self-signed, they will fail verification) by assigning an anonymous method that only returns <span class="calibre4">true</span> to the <span class="calibre4">ServerCertificateValidationCallback</span> ➊. This callback is used by the HTTP networking libraries to verify an SSL certificate. Simply returning <span class="calibre4">true</span> causes any SSL certificate to be accepted. Next, we create a <span class="calibre4">NessusSession</span> ➋ and pass it the IP address of the Nessus server as well as the username and password for the Nessus API. If authentication succeeds, we pass the new session to another <span class="calibre4">NessusManager</span>.</p><p class="calibre_6">Once we have an authenticated session and a manager, we can begin interacting with the Nessus server. We first get a list of the scan policies available with <span class="calibre4">GetScanPolicies()</span> ➌ and then create an empty string with <span class="calibre4">string.Empty</span> to hold the scan policy ID for the basic scan policy and iterate over the scan policy templates. As we iterate over the scan policies, we check whether the name of the current scan policy equals the string <span class="calibre4">basic</span> ➍; this is a good starting point for a scan policy that allows us to perform a small set of unauthenticated checks against hosts on the network. We store the ID for the basic scan policy for later use.</p><p class="calibre_6">Now to create and start the scan with the basic scan policy ID, as shown in <a href="#filepos450210">Listing 5-8</a>.</p><blockquote class="calibre_14"><span class="calibre4"> JObject scan = manager.➊CreateScan(discoveryPolicyID, "192.168.1.31",</span><br class="calibre5"/><span class="calibre4"> "Network Scan", "A simple scan of a single IP address.");</span><br class="calibre5"/><span class="calibre4"> int scanID = ➋scan["scan"]["id"].Value&lt;int&gt;();</span><br class="calibre5"/><span class="calibre4"> manager.➌StartScan(scanID);</span><br class="calibre5"/><span class="calibre4"> JObject scanStatus = manager.GetScan(scanID);</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> while (scanStatus["info"]["status"].Value&lt;string&gt;() != ➍"completed")</span><br class="calibre5"/><span class="calibre4"> {</span><br class="calibre5"/><span class="calibre4"> Console.WriteLine("Scan status: " + scanStatus["info"]</span><br class="calibre5"/><span class="calibre4"> ["status"].Value&lt;string&gt;());</span><br class="calibre5"/><span class="calibre4"> Thread.Sleep(5000);</span><br class="calibre5"/><span class="calibre4"> scanStatus = manager.➎GetScan(scanID);</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><br class="calibre5"/><span class="calibre4"> foreach (JObject vuln in scanStatus["vulnerabilities"])</span><br class="calibre5"/><span class="calibre4"> Console.WriteLine(vuln.ToString());</span><br class="calibre5"/><span class="calibre4"> }</span><br class="calibre5"/><span class="calibre4">}</span></blockquote><p id="filepos450210" class="calibre_15"><span class="calibre4"><span class="italic">Listing 5-8: The second half of the Nessus automation</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">Main()</span></span><span class="calibre4">
</span><span class="calibre4"><span class="italic">method</span></span></p><p class="calibre_6"> At ➊, we call <span class="calibre4">CreateScan()</span>, passing in a policy ID, IP address, name, and description of the method, and we store its response in a <span class="calibre4">JObject</span>. We then pull the scan ID out of the <span class="calibre4">JObject</span> ➋ so that we can pass the scan ID to <span class="calibre4">StartScan()</span> ➌ to start the scan.</p><p class="calibre_6">We use <span class="calibre4">GetScan()</span> to monitor the scan by passing it the scan ID, storing the result in a <span class="calibre4">JObject</span> and using a <span class="calibre4">while</span> loop to continually check whether the current scan status has completed ➍. If the scan has not completed, we print its status, sleep for five seconds, and call <span class="calibre4">GetScan()</span> ➎ again. The loop repeats until the scan reports completed, at which point we iterate over and print each vulnerability returned by <span class="calibre4">GetScan()</span> in a <span class="calibre4">foreach</span> loop, which may look something like <a href="#filepos453341">Listing 5-9</a>. A scan might take several minutes to complete, depending on your computer and network speed.</p><blockquote class="calibre_14"><span class="calibre4">$ </span><span class="calibre4"><span class="bold">mono ch5_automating_nessus.exe</span></span><br class="calibre5"/><span class="calibre4">Scan status: running</span><br class="calibre5"/><span class="calibre4">Scan status: running</span><br class="calibre5"/><span class="calibre4">Scan status: running</span><br class="calibre5"/><span class="calibre4"><span class="italic">--snip--</span></span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4"> "count": 1,</span><br class="calibre5"/><span class="calibre4"> "plugin_name": ➊"SSL Version 2 and 3 Protocol Detection",</span><br class="calibre5"/><span class="calibre4"> "vuln_index": 62,</span><br class="calibre5"/><span class="calibre4"> "severity": 2,</span><br class="calibre5"/><span class="calibre4"> "plugin_id": 20007,</span><br class="calibre5"/><span class="calibre4"> "severity_index": 30,</span><br class="calibre5"/><span class="calibre4"> "plugin_family": "Service detection"</span><br class="calibre5"/><span class="calibre4">}</span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4"> "count": 1,</span><br class="calibre5"/><span class="calibre4"> "plugin_name": ➋"SSL Self-Signed Certificate",</span><br class="calibre5"/><span class="calibre4"> "vuln_index": 61,</span><br class="calibre5"/><span class="calibre4"> "severity": 2,</span><br class="calibre5"/><span class="calibre4"> "plugin_id": 57582,</span><br class="calibre5"/><span class="calibre4"> "severity_index": 31,</span><br class="calibre5"/><span class="calibre4"> "plugin_family": "General"</span><br class="calibre5"/><span class="calibre4">}</span><br class="calibre5"/><span class="calibre4">{</span><br class="calibre5"/><span class="calibre4"> "count": 1,</span><br class="calibre5"/><span class="calibre4"> "plugin_name": "SSL Certificate Cannot Be Trusted",</span><br class="calibre5"/><span class="calibre4"> "vuln_index": 56,</span><br class="calibre5"/><span class="calibre4"> "severity": 2,</span><br class="calibre5"/><span class="calibre4"> "plugin_id": 51192,</span><br class="calibre5"/><span class="calibre4"> "severity_index": 32,</span><br class="calibre5"/><span class="calibre4"> "plugin_family": "General"</span><br class="calibre5"/><span class="calibre4">}</span></blockquote><p id="filepos453341" class="calibre_15"><span class="calibre4"><span class="italic">Listing 5-9: Partial output from an automated scan using the Nessus vulnerability scanner</span></span></p><p class="calibre_6">The scan results tell us that the target is using weak SSL modes (protocols 2 and 3) ➊ and a self-signed SSL certificate on an open port ➋. We can now ensure that the server’s SSL configurations are using fully up-to-date SSL modes and then disable the weak modes (or disable the service altogether). Once finished, we can rerun our automated scan to ensure that Nessus no longer reports any weak SSL modes in use.</p><p id="filepos453972" class="calibre_10"><span class="calibre3"><span class="bold"> Conclusion</span></span></p><p class="calibre_11">This chapter has shown you how to automate various aspects of the Nessus API in order to complete an unauthenticated scan of a network-attached device. In order to achieve this, we needed to be able to send API requests to the Nessus HTTP server. To do so, we created the <span class="calibre4">NessusSession</span> class; then, once we were able to authenticate with Nessus, we created the <span class="calibre4">NessusManager</span> class to create, run, and report the results of a scan. We wrapped everything with code that used these classes to drive the Nessus API automatically based on user-provided information.</p><p class="calibre_6">This isn’t the extent of the features Nessus provides, and you’ll find more detail in the Nessus API documentation. Many organizations require performing authenticated scans against hosts on the network in order to get full patch listings to determine host health, and upgrading our automation to handle this would be a good exercise. </p><div class="mbp_pagebreak" id="calibre_pb_10"/>
</body></html>