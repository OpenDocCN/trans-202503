<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" lang="en" xml:lang="en">
<head>
<title>JavaScript Crash Course</title>
<meta content="text/html; charset=utf-8" http-equiv="default-style"/>
<link href="../styles/stylesheet.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:26ab05bf-a247-42ca-b08d-ede069333d2b" name="Adept.expected.resource"/>
</head>
<body epub:type="bodymatter">
<section aria-labelledby="ch15" epub:type="chapter" role="doc-chapter">
<hgroup>
<h2 class="CHAPTER" id="ch15">
<span class="CN"><span aria-label=" Page 299. " epub:type="pagebreak" id="pg_299" role="doc-pagebreak"/><samp class="SANS_Futura_Std_Bold_Condensed_B_11">15</samp></span>
<span class="CT"><samp class="SANS_Dogma_OT_Bold_B_11">VISUALIZING DATA FROM THE GITHUB SEARCH API</samp></span>
</h2>
</hgroup>
<figure class="opener"><img alt="" class="opener" src="../images/opener.png"/>
</figure>
<p class="INTROTNI2">In this final project, you’ll build an application that reads data from a public API and uses D3 to build an interactive bar chart based on that data. We’ll be reading data from the GitHub Search API. This API allows you to search for data on GitHub, a service that hosts Git repositories (Git is a popular version control system for keeping track of software project source code). The API uses the HTTPS protocol and returns JSON-formatted data based on a search query you encode into a URL.</p>
<p class="TX">If you haven’t used GitHub before, go to <a href="https://github.com"><i>https://<wbr/>github<wbr/>.com</i></a> to see what it looks like. At the top of the page, you’ll see a search box that you can use to search for public, <i>open source</i> repositories (that is, repositories whose source code is available to anyone to read and use). Instead of using that search box manually, the GitHub Search API lets us perform searches <span aria-label=" Page 300. " epub:type="pagebreak" id="pg_300" role="doc-pagebreak"/>programmatically—for example, with JavaScript. The API can search for various items on GitHub, such as repositories, users, and issues. We’ll be using the repository search feature to find top JavaScript repositories. Then we’ll draw a D3 bar chart ranking the repositories by popularity. The viewer will be able to learn more about each repository by hovering over its bar. We’ll also add some interactivity by allowing the viewer to hide or show repositories based on their software license.</p>
<p class="TX">This project will give you experience working with real-world data from a JSON API. A huge amount of programming boils down to making requests to third-party APIs and then doing some work with the returned data, as you’ll practice here. You’ll also put everything you learned about D3 in <a href="chapter14.xhtml">Chapter 14</a> to work, building up a more interesting, interactive chart, and you’ll learn some techniques for creating richer visualizations.</p>
<section aria-labelledby="sec1" epub:type="division">
<h3 class="H1" id="sec1"><span id="h1-89"/><samp class="SANS_Futura_Std_Bold_B_11">Setting Up</samp></h3>
<p class="TNI1">To get started, create a new directory called <i>github</i>, and add empty <i>style.css</i> and <i>script.js</i> files. Then make an <i>index.html</i> file and add the code in <a href="#Lis15-1">Listing 15-1</a>.</p>
<span id="Lis15-1"/>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;GitHub&lt;/title&gt;
    &lt;link rel="stylesheet" href="style.css"&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;script src="https://unpkg.com/d3@7.4.4/dist/d3.js"&gt;&lt;/script&gt;
    &lt;script src="script.js"&gt;&lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-1: An</samp> <samp class="SANS_Futura_Std_Book_11">index.html</samp> <samp class="SANS_Futura_Std_Book_Oblique_I_11">file for our GitHub Search API visualization</samp></p>
<p class="TX">This is the same basic HTML file we used in <a href="chapter14.xhtml">Chapter 14</a>. It gives us access to D3 through a <span class="SANS_TheSansMonoCd_W5Regular_11">script</span> element linking to a copy of the library on <a href="https://unpkg.com"><i>https://<wbr/>unpkg<wbr/>.com</i></a>.</p>
</section>
<section aria-labelledby="sec2" epub:type="division">
<h3 class="H1" id="sec2"><span id="h1-90"/><samp class="SANS_Futura_Std_Bold_B_11">Fetching Data</samp></h3>
<p class="TNI1">Now let’s try getting some data from the GitHub Search API. To do this, we need to format our request for data as part of a URL. Visiting that URL retrieves the data. The whole URL, including the search query we’ll be using, looks like this (note that it’s been broken onto two lines here to fit the page):</p>

<pre><code>https://api.github.com/search/repositories?q=language%3Ajavascript%20stars%3A
%3E10000&amp;per_page=20&amp;sort=stars
</code></pre>
<p class="BodyContinued"><span aria-label=" Page 301. " epub:type="pagebreak" id="pg_301" role="doc-pagebreak"/>Rather than type out the URL manually, however, we’ll build it up using JavaScript, which will make it easier to understand and modify.</p>
<p class="TX">The URL has two parts: a base URL, which gives us access to the API, and a query string, where we specify what data we want. These two parts are separated by a question mark (<span class="SANS_TheSansMonoCd_W5Regular_11">?</span>). The query string contains pairs of keys and values that are used to send information to the API about the query we’re making. Each key and value is joined by an equal sign (<span class="SANS_TheSansMonoCd_W5Regular_11">=</span>), and each key-value pair is separated by an ampersand (<span class="SANS_TheSansMonoCd_W5Regular_11">&amp;</span>). In this URL, the keys are <span class="SANS_TheSansMonoCd_W5Regular_11">q</span> (search query), <span class="SANS_TheSansMonoCd_W5Regular_11">per_page</span> (number of results per page), and <span class="SANS_TheSansMonoCd_W5Regular_11">sort</span> (how to sort the results). The keys and values in query strings are allowed to contain only a limited set of characters: <span class="SANS_TheSansMonoCd_W5Regular_11">a</span>–<span class="SANS_TheSansMonoCd_W5Regular_11">z</span>, <span class="SANS_TheSansMonoCd_W5Regular_11">A</span>–<span class="SANS_TheSansMonoCd_W5Regular_11">Z</span>, <span class="SANS_TheSansMonoCd_W5Regular_11">0</span>–<span class="SANS_TheSansMonoCd_W5Regular_11">9</span>, hyphen (<span class="SANS_TheSansMonoCd_W5Regular_11">-</span>), period (<span class="SANS_TheSansMonoCd_W5Regular_11">.</span>), underscore (<span class="SANS_TheSansMonoCd_W5Regular_11">_</span>), tilde (<span class="SANS_TheSansMonoCd_W5Regular_11">~</span>), and a limited set of other special characters. All other characters must be represented using the <i>URL encoding</i> system, which is where all the percent (<span class="SANS_TheSansMonoCd_W5Regular_11">%</span>) characters in the URL come from. For example, a colon (<span class="SANS_TheSansMonoCd_W5Regular_11">:</span>) is encoded as <span class="SANS_TheSansMonoCd_W5Regular_11">%3A</span> and a space is encoded as <span class="SANS_TheSansMonoCd_W5Regular_11">%20</span>.</p>
<p class="TX">To simplify things, we’ll write a function that takes an object with the unencoded query string parameters and converts it to a properly formatted and encoded URL. Add the code in <a href="#Lis15-2">Listing 15-2</a> to <i>script.js</i>.</p>
<span id="Lis15-2"/>
<pre><code>function getUrl() {
<span aria-label="annotation1" class="CodeAnnotationCode">❶</span> let baseUrl = "https://api.github.com/search/repositories";

<span aria-label="annotation2" class="CodeAnnotationCode">❷</span> let params = {
    q: "language:javascript stars:&gt;10000",
    per_page: 20,
    sort: "stars"
  };

<span aria-label="annotation3" class="CodeAnnotationCode">❸</span> let queryString = Object.entries(params).map(pair =&gt; {
    return `${pair[0]}=${encodeURIComponent(pair[1])}`;
  }).join("&amp;");

<span aria-label="annotation4" class="CodeAnnotationCode">❹</span> return `${baseUrl}?${queryString}`;
}

let url = getUrl();

console.log(url);
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-2: Creating the URL</samp></p>
<p class="TX">The code to create the URL lives in the <span class="SANS_TheSansMonoCd_W5Regular_11">getUrl</span> function. This function first sets the base URL (the part of the URL before the query string) <span aria-label="annotation1" class="CodeAnnotationCode">❶</span>. Then, to build the query string, we start by creating a <span class="SANS_TheSansMonoCd_W5Regular_11">params</span> object <span aria-label="annotation2" class="CodeAnnotationCode">❷</span>, with the search query <span class="SANS_TheSansMonoCd_W5Regular_11">q</span> using GitHub’s search query format. Specifically, we’re searching for repositories whose language is JavaScript that have over 10,000 stars (users on GitHub can “star” repositories to save them for later, so the number of stars is a rough measure of popularity). You can try out this query in the search box on <a href="https://github.com"><i>https://<wbr/>github<wbr/>.com</i></a> if you want.</p>
<p class="TX">Next, we map over the key-value pairs in <span class="SANS_TheSansMonoCd_W5Regular_11">params</span>, creating a string for each pair with the format <span class="SANS_TheSansMonoCd_W5Regular_11">"</span><span class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">key</span><span class="SANS_TheSansMonoCd_W5Regular_11">=</span><span class="SANS_TheSansMonoCd_W5Regular_Italic_I_11">value</span><span class="SANS_TheSansMonoCd_W5Regular_11">"</span> <span aria-label="annotation3" class="CodeAnnotationCode">❸</span>. The keys don’t need to be <span aria-label=" Page 302. " epub:type="pagebreak" id="pg_302" role="doc-pagebreak"/>URL-encoded—unquoted object keys don’t contain any special characters, so they’re already valid in URLs—but we encode the values using the built-in function <span class="SANS_TheSansMonoCd_W5Regular_11">encodeURIComponent</span>, which replaces any disallowed characters with their percent-encoded versions. We then join the strings together, separating them with the <span class="SANS_TheSansMonoCd_W5Regular_11">&amp;</span> character, and build and return the final URL by combining the base URL, the <span class="SANS_TheSansMonoCd_W5Regular_11">?</span> character, and the query string <span aria-label="annotation4" class="CodeAnnotationCode">❹</span>. We end the script by calling our <span class="SANS_TheSansMonoCd_W5Regular_11">getUrl</span> function and logging the result to the console.</p>
<p class="TX">When you load the page and open the console, you should see the URL shown earlier printed there. If you copy that URL and paste it into your browser’s address bar, you should see a bunch of JSON data. If not, make sure the URL matches the URL on the previous page, and check your code if it doesn’t. If the URL looks correct and you’re not getting data, or you’re getting an error message, it’s possible that GitHub has changed the way its API works. See the upcoming box “Authenticated vs. Unauthenticated APIs” for guidance on what to do in this case.</p>
<p class="TX">To bring the JSON data into your application you can use D3’s <span class="SANS_TheSansMonoCd_W5Regular_11">json</span> helper method, which fetches JSON from a given URL. Update the end of <i>script.js</i> as shown in <a href="#Lis15-3">Listing 15-3</a>.</p>
<span id="Lis15-3"/>
<pre><code><var>--snip--</var>
<span class="gray">let url = getUrl();</span>

d3.json(url).then(data =&gt; {
  console.log(data);
});
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-3: Fetching JSON data</samp></p>
<p class="TX">Fetching a bunch of data from an API may take a little time, so the <span class="SANS_TheSansMonoCd_W5Regular_11">d3.json</span> method returns a <span class="SANS_TheSansMonoCd_W5Regular_11">Promise</span>, a type of object that represents something that will be available in the future. The <span class="SANS_TheSansMonoCd_W5Regular_11">then</span> method takes a function that will be called when the data is ready. D3 converts the JSON response string into a JavaScript object, so <span class="SANS_TheSansMonoCd_W5Regular_11">data</span> will be an object. Here, we just log it to the console.</p>
<section aria-labelledby="sec3" epub:type="division">
<aside aria-label="box-46" class="box" id="sec3">
<h4 class="BH" id="box-46"><samp class="SANS_Dogma_OT_Bold_B_11">AUTHENTICATED VS. UNAUTHENTICATED APIS</samp></h4>
<p class="BoxBodyFirst"><samp class="SANS_Futura_Std_Book_11">The GitHub Search API is an HTTP API, meaning it exchanges data using HTTP over the HTTPS protocol. This kind of API can be either authenticated or unauthenticated. An</samp> <samp class="SANS_Futura_Std_Book_Oblique_I_11">authenticated</samp> <samp class="SANS_Futura_Std_Book_11">API requires you to somehow prove your identity to the API owner, for example, by providing a secret key with your request, whereas</samp> <samp class="SANS_Futura_Std_Book_Oblique_I_11">unauthenticated</samp> <samp class="SANS_Futura_Std_Book_11">APIs have no such requirements.</samp></p>
<p class="BoxBody"><samp class="SANS_Futura_Std_Book_11">Unfortunately, with browser-based JavaScript applications like the one we’re writing here, there’s no easy way to use an authenticated API without exposing some secret information. For that reason, when you need to work</samp> <span aria-label=" Page 303. " epub:type="pagebreak" id="pg_303" role="doc-pagebreak"/><samp class="SANS_Futura_Std_Book_11">with an authenticated API, it’s most common to break the application into two pieces:</samp> <samp class="SANS_Futura_Std_Book_Oblique_I_11">backend</samp> <samp class="SANS_Futura_Std_Book_11">code running on a server that communicates securely with the authenticated API, and</samp> <samp class="SANS_Futura_Std_Book_Oblique_I_11">frontend</samp> <samp class="SANS_Futura_Std_Book_11">code running in the browser that communicates with the backend. This way, the browser code and the API don’t need to interact directly.</samp></p>
<p class="BoxBody"><samp class="SANS_Futura_Std_Book_11">It’s perfectly possible to write backend code in JavaScript using a framework called Node.js, but that’s outside of the scope of this book. Instead, we’ll keep all the application code in the browser, and stick to unauthenticated APIs like the GitHub Search API we’re using here. On the off chance that GitHub is no longer supporting this unauthenticated API at the time you read this book, however, this arrangement will no longer work, and you’ll have problems running Listings 15-2 and 15-3. In case that happens, I’ve provided a snapshot of the GitHub Search API data we’ll be using for this project, which you can access through the URL</samp> <a href="https://skilldrick-jscc.s3.us-west-2.amazonaws.com/gh-js-repos.json"><samp class="SANS_Futura_Std_Book_Oblique_I_11">https://skilldrick-jscc.s3.us-west-2.amazonaws.com/gh-js-repos.json</samp><samp class="SANS_Futura_Std_Book_11">.</samp></a> <samp class="SANS_Futura_Std_Book_11">To use this snapshot of the data, replace the content of your</samp> <samp class="SANS_Futura_Std_Book_Oblique_I_11">script.js</samp> <samp class="SANS_Futura_Std_Book_11">file with the following code:</samp></p>

<pre><code>let backupUrl =
  "https://skilldrick-jscc.s3.us-west-2.amazonaws.com/gh-js-repos.json";

d3.json(backupUrl).then(data =&gt; {
  console.log(data);
});
</code></pre>
<p class="BoxBodyLast"><samp class="SANS_Futura_Std_Book_11">You’ll now be able to continue with the rest of the project code as written, starting from <a href="#Lis15-4">Listing 15-4</a>.</samp></p>
</aside>
<p class="TX">When you reload the page, after waiting a few seconds you should see the data in the console. Take a moment to inspect it. You should see three top-level properties: <span class="SANS_TheSansMonoCd_W5Regular_11">incomplete_results</span>, <span class="SANS_TheSansMonoCd_W5Regular_11">items</span>, and <span class="SANS_TheSansMonoCd_W5Regular_11">total_count</span>. The <span class="SANS_TheSansMonoCd_W5Regular_11">incomplete _results</span> property will be <span class="SANS_TheSansMonoCd_W5Regular_11">true</span> if the query took too long and the API was able to return only partial results; otherwise, it will be <span class="SANS_TheSansMonoCd_W5Regular_11">false</span>. The <span class="SANS_TheSansMonoCd_W5Regular_11">total_count</span> property gives the total number of results for this search query (this is the total number of results the search found, of which only the first 20 are returned). The <span class="SANS_TheSansMonoCd_W5Regular_11">items</span> array contains the results of the current call; it should contain 20 items. Each item is an object with some information about a particular repository, including its name, description, and various other details. Several of the fields are themselves GitHub API URLs that can be called to get additional information about the repository. For example, <span class="SANS_TheSansMonoCd_W5Regular_11">languages_url</span> is an API URL that tells you what programming languages are used in the repository, broken down by the number of lines of code per language.</p>
<p class="TX">In this project, we’ll be using several fields from each item: <span class="SANS_TheSansMonoCd_W5Regular_11">full_name</span>, <span class="SANS_TheSansMonoCd_W5Regular_11">stargazers_count</span>, <span class="SANS_TheSansMonoCd_W5Regular_11">html_url</span>, and <span class="SANS_TheSansMonoCd_W5Regular_11">license</span>. The <span class="SANS_TheSansMonoCd_W5Regular_11">full_name</span> field holds the name of the repository owner and the name of the repository joined with a forward slash: for example, <span class="SANS_TheSansMonoCd_W5Regular_11">"facebook/react"</span>. The <span class="SANS_TheSansMonoCd_W5Regular_11">stargazers_count</span> field gives the number of times the repository has been starred by users. The <span class="SANS_TheSansMonoCd_W5Regular_11">html_url</span> <span aria-label=" Page 304. " epub:type="pagebreak" id="pg_304" role="doc-pagebreak"/>field holds the repository’s URL on GitHub. Finally, <span class="SANS_TheSansMonoCd_W5Regular_11">license</span> has data about which software license the repository uses.</p>
<blockquote>
<p class="NOTE"><samp class="SANS_Dogma_OT_Bold_B_21">NOTE</samp></p>
</blockquote>
<p class="NOTE-TXT"><i>Open source code owners use software licenses to tell other users what they can and can’t do with their code. For example, some licenses are very restrictive, stating that the code can’t be used in an application whose code isn’t itself open source. Others are much more permissive, allowing you to do whatever you want with the code.</i></p>
</section>
</section>
<section aria-labelledby="sec4" epub:type="division">
<h3 class="H1" id="sec4"><span id="h1-91"/><samp class="SANS_Futura_Std_Bold_B_11">The Basic Visualization</samp></h3>
<p class="TNI1">Now that we have the data, we’ll create a basic bar chart showing how many stars each repository in the dataset has received. To do this, we’ll create the required SVG elements, draw the axes, and draw the bars themselves. Later we’ll improve on this basic chart, making it more informative, stylish, and interactive.</p>
<section aria-labelledby="sec5" epub:type="division">
<h4 class="H2" id="sec5"><span id="h2-99"/><samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">Creating the Elements</samp></h4>
<p class="TNI1">To create our chart, we first have to create the <span class="SANS_TheSansMonoCd_W5Regular_11">svg</span> element that will hold it and the two <span class="SANS_TheSansMonoCd_W5Regular_11">g</span> elements for the axes. In this case, the axes will be on the bottom and left sides. Add the code in <a href="#Lis15-4">Listing 15-4</a> to the start of <i>script.js</i>, before the <span class="SANS_TheSansMonoCd_W5Regular_11">getUrl</span> function.</p>
<span id="Lis15-4"/>
<pre><code>const width = 600;
const height = 400;

let svg = d3
  .select("body")
<span aria-label="annotation1" class="CodeAnnotationHang1">❶</span> .append("svg")
  .attr("width", width)
  .attr("height", height);

<span aria-label="annotation2" class="CodeAnnotationHang">❷</span> let margin = {top: 20, right: 10, bottom: 20, left: 50};

// Bottom axis container
let bottomContainer = svg
<span aria-label="annotation3" class="CodeAnnotationHang1">❸</span> .append("g")
  .attr("id", "bottom")
  .attr("transform", `translate(0, ${height - margin.bottom})`);

// Left axis container
let leftContainer = svg
<span aria-label="annotation4" class="CodeAnnotationHang1">❹</span> .append("g")
  .attr("id", "left")
  .attr("transform", `translate(${margin.left}, 0)`);

<span class="gray">function getUrl() {</span>
<var>--snip--</var>
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-4: Setting up the elements</samp></p>
<p class="TX"><span aria-label=" Page 305. " epub:type="pagebreak" id="pg_305" role="doc-pagebreak"/>Much like we did for the character frequency chart in <a href="chapter14.xhtml">Chapter 14</a>, we append an <span class="SANS_TheSansMonoCd_W5Regular_11">svg</span> element to the page <span aria-label="annotation1" class="CodeAnnotationCode">❶</span> and set its width and height. We then create a <span class="SANS_TheSansMonoCd_W5Regular_11">margin</span> object <span aria-label="annotation2" class="CodeAnnotationCode">❷</span> and append the <span class="SANS_TheSansMonoCd_W5Regular_11">g</span> elements for containing the bottom <span aria-label="annotation3" class="CodeAnnotationCode">❸</span> and left <span aria-label="annotation4" class="CodeAnnotationCode">❹</span> axes, which we position based on the margins.</p>
</section>
<section aria-labelledby="sec6" epub:type="division">
<h4 class="H2" id="sec6"><span id="h2-100"/><samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">Drawing the Axes</samp></h4>
<p class="TNI1">With the elements created, we can make a start on the <span class="SANS_TheSansMonoCd_W5Regular_11">update</span> function, which will draw the visualization. First, we’ll create the scales based on the data and draw the axes. Make the changes to <i>script.js</i> shown in <a href="#Lis15-5">Listing 15-5</a>.</p>
<span id="Lis15-5"/>
<pre><code><var>--snip--</var>
<span class="gray">// Left axis container</span>
<span class="gray">let leftContainer = svg</span>
<span class="gray">  .append("g")</span>
<span class="gray">  .attr("id", "left")</span>
<span class="gray">  .attr("transform", `translate(${margin.left}, 0)`);</span>

function update(items) {
<span aria-label="annotation1" class="CodeAnnotationCode">❶</span> let xScale = d3.scaleBand()
    .domain(items.map(d =&gt; d.full_name))
    .range([margin.left, width - margin.right])
    .padding(0.3);

  let yScale = d3.scaleLinear()
  <span aria-label="annotation2" class="CodeAnnotationHang1">❷</span> .domain([0, d3.max(items, d =&gt; d.stargazers_count)])
    .range([height - margin.bottom, margin.top])
    .nice();

<span aria-label="annotation3" class="CodeAnnotationHang1">❸</span> let bottomAxis = d3.axisBottom(xScale);
  let leftAxis = d3.axisLeft(yScale);

<span aria-label="annotation4" class="CodeAnnotationHang1">❹</span> bottomContainer.call(bottomAxis);
  leftContainer.call(leftAxis);
}

<span class="gray">function getUrl() {</span>
<span class="TheSansMonoCd_W5Regular_Italic_I_11">--snip--</span>

<span class="gray">d3.json(url).then(data =&gt; {</span>
<span aria-label="annotation5" class="CodeAnnotationCode">❺</span> update(data.items);
});
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-5: Drawing the axes</samp></p>
<p class="TX">The <span class="SANS_TheSansMonoCd_W5Regular_11">update</span> function takes the <span class="SANS_TheSansMonoCd_W5Regular_11">items</span> array from the API response. Our bar chart will have a vertical bar for each repository, so we create the horizontal <span class="SANS_TheSansMonoCd_W5Regular_11">xScale</span> using the <span class="SANS_TheSansMonoCd_W5Regular_11">scaleBand</span> helper to evenly space the bars <span aria-label="annotation1" class="CodeAnnotationCode">❶</span>. The domain is the <span class="SANS_TheSansMonoCd_W5Regular_11">full_name</span> from each repository. Each repository’s full name is unique, so this will result in 20 bands. The vertical <span class="SANS_TheSansMonoCd_W5Regular_11">yScale</span> is used to visualize the number of stars that each repository has, so its domain goes from zero to the max <span class="SANS_TheSansMonoCd_W5Regular_11">stargazers_count</span> <span aria-label="annotation2" class="CodeAnnotationCode">❷</span>. We use <span class="SANS_TheSansMonoCd_W5Regular_11">nice</span> here to round the top of the scale to the next <span aria-label=" Page 306. " epub:type="pagebreak" id="pg_306" role="doc-pagebreak"/>tick value. After creating the scales, we create the axis generators <span aria-label="annotation3" class="CodeAnnotationCode">❸</span> and then use those generators to draw the axes to the containers <span aria-label="annotation4" class="CodeAnnotationCode">❹</span>, as we did for the character frequencies project.</p>
<p class="TX">The last thing to do here is call our <span class="SANS_TheSansMonoCd_W5Regular_11">update</span> function from inside the <span class="SANS_TheSansMonoCd_W5Regular_11">d3.json</span> callback, passing the <span class="SANS_TheSansMonoCd_W5Regular_11">items</span> array <span aria-label="annotation5" class="CodeAnnotationCode">❺</span>. We’re able to go straight from fetching the data to calling <span class="SANS_TheSansMonoCd_W5Regular_11">update</span> because the GitHub Search API conveniently returns the data in the format we need for rendering. There’s no need to do any processing of the data like we did in the character frequencies example, where the source data was just a string and we needed a sorted array of objects describing each character and its count.</p>
<p class="TX">When you reload <i>index.html</i> you should now see the axes, as shown in <a href="chapter15.xhtml#fig15-1">Figure 15-1</a>. We’ll fix the bottom axis labels shortly; they’re a mess right now because D3 is trying to render the full name of each repository. Also, your left axis scale may go higher than the 200,000 shown in the figure, depending on how many stars the most popular JavaScript project has when you run this code. At the time of this writing, facebook/react had the most stars of any JavaScript project on GitHub, at around 196,000.</p>
<figure class="IMG"><img alt="" class="img1" id="fig15-1" src="../images/Figure_15-1.png"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 15-1: The axes</samp></p></figcaption>
</figure>
<p class="TX">Given that we’re working with such large numbers here (and getting larger every day), we can increase readability by using SI prefixes like <i>k</i> for 1,000. This is easy to do in D3 with the right number format. While we make that change, we’ll also remove the ticks from the bottom axis. See <a href="#Lis15-6">Listing 15-6</a> for these changes.</p>
<span id="Lis15-6"/>
<pre><code><span aria-label=" Page 307. " epub:type="pagebreak" id="pg_307" role="doc-pagebreak"/><var>--snip--</var>
<span class="gray">  let yScale = d3.scaleLinear()</span>
<span class="gray">    .domain([0, d3.max(items, d </span><span class="gray">=&gt; d.stargazers_count)])</span>
<span class="gray">    .range([height - margin.bottom, margin.top])</span>
<span class="gray">    .nice();</span>

  let bottomAxis = d3
    .axisBottom(xScale)
  <span aria-label="annotation1" class="CodeAnnotationHang1">❶</span> .tickValues([]);

  let leftAxis = d3
    .axisLeft(yScale)
  <span aria-label="annotation2" class="CodeAnnotationHang1">❷</span> .tickFormat(d3.format("~s"));

<span class="gray">  bottomContainer.call(bottomAxis);</span>
<span class="gray">  leftContainer.call(leftAxis);</span>
<var>--snip--</var>
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-6: Cleaning up the scales</samp></p>
<p class="TX">For the bottom axis, we’re updating the tick values to be an empty list <span aria-label="annotation1" class="CodeAnnotationCode">❶</span>, which effectively removes the ticks. For the left axis, we’re adding a tick format using the format specifier <span class="SANS_TheSansMonoCd_W5Regular_11">"~s"</span> <span aria-label="annotation2" class="CodeAnnotationCode">❷</span>, which will, for example, render the number 200,000 as <span class="SANS_TheSansMonoCd_W5Regular_11">200k</span> and 1,000,000 as <span class="SANS_TheSansMonoCd_W5Regular_11">1M</span>. <a href="chapter15.xhtml#fig15-2">Figure 15-2</a> shows how the updated axes should now look.</p>
<figure class="IMG"><img alt="" class="img1" id="fig15-2" src="../images/Figure_15-2.png"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 15-2: The axes after some cleanup</samp></p></figcaption>
</figure>
<p class="TX">The numbers in the left axis are now easier to read at a glance, and the bottom axis is no longer a jumble of text.</p>
</section>
<section aria-labelledby="sec7" epub:type="division">
<h4 class="H2" id="sec7"><span id="h2-101"/><span aria-label=" Page 308. " epub:type="pagebreak" id="pg_308" role="doc-pagebreak"/><samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">Drawing the Bars</samp></h4>
<p class="TNI1">Now that the axes are drawn, we need to draw the bars themselves. Add the code in <a href="#Lis15-7">Listing 15-7</a> to the end of the <span class="SANS_TheSansMonoCd_W5Regular_11">update</span> function.</p>
<span id="Lis15-7"/>
<pre><code><var>--snip--</var>
<span class="gray">  bottomContainer.call(bottomAxis);</span>
<span class="gray">  leftContainer.call(leftAxis);</span>

  svg
    .selectAll("rect")
    .data(items, <span aria-label="annotation1" class="CodeAnnotationCode">❶</span> d =&gt; d.full_name)
    .join("rect")
    .attr("x", d =&gt; xScale(d.full_name))
  <span aria-label="annotation2" class="CodeAnnotationHang1">❷</span> .attr("y", d =&gt; yScale(d.stargazers_count))
    .attr("width", xScale.bandwidth())
  <span aria-label="annotation3" class="CodeAnnotationHang1">❸</span> .attr("height", d =&gt; yScale(0) - yScale(d.stargazers_count));
<span class="gray">}</span>

<span class="gray">function getUrl() {</span>
<var>--snip--</var>
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-7: Drawing the bars</samp></p>
<p class="TX">As in the character frequencies project, we’re drawing a bunch of <span class="SANS_TheSansMonoCd_W5Regular_11">rect</span> elements. The key function <span aria-label="annotation1" class="CodeAnnotationCode">❶</span> extracts the <span class="SANS_TheSansMonoCd_W5Regular_11">full_name</span> property, which we’re using here as the unique identifier for each repository. For now, we’re using the simple join technique, without separate handling for entering, updating, and exiting elements (that will come later).</p>
<p class="TX">The <span class="SANS_TheSansMonoCd_W5Regular_11">x</span> attribute is set based on looking up the <span class="SANS_TheSansMonoCd_W5Regular_11">full_name</span> in <span class="SANS_TheSansMonoCd_W5Regular_11">xScale</span>, and the <span class="SANS_TheSansMonoCd_W5Regular_11">width</span> is based on the <span class="SANS_TheSansMonoCd_W5Regular_11">bandwidth</span> method on <span class="SANS_TheSansMonoCd_W5Regular_11">xScale</span>. The <span class="SANS_TheSansMonoCd_W5Regular_11">y</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">height</span> attributes are a bit trickier this time and require some explanation. If you look back at the definition of <span class="SANS_TheSansMonoCd_W5Regular_11">yScale</span> in <a href="#Lis15-5">Listing 15-5</a>, you’ll see that the domain is <span class="SANS_TheSansMonoCd_W5Regular_11">[0, d3.max(items, d =&gt; d.stargazers_count)]</span> and the range is <span class="SANS_TheSansMonoCd_W5Regular_11">[height - margin .bottom, margin.top]</span>. With the values we’ve set, that range expands to <span class="SANS_TheSansMonoCd_W5Regular_11">[380, 20]</span>. The range goes from high to low, meaning that high values in the domain map to lower values in the range, and vice versa. This is because y values in computer graphics count down from the top of the screen, but in our graph we want y values to count up from the bottom of the graph. The other thing that makes this tricky is that SVG rectangles are drawn from the top-left corner, which will likely be different for each bar, so we need to set a variable height that makes all the bars hit the bottom axis.</p>
<p class="TX">Because of all this, we set the <span class="SANS_TheSansMonoCd_W5Regular_11">y</span> attribute of the bar to <span class="SANS_TheSansMonoCd_W5Regular_11">yScale(d.stargazers _count)</span> <span aria-label="annotation2" class="CodeAnnotationCode">❷</span>, which gives the vertical position of the top of the bar. To calculate the height of the bar, we use <span class="SANS_TheSansMonoCd_W5Regular_11">yScale(0) - yScale(d.stargazers_count)</span> <span aria-label="annotation3" class="CodeAnnotationCode">❸</span>. Calling <span class="SANS_TheSansMonoCd_W5Regular_11">yScale(0)</span> gives the vertical position of the bottom of the bar (all the bars should have their base at 0 in the domain), so subtracting the position of the top of the bar from the position of the bottom of the bar gives the height of the bar. We need to end up with a positive height, so we have to subtract the smaller number from the larger number. The top of the bar is a smaller number in the display range, even though it’s a larger number in <span aria-label=" Page 309. " epub:type="pagebreak" id="pg_309" role="doc-pagebreak"/>the domain. <a href="chapter15.xhtml#fig15-3">Figure 15-3</a> shows how the bars should look, though keep in mind that your bar heights may be different based on how the data evolves.</p>
<figure class="IMG"><img alt="" class="img1" id="fig15-3" src="../images/Figure_15-3.png"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 15-3: Drawing the bars as rect elements</samp></p></figcaption>
</figure>
<p class="TX">As you look at the bars, remember that each bar is drawn from its top-left corner, and that the heights are calculated such that the bottoms of all the bars align.</p>
</section>
<section aria-labelledby="sec8" epub:type="division">
<aside aria-label="box-47" class="box" id="sec8">
<h4 class="BH" id="box-47"><samp class="SANS_Dogma_OT_Bold_B_11">TRY IT YOURSELF</samp></h4>
<p class="BoxListNumber"><samp class="SANS_Futura_Std_Bold_B_11">15-1.</samp><samp class="SANS_Futura_Std_Book_11">  Try modifying the width of the bars by changing the padding on the</samp> <span class="SANS_TheSansMonoCd_W5Regular_11">xScale</span> <samp class="SANS_Futura_Std_Book_11">object.</samp></p>
<p class="BoxListNumber"><samp class="SANS_Futura_Std_Bold_B_11">15-2.</samp><samp class="SANS_Futura_Std_Book_11">  </samp><samp class="SANS_Futura_Std_Book_11">For more of a challenge, try modifying the domain of the data along the left axis so the minimum value is based on the minimum number of stars rather than starting at zero. Hint: this makes calculating the bar heights a little more complex, as you can’t subtract from</samp> <span class="SANS_TheSansMonoCd_W5Regular_11">yScale(0)</span> <samp class="SANS_Futura_Std_Book_11">now. To get the appropriate height, you’ll need to replace</samp> <span class="SANS_TheSansMonoCd_W5Regular_11">yScale(0)</span> <samp class="SANS_Futura_Std_Book_11">with</samp> <span class="SANS_TheSansMonoCd_W5Regular_11">yScale.range()[0]</span><samp class="SANS_Futura_Std_Book_11">.</samp> <span class="SANS_TheSansMonoCd_W5Regular_11">yScale.range()</span> <samp class="SANS_Futura_Std_Book_11">gives you the two-element array of the minimum and maximum range values after applying the</samp> <span class="SANS_TheSansMonoCd_W5Regular_11">nice</span> <samp class="SANS_Futura_Std_Book_11">rounding.</samp></p>
</aside>
</section>
</section>
<section aria-labelledby="sec9" epub:type="division">
<h3 class="H1" id="sec9"><span id="h1-92"/><span aria-label=" Page 310. " epub:type="pagebreak" id="pg_310" role="doc-pagebreak"/><samp class="SANS_Futura_Std_Bold_B_11">Improving the Visualization</samp></h3>
<p class="TNI1">We now have a basic visualization up and running, but it isn’t terribly informative. In this section, we’ll implement some improvements to make the visualization more meaningful. We’ll create a way to see more information about each repository. We’ll also color-code the bars to show each repository’s license type, and make sure the axes are properly labeled.</p>
<section aria-labelledby="sec10" epub:type="division">
<h4 class="H2" id="sec10"><span id="h2-102"/><samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">Showing Repository Info</samp></h4>
<p class="TNI1">The current graph doesn’t give any way of identifying which repository each bar represents. There are various ways to solve this (for example, vertically or diagonally oriented tick labels, or some kind of <i>tooltip</i>, a text field that pops up when a bar is hovered), but for this project we’ll add a permanent sidebar that shows more information about a bar when you hover over it. First, we’ll add the HTML for the sidebar to <i>index.html</i>, as shown in <a href="#Lis15-8">Listing 15-8</a>.</p>
<span id="Lis15-8"/>
<pre><code><var>--snip--</var>
<span class="gray">  &lt;body</span>&gt;
    &lt;div id="sidebar"&gt;
      &lt;div id="info" class="box"&gt;
        &lt;p class="repo"&gt;
          &lt;span class="label"&gt;Repository&lt;/span&gt;
        <span aria-label="annotation1" class="CodeAnnotationHang1">❶</span> &lt;span class="value"&gt;&lt;a target="_blank"&gt;&lt;/a&gt;&lt;/span&gt;
        &lt;/p&gt;
        &lt;p class="license"&gt;
          &lt;span class="label"&gt;License&lt;/span&gt;
          &lt;span class="value"&gt;&lt;/span&gt;
        &lt;/p&gt;
        &lt;p class="stars"&gt;
          &lt;span class="label"&gt;Stars&lt;/span&gt;
          &lt;span class="value"&gt;&lt;/span&gt;
        &lt;/p&gt;
      &lt;/div&gt;
    &lt;/div&gt;

<span class="gray">    &lt;script src="https://unpkg.com/d3@7.4.4/dist/d3.js"&gt;&lt;/script&gt;</span>
<span class="gray">    &lt;script src="script.js"&gt;&lt;/script&gt;</span>
<span class="gray">  &lt;/body&gt;</span>
<var>--snip--</var>
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-8: Adding the sidebar HTML to</samp> <samp class="SANS_Futura_Std_Book_11">index.html</samp></p>
<p class="TX">Here we set up a <span class="SANS_TheSansMonoCd_W5Regular_11">div</span> called <span class="SANS_TheSansMonoCd_W5Regular_11">info</span> with the elements that we’ll need to display the repository information. It’s nested inside another <span class="SANS_TheSansMonoCd_W5Regular_11">div</span> called <span class="SANS_TheSansMonoCd_W5Regular_11">sidebar</span>. This outer <span class="SANS_TheSansMonoCd_W5Regular_11">div</span> may seem superfluous now, but later we’ll add another <span class="SANS_TheSansMonoCd_W5Regular_11">div</span> element to the sidebar, so we’ll need the parent <span class="SANS_TheSansMonoCd_W5Regular_11">div</span> element to contain the two sidebar <span class="SANS_TheSansMonoCd_W5Regular_11">div</span> elements.</p>
<p class="TX">The <span class="SANS_TheSansMonoCd_W5Regular_11">info div</span> will show the repository name, its license type, and its number of stars. We use <span class="SANS_TheSansMonoCd_W5Regular_11">span</span> elements to wrap parts of the text. A <span class="SANS_TheSansMonoCd_W5Regular_11">span</span> is a <span aria-label=" Page 311. " epub:type="pagebreak" id="pg_311" role="doc-pagebreak"/>container element like a <span class="SANS_TheSansMonoCd_W5Regular_11">div</span>, but unlike <span class="SANS_TheSansMonoCd_W5Regular_11">div</span> elements, which create a new block, <span class="SANS_TheSansMonoCd_W5Regular_11">span</span> is an inline element, so it can enclose part of a line of text without making a new line. Later, we’ll update the content of the <span class="SANS_TheSansMonoCd_W5Regular_11">value</span> spans when you hover over a bar to show the relevant information about that bar.</p>
<p class="TX">One of the <span class="SANS_TheSansMonoCd_W5Regular_11">span</span> elements contains an <span class="SANS_TheSansMonoCd_W5Regular_11">a</span> element <span aria-label="annotation1" class="CodeAnnotationCode">❶</span>, which creates a hyperlink to another page or website. The URL of the link is specified with an <span class="SANS_TheSansMonoCd_W5Regular_11">href</span> attribute, which we’ll set dynamically later. The <span class="SANS_TheSansMonoCd_W5Regular_11">target="_blank"</span> attribute instructs the browser to open the link in a new tab or window.</p>
<p class="TX">The sidebar looks a bit ugly at this stage, so let’s add some CSS. Add the code in <a href="#Lis15-9">Listing 15-9</a> to <i>style.css</i>.</p>
<span id="Lis15-9"/>
<pre><code>body {
<span aria-label="annotation1" class="CodeAnnotationHang1">❶</span> display: flex;
  align-items: flex-start;
  font-family: Arial, Helvetica, sans-serif;
}

.box {
  padding: 0px 15px 0px 15px;
  border: 1px solid #888;
  margin-bottom: 15px;
}

#info .label {
  font-weight: bold;
  display: block;
}

#info a {
  text-decoration: none;
}

#info a:hover {
  text-decoration: underline;
}
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-9: Styling the sidebar</samp></p>
<p class="TX">For this project we’re using a CSS technique called <i>flexbox</i> <span aria-label="annotation1" class="CodeAnnotationCode">❶</span>, which is a relatively recent addition to the CSS specification. Flexbox makes it much easier to define layouts, especially those that will work flexibly across a variety of screen and viewport sizes. Flexbox layouts have two main components: the <i>flex container</i> and the <i>flex items</i>. The flex container is a parent element that defines how its child flex items (the direct children of the container) are sized and how they flow. In our case, the flex container is the <span class="SANS_TheSansMonoCd_W5Regular_11">body</span> element, and the flex items are the <span class="SANS_TheSansMonoCd_W5Regular_11">svg</span> element and the <span class="SANS_TheSansMonoCd_W5Regular_11">#sidebar</span> element. By default, the items are arranged left to right (meaning that the <span class="SANS_TheSansMonoCd_W5Regular_11">#sidebar</span> element will appear on the left of the screen, followed by the <span class="SANS_TheSansMonoCd_W5Regular_11">svg</span> element to its right). The declaration <span class="SANS_TheSansMonoCd_W5Regular_11">align-items: flex-start;</span> means that the items will be aligned to the top of the parent container.</p>
<blockquote>
<p class="NOTE"><span aria-label=" Page 312. " epub:type="pagebreak" id="pg_312" role="doc-pagebreak"/><samp class="SANS_Dogma_OT_Bold_B_21">NOTE</samp></p>
</blockquote>
<p class="NOTE-TXT"><i>If you want to learn more about flexbox, check out</i> <a href="https://css-tricks.com/snippets/css/a-guide-to-flexbox/"><span class="note_LinkURL_Italic">https://css-tricks.com/snippets/css/a-guide-to-flexbox/</span></a>.</p>
</section>
<section aria-labelledby="sec11" epub:type="division">
<aside aria-label="box-48" class="box" id="sec11">
<h4 class="BH" id="box-48"><samp class="SANS_Dogma_OT_Bold_B_11">TRY IT YOURSELF</samp></h4>
<p class="BoxListNumber"><samp class="SANS_Futura_Std_Bold_B_11">15-3.</samp><samp class="SANS_Futura_Std_Book_11">  Chrome makes it very easy to experiment with flexbox changes. If you open up the element inspector, you’ll see a small</samp> <span class="SANS_TheSansMonoCd_W5Regular_11">flex</span> <samp class="SANS_Futura_Std_Book_11">icon next to the</samp> <span class="SANS_TheSansMonoCd_W5Regular_11">body</span> <samp class="SANS_Futura_Std_Book_11">element. Click that and the browser will add highlighting to show the flex container and flex items. In the Styles pane, you can click the icon next to</samp> <span class="SANS_TheSansMonoCd_W5Regular_11">display: flex;</span> <samp class="SANS_Futura_Std_Book_11">to open a dialog that will let you interactively modify the flex container properties.</samp></p>
</aside>
<p class="TX">Currently the <span class="SANS_TheSansMonoCd_W5Regular_11">svg</span> element is being appended to the <span class="SANS_TheSansMonoCd_W5Regular_11">body</span> element, meaning that it comes after the sidebar, but for layout reasons we want it to come before. To do that, we’ll need to switch from the <span class="SANS_TheSansMonoCd_W5Regular_11">append</span> method to the <span class="SANS_TheSansMonoCd_W5Regular_11">insert</span> method when we create the <span class="SANS_TheSansMonoCd_W5Regular_11">svg</span> element, since the latter allows us to specify an element to insert before. The <i>script.js</i> change for this is shown in <a href="#Lis15-10">Listing 15-10</a>.</p>
<span id="Lis15-10"/>
<pre><code><var>--snip--</var>
<span class="gray">let svg = d3</span>
<span class="gray">  .select("body")</span>
  .insert("svg", "#sidebar")
<span class="gray">  .attr("width", width)</span>
<span class="gray">  .attr("height", height);</span>
<var>--snip--</var>
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-10: Inserting the svg element before the sidebar</samp></p>
<p class="TX">Now the sidebar will appear to the right of the graph, as the <span class="SANS_TheSansMonoCd_W5Regular_11">svg</span> element now appears before the sidebar in the flex container.</p>
<p class="TX">Before we write the code for displaying the details about a repository in the sidebar, we need a function for getting the name of the repository’s license. Accessing the other pieces of information will be straightforward, but not all repositories have a license, so our function has to handle the case where no license data is available. <a href="#Lis15-11">Listing 15-11</a> shows the new <span class="SANS_TheSansMonoCd_W5Regular_11">getLicense</span> function, which you can insert into <i>script.js</i> just before the <span class="SANS_TheSansMonoCd_W5Regular_11">update</span> function.</p>
<span id="Lis15-11"/>
<pre><code><var>--snip--</var>
<span class="gray">// Left axis container</span>
<span class="gray">let leftContainer = svg</span>
<span class="gray">  .append("g")</span>
<span class="gray">  .attr("id", "left")</span>
<span class="gray">  .attr("transform", `translate(${margin.left}, 0)`);</span>

<span aria-label=" Page 313. " epub:type="pagebreak" id="pg_313" role="doc-pagebreak"/>function getLicense(d) {
<span aria-label="annotation1" class="CodeAnnotationCode">❶</span> let license = d.license?.name;

<span aria-label="annotation2" class="CodeAnnotationCode">❷</span> if (!license) {
    return "No License";
  } else {
    return license;
  }
}

<span class="gray">function update(items) {</span>
<var>--snip--</var>
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-11: The getLicense function</samp></p>
<p class="TX">If a repository has a license, the license name will be available as <span class="SANS_TheSansMonoCd_W5Regular_11">d.license.name</span>, but if it doesn’t have a license, <span class="SANS_TheSansMonoCd_W5Regular_11">d.license</span> will be undefined. We test for this situation using the <span class="SANS_TheSansMonoCd_W5Regular_11">?.</span> operator, called the <i>optional chaining operator</i> <span aria-label="annotation1" class="CodeAnnotationCode">❶</span>. Like the regular <span class="SANS_TheSansMonoCd_W5Regular_11">.</span> operator, <span class="SANS_TheSansMonoCd_W5Regular_11">?.</span> attempts to take the object specified to the left of the operator and access the method or property specified to the right of the operator. Unlike the regular <span class="SANS_TheSansMonoCd_W5Regular_11">.</span> operator, however, <span class="SANS_TheSansMonoCd_W5Regular_11">?.</span> will return <span class="SANS_TheSansMonoCd_W5Regular_11">undefined</span> if the object to the left of the operator is <span class="SANS_TheSansMonoCd_W5Regular_11">null</span> or <span class="SANS_TheSansMonoCd_W5Regular_11">undefined</span>. Thus, if <span class="SANS_TheSansMonoCd_W5Regular_11">d.license</span> is <span class="SANS_TheSansMonoCd_W5Regular_11">undefined</span> (meaning the repository doesn’t have a license), our <span class="SANS_TheSansMonoCd_W5Regular_11">license</span> variable will be set to <span class="SANS_TheSansMonoCd_W5Regular_11">undefined</span>, but if <span class="SANS_TheSansMonoCd_W5Regular_11">d.license</span> is an object (meaning the repository has a license), then <span class="SANS_TheSansMonoCd_W5Regular_11">license</span> will be set to <span class="SANS_TheSansMonoCd_W5Regular_11">d.license.name</span>. If <span class="SANS_TheSansMonoCd_W5Regular_11">license</span> ends up <span class="SANS_TheSansMonoCd_W5Regular_11">undefined</span> <span aria-label="annotation2" class="CodeAnnotationCode">❷</span>, our <span class="SANS_TheSansMonoCd_W5Regular_11">getLicense</span> function returns the string <span class="SANS_TheSansMonoCd_W5Regular_11">"No License"</span>. Otherwise, the value of <span class="SANS_TheSansMonoCd_W5Regular_11">license</span> is returned.</p>
<p class="TX">Now we can add the code that will update the sidebar when the bars are hovered over. We’ll do this by adding a <span class="SANS_TheSansMonoCd_W5Regular_11">mouseover</span> event handler to the <span class="SANS_TheSansMonoCd_W5Regular_11">rect</span> elements. Update <i>script.js</i> with the code in <a href="#Lis15-12">Listing 15-12</a>. This code goes at the end of the <span class="SANS_TheSansMonoCd_W5Regular_11">update</span> function.</p>
<span id="Lis15-12"/>
<pre><code><var>--snip--</var>
    <span class="gray">.attr("width", xScale.bandwidth())</span>
    .attr("height", d =&gt; yScale(0) - yScale(d.stargazers_count))
    .on("mouseover", (e, d) =&gt; {
      let info = d3.select("#info");
      info.select(".repo .value a").text(d.full_name).attr("href", d.html_url); <span class="codewide_CodeAnnotation">1</span>
      info.select(".license .value").text(getLicense(d));
      info.select(".stars .value").text(d.stargazers_count);
    });
<span class="gray">}</span>

<span class="gray">function getUrl() {</span>
<var>--snip--</var>
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-12: Updating the sidebar on hover</samp></p>
<p class="TX">D3 event handlers are called with two arguments: the event object (<span class="SANS_TheSansMonoCd_W5Regular_11">e</span>) and the datum bound to the element that the event was triggered on (<span class="SANS_TheSansMonoCd_W5Regular_11">d</span>). The first thing we do in the handler is select the <span class="SANS_TheSansMonoCd_W5Regular_11">#info</span> element, because <span aria-label=" Page 314. " epub:type="pagebreak" id="pg_314" role="doc-pagebreak"/>all the elements we want to modify are children of that element. We then update the <span class="SANS_TheSansMonoCd_W5Regular_11">a</span> element inside the <span class="SANS_TheSansMonoCd_W5Regular_11">.value</span> element inside the <span class="SANS_TheSansMonoCd_W5Regular_11">.repo</span> element <span aria-label="annotation1" class="CodeAnnotationCode">❶</span> (refer back to <a href="#Lis15-8">Listing 15-8</a> or look at <i>index.html</i> to remind yourself of the HTML structure). We’re setting both the text content of this element and the <span class="SANS_TheSansMonoCd_W5Regular_11">href</span> attribute. This has the effect of making a link to the repository, with the full name of the repository as the link text. We similarly set the text of the <span class="SANS_TheSansMonoCd_W5Regular_11">.value .license</span> element to whatever <span class="SANS_TheSansMonoCd_W5Regular_11">getLicense</span> returns for this datum and the text of the <span class="SANS_TheSansMonoCd_W5Regular_11">.stars .value</span> element to the number of stars.</p>
<p class="TX">Reload the page and try hovering over some of the bars. You should see something like <a href="chapter15.xhtml#fig15-4">Figure 15-4</a>.</p>
<figure class="IMG"><img alt="" class="img1" id="fig15-4" src="../images/Figure_15-4.png"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 15-4: The sidebar showing details about one of the repositories</samp></p></figcaption>
</figure>
<p class="TX">For each bar you hover over, the details for that repository should show up in the new sidebar. If you click the repository name, your browser should open up a new tab and take you to the repository’s GitHub page.</p>
</section>
<section aria-labelledby="sec12" epub:type="division">
<h4 class="H2" id="sec12"><span id="h2-103"/><samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">Color-Coding the Bars</samp></h4>
<p class="TNI1">In order to convey some additional information visually, we’re going to color-code the bars based on the license types. D3 lets you create scales whose inputs (the domain) are values and whose outputs (the range) are colors. You’ll see how to do that in <a href="#Lis15-13">Listing 15-13</a>.</p>
<span id="Lis15-13"/>
<pre><code><var>--snip--</var>
<span class="gray">function update(items) {</span>
<span aria-label="annotation1" class="CodeAnnotationCode">❶</span> let licenses = new Set(items.map(d =&gt; getLicense(d)));

<span aria-label="annotation2" class="CodeAnnotationCode">❷</span> let colorScale = d3.scaleOrdinal()
    .domain(licenses)
<span aria-label=" Page 315. " epub:type="pagebreak" id="pg_315" role="doc-pagebreak"/>    .range(d3.schemeCategory10);

<span class="gray">  let xScale = d3.scaleBand()</span>
<var>--snip--</var>
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-13: Creating a color scale for the licenses</samp></p>
<p class="TX">First, we need to collect all the unique license names. To do this, we map over the items, calling our <span class="SANS_TheSansMonoCd_W5Regular_11">getLicense</span> function for each one <span aria-label="annotation1" class="CodeAnnotationCode">❶</span>. This gives an array of the license names. In the same line, we pass the resulting array to the <span class="SANS_TheSansMonoCd_W5Regular_11">Set</span> constructor. In programming terms, a <i>set</i> is a collection of unique items, so the <span class="SANS_TheSansMonoCd_W5Regular_11">Set</span> constructor can take an array of items and filter out any duplicates. In JavaScript, sets maintain their order, like arrays.</p>
<p class="TX">The <span class="SANS_TheSansMonoCd_W5Regular_11">d3.scaleOrdinal</span> helper <span aria-label="annotation2" class="CodeAnnotationCode">❷</span> creates a scale with discrete inputs and discrete outputs. Here, the inputs are the unique license names and the outputs are color names. For the scale’s range, we’re using <span class="SANS_TheSansMonoCd_W5Regular_11">d3.schemeCategory10</span>, which is an array of 10 hex color strings. You can check it out in the console:</p>

<pre><code><b>d3.schemeCategory10;</b>
<span class="code_MenuArrow"></span><var>(10) ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', </var>
<var> '#e377c2', '#7f7f7f', '#bcbd22', '#17becf']</var>
</code></pre>
<p class="TX">Each license in the set will map to one of these colors, index-wise. If there are more than 10 licenses, the colors will wrap around to the beginning again (the eleventh and twelfth licenses will use the same colors as the first and second ones).</p>
<p class="TX">Next we have to set the color of the bar based on its license and the color scale. <a href="#Lis15-14">Listing 15-14</a> shows how to make that change near the end of the <span class="SANS_TheSansMonoCd_W5Regular_11">update</span> function.</p>
<span id="Lis15-14"/>
<pre><code><var>--snip--</var>
<span class="gray">  svg</span>
<span class="gray">    .selectAll("rect")</span>
<span class="gray">    .data(items, d </span><span class="gray">=&gt; d.full_name)</span>
<span class="gray">    .join("rect")</span>
<span class="gray">    .attr("x", d =&gt; xScale(d.full_name))</span>
<span class="gray">    .attr("y", d =&gt; yScale(d.stargazers_count))</span>
    .attr("fill", d =&gt; colorScale(getLicense(d)))
<span class="gray">    .attr("width", xScale.bandwidth())</span>
<span class="gray">    .attr("height", d =&gt; yScale(0) - yScale(d.stargazers_count))</span>
<var>--snip--</var>
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-14: Setting the fill color of the rect</samp></p>
<p class="TX">We have to call our <span class="SANS_TheSansMonoCd_W5Regular_11">getLicense</span> function on <span class="SANS_TheSansMonoCd_W5Regular_11">d</span> to get the license name (because it could be <span class="SANS_TheSansMonoCd_W5Regular_11">"No License"</span>), before passing the license name to the <span class="SANS_TheSansMonoCd_W5Regular_11">colorScale</span>. This gives us the color value for setting the <span class="SANS_TheSansMonoCd_W5Regular_11">fill</span> attribute of the <span class="SANS_TheSansMonoCd_W5Regular_11">rect</span>.</p>
<p class="TX">With color-coding like this, you really need a key so users know what each color means. We’ll create that key as another box in the sidebar, <span aria-label=" Page 316. " epub:type="pagebreak" id="pg_316" role="doc-pagebreak"/>beneath the repository info box. It will include squares of color alongside the corresponding license names. First, we’ll need some more HTML. Update <i>index.html</i> with the changes in <a href="#Lis15-15">Listing 15-15</a>.</p>
<span id="Lis15-15"/>
<pre><code><var>--snip--</var>
<span class="gray">        &lt;p class="stars"&gt;</span>
<span class="gray">          &lt;span class="label"&gt;Stars&lt;/span&gt;</span>
<span class="gray">          &lt;span class="value"&gt;&lt;/span&gt;</span>
<span class="gray">        &lt;/p&gt;</span>
<span class="gray">      &lt;/div&gt;</span>

      &lt;div id="key" class="box"&gt;
        &lt;h1&gt;Key&lt;/h1&gt;
      &lt;/div&gt;
<span class="gray">    &lt;/div&gt;</span>
<var>--snip--</var>
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-15: Adding the div and heading for the license key</samp></p>
<p class="TX">Here we’re creating another <span class="SANS_TheSansMonoCd_W5Regular_11">div</span> called <span class="SANS_TheSansMonoCd_W5Regular_11">key</span> inside the <span class="SANS_TheSansMonoCd_W5Regular_11">sidebar div</span> and giving it a heading. We’ll create the other elements for the key using JavaScript.</p>
<p class="TX">Next comes the CSS for styling these new elements and the children we’ll be adding with JavaScript. Add the code in <a href="#Lis15-16">Listing 15-16</a> to the end of <i>style.css</i>.</p>
<span id="Lis15-16"/>
<pre><code><var>--snip--</var>
<span class="gray">#info a:hover {</span>
<span class="gray">  text-decoration: underline;</span>
<span class="gray">}</span>

#key h1 {
  font-size: 1.5em;
}

#key .color {
  display: inline-block;
  width: 10px;
  height: 10px;
  margin: 0px 10px 0px 10px;
}
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-16: Styling the key</samp></p>
<p class="TX">The font size for the <span class="SANS_TheSansMonoCd_W5Regular_11">h1</span> element here is set to <span class="SANS_TheSansMonoCd_W5Regular_11">1.5em</span>, which means 1.5 times the font size of the parent element. This ensures that this heading will be 1.5 times bigger than the rest of the text. The <span class="SANS_TheSansMonoCd_W5Regular_11">#key .color</span> ruleset is used to style the squares of color that will appear as part of the key. These will be <span class="SANS_TheSansMonoCd_W5Regular_11">div</span> elements, but <span class="SANS_TheSansMonoCd_W5Regular_11">display: inline-block</span> means that they’ll act like a cross between an inline element (like a <span class="SANS_TheSansMonoCd_W5Regular_11">span</span>), in that they won’t force a new line, and a block element (like a <span class="SANS_TheSansMonoCd_W5Regular_11">div</span>), in that they’ll be able to have fixed dimensions and margins. (Inline elements are unable to have a width and height because <span aria-label=" Page 317. " epub:type="pagebreak" id="pg_317" role="doc-pagebreak"/>they’re sized based on their content, and in this case the squares have no content.)</p>
<p class="TX">Now we can add the JavaScript that will generate the key. This will entail a new data join at the end of the <span class="SANS_TheSansMonoCd_W5Regular_11">update</span> function, to join the licenses to the elements used to render them. Update <i>script.js</i> with the changes in <a href="#Lis15-17">Listing 15-17</a>.</p>
<span id="Lis15-17"/>
<pre><code><var>--snip--</var>
<span class="gray">    .on("mouseover", (e, d) </span><span class="gray">=&gt; {</span>
<span class="gray">      let info = d3.select("#info");</span>
<span class="gray">      info.select(".repo .value a").text(d.full_name).attr("href", d.html_url);</span>
<span class="gray">      info.select(".license .value").text(getLicense(d));</span>
<span class="gray">      info.select(".stars .value").text(d.stargazers_count);</span>
<span class="gray">  });</span>

  d3.select("#key")
    .selectAll("p")
    .data(licenses)
    .join(
      enter =&gt; {
      <span aria-label="annotation1" class="CodeAnnotationHang1">❶</span> let p = enter.append("p");

<b>      </b><span aria-label="annotation2" class="CodeAnnotationHang1">❷</span> p.append("div")
          .attr("class", "color")
        <span aria-label="annotation3" class="CodeAnnotationHang1">❸</span> .style("background-color", d =&gt; colorScale(d));

      <span aria-label="annotation4" class="CodeAnnotationHang1">❹</span> p.append("span")
          .text(d =&gt; d)

        return p;
      }
    ); 
<span class="gray">}</span>

<span class="gray">function getUrl() {</span>
<var>--snip--</var>
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-17: Generating the key</samp></p>
<p class="TX">Here we’re using the <span class="SANS_TheSansMonoCd_W5Regular_11">#key</span> element as the container for our new join, and we’re joining in a bunch of <span class="SANS_TheSansMonoCd_W5Regular_11">p</span> elements to bind to each license datum. We’re using the advanced join technique, but just with an <span class="SANS_TheSansMonoCd_W5Regular_11">enter</span> function; we don’t need custom behavior for updating or exiting items. (We can’t use the regular join technique here because then the element appends would happen every time <span class="SANS_TheSansMonoCd_W5Regular_11">update</span> is called.) First we create the <span class="SANS_TheSansMonoCd_W5Regular_11">p</span> element for each new datum <span aria-label="annotation1" class="CodeAnnotationCode">❶</span>, then we append a <span class="SANS_TheSansMonoCd_W5Regular_11">div</span> element where we’ll display the square of color to the <span class="SANS_TheSansMonoCd_W5Regular_11">p</span> element <span aria-label="annotation2" class="CodeAnnotationCode">❷</span>. Adding the <span class="SANS_TheSansMonoCd_W5Regular_11">color</span> class to the <span class="SANS_TheSansMonoCd_W5Regular_11">div</span> means that it will have the styling from <a href="#Lis15-16">Listing 15-16</a>. To give it the right color, we use the <span class="SANS_TheSansMonoCd_W5Regular_11">style</span> method <span aria-label="annotation3" class="CodeAnnotationCode">❸</span>, which sets an inline CSS style on the element. We set the color to the appropriate value for the datum using <span class="SANS_TheSansMonoCd_W5Regular_11">colorScale</span>. Finally, we add a <span class="SANS_TheSansMonoCd_W5Regular_11">span</span> element to the <span class="SANS_TheSansMonoCd_W5Regular_11">p</span> element for holding the actual name of the license <span aria-label="annotation4" class="CodeAnnotationCode">❹</span>.</p>
<p class="TX"><span aria-label=" Page 318. " epub:type="pagebreak" id="pg_318" role="doc-pagebreak"/>Reload the page and you should see something like <a href="chapter15.xhtml#fig15-5">Figure 15-5</a>.</p>
<figure class="IMG"><img alt="" class="img1" id="fig15-5" src="../images/Figure_15-5.png"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 15-5: Color-coded bars with a key</samp></p></figcaption>
</figure>
<p class="TX">Our visualization now has a full key showing the license that each color maps to, making the colors much more meaningful.</p>
</section>
<section aria-labelledby="sec13" epub:type="division">
<h4 class="H2" id="sec13"><span id="h2-104"/><samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">Labeling the Left Axis</samp></h4>
<p class="TNI1">It’s implied that our graph’s left axis shows the number of stars each repository has, but that isn’t explicitly stated in the chart. To fix this, we’ll add a <span class="SANS_TheSansMonoCd_W5Regular_11">text</span> element to label the left axis. The code for this is in <a href="#Lis15-18">Listing 15-18</a>. Add this code right before the <span class="SANS_TheSansMonoCd_W5Regular_11">getLicense</span> function.</p>
<span id="Lis15-18"/>
<pre><code><var>--snip--</var>
<span class="gray">// Left axis container</span>
<span class="gray">let leftContainer = svg</span>
<span class="gray">  .append("g")</span>
<span class="gray">  .attr("id", "left")</span>
<span class="gray">  .attr("transform", `translate(${margin.left}, 0)`);</span>

let chartHeight = (height - margin.bottom) - margin.top;
let midPoint = margin.top + chartHeight / 2;

svg
  .append("text")
  .text("Stars")
  .style("font-size", "14px")
<span aria-label="annotation1" class="CodeAnnotationCode">❶</span> .attr("text-anchor", "middle")
<span aria-label="annotation2" class="CodeAnnotationCode">❷</span> .attr("transform", `translate(12, ${midPoint}) rotate(270)`);

<span class="gray">function getLicense(d) {</span>
<var>--snip--</var>
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-18: Adding a left axis label</samp></p>
<p class="TX"><span aria-label=" Page 319. " epub:type="pagebreak" id="pg_319" role="doc-pagebreak"/>First, we need to calculate where to draw the label. Its vertical position should be in the middle of the chart. We calculate the height of the chart based on the total height and the two margins, then calculate the midpoint based on adding the top margin and half the height of the chart.</p>
<p class="TX">Next, we append a <span class="SANS_TheSansMonoCd_W5Regular_11">text</span> element with the word <i>Stars</i> to the <span class="SANS_TheSansMonoCd_W5Regular_11">svg</span> element. We set the font earlier in <i>style.css</i> by applying a <span class="SANS_TheSansMonoCd_W5Regular_11">font-family</span> to the <span class="SANS_TheSansMonoCd_W5Regular_11">body</span> element. Setting the <span class="SANS_TheSansMonoCd_W5Regular_11">text-anchor</span> attribute to <span class="SANS_TheSansMonoCd_W5Regular_11">middle</span> <span aria-label="annotation1" class="CodeAnnotationCode">❶</span> causes the text to be centered around its calculated position. We also specify two transformations <span aria-label="annotation2" class="CodeAnnotationCode">❷</span>: a <span class="SANS_TheSansMonoCd_W5Regular_11">translate</span> followed by a <span class="SANS_TheSansMonoCd_W5Regular_11">rotate</span>. The <span class="SANS_TheSansMonoCd_W5Regular_11">translate</span> moves the center of the label to the correct position, and the <span class="SANS_TheSansMonoCd_W5Regular_11">rotate</span> turns it 90 degrees counterclockwise (or 270 degrees clockwise).</p>
</section>
</section>
<section aria-labelledby="sec14" epub:type="division">
<h3 class="H1" id="sec14"><span id="h1-93"/><samp class="SANS_Futura_Std_Bold_B_11">Adding Interactivity</samp></h3>
<p class="TNI1">Our visualization is already somewhat interactive in the sense that hovering over a bar shows details about that repository in the sidebar. It would be fun to add another interactive element that allows the user to filter the data. For example, now that we have a key listing the different license types, we could use it to selectively show or hide repositories with those licenses. We’ll implement this interactive feature now, while also adding animation to smooth out the changes to the graph.</p>
<section aria-labelledby="sec15" epub:type="division">
<h4 class="H2" id="sec15"><span id="h2-105"/><samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">Filtering the Data by License</samp></h4>
<p class="TNI1">To let the user filter the data by license type, we’re going to add a checkbox to each of the items in the key. We’ll then use those checkboxes to determine which repositories to (temporarily) exclude from the graph. This will require keeping track of the licenses we want to hide and removing any repositories that use those licenses before rendering.</p>
<p class="TX">First we’ll add the checkboxes. Change <i>script.js</i> as shown in <a href="#Lis15-19">Listing 15-19</a> to do this.</p>
<span id="Lis15-19"/>
<pre><code><var>--snip--</var>
<span class="gray">    d3.select("#key")</span>
<span class="gray">      .selectAll("p")</span>
<span class="gray">      .data(licenses)</span>
<span class="gray">      .join(</span>
<span class="gray">        enter =&gt; {</span>
<span class="gray">        let p = enter.append("p");</span>

        p.append("input")
         .attr("type", "checkbox")
         .attr("checked", true)
         .attr("title", "Include in chart");

<span class="gray">         p.append("div")</span>
<span class="gray">         .attr("class", "color")</span>
<span class="gray">         .style("background-color", d =&gt; colorScale(d));</span>
<var>--snip--</var>
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-19: Adding checkboxes</samp></p>
<p class="TX"><span aria-label=" Page 320. " epub:type="pagebreak" id="pg_320" role="doc-pagebreak"/>In HTML, a checkbox is an <span class="SANS_TheSansMonoCd_W5Regular_11">input</span> element with a <span class="SANS_TheSansMonoCd_W5Regular_11">type</span> attribute value of <span class="SANS_TheSansMonoCd_W5Regular_11">checkbox</span>. In the code, we add one of these at the start of each <span class="SANS_TheSansMonoCd_W5Regular_11">p</span> element in the key. The <span class="SANS_TheSansMonoCd_W5Regular_11">checked</span> attribute determines whether the checkbox is checked or not; we set them to be checked by default, so all the repositories will be shown when the visualization first loads. The <span class="SANS_TheSansMonoCd_W5Regular_11">title</span> attribute gives a tooltip with helper text if you hover over the element.</p>
<p class="TX">Next, we need to create a mechanism for keeping track of which licenses should be hidden. The code for this is in <a href="#Lis15-20">Listing 15-20</a>.</p>
<span id="Lis15-20"/>
<pre><code><var>--snip--</var>
<span class="gray">function getLicense(d) {</span>
<span class="gray">  let license = d.license?.name;</span>

<span class="gray">  if (!license) {</span>
<span class="gray">    return "No License";</span>
<span class="gray">  } else {</span>
<span class="gray">    return license;</span>
<span class="gray">  }</span>
<span class="gray">}</span>

<span aria-label="annotation1" class="CodeAnnotationHang">❶</span> let hiddenLicenses = new Set();

<span class="gray">function update(items) {</span>
<span class="gray">  let licenses = new Set(items.map(d =&gt; getLicense(d))); </span>

<var>--snip--</var>

<span class="gray">        p.append("span")</span>
<span class="gray">         .text(d =&gt; d)</span>

<span class="gray">        return p;</span>
<span class="gray">      }</span>
<span class="gray">    );</span>

<span aria-label="annotation2" class="CodeAnnotationCode">❷</span> d3.selectAll("#key input").on("change", (e, d) =&gt; {
    if (e.target.checked) {
    <span aria-label="annotation3" class="CodeAnnotationCode">❸</span> hiddenLicenses.delete(d);
    } else {
    <span aria-label="annotation4" class="CodeAnnotationCode">❹</span> hiddenLicenses.add(d);
    }

    console.log(hiddenLicenses);
  <span aria-label="annotation5" class="CodeAnnotationHang1">❺</span> update(items);
  });
<span class="gray">}</span>

<span class="gray">function getUrl() {</span>
<var>--snip--</var>
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-20: Keeping track of the hidden licenses</samp></p>
<p class="TX">First, we create a new empty <span class="SANS_TheSansMonoCd_W5Regular_11">Set</span> called <span class="SANS_TheSansMonoCd_W5Regular_11">hiddenLicenses</span>, just before the <span class="SANS_TheSansMonoCd_W5Regular_11">update</span> function <span aria-label="annotation1" class="CodeAnnotationCode">❶</span>. We’re using <span class="SANS_TheSansMonoCd_W5Regular_11">Set</span> here to make it easier to add or remove <span aria-label=" Page 321. " epub:type="pagebreak" id="pg_321" role="doc-pagebreak"/>licenses—with an array it’s trickier to remove a specific element. Then, after the code that renders the key, we create a <span class="SANS_TheSansMonoCd_W5Regular_11">change</span> event handler for the checkboxes <span aria-label="annotation2" class="CodeAnnotationCode">❷</span>. Whenever a checkbox changes from checked to unchecked or vice versa, this handler will run. In the handler, <span class="SANS_TheSansMonoCd_W5Regular_11">e</span> is the <span class="SANS_TheSansMonoCd_W5Regular_11">change</span> event and <span class="SANS_TheSansMonoCd_W5Regular_11">d</span> is the bound datum (even though the license is bound to the <span class="SANS_TheSansMonoCd_W5Regular_11">p</span> element, the children, like this checkbox, also inherit the datum). We use <span class="SANS_TheSansMonoCd_W5Regular_11">e.target.checked</span> to determine whether, after the change, the checkbox is checked or not. If it is, then we know the datum should be removed from the <span class="SANS_TheSansMonoCd_W5Regular_11">hiddenLicenses</span> set, using the <span class="SANS_TheSansMonoCd_W5Regular_11">delete</span> method on the set <span aria-label="annotation3" class="CodeAnnotationCode">❸</span>. Conversely, if the checkbox is now unchecked we add that datum to <span class="SANS_TheSansMonoCd_W5Regular_11">hiddenLicenses</span>, using the <span class="SANS_TheSansMonoCd_W5Regular_11">add</span> method on the set <span aria-label="annotation4" class="CodeAnnotationCode">❹</span>.</p>
<p class="TX">Finally, with the <span class="SANS_TheSansMonoCd_W5Regular_11">hiddenLicenses</span> set modified, we log the set to the console and call the <span class="SANS_TheSansMonoCd_W5Regular_11">update</span> function again <span aria-label="annotation5" class="CodeAnnotationCode">❺</span>, with the same <span class="SANS_TheSansMonoCd_W5Regular_11">items</span> it was called with originally. When you reload the page, you won’t see any new behavior because we’re not actually updating the graph yet, but if you open the console you’ll see how the <span class="SANS_TheSansMonoCd_W5Regular_11">hiddenLicenses</span> set changes as you check and uncheck the various checkboxes. The <span class="SANS_TheSansMonoCd_W5Regular_11">hiddenLicenses</span> set should always correspond to the unchecked licenses in the key.</p>
<p class="TX">Now we need to determine which repositories to show when there are hidden licenses. To do that, we’ll create a new array called <span class="SANS_TheSansMonoCd_W5Regular_11">filtered</span> at the top of the <span class="SANS_TheSansMonoCd_W5Regular_11">update</span> method. It will be a version of the <span class="SANS_TheSansMonoCd_W5Regular_11">items</span> array with the repositories with hidden licenses removed. The code for this change is in <a href="#Lis15-21">Listing 15-21</a>.</p>
<span id="Lis15-21"/>
<pre><code><var>--snip--</var>
<span class="gray">let hiddenLicenses = new Set();</span>

<span class="gray">function update(items) {</span>
  // Items with the hidden licenses removed
  let filtered = items.filter(d =&gt; !hiddenLicenses.has(getLicense(d)));

<span class="gray">  let licenses = new Set(items.map(d =&gt; getLicense(d)));</span>
<var>--snip--</var>
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-21: Determining the repositories with hidden licenses</samp></p>
<p class="TX">To filter the list of items, for each item we check to see if its license name is in the <span class="SANS_TheSansMonoCd_W5Regular_11">hiddenLicenses</span> set, using the set’s <span class="SANS_TheSansMonoCd_W5Regular_11">has</span> method. If the name isn’t included the set, then it will be in the <span class="SANS_TheSansMonoCd_W5Regular_11">filtered</span> list. Otherwise, it’s filtered out.</p>
<p class="TX">Finally, we need to switch to using the <span class="SANS_TheSansMonoCd_W5Regular_11">filtered</span> array rather than the <span class="SANS_TheSansMonoCd_W5Regular_11">items</span> array for rendering. The new graph will be rendering only the filtered data, so we need to change the scales and the bar drawing code to work with <span class="SANS_TheSansMonoCd_W5Regular_11">filtered</span>. On the other hand, we shouldn’t filter the <span class="SANS_TheSansMonoCd_W5Regular_11">licenses</span> set because it’s needed to maintain a consistent color scheme and to render the key, regardless of whether certain licenses are currently hidden in the bar chart. <a href="#Lis15-22">Listing 15-22</a> shows all the places in the <span class="SANS_TheSansMonoCd_W5Regular_11">update</span> function that need to be changed to use <span class="SANS_TheSansMonoCd_W5Regular_11">filtered</span> instead of <span class="SANS_TheSansMonoCd_W5Regular_11">items</span>.</p>
<span id="Lis15-22"/>
<pre><code><span aria-label=" Page 322. " epub:type="pagebreak" id="pg_322" role="doc-pagebreak"/><var>--snip--</var>
<span class="gray">  let xScale = d3.scaleBand()</span>
  <span aria-label="annotation1" class="CodeAnnotationHang1">❶</span> .domain(filtered.map(d =&gt; d.full_name))
<span class="gray">    .range([margin.left, width - margin.right])</span>
<span class="gray">    .padding(0.3);</span>

<span class="gray">  let yScale = d3.scaleLinear()</span>
  <span aria-label="annotation2" class="CodeAnnotationHang1">❷</span> .domain([0, d3.max(filtered, d =&gt; d.stargazers_count)])
<span class="gray">    .range([height - margin.bottom, margin.top])</span>
<span class="gray">    .nice();</span>

<var>--snip--</var>

<span class="gray">  svg</span>
<span class="gray">    .selectAll("rect")</span>
  <span aria-label="annotation3" class="CodeAnnotationHang1">❸</span> .data(filtered, d =&gt; d.full_name)
<span class="gray">    .join("rect")</span>
<span class="gray">    .attr("x", d =&gt; xScale(d.full_name))</span>
<span class="gray">    .attr("y", d =&gt; yScale(d.stargazers_count))</span>
<var>--snip--</var>
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-22: Replacing items with filtered</samp> <samp class="SANS_Futura_Std_Book_Oblique_I_11">for rendering the bar chart</samp></p>
<p class="TX">We update the code for creating the bottom <span aria-label="annotation1" class="CodeAnnotationCode">❶</span> and left axis <span aria-label="annotation2" class="CodeAnnotationCode">❷</span> scales, as well as the code for drawing the bars <span aria-label="annotation3" class="CodeAnnotationCode">❸</span>, changing <span class="SANS_TheSansMonoCd_W5Regular_11">items</span> to <span class="SANS_TheSansMonoCd_W5Regular_11">filtered</span> in each case. Refresh the page and deselect some of the licenses in the key. You should now see the corresponding bars disappear from the bar chart. The changes are rendered because, as you saw in <a href="#Lis15-20">Listing 15-20</a>, we’re calling <span class="SANS_TheSansMonoCd_W5Regular_11">update</span> from the <span class="SANS_TheSansMonoCd_W5Regular_11">change</span> event handler for the checkboxes.</p>
</section>
<section aria-labelledby="sec16" epub:type="division">
<h4 class="H2" id="sec16"><span id="h2-106"/><samp class="SANS_Futura_Std_Bold_Condensed_Oblique_BI_11">Animating the Changes</samp></h4>
<p class="TNI1">For the icing on the cake, let’s add some animations. These will make it easier to see changes to the bars as licenses are shown or hidden, and also just make the visualization look cooler. We’re going to animate two parts of the graph: the left axis and the bars. To do this, make the changes shown in <a href="#Lis15-23">Listing 15-23</a>.</p>
<span id="Lis15-23"/>
<pre><code><var>--snip--</var>
<span class="gray">  let leftAxis = d3</span>
<span class="gray">    .axisLeft(yScale)</span>
<span class="gray">    .tickFormat(d3.format("~s"));</span>

<span class="gray">  bottomContainer.call(bottomAxis);</span>

  leftContainer
  <span aria-label="annotation1" class="CodeAnnotationHang1">❶</span> .transition()
    .call(leftAxis);

<span class="gray">  svg</span>
<span class="gray">    .selectAll("rect")</span>
<span class="gray">    .data(filtered, d =&gt; d.full_name)</span>
<span aria-label=" Page 323. " epub:type="pagebreak" id="pg_323" role="doc-pagebreak"/>    .join(
      enter =&gt; enter
        .append("rect")
        .attr("x", d =&gt; xScale(d.full_name))
        .attr("y", d =&gt; yScale(d.stargazers_count))
        .attr("fill", d =&gt; colorScale(getLicense(d)))
        .attr("width", xScale.bandwidth())
        .attr("height", d =&gt; yScale(0) - yScale(d.stargazers_count))
      <span aria-label="annotation2" class="CodeAnnotationHang1">❷</span> .style("opacity", 0)
        .transition()
      <span aria-label="annotation3" class="CodeAnnotationHang1">❸</span> .style("opacity", 1),
      update =&gt; update
        .transition()
      <span aria-label="annotation4" class="CodeAnnotationHang1">❹</span> .attr("x", d =&gt; xScale(d.full_name))
        .attr("y", d =&gt; yScale(d.stargazers_count))
        .attr("width", xScale.bandwidth())
        .attr("height", d =&gt; yScale(0) - yScale(d.stargazers_count)),
      exit =&gt; exit
        .transition()
      <span aria-label="annotation5" class="CodeAnnotationHang1">❺</span> .style("opacity", 0)
      <span aria-label="annotation6" class="CodeAnnotationHang1">❻</span> .remove()
    )
<span class="gray">    .on("mouseover", (e, d) =&gt; {</span>
<span class="gray">      let info = d3.select("#info");</span>
<span class="gray">      info.select(".repo .value a").text(d.full_name).attr("href", d.html_url);</span>
<span class="gray">      info.select(".license .value").text(getLicense(d));</span>
<span class="gray">      info.select(".stars .value").text(d.stargazers_count);</span>
<span class="gray">    });</span>
<var>--snip--</var>
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-23: Adding animations</samp></p>
<p class="TX">Animating the left axis is straightforward: we just call <span class="SANS_TheSansMonoCd_W5Regular_11">transition</span> on the axis’s container before the axis is drawn to it <span aria-label="annotation1" class="CodeAnnotationCode">❶</span>, and the left axis will transition anytime the scale changes (which will happen only if the biggest bar is hidden or unhidden, which changes the upper bound of the domain).</p>
<p class="TX">To animate the bars, we follow the standard practice of switching to the advanced join technique and adding transitions for entering, updating, and exiting elements. Entering elements start out with all their attributes set and an opacity of 0 (meaning that they are 100 percent transparent) <span aria-label="annotation2" class="CodeAnnotationCode">❷</span>. We then call <span class="SANS_TheSansMonoCd_W5Regular_11">transition</span> and animate up to 100 percent opaque <span aria-label="annotation3" class="CodeAnnotationCode">❸</span>, which has the effect of fading in entering elements. Updating elements remain the same color and opacity, but their position and dimensions can change, so we animate all of these <span aria-label="annotation4" class="CodeAnnotationCode">❹</span>. This has the effect of stretching and sliding these updated elements to their new size and position. Exiting elements do the opposite of entering elements and fade out, which we achieve by transitioning their opacity back to 0 <span aria-label="annotation5" class="CodeAnnotationCode">❺</span>. Remember that we also have to call <span class="SANS_TheSansMonoCd_W5Regular_11">remove</span> on any exiting elements after the transition is complete <span aria-label="annotation6" class="CodeAnnotationCode">❻</span>.</p>
<p class="TX"><span aria-label=" Page 324. " epub:type="pagebreak" id="pg_324" role="doc-pagebreak"/>Reload the page and try hiding and unhiding various licenses. The first license in the key should always correspond to the repository with the most stars (because the repositories are ordered that way and we extract the license names from the repositories in order), so if you want to see the left axis resize, you’ll need to turn off that license. You should see the repositories with that license fade out and the other repositories expand to fill the space and the recomputed scale. <a href="chapter15.xhtml#fig15-6">Figure 15-6</a>(a) shows the chart with all the licenses shown, and <a href="chapter15.xhtml#fig15-6">Figure 15-6</a>(b) shows the chart with the MIT license (at the time of writing, the most popular license in the dataset) hidden.</p>
<figure class="IMG"><img alt="" class="img1" id="fig15-6" src="../images/Figure_15-6.png"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 15-6: The final chart showing all licenses (a) and with the top license hidden (b)</samp></p></figcaption>
</figure>
<p class="TX">Try showing and hiding different licenses to get a feel for how the animations work. Is there anything you would change about them? How else might you make the visualization more interesting?</p>
</section>
<section aria-labelledby="sec17" epub:type="division">
<aside aria-label="box-49" class="box" id="sec17">
<h4 class="BH" id="box-49"><span aria-label=" Page 325. " epub:type="pagebreak" id="pg_325" role="doc-pagebreak"/><samp class="SANS_Dogma_OT_Bold_B_11">TRY IT YOURSELF</samp></h4>
<p class="BoxListNumber"><samp class="SANS_Futura_Std_Bold_B_11">15-4.</samp><samp class="SANS_Futura_Std_Book_11">  Add an</samp> <span class="SANS_TheSansMonoCd_W5Regular_11">input</span> <samp class="SANS_Futura_Std_Book_11">element that lets you change the page of search results, so you can see the 20 repositories on the next page, or any other page. Hint: you’ll need to listen for</samp> <span class="SANS_TheSansMonoCd_W5Regular_11">change</span> <samp class="SANS_Futura_Std_Book_11">events on the</samp> <span class="SANS_TheSansMonoCd_W5Regular_11">input</span> <samp class="SANS_Futura_Std_Book_11">element and use the new value to set the</samp> <span class="SANS_TheSansMonoCd_W5Regular_11">page</span> <samp class="SANS_Futura_Std_Book_11">parameter in the request to the GitHub Search API.</samp></p>
<p class="BoxListNumber"><samp class="SANS_Futura_Std_Bold_B_11">15-5.</samp><samp class="SANS_Futura_Std_Book_11">  Add a</samp> <span class="SANS_TheSansMonoCd_W5Regular_11">button</span> <samp class="SANS_Futura_Std_Book_11">element called “Load More” that loads the next page of search results into the chart, combining them with the existing data (so you’d have 40 bars after one click, and 60 after two clicks).</samp></p>
<p class="BoxListNumber"><samp class="SANS_Futura_Std_Bold_B_11">15-6.</samp><samp class="SANS_Futura_Std_Book_11">  Instead of color-coding based on the license, try using a different dimension, such as</samp> <span class="SANS_TheSansMonoCd_W5Regular_11">d.owner.login</span> <samp class="SANS_Futura_Std_Book_11">(which gives the name of the account that owns the repository).</samp></p>
</aside>
</section>
</section>
<section aria-labelledby="sec18" epub:type="division">
<h3 class="H1" id="sec18"><span id="h1-94"/><samp class="SANS_Futura_Std_Bold_B_11">The Complete Code</samp></h3>
<p class="TNI1">If you’d like to see what the full <i>script.js</i> file should look like, you can find the complete code in <a href="#Lis15-24">Listing 15-24</a>.</p>
<span id="Lis15-24"/>
<pre><code>const width = 600;
const height = 400;

let svg = d3
  .select("body")
  .insert("svg", "#sidebar")
  .attr("width", width)
  .attr("height", height);

let margin = {top: 20, right: 10, bottom: 20, left: 50};

// Bottom axis container
let bottomContainer = svg
  .append("g")
  .attr("id", "bottom")
  .attr("transform", `translate(0, ${height - margin.bottom})`);

// Left axis container
let leftContainer = svg
  .append("g")
  .attr("id", "left")
  .attr("transform", `translate(${margin.left}, 0)`);

let chartHeight = (height - margin.bottom) - margin.top;
let midPoint = margin.top + chartHeight / 2;

svg
  .append("text")
<span aria-label=" Page 326. " epub:type="pagebreak" id="pg_326" role="doc-pagebreak"/>  .text("Stars")
  .style("font-size", "14px")
  .attr("text-anchor", "middle")
  .attr("transform", `translate(12, ${midPoint}) rotate(270)`);

function getLicense(d) {
  let license = d.license?.name;

  if (!license) {
<b>    </b>return "No License";
  } else {
<b>    </b>return license;
  }
}

let hiddenLicenses = new Set();

function update(items) {
  // Items with the hidden licenses removed
  let filtered = items.filter(d =&gt; !hiddenLicenses.has(getLicense(d)));

  let licenses = new Set(items.map(d =&gt; getLicense(d)));
  let colorScale = d3.scaleOrdinal()
<b>    </b>.domain(licenses)
<b>    </b>.range(d3.schemeCategory10);

  let xScale = d3.scaleBand()
<b>    </b>.domain(filtered.map(d =&gt; d.full_name))
<b>    </b>.range([margin.left, width - margin.right])
<b>    </b>.padding(0.3);

  let yScale = d3.scaleLinear()
<b>    </b>.domain([0, d3.max(filtered, d =&gt; d.stargazers_count)])
<b>    </b>.range([height - margin.bottom, margin.top])
<b>    </b>.nice();

  let bottomAxis = d3
<b>    </b>.axisBottom(xScale)
<b>    </b>.tickValues([]);

  let leftAxis = d3
<b>    </b>.axisLeft(yScale)
<b>    </b>.tickFormat(d3.format("~s"));

  bottomContainer.call(bottomAxis);

  leftContainer
<b>    </b>.transition()
<b>    </b>.call(leftAxis);

  svg
<b>    </b>.selectAll("rect")
<b>    </b>.data(filtered, d =&gt; d.full_name)
<b>    </b>.join(
<span aria-label=" Page 327. " epub:type="pagebreak" id="pg_327" role="doc-pagebreak"/><b>      </b>enter =&gt; enter
<b>        </b>.append("rect")
<b>        </b>.attr("x", d =&gt; xScale(d.full_name))
<b>        </b>.attr("y", d =&gt; yScale(d.stargazers_count))
<b>        </b>.attr("fill", d =&gt; colorScale(getLicense(d)))
<b>        </b>.attr("width", xScale.bandwidth())
<b>        </b>.attr("height", d =&gt; yScale(0) - yScale(d.stargazers_count))
        .style("opacity", 0)
        .transition()
        .style("opacity", 1),
<b>      </b>update =&gt; update
        .transition()
        .attr("x", d =&gt; xScale(d.full_name))
        .attr("y", d =&gt; yScale(d.stargazers_count))
        .attr("width", xScale.bandwidth())
        .attr("height", d =&gt; yScale(0) - yScale(d.stargazers_count)),
<b>      </b>exit =&gt; exit
        .transition()
        .style("opacity", 0)
        .remove()
<b>    </b>)
<b>    </b>.on("mouseover", (e, d) =&gt; {
<b>      </b>let info = d3.select("#info");
<b>      </b>info.select(".repo .value a").text(d.full_name).attr("href", d.html_url);
<b>      </b>info.select(".license .value").text(getLicense(d));
<b>      </b>info.select(".stars .value").text(d.stargazers_count);
<b>    </b>});

  d3.select("#key")
<b>    </b>.selectAll("p")
<b>    </b>.data(licenses)
<b>    </b>.join(
<b>      </b>enter =&gt; {
        let p = enter.append("p");

<b>        </b>p.append("input")
<b>          </b>.attr("type", "checkbox")
<b>          </b>.attr("checked", true)
<b>          </b>.attr("title", "Include in chart");

<b>        </b>p.append("div")
<b>          </b>.attr("class", "color")
<b>        </b>  .style("background-color", d =&gt; colorScale(d));

<b>        </b>p.append("span")
<b>          </b>.text(d =&gt; d)

<b>        </b>return p;
<b>      </b>}
<b>    </b>);

  d3.selectAll("#key input").on("change", (e, d) =&gt; {
<b>    </b>if (e.target.checked) {
<b>      </b>hiddenLicenses.delete(d);
<span aria-label=" Page 328. " epub:type="pagebreak" id="pg_328" role="doc-pagebreak"/><b>    </b>} else {
<b>      </b>hiddenLicenses.add(d);
<b>    </b>}

<b>    </b>console.log(hiddenLicenses);
<b>    </b>update(items);
  });
}

function getUrl() {
  let baseUrl = "https://api.github.com/search/repositories";

  let params = {
<b>    </b>q: "language:javascript stars:&gt;10000",
<b>    </b>per_page: 20,
<b>    </b>sort: "stars"
  };

  let queryString = Object.entries(params).map(pair =&gt; {
<b>    </b>return `${pair[0]}=${encodeURIComponent(pair[1])}`;
  }).join("&amp;");

  return `${baseUrl}?${queryString}`;
}

let url = getUrl();
let backupUrl = "https://skilldrick-jscc.s3.us-west-2.amazonaws.com/gh-js-repos.json";

// Replace url with backupUrl in following line if needed
d3.json(url).then(data =&gt; {
  update(data.items);
});
</code></pre>
<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 15-24: The full</samp> <samp class="SANS_Futura_Std_Book_11">script.js</samp> <samp class="SANS_Futura_Std_Book_Oblique_I_11">file for this project</samp></p>
</section>
<section aria-labelledby="sec19" epub:type="division">
<h3 class="H1" id="sec19"><span id="h1-95"/><samp class="SANS_Futura_Std_Bold_B_11">Summary</samp></h3>
<p class="TNI1">In this final project, you created a pretty complex interactive chart using live data fetched from the GitHub Search API. You now have the tools you need to create your own custom charts using D3. We’ve touched on only a small part of what this library offers, however; it has support for many different kinds of visualizations, like trees, cartographic maps, and other more esoteric layouts. Each of these visualization types has the same basis in SVG, data binding, joins, scales, and transitions, so what you’ve learned here will set you up well if you decide to explore data visualization with JavaScript further. The D3 website, <a href="https://d3js.org"><i>https://<wbr/>d3js<wbr/>.org</i></a>, is an excellent starting point for further research.</p>
</section>
</section>
</body>
</html>