- en: '**4**'
  id: totrans-0
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: '**4**'
- en: '**DIAGNOSTICS AND LOGGING**'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: '**诊断与日志记录**'
- en: '![image](graphics/common-01.jpg)'
  id: totrans-2
  prefs: []
  type: TYPE_IMG
  zh: '![image](graphics/common-01.jpg)'
- en: The OBD-II connector is primarily used by mechanics to quickly analyze and troubleshoot
    problems with a vehicle. (See “[The OBD-II Connector](ch02.html#ch02lev2sec1)”
    on [page 17](ch02.html#page_17) for help locating the OBD connector.) When a vehicle
    experiences a fault, it saves information related to that fault and triggers the
    engine warning light, also known as the *malfunction indicator lamp (MIL).* These
    routine diagnostic checks are handled by the vehicle’s primary ECU, the powertrain
    control module (PCM), which can be made up of several ECUs (but to keep the discussion
    simple, we’ll refer to it only as the PCM).
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: OBD-II连接器主要供技师快速分析和排查车辆故障。（请参见[《OBD-II连接器》](ch02.html#ch02lev2sec1)第[17页](ch02.html#page_17)了解如何定位OBD连接器。）当车辆出现故障时，它会保存与该故障相关的信息，并触发发动机警告灯，也称为*故障指示灯（MIL）*。这些常规的诊断检查由车辆的主ECU（电子控制单元）——动力总成控制模块（PCM）处理，PCM可能由多个ECU组成（但为了简化讨论，我们将其称为PCM）。
- en: If you trigger faults while experimenting with the bus on a vehicle, you’ll
    need to able to read and write to the PCM in order to clear them. In this chapter,
    we’ll learn how to fetch and clear diagnostic codes as well as query the diagnostic
    services of the ECU. We’ll also learn how to access a vehicle’s crash data recordings
    and how to brute-force hidden diagnostic codes.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 如果在实验过程中触发故障，需要能够读写PCM才能清除故障代码。在本章中，我们将学习如何获取和清除诊断代码，以及如何查询ECU的诊断服务。我们还将学习如何访问车辆的碰撞数据记录以及如何强行破解隐藏的诊断代码。
- en: '**Diagnostic Trouble Codes**'
  id: totrans-5
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '**诊断故障代码**'
- en: The PCM stores fault codes as diagnostic trouble codes (DTCs). DTCs are stored
    in different places. For instance, memory-based DTCs are stored in the PCM’s RAM,
    which means they’re erased when power from the battery is lost (as is true for
    all DTCs stored in RAM). More serious DTCs are stored in areas that will survive
    a power failure.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: PCM将故障代码存储为诊断故障代码（DTC）。DTC存储在不同的地方。例如，基于内存的DTC存储在PCM的RAM中，这意味着当电池断电时，它们会被清除（就像所有存储在RAM中的DTC一样）。更严重的DTC则存储在能够在断电时保存的区域。
- en: Faults are usually classified as either hard or soft. Soft faults map to intermittent
    issues, whereas hard faults are ones that won’t go away without some sort of intervention.
    Often to determine whether a fault is hard or soft, a mechanic clears the DTCs
    and drives the vehicle to see whether the fault reappears. If it reappears, the
    fault is a hard fault. A soft fault could be due to a problem such as a loose
    gas cap.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 故障通常分为硬故障和软故障。软故障通常是间歇性问题，而硬故障则是无法自行消失，需要某种干预的故障。为了确定故障是硬故障还是软故障，技师通常会清除DTCs（诊断故障代码），然后驾驶车辆看故障是否会重新出现。如果故障重新出现，则是硬故障。软故障可能是由于某些问题引起的，比如油箱盖松动。
- en: Not all faults trigger the MIL light right away. Specifically, class A faults,
    which signal a gross emissions failure, light the MIL right away, while class
    B faults, which don’t affect the vehicle’s emissions system, are stored the first
    time they’re triggered as a *pending* fault. The PCM waits to record several of
    the same faults before triggering the MIL. Class C faults often won’t turn on
    the MIL light but instead trigger a “service engine soon” type of message. Class
    D faults don’t trigger the MIL light at all.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 并非所有故障都会立即触发MIL灯。具体来说，A类故障（表示严重排放故障）会立即点亮MIL灯，而B类故障（不影响车辆排放系统的故障）在首次触发时会作为*待处理*故障存储。PCM会等待记录多个相同的故障后才会触发MIL灯。C类故障通常不会点亮MIL灯，而是触发“发动机即将维修”类型的信息。D类故障则根本不会触发MIL灯。
- en: 'When storing the DTCs, the PCM snapshots all the relevant engine components
    in what is known as *freeze frame data,* which typically includes information
    such as the following:'
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 当存储DTC时，PCM会拍摄所有相关的发动机组件的快照，这些快照被称为*冻结帧数据*，通常包括如下信息：
- en: • DTC involved
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: • 涉及的DTC
- en: • Engine load
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: • 发动机负荷
- en: • Engine revolutions per minute (RPM)
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: • 发动机转速（RPM）
- en: • Engine temperature
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: • 发动机温度
- en: • Fuel trim
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: • 燃油修正
- en: • Manifold air pressure/mass air flow (MAP/MAF) values
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: • 进气歧管压力/质量空气流量（MAP/MAF）值
- en: • Operating mode (open/close loop)
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: • 操作模式（开环/闭环）
- en: • Throttle position
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: • 油门位置
- en: • Vehicle speed
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: • 车速
- en: Some systems store only one freeze frame, usually for the first DTC triggered
    or the highest-priority DTC, while others record multiple ones.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 一些系统只存储一个冻结帧，通常是为首次触发的DTC或优先级最高的DTC，而其他系统则会记录多个冻结帧。
- en: In an ideal world, these snapshots would happen as soon the DTC occurs, but
    the freeze frames are typically recorded about five seconds after a DTC is triggered.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
- en: '***DTC Format***'
  id: totrans-21
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: A DTC is a five-character alphanumeric code. For example, you’ll see codes like
    P0477 (exhaust pressure control valve low) and U0151 (lost communication with
    restraint control module). The code in the first byte position represents the
    basic function of the component that set the code, as shown in [Table 4-1](ch04.html#ch4tab1).
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
- en: '**Table 4-1:** Diagnostic Code Layouts'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
- en: '| **Byte position** | **Description** |'
  id: totrans-24
  prefs: []
  type: TYPE_TB
- en: '| --- | --- |'
  id: totrans-25
  prefs: []
  type: TYPE_TB
- en: '| 1 | P (0x0) = powertrain, B (0x1) = body, C (0x2) = chassis, U (0x3) = network
    |'
  id: totrans-26
  prefs: []
  type: TYPE_TB
- en: '| 2 | 0,2,3 (SAE standard) 1,3 (manufacturer specific) |'
  id: totrans-27
  prefs: []
  type: TYPE_TB
- en: '| 3 | Subgroup of position 1 |'
  id: totrans-28
  prefs: []
  type: TYPE_TB
- en: '| 4 | Specific fault area |'
  id: totrans-29
  prefs: []
  type: TYPE_TB
- en: '| 5 | Specific fault area |'
  id: totrans-30
  prefs: []
  type: TYPE_TB
- en: '**NOTE**'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
- en: '*When set to 3, byte 2 is both an SAE-defined standard and a manufacturer-specific
    code. Originally, 3 was used exclusively for manufacturers, but pressure is mounting
    to standardize 3 to mean a standard code instead. In modern cars, if you see a
    3 in the second position, it’s probably an SAE standard code.*'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
- en: The five characters in a DTC are represented by just two raw bytes on the network.
    [Table 4-2](ch04.html#ch4tab2) shows how to break down the 2 DTC bytes into a
    full DTC code.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
- en: '**Table 4-2:** Diagnostic Code Binary Breakdown'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
- en: '![image](graphics/f0053-01.jpg)'
  id: totrans-35
  prefs: []
  type: TYPE_IMG
- en: Except for the first two, the characters have a one-to-one relationship. Refer
    to [Table 4-1](ch04.html#ch4tab1) to see how the first two bits are assigned.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
- en: 'You should be able to look up the meaning of any codes that follow the SAE
    standard online. Here are some example ranges for common powertrain DTCs:'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
- en: '• P0001–P0099: Fuel and air metering, auxiliary emissions controls'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
- en: '• P0100–P0199: Fuel and air metering'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
- en: '• P0200–P0299: Fuel and air metering (injector circuit)'
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
- en: '• P0300–P0399: Ignition system or misfire'
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
- en: '• P0400–P0499: Auxiliary emissions controls'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
- en: '• P0500–P0599: Vehicle speed controls, and idle control systems'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
- en: '• P0600–P0699: Computer output circuit'
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
- en: '• P0700–P0799: Transmission'
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
- en: To learn the meaning of a particular code, pick up a repair book in the Chilton
    series at your local auto shop. There, you’ll find a list of all OBD-II diagnostic
    codes for your vehicle.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
- en: '***Reading DTCs with Scan Tools***'
  id: totrans-47
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: Mechanics check fault codes with scan tools. Scan tools are nice to have but
    not necessary for vehicle hacking. You should be able to pick one up at any vehicle
    supply store or on the Internet for anywhere between $100 and $3,000.
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
- en: For the cheapest possible solution, you can get an ELM327 device on eBay for
    around $10\. These are typically dongles that need additional software, such as
    a mobile app, in order for them to function fully as scan tools. The software
    is usually free or under $5\. A basic scan tool should be able to probe the vehicle’s
    fault system and report on the common, nonmanufacturer-specific DTC codes. Higher-end
    ones should have manufacturer-specific databases that allow you to perform much
    more detailed testing.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
- en: '***Erasing DTCs***'
  id: totrans-50
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: 'DTCs usually erase themselves once the fault no longer appears during conditions
    similar to when the fault was first found. For this purpose, *similar* is defined
    as the following:'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
- en: • Engine speed within 375 RPM of the flagged condition
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
- en: • Engine load within 10 percent of the flagged condition
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
- en: • Engine temp is similar
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
- en: 'Under normal conditions, once the PCM no longer sees a fault after three checks,
    the MIL light turns off and the DTCs get erased. There are other ways to clear
    these codes: you can clear soft DTCs with a scan tool (discussed in the previous
    section) or by disconnecting the vehicle’s battery. Permanent or hard DTCs, however,
    are stored in NVRAM and are cleared only when the PCM no longer sees the fault
    condition. The reason for this is simple enough: to prevent mechanics from manually
    turning off the MIL and clearing the DTCs when the problem still exists. Permanent
    DTCs give mechanics a history of faults so that they’re in a better position to
    repair them.'
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
- en: '**Unified Diagnostic Services**'
  id: totrans-56
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The *Unified Diagnostic Services (UDS)* is designed to provide a uniform way
    to show mechanics what’s going on with a vehicle without their having to pay huge
    license fees for the auto manufacturer’s proprietary CAN bus packet layouts.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
- en: 'Unfortunately, although UDS was designed to make vehicle information accessible
    to even the mom-and-pop mechanic, the reality is a bit different: CAN packets
    are sent the same way but the contents vary for each make, model, and even year.'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
- en: Auto manufacturers sell dealers licenses to the details of the packet contents.
    In practice, UDS just works as a gateway to make some but not all of this vehicle
    information available. The UDS system does *not* affect how a vehicle operates;
    it’s basically just a read-only view into what’s going on. However, it’s possible
    to use UDS to perform more advanced operations, such as diagnostic tests or firmware
    modifications (tests that are only a feature of higher-end scan tools). Diagnostic
    tests like these send the system a request to perform an action, and that request
    generates signals, such as other CAN packets, that are used to perform the work.
    For instance, a diagnostic tool may make a request to unlock the car doors, which
    results in the component sending a separate CAN signal that actually does the
    work of unlocking the doors.
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
- en: '***Sending Data with ISO-TP and CAN***'
  id: totrans-60
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: Because CAN frames are limited to 8 bytes of data, UDS uses the ISO-TP protocol
    to send larger outputs over the CAN bus. You can still use regular CAN to read
    or send data, but the response won’t be complete because ISO-TP allows chaining
    of multiple CAN packets.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
- en: 'To test ISO-TP, connect to a CAN network that has diagnostic-capable modules
    such as an ECU. Then send a packet designed for ISO-TP over normal CAN using SocketCAN’s
    `cansend` application:'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  id: totrans-63
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: In this listing, `7df` is the OBD diagnostic code, `02` is the size of the packet,
    `01` is the mode (show current data; see [Appendix B](app02.html#app02) for a
    list of common modes and PIDs), and `0d` is the service (a vehicle speed of 0
    because the vehicle was stationary). The response adds 0x8 to the ID (`7e8`);
    the next byte is the size of the response. Responses then add 0x40 to the type
    of request, which is 0x41 in this case. Then, the service is repeated and followed
    by the data for the service. ISO-TP dictates how to respond to a CAN packet.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
- en: Normal CAN packets use a “fire-and-forget” structure, meaning they simply send
    data and don’t wait for a return packet. ISO-TP specifies a method to receive
    response data. Because this response data can’t be sent back using the same arbitration
    ID, the receiver returns the response by adding 0x8 to the ID and noting that
    the response is a positive one by adding 0x40 to the request. (If the response
    fails, you should see a 0x7F instead of the positive + 0x40 response.)
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
- en: '[Table 4-3](ch04.html#ch4tab3) lists the most common error responses.'
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
- en: '**Table 4-3:** Common UDS Error Responses'
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
- en: '| **Hex (4th byte)** | **Abbreviation** | **Description** |'
  id: totrans-68
  prefs: []
  type: TYPE_TB
- en: '| --- | --- | --- |'
  id: totrans-69
  prefs: []
  type: TYPE_TB
- en: '| 10 | GR | General reject |'
  id: totrans-70
  prefs: []
  type: TYPE_TB
- en: '| 11 | SNS | Service not supported |'
  id: totrans-71
  prefs: []
  type: TYPE_TB
- en: '| 12 | SFNS | Subfunction not supported |'
  id: totrans-72
  prefs: []
  type: TYPE_TB
- en: '| 13 | IMLOIF | Incorrect message length or invalid format |'
  id: totrans-73
  prefs: []
  type: TYPE_TB
- en: '|  14  | RTL | Response too long |'
  id: totrans-74
  prefs: []
  type: TYPE_TB
- en: '| 21 | BRR | Busy repeat request |'
  id: totrans-75
  prefs: []
  type: TYPE_TB
- en: '| 22 | CNC | Condition not correct |'
  id: totrans-76
  prefs: []
  type: TYPE_TB
- en: '| 24 | RSE | Request sequence error |'
  id: totrans-77
  prefs: []
  type: TYPE_TB
- en: '| 25 | NRFSC | No response from subnet component |'
  id: totrans-78
  prefs: []
  type: TYPE_TB
- en: '| 26 | FPEORA | Failure prevents execution of requested action |'
  id: totrans-79
  prefs: []
  type: TYPE_TB
- en: '| 31 | ROOR | Request out of range |'
  id: totrans-80
  prefs: []
  type: TYPE_TB
- en: '| 33 | SAD | Security access denied |'
  id: totrans-81
  prefs: []
  type: TYPE_TB
- en: '| 35 | IK | Invalid key |'
  id: totrans-82
  prefs: []
  type: TYPE_TB
- en: '| 36 | ENOA | Exceeded number of attempts |'
  id: totrans-83
  prefs: []
  type: TYPE_TB
- en: '| 37 | RTDNE | Required time delay not expired |'
  id: totrans-84
  prefs: []
  type: TYPE_TB
- en: '| 38-4F | RBEDLSD | Reserved by extended data link security document |'
  id: totrans-85
  prefs: []
  type: TYPE_TB
- en: '| 70 | UDNA | Upload/download not accepted |'
  id: totrans-86
  prefs: []
  type: TYPE_TB
- en: '| 71 | TDS | Transfer data suspended |'
  id: totrans-87
  prefs: []
  type: TYPE_TB
- en: '| 72 | GPF | General programming failure |'
  id: totrans-88
  prefs: []
  type: TYPE_TB
- en: '| 73 | WBSC | Wrong block sequence counter |'
  id: totrans-89
  prefs: []
  type: TYPE_TB
- en: '| 78 | RCRRP | Request correctly received but response is pending |'
  id: totrans-90
  prefs: []
  type: TYPE_TB
- en: '| 7E | SFNSIAS | Subfunction not supported in active session |'
  id: totrans-91
  prefs: []
  type: TYPE_TB
- en: '| 7F | SNSIAS | Service not supported in active session |'
  id: totrans-92
  prefs: []
  type: TYPE_TB
- en: 'For example, if you use service 0x11 to reset the ECU and the ECU doesn’t support
    remote resets, you may see traffic like this:'
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  id: totrans-94
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: In this response, we can see that after 0x7e8, the next byte is 0x03, which
    represents the size of the response. The next byte, 0x7F, represents an error
    for service 0x11, the third byte. The final byte, 0x11, represents the error returned—in
    this case, service not supported (SNS).
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
- en: To send or receive something with more than the 8 bytes of data in a standard
    CAN packet, use SocketCAN’s ISO-TP tools. Run `istotpsend` in one terminal, and
    then run `isotpsniffer` (or `isotprecv`) in another terminal to see the response
    to your `istotpsend` commands. (Don’t forget to `insmod` your `can-isotp.ko` module,
    as described in [Chapter 3](ch03.html#ch03).)
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
- en: 'For example, in one terminal, set up a sniffer like this:'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  id: totrans-98
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Then, in another terminal, send the request packet via the command line:'
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  id: totrans-100
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: When using ISO-TP, you need to specify a source and destination address (ID).
    In the case of UDS, the source is 0x7df, and the destination (response) is 0x7e8\.
    (When using ISO-TP tools, the starting 0x in the addresses isn’t specified.)
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
- en: 'In this example, we’re sending a packet containing PID 0x02 with mode 0x09
    in order to request the vehicle’s VIN. The response in the sniffer should display
    the vehicle’s VIN, as shown here in the last line of output:'
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  id: totrans-103
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: The first 3 bytes make up the UDS response. 0x49 ➊ is service 0x09 + 0x40, which
    signifies a positive response for PID 0x02 ➋, the next byte. The third byte, 0x01
    ➌, indicates the number of data items that are being returned (one VIN in this
    case). The VIN returned is 1G1ZT53826F109149\. Enter this VIN into Google, and
    you should see detailed information about this vehicle, which was taken from an
    ECU pulled from a wrecked car found in a junkyard. [Table 4-4](ch04.html#ch4tab4)
    shows the information you should see.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
- en: '**Table 4-4:** VIN Information'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
- en: '| **Model** | **Year** | **Make** | **Body** | **Engine** |'
  id: totrans-106
  prefs: []
  type: TYPE_TB
- en: '| --- | --- | --- | --- | --- |'
  id: totrans-107
  prefs: []
  type: TYPE_TB
- en: '| Malibu | 2006 | Chevrolet | Sedan 4 Door | 3.5L V6 OHV 12V |'
  id: totrans-108
  prefs: []
  type: TYPE_TB
- en: If you were watching this UDS query via a normal CAN sniffer, you’d have seen
    several response packets on 0x7e8\. You could re-assemble an ISO-TP packet by
    hand or with a simple script, but the ISO-TP tools make things much easier.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
- en: '**NOTE**'
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
- en: '*If you have difficulty running the ISO-TP tools, make sure you have the proper
    kernel module compiled and installed (see “[Installing Additional Kernel Modules](ch03.html#ch03lev2sec5)”
    on [page 42](ch03.html#page_42)).*'
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
- en: '***Understanding Modes and PIDs***'
  id: totrans-112
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: The first byte of the data section in a diagnostic code is the mode. In automotive
    manuals, modes start with a $, as in $1\. The $ is used to state that the number
    is in hex. The mode $1 is the same as 0x01, $0A is the same as 0x0A, and so on.
    I’ve listed a few examples here, and there are more in [Appendix B](app02.html#app02)
    for reference.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
- en: '**0x01: Shows current data**'
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
- en: Shows data streams of a given PID. Sending a PID of 0x00 returns 4 bytes of
    bit-encoded available PIDs (0x01 through 0x20).
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
- en: '**0x02: Shows freeze frame data**'
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
- en: Has the same PID values as 0x01, except that the data returned is from the freeze
    frame state.
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
- en: '**0x03: Shows stored “confirmed” diagnostic trouble codes**'
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
- en: Matches the DTCs mentioned in “[DTC Format](ch04.html#ch04lev2sec1)” on [page
    52](ch04.html#page_52).
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
- en: '**0x04: Erases DTCs and clears diagnostic history**'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
- en: Clears the DTC and freeze frame data.
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
- en: '**0x07: Shows “pending” diagnostic codes**'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
- en: Displays codes that have shown up once but that haven’t been confirmed; status
    pending.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
- en: '**0x08: Controls operations of onboard component/system**'
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
- en: Allows a technician to activate and deactivate the system actuators manually.
    System actuators allow drive-by-wire operations and physically control different
    devices. These codes aren’t standard, so a common scan tool won’t be able to do
    much with this mode. Dealership scan tools have a lot more access to vehicle internals
    and are an interesting target for hackers to reverse engineer.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
- en: '**0x09: Requests vehicle information**'
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
- en: Several pieces of data can be pulled with mode 0x09.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
- en: '**0x0a: Permanent diagnostic codes**'
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
- en: This mode pulls DTCs that have been erased via mode 0x04\. These DTCs are cleared
    only once the PCM has verified the fault condition is no longer present (see “[Erasing
    DTCs](ch04.html#ch04lev2sec3)” on [page 54](ch04.html#page_54)).
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
- en: '***Brute-Forcing Diagnostic Modes***'
  id: totrans-130
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: Each manufacturer has its own proprietary modes and PIDs, which you can usually
    get by digging through “acquired” dealer software or by using tools or brute force.
    The easiest way to do brute force is to use an open source tool called the *CaringCaribou
    (CC)*, available at *[https://github.com/CaringCaribou/caringcaribou](https://github.com/CaringCaribou/caringcaribou).*
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
- en: CaringCaribou consists of a collection of Python modules designed to work with
    SocketCAN. One such module is a DCM module that deals specifically with discovering
    diagnostic services.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
- en: To get started with CaringCaribou, create an RC file in your home directory,
    *~/.canrc.*
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  id: totrans-134
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'Set your channel to that of your SocketCAN device. Now, to discover what diagnostics
    your vehicle supports, run the following:'
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  id: totrans-136
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'This will send the tester-present code to every arbitration ID. Once the tool
    sees a valid response (0x40+service) or an error (0x7f), it’ll print the arbitration
    ID and the reply ID. Here is an example discovery session using CaringCaribou:'
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  id: totrans-138
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'We see that there’s a diagnostic service responding to 0x0244\. Great! Next,
    we probe the different services on 0x0244:'
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  id: totrans-140
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: Notice that the output lists several duplicate services for service 0x00\. This
    is often caused by an error response for something that’s not a UDS service. For
    instance, the requests below 0x0A are legacy modes that don’t respond to the official
    UDS protocol.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
- en: '**NOTE**'
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
- en: '*As of this writing, CaringCaribou is in its early stages of development, and
    your results may vary. The current version available doesn’t account for older
    modes and parses the response incorrectly, which is why you see several services
    with ID 0x00\. For now, just ignore those services; they’re false positives. CaringCaribou’s
    discovery option stops at the first arbitration ID that responds to a diagnostic
    session control (DSC) request. Restart the scan from where it left off using the*
    `-min` *option, as follows:*'
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  id: totrans-144
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'In our example, the scan will also stop scanning a bit later at this more common
    diagnostic ID:'
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  id: totrans-146
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: '***Keeping a Vehicle in a Diagnostic State***'
  id: totrans-147
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: When doing certain types of diagnostic operations, it’s important to keep the
    vehicle in a diagnostic state because it’ll be less likely to be interrupted,
    thereby allowing you to perform actions that can take several minutes. In order
    to keep the vehicle in this state, you need to continuously send a packet to let
    the vehicle know that a diagnostic technician is present.
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
- en: 'These simple scripts will keep the car in a diagnostic state that’ll prove
    useful for flashing ROMs or brute-forcing. The tester present packet keeps the
    car in a diagnostic state. It works as a heartbeat, so you’ll need to transmit
    it every one to two seconds, as shown here:'
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  id: totrans-150
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'You can do the same things with `cangen`:'
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  id: totrans-152
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: '**NOTE**'
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
- en: '*As of this writing,* `cangen` *doesn’t always work on serial-line CAN devices.
    One possible workaround is to tell* `slcand` *to use canX style names instead
    of slcanX.*'
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
- en: Use the `ReadDataByID` command to read data by ID and to query devices for information.
    0x01 is the standard query. The enhanced version, 0x22, can return information
    not available with standard OBD tools.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
- en: Use the `SecurityAccess` command (0x27) to access protected information. This
    can be a rolling key, meaning that the password or key changes each time, but
    the important thing is that the controller responds if successful. For example,
    if you send the key 0x1, and it’s the correct access code, then you should receive
    an 0x2 in return. Some actions, such as flashing ROMs, will require you to send
    a `SecurityAccess` request. If you don’t have the algorithm to generate the necessary
    challenge response, then you’ll need to brute-force the key.
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
- en: '**Event Data Recorder Logging**'
  id: totrans-157
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'You likely know that airplanes have black boxes that record information about
    flights as well as conversations in the cockpit and over radio transmissions.
    All 2015 and newer vehicles are also required to have a type of black box, known
    as an *event data recorder (EDR)*, but EDRs record only a portion of the information
    that a black box on an airplane would. The information stored on the EDR includes
    the following (you’ll find a more complete list in SAE J1698-2):'
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
- en: • Airbag deployment
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
- en: • Brake status
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
- en: • Delta-v (longitudinal change in velocity)
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
- en: • Ignition cycles
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
- en: • Seat belt status
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
- en: • Steering angles
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
- en: • Throttle position
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
- en: • Vehicle speed
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
- en: While this data is very similar to freeze frame data, its purpose is to collect
    and store information during a crash. The EDR constantly stores information, typically
    only about 20 seconds worth at any one time. This information was originally stored
    in a vehicle’s airbag control module (ACM), but today’s vehicles distribute this
    data among the vehicle’s ECUs. These boxes collect data from other ECUs and sensors
    and store them for recovery after a crash. [Figure 4-1](ch04.html#ch4fig1) shows
    a typical EDR.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
- en: '![image](graphics/f04-01.jpg)'
  id: totrans-168
  prefs: []
  type: TYPE_IMG
- en: '*Figure 4-1: A typical event data recorder*'
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
- en: '***Reading Data from the EDR***'
  id: totrans-170
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: 'The official way to read data from an EDR is with a crash data retrieval (CDR)
    tool kit. A basic CDR tool will connect to the OBD connector and pull data (or
    image the vehicle) from the main ECU. CDR tools can also access data in other
    modules, such as the ACM or the rollover sensor (ROS) module, but they’ll normally
    need to be plugged in directly to those devices instead of using the OBD port.
    (You’ll find a comprehensive list of which vehicles have black box data that can
    be retrieved here: *[http://www.crashdatagroup.com/research/vehiclecoverage.html](http://www.crashdatagroup.com/research/vehiclecoverage.html)*.)'
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
- en: CDR kits include both proprietary hardware and software. The hardware usually
    costs about $2,000, and the cost of the software will vary depending on how many
    vehicle types you want to support. The format of vehicle crash data is often considered
    proprietary as well, and many manufacturers license the communication protocol
    to tool providers that make CDRs. Obviously, this is not in the best interest
    of the consumer. The National Highway Traffic Safety Administration (NHTSA) has
    proposed the adoption of a standard OBD communication method to access this data.
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
- en: '***The SAE J1698 Standard***'
  id: totrans-173
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: 'The SAE J1698 standard lists recommended practices for event data collection
    and defines event records by sample rate: high, low, and static. High samples
    are data recorded at the crash event, low samples are pre-crash data, and static
    samples are data that doesn’t change. Many vehicles are influenced by the SAE
    J1698 but don’t necessarily conform to its rules for all data retrieved from a
    vehicle.'
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
- en: 'Some recorded elements are:'
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
- en: • Cruise control status
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
- en: '• Driver controls: parking brake, headlight, front wiper, gear selection, passenger
    airbag disabled switch'
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
- en: • Foremost seat track position
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
- en: • Hours in operation
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
- en: '• Indicator status lights: VEDI, SRS, PAD, TPMS, ENG, DOOR, IOD'
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
- en: • Latitude and longitude
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
- en: • Seating position
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
- en: • SRS deployment status/time
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
- en: • Temperature air/cabin
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
- en: • Vehicle mileage
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
- en: • VIN
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
- en: While the SAE J1698 states latitude and longitude recordings, many manufacturers
    claim not to record this information for privacy reasons. Your research may vary.
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
- en: '***Other Data Retrieval Practices***'
  id: totrans-188
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
- en: Not all manufacturers conform the to SAE J1698 standard. For example, since
    the 1990s, General Motors has collected a small amount of EDR data in the sensing
    and diagnostic module (SDM) of its vehicles. The SDM stores the vehicle’s Delta-v,
    which is the longitudinal change in the vehicle’s velocity. The SDM does not record
    any post-crash information.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
- en: Another example is Ford’s EDR, known as the *restraint control module (RCM)*.
    Ford stores a vehicle’s longitudinal and lateral acceleration data rather than
    Delta-v. If the vehicle has electronic throttle control, the PCM stores additional
    EDR data, including whether the passenger was an adult or not, the percent the
    accelerator/brake pedal was depressed, and whether a diagnostic code was active
    when the crash occurred.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
- en: '**Automated Crash Notification Systems**'
  id: totrans-191
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: '*Automated crash notification (ACN) systems* are the phone-home systems that
    contact a vehicle’s manufacturer or a third party with event information. These
    coincide with other crash recovery systems and extend the functionality by contacting
    the manufacturer or third party. One major difference is that there aren’t rules
    or standards that determine what data is collected and sent to an ACN. ACNs are
    specific to each manufacturer, and each system will send different information.
    For example, the Veridian automated collision notification system (released in
    2001) reports this information:'
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
- en: • Crash type (frontal, side, rear)
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
- en: • Date and time
  id: totrans-194
  prefs: []
  type: TYPE_NORMAL
- en: • Delta-v
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
- en: • Longitude and latitude
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
- en: • Make, model, and year of vehicle
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
- en: • Principal direction of force
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
- en: • Probable number of occupants
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
- en: • Rollover (yes or no)
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
- en: • Seat belt use
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
- en: • Vehicle’s final resting position (normal, left side, right side, roof)
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
- en: '**Malicious Intent**'
  id: totrans-203
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Attackers may target a vehicle’s DTCs and freeze frame data to hide malicious
    activity. For example, if an exploit needs to take advantage of only a brief,
    temporary condition in order to succeed, a vehicle’s freeze frame data will most
    likely miss the event due to delays in recording. Captured freeze frame snapshots
    rarely contain information that would help determine whether the DTC was triggered
    by malicious intent. (Because black box EDR systems typically trigger only during
    a crash, it’s unlikely that an attacker would target them because they’re not
    likely to contain useful data.)
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
- en: An attacker fuzzing a vehicle’s system might check for fired DTCs and use the
    information contained in a DTC to determine which component was affected. This
    type of attack would most likely occur during the research phase of an attack
    (when an attacker is trying to determine what components the randomly generated
    packets were affecting), not during an active exploit.
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
- en: Accessing and fuzzing manufacturer-specific PIDs—by flashing firmware or using
    mode 0x08—can lead to interesting results. Because each manufacturer interface
    is kept secret, it’s difficult to assess the actual risk of the network. Unfortunately,
    security professionals will need to reverse or fuzz these proprietary interfaces
    to determine what is exposed before work can be done to determine whether there
    are vulnerabilities. Malicious actors will need to do the same thing, although
    they won’t be motivated to share their findings. If they can keep undocumented
    entry points and weaknesses a secret, then their exploit will last longer without
    being detected. Having secret interfaces into the vehicle doesn’t increase security;
    the vulnerabilities are there regardless of whether people are allowed to discuss
    them. Because there’s money in selling these codes (sometimes upward of $50,000),
    the industry has little incentive to embrace the community.
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
- en: '**Summary**'
  id: totrans-207
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: In this chapter, you have gone beyond traditional CAN packets to understand
    more complex protocols such as ISO-TP. You have learned how CAN packets can be
    linked together to write larger messages or to create two-directional communications
    over CAN. You also learned how to read and clear any DTCs. You looked at how to
    find undocumented diagnostic services and saw what types of data are recorded
    about you and your driving habits. You also explored some ways in which diagnostic
    services can be used by malicious parties.
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
