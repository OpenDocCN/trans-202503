<html><head></head><body>
<h2 class="h2" id="ch05"><a id="page_81"/><strong>5</strong></h2>
<p class="h2a"><strong>SURVEILLANCE AND RASPBERRY PI</strong></p>
<div class="image1"><img src="graphics/f0001-01.jpg" alt="image"/></div>
<p class="noindent">Now that you can detect zombies, it’s also a good idea to monitor their movements. But don’t risk joining the undead ranks by following them around! Watch them safely from inside your base, and you’ll keep your brain intact. This chapter shows you how to make a surveillance camera setup with USB and wireless webcams, using a Raspberry Pi single-board computer to minimize your energy usage (see <a href="ch05.html#ch05fig1">Figure 5-1</a>).</p>
<p class="indent">Both projects in this chapter require you to download software, so you’d be well advised to think ahead and get your system set up before disaster strikes.</p>
<div class="image"><a id="page_82"/><img src="graphics/f05-01.jpg" alt="image"/></div>
<p class="figuret"><a id="ch05fig1">Figure 5-1:</a> Zombie smiling and waving at a webcam</p>
<h3 class="h3" id="ch00lev1sec90"><strong>THE RASPBERRY PI</strong></h3>
<p class="noindent">You could get these projects working with a regular laptop or desktop computer, but those devices take a fair bit of power. A laptop typically consumes 20W to 60W, and a desktop draws even more. Also, you’d need an AC inverter. Laptop power supplies provide low-voltage DC, but generally that voltage is still higher than 12V, so powering directly from a 12V battery wouldn’t be an option.</p>
<p class="indent">Besides, if you have to shift bases because the zombie population density has gotten too high, do you really want to risk being weighed down by a giant desktop tower?</p>
<p class="indent">The Raspberry Pi, on the other hand, is a tiny Linux computer on a single board about the size of a credit card, and it uses less than 3W of power. A Raspberry Pi Model B+ is used in this project and throughout this book (<a href="ch05.html#ch05fig2">Figure 5-2</a>). If you happen to have an older Raspberry Pi Model B or a newer Raspberry Pi 2, they should also work just fine. In fact, the extra power of <a id="page_83"/>the Pi 2 should make the webcam browser page perform noticeably quicker. Models A and A+ are not ideal, as they are less powerful and have less memory than the other models.</p>
<div class="image"><img src="graphics/f05-02.jpg" alt="image"/></div>
<p class="figuret"><a id="ch05fig2">Figure 5-2:</a> A Raspberry Pi Model B+</p>
<p class="indent">The Raspberry Pi can run simple Python scripts, and you can link it to external hardware, too. For example, in “<a href="ch05.html#ch00lev1sec95">Project 7: Monitor Zombies with a USB Webcam</a>” on <a href="ch05.html#page_87">page 87</a>, when the webcam detects movement, an LED will turn from green to red using the Raspberry Pi’s GPIO (general purpose input and output) connector. The GPIO connector is the double row of pins down one side of the board (<a href="ch05.html#ch05fig2">Figure 5-2</a>).</p>
<h4 class="h4" id="ch00lev1sec91"><strong>THE RASPBERRY PI SYSTEM</strong></h4>
<p class="noindent">A complete Raspberry Pi system includes a USB keyboard, a mouse, and a small HDMI (High-Definition Multimedia Interface) monitor (<a href="ch05.html#ch05fig3">Figure 5-3</a>).</p>
<p class="indent">The keyboard and mouse are standard items that you can buy anywhere. For a constant visual on your zombie foes, you’ll need something to watch the video feed on, and you could just connect a normal TV or monitor to the Raspberry Pi. However, to save even more power, this project uses a 12V DC monitor with a 7-inch (180 mm) display. At worst, this might double the power consumption to a peak of 6W.</p>
<div class="image"><a id="page_84"/><img src="graphics/f05-03.jpg" alt="image"/></div>
<p class="figuret"><a id="ch05fig3">Figure 5-3:</a> A Raspberry Pi system</p>
<h4 class="h4" id="ch00lev1sec92"><strong>WHAT YOU WILL NEED</strong></h4>
<p class="noindent">To use this Raspberry Pi system with a 12V battery as this book describes, you’ll need the following items.</p>
<table border="0" cellpadding="0" cellspacing="0" class="topbot" width="100%">
<thead>
<tr>
<th valign="top" class="table_th"><p class="table1"><strong>ITEM</strong></p></th>
<th valign="top" class="table_th"><p class="table1"><strong>NOTES</strong></p></th>
<th valign="top" class="table_th"><p class="table1"><strong>SOURCE</strong></p></th>
</tr>
</thead>
<tbody>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> Raspberry Pi</p></td>
<td valign="top" class="table"><p class="table">Model B+ or Pi 2 with NOOBS micro SD card</p></td>
<td valign="top" class="table"><p class="table">Adafruit (2358), Fry’s (8258726)</p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> Small HDMI monitor</p></td>
<td valign="top" class="table"><p class="table">12V HDMI monitor. Suggested device has 800×480 pixel resolution.</p></td>
<td valign="top" class="table"><p class="table">Adafruit (1934), eBay</p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> Keyboard and mouse</p></td>
<td valign="top" class="table"><p class="table">Standard USB keyboard and mouse</p></td>
<td valign="top" class="table"><p class="table">Computer store, online</p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> HDMI cable</p></td>
<td valign="top" class="table"><p class="table">As short as possible</p></td>
<td valign="top" class="table"><p class="table">Computer store, online</p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> 12V to USB adapter</p></td>
<td valign="top" class="table"><p class="table">Minimum current of 1 A</p></td>
<td valign="top" class="table"><p class="table">Auto parts store, Computer store</p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> Vehicle to 2.1 mm jack adapter</p></td>
<td valign="top" class="table"><p class="table"> </p></td>
<td valign="top" class="table"><p class="table">Auto parts store</p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> Powered USB hub</p></td>
<td valign="top" class="table"><p class="table">Needed only if you have a Raspberry Pi Model B</p></td>
<td valign="top" class="table"><p class="table">Computer store, online</p></td>
</tr>
</tbody>
</table>
<p class="indent">If you’re using a Model B Raspberry Pi that has only two USB sockets, then you’ll need a powered USB hub or a wireless keyboard and mouse combo that uses a single USB adapter. Otherwise, the keyboard and mouse will occupy both of the Model B’s USB ports, and you won’t be able to plug in the webcam needed in the next project.</p>
<h4 class="h4" id="ch00lev1sec93"><a id="page_85"/><strong>POWERING THE SYSTEM</strong></h4>
<p class="noindent">The Raspberry Pi is powered from a micro USB socket, so you can use a 12V-to-USB power adapter when powering it from a 12V battery. The monitor I suggest has a separate driver board that powers the display and connects it to the Raspberry Pi; that’s the printed circuit board (PCB) in the middle of <a href="ch05.html#ch05fig3">Figure 5-3</a>. This driver board has a 2.1 mm DC power socket.</p>
<p class="indent">A combined cigarette lighter and USB socket adapter (such as in <a href="ch05.html#ch05fig4">Figure 5-4</a>) is a great way to power this whole system from batteries. If you haven’t already done so, you’ll need to replace the cigarette plug with a pair of alligator clips to attach the adapter to the battery. Refer to <a href="ch03.html#ch03">Chapter 3</a> for instructions on how to connect your 12V battery to low-voltage devices.</p>
<div class="image"><img src="graphics/f05-04.jpg" alt="image"/></div>
<p class="figuret"><a id="ch05fig4">Figure 5-4:</a> Combined USB and 12V DC power adapter</p>
<p class="indent">With the power adapter setup of <a href="ch05.html#ch05fig4">Figure 5-4</a>, you can power your Raspberry Pi from a normal micro USB lead and, in “<a href="ch05.html#ch00lev1sec102">Project 8: A Wireless Zombie Surveillance System</a>” on <a href="ch05.html#page_96">page 96</a>, power the Wi-Fi webcam and router with a DC jack-to-cigarette lighter adapter. Check the voltages used by your router and Wi-Fi webcam, but they’re quite likely 12V DC, which is very handy if you’ve stockpiled car batteries for the apocalypse already.</p>
<div class="note">
<p class="notet"><span class="font1"><strong>WARNING</strong></span></p>
<p class="noindent">Be careful when handling the display, especially if the display has a metal back. The exposed underside of the driver board can easily short against the metal, damaging the board.</p>
</div>
<p class="indent">To connect the driver board to a car battery from your stockpile, just make a lead with a 2.1 mm jack on one end and alligator clips on the other. However, if your battery is overloaded with alligator clips, you may want to attach a multiple cigarette lighter socket adapter to it instead. Then you can plug various appliances into the adapter with cigarette lighter plugs, as described in “<a href="ch03.html#ch00lev1sec53">Cigarette Lighter Sockets</a>” on <a href="ch03.html#page_46">page 46</a>.</p>
<h4 class="h4" id="ch00lev1sec94"><a id="page_86"/><strong>INSTALLING RASPBIAN</strong></h4>
<p class="noindent">The Raspberry Pi computer doesn’t have a hard disk. Instead, the Raspberry Pi 2 and Model B+ stores its operating system, programs, and data on a micro SD card. Older Raspberry Pi models store that information on a regular SD card. There won’t be an Internet after the zombie apocalypse, so get a micro SD card preloaded with an operating system (OS)—you won’t be able to download it. In fact, a Raspberry Pi with a preloaded SD card usually doesn’t cost much more than the Raspberry Pi on its own, so I recommend just buying the preloaded card with your Raspberry Pi. If you do want to add an OS to a blank SD card yourself, visit <em><a href="http://www.raspberrypi.org/help/noobs-setup/">http://www.raspberrypi.org/help/noobs-setup/</a></em> and follow the directions there before the Internet ceases to exist.</p>
<p class="indent">Whether you buy a preloaded micro SD card or add the software yourself, this book assumes you’re using a micro SD card with the Raspberry Pi Foundation’s NOOBS (New Out Of the Box Software) installer. Once you have one, fit the micro SD card into the Raspberry Pi; plug in the keyboard, mouse, and monitor; and power everything up.</p>
<div class="note">
<p class="notet"><span class="font1"><strong>NOTE</strong></span></p>
<p class="noindent">The monitor I suggest for this project should detect the Raspberry Pi through the HDMI cable, and the Pi should automatically detect the screen resolution. If the Pi doesn’t detect the screen resolution, then visit the Raspberry Pi’s documentation page (<a href="http://www.raspberrypi.org/documentation/">http://www.raspberrypi.org/documentation/</a>), go to the Configuration section, and read config.txt to learn how to configure your Raspberry Pi. Print the instructions and keep them with this book so you’re ready when the apocalypse ends the Internet as we know it.</p>
</div>
<p class="indent">When you boot the Raspberry Pi with NOOBS, you’ll be offered your choice of operating system. This book uses Raspbian, so select the checkbox next to Raspbian and then click <strong>Install</strong>. The installation will take a while, so watch your PIR zombie detector or double-check your battery stockpile while you wait. Once the installer finishes, you’re ready to move on.</p>
<p class="indent">The Raspbian distribution comes with a pretty comprehensive set of software, but at the time of writing, one thing it lacks is a decent browser that will work with a webcam. I favor Chromium, a derivative of Google Chrome that works well without hogging so many of the Raspberry Pi’s resources that the Pi becomes too zombie-like for comfort. As with most free software, you’ll need to download Chromium from the Internet.</p>
<p class="indent">I apologize if it’s too late, but if it’s not, then connect the Raspberry Pi to your preapocalyptic home modem or router with an Ethernet cable. Then, to <a id="page_87"/>install Chromium, click the <strong>LX Terminal</strong> icon on the Raspberry Pi desktop. A terminal window should open, and at first, you should just see a flashing cursor and a command prompt like this:</p>
<p class="programsb"><span class="codestrong">$</span></p>
<p class="indent">Anytime you need to enter commands for a project in this book, I’ll also show the dollar command prompt on the left, which you don’t need to type. Now, enter the following commands:</p>
<p class="programsb">$ <span class="codestrong">sudo apt-get update</span><br/>$ <span class="codestrong">sudo apt-get install chromium</span></p>
<p class="indent">The <code>sudo</code> (short for <em>substitute user do</em>) command allows you to execute administrative commands. Prepend it to commands that need administrative access, such as commands that install new software as we’re doing now.</p>
<p class="indent">The <code>apt-get</code> package management software on Debian-based Linux distributions such as Raspbian is used to manage and install software. The <code>update</code> command used with <code>apt-get</code> tells your system to update its cached list of available software from Internet software repositories. The <code>apt-get install</code> command tells <code>apt-get</code> to search for and install the latest version of the package supplied as the final argument, which in this case is Chromium.</p>
<p class="indent">With Chromium in place, you are ready to build your surveillance system. Now let’s monitor some zombies!</p>
<h3 class="h3" id="ch00lev1sec95"><strong>PROJECT 7: MONITOR ZOMBIES WITH A USB WEBCAM</strong></h3>
<p class="noindent">This project uses a low-cost USB webcam with a long lead attached to the Raspberry Pi. The maximum usable length of a USB 2 lead is 96 feet (30 m), so that’s the farthest away from the Raspberry Pi that your camera can be.</p>
<p class="indent">You can see most of the setup in <a href="ch05.html#ch05fig5">Figure 5-5</a>, though the webcam is just out of view on the left; I’ve shown it in the inset photo. One of the benefits of building a surveillance system for yourself rather than simply using an off-the-shelf closed-circuit television (CCTV) system is that because the software is completely under your control, you can customize it however you want.</p>
<p class="indent">The webcam is controlled by a short Python program that monitors the images being captured for changes. When movement is detected on the screen, the program uses the Raspberry Pi’s GPIO pins to turn an RGB (red-green-blue) LED from green to red. You can cancel the alarm by pressing the spacebar on the keyboard, which will turn the LED green again.</p>
<div class="image"><a id="page_88"/><img src="graphics/f05-05.jpg" alt="image"/></div>
<p class="figuret"><a id="ch05fig5">Figure 5-5:</a> Zombie webcam and movement alarm</p>
<p class="indent">The advantage of this project over “<a href="ch04.html#ch00lev1sec81">Project 6: PIR Zombie Detector</a>” on <a href="ch04.html#page_72">page 72</a>, which uses a PIR sensor, is that now, if the alarm is triggered, you can take a good look at the zombies that are about to attack you.</p>
<h4 class="h4" id="ch00lev1sec96"><strong>WHAT YOU WILL NEED</strong></h4>
<p class="noindent">To set up this USB webcam, you’ll need the Raspberry Pi setup described in “<a href="ch05.html#ch00lev1sec90">The Raspberry Pi</a>” on <a href="ch05.html#page_82">page 82</a> and the additional items described here.</p>
<table border="0" cellpadding="0" cellspacing="0" class="topbot" width="100%">
<thead>
<tr>
<th valign="top" class="table_th"><p class="table1"><strong>ITEM</strong></p></th>
<th valign="top" class="table_th"><p class="table1"><strong>NOTES</strong></p></th>
<th valign="top" class="table_th"><p class="table1"><strong>SOURCE</strong></p></th>
</tr>
</thead>
<tbody>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> USB webcam</p></td>
<td valign="top" class="table"><p class="table">See <a href="http://elinux.org/RPi_USB_Webcams/">http://elinux.org/RPi_USB_Webcams/</a> for compatible webcams.</p></td>
<td valign="top" class="table"><p class="table">Computer store</p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> USB extension lead</p></td>
<td valign="top" class="table"><p class="table">Length to suit your compound (less than 100 feet [30 m])</p></td>
<td valign="top" class="table"><p class="table">Computer store</p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> Raspberry Squid</p></td>
<td valign="top" class="table"><p class="table">Contains the RGB LED</p></td>
<td valign="top" class="table"><p class="table">Amazon, <a href="http://www.monkmakes.com/">http://www.monkmakes.com/</a></p></td>
</tr>
</tbody>
</table>
<p class="indent"><a id="page_89"/>Not every USB webcam is compatible with the Raspberry Pi, so check <em><a href="http://elinux.org/RPi_USB_Webcams">http://elinux.org/RPi_USB_Webcams</a></em> for a list of cameras known to work with the Raspberry Pi. I used an HP 2300 Webcam.</p>
<div class="note">
<p class="notet"><span class="font1"><strong>NOTE</strong></span></p>
<p class="noindent">The Raspberry Pi camera module is a high-resolution camera that plugs directly into a special connector on the Raspberry Pi. The module is great if you’re making a Raspberry Pi camera, but it’s not much use in a situation like this, where you want the camera to be some distance from the Raspberry Pi.</p>
</div>
<p class="indent">The Raspberry Squid is a handy little accessory built just for the Raspberry Pi. It has an RGB LED with built-in current-limiting resistors that allow you to connect it directly to the Raspberry Pi’s GPIO pins. Its design is open source, and you can find details of how to build your own here: <em><a href="https://github.com/simonmonk/squid/">https://github.com/simonmonk/squid/</a></em>. You can also buy a ready-made Squid; see <em><a href="http://www.monkmakes.com/">http://www.monkmakes.com/</a></em> for details.</p>
<h4 class="h4" id="ch00lev1sec97"><strong>CONSTRUCTION</strong></h4>
<p class="noindent">After completing the setup in “<a href="ch05.html#ch00lev1sec91">The Raspberry Pi System</a>” on <a href="ch05.html#page_83">page 83</a>, to build this project you just need to attach the Raspberry Squid to the GPIO connector of the Raspberry Pi, plug in the USB webcam, supply 12V to the monitor, and supply 5V to the Raspberry Pi (see <a href="ch05.html#ch05fig6">Figure 5-6</a>).</p>
<div class="image"><img src="graphics/f05-06.jpg" alt="image"/></div>
<p class="figuret"><a id="ch05fig6">Figure 5-6:</a> Schematic for the surveillance system</p>
<h5 class="h5" id="ch00lev1sec98"><a id="page_90"/><strong>STEP 1: ATTACH THE RASPBERRY SQUID</strong></h5>
<p class="noindent">By controlling the three outputs of the Raspberry Squid, you can make the LED display any color. However, this project won’t use the accessory’s full potential since this surveillance setup needs to display only red and green.</p>
<p class="indent">To help identify the GPIO pins, you can use a GPIO pin identification template. There are many of these available from suppliers like Adafruit, including the Raspberry Leaf, which is included if you buy a ready-made Raspberry Squid. Place this template over the GPIO connectors so that you can tell which pin is which. Then connect the Raspberry Squid to the GPIO connector (<a href="ch05.html#ch05fig7">Figure 5-7</a>).</p>
<div class="image"><img src="graphics/f05-07.jpg" alt="image"/></div>
<p class="figuret"><a id="ch05fig7">Figure 5-7:</a> Connecting the Raspberry Squid to the GPIO connector</p>
<p class="indent">The black lead of the Raspberry Squid goes to one of the GND pins on the Raspberry Pi. In the orientation shown (<a href="ch05.html#ch05fig7">Figure 5-7</a>), this is the third pin down on the right. The red lead of the Raspberry Squid goes to pin 18 on the Raspberry Pi, and the green lead of the Squid goes to pin 23 of the Pi. Since you won’t need the blue color, you can leave the blue lead of the Raspberry Squid unattached, but if you prefer to keep the leads tidy, just attach the blue lead to any one of the other GND pins of the GPIO header.</p>
<h5 class="h5" id="ch00lev1sec99"><strong>STEP 2: INSTALL THE USB WEBCAM</strong></h5>
<p class="noindent">If you already have a USB webcam, then see if it works with the Raspberry Pi before you get another one. First, check whether the Raspberry Pi can <a id="page_91"/>detect your webcam as a USB device by entering the command <span class="codestrong">lsusb</span> in LXTerminal both before and after plugging the webcam into the Pi, without the USB extension lead.</p>
<p class="programsb">$ <span class="codestrong">lsusb</span><br/>Bus 001 Device 002: ID 0424:9514 Standard Microsystems Corp.<br/>Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub<br/>Bus 001 Device 003: ID 0424:ec00 Standard Microsystems Corp.<br/>Bus 001 Device 004: ID 03f0:e207 Hewlett-Packard<br/>Bus 001 Device 006: ID 04d9:1603 Holtek Semiconductor, Inc. Keyboard<br/>Bus 001 Device 005: ID 1c4f:0034 SiGma Micro</p>
<p class="indent">If an extra entry appears after you run the command with the webcam plugged in, then that entry should be your webcam. In the list I’ve shown, my Hewlett-Packard webcam is the fourth entry from the top.</p>
<p class="indent">If your webcam does not appear in the list, then try unplugging it, plugging it back in, and running the <code>lsusb</code> command again. If that doesn’t work, try a reboot of the Raspberry Pi.</p>
<p class="indent">Unfortunately, being recognized as a USB device is still no guarantee that a webcam will work with the Raspberry Pi. You’ll find out for certain when you run the program. You may also find that your webcam works only if it’s plugged into a powered hub. If you have an older model of Raspberry Pi, you may find instead that the whole board resets when you plug the webcam into the USB port. If this is the case for your board, then plug the webcam in while the Raspberry Pi is powered off.</p>
<h5 class="h5" id="ch00lev1sec100"><strong>STEP 3: INSTALL THE SOFTWARE</strong></h5>
<p class="noindent">Connect the Raspberry Pi to your network with an Ethernet cable, make sure the Internet is up and running, and download the Raspberry Pi programs for the projects in this book. From your browser on the Pi, you can head to <em><a href="http://www.nostarch.com/zombies/">http://www.nostarch.com/zombies/</a></em>, click the link to GitHub, and download the <em>Raspberry Pi</em> directory. For this project, you’ll use the code in the <em>usb_webcam</em> directory. But the easiest way to get the software onto your Raspberry Pi is to clone the GitHub repository directly onto your Raspberry Pi, as I describe in “Fetching Source Code from GitHub” on <a href="ch05.html#page_92">page 92</a>.</p>
<p class="indent">The Python program <em>monitor.py</em> is pretty brief, considering what it does, and I’ll walk you through it here. I won’t, however, cover Python itself beyond the context of the projects that use it. If you are new to Python, you might take a look another of my books, <em>Programming the Raspberry Pi: Getting Started with Python</em> (McGraw-Hill, 2013).</p>
<div class="sidebar">
<p class="sidebart"><a id="page_92"/><strong>FETCHING SOURCE CODE FROM GITHUB</strong></p>
<p class="noindent">You can get all the Raspberry Pi programs used in this book onto your Raspberry Pi in one go by cloning the book’s GitHub repository. Just enter the following commands from a terminal window on the Raspberry Pi.</p>
<p class="programsb">$ <span class="codestrong">cd /home/pi</span><br/>$ <span class="codestrong">git clone https://github.com/simonmonk/zombies.git</span></p>
<p class="indent">These commands will fetch all of code for the book, including the Arduino code used in other projects (which you can ignore in this chapter). Even though you’re not using a browser, you’ll still need an Internet connection for the commands to work, so definitely get this code before the apocalypse.</p>
</div>
<p class="indent">The program begins by importing the various Python modules that it needs. These libraries of existing code are all included in the Raspbian distribution, so you shouldn’t need to install them separately.</p>
<pre>import sys<br/>import time<br/>import pygame<br/>import pygame.camera<br/>import RPi.GPIO as GPIO</pre>
<p class="indent">The <code>sys</code> and <code>time</code> modules have general utilities for accessing the operating system and the ability to tell the program to sleep as a way of delaying its activity for a period of time. The <code>pygame</code> module contains the Pygame graphical games library, which includes a camera interface. To control the LED, the program needs access to the GPIO system, and this is provided by the <code>RPi.GPIO</code> library.</p>
<p class="indent">Next, the program defines some constants that it will use. You could change these if you wanted to use the camera at a different resolution or make the default size of the window larger.</p>
<pre>camera_res = (320, 240)<br/>window_size = (640, 480)<br/>red_pin = 18<br/>green_pin = 23</pre>
<p class="indent"><a id="page_93"/>The parameters in parentheses after the <code>camera_res</code> and <code>window_res</code> constants are the width and height respectively (in pixels). After the constants, the Pygame system (used to display the camera images) and the camera itself are initialized, along with the GPIO ports that you’ll use to control the Raspberry Squid:</p>
<pre><span class="ent">➊</span> pygame.init()<br/>  pygame.camera.init()<br/><br/>  # initialize GPIO<br/><span class="ent">➋</span> GPIO.setmode(GPIO.BCM)<br/>  GPIO.setup(red_pin, GPIO.OUT)<br/>  GPIO.setup(green_pin, GPIO.OUT)<br/><br/><span class="ent">➌</span> screen = pygame.display.set_mode(window_size, 0)<br/><br/>  #Find, open, and start the low-res camera.<br/><span class="ent">➍</span> cam_list = pygame.camera.list_cameras()<br/>  webcam = pygame.camera.Camera(cam_list[0], camera_res)<br/>  webcam.start()<br/><span class="ent">➎</span> old_image = False</pre>
<p class="indent">The first two lines of initialization code <span class="ent">➊</span> handle Pygame and the camera, while the next three lines <span class="ent">➋</span> initialize those GPIO ports. The screen is then initialized <span class="ent">➌</span> to the size of the window specified in <code>window_size</code>. The final cluster of lines <span class="ent">➍</span> first finds all the cameras connected to the Raspberry Pi and then creates a link to the first one (<code>webcam</code>). It then starts running the webcam. The final line <span class="ent">➎</span> defines a variable called <code>old_image</code>, which is used to detect movement by spotting changes in successive frames from the webcam.</p>
<p class="indent">After initialization, the first function this program defines is called <code>check_for_movement</code>.</p>
<pre>def check_for_movement(old_image, new_image):<br/>    global c<br/>    diff_image = pygame.PixelArray(new_image)<br/>      .compare(pygame.PixelArray(old_image), distance=0.5, <br/>      weights=(0.299, 0.587, 0.114))<br/><br/>    ys = range(0, camera_res[1] / 20)<br/>    for x in range(0, camera_res[0] / 20):<br/>        for y in ys:<br/>            if diff_image[x*20, y*20] &gt; 0:<br/>                return True<br/>    return False</pre>
<p class="indent">As the name suggests, <code>check_for_movement</code> takes two images, the previous frame (<code>old_image</code>) and the latest frame (<code>new_image</code>), and compares them. The <code>distance</code> parameter to <code>compare</code> is the “distance” between the color of the pixel <a id="page_94"/>in one image and the color of that same pixel in the other image. The <code>weights</code> parameter is not explained in the <code>pygame</code> documentation, and the values used here are taken in faith from an example in the <code>pygame</code> documentation for <code>PixelArray</code> (<em><a href="http://www.pygame.org/docs/ref/pixelarray.html">http://www.pygame.org/docs/ref/pixelarray.html</a></em>).</p>
<p class="indent">The comparison results in a new image called <code>diff_image</code> that only has white pixels where a difference was found between the pixels in the two images.</p>
<p class="indent">To decide whether movement has occurred, the program should really go through every pixel in the <code>diff_image</code>. But any largish movement will result in lots of pixels changing, and zombies are big, so the code speeds things up by only sampling 1 pixel in 20.</p>
<p class="indent">The next two functions set the LED of the Raspberry Squid to red or green.</p>
<pre>def led_red():<br/>    GPIO.output(red_pin, True) <br/>    GPIO.output(green_pin, False) <br/><br/>def led_green():<br/>    GPIO.output(red_pin, False) <br/>    GPIO.output(green_pin, True) </pre>
<p class="indent">The Raspberry Squid is just an RGB LED, and as with most RGB LEDs, you can select the color it glows by outputting certain combinations of high (<code>True</code>) and low (<code>False</code>) on the GPIO pins the LED is connected to. In this case, you want red and green, so the code just sets the appropriate pin to <code>True</code> and the other to <code>False</code>. The blue takes no part in this project, so you don’t have to deal with it in the code.</p>
<p class="indent">Finally, we come to the main loop of the program, where the new image is fetched and scaled so it’s ready to display in the window.</p>
<pre>count = 0<br/>led_green()<br/>while True:<br/>    count = count + 1<br/>    new_image = webcam.get_image()<br/>    # Set old_image the first time around the loop.<br/>    if not old_image:<br/>        old_image = new_image<br/>    scaled_image = pygame.transform.scale(new_image, window_size)<br/>    # Only check one frame in 10.<br/>    if count == 10 :<br/>        if check_for_movement(old_image, new_image):<br/>            led_red()<br/>        count = 0<br/><a id="page_95"/><br/>    old_image = new_image<br/>    screen.blit(scaled_image, (0, 0))<br/>    pygame.display.update()</pre>
<p class="indent">The <code>count</code> variable keeps track of how many times the loop has run. When <code>count</code> gets to 10, the last two images are compared. Sampling only one-tenth of the time also speeds up the program, which would otherwise be too slow. If there was movement, meaning <code>check_for_movement</code> returns <code>True</code>, the LED turns red.</p>
<p class="indent">The last part of the main loop checks for the close window event (which stops the program).</p>
<pre># Check for events.<br/>for event in pygame.event.get():<br/>    if event.type == pygame.QUIT:<br/>        webcam.stop()<br/>        pygame.quit()<br/>        sys.exit()<br/>    if event.type == pygame.KEYDOWN:<br/>        print(event.key)<br/>        if event.key == 32: # Space<br/>            led_green()</pre>
<p class="indent">The event checking also catches any key press event (<code>KEYDOWN</code>), and if the spacebar is pressed, the program sets the LED back to green.</p>
<h4 class="h4" id="ch00lev1sec101"><strong>USING THE WEBCAM</strong></h4>
<p class="noindent">To get the webcam started, run <em>monitor.py</em> by entering the following commands in a terminal window on your Raspberry Pi. A window should open showing a view from the webcam (<a href="ch05.html#ch05fig8">Figure 5-8</a>).</p>
<p class="programsb">$ <span class="codestrong">cd "/home/pi/zombies/Raspberry Pi/usb_webcam"</span><br/>$ <span class="codestrong">sudo python monitor.py</span></p>
<p class="indent">At this point, the Raspberry Squid LED should be green. To test the movement detection, wave your hand in front of the webcam. The LED should go red and stay red until you press the spacebar on the Raspberry Pi’s keyboard.</p>
<p class="indent">When everything is working with the webcam connected directly to the Raspberry Pi, you can use the USB extension lead to place the camera further away. Place the camera somewhere overlooking your base’s entrance, and then you’ll know when the coast is clear to go outside.</p>
<p class="indent">There will be a limit on how far you can move the webcam before the signal degrades and you start getting errors, so keep the lead under 30 m.</p>
<div class="image"><a id="page_96"/><img src="graphics/f05-08.jpg" alt="image"/></div>
<p class="figuret"><a id="ch05fig8">Figure 5-8:</a> The USB webcam in operation</p>
<h3 class="h3" id="ch00lev1sec102"><strong>PROJECT 8: A WIRELESS ZOMBIE SURVEILLANCE SYSTEM</strong></h3>
<p class="noindent">There may be no Internet after the apocalypse, but that doesn’t mean you can’t set up your own wireless network and attach a Wi-Fi webcam to it. You can use a low-cost webcam for this project (<a href="ch05.html#ch05fig9">Figure 5-9</a>). With a wireless webcam, you can put even more distance between you and the zombies you’re monitoring, making you safer than ever.</p>
<p class="indent">Once you set up the camera and a local network, you can view the camera video from the browser on your Raspberry Pi (<a href="ch05.html#ch05fig10">Figure 5-10</a>) or even a Wi-Fi-equipped tablet or smartphone. What’s more, if you buy the right sort of webcam, you’ll be able to use software to change the direction the webcam is pointing.</p>
<div class="image"><img src="graphics/f05-09.jpg" alt="image"/></div>
<p class="figuret"><a id="ch05fig9">Figure 5-9:</a> A low-cost Wi-Fi webcam</p>
<div class="image"><a id="page_97"/><img src="graphics/f05-10.jpg" alt="image"/></div>
<p class="figuret"><a id="ch05fig10">Figure 5-10:</a> Using a Wi-Fi webcam with the Raspberry Pi</p>
<p class="indent">All this comes at a cost, of course: Wi-Fi uses quite a lot of power. The wireless router and Wi-Fi webcam are likely to both use between 5W and 10W of power each. You want to turn them on only when needed.</p>
<p class="indent">Note that the Raspberry Pi in <a href="ch05.html#ch05fig8">Figure 5-8</a> still has the Raspberry Squid attached, even though this project doesn’t use the Squid. Leave Project 7’s hardware connected, and you can monitor zombies from both cameras!</p>
<h4 class="h4" id="ch00lev1sec103"><strong>WHAT YOU WILL NEED</strong></h4>
<p class="noindent">To setup this Wi-Fi webcam, you’ll need the Raspberry Pi setup described in “<a href="ch05.html#ch00lev1sec91">The Raspberry Pi System</a>” on <a href="ch05.html#page_83">page 83</a> and these additional items.</p>
<table border="0" cellpadding="0" cellspacing="0" class="topbot" width="100%">
<thead>
<tr>
<th valign="top" class="table_th"><p class="table1"><strong>ITEM</strong></p></th>
<th valign="top" class="table_th"><p class="table1"><strong>NOTES</strong></p></th>
<th valign="top" class="table_th"><p class="table1"><strong>SOURCE</strong></p></th>
</tr>
</thead>
<tbody>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> Wi-Fi webcam</p></td>
<td valign="top" class="table"><p class="table">Preferably a unit that can rotate ($50)</p></td>
<td valign="top" class="table"><p class="table">Computer store, eBay</p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> Wi-Fi router</p></td>
<td valign="top" class="table"><p class="table">Low-end unit ($20) operating from 12V DC supply</p></td>
<td valign="top" class="table"><p class="table">Computer store, eBay</p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> 2x Ethernet cable</p></td>
<td valign="top" class="table"><p class="table">Any length will do.</p></td>
<td valign="top" class="table"><p class="table"> </p></td>
</tr>
<tr>
<td valign="top" class="table"><p class="table-b"><img src="graphics/square.jpg" alt="image"/> 2x 12V adapter lead</p></td>
<td valign="top" class="table"><p class="table">2.1 mm jack plug-to-cigarette lighter adapter</p></td>
<td valign="top" class="table"><p class="table">Auto parts store</p></td>
</tr>
</tbody>
</table>
<p class="indent"><a id="page_98"/>Wi-Fi webcams are available at a wide range of costs. The device I chose is at the low-cost end and while the image isn’t fantastic, it’s plenty good enough to spot zombies.</p>
<p class="indent">The Wi-Fi router is just a normal household router; most homes with Internet access probably have several, and I’ll bet you have a spare lying around, too. These devices serve two purposes: first, to connect your devices to the Internet (not going to happen with zombies all over the place) and, second, to make a local area network (LAN) to which you can attach wired and wireless devices. We’ll use the second function of the Wi-Fi router here.</p>
<h4 class="h4" id="ch00lev1sec104"><strong>CONSTRUCTION</strong></h4>
<p class="noindent">This project uses ready-made components, so you don’t really have any electronics construction to do. You’ll just be connecting components (<a href="ch05.html#ch05fig11">Figure 5-11</a>).</p>
<div class="image"><img src="graphics/f05-11.jpg" alt="image"/></div>
<p class="figuret"><a id="ch05fig11">Figure 5-11:</a> Schematic for the Wi-Fi camera system</p>
<p class="indent">Connecting a tablet or smartphone to the Wi-Fi network (<a href="ch05.html#ch05fig11">Figure 5-11</a>) is by no means essential, but it would allow you to monitor the webcam from a mobile device as well as the screen of your Raspberry Pi.</p>
<h5 class="h5" id="ch00lev1sec105"><a id="page_99"/><strong>STEP 1: SET UP A LOCAL AREA NETWORK (LAN)</strong></h5>
<p class="noindent">Since this network will not connect to the Internet, you only need a router. That means even if you have a modem-router combination, you don’t need to connect it to a phone line or cable connection.</p>
<p class="indent">The router allows devices to connect to it in two ways: using an Ethernet cable or using Wi-Fi. We’ll connect the Raspberry Pi using an Ethernet cable because a wired connection is more reliable and uses less power than Wi-Fi.</p>
<p class="indent">Once you plug the Raspberry Pi into the router, the Pi should automatically join the network using DHCP (Dynamic Host Configuration Protocol), so you shouldn’t need to set it up. At this point, though, you may want to set up the Wi-Fi details of the router. This will involve connecting to the configuration page for your router. The IP address for this page is usually 192.168.1.1, but in my case, it was 192.168.1.254. In other words, check your router documentation. When you know the address of your router’s admin page, open the Chromium browser and type that URL into the browser’s address bar.</p>
<p class="indent">The router admin page should have a wireless, WLAN, or Wi-Fi settings page somewhere. Find this page and set the wireless network name (also called the ESSID) and password (<a href="ch05.html#ch05fig12">Figure 5-12</a>).</p>
<div class="image"><img src="graphics/f05-12.jpg" alt="image"/></div>
<p class="figuret"><a id="ch05fig12">Figure 5-12:</a> Setting up a wireless network</p>
<p class="indent">Set the network name to something like <em>Apocalypse Survivors</em> so techsavvy survivors can find you easily. Your group of survivors can always benefit from more geeks—especially if it looks like you can run faster than them.</p>
<h5 class="h5" id="ch00lev1sec106"><a id="page_100"/><strong>STEP 2: SET UP THE WI-FI CAMERA</strong></h5>
<p class="noindent">The Wi-Fi camera can’t connect itself to your wireless network without knowing your password and network name. To give it this information, you’ll need to connect to it from a browser, but first it must be connected to the network. This is a bit of a problem. Fortunately, it’s a problem that can be resolved by connecting the Wi-Fi camera to the router using an Ethernet cable. Making a wired connection doesn’t require a password, and the camera should connect to the network using DHCP just like the Raspberry Pi. After you finish the setup, you can disconnect the Ethernet cable, and the Wi-Fi camera will be free!</p>
<p class="indent">Connect the Wi-Fi camera to the router and go back to the same router admin page you used to set up the wireless network. You can use it again to find the IP address of the camera so you can configure it. This time, you’re looking for a page called either DHCP table or ARP (Address Resolution Protocol) table. <a href="ch05.html#ch05fig13">Figure 5-13</a> shows the ARP table for my router.</p>
<div class="image"><img src="graphics/f05-13.jpg" alt="image"/></div>
<p class="figuret"><a id="ch05fig13">Figure 5-13:</a> Finding the IP address of the camera</p>
<p class="indent">The connection to the camera is wired, so the IP address of the camera is either 192.168.1.102 or 192.168.1.100. One of those IP addresses belongs to the Raspberry Pi. Find out which is which by entering the <span class="codestrong">ifconfig</span> command in LXTerminal. You should see one of the two addresses above in the response to the command, and that’s the Raspberry Pi’s address.</p>
<p class="indent">My Raspberry Pi had an IP address of 192.168.1.102, so by process of elimination, my camera’s IP address was 192.168.1.100. Start a new tab on the browser and connect to that IP address, adding :99 after the last number in the address. (I pointed my browser to 192.168.1.100:99.) This extra <a id="page_101"/>number specifies the network port to use for the webcam. In most cases, this is 99, but if you’re using a different camera, then check your documentation because its port may be different.</p>
<div class="note">
<p class="notet"><span class="font1"><strong>NOTE</strong></span></p>
<p class="noindent">Any IP address can have a port number after it like this. Different types of network traffic use different ports. For example, most web traffic uses port 80, which is the default. The webcam happens to use port 99, so this has to be specified in the URL.</p>
</div>
<p class="indent">The browser should immediately start displaying video from the camera as well as the controls to pan and tilt the camera. Somewhere on the page, you should see a settings link. Click on this and look for Wireless LAN Settings. Click <strong>Wireless LAN Settings</strong>, and you should see an option to scan for Wireless Networks (<a href="ch05.html#ch05fig14">Figure 5-14</a>).</p>
<div class="image"><img src="graphics/f05-14.jpg" alt="image"/></div>
<p class="figuret"><a id="ch05fig14">Figure 5-14:</a> Connecting the camera to the wireless network</p>
<p class="indent">Select the <em>Apocalypse Survivors</em> network, enter the password (also called the <em>share key</em>), and click <strong>Submit</strong>. The camera should reboot, and then you can unplug the Ethernet because from now on, the camera will use its Wi-Fi connection.</p>
<p class="indent">Once the camera has switched over to using Wi-Fi, it will also have a different IP address, so return to the router admin page (<a href="ch05.html#ch05fig13">Figure 5-13</a>). This time, there should be an entry in the wireless section of the list representing the camera. Try browsing to the camera using that IP address with :99 on the end. Once again, the video should appear in the browser window along with the camera controls (<a href="ch05.html#ch05fig15">Figure 5-15</a>).</p>
<p class="indent"><a id="page_102"/>One problem with using DHCP to allocate an address to the webcam is that the router may allocate a different IP address if it is restarted. To avoid this problem, look for the option in your router’s DHCP settings that sets the lease time and set this to its maximum. That way, once the IP address is allocated, it shouldn’t change until sometime after civilization has been reestablished.</p>
<div class="image"><img src="graphics/f05-15.jpg" alt="image"/></div>
<p class="figuret"><a id="ch05fig15">Figure 5-15:</a> A view from the Wi-Fi camera</p>
<h4 class="h4" id="ch00lev1sec107"><strong>USING THE WI-FI WEBCAM</strong></h4>
<p class="noindent">Once everything is set up, you can view the image from the webcam by going to the URL for your camera in the browser. The software for most webcams will also allow you to set up multiple cameras and split the screen two or four ways so that you can monitor all the images at once. Then, you can keep tabs on your entrance, supply cache, any zombie traps you’ve built, and the survivors across the street simultaneously!</p>
<p class="indent">You could also access the camera from a mobile browser on a smartphone or tablet computer. There may also be an app for the camera that works better than a browser. This would allow you to work in one area of your compound while keeping an eye on another area using your mobile device. The app provided with the camera I used includes a function to send alerts when movement is detected.</p>
<p class="indent">In the next chapter, you’ll learn how to control an electric door latch. After completing that project, you’ll be able to unlock doors remotely and get inside faster. You’ll also be able to detect when the door opens, just in case the undead begin to overrun your base.</p>
</body></html>