<html><head></head><body><div class="chapter" title="Chapter&#xA0;9.&#xA0;Authentication"><div class="titlepage"><div><div><h1 class="title"><a id="authentication"/>Chapter 9. Authentication</h1></div></div></div><p><a class="indexterm" id="iddle1205"/>Identity is a core concept in any social network, and
          <span class="emphasis"><em>authentication</em></span> is the act of identifying yourself to a system. You
        want users to be able to sign up for new accounts and log into your application. Although
        gems like devise and authlogic provide complete authentication systems for Rails
        applications, in this chapter, you’ll get your hands dirty by building your own system
        instead.</p><p>In addition to the signup, login, and logout actions, you’ll also add methods for
        getting the current logged-in user’s identity and redirecting anonymous users to the
        login page. This authentication system will require controllers and views, so before
        starting, let’s take a moment to add a little style to your site with the Bootstrap
        framework.</p><div class="sidebar"><a id="bootstr_ap"/><p class="title">Bootstrap</p><p><a class="indexterm" id="iddle1071"/><a class="indexterm" id="iddle1074"/><a class="indexterm" id="iddle1237"/><a class="indexterm" id="iddle1256"/><a class="indexterm" id="iddle1260"/><a class="indexterm" id="iddle1303"/><a class="indexterm" id="iddle1504"/><a class="indexterm" id="iddle1507"/><a class="indexterm" id="iddle1608"/><a class="indexterm" id="iddle1615"/><a class="indexterm" id="iddle1766"/><a class="indexterm" id="iddle1819"/><a class="indexterm" id="iddle2349"/>Bootstrap is an open source frontend framework originally created at Twitter.
          It provides a collection of CSS and JavaScript files that you can incorporate into a
          website to provide pleasant typography, a responsive layout that works in both desktop and
          mobile browsers, and features such as modal dialogs, drop-down menus, and tooltips. Full
          documentation for Bootstrap is online at <span class="emphasis"><em><a class="ulink" href="http://getbootstrap.com/">http://getbootstrap.com/</a>.</em></span></p><p>You could download the Bootstrap framework and manually integrate the CSS and
          JavaScript files into your application, but the bootstrap-sass gem can do all of that for
          you. Since you’re already building your own authentication system, save yourself
          some work here—edit your application’s <span class="emphasis"><em>Gemfile</em></span> and add
          this gem.</p><a id="pro_id00270"/><pre class="programlisting"><span class="strong"><strong>gem 'bootstrap-sass'</strong></span></pre><p>Then run the <span class="strong"><strong><code class="literal">bin/bundle install</code></strong></span>
          command to update the installed gems. Now that the gem is installed, you need to make a
          few changes to your CSS and JavaScript files to include Bootstrap. First, update
            <span class="emphasis"><em>app/assets/stylesheets/application.css,</em></span> as shown here:</p><a id="pro_id00271"/><pre class="programlisting">--<span class="emphasis"><em>snip</em></span>-
*= require_tree.
<span class="strong"><strong>*= require bootstrap</strong></span>
*= require_self
*/</pre><p>This code includes the Bootstrap CSS files in your application. Next, include the
          Bootstrap JavaScript files by editing
            <span class="emphasis"><em>app/assets/javascripts/application.js</em></span> and adding this line to the
          end of the file:</p><a id="pro_id00272"/><pre class="programlisting"><span class="strong"><strong>//= require bootstrap</strong></span></pre><p>Finally, update the application layout to use Bootstrap styles. Open the file
            <span class="emphasis"><em>app/ views/layouts/application.html.erb</em></span> and change the contents of
          the body like so:</p><a id="pro_id00273"/><pre class="programlisting"><span class="emphasis"><em>--snip--</em></span>
<span class="strong"><strong>&lt;body&gt;</strong></span>
  <span class="strong"><strong>&lt;div class="container"&gt;</strong></span> ➊
    <span class="strong"><strong>&lt;%= yield %&gt;</strong></span> ➋
  <span class="strong"><strong>&lt;/div&gt;</strong></span>
&lt;/body&gt;
&lt;/html&gt;</pre><p>The <code class="literal">div</code> with <code class="literal">class="container"</code> wraps the
          contents of the page ➊ and provides margins that adjust based on the screen’s
          width, making your site look sharp on both desktop and mobile screens. The
            <code class="literal">yield</code> statement ➋ is used by Rails to insert the contents of
          the view template into the layout.</p><p>Now that you have the stylesheets, JavaScript, and basic layout in place, you are all
          set to start using Bootstrap.</p></div><div class="sect1" title="The Authentication System"><div class="titlepage"><div><div><h1 class="title"><a id="authentication_system"/>The Authentication System</h1></div></div></div><p><a class="indexterm" id="iddle1056"/><a class="indexterm" id="iddle1090"/><a class="indexterm" id="iddle1145"/><a class="indexterm" id="iddle1207"/><a class="indexterm" id="iddle1422"/><a class="indexterm" id="iddle1530"/><a class="indexterm" id="iddle1722"/><a class="indexterm" id="iddle1725"/><a class="indexterm" id="iddle1973"/><a class="indexterm" id="iddle2159"/><a class="indexterm" id="iddle2162"/><a class="indexterm" id="iddle2323"/>The purpose of the authentication system is to identify the current user and
          only display pages the user wants to see or is authorized to see. You’ll use a
          combination of an email address and password to identify users. Email addresses are a good
          choice because they are globally unique. No two people have the same email address.</p><p>In your application, anonymous users are only allowed to see pages for logging in or
          signing up for a new account. Every other page should be restricted.</p><div class="sect2" title="Post Index and Show"><div class="titlepage"><div><div><h2 class="title"><a id="post_index_and_show"/>Post Index and Show</h2></div></div></div><p>Before you start building the authentication system, you need data to protect from
            anonymous users. Let’s add the <code class="literal">index</code> and
              <code class="literal">show</code> pages for the <code class="literal">Post</code> models created in the
            last chapter. First, you need to add controller actions. Open the file
              <span class="emphasis"><em>app/controllers/posts_controller.rb</em></span> in your editor and add these
              <code class="literal">index</code> and <code class="literal">show</code> methods:</p><a id="pro_id00274"/><pre class="programlisting">  class PostsController &lt; ApplicationController
➊   <span class="strong"><strong>def index</strong></span>
         <span class="strong"><strong>@posts = Post.all</strong></span>
    <span class="strong"><strong>end</strong></span>

➋   <span class="strong"><strong>def show</strong></span>
         <span class="strong"><strong>@post = Post.find(params[:id])</strong></span>
    <span class="strong"><strong>end</strong></span>
  end</pre><p>These two actions are similar to the <code class="literal">index</code> and
              <code class="literal">show</code> actions in the blog from <a class="xref" href="ch04.html" title="Chapter 4. Controllers">Chapter 4</a>. The
              <code class="literal">index</code> action ➊ retrieves all posts from the database and
            assigns them to the <code class="literal">@posts</code> variable. It then renders the view at
              <span class="emphasis"><em>app/ views/posts/index.html.erb</em></span>. The <code class="literal">show</code>
            action ➋ finds the requested post using the <code class="literal">id</code> from the
              <code class="literal">params</code> hash, assigns it to <code class="literal">@post</code>, and renders
            the view at <span class="emphasis"><em>app/ views/posts/show.html.erb</em></span>.</p><p>Now you need to create corresponding view templates for these actions. Create a new
            file named <span class="emphasis"><em>app/views/posts/index.html.erb</em></span> and add the following
            code:</p><a id="pro_id00275"/><pre class="programlisting">➊ &lt;div class="page-header"&gt;
    &lt;h1&gt;Home&lt;/h1&gt;
  &lt;/div&gt;

➋ &lt;%= render @posts %&gt;</pre><p>The <code class="literal">index</code> view adds a header ➊ using the Bootstrap
              <code class="literal">page-header</code> class and renders the collection
              <code class="literal">@posts</code> ➋ using partials.</p><p>Because you’re using partials to render the posts, add those next;
            you’ll need a partial for each post type—of which there are two—so you
            need two partial files.</p><p><a class="indexterm" id="iddle1129"/><a class="indexterm" id="iddle1154"/><a class="indexterm" id="iddle1258"/><a class="indexterm" id="iddle1716"/><a class="indexterm" id="iddle1717"/>First, create the file
              <span class="emphasis"><em>app/views/text_posts/_text_post.html.erb</em></span> and open it for
            editing:</p><a id="pro_id00276"/><pre class="programlisting">➊ &lt;div class="panel panel-default"&gt;
➋   &lt;div class="panel-heading"&gt;
      &lt;h3 class="panel-title"&gt;
➌       &lt;%= text_post.title %&gt;
      &lt;/h3&gt;
    &lt;/div&gt;

➍ &lt;div class="panel-body"&gt;
    &lt;p&gt;&lt;em&gt;By &lt;%= text_post.user.name %&gt;&lt;/em&gt;&lt;/p&gt;

    &lt;%= text_post.body %&gt;
  &lt;/div&gt;
&lt;/div&gt;</pre><p>This partial uses Bootstrap’s panel component to display a
              <code class="literal">TextPost</code>. The <code class="literal">panel</code> class ➊ adds a gray
            border around the content. The <code class="literal">panel-heading</code> class ➋ adds a
            light gray background. The <code class="literal">title</code> is then rendered inside an
              <code class="literal">h3</code> element with <code class="literal">&lt;%= text_post.title %&gt;</code>
            ➌. The <code class="literal">panel-body</code> class ➍ adds padding to match the
            heading. The post author and body are rendered in this section.</p><p>Then create the file <span class="emphasis"><em>app/views/image_posts/_image_post.html.erb</em></span>
            with the following content. The <code class="literal">ImagePost</code> partial is just a slight
            variation on the <code class="literal">TextPost</code> partial:</p><a id="pro_id00277"/><pre class="programlisting">  &lt;div class="panel panel-default"&gt;
    &lt;div class="panel-heading"&gt;
      &lt;h3 class="panel-title"&gt;
        &lt;%= image_post.title %&gt;
      &lt;/h3&gt;
     &lt;/div&gt;

     &lt;div class="panel-body"&gt;
       &lt;p&gt;&lt;em&gt;By &lt;%= image_post.user.name %&gt;&lt;/em&gt;&lt;/p&gt;

➊       &lt;%= image_tag image_post.url, class: "img-responsive" %&gt;

       &lt;%= image_post.body %&gt;
   &lt;/div&gt;
 &lt;/div&gt;</pre><p>This partial uses the ERB <code class="literal">image_tag</code> helper to add an image tag
            with the source set to <code class="literal">image_post.url</code> ➊, the location of the
            image. This line also adds Bootstrap’s <code class="literal">img-responsive</code> class to
            the image, which causes it to scale automatically based on the browser width.</p><p>With these views in place, start the Rails server and look at the
            application:</p><a id="pro_id00278"/><pre class="programlisting">$ <span class="strong"><strong>bin/rails server</strong></span></pre><p><a class="indexterm" id="iddle1150"/><a class="indexterm" id="iddle1969"/>Now go to <span class="emphasis"><em>http://localhost:3000/posts</em></span> in your web
            browser. The <code class="literal">Post index</code> view should look similar to <a class="xref" href="ch09.html#post_index_view" title="Figure 9-1. The Post index view">Figure 9-1</a>, depending on how many posts you created in the Rails
            console.</p><div class="figure"><a id="post_index_view"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00015"/><img alt="The Post index view" src="httpatomoreillycomsourcenostarchimages2169088.png.jpg"/></div></div><p class="title">Figure 9-1. The <span class="emphasis"><em>Post index view</em></span></p></div><p>You created two posts in the previous chapter, and your application’s
              <code class="literal">Post index</code> view currently shows those two posts. You didn’t
            add titles in the last chapter, so the headings are blank.</p><p>Now that the <code class="literal">Post</code> partials have been created, the <code class="literal">Post
              show</code> view can also use those partials. Create the new file
              <span class="emphasis"><em>app/views/posts/show.html.erb</em></span> with the following content:</p><a id="pro_id00279"/><pre class="programlisting">  &lt;div class="page-header"&gt;
    &lt;h1&gt;Post&lt;/h1&gt;
  &lt;/div&gt;

➊ &lt;%= render @post %&gt;

  &lt;%= link_to "Home", posts_path,
➋       class: "btn btn-default" %&gt;</pre><p>The <code class="literal">show</code> view is similar to the <code class="literal">index</code> view
            with two exceptions. It renders a single post ➊ instead of a collection of posts,
            and it includes a button ➋ that links back to the posts index page.</p><p>Go to <span class="emphasis"><em>http://localhost:3000/posts/1</em></span> to see it in action, as in
              <a class="xref" href="ch09.html#post_show_view" title="Figure 9-2. The Post show view">Figure 9-2</a>.</p><div class="figure"><a id="post_show_view"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00016"/><img alt="The Post show view" src="httpatomoreillycomsourcenostarchimages2169090.png.jpg"/></div></div><p class="title">Figure 9-2. The <span class="emphasis"><em>Post show view</em></span></p></div><p><a class="indexterm" id="iddle1220"/><a class="indexterm" id="iddle1238"/><a class="indexterm" id="iddle1531"/><a class="indexterm" id="iddle1607"/><a class="indexterm" id="iddle1616"/><a class="indexterm" id="iddle1661"/><a class="indexterm" id="iddle1675"/><a class="indexterm" id="iddle1908"/><a class="indexterm" id="iddle1936"/><a class="indexterm" id="iddle1938"/><a class="indexterm" id="iddle2166"/><a class="indexterm" id="iddle2301"/>Now that the application has actions and views for displaying posts,
            let’s move on to adding authentication to protect these actions from anonymous
            users.</p></div><div class="sect2" title="Sign Up"><div class="titlepage"><div><div><h2 class="title"><a id="sign_up"/>Sign Up</h2></div></div></div><p>Here, you’ll implement a user sign-up process that asks for an email address,
            password, and password confirmation. If the user enters an email address that
            isn’t already in the database and provides passwords that match, the system will
            create a new <code class="literal">User</code> and thank the user for signing up.</p><p>You can already store the new user’s email address because you have a string
            field named <code class="literal">email</code> in the <code class="literal">users</code> table. You need to
            be more careful, however, with passwords. Never store a user’s password in plain
            text. Instead, store a hashed version of the password, known as a <span class="emphasis"><em>password
              digest</em></span>. The secure password feature in Rails provides built-in support for
            password hashing, using a hashing algorithm called bcrypt. Bcrypt is a secure one-way
            hash.</p><p>You can enable the secure password feature by calling the method
              <code class="literal">has_secure_password</code> in a Rails model. This method adds the
              <code class="literal">password</code> and <code class="literal">password_confirmation</code> attributes to
            the model and expects the model to have a string field named
              <code class="literal">password_digest</code>. It adds validations that require matching
              <code class="literal">password</code> and <code class="literal">password_confirmation</code> attributes on
            creation. If these attributes match, it automatically hashes the password and stores it
            in the <code class="literal">password_digest</code> field.</p><p>First, edit your application’s <span class="emphasis"><em>Gemfile</em></span> and add the bcrypt
            gem. Because many applications include an authentication system, a commented-out line is
            already available for this gem. Remove the hash mark at the beginning of that line and
            save the file.</p><a id="pro_id00280"/><pre class="programlisting">gem 'bcrypt', '~&gt; 3.1.7'</pre><p>Anytime you change the <span class="emphasis"><em>Gemfile</em></span>, you also need to run the
              <code class="literal">bin/bundle install</code> command to update the gems installed on your
            system:</p><a id="pro_id00281"/><pre class="programlisting">$ <span class="strong"><strong>bin/bundle install</strong></span></pre><p><a class="indexterm" id="iddle1099"/><a class="indexterm" id="iddle1120"/><a class="indexterm" id="iddle1245"/><a class="indexterm" id="iddle1995"/><a class="indexterm" id="iddle2114"/><a class="indexterm" id="iddle2165"/><a class="indexterm" id="iddle2274"/><a class="indexterm" id="iddle2298"/>The next step is to add the <code class="literal">password_digest</code> field to the
              <code class="literal">users</code> table and run the database migration with <code class="literal">bin/rake
              db:migrate</code> so you can store the user’s hashed password:</p><a id="pro_id00282"/><pre class="programlisting">$ <span class="strong"><strong>bin/rails g migration AddPasswordDigistToUsers password_digest</strong></span></pre><p>Now you need to turn on the secure password feature for the <code class="literal">User</code>
            model. Open <span class="emphasis"><em>app/models/user.rb</em></span> and add the line
              <code class="literal">has_secure_password</code> below the <code class="literal">has_many</code>
            associations you added in the last chapter. While you’re editing that file, also
            add <code class="literal">presence</code> and <code class="literal">uniqueness</code> validations for the
            email field:</p><a id="pro_id00283"/><pre class="programlisting">class User &lt; ActiveRecord::Base
  --<span class="emphasis"><em>snip</em></span>--

  <span class="strong"><strong>has_secure_password</strong></span>

  <span class="strong"><strong>validates :email, presence: true, uniqueness: true</strong></span>
  --<span class="emphasis"><em>snip</em></span>--
end</pre><p>The default route for creating a new user is
              <span class="emphasis"><em>http://localhost:3001/users/new</em></span>. That works, but a custom route
            such as <span class="emphasis"><em>http://localhost:3001/signup</em></span> might be easier to
            remember.</p><p>Edit <span class="emphasis"><em>config/routes.rb</em></span> and add a route for the sign-up page.
            After a user signs up for an account or logs in to your application, you want to
            redirect the user to the home page. So set the <code class="literal">root</code> route to the
              <code class="literal">posts index</code> page while you’re editing this file.</p><a id="pro_id00284"/><pre class="programlisting">Rails.application.routes.draw do
  resources :comments
  resources :image_posts
  resources :text_posts
  resources :posts
  resources :users

  <span class="strong"><strong>get 'signup', to: 'users#new', as: 'signup'</strong></span>

  <span class="strong"><strong>root 'posts#index'</strong></span>
end</pre><p>Open <span class="emphasis"><em>app/controllers/users_controller.rb</em></span> and add the necessary
            actions to <code class="literal">UsersController</code> for creating new
            <code class="literal">Users</code>:</p><a id="pro_id00285"/><pre class="programlisting">  class UsersController &lt; ApplicationController
➊   <span class="strong"><strong>def new</strong></span>
      <span class="strong"><strong>@user = User.new</strong></span>
    <span class="strong"><strong>end</strong></span>

➋   <span class="strong"><strong>def create</strong></span>
      <span class="strong"><strong>@user = User.new(user_params)</strong></span>
      <span class="strong"><strong>if @user.save</strong></span>
      <span class="strong"><strong>redirect_to root_url,</strong></span>
        <span class="strong"><strong>notice: "Welcome to the site!"</strong></span>
    <span class="strong"><strong>else</strong></span>
      <span class="strong"><strong>render "new"</strong></span>
    <span class="strong"><strong>end</strong></span>
  <span class="strong"><strong>end</strong></span>

  <span class="strong"><strong>private</strong></span>

  <span class="strong"><strong>def user_params</strong></span>
    <span class="strong"><strong>params.require(:user).permit(:name, :email, :password,</strong></span>
                                 <span class="strong"><strong>:password_confirmation)</strong></span>
  <span class="strong"><strong>end</strong></span>
<span class="strong"><strong>end</strong></span></pre><p><a class="indexterm" id="iddle1160"/><a class="indexterm" id="iddle2164"/>The <code class="literal">new</code> method ➊ instantiates an empty new
              <code class="literal">User</code> object and renders the sign-up form. The
              <code class="literal">create</code> method ➋ instantiates a <code class="literal">User</code>
            object using the parameters passed from the form. Then, if the user can be saved, it
            redirects the user to the root of the site and displays a welcome message. Otherwise, it
            renders the new user form again.</p><p>Now that the controller actions are in place, add the sign-up form in
              <span class="emphasis"><em>app/views/users/new.html.erb:</em></span></p><a id="pro_id00286"/><pre class="programlisting">   &lt;div class="page-header"&gt;
    &lt;h1&gt;Sign Up&lt;/h1&gt;
  &lt;/div&gt;

  &lt;%= form_for(@user) do |f| %&gt;
➊   &lt;% if @user.errors.any? %&gt;
      &lt;div class="alert alert-danger"&gt;
        &lt;strong&gt;
          &lt;%= pluralize(@user.errors.count, "error") %&gt;
          prevented you from signing up:
        &lt;/strong&gt;
        &lt;ul&gt;
          &lt;% @user.errors.full_messages.each do |msg| %&gt;
            &lt;li&gt;&lt;%= msg %&gt;&lt;/li&gt;
          &lt;% end %&gt;
        &lt;/ul&gt;
      &lt;/div&gt;
    &lt;% end %&gt;

➋   &lt;div class="form-group"&gt;
      &lt;%= f.label :email %&gt;
➌     &lt;%= f.email_field :email, class: "form-control" %&gt;
    &lt;/div&gt;
    &lt;div class="form-group"&gt;
      &lt;%= f.label :password %&gt;
      &lt;%= f.password_field :password, class: "form-control" %&gt;
    &lt;/div&gt;
    &lt;div class="form-group"&gt;
      &lt;%= f.label :password_confirmation %&gt;
      &lt;%= f.password_field :password_confirmation,
        class: "form-control" %&gt;
    &lt;/div&gt;

    &lt;%= f.submit class: "btn btn-primary" %&gt;
  &lt;% end %&gt;</pre><p><a class="indexterm" id="iddle1047"/><a class="indexterm" id="iddle1257"/><a class="indexterm" id="iddle1577"/>The first half of this form displays error messages ➊, if any. The
            form uses a <code class="literal">div</code> with the Bootstrap class
              <code class="literal">form-group</code> to group labels and inputs ➋, and adds the class
              <code class="literal">form-control</code> to input controls ➌. Bootstrap uses these
            classes to apply styles to the form.</p><p>Go to <span class="emphasis"><em>http://localhost:3000/signup</em></span> in your web browser to see
            the sign-up form, as in <a class="xref" href="ch09.html#sign-up_form" title="Figure 9-3. The sign-up form">Figure 9-3</a>.</p><div class="figure"><a id="sign-up_form"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00017"/><img alt="The sign-up form" src="httpatomoreillycomsourcenostarchimages2169092.png.jpg"/></div></div><p class="title">Figure 9-3. The sign-up form</p></div><p>In the <code class="literal">create</code> action, you added a flash message to welcome new
            users, but your views don’t have a place for displaying flash messages yet.
            Bootstrap includes an <code class="literal">alert</code> class that’s perfect for displaying
            flash messages. Open the application layout at
              <span class="emphasis"><em>app/views/layouts/application.html.erb</em></span> and add a section for
            flash messages, as shown here:</p><a id="pro_id00287"/><pre class="programlisting"> --<span class="emphasis"><em>snip</em></span>--
 &lt;body&gt;
   &lt;div class="container"&gt;
➊    <span class="strong"><strong>&lt;% if notice %&gt;</strong></span>
       <span class="strong"><strong>&lt;div class="alert alert-success"&gt;&lt;%= notice %&gt;&lt;/div&gt;</strong></span>
     <span class="strong"><strong>&lt;% end %&gt;</strong></span>
➋    <span class="strong"><strong>&lt;% if alert %&gt;</strong></span>
       <span class="strong"><strong>&lt;div class="alert alert-danger"&gt;&lt;%= alert %&gt;&lt;/div&gt;</strong></span>
     <span class="strong"><strong>&lt;% end %&gt;</strong></span>

     &lt;%= yield %&gt;
   &lt;/div&gt;
 &lt;/body&gt;
 &lt;/html&gt;</pre><p><a class="indexterm" id="iddle1048"/><a class="indexterm" id="iddle1049"/><a class="indexterm" id="iddle1050"/><a class="indexterm" id="iddle1209"/><a class="indexterm" id="iddle1809"/><a class="indexterm" id="iddle1892"/><a class="indexterm" id="iddle2151"/><a class="indexterm" id="iddle2293"/>This application uses two different kinds of flash messages: A
              <code class="literal">notice</code> message ➊ indicates success. A
              <code class="literal">notice</code> is shown in green using Bootstrap’s
              <code class="literal">alert-success</code> class. An <code class="literal">alert</code> message ➋
            indicates an error. An <code class="literal">alert</code> is shown in red using the Bootstrap
              <code class="literal">alert-danger</code> class.</p><p>In the last chapter, you didn’t add email addresses or passwords to the users
            you created. If you want to log in using <code class="literal">alice</code> or
              <code class="literal">bob</code>, you can update their accounts in the Rails console.</p><a id="pro_id00288"/><pre class="programlisting">➊ irb(main):001:0&gt; <span class="strong"><strong>alice = User.find(1)</strong></span>
    User Load ...
   =&gt; #&lt;User id: 1, name: "Alice", ...&gt;
➋ irb(main):002:0&gt; <span class="strong"><strong>alice.email = "alice@example.com"</strong></span>
   =&gt; "alice@example.com"
  irb(main):003:0&gt; <span class="strong"><strong>alice.password = "password"</strong></span>
   =&gt; "password"
  irb(main):004:0&gt; <span class="strong"><strong>alice.password_confirmation = "password"</strong></span>
   =&gt; "password"
➌ irb(main):005:0&gt; <span class="strong"><strong>alice.save</strong></span>
    --<span class="emphasis"><em>snip</em></span>--
   =&gt; true</pre><p>After starting the Rails console with <code class="literal">bin/rails console</code>, find the
              <code class="literal">User</code> by <code class="literal">id</code> ➊. Then assign values for the
              <code class="literal">email</code>, <code class="literal">password</code>, and
              <code class="literal">password_confirmation</code> ➋. Finally, save the
              <code class="literal">User</code> with <code class="literal">alice.save</code> ➌. Repeat these
            steps for the other <code class="literal">User</code>. Make sure the <code class="literal">email</code> for
            each user is unique.</p><p>Now that you’ve seen how to create a form for users to sign up for an account,
            let’s explore how to let them log in.</p></div><div class="sect2" title="Log In"><div class="titlepage"><div><div><h2 class="title"><a id="log_in"/>Log In</h2></div></div></div><p>A user signing up for an account fills out a form like the one in <a class="xref" href="ch09.html#sign-up_form" title="Figure 9-3. The sign-up form">Figure 9-3</a> and creates a new user record in the database. On the other
            hand, there is no model that represents a login, and a login doesn’t create a
            record in the database. Instead, the user’s identity is stored in the
              <span class="emphasis"><em>session</em></span>, a small amount of data used to identify requests from a
            particular browser to the web server.</p><div class="sect3" title="Sessions"><div class="titlepage"><div><div><h3 class="title"><a id="sessions"/>Sessions</h3></div></div></div><p>In general, web servers are <span class="emphasis"><em>stateless</em></span>. That is, they
              don’t remember the identity of a user from one request to the next. You must add
              this functionality, which you do by storing the currently logged-in user’s
                <code class="literal">user_id</code> in the session.</p><p>Rails stores session information in a cookie by default. Session cookies are
              signed and encrypted to prevent tampering. Users can’t see the data stored in
              their session cookie.</p><p><a class="indexterm" id="iddle1151"/><a class="indexterm" id="iddle1811"/>Session values in Rails are stored using key-value pairs, and
              they’re accessed like a hash:</p><a id="pro_id00289"/><pre class="programlisting">session[:user_id] = @user.id</pre><p>This command stores <code class="literal">@user.id</code> in a cookie on the current
              user’s computer. That cookie is automatically sent to the server with every
              request to your application.</p><p>When a user successfully logs in to your site, you need to store the
                <code class="literal">user_id</code> in the <code class="literal">session</code>. Then you look for a
                <code class="literal">user_id</code> in the <code class="literal">session</code> on every request. If a
                <code class="literal">user_id</code> is found and a <code class="literal">User</code> record matches
              that <code class="literal">id</code>, then you know that user is authenticated. Otherwise, you
              should redirect the user to the login page.</p></div><div class="sect3" title="Implementation"><div class="titlepage"><div><div><h3 class="title"><a id="implementation"/>Implementation</h3></div></div></div><p>Now let’s implement the login process. First, use the Rails generator to
              create a <code class="literal">sessions</code> controller:</p><a id="pro_id00290"/><pre class="programlisting">$ <span class="strong"><strong>bin/rails g controller Sessions</strong></span></pre><p>Next, open <span class="emphasis"><em>config/routes.rb</em></span>. Add a new resource called
                <code class="literal">:sessions</code> and add routes for login and logout:</p><a id="pro_id00291"/><pre class="programlisting">Rails.application.routes.draw do
  resources :comments
  resources :image_posts
  resources :text_posts
  resources :posts
  resources :users
  <span class="strong"><strong>resources :sessions</strong></span>

  get 'signup', to: 'users#new', as: 'signup'

  <span class="strong"><strong>get 'login', to: 'sessions#new', as: 'login'</strong></span>
  <span class="strong"><strong>get 'logout', to: 'sessions#destroy', as: 'logout'</strong></span>

  root 'posts#index'
end</pre><p>Now, create a new file named <span class="emphasis"><em>app/views/sessions/new.html.erb</em></span>
              and add the login form:</p><a id="pro_id00292"/><pre class="programlisting">  &lt;div class="page-header"&gt;
    &lt;h1&gt;Log In&lt;/h1&gt;
  &lt;/div&gt;
➊ &lt;%= form_tag sessions_path do %&gt;
    &lt;div class="form-group"&gt;
      &lt;%= label_tag :email %&gt;
      &lt;%= email_field_tag :email, params[:email],
        class: "form-control" %&gt;
    &lt;/div&gt;
    &lt;div class="form-group"&gt;
      &lt;%= label_tag :password %&gt;
      &lt;%= password_field_tag :password, nil,
        class: "form-control" %&gt;
    &lt;/div&gt;
    &lt;%= submit_tag "Log In", class: "btn btn-primary" %&gt;
&lt;% end %&gt;</pre><p><a class="indexterm" id="iddle1399"/><a class="indexterm" id="iddle1492"/><a class="indexterm" id="iddle1592"/><a class="indexterm" id="iddle1878"/>Notice that I’m using <code class="literal">form_tag</code> ➊ here
              instead of <code class="literal">form_for</code>. The sign-up process used
                <code class="literal">form_for</code> because that form was associated with the
                <code class="literal">User</code> model. Use <code class="literal">form_tag</code> now because the login
              form is not associated with a model.</p><p>The sessions controller handles login and logout. Edit <span class="emphasis"><em>app/controllers/
                sessions_controller.rb</em></span> to add these actions:</p><a id="pro_id00293"/><pre class="programlisting">  class SessionsController &lt; ApplicationController
➊   <span class="strong"><strong>def new</strong></span>
    <span class="strong"><strong>end</strong></span>

➋   <span class="strong"><strong>def create</strong></span>
      <span class="strong"><strong>user = User.find_by(email: params[:email])</strong></span>
      <span class="strong"><strong>if user &amp;&amp; user.authenticate(params[:password])</strong></span>
        <span class="strong"><strong>session[:user_id] = user.id</strong></span>
        <span class="strong"><strong>redirect_to root_url, notice: "Log in successful!"</strong></span>
      <span class="strong"><strong>else</strong></span>
        <span class="strong"><strong>flash.now.alert = "Invalid email or password"</strong></span>
        <span class="strong"><strong>render "new"</strong></span>
      <span class="strong"><strong>end</strong></span>
    <span class="strong"><strong>end</strong></span>

➌   <span class="strong"><strong>def destroy</strong></span>
      <span class="strong"><strong>session[:user_id] = nil</strong></span>
      <span class="strong"><strong>redirect_to root_url, notice: "Log out successful!"</strong></span>
    <span class="strong"><strong>end</strong></span>
  end</pre><p>The <code class="literal">new</code> method ➊ renders the login form. The controller
              action doesn’t need to do anything. Remember that actions render a view file
              matching their name by default. In this case, the <code class="literal">new</code> method
              renders the view at <span class="emphasis"><em>/app/views/sessions/new.html.erb</em></span>. The
                <code class="literal">create</code> method ➋ looks for a user record by email address.
              If it finds a matching user and that user can be authenticated with the provided
              password, it stores the <code class="literal">user_id</code> in the session and redirects to the
              home page. Otherwise, it adds an error message to the flash and redisplays the login
              form. The <code class="literal">destroy</code> method ➌ clears the
                <code class="literal">user_id</code> stored in the session and redirects to the home
              page.</p><p><a class="indexterm" id="iddle1080"/><a class="indexterm" id="iddle1423"/><a class="indexterm" id="iddle1425"/>Go to <span class="emphasis"><em>http://localhost:3000/login</em></span> to see the login
              form shown in <a class="xref" href="ch09.html#login_form" title="Figure 9-4. The login form">Figure 9-4</a>.</p><div class="figure"><a id="login_form"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00018"/><img alt="The login form" src="httpatomoreillycomsourcenostarchimages2169094.png.jpg"/></div></div><p class="title">Figure 9-4. The login form</p></div><p>Users can log in and log out now, but the rest of the application has no way to
              know anything about the current user. As you add features to the application, the
              identity of the current user will be used frequently. For example, the application
              uses the current user to decide which posts to display and to assign ownership to any
              new posts or comments created. Now let’s add the methods needed to make the
              authentication system available to the rest of the application.</p></div></div><div class="sect2" title="Current User"><div class="titlepage"><div><div><h2 class="title"><a id="current_user"/>Current User</h2></div></div></div><p>First, you need to be able to identify the currently logged-in user. Add the
              <code class="literal">current_user</code> method to <code class="literal">ApplicationController</code> in
              <span class="emphasis"><em>app/controllers/application _controller.rb</em></span> and make it a
              <code class="literal">helper</code> method. That way, it will be available in all controllers
            and views, laying the groundwork for other parts of the app to access the currently
            logged-in user:</p><a id="pro_id00294"/><pre class="programlisting">class ApplicationController &lt; ActionController::Base
  # Prevent CSRF attacks by raising an exception.
  # For APIs, you may want to use :null_session instead.
  protect_from_forgery with: :exception

  <span class="strong"><strong>private</strong></span>

  <span class="strong"><strong>def current_user</strong></span>
    <span class="strong"><strong>if session[:user_id]</strong></span>
       <span class="strong"><strong>@current_user ||= User.find(session[:user_id])</strong></span>
    <span class="strong"><strong>end</strong></span>
  <span class="strong"><strong>end</strong></span>
  <span class="strong"><strong>helper_method :current_user</strong></span>
end</pre><p><a class="indexterm" id="iddle1057"/><a class="indexterm" id="iddle1106"/><a class="indexterm" id="iddle1136"/><a class="indexterm" id="iddle1202"/><a class="indexterm" id="iddle1212"/><a class="indexterm" id="iddle1226"/><a class="indexterm" id="iddle2299"/>The <code class="literal">current_user</code> method returns a <code class="literal">User</code>
            object representing the currently logged-in user. This method returns
              <code class="literal">nil</code> when no one is logged in, so you can also use it in conditional
            statements that should have different results when no user is logged in.</p><p>For example, use the <code class="literal">current_user</code> method to add a logout link
            when a user is logged in or show links to log in and sign up when no one is logged in.
            Open <span class="emphasis"><em>app/views/layouts/application.html.erb</em></span> and add this code just
            above the <code class="literal">yield</code> statement:</p><a id="pro_id00295"/><pre class="programlisting">    <span class="emphasis"><em>--snip--</em></span>
    <span class="strong"><strong>&lt;div class="pull-right"&gt;</strong></span>
      <span class="strong"><strong>&lt;% if current_user %&gt;</strong></span>
        <span class="strong"><strong>&lt;%= link_to 'Log Out', logout_path %&gt;</strong></span>
      <span class="strong"><strong>&lt;% else %&gt;</strong></span>
        <span class="strong"><strong>&lt;%= link_to 'Log In', login_path %&gt; or</strong></span>
        <span class="strong"><strong>&lt;%= link_to 'Sign Up', signup_path %&gt;</strong></span>
      <span class="strong"><strong>&lt;% end %&gt;</strong></span>
    <span class="strong"><strong>&lt;/div&gt;</strong></span>

    &lt;%= yield %&gt;
  &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</pre><p>Now logged-in users should see a link to log out, and anonymous users should see
            links to either log in or sign up.</p></div><div class="sect2" title="Authenticate User"><div class="titlepage"><div><div><h2 class="title"><a id="authenticate_user"/>Authenticate User</h2></div></div></div><p>In any social app, certain pages should not be available to anonymous users. The
            last thing you need is a way to restrict pages so only authenticated users can view
            them. You can do this with the Rails <code class="literal">before_action</code> method.</p><p>A <code class="literal">before_action</code> is a method that runs automatically before any
            other action in the controller. These methods are sometimes used to remove duplication
            by loading data needed by several different actions. A <code class="literal">before_action</code>
            can also halt the current request by rendering or redirecting to another
            location.</p><p>Create a method named <code class="literal">authenticate_user!</code> that redirects to the
            login page if there is no current user. Add this method to the
              <code class="literal">ApplicationController</code> in
              <span class="emphasis"><em>app/controllers/application_controller.rb</em></span> so it is available in
            all controllers:</p><a id="pro_id00296"/><pre class="programlisting">class ApplicationController &lt; ActionController::Base
  # Prevent CSRF attacks by raising an exception.
  # For APIs, you may want to use :null_session instead.
  protect_from_forgery with: :exception

  private

  def current_user
    if session[:user_id]
      @current_user ||= User.find(session[:user_id])
    end
  end
  helper_method :current_user

  <span class="strong"><strong>def authenticate_user!</strong></span>
    <span class="strong"><strong>redirect_to login_path unless current_user</strong></span>
  <span class="strong"><strong>end</strong></span>
end</pre><p><a class="indexterm" id="iddle1424"/><a class="indexterm" id="iddle1671"/><a class="indexterm" id="iddle1698"/><a class="indexterm" id="iddle1792"/><a class="indexterm" id="iddle2255"/><a class="indexterm" id="iddle2256"/>Because you set the <code class="literal">posts index</code> page as the home page of
            your application, let’s try this method in the posts controller. Open the file
              <span class="emphasis"><em>app/controllers/posts_controller.rb</em></span> and add a
              <code class="literal">before_action</code>:</p><a id="pro_id00297"/><pre class="programlisting">class PostsController &lt; ApplicationController
  <span class="strong"><strong>before_action :authenticate_user!</strong></span>

  --<span class="emphasis"><em>snip</em></span>--
end</pre><p>Now if an anonymous user tries to access the home page, he or she should be
            redirected to the login page automatically. Be sure you don’t add this
              <code class="literal">before_action</code> to the sessions page. If you do, anonymous users
            won’t be able to access the login page!</p></div><div class="sect2" title="Use Current User"><div class="titlepage"><div><div><h2 class="title"><a id="use_current_user"/>Use Current User</h2></div></div></div><p>Now that your application knows who’s logged in, you can change the home page
            to display only posts authored by the current user or anyone the current user is
            following. This type of home page is usually arranged in chronological order and called
            a <span class="emphasis"><em>timeline</em></span>.</p><p>The first thing you need to do is add a method to the <code class="literal">User</code> model
            to return a <code class="literal">user_id</code> list that you can use to query posts. Let’s
            call this method <code class="literal">timeline_user_ids</code>. Open the file
              <span class="emphasis"><em>app/models/user.rb</em></span> and add this method near the end:</p><a id="pro_id00298"/><pre class="programlisting">--<span class="emphasis"><em>snip</em></span>--

  <span class="strong"><strong>def timeline_user_ids</strong></span>
➊   <span class="strong"><strong>leader_ids + [id]</strong></span>
  <span class="strong"><strong>end</strong></span>
end</pre><p>The <code class="literal">has_many :leaders</code> association added in <a class="xref" href="ch08.html" title="Chapter 8. Advanced Active Record">Chapter 8</a> automatically adds a method called
              <code class="literal">leader_ids</code> that returns an array of the <code class="literal">id</code>
            values of this user’s leaders—or the people whose posts the user is
            following. The <code class="literal">timeline_user_ids</code> method adds the current user’s
              <code class="literal">id</code> to the array returned by <code class="literal">leader_ids</code> and
            returns the new array ➊, which should contain every user you want to display on
            the timeline.</p><p><a class="indexterm" id="iddle1917"/>Now open <span class="emphasis"><em>app/controllers/posts_controller.rb</em></span> and update
            the <code class="literal">index</code> action to use this method:</p><a id="pro_id00299"/><pre class="programlisting">def index
  <span class="strong"><strong>user_ids = current_user.timeline_user_ids</strong></span>
  <span class="strong"><strong>@posts = Post.where(user_id: user_ids)</strong></span>
             <span class="strong"><strong>.order("created_at DESC")</strong></span>
end</pre><p>Instead of just fetching every post with <code class="literal">Post.all</code>, the
              <code class="literal">index</code> action first obtains the list of <code class="literal">user_ids</code>
            returned by <code class="literal">current_user.timeline_user_ids</code>. It then initializes
              <code class="literal">@posts</code> to include every post that should be in the timeline based
            on those ids. Also add an <code class="literal">order</code> clause because timelines are shown in
            reverse chronological order.</p><p>Log in to see the <code class="literal">Post index</code> page in <a class="xref" href="ch09.html#post_index_view_after_login" title="Figure 9-5. The Post index view after login">Figure 9-5</a>.</p><div class="figure"><a id="post_index_view_after_login"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00019"/><img alt="The Post index view after login" src="httpatomoreillycomsourcenostarchimages2169096.png.jpg"/></div></div><p class="title">Figure 9-5. The Post index view after login</p></div><p>Click the Log Out link and confirm that you’re redirected to the Log In
            page.</p></div></div><div class="sect1" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="summary-id00021"/>Summary</h1></div></div></div><p>Your application is really starting to take shape now. You have some pretty
          good-looking styles in place thanks to Bootstrap. Users can now sign up, log in, and log
          out. You can also restrict access to pages based on whether a user is
          authenticated.</p><p>You’ve written a lot of code, but so far you’ve only tested it by clicking
          around in the browser. This isn’t too bad when you only have a few actions to test.
          As the number of actions in your application grows, however, this sort of testing gets
          tedious.</p><p>In the next chapter, you’ll learn about automated testing of models and
          controllers. We’ll look at the default test framework already included by Rails,
          write tests for various parts of the application, and learn a little about test-driven
          development.</p></div><div class="sect1" title="Exercises"><div class="titlepage"><div><div><h1 class="title"><a id="exercises-id00022"/>Exercises</h1></div></div></div><div class="qandaset" title="Frequently Asked Questions"><a id="ch09qa1"/><table border="0" summary="Q and A Set" width="100%"><col align="left" width="1%"/><col/><tbody><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch09qa1qe1"/><a id="ch09qa1q1"/><p>Q:</p></td><td align="left" valign="top"><p>1. You added a post <code class="literal">show</code> action and view, but currently you
                can’t get to the page for an individual post without typing in the URL. Use
                the Rails <code class="literal">time_ago_in_words</code> helper to create a link to the post
                in the <code class="literal">TextPost</code> and <code class="literal">ImagePost</code> partials based
                on the <code class="literal">created_at</code> field.</p></td></tr><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch09qa1qe2"/><a id="ch09qa1q2"/><p>Q:</p></td><td align="left" valign="top"><p>2. Add comments to posts. The process is similar to adding comments to the blog
                at the end of <a class="xref" href="ch05.html" title="Chapter 5. Views">Chapter 5</a>. First, update the post
                  <code class="literal">show</code> page at <span class="emphasis"><em>app/views/posts/show.html.erb</em></span>
                to render a collection of comments and a form for adding a new comment at the bottom
                as shown here:</p><a id="pro_id00300"/><pre class="programlisting">  <span class="emphasis"><em>--snip--</em></span>

  <span class="strong"><strong>&lt;h3&gt;Comments&lt;h3&gt;</strong></span>
  <span class="strong"><strong>&lt;%= render @post.comments %&gt;</strong></span>

  <span class="strong"><strong>&lt;h4&gt;New Comment&lt;/h4&gt;</strong></span>
  <span class="strong"><strong>&lt;%= form_for @post.comments.build do |f| %&gt;</strong></span>
    <span class="strong"><strong>&lt;div class="form-group"&gt;</strong></span>
      <span class="strong"><strong>&lt;%= f.label :body %&gt;&lt;br&gt;</strong></span>
      <span class="strong"><strong>&lt;%= f.text_area :body, class: "form-control" %&gt;</strong></span>
    <span class="strong"><strong>&lt;/div&gt;</strong></span>
➊   <span class="strong"><strong>&lt;%= f.hidden_field :post_id %&gt;</strong></span>
    <span class="strong"><strong>&lt;%= f.submit class: "btn btn-primary" %&gt;</strong></span>
  <span class="strong"><strong>&lt;% end %&gt;</strong></span></pre><p>The form includes the <code class="literal">post_id</code> of the current post in a hidden
                field ➊. Next, add the <code class="literal">create</code> action to
                  <code class="literal">CommentsController</code> at <span class="emphasis"><em>app/controllers/
                  comments_controller.rb:</em></span></p><a id="pro_id00301"/><pre class="programlisting"><span class="strong"><strong>def create</strong></span>
  <span class="strong"><strong>@comment = current_user.comments.build(comment_params)</strong></span>

  <span class="strong"><strong>if @comment.save</strong></span>
    <span class="strong"><strong>redirect_to post_path(@comment.post_id),</strong></span>
                <span class="strong"><strong>notice: 'Comment was successfully created.'</strong></span>
  <span class="strong"><strong>else</strong></span>
    <span class="strong"><strong>redirect_to post_path(@comment.post_id),</strong></span>
                <span class="strong"><strong>alert: 'Error creating comment.'</strong></span>
  <span class="strong"><strong>end</strong></span>
<span class="strong"><strong>end</strong></span></pre><p>Also add the private <code class="literal">comment_params</code> method to
                  <code class="literal">CommentsController</code>. In addition to the comment
                  <code class="literal">body</code>, also permit the <code class="literal">post_id</code> passed in
                  <code class="literal">params</code>:</p><a id="pro_id00302"/><pre class="programlisting"><span class="strong"><strong>def comment_params</strong></span>
  <span class="strong"><strong>params.require(:comment).permit(:body, :post_id)</strong></span>
<span class="strong"><strong>end</strong></span></pre><p>Make sure only authenticated users can access this controller. Finally, create
                the comment partial <span class="emphasis"><em>app/views/comments/_comment.html.erb</em></span>. This
                partial needs to show the name of the user who added the comment and the
                comment’s body.</p></td></tr><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch09qa1qe3"/><a id="ch09qa1q3"/><p>Q:</p></td><td align="left" valign="top"><p>3. How secure is the authentication system? Look at the
                  <code class="literal">password_digest</code> field for a <code class="literal">User</code>. Also,
                examine the cookie placed on your computer after you log in to the application. Can
                you figure out the data contained in either of these?</p></td></tr></tbody></table></div></div></div></body></html>