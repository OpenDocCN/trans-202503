<html><head></head><body>
<div id="sbo-rt-content" class="calibre1"><section aria-labelledby="ch22" epub:type="chapter" role="doc-chapter">
<hgroup>
<h2 class="title" id="ch22">
<span class="cn"><span aria-label=" Page 259. " epub:type="pagebreak" id="pg_259" role="doc-pagebreak" class="calibre2"/><span class="sans_dogma_ot_bold_b_">22</span></span>
<span class="ct1"><span class="sans_dogma_ot_bold_b_">WRITING REPORTS</span></span>
</h2>
</hgroup>
<figure class="opener"><img alt="" class="opener1" height="407" src="../images/chapter.jpg" width="408"/>
</figure>
<p class="chapterintro">Even if squinting hard enough to provoke an aneurysm, no one will ever mistake Batch for Power BI or other similar report writers, but when you want a simple formatted text report, Batch is one tool that’s up to the challenge.</p>
<p class="tx">In this chapter, we’ll build a report with real-world data from a pipe-delimited input file. With two pseudo-environment variables from the previous chapter, you’ll learn how to build a title with the current date and time, and formatted column headers. You’ll also create detail records by reading the input file with a certain command you learned about in <span class="xref"><a href="part2.xhtml" class="calibre3">Part II</a></span>. I’ll share a few techniques for right- and left-justifying strings, integers, and floating-point data into nicely aligned columns when viewed in a fixed-width or monospace font. Finally, you’ll learn how to tally the data to create trailer records with total and average quantities.</p>
<p class="tx">And if you are looking to generate a pie graph, histogram, or scatter- plot ... there are other tools.</p>
<section aria-labelledby="sec1" epub:type="division">
<h3 class="h" id="sec1"><span id="h1-151"/><span aria-label=" Page 260. " epub:type="pagebreak" id="pg_260" role="doc-pagebreak"/><span class="sans_futura_std_bold_b_">The Data and Report</span></h3>
<p class="tni">For this exercise, we’ll start with a simple pipe-delimited file containing three important health measures for a short list of selected wealthy countries from the year 2019. The first token in each record is the name of a country, followed by the percentage of the country’s gross domestic product spent on healthcare. This is a great measure of how much money a country spends on healthcare out of its overall wealth. The third token is life expectancy, and the final is the number of avoidable deaths for every 100,000 residents. Avoidable deaths are defined as deaths resulting from a lack of access to effective and quality healthcare for conditions such as diabetes, hypertension, and certain cancers. These last two measures are very good indicators of the effectiveness of a healthcare system. The <i class="calibre6">HealthStats.dat</i> file can hold any number of records, but for brevity’s sake, I’m including only seven countries and their statistics, as shown in <a href="#Lis22-1" class="calibre3">Listing 22-1</a>.</p>
<span id="Lis22-1"/>
<pre class="pre"><code class="calibre11">Australia|9.3|82.6|62
Canada|10.7|82|72
France|11.2|82.6|60
Germany|11.2|81.1|86
Sweden|11|82.5|65
UK|9.8|81.3|84
US|16.9|78.6|112
</code></pre>
<p class="listingcaption"><span class="futura_std_book_oblique_i_">Listing 22-1: The pipe-delimited</span> <span class="sans_futura_std_book_">HealthStats.dat</span> <span class="futura_std_book_oblique_i_">file containing health statistics</span></p>
<p class="tni">Notice that the first two numeric tokens are floating-point values, but someone (me) didn’t include the <span class="sans_thesansmonocd_w5regular_">.0</span> for a couple of entries’ values. We’ll have to take that into account in the code. (The data in this file is from the Commonwealth Fund, used with permission, at <i class="calibre6"><a href="https://www.commonwealthfund.org/publications/issue-briefs/2020/jan/us-health-care-global-perspective-2019" class="calibre3">https://<wbr/>www<wbr/>.commonwealthfund<wbr/>.org<wbr/>/publications<wbr/>/issue<wbr/>-briefs<wbr/>/2020<wbr/>/jan<wbr/>/us<wbr/>-health<wbr/>-care<wbr/>-global<wbr/>-perspective<wbr/>-2019</a></i>.)</p>
<p class="tx">It’s wonderful data, but pipe-delimited files are not known for their readability. Our task is to convert the data in <a href="#Lis22-1" class="calibre3">Listing 22-1</a> into the far more readable and descriptive report shown in <a href="#Lis22-2" class="calibre3">Listing 22-2</a>.</p>
<span id="Lis22-2"/>
<pre class="pre"><code class="calibre11">           A Comparison of National Health
            Expenditures and Outcomes, 2019
             Date: 03/23/2020  Time: 14:30

                 % of           Life          Avoidable
Country          GDP         Expectancy      Deaths/100K
-------          ----        ----------      ----------- 
Australia         9.3           82.6              62
Canada           10.7           82.0              72
France           11.2           82.6              60
Germany          11.2           81.1              86
Sweden           11.0           82.5              65
UK                9.8           81.3              84
US               16.9           78.6             112
-------          ----        ----------      -----------
Averages         11.4           81.5              77
</code></pre>
<p class="listingcaption"><span class="futura_std_book_oblique_i_">Listing 22-2: The</span> <span class="sans_futura_std_book_">HealthRpt.txt</span> <span class="futura_std_book_oblique_i_">bat file–generated report</span></p>
<p class="tx"><span aria-label=" Page 261. " epub:type="pagebreak" id="pg_261" role="doc-pagebreak"/>At worst, you might call this report functional. It doesn’t have the different font sizes, boxes, highlighting, automatic centering, or other features you might find in an HTML-created report viewed in a browser, but it’s useful, informative, and well-formatted.</p>
<p class="tx">A report such as this has three distinct parts: introduction, body, and summary, consisting of header, detail, and trailer records, respectively. I’ll share the entire bat file to build this report, but I’ll break it down into those three parts. At the conclusion of this chapter, you’ll be able to build your own data files and create your own reports.</p>
</section>
<section aria-labelledby="sec2" epub:type="division">
<h3 class="h" id="sec2"><span id="h1-152"/><span class="sans_futura_std_bold_b_">Header Records</span></h3>
<p class="tni">The obvious place to start is with the introduction, which consists of the title and column headers. Here’s the first part of the bat file that creates the report:</p>
<pre class="pre"><code class="calibre11">setlocal EnableExtensions EnableDelayedExpansion
<span aria-label="annotation1" class="codeannotationhang">❶</span> set rpt=C:\Batch\HealthRpt.txt
<span aria-label="annotation2" class="codeannotationhang">❷</span><span class="sans_thesansmonocd_w5regular_"> set cnt=0</span>
set totPerGDP=0
set totLifeExp=0
set totDeaths=0

<span aria-label="annotation3" class="codeannotationhang">❸</span> &gt;  %rpt% echo              A Comparison of National Health
&gt;&gt; %rpt% echo             Expenditures and Outcomes, 2019
&gt;&gt; %rpt% echo              Date: %date:~4%  Time: %time:~0,5%
&gt;&gt; %rpt% echo.
<span aria-label="annotation4" class="codeannotationhang">❹</span><span class="sans_thesansmonocd_w5regular_"> &gt;&gt; %rpt% echo                  %% of          Life          Avoidable</span>
&gt;&gt; %rpt% echo Country          GDP          Expectancy      Deaths/100K
&gt;&gt; %rpt% echo -------          ----        ----------      -----------
</code></pre>
<p class="tx">After the opening <span class="sans_thesansmonocd_w5regular_">setlocal</span> command, we define the <span class="sans_thesansmonocd_w5regular_">rpt</span> variable <span aria-label="annotation1" class="codeannotation">❶</span> with the path and name of the report file. I’m keeping the variable name succinct because we’ll be using it every time we write a record to the report, which will be often. Next, we initialize four variables <span aria-label="annotation2" class="codeannotation">❷</span> to <span class="sans_thesansmonocd_w5regular_">0</span>. The <span class="sans_thesansmonocd_w5regular_">cnt</span> variable keeps a count of the number of detail records, and the other variables are totals for each of the three quantities in the report, which we’ll use in the next two sections of the bat file.</p>
<p class="tx">The introduction is actually composed of two parts: the title <span aria-label="annotation3" class="codeannotation">❸</span> and the column headers <span aria-label="annotation4" class="codeannotation">❹</span>. In this particular report, they account for seven header records overall, and we’ll create them with seven <span class="sans_thesansmonocd_w5regular_">echo</span> commands redirected to the report file.</p>
<p class="tx">We start the report by redirecting the beginning of the title to the file defined by the <span class="sans_thesansmonocd_w5regular_">rpt</span> variable <span aria-label="annotation3" class="codeannotation">❸</span>; a single redirection character is used for only this command, so if an existing file is present, we overwrite it. We next append the remainder of the title, followed by the date and time and a blank line with the <span class="sans_thesansmonocd_w5regular_">echo.</span> command.</p>
<p class="tx">We’re populating the date and time in the third record from the aptly named <span class="sans_thesansmonocd_w5regular_">date</span> and <span class="sans_thesansmonocd_w5regular_">time</span> variables, respectively. These pseudo-environment <span aria-label=" Page 262. " epub:type="pagebreak" id="pg_262" role="doc-pagebreak"/>variables introduced in <span class="xref"><a href="chapter21.xhtml" class="calibre3">Chapter 21</a></span> offer an easy way of documenting when the report was generated. Notice I’m extracting portions of each value to remove the day of the week from the date and the seconds from the time. Sometimes there’s such a thing as too much data.</p>
<p class="tx">The final three <span class="sans_thesansmonocd_w5regular_">echo</span> commands are writing out the column headers <span aria-label="annotation4" class="codeannotation">❹</span>. Most of this data is hardcoded, but notice that I’m escaping the percent sign with another percent so the interpreter doesn’t think that it’s the start of a very awkward variable name (see <span class="xref"><a href="chapter14.xhtml" class="calibre3">Chapter 14</a></span>).</p>
<p class="tx">Some of the data in the title and the column headers appear to be off-kilter, but this is just a result of variable resolution and escaping. The best way to line up everything is to type the title, headers, and a sample data line into a text file using a fixed-width font and line up everything as desired—that is, type up a sample of the report in <a href="#Lis22-2" class="calibre3">Listing 22-2</a>. When satisfied with the alignment, copy the resulting headings into the bat file, preceding each with the redirection and an <span class="sans_thesansmonocd_w5regular_">echo</span> command. Then add any escape characters and replace any temporary text such as the sample date and time with the variables that will take their place.</p>
<p class="tx">Throughout this last step, let the data shift; everything will realign in the final output. For instance, the record with the date and time <span aria-label="annotation3" class="codeannotation">❸</span> appears to be shifted to the right, but that’s only because the variable name with the substringing syntax and the encasing percent signs is longer than the time it will eventually display. Likewise, the extra percent sign <span aria-label="annotation4" class="codeannotation">❹</span> skews the rest of the data in the first column header record. <span class="sans_thesansmonocd_w5regular_">Life</span> and <span class="sans_thesansmonocd_w5regular_">Avoidable</span> don’t appear to be lined up with the next two lines, but after the interpreter consolidates the two percent signs into one, everything will again realign.</p>
</section>
<section aria-labelledby="sec3" epub:type="division">
<h3 class="h" id="sec3"><span id="h1-153"/><span class="sans_futura_std_bold_b_">Detail Records</span></h3>
<p class="tni">There’s much to unpack, but the following code writes one formatted detail record for each record in the input file and keeps track of the record count and the running totals of the three fields:</p>
<pre class="pre"><code class="calibre11"><span aria-label="annotation1" class="codeannotationhang">❶</span> for /F "usebackq tokens=1-4 delims=|" %%a in ("C:\Batch\HealthStats.dat") do (
<span aria-label="annotation2" class="codeannotation">❷</span> set ctry=%%a                eol
<span aria-label="annotation3" class="codeannotation">❸</span> for /F "tokens=1-2 delims=." %%m in ("%%b") do (
      set dcml=%%n0
      set perGDP=      %%m.!dcml:~0,1!
   )
<span aria-label="annotation4" class="codeannotation">❹</span> for /F "tokens=1-2 delims=." %%m in ("%%c") do (
      set dcml=%%n0
      set lifeExp=              %%m.!dcml:~0,1!
   )
<span aria-label="annotation5" class="codeannotation">❺</span> set deaths=                %%d
<span aria-label="annotation6" class="codeannotation">❻</span> &gt;&gt; %rpt% echo !ctry:~0,15! !perGDP:~-5! !lifeExp:~-14! !deaths:~-15!
<span aria-label="annotation7" class="codeannotation">❼</span> set /A cnt += 1
   set /A totPerGDP += !perGDP:.=!
   set /A totLifeExp += !lifeExp:.=!
   set /A totDeaths += deaths
)
</code></pre>
<p class="tx"><span aria-label=" Page 263. " epub:type="pagebreak" id="pg_263" role="doc-pagebreak"/>The <span class="sans_thesansmonocd_w5regular_">for /F</span> command <span aria-label="annotation1" class="codeannotation">❶</span> introduced in <span class="xref"><a href="chapter19.xhtml" class="calibre3">Chapter 19</a></span> is the obvious solution to pull out the four tokens (<span class="sans_thesansmonocd_w5regular_">tokens=1-4</span>) from each record of the pipe-delimited data file (<span class="sans_thesansmonocd_w5regular_">delims=|</span>). This logic assigns the country from the data file to the <span class="sans_thesansmonocd_w5regular_">for</span> variable <span class="sans_thesansmonocd_w5regular_">%%a</span>, which implies that the percent of GDP is <span class="sans_thesansmonocd_w5regular_">%%b</span>, the life expectancy is <span class="sans_thesansmonocd_w5regular_">%%c</span>, and the number of avoidable deaths is <span class="sans_thesansmonocd_w5regular_">%%d</span>.</p>
<section aria-labelledby="sec4" epub:type="division">
<h4 class="h1" id="sec4"><span id="h2-67"/><span class="sans_futura_std_heavy_oblique_bi_">Aligning Columns with Justified Data</span></h4>
<p class="tni">I’m padding the <span class="sans_thesansmonocd_w5regular_">ctry</span> variable <span aria-label="annotation2" class="codeannotation">❷</span>, which contains string data, with a number of spaces and ultimately the text <span class="sans_thesansmonocd_w5regular_">eol</span> that doesn’t appear in the report. To make the columns line up, I’ll make this a left-justified field and ultimately substring out just its first 15 bytes, but for this to work, the field must be at least 15 bytes in length—hence, the space padding.</p>
<p class="tx">The <span class="sans_thesansmonocd_w5regular_">eol</span> tag at the end is simply there to demonstrate to the reader that the field has trailing spaces. I’ll strip it off before writing the record, so any text would work, but it does stand for <i class="calibre6">end of line</i>. (If you are really proud of the report, you can sign your work by entering your name instead.) Without some sort of a marker, a future coder might someday remove the trailing spaces, especially if they’re more familiar with languages that ignore trailing spaces, which is almost any language not named Batch.</p>
<p class="warning"><span class="sans_dogma_ot_bold_b_1">WARNING</span></p>
<p class="warning-txt"><i class="calibre6">In <a href="chapter2.xhtml" class="calibre3">Chapter 2</a>, I mentioned that you can place an ampersand, or the command separator, after trailing spaces, but due to a frustrating batveat, that doesn’t work in a code block, or at least not the same way. The interpreter balks when you use the ampersand in a code block without an actual command after it, which means you could replace eol with &amp;rem. In what’s even more of an oddity, if escaped, the ampersand works in a code block without a second command, so you can also replace eol with ^&amp;.</i></p>
<p class="tx">Contrast the country variable with the variable corresponding to the last column detailing avoidable deaths per 100,000 people. Instead of trailing spaces, I’m adding 15 <i class="calibre6">leading</i> spaces to <span class="sans_thesansmonocd_w5regular_">deaths</span> <span aria-label="annotation5" class="codeannotation">❺</span>. This is an integer and unlike the string data items that we should line up by the first character, we should line up avoidable deaths by its final character, or the ones digit.</p>
<p class="tx">To right-justify a number, I do the opposite of what I did for a string. I <i class="calibre6">prepend</i> the value with a number of spaces so that I can later extract the desired text from the end of the field. To maintain the spaces needed for the report, I’ll extract 15 total bytes from this field, so if this field isn’t at least 15 bytes long, the resulting data will be askew.</p>
</section>
<section aria-labelledby="sec5" epub:type="division">
<h4 class="h1" id="sec5"><span id="h2-68"/><span class="sans_futura_std_heavy_oblique_bi_">Working with Floating-Point Data</span></h4>
<p class="tni">Decimal or floating-point values represent the two middle columns, and since we’ll be treating both the same way, I’ll focus on just one. The data in the input file expresses life expectancy <span aria-label="annotation4" class="codeannotation">❹</span> as a decimal with a tenths place for all values except for Canada, which happens to be an integer, but we want a decimal place for each value in the report, and we want to line up the numbers on that decimal place.</p>
<p class="tx"><span aria-label=" Page 264. " epub:type="pagebreak" id="pg_264" role="doc-pagebreak"/>I’m resolving life expectancy from the third token, <span class="sans_thesansmonocd_w5regular_">%%c</span>, of the outer <span class="sans_thesansmonocd_w5regular_">for</span> command <span aria-label="annotation1" class="codeannotation">❶</span> and using it as the input string to one of the inner <span class="sans_thesansmonocd_w5regular_">for</span> commands <span aria-label="annotation4" class="codeannotation">❹</span>. Delimiting on the dot breaks the value up into the whole number before the decimal and the decimal part after the decimal point. I’m assigning the latter value to the <span class="sans_thesansmonocd_w5regular_">dcml</span> or decimal variable while appending <span class="sans_thesansmonocd_w5regular_">0</span>. Batch syntax can be so esoteric it’s easy to miss, but in the four bytes <span class="sans_thesansmonocd_w5regular_">%%n0</span>, the first three are the second token of the inner <span class="sans_thesansmonocd_w5regular_">for</span> loop, and the last is a hardcoded number.</p>
<p class="tx">In the second and final command inside the code block of the inner <span class="sans_thesansmonocd_w5regular_">for</span> command, I’m extracting the first byte of the decimal: <span class="sans_thesansmonocd_w5regular_">!dcml:~0,1!</span>. For most countries, we append <span class="sans_thesansmonocd_w5regular_">0</span> to the decimal value and immediately strip it off. That seems pointless until Canada is considered. Since its life expectancy is <span class="sans_thesansmonocd_w5regular_">82</span> with no decimal value present, the <span class="sans_thesansmonocd_w5regular_">0</span> tacked onto the end becomes the sole decimal byte. Finally, I string together the whole number, <span class="sans_thesansmonocd_w5regular_">%%m</span>, a dot, and the first digit of the decimal value. Lest we forget, this must all follow a number of leading spaces for right-justification. If we had wanted to format numbers with two decimal points, such as dollar amounts, we could have appended two zeros and extracted the first two bytes.</p>
<p class="tx">(In this example, <span class="sans_thesansmonocd_w5regular_">%%n0</span> represents a <span class="sans_thesansmonocd_w5regular_">for</span> variable followed by the hardcoded <span class="sans_thesansmonocd_w5regular_">0</span>, but changing just one byte produces something quite different: <span class="sans_thesansmonocd_w5regular_">%~n0</span>. The <span class="sans_thesansmonocd_w5regular_">n</span> now turns into a modifier for the hidden parameter, <span class="sans_thesansmonocd_w5regular_">%~0</span>. Hence, <span class="sans_thesansmonocd_w5regular_">%~n0</span> resolves to the extensionless name the bat file. Oh, the vagaries of Batch.)</p>
<p class="tx">The logic for the percentage of each country’s GDP spent on healthcare <span aria-label="annotation3" class="codeannotation">❸</span> is nearly identical to the logic for life expectancy. Because of how the columns line up, the only difference is the number of leading spaces we attach to each value.</p>
</section>
<section aria-labelledby="sec6" epub:type="division">
<h4 class="h1" id="sec6"><span id="h2-69"/><span class="sans_futura_std_heavy_oblique_bi_">Writing a Detail Record</span></h4>
<p class="tni">These four variables culminate in the line that actually writes the formatted text string to the report file <span aria-label="annotation6" class="codeannotation">❻</span>. This is a redirection of an <span class="sans_thesansmonocd_w5regular_">echo</span> command similar to what we’ve seen earlier in this chapter, resolving the four variables and extracting portions via substringing, each separated by a space.</p>
<p class="tx">To left-justify the <span class="sans_thesansmonocd_w5regular_">ctry</span> variable, I use an offset of <span class="sans_thesansmonocd_w5regular_">0</span> and length of <span class="sans_thesansmonocd_w5regular_">15</span>, thus extracting the first 15 bytes and dropping everything else (including the <span class="sans_thesansmonocd_w5regular_">eol</span> marker). The next three values, <span class="sans_thesansmonocd_w5regular_">perGDP</span>, <span class="sans_thesansmonocd_w5regular_">lifeExp</span>, and <span class="sans_thesansmonocd_w5regular_">deaths</span>, are to be right-justified numbers, so I substring with negative offsets to grab the last <span class="sans_thesansmonocd_w5regular_">5</span>, <span class="sans_thesansmonocd_w5regular_">14</span>, and <span class="sans_thesansmonocd_w5regular_">15</span> bytes, respectively.</p>
<p class="tx">The various lengths are dependent on the layout. The best way to format the detail record and determine the proper layout is to type up the same type of sample line I suggested for the header records. Figure out the lengths of each justified field, experiment, and expect the need for some tweaking. Just be careful to make sure there are at least <i class="calibre6">n</i> bytes in a string if you plan to extract <i class="calibre6">n</i> bytes from it. Put more plainly, the country is 15 bytes, so make sure you append 15 spaces to ensure perfect alignment.</p>
</section>
<section aria-labelledby="sec7" epub:type="division">
<h4 class="h1" id="sec7"><span id="h2-70"/><span aria-label=" Page 265. " epub:type="pagebreak" id="pg_265" role="doc-pagebreak"/><span class="sans_futura_std_heavy_oblique_bi_">Working with Counters and Totals</span></h4>
<p class="tni">The last four lines of the code block <span aria-label="annotation7" class="codeannotation">❼</span> all perform some arithmetic with the augmented assignment operators from <span class="xref"><a href="chapter6.xhtml" class="calibre3">Chapter 6</a></span>. The first is a simple counter, <span class="sans_thesansmonocd_w5regular_">cnt</span>, keeping track of the number of entries. The last three, <span class="sans_thesansmonocd_w5regular_">totPerGDP</span>, <span class="sans_thesansmonocd_w5regular_">totLifeExp</span>, and <span class="sans_thesansmonocd_w5regular_">totDeaths</span>, are cumulative totals of the three quantities in the report. I’ve named these variable names with <span class="sans_thesansmonocd_w5regular_">tot</span>, for <i class="calibre6">total</i>, prepending a familiar variable name.</p>
<p class="tx">The logic is straightforwardly incrementing the variable for total deaths by the number of deaths in each record. The other two are decimals, and as you learned in <span class="xref"><a href="chapter6.xhtml" class="calibre3">Chapter 6</a></span>, floating-point arithmetic requires a little ingenuity. The text replacement syntax removes the decimal point before adding each to the total—for example, <span class="sans_thesansmonocd_w5regular_">!perGDP:.=!</span>. This effectively multiples the total by 10, so we’ll need to address this discrepancy when calculating the averages and writing out the trailer records.</p>
<p class="tx">I didn’t do it in this report, but you may want to create a page break after a certain number of detail records. Typically, you might want a page number at the bottom followed by a few blank lines before reproducing the headers followed by another page of detail lines. To do this after every 25 detail lines, interrogate <span class="sans_thesansmonocd_w5regular_">cnt %% 25</span> at the end of the loop. If equal to <span class="sans_thesansmonocd_w5regular_">0</span>, the record count is a multiple of 25, so you can initiate a page break. You can also create another counter for the page number and write it as part of the page trailer information and move the header logic to a callable routine so that you can invoke it one to many times.</p>
</section>
</section>
<section aria-labelledby="sec8" epub:type="division">
<h3 class="h" id="sec8"><span id="h1-154"/><span class="sans_futura_std_bold_b_">Trailer Records</span></h3>
<p class="tni">The third and final section of the bat file finds and formats the averages before writing them to the report:</p>
<pre class="pre"><code class="calibre11"><span aria-label="annotation1" class="codeannotationhang">❶</span> set /A avePerGDP = (totPerGDP * 10 / cnt + 5) / 10
set /A aveLifeExp = (totLifeExp * 10 / cnt + 5) / 10
set /A avgDeaths = (totDeaths * 10 / cnt + 5) / 10
<span aria-label="annotation2" class="codeannotationhang">❷</span><span class="sans_thesansmonocd_w5regular_"> set avePerGDP=     %avePerGDP%</span>
set aveLifeExp=            %aveLifeExp%
set avgDeaths=              %avgDeaths%

<span aria-label="annotation3" class="codeannotationhang">❸</span> &gt;&gt; %rpt% echo -------          ----        ----------      -----------
&gt;&gt; %rpt% echo Averages      !avePerGDP:~-5,-1!.!avePerGDP:~-1!^
 !aveLifeExp:~-13,-1!.!aveLifeExp:~-1! !avgDeaths:~-15!
goto :eof
</code></pre>
<p class="tx">To find the averages, we could simply divide the totals by the number of detail records, but since Batch truncates the decimal part of the solution, everything is in effect rounded down. To compensate, each <span class="sans_thesansmonocd_w5regular_">set /A</span> command <span aria-label="annotation1" class="codeannotation">❶</span> first multiplies the value by <span class="sans_thesansmonocd_w5regular_">10</span> and divides by <span class="sans_thesansmonocd_w5regular_">cnt</span>. Adding <span class="sans_thesansmonocd_w5regular_">5</span> to this number corrects for the rounding so that dividing by <span class="sans_thesansmonocd_w5regular_">10</span> produces the rounded average. For example, 77.4 deaths should round down: 77.4 + 0.5 = 77.9, which is 77 when the decimal is truncated. Then 77.6 should <span aria-label=" Page 266. " epub:type="pagebreak" id="pg_266" role="doc-pagebreak"/>round up: 77.6 + 0.5 = 78.1, which becomes 78. Because we can’t add the decimal 0.5, we are instead multiplying by 10, adding 5, and dividing by 10.</p>
<p class="tx">The next section of code <span aria-label="annotation2" class="codeannotation">❷</span> appends leading spaces to each of the three averages in anticipation of the substringing for data alignment. The final section of the code <span aria-label="annotation3" class="codeannotation">❸</span> writes the trailer records to the report with two <span class="sans_thesansmonocd_w5regular_">echo</span> commands. The first writes hardcoded dashes identical to a header record. The second command replaces the name of a country with the hardcoded text, <span class="sans_thesansmonocd_w5regular_">Averages</span>, and the remainder of the command displays the three averages with such dense substringing that I’ve had to continue the command on the next line.</p>
<p class="tx">I’m extracting the last 15 bytes from the <span class="sans_thesansmonocd_w5regular_">avgDeaths</span> variable, but since the other two totals are actually 10 times greater than their actual values, it follows that their corresponding averages, <span class="sans_thesansmonocd_w5regular_">avePerGDP</span> and <span class="sans_thesansmonocd_w5regular_">aveLifeExp</span>, are also increased by a factor of 10. We can’t correct this by dividing these by 10, because that would lose the decimal parts. However, by inserting a decimal point into the number as it’s being written, we are presenting the number as it should be, effectively dividing by 10 while also showing the decimal part, which is a win-win. Notice that <span class="sans_thesansmonocd_w5regular_">!avePerGDP:~-5,-1!.!avePerGDP:~-1!</span> resolves to the four bytes prior to the last byte, a hardcoded dot, and that last byte.</p>
<p class="tx">Other datasets may lend themselves to simply displaying totals instead of averages, meaning that the floating-point arithmetic will be lessened or nonexistent. Even with this example using averages, we were able to create a fairly impressive report without a great deal of code.</p>
</section>
<section aria-labelledby="sec9" epub:type="division">
<h3 class="h" id="sec9"><span id="h1-155"/><span class="sans_futura_std_bold_b_">Summary</span></h3>
<p class="tni">In this chapter, I stepped through the three sections of a typical text report formatted with Batch. If you were expecting a nifty routine to automatically line up columns with ease, I’m sure I’ve disappointed you, but with a little attention to the details, you can create a quality report. You learned how to build a title, headers, any number of detail records, and a trailer record with totals and averages. Along the way, I demonstrated techniques for aligning columns with justified data items and tips for handling floating-point data. This isn’t a heavy-duty utility, and I’m sure that no one is making a living solely producing Batch reports, but when a simple text report is needed, a compiled program is not.</p>
<p class="tx">The next chapter changes gears and delves into a subject that’s dear to my heart: recursion. You'll learn how to build Batch code that calls itself, along with some interesting applications.</p>
</section>
</section>
</div></body></html>