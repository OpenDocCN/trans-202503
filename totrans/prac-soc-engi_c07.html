<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en">
<head>
<title>Chapter 7: Phishing</title>
<link href="NSTemplate_v1.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:5e8bb34b-260b-4fef-91f3-caabb4446e65" name="Adept.expected.resource"/>
</head>
<body epub:type="bodymatter chapter">
<section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" id="Page_83" title="83"/>7</span><br/>
<span class="ChapterTitle">Phishing</span></h1>
</header>
<figure class="opener">
<img alt="" src="image_fi/book_art/chapterart.png"/>
</figure>
<p class="ChapterIntro">In this chapter, you’ll create a phishing campaign. We’ll walk through the infrastructure you’ll need if you want to create an attack manually, and then discuss automated solutions, technical features like tracking pixels that you can add to your attack, and the factors you should consider before deployment to make your engagement successful. This chapter should help any social engineer get started with email-based attacks. It may also be a refresher for system administrators or an informative guide for someone coming from a Security Operations Center or compliance role. </p>
<h2 id="h1-500983c07-0001"><span epub:type="pagebreak" id="Page_84" title="84"/>Setting Up a Phishing Attack</h2>
<p class="BodyFirst">The proper architecture to use for a phishing attack varies. The tools you’ll need all depend on the engagement’s scope, SOW, contract, and client’s desires. For example, if the client wants you to measure how many employees click a sketchy link in an email, all you need is a simple web server that captures HTTP GET requests and displays a 404 or Thank You page to the user. The responses will be stored in an Apache log.</p>
<p>From there, things get more complicated. Does the client want you to spoof or squat? You could <em>spoof</em> a legitimate domain, sending an email and manipulating the information displayed to the recipient to make it appear as if it came from a legitimate source, but spoofing is easy to detect. </p>
<p><em>Squatting</em>, a similar technique, is less risky, and you’re less likely to get caught. It involves registering a domain similar to the recipient’s, such as <em>.co.uk</em> to a company’s <em>.com</em> domain. This makes your emails appear to come from the legitimate domain—at least to those who don’t look too closely.</p>
<p>Next, do your clients want you to collect user credentials or other sensitive information, like password-reset questions? In that case, your email will have to link to a web page that asks for this information in a convincing way. Or do your clients want you to send malicious documents? If so, you’ll need to create those documents and find a place to host them without getting flagged by security tools. </p>
<p>Do they want you to use an automated phishing solution, like King Phisher or Gophish? If you phish regularly, you’ll likely already have an automated setup, but even if you do, you may need to make some changes or input your own email designs. The most successful social engineers understand both the technical aspects of the architecture and the human element that makes their attack succeed. </p>
<p>In this section, you’ll set up a sophisticated phishing attack designed to fool users and evade detection. By setting up your own VPS, email server, and landing page, you’ll be able to send emails that appear to come from a legitimate company email address. You’ll include a link in the body of the email that directs users to a web page, prompting them to enter their credentials. </p>
<h3 id="h2-500983c07-0001">Setting Up a Secure VPS Instance for Phishing Landing Pages</h3>
<p class="BodyFirst">No matter what you do in your engagement, you’ll almost always need a VPS instance. Through a VPS, you’ll be able to host a landing page and run a mail server if you choose, all without linking your attack to your IP address.</p>
<p>In this section, I’ll show you how to set up a secure VPS with DigitalOcean, a cloud infrastructure company that lets you use its services for security research. <em>Droplets,</em> which are DigitalOcean VPS instances, start at low monthly prices and come with backups, snapshots, storage volumes, DNS, a CDN, load balancing, one-click applications, and network firewalls. You can choose from a variety of Linux and BSD operating systems, <span epub:type="pagebreak" id="Page_85" title="85"/>containers, and preloaded apps like Node.js, LAMP, WordPress, GitLab, and Docker. </p>
<p>Note that DigitalOcean has data centers in New York, San Francisco, Toronto, Bangalore, Amsterdam, Frankfurt, London, and Singapore. These locations can matter, because some regions filter certain content, and some companies filter traffic based on country. Additionally, if you are dealing with European citizens and their data, you should seek legal counsel regarding the EU GDPR.</p>
<p>Ideally, you should set up your VPS with your domain and web server at least two weeks before the engagement. That’s because some mail server security platforms reject all mail from domains that are less than two weeks old. </p>
<h4 id="h3-500983c07-0001">Creating a DigitalOcean Account and Droplet</h4>
<p class="BodyFirst">To set up a DigitalOcean droplet, you need to create an account. Navigate to <a class="LinkURL" href="https://www.digitalocean.com/">https://www.digitalocean.com/</a> and follow the page’s sign-up instructions. I recommend enabling two-factor authentication for your account to prevent anyone from gaining access should they compromise your password. </p>
<p>Once logged in, select <b>Create</b><span class="MenuArrow">▶</span><b>Droplet</b>. Select your desired operating system. I recommend using either Kali or Debian Linux. Then size the droplet to determine the number of processors and the amount of RAM it should use. The more connections the droplet will have, the more processing power it will need. For a short engagement that targets, say, 150 users, the standard droplet should work without issue. Next, you can choose to use IPv6, private networking, backups, or your own RSA key. You can also add a hostname or spin up multiple droplets.</p>
<p>You should see the droplet’s IP address once it’s created. DigitalOcean will email you the initial root credential for the host, as well as the IP address. If you upload an SSH key pair, as described in the next section, you can use this information to log in. If you do not, DigitalOcean will email you a temporary root password, but you will be prompted to change it after your first login.</p>
<h4 id="h3-500983c07-0002">Creating an SSH Key Pair to Secure the VPS</h4>
<p class="BodyFirst">Having a strong authentication method is important, because this server is internet facing. When I used DigitalOcean to run <em>honeypots</em>—purposely vulnerable systems created with the aim of being attacked, allowing researchers to study the attackers’ techniques and behavior, or alerting administrators of a system compromise—the hosts were hammered by scanners and would-be exploiters. </p>
<p>To prevent attackers from brute-forcing your password, create an SSH key pair. Also known as an <em>RSA key pair</em>, an <em>SSH key pair</em> is a private and public RSA key used to log in. You will copy the private key (<code>id_rsa</code> by default) to your remote system and copy the public key (<code>id_rsa.pub</code> by default) to the <em>authorized_keys</em> file to allow the login to occur. SSH keys allow you to disable password authentication. </p>
<p><span epub:type="pagebreak" id="Page_86" title="86"/>First, execute the following command in your terminal:</p>
<pre><code><b>ssh-keygen -t rsa</b>
Enter file in which to save the key (/root/.ssh/id_rsa): 
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /root/.ssh/id_rsa.
Your public key has been saved in /root/.ssh/id_rsa.pub.
cat ./.ssh/id_rsa.pub &gt; ./.ssh/authorized_keys</code></pre>
<p>The <code>ssh-keygen</code> command creates the key pair. By default, the keys appear in the<em> /root/.ssh </em>directory on the VPS. You can choose to write the keys to a particular location by passing <code>-C /path/</code> to the <code>ssh-keygen</code> command, followed by the desired file path. You may also want to enter a passphrase with your SSH key to create a second authentication factor. You will be prompted to enter a passphrase while creating the key pair. If you don’t want to use one, press <span class="KeyCaps">enter</span> to continue.</p>
<p>You’ll need to access the VPS key pair on the system you’ll use to control the VPS. To do this, use the Secure Copy Protocol (SCP) or an SCP client. If you’re on a Windows host, you could use <em>WinSCP</em>, which is a terminal emulator that allows Windows users to connect directly to Linux hosts over FTP, SSH, and Telnet. If you are on a Mac or Linux host, you can use an SCP client like the native terminal, iTerm2, Cyberduck, or Termius. This will allow you to move the RSA keys to and from the droplet. You can also use the SCP client later to move artifacts, such as files, to and from the droplet.</p>
<p>To copy the files using WinSCP, log in to the VPS using the credentials (password or RSA key pair) you created and drag and drop the files in either direction from within the GUI. You will need to ensure that you have the correct permissions for your file. Run the command <code class="bold">chmod 600</code><code> </code><var class="bold">filename_of_private_key</var> to ensure you have the proper permissions set.</p>
<h4 id="h3-500983c07-0003">Setting Up Windows Remote Access to the VPS</h4>
<p class="BodyFirst">Once you have moved the RSA key to your workstation, install a client that will give you remote access to your VPS. You need remote access in order to set up the landing page and configure any additional services, such as mail servers, on the VPS. </p>
<p>On Windows, you can get remote access with the PuTTY tool. Download PuTTYgen from the PuTTY website, <a class="LinkURL" href="https://www.putty.org/">https://www.putty.org/</a>. Then, create a PuTTY Private Key (PPK) file to use in PuTTY and WinSCP by importing your RSA private key into the software. In the PuTTY Key Generator window, click <b>Generate</b> (<a href="#figure7-1" id="figureanchor7-1">Figure 7-1</a>). </p>
<p>Import the <code>id_rsa</code> key from the host into PuTTYgen. You should see the key generated in PPK format, as shown in <a href="#figure7-2" id="figureanchor7-2">Figure 7-2</a>.</p>
<span epub:type="pagebreak" id="Page_87" title="87"/><figure>
<img alt="&lt;&lt;PuTTY Key Generator window shows options to generate a public/private key pair, load an existing private key file, save the generated key, and select the key parameters and number of bits. “Generate” button highlighted.&gt;&gt;" class="" src="image_fi/500983c07/f07001.png"/>
<figcaption><p><a id="figure7-1">Figure 7-1</a>: PuTTYgen</p></figcaption>
</figure>
<figure>
<img alt="&lt;&lt;PuTTY Key Generator window shows public key in PPK format for pasting into OpenSSH authorized_keys file.&gt;&gt;" class="" src="image_fi/500983c07/f07002.png"/>
<figcaption><p><a id="figure7-2">Figure 7-2</a>: Creating a PPK</p></figcaption>
</figure>
<p>Next, load the key into the PuTTY session. To do so, add your username or your droplet’s IP address into the <b>Host Name (or IP Address)</b> field (<a href="#figure7-3" id="figureanchor7-3">Figure 7-3</a>). </p>
<span epub:type="pagebreak" id="Page_88" title="88"/><figure>
<img alt="&lt;&lt;PuTTY Configuration window shows basic options for the PuTTY session. &quot;root@127.0.1.1&quot; listed in Host Name field and &quot;22&quot; listed in Port field. SSH connection type selected. BOOK saved session and Load button highlighted.&gt;&gt;" class="" src="image_fi/500983c07/f07003.png"/>
<figcaption><p><a id="figure7-3">Figure 7-3</a>: PuTTY configuration</p></figcaption>
</figure>
<p>Then select <b>Connection</b><span class="MenuArrow">▶</span><b>SSH</b><span class="MenuArrow">▶</span><b>Auth</b> from the left pane (<a href="#figure7-4" id="figureanchor7-4">Figure 7-4</a>). Enter the file path to the PPK file in the <b>Private key file for authentication</b> field. Finally, click <b>Session</b> at the top of the left pane, and then give the instance a name and save it. To connect to the host, click <b>Open</b>. </p>
<figure>
<img alt="&lt;&lt;PuTTY Configuration window shows options controlling SSH authentication, accessed from the Connection category under SSH and Auth (outlined in red). &quot;Display pre-authentication banner (SSH-2 only),&quot; &quot;Attempt authentication using Pageant,&quot; and &quot;Attempt 'keyboard-interactive' auth (SSH-2)&quot; options are selected. File path field to upload private key file for authentication also outlined.&gt;&gt;" class="" src="image_fi/500983c07/f07004.png"/>
<figcaption><p><a id="figure7-4">Figure 7-4</a>: Configuring PuTTY to use the PPK</p></figcaption>
</figure>
<p><span epub:type="pagebreak" id="Page_89" title="89"/>Now that you’ve configured PuTTY to use SSH keys, enter your passphrase, if you set one, to log in to the VPS. Update all packages and run any outstanding security updates to protect yourself against attacks on the public internet.</p>
<h4 id="h3-500983c07-0004">Setting Up macOS or Linux Remote Access to the VPS</h4>
<p class="BodyFirst">If you’re accessing the VPS from a macOS or Linux operating system, you’ll have to copy the RSA private key over first, either via SCP or copy and paste. You can do this from the terminal. Issue the following command to copy over the key (I’ve censored the IP address in this example):</p>
<pre><code>root@******:<b>~/.ssh# scp root@***.***.***.***:/root/.ssh/id_rsa ./id_rsa</b></code></pre>
<p>If you’re using a remote access tool like Termius, a paid solution that allows you to save SSH sessions, you won’t have to copy over the file, but you’ll need to copy and paste the contents of the file into your keychain. To accomplish this, execute the following command:</p>
<pre><code>root@******:<b>~</b><b>#cat ./.ssh/id_rsa</b></code></pre>
<p>If using a terminal to connect via SSH, execute the following command to gain access:</p>
<pre><code>root@******:<b>~# chmod 600 id_rsa</b>
root@******:<b>~# ssh -i id_rsa root@***.***.***.***</b></code></pre>
<p>If everything runs properly, you will see a prompt on the VPS showing last login and any packages to be updated. If the key is not configured properly, you will see an error indicating what went wrong.</p>
<h4 id="h3-500983c07-0005">Disabling Password-Based Authentication </h4>
<p class="BodyFirst">Now that you’re connected, take steps to make sure your VPS remains secure. First, remove the ability to log in to the system itself using a password. (This won’t affect any web applications you install later.) Anyone who logs in to this VPS will need the RSA private key, which is extremely difficult (if not impossible) to brute-force, unlike passwords. </p>
<p>Ensure that the <em>authorized_keys</em> file contains the public key you created earlier by executing the following command:</p>
<pre><code>root@******:<b>~# cat id_rsa.pub &gt;&gt; ./.ssh/authorized_keys</b></code></pre>
<p>Open the <em>sshd_config</em> file in a text editor and change <code>#PasswordAuthentication yes</code> to <code class="bold">PasswordAuthentication no</code>.</p>
<p>To do so, execute the following command:</p>
<pre><code>root@******:<b>vi /etc/ssh/sshd_config</b></code></pre>
<p><span epub:type="pagebreak" id="Page_90" title="90"/>Save the file, then restart SSH. You will need to define the key in your <code>ssh</code> command to connect to the VPS:</p>
<pre><code>root@******:<b>chmod 600</b><b> </b><var class="bold">key_file</var>
root@******:<b>ssh -I</b><b> </b><var class="bold">key_file</var><b> </b><var class="bold">user</var><b>@</b><var class="bold">VPS_IP_address</var></code></pre>
<p>Then enter your passphrase if you’ve created one.</p>
<h4 id="h3-500983c07-0006">Installing a Firewall</h4>
<p class="BodyFirst">Next, you need a firewall to limit the ports on the VPS that an application can access, and the hosts that can access the VPS. This will keep vulnerability scanning bots and attackers from connecting with the VPS, preventing collateral damage. Install <em>Uncomplicated Firewall </em>(<code>ufw</code>) if it’s not already installed:</p>
<pre><code>root@******:<b>apt-get install ufw</b></code></pre>
<p>Now make sure you can access the firewall by issuing <code>ufw enable</code><em>. </em>The following steps create new rules to control the flow of data in and out of your VPS:</p>
<pre><code>root@******:<b>ufw allow from </b><var class="bold">your_IP_address</var><b> to any</b>
root@******:<b>ufw allow from any to </b><var class="bold">your_IP_address</var>
root@******:<b>ufw enable</b></code></pre>
<p>You can run the firewall on a specific port, as opposed to all ports, by adding <code>port </code><var>port_number</var> to the IP address for source or destination. </p>
<p>To set up the firewall, log in to DigitalOcean and navigate to the <b>Networking</b> menu along the left pane. Next, select <b>Firewalls</b>. If you already have a firewall connected to DigitalOcean, select it from the list, as shown in <a href="#figure7-5" id="figureanchor7-5">Figure 7-5</a>. </p>
<figure>
<img alt="&lt;&lt;DigitalOcean web page displays Firewalls tab under the Networking menu. Shows an entry named &quot;Web&quot; with 0 droplets and 4 rules, created Just now.&gt;&gt;" class="keyline" src="image_fi/500983c07/f07005.png"/>
<figcaption><p><a id="figure7-5">Figure 7-5</a>: Setting up a DigitalOcean firewall</p></figcaption>
</figure>
<p><span epub:type="pagebreak" id="Page_91" title="91"/>If you don’t have a firewall already, click the green <b>Create</b> button and choose <b>Firewall </b>from the drop-down. This should take you to a page, shown in <a href="#figure7-6" id="figureanchor7-6">Figure 7-6</a>, that prompts you to create inbound rules. An <em>inbound rule</em> dictates how the VPS will interact with connections coming into it. An <em>outbound rule</em> dictates how the VPS will behave when trying to connect to other hosts, sometimes also referred to as <em>egress filtering</em>.</p>
<figure>
<img alt="&lt;&lt;DigitalOcean screenshot of the Create Firewall page displays name (Book) and fields for inputting Inbound Rules for incoming traffic (Type, Protocol, Port Range, and Sources).&gt;&gt;" class="keyline" src="image_fi/500983c07/f07006.png"/>
<figcaption><p><a id="figure7-6">Figure 7-6</a>: Creating a DigitalOcean firewall</p></figcaption>
</figure>
<p>Since you may use this host for phishing, you probably want the web server to be publicly accessible. Depending on your contract with the client, you may want to restrict this to hosts in their IP ranges. It’s also a good idea to limit IP ranges if you’re using the server to host malicious scripts for use in your phish. This would keep web crawlers and threat intelligence firms from spidering your website and finding it—a quick way to end up on blacklists and in threat intelligence feeds ingested by intrusion detection systems, SIEM programs, and other defensive technologies.</p>
<p>To give only a specific range of IP addresses access to your server, create an inbound rule for HTTP on TCP port 80 and HTTPS on TCP port 443 accepting inbound connections from <b>All IPv4 </b>and <b>All IPv6</b> unless the preceding conditions apply. Make sure to create an inbound rule that lets you connect to the host using SSH from any IP addresses that you personally use. </p>
<p>The system image from your VPS provider may not be fully up to date. To update a Linux system, execute the following commands:</p>
<pre><code><b>apt-get update -y; apt-get upgrade -y; apt-get dist-upgrade </b></code></pre>
<p><span epub:type="pagebreak" id="Page_92" title="92"/>The <code>apt-get update</code> command gives you a list of the updated packages, <code>apt-get upgrade</code> executes the updates, and <code>apt-get dist-upgrade</code> updates the kernel as well as software dependencies. The <code>-y</code> switch answers yes to most of the prompts you may receive.</p>
<h3 id="h2-500983c07-0002">Choosing an Email Platform </h3>
<p class="BodyFirst">Now that you have the VPS, you need to choose which service you’ll use to actually send your email. Although you could use a free email account from Yahoo! or Gmail, doing so might arouse suspicion if you’re posing as an authoritative figure. Free email accounts could work for certain attacks, such as ones targeting HR in which you pretend to be a hiring candidate. In most cases, though, it is better to use a domain that is not free, and so you’ll need to set up an email server.</p>
<p>The available services use several protocols to send mail, each with its strengths and weaknesses. In terms of choosing protocols, the blog post “Managed File Transfer and Network Solutions” by John Carl Villanueva (<a class="LinkURL" href="https://jscape.com/blog/smtp-vs-imap-vs-pop3-difference/">https://jscape.com/blog/smtp-vs-imap-vs-pop3-difference/</a>) is a comprehensive resource. Email protocols include the following:</p>
<p class="ListHead"><b>Simple Mail Transfer Protocol (SMTP)</b></p>
<ol class="none">
<li>Defined in RFC 5321. Uses port 25 by default. It may also use port 587 and port 465. </li>
</ol>
<p class="ListHead"><b>Internet Message Access Protocol (IMAP)</b></p>
<ol class="none">
<li>Defined in RFC 3501. Uses port 143 (or 993 for SSL/TLS connections).</li>
</ol>
<p class="ListHead"><b>Post Office Protocol v3 (POP3)</b></p>
<ol class="none">
<li>Defined in<b> </b>RFC 1939. Uses port 110 (or 995 for SSL/TLS connections).</li>
</ol>
<p>If you’re planning to spoof your email, you must use SMTP. POP3 and IMAP4 do not support spoofing but will work with squatting. If you have the autonomy to decide which email server to use for yourself, you can use one of a few options: </p>
<p class="ListHead"><b>Dovecot</b></p>
<ol class="none">
<li>An open source IMAP and POP3 email server for Linux/Unix-like systems. It is lightweight, meaning it uses little memory and does not require a lot of processing. As with any software, you must maintain a secure configuration and keep the system up to date in order to remain secure. If you are doing sporadic, low volumes of phishing, this upkeep may not be worth the effort and time, even though the software is free. If you’re phishing from a large pool of domains, or sending emails multiple times per day, this may be a more economical solution. Since Dovecot does not support SMTP, it does not support spoofing. You can use Dovecot for squatting attacks.</li>
</ol>
<p class="ListHead"><b><span epub:type="pagebreak" id="Page_93" title="93"/>Sendmail</b></p>
<p class="ListBody">One of the original internet mail clients, first released in 1983. It implements SMTP and is currently maintained by the Sendmail Consortium and Proofpoint, a phishing awareness and prevention company. The same considerations that are relevant to Dovecot exist with Sendmail. While Sendmail is open source software, its maintainers attempt to prevent phishing, which may make some social engineers uneasy. Since Sendmail uses SMTP, you can use it for either spoofing or squatting.</p>
<p class="ListHead"><b>Cloud Email</b></p>
<ol class="none">
<li>Microsoft 365 is Microsoft’s cloud-based email service, and Google Workspace is Google’s cloud-based enterprise email. Both services charge per user, per month, or per year and are accessible from anywhere with an internet connection. Both services support SMTP, POP3, and IMAP4, although they default to IMAP. You can tie Microsoft 365 or Google Workspace to any domain you own, so they work for squatting but not spoofing. </li>
</ol>
<p class="ListHead"><b>Google Mail (Gmail)</b></p>
<ol class="none">
<li>In my experience, Google won’t let you send malware (even macro-enabled Office documents) via email or Google Drive. However, Google won’t shut you down if you phish. At the time of this writing, you can acquire access to Google Workspace for your domains through Namecheap, Bluehost, SiteGround, or GoDaddy for around $6 per user per month. Most phishing domains are used on a burn-and-churn basis, meaning they’re used for one instance of phishing per client. If you’re the only person doing the phishing, you need to pay for only one user. If this is the case, you will likely pay no more than $6 per client for a phishing engagement. <aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	Technically, using these cloud providers as part of phishing engagements is a violation of their Terms of Service. Establish a contingency plan if you are caught and banned. </p>
<div class="bottom hr"><hr/></div>
</section>
</aside></li>
</ol>
<p>When selecting one of these options, keep the following considerations in mind. First, spoofing is easy to catch, and many mail systems have logic in place to detect it. Moreover, several apps independent of the mail systems, like Exchange, Proofpoint, and Mimecast, can validate emails and thwart spoofing. On the other hand, even if your target implements anti-phishing tools like Sender Policy Framework (SPF), Domain Keys Identified Mail (DKIM), or Domain-based Message Authentication, Reporting, and Conformance (DMARC), you can still successfully perform typo and domain squatting. SPF, DKIM, and DMARC are technical solutions that aim to prevent spoofing. In reality, if implemented, they prevent other parties from spoofing your domain, so they are worth implementing for your reputation, but they do little to prevent the spoofing of your organization.</p>
<p><span epub:type="pagebreak" id="Page_94" title="94"/>Squatting can also bypass technologies, like Mimecast, that attempt to catch phishing emails by looking at statistics in the emails themselves, as well as age and reputation of the domain sending the email. If the sending domain does not have a bad reputation or use language consistent with phishing, you should be able to get through these filters unless administrators have set up any specific rules. Even if the target has SPF or another solution, sending the mail using cloud services such as Google Mail (for domains) and Microsoft 365 will often bypass their filters, since the mail servers for Google and Microsoft are almost universally trusted.</p>
<p>Third, automated phishing solutions have several methods to integrate into email services like Dovecot, Sendmail, or cloud providers. However, automated solutions may put code, watermarks, or signatures into the email that filters and other defensive technologies for mail can detect. </p>
<p>Before you configure a mail server, you need to create firewall rules in DigitalOcean for it and to update UFW in your droplet with information about the protocols (either SMTP, IMAP, or POP3) you’re using to allow the communications. Use the steps coming up in <span class="xref" itemid="xref_target_“Setting Up the Phishing and Infrastructure Web Server”">“Setting Up the Phishing and Infrastructure Web Server”</span> to create the firewall rules for your mail server of choice.</p>
<h3 id="h2-500983c07-0003">Purchasing Sending and Landing Page Domains</h3>
<p class="BodyFirst">Next, you need to purchase two domains: one to host the <em>landing page</em>, which is where you’ll redirect victims who click the link in your email, and one to host the site from which you’ll send the phishing email. The landing page domain can be cheap, like the 88-cent <em>.tech</em> or <em>.info</em> domains. You’ll apply a long subdomain name to the link, so making it look legitimate is less critical. </p>
<p>The domain you’ll use to send the email needs to be one of the better-known top-level domains, like <em>.com</em>, <em>.net</em>, <em>.org</em>, <em>.io</em>, or <em>.us</em>. My main recommendation is to ensure that you buy one with domain privacy enabled, which <em>.us</em> domains don’t allow. <em>Domain privacy</em> is a service offered by domain registrars that allows you to put anonymized data as your domain’s WHOIS contact information. That way, people won’t be able to link you to the domain. Should anything occur that would require you to be notified, the registrar will act as an intermediary between you and the sender. You don’t want you or your employer’s names associated with a phishing domain, or threat intelligence professionals will dig relentlessly and enumerate all your domains and sites.</p>
<p>Once you have the domain you’ll be phishing from, attach it to the mail platform of your choice within your hosting platform and follow the prompts to gain access to it. If you are doing a more advanced phishing engagement, consider implementing a technical email control (such as SPF, DKIM, or DMARC) on your domain, since you’ll be squatting instead of spoofing. </p>
<h3 id="h2-500983c07-0004">Setting Up the Phishing and Infrastructure Web Server</h3>
<p class="BodyFirst">Now that you have the VPS instance and email service, you must set up the web server that will receive incoming connections, collect credentials, host malicious scripts, and perform anything else you need to do to be <span epub:type="pagebreak" id="Page_95" title="95"/>successful for your particular attack. In this section, I’ll show you how to use Apache, a free and open source web server software package. Apache is well-documented and fairly simple to use. </p>
<p>To install Apache, execute the following commands:</p>
<pre><code>root@********:<b>~# apt-get update -y</b>
root@********:<b>~</b><b># apt-get install apache2 -y</b></code></pre>
<p>Once the installation is complete, verify that Apache is in the UFW list of allowed processes/services by entering the following command:</p>
<pre><code><b>ufw app list</b></code></pre>
<p>Now, you need to minimize the range of IP addresses that can access the Apache instance to prevent third parties from accessing your server. I recommend allowing the IP address from which you will be connecting to the VPS, any testing or quality assurance IP addresses, and the IP range of your target organization (ideally, provided in writing from your security point of contact in the contract). To restrict your server to this range, execute the following commands:</p>
<pre><code><b>ufw allow from </b><var class="bold">IP_address or CIDR</var><b> </b><b>to any port</b><b> </b><var class="bold">web_port; 80 or 443</var>
<b>ufw enable</b></code></pre>
<p>Verify the status by using the <code>ufw status</code> command:</p>
<pre><code>root@********:<b>~# ufw status</b>
Status: active
To                         Action      From
--                         ------      ----
Anywhere                   ALLOW       ***.***.***.*** 
***.***.***.***            ALLOW       Anywhere 
22                         ALLOW       ***.***.***.***</code></pre>
<p>Now that the installation is complete, shut down Apache for the time being with these commands:</p>
<pre><code>root@********:<b>~# service apache2 stop</b>
root@********:<b>~# systemctl stop apache2</b></code></pre>
<p>You can still make the configuration changes, bind domains, and perform other housekeeping tasks without Apache running. Shutting down Apache minimizes the possibility that the server will get picked up in security scans or spidering. </p>
<p>In <span class="xref" itemid="xref_target_Chapter 8">Chapter 8</span>, you’ll clone a realistic landing page to host on this server. </p>
<h2 id="h1-500983c07-0002">Additional Steps for Phishing</h2>
<p class="BodyFirst">The steps discussed in this section are not mandatory for a good phish, but they provide services that clients may occasionally request. </p>
<h3 id="h2-500983c07-0005"><span epub:type="pagebreak" id="Page_96" title="96"/>Using Tracking Pixels to Measure How Often Your Email Is Opened</h3>
<p class="BodyFirst">If you are doing a nonautomated test, like the one described thus far in this chapter, you may need a means to see how many people open your email. You can easily accomplish this with <em>tracking pixels</em>, which are usually 1-pixel-by-1-pixel images that are unique to each user and rendered from a remote site that you own. You can then watch the access logs for instances of each ID connecting to the server.</p>
<p>Add the following HTML snippet to your email to set up a tracking pixel:</p>
<pre><code>&lt;img src="http://www.<var>your_site</var>/tracker.php?eid=<var>unique_id</var>" alt="" width="1px" height="1px""&gt;</code></pre>
<p>Create the file that will monitor the tracking pixel,<em> tracker.php</em>. It should look something like this:</p>
<pre><code>&lt;?php
  // Create an image, 1x1 pixel in size
  $im=imagecreate(1,1);
  // Set the background color
  $white=imagecolorallocate($im,255,255,255);
  // Allocate the background color
  imagesetpixel($im,1,1,$white);
  // Set the image type
  header("content-type:image/jpg");
  // Create a JPEG file from the image
  imagejpeg($im);
  // Free memory associated with the image
  imagedestroy($im);
?&gt;</code></pre>
<p>Tracking pixels are often used in marketing and sales. In phishing, they can create headaches and waste time for those perpetrating the attack. Automated solutions build them in. The number of emails opened is an overhyped metric in phishing. Having victims report that they received a phishing email or acted upon one is far more important than how many people open an email.</p>
<h3 id="h2-500983c07-0006">Automating Phishing with Gophish</h3>
<p class="BodyFirst">An <em>automated phishing solution</em> is a service that lets you develop a phish and send it through an automated system, such as a built-in mail interface. The solution will often monitor information such as the number of times the phish was opened and by whom, the number of times a victim clicked a link in the email, and the time at which each event occurred. These services are convenient to use, and sometimes they’re the most economical option. However, because they’re well-known, phishes sent through them are likely to get caught and shut down. </p>
<p>In this section, I’ll show you how to send phishing emails with Gophish, an automated phishing utility written in the Go language. To use it, you need to have an SMTP server to send the mail through and a web server <span epub:type="pagebreak" id="Page_97" title="97"/>at which victims will land. Although you can create both of these within Gophish, doing so might increase your chances of detection. I suggest setting up these three firewall rules to prevent detection or collateral damage:</p>
<ol class="decimal">
<li value="1">Allow port 3333/TCP (the port for the Gophish web admin interface) and port 22 (the SSH port) from your network only.</li>
<li value="2">Allow port 80/TCP (the default port for your landing page, though you could use port 443 with an SSL/TLS certificate for more realism) from your network and the victim IP ranges only.</li>
<li value="3">Allow port 25/TCP (the port for SMTP traffic) in the outbound direction only.</li>
</ol>
<p>To set these rules in UFW, execute the following commands:</p>
<pre><code><b>ufw allow from </b><var class="bold">your_IP_address </var><b>to any port 3333</b>
<b>ufw allow from </b><var class="bold">your_IP_address, QA_IP_address, and/or target_IP_range/CIDR </var><b>to any port 80 (443 if using HTTPS) </b>
<b>ufw allow from any port 25 to any</b>
<b>ufw enable</b></code></pre>
<p>Now, let’s install Gophish:</p>
<pre><code><b>cd /opt/</b>
<b>git clone https://github.com/gophish/gophish</b>
<b>cd gophish</b>
<b>apt-get install golang -y</b>
<b>go get github.com/gophish/gophish</b>
<b>go build</b></code></pre>
<p>Configure Gophish to listen on the public or private IP address that you will use to connect to it:</p>
<pre><code>root@********:<b>/opt/gophish# vi config.json</b></code></pre>
<p>Within <em>config.json</em>, change <code>admin_server listen_url</code> to the IP address of the VPS from which you’re administering the phish. Then change <code>phish_server listen_url</code> to the IP address or domain name to which you are sending victims:</p>
<pre><code>        "admin_server": {
                "listen_url": <b>"127.0.0.1:3333"</b>,
                "use_tls": true,
                "cert_path": "gophish_admin.crt",
                "key_path": "gophish_admin.key"
        },
        "phish_server": {
                "listen_url": <b>"0.0.0.0:80"</b>,
                "use_tls": false,
                "cert_path": "example.crt",
                "key_path": "example.key"
        },
        "db_name": "sqlite3",
<span epub:type="pagebreak" id="Page_98" title="98"/>        "db_path": "gophish.db",
        "migrations_prefix": "db/db_",
        "contact_address": "",
        "logging": {
                "filename": ""
        }
}</code></pre>
<p>Make sure that you change the admin password after you log in. The default credentials for Gophish are as follows:</p>
<pre><code>Username: admin
Password: gophish</code></pre>
<p>I recommend going to the <b>Settings</b> menu on the left pane and changing your password immediately. Even if you’re the only one accessing Gophish, create a new user. If multiple people will log in to this account, you must create distinct users. To do this, click the <b>Users</b><em> </em>tab, select <b>New User</b>, and then fill out the form on the page.</p>
<p>Next, you need a place to send victims. You create this via the <b>Landing Pages</b> tab, under <b>New Landing Page</b> (<a href="#figure7-7" id="figureanchor7-7">Figure 7-7</a>).</p>
<figure>
<img alt="&lt;&lt;GoPhish New Landing Page interface. Includes fields for page name, HTML, and redirection, &quot;Import Site&quot; button, and checkboxes to capture submitted data and passwords.&gt;&gt;" class="keyline" src="image_fi/500983c07/f07007.png"/>
<figcaption><p><a id="figure7-7">Figure 7-7</a>: Setting up a new landing page in Gophish</p></figcaption>
</figure>
<p><span epub:type="pagebreak" id="Page_99" title="99"/>You can build the landing page from scratch or copy and paste the HTML of another page into this.</p>
<p>Next, you have to know who you’re pretending to be when you send the phishing emails, and which mail server (in <code>ip_address:port</code> format) needs to send the email. You can configure this in the <b>Sending Profiles</b> tab, under <b>New Sending Profile</b> (<a href="#figure7-8" id="figureanchor7-8">Figure 7-8</a>).</p>
<figure>
<img alt="&lt;&lt;GoPhish New Sending Profile interface. Input fields include Name, Interface Type, From, Host, Username, Password, and Email Headers. “Ignore Certificate Errors” checkbox is selected. Shows buttons for adding a customer header and sending a test email.&gt;&gt;" class="keyline" src="image_fi/500983c07/f07008.png"/>
<figcaption><p><a id="figure7-8">Figure 7-8</a>: Setting up a new sending profile in Gophish</p></figcaption>
</figure>
<p>Now you know who is sending the email, how it’s getting to its destination, and what you want it to do, it’s time to create the actual email. One way to do this is to import an existing email—say, an email that Erica in HR got two weeks ago—and use it as a template. Gophish will use the format, style, and language of the email you import. You can configure this in the <b>Email Templates</b> tab under <b>New Template</b> (<a href="#figure7-9" id="figureanchor7-9">Figure 7-9</a>).</p>
<span epub:type="pagebreak" id="Page_100" title="100"/><figure>
<img alt="&lt;&lt;GoPhish New Template interface. Includes fields for name, subject, and plaintext and HTML. &quot;Add Tracking Image&quot; checkbox is selected. Shows buttons for importing email and adding files.&gt;&gt;" class="keyline" src="image_fi/500983c07/f07009.png"/>
<figcaption><p><a id="figure7-9">Figure 7-9</a>: Setting up a new email template in Gophish</p></figcaption>
</figure>
<p>You have everything you need. Let’s organize it into a <em>campaign</em>, which puts all the pieces you’ve worked on together to send to clients. You can configure this in the <b>Campaigns </b>tab, under <b>New Campaign</b><em> </em>(<a href="#figure7-10" id="figureanchor7-10">Figure 7-10</a>)<em>. </em></p>
<figure>
<img alt="&lt;&lt;GoPhish New Campaign interface. Includes fields for name, email template, landing page, URL, launch date, send emails by, sending profile, and groups. &quot;No profiles found!&quot; red banner shown above fields and green “Launch Campaign” button shown below.&gt;&gt;" class="keyline" src="image_fi/500983c07/f07010.png"/>
<figcaption><p><a id="figure7-10">Figure 7-10</a>: Setting up a campaign in Gophish</p></figcaption>
</figure>
<p>Once this form is complete, all you have to do is launch the campaign and wait for the results.</p>
<h3 id="h2-500983c07-0007"><span epub:type="pagebreak" id="Page_101" title="101"/>Adding HTTPS Support for Phishing Landing Pages</h3>
<p class="BodyFirst">Some users look for the green padlock associated with HTTPS websites as a litmus test to see that a site was not part of a phishing attack. Attackers took notice and started to use HTTPS in their sites. Through the use of Let’s Encrypt, we can do the same for free and give our clients a more realistic experience.</p>
<p>Let’s Encrypt is a free, automated, and open certificate authority (CA), run for the public’s benefit. It is a service provided by the Internet Security Research Group (ISRG) and is an excellent method for implementing HTTPS (for free!). Let’s install Let’s Encrypt for Gophish:</p>
<pre><code>root@*********<b>:~# cd /opt/</b>
root@*********<b>:~# wget https://dl.eff.org/certbot-auto</b>
root@*********<b>:~# chmod a+x certbot-auto</b>
root@*********<b>:~# ./certbot-auto certonly -d </b><var class="bold">your_domain</var><b> --manual --preferred-challenges dns</b></code></pre>
<p>Once the installation is complete, follow the onscreen prompts to complete any verifications in DNS and finish the setup. </p>
<p>The process is similar if you’re manually setting up your phishing attack. (Note that the setup will not auto-renew. You will have to execute the script to renew this every three months, assuming you leave it up that long.)</p>
<pre><code>root@********<b>:~# apt-get install git</b>
root@********<b>:~# git clone https://github.com/letsencrypt/letsencrypt /opt/letsencrypt</b>
root@********<b>:~# cd /opt/letsencrypt</b>
root@********<b>:~# sudo -H ./letsencrypt-auto certonly --standalone -d example.com -d www.example.com</b></code></pre>
<p>After this series of commands, you will be prompted to enter some information. Once all verifications have occurred, run this command to verify installation:</p>
<pre><code><b>sudo ls /etc/letsencrypt/live</b></code></pre>
<h3 id="h2-500983c07-0008">Using URL Shorteners in Phishing</h3>
<p class="BodyFirst">URL shorteners (like <em>Bitly</em>) can make the landing page less obviously recognizable. When deciding whether to use them, consider the perceived level of difficulty of the phishing engagement and the maturity of the target organization. Some organizations attempt to filter shortened URLs from emails, and others train users to avoid these links. Whether to use shorteners is something to discuss with your security point of contact. If you choose to use them, understand that they may be stripped from the emails.</p>
<h3 id="h2-500983c07-0009"><span epub:type="pagebreak" id="Page_102" title="102"/>Using SpoofCard for Call Spoofing </h3>
<p class="BodyFirst">The only architecture you’ll need for a vishing attack is a call spoofing platform, and if it’s legal in your target’s area, a means to record the call. </p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Warning</span></h2>
<p>	Be cautious and ensure that you have all the proper authority to record calls. You do not want to be the subject of a case study in a book about social engineering. If you are in doubt, seek professional legal advice. </p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p><em>SpoofCard</em> is a mobile application that allows you to spoof numbers, call them, record them, and even inject background noises into the call. The application itself is free, but you have to purchase credits to use it. </p>
<h2 id="h1-500983c07-0003">Timing and Delivery Considerations</h2>
<p class="BodyFirst">Now that you’ve set up your attack, you need to actually deliver it. Before doing so, you should take into account two time-related factors. </p>
<p>The first is how much time you have between preparing the architecture and performing the engagement itself. The amount of time you put into the project will tell you how likely you are to be caught using technical controls such as email filters or threat intelligence feeds. A rushed project will likely be easy to detect, but if the client wants something more advanced, you need to have the time to do the appropriate research about company lingo and culture, as well as the technologies they use, so you can seem like an insider with authorized access when you send the campaign. The bottom line? Don’t rush if you don’t have to. Sometimes your clients will need you to move quickly, but this should be the exception, not the standard.</p>
<p>Second, choose the day and time to execute the engagement carefully. Choosing the proper moment takes research. For example, if you’re vishing, you could block your number and mute your line, and then call at the same time on the same day of the week every week for a few weeks before the engagement, to see who will answer. Also pay attention to whether you are performing your engagement during working hours. If you’re posing as an employee, regardless of whether you’re spoofing or squatting, what is that person’s work schedule and patterns? If, during a phishing engagement, you pose as a person who works 10-hour shifts from 6:00 <span class="SmallCaps">AM</span> to 5:00 <span class="SmallCaps">PM</span>, Monday through Thursday, sending your email at 5:45 <span class="SmallCaps">PM</span> any day—or, worse, on Friday—is probably not a good idea. </p>
<h2 id="h1-500983c07-0004">Case Study: The $25 Advanced Persistent Phish</h2>
<p class="BodyFirst">This is the story of how I phished an organization in a creative way and for a relatively small price. In doing so, I was able to send a high-quality phish, bypass the organization’s technical defenses, and make my way into the inboxes of unsuspecting employees.</p>
<p><span epub:type="pagebreak" id="Page_103" title="103"/>On the scoping call for this engagement, my point of contact at the target company mentioned that the CEO was retiring within the next two weeks, and that the COO would be taking over. Based on this information, I devised a plan. When I shared my idea with the point of contact, he called me a devious madman and approved it. Time to get rolling on making this work!</p>
<p>To set up my phishing attack, I followed the process described in this chapter. First, I spun up a DigitalOcean droplet. Because this was a short engagement with 150 targets, I didn’t need a huge droplet with a lot of space or processing power, so I signed up for a $5 droplet. Since DigitalOcean bills by the hour, and the cost is paid at the end of the month, I had spent nothing so far. <em>Total cost: $0.</em> </p>
<p>The schedule for this attack didn’t give me much time to collect OSINT using the methods discussed in Chapters <span class="xref" itemid="xref_target_5">5</span> and <span class="xref" itemid="xref_target_6">6</span>. Instead, I dedicated my effort to enumerating the target company’s domains, recording names of pertinent employees, and finding direct quotes from the CEO and COO on the company website, in trade journals, and in press releases.</p>
<p>The next step was to buy the sending and landing page domains. The target domain had a <em>.com</em> top-level domain, so I bought the corresponding <em>.us</em> domain name. This cost about $12, because I had a promo code for the domain registration company Namecheap. Next, I bought something to the effect of <em>surveysofsatisfaction.life</em> for the web domain. The cheap domain cost me 88 cents. I subscribed to the Google apps for the email domain for $5 for the month. <em>Total cost: $17.88.</em></p>
<p>I configured the web domain to resolve to my droplet’s IP address. Then I installed a Let’s Encrypt TLS/HTTPS certificate on the domain for free. I used HTTrack to get a perfect clone of SurveyMonkey (as you’ll do in <span class="xref" itemid="xref_target_Chapter 8">Chapter 8</span>), then added a high-resolution logo from the target’s website to the page. </p>
<p>I configured the landing page to resolve to <span class="Italic">https://&lt;target company name&gt;.surveysofsatisfaction.life</span>, making it seem like the target company had its own subdomain on the survey website.<em> </em>Once again, I used the SurveyMonkey and target company logo. I also added prompts for users to submit their email addresses and passwords, and then passed these credentials to the Apache log in an HTTP GET request. </p>
<p>On a second page, I set up common password-reset questions: mother’s maiden name, first school, honeymoon location, and name of elementary school. I passed this information to the log in the same way. </p>
<p>Finally, I created a third page that said, “Sorry, this survey is closed” and started an infinite loop. The loop was initially a coding error, but I chose to leave it as a hint for the target employees that this wasn’t a legitimate survey.</p>
<p>Next, I wrote the email using direct quotes from both the CEO and COO. I’d also uncovered a specific term, <em>Owner-Associates</em>, that the company used to refer to its employees, so I used that, too. I chose to send the phish posing as the COO. I was able to send him an email from a random account and got his email signature from his out-of-office reply.</p>
<p><span epub:type="pagebreak" id="Page_104" title="104"/>The email said something to the effect of this:</p>
<blockquote class="blockquote">
<p class="Blockquote">Dear Owner-Associates:</p>
<p class="Blockquote">As you know, I will be replacing Steve as CEO next week after 37 years of dedicated, selfless, devoted service. These are enormous shoes to fill, but I will do my best. &lt;Insert Direct Quote from COO here&gt;.</p>
<p class="Blockquote">Over the years, we have had ups and downs and seek to do better. I plan on &lt;points taken from a press release&gt;. As Steve says, &lt;direct quote from the outgoing CEO’s media interviews about his retirement&gt;.</p>
<p class="Blockquote">As some of you know, I am committed to constant improvement of processes for the customers, partners, vendors, and most importantly, Owner-Associates. That’s why I have collaborated with HR to set up a SurveyMonkey survey to improve all aspects of &lt;Company Name&gt;. Please use the link below to complete this survey no later than close of business on Friday.</p>
<p class="Blockquote">&lt;Bitly Link to Web Domain&gt;</p>
<p class="Blockquote">&lt;Signature stolen from out of office reply&gt;</p></blockquote>
<p>I confirmed with my point of contact that the phish looked acceptable and received the green light to go ahead. I sent the email from the Google apps in batches of about 10 to 20 at a time, every 5 to 10 minutes, so as to not set off any potential alarms. Though my emails were eventually blocked, I managed to send enough to receive numerous survey inputs from the target’s IP address.</p>
<p>I left the website up for a week, and then verified the information the following Monday and saw that I had received more input from employees. One employee had entered information multiple times with a new password. I coordinated with the point of contact to end the engagement. I preserved the droplet for another week in case he wanted any more information. I collected metrics, controlling for out-of-office replies and emails not sent (we’ll discuss collecting metrics in <span class="xref" itemid="xref_target_Chapter 9">Chapter 9</span>). Per the contract, I was not permitted to give him the passwords entered, only the names of the employees who entered their passwords. I took backups of the web pages and the Apache log for retention and deleted the droplet. A total of two weeks had elapsed. <em>Total cost: $22.88.</em></p>
<p>On the 29th day of the subscription, I logged in to the email from which I’d sent the phish to verify that nothing of value was in there and then canceled the service. An employee had added that email address to several highly sensitive emails and mailing lists. <em>Priceless.</em><b> </b>I advised my point of contact immediately and forwarded the emails to him. I wrote up the report and then ended the engagement. </p>
<p>This great phish could have been disastrous if I were a true bad actor, and it cost me less than $25. </p>
<p><span epub:type="pagebreak" id="Page_105" title="105"/>Based on the information I’ve provided, how could this attack have been mitigated or prevented?</p>
<ul>
<li>The company should have trained all users on how to evaluate emails for suspicious context. Teach them to ask security for help when in doubt, especially when shortened URLs are involved.</li>
<li>The company should have implemented Proofpoint or a similar solution to add the word <em>[External]</em> to the beginning of the subject line of the email.</li>
<li>The company should have trained employees to evaluate the URLs of the pages to which they navigate.</li>
<li>Better coordination could have occurred between the security and networking teams. Better communication could have prevented the networking lead from emailing the company about the email, thus drawing attention to the email instead of quietly removing it from the inbox queue before the email.</li>
<li>There should have been a better incident response plan for social engineering attacks.</li>
</ul>
<h2 id="h1-500983c07-0005">Conclusion</h2>
<p class="BodyFirst">Successful social engineering engagements require significant planning and technical setup. This chapter covered how to set up a phishing attack that collected user credentials without getting caught. You first set up a DigitalOcean droplet, secured the droplet, and configured the droplet’s firewall. You then learned about considerations for setting up a realistic email server. </p>
<p>You’ll have to make many decisions in the process of phishing. We discussed how best to select a domain for your email account, as well as for the landing page to which you’ll direct users. We also discussed add-ons like tracking pixels, automated phishing services, HTTPS support, and URL shorteners. Equally important on the nontechnical side, we discussed the timing of your attack.</p>
<p>In the next chapter, you’ll set up a realistic clone of a legitimate website that you could use to harvest user credentials and sensitive information—or for some other devious purpose. </p>
</section>
</body>
</html>