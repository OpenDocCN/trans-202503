<?xml version='1.0' encoding='utf-8'?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" epub:prefix="z3998: http://www.daisy.org/z3998/2012/vocab/structure/#" lang="en" xml:lang="en">
  <head>
    <title>Project 14: Home Surveillance Camera</title>
    <link href="../styles/9781593278717.css" rel="stylesheet" type="text/css"/>
    <link href="../68851547a55f.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <div id="sbo-rt-content"><h2 class="h2" id="ch14"><span epub:type="pagebreak" id="page_171"/><strong>14<br/>Home Surveillance Camera</strong></h2>
<p class="noindent"><span class="green3">In this project, you’ll create a home surveillance camera system that streams live video on a web page that you can access from any device with browser capabilities connected to the same network as your Pi. This means you’ll be able to monitor any part of your house without getting off the sofa!</span></p>
<div class="image"><span epub:type="pagebreak" id="page_172"/><img src="../images/f0172-01.jpg" alt="image"/></div>
<p class="cap"><span class="green3"><strong>PARTS REQUIRED</strong></span></p>
<p class="cap1">Raspberry Pi</p>
<p class="cap1">Raspberry Pi Camera Module v2</p>
<p class="indentt"><span epub:type="pagebreak" id="page_173"/>In this project, you need to connect the camera to the Raspberry Pi, as we’ve shown you in <a href="ch13.xhtml#lev134">“Connecting the Camera”</a> on <a href="ch13.xhtml#page_165">page 165</a>. If you haven’t enabled the software camera yet, go back to <a href="ch13.xhtml#ch13">Project 13</a> and follow the instructions to set up the camera before continuing.</p>
<h3 class="h3" id="lev140"><span class="green3"><strong>RECORDING VIDEO TO A FILE</strong></span></h3>
<p class="noindent">Before building your home surveillance camera system, you need to learn how to record video to a file.</p>
<p class="indent">Using <a href="ch13.xhtml#ch13">Project 13</a> as a reference, connect your Raspberry Pi Camera Module v2 to your Pi using the CSI port. Create a new script called <em>record_file.py</em> in <strong>Python 3 (IDLE)</strong>, save it inside the <em>Cameras</em> folder, and enter the code in <a href="ch14.xhtml#ch14list1">Listing 14-1</a>.</p>
<p class="listing" id="ch14list1"><strong>LISTING 14-1:</strong> Record video to a file</p>
<div class="box">
<p class="programs"><span class="ent">➊</span> <span class="orange">import</span> picamera<br/><br/><span class="ent">➋</span> camera = picamera.PiCamera()<br/><br/><span class="ent">➌</span> camera.resolution = (640, 480)<br/><span class="ent">➍</span> camera.start_recording(<span class="green">'videotest.h264'</span>)<br/><span class="ent">➎</span> camera.wait_recording(60)<br/><span class="ent">➏</span> camera.stop_recording()<br/><br/>  <span class="purple">print</span>(<span class="green">'Finished recording'</span>)</p>
</div>
<p class="indent">As usual, you first import the picamera library to control the camera <span class="ent">➊</span>. You create an object called <span class="literal">camera</span> to refer to the camera <span class="ent">➋</span> and then set the camera resolution to 640×480 <span class="ent">➌</span>. The camera resolution is configurable; the maximum resolution for video recording is 1920×1080 and the minimum resolution is 64×64. To enable maximum resolution, you also need to set the frame rate to 15 by adding the line of code <span class="literal">camera.framerate = 15</span>. You can try testing this script now with different resolutions and see what works best for you, or you can just go with our settings for now and come back to it later.</p>
<p class="indent">The camera then starts recording to a file called <em>videotest.h264</em> <span class="ent">➍</span>. Feel free to change the filename, though you should keep the extension <em>.h264</em>, which is a format for video files. You then specify the amount of time that the camera should record for <span class="ent">➎</span>. In this case, the camera is recording for 60 seconds. The <span class="literal">wait_recording()</span> method also repeatedly checks for errors, such as the disk space being too full for more recording.</p>
<p class="indent">Last, you stop the video recording <span class="ent">➏</span> and print a message saying that the recording is finished. Press <strong>F5</strong> or go to <strong>Run</strong> <span class="ent">▸</span> <strong>Run Module</strong> to run the script. Your video file is located in the script’s <span epub:type="pagebreak" id="page_174"/>folder, <em>Cameras</em>. From the terminal, enter the following commands to navigate to the video folder and watch it:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~ $ <span class="codestrong">cd ~/Desktop/Projects/Cameras</span><br/>pi@raspberrypi:~/Desktop/Projects/Cameras $ <span class="codestrong">omxplayer videotest.h264</span></p>
</div>
<p class="indent">This opens a new window and plays the whole video in fullscreen. <a href="ch14.xhtml#ch14fig1">Figure 14-1</a> shows a screenshot of our video recording test.</p>
<div class="image"><a id="ch14fig1"/><img src="../images/f0174-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 14-1:</strong> Recording video with the Raspberry Pi camera</p>
<h3 class="h3" id="lev141"><span class="green3"><strong>WRITING THE SCRIPT</strong></span></h3>
<p class="noindent">Now for the important bit: you’re going to build a web page that is hosted in your Raspberry Pi—also known as a <em>web server</em>—that streams live video. (We’ll cover web servers in more detail in <a href="ch15.xhtml#ch15">Projects 15</a>, <a href="ch16.xhtml#ch16">16</a>, and <a href="ch17.xhtml#ch17">17</a>.)</p>
<p class="indent">The script for this project is advanced, so we won’t explain each line in detail. Here’s an overview of what the code should do:</p>
<ol>
<li class="noindent"><p class="list">Initialize a web server and the Pi camera.</p></li>
<li class="noindent"><p class="list">Set the web server, available at the Raspberry Pi IP address port 8000, to show a web page you can customize using HTML.</p></li>
<li class="noindent"><p class="list">Set the web page to contain the camera video streaming.</p></li>
<li class="noindent"><p class="list">Make the web server accessible from any browser connected to the same network as your Pi.</p></li>
</ol>
<h4 class="h4" id="lev142"><span epub:type="pagebreak" id="page_175"/><span class="green3"><strong>Entering the Script</strong></span></h4>
<p class="noindent">Open <strong>Python 3 (IDLE)</strong> and go to <strong>File</strong> <span class="ent">▸</span> <strong>New</strong> to create a new script. Enter the code in <a href="ch14.xhtml#ch14list2">Listing 14-2</a>, and save it as <em>surveillance_system.py</em> in the <em>Cameras</em> folder (remember that you can download all the scripts at <em><a href="https://www.nostarch.com/RaspberryPiProject/">https://www.nostarch.com/RaspberryPiProject/</a></em>).</p>
<p class="indent">This script was based on the web streaming example at <em><a href="http://picamera.readthedocs.io/en/latest/recipes2.html">http://picamera.readthedocs.io/en/latest/recipes2.html</a></em>.</p>
<p class="listing" id="ch14list2"><strong>LISTING 14-2:</strong> Stream video to a web page</p>
<div class="box">
<p class="programs">  <span class="orange">import</span> io<br/>  <span class="orange">import</span> picamera<br/>  <span class="orange">import</span> logging<br/>  <span class="orange">import</span> socketserver<br/>  <span class="orange">from</span> threading <span class="orange">import</span> Condition<br/>  <span class="orange">from</span> http <span class="orange">import</span> server<br/><br/><span class="ent">➊</span> PAGE=<span class="green">"""\</span><br/>  <span class="green">&lt;html&gt;</span><br/>  <span class="green">&lt;head&gt;</span><br/>  <span class="green">&lt;title&gt;Raspberry Pi - Surveillance Camera&lt;/title&gt;</span><br/>  <span class="green">&lt;/head&gt;</span><br/>  <span class="green">&lt;body&gt;</span><br/>  <span class="green">&lt;center&gt;&lt;h1&gt;Raspberry Pi - Surveillance Camera&lt;/h1&gt;&lt;/center&gt;</span><br/>  <span class="green">&lt;center&gt;&lt;img src="stream.mjpg" width="640" height="480"&gt;&lt;/center&gt;</span><br/>  <span class="green">&lt;/body&gt;</span><br/>  <span class="green">&lt;/html&gt;</span><br/>  <span class="green">"""</span><br/><br/>  <span class="orange">class</span> <span class="blue">StreamingOutput</span>(object):<br/>      <span class="orange">def</span> <span class="blue">__init__</span>(self):<br/>          self.frame = <span class="orange">None</span><br/>          self.buffer = io.BytesIO()<br/>          self.condition = Condition()<br/><br/>      <span class="orange">def</span> <span class="blue">write</span>(self, buf):<br/>          <span class="orange">if</span> buf.startswith(<span class="green">b'\xff\xd8'</span>):<br/>              <span class="red1">#new frame, copy the existing buffer's content and</span><br/>              <span class="red1">#notify all clients it's available</span><br/>              self.buffer.truncate()<br/>              <span class="orange">with</span> self.condition:<br/>                  self.frame = self.buffer.getvalue()<br/>                  self.condition.notify_all()<br/>              self.buffer.seek(0)<br/>          <span class="orange">return</span> self.buffer.write(buf)<br/><br/>  <span class="orange">class</span> <span class="blue">StreamingHandler</span>(server.BaseHTTPRequestHandler):<br/>      <span class="orange">def</span> <span class="blue">do_GET</span>(self):<br/>          <span class="orange">if</span> self.path == <span class="green">'/'</span>:<br/>              self.send_response(301)<br/>              self.send_header(<span class="green">'Location', '/index.html'</span>)<br/>              self.end_headers()<br/>          <span class="orange">elif</span> self.path == <span class="green">'/index.html'</span>:<br/><span epub:type="pagebreak" id="page_176"/>              content = PAGE.encode(<span class="green">'utf-8'</span>)<br/>              self.send_response(200)<br/>              self.send_header(<span class="green">'Content-Type', 'text/html'</span>)<br/>              self.send_header(<span class="green">'Content-Length'</span>, <span class="purple">len</span>(content))<br/>              self.end_headers()<br/>              self.wfile.write(content)<br/>          <span class="orange">elif</span> self.path == <span class="green">'</span><span class="green">/stream.mjpg'</span>:<br/>              self.send_response(200)<br/>              self.send_header(<span class="green">'Age'</span>, 0)<br/>              self.send_header(<span class="green">'Cache-Control'</span>, <span class="green">'no-cache, private'</span>)<br/>              self.send_header(<span class="green">'Pragma'</span>, <span class="green">'no-cache'</span>)<br/>              self.send_header(<span class="green">'Content-Type'</span>, <br/>  <span class="green">'multipart/x-mixed-replace; boundary=FRAME'</span>)<br/>              self.end_headers()<br/>              <span class="orange">try</span>:<br/>                  <span class="orange">while</span> <span class="orange">True</span>:<br/>                      <span class="orange">with</span> output.condition:<br/>                          output.condition.wait()<br/>                          frame = output.frame<br/>                      self.wfile.write(<span class="green">b'--FRAME\r\n'</span>)<br/>                      self.send_header(<span class="green">'Content-Type', 'image/jpeg'</span>)<br/>                      self.send_header(<span class="green">'Content-Length'</span>, <span class="purple">len</span>(frame))<br/>                      self.end_headers()<br/>                      self.wfile.write(frame)<br/>                      self.wfile.write(<span class="green">b'\r\n'</span>)<br/>              <span class="orange">except</span> <span class="purple">Exception</span> <span class="orange">as</span> e:<br/>                  logging.warning(<br/>                      <span class="green">'</span><span class="green">Removed streaming client %s: %s'</span>,<br/>                      self.client_address, <span class="purple">str</span>(e))<br/>          <span class="orange">else</span>:<br/>              self.send_error(404)<br/>              self.end_headers()<br/><br/>  <span class="orange">class</span> <span class="blue">StreamingServer</span>(socketserver.ThreadingMixIn,<br/>  server.HTTPServer):<br/>      allow_reuse_address = <span class="orange">True</span><br/>      daemon_threads = <span class="orange">True</span><br/><br/><span class="ent">➋</span> <span class="orange">with</span> picamera.PiCamera(resolution=<span class="green">'640x480'</span>, framerate=24) <span class="orange">as</span><br/>  camera:<br/>      output = StreamingOutput()<br/>      camera.start_recording(output, <span class="purple">format</span>=<span class="green">'mjpeg'</span>)<br/>      <span class="orange">try</span>:<br/>          address = (<span class="green">''</span>, 8000)<br/>          server = StreamingServer(address, StreamingHandler)<br/>          server.serve_forever()<br/>      <span class="orange">finally</span>:<br/>          camera.stop_recording()</p>
</div>
<p class="indent"><a href="ch14.xhtml#ch14list2">Listing 14-2</a> is more complicated than the scripts we’ve been writing so far, and explaining each class and function necessary for video streaming goes beyond the book’s scope, so we won’t go into it here.</p>
<p class="indent"><span epub:type="pagebreak" id="page_177"/>There is space for customization, though. You can edit the way your web page looks and the camera settings:</p>
<ul>
<li class="noindent">At <span class="ent">➊</span>, you define your web page content using HTML; here you can change the title and heading of your web page. Check <a href="ch15.xhtml#ch15">Project 15</a> for more information about HTML, as well as to learn how to style your web page using CSS.</li>
<li class="noindent">At <span class="ent">➋</span>, you initialize the camera; here you can change the camera resolution and frame rate.</li>
</ul>
<h4 class="h4" id="lev143"><span class="green3"><strong>Running the Script</strong></span></h4>
<p class="noindent">Press <strong>F5</strong> or go to <strong>Run</strong> <span class="ent">▸</span> <strong>Run Module</strong> to run the script. Once the script is running, your camera will stream to the web page. To access this page, you need to find the IP address for your Pi and enter the URL <em>http://&lt;Pi IP address&gt;:8000</em>, replacing <em>&lt;Pi IP address&gt;</em> with your Pi’s IP address.</p>
<p class="indent">To find your Pi’s IP address, go to the terminal and enter the following:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~ $ <span class="codestrong">hostname -I</span></p>
</div>
<p class="indent">This will print the Pi’s IP address, as highlighted in <a href="ch14.xhtml#ch14fig2">Figure 14-2</a>.</p>
<div class="image"><a id="ch14fig2"/><img src="../images/f0177-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 14-2:</strong> Finding your Raspberry Pi’s IP address</p>
<p class="indent">Congratulations—you’ve built your own home surveillance system! You can access the video streaming from a computer, smartphone, or tablet browser connected to the local network. In this example, since our IP address is 192.168.1.112, we enter <em>http://192.168.1.112:8000</em>. Make sure you use your own IP address.</p>
<h3 class="h3" id="lev144"><span epub:type="pagebreak" id="page_178"/><span class="green3"><strong>TAKING IT FURTHER</strong></span></h3>
<p class="noindent">In this project you’ve learned how to record video and how to build a web server that streams live video footage. You can mix what you’ve learned here with other projects to enhance them. For example:</p>
<ul>
<li class="noindent">Edit <a href="ch13.xhtml#ch13">Project 13</a> so that the Pi records video for a specified time when it detects movement inside your house while you’re out.</li>
<li class="noindent">Customize the streaming web page with CSS using the skills you’ll learn in <a href="ch15.xhtml#ch15">Project 15</a>.</li>
</ul>
</div>
  </body>
</html>
