<html><head></head><body>
<h2 class="h2" id="ch04"><span epub:type="pagebreak" id="page_79"/><span class="big">4</span><br/>CONFIGURING YOUR PROJECT WITH AUTOCONF</h2>&#13;
<p class="quote"><em>Come my friends, ’Tis not too late to seek a newer world.<br/>—Alfred, Lord Tennyson, “Ulysses”</em></p>&#13;
<div class="image1"><img src="../images/common.jpg" alt="Image"/></div>&#13;
<p class="noindent">The Autoconf project has had a long history, starting in 1992 when David McKenzie, while volunteering for the Free Software Foundation, was looking for a way to simplify the process of creating the complex configuration scripts necessary to support the target platforms that were being added daily at that time to the GNU project. At the same time, he was working on his bachelor’s degree in computer science at the University of Maryland, College Park.</p>&#13;
<p class="indent">After McKenzie’s initial work on Autoconf, he continued to be a strong contributor to the project through 1996, at which point Ben Elliston took over project maintenance. Since then, maintainers and primary contributors have included Akim Demaille, Jim Meyering, Alexandre Oliva, Tom Tromey, Lars J. Aas (inventor of the name <em>autom4te</em>, among others), Mo DeJong, Steven G. Johnson, Matthew D. Langston, Paval Roskin, and Paul Eggert (the list of contributors is much longer—see the Autoconf <em>AUTHORS</em> file for more history).</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_80"/>Today’s maintainer, Eric Blake, began making strong contributions to Autoconf in 2012. He’s been maintainer of the project ever since while working for Red Hat. Because Automake and Libtool are essentially add-on components to the original Autoconf framework, it’s useful to spend some time focusing on using Autoconf without Automake and Libtool. This will provide a fair amount of insight into how Autoconf operates by exposing aspects of the tool that are often hidden by Automake.</p>&#13;
<p class="indent">Before Automake came along, Autoconf was used alone. In fact, many legacy open source projects never made the transition from Autoconf to the full GNU Autotools suite. As a result, it’s not unusual to find a file called <em>configure.in</em> (the original Autoconf naming convention), as well as handwritten <em>Makefile.in</em> templates, in older open source projects.</p>&#13;
<p class="indent">In this chapter, I’ll show you how to add an Autoconf build system to an existing project. I’ll spend most of this chapter talking about the more basic features of Autoconf, and in <a href="ch05.xhtml">Chapter 5</a> I’ll go into much more detail about how some of the more complex Autoconf macros work and how to properly use them. Throughout this process, we’ll continue using the Jupiter project as our example.</p>&#13;
<h3 class="h3" id="ch04sec1">Autoconf Configuration Scripts</h3>&#13;
<p class="noindent">The input to the <code>autoconf</code> program is Bourne shell script sprinkled with macro calls. The input data stream must also include the definitions of all referenced macros—both those that Autoconf provides and those that you write yourself.</p>&#13;
<p class="indent">The macro language used in Autoconf is called <em>M4</em>. (The name means <em>M, plus 4 more letters</em>, or the word <em>Macro</em>.<sup><a id="ch04fn_1" href="footnote.xhtml#ch04fn1">1</a></sup>) The <code>m4</code> utility is a general-purpose macro language processor originally written by Brian Kernighan and Dennis Ritchie in 1977.</p>&#13;
<p class="indent">While you may not be familiar with it, you can find some form of M4 on every Unix and Linux variant (as well as other systems) in use today. The ubiquitous nature of this tool is the main reason it’s used by Autoconf, as the original design goals of Autoconf stated that it should be able to run on all systems without the addition of complex tool chains and utility sets.<sup><a id="ch04fn_2" href="footnote.xhtml#ch04fn2">2</a></sup></p>&#13;
<p class="indent">Autoconf depends on the existence of relatively few tools: a Bourne shell, M4, and a Perl interpreter. The configuration scripts and makefiles it generates rely on the existence of a different set of tools, including a Bourne shell, <code>grep</code>, <code>ls</code>, and <code>sed</code> or <code>awk</code>.<sup><a id="ch04fn_3" href="footnote.xhtml#ch04fn3">3</a></sup></p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><span epub:type="pagebreak" id="page_81"/><em>Do not confuse the requirements of the Autotools with the requirements of the scripts and makefiles they generate. The Autotools are maintainer tools, whereas the resulting scripts and makefiles are end user tools. We can reasonably expect a higher level of installed functionality on development systems than we can on end user systems.</em></p>&#13;
</div>&#13;
<p class="indent">The configuration script ensures that the end user’s build environment is configured to properly build your project. This script checks for installed tools, utilities, libraries, and header files, as well as for specific functionality within these resources. What distinguishes Autoconf from other project configuration frameworks is that Autoconf tests also ensure that these resources can be properly consumed by your project. You see, it’s important not only that your users have <em>libxyz.so</em> and its public header files properly installed on their systems but also that they have compatible versions of these files. Autoconf is pathological about such tests. It ensures that the end user’s environment is in compliance with the project requirements by compiling and linking a small test program for each feature—a quintessential example, if you will, that does what your project source code does on a larger scale.</p>&#13;
<p class="indent"><em>Can’t I just ensure that</em> libxyz.2.1.0.so <em>is installed by searching library paths for the filename?</em> The answer to this question is debatable. There are legitimate situations where libraries and tools get updated quietly. Sometimes, the specific functionality upon which your project relies is added in the form of a security bug fix or enhancement to a library, in which case vendors aren’t even required to bump up the version number. But it’s often difficult to tell whether you’ve got version 2.1.0.r1 or version 2.1.0.r2 unless you look at the file size or call a library function to make sure it works as expected.</p>&#13;
<p class="indent">Additionally, vendors often backport bug fixes and features from newer products onto older platforms without bumping the version number. Hence, you can’t tell even by looking at the version number whether the library supports a feature that was added <em>after</em> that version of the library was published.</p>&#13;
<p class="indent">However, the most significant reason for not relying on library version numbers is that they do not represent specific marketing releases of a library. As we will discuss in <a href="ch08.xhtml">Chapter 8</a>, library version numbers indicate binary interface characteristics on a particular platform. This means that library version numbers for the same feature set can be different from platform to platform. As a result, you may not be able to tell—short of compiling and linking against the library—whether or not a particular library has the functionality your project needs.</p>&#13;
<p class="indent">Finally, there are several important cases where the same functionality is provided by entirely different libraries on different systems. For example, you may find cursor manipulation functionality in <em>libtermcap</em> on one system, <em>libncurses</em> on another, and <em>libcurses</em> on yet another system. But it’s not critical that you know about all of these side cases, because your users will tell you when your project won’t build on their system because of such a discrepancy.</p>&#13;
<p class="indent">What can you do when such a bug is reported? You can use the Autoconf <code>AC_SEARCH_LIBS</code> macro to test multiple libraries for the same functionality. Simply add a library to the search list, and you’re done. Since this fix is so easy, it’s likely the user who noticed the problem will simply send a patch to your <em>configure.ac</em> file.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_82"/>Because Autoconf tests are written in shell script, you have a lot of flexibility as to how the tests operate. You can write a test that merely checks for the existence of a library or utility in the usual locations on your user’s system, but this bypasses some of the most significant features of Autoconf. Fortunately, Autoconf provides dozens of macros that conform to Autoconf’s feature-testing philosophy. You should carefully study and use the list of available macros, rather than write your own, because they’re specifically designed to ensure that the desired functionality is available on the widest variety of systems and platforms.</p>&#13;
<h3 class="h3" id="ch04sec2">The Shortest configure.ac File</h3>&#13;
<p class="noindent">The input file for <code>autoconf</code> is called <em>configure.ac</em>. The simplest possible <em>configure.ac</em> file has just two lines, as shown in <a href="ch04.xhtml#ch04ex01">Listing 4-1</a>.</p>&#13;
<pre>AC_INIT([Jupiter], [1.0])&#13;
AC_OUTPUT</pre>&#13;
<p class="caption"><a id="ch04ex01"/><em>Listing 4-1: The simplest configure.ac file</em></p>&#13;
<p class="indent">To those new to Autoconf, these two lines appear to be a couple of function calls, perhaps in the syntax of some obscure programming language. Don’t let their appearance throw you—these are M4 macro invocations. The macros are defined in files distributed with the autoconf package. You can find the definition of <code>AC_INIT</code>, for example, in <em>general.m4</em> in Autoconf’s installation directory (usually <em>/usr/(local/)share/autoconf/autoconf</em>). <code>AC_OUTPUT</code> is defined in <em>status.m4</em> in the same directory.</p>&#13;
<h3 class="h3" id="ch04sec3">Comparing M4 to the C Preprocessor</h3>&#13;
<p class="noindent">M4 macros are similar in many ways to the C-preprocessor (CPP) macros defined in C-language source files. The C preprocessor is also a text replacement tool, which isn’t surprising: both M4 and the C preprocessor were designed and written by Kernighan and Ritchie around the same time.</p>&#13;
<p class="indent">Autoconf uses square brackets around macro parameters as a quoting mechanism. Quotes are necessary only for cases in which the context of the macro call could cause an ambiguity that the macro processor may resolve incorrectly (usually without telling you). We’ll discuss M4 quoting in much more detail in <a href="ch16.xhtml">Chapter 16</a>. For now, just use square brackets around every argument to ensure that the expected macro expansions are generated.</p>&#13;
<p class="indent">As with CPP macros, you can define M4 macros to accept a comma-delimited list of arguments enclosed in parentheses. With CPP, macros are defined using a <em>preprocessor directive</em>: <code>#define</code> <em><code>name</code></em><code>(</code><em><code>args</code></em><code>)</code> <em><code>expansion</code></em>, while in M4, macros are defined with a built-in macro: <code>define(</code><em><code>name</code></em><code>,</code> <em><code>expansion</code></em><code>)</code>. Another significant difference is that in CPP, the arguments specified in <span epub:type="pagebreak" id="page_83"/>the macro definition are required,<sup><a id="ch04fn_4" href="footnote.xhtml#ch04fn4">4</a></sup> while in M4, the arguments to parameterized macros are optional and the caller may simply omit them. If no arguments are passed, you can also omit the parentheses. Extra arguments passed to M4 macros are simply ignored. Finally, M4 does not allow intervening whitespace between a macro name and the opening parenthesis in a macro invocation.</p>&#13;
<h3 class="h3" id="ch04sec4">The Nature of M4 Macros</h3>&#13;
<p class="noindent">If you’ve been programming in C for many years, you’ve no doubt run across a few C-preprocessor macros from the dark regions of the lower realm. I’m talking about those truly evil macros that expand into one or two pages of C code. They should have been written as C functions, but their authors were either overly worried about performance or just got carried away, and now it’s your turn to debug and maintain them. But, as any veteran C programmer will tell you, the slight performance gains you get by using a macro where you should have used a function do not justify the trouble you cause maintainers trying to debug your fancy macros. Debugging such macros can be a nightmare because the source code generated by macros is usually inaccessible from within a symbolic debugger.<sup><a id="ch04fn_5" href="footnote.xhtml#ch04fn5">5</a></sup></p>&#13;
<p class="indent">Writing such complex macros is viewed by M4 programmers as a sort of macro nirvana—the more complex and functional they are, the “cooler” they are. The two Autoconf macros in <a href="ch04.xhtml#ch04ex01">Listing 4-1</a> expand into a file containing almost 2,400 lines of Bourne-shell script that total more than 70KB! But you wouldn’t guess this by looking at their definitions. They’re both fairly short—only a few dozen lines each. The reason for this apparent disparity is simple: they’re written in a modular fashion, with each macro expanding several others, which in turn expand several others, and so on.</p>&#13;
<p class="indent">For the same reasons that programmers are taught not to abuse the C preprocessor, the extensive use of M4 causes a fair amount of frustration for those trying to understand Autoconf. That’s not to say Autoconf shouldn’t use M4 this way; quite the contrary—this is the domain of M4. But there is a school of thought that says M4 was a poor choice for Autoconf because of the problems with macros mentioned earlier. Fortunately, being able to use Autoconf effectively usually doesn’t require a deep understanding of the inner workings of the macros that ship with it.<sup><a id="ch04fn_6" href="footnote.xhtml#ch04fn6">6</a></sup></p>&#13;
<h3 class="h3" id="ch04sec5"><span epub:type="pagebreak" id="page_84"/>Executing autoconf</h3>&#13;
<p class="noindent">Running Autoconf is simple: just execute <code>autoconf</code> in the same directory as your <em>configure.ac</em> file. While I could do this for each example in this chapter, I’m going to use the <code>autoreconf</code> program instead of the <code>autoconf</code> program, because running <code>autoreconf</code> has exactly the same effect as running <code>autoconf</code>, except that <code>autoreconf</code> will also do the right thing when you start adding Automake and Libtool functionality to your build system. That is, it will execute all of the Autotools in the right order based on the contents of your <em>configure.ac</em> file.</p>&#13;
<p class="indent">The <code>autoreconf</code> program is smart enough to execute only the tools you need, in the order you need them, with the options you want (with one caveat that I’ll mention shortly). Therefore, running <code>autoreconf</code> is the recommended method for executing the Autotools tool chain.</p>&#13;
<p class="indent">Let’s start by adding the simple <em>configure.ac</em> file from <a href="ch04.xhtml#ch04ex01">Listing 4-1</a> to our project directory. The top-level directory currently contains only a <em>Makefile</em> and a <em>src</em> directory that contains its own <em>Makefile</em> and a <em>main.c</em> file. Once you’ve added <em>configure.ac</em> to the top-level directory, run <code>autoreconf</code>:</p>&#13;
<p class="margin">Git tag 4.0</p>&#13;
<pre>$ <span class="codestrong1">autoreconf</span>&#13;
$&#13;
$ <span class="codestrong1">ls -1p</span>&#13;
autom4te.cache/&#13;
configure&#13;
configure.ac&#13;
Makefile&#13;
src/&#13;
$</pre>&#13;
<p class="indent">First, notice that <code>autoreconf</code> operates silently by default. If you want to see something happening, use the <code>-v</code> or <code>--verbose</code> option. If you want <code>autoreconf</code> to execute the Autotools in verbose mode as well, then add <code>-vv</code> to the command line.<sup><a id="ch04fn_7" href="footnote.xhtml#ch04fn7">7</a></sup></p>&#13;
<p class="indent">Next, notice that <code>autoconf</code> creates a directory called <em>autom4te.cache</em>. This is the <code>autom4te</code> cache directory. This cache speeds up access to <em>configure.ac</em> during successive executions of utilities in the Autotools tool chain.</p>&#13;
<p class="indent">The result of passing <em>configure.ac</em> through <code>autoconf</code> is essentially the same file (now called <code>configure</code>), but with all of the macros fully expanded. You’re welcome to take a look at <code>configure</code>, but don’t be too surprised if you don’t immediately understand what you see. The <em>configure.ac</em> file has been transformed, through M4 macro expansions, into a text file containing thousands of lines of complex Bourne shell script.</p>&#13;
<h3 class="h3" id="ch04sec6"><span epub:type="pagebreak" id="page_85"/>Executing configure</h3>&#13;
<p class="noindent">As discussed in “Configuring Your Package” on <a href="ch03.xhtml#page_77">page 77</a>, the <em>GNU Coding Standards</em> indicate that a handwritten <code>configure</code> script should generate another script called <code>config.status</code>, whose job it is to generate files from templates. Unsurprisingly, this is exactly the sort of functionality you’ll find in an Autoconf-generated configuration script. This script has two primary tasks:</p>&#13;
<ul>&#13;
<li class="noindent">Perform requested checks</li>&#13;
<li class="noindent">Generate and then call <code>config.status</code></li>&#13;
</ul>&#13;
<p class="indent">The results of the checks performed by <code>configure</code> are written into <code>config</code><code>.status</code> in a manner that allows them to be used as replacement text for Autoconf substitution variables in template files (<em>Makefile.in</em>, <em>config.h.in</em>, and so on). When you execute <code>./configure</code>, it tells you that it’s creating <code>config.status</code>. It also creates a log file called <em>config.log</em> that has several important attributes. Let’s run <code>./configure</code> and then see what’s new in our project directory:</p>&#13;
<pre>$ <span class="codestrong1">./configure</span>&#13;
configure: creating ./config.status&#13;
$&#13;
$ <span class="codestrong1">ls -1p</span>&#13;
autom4te.cache/&#13;
config.log&#13;
config.status&#13;
configure&#13;
configure.ac&#13;
Makefile&#13;
src/&#13;
$</pre>&#13;
<p class="indent">We see that <code>configure</code> has indeed generated both <code>config.status</code> and <em>config.log</em><em/>. The <em>config.log</em> file contains the following information:</p>&#13;
<ul>&#13;
<li class="noindent">The command line that was used to invoke <code>configure</code> (very handy!)</li>&#13;
<li class="noindent">Information about the platform on which <code>configure</code> was executed</li>&#13;
<li class="noindent">Information about the core tests <code>configure</code> executed</li>&#13;
<li class="noindent">The line number in <code>configure</code> at which <code>config.status</code> is generated and then called</li>&#13;
</ul>&#13;
<p class="indent">At this point in the log file, <code>config.status</code> takes over generating log information and adds the following:</p>&#13;
<ul>&#13;
<li class="noindent">The command line used to invoke <code>config.status</code></li>&#13;
</ul>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_86"/>After <code>config.status</code> generates all the files from their templates, it exits, returning control to <code>configure</code>, which then appends the following information to the log:</p>&#13;
<ul>&#13;
<li class="noindent">The cache variables that <code>config.status</code> used to perform its tasks</li>&#13;
<li class="noindent">The list of output variables that may be replaced in templates</li>&#13;
<li class="noindent">The exit code <code>configure</code> returned to the shell</li>&#13;
</ul>&#13;
<p class="indent">This information is invaluable when you’re debugging a <code>configure</code> script and its associated <em>configure.ac</em> file.</p>&#13;
<p class="indent">Why doesn’t <code>configure</code> just execute the code it writes into <code>config.status</code> instead of going to all the trouble of generating a second script, only to immediately call it? There are a few good reasons. First, the operations of performing checks and generating files are conceptually different, and the <code>make</code> utility works best when conceptually different operations are associated with separate targets. A second reason is that you can execute <code>config.status</code> separately to regenerate output files from their corresponding template files, saving the time required to perform those lengthy checks. Finally, <code>config.status</code> is written to remember the parameters originally used on the <code>configure</code> command line. Thus, when <code>make</code> detects that it needs to update the build system, it can call <code>config.status</code> to re-execute <code>configure</code>, using the command line options that were originally specified.</p>&#13;
<h3 class="h3" id="ch04sec7">Executing config.status</h3>&#13;
<p class="noindent">Now that you know how <code>configure</code> works, you might be tempted to execute <code>config.status</code> yourself. This was exactly the intent of the Autoconf designers and the authors of the <em>GCS</em>, who originally conceived these design goals. However, a more important reason for separating checks from template processing is that <code>make</code> rules can use <code>config.status</code> to regenerate makefiles from their templates when <code>make</code> determines that a template is newer than its corresponding makefile.</p>&#13;
<p class="indent">Rather than call <code>configure</code> to perform needless checks (your environment hasn’t changed—just your template files), makefile rules should be written to indicate that output files depend on their templates. The commands for these rules run <code>config.status</code>, passing the rule’s target as a parameter. If, for example, you modify one of your <em>Makefile.in</em> templates, <code>make</code> calls <code>config.status</code> to regenerate the corresponding <em>Makefile</em>, after which <code>make</code> re-executes its own original command line—basically restarting itself.<sup><a id="ch04fn_8" href="footnote.xhtml#ch04fn8">8</a></sup></p>&#13;
<p class="indent"><a href="ch04.xhtml#ch04ex02">Listing 4-2</a> shows the relevant portion of such a <em>Makefile.in</em> template, containing the rules needed to regenerate the corresponding <em>Makefile</em>.</p>&#13;
<pre><span epub:type="pagebreak" id="page_87"/>Makefile: Makefile.in config.status&#13;
        ./config.status $@</pre>&#13;
<p class="caption"><a id="ch04ex02"/><em>Listing 4-2: A rule that causes <code>make</code> to regenerate</em> Makefile <em>if its template has changed</em></p>&#13;
<p class="indent">A rule with a target named <code>Makefile</code> is the trigger here. This rule allows <code>make</code> to regenerate the source makefile from its template if the template changes. It does this <em>before</em> executing either the user’s specified targets or the default target, if no specific target was given. This functionality is built into <code>make</code>—if there’s a rule whose target is <code>Makefile</code>, <code>make</code> always evaluates that rule first.</p>&#13;
<p class="indent">The rule in <a href="ch04.xhtml#ch04ex02">Listing 4-2</a> indicates that <em>Makefile</em> is dependent on <code>config</code><code>.status</code> as well as <em>Makefile.in</em>, because if <code>configure</code> updates <code>config.status</code>, it may generate <em>Makefile</em> differently. Perhaps different command line options were provided so that <code>configure</code> can now find libraries and header files it couldn’t find previously. In this case, Autoconf substitution variables may have different values. Thus, <em>Makefile</em> should be regenerated if either <em>Makefile.in</em> or <code>config .status</code> is updated.</p>&#13;
<p class="indent">Since <code>config.status</code> is itself a generated file, it stands to reason that you could write such a rule to regenerate this file when needed. Expanding on the previous example, <a href="ch04.xhtml#ch04ex03">Listing 4-3</a> adds the required code to rebuild <code>config.status</code> if <code>configure</code> changes.</p>&#13;
<pre><span class="ash">Makefile: Makefile.in config.status</span>&#13;
        <span class="ash">./config.status $@</span>&#13;
&#13;
config.status: configure&#13;
        ./config.status --recheck</pre>&#13;
<p class="caption"><a id="ch04ex03"/><em>Listing 4-3: A rule to rebuild <code>config.status</code> when <code>configure</code> changes</em></p>&#13;
<p class="indent">Since <code>config.status</code> is a dependency of the <code>Makefile</code> target, <code>make</code> will look for a rule whose target is <code>config.status</code> and run its commands if needed.</p>&#13;
<h3 class="h3" id="ch04sec8">Adding Some Real Functionality</h3>&#13;
<p class="noindent">I’ve suggested before that you should call <code>config.status</code> in your makefiles to generate those makefiles from templates. <a href="ch04.xhtml#ch04ex04">Listing 4-4</a> shows the code in <em>configure.ac</em> that actually makes this happen. It’s just a single additional macro call between the two original lines of <a href="ch04.xhtml#ch04ex01">Listing 4-1</a>.</p>&#13;
<p class="margin">Git tag 4.1</p>&#13;
<pre><span class="ash">AC_INIT([Jupiter],[1.0])</span>&#13;
AC_CONFIG_FILES([Makefile src/Makefile])&#13;
<span class="ash">AC_OUTPUT</span></pre>&#13;
<p class="caption"><a id="ch04ex04"/><em>Listing 4-4:</em> configure.ac: <em>Using the <code>AC_CONFIG_FILES</code> macro</em></p>&#13;
<p class="indent">This code assumes that templates exist for <em>Makefile</em> and <em>src/Makefile</em>, called <em>Makefile.in</em> and <em>src/Makefile.in</em>, respectively. These template files look <span epub:type="pagebreak" id="page_88"/>exactly like their <em>Makefile</em> counterparts, with one exception: any text I want Autoconf to replace is marked as an Autoconf substitution variable, using the <code>@</code><em><code>VARIABLE</code></em><code>@</code> syntax.</p>&#13;
<p class="indent">To create these files, simply rename the existing <em>Makefile</em> files to <em>Makefile.in</em> in both the top-level and <em>src</em> directories. This is a common practice when <em>autoconfiscating</em> a project:</p>&#13;
<pre>$ <span class="codestrong1">mv Makefile Makefile.in</span>&#13;
$ <span class="codestrong1">mv src/Makefile src/Makefile.in</span>&#13;
$</pre>&#13;
<p class="indent">With these changes in place, we are now effectively using our new <em>configure.ac</em> file in Jupiter to generate makefiles. To make it useful, let’s add a few Autoconf substitution variables to replace the original default values. At the top of these files, I’ve also added the Autoconf substitution variable, <code>@configure_input@</code>, after a comment hash mark. <a href="ch04.xhtml#ch04ex05">Listing 4-5</a> shows the comment text that is generated in <em>Makefile</em>.</p>&#13;
<p class="margin">Git tag 4.2</p>&#13;
<pre># Makefile. Generated from Makefile.in by configure.&#13;
<span class="codeitalic1">--snip--</span></pre>&#13;
<p class="caption"><a id="ch04ex05"/><em>Listing 4-5:</em> Makefile: <em>The text generated from the Autoconf <code>@configure_input@</code> variable</em></p>&#13;
<p class="indent">I’ve also added the makefile regeneration rules from the previous examples to each of these templates, with slight path differences in each file to account for their different positions relative to <code>config.status</code> and <code>configure</code> in the build directory.</p>&#13;
<p class="indent"><a href="ch04.xhtml#ch04ex06">Listings 4-6</a> and <a href="ch04.xhtml#ch04ex07">4-7</a> highlight the required changes to the final recursive versions of <em>Makefile</em> and <em>src/Makefile</em> from near the end of <a href="ch03.xhtml">Chapter 3</a>. We’ll consider writing nonrecursive versions of these files later as we cover Automake—the process when using Autoconf with handwritten <em>Makefile.in</em> templates is nearly identical to what we did in <a href="ch03.xhtml">Chapter 3</a> with makefiles.<sup><a id="ch04fn_9" href="footnote.xhtml#ch04fn9">9</a></sup></p>&#13;
<pre># @configure_input@&#13;
&#13;
# Package-specific substitution variables&#13;
<span class="ash">package =</span> @PACKAGE_NAME@&#13;
<span class="ash">version =</span> @PACKAGE_VERSION@&#13;
<span class="ash">tarname =</span> @PACKAGE_TARNAME@&#13;
<span class="ash">distdir = $(tarname)-$(version)</span>&#13;
&#13;
# Prefix-specific substitution variables&#13;
<span class="ash">prefix =</span> @prefix@&#13;
<span class="ash">exec_prefix =</span> @exec_prefix@&#13;
<span class="ash">bindir =</span> @bindir@&#13;
&#13;
<span class="ash">all clean check install uninstall jupiter:</span>&#13;
        <span class="ash">cd src &amp;&amp; $(MAKE) $@</span>&#13;
<span epub:type="pagebreak" id="page_89"/><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">$(distdir): FORCE</span>&#13;
        <span class="ash">mkdir -p $(distdir)/src</span>&#13;
        cp configure.ac $(distdir)&#13;
        cp configure $(distdir)&#13;
        <span class="ash">cp Makefile</span>.in <span class="ash">$(distdir)</span>&#13;
        <span class="ash">cp src/Makefile</span>.in <span class="ash">src/main.c $(distdir)/src</span>&#13;
&#13;
<span class="ash">distcheck: $(distdir).tar.gz</span>&#13;
        <span class="ash">gzip -cd $(distdir).tar.gz | tar xvf -</span>&#13;
        cd $(distdir) &amp;&amp; ./configure&#13;
        <span class="ash">cd $(distdir) &amp;&amp; $(MAKE) all</span>&#13;
        <span class="ash">cd $(distdir) &amp;&amp; $(MAKE) check</span>&#13;
        <span class="ash">cd $(distdir) &amp;&amp; $(MAKE) DESTDIR=$${PWD}/_inst install</span>&#13;
        <span class="ash">cd $(distdir) &amp;&amp; $(MAKE) DESTDIR=$${PWD}/_inst uninstall</span>&#13;
        <span class="ash">@remaining="`find $${PWD}/$(distdir)/_inst -type f | wc -l`"; \</span>&#13;
        <span class="ash">if test "$${remaining}" -ne 0; then \</span>&#13;
          <span class="ash">echo "*** $${remaining} file(s) remaining in stage directory!"; \</span>&#13;
          <span class="ash">exit 1; \</span>&#13;
        <span class="ash">fi</span>&#13;
        <span class="ash">cd $(distdir) &amp;&amp; $(MAKE) clean</span>&#13;
        <span class="ash">rm -rf $(distdir)</span>&#13;
        <span class="ash">@echo "*** Package $(distdir).tar.gz is ready for distribution."</span>&#13;
<span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">FORCE:</span>&#13;
        <span class="ash">rm -f $(distdir).tar.gz</span>&#13;
        <span class="ash">rm -rf $(distdir)</span>&#13;
&#13;
Makefile: Makefile.in config.status&#13;
        ./config.status $@&#13;
&#13;
config.status: configure&#13;
        ./config.status --recheck&#13;
&#13;
<span class="ash">.PHONY: FORCE all clean check dist distcheck install uninstall</span></pre>&#13;
<p class="caption"><a id="ch04ex06"/><em>Listing 4-6:</em> Makefile.in: <em>Required modifications to Makefile from <a href="ch03.xhtml">Chapter 3</a></em></p>&#13;
<pre># @configure_input@&#13;
&#13;
# Package-specific substitution variables&#13;
package = @PACKAGE_NAME@&#13;
version = @PACKAGE_VERSION@&#13;
tarname = @PACKAGE_TARNAME@&#13;
distdir = $(tarname)-$(version)&#13;
&#13;
# Prefix-specific substitution variables&#13;
prefix = @prefix@&#13;
exec_prefix = @exec_prefix@&#13;
bindir = @bindir@&#13;
&#13;
<span class="ash">CFLAGS = -g -O0</span>&#13;
<span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">clean:</span>&#13;
        <span class="ash">rm -f jupiter</span>&#13;
<span epub:type="pagebreak" id="page_90"/>&#13;
Makefile: Makefile.in ../config.status&#13;
        cd .. &amp;&amp; ./config.status src/$@&#13;
&#13;
../config.status: ../configure&#13;
        cd .. &amp;&amp; ./config.status --recheck&#13;
&#13;
<span class="ash">.PHONY: all clean check install uninstall</span></pre>&#13;
<p class="caption"><a id="ch04ex07"/><em>Listing 4-7:</em> src/Makefile.in: <em>Required modifications to src/Makefile from <a href="ch03.xhtml">Chapter 3</a></em></p>&#13;
<p class="indent">I’ve removed the <code>export</code> statements from the top-level <em>Makefile.in</em> and added a copy of all the <code>make</code> variables (originally only in the top-level <em>Makefile</em>) into <em>src/Makefile.in</em>. Since <code>config.status</code> generates both of these files, I can reap excellent benefits by substituting values for these variables directly into both files. The primary advantage of doing this is that I can now run <code>make</code> in any subdirectory without worrying about uninitialized variables that would originally have been passed down by a higher-level makefile.</p>&#13;
<p class="indent">Since Autoconf generates entire values for these <code>make</code> variables, you may be tempted to clean things up a bit by removing the variables and just substituting <code>@prefix@</code> where we currently use <code>$(prefix)</code> throughout the files. There are a few good reasons for keeping the <code>make</code> variables. First and foremost, we’ll retain the original benefits of the <code>make</code> variables; our end users can continue to substitute their own values on the <code>make</code> command line. (Even though Autoconf places default values in these variables, users may wish to override them.) Second, for variables such as <code>$(distdir)</code>, whose values are composed of multiple variable references, it’s simply cleaner to build the name in one place and use it everywhere else through a single variable.</p>&#13;
<p class="indent">I’ve also changed the commands in the distribution targets a bit. Rather than distribute the makefiles, I now need to distribute the <em>Makefile.in</em> templates, as well as the new <code>configure</code> script and the <em>configure.ac</em> file.<sup><a id="ch04fn_10" href="footnote.xhtml#ch04fn10">10</a></sup></p>&#13;
<p class="indent">Finally, I modified the <code>distcheck</code> target’s commands to run the <code>configure</code> script before running <code>make</code>.</p>&#13;
<h3 class="h3" id="ch04sec9">Generating Files from Templates</h3>&#13;
<p class="noindent">Note that you can use <code>AC_CONFIG_FILES</code> to generate <em>any</em> text file from a file of the same name with a <em>.in</em> extension, found in the same directory. The <em>.in</em> extension is the default template-naming pattern for <code>AC_CONFIG_FILES</code>, but you can override this default behavior. I’ll get into the details shortly.</p>&#13;
<p class="indent">Autoconf generates <code>sed</code> or <code>awk</code> expressions into the resulting <code>configure</code> script, which then copies them into <code>config.status</code>. The <code>config.status</code> script uses these expressions to perform string replacement in the input template files.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_91"/>Both <code>sed</code> and <code>awk</code> are text-processing tools that operate on file streams. The advantage of a stream editor (the name <em>sed</em> is a contraction of the phrase <em>stream editor</em>) is that it replaces text patterns in a byte stream. Thus, both <code>sed</code> and <code>awk</code> can operate on huge files because they don’t need to load the entire input file into memory in order to process it. Autoconf builds the expression list that <code>config.status</code> passes to <code>sed</code> or <code>awk</code> from a list of variables defined by various macros, many of which I’ll cover in greater detail later in this chapter. It’s important to understand that Autoconf substitution variables are the <em>only</em> items replaced in a template file while generating output files.</p>&#13;
<p class="indent">At this point, with very little effort, I’ve created a basic <em>configure.ac</em> file. I can now execute <code>autoreconf</code>, followed by <code>./configure</code> and then <code>make</code>, in order to build the Jupiter project. This simple, three-line <em>configure.ac</em> file generates a <code>configure</code> script that is fully functional, according to the definition of a proper configuration script as specified by the <em>GCS</em>.</p>&#13;
<p class="indent">The resulting configuration script runs various system checks and generates a <code>config.status</code> script that can replace a fair number of substitution variables in a set of specified template files in this build system. That’s a lot of functionality in just three lines of code.</p>&#13;
<h3 class="h3" id="ch04sec10">Adding VPATH Build Functionality</h3>&#13;
<p class="noindent">At the end of <a href="ch03.xhtml">Chapter 3</a>, I mentioned that I hadn’t yet covered an important concept—that of vpath builds. A <em>vpath build</em> is a way of using a <code>make</code> construct (<code>VPATH</code>) to <code>configure</code> and build a project in a directory other than the source directory. This is important if you need to perform any of the following tasks:</p>&#13;
<ul>&#13;
<li class="noindent">Maintain a separate debug configuration</li>&#13;
<li class="noindent">Test different configurations side by side</li>&#13;
<li class="noindent">Keep a clean source directory for patch diffs after local modifications</li>&#13;
<li class="noindent">Build from a read-only source directory</li>&#13;
</ul>&#13;
<p class="indent">The <code>VPATH</code> keyword is short for <em>virtual search path</em>. A <code>VPATH</code> statement contains a colon-separated list of places to look for relative-path dependencies when they can’t be found relative to the current directory. In other words, when <code>make</code> can’t find a prerequisite file relative to the current directory, it searches for that file successively in each of the paths in the <code>VPATH</code> statement.</p>&#13;
<p class="indent">Adding remote build functionality to an existing makefile using <code>VPATH</code> is very simple. <a href="ch04.xhtml#ch04ex08">Listing 4-8</a> shows an example of using a <code>VPATH</code> statement in a makefile.</p>&#13;
<pre>VPATH = some/path:some/other/path:yet/another/path&#13;
&#13;
program : src/main.c&#13;
        $(CC) ...</pre>&#13;
<p class="caption"><a id="ch04ex08"/><em>Listing 4-8: An example of using <code>VPATH</code> in a makefile</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_92"/>In this (contrived) example, if <code>make</code> can’t find <em>src/main.c</em> in the current directory while processing the rule, it will look for <em>some/path/src/main.c</em>, and then for <em>some/other/path/src/main.c</em>, and finally for <em>yet/another/path/src/main.c</em> before giving up with an error message about not knowing how to make <em>src/main.c</em>.</p>&#13;
<p class="indent">With just a few simple modifications, we can completely support remote builds in Jupiter. <a href="ch04.xhtml#ch04ex09">Listings 4-9</a> and <a href="ch04.xhtml#ch04ex10">4-10</a> illustrate the necessary changes to the project’s two makefiles.</p>&#13;
<p class="margin">Git tag 4.3</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash"># Prefix-specific substitution variables</span>&#13;
<span class="ash">prefix = @prefix@</span>&#13;
<span class="ash">exec_prefix = @exec_prefix@</span>&#13;
<span class="ash">bindir = @bindir@</span>&#13;
&#13;
# VPATH-specific substitution variables&#13;
srcdir = @srcdir@&#13;
VPATH = @srcdir@&#13;
<span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">$(distdir): FORCE</span>&#13;
        <span class="ash">mkdir -p $(distdir)/src</span>&#13;
        <span class="ash">cp</span> $(srcdir)/<span class="ash">configure.ac $(distdir)</span>&#13;
        <span class="ash">cp</span> $(srcdir)/<span class="ash">configure $(distdir)</span>&#13;
        <span class="ash">cp</span> $(srcdir)/<span class="ash">Makefile.in $(distdir)</span>&#13;
        <span class="ash">cp</span> $(srcdir)/<span class="ash">src/Makefile.in</span> $(srcdir)/<span class="ash">src/main.c $(distdir)/src</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption"><a id="ch04ex09"/><em>Listing 4-9:</em> Makefile.in: <em>Adding VPATH build capabilities to the top-level makefile</em></p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash"># Prefix-specific substitution variables</span>&#13;
<span class="ash">prefix = @prefix@</span>&#13;
<span class="ash">exec_prefix = @exec_prefix@</span>&#13;
<span class="ash">bindir = @bindir@</span>&#13;
&#13;
# VPATH-specific substitution variables&#13;
srcdir = @srcdir@&#13;
VPATH = @srcdir@&#13;
<span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">jupiter: main.c</span>&#13;
        <span class="ash">$(CC) $(CPPFLAGS) $(CFLAGS) -o $@</span> $(srcdir)/<span class="ash">main.c</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption"><a id="ch04ex10"/><em>Listing 4-10:</em> src/Makefile.in: <em>Adding <code>VPATH</code> build capabilities to the lower-level makefile</em></p>&#13;
<p class="indent">That’s it. Really. When <code>config.status</code> generates a file, it replaces an Autoconf substitution variable called <code>@srcdir@</code> with the relative path to the template’s source directory. The value substituted for <code>@srcdir@</code> in a given <em>Makefile</em> within the build directory structure is the relative path to the directory containing the corresponding <em>Makefile.in</em> template in the <span epub:type="pagebreak" id="page_93"/>source directory structure. The concept here is that for each <em>Makefile</em> in the remote build directory, <code>VPATH</code> provides a relative path to the directory containing the source code for that build directory.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Do not expect <em><code>VPATH</code></em> to work in commands. <em><code>VPATH</code></em> only allows <em><code>make</code></em> to find dependencies; therefore, you can only expect <em><code>VPATH</code></em> to take effect in target and dependency lists within rules. You may use <em><code>$(srcdir)/</code></em> as a prefix for file system objects in commands, as I’ve done in <a href="ch04.xhtml#ch04ex10">Listing 4-10</a> in the command for the <em><code>jupiter</code></em> target rule.</em></p>&#13;
</div>&#13;
<p class="indent">The changes required for supporting remote builds in your build system are summarized as follows:</p>&#13;
<ul>&#13;
<li class="noindent">Set a <code>make</code> variable, <code>srcdir</code>, to the <code>@srcdir@</code> substitution variable.</li>&#13;
<li class="noindent">Set the <code>VPATH</code> variable to <code>@srcdir@</code>.</li>&#13;
<li class="noindent">Prefix all file dependencies used <em>in commands</em> with <code>$(srcdir)/</code>.</li>&#13;
</ul>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Don’t use <em><code>$(srcdir)</code></em> in the <em><code>VPATH</code></em> statement itself, because some older versions of <em><code>make</code></em> won’t substitute variable references within the <em><code>VPATH</code></em> statement.</em></p>&#13;
</div>&#13;
<p class="indent">If the source directory is the same as the build directory, the <code>@srcdir@</code> substitution variable degenerates to a dot (<em>.</em>). That means all of these <code>$(srcdir)</code><em>/</em> prefixes simply degenerate to <em>./</em>, which is harmless.<sup><a id="ch04fn_11" href="footnote.xhtml#ch04fn11">11</a></sup></p>&#13;
<p class="indent">A quick example is the easiest way to show you how this works. Now that Jupiter is fully functional with respect to remote builds, let’s give it a try. Start in the Jupiter project directory, create a subdirectory called <em>build</em>, and then change into that directory. Execute the <code>configure</code> script using a relative path and then list the current directory contents:</p>&#13;
<pre>$ <span class="codestrong1">mkdir build</span>&#13;
$ <span class="codestrong1">cd build</span>&#13;
$ <span class="codestrong1">../configure</span>&#13;
configure: creating ./config.status&#13;
config.status: creating Makefile&#13;
config.status: creating src/Makefile&#13;
$&#13;
$ <span class="codestrong1">ls -1p</span>&#13;
config.log&#13;
config.status&#13;
Makefile&#13;
src/&#13;
$&#13;
$ <span class="codestrong1">ls -1p src</span>&#13;
Makefile&#13;
$</pre>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_94"/>The entire build system has been constructed by <code>configure</code> and <code>config.status</code> within the <em>build</em> subdirectory. Enter <code>make</code> to build the project from within the <em>build</em> directory:</p>&#13;
<pre>$ <span class="codestrong1">make</span>&#13;
cd src &amp;&amp; make all&#13;
make[1]: Entering directory '.../jupiter/build/src'&#13;
cc -g -O0 -o jupiter ../../src/main.c&#13;
make[1]: Leaving directory '.../jupiter/build/src'&#13;
$&#13;
$ <span class="codestrong1">ls -1p src</span>&#13;
jupiter&#13;
Makefile&#13;
$</pre>&#13;
<p class="indent">No matter where you are, if you can access the project directory using either a relative or an absolute path, you can do a remote build from that location. This is just one more thing that Autoconf does for you in Autoconf-generated configuration scripts. Imagine managing proper relative paths to source directories in your own hand-coded configuration scripts!</p>&#13;
<h3 class="h3" id="ch04sec11">Let’s Take a Breather</h3>&#13;
<p class="noindent">So far, I’ve shown you a nearly complete build system that includes almost all of the features outlined in the <em>GCS</em>. The features of Jupiter’s build system are all fairly self-contained and reasonably simple to understand. The most difficult feature to implement by hand is the configuration script. In fact, writing a configuration script by hand is so labor intensive, compared to the simplicity of using Autoconf, that I just skipped the hand-coded version entirely in <a href="ch03.xhtml">Chapter 3</a>.</p>&#13;
<p class="indent">Although using Autoconf as I’ve used it here is quite easy, most people don’t create their build systems in the manner I’ve shown you. Instead, they try to copy the build system of another project and tweak it to make it work in their own project. Later, when they start a new project, they do the same thing again. This can cause trouble because the code they’re copying was never meant to be used the way they’re now trying to use it.</p>&#13;
<p class="indent">I’ve seen projects in which the <em>configure.ac</em> file contained junk that had nothing to do with the project to which it belonged. These leftover bits came from some legacy project, but the maintainer didn’t know enough about Autoconf to properly remove all the extraneous text. With the Autotools, it’s generally better to start small and add what you need than to start with a copy of <em>configure.ac</em> from another full-featured build system and then try to pare it down to size or otherwise modify it to work with a new project.</p>&#13;
<p class="indent">I’m sure you’re feeling like there’s a lot more to learn about Autoconf, and you’re right. We’ll spend the remainder of this chapter examining the most important Autoconf macros and how they’re used in the context of the Jupiter project. But first, let’s go back and see if we might be able to simplify the Autoconf startup process even more by using another utility that comes with the Autoconf package.</p>&#13;
<h3 class="h3" id="ch04sec12"><span epub:type="pagebreak" id="page_95"/>An Even Quicker Start with autoscan</h3>&#13;
<p class="noindent">The easiest way to create a (mostly) complete <em>configure.ac</em> file is to run the <code>autoscan</code> utility, which is part of the Autoconf package. This utility examines the contents of a project directory and generates the basis for a <em>configure.ac</em> file (which <code>autoscan</code> names <em>configure.scan</em>) using existing makefiles and source files.</p>&#13;
<p class="indent">Let’s see how well <code>autoscan</code> does on the Jupiter project. First, I’ll clean up the droppings from my earlier experiments, and then I’ll run <code>autoscan</code> in the <em>jupiter</em> directory.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>If you’re using the git repository that accompanies this book, you can simply run <em><code>git clean -df</code></em> to remove all files and directories not currently under source control by git. Don’t forget to switch back into the parent directory if you’re still sitting in the build directory.</em></p>&#13;
</div>&#13;
<p class="indent">Note that I’m <em>not</em> deleting my original <em>configure.ac</em> file—I’ll just let <code>autoscan</code> tell me how to improve it. In less than a second, I have a few new files in the top-level directory:</p>&#13;
<pre>   $ <span class="codestrong1">cd ..</span>&#13;
   $ <span class="codestrong1">git clean -df</span>&#13;
   $ <span class="codestrong1">autoscan</span>&#13;
<span class="ent">➊</span> configure.ac: warning: missing AC_CHECK_HEADERS([stdlib.h]) wanted by:&#13;
     src/main.c:2&#13;
   configure.ac: warning: missing AC_PREREQ wanted by: autoscan&#13;
   configure.ac: warning: missing AC_PROG_CC wanted by: src/main.c&#13;
   configure.ac: warning: missing AC_PROG_INSTALL wanted by: Makefile.in:18&#13;
   $&#13;
   $ <span class="codestrong1">ls -1p</span>&#13;
   autom4te.cache/&#13;
   autoscan.log&#13;
   configure.ac&#13;
   configure.scan&#13;
   Makefile.in&#13;
   src/&#13;
   $</pre>&#13;
<p class="indent">The <code>autoscan</code> utility examines the project directory hierarchy and creates two files called <em>configure.scan</em> and <em>autoscan.log</em>. The project may or may not already be instrumented for the Autotools—it doesn’t really matter, because <code>autoscan</code> is decidedly nondestructive. It will never alter any existing files in a project.</p>&#13;
<p class="indent">The <code>autoscan</code> utility generates a warning message for each problem it discovers in an existing <em>configure.ac</em> file. In this example, <code>autoscan</code> noticed that <em>configure.ac</em> should be using the Autoconf-provided <code>AC_CHECK_HEADERS</code>, <code>AC_PREREQ</code>, <code>AC_PROG_CC</code>, and <code>AC_PROG_INSTALL</code> macros. It made these assumptions based on information gleaned from the existing <em>Makefile.in</em> templates and <span epub:type="pagebreak" id="page_96"/>from the C-language source files, as you can see by the comments after the warning statements beginning at <span class="ent">➊</span>. You can always see these messages (in even greater detail) by examining the <em>autoscan.log</em> file.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>The notices you receive from <em><code>autoscan</code></em> and the contents of your configure.ac file may differ slightly from mine, depending on the version of Autoconf you have installed. I have version 2.69 of GNU Autoconf installed on my system (the latest, as of this writing). If your version of <em><code>autoscan</code></em> is older (or newer), you may see some minor differences.</em></p>&#13;
</div>&#13;
<p class="indent">Looking at the generated <em>configure.scan</em> file, I note that <code>autoscan</code> has added more text to this file than was in my original <em>configure.ac</em> file. After looking it over to ensure that I understand everything, I see that it’s probably easiest for me to overwrite <em>configure.ac</em> with <em>configure.scan</em> and then change the few bits of information that are specific to Jupiter:</p>&#13;
<pre>$ <span class="codestrong1">mv configure.scan configure.ac</span>&#13;
$ <span class="codestrong1">cat configure.ac</span>&#13;
#                                               -*- Autoconf -*-&#13;
# Process this file with autoconf to produce a configure script.&#13;
&#13;
AC_PREREQ([2.69])&#13;
AC_INIT([FULL-PACKAGE-NAME], [VERSION], [BUG-REPORT-ADDRESS])&#13;
AC_CONFIG_SRCDIR([src/main.c])&#13;
AC_CONFIG_HEADERS([config.h])&#13;
&#13;
# Checks for programs.&#13;
AC_PROG_CC&#13;
AC_PROG_INSTALL&#13;
&#13;
# Checks for libraries.&#13;
&#13;
# Checks for header files.&#13;
AC_CHECK_HEADERS([stdlib.h])&#13;
&#13;
# Checks for typedefs, structures, and compiler characteristics.&#13;
&#13;
# Checks for library functions.&#13;
AC_CONFIG_FILES([Makefile&#13;
                 src/Makefile])&#13;
AC_OUTPUT&#13;
$</pre>&#13;
<p class="indent">My first modification involves changing the <code>AC_INIT</code> macro parameters for Jupiter, as illustrated in <a href="ch04.xhtml#ch04ex11">Listing 4-11</a>.</p>&#13;
<p class="margin">Git tag 4.4</p>&#13;
<pre><span class="ash">#                                               -*- Autoconf -*-</span>&#13;
<span class="ash"># Process this file with autoconf to produce a configure script.</span>&#13;
&#13;
<span class="ash">AC_PREREQ([2.69])</span>&#13;
<span class="ash">AC_INIT([</span>Jupiter<span class="ash">], [</span>1.0<span class="ash">], [</span>jupiter-bugs@example.org<span class="ash">])</span>&#13;
<span epub:type="pagebreak" id="page_97"/><span class="ash">AC_CONFIG_SRCDIR([src/main.c])</span>&#13;
<span class="ash">AC_CONFIG_HEADERS([config.h])</span>&#13;
<span class="codeitalic1a">--snip--</span><span class="ash"/></pre>&#13;
<p class="caption"><a id="ch04ex11"/><em>Listing 4-11:</em> configure.ac: <em>Tweaking the <code>AC_INIT</code> macro generated by <code>autoscan</code></em></p>&#13;
<p class="indent">The <code>autoscan</code> utility does a lot of the work for you. The <em>GNU Autoconf Manual</em><sup><a id="ch04fn_12" href="footnote.xhtml#ch04fn12">12</a></sup> states that you should modify this file to meet the needs of your project before you use it, but there are only a few key issues to worry about (besides those related to <code>AC_INIT</code>). I’ll cover each of these issues in turn, but first, let’s take care of a few administrative details.</p>&#13;
<p class="indent">I’d be remiss if I didn’t mention <code>autoupdate</code> while discussing <code>autoscan</code>. If you’ve already got a working <em>configure.ac</em> file, and you update to a newer version of Autoconf, you can run <code>autoupdate</code> to update your existing <em>configure.ac</em> file with constructs that have changed or been added since the older version of Autoconf.</p>&#13;
<h4 class="h4" id="ch04sec12-1"><em>The Proverbial bootstrap.sh Script</em></h4>&#13;
<p class="noindent">Before <code>autoreconf</code> came along, maintainers passed around a short shell script, often named <code>autogen.sh</code> or <code>bootstrap.sh</code>, which would run all of the Autotools required for their projects in the proper order. The recommended name for this script is <code>bootstrap.sh</code> because Autogen is the name of another GNU project. The <code>bootstrap.sh</code> script can be fairly sophisticated, but to solve the problem of the missing <code>install-sh</code> script (see “Missing Required Files in Autoconf,” next), I’ll just add a simple temporary <code>bootstrap.sh</code> script to the project root directory, as shown in <a href="ch04.xhtml#ch04ex12">Listing 4-12</a>.</p>&#13;
<p class="margin">Git tag 4.5</p>&#13;
<pre>   #!/bin/sh&#13;
   autoreconf --install&#13;
<span class="ent">➊</span> automake --add-missing --copy &gt;/dev/null 2&gt;&amp;1</pre>&#13;
<p class="caption"><a id="ch04ex12"/><em>Listing 4-12:</em> bootstrap.sh: <em>A temporary bootstrap script that executes the required Autotools</em></p>&#13;
<p class="indent">The Automake <code>--add-missing</code> option copies the required missing utility scripts into the project, and the <code>--copy</code> option indicates that true copies should be made (otherwise, symbolic links are created that refer to the files where they’re installed with the Automake package).<sup><a id="ch04fn_13" href="footnote.xhtml#ch04fn13">13</a></sup></p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em><span epub:type="pagebreak" id="page_98"/>We don’t need to see the warnings from executing <em><code>automake</code></em>, so I’ve redirected the <em><code>stderr</code></em> and <em><code>stdout</code></em> streams to /dev/null on the <em><code>automake</code></em> command line at <span class="ent">➊</span> in this script. In <a href="ch06.xhtml">Chapter 6</a>, we’ll remove <em><code>bootstrap.sh</code></em> and simply run <em><code>autoreconf --install</code></em>, but for now, this solves our missing file problems.</em></p>&#13;
</div>&#13;
<div class="box5">&#13;
<p class="sidebart">MISSING REQUIRED FILES IN AUTOCONF</p>&#13;
<p class="noindent">When I first tried to execute <code>autoreconf</code> on the <em>configure.ac</em> file in <a href="ch04.xhtml#ch04ex11">Listing 4-11</a>, I discovered a minor problem related to using Autoconf <em>without</em> Automake. When I ran the <code>configure</code> script, it failed with an error: <code>configure: error: cannot find install-sh, install.sh, or shtool in "." "./.." "./../.."</code>.</p>&#13;
<p class="indent">Autoconf is all about portability and, unfortunately, the Unix <code>install</code> utility is not as portable as it could be. From one platform to another, critical bits of installation functionality are just different enough to cause problems, so the Autotools provide a shell script called <code>install-sh</code> (deprecated name: <code>install.sh</code>). This script acts as a wrapper around the system’s own <code>install</code> utility, masking important differences between various versions of <code>install</code>.</p>&#13;
<p class="indent"><code>autoscan</code> noticed that I’d used the <code>install</code> program in my <em>src/Makefile.in</em> template, so it generated an expansion of the <code>AC_PROG_INSTALL</code> macro. The problem is that <code>configure</code> couldn’t find the <code>install-sh</code> wrapper script anywhere in my project.</p>&#13;
<p class="indent">I reasoned that the missing file was part of the Autoconf package and it just needed to be installed. I also knew that <code>autoreconf</code> accepts a command line option to install such missing files into a project directory. The <code>--install</code> (<code>-i</code>) option supported by <code>autoreconf</code> is designed to pass tool-specific options down to each of the tools that it calls in order to install missing files. However, when I tried that, I found that the file was still missing, because <code>autoconf</code> doesn’t support an option to install missing files.</p>&#13;
<p class="indent">I could have manually copied <code>install-sh</code> from the Automake installation directory (usually <em>/usr/(local/)share/automake-*</em>), but looking for a more automated solution, I tried manually executing <code>automake --add-missing --copy</code>. This command generated a slew of warnings indicating that the project was not configured for Automake. However, I could now see that <code>install-sh</code> had been copied into my project root directory, and that’s all I was after. Executing <code>autoreconf --install</code> didn’t run <code>automake</code> because <em>configure.ac</em> was not set up for Automake.</p>&#13;
<p class="indent">Autoconf should ship with <code>install-sh</code>, since it provides a macro that requires it, but then <code>autoconf</code> would have to provide an <code>--add-missing</code> command line option. Nevertheless, there is actually a quite obvious solution to this problem. The <code>install-sh</code> script is not really required by any code Autoconf generates. How could it be? Autoconf doesn’t generate any makefile constructs—it only substitutes variables into your <em>Makefile.in</em> templates. Thus, there’s really no reason for Autoconf to complain about a missing <code>install-sh</code> script.</p>&#13;
</div>&#13;
<h4 class="h4" id="ch04sec12-2"><em><span epub:type="pagebreak" id="page_99"/>Updating Makefile.in</em></h4>&#13;
<p class="noindent">Let’s make <code>bootstrap.sh</code> executable and then execute it and see what we end up with:</p>&#13;
<pre>   $ <span class="codestrong1">chmod +x bootstrap.sh</span>&#13;
   $ <span class="codestrong1">./bootstrap.sh</span>&#13;
   $ <span class="codestrong1">ls -1p</span>&#13;
   autom4te.cache/&#13;
   bootstrap.sh&#13;
<span class="ent">➊</span> config.h.in&#13;
   configure&#13;
   configure.ac&#13;
<span class="ent">➋</span> install-sh&#13;
   Makefile.in&#13;
   src/&#13;
   $</pre>&#13;
<p class="indent">We know from the file list at <span class="ent">➊</span> that <em>config.h.in</em> has been created, so we know that <code>autoreconf</code> has executed <code>autoheader</code>. We also see the new <code>install-sh</code> script at <span class="ent">➋</span> that was created when we executed <code>automake</code> in <code>bootstrap.sh</code>. Anything provided or generated by the Autotools should be copied into the archive directory so that it can be shipped with release tarballs. Therefore, we’ll add <code>cp</code> commands for these two files to the <code>$(distdir)</code> target in the top-level <em>Makefile.in</em> template. Note that we don’t need to copy the <code>bootstrap.sh</code> script because it’s purely a maintainer tool—users should never need to execute it from a tarball distribution.</p>&#13;
<p class="indent"><a href="ch04.xhtml#ch04ex13">Listing 4-13</a> illustrates the required changes to the <code>$(distdir)</code> target in the top-level <em>Makefile.in</em> template.</p>&#13;
<p class="margin">Git tag 4.6</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">$(distdir): FORCE</span>&#13;
        <span class="ash">mkdir -p $(distdir)/src</span>&#13;
        <span class="ash">cp $(srcdir)/configure.ac $(distdir)</span>&#13;
        <span class="ash">cp $(srcdir)/configure $(distdir)</span>&#13;
        cp $(srcdir)/config.h.in $(distdir)&#13;
        cp $(srcdir)/install-sh $(distdir)&#13;
        <span class="ash">cp $(srcdir)/Makefile.in $(distdir)</span>&#13;
        <span class="ash">cp $(srcdir)/src/Makefile.in $(distdir)/src</span>&#13;
        <span class="ash">cp $(srcdir)/src/main.c $(distdir)/src</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption"><a id="ch04ex13"/><em>Listing 4-13:</em> Makefile.in: <em>Additional files needed in the distribution archive image directory</em></p>&#13;
<p class="indent">If you’re beginning to think that this could become a maintenance problem, then you’re right. I mentioned earlier that the <code>$(distdir)</code> target was painful to maintain. Luckily, the <code>distcheck</code> target still exists and still works as designed. It would have caught this problem, because attempts to build from the tarball will fail without these additional files—and the <code>distcheck</code> target certainly won’t succeed if the build fails. When we discuss Automake in <a href="ch06.xhtml">Chapter 6</a>, we will clear up much of this maintenance mess.</p>&#13;
<h3 class="h3" id="ch04sec13"><span epub:type="pagebreak" id="page_100"/>Initialization and Package Information</h3>&#13;
<p class="noindent">Now let’s turn our attention back to the contents of the <em>configure.ac</em> file in <a href="ch04.xhtml#ch04ex11">Listing 4-11</a> (and the console example immediately preceding that listing). The first section contains Autoconf initialization macros. These are required for all projects. Let’s consider each of these macros individually, because they’re all important.</p>&#13;
<h4 class="h4" id="ch04sec13-1"><em>AC_PREREQ</em></h4>&#13;
<p class="noindent">The <code>AC_PREREQ</code> macro simply defines the earliest version of Autoconf that may be used to successfully process this <em>configure.ac</em> file:</p>&#13;
<pre>AC_PREREQ(<span class="codeitalic1">version</span>)</pre>&#13;
<p class="indent">The <em>GNU Autoconf Manual</em> indicates that <code>AC_PREREQ</code> is the only macro that may be used before <code>AC_INIT</code>. This is because it’s good to ensure you’re using a new enough version of Autoconf before you begin processing any other macros, which may be version dependent.</p>&#13;
<h4 class="h4" id="ch04sec13-2"><em>AC_INIT</em></h4>&#13;
<p class="noindent">The <code>AC_INIT</code> macro, as its name implies, initializes the Autoconf system. Here’s its prototype, as defined in the <em>GNU Autoconf Manual</em>:<sup><a id="ch04fn_14" href="footnote.xhtml#ch04fn14">14</a></sup></p>&#13;
<pre>AC_INIT(<span class="codeitalic1">package</span>, <span class="codeitalic1">version</span>, [<span class="codeitalic1">bug-report</span>], [<span class="codeitalic1">tarname</span>], [<span class="codeitalic1">url</span>])</pre>&#13;
<p class="indent">It accepts up to five arguments (<code>autoscan</code> only generates an invocation with the first three): <em><code>package</code></em>, <em><code>version</code></em>, and, optionally, <em><code>bug-report</code></em>, <em><code>tarname</code></em>, and <em><code>url</code></em>. The <em><code>package</code></em> argument is intended to be the name of the package. It will end up (in a canonical form) as the first part of the name of an Automake-generated release distribution tarball when you execute <code>make dist</code>.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Autoconf uses a normalized form of the package name in the tarball name, so you can use uppercase letters in the package name, if you wish. Automake-generated tarballs are named <em><code>tarname</code></em>-<em><code>version</code></em>.tar.gz by default, but <em><code>tarname</code></em> is set to a normalized form of the <em><code>package</code></em> name (lowercase, with all punctuation converted to underscores). Bear this in mind when you choose your package name and version string.</em></p>&#13;
</div>&#13;
<p class="indent">The optional <em><code>bug-report</code></em> argument is usually set to an email address, but any text string is valid—the URL of a web page that accepts bug reports for the project is a common alternative. An Autoconf substitution variable called <code>@PACKAGE_BUGREPORT@</code> is created for it, and that variable is also added to the <em>config.h.in</em> template as a C-preprocessor definition. The intent here is that you use the variable in your code to present an email address or URL for bug reports at appropriate places—possibly when the user requests help or version information from your application.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_101"/>While the <em><code>version</code></em> argument can be anything you like, there are a few commonly used OSS conventions that will make things a little easier for you. The most widely used convention is to pass in <em>major.minor</em> (for example, 1.2). However, there’s nothing that says you can’t use <em>major.minor.revision</em>, and there’s nothing wrong with this approach. None of the resulting <code>VERSION</code> variables (Autoconf, shell, or <code>make</code>) are parsed or analyzed anywhere—they’re only used as placeholders for substituted text in various locations.<sup><a id="ch04fn_15" href="footnote.xhtml#ch04fn15">15</a></sup> So if you wish, you may even add nonnumerical text into this macro, such as <em>0.15.alpha1</em>, which is occasionally useful.<sup><a id="ch04fn_16" href="footnote.xhtml#ch04fn16">16</a></sup></p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>The RPM package manager, on the other hand, does care what you put in the version string. For the sake of RPM, you may wish to limit the version string text to only alphanumeric characters and periods—no dashes or underscores.</em></p>&#13;
</div>&#13;
<p class="indent">The optional <em><code>url</code></em> argument should be the URL for your project website. It’s shown in the help text displayed by <code>configure --help</code>.</p>&#13;
<p class="indent">Autoconf generates the substitution variables <code>@PACKAGE_NAME@</code>, <code>@PACKAGE_VERSION@</code>, <code>@PACKAGE_TARNAME@</code>, <code>@PACKAGE_STRING@</code> (a stylized concatenation of the package name and version information), <code>@PACKAGE_BUGREPORT@</code>, and <code>@PACKAGE_URL@</code> from the arguments to <code>AC_INIT</code>. You can use any or all of these in your <em>Makefile.in</em> template files.</p>&#13;
<h4 class="h4" id="ch04sec13-3"><em>AC_CONFIG_SRCDIR</em></h4>&#13;
<p class="noindent">The <code>AC_CONFIG_SRCDIR</code> macro is a sanity check. Its purpose is to ensure that the generated <code>configure</code> script knows that the directory on which it is being executed is actually the project directory.</p>&#13;
<p class="indent">More specifically, <code>configure</code> needs to be able to locate itself, because it generates code that executes itself, possibly from a remote directory. There are myriad ways to inadvertently fool <code>configure</code> into finding some other <code>configure</code> script. For example, the user could accidentally provide an incorrect <code>--srcdir</code> argument to <code>configure</code>. The <code>$0</code> shell script parameter is unreliable, at best—it may contain the name of the shell, rather than that of the script, or it may be that <code>configure</code> was found in the system search path, so no path information was specified on the command line.</p>&#13;
<p class="indent">The <code>configure</code> script could try looking in the current or parent directories, but it still needs a way to verify that the <code>configure</code> script it locates is actually itself. Thus, <code>AC_CONFIG_SRCDIR</code> gives <code>configure</code> a significant hint that it’s looking in the right place. Here’s the prototype for <code>AC_CONFIG_SRCDIR</code>:</p>&#13;
<pre>AC_CONFIG_SRCDIR(<span class="codeitalic1">unique-file-in-source-dir</span>)</pre>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_102"/>The argument can be a path (relative to the project’s <code>configure</code> script) to any source file you like. You should choose one that is unique to your project so as to minimize the possibility that <code>configure</code> is fooled into thinking some other project’s configuration file is itself. I normally try to choose a file that sort of represents the project, such as a source file named for a feature that defines the project. That way, in case I ever decide to reorganize the source code, I’m not likely to lose it in a file rename. In this case, however, we have only one source file, <em>main.c</em>, making it a little difficult to follow this convention. Regardless, both <code>autoconf</code> and <code>configure</code> will tell you and your users if it can’t find the file.</p>&#13;
<h3 class="h3" id="ch04sec14">The Instantiating Macros</h3>&#13;
<p class="noindent">Before we dive into the details of <code>AC_CONFIG_HEADERS</code>, I’d like to spend a little time on the file generation framework Autoconf provides. From a high-level perspective, there are four major things happening in <em>configure.ac</em>:</p>&#13;
<ul>&#13;
<li class="noindent">Initialization</li>&#13;
<li class="noindent">Check request processing</li>&#13;
<li class="noindent">File instantiation request processing</li>&#13;
<li class="noindent">Generation of the <code>configure</code> script</li>&#13;
</ul>&#13;
<p class="indent">We’ve covered initialization—there’s not much to it, although there are a few more macros you should be aware of. Check out the <em>GNU Autoconf Manual</em> for more information—look up <code>AC_COPYRIGHT</code>, for an example. Now let’s move on to file instantiation.</p>&#13;
<p class="indent">There are actually four so-called <em>instantiating macros</em>: <code>AC_CONFIG_FILES</code>, <code>AC_CONFIG_HEADERS</code>, <code>AC_CONFIG_COMMANDS</code>, and <code>AC_CONFIG_LINKS</code>. An instantiating macro accepts a list of tags or files; <code>configure</code> will generate these files from templates containing Autoconf substitution variables.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>You might need to change the name of <em><code>AC_CONFIG_HEADER</code></em> (singular) to <em><code>AC_CONFIG_HEADERS</code></em> (plural) in your version of</em> configure.scan. <em>The singular version is the older name for this macro, and the older macro is less functional than the newer one.<sup><a id="ch04fn_17" href="footnote.xhtml#ch04fn17">17</a></sup></em></p>&#13;
</div>&#13;
<p class="indent">The four instantiating macros have an interesting common signature. The following prototype can be used to represent each of them, with appropriate text replacing the <em><code>XXX</code></em> portion of the macro name:</p>&#13;
<pre>AC_CONFIG_<span class="codeitalic1">XXX</span>S(<span class="codeitalic1">tag...</span>, [<span class="codeitalic1">commands</span>], [<span class="codeitalic1">init-cmds</span>])</pre>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_103"/>For each of these four macros, the tag argument has the form <em><code>OUT</code></em><code>[:</code><em><code>INLIST</code></em><code>]</code>, where <em><code>INLIST</code></em> has the form <em><code>IN0</code></em><code>[:</code><em><code>IN1</code></em><code>:...:</code><em><code>INn</code></em><code>]</code>. Often, you’ll see a call to one of these macros with only a single argument, as in the three examples that follow (note that these examples represent macro <em>invocations</em>, not <em>prototypes</em>, so the square brackets are actually Autoconf quotes, not indications of optional parameters):</p>&#13;
<pre>AC_CONFIG_HEADERS([config.h])</pre>&#13;
<p class="indent">In this example, <em>config.h</em> is the <em><code>OUT</code></em> portion of the preceding specification. The default value for <em><code>INLIST</code></em> is the <em><code>OUT</code></em> portion with <em>.in</em> appended to it. So, in other words, the preceding call is exactly equivalent to the following:</p>&#13;
<pre>AC_CONFIG_HEADERS([config.h:config.h.in])</pre>&#13;
<p class="indent">What this means is that <code>config.status</code> contains shell code that will generate <em>config.h</em> from <em>config.h.in</em>, substituting all Autoconf variables in the process. You may also provide a list of input files in the <em><code>INLIST</code></em> portion. In this case, the files in <em><code>INLIST</code></em> will be concatenated to form the resulting <em><code>OUT</code></em> file:</p>&#13;
<pre>AC_CONFIG_HEADERS([config.h:cfg0:cfg1:cfg2])</pre>&#13;
<p class="indent">Here, <code>config.status</code> will generate <em>config.h</em> by concatenating <em>cfg0</em>, <em>cfg1</em>, and <em>cfg2</em> (in that order), after substituting all Autoconf variables. The <em>GNU Autoconf Manual</em> refers to this entire <em><code>OUT</code></em><code>[:</code><em><code>INLIST</code></em><code>]</code> construct as a <em>tag</em>.</p>&#13;
<p class="indent">Why not just call it a <em>file</em>? Well, this parameter’s primary purpose is to provide a sort of command line target name—much like makefile targets. It can also be used as a filesystem name if the associated macro generates files, as is the case with <code>AC_CONFIG_HEADERS</code>, <code>AC_CONFIG_FILES</code>, and <code>AC_CONFIG_LINKS</code>.</p>&#13;
<p class="indent">But <code>AC_CONFIG_COMMANDS</code> is unique in that it doesn’t generate any files. Instead, it runs arbitrary shell code, as specified by the user in the macro’s arguments. Thus, rather than name this first parameter after a secondary function (the generation of files), the <em>GNU Autoconf Manual</em> refers to it more generally, according to its primary purpose—as a command line <em>tag</em> that may be specified on the <code>./config.status</code> command line, in this manner:</p>&#13;
<pre>$ <span class="codestrong1">./config.status config.h</span></pre>&#13;
<p class="indent">This command will regenerate the <em>config.h</em> file based on the macro call to <code>AC_CONFIG_HEADERS</code> in <em>configure.ac</em>. It will <em>only</em> regenerate <em>config.h</em>.</p>&#13;
<p class="indent">Enter <code>./config.status --help</code> to see the other command line options you can use when executing <code>./config.status</code>:</p>&#13;
<pre>   $ <span class="codestrong1">./config.status --help</span>&#13;
   `config.status' instantiates files and other configuration actions&#13;
   from templates according to the current configuration.    Unless the files&#13;
   and actions are specified as TAGs, all are instantiated by default.&#13;
<span epub:type="pagebreak" id="page_104"/><span class="ent">➊</span> Usage: ./config.status [OPTION]... [TAG]...&#13;
&#13;
    -h, --help       print this help, then exit&#13;
    -V, --version    print version number and configuration settings, then exit&#13;
     <span class="ent">➋</span> --config      print configuration, then exit&#13;
    -q, --quiet, --silent&#13;
                     do not print progress messages&#13;
    -d, --debug      don't remove temporary files&#13;
        --recheck    update config.status by reconfiguring in the same conditions&#13;
     <span class="ent">➌</span> --file=FILE[:TEMPLATE]&#13;
                     instantiate the configuration file FILE&#13;
        --header=FILE[:TEMPLATE]&#13;
                       instantiate the configuration header FILE&#13;
&#13;
<span class="ent">➍</span> Configuration files:&#13;
   Makefile src/Makefile&#13;
&#13;
<span class="ent">➎</span> Configuration headers:&#13;
   config.h&#13;
&#13;
   Report bugs to &lt;jupiter-bugs@example.org&gt;.&#13;
   $</pre>&#13;
<p class="indent">Notice that <code>config.status</code> provides custom help about a project’s <code>config .status</code> file. It lists configuration files <span class="ent">➍</span> and configuration headers <span class="ent">➎</span> that we can use as tags on the command line where the usage specifies <code>[TAG]...</code> at <span class="ent">➊</span>. In this case, <code>config.status</code> will only instantiate the specified objects. In the case of commands, it will execute the command set specified by the tag passed in the associated expansion of the <code>AC_CONFIG_COMMANDS</code> macro.</p>&#13;
<p class="indent">Each of these macros may be used multiple times in a <em>configure.ac</em> file. The results are cumulative, and we can use <code>AC_CONFIG_FILES</code> as many times as we need to in <em>configure.ac</em>. It is also important to note that <code>config.status</code> supports the <code>--file=</code> option (at <span class="ent">➌</span>). When you call <code>config.status</code> with tags on the command line, the only tags you can use are those the help text lists as available configuration files, headers, links, and commands. When you execute <code>config.status</code> with the <code>--file=</code> option, you’re telling <code>config.status</code> to generate a new file that’s not already associated with any of the calls to the instantiating macros found in <em>configure.ac</em>. This new file is generated from an associated template using configuration options and check results determined by the last execution of <code>configure</code>. For example, I could execute <code>config.status</code> in this manner (using a fictional template called <em>extra.in</em>):</p>&#13;
<pre>$ <span class="codestrong1">./config.status --file=extra:extra.in</span></pre>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>The default template name is the filename with a .in suffix, so this call could have been made without using the <em><code>:extra.in</code></em> portion of the option. I added it here for clarity.</em></p>&#13;
</div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_105"/>Finally, I’d like to point out a newer feature of <code>config.status</code>—the <code>--config</code> option at <span class="ent">➋</span>, added with version 2.65 of Autoconf. Using this option displays the explicit configuration options passed to <code>configure</code> on the command line. For instance, assume that we had invoked <code>./configure</code> in this manner:</p>&#13;
<pre>$ ./configure --prefix=$HOME</pre>&#13;
<p class="indent">When you use the new <code>--config</code> option, <code>./config.status</code> displays the following:</p>&#13;
<pre>$ ./config.status --config&#13;
'--prefix=/home/jcalcote'</pre>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Older versions of Autoconf generated a <em><code>config.status</code></em> script that displayed this information when using the <em><code>--version</code></em> option, but it was part of a larger wall of text. The newer <em><code>--config</code></em> option makes it easier to find and reuse configuration options originally passed to the <em><code>configure</code></em> script.</em></p>&#13;
</div>&#13;
<p class="indent">Let’s return now to the instantiating macro signature at the bottom of <a href="ch04.xhtml#page_102">page 102</a>. I’ve shown you that the <em><code>tag...</code></em> argument has a complex format, but the ellipsis indicates that it also represents multiple tags, separated by whitespace. The format you’ll see in nearly all <em>configure.ac</em> files is shown in <a href="ch04.xhtml#ch04ex14">Listing 4-14</a>.</p>&#13;
<pre>AC_CONFIG_FILES([Makefile&#13;
                 src/Makefile&#13;
                 lib/Makefile&#13;
                 etc/proj.cfg])</pre>&#13;
<p class="caption"><a id="ch04ex14"/><em>Listing 4-14: Specifying multiple tags (files) in <code>AC_CONFIG_FILES</code></em></p>&#13;
<p class="indent">Each entry here is one tag specification, which, if fully specified, would look like the call in <a href="ch04.xhtml#ch04ex15">Listing 4-15</a>.</p>&#13;
<pre>AC_CONFIG_FILES([Makefile:Makefile.in&#13;
                 src/Makefile:src/Makefile.in&#13;
                 lib/Makefile:lib/Makefile.in&#13;
                 etc/proj.cfg:etc/proj.cfg.in])</pre>&#13;
<p class="caption"><a id="ch04ex15"/><em>Listing 4-15: Fully specifying multiple tags in <code>AC_CONFIG_FILES</code></em></p>&#13;
<p class="indent">Returning to the instantiating macro prototype, there are two optional arguments that you’ll rarely see used in these macros: <em><code>commands</code></em> and <em><code>init-cmds</code></em>. The <em><code>commands</code></em> argument may be used to specify some arbitrary shell code that should be executed by <code>config.status</code> just before the files associated with the tags are generated. It is unusual for this feature to be used within the file-generating instantiating macros. You will almost always see the <em><code>commands</code></em> argument used with <code>AC_CONFIG_COMMANDS</code>, which generates no files by <span epub:type="pagebreak" id="page_106"/>default, because a call to this macro is basically useless without commands to execute!<sup><a id="ch04fn_18" href="footnote.xhtml#ch04fn18">18</a></sup> In this case, the <em><code>tag</code></em> argument becomes a way of telling <code>config .status</code> to execute a specific set of shell commands.</p>&#13;
<p class="indent">The <em><code>init-cmds</code></em> argument initializes shell variables at the top of <code>config .status</code> with values available in <em>configure.ac</em> and <code>configure</code>. It’s important to remember that all calls to instantiating macros share a common namespace along with <code>config.status</code>. Therefore, you should try to choose your shell variable names carefully so they are less likely to conflict with each other and with Autoconf-generated variables.</p>&#13;
<p class="indent">The old adage about the value of a picture versus an explanation holds true here, so let’s try a little experiment. Create a test version of your <em>configure.ac</em> file that contains only the contents of <a href="ch04.xhtml#ch04ex16">Listing 4-16</a>. You should do this in a separate directory, as we’re not relying on any of the other files in the Jupiter project directory structure with this experiment.</p>&#13;
<pre>AC_INIT([test], [1.0])&#13;
AC_CONFIG_COMMANDS([abc],&#13;
                   [echo "Testing $mypkgname"],&#13;
                   [mypkgname=$PACKAGE_NAME])&#13;
AC_OUTPUT</pre>&#13;
<p class="caption"><a id="ch04ex16"/><em>Listing 4-16: Experiment #1—a simple</em> configure.ac <em>file using <code>AC_CONFIG_COMMANDS</code></em></p>&#13;
<p class="indent">Now execute <code>autoreconf</code>, <code>./configure</code>, and <code>./config.status</code> in various ways to see what happens:</p>&#13;
<pre>   $ <span class="codestrong1">autoreconf</span>&#13;
<span class="ent">➊</span> $ <span class="codestrong1">./configure</span>&#13;
   configure: creating ./config.status&#13;
   config.status: executing abc commands&#13;
   Testing test&#13;
   $&#13;
<span class="ent">➋</span> $ <span class="codestrong1">./config.status</span>&#13;
   config.status: executing abc commands&#13;
   Testing test&#13;
   $&#13;
<span class="ent">➌</span> $ <span class="codestrong1">./config.status --help</span>&#13;
   'config.status' instantiates files from templates according to the current configuration.&#13;
   Usage: ./config.status [OPTIONS]... [FILE]...&#13;
   <span class="codeitalic1">--snip--</span>&#13;
   Configuration commands:&#13;
    abc&#13;
&#13;
   Report bugs to &lt;bug-autoconf@gnu.org&gt;.&#13;
   $&#13;
<span class="ent">➍</span> $ <span class="codestrong1">./config.status abc</span>&#13;
   config.status: executing abc commands&#13;
   Testing test&#13;
   $</pre>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_107"/>As you can see at <span class="ent">➊</span>, executing <code>./configure</code> caused <code>config.status</code> to be executed with no command line options. There are no checks specified in <em>configure.ac</em>, so manually executing <code>./config.status</code>, as we did at <span class="ent">➋</span>, has nearly the same effect. Querying <code>config.status</code> for help (as we did at <span class="ent">➌</span>) indicates that <code>abc</code> is a valid tag; executing <code>./config.status</code> with that tag (as we did at <span class="ent">➍</span>) on the command line simply runs the associated commands.</p>&#13;
<p class="indent">In summary, the important points regarding the instantiating macros are as follows:</p>&#13;
<ul>&#13;
<li class="noindent">The <code>config.status</code> script generates all files from templates.</li>&#13;
<li class="noindent">The <code>configure</code> script performs all checks and then executes <code>./config.status</code>.</li>&#13;
<li class="noindent">When you execute <code>./config.status</code> with no command line options, it generates files based on the last set of check results.</li>&#13;
<li class="noindent">You can call <code>./config.status</code> to execute file generation or command sets specified by any of the tags given in any of the instantiating macro calls.</li>&#13;
<li class="noindent">The <code>config.status</code> script may generate files not associated with any tags specified in <em>configure.ac</em>, in which case it will substitute variables based on the last set of checks performed.</li>&#13;
</ul>&#13;
<h4 class="h4" id="ch04sec14-1"><em>Generating Header Files from Templates</em></h4>&#13;
<p class="noindent">As you’ve no doubt concluded by now, the <code>AC_CONFIG_HEADERS</code> macro allows you to specify one or more header files that <code>config.status</code> should generate from template files. The format of a configuration header template is very specific. A short example is given in <a href="ch04.xhtml#ch04ex17">Listing 4-17</a>.</p>&#13;
<pre>/* Define as 1 if you have unistd.h. */&#13;
#undef HAVE_UNISTD_H</pre>&#13;
<p class="caption"><a id="ch04ex17"/><em>Listing 4-17: A short example of a header file template</em></p>&#13;
<p class="indent">You can place multiple statements like this in your header template, one per line. The comments are optional, of course. Let’s try another experiment. Create a new <em>configure.ac</em> file like that shown in <a href="ch04.xhtml#ch04ex18">Listing 4-18</a>. Again, you should do this in an isolated directory.</p>&#13;
<pre>AC_INIT([test], [1.0])&#13;
AC_CONFIG_HEADERS([config.h])&#13;
AC_CHECK_HEADERS([unistd.h foobar.h])&#13;
AC_OUTPUT</pre>&#13;
<p class="caption"><a id="ch04ex18"/><em>Listing 4-18: Experiment #2—a simple</em> configure.ac <em>file</em></p>&#13;
<p class="indent">Create a template header file called <em>config.h.in</em> that contains the two lines in <a href="ch04.xhtml#ch04ex19">Listing 4-19</a>.</p>&#13;
<pre>#undef HAVE_UNISTD_H&#13;
#undef HAVE_FOOBAR_H</pre>&#13;
<p class="caption"><a id="ch04ex19"/><em>Listing 4-19: Experiment #2 continued—a simple</em> config.h.in <em>file</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_108"/>Now execute the following commands:</p>&#13;
<pre>   $ <span class="codestrong1">autoconf</span>&#13;
   $ <span class="codestrong1">./configure</span>&#13;
   checking for gcc... gcc&#13;
   <span class="codeitalic1">--snip--</span>&#13;
<span class="ent">➊</span> checking for unistd.h... yes&#13;
   checking for unistd.h... (cached) yes&#13;
   checking foobar.h usability... no&#13;
   checking foobar.h presence... no&#13;
<span class="ent">➋</span> checking for foobar.h... no&#13;
   configure: creating ./config.status&#13;
<span class="ent">➌</span> config.status: creating config.h&#13;
   $&#13;
   $ <span class="codestrong1">cat config.h</span>&#13;
   /* config.h.    Generated from config.h.in by configure.    */&#13;
   #define HAVE_UNISTD_H 1&#13;
<span class="ent">➍</span> /* #undef HAVE_FOOBAR_H */&#13;
   $</pre>&#13;
<p class="indent">You can see at <span class="ent">➌</span> that <code>config.status</code> generated a <em>config.h</em> file from the simple <em>config.h.in</em> template we wrote. The contents of this header file are based on the checks executed by <code>configure</code>. Since the shell code generated by <code>AC_CHECK_HEADERS([unistd.h foobar.h])</code> was able to locate a <em>unistd.h</em> header file (<span class="ent">➊</span>) in the system include directory, the corresponding <code>#undef</code> statement was converted into a <code>#define</code> statement. Of course, no <em>foobar.h</em> header was found in the system include directory, as you can also see by the output of <code>./configure</code> at <span class="ent">➋</span>; therefore, its definition was left commented out in the template, as shown at <span class="ent">➍</span>.</p>&#13;
<p class="indent">Hence, you may add the sort of code shown in <a href="ch04.xhtml#ch04ex20">Listing 4-20</a> to appropriate C-language source files in your project.</p>&#13;
<pre>#include "config.h"&#13;
#if HAVE_UNISTD_H&#13;
# include &lt;unistd.h&gt;&#13;
#endif&#13;
#if HAVE_FOOBAR_H&#13;
# include &lt;foobar.h&gt;&#13;
#endif</pre>&#13;
<p class="caption"><a id="ch04ex20"/><em>Listing 4-20: Using generated CPP definitions in a C-language source file</em></p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>The unistd.h header file is so standard these days that it’s not really necessary to check for it in <em><code>AC_CONFIG_HEADERS</code></em>, but it served here as a file that I was sure existed on my system for this example.</em></p>&#13;
</div>&#13;
<h4 class="h4" id="ch04sec14-2"><em>Using autoheader to Generate an Include File Template</em></h4>&#13;
<p class="noindent">Manually maintaining a <em>config.h.in</em> template is more trouble than necessary. The format of <em>config.h.in</em> is very strict—for example, you can’t have any leading or trailing whitespace on the <code>#undef</code> lines, and the <code>#undef</code> lines you <span epub:type="pagebreak" id="page_109"/>add must use <code>#undef</code> rather than <code>#define</code>, mainly because <code>config.status</code> only knows how to either replace <code>#undef</code> with <code>#define</code> or comment out lines containing <code>#undef</code>.<sup><a id="ch04fn_19" href="footnote.xhtml#ch04fn19">19</a></sup></p>&#13;
<p class="indent">Most of the information you need from <em>config.h.in</em> is available in <em>configure.ac</em>. Fortunately, <code>autoheader</code> will generate a properly formatted header file template for you based on the contents of <em>configure.ac</em>, so you don’t often need to write <em>config.h.in</em> templates. Let’s return to the command prompt for a final experiment. This one is easy—just delete your <em>config.h.in</em> template from experiment #2 and then run <code>autoheader</code> followed by <code>autoconf</code>:</p>&#13;
<pre>   $ <span class="codestrong1">rm config.h.in</span>&#13;
   $ <span class="codestrong1">autoheader</span>&#13;
   $ <span class="codestrong1">autoconf</span>&#13;
   $ <span class="codestrong1">./configure</span>&#13;
   checking for gcc... gcc&#13;
   <span class="codeitalic1">--snip--</span>&#13;
   checking for unistd.h... yes&#13;
   checking for unistd.h... (cached) yes&#13;
   checking foobar.h usability... no&#13;
   checking foobar.h presence... no&#13;
   checking for foobar.h... no&#13;
   configure: creating ./config.status&#13;
   config.status: creating config.h&#13;
   $&#13;
<span class="ent">➊</span> $ <span class="codestrong1">cat config.h</span>&#13;
   /* config.h. Generated from config.h.in by configure.    */&#13;
   /* config.h.in. Generated from configure.ac by autoheader.    */&#13;
   /* Define to 1 if you have the &lt;foobar.h&gt; header file. */&#13;
   /* #undef HAVE_FOOBAR_H */&#13;
   <span class="codeitalic1">--snip--</span>&#13;
   /* Define to 1 if you have the &lt;unistd.h&gt; header file. */&#13;
   #define HAVE_UNISTD_H 1&#13;
   /* Define to the address where bug reports for this package should be sent. */&#13;
   #define PACKAGE_BUGREPORT ""&#13;
   /* Define to the full name of this package. */&#13;
   #define PACKAGE_NAME "test"&#13;
   /* Define to the full name and version of this package. */&#13;
   #define PACKAGE_STRING "test 1.0"&#13;
   /* Define to the one symbol short name of this package. */&#13;
   #define PACKAGE_TARNAME "test"&#13;
   /* Define to the version of this package. */&#13;
   #define PACKAGE_VERSION "1.0"&#13;
   /* Define to 1 if you have the ANSI C header files. */&#13;
   #define STDC_HEADERS 1&#13;
   $</pre>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em><span epub:type="pagebreak" id="page_110"/>Again, I encourage you to use <em><code>autoreconf</code></em>, which will automatically run <em><code>autoheader</code></em> if it notices an expansion of <em><code>AC_CONFIG_HEADERS</code></em></em> in configure.ac.</p>&#13;
</div>&#13;
<p class="indent">As you can see by the output of the <code>cat</code> command at <span class="ent">➊</span>, an entire set of preprocessor definitions was derived from <em>configure.ac</em> by <code>autoheader</code>.</p>&#13;
<p class="indent"><a href="ch04.xhtml#ch04ex21">Listing 4-21</a> shows a much more realistic example of using a generated <em>config.h</em> file to increase the portability of your project source code. In this example, the <code>AC_CONFIG_HEADERS</code> macro invocation indicates that <em>config.h</em> should be generated, and the invocation of <code>AC_CHECK_HEADERS</code> will cause <code>autoheader</code> to insert a definition into <em>config.h</em>.</p>&#13;
<pre>AC_INIT([test], [1.0])&#13;
AC_CONFIG_HEADERS([config.h])&#13;
AC_CHECK_HEADERS([dlfcn.h])&#13;
AC_OUTPUT</pre>&#13;
<p class="caption"><a id="ch04ex21"/><em>Listing 4-21: A more realistic example of using <code>AC_CONFIG_HEADERS</code></em></p>&#13;
<p class="indent">The <em>config.h</em> file is intended to be included in your source code in locations where you might wish to test a configured option in the code itself using the C preprocessor. This file should be included first in source files so it can influence the inclusion of system header files later in the source.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>The config.h.in template that <em><code>autoheader</code></em> generates doesn’t contain an include-guard construct, so you need to be careful that it’s not included more than once in a source file. A good rule of thumb is to always include</em> config.h <em>as the very first header in every .c source file and never include it anywhere else. Following this rule will guarantee that it never needs an include guard.</em></p>&#13;
</div>&#13;
<p class="indent">It’s often the case that every <em>.c</em> file in a project needs to include <em>config.h</em>. In this case, an interesting approach is to use the <code>gcc</code> <code>-include</code> option to include it at the top of every compiled source file from the compiler command line. This can be done within <em>configure.ac</em> by appending <code>-include config.h</code> to the <code>DEFS</code> variable (which is currently only used to define <code>HAVE_CONFIG_H</code>—if you’re more of a purist, you can use <code>CFLAGS</code> instead). Once done, you may assume <em>config.h</em> is part of every translation unit.</p>&#13;
<p class="indent">Don’t make the mistake of including <em>config.h</em> in a public header file if your project installs libraries and header files as part of your product set. For more detailed information on this topic, refer to “Item 1: Keeping Private Details out of Public Interfaces” on <a href="ch18.xhtml#page_499">page 499</a>.</p>&#13;
<p class="indent">Using the <em>configure.ac</em> file from <a href="ch04.xhtml#ch04ex21">Listing 4-21</a>, the generated <code>configure</code> script will create a <em>config.h</em> header file with appropriate definitions for determining, at compile time, whether or not the current system provides the <code>dlfcn</code> interface. To complete the portability check, you can add the code from <a href="ch04.xhtml#ch04ex22">Listing 4-22</a> to a source file in your project that uses dynamic loader functionality.</p>&#13;
<pre>   #include "config.h"&#13;
<span class="ent">➊</span> #if HAVE_DLFCN_H&#13;
   <span epub:type="pagebreak" id="page_111"/># include &lt;dlfcn.h&gt;&#13;
   #else&#13;
   # error Sorry, this code requires dlfcn.h.&#13;
   #endif&#13;
   <span class="codeitalic1">--snip--</span>&#13;
<span class="ent">➋</span> #if HAVE_DLFCN_H&#13;
       <span class="ash">handle = dlopen("/usr/lib/libwhatever.so", RTLD_NOW);</span>&#13;
   #endif&#13;
   <span class="codeitalic1">--snip--</span></pre>&#13;
<p class="caption"><a id="ch04ex22"/><em>Listing 4-22: A sample source file that checks for dynamic loader functionality</em></p>&#13;
<p class="indent">If you already had code that included <em>dlfcn.h</em>, <code>autoscan</code> would have generated a line in <em>configure.ac</em> to call <code>AC_CHECK_HEADERS</code> with an argument list containing <em>dlfcn.h</em> as one of the header files to be checked. Your job as maintainer is to add the conditional statements at <span class="ent">➊</span> and <span class="ent">➋</span> to your source code around the existing inclusions of the <em>dlfcn.h</em> header file and around calls to the <em>dlfcn</em> interface functions. This is the crux of Autoconf portability support.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>You don’t technically need the preprocessor conditionals around the code if you choose to “error out” if the inclusion check fails, but doing so makes it obvious to the reader which portions of the source code are affected by the conditional inclusion.</em></p>&#13;
</div>&#13;
<p class="indent">Your project might prefer dynamic loader functionality, but could get along without it if necessary. It’s also possible that your project requires a dynamic loader, in which case your build should terminate with an error (as this code does) if the key functionality is missing. Often, this is an acceptable stopgap until someone comes along and adds support to the source code for a more system-specific dynamic loader service.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>If you have to bail out with an error, it’s best to do so at configuration time rather than at compile time. The general rule of thumb is to bail out as early as possible.</em></p>&#13;
</div>&#13;
<p class="indent">As mentioned earlier, <code>HAVE_CONFIG_H</code> is part of a string of definitions passed on the compiler command line in the Autoconf substitution variable <code>@DEFS@</code>. Before <code>autoheader</code> and <code>AC_CONFIG_HEADERS</code> functionality existed, Automake added all of the compiler configuration macros to the <code>@DEFS@</code> variable. You can still use this method if you don’t use <code>AC_CONFIG_HEADERS</code> in <em>configure.ac,</em> but it’s not recommended—mainly because a large number of definitions make for very long compiler command lines.</p>&#13;
<h3 class="h3" id="ch04sec15">Back to Remote Builds for a Moment</h3>&#13;
<p class="noindent">As we wrap up this chapter, you’ll notice that we’ve come full circle. We started out covering some preliminary information before we discussed how to add remote builds to Jupiter. Now we’ll return to this topic for a moment, because I haven’t yet covered how to get the C preprocessor to properly locate a generated <em>config.h</em> file.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_112"/>Since this file is generated from a template, it will be at the same relative position in the build directory structure as its counterpart template file, <em>config.h.in</em>, is in the source directory structure. The template is located in the top-level <em>source</em> directory (unless you chose to put it elsewhere), so the generated file will be in the top-level <em>build</em> directory. Well, that’s easy enough—it’s always one level up from the generated <em>src/Makefile</em>.</p>&#13;
<p class="indent">Before we draw any conclusions then about header file locations, let’s consider where header files might appear in a project. We might generate them in the current build directory, as part of the build process. We might also add internal header files to the current source directory. We know we have a <em>config.h</em> file in the top-level build directory. Finally, we might also create a top-level <em>include</em> directory for library interface header files our package provides. What is the order of priority for these various <em>include</em> directories?</p>&#13;
<p class="indent">The order in which we place <em>include directives</em> (<code>-I</code><em><code>path</code></em> options) on the compiler command line is the order in which they will be searched, so the order should be based on which files are most relevant to the source file currently being compiled. Therefore, the compiler command line should include <code>-I</code><em><code>path</code></em> directives for the current build directory (<code>.</code>) first, followed by the source directory [<code>$(srcdir)</code>], then the top-level build directory (<code>..</code>), and, finally, our project’s <em>include</em> directory, if it has one. We impose this ordering by adding <code>-I</code><em><code>path</code></em> options to the compiler command line, as shown in <a href="ch04.xhtml#ch04ex23">Listing 4-23</a>.</p>&#13;
<p class="margin">Git tag 4.7</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">jupiter: main.c</span>&#13;
        <span class="ash">$(CC) $(CPPFLAGS) $(CFLAGS)</span> -I. -I$(srcdir) -I.. <span class="ash">-o $@ \</span>&#13;
          <span class="ash">$(srcdir)/main.c</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption"><a id="ch04ex23"/><em>Listing 4-23:</em> src/Makefile.in: <em>Adding proper compiler include directives</em></p>&#13;
<p class="indent">Now that we know this, we need to add another rule of thumb for remote builds to the list we created on <a href="ch04.xhtml#page_92">page 92</a>:</p>&#13;
<ul>&#13;
<li class="noindent">Add preprocessor commands for the current build directory, the associated source directory, and the top-level build directory (or other build directory if <em>config.h.in</em> is located elsewhere), in that order.</li>&#13;
</ul>&#13;
<h3 class="h3" id="ch04sec16">Summary</h3>&#13;
<p class="noindent">In this chapter, we covered just about all the major features of a fully functional GNU project build system, including writing a <em>configure.ac</em> file, from which Autoconf generates a fully functional <code>configure</code> script. We’ve also covered adding remote build functionality to makefiles with <code>VPATH</code> statements.</p>&#13;
<p class="indent">So what else is there? Plenty! In the next chapter, I’ll continue to show you how you can use Autoconf to test system features and functionality before your users run <code>make</code>. We’ll also continue enhancing the configuration script so that when we’re done, users will have more options and understand exactly how our package will be built on their systems.</p>&#13;
</body></html>