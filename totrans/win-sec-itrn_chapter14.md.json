["```\nPS> **Get-ADComputer -Identity $env:COMPUTERNAME -Properties ServicePrincipalNames |** **Select-Object -ExpandProperty ServicePrincipalNames**\nHOST/GRAPHITE\nTERMSRV/GRAPHITE.mineral.local\nRestrictedKrbHost/GRAPHITE.mineral.local\nHOST/GRAPHITE.mineral.local\nTERMSRV/GRAPHITE\nRestrictedKrbHost/GRAPHITE \n```", "```\n❶ PS> **$credout = New-LsaCredentialHandle -Package \"Kerberos\" -UseFlag Outbound**\n❷ PS> **$spn = \"HOST/$env:COMPUTERNAME\"**\nPS> **$client = New-LsaClientContext -CredHandle $credout** **-Target $spn**\nPS> **Format-LsaAuthToken -Token $client.Token**\n❸ <KerberosV5 KRB_AP_REQ>\nOptions         : None\n<Ticket>\nTicket Version  : 5\n❹ ServerName      : SRV_INST - HOST/GRAPHITE\nRealm           : MINERAL.LOCAL\n❺ Encryption Type : AES256_CTS_HMAC_SHA1_96\n❻ Key Version     : 1\nCipher Text     :\n00000000: B2 9F B5 0C 7E D9 C4 7F 4A DA 19 CB B4 98 AD 33\n00000010: 20 3A 2E C3 35 0B F3 FE 2D FF A7 FD 00 2B F2 54\n`--snip--`\n00000410: B7 52 F1 0C 7F 0A C8 5E 87 AD 54 4A\n❼ <Authenticator>\nEncryption Type : AES256_CTS_HMAC_SHA1_96\nCipher Text     :\n00000000: E4 E9 55 CB 40 41 27 05 D0 52 92 79 76 91 4D 8D\n00000010: A1 F2 56 D1 23 1F BF EC 7A 60 14 0E 00 B6 AD 3D\n`--snip--`\n00000190: 04 D4 E4 5D 18 60 DB C5 FD \n```", "```\n(0x80090303) - The specified target is unknown or unreachable \n```", "```\nPS> **$credin = New-LsaCredentialHandle -Package \"Kerberos\" -UseFlag Inbound**\nPS> **$server = New-LsaServerContext -CredHandle $credin**\nPS> **Update-LsaServerContext -Server $server -Token $client.Token**\nException calling \"Continue\" with \"1\" argument(s):\n\"(0x8009030C) - The logon attempt failed\" \n```", "```\nPS> **$credout = New-LsaCredentialHandle -Package \"Kerberos\" -UseFlag Outbound**\n❶ PS> **$spn = \"RestrictedKrbHost/$env:COMPUTERNAME\"**\nPS> **$client = New-LsaClientContext -CredHandle $credout -Target $spn**\nPS> **Format-LsaAuthToken -Token $client.Token**\n<KerberosV5 KRB_AP_REQ>\nOptions         : None\n<Ticket>\nTicket Version  : 5\n❷ ServerName      : SRV_INST - RestrictedKrbHost/GRAPHITE\n`--snip--`\n\nPS> **$credin = New-LsaCredentialHandle -Package \"Kerberos\" -UseFlag Inbound**\nPS> **$server = New-LsaServerContext -CredHandle $credin**\nPS> **Update-LsaServerContext -Server $server -Token $client.Token**\nPS> **Use-NtObject($token = Get-LsaAccessToken $server) {**\n   **Get-NtLogonSession $token | Format-Table**\n**}**\n❸ LogonId           UserName      LogonType SessionId\n-------           --------      --------- ---------\n00000000-01214E12 MINERAL\\alice Network   0 \n```", "```\n❶ PS> **$client = New-LsaClientContext -CredHandle $credout**\n**-Target \"RestrictedKrbHost/$env:COMPUTERNAME\" -RequestAttribute MutualAuth**\nPS> **Format-LsaAuthToken -Token $client.Token**\n<KerberosV5 KRB_AP_REQ>\n❷ Options         : MutualAuthRequired\n`--snip--`\n\nPS> **$server = New-LsaServerContext -CredHandle $credin**\nPS> **Update-LsaServerContext -Server $server -Token $client.Token**\nPS> **$ap_rep = $server.Token**\nPS> **$ap_rep | Format-LsaAuthToken**\n❸ <KerberosV5 KRB_AP_REP>\n<Encrypted Part>\n❹ Encryption Type : AES256_CTS_HMAC_SHA1_96\nCipher Text     :\n00000000: 32 E1 3F FC 25 70 51 29 51 AE 4E AC B9 BD 58 72\n`--snip--` \n```", "```\nPS> **Set-ADUser -Identity alice -ServicePrincipalNames @{Add=\"HTTP/graphite\"}** \n```", "```\nPS> **$credout = New-LsaCredentialHandle -Package \"Kerberos\" -UseFlag Outbound**\nPS> **$client = New-LsaClientContext -CredHandle $credout -Target** \n**\"HTTP/graphite\"**\nPS> **Format-LsaAuthToken -Token $client.Token**\n<KerberosV5 KRB_AP_REQ>\nOptions         : None\n<Ticket>\nTicket Version  : 5\nServer Name     : SRV_INST - HTTP/graphite\nRealm           : MINERAL.LOCAL\nEncryption Type : ARCFOUR_HMAC_MD5\nKey Version     : 3\nCipher Text     :\n00000000: 1A 33 03 E3 04 47 29 99 AF B5 E0 5B 6A A4 B0 D9\n00000010: BA 7E 9F 84 C3 BD 09 62 57 B7 FB F7 86 3B D7 08\n`--snip--`\n00000410: AF 74 71 23 96 D6 30 01 05 9A 89 D7\n<Authenticator>\nEncryption Type : ARCFOUR_HMAC_MD5\nCipher Text     :\n00000000: 72 30 A1 25 F1 CC DD B2 C2 7F 61 8B 36 F9 37 B5\n00000010: 0C D8 17 6B BB 60 D3 04 6E 3A C4 67 68 3D 90 EE\n`--snip--`\n00000180: 5E 91 16 3A 5F 7B 96 35 91 \n```", "```\nPS> **$key = Get-KerberosKey -Password \"****`AlicePassw0rd`****\" -KeyType ARCFOUR_HMAC_MD5**\n**-NameType SRV_INST -Principal \"HTTP/graphite@mineral.local\"**\nPS> **$key.Key | Out-HexDump**\nC0 12 36 B2 39 0B 9E 82 EE FD 6E 8E 57 E5 1C E1 \n```", "```\nPS> **$ap_req = Unprotect-LsaAuthToken -Token $client.Token -Key $key**\nPS> **$ap_req | Format-LsaAuthToken**\n<KerberosV5 KRB_AP_REQ>\nOptions         : None\n<Ticket>\nTicket Version  : 5\nServer Name     : SRV_INST - HTTP/graphite\nRealm           : MINERAL.LOCAL\nFlags           : Forwardable, Renewable, PreAuthent, EncPARep\n❶ Client Name     : PRINCIPAL - alice\nClient Realm    : MINERAL.LOCAL\n❷ Auth Time       : 5/12 5:37:40 PM\nStart Time      : 5/12 5:43:07 PM\nEnd Time        : 5/13 3:37:40 AM\nRenew Till Time : 5/19 5:37:40 PM \n```", "```\n<Session Key>\nEncryption Type : ARCFOUR_HMAC_MD5\nEncryption Key  : 27BD4DE38A47B87D08E03500DF116AB5 \n```", "```\n<Authorization Data - AD_WIN2K_PAC>\n<PAC Entry Logon>\n<User Information> ❶\nEffective Name   : alice\nFull Name        : Alice Roberts\nUser SID         : S-1-5-21-1195776225-522706947-2538775957-1110\nPrimary Group    : MINERAL\\Domain Users\nPrimary Group SID: S-1-5-21-1195776225-522706947-2538775957-513\n<Groups> ❷\nMINERAL\\Domain Users            - Mandatory, EnabledByDefault, Enabled\n<Resource Groups> ❸\nResource Group   : S-1-5-21-1195776225-522706947-2538775957 ❹\nMINERAL\\Local Resource          - Mandatory, EnabledByDefault, Enabled, Resource\n<Extra Groups> ❺\nNT AUTHORITY\\Claims Valid       - Mandatory, EnabledByDefault, Enabled\nAuthentication authority asserted identity - Mandatory, EnabledByDefault, Enabled\n<Account Details> ❻\nLogon Time       : 5/12 5:37:15 PM\nPassword Last Set: 5/8 11:07:55 AM\nPassword Change  : 5/9 11:07:55 AM\nLogon Count      : 26\nBad Password #   : 0\nLogon Server     : PRIMARYDC\nLogon Domain     : MINERAL\nLogon Domain SID : S-1-5-21-1195776225-522706947-2538775957 ❼\nUser Flags       : ExtraSidsPresent, ResourceGroupsPresent\nUser Account Cntl: NormalAccount, DontExpirePassword\nSession Key      : 00000000000000000000000000000000 ❽ \n```", "```\n<PAC Entry UserClaims>\n<ActiveDirectory Claim>\nad://ext/cn:88d7f6d41914512a - String - Alice Roberts\nad://ext/country:88d7f5009d9f2815 - String - US\nad://ext/department:88d7f500a308c4a9 - String - R&D \n```", "```\n<PAC Entry Device>\nDevice Name      : MINERAL\\GRAPHITE$\nPrimary Group    : MINERAL\\Domain Computers\n<Groups>\nMINERAL\\Domain Computers       - Mandatory, EnabledByDefault, Enabled\n<Domain Groups>\nNT AUTHORITY\\Claims Valid      - Mandatory, EnabledByDefault, Enabled\n<Extra Groups>\nAuthentication authority asserted identity - Mandatory, EnabledByDefault, Enabled\n\n<PAC Entry DeviceClaims>\n<ActiveDirectory Claim>\nad://ext/cn:88d7f6d41914512a - String - GRAPHITE\nad://ext/operatingSystem:88d7f6d534791d12 - String - Windows Enterprise \n```", "```\n<PAC Entry ClientInfo>\nClient ID        : 5/12 5:37:40 PM\nClient Name      : alice\n\n<PAC Entry UserPrincipalName>\nFlags            : None\nName             : alice@mineral.local\nDNS Name         : MINERAL.LOCAL \n```", "```\n<PAC Entry ServerChecksum>\nSignature Type   : HMAC_MD5\nSignature        : 7FEA93110C5E193734FF5071ECC6B3C5\n\n<PAC Entry KDCChecksum>\nSignature Type   : HMAC_SHA1_96_AES_256\nSignature        : 9E0689AF7CFE1445EBACBF88\n\n<PAC Entry TicketChecksum>\nSignature Type   : HMAC_SHA1_96_AES_256\nSignature        : 1F97471A222BBCDE8EC717BC \n```", "```\n<Authenticator>\nClient Name     : PRINCIPAL - alice\nClient Realm    : MINERAL.LOCAL\nClient Time     : 5/13 2:15:03 AM\n❶ Checksum        : GSSAPI\nChannel Binding : 00000000000000000000000000000000\nContext Flags   : None\n❷ <Sub Session Key>\nEncryption Type : ARCFOUR_HMAC_MD5\nEncryption Key  : B3AC3B1C31937088B7B1BC880B10950E\n❸ Sequence Number : 0x7DDD0DBA\n❹ <Authorization Data - AD_ETYPE_NEGOTIATION>\nAES256_CTS_HMAC_SHA1_96, AES128_CTS_HMAC_SHA1_96, ARCFOUR_HMAC_MD5 \n```", "```\nChannel Binding : BAD4B8274DC394EDC375CA8ABF2D2AEE \n```", "```\nPS> **$sesskey = (Unprotect-LsaAuthToken -Token $ap_req -Key $key).Ticket.Key**\nPS> **Unprotect-LsaAuthToken -Token $ap_rep -Key $sesskey | Format-LsaAuthToken**\n<KerberosV5 KRB_AP_REP>\n<Encrypted Part>\nClient Time      : 05-14 01:48:39\n<Sub Session Key>\nEncryption Type : AES256_CTS_HMAC_SHA1_96\nEncryption Key  : 76F0794F1F3B8CE10C38CFA98BF74AF5229C7F626110C6302E4B8780AE91FD3A\nSequence Number : 0x699181B8 \n```", "```\nPS> **Set-ADAccountControl -Identity alice -TrustedForDelegation $true** \n```", "```\nPS> **Get-ADUser -Identity alice -Properties TrustedForDelegation |**\n**Select-Object TrustedForDelegation**\nTrustedForDelegation\n--------------------\n                True \n```", "```\nPS> **$credout = New-LsaCredentialHandle -Package \"Kerberos\" -UseFlag Outbound**\n❶ PS> **$client = New-LsaClientContext -CredHandle $credout -Target** \n**\"HTTP/graphite\"-RequestAttribute MutualAuth, Delegate**\nPS> **$key = Get-KerberosKey -Password \"AlicePassw0rd\" -KeyType ARCFOUR_HMAC_MD5**\n**-NameType SRV_INST -Principal \"HTTP/graphite@mineral.local\"**\nPS> **Unprotect-LsaAuthToken -Token $client.Token -Key $key |** \n**Format-LsaAuthToken**\n<KerberosV5 KRB_AP_REQ>\nOptions         : MutualAuthRequired\n<Ticket>\nTicket Version  : 5\nServer Name     : SRV_INST - HTTP/graphite\nRealm           : MINERAL.LOCAL\n❷ Flags           : Forwardable, Renewable, PreAuthent, OkAsDelegate, EncPARep\n`--snip--` \n```", "```\n<Authenticator>\nClient Name     : PRINCIPAL - alice\nClient Realm    : MINERAL.LOCAL\nClient Time     : 5/15 1:51:00 PM\nChecksum        : GSSAPI\nChannel Binding : 00000000000000000000000000000000\n❶ Context Flags   : Delegate, Mutual\nDelegate Opt ID : 1\n<KerberosV5 KRB_CRED>\n❷ <Ticket 0>\nTicket Version  : 5\n❸ Server Name     : SRV_INST - krbtgt/MINERAL.LOCAL\nRealm           : MINERAL.LOCAL\nEncryption Type : AES256_CTS_HMAC_SHA1_96\nKey Version     : 2\nCipher Text     :\n00000000: 49 FA B2 17 34 F9 0F D6 0C DE A3 67 54 9E 74 B7\n00000010: 4E 1B 18 DC 91 40 F1 91 DC 42 37 64 CC 39 56 78\n`--snip--`\n000005D0: E5 D5 99 FD 15 2B\n❹ <Encrypted Part>\nEncryption Type : AES256_CTS_HMAC_SHA1_96\nCipher Text     :\n00000000: 3B 25 F6 CA 18 B4 E6 D4 C0 77 07 66 73 0E 67 9C\n`--snip--` \n```", "```\nPS> **$credin = New-LsaCredentialHandle -Package \"Kerberos\" -UseFlag Inbound**\nPS> **$server = New-LsaServerContext -CredHandle $credin**\nPS> **Update-LsaServerContext -Server $server -Client $client**\nPS> **Use-NtObject($token = Get-LsaAccessToken $server) {**\n    **Format-NtToken $token -Information**\n**}**\nTOKEN INFORMATION\n-----------------\nType       : Impersonation\nImp Level  : Delegation\n`--snip--` \n```", "```\nPS> **$spns = @{'msDS-AllowedToDelegateTo'=@('CIFS/graphite')}**\nPS> **Set-ADUser -Identity alice -Add $spns** \n```", "```\nPS> **Get-ADUser -Identity alice -Properties 'msDS-AllowedToDelegateTo' |**\n**Select-Object -Property 'msDS-AllowedToDelegateTo'**\nmsDS-AllowedToDelegateTo\n------------------------\n{CIFS/graphite} \n```", "```\nPS> **Set-ADAccountControl -Identity alice -TrustedToAuthForDelegation $true** \n```", "```\nPS> **Get-ADUser -Identity alice -Properties TrustedToAuthForDelegation |**\n**Select-Object -Property TrustedToAuthForDelegation**\nTrustedToAuthForDelegation\n--------------------------\n                      True \n```", "```\nPS> **Show-NtTokenEffective**\nMINERAL\\alice\n\n❶ PS> **$token = Get-NtToken -S4U -User bob -Domain MINERAL**\nPS> **Format-NtToken $token**\n❷ MINERAL\\bob\n\nPS> **Format-NtToken $token -Information**\nTOKEN INFORMATION\n-----------------\nType       : Impersonation\n❸ Imp Level  : Identification\n`--snip--` \n```", "```\nPS> **Set-ADUser -Identity alice**\n**-PrincipalsAllowedToDelegateToAccount (Get-ADComputer GRAPHITE)**\nPS> **Get-ADUser -Identity alice -Properties** \n**PrincipalsAllowedToDelegateToAccount |**\n**Select-Object PrincipalsAllowedToDelegateToAccount**\nPrincipalsAllowedToDelegateToAccount\n------------------------------------\n❶ {CN=GRAPHITE,CN=Computers,DC=mineral,DC=com}\nPS> **$name = \"msDS-AllowedToActOnBehalfOfOtherIdentity\"**\nPS> **(Get-ADUser -Identity alice -Properties $name)[$name] |**\n**ConvertTo-NtSecurityDescriptor | Format-NtSecurityDescriptor -Summary**\n<Owner> : BUILTIN\\Administrators\n<DACL>\n❷ MINERAL\\GRAPHITE$: (Allowed)(None)(Full Access) \n```", "```\nPS> **Set-ADUser -Identity alice -AccountNotDelegated $true** \n```", "```\n❶ PS> **Get-ADUser -Identity alice -Properties AccountNotDelegated |**\n**Select-Object AccountNotDelegated**\nAccountNotDelegated\n-------------------\n               True\nPS> **$client = New-LsaClientContext -CredHandle $credout -Target** \n**\"HTTP/graphite\"**\nPS> **Unprotect-LsaAuthToken -Token $client.Token -Key $key |** \n**Format-LsaAuthToken**\n<KerberosV5 KRB_AP_REQ>\nOptions         : MutualAuthRequired\n<Ticket>\nTicket Version  : 5\nServer Name     : SRV_INST - HTTP/graphite\nRealm           : MINERAL.LOCAL\n❷ Flags           : Renewable, PreAuthent, EncPARep\n`--snip--` \n```", "```\nPS> **$credout = New-LsaCredentialHandle -Package \"Kerberos\" -UseFlag Outbound**\n❶ PS> **$client = New-LsaClientContext -CredHandle $credout -Target** \n**bob@mineral.local**\nPS> **Format-LsaAuthToken -Token $client.Token**\n❷ <KerberosV5 KRB_TGT_REQ>\nPrincipal: bob@mineral.local \n```", "```\nPS> **$credin = New-LsaCredentialHandle -Package \"Kerberos\" -UseFlag Inbound**\n**-ReadCredential**\nUserName: bob\nDomain: MINERAL\nPassword: **********\n\nPS> **$server = New-LsaServerContext -CredHandle $credin**\nPS> **Update-LsaServerContext -Server $server -Client $client**\nPS> **Format-LsaAuthToken -Token $server.Token**\n❶ <KerberosV5 KRB_TGT_REP>\nTicket Version  : 5\nServer Name     : SRV_INST - krbtgt/MINERAL.LOCAL\nRealm           : MINERAL.LOCAL\nEncryption Type : AES256_CTS_HMAC_SHA1_96\nKey Version     : 2\nCipher Text     :\n00000000: 98 84 C6 F4 B3 92 66 A7 50 6E 9B C2 AF 48 70 09\n00000010: 76 E9 75 E8 D6 DE FF A5 A2 E9 6F 10 A9 1E 43 FE\n`--snip--` \n```", "```\nPS> **Update-LsaClientContext -Client $client -Server $server**\nPS> **Format-LsaAuthToken -Token $client.Token**\n❶ <KerberosV5 KRB_AP_REQ>\n❷ Options         : UseSessionKey\n<Ticket>\nTicket Version  : 5\n❸ Server Name     : PRINCIPAL - bob\nRealm           : MINERAL.LOCAL\nEncryption Type : AES256_CTS_HMAC_SHA1_96\nCipher Text     :\n00000000: 26 3B A8 9D DA 13 74 9F DC 47 16 83 0C AB 4F FF\n00000010: 75 A3 45 E4 16 6F D1 E9 DA FA 71 E2 26 DE 42 8C\n`--snip--` \n```", "```\n❶ PS> **Update-LsaServerContext -Server $server -Client $client**\nPS> **Use-NtObject($token = Get-LsaAccessToken $server) {**\n    **Get-NtLogonSession $token | Format-Table**\n**}**\nLogonId           UserName       LogonType SessionId\n-------           --------       --------- ---------\n❷ 00000000-005CD2EF MINERAL\\alice  Network   0 \n```", "```\n❶ PS> **Get-KerberosTicket | Select-Object ServiceName, EndTime**\nServiceName                                           EndTime\n-----------                                           -------\n❷ SRV_INST - krbtgt/MINERAL.LOCAL                       3/19 6:12:15 AM\nSRV_INST - LDAP/PRIMARYDC.mineral.local/mineral.local 3/19 6:12:15 AM\n\n❸ PS> **Get-KerberosTicket | Select-Object -First 1 | Format-KerberosTicket**\nTicket Version  : 5\nServer Name     : SRV_INST - krbtgt/MINERAL.LOCAL\nRealm           : MINERAL.LOCAL\nEncryption Type : AES256_CTS_HMAC_SHA1_96\nKey Version     : 2\nCipher Text     :\n00000000: 10 F5 39 C5 E1 6D BB 59 E0 CF 04 61 F6 2D CF E2\n00000010: 94 B3 88 46 DB 69 88 FF F4 F2 8B 52 AD 48 20 9C\n00000020: 2D AE A4 02 4B 9E 75 F3 D0 05 23 63 70 31 E4 88\n00000030: 4F 3E DD E7 23 DE 4B 7A 0D A9 47 62 90 6E 24 65\n`--snip--` \n```", "```\nPS> **$sess = Get-NtLogonSession**\nPS> **$tickets = Invoke-NtToken -System {Get-KerberosTicket -LogonSession $sess}**\nPS> **$tickets | Select-Object ServiceName, {Format-HexDump $_.SessionKey.Key}**\nServiceName                      Format-HexDump $_.SessionKey.Key\n-----------                      --------------------------------\nSRV_INST - krbtgt/MINERAL.LOCAL  EE 3D D2 F7 6F 5F 7E 06 B6 E2 4E 6C C6 36 59 64\n`--snip--` \n```", "```\nPS> **Get-ADUser -Filter {**\n    **ObjectClass -eq 'user'**\n**} -Properties ServicePrincipalName |**\n**Where-Object ServicePrincipalName -ne $null |**\n**Select SamAccountName, ServicePrincipalName**\nSamAccountName ServicePrincipalName\n-------------- --------------------\nkrbtgt         {kadmin/changepw}\nalice          {HTTP/graphite}\nsqlserver      {MSSQL/topaz.mineral.local} \n```", "```\nPS> **$creds = New-LsaCredentialHandle -Package \"Kerberos\" -UseFlag Outbound**\nPS> **$client = New-LsaClientContext -CredHandle $creds**\n**-Target \"MSSQL/topaz.mineral.local\"**\nPS> **Format-LsaAuthToken $client**\n<KerberosV5 KRB_AP_REQ>\nOptions         : None\n<Ticket>\nTicket Version  : 5\nServer Name     : SRV_INST - MSSQL/topaz.mineral.local\nRealm           : MINERAL.LOCAL\nEncryption Type : ARCFOUR_HMAC_MD5\nKey Version     : 2\nCipher Text     :\n00000000: F3 23 A8 DB C3 64 BE 58 48 7A 4D E1 20 50 E7 B9\n00000010: CB CA 17 59 A3 5C 0E 1D 6D 56 F9 B5 5C F5 EE 11\n`--snip--` \n```", "```\nPS> **$pwds = \"ABC!!!!\", \"SQLRUS\", \"DBPassw0rd\"**\nPS> **foreach($pwd in $pwds) {**\n    **$key = Get-KerberosKey -Password $pwd -KeyType ARCFOUR_HMAC_MD5**\n**-NameType SRV_INST -Principal \"MSSQL/topaz.mineral.local@mineral.local\"**\n    **$dec_token = Unprotect-LsaAuthToken -Key $key -Token $client.Token**\n❶ **if ($dec_token.Ticket.Decrypted) {**\n        **Write-Host \"Decrypted ticket with password: $pwd\"**\n        **break**\n **}**\n**}**\nDecrypted ticket with password: DBPassw0rd \n```"]