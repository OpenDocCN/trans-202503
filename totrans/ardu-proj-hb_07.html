<html><head></head><body>
<h1 class="part" id="part06"><span epub:type="pagebreak" id="page_155"/><strong>PART 6</strong><br/><img alt="image" class="middle" src="../images/common-01.jpg"/><br/><span class="big"><strong>SECURITY</strong></span></h1>&#13;


<h2 class="h2a" id="ch18"><span epub:type="pagebreak" id="page_156"/>PROJECT 18: INTRUDER SENSOR</h2>&#13;
<p class="h2sub"><strong><span class="green1">IN THIS PROJECT, WE’LL USE AN ULTRASONIC SENSOR TO DETECT AN INTRUDER.</span></strong></p>&#13;
<div class="image2"><img alt="image" src="../images/f0156-01.jpg"/></div>&#13;
<div class="image2"><span epub:type="pagebreak" id="page_157"/><img alt="image" src="../images/f0157-01.jpg"/></div>&#13;
<div class="box1">&#13;
<p class="boxtitle1a"><span class="green1"><strong>PARTS REQUIRED</strong></span></p>&#13;
<p class="bull">• Arduino board</p>&#13;
<p class="bull">• Breadboard</p>&#13;
<p class="bull">• Jumper wires</p>&#13;
<p class="bull">• Four-pin HC-SR04 ultrasonic sensor</p>&#13;
<p class="bull">• Servomotor</p>&#13;
<p class="bull">• Red LED</p>&#13;
<p class="bull">• Green LED</p>&#13;
<p class="bull">• 2 220-ohm resistors</p>&#13;
</div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_158"/>We’ll connect the intruder sensor to a servo and some LEDs so that when someone comes within a certain distance, a green LED turns off, a red LED turns on, and the servomotor moves (see <a href="ch18.xhtml#ch18fig1">Figure 18-1</a>).</p>&#13;
<p class="figcaption"><a id="ch18fig1"/><strong>FIGURE 18-1:</strong><br/>The LEDs alert you to an intruder.</p>&#13;
<div class="image"><img alt="image" src="../images/f18-01.jpg"/></div>&#13;
<h3 class="h3" id="ch18lev1sec01"><span class="green1"><strong>HOW IT WORKS</strong></span></h3>&#13;
<p class="noindent">This project is versatile and can be used and adapted in various ways. Because the ultrasonic sensor can define distance, you could, for example, use it to define an area and trigger an alarm when that perimeter is breached. The sensor works similarly to a radar: it sends out an ultrasonic signal, or <em>ping</em>. When this signal hits an object, it bounces back like an echo, and the time between the ping and the echo is used to calculate distance. The Arduino can use this calculation to trigger an event, depending on the value received.</p>&#13;
<p class="indent">In this project, when the sensor detects an intruder within a predefined vicinity, the red LED will light and the servo arm will move. You can adapt this project to trigger a different event when the intruder is detected, like pressing a security system button or locking a door. For a friendlier scenario, you could set the distance really close so that when you wave your hand in front of the sensor, the servo presses a button to release a treat, like candy.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong>NOTE</strong></p>&#13;
<p class="notep"><em>To use the same ultrasonic sensor shown in these figures, see “<a href="app01.xhtml#app01lev1sec02">Retailer List</a>” on <a href="app01.xhtml#page_240">page 240</a> or search online for</em> HC-SR04 ultrasonic module.</p>&#13;
</div>&#13;
<h3 class="h3" id="ch18lev1sec02"><span class="green1"><strong>THE BUILD</strong></span></h3>&#13;
<ol>&#13;
<li><p class="noindenta">Insert the ultrasonic sensor into the breadboard. The sensor we’re using in this project has four pins, as shown in <a href="ch18.xhtml#ch18fig2">Figure 18-2</a>. Connect the sensor’s GND to the Arduino GND rail, VCC to Arduino +5V, Trig to Arduino pin 12, and Echo to Arduino pin 13.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="tableth1a-g1" style="vertical-align: middle;"><p class="tablec"><span epub:type="pagebreak" id="page_159"/><strong>ULTRASONIC SENSOR</strong></p></td>&#13;
<td class="tableth2" style="vertical-align: middle;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">GND</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">VCC</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Trig</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 12</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table3a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Echo</span></p></td>&#13;
<td class="table3l" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 13</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<p class="figcaption"><a id="ch18fig2"/><strong>FIGURE 18-2:</strong><br/>The HC-SR04 ultrasonic sensor</p>&#13;
<div class="image"><img alt="image" src="../images/f18-02.jpg"/></div></li>&#13;
<li><p class="noindenta">Connect the servo’s brown (ground) wire to the Arduino GND rail, its red (power) wire to the Arduino +5V rail, and its yellow signal (control) wire to Arduino pin 9.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="tableth1a-g1" style="vertical-align: middle;"><p class="tablec"><strong>SERVO</strong></p></td>&#13;
<td class="tableth2" style="vertical-align: middle;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Red wire</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Brown wire</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table3a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Yellow wire</span></p></td>&#13;
<td class="table3l" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 9</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindenta">Insert the red and green LEDs into the breadboard with the shorter, negative legs in the Arduino GND rail. Add a 220-ohm resistor to each of the positive legs, and connect the red LED to Arduino pin 2 and the green LED to pin 3 via the resistors.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="tableth1a-g1" style="vertical-align: middle;"><p class="tablec"><strong>LEDS</strong></p></td>&#13;
<td class="tableth2" style="vertical-align: middle;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Negative legs</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Positive leg (red)</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 2 via 220-ohm resistor</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table3a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Positive leg (green)</span></p></td>&#13;
<td class="table3l" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 3 via 220-ohm resistor</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindenta">Connect the power rails on the breadboard to Arduino +5V and GND. The final configuration is shown in <a href="ch18.xhtml#ch18fig3">Figure 18-3</a>.</p>&#13;
<p class="figcaption"><a id="ch18fig3"/><strong>FIGURE 18-3:</strong><br/>The complete intruder sensor project</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_160"/><img alt="image" src="../images/f18-03.jpg"/></div></li>&#13;
<li><p class="noindenta">Check that your setup matches that of <a href="ch18.xhtml#ch18fig4">Figure 18-4</a> and then upload the code in “<a href="ch18.xhtml#ch18lev1sec03">The Sketch</a>” on <a href="ch18.xhtml#page_161">page 161</a>.</p>&#13;
<p class="figcaption"><a id="ch18fig4"/><strong>FIGURE 18-4:</strong><br/>The circuit diagram for the intruder sensor</p>&#13;
<div class="image"><img alt="image" src="../images/f18-04.jpg"/></div></li>&#13;
</ol>&#13;
<h3 class="h3" id="ch18lev1sec03"><span epub:type="pagebreak" id="page_161"/><span class="green1"><strong>THE SKETCH</strong></span></h3>&#13;
<p class="noindent">When an object is within the trigger distance, the red LED will light and the servo will move 45 degrees. You can change the distance of the sensor field in the following line of the sketch:</p>&#13;
<pre><span class="green3">if</span> (distance &lt;= 15)</pre>&#13;
<p class="indent">In this example, if something is sensed within a distance of 15 centimeters, the next block of code will run.</p>&#13;
<p class="indent">The Trig pin on the sensor is connected to Arduino pin 12 and emits an ultrasonic signal or ping. When the signal reaches an object, it bounces back to the module, and this echo is sent to Arduino pin 13. The time difference between the two signals gives us our distance reading. If the distance is more than our set minimum, the green LED stays on; if not, the red LED lights and the servo moves.</p>&#13;
<pre><span class="ash">/* NewPing Library created by Tim Eckel teckel@leethost.com.</span><br/>   <span class="ash">Copyright 2012 License: GNU GPL v3</span><br/>   <span class="ash">http://www.gnu.org/licenses/gpl-3.0.html</span><br/><span class="ash">*/</span><br/><br/>#include &lt;<span class="orange1">NewPing</span>.h&gt; <span class="ash">// Call NewPing library</span><br/>#include &lt;<span class="orange1">Servo</span>.h&gt;   <span class="ash">// Call Servo library</span><br/>#define trigPin 12   <span class="ash">// Trig pin connected to Arduino 12</span><br/>#define echoPin 13   <span class="ash">// Echo pin connected to Arduino 13</span><br/>#define MAX_DISTANCE 500<br/>NewPing sonar(trigPin, echoPin, MAX_DISTANCE); <span class="ash">// Library setting</span><br/><span class="green2">int</span> greenLed = 3, redLed = 2; <span class="ash">// Set green LED to pin 3, red to pin 2</span><br/><span class="green2">int</span> pos = 20;<br/><span class="orange1">Servo</span> myservo;<br/><br/><span class="green2">void</span> <span class="green3">setup</span>() {<br/>  <span class="orange1">Serial.begin</span> (115200);<br/>  <span class="orange1">pinMode</span>(trigPin, <span class="green2">OUTPUT</span>);<br/>  <span class="orange1">pinMode</span>(echoPin, <span class="green2">INPUT</span>);<br/>  <span class="orange1">pinMode</span>(greenLed, <span class="green2">OUTPUT</span>);<br/>  <span class="orange1">pinMode</span>(redLed, <span class="green2">OUTPUT</span>);<br/>  myservo.<span class="orange1">attach</span>(9); <span class="ash">// Servo attached to pin 9</span><br/>}<br/><br/><span class="green2">void</span> <span class="green3">loop</span>() {<br/>  <span class="green2">int</span> duration, distance, pos = 0, i;<br/>  <span class="orange1">digitalWrite</span>(trigPin, <span class="green2">LOW</span>);<br/>  <span class="orange1">delayMicroseconds</span>(2);<br/>  <span class="orange1">digitalWrite</span>(trigPin, <span class="green2">HIGH</span>); <span class="ash">// Trig pin sends a ping</span><br/>  <span class="orange1">delayMicroseconds</span>(10);<br/>  <span class="orange1">digitalWrite</span>(trigPin, <span class="green2">LOW</span>);<br/>  duration = <span class="orange1">pulseIn</span>(echoPin, <span class="green2">HIGH</span>); <span class="ash">// Echo receives the ping</span><br/>  distance = (duration / 2) / 29.1;<br/>  <span epub:type="pagebreak" id="page_162"/><span class="orange1">Serial</span>.<span class="orange1">print</span>(distance);<br/>  <span class="orange1">Serial</span>.<span class="orange1">println</span>(<span class="green2">" cm"</span>);<br/>  <span class="ash">// If sensor detects object within 15 cm</span><br/>  <span class="green3">if</span> (distance &lt;= 15) {<br/>    <span class="orange1">digitalWrite</span>(greenLed, <span class="green2">LOW</span>); <span class="ash">// Turn off green LED</span><br/>    <span class="orange1">digitalWrite</span>(redLed, <span class="green2">HIGH</span>);  <span class="ash">// Turn on red LED</span><br/>    myservo.<span class="orange1">write</span>(180);          <span class="ash">// Move servo arm 180 degrees</span><br/>    <span class="orange1">delay</span>(450);<br/>    <span class="orange1">digitalWrite</span>(redLed, <span class="green2">LOW</span>);   <span class="ash">// Light the red LED</span><br/>    myservo.<span class="orange1">write</span>(90);<br/>    <span class="orange1">delay</span>(450);<br/>    <span class="orange1">digitalWrite</span>(redLed, <span class="green2">HIGH</span>);<br/>    myservo.<span class="orange1">write</span>(0);<br/>    <span class="orange1">delay</span>(450);<br/>    <span class="orange1">digitalWrite</span>(redLed, <span class="green2">LOW</span>);<br/>    myservo.<span class="orange1">write</span>(90);<br/>  }<br/>  <span class="ash">// Otherwise</span><br/>  <span class="green3">else</span> {<br/>    <span class="orange1">digitalWrite</span>(redLed, <span class="green2">LOW</span>);    <span class="ash">// Turn off red LED</span><br/>    <span class="orange1">digitalWrite</span>(greenLed, <span class="green2">HIGH</span>); <span class="ash">// Turn on green LED</span><br/>    myservo.<span class="orange1">write</span>(90);<br/>  }<br/>  <span class="orange1">delay</span>(450);<br/>}</pre>&#13;


<h2 class="h2a" id="ch19"><span epub:type="pagebreak" id="page_163"/>PROJECT 19: LASER TRIP WIRE ALARM</h2>&#13;
<p class="h2sub"><strong><span class="green1">IN THIS PROJECT, YOU’LL CREATE A SIMPLE LASER TRIP WIRE ALARM.</span></strong></p>&#13;
<div class="image2"><img alt="image" src="../images/f0163-01.jpg"/></div>&#13;
<div class="image2"><span epub:type="pagebreak" id="page_164"/><img alt="image" src="../images/f0164-01.jpg"/></div>&#13;
<div class="box1">&#13;
<p class="boxtitle1a"><span class="green1"><strong>PARTS REQUIRED</strong></span></p>&#13;
<p class="bull">• Arduino board</p>&#13;
<p class="bull">• Breadboard</p>&#13;
<p class="bull">• Jumper wires</p>&#13;
<p class="bull">• Photoresistor</p>&#13;
<p class="bull">• Piezo buzzer</p>&#13;
<p class="bull">• Green LED</p>&#13;
<p class="bull">• 10k-ohm resistor</p>&#13;
<p class="bull">• Laser pen</p>&#13;
</div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_165"/>You’ve probably seen a movie where a valuable item is protected by a grid of laser beams. The beams look cool and seem pretty high-tech, but the principles behind them are actually very simple.</p>&#13;
<h3 class="h3" id="ch19lev1sec01"><span class="green1"><strong>HOW IT WORKS</strong></span></h3>&#13;
<p class="noindent">When the laser pen shines on the photoresistor, the green LED will light up to signify that the circuit is ready. When the laser beam is broken, the LED turns off and the buzzer sounds.</p>&#13;
<p class="indent">As we know from <a href="ch13.xhtml#ch13">Projects 13</a> and <a href="ch18.xhtml#ch18">18</a>, photoresistors produce variable resistance depending on the amount of light falling on their sensor. When the photoresistor does not detect light from the laser, it will drop its resistance and trigger the Arduino to send voltage to the pin controlling the buzzer.</p>&#13;
<p class="indent">Laser beams that are visible in daylight or even in the dark are very powerful and can be extremely dangerous. In this project we’ll use a low-powered laser pen instead (see <a href="ch19.xhtml#ch19fig1">Figure 19-1</a>).</p>&#13;
<p class="figcaption"><a id="ch19fig1"/><strong>FIGURE 19-1:</strong><br/>Laser pens can still be dangerous and should never be directed toward anybody’s eyes!</p>&#13;
<div class="image"><img alt="image" src="../images/f19-01.jpg"/></div>&#13;
<h3 class="h3" id="ch19lev1sec02"><span class="green1"><strong>THE BUILD</strong></span></h3>&#13;
<ol>&#13;
<li><p class="noindenta">Insert your photoresistor into the breadboard. Connect one leg to the +5V rail using a jumper wire. Connect a 10k-ohm resistor to the other leg, and connect the other side of this resistor to Arduino A0 and GND on the breadboard.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="tableth1a-g1" style="vertical-align: middle;"><p class="tablec"><span epub:type="pagebreak" id="page_166"/><strong>PHOTORESISTOR</strong></p></td>&#13;
<td class="tableth2" style="vertical-align: middle;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Leg 1</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table3a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Leg 2</span></p></td>&#13;
<td class="table3l" style="vertical-align: middle;"><p class="tablec"><span class="green1">A0 via 10k-ohm resistor and GND</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindenta">Connect the red (positive) wire of the piezo buzzer directly to Arduino pin 11 on the Arduino and the black (GND) wire to GND on the breadboard.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="tableth1a-g1" style="vertical-align: middle;"><p class="tablec"><strong>PIEZO</strong></p></td>&#13;
<td class="tableth2" style="vertical-align: middle;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Black wire</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table3a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Red wire</span></p></td>&#13;
<td class="table3l" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 11</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindenta">Insert the green LED’s long leg into Arduino pin 13 and the short leg into GND.</p></li>&#13;
<li><p class="noindenta">Connect the power rails to the breadboard.</p></li>&#13;
<li><p class="noindenta">Before you upload the code, you need to check the photo-resistor’s value in ambient light. Run the following small program with the photoresistor set up as instructed.</p>&#13;
<pre><span class="green2">void</span> <span class="green3">setup</span>() {<br/>  <span class="orange1">pinMode</span>(4, <span class="green2">OUTPUT</span>);<br/>  <span class="orange1">Serial</span>.<span class="orange1">begin</span>(9600);<br/>}<br/><br/><span class="green2">void</span> <span class="green3">loop</span>() {<br/>  <span class="orange1">digitalWrite</span>(4, <span class="green2">HIGH</span>);<br/>  <span class="orange1">Serial</span>.<span class="orange1">println</span>(<span class="orange1">analogRead</span>(0));<br/>}</pre></li>&#13;
<li><p class="noindenta">Open the Serial Monitor in the Arduino IDE. It will show the value being read from the light resistor—in <a href="ch19.xhtml#ch19fig2">Figure 19-2</a>, it’s 964—in normal lighting conditions. Take note of your number, which will be different depending on your lighting conditions.</p>&#13;
<p class="figcaption"><a id="ch19fig2"/><strong>FIGURE 19-2:</strong><br/>Reading values from the photoresistor</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_167"/><img alt="image" src="../images/f19-02.jpg"/></div>&#13;
<p class="indent">Now shine the laser on the resistor’s cell, and also note this number; my reading is 620. This might seem counterintuitive, as you would expect more light to provide a higher number, but the figure is actually translating the resistance—more light, less resistance. Your values will differ from those shown here, so make sure to record your two readings.</p></li>&#13;
<li><p class="noindenta">Check that your setup matches that of <a href="ch19.xhtml#ch19fig3">Figure 19-3</a> and then upload the code in “<a href="ch19.xhtml#ch19lev1sec03">The Sketch</a>” on <a href="ch19.xhtml#page_168">page 168</a>.</p>&#13;
<p class="figcaption"><a id="ch19fig3"/><strong>FIGURE 19-3:</strong><br/>The circuit diagram for the laser trip wire alarm</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_168"/><img alt="image" src="../images/f19-03.jpg"/></div></li>&#13;
</ol>&#13;
<h3 class="h3" id="ch19lev1sec03"><span class="green1"><strong>THE SKETCH</strong></span></h3>&#13;
<p class="noindent">The sketch first sets Arduino pin 11 as an <code>OUTPUT</code> for the piezo buzzer and pin 13 as an <code>OUTPUT</code> for the LED. The photoresistor is connected to Arduino pin A0. If the analog reading from A0 is more than 850 (meaning that there is less light and the laser beam has been broken), the buzzer will be set to <code>HIGH</code> and turn on and the LED will turn off. Remember to change the resistance value depending on your calibration on this line:</p>&#13;
<pre><span class="green3">if</span> (<span class="orange1">analogRead</span>(0) &gt; 850) {</pre>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_169"/>As noted earlier, when the laser is shining on the resistor it reads about 620, so in the sketch I’ve set the buzzer to sound only if the value is more than 850. This value is between our laser value and our nonlaser value, so we know the laser beam to the resistor has been broken if the value reaches 850.</p>&#13;
<pre><span class="green2">int</span> buzzPin = 11; <span class="ash">// Pin connected to the piezo</span><br/><span class="green2">int</span> LED = 13;     <span class="ash">// Pin connected to the LED</span><br/><br/><span class="green2">void</span> <span class="green3">setup</span>() {<br/>  <span class="orange1">pinMode</span>(buzzPin, <span class="green2">OUTPUT</span>); <span class="ash">// Set pin as output</span><br/>  <span class="orange1">pinMode</span>(LED, <span class="green2">OUTPUT</span>);     <span class="ash">// Set pin as output</span><br/>}<br/><br/><span class="green2">void</span> <span class="green3">loop</span>() {<br/>  <span class="green3">if</span> (<span class="orange1">analogRead</span>(0) &gt; 850) { <span class="ash">// Set this value depending on the</span><br/>                             <span class="ash">// values of your photoresistor</span><br/>    <span class="orange1">digitalWrite</span>(buzzPin, <span class="green2">HIGH</span>); <span class="ash">// If value is above 850,</span><br/>                                 <span class="ash">// turn the piezo ON</span><br/>    <span class="orange1">digitalWrite</span>(LED, <span class="green2">LOW</span>);      <span class="ash">// If value is above 850,</span><br/>                                 <span class="ash">// turn the LED OFF</span><br/>    <span class="orange1">delay</span>(1000); <span class="ash">// Wait for 1 second</span><br/>    <span class="orange1">digitalWrite</span>(buzzPin, <span class="green2">LOW</span>);<br/>    <span class="orange1">digitalWrite</span>(LED, <span class="green2">LOW</span>);<br/>  } <span class="green3">else</span> {<br/>    <span class="orange1">digitalWrite</span>(buzzPin, <span class="green2">LOW</span>); <span class="ash">// If value is 850 or below</span><br/>                                <span class="ash">// (light shining on photoresistor),</span><br/>                                <span class="ash">// the piezo is off</span><br/>    <span class="orange1">digitalWrite</span>(LED, <span class="green2">HIGH</span>);    <span class="ash">// If value is 850 or below</span><br/>                                <span class="ash">// (light shining on photoresistor),</span><br/>                                <span class="ash">// the LED is on</span><br/>  }<br/>}</pre>&#13;


<h2 class="h2a" id="ch20"><span epub:type="pagebreak" id="page_170"/>PROJECT 20: SENTRY GUN</h2>&#13;
<p class="h2sub"><strong><span class="green1">A SENTRY GUN IS AN UNMANNED WEAPON CAPABLE OF AUTONOMOUSLY SENSING AND FIRING UPON ENEMY TARGETS USING ULTRASONIC DETECTION. IN THIS PROJECT, WE’LL CREATE A MINIATURE VERSION OF THIS GUN.</span></strong></p>&#13;
<div class="image2"><img alt="image" src="../images/f0170-01.jpg"/></div>&#13;
<div class="image2"><span epub:type="pagebreak" id="page_171"/><img alt="image" src="../images/f0171-01.jpg"/></div>&#13;
<div class="box1">&#13;
<p class="boxtitle1a"><span class="green1"><strong>PARTS REQUIRED</strong></span></p>&#13;
<p class="bull">• Arduino board</p>&#13;
<p class="bull">• Mini breadboard</p>&#13;
<p class="bull">• Jumper wires</p>&#13;
<p class="bull">• Male-to-male jumper wires</p>&#13;
<p class="bull">• Four-pin HC-SR04 ultrasonic sensor</p>&#13;
<p class="bull">• WLToys RC V959 missile launcher</p>&#13;
<p class="bull">• Tower Pro SG90 9g servomotor</p>&#13;
</div>&#13;
<div class="box1">&#13;
<p class="boxtitle1a"><span class="green1"><strong>LIBRARIES REQUIRED</strong></span></p>&#13;
<p class="bull">• Servo</p>&#13;
<p class="bull">• NewPing</p>&#13;
</div>&#13;
<h3 class="h3" id="ch20lev1sec01"><span epub:type="pagebreak" id="page_172"/><span class="green1"><strong>HOW IT WORKS</strong></span></h3>&#13;
<p class="noindent">We’ll attach the toy missile launcher and the ultrasonic sensor to a servo arm (see <a href="ch20.xhtml#ch20fig1">Figure 20-1</a>) so that the servo sweeps the gun and sensor back and forth across 180 degrees, giving the ultrasonic sensor a wide range of detection. When an enemy is detected, the Arduino triggers the sentry gun and discharges the missiles. For more on the ultrasonic sensor, see <a href="ch18.xhtml#ch18">Project 18</a>.</p>&#13;
<p class="figcaption"><a id="ch20fig1"/><strong>FIGURE 20-1:</strong><br/>Attaching the toy gun and ultrasonic sensor to the servo arm gives them a wide range of detection and motion.</p>&#13;
<div class="image"><img alt="image" src="../images/f20-01.jpg"/></div>&#13;
<p class="indent">The key component for this project is the WLToys RC V959 missile launcher, also known as the Walkera Part RC V959-19 missile bullet launcher, intended for radio-controlled helicopters (<a href="ch20.xhtml#ch20fig2">Figure 20-2</a>).</p>&#13;
<p class="figcaption"><a id="ch20fig2"/><strong>FIGURE 20-2:</strong><br/>The Walkera Part RC V959-19 missile bullet launcher</p>&#13;
<div class="image"><img alt="image" src="../images/f20-02.jpg"/></div>&#13;
<p class="indent">This cool part is really cheap (around $6 –10) and is widely available online. Inside this launcher is a mini servo that revolves to set off the missiles. The wires that control this servo are white (GND) <span epub:type="pagebreak" id="page_173"/>and yellow (+5V). You’ll also find black and red wires, which are for a single shot, but we’ll use only yellow and white for a continuous Gatling gun effect.</p>&#13;
<h3 class="h3" id="ch20lev1sec02"><span class="green1"><strong>THE BUILD</strong></span></h3>&#13;
<ol>&#13;
<li><p class="noindenta">First we’ll prepare the toy missile launcher. Carefully remove the four wires from the small plastic socket; they should come out fairly easily. You can use a male-to-male jumper wire to push down on the plastic clip to help.</p></li>&#13;
<li><p class="noindenta">The core of the wire is stranded and quite flimsy, so strip the end of the yellow and white wires and solder them to separate solid-core wires that can be inserted into the Arduino, as shown in <a href="ch20.xhtml#ch20fig3">Figure 20-3</a>. Trim the black and red wires or tape them out of the way.</p>&#13;
<p class="figcaption"><a id="ch20fig3"/><strong>FIGURE 20-3:</strong><br/>Stripping and soldering the missile launcher wires</p>&#13;
<div class="image"><img alt="image" src="../images/f20-03.jpg"/></div></li>&#13;
<li><p class="noindenta">Glue the servo motor’s arm to the base of the missile launcher, as shown in <a href="ch20.xhtml#ch20fig4">Figure 20-4</a>.</p>&#13;
<p class="figcaption"><a id="ch20fig4"/><strong>FIGURE 20-4:</strong><br/>Gluing the servo motor’s arm</p>&#13;
<div class="image"><img alt="image" src="../images/f20-04.jpg"/></div></li>&#13;
<li><p class="noindenta"><span epub:type="pagebreak" id="page_174"/>Attach the ultrasonic sensor to the top of the launcher, as shown in <a href="ch20.xhtml#ch20fig5">Figure 20-5</a>. You can use a hot-glue gun for a solid connection or just tape it for now if you might want to alter it later.</p>&#13;
<p class="figcaption"><a id="ch20fig5"/><strong>FIGURE 20-5:</strong><br/>Attaching the ultrasonic sensor</p>&#13;
<div class="image"><img alt="image" src="../images/f20-05.jpg"/></div></li>&#13;
<li><p class="noindenta">Use the jumper wires to connect the ultrasonic sensor to the Arduino: connect Trig directly to Arduino pin 13, and Echo directly to Arduino pin 12. We will use a mini breadboard to assist with multiple power connections to Arduino +5V and GND.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="tableth1a-g1" style="vertical-align: middle;"><p class="tablec"><strong>ULTRASONIC SENSOR</strong></p></td>&#13;
<td class="tableth2" style="vertical-align: middle;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">VCC</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Trig</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 13</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Echo</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 12</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table3a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">GND</span></p></td>&#13;
<td class="table3l" style="vertical-align: middle;"><p class="tablec"><span class="green1">GND</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindenta"><span epub:type="pagebreak" id="page_175"/>Connect the servomotor’s brown wire to Arduino GND and the red wire to +5V via the mini breadboard, and the yellow/white wire directly to Arduino pin 9.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="tableth1a-g1" style="vertical-align: middle;"><p class="tablec"><strong>SERVO</strong></p></td>&#13;
<td class="tableth2" style="vertical-align: middle;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Brown wire</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Red wire</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table3a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Yellow wire</span></p></td>&#13;
<td class="table3l" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 9</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindenta">Connect the launcher’s white wire to the GND rail of the mini breadboard, and the yellow wire directly to Arduino pin 3.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="tableth1a-g1" style="vertical-align: middle;"><p class="tablec"><strong>LAUNCHER</strong></p></td>&#13;
<td class="tableth2" style="vertical-align: middle;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">White wire</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table3a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Yellow wire</span></p></td>&#13;
<td class="table3l" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 3</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindenta">Your sentry gun should look like <a href="ch20.xhtml#ch20fig6">Figure 20-6</a>. Insert the missiles into the launcher.</p>&#13;
<p class="figcaption"><a id="ch20fig6"/><strong>FIGURE 20-6:</strong><br/>Your sentry gun is ready to fire!</p>&#13;
<div class="image"><img alt="image" src="../images/f20-06.jpg"/></div></li>&#13;
<li><p class="noindenta">Confirm that your completed setup matches that of <a href="ch20.xhtml#ch20fig7">Figure 20-7</a>. Upload the code in “<a href="ch20.xhtml#ch20lev1sec03">The Sketch</a>” on <a href="ch20.xhtml#page_176">page 176</a>.</p>&#13;
<p class="figcaption"><a id="ch20fig7"/><strong>FIGURE 20-7:</strong><br/>The circuit diagram for the sentry gun</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_176"/><img alt="image" src="../images/f20-07.jpg"/></div></li>&#13;
</ol>&#13;
<h3 class="h3" id="ch20lev1sec03"><span class="green1"><strong>THE SKETCH</strong></span></h3>&#13;
<p class="noindent">The sketch first calls the NewPing and Servo libraries to access the functions you’ll need to control the servomotor and ultrasonic sensor, respectively. (Make sure the NewPing library is downloaded from <em><a href="http://nostarch.com/arduinohandbook/">http://nostarch.com/arduinohandbook/</a></em> and saved in your Arduino folder.) The servomotor sweeps back one way and then forth the other, moving the ultrasonic sensor 180 degrees. The sensor sends out an ultrasonic signal, or <em>ping</em>, and when this ping reaches an object, it echoes back to give a time value. The Arduino converts this value into the distance between the sensor and the object. When the distance to the object is fewer than 15 centimeters, the servo stops and power is sent to the launcher to fire the bullets at the object. You can change this trigger distance (given in centimeters) at <span class="ent">➊</span>.</p>&#13;
<pre><span epub:type="pagebreak" id="page_177"/>   #include &lt;NewPing.h&gt; <span class="ash">// Call NewPing library</span><br/>   #include &lt;<span class="orange1">Servo</span>.h&gt;   <span class="ash">// Call Servo library</span><br/>   #define trigPin 12   <span class="ash">// Pin connected to ultrasonic sensor Trig</span><br/>   #define echoPin 13   <span class="ash">// Pin connected the ultrasonic sensor Echo</span><br/>   #define MAX_DISTANCE 500<br/><br/>   NewPing sonar(trigPin, echoPin, MAX_DISTANCE);<br/><br/>   <span class="green2">int</span> blaster = 3; <span class="ash">// Pin connected to the blaster</span><br/><br/>   <span class="green2">int</span> angle = 0; <span class="ash">// Set servo position in degrees</span><br/><br/>   <span class="orange1">Servo</span> servo;<br/><br/>   <span class="green2">void</span> <span class="green3">setup</span>() {<br/>     <span class="orange1">Serial</span>.<span class="orange1">begin</span> (115200);<br/>     <span class="orange1">pinMode</span>(trigPin, <span class="green2">OUTPUT</span>);<br/>     <span class="orange1">pinMode</span>(echoPin, <span class="green2">INPUT</span>);<br/>     <span class="orange1">pinMode</span>(blaster, <span class="green2">OUTPUT</span>);<br/>     servo.<span class="orange1">attach</span>(9); <span class="ash">// Pin connected to servo</span><br/>   }<br/><br/>   <span class="green2">void</span> <span class="green3">loop</span>() {<br/>     <span class="green2">int</span> duration, distance, pos = 0, i;<br/>     <span class="orange1">digitalWrite</span>(trigPin, <span class="green2">LOW</span>);<br/>     <span class="orange1">delayMicroseconds</span>(2);<br/>     <span class="orange1">digitalWrite</span>(trigPin, <span class="green2">HIGH</span>); <span class="ash">// trigPin sends a ping</span><br/>     <span class="orange1">delayMicroseconds</span>(10);<br/>     <span class="orange1">digitalWrite</span>(trigPin, <span class="green2">LOW</span>);<br/>     duration = <span class="orange1">pulseIn</span>(echoPin, <span class="green2">HIGH</span>); <span class="ash">// echoPin receives the ping</span><br/>     distance = (duration / 2) / 29.1;<br/>     <span class="orange1">Serial</span>.<span class="orange1">print</span>(distance);<br/>     <span class="orange1">Serial</span>.<span class="orange1">println</span>(<span class="green2">" cm"</span>);<br/><span class="ent">➊</span>   <span class="green3">if</span> (distance &lt;= 15) { <span class="ash">// If distance is fewer than 15 cm</span><br/>       <span class="orange1">digitalWrite</span>(blaster, <span class="green2">HIGH</span>); <span class="ash">// Blaster will fire</span><br/>       servo.<span class="orange1">write</span>(90);<br/>     }<br/>     <span class="green3">else</span> {<br/>       <span class="orange1">digitalWrite</span>(blaster, <span class="green2">LOW</span>); <span class="ash">// Otherwise, blaster won't activate</span><br/>       <span class="green3">for</span> (angle = 0; angle &lt; 180; angle++) { <span class="ash">// Sweep the servo</span><br/>         servo.<span class="orange1">write</span>(angle);<br/>         <span class="orange1">delay</span>(15);<br/>       }<br/>       <span class="green3">for</span> (angle = 180; angle &gt; 0; angle--) {<br/>         servo.<span class="orange1">write</span>(angle);<br/>       }<br/>       <span class="orange1">delay</span>(450);<br/>     }<br/>   }</pre>&#13;


<h2 class="h2a" id="ch21"><span epub:type="pagebreak" id="page_178"/>PROJECT 21: MOTION SENSOR ALARM</h2>&#13;
<p class="h2sub"><strong><span class="green1">IN THIS PROJECT, WE’LL BUILD A MOTION-SENSING ALARM USING A PASSIVE INFRARED (PIR) SENSOR.</span></strong></p>&#13;
<div class="image2"><img alt="image" src="../images/f0178-01.jpg"/></div>&#13;
<div class="image2"><span epub:type="pagebreak" id="page_179"/><img alt="image" src="../images/f0179-01.jpg"/></div>&#13;
<div class="box1">&#13;
<p class="boxtitle1a"><span class="green1"><strong>PARTS REQUIRED</strong></span></p>&#13;
<p class="bull">• Arduino board</p>&#13;
<p class="bull">• Breadboard</p>&#13;
<p class="bull">• HC SR501 PIR sensor</p>&#13;
<p class="bull">• LED</p>&#13;
<p class="bull">• Piezo buzzer</p>&#13;
</div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_180"/>You can use this alarm to trigger a variety of outputs, such as lights, motors, or even a “welcome home” message when you approach your front door.</p>&#13;
<h3 class="h3" id="ch21lev1sec01"><span class="green1"><strong>HOW IT WORKS</strong></span></h3>&#13;
<p class="noindent">This project is based on the HC SR501 PIR sensor, which is widely available online for a few dollars. We’re going to set it up so that when someone passes in front of the PIR sensor, the LED will light up and the piezo buzzer will sound (see <a href="ch21.xhtml#ch21fig1">Figure 21-1</a>), but you can adapt it for various other output.</p>&#13;
<p class="figcaption"><a id="ch21fig1"/><strong>FIGURE 21-1:</strong><br/>Any piezo buzzer will work for this project, but remember that most have polarity, so the red wire must be connected to +5V and the black wire to GND.</p>&#13;
<div class="image"><img alt="image" src="../images/f21-01.jpg"/></div>&#13;
<p class="indent">Other similar PIR sensors will work with this code, but it’s important to check the pin layout of your sensor on the data sheet, as this can vary. All sensors should have +5V, GND, and output pins. On this model, the pins are not clearly marked, but if you simply remove the outer lens (it’s clipped in place and can be unclipped easily), you can identify the pins underneath, as shown in <a href="ch21.xhtml#ch21fig2">Figure 21-2</a>.</p>&#13;
<p class="figcaption"><a id="ch21fig2"/><strong>FIGURE 21-2:</strong><br/>A PIR sensor with the lens removed</p>&#13;
<div class="image"><img alt="image" src="../images/f21-02.jpg"/></div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_181"/>The two orange potentiometers on the sensor indicate that there are two adjustable settings. With the sensor upright, as shown in <a href="ch21.xhtml#ch21fig3">Figure 21-3</a>, the left potentiometer controls how long the output is set to <code>HIGH</code> when something is detected, and can be set between 5 and 200 seconds. When we attach an LED to the output, the LED will be lit for between 5 and 200 seconds depending on the setting. The right potentiometer adjusts the detection range from 0 to 7 meters.</p>&#13;
<p class="figcaption"><a id="ch21fig3"/><strong>FIGURE 21-3:</strong><br/>PIR sensor potentiometers. The left controls how long the output is set to <code>HIGH</code> (5–200 seconds), while the right controls the range (0–7 meters).</p>&#13;
<div class="image"><img alt="image" src="../images/f21-03.jpg"/></div>&#13;
<p class="indent">The sensor works by detecting infrared radiation, which is emitted from objects that generate heat. Crystalline material within the sensor detects the infrared radiation, and when it detects a set level, it triggers the output signal of the sensor. The Arduino reads this output as voltage, so we can use this as a simple switch to turn something on—in this instance, an LED.</p>&#13;
<p class="indent">We are setting up the sensor so that an alarm sounds when the sensor is triggered, but there are other ways that you can customize the project. For example, you could scare your friends by attaching a servo and setting it up to release a rubber band when they walk by.</p>&#13;
<h3 class="h3" id="ch21lev1sec02"><span class="green1"><strong>THE BUILD</strong></span></h3>&#13;
<ol>&#13;
<li><p class="noindenta">Connect the PIR sensor’s +5V and GND wires to the +5V and GND rails on the breadboard, and connect these rails to the Arduino. Connect the PIR sensor’s output wire to Arduino pin 2. (See <a href="ch21.xhtml#ch21fig4">Figure 21-4</a>.)</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="tableth1a-g1" style="vertical-align: middle;"><p class="tablec"><span epub:type="pagebreak" id="page_182"/><strong>PIR SENSOR</strong></p></td>&#13;
<td class="tableth2" style="vertical-align: middle;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">+5V</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">GND</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table3a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Output</span></p></td>&#13;
<td class="table3l" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 2</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<p class="figcaption"><a id="ch21fig4"/><strong>FIGURE 21-4:</strong><br/>PIR sensor connected to wires</p>&#13;
<div class="image"><img alt="image" src="../images/f21-04.jpg"/></div></li>&#13;
<li><p class="noindenta">Insert an LED into the breadboard and connect the long, positive leg to Arduino pin 13, and the short, negative leg to GND. You don’t need a resistor for the LED in this project.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="tableth1a-g1" style="vertical-align: middle;"><p class="tablec"><strong>LED</strong></p></td>&#13;
<td class="tableth2" style="vertical-align: middle;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Positive leg</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 13</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table3a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Negative leg</span></p></td>&#13;
<td class="table3l" style="vertical-align: middle;"><p class="tablec"><span class="green1">GND</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindenta">Connect the piezo buzzer by attaching the red wire to Arduino pin 10 and the black wire to GND.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="tableth1a-g1" style="vertical-align: middle;"><p class="tablec"><strong>PIEZO</strong></p></td>&#13;
<td class="tableth2" style="vertical-align: middle;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Red wire</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 10</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table3a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Black wire</span></p></td>&#13;
<td class="table3l" style="vertical-align: middle;"><p class="tablec"><span class="green1">GND</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindenta">Confirm that your setup matches the circuit diagram in <a href="ch21.xhtml#ch21fig5">Figure 21-5</a>, and then upload the code in “<a href="ch21.xhtml#ch21lev1sec03">The Sketch</a>” on <a href="ch21.xhtml#page_183">page 183</a>.</p>&#13;
<p class="figcaption"><a id="ch21fig5"/><strong>FIGURE 21-5:</strong><br/>The circuit diagram for the motion sensor alarm</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_183"/><img alt="image" src="../images/f21-05.jpg"/></div></li>&#13;
</ol>&#13;
<h3 class="h3" id="ch21lev1sec03"><span class="green1"><strong>THE SKETCH</strong></span></h3>&#13;
<p class="noindent">The sketch works by setting Arduino pin 13 as output for the LED, pin 2 as input for the PIR sensor, and pin 10 as output for the piezo buzzer. When the PIR sensor is triggered, a <code>HIGH</code> signal is sent to the Arduino, which will in turn light the LED and play a tone on the piezo buzzer.</p>&#13;
<pre><span class="green2">int</span> ledPin = 13;           <span class="ash">// Pin connected to LED</span><br/><span class="green2">int</span> inputPin = 2;          <span class="ash">// Pin connected to PIR sensor</span><br/><span class="green2">int</span> pirState = <span class="green2">LOW</span>;        <span class="ash">// Start PIR state LOW with no motion</span><br/><span epub:type="pagebreak" id="page_184"/><span class="green2">int</span> val = 0;               <span class="ash">// Variable for reading the pin status</span><br/><span class="green2">int</span> pinSpeaker = 10;       <span class="ash">// Pin connected to piezo</span><br/><br/><span class="green2">void</span> <span class="green3">setup</span>() {<br/>  <span class="orange1">pinMode</span>(ledPin, <span class="green2">OUTPUT</span>);  <span class="ash">// Set LED as output</span><br/>  <span class="orange1">pinMode</span>(inputPin, <span class="green2">INPUT</span>); <span class="ash">// Set sensor as input</span><br/>  <span class="orange1">pinMode</span>(pinSpeaker, <span class="green2">OUTPUT</span>);<br/>  <span class="orange1">Serial</span>.<span class="orange1">begin</span>(9600);<br/>}<br/><br/><span class="green2">void</span> <span class="green3">loop</span>() {<br/>  val = <span class="orange1">digitalRead</span>(inputPin);   <span class="ash">// Read PIR input value</span><br/>  <span class="green3">if</span> (val == <span class="green2">HIGH</span>) {             <span class="ash">// Check if input is HIGH</span><br/>    <span class="orange1">digitalWrite</span>(ledPin, <span class="green2">HIGH</span>);  <span class="ash">// If it is, turn ON LED</span><br/>    playTone(300, 160);<br/>    <span class="orange1">delay</span>(150);<br/>    if (pirState == <span class="green2">LOW</span>) {<br/>      <span class="ash">// Print to the Serial Monitor if motion detected</span><br/>      <span class="orange1">Serial</span>.<span class="orange1">println</span>(<span class="green2">"Motion detected!"</span>);<br/><br/>      pirState = <span class="green2">HIGH</span>;<br/>    }<br/>  } <span class="green3">else</span> {<br/>      <span class="orange1">digitalWrite</span>(ledPin, <span class="green2">LOW</span>); <span class="ash">// If input is not HIGH,</span><br/>                                 <span class="ash">// turn OFF LED</span><br/>      playTone(0, 0);<br/>      <span class="orange1">delay</span>(300);<br/>      if (pirState == <span class="green2">HIGH</span>) {<br/>      <span class="orange1">Serial</span>.<span class="orange1">println</span>(<span class="green2">"Motion ended!"</span>);<br/>      pirState = <span class="green2">LOW</span>;<br/>    }<br/>  }<br/>}<br/><br/><span class="green2">void</span> playTone(<span class="green2">long</span> duration, <span class="green2">int</span> freq) { <span class="ash">// Duration in ms,</span><br/>                                         <span class="ash">// frequency in Hz</span><br/>    duration *= 1000;<br/>    <span class="green2">int</span> period = (1.0 / freq) * 1000000;<br/>    <span class="green2">long</span> elapsed_time = 0;<br/>    <span class="green3">while</span> (elapsed_time &lt; duration) {<br/>      <span class="orange1">digitalWrite</span>(pinSpeaker, <span class="green2">HIGH</span>);<br/>      <span class="orange1">delayMicroseconds</span>(period / 2);<br/>      <span class="orange1">digitalWrite</span>(pinSpeaker, <span class="green2">LOW</span>);<br/>      <span class="orange1">delayMicroseconds</span>(period / 2);<br/>      elapsed_time += (period);<br/>    }<br/>}</pre>&#13;


<h2 class="h2a" id="ch22"><span epub:type="pagebreak" id="page_185"/>PROJECT 22: KEYPAD ENTRY SYSTEM</h2>&#13;
<p class="h2sub"><strong><span class="green1">IT’S TIME TO INTRODUCE A KEYPAD TO YOUR ARDUINO BY BUILDING A KEYPAD ENTRY SYSTEM.</span></strong></p>&#13;
<div class="image2"><img alt="image" src="../images/f0185-01.jpg"/></div>&#13;
<div class="image2"><span epub:type="pagebreak" id="page_186"/><img alt="image" src="../images/f0186-01.jpg"/></div>&#13;
<div class="box1">&#13;
<p class="boxtitle1a"><span class="green1"><strong>PARTS REQUIRED</strong></span></p>&#13;
<p class="bull">• Arduino board</p>&#13;
<p class="bull">• Breadboard</p>&#13;
<p class="bull">• Jumper wires</p>&#13;
<p class="bull">• Tower Pro SG90 9g servomotor</p>&#13;
<p class="bull">• Green LED</p>&#13;
<p class="bull">• Red LED</p>&#13;
<p class="bull">• 4×4 membrane keypad</p>&#13;
<p class="bull">• 2 220-ohm resistors</p>&#13;
</div>&#13;
<div class="box1">&#13;
<p class="boxtitle1a"><span class="green1"><strong>LIBRARIES REQUIRED</strong></span></p>&#13;
<p class="bull">• Keypad</p>&#13;
<p class="bull">• Servo</p>&#13;
<p class="bull">• Password</p>&#13;
</div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_187"/>This project uses a 4×4 membrane keypad with a ribbon of eight wires running from the bottom, connected to a servo that sweeps to open a lock.</p>&#13;
<h3 class="h3" id="ch22lev1sec01"><span class="green1"><strong>HOW IT WORKS</strong></span></h3>&#13;
<p class="noindent">A keypad is basically a series of buttons that output a number or character depending on which button is pressed. With the keypad face up, the wires are numbered 1–8 from left to right. The first four wires correspond to the rows, and the latter four to the columns.</p>&#13;
<p class="indent">You’ll need to download the library for the keypad from the <em><a href="http://nostarch.com/arduinohandbook/">http://nostarch.com/arduinohandbook/</a></em> and save it in your IDE’s Arduino libraries folder.</p>&#13;
<p class="indent">We’ll connect this keypad to a servo and some LEDs to create a lock system like the secret knock lock in <a href="ch09.xhtml#ch09">Project 9</a>. To use the lock, enter your code and press the asterisk (*) to confirm. If the code matches the password defined in the sketch, the green LED will flash and the servo will move 90 degrees. If the code is incorrect, the red LED will flash. Use the hash key (#) to reset between code inputs. You could swap this servo for a more substantial one capable of unlocking a heavier deadbolt on a door, or locking and unlocking a box from the inside with the keypad and LEDs mounted externally.</p>&#13;
<h3 class="h3" id="ch22lev1sec02"><span class="green1"><strong>TESTING THE KEYPAD</strong></span></h3>&#13;
<p class="noindent">First we’ll test the keypad with the following code:</p>&#13;
<pre>#include &lt;Keypad.h&gt;<br/><br/><span class="green2">const byte</span> ROWS = 4;<br/><span class="green2">const byte</span> COLS = 4;<br/>char keys[ROWS][COLS] = {<br/>  {<span class="green2">'1'</span>,<span class="green2">'2'</span>,<span class="green2">'3'</span>,<span class="green2">'A'</span>},<br/>  {<span class="green2">'4'</span>,<span class="green2">'5'</span>,<span class="green2">'6'</span>,<span class="green2">'B'</span>},<br/>  {<span class="green2">'7'</span>,<span class="green2">'8'</span>,<span class="green2">'9'</span>,<span class="green2">'C'</span>},<br/>  {<span class="green2">'*'</span>,<span class="green2">'0'</span>,<span class="green2">'#'</span>,<span class="green2">'D'</span>}<br/>};<br/><span class="green2">byte</span> rowPins[ROWS] = {2,3,4,5};<br/><span class="green2">byte</span> colPins[COLS] = {6,7,8,9};<br/><br/>Keypad keypad = Keypad(makeKeymap(keys), rowPins, colPins,<br/>                       ROWS, COLS);<br/><br/><span class="green2">void</span> <span class="green3">setup</span>() {<br/>  <span class="orange1">Serial</span>.<span class="orange1">begin</span>(9600);<br/>}<br/><br/><span epub:type="pagebreak" id="page_188"/><span class="green2">void</span> <span class="green3">loop</span>() {<br/>  <span class="green2">char</span> key = keypad.getKey();<br/>  <span class="green3">if</span> (key != NO_KEY){<br/>    <span class="orange1">Serial</span>.<span class="orange1">println</span>(key);<br/>  }<br/>}</pre>&#13;
<p class="indent">Upload this code and then open the Serial Monitor in your IDE (<a href="ch22.xhtml#ch22fig1">Figure 22-1</a>).</p>&#13;
<p class="figcaption"><a id="ch22fig1"/><strong>FIGURE 22-1:</strong><br/>Testing the keypad</p>&#13;
<div class="image"><img alt="image" src="../images/f22-01.jpg"/></div>&#13;
<p class="indent">With the keypad face up, connect the wires in sequence from left to right to Arduino digital pins 9–2. Once you have uploaded the code, press a few keys. As each key is pressed, the corresponding character should appear on a separate line in the Arduino IDE’s serial console.</p>&#13;
<h3 class="h3" id="ch22lev1sec03"><span epub:type="pagebreak" id="page_189"/><span class="green1"><strong>THE BUILD</strong></span></h3>&#13;
<ol>&#13;
<li><p class="noindenta">Connect the pins of the keypad directly to the Arduino pins as follows. The keypad pins are numbered as shown in <a href="ch22.xhtml#ch22fig2">Figure 22-2</a>.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="tableth1a-g1" style="vertical-align: middle;"><p class="tablec"><strong>KEYPAD</strong></p></td>&#13;
<td class="tableth2" style="vertical-align: middle;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 1</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 9</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 2</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 8</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 3</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 7</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 4</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 6</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 5</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 5</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 6</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 4</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 7</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 3</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table3a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 8</span></p></td>&#13;
<td class="table3l" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 2</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<p class="figcaption"><a id="ch22fig2"/><strong>FIGURE 22-2:</strong><br/>Keypad pins 1–8</p>&#13;
<div class="image"><img alt="image" src="../images/f22-02.jpg"/></div></li>&#13;
<li><p class="noindenta">Place a green LED and a red LED into the breadboard with the shorter, negative legs connected to the Arduino GND rail. Add a 220-ohm resistor to each longer, positive leg. Connect the resistor that’s attached to the green LED to Arduino pin 11, and the resistor that’s attached to the red LED to Arduino pin 12.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="tableth1a-g1" style="vertical-align: middle;"><p class="tablec"><span epub:type="pagebreak" id="page_190"/><strong>LEDS</strong></p></td>&#13;
<td class="tableth2" style="vertical-align: middle;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Positive legs</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pins 11 and 12 via 220-ohm resistors</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table3a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Negative legs</span></p></td>&#13;
<td class="table3l" style="vertical-align: middle;"><p class="tablec"><span class="green1">GND</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindenta">Now attach the servo (see <a href="ch22.xhtml#ch22fig3">Figure 22-3</a>). Connect the brown wire to the GND rail, the red wire to the +5V rail, and the yellow/white wire directly to pin 13 on the Arduino.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="tableth1a-g1" style="vertical-align: middle;"><p class="tablec"><strong>SERVO</strong></p></td>&#13;
<td class="tableth2" style="vertical-align: middle;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Brown wire</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Red wire</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table3a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Yellow wire</span></p></td>&#13;
<td class="table3l" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 13</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<p class="figcaption"><a id="ch22fig3"/><strong>FIGURE 22-3:</strong><br/>Attaching the servo</p>&#13;
<div class="image"><img alt="image" src="../images/f22-03.jpg"/></div></li>&#13;
<li><p class="noindenta">Make sure your setup matches that of <a href="ch22.xhtml#ch22fig4">Figure 22-4</a>, and upload the code in “<a href="ch22.xhtml#ch22lev1sec04">The Sketch</a>” on <a href="ch22.xhtml#page_192">page 192</a>.</p>&#13;
<p class="figcaption"><a id="ch22fig4"/><strong>FIGURE 22-4:</strong><br/>Circuit diagram for the keypad entry system</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_191"/><img alt="image" src="../images/f22-04.jpg"/></div></li>&#13;
</ol>&#13;
<h3 class="h3" id="ch22lev1sec04"><span epub:type="pagebreak" id="page_192"/><span class="green1"><strong>THE SKETCH</strong></span></h3>&#13;
<p class="noindent">First, the sketch calls on the Keypad, Servo, and Password libraries. The Servo library is included in the IDE, but you’ll have to download the Keypad and Password libraries (<em><a href="http://nostarch.com/arduinohandbook/">http://nostarch.com/arduinohandbook/</a></em>). We then set the eight pins that will determine the input from the keypad, and set Arduino pins 11 and 12 to control the LEDs and pin 13 to control the servomotor. The Arduino waits for your code input from the keypad and for you to confirm your input with *. Once you’ve pressed the asterisk key, the sketch will check the entry against the password in the code. If the entry doesn’t match the password, the red LED will be set to <code>HIGH</code> and light; if the entry <em>does</em> match the password, the green LED will be set to <code>HIGH</code> and light, and the servomotor will turn. Pressing # will reset the sketch so it’s ready for another entry.</p>&#13;
<p class="indent">To alter the password, change the number in quotation marks in the following line.</p>&#13;
<pre>Password password = Password(<span class="green2">"2468"</span>);</pre>&#13;
<p class="indent">The default password in the sketch is 2468.</p>&#13;
<pre><span class="ash">/* Keypad Library for Arduino</span><br/>   <span class="ash">Authors: Mark Stanley, Alexander Brevig</span><br/>   <span class="ash">http://playground.arduino.cc/Main/KeypadTutorial</span><br/><span class="ash">*/</span><br/><br/>#include &lt;Password.h&gt;<br/>#include &lt;Keypad.h&gt;<br/>#include &lt;<span class="orange1">Servo</span>.h&gt;<br/><br/><span class="orange1">Servo</span> myservo;<br/>Password password = Password(<span class="green2">"2468"</span>); <span class="ash">// Set password</span><br/><br/>const byte ROWS = 4; <span class="ash">// Set four rows</span><br/>const byte COLS = 4; <span class="ash">// Set four columns</span><br/><br/><span class="green2">char</span> keys[ROWS][COLS] = { <span class="ash">// Define the keymap</span><br/>  {<span class="green2">'1'</span>,<span class="green2">'2'</span>,<span class="green2">'3'</span>,<span class="green2">'A'</span>},<br/>  {<span class="green2">'4'</span>,<span class="green2">'5'</span>,<span class="green2">'6'</span>,<span class="green2">'B'</span>},<br/>  {<span class="green2">'7'</span>,<span class="green2">'8'</span>,<span class="green2">'9'</span>,<span class="green2">'C'</span>},<br/>  {<span class="green2">'*'</span>,<span class="green2">'0'</span>,<span class="green2">'#'</span>,<span class="green2">'D'</span>}<br/>};<br/>byte rowPins[ROWS] = { 9,8,7,6 };  <span class="ash">// Pins connected to keypad</span><br/>                                   <span class="ash">// ROW0, ROW1, ROW2 and ROW3</span><br/>byte colPins[COLS] = { 5,4,3,2, }; <span class="ash">// Pins connected to keypad</span><br/>                                   <span class="ash">// COL0, COL1 and COL2</span><br/><span epub:type="pagebreak" id="page_193"/><span class="ash">// Create the keypad</span><br/>Keypad keypad = Keypad(makeKeymap(keys), rowPins, colPins,<br/>                       ROWS, COLS);<br/><span class="green2">void</span> <span class="green3">setup</span>() {<br/>  <span class="orange1">Serial</span>.<span class="orange1">begin</span>(9600);<br/>  <span class="orange1">delay</span>(200);<br/>  <span class="orange1">pinMode</span>(11, <span class="green2">OUTPUT</span>); <span class="ash">// Set green LED as output</span><br/>  <span class="orange1">pinMode</span>(12, <span class="green2">OUTPUT</span>); <span class="ash">// Set red LED as output</span><br/>  myservo.<span class="orange1">attach</span>(13);  <span class="ash">// Pin connected to servo</span><br/>  keypad.addEventListener(keypadEvent); <span class="ash">// Add an event listener to</span><br/>                                        <span class="ash">// detect keypresses</span><br/>}<br/><br/><span class="green2">void</span> <span class="green3">loop</span>() {<br/>  keypad.getKey();<br/>  myservo.<span class="orange1">write</span>(0);<br/>}<br/><br/><span class="green2">void</span> keypadEvent(KeypadEvent eKey) {<br/>  <span class="green3">switch</span> (keypad.getState()) {<br/>    <span class="green3">case</span> <span class="orange1">PRESSED</span>:<br/>    <span class="orange1">Serial</span>.<span class="orange1">print</span>(<span class="green2">"Pressed: "</span>);<br/>    <span class="orange1">Serial</span>.<span class="orange1">println</span>(eKey);<br/>    <span class="green3">switch</span> (eKey) {<br/>      <span class="green3">case</span> <span class="green2">'*</span>': checkPassword(); <span class="green3">break</span>;<br/>      <span class="green3">case</span> <span class="green2">'#</span>': password.reset(); <span class="green3">break</span>;<br/>      <span class="green3">default</span>: password.append(eKey);<br/>    }<br/>  }<br/>}<br/><br/><span class="green2">void</span> checkPassword() {<br/>  <span class="green3">if</span> (password.evaluate() ){<br/>    <span class="orange1">Serial</span>.<span class="orange1">println</span>(<span class="green2">"Success"</span>); <span class="ash">// If the password is correct...</span><br/>    myservo.<span class="orange1">write</span>(90);         <span class="ash">// Move servo arm 90 degrees</span><br/>    <span class="orange1">digitalWrite</span>(11, <span class="green2">HIGH</span>);    <span class="ash">// Turn on green LED</span><br/>    <span class="orange1">delay</span>(500);                <span class="ash">// Wait 5 seconds</span><br/>    <span class="orange1">digitalWrite</span>(11, <span class="green2">LOW</span>);     <span class="ash">// Turn off green LED</span><br/>  } <span class="green3">else</span> {<br/>    <span class="orange1">Serial</span>.<span class="orange1">println</span>(<span class="green2">"Wrong"</span>);   <span class="ash">// If the password is incorrect...</span><br/>    myservo.<span class="orange1">write</span>(0);<br/>    <span class="orange1">digitalWrite</span>(12, <span class="green2">HIGH</span>);    <span class="ash">// Turn on red LED</span><br/>    <span class="orange1">delay</span>(500);                <span class="ash">// Wait 5 seconds</span><br/>    <span class="orange1">digitalWrite</span>(12, <span class="green2">LOW</span>);     <span class="ash">// Turn off red LED</span><br/><br/>  }<br/>}</pre>&#13;


<h2 class="h2a" id="ch23"><span epub:type="pagebreak" id="page_194"/>PROJECT 23: WIRELESS ID CARD ENTRY SYSTEM</h2>&#13;
<p class="h2sub"><strong><span class="green1">IN THIS PROJECT, WE’LL USE A <span class="underline">RADIO FREQUENCY IDENTIFICATION (RFID)</span> READER TO BUILD A WIRELESS ID CARD ENTRY SYSTEM.</span></strong></p>&#13;
<div class="image2"><img alt="image" src="../images/f0194-01.jpg"/></div>&#13;
<div class="image2"><span epub:type="pagebreak" id="page_195"/><img alt="image" src="../images/f0195-01.jpg"/></div>&#13;
<div class="box1">&#13;
<p class="boxtitle1a"><span class="green1"><strong>PARTS REQUIRED</strong></span></p>&#13;
<p class="bull">• Arduino board</p>&#13;
<p class="bull">• Breadboard</p>&#13;
<p class="bull">• Jumper wires</p>&#13;
<p class="bull">• Mifare RFID-RC522 module</p>&#13;
<p class="bull">• Tower Pro SG90 9g servomotor</p>&#13;
<p class="bull">• Piezo buzzer</p>&#13;
<p class="bull">• Red LED</p>&#13;
<p class="bull">• Green LED</p>&#13;
<p class="bull">• 2 220-ohm resistors</p>&#13;
</div>&#13;
<div class="box1">&#13;
<p class="boxtitle1a"><span class="green1"><strong>LIBRARIES REQUIRED</strong></span></p>&#13;
<p class="bull">• RFID</p>&#13;
<p class="bull">• SPI</p>&#13;
<p class="bull">• Wire</p>&#13;
<p class="bull">• Servo</p>&#13;
<p class="bull">• Pitches</p>&#13;
</div>&#13;
<h3 class="h3" id="ch23lev1sec01"><span epub:type="pagebreak" id="page_196"/><span class="green1"><strong>HOW IT WORKS</strong></span></h3>&#13;
<p class="noindent">An RFID reader uses wireless technology to identify a card, tag, or key fob without contact. The reader will respond when the card is placed near it. First, we need the reader to read the unique number of our RFID card, and then we’ll add a servo that will move depending on whether the RFID reader recognizes the card. We could use this ID system for something like a door or box lock, as with the secret knock code lock in <a href="ch09.xhtml#ch09">Project 9</a>.</p>&#13;
<p class="indent">You may have seen a sticker like the one in <a href="ch23.xhtml#ch23fig1">Figure 23-1</a> on an item you have purchased. These stickers use RFID to allow the store to track items for security purposes. If you pass through the RFID field at the exit without paying, the stickers will set off the alarm. RFID readers and cards are also often used as identification to allow access into restricted areas, like top-secret labs or gated communities.</p>&#13;
<p class="figcaption"><a id="ch23fig1"/><strong>FIGURE 23-1:</strong><br/>An RFID sticker</p>&#13;
<div class="image"><img alt="image" src="../images/f23-01.jpg"/></div>&#13;
<p class="indent">There are two types of RFID: passive and active. Each RFID system uses a radio frequency to exchange a signal between the reader and the tag or card. This signal contains the tag or card’s unique code, and if the RFID reader recognizes that code, it reacts appropriately—for example, by allowing the item to pass through the detectors in a store or by unlocking a door.</p>&#13;
<p class="indent">In a passive system, when the two are passed close to each other, the reader’s radio signal powers the circuit in the tag or card just enough for them to exchange data. Active systems have a powered reader and a powered tag and can read tags accurately from much farther away. Active systems are very expensive and used for more sophisticated applications, so we’ll be using a passive RFID system: the Mifare RFID-RC522 reader, which comes with a blank card and key fob, like those shown in <a href="ch23.xhtml#ch23fig2">Figure 23-2</a>. The reader operates at 13.56 MHz, which means it can identify the card or fob, each of which is powered by the reader, only if it is less than a few inches away. It’s important to keep this in mind when positioning your reader.</p>&#13;
<p class="figcaption"><a id="ch23fig2"/><strong>FIGURE 23-2:</strong><br/>RFID reader with card and key fob</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_197"/><img alt="image" src="../images/f23-02.jpg"/></div>&#13;
<p class="indent">We’ll create an RFID-controlled servo. When you pass your card in front of the RFID reader, it reads the card. If the module recognizes the card and the card has access rights, the green LED lights up, a tune plays, and the servomotor moves 180 degrees. If the module does not recognize the card, the red LED lights up, a different tune plays, and the servo does not move.</p>&#13;
<p class="indent"><a href="ch23.xhtml#ch23tab1">Table 23-1</a> describes the various functions of the RFID reader.</p>&#13;
<p class="tablecap"><a id="ch23tab1"/><strong>TABLE 23-1:</strong><br/>Functions of the RFID reader pins</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="tableth1a-g1" style="vertical-align: middle;"><p class="tablec"><strong>RFID</strong></p></td>&#13;
<td class="tableth1" style="vertical-align: middle;"><p class="tablec"><strong>DETAIL</strong></p></td>&#13;
<td class="tableth1aa-g1" style="vertical-align: middle;"><p class="tablec"><strong>NOTES</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">3.3V</span></p></td>&#13;
<td class="table1" style="vertical-align: middle;"><p class="tablec"><span class="green1">3.3 volts</span></p></td>&#13;
<td class="table1aa-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">The module can use only this amount of voltage.</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">RST</span></p></td>&#13;
<td class="table1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Reset</span></p></td>&#13;
<td class="table1aa-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Will clear the module to initial state.</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">GND</span></p></td>&#13;
<td class="table1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Ground</span></p></td>&#13;
<td class="table1aa-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Connects to the Arduino GND pin.</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">IRQ</span></p></td>&#13;
<td class="table1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Interrupt Request</span></p></td>&#13;
<td class="table1aa-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Not used in this project.</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">MISO</span></p></td>&#13;
<td class="table1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Master In Slave Out</span></p></td>&#13;
<td class="table1aa-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Sometimes referred to as “data in.”</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">MOSI</span></p></td>&#13;
<td class="table1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Master Out Slave In</span></p></td>&#13;
<td class="table1aa-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Sometimes referred to as “data out.”</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">SCK</span></p></td>&#13;
<td class="table1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Serial Clock</span></p></td>&#13;
<td class="table1aa-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Output from master. This creates a pulse that synchronizes data, usually set by the master.</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">SDA/SS</span></p></td>&#13;
<td class="table1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Serial Data/Slave Select</span></p></td>&#13;
<td class="table1aa-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Modules will have either SDA or SS, although they are the same. This is how the Arduino and module share data and communicate.</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table3a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 16</span></p></td>&#13;
<td class="table3" style="vertical-align: middle;"><p class="tablec"><span class="green1">VCC</span></p></td>&#13;
<td class="table3aa-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Positive power.</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<h3 class="h3" id="ch23lev1sec02"><span epub:type="pagebreak" id="page_198"/><span class="green1"><strong>THE BUILD</strong></span></h3>&#13;
<ol>&#13;
<li><p class="noindenta">You may need to set up the module by soldering the header pins to it first. Snap off a strip of eight header pins. Solder one header pin to each point. Make sure to hold the solder iron in place for only a few seconds so you don’t damage the circuits. See the “<a href="ch00.xhtml#ch00lev1sec07">Quick Soldering Guide</a>” on <a href="ch00.xhtml#page_18">page 18</a> for a primer on soldering.</p></li>&#13;
<li><p class="noindenta">Place your RFID module into a breadboard as shown in <a href="ch23.xhtml#ch23fig3">Figure 23-3</a>, and then connect the RFID pins to the Arduino pins as indicated in the following table. Remember to connect the RFID board to 3.3V power on the Arduino (not +5V), or you will damage the module.</p>&#13;
<p class="figcaption"><a id="ch23fig3"/><strong>FIGURE 23-3:</strong><br/>Placing the RFID module into the breadboard</p>&#13;
<div class="image"><img alt="image" src="../images/f23-03.jpg"/></div>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="tableth1a-g1" style="vertical-align: middle;"><p class="tablec"><strong>RFID</strong></p></td>&#13;
<td class="tableth2" style="vertical-align: middle;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">3.3V</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">3.3V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">RST</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 5</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">GND</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">IRQ</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">Not used</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">MISO</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 12</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">MOSI</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 11</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">SCK</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 13</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table3a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">SDA</span></p></td>&#13;
<td class="table3l" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 10</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindenta">Now we need to check that the RFID module is working. Download the RFID library from <em><a href="http://www.nostarch.com/arduinohandbook/">http://www.nostarch.com/arduinohandbook/</a></em> and save it in your <em>libraries</em> directory (see “<a href="ch00.xhtml#ch00lev2sec07">Libraries</a>” on <a href="ch00.xhtml#page_7">page 7</a> for details on downloading libraries). <span epub:type="pagebreak" id="page_199"/>Upload the following test sketch for the RFID reader. Keep the USB cable from your PC connected to the Arduino.</p>&#13;
<pre><span class="ash">// RFID Library Created by Miguel Balboa (circuitito.com)</span><br/>#include &lt;<span class="orange1">SPI</span>.h&gt;<br/>#include &lt;RFID.h&gt;<br/>#define SS_PIN 10<br/>#define RST_PIN 9<br/>RFID rfid(SS_PIN, RST_PIN);<br/><br/><span class="ash">// Setup variables</span><br/><span class="green2">int</span> serNum0;<br/><span class="green2">int</span> serNum1;<br/><span class="green2">int</span> serNum2;<br/><span class="green2">int</span> serNum3;<br/><span class="green2">int</span> serNum4;<br/><br/><span class="green2">void</span> <span class="green3">setup</span>() {<br/>  <span class="orange1">Serial</span>.<span class="orange1">begin</span>(9600);<br/>  <span class="orange1">SPI</span>.<span class="orange1">begin</span>();<br/>  rfid.init();<br/>}<br/><br/><span class="green2">void</span> <span class="green3">loop</span>() { <span class="ash">// This loop looks for a card(s) to read</span><br/>  <span class="green3">if</span> (rfid.isCard()) {<br/>    <span class="green3">if</span> (rfid.readCardSerial()) {<br/>      <span class="green3">if</span> (rfid.serNum[0] != serNum0<br/>          &amp;&amp; rfid.serNum[1] != serNum1<br/>          &amp;&amp; rfid.serNum[2] != serNum2<br/>          &amp;&amp; rfid.serNum[3] != serNum3<br/>          &amp;&amp; rfid.serNum[4] != serNum4<br/>         ) {<br/>        <span class="ash">// When a card is found, the following code will run</span><br/>        <span class="orange1">Serial</span>.<span class="orange1">println</span>(<span class="green2">" "</span>);<br/>        <span class="orange1">Serial</span>.<span class="orange1">println</span>(<span class="green2">"Card found"</span>);<br/>        serNum0 = rfid.serNum[0];<br/>        serNum1 = rfid.serNum[1];<br/>        serNum2 = rfid.serNum[2];<br/>        serNum3 = rfid.serNum[3];<br/>        serNum4 = rfid.serNum[4];<br/><br/>        <span class="ash">// Print the card ID to the Serial Monitor of the IDE</span><br/>        <span class="orange1">Serial</span>.<span class="orange1">println</span>(<span class="green2">"Cardnumber:"</span>);<br/>        <span class="orange1">Serial</span>.<span class="orange1">print</span>(<span class="green2">"Dec: "</span>);<br/>        <span class="orange1">Serial</span>.<span class="orange1">print</span>(rfid.serNum[0], <span class="green2">DEC</span>);<br/>        <span class="orange1">Serial</span>.<span class="orange1">print</span>(<span class="green2">", "</span>);<br/>        <span class="orange1">Serial</span>.<span class="orange1">print</span>(rfid.serNum[1], <span class="green2">DEC</span>);<br/>        <span class="orange1">Serial</span>.<span class="orange1">print</span>(<span class="green2">", "</span>);<br/>        <span class="orange1">Serial</span>.<span class="orange1">print</span>(rfid.serNum[2], <span class="green2">DEC</span>);<br/>        <span class="orange1">Serial</span>.<span class="orange1">print</span>(<span class="green2">", "</span>);<br/>        <span class="orange1">Serial</span>.<span class="orange1">print</span>(rfid.serNum[3], <span class="green2">DEC</span>);<br/>        <span class="orange1">Serial</span>.<span class="orange1">print</span>(<span class="green2">", "</span>);<br/>        <span epub:type="pagebreak" id="page_200"/><span class="orange1">Serial</span>.<span class="orange1">print</span>(rfid.serNum[4], <span class="green2">DEC</span>);<br/>        <span class="orange1">Serial</span>.<span class="orange1">println</span>(<span class="green2">" "</span>);<br/>        <span class="orange1">Serial</span>.<span class="orange1">print</span>(<span class="green2">"Hex: "</span>);<br/>        <span class="orange1">Serial</span>.<span class="orange1">print</span>(rfid.serNum[0], <span class="green2">HEX</span>);<br/>        <span class="orange1">Serial</span>.<span class="orange1">print</span>(<span class="green2">", "</span>);<br/>        <span class="orange1">Serial</span>.<span class="orange1">print</span>(rfid.serNum[1], <span class="green2">HEX</span>);<br/>        <span class="orange1">Serial</span>.<span class="orange1">print</span>(<span class="green2">", "</span>);<br/>        <span class="orange1">Serial</span>.<span class="orange1">print</span>(rfid.serNum[2], <span class="green2">HEX</span>);<br/>        <span class="orange1">Serial</span>.<span class="orange1">print</span>(<span class="green2">", "</span>);<br/>        <span class="orange1">Serial</span>.<span class="orange1">print</span>(rfid.serNum[3], <span class="green2">HEX</span>);<br/>        <span class="orange1">Serial</span>.<span class="orange1">print</span>(<span class="green2">", "</span>);<br/>        <span class="orange1">Serial</span>.<span class="orange1">print</span>(rfid.serNum[4], <span class="green2">HEX</span>);<br/>        <span class="orange1">Serial</span>.<span class="orange1">println</span>(<span class="green2">" "</span>);<br/><br/>      } <span class="green3">else</span> {<br/>        <span class="ash">// If the ID matches, write a dot to the Serial Monitor</span><br/>        <span class="orange1">Serial</span>.<span class="orange1">print</span>(<span class="green2">"."</span>);<br/>      }<br/>    }<br/>  }<br/>  rfid.halt();<br/>}</pre></li>&#13;
<li><p class="noindenta">Open the Arduino Serial Monitor in your IDE.</p></li>&#13;
<li><p class="noindenta">Pass either your card or key fob in front of the RFID module. The unique number should appear on the Serial Monitor, as shown in <a href="ch23.xhtml#ch23fig4">Figure 23-4</a>. Write down this number, because you’ll need it later. In this case, my card number is 4D 55 AD D3 66.</p>&#13;
<p class="figcaption"><a id="ch23fig4"/><strong>FIGURE 23-4:</strong><br/>The RFID number represented in hexadecimal on the screen</p>&#13;
<div class="image"><img alt="image" src="../images/f23-04.jpg"/></div></li>&#13;
<li><p class="noindenta">Insert the two LEDs into the breadboard, with the shorter, negative wires connected to the GND rail. Connect the longer, positive wire on the red LED to Arduino pin 3 via a 220-ohm resistor. Connect the positive leg of the green LED to pin 2 via another 220-ohm resistor.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="tableth1a-g1" style="vertical-align: middle;"><p class="tablec"><span epub:type="pagebreak" id="page_201"/><strong>LEDS</strong></p></td>&#13;
<td class="tableth2" style="vertical-align: middle;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Negative legs</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Positive leg (red)</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 3 via 220-ohm resistor</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table3a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Positive leg (green)</span></p></td>&#13;
<td class="table3l" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 2 via 220-ohm resistor</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindenta">Connect the servo to the Arduino by attaching the red wire to +5V, the brown (or black) wire to GND, and the yellow wire to Arduino pin 9.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="tableth1a-g1" style="vertical-align: middle;"><p class="tablec"><strong>SERVO</strong></p></td>&#13;
<td class="tableth2" style="vertical-align: middle;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Red wire</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Black wire</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table3a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Yellow wire</span></p></td>&#13;
<td class="table3l" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 9</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindenta">Connect the piezo buzzer to the Arduino by attaching the red wire to Arduino pin 8 and the black wire to GND. Your build should now look something like <a href="ch23.xhtml#ch23fig5">Figure 23-5</a>.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="tableth1a-g1" style="vertical-align: middle;"><p class="tablec"><strong>PIEZO</strong></p></td>&#13;
<td class="tableth2" style="vertical-align: middle;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table1a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Red wire</span></p></td>&#13;
<td class="table2" style="vertical-align: middle;"><p class="tablec"><span class="green1">Pin 8</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table3a-g1" style="vertical-align: middle;"><p class="tablec"><span class="green1">Black wire</span></p></td>&#13;
<td class="table3l" style="vertical-align: middle;"><p class="tablec"><span class="green1">GND</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<p class="figcaption"><a id="ch23fig5"/><strong>FIGURE 23-5:</strong><br/>Completed RFID project</p>&#13;
<div class="image"><img alt="image" src="../images/f23-05.jpg"/></div></li>&#13;
<li><p class="noindenta"><span epub:type="pagebreak" id="page_202"/>Open the project code in your Arduino IDE and change the following line to match the hex number you found for your card or key fob in step 5 using the RFID reader. Leave the <code>0x</code> as it appears, but fill in the rest with your number.</p>&#13;
<pre><span class="green2">byte</span> card[5] = {0x<span class="codeitalic">4D</span>,0x<span class="codeitalic">55</span>,0x<span class="codeitalic">AD</span>,0x<span class="codeitalic">D3</span>,0x<span class="codeitalic">66</span>};</pre></li>&#13;
<li><p class="noindenta">Confirm that your setup matches the circuit diagram in <a href="ch23.xhtml#ch23fig6">Figure 23-6</a>, and then upload the code from “<a href="ch23.xhtml#ch23lev1sec03">The Sketch</a>” on <a href="ch23.xhtml#page_203">page 203</a> to your Arduino.</p>&#13;
<p class="figcaption"><a id="ch23fig6"/><strong>FIGURE 23-6:</strong><br/>Circuit diagram for the wireless ID card entry system</p>&#13;
<div class="image"><img alt="image" src="../images/f23-06.jpg"/></div></li>&#13;
</ol>&#13;
<h3 class="h3" id="ch23lev1sec03"><span epub:type="pagebreak" id="page_203"/><span class="green1"><strong>THE SKETCH</strong></span></h3>&#13;
<p class="noindent">The sketch begins by calling on the SPI, RFID, Servo, Pitches, and Wire libraries to control communication between the Arduino, RFID module, and servo. Two melodies are defined, one for a positive reading on your card and the other for a negative reading. The green LED is set to Arduino pin 2, the red LED to pin 3, the piezo buzzer to pin 8, and the servo to pin 9.</p>&#13;
<p class="indent">The following line is where you add your card’s hex value:</p>&#13;
<pre><span class="green2">byte</span> card[5] = {0x<span class="codeitalic">4D</span>,0x<span class="codeitalic">55</span>,0x<span class="codeitalic">AD</span>,0x<span class="codeitalic">D3</span>,0x<span class="codeitalic">66</span>};</pre>&#13;
<p class="indent">Pass your card in front of the reader. If the hex code on the card matches that in your sketch, the green LED lights up, a tune plays, and the servo moves. The reader rejects all other cards unless you add their number to the code at <span class="ent">➊</span>. If a card is rejected, the red LED lights up and a different tune plays, but the servo does not move.</p>&#13;
<pre>   #include &lt;<span class="orange1">SPI</span>.h&gt;<br/>   #include &lt;RFID.h&gt;<br/>   #include &lt;<span class="orange1">Servo</span>.h&gt;<br/>   #include <span class="green2">"pitches.h"</span><br/>   #include &lt;<span class="orange1">Wire</span>.h&gt;<br/><br/>   RFID rfid(10, 5); <span class="ash">// Define the RFID</span><br/><br/>   <span class="ash">// Replace this with the code from your card in hex form</span><br/><span class="ent">➊</span> <span class="green2">byte</span> card[5] = {0x<span class="codeitalic">4D</span>,0x<span class="codeitalic">55</span>,0x<span class="codeitalic">AD</span>,0x<span class="codeitalic">D3</span>,0x<span class="codeitalic">66</span>};<br/>   <span class="ash">// List any other codes for cards with access here</span><br/><br/>   <span class="green2">byte</span> serNum[5];<br/>   <span class="green2">byte</span> data[5];<br/><br/>   <span class="ash">// Define the melodies for successful access and denied access</span><br/>   <span class="green2">int</span> access_melody[] = {NOTE_G4, 0, NOTE_A4, 0, NOTE_B4, 0, NOTE_A4,<br/>   0, NOTE_B4, 0, NOTE_C5, 0};<br/>   <span class="green2">int</span> access_noteDurations[] = {8, 8, 8, 8, 8, 4, 8, 8, 8, 8, 8, 4};<br/>   <span class="green2">int</span> fail_melody[] = {NOTE_G2, 0, NOTE_F2, 0, NOTE_D2, 0};<br/>   <span class="green2">int</span> fail_noteDurations[] = {8, 8, 8, 8, 8, 4};<br/><br/>   <span class="green2">int</span> LED_access = 2;   <span class="ash">// Pin connected to green LED</span><br/>   <span class="green2">int</span> LED_intruder = 3; <span class="ash">// Pin connected to red LED</span><br/>   <span class="green2">int</span> speaker_pin = 8;  <span class="ash">// Pin connected to piezo buzzer</span><br/>   <span class="green2">int</span> servoPin = 9;     <span class="ash">// Pin connected to servo</span><br/><br/>   <span class="orange1">Servo</span> doorLock; <span class="ash">// Define the servomotor</span><br/><br/>   <span class="green2">void</span> <span class="green3">setup</span>() {<br/>     doorLock.<span class="orange1">attach</span>(servoPin); <span class="ash">// Set servo as a pin</span><br/>     <span class="orange1">Serial</span>.<span class="orange1">begin</span>(9600); <span class="ash">// Start serial communication</span><br/>     <span epub:type="pagebreak" id="page_204"/><span class="orange1">SPI</span>.<span class="orange1">begin</span>(); <span class="ash">// Start serial communication between the RFID and PC</span><br/>     rfid.init(); <span class="ash">// Initialize the RFID</span><br/>     <span class="orange1">Serial</span>.<span class="orange1">println</span>(<span class="green2">"Arduino card reader"</span>);<br/>     <span class="orange1">delay</span>(1000);<br/>     <span class="orange1">pinMode</span>(LED_access, <span class="green2">OUTPUT</span>);<br/>     <span class="orange1">pinMode</span>(LED_intruder, <span class="green2">OUTPUT</span>);<br/>     <span class="orange1">pinMode</span>(speaker_pin, <span class="green2">OUTPUT</span>);<br/>     <span class="orange1">pinMode</span>(servoPin, <span class="green2">OUTPUT</span>);<br/>   }<br/><br/>   <span class="green2">void</span> <span class="green3">loop</span>() { <span class="ash">// Create a variable for each user</span><br/>     <span class="green2">boolean</span> card_card = true; <span class="ash">// Define your card</span><br/>     <span class="green3">if</span> (rfid.isCard()) {<br/>       <span class="green3">if</span> (rfid.readCardSerial()) {<br/>         <span class="orange1">delay</span>(1000);<br/>         data[0] = rfid.serNum[0];<br/>         data[1] = rfid.serNum[1];<br/>         data[2] = rfid.serNum[2];<br/>         data[3] = rfid.serNum[3];<br/>         data[4] = rfid.serNum[4];<br/>       }<br/>       <span class="orange1">Serial</span>.<span class="orange1">print</span>(<span class="green2">"Card found - code:"</span>);<br/>       <span class="green3">for</span> (<span class="green2">int</span> i = 0; i &lt; 5; i++) {<br/>         <span class="ash">// If it is not your card, the card is considered false</span><br/>         <span class="green3">if</span> (data[i] != card[i]) card_card = false;<br/>       }<br/>       <span class="orange1">Serial</span>.<span class="orange1">println</span>();<br/>       <span class="green3">if</span> (card_card) { <span class="ash">// A card with access permission is found</span><br/>         <span class="orange1">Serial</span>.<span class="orange1">println</span>(<span class="green2">"Hello!"</span>); <span class="ash">// Print to Serial Monitor</span><br/>         <span class="green3">for</span> (<span class="green2">int</span> i = 0; i &lt; 12; i++) { <span class="ash">// Play welcome music</span><br/>           <span class="green2">int</span> access_noteDuration = 1000 / access_noteDurations[i];<br/>           <span class="orange1">tone</span>(speaker_pin, access_melody[i], access_noteDuration);<br/>           <span class="green2">int</span> access_pauseBetweenNotes = access_noteDuration * 1.30;<br/>           <span class="orange1">delay</span>(access_pauseBetweenNotes);<br/>           <span class="orange1">noTone</span>(speaker_pin);<br/>         }<br/>       }<br/>       <span class="green3">else</span> { <span class="ash">// If the card is not recognized</span><br/>         <span class="ash">// Print message to Serial Monitor</span><br/>         <span class="orange1">Serial</span>.<span class="orange1">println</span>(<span class="green2">"Card not recognized! Contact administrator!"</span>);<br/>         <span class="orange1">digitalWrite</span>(LED_intruder, <span class="green2">HIGH</span>); <span class="ash">// Turn on red LED</span><br/>         <span class="green3">for</span> (<span class="green2">int</span> i = 0; i &lt; 6; i++) { <span class="ash">// Play intruder melody</span><br/>           <span class="green2">int</span> fail_noteDuration = 1000 / fail_noteDurations[i];<br/>           <span class="orange1">tone</span>(speaker_pin, fail_melody[i], fail_noteDuration);<br/>           <span class="green2">int</span> fail_pauseBetweenNotes = fail_noteDuration * 1.30;<br/>           <span class="orange1">delay</span>(fail_pauseBetweenNotes);<br/>           <span class="orange1">noTone</span>(speaker_pin);<br/>         }<br/>         <span class="orange1">delay</span>(1000);<br/>         <span class="orange1">digitalWrite</span>(LED_intruder, <span class="green2">LOW</span>); <span class="ash">// Turn off red LED</span><br/>       }<br/>   <span epub:type="pagebreak" id="page_205"/><br/>       <span class="green3">if</span> (card_card) { <span class="ash">// Add other users with access here</span><br/>         <span class="orange1">Serial</span>.<span class="orange1">println</span>(<span class="green2">"Access granted.......Welcome!"</span>);<br/>         <span class="orange1">digitalWrite</span>(LED_access, <span class="green2">HIGH</span>); <span class="ash">// Turn on green LED</span><br/>         doorLock.<span class="orange1">write</span>(180); <span class="ash">// Turn servo 180 degrees</span><br/>         <span class="orange1">delay</span>(5000); <span class="ash">// Wait for 5 seconds</span><br/>         doorLock.<span class="orange1">write</span>(0); <span class="ash">// Turn servo back to 0 degrees</span><br/>         <span class="orange1">digitalWrite</span>(LED_access, <span class="green2">LOW</span>); <span class="ash">// Turn off green LED</span><br/>       }<br/>       <span class="orange1">Serial</span>.<span class="orange1">println</span>();<br/>       <span class="orange1">delay</span>(500);<br/>       rfid.halt();<br/>     }<br/>   }<span epub:type="pagebreak" id="page_206"/></pre>&#13;
</body></html>