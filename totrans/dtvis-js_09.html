<html><head></head><body><section class="chapter" title="Chapter&#xA0;9.&#xA0;Building Data-Driven Web Applications: Part 1" epub:type="chapter" id="building_data-driven_web_applications_pa"><div class="titlepage"><div><div><h2 class="title">Chapter 9. Building Data-Driven Web Applications: Part 1</h2></div></div></div><p><a id="iddle2141" class="indexterm"/>So far we’ve had a chance to see many of the tools and libraries for creating individual JavaScript visualizations, but we’ve considered them only in the context of a traditional web page. Today, of course, the Web is much more than traditional web pages. Especially on desktop computers, websites are effectively full-featured software applications. (Even on mobile devices many “apps” are really just websites enclosed in a thin wrapper.) When a web application is structured around data, there’s a good chance it can benefit from data visualizations. That’s exactly what we’ll consider in this final project: how to integrate data visualization into a true web application.</p><p>The sections that follow will walk through the development of an example application driven by data. The source of the data will be Nike’s Nike+ (<span class="emphasis"><em><a class="ulink" href="http://nikeplus.com/" target="_top">http://nikeplus.com/</a></em></span>) service for runners. Nike sells many products and applications that let runners track their activities and save the results for analysis and review. In this chapter and the next, we’ll build a web application to retrieve that data from Nike and present it to a user. Nike, of course, has its own web app for viewing Nike+ data, and that app is far superior to the simple example here. We’re certainly not trying to compete with Nike; rather, we’re just using the Nike+ service to structure our example.</p><div class="note" title="Note"><h3 class="title"><a id="ch09note01"/>Note</h3><p><span class="strong"><strong>This sample project is based on the version of the interface at the time of this writing. There may have been changes to the interface since then.</strong></span></p></div><p>Unlike most other chapters, this chapter won’t include multiple independent examples. Instead, it will walk through the main stages in the development and testing of a single data-driven application. We’ll see how to build up the basic structure and functionality of the web application. This includes the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>How to structure a web application using a framework or library</p></li><li class="listitem"><p>How to organize an application into models and views</p></li><li class="listitem"><p>How to incorporate visualizations in views</p></li></ul></div><p>In <a class="xref" href="ch10.html" title="Chapter 10. Building Data-Driven Web Applications: Part 2">Chapter 10</a>, we’ll focus on some of the finer details by dealing with several quirks of the Nike+ interface and adding some finishing touches to round out the single-page application.</p><div class="note" title="Note"><h3 class="title"><a id="ch09note02"/>Note</h3><p><span class="strong"><strong>To use the Nike+ data in an actual product, you must register your application with Nike and get the necessary credentials and security keys. That process also grants you access to the full documentation for the service, which is not publicly available. Since we’re not building a real application in this example, we won’t cover that step. We will, however, base the application on the Nike+ API, which is documented publicly on Nike’s developer website (</strong></span><span class="emphasis"><em><a class="ulink" href="https://developer.nike.com/index.html" target="_top">https://developer.nike.com/index.html</a></em></span><span class="strong"><strong>). Because the example doesn’t include the credentials and security keys, it won’t be able to access the real Nike+ service. The book’s source code, however, does include actual Nike+ data that can be used to emulate the Nike+ service for testing and development.</strong></span></p></div><div class="sect1" title="Frameworks and Libraries"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="frameworks_and_libraries">Frameworks and Libraries</h2></div></div></div><p><a id="iddle1041" class="indexterm"/><a id="iddle1061" class="indexterm"/><a id="iddle1782" class="indexterm"/><a id="iddle2051" class="indexterm"/><a id="iddle2145" class="indexterm"/>If we’re using JavaScript to add data visualizations to traditional web pages, we don’t have to worry too much about organizing and structuring our JavaScript. After all, it’s often a relatively small amount of code, especially compared to the HTML markup and CSS styles that are also part of the page. With web applications, however, the code can grow to be more extensive and more complex. To help keep our code organized and manageable, we’ll take advantage of a JavaScript application library, also called a <span class="emphasis"><em>framework</em></span>.</p><div class="sect2" title="Step 1: Select an Application Library"><div class="titlepage"><div><div><h3 class="title" id="step_1_select_an_application_library">Step 1: Select an Application Library</h3></div></div></div><p>Deciding to use an application library might be easier than deciding which one to use. The number of these libraries has exploded in the past few years; there are now over 30 high-quality libraries from which to choose. A good place to see all the alternatives is TodoMVC (<span class="emphasis"><em><a class="ulink" href="http://todomvc.com/" target="_top">http://todomvc.com/</a></em></span>), which shows how to implement a simple to-do application in each library.</p><p>There is an important question to ask that can help you narrow down the choices: is an application library a <span class="emphasis"><em>pure library</em></span> or an <span class="emphasis"><em>application framework</em></span>? Those terms are often used interchangeably, but there is a significant distinction. A pure library functions like jQuery or other libraries we’ve used throughout this book. It provides a set of tools for our application, and we can use as many—or as few—of those tools as we like. An application framework, on the other hand, dictates exactly how the application should work. The code that we write must follow the strictures and conventions of the framework. Fundamentally, the difference is about control. With a pure library, our code is in control and the library is at our disposal. With a framework, the framework code is in control, and we simply add the code that makes our application unique.</p><p>The main advantage of a pure library is flexibility. Our code is in control of the application, and we have full latitude to structure the application to our own requirements. That’s not always a good thing, however. The constraints of a framework can protect us from making poor design decisions. Some of the world’s best JavaScript developers are responsible for the popular frameworks, and they’ve put a lot of thought into what makes a good web application. There’s another benefit to frameworks: because the framework assumes more responsibility for the application, there’s generally less code we’re required to write.</p><p>It’s worth noting this distinction between frameworks and pure libraries, but almost any web application can be built effectively with either. Both approaches provide the organization and structure necessary for a high-quality application. For our example, we’ll use the Backbone.js (<span class="emphasis"><em><a class="ulink" href="http://backbonejs.org/" target="_top">http://backbonejs.org/</a></em></span>) library. It is by far the most popular of the pure (nonframework) libraries, and it’s used by dozens of the largest sites on the Web. The general approach that we’ll follow, however (including tools such as Yeoman), works well with almost any popular application library.</p></div><div class="sect2" title="Step 2: Install Development Tools"><div class="titlepage"><div><div><h3 class="title" id="step_2_install_development_tools">Step 2: Install Development Tools</h3></div></div></div><p><a id="iddle1705" class="indexterm"/><a id="iddle2136" class="indexterm"/><a id="iddle2138" class="indexterm"/><a id="iddle2183" class="indexterm"/>When you start building your first real web application, deciding how to begin can be a bit intimidating. One tool that can be a big help at this stage is Yeoman (<span class="emphasis"><em><a class="ulink" href="http://yeoman.io/" target="_top">http://yeoman.io/</a></em></span>), which describes itself as “The Web’s Scaffolding Tool for Modern Webapps.” That’s a pretty accurate description. Yeoman can define and initialize a project structure for a large number of different web application frameworks, including Backbone.js. As we’ll see, it also sets up and configures most of the other tools we’ll need during the application’s development.</p><p>Before we can use Yeoman, we must first install Node.js (<span class="emphasis"><em><a class="ulink" href="http://nodejs.org/" target="_top">http://nodejs.org/</a></em></span>). Node.js is a powerful application development platform all by itself, but we won’t need to worry about the details here. It is, however, the application platform required by many modern web development tools like Yeoman. To install Node.js, follow the instructions on its website (<span class="emphasis"><em><a class="ulink" href="http://nodejs.org/" target="_top">http://nodejs.org/</a></em></span>).</p><p>With Node.js installed, we can install the main Yeoman application as well as everything necessary to create a Backbone.js application (<span class="emphasis"><em><a class="ulink" href="https://github.com/yeoman/generator-backbone/" target="_top">https://github.com/yeoman/generator-backbone/</a></em></span>) with one command.</p><a id="pro_id00485"/><pre class="programlisting">$ <span class="steelblue"><span class="strong"><strong>npm</strong></span></span> install -g generator-backbone</pre><p>You can execute this command in the Terminal app (on Mac OS X) or from the Windows command prompt.</p></div><div class="sect2" title="Step 3: Define a New Project"><div class="titlepage"><div><div><h3 class="title" id="step_3_define_a_new_project">Step 3: Define a New Project</h3></div></div></div><p>The development tools we just installed will make it easy to create a new web app project. First, with the following commands, we create a new folder (named <span class="emphasis"><em>running</em></span>) for our application and then <code class="literal">cd</code> (change directory) into that folder.</p><a id="pro_id00486"/><pre class="programlisting">$ <span class="steelblue"><span class="strong"><strong>mkdir</strong></span></span> running
$ <span class="steelblue"><span class="strong"><strong>cd</strong></span></span> running</pre><p>From within that new folder, executing the command <code class="literal">yo backbone</code> will initialize the project structure.</p><a id="pro_id00487"/><pre class="programlisting">$ <span class="steelblue"><span class="strong"><strong>yo</strong></span></span> backbone</pre><p>As part of the initialization, Yeoman will ask for permission to send diagnostic information (mainly which frameworks and features our app uses) back to the Yeoman developers. It will then give us a choice to add a few more tools to the app. For our example, we’ll skip any of the suggested options.</p><a id="pro_id00488"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>Out</strong></span></span> of the box I include HTML5 Boilerplate, jQuery, Backbone.js and Modernizr.
[<span class="steelblue"><span class="strong"><strong>?</strong></span></span>] What more would you like? (Press <span class="steelblue"><span class="strong"><strong>&lt;</strong></span></span>space<span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span> to select)
 &gt;<img src="figs/web/common.png.jpg" alt=""/> <span class="steelblue"><span class="strong"><strong>Bootstrap</strong></span></span> for Sass
  <img src="figs/web/common.png.jpg" alt=""/> <span class="steelblue"><span class="strong"><strong>Use</strong></span></span> CoffeeScript
  <img src="figs/web/common.png.jpg" alt=""/> <span class="steelblue"><span class="strong"><strong>Use</strong></span></span> RequireJs</pre><p><a id="iddle1038" class="indexterm"/><a id="iddle1095" class="indexterm"/><a id="iddle1442" class="indexterm"/><a id="iddle1706" class="indexterm"/><a id="iddle1732" class="indexterm"/><a id="iddle2005" class="indexterm"/>Yeoman will then do its magic, creating several subfolders, installing extra tools and applications, and setting up reasonable defaults. As you watch all the pages and pages of installation information scroll by in your window, you can be glad that Yeoman is doing all this work for you. When Yeoman finishes, you’ll have a project structure like the one shown in <a class="xref" href="ch09.html#yeoman_creates_a_default_project_structu" title="Figure 9-1. Yeoman creates a default project structure for a web application.">Figure 9-1</a>. It may not look exactly like the figure here, since web applications may have changed since this text was written, but rest assured that it will follow the best practices and conventions.</p><div class="figure"><a id="yeoman_creates_a_default_project_structu"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00137"/><img src="figs/web/09fig01.png.jpg" alt="Yeoman creates a default project structure for a web application."/></div></div><div class="figure-title">Figure 9-1. Yeoman creates a default project structure for a web application.</div></div><p>We’ll spend more time with most of these files and folders in the sections that follow, but here’s a quick overview of the project that Yeoman has set up for us.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: none"><p title="app/"><span class="title"><strong><span class="bolditalic">app/</span></strong></span>. The folder that will contain all the code for our app</p></li><li class="listitem" style="list-style-type: none"><p title="bower.json"><span class="title"><strong><span class="bolditalic">bower.json</span></strong></span>. A file that keeps track of all the third-party libraries our app uses</p></li><li class="listitem" style="list-style-type: none"><p title="gruntfile.js"><span class="title"><strong><span class="bolditalic">gruntfile.js</span></strong></span>. A file that controls how to test and build our app</p></li><li class="listitem" style="list-style-type: none"><p title="node_modules/"><span class="title"><strong><span class="bolditalic">node_modules/</span></strong></span>. A folder that contains the tools used to build and test our app</p></li><li class="listitem" style="list-style-type: none"><p title="package.json"><span class="title"><strong><span class="bolditalic">package.json</span></strong></span>. A file that identifies the tools used to build and test our app</p></li><li class="listitem" style="list-style-type: none"><p title="test/"><span class="title"><strong><span class="bolditalic">test/</span></strong></span>. A folder that will contain the code we’ll write to test our app</p></li></ul></div><p>At this point Yeoman has set up a complete web app (albeit one that doesn’t do anything). You can execute the command <code class="literal">grunt serve</code> from the command prompt to see it in a browser.</p><a id="pro_id00489"/><pre class="programlisting">$ <span class="steelblue"><span class="strong"><strong>grunt</strong></span></span> serve
<span class="steelblue"><span class="strong"><strong>Running</strong></span></span> <span class="maroon">"serve"</span> task

<span class="steelblue"><span class="strong"><strong>Running</strong></span></span> <span class="maroon">"clean:server"</span> (clean) <span class="steelblue"><span class="strong"><strong>task</strong></span></span>

<span class="steelblue"><span class="strong"><strong>Running</strong></span></span> <span class="maroon">"createDefaultTemplate"</span> task

<span class="steelblue"><span class="strong"><strong>Running</strong></span></span> <span class="maroon">"jst:compile"</span> (jst) <span class="steelblue"><span class="strong"><strong>task</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&gt;&gt;</strong></span></span> <span class="steelblue"><span class="strong"><strong>Destination</strong></span></span> not written because compiled files were empty.

<span class="steelblue"><span class="strong"><strong>Running</strong></span></span> <span class="maroon">"connect:livereload"</span> (connect) <span class="steelblue"><span class="strong"><strong>task</strong></span></span>
<span class="steelblue"><span class="strong"><strong>Started</strong></span></span> connect web server on http://localhost:9000

<span class="steelblue"><span class="strong"><strong>Running</strong></span></span> <span class="maroon">"open:server"</span> (open) <span class="steelblue"><span class="strong"><strong>task</strong></span></span>

<span class="steelblue"><span class="strong"><strong>Running</strong></span></span> <span class="maroon">"watch:livereload"</span> (watch) <span class="steelblue"><span class="strong"><strong>task</strong></span></span>
<span class="steelblue"><span class="strong"><strong>Waiting...</strong></span></span></pre><p><a id="iddle1441" class="indexterm"/>The <code class="literal">grunt</code> command runs one of the tools that’s part of the Yeoman package. When passed the <code class="literal">serve</code> option, it cleans up the application folder, starts a web server to host the application, launches a web browser, and navigates to the skeleton app. You’ll see something like <a class="xref" href="ch09.html#default_yeoman_web_application_runs_in_t" title="Figure 9-2. The default Yeoman web application runs in the browser.">Figure 9-2</a> in your browser.</p><div class="figure"><a id="default_yeoman_web_application_runs_in_t"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00138"/><img src="figs/web/09fig02.png.jpg" alt="The default Yeoman web application runs in the browser."/></div></div><div class="figure-title">Figure 9-2. The default Yeoman web application runs in the browser.</div></div><p>Congratulations! Our web app, as basic as it is, is now running.</p></div><div class="sect2" title="Step 4: Add Our Unique Dependencies"><div class="titlepage"><div><div><h3 class="title" id="step_4_add_our_unique_dependencies">Step 4: Add Our Unique Dependencies</h3></div></div></div><p><a id="iddle1094" class="indexterm"/><a id="iddle1244" class="indexterm"/><a id="iddle1355" class="indexterm"/><a id="iddle1547" class="indexterm"/><a id="iddle1684" class="indexterm"/><a id="iddle1833" class="indexterm"/><a id="iddle2105" class="indexterm"/><a id="iddle2129" class="indexterm"/>Yeoman sets up sensible defaults and tools for a new app, but our app needs a few JavaScript libraries that aren’t part of those defaults, such as Leaflet for maps and Flot for charts. The Moment.js (<span class="emphasis"><em><a class="ulink" href="http://momentjs.com/" target="_top">http://momentjs.com/</a></em></span>) library for dealing with dates and times will also come in handy, as will the Underscore.string (<span class="emphasis"><em><a class="ulink" href="http://epeli.github.io/underscore.string/" target="_top">http://epeli.github.io/underscore.string/</a></em></span>) library. We can add these libraries to our project with some simple commands. The <code class="literal">--save</code> option tells the bower tool (which is part of the Yeoman package) to remember that our project depends on these libraries.</p><a id="pro_id00490"/><pre class="programlisting">$ <span class="steelblue"><span class="strong"><strong>bower</strong></span></span> install leaflet --save
$ <span class="steelblue"><span class="strong"><strong>bower</strong></span></span> install flot --save
$ <span class="steelblue"><span class="strong"><strong>bower</strong></span></span> install momentjs --save
$ <span class="steelblue"><span class="strong"><strong>bower</strong></span></span> install underscore.string --save</pre><p>Perhaps you’ve already begun to appreciate how tools like Yeoman make development easier. The simple commands shown here save us from having to find the libraries on the Web, download the appropriate files, copy them to the right place in our project, and so on.</p><p>Even more importantly, Yeoman (technically, the bower tool) automatically takes care of any additional libraries on which these libraries depend. The Flot library, for example, requires jQuery. When Yeoman installs Flot, it will also check and make sure that jQuery is installed in the project. In our case, it is because Backbone.js depends on it, but if jQuery weren’t already installed, Yeoman would automatically find it and install it as well.</p><p>For most libraries, bower can completely install all the necessary components and files. In the case of Leaflet, however, we need to perform a few extra steps. Change directory to the <span class="emphasis"><em>leaflet</em></span> folder within <span class="emphasis"><em>app/bower_components</em></span>. From there, run two commands to install the unique tools that Leaflet requires:</p><a id="pro_id00491"/><pre class="programlisting">$ <span class="steelblue"><span class="strong"><strong>npm</strong></span></span> install
$ <span class="steelblue"><span class="strong"><strong>npm</strong></span></span> install jake -g</pre><p>Executing the command <code class="literal">jake</code> will then run all of Leaflet’s tests and, provided they pass, create a Leaflet.js library for our app.</p><a id="pro_id00492"/><pre class="programlisting">$ <span class="steelblue"><span class="strong"><strong>jake</strong></span></span>
<span class="steelblue"><span class="strong"><strong>Checking</strong></span></span> for JS errors...
    <span class="steelblue"><span class="strong"><strong>Check</strong></span></span> passed.

<span class="steelblue"><span class="strong"><strong>Checking</strong></span></span> for specs JS errors...
    <span class="steelblue"><span class="strong"><strong>Check</strong></span></span> passed.

<span class="steelblue"><span class="strong"><strong>Running</strong></span></span> tests...

<span class="steelblue"><span class="strong"><strong>...............................................................................</strong></span></span>
<span class="steelblue"><span class="strong"><strong>...............................................................................</strong></span></span>
<span class="steelblue"><span class="strong"><strong>...............................................................................</strong></span></span>
<span class="steelblue"><span class="strong"><strong>........................................</strong></span></span>
<span class="steelblue"><span class="strong"><strong>PhantomJS</strong></span></span> 1.9.7 (Mac OS X)<span class="steelblue"><span class="strong"><strong>:</strong></span></span> Executed 280 of 280 SUCCESS (0.881 secs / 0.496 secs)
    <span class="steelblue"><span class="strong"><strong>Tests</strong></span></span> ran successfully.


<span class="steelblue"><span class="strong"><strong>Concatenating</strong></span></span> and compressing 75 files...
    <span class="steelblue"><span class="strong"><strong>Uncompressed</strong></span></span>: 217.22 KB (unchanged)
    <span class="steelblue"><span class="strong"><strong>Compressed</strong></span></span>: 122.27 KB (unchanged)
    <span class="steelblue"><span class="strong"><strong>Gzipped</strong></span></span>: 32.71 KB</pre><p>All that’s left to do is add the other libraries into our HTML files. That’s easy enough. The main page for our app is <span class="emphasis"><em>index.html</em></span> in the <span class="emphasis"><em>app</em></span> folder. There’s already a block of code that includes jQuery, Underscore.js, and Backbone.js:</p><a id="pro_id00493"/><pre class="programlisting"><span class="indianred"><span class="emphasis"><em>&lt;!-- build:js scripts/vendor.js --&gt;</em></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"bower_components/jquery/dist/jquery.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"bower_components/underscore/underscore.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"bower_components/backbone/backbone.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
<span class="indianred"><span class="emphasis"><em>&lt;!-- endbuild --&gt;</em></span></span></pre><p>We can add our new libraries after Backbone.js.</p><a id="pro_id00494"/><pre class="programlisting"><span class="indianred"><span class="emphasis"><em>&lt;!-- build:js scripts/vendor.js --&gt;</em></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"bower_components/jquery/dist/jquery.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"bower_components/underscore/underscore.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"bower_components/backbone/backbone.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"bower_components/flot/jquery.flot.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"bower_components/leaflet/dist/leaflet-src.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span> <span class="steelblue">src=</span><span class="maroon">"bower_components/momentjs/moment.js"</span><span class="steelblue"><span class="strong"><strong>&gt;&lt;/script&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;script</strong></span></span>
    <span class="steelblue">src=</span><span class="maroon">"bower_components/underscore.string/lib/underscore.string.js"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/script&gt;</strong></span></span>
<span class="indianred"><span class="emphasis"><em>&lt;!-- endbuild --&gt;</em></span></span></pre><p>Leaflet, as we saw in <a class="xref" href="ch06.html" title="Chapter 6. Visualizing Geographic Data">Chapter 6</a>, also requires its own style sheet. We add that to the top of <span class="emphasis"><em>index.html</em></span> just before <span class="emphasis"><em>main.css</em></span>.</p><a id="pro_id00495"/><pre class="programlisting"><span class="indianred"><span class="emphasis"><em>&lt;!-- build:css(.tmp) styles/main.css --&gt;</em></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;link</strong></span></span> <span class="steelblue">rel=</span><span class="maroon">"stylesheet"</span> <span class="steelblue">href=</span><span class="maroon">"bower_components/leaflet/dist/leaflet.css"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;link</strong></span></span> <span class="steelblue">rel=</span><span class="maroon">"stylesheet"</span> <span class="steelblue">href=</span><span class="maroon">"styles/main.css"</span><span class="steelblue"><span class="strong"><strong>&gt;</strong></span></span>
<span class="indianred"><span class="emphasis"><em>&lt;!-- endbuild --&gt;</em></span></span></pre><p>Now that we’ve set up the structure of our app and installed the necessary libraries, it’s time to start development.</p></div></div><div class="sect1" title="Models and Views"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="models_and_views">Models and Views</h2></div></div></div><p>There are many application libraries available for web apps, and each has its quirks, but most of the libraries agree on the key principles that should guide an app’s architecture. Perhaps the most fundamental of those principles is separating <span class="emphasis"><em>models</em></span> <a id="iddle1830" class="indexterm"/><a id="iddle1831" class="indexterm"/><a id="iddle2139" class="indexterm"/><a id="iddle2187" class="indexterm"/>from <span class="emphasis"><em>views.</em></span> The code that keeps track of the core data for the app (the models) should be separate from the code that presents that data to the user (the views). Enforcing this separation makes it easier to update and modify either. If you want to present your data in a table instead of a chart, you can do that without any changes to the models. And if you need to change your data source from a local file to a REST API, you can do that without any changes to the views. We’ve been employing this principle in an informal way throughout the book. In all of the examples, we’ve isolated the steps required to obtain and format our data from the steps we used to visualize it. Using an application library like Backbone.js gives us the tools to manage models and views more explicitly.</p><div class="sect2" title="Step 1: Define the Application’s Models"><div class="titlepage"><div><div><h3 class="title" id="step_1_define_the_applicationapostrophes">Step 1: Define the Application’s Models</h3></div></div></div><p>Our running app is designed to work with Nike+, which provides details about runs—training runs, interval workouts, trail runs, races, and so on. The data set we want consists of nothing but runs, so our app’s core model is, naturally, a run.</p><p>The Yeoman tool makes it very easy to define a model for our app. A simple command defines a new model and creates the JavaScript files and scaffolding for that model.</p><a id="pro_id00496"/><pre class="programlisting">$ <span class="steelblue"><span class="strong"><strong>yo</strong></span></span> backbone:model run
   <span class="steelblue"><span class="strong"><strong>create</strong></span></span> app/scripts/models/run.js
   <span class="steelblue"><span class="strong"><strong>invoke</strong></span></span>   backbone-mocha:model
   <span class="steelblue"><span class="strong"><strong>create</strong></span></span>     test/models/run.spec.js</pre><p>That command creates two new files: <span class="emphasis"><em>run.js</em></span> in the <span class="emphasis"><em>app/scripts/models/</em></span> folder and <span class="emphasis"><em>run.spec.js</em></span> in the <span class="emphasis"><em>test/</em></span> folder. Let’s take a look at the file Yeoman created for our model. It’s quite short.</p><a id="pro_id00497"/><pre class="programlisting">➊ <span class="indianred"><span class="emphasis"><em>/*Global Running, Backbone*/</em></span></span>

➋ <span class="steelblue">Running</span>.<span class="olive">Models</span> = <span class="steelblue">Running</span>.<span class="olive">Models ||</span> {};

   (<span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
       <span class="maroon">"use strict"</span>;
       <span class="steelblue">Running</span>.<span class="steelblue">Models</span>.<span class="olive">Run</span> = <span class="steelblue">Backbone</span>.<span class="steelblue">Model</span>.<span class="olive">extend</span>({
           <span class="dodgerblue">url</span>: <span class="maroon">""</span>,
           <span class="dodgerblue">initialize</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {
           },
           <span class="dodgerblue">defaults</span>: {
           },
           <span class="dodgerblue">validate</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(attrs, options) {
           },
           <span class="dodgerblue">parse</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(response, options) {
               <span class="steelblue"><span class="strong"><strong>return</strong></span></span> response;
           }
       });
   })();</pre><p><a id="iddle1682" class="indexterm"/><a id="iddle2140" class="indexterm"/><a id="iddle2188" class="indexterm"/>At ➊ is a comment that lists the global variables our model requires. In this case there are only two: <code class="literal">Running</code> (that’s our app) and <code class="literal">Backbone</code>. Next, at ➋, this file creates a <code class="literal">.Models</code> property of the <code class="literal">Running</code> object unless that property already exists.</p><p>When the browser encounters this line, it will check to see if <code class="literal">Running.Models</code> exists. If it does, then <code class="literal">Running.Models</code> won’t be <code class="literal">false</code>, and the browser never has to consider the second clause of the logical <span class="emphasis"><em>or</em></span> (<code class="literal">||</code>). The statement simply assigns <code class="literal">Running.Models</code> to itself, so it has no practical effect. If <code class="literal">Running.Models</code> does not exist, however, then it evaluates to <code class="literal">false</code>, and the browser will continue to the second clause, where it assigns an empty object (<code class="literal">{}</code>) to <code class="literal">Running.Models</code>. Ultimately, this statement makes sure that the object <code class="literal">Running.Models</code> exists.</p><p>The rest of the code in the file is enclosed within an <span class="emphasis"><em>immediately invoked function expression.</em></span> If you haven’t seen this pattern before, it may look a little strange.</p><a id="pro_id00498"/><pre class="programlisting">(<span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
    <span class="indianred"><span class="emphasis"><em>/* Code goes here */</em></span></span>
})();</pre><p>If we rewrite the block as a single line, though, it might be easier to understand.</p><a id="pro_id00499"/><pre class="programlisting">( <span class="steelblue"><span class="strong"><strong>function</strong></span></span> () { <span class="indianred"><span class="emphasis"><em>/* Code goes here */</em></span></span> } ) ();</pre><p>The statement defines a JavaScript function with a function expression, <code class="literal">function () { /* ... */ }</code>, and then, with the concluding <code class="literal">()</code>, it calls (technically <span class="emphasis"><em>invokes</em></span>) that newly created function. All we’re really doing, therefore, is putting our code inside a function and calling that function. You’ll see this pattern a lot in professional JavaScript because it protects a block of code from interfering with other code blocks in the application.</p><p>When you define a variable in JavaScript, it is a <span class="emphasis"><em>global</em></span> variable, available everywhere in the code. As a consequence, if two different sections of code try to define the same global variable, those definitions will clash. This interaction can cause bugs that are very hard to find, as code in one section inadvertently interferes with code in a completely different section. To prevent this problem, we can avoid using global variables, and the easiest way to do that in JavaScript is to define our variables inside a function. That’s the purpose of an immediately invoked function expression. It makes sure that any variables our code defines are <span class="emphasis"><em>local</em></span> to the function rather than global, and it prevents our code blocks from interfering with one another.</p></div><div class="sect2" title="Step 2: Implement the Model"><div class="titlepage"><div><div><h3 class="title" id="step_2_implement_the_model">Step 2: Implement the Model</h3></div></div></div><p>Our application really only needs this one model, and it’s already complete! That’s right: the scaffolding that Yeoman has set up for us is a complete and functioning model for a run. In fact, if it weren’t for some quirks in Nike’s REST API, we wouldn’t have to touch the model code at all. We’ll address those quirks in <a class="xref" href="ch10.html" title="Chapter 10. Building Data-Driven Web Applications: Part 2">Chapter 10</a>.</p><p>Before we move on to the next step, though, let’s look at what we can do with our newly created model. To do that we’ll make a temporary addition to the model code. We won’t use the following code in the final app; it’s only meant to show off what our model can already do.</p><p>First, let’s add the URL to retrieve details about a run (Nike+ uses the more general term <span class="emphasis"><em>activity</em></span>). From the Nike+ documentation, we find that this URL is <span class="emphasis"><em><a class="ulink" href="https://api.nike.com/v1/me/sport/activities/&lt;activityId&gt;" target="_top">https://api.nike.com/v1/me/sport/activities/&lt;activityId&gt;</a></em></span>.</p><a id="pro_id00500"/><pre class="programlisting">   <span class="steelblue">Running</span>.<span class="steelblue">Models</span>.<span class="olive">Run</span> = <span class="steelblue">Backbone</span>.<span class="steelblue">Model</span>.<span class="olive">extend</span>({
➊     <span class="dodgerblue">url</span>: <span class="maroon">"https://api.nike.com/v1/me/sport/activities/"</span>,
       <span class="dodgerblue">initialize</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {
       },
       <span class="dodgerblue">defaults</span>: {
       },
       <span class="dodgerblue">validate</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(attrs, options) {
       },
       <span class="dodgerblue">parse</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(response, options) {
           <span class="steelblue"><span class="strong"><strong>return</strong></span></span> response;
       }
   });</pre><p>The final part of the URL depends on the specific activity, so here we add only the general part of the URL to our model (➊).</p><p>Now imagine that we want to get the details for a specific run from the Nike+ service. The run in question has a unique identifier of <code class="literal">2126456911</code>. If the Nike+ API followed typical conventions, we could create a variable representing that run, <span class="emphasis"><em>and get all its data</em></span>, with the hypothetical two statements that follow. (We’ll consider the quirks of the actual Nike+ interface in Step 7 of <a class="xref" href="ch10.html#connecting_with_the_nikeplus_service" title="Connecting with the Nike+ Service">Connecting with the Nike+ Service</a>.)</p><a id="pro_id00501"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> run = <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">Running</span>.<span class="steelblue">Models</span>.<span class="olive">Run</span>({<span class="dodgerblue">id</span>: <span class="red">2126456911</span>});
<span class="steelblue">run</span>.<span class="olive">fetch</span>();</pre><p>Since many APIs <span class="emphasis"><em>do</em></span> follow typical conventions, it’s worth spending some time understanding how that code works. The first statement creates a new instance of the Run model and specifies its identifier. The second statement tells Backbone to retrieve the model’s data from the server. Backbone will take care of all the communication with Nike+, including error handling, time-outs, parsing the response, and so on. Once the fetch completes, detailed information from that run will be available from the model. If we provide a callback function, we could output some of the details. Here’s an example:</p><a id="pro_id00502"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> run = <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">Running</span>.<span class="steelblue">Models</span>.<span class="olive">Run</span>({<span class="dodgerblue">id</span>: <span class="red">2126456911</span>});
<span class="steelblue">run</span>.<span class="olive">fetch</span>({<span class="dodgerblue">success</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span>() {
    <span class="steelblue">console</span>.<span class="olive">log</span>(<span class="maroon">"Run started at "</span>, <span class="steelblue">run</span>.<span class="olive">get</span>(<span class="maroon">"startTime"</span>));
    <span class="steelblue">console</span>.<span class="olive">log</span>(<span class="maroon">"    Duration: "</span>,  <span class="steelblue">run</span>.<span class="olive">get</span>(<span class="maroon">"metricSummary"</span>).<span class="olive">duration</span>);
    <span class="steelblue">console</span>.<span class="olive">log</span>(<span class="maroon">"    Distance: "</span>,  <span class="steelblue">run</span>.<span class="olive">get</span>(<span class="maroon">"metricSummary"</span>).<span class="olive">distance</span>);
    <span class="steelblue">console</span>.<span class="olive">log</span>(<span class="maroon">"    Calories: "</span>,  <span class="steelblue">run</span>.<span class="olive">get</span>(<span class="maroon">"metricSummary"</span>).<span class="olive">calories</span>);
}});</pre><p><a id="iddle2131" class="indexterm"/><a id="iddle2184" class="indexterm"/>The output in the browser’s console would be the following:</p><a id="pro_id00503"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>Run</strong></span></span> started at 2013-04-09T10:54:33Z
    <span class="steelblue"><span class="strong"><strong>Duration</strong></span></span>: 0:22:39.000
    <span class="steelblue"><span class="strong"><strong>Distance</strong></span></span>: 3.7524
    <span class="steelblue"><span class="strong"><strong>Calories</strong></span></span>: 240</pre><p>Not bad for a few simple lines of code! The code in this step, though, is really just a detour. Our application won’t use individual models in this way. Instead, we’ll use an even more powerful Backbone.js feature: collections.</p></div><div class="sect2" title="Step 3: Define the Application’s Collections"><div class="titlepage"><div><div><h3 class="title" id="step_3_define_the_applicationapostrophes">Step 3: Define the Application’s Collections</h3></div></div></div><p>The model we created is designed to capture the data for a single run. Our users, however, aren’t interested in just a single run. They’d like to see all of their runs—dozens, hundreds, possibly thousands of them. We can handle all of these runs with a <span class="emphasis"><em>collection</em></span>, or group of models. The collection is one of the core concepts of Backbone.js, and it will be a big help for our app. Let’s define a collection for all of the user’s runs.</p><p>Yeoman makes it easy to define and set up scaffolding for our collection. We execute the single command <code class="literal">yo backbone:collection runs</code> from the command line. (Yes, we’re being very original and calling our collection of runs, well, <span class="emphasis"><em>runs</em></span>.)</p><a id="pro_id00504"/><pre class="programlisting">$ <span class="steelblue"><span class="strong"><strong>yo</strong></span></span> backbone:collection runs
   <span class="steelblue"><span class="strong"><strong>create</strong></span></span> app/scripts/collections/runs.js
   <span class="steelblue"><span class="strong"><strong>invoke</strong></span></span>   backbone-mocha:collection
   <span class="steelblue"><span class="strong"><strong>create</strong></span></span>     test/collections/runs.spec.js</pre><p>Yeoman does the same thing for collections as it did for models: it creates an implementation file (<span class="emphasis"><em>runs.js</em></span> in the <span class="emphasis"><em>app/scripts/collections/</em></span> folder) and a test file. For now, let’s take a look at <span class="emphasis"><em>runs.js</em></span>.</p><a id="pro_id00505"/><pre class="programlisting"><span class="indianred"><span class="emphasis"><em>/*Global Running, Backbone*/</em></span></span>

<span class="steelblue">Running</span>.<span class="olive">Collections</span> = <span class="steelblue">Running</span>.<span class="olive">Collections</span> || {};

(<span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
    <span class="maroon">"use strict"</span>;
    <span class="steelblue">Running</span>.<span class="steelblue">Collections</span>.<span class="olive">Runs</span> = <span class="steelblue">Backbone</span>.<span class="steelblue">Collection</span>.<span class="olive">extend</span>({
        <span class="dodgerblue">model</span>: <span class="steelblue">Running</span>.<span class="steelblue">Models</span>.<span class="olive">Runs</span>
    });
})();</pre><p>This file is even simpler than our model; the default collection has only a single property to indicate what type of model the collection contains. Unfortunately, Yeoman isn’t smart enough to handle plurals, so it assumes the name of the model is the same as the name of the collection. That’s not true for our app, as our model is Run (singular) and the collection is Runs (plural). While we’re removing <a id="iddle1074" class="indexterm"/><a id="iddle2151" class="indexterm"/><a id="iddle2185" class="indexterm"/>that <span class="emphasis"><em>s</em></span>, we can also add a property to specify the REST API for the collection. That’s a URL from the Nike+ service.</p><a id="pro_id00506"/><pre class="programlisting"><span class="steelblue">Running</span>.<span class="steelblue">Collections</span>.<span class="olive">Runs</span> = <span class="steelblue">Backbone</span>.<span class="steelblue">Collection</span>.<span class="olive">extend</span>({
    <span class="dodgerblue">url</span>: <span class="maroon">"https://api.nike.com/v1/me/sport/activities/"</span>,
    <span class="dodgerblue">model</span>: <span class="steelblue">Running</span>.<span class="steelblue">Models</span>.<span class="olive">Run</span>
});</pre><p>With those two small changes, we’re ready to take advantage of our new collection (aside from handling a few quirks with the Nike+ API; we’ll ignore that complication for now and address it later). All we need to do is create a new instance of the Runs collection and then fetch its data.</p><a id="pro_id00507"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> runs = <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">Running</span>.<span class="steelblue">Collections</span>.<span class="olive">Runs</span>();
<span class="steelblue">runs</span>.<span class="olive">fetch</span>();</pre><p>That’s all it takes to build a collection containing the user’s runs. Backbone.js creates a model for each and retrieves the model’s data from the server. Even better, those run models are stored in a true Underscore.js collection, which gives us access to many powerful methods to manipulate and search through the collection. Suppose, for example, we want to find the total distance for all of a user’s runs. That’s tailor-made for the Underscore.js <code class="literal">reduce()</code> function.</p><a id="pro_id00508"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> totalDistance = <span class="steelblue">runs</span>.<span class="olive">reduce</span>( <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(sum, run) {
    <span class="steelblue"><span class="strong"><strong>return</strong></span></span> sum + <span class="steelblue">run</span>.<span class="olive">get</span>(<span class="maroon">"metricSummary"</span>).<span class="olive">distance</span>;
}, <span class="red">0</span>);</pre><p>That code could tell us, for example, that the user has logged a total of 3,358 kilometers with Nike+.</p><div class="note" title="Note"><h3 class="title"><a id="ch09note03"/>Note</h3><p><span class="strong"><strong>As you may have noticed, we’re taking advantage of many utilities from Underscore.js in our Backbone.js application. That is not a coincidence. Jeremy Ashkenas is the lead developer for both projects.</strong></span></p></div></div><div class="sect2" title="Step 4: Define the Application’s Main View"><div class="titlepage"><div><div><h3 class="title" id="step_4_define_the_applicationapostrophes">Step 4: Define the Application’s Main View</h3></div></div></div><p>Now that we have all the running data for a user, it’s time to present that data. We’ll do that with Backbone.js <span class="emphasis"><em>views.</em></span> To keep our example simple, we’ll consider only two ways to show the running data. First we’ll display a table listing summary information about each run. Then, if the user clicks on a table row, we’ll show details about that specific run, including any visualizations. The main view of our application will be the summary table, so let’s focus on that first.</p><p>A Backbone.js view is responsible for presenting data to the user, and that data may be maintained in a collection or a model. For the main page of our app, we want to show summary information for all of a user’s runs. That view, therefore, is a view of the entire collection. We’ll call the view <span class="emphasis"><em>Summary.</em></span></p><p><a id="iddle1991" class="indexterm"/><a id="iddle2003" class="indexterm"/>The bulk of the table for this Summary view will be a series of table rows, where each row presents summary data about an individual run. That means we can simply create a view of a single Run model presented as a table row, and design our main Summary view to be made up (mostly) of many SummaryRow views. We can once again rely on Yeoman to set up the scaffolding for both of those types of views.</p><a id="pro_id00509"/><pre class="programlisting">$ <span class="steelblue"><span class="strong"><strong>yo</strong></span></span> backbone:view summary
   <span class="steelblue"><span class="strong"><strong>create</strong></span></span> app/scripts/templates/summary.ejs
   <span class="steelblue"><span class="strong"><strong>create</strong></span></span> app/scripts/views/summary.js
   <span class="steelblue"><span class="strong"><strong>invoke</strong></span></span>   backbone-mocha:view
   <span class="steelblue"><span class="strong"><strong>create</strong></span></span>     test/views/summary.spec.js
$ <span class="steelblue"><span class="strong"><strong>yo</strong></span></span> backbone:view summaryRow
   <span class="steelblue"><span class="strong"><strong>create</strong></span></span> app/scripts/templates/summaryRow.ejs
   <span class="steelblue"><span class="strong"><strong>create</strong></span></span> app/scripts/views/summaryRow.js
   <span class="steelblue"><span class="strong"><strong>invoke</strong></span></span>   backbone-mocha:view
   <span class="steelblue"><span class="strong"><strong>create</strong></span></span>     test/views/summaryRow.spec.js</pre><p>The scaffolding that Yeoman sets up is pretty much the same for each view; only the name varies. Here’s what a Summary view looks like.</p><a id="pro_id00510"/><pre class="programlisting"><span class="indianred"><span class="emphasis"><em>/*Global Running, Backbone, JST*/</em></span></span>

<span class="steelblue">Running</span>.<span class="olive">Views</span> = <span class="steelblue">Running</span>.<span class="olive">Views</span> || {};

(<span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
    <span class="maroon">"use strict"</span>;
    <span class="steelblue">Running</span>.<span class="steelblue">Views</span>.<span class="olive">Summary</span> = <span class="steelblue">Backbone</span>.<span class="steelblue">View</span>.<span class="olive">extend</span>({
        <span class="dodgerblue">template</span>: JST[<span class="maroon">"app/scripts/templates/summary.ejs"</span>],
        <span class="dodgerblue">tagName</span>: <span class="maroon">"div"</span>,
        <span class="dodgerblue">id</span>: <span class="maroon">""</span>,
        <span class="dodgerblue">className</span>: <span class="maroon">""</span>,
        <span class="dodgerblue">events</span>: {},
        <span class="dodgerblue">initialize</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
            <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">listenTo</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">model</span>, <span class="maroon">"change"</span>, <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">render</span>);
        },
        <span class="dodgerblue">render</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
            <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">$el</span>.<span class="olive">html</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">template</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">model</span>.<span class="olive">toJSON</span>()));
        }
    });
})();</pre><p>The overall structure of the file is the same as our model and our collection, but there’s a bit more going on in the view itself. Let’s step through the view’s properties one at a time. The first property is <code class="literal">template</code>. That’s where we define the exact HTML markup for the view, and we’ll look at this in more detail in the next step.</p><p>The <code class="literal">tagName</code> property defines the HTML tag that our view will use as its parent. Yeoman defaults it to a generic <code class="literal">&lt;div&gt;</code>, but we know that in our case, it will be a <code class="literal">&lt;table&gt;</code>. We’ll change that in a moment.</p><p><a id="iddle1137" class="indexterm"/><a id="iddle1303" class="indexterm"/><a id="iddle1477" class="indexterm"/><a id="iddle1486" class="indexterm"/><a id="iddle1616" class="indexterm"/><a id="iddle1806" class="indexterm"/><a id="iddle1992" class="indexterm"/><a id="iddle2004" class="indexterm"/><a id="iddle2007" class="indexterm"/>The <code class="literal">id</code> and <code class="literal">className</code> properties specify HTML <code class="literal">id</code> attributes or <code class="literal">class</code> values to add to the main container (in our case, the <code class="literal">&lt;table&gt;</code>). We could, for example, base some CSS styles on these values. For our example, we’re not considering styles, so we can leave both properties blank or delete them entirely.</p><p>Next is the <code class="literal">events</code> property. This property identifies user events (such as mouse clicks) that are relevant for the view. In the case of the Summary view, there are no events, so we can leave the object empty or simply delete it.</p><p>The last two properties, <code class="literal">initialize()</code> and <code class="literal">render()</code>, are both methods. Before we consider those, let’s see the Summary view after we make the tweaks just mentioned. Now that we’ve omitted the properties we won’t be using, we’re down to just the <code class="literal">template</code> and <code class="literal">tagName</code> properties, plus the <code class="literal">initialize()</code> and <code class="literal">render()</code> methods:</p><a id="pro_id00511"/><pre class="programlisting"><span class="steelblue">Running</span>.<span class="steelblue">Views</span>.<span class="olive">Summary</span> = <span class="steelblue">Backbone</span>.<span class="steelblue">View</span>.<span class="olive">extend</span>({
    <span class="dodgerblue">template</span>: JST[<span class="maroon">"app/scripts/templates/summary.ejs"</span>],
    <span class="dodgerblue">tagName</span>: <span class="maroon">"table"</span>,
    <span class="dodgerblue">initialize</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
            <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">listenTo</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">model</span>, <span class="maroon">"change"</span>, <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">render</span>);
    },
    <span class="dodgerblue">render</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
            <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">$el</span>.<span class="olive">html</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">template</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">model</span>.<span class="olive">toJSON</span>()));
    }
});</pre><p>Now let’s look inside the last two methods, starting with <code class="literal">initialize()</code>. That method has a single statement (other than the <code class="literal">return</code> statement that we just added). By calling <code class="literal">listenTo()</code>, it tells Backbone.js that the view wants to listen for events. The first parameter, <code class="literal">this.collection</code>, specifies the event target, so the statement says that the view wants to listen to events affecting the collection. The second parameter specifies the type of events. In this case, the view wants to know whenever the collection changes. The final parameter is the function Backbone.js should call when the event occurs. Every time the Runs collection changes, we want Backbone.js to call the view’s <code class="literal">render()</code> method. That makes sense, because whenever the Runs collection changes, whatever we were displaying on the page is now out of date. To make it current, our view should refresh its contents.</p><p>Most of the real work of a view takes place in its <code class="literal">render()</code> method. After all, this is the code that actually creates the HTML markup for the web page. Yeoman has gotten us started with a template, but in the case of a collection view, that’s not enough. The template takes care of the HTML for the collection as a whole, but it doesn’t handle the models that are part of the collection. For the individual runs, we can use the <code class="literal">each()</code> function from Underscore.js to iterate through the collection and render each run.</p><p>As you can see from the following code, we’ve also added a <code class="literal">return this;</code> statement to each method. In a bit we’ll take advantage of this addition to <span class="emphasis"><em>chain</em></span> together calls to multiple methods in a single, concise statement.</p><a id="pro_id00512"/><pre class="programlisting"><span class="steelblue">Running</span>.<span class="steelblue">Views</span>.<span class="olive">Summary</span> = <span class="steelblue">Backbone</span>.<span class="steelblue">View</span>.<span class="olive">extend</span>({
    <span class="dodgerblue">template</span>: JST[<span class="maroon">"app/scripts/templates/summary.ejs"</span>],
    <span class="dodgerblue">tagName</span>: <span class="maroon">"table"</span>,
    <span class="dodgerblue">initialize</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
        <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">listenTo</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">collection</span>, <span class="maroon">"change"</span>, <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">render</span>);
        <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue"><span class="strong"><strong>this</strong></span></span>;
    },
     <span class="dodgerblue">render</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
        <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">$el</span>.<span class="olive">html</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">template</span>());
        <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">collection</span>.<span class="olive">each</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">renderRun</span>, <span class="steelblue"><span class="strong"><strong>this</strong></span></span>);
        <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue"><span class="strong"><strong>this</strong></span></span>;
    }
});</pre><p><a id="iddle1807" class="indexterm"/><a id="iddle1814" class="indexterm"/><a id="iddle1993" class="indexterm"/>Now we have to write the <code class="literal">renderRun()</code> method that handles each individual run. Here’s what we want that function to do:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Create a new SummaryRow view for the run.</p></li><li class="listitem"><p>Render that SummaryRow view.</p></li><li class="listitem"><p>Append the resulting HTML to the <code class="literal">&lt;tbody&gt;</code> in the Summary view.</p></li></ol></div><p>The code to implement those steps is straightforward, but it’s helpful to take each step one at a time.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Create a new SummaryRow view: <code class="literal">new SummaryRow({model: run})</code></p></li><li class="listitem"><p>Render that SummaryRow view: <code class="literal">.render()</code></p></li><li class="listitem"><p>Append the result: <code class="literal">this.$("tbody").append();</code></p></li></ol></div><p>When we put the steps together, we have the <code class="literal">renderRun()</code> method.</p><a id="pro_id00513"/><pre class="programlisting">renderRun: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> (run) {
    <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">$</span>(<span class="maroon">"tbody"</span>).<span class="olive">append</span>(<span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">Running</span>.<span class="steelblue">Views</span>.<span class="olive">SummaryRow</span>({
        <span class="dodgerblue">model</span>: run
    }).<span class="olive">render</span>().<span class="olive">el</span>);
}</pre><p>Most of the changes we made to the Summary view are also appropriate for the SummaryRow view, although we don’t need to add anything to the <code class="literal">render()</code> method. Here’s our first implementation of the SummaryRow. Note that we’ve set the <code class="literal">tagName</code> property to <code class="literal">"tr"</code> because we want each run model presented as a table row.</p><a id="pro_id00514"/><pre class="programlisting"><span class="steelblue">Running</span>.<span class="steelblue">Views</span>.<span class="olive">SummaryRow</span> = <span class="steelblue">Backbone</span>.<span class="steelblue">View</span>.<span class="olive">extend</span>({
    <span class="dodgerblue">template</span>: JST[<span class="maroon">"app/scripts/templates/summaryRow.ejs"</span>],
    <span class="dodgerblue">tagName</span>: <span class="maroon">"tr"</span>,
    <span class="dodgerblue">events</span>: {},
    <span class="dodgerblue">initialize</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
        <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">listenTo</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">model</span>, <span class="maroon">"change"</span>, <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">render</span>);
        <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue"><span class="strong"><strong>this</strong></span></span>;
    },
    <span class="dodgerblue">render</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
        <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">$el</span>.<span class="olive">html</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">template</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">model</span>.<span class="olive">toJSON</span>()));
        <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue"><span class="strong"><strong>this</strong></span></span>;
    }
});</pre><p><a id="iddle1551" class="indexterm"/><a id="iddle2057" class="indexterm"/><a id="iddle2186" class="indexterm"/>Now we have all the JavaScript code we need to show the main summary view for our app.</p></div><div class="sect2" title="Step 5: Define the Main View Templates"><div class="titlepage"><div><div><h3 class="title" id="step_5_define_the_main_view_templates">Step 5: Define the Main View Templates</h3></div></div></div><p>So far we’ve developed the JavaScript code to manipulate our Summary and SummaryRow views. That code doesn’t generate the actual HTML markup, though. For that task we rely on <span class="emphasis"><em>templates</em></span>. Templates are skeletal HTML markup with placeholders for individual values. Confining HTML markup to templates helps keep our JavaScript code clean, well structured, and easy to maintain.</p><p>Just as there are many popular JavaScript application libraries, there are also many template languages. Our application doesn’t require any fancy template functionality, however, so we’ll stick with the default template process that Yeoman has set up for us. That process relies on a JST tool (<span class="emphasis"><em><a class="ulink" href="https://github.com/gruntjs/grunt-contrib-jst/" target="_top">https://github.com/gruntjs/grunt-contrib-jst/</a></em></span>) to process templates, and the tool uses the Underscore.js template language (<span class="emphasis"><em><a class="ulink" href="http://underscorejs.org/#template/" target="_top">http://underscorejs.org/#template/</a></em></span>). It’s easy to see how this works through an example, so let’s dive in.</p><p>The first template we’ll tackle is the template for a SummaryRow. In our view, we’ve already established that the SummaryRow is a <code class="literal">&lt;tr&gt;</code> element, so the template needs to supply only the content that lives within that <code class="literal">&lt;tr&gt;</code>. We’ll get that content from the associated Run model, which, in turn, comes from the Nike+ service. Here’s an example activity that Nike+ could return.</p><a id="pro_id00515"/><pre class="programlisting">{
    <span class="maroon">"activityId"</span>: <span class="maroon">"2126456911"</span>,
    <span class="maroon">"activityType"</span>: <span class="maroon">"RUN"</span>,
    <span class="maroon">"startTime"</span>: <span class="maroon">"2013-04-09T10:54:33Z"</span>,
    <span class="maroon">"activityTimeZone"</span>: <span class="maroon">"GMT-04:00"</span>,
    <span class="maroon">"status"</span>: <span class="maroon">"COMPLETE"</span>,
    <span class="maroon">"deviceType"</span>: <span class="maroon">"IPOD"</span>,
    <span class="maroon">"metricSummary"</span>: {
        <span class="maroon">"calories"</span>: <span class="red">240</span>,
        <span class="maroon">"fuel"</span>: <span class="red">790</span>,
        <span class="maroon">"distance"</span>: <span class="red">3.7524</span>,
        <span class="maroon">"steps"</span>: <span class="red">0</span>,
        <span class="maroon">"duration"</span>: <span class="maroon">"0:22:39.000"</span>
    },
    <span class="maroon">"tags"</span>: [<span class="indianred"><span class="emphasis"><em>/* Data continues... */</em></span></span>],
    <span class="maroon">"metrics"</span>: [<span class="indianred"><span class="emphasis"><em>/* Data continues... */</em></span></span>],
    <span class="maroon">"gps"</span>: {<span class="indianred"><span class="emphasis"><em>/* Data continues... */</em></span></span>}
}</pre><p><a id="iddle1979" class="indexterm"/><a id="iddle1988" class="indexterm"/><a id="iddle2001" class="indexterm"/>For a first implementation, let’s show the time of the run, as well as its duration, distance, and calories. Our table row, therefore, will have four cells, with each cell holding one of these values. We can find the template, <span class="emphasis"><em>summaryRow.ejs</em></span>, in the <span class="emphasis"><em>app/scripts/templates</em></span> folder. By default, Yeoman sets it to a simple paragraph.</p><a id="pro_id00516"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;p&gt;</strong></span></span>Your content here.<span class="steelblue"><span class="strong"><strong>&lt;/p&gt;</strong></span></span></pre><p>Let’s replace that with four table cells.</p><a id="pro_id00517"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;td&gt;&lt;/td&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;td&gt;&lt;/td&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;td&gt;&lt;/td&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;td&gt;&lt;/td&gt;</strong></span></span></pre><p>As placeholders for the cells’ content, we can use model attributes enclosed in special <code class="literal">&lt;%=</code> and <code class="literal">%&gt;</code> delimiters. The full SummaryRow template is as follows.</p><a id="pro_id00518"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>&lt;%= startTime %&gt;<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>&lt;%= metricSummary.duration %&gt;<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>&lt;%= metricSummary.distance %&gt;<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>&lt;%= metricSummary.calories %&gt;<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span></pre><p>The other template we need to supply is the Summary template. Since we’ve already set the view’s main tag to be a <code class="literal">&lt;table&gt;</code>, this template should specify the content within that <code class="literal">&lt;table&gt;</code>: a table header row plus an empty <code class="literal">&lt;tbody&gt;</code> element (whose individual rows will come from the Run models).</p><a id="pro_id00519"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;thead&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;tr&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;th&gt;</strong></span></span>Time<span class="steelblue"><span class="strong"><strong>&lt;/th&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;th&gt;</strong></span></span>Duration<span class="steelblue"><span class="strong"><strong>&lt;/th&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;th&gt;</strong></span></span>Distance<span class="steelblue"><span class="strong"><strong>&lt;/th&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;th&gt;</strong></span></span>Calories<span class="steelblue"><span class="strong"><strong>&lt;/th&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;/tr&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/thead&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;tbody&gt;&lt;/tbody&gt;</strong></span></span></pre><p>Now we’re finally ready to construct the main view for our runs. The steps are quite straightforward:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Create a new Runs collection.</p></li><li class="listitem"><p>Fetch the data for that collection from the server.</p></li><li class="listitem"><p>Create a new Summary view for the collection.</p></li><li class="listitem"><p>Render the view.</p></li></ol></div><p><a id="iddle1305" class="indexterm"/>Here’s the JavaScript code for those four steps:</p><a id="pro_id00520"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> runs = <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">Running</span>.<span class="steelblue">Collection</span>.<span class="olive">Runs</span>();
<span class="steelblue">runs</span>.<span class="olive">fetch</span>();
<span class="steelblue"><span class="strong"><strong>var</strong></span></span> summaryView = <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">Running</span>.<span class="steelblue">Views</span>.<span class="olive">Summary</span>({<span class="dodgerblue">collection</span>: runs});
<span class="steelblue">summaryView</span>.<span class="olive">render</span>();</pre><p>We can access the constructed <code class="literal">&lt;table&gt;</code> as the <code class="literal">el</code> (short for <span class="emphasis"><em>element</em></span>) property of the view. It will look something like the following:</p><a id="pro_id00521"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;table&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;thead&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;tr&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;th&gt;</strong></span></span>Time<span class="steelblue"><span class="strong"><strong>&lt;/th&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;th&gt;</strong></span></span>Duration<span class="steelblue"><span class="strong"><strong>&lt;/th&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;th&gt;</strong></span></span>Distance<span class="steelblue"><span class="strong"><strong>&lt;/th&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;th&gt;</strong></span></span>Calories<span class="steelblue"><span class="strong"><strong>&lt;/th&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;/tr&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;/thead&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;tbody&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;tr&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>2013-04-09T10:54:33Z<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>0:22:39.000<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>3.7524<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>240<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;/tr&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;tr&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>2013-04-07T12:34:40Z<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>0:44:59.000<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>8.1724<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>569<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;/tr&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;tr&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>2013-04-06T13:28:36Z<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>1:28:59.000<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>16.068001<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
        <span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>1200<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;/tr&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;/tbody&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/table&gt;</strong></span></span></pre><p>When we insert that markup in the page, our users can see a simple summary table listing their runs, as shown in <a class="xref" href="ch09.html#simple_table_with_a_summary_of_run_infor" title="Figure 9-3. A simple table with a summary of run information">Figure 9-3</a>.</p><div class="figure"><a id="simple_table_with_a_summary_of_run_infor"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00139"/><img src="figs/web/09fig03.png.jpg" alt="A simple table with a summary of run information"/></div></div><div class="figure-title">Figure 9-3. A simple table with a summary of run information</div></div></div><div class="sect2" title="Step 6: Refine the Main View"><div class="titlepage"><div><div><h3 class="title" id="step_6_refine_the_main_view">Step 6: Refine the Main View</h3></div></div></div><p><a id="iddle1685" class="indexterm"/><a id="iddle1808" class="indexterm"/><a id="iddle2052" class="indexterm"/><a id="iddle2189" class="indexterm"/>Now we’re starting to get somewhere, though the table contents could use some tweaking. After all, does the last digit in a run of 16.068001 kilometers really matter? Since Nike+ determines the attributes of our Run model, it might seem like we have no control over the values passed to our template. Fortunately, that’s not the case. If we look at the SummaryView’s <code class="literal">render()</code> method, we can see how the template gets its values.</p><a id="pro_id00522"/><pre class="programlisting">render: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
    <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">$el</span>.<span class="olive">html</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">template</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">model</span>.<span class="olive">toJSON</span>()));
    <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue"><span class="strong"><strong>this</strong></span></span>;
}</pre><p>The template values come from a JavaScript object that we’re creating directly from the model. Backbone.js provided the <code class="literal">toJSON()</code> method, which returns a JavaScript object corresponding to the model’s attributes. We can actually pass any JavaScript object to the template, even one we create ourselves within the <code class="literal">render()</code> method. Let’s rewrite that method to provide a more user-friendly Summary view. We’ll take the model’s attributes one at a time.</p><p>First is the date of the run. A date of “2013-04-09T10:54:33Z” isn’t very readable for average users, and it’s probably not even in their time zone. Working with dates and times is actually quite tricky, but the excellent Moment.js library (<span class="emphasis"><em><a class="ulink" href="http://momentjs.com/" target="_top">http://momentjs.com/</a></em></span>) can handle all of the complexity. Since we added that library to our app in an earlier section, we can take advantage of it now.</p><a id="pro_id00523"/><pre class="programlisting">render: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> run = {};
    <span class="steelblue">run</span>.<span class="olive">date</span> = <span class="olive">moment</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">model</span>.<span class="olive">get</span>(<span class="maroon">"startTime"</span>)).<span class="olive">calendar</span>();</pre><div class="note" title="Note"><h3 class="title"><a id="ch09note04"/>Note</h3><p><span class="strong"><strong>In the interest of brevity, we’re cheating a little with the preceding code because it converts the UTC timestamp to the local time zone of the browser. It would probably be more correct to convert it to the time zone for the run, which Nike+ provides in the data.</strong></span></p></div><p>Next up is the run’s duration. It’s doubtful that we need to show the fractions of seconds that Nike+ includes, so let’s simply drop them from the attribute. (It would be more precise to round up or down, but assuming our users are not Olympic athletes in training, a second here or there won’t matter. Besides, Nike+ seems to always record these subsecond durations as “.000” anyway.)</p><a id="pro_id00524"/><pre class="programlisting"><span class="steelblue">run</span>.<span class="olive">duration</span> = <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">model</span>.<span class="olive">get</span>(<span class="maroon">"metricSummary"</span>).<span class="steelblue">duration</span>.<span class="olive">split</span>(<span class="maroon">"."</span>)[<span class="red">0</span>];</pre><p>The <code class="literal">distance</code> property can also use some adjustment. In addition to rounding it to a reasonable number of decimal places, we can convert from kilometers to miles for our US users. A single statement takes care of both.</p><a id="pro_id00525"/><pre class="programlisting"><span class="steelblue">run</span>.<span class="olive">distance</span> = <span class="steelblue">Math</span>.<span class="olive">round</span>(<span class="red">62</span>. *
    <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">model</span>.<span class="olive">get</span>(<span class="maroon">"metricSummary"</span>).<span class="olive">distance</span>)/<span class="red">100</span> +
    <span class="maroon">" Miles"</span>;</pre><p>The <code class="literal">calories</code> property is fine as it is, so we’ll just copy it into our temporary object.</p><a id="pro_id00526"/><pre class="programlisting"><span class="steelblue">run</span>.<span class="olive">calories</span> = <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">model</span>.<span class="olive">get</span>(<span class="maroon">"metricSummary"</span>).<span class="olive">calories</span>;</pre><p>Finally, if you’re an avid runner, you might have noticed that there’s an important value missing from the Nike+ attributes: the average pace for the run in minutes per mile. We have the data to calculate it, so let’s add that as well.</p><a id="pro_id00527"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> secs = <span class="olive">_</span>(<span class="steelblue">run</span>.<span class="steelblue">duration</span>.<span class="olive">split</span>(<span class="maroon">":"</span>)).<span class="olive">reduce</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(sum, num) {
    <span class="steelblue"><span class="strong"><strong>return</strong></span></span> sum*<span class="red">60</span>+<span class="olive">parseInt</span>(num,<span class="red">10</span>); }, <span class="red">0</span>);
<span class="steelblue"><span class="strong"><strong>var</strong></span></span> pace = <span class="steelblue">moment</span>.<span class="olive">duration</span>(<span class="red">1000</span>*secs/<span class="olive">parseFloat</span>(<span class="steelblue">run</span>.<span class="olive">distance</span>));
<span class="steelblue">run</span>.<span class="olive">pace</span> = <span class="steelblue">pace</span>.<span class="olive">minutes</span>() + <span class="maroon">":"</span> + <span class="olive">_</span>(<span class="steelblue">pace</span>.<span class="olive">seconds</span>()).<span class="olive">pad</span>(<span class="red">2</span>, <span class="maroon">"0"</span>);</pre><p>Now we have a new object to pass to the template.</p><a id="pro_id00528"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">$el</span>.<span class="olive">html</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">template</span>(run));</pre><p>We’ll also need to modify both templates to match the new markup. Here’s the updated template for SummaryRows.</p><a id="pro_id00529"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>&lt;%= date %&gt;<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>&lt;%= duration %&gt;<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>&lt;%= distance %&gt;<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>&lt;%= calories %&gt;<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;td&gt;</strong></span></span>&lt;%= pace %&gt;<span class="steelblue"><span class="strong"><strong>&lt;/td&gt;</strong></span></span></pre><p>And here’s the Summary template with the additional column for Pace.</p><a id="pro_id00530"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;thead&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;tr&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;th&gt;</strong></span></span>Date<span class="steelblue"><span class="strong"><strong>&lt;/th&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;th&gt;</strong></span></span>Duration<span class="steelblue"><span class="strong"><strong>&lt;/th&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;th&gt;</strong></span></span>Distance<span class="steelblue"><span class="strong"><strong>&lt;/th&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;th&gt;</strong></span></span>Calories<span class="steelblue"><span class="strong"><strong>&lt;/th&gt;</strong></span></span>
    <span class="steelblue"><span class="strong"><strong>&lt;th&gt;</strong></span></span>Pace<span class="steelblue"><span class="strong"><strong>&lt;/th&gt;</strong></span></span>
  <span class="steelblue"><span class="strong"><strong>&lt;/tr&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;/thead&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;tbody&gt;&lt;/tbody&gt;</strong></span></span></pre><p>Now we have a much-improved summary table for our users, shown in <a class="xref" href="ch09.html#improved_summary_table_with_cleaner-look" title="Figure 9-4. An improved summary table with cleaner-looking data">Figure 9-4</a>.</p><div class="figure"><a id="improved_summary_table_with_cleaner-look"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00140"/><img src="figs/web/09fig04.png.jpg" alt="An improved summary table with cleaner-looking data"/></div></div><div class="figure-title">Figure 9-4. An improved summary table with cleaner-looking data</div></div></div></div><div class="sect1" title="Views for Visualizations"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="views_for_visualizations">Views for Visualizations</h2></div></div></div><p>Now that we’ve seen how to use Backbone.js views to separate data from its presentation, we can consider how to use the same approach for data visualizations. When the presentation is simple HTML markup—as in the previous section’s <a id="iddle1269" class="indexterm"/><a id="iddle2146" class="indexterm"/><a id="iddle2149" class="indexterm"/>tables—it’s easy to use templates to view a model. But templates aren’t sophisticated enough to handle data visualizations, so we’ll need to modify our approach for those.</p><p>The data from the Nike+ service offers lots of opportunity for visualizations. Each run, for example, may include a record of the user’s heart rate, instantaneous pace, and cumulative distance, recorded every 10 seconds. Runs may also include the user’s GPS coordinates captured every second. That type of data lends itself to both charts and maps, and in this section, we’ll add both to our application.</p><div class="sect2" title="Step 1: Define the Additional Views"><div class="titlepage"><div><div><h3 class="title" id="step_1_define_the_additional_views">Step 1: Define the Additional Views</h3></div></div></div><p>As we did in the previous section, we’ll rely on Yeoman to create the scaffolding for our additional views. One view, which we’ll call <span class="emphasis"><em>Details</em></span>, will act as the overall view for the details of an individual run. Within that view, we’ll create three additional views, each showing a different aspect of the run. We can think of these views in a hierarchy.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: none"><p title="Details"><span class="title"><strong><span class="strong"><strong>Details</strong></span></strong></span>. A detailed view of a single run</p></li><li class="listitem" style="list-style-type: none"><p title="Properties"><span class="title"><strong><span class="strong"><strong>Properties</strong></span></strong></span>. The full set of properties associated with the run</p></li><li class="listitem" style="list-style-type: none"><p title="Chart"><span class="title"><strong><span class="strong"><strong>Chart</strong></span></strong></span>. Charts showing performance during the run</p></li><li class="listitem" style="list-style-type: none"><p title="Map"><span class="title"><strong><span class="strong"><strong>Map</strong></span></strong></span>. A map of the run’s route</p></li></ul></div><p>To start the development of these views, we return to the command line and execute four Yeoman commands.</p><a id="pro_id00531"/><pre class="programlisting">$ <span class="steelblue"><span class="strong"><strong>yo</strong></span></span> backbone:view details
$ <span class="steelblue"><span class="strong"><strong>yo</strong></span></span> backbone:view properties
$ <span class="steelblue"><span class="strong"><strong>yo</strong></span></span> backbone:view charts
$ <span class="steelblue"><span class="strong"><strong>yo</strong></span></span> backbone:view map</pre></div><div class="sect2" title="Step 2: Implement the Details View"><div class="titlepage"><div><div><h3 class="title" id="step_2_implement_the_details_view">Step 2: Implement the Details View</h3></div></div></div><p>The Details view is really nothing more than a container for its three children, so its implementation is about as easy as it gets. We create a new view for each of the children, render the view, and add the resulting markup to the Details. Here is the complete code for this view:</p><a id="pro_id00532"/><pre class="programlisting"><span class="steelblue">Running</span>.<span class="steelblue">Views</span>.<span class="olive">Details</span> = <span class="steelblue">Backbone</span>.<span class="steelblue">View</span>.<span class="olive">extend</span>({
    <span class="dodgerblue">render</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
        <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">$el</span>.<span class="olive">empty</span>();
        <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">$el</span>.<span class="olive">append</span>(
            <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">Running</span>.<span class="steelblue">Views</span>.<span class="olive">Properties</span>({<span class="dodgerblue">model</span>: <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">model</span>}).<span class="olive">render</span>().<span class="olive">el</span>
        );
        <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">$el</span>.<span class="olive">append</span>(
            <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">Running</span>.<span class="steelblue">Views</span>.<span class="olive">Charts</span>({<span class="dodgerblue">model</span>: <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">model</span>}).<span class="olive">render</span>().<span class="olive">el</span>
        );
        <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">$el</span>.<span class="olive">append</span>(
            <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">Running</span>.<span class="steelblue">Views</span>.<span class="olive">Map</span>({<span class="dodgerblue">model</span>: <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">model</span>}).<span class="olive">render</span>().<span class="olive">el</span>
        );
        <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue"><span class="strong"><strong>this</strong></span></span>;
    }
});</pre><p><a id="iddle1487" class="indexterm"/><a id="iddle1781" class="indexterm"/><a id="iddle1809" class="indexterm"/><a id="iddle2153" class="indexterm"/>Unlike the previous views we’ve created, this view doesn’t have an <code class="literal">initialize()</code> method. That’s because the Details view doesn’t have to listen for changes to the model, so there’s nothing to do during initialization. In other words, the Details view itself doesn’t actually depend on any of the properties of the Run model. (The child views, on the other hand, depend greatly on those properties.)</p><p>The <code class="literal">render()</code> method itself first clears out any existing content from its element. This line makes it safe to call the <code class="literal">render()</code> method multiple times. The next three statements create each of the child views. Notice that all of the child views have the same model, which is the model for the Details view as well. This capability is the power of the model/view architecture; one data object—in our case, a run—can be presented in many different ways. While the <code class="literal">render()</code> method creates each of these child views, it also calls their <code class="literal">render()</code> methods, and it appends the resulting content (their <code class="literal">el</code> properties) into its own <code class="literal">el</code>.</p></div><div class="sect2" title="Step 3: Implement the Properties View"><div class="titlepage"><div><div><h3 class="title" id="step_3_implement_the_properties_view">Step 3: Implement the Properties View</h3></div></div></div><p>For the Properties view, we want to show all of the properties that Nike+ has associated with the run. Those properties are determined by the data returned by the Nike+ service; here’s an example:</p><a id="pro_id00533"/><pre class="programlisting">{
    <span class="maroon">"activityId"</span>: <span class="maroon">"2126456911"</span>,
    <span class="maroon">"activityType"</span>: <span class="maroon">"RUN"</span>,
    <span class="maroon">"startTime"</span>: <span class="maroon">"2013-04-09T10:54:33Z"</span>,
    <span class="maroon">"activityTimeZone"</span>: <span class="maroon">"GMT-04:00"</span>,
    <span class="maroon">"status"</span>: <span class="maroon">"COMPLETE"</span>,
    <span class="maroon">"deviceType"</span>: <span class="maroon">"IPOD"</span>,
    <span class="maroon">"metricSummary"</span>: {
        <span class="maroon">"calories"</span>: <span class="red">240</span>,
        <span class="maroon">"fuel"</span>: <span class="red">790</span>,
        <span class="maroon">"distance"</span>: <span class="red">3.7524</span>,
        <span class="maroon">"steps"</span>: <span class="red">0</span>,
        <span class="maroon">"duration"</span>: <span class="maroon">"0:22:39.000"</span>
    },
    <span class="maroon">"tags"</span>: [
        { <span class="maroon">"tagType"</span>: <span class="maroon">"WEATHER"</span>, <span class="maroon">"tagValue"</span>: <span class="maroon">"SUNNY"</span>    },
        { <span class="maroon">"tagType"</span>: <span class="maroon">"NOTE"</span>                            },
        { <span class="maroon">"tagType"</span>: <span class="maroon">"TERRAIN"</span>, <span class="maroon">"tagValue"</span>: <span class="maroon">"TRAIL"</span>    },
        { <span class="maroon">"tagType"</span>: <span class="maroon">"SHOES"</span>, <span class="maroon">"tagValue"</span>: <span class="maroon">"Neo Trail"</span>  },
        { <span class="maroon">"tagType"</span>: <span class="maroon">"EMOTION"</span>, <span class="maroon">"tagValue"</span>: <span class="maroon">"GREAT"</span>    }
    ],
    <span class="maroon">"metrics"</span>: [
        { <span class="maroon">"intervalMetric"</span>: <span class="red">10</span>, <span class="maroon">"intervalUnit"</span>: <span class="maroon">"SEC"</span>,
          <span class="maroon">"metricType"</span>: <span class="maroon">"SPEED"</span>, <span class="maroon">"values"</span>: [<span class="indianred"><span class="emphasis"><em>/* Data continues... */</em></span></span>] },
        { <span class="maroon">"intervalMetric"</span>: <span class="red">10</span>, <span class="maroon">"intervalUnit"</span>: <span class="maroon">"SEC"</span>,
          <span class="maroon">"metricType"</span>: <span class="maroon">"HEARTRATE"</span>, <span class="maroon">"values"</span>: [<span class="indianred"><span class="emphasis"><em>/* Data continues... */</em></span></span>] },
        { <span class="maroon">"intervalMetric"</span>: <span class="red">10</span>, <span class="maroon">"intervalUnit"</span>: <span class="maroon">"SEC"</span>,
          <span class="maroon">"metricType"</span>: <span class="maroon">"DISTANCE"</span>, <span class="maroon">"values"</span>: [<span class="indianred"><span class="emphasis"><em>/* Data continues... */</em></span></span>] },
    ],
    <span class="maroon">"gps"</span>: {
        <span class="maroon">"elevationLoss"</span>: <span class="red">114.400024</span>,
        <span class="maroon">"elevationGain"</span>: <span class="red">109.00003</span>,
        <span class="maroon">"elevationMax"</span>: <span class="red">296.2</span>,
        <span class="maroon">"elevationMin"</span>: <span class="red">257</span>,
        <span class="maroon">"intervalMetric"</span>: <span class="red">10</span>,
        <span class="maroon">"intervalUnit"</span>: <span class="maroon">"SEC"</span>,
        <span class="maroon">"waypoints"</span>: [<span class="indianred"><span class="emphasis"><em>/* Data continues... */</em></span></span>]
    }
}</pre><p><a id="iddle1264" class="indexterm"/><a id="iddle1281" class="indexterm"/><a id="iddle1994" class="indexterm"/><a id="iddle2106" class="indexterm"/>That data can certainly benefit from a bit of cleanup to make it more user-friendly. To do that we’ll take advantage of the Underscore.string library we added to the project before. We can make sure that library is available by “mixing it into” the main Underscore.js library. We’ll do that right at the start of the JavaScript file for the Properties view.</p><a id="pro_id00534"/><pre class="programlisting"><span class="indianred"><span class="emphasis"><em>/*Global Running, Backbone, JST, _*/</em></span></span>

<span class="steelblue">_</span>.<span class="olive">mixin</span>(<span class="steelblue">_</span>.<span class="steelblue">str</span>.<span class="olive">exports</span>());

<span class="steelblue">Running</span>.<span class="olive">Views</span> = <span class="steelblue">Running</span>.<span class="olive">Views</span> || {};

<span class="indianred"><span class="emphasis"><em>// Code continues...</em></span></span></pre><p>Notice that we’ve also added the global variable for Underscore.js (<code class="literal">_</code>) to the initial comment in the file.</p><p>The most straightforward way to present this information in HTML is with a description list (<code class="literal">&lt;dl&gt;</code>). Each property can be an individual item in the list, with a description term (<code class="literal">&lt;dt&gt;</code>) holding the property name and the description data (<code class="literal">&lt;dd&gt;</code>) its value. To implement this, we set the <code class="literal">tagName</code> property of the view to be <code class="literal">"dl"</code>, and we create a generic list item template. Here’s the start of our Properties view code:</p><a id="pro_id00535"/><pre class="programlisting"><span class="steelblue">Running</span>.<span class="steelblue">Views</span>.<span class="olive">Properties</span> = <span class="steelblue">Backbone</span>.<span class="steelblue">View</span>.<span class="olive">extend</span>({
    <span class="dodgerblue">template</span>: JST[<span class="maroon">"app/scripts/templates/properties.ejs"</span>],
    <span class="dodgerblue">tagName</span>: <span class="maroon">"dl"</span>,
    <span class="dodgerblue">initialize</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
        <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">listenTo</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">model</span>, <span class="maroon">"change"</span>, <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">render</span>);
        <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue"><span class="strong"><strong>this</strong></span></span>;
    },
    <span class="dodgerblue">render</span>: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
        <span class="indianred"><span class="emphasis"><em>// More code goes here</em></span></span>
        <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue"><span class="strong"><strong>this</strong></span></span>;
    }
});</pre><p>And here’s the simple template that the view will use.</p><a id="pro_id00536"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>&lt;dt&gt;</strong></span></span>&lt;%= key %&gt;<span class="steelblue"><span class="strong"><strong>&lt;/dt&gt;</strong></span></span>
<span class="steelblue"><span class="strong"><strong>&lt;dd&gt;</strong></span></span>&lt;%= value %&gt;<span class="steelblue"><span class="strong"><strong>&lt;/dd&gt;</strong></span></span></pre><p><a id="iddle1471" class="indexterm"/><a id="iddle1676" class="indexterm"/><a id="iddle1712" class="indexterm"/><a id="iddle1800" class="indexterm"/><a id="iddle2045" class="indexterm"/><a id="iddle2107" class="indexterm"/>A quick glance at the Nike+ data shows that it contains nested objects. The <code class="literal">metricSummary</code> property of the main object is itself an object. We need a function that will iterate through all the properties in the input object, building the HTML markup as it does. A recursive function can be particularly effective here, since it can call itself whenever it reaches another nested object. Next, we add an <code class="literal">obj2Html()</code> method to our view. At its core, this method will use the Underscore.js <code class="literal">reduce()</code> function, which is well suited to the task at hand.</p><a id="pro_id00537"/><pre class="programlisting">obj2Html: <span class="steelblue"><span class="strong"><strong>function</strong></span></span>(obj) {
    <span class="steelblue"><span class="strong"><strong>return</strong></span></span> (
        <span class="olive">_</span>(obj).<span class="olive">reduce</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(html, value, key) {

            <span class="indianred"><span class="emphasis"><em>// Create the markup for the current</em></span></span>
            <span class="indianred"><span class="emphasis"><em>// key/value pair and add it to the html variable</em></span></span>

            <span class="steelblue"><span class="strong"><strong>return</strong></span></span> html;
        }, <span class="maroon">""</span>, <span class="steelblue"><span class="strong"><strong>this</strong></span></span>)
    );
}</pre><p>As we process each property, the first thing we can do is improve the key name. For example, we’d like to replace <code class="literal">startTime</code> with <code class="literal">Start Time</code>. That’s where Underscore.string comes in. Its <code class="literal">humanize()</code> function turns camelCase into separate words, and its <code class="literal">titleize()</code> function ensures that each word begins with an uppercase letter. We’ll use chaining to perform both operations in one statement.</p><a id="pro_id00538"/><pre class="programlisting">key = <span class="steelblue">_</span>.<span class="olive">chain</span>(key).<span class="olive">humanize</span>().<span class="olive">titleize</span>().<span class="olive">value</span>();</pre><p>Now we can consider the value. If it is an array, we’ll replace it with a string that shows the array length.</p><a id="pro_id00539"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>if</strong></span></span> (<span class="olive">_</span>(value).<span class="olive">isArray</span>()) {
    value = <span class="maroon">"["</span> + <span class="steelblue">value</span>.<span class="olive">length</span> + <span class="maroon">" items]"</span>;
}</pre><p>Next we check to see if the value is an object. If it is, then we’ll call the <code class="literal">obj2Html()</code> method recursively.</p><a id="pro_id00540"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>if</strong></span></span> (<span class="olive">_</span>(value).<span class="olive">isObject</span>()) {
    html += <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">obj2Html</span>(value);</pre><p>For other types, we convert the value to a string, format it a bit with Underscore.string, and make use of our template.</p><a id="pro_id00541"/><pre class="programlisting">} <span class="steelblue"><span class="strong"><strong>else</strong></span></span> {
    value = <span class="olive">_</span>(<span class="steelblue">value</span>.<span class="olive">toString</span>().<span class="olive">toLowerCase</span>()).<span class="olive">titleize</span>();
    html += <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">template</span>({ <span class="dodgerblue">key</span>: key, <span class="dodgerblue">value</span>: value });
}</pre><p><a id="iddle1713" class="indexterm"/><a id="iddle1810" class="indexterm"/><a id="iddle2053" class="indexterm"/>There are a few other minor improvements we can make to the presentation, which you can find in the book’s source code. The last piece of the view is implementing the <code class="literal">render()</code> method. In that method, we use <code class="literal">toJSON()</code> to get an object corresponding to the Run model, and then we start the <code class="literal">obj2Html()</code> recursion with that object.</p><a id="pro_id00542"/><pre class="programlisting">render: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
    <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">$el</span>.<span class="olive">html</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">obj2Html</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">model</span>.<span class="olive">toJSON</span>()));
    <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue"><span class="strong"><strong>this</strong></span></span>;
}</pre><p>The result is a complete picture of the properties of the run, shown in <a class="xref" href="ch09.html#completed_properties_view_shows_all_of_t" title="Figure 9-5. The completed Properties view shows all of the data associated with a run.">Figure 9-5</a>.</p><div class="figure"><a id="completed_properties_view_shows_all_of_t"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00141"/><img src="figs/web/09fig05.png.jpg" alt="The completed Properties view shows all of the data associated with a run."/></div></div><div class="figure-title">Figure 9-5. The completed Properties view shows all of the data associated with a run.</div></div></div><div class="sect2" title="Step 4: Implement the Map View"><div class="titlepage"><div><div><h3 class="title" id="step_4_implement_the_map_view">Step 4: Implement the Map View</h3></div></div></div><p><a id="iddle1062" class="indexterm"/><a id="iddle1092" class="indexterm"/><a id="iddle1120" class="indexterm"/><a id="iddle1255" class="indexterm"/><a id="iddle1632" class="indexterm"/><a id="iddle1811" class="indexterm"/><a id="iddle2148" class="indexterm"/><a id="iddle2152" class="indexterm"/>To show users maps of their runs, we rely on the Leaflet library from <a class="xref" href="ch06.html" title="Chapter 6. Visualizing Geographic Data">Chapter 6</a>. Using the library will require some small modifications to the normal Backbone.js view implementation, but, as we’ll see, those same modifications will come in handy for other views as well. Leaflet builds its maps in a containing element in the page (typically a <code class="literal">&lt;div&gt;</code>), and that containing element must have an <code class="literal">id</code> attribute so that Leaflet can find it. Backbone.js will take care of adding that <code class="literal">id</code> if we include an <code class="literal">id</code> property in the view. That’s easy enough.</p><a id="pro_id00543"/><pre class="programlisting"><span class="steelblue">Running</span>.<span class="steelblue">Views</span>.<span class="olive">Map</span> = <span class="steelblue">Backbone</span>.<span class="steelblue">View</span>.<span class="olive">extend</span>({
    <span class="dodgerblue">id</span>: <span class="maroon">"map"</span>,</pre><p>With <code class="literal">&lt;div id="map"&gt;&lt;/div&gt;</code> available in the page’s markup, we can create a Leaflet map with the following statement:</p><a id="pro_id00544"/><pre class="programlisting"><span class="steelblue"><span class="strong"><strong>var</strong></span></span> map = <span class="steelblue">L</span>.<span class="olive">map</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">id</span>);</pre><p>We might be tempted to do that directly in the view’s <code class="literal">render()</code> method, but there’s a problem with that approach. Adding (and removing) elements in a web page requires a lot of computation by the browser. When JavaScript code does that frequently, the performance of the page can suffer significantly. To reduce this problem, Backbone.js tries to minimize the number of times it adds (or removes) elements, and one way to do that is to add many elements at once rather than adding each element independently. It employs that approach when it implements a view’s <code class="literal">render()</code> method. Before adding any elements to the page, it lets the view finish constructing its entire markup; only then does it add that markup to the page.</p><p>The problem here is that when <code class="literal">render()</code> is called the first time, there won’t (yet) be a <code class="literal">&lt;div id="map"&gt;&lt;/div&gt;</code> anywhere in the page. If we call Leaflet, it won’t be able to find the container for its map, and it will generate an error. What we need to do is defer the part of <code class="literal">render()</code> that draws the map until after Backbone.js has added the map container to the page.</p><p>Fortunately, Underscore.js has a utility function called <code class="literal">defer()</code> to do just that. Instead of drawing the map directly in the <code class="literal">render()</code> method, we’ll create a separate method. Then, in the <code class="literal">render()</code> method, we’ll defer execution of that new method. Here’s what the code to do that looks like:</p><a id="pro_id00545"/><pre class="programlisting">render: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
    <span class="steelblue">_</span>.<span class="olive">defer</span>(<span class="olive">_</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(){ <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">drawMap</span>(); }).<span class="olive">bind</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>));
},
drawMap: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
    <span class="steelblue"><span class="strong"><strong>var</strong></span></span> map = <span class="steelblue">L</span>.<span class="olive">map</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">id</span>);
    <span class="indianred"><span class="emphasis"><em>// Code continues...</em></span></span>
}</pre><p>As you can see, we’re actually using a couple of Underscore.js functions in our <code class="literal">render()</code> method. In addition to <code class="literal">defer()</code>, we also take advantage of <code class="literal">bind()</code>. The <a id="iddle1063" class="indexterm"/><a id="iddle1290" class="indexterm"/><a id="iddle1422" class="indexterm"/><a id="iddle1488" class="indexterm"/><a id="iddle1812" class="indexterm"/>latter function ensures that the <code class="literal">this</code> value when <code class="literal">drawMap()</code> is eventually called is the same as the <code class="literal">this</code> value within the view.</p><p>There’s one change we can make to further improve this implementation. Although there won’t be a <code class="literal">&lt;div id="map"&gt;&lt;/div&gt;</code> in the page when <code class="literal">render()</code> is first called, that element will exist in subsequent calls to <code class="literal">render()</code>. In those cases, we don’t need to defer the execution of <code class="literal">drawMap()</code>. That leads to the following code for our <code class="literal">render()</code> method.</p><a id="pro_id00546"/><pre class="programlisting">render: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
    <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (<span class="steelblue">document</span>.<span class="olive">getElementById</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">id</span>)) {
        <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">drawMap</span>();
    } <span class="steelblue"><span class="strong"><strong>else</strong></span></span> {
        <span class="steelblue">_</span>.<span class="olive">defer</span>(<span class="olive">_</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(){ <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">drawMap</span>(); }).<span class="olive">bind</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>));
    }
    <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue"><span class="strong"><strong>this</strong></span></span>;
},</pre><p>As long as we’re making optimizations, let’s also change the <code class="literal">initialize()</code> method slightly. The default method that Yeoman creates is this:</p><a id="pro_id00547"/><pre class="programlisting">initialize: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
    <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">listenTo</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">model</span>, <span class="maroon">"change"</span>, <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">render</span>);
},</pre><p>For the Map view, however, we don’t really care if any property of the Run model changes. The only property the view needs is <code class="literal">gps</code>, so we can tell Backbone. js to bother us only if that specific property changes.</p><a id="pro_id00548"/><pre class="programlisting">initialize: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
    <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">listenTo</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">model</span>, <span class="maroon">"change:gps"</span>, <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">render</span>);
    <span class="steelblue"><span class="strong"><strong>return</strong></span></span> <span class="steelblue"><span class="strong"><strong>this</strong></span></span>;
},</pre><p>You might be wondering, “Why would the <code class="literal">gps</code> property of the Run model ever change?” I’ll get to that when I cover the quirks of the Nike+ REST API in <a class="xref" href="ch10.html" title="Chapter 10. Building Data-Driven Web Applications: Part 2">Chapter 10</a>.</p><p>With the preliminaries out of the way, we can implement the <code class="literal">drawMap()</code> function, which turns out to be a very easy implementation. The steps are as follows:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Make sure the model has a <code class="literal">gps</code> property and there are waypoints associated with it.</p></li><li class="listitem"><p>If an old map exists, remove it.</p></li><li class="listitem"><p>Extract the GPS coordinates from the waypoints array.</p></li><li class="listitem"><p>Create a path using those coordinates.</p></li><li class="listitem"><p>Create a map that contains that path, and draw the path on the map.</p></li><li class="listitem"><p>Add the map tiles.</p></li></ol></div><p>The resulting code is a straightforward implementation of those steps.</p><a id="pro_id00549"/><pre class="programlisting">drawMap: <span class="steelblue"><span class="strong"><strong>function</strong></span></span> () {
    <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">model</span>.<span class="olive">get</span>(<span class="maroon">"gps"</span>) &amp;&amp; <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">model</span>.<span class="olive">get</span>(<span class="maroon">"gps"</span>).<span class="olive">waypoints</span>) {
        <span class="steelblue"><span class="strong"><strong>if</strong></span></span> (<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">map</span>) {
            <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">map</span>.<span class="olive">remove</span>();
        }
        <span class="steelblue"><span class="strong"><strong>var</strong></span></span> points = <span class="olive">_</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">model</span>.<span class="olive">get</span>(<span class="maroon">"gps"</span>).<span class="olive">waypoints</span>).<span class="olive">map</span>(<span class="steelblue"><span class="strong"><strong>function</strong></span></span>(pt) {
            <span class="steelblue"><span class="strong"><strong>return</strong></span></span> [<span class="steelblue">pt</span>.<span class="olive">latitude</span>, <span class="steelblue">pt</span>.<span class="olive">longitude</span>];
        });
        <span class="steelblue"><span class="strong"><strong>var</strong></span></span> path = <span class="steelblue"><span class="strong"><strong>new</strong></span></span> <span class="steelblue">L</span>.<span class="olive">Polyline</span>(points, {<span class="dodgerblue">color</span>: <span class="maroon">"#1788cc"</span>});
        <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">map</span> = <span class="steelblue">L</span>.<span class="olive">map</span>(<span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="olive">id</span>).<span class="olive">fitBounds</span>(<span class="steelblue">path</span>.<span class="olive">getBounds</span>())
            .<span class="olive">addLayer</span>(path);
        <span class="steelblue"><span class="strong"><strong>var</strong></span></span> tiles = <span class="steelblue">L</span>.<span class="olive">tileLayer</span>(
            <span class="maroon">"http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/"</span>+
            <span class="maroon">"World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}"</span>,
            {
                <span class="dodgerblue">attribution</span>: <span class="maroon">"Tiles &amp;copy; Esri &amp;mdash; "</span>+
                             <span class="maroon">"Esri, DeLorme, NAVTEQ"</span>,
                <span class="dodgerblue">maxZoom</span>: <span class="red">16</span>
            }
        );
        <span class="steelblue"><span class="strong"><strong>this</strong></span></span>.<span class="steelblue">map</span>.<span class="olive">addLayer</span>(tiles);
    }
}</pre><p>As you can see from the code, we’re storing a reference to the Leaflet map object as a property of the view. From within the view, we can access that object using <code class="literal">this.map</code>.</p><p>The result is a nice map of the run’s route, shown in <a class="xref" href="ch09.html#map_view_shows_the_route_of_a_run" title="Figure 9-6. A map view shows the route of a run.">Figure 9-6</a>.</p><div class="figure"><a id="map_view_shows_the_route_of_a_run"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00142"/><img src="figs/web/09fig06.png.jpg" alt="A map view shows the route of a run."/></div></div><div class="figure-title">Figure 9-6. A map view shows the route of a run.</div></div></div><div class="sect2" title="Step 5: Implement the Charts View"><div class="titlepage"><div><div><h3 class="title" id="step_5_implement_the_charts_view">Step 5: Implement the Charts View</h3></div></div></div><p>The last remaining view that we need to implement is the Charts view, where we want to show pace, heart rate, and elevation during the run. This view is the most complex, but nearly all of the code is identical to the example in <a class="xref" href="ch02.html#tracking_data_values" title="Tracking Data Values">Tracking Data Values</a>, so there’s no need to repeat it here.</p><p>You can see the interactive result in <a class="xref" href="ch09.html#alternative_view_shows_charts_of_the_run" title="Figure 9-7. An alternative view shows charts of the run.">Figure 9-7</a>.</p><div class="figure"><a id="alternative_view_shows_charts_of_the_run"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00143"/><img src="figs/web/09fig07.png.jpg" alt="An alternative view shows charts of the run."/></div></div><div class="figure-title">Figure 9-7. An alternative view shows charts of the run.</div></div><p>The source code for the book includes the complete implementation. If you’re looking in detail at that implementation, there a few points to note:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Just as with Leaflet and the map container, Flot expects a container for its chart to be present in the web page. We can use the same <code class="literal">defer</code> trick to prevent Flot errors.</p></li><li class="listitem"><p>Nike+ returns at least four types of charts as metrics: distance, heart rate, speed, and GPS signal strength. We really only care about the first two. At first, it might seem easiest to calculate pace from speed, but speed isn’t present in all activities. Distance, however, is present, and we can derive pace from distance and time.</p></li><li class="listitem"><p>If GPS waypoint data is available, we can also graph elevation, but that data is in a separate attribute of the model (not the <code class="literal">metrics</code> attribute).</p></li><li class="listitem"><p>As of this writing, there’s a bit of a bug in Nike’s response for GPS data. It claims that the measurements are on the same time scale as the other metrics (every 10 seconds), but in fact the GPS measurements are reported on different intervals. To work around this bug, we ignore the reported interval and calculate one ourselves. Also, we want to normalize the elevation graph to the same time scale as all the others. Doing that will give us the additional benefit of averaging the GPS elevation data; averaging is useful here because GPS elevation measurements aren’t generally very accurate.</p></li></ul></div></div></div><div class="sect1" title="Summing Up"><div class="titlepage"><div><div><h2 class="title" style="clear: both" id="summing_up-id00043">Summing Up</h2></div></div></div><p>In this chapter, we’ve starting building an entire web application based on data and data visualizations. To help organize and coordinate our application, we based it on the Backbone.js library, and we relied on the Yeoman tool to create the application’s scaffolding and boilerplate code and templates. Backbone.js lets us separate our application into models and views so that the code responsible for managing the data doesn’t have to worry about how that data is presented (and vice versa).</p><p>In the next chapter, we’ll enable our application to communicate with the Nike+ interface, and we’ll add some finishing touches to improve user interaction with the page.</p></div></section></body></html>