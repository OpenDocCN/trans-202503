<html><head></head><body>
<div id="book-content">
<div id="sbo-rt-content"><section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" title="165" id="Page_165"/><a class="XrefDestination" id="11"/><span class="XrefDestination" id="xref-503007c11-001"/>11</span><br/>
<span class="ChapterTitle"><a class="XrefDestination" id="CreatingFunctionsandProcedures"/><span class="XrefDestination" id="xref-503007c11-002"/>Creating Functions and Procedures</span></h1>
</header>
<figure class="opener">
<img src="image_fi/book_art/chapterart.png" alt="" width="200" height="200"/>
</figure>
<p class="ChapterIntro">In <a class="xref" href="c08.xhtml">Chapter 8</a>, you learned how to call built-in MySQL functions; in this chapter, you’ll write your own. You’ll also learn to write procedures and explore the key differences between the two.</p>
<p>You’ll add logic to your functions and procedures using <code>if</code> statements, loops, cursors, and <code>case</code> statements to perform different tasks based on the value of your data. Lastly, you’ll practice accepting values in your functions and procedures and returning values.</p>
<h2 id="h1-503007c11-0001"><a class="XrefDestination" id="FunctionsvsProcedures"/><span class="XrefDestination" id="xref-503007c11-003"/>Functions vs. Procedures</h2>
<p class="BodyFirst">Functions and procedures are programs you can call by name. Because they’re saved in your MySQL database, they are sometimes called <em>stored</em> functions and procedures. Collectively, they are referred to as <em>stored routines</em> or <em>stored programs</em>. When you write a complex SQL statement or a group of statements with several steps, you should save it as a function or procedure so you can easily call it by name later.</p>
<p><span epub:type="pagebreak" title="166" id="Page_166"/>The main difference between a function and a procedure is that a function gets called from a SQL statement and always returns one value. A procedure, on the other hand, gets called explicitly using a <code>call</code> statement. Procedures also pass values back to the caller differently than functions. (Note that the caller may be a person using a tool like MySQL Workbench, a program written in a programming language like Python or PHP, or another MySQL procedure.) While procedures may return no values, one value, or many values, a function accepts arguments, performs some task, and returns a single value. For example, you might find the population of New York by calling the <code>f_get_state_population()</code> function from a <code>select</code> statement, passing in the state name as an argument to the function:</p>
<pre><code>select f_get_state_population('New York');</code></pre>
<p>You pass an argument to a function by putting it between the parentheses. To pass more than one argument, separate them by commas. The function accepts the argument, does some processing that you defined when you created the function, and returns a value:</p>
<pre><code>f_get_state_population('New York')
----------------------------------
              19299981</code></pre>
<p>The <code>f_get_state_population()</code> function took the text <code>New York</code> as an argument, did a lookup in your database to find the population, and returned <code>19299981</code>.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	Consider starting your custom functions with <code>f_</code> to make their role clear, as I’ve done here.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>You can also call functions in the <code>where</code> clause of SQL statements, such as the following example that returns every <code>state_population</code> greater than New York’s:</p>
<pre><code>select  *
from    state_population
where   population &gt; f_get_state_population('New York');</code></pre>
<p>Here, you called the function <code>f_get_state_population()</code> with an argument of <code>New York</code>. The function returned the value <code>19299981</code>, which caused your query to evaluate to the following:</p>
<pre><code>select  *
from    state_population
where   population &gt; 19299981;</code></pre>
<p>Your query returned data from the <code>state</code> table for states with a population greater than 19,299,981:</p>
<pre><code>state       population
----------  ----------
California   39613493
<span epub:type="pagebreak" title="167" id="Page_167"/>Texas        29730311
Florida      21944577</code></pre>
<p>Procedures, on the other hand, are not called from SQL queries, but instead via the <code>call</code> statement. You pass in any arguments the procedure has been designed to accept, the procedure performs the tasks you defined, and then control returns to the caller.</p>
<p>For example, you call a procedure named <code>p_set_state_population()</code> and pass it an argument of <code>New York</code> like so:</p>
<pre><code>call p_set_state_population('New York');</code></pre>
<p>You’ll see how to create the <code>p_set_state_population()</code> procedure and define its tasks in <a href="#listing11-2" id="listinganchor11-2">Listing 11-2</a>. For now, just know that this is the syntax for calling a procedure.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	Consider starting procedures with <code>p_</code> to make their role clear.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>Procedures are often used to execute business logic by updating, inserting, and deleting records in tables, and they can also be used to display a dataset from the database. Functions are used for smaller tasks, like getting one piece of data from the database or formatting a value. Sometimes you can implement the same functionality as either a procedure or a function.</p>
<p>Like tables and views, functions and procedures are saved in the database where you created them. You can set the current database with the <code>use</code> command; then, when you define a procedure or function, it will be created in that database.</p>
<p>Now that you’ve seen how to call functions and procedures, let’s look at how to create them.</p>
<h2 id="h1-503007c11-0002"><a class="XrefDestination" id="CreatingFunctions"/><span class="XrefDestination" id="xref-503007c11-004"/>Creating Functions</h2>
<p class="BodyFirst"><a href="#listing11-1" id="listinganchor11-1">Listing 11-1</a> defines the <code>f_get_state_population()</code> function, which accepts a state’s name and returns the population of the state.</p>
<pre><code><span class="CodeAnnotationHang" aria-label="annotation1">❶</span> use population;

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> drop function if exists f_get_state_population;

delimiter //

<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> create function f_get_state_population(
    state_param    varchar(100)
)
returns int
deterministic reads sql data
begin
    declare population_var int;

    select  population
    into    population_var
<span epub:type="pagebreak" title="168" id="Page_168"/>    from    state_population
    where   state = state_param;

    return(population_var);
<span class="CodeAnnotationHang" aria-label="annotation4">❹</span> end//

delimiter ;</code></pre>
<p class="CodeListingCaption"><a id="listing11-1">Listing 11-1</a>: Creating the <code>f_get_state_population()</code> function</p>
<p>In the first line, you set the current database to <code>population</code> with the <code>use</code> command <span class="CodeAnnotation" aria-label="annotation1">❶</span> so your function will be created in that database.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	Another way to accomplish this is to specify the database name in the <code>create function</code> statement by prefixing the function name with the database name and a period, like so:</p>
<pre><code>create function population.f_get_state_population(</code></pre>
<p class="Continued">For simplicity’s sake, I’ll continue using the approach shown in <a href="#listing11-1">Listing 11-1</a>.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>Before you create the function, you use the <code>drop function</code> statement in case there’s already a version of this function. If you try to create a function and an old version already exists, MySQL will send a <code>function already exists</code> error and won’t create the function. Similarly, if you try to drop a function that doesn’t already exist, MySQL will also send an error. To prevent that error from appearing, you add <code>if exists</code> after <code>drop function</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>, which will drop the function if it already exists, but won’t send an error if it doesn’t.</p>
<p>The function itself is defined between the <code>create function</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span> and <code>end</code> statements <span class="CodeAnnotation" aria-label="annotation4">❹</span>. We’ll walk through its components in the following sections.</p>
<h3 id="h2-503007c11-0001"><a class="XrefDestination" id="RedefiningtheDelimiter"/><span class="XrefDestination" id="xref-503007c11-005"/>Redefining the Delimiter</h3>
<p class="BodyFirst">The function definition also includes lines of code to redefine and then reset your delimiter. A <em>delimiter</em> is one or more characters that separate one SQL statement from another and mark the end of each statement. Typically, you’ll use a semicolon as the delimiter.</p>
<p>In <a href="#listing11-1">Listing 11-1</a>, you temporarily set the MySQL delimiter to <code>//</code> using the <code>delimiter //</code> statement because your function is made up of multiple SQL statements that end in a semicolon. For example, <code>f_get_state_population()</code> has three semicolons, located after the <code>declare</code> statement, the <code>select</code> statement, and the <code>return</code> statement. To ensure that MySQL creates your function starting with the <code>create function</code> statement and ending with the <code>end</code> statement, you need a way to tell it not to interpret any semicolons between those two statements as the end of your function. This is why you’ve redefined the delimiter.</p>
<p>Let’s take a look at what would happen if you didn’t redefine your delimiter. If you remove or comment out the <code>delimiter //</code> statement at the beginning of your code and look at it in MySQL Workbench, you’ll notice some red X markers on lines 12 and 19, indicating errors (<a href="#figure11-1" id="figureanchor11-1">Figure 11-1</a>).</p>
<span epub:type="pagebreak" title="169" id="Page_169"/><figure>
<img src="image_fi/503007c11/f11001.png" class="keyline" alt="" width="485" height="629"/>
<figcaption><p><a id="figure11-1">Figure 11-1</a>: MySQL Workbench showing errors on lines 12 and 19</p></figcaption>
</figure>
<p>You commented out the <code>delimiter</code> statement on line 5 by adding two hyphens and a space (<code>-- </code>) in front of it; this caused MySQL Workbench to report errors on lines 12 and 19 because the semicolon has become the delimiter character. Thus, every time MySQL encounters a semicolon, it assumes that is the end of a SQL statement. MySQL Workbench tries to help you by showing error markers with a red X to let you know the statements ending in semicolons aren’t valid.</p>
<p>Redefining the delimiter to <code>//</code> (or something other than <code>;</code>) informs MySQL Workbench that the statements creating your function aren’t over until it hits <code>//</code> at the end of line 21. You can fix the errors by uncommenting line 5 (removing the two hyphens and a space, <code>-- </code> , at the beginning of the line), thereby reinserting the <code>delimiter //</code> command.</p>
<p>After the function has been created, you set the delimiter back to the semicolon on line 23.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	The typical characters developers use to redefine the delimiter are <code>//</code>, <code>$$</code>, and occasionally <code>;;</code>.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p><span epub:type="pagebreak" title="170" id="Page_170"/>Although redefining the delimiter to <code>//</code> is necessary here because your function body contains three semicolons, there are other situations where you don’t need to redefine your delimiter. For example, you can simplify the following function:</p>
<pre><code>delimiter //
create function f_get_world_population()
returns bigint
deterministic no sql
begin
    return(7978759141);
end//

delimiter ;</code></pre>
<p>The <code>begin</code> and <code>end</code> keywords group statements that are part of the function body. Since this function body has only one SQL statement, returning the world population, you don’t need to use <code>begin</code> and <code>end</code> here. And you don’t need to redefine your delimiter, either, because there’s only one semicolon—at the end of the <code>return</code> statement. You can remove the code that redefines and resets the delimiter and simplify your function to this:</p>
<pre><code>create function f_get_world_population()
returns bigint
deterministic no sql
return(7978759141);</code></pre>
<p>While this is a more concise way to write the function, you might want to keep the <code>begin</code> and <code>end</code> statements and redefine the delimiter because it makes it easier to add a second SQL statement in the future. The choice is yours.</p>
<h3 id="h2-503007c11-0002"><a class="XrefDestination" id="AddingParametersandReturningaValue"/><span class="XrefDestination" id="xref-503007c11-006"/>Adding Parameters and Returning a Value</h3>
<p class="BodyFirst">Both built-in functions and custom functions can accept parameters. You created the <code>f_get_state_population()</code> function in <a href="#listing11-1">Listing 11-1</a> to accept one parameter named <code>state_param</code>, which has a <code>varchar(100)</code> data type. You can define parameters with the data types in <a class="xref" href="c04.xhtml">Chapter 4</a>, including <code>int</code>, <code>date</code>, <code>decimal</code>, and <code>text</code>, to define a table’s columns.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	Consider ending any parameters with <code>_param</code> to make their role clear.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>Because functions return a value to the caller of the function, you use the <code>returns</code> keyword in <a href="#listing11-1">Listing 11-1</a> to let MySQL know the data type of the value that your function will return. In this case, the function will return an integer, representing the population of a state.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2><span epub:type="pagebreak" title="171" id="Page_171"/><a class="XrefDestination" id="ParametersvsArguments"/><span class="XrefDestination" id="xref-503007c11-007"/>Parameters vs. Arguments</h2>
<p class="BoxBodyFirst">Some developers use the words <em>arguments</em> and <em>parameters</em> interchangeably, although there is a difference between the two. While arguments are the values that are passed to functions, parameters are the variables in the functions that receive those values.</p>
<p>The key point for you, however, is that you can call functions and send values to them, and write functions that receive those values. Functions can be written to accept no values at all, or they can be written to take a large number of them—even thousands. Typically, though, you won’t need to write a function that accepts more than 10 parameters.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-503007c11-0003"><a class="XrefDestination" id="SpecifyingCharacteristics"/><span class="XrefDestination" id="xref-503007c11-008"/>Specifying Characteristics</h3>
<p class="BodyFirst">In <a href="#listing11-1">Listing 11-1</a>, once you establish that your function returns an integer, you specify some characteristics of your function. A <em>characteristic</em> is an attribute or property of the function. In this example, you used the <code>deterministic</code> and <code>reads sql data</code> characteristics:</p>
<pre><code>deterministic reads sql data</code></pre>
<p>You can list the characteristics on one line, or you can list each characteristic on its own line, like so:</p>
<pre><code>deterministic
reads sql data</code></pre>
<p>You need to choose from two sets of characteristics: <code>deterministic</code> or <code>not deterministic</code>, and <code>reads sql data</code>, <code>modifies sql data</code>, <code>contains sql</code>, or <code>no sql</code>. You must specify at least one of these three characteristics for all of your functions: <code>deterministic</code>, <code>no sql</code>, or <code>reads sql data</code>. If you don’t, MySQL will send an error message and won’t create your function.</p>
<h4 id="h3-503007c11-0001"><a class="XrefDestination" id="deterministicornotdeterministic"/><span class="XrefDestination" id="xref-503007c11-009"/>deterministic or not deterministic</h4>
<p class="BodyFirst">Choosing <code>deterministic</code> means the function will return the same value given the same arguments and the same state of the database. This is usually the case. The <code>f_get_state_population()</code> function is deterministic because, unless the data in the database changes, every time you call <code>f_get_state_population()</code> with an argument of <code>New York</code>, the function will return the value <code>19299981</code>.</p>
<p>The <code>not deterministic</code> characteristic means that the function may not return the same value given the same arguments and the same state of the database. This would be the case for a function that returns the current date, for example, as calling it today will yield a different return value than calling it tomorrow.</p>
<p><span epub:type="pagebreak" title="172" id="Page_172"/>If you tag a nondeterministic function as <code>deterministic</code>, you might get incorrect results when you call your function. If you tag a deterministic function as <code>not deterministic</code>, your function might run slower than necessary. If you don’t define a function as <code>deterministic</code> or <code>not deterministic</code>, MySQL defaults to <code>not deterministic</code>.</p>
<p>MySQL uses <code>deterministic</code> or <code>not deterministic</code> for two purposes. First, MySQL has a query optimizer that determines the fastest way to execute queries. Specifying <code>deterministic</code> or <code>not deterministic</code> helps the query optimizer make good execution choices.</p>
<p>Second, MySQL has a binary log that keeps track of changes to data in the database. The binary log is used to perform <em>replication</em>, a process in which data from one MySQL database server is copied to another server, known as a <em>replica</em>. Specifying <code>deterministic</code> or <code>not deterministic</code> helps MySQL perform this replication.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	Your database administrator can remove the requirement to tag functions as <code>deterministic</code> or <code>not deterministic</code> by setting the <code>log_bin_trust_function_creators</code> configuration variable to <code>ON</code>.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h4 id="h3-503007c11-0002"><a class="XrefDestination" id="readssqldata,modifiessqldata,containssql,ornosql"/><span class="XrefDestination" id="xref-503007c11-010"/>reads sql data, modifies sql data, contains sql, or no sql</h4>
<p class="BodyFirst">The <code>reads sql</code> <code>data</code> characteristic means that the function reads from the database using <code>select</code> statements but doesn’t update, delete, or insert any data; <code>modifies sql data</code>, on the other hand, means that the function does update, delete, or insert data. This would be the case more for procedures than for functions because procedures are more commonly used for modifying data in the database than functions are.</p>
<p>The <code>contains sql</code> characteristic means the function has at least one SQL statement but doesn’t read or write any data from the database, and <code>no sql</code> means the function contains no SQL statements. An example of <code>no sql</code> would be a function that returns a hardcoded number, in which case it doesn’t query the database. You could, for example, write a function that always returns <code>212</code> so that you don’t need to remember the temperature at which water boils.</p>
<p>If you don’t specify <code>reads sql data</code>, <code>modifies sql data</code>, <code>contains sql</code>, or <code>no sql</code>, MySQL defaults to <code>contains sql</code>.</p>
<h3 id="h2-503007c11-0004"><a class="XrefDestination" id="DefiningtheFunctionBody"/><span class="XrefDestination" id="xref-503007c11-011"/>Defining the Function Body</h3>
<p class="BodyFirst">After listing the characteristics, you define the function body, the block of code that gets executed when the function is called. You use a <code>begin</code> and an <code>end</code> statement to mark the beginning and end of the function body.</p>
<p>In <a href="#listing11-1">Listing 11-1</a>, you declared a variable named <code>population_var</code> with the <code>declare</code> keyword. Variables are named objects that can hold values. You can declare them with any of the MySQL data types; in this case, you used the <code>int</code> type. You’ll learn about different types of variables in the section <span class="xref" itemid="xref_target_“LocalVariablesandUserVariables”">“Defining Local Variables and User Variables”</span> later in the chapter.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">NOTE</span></h2>
<p>	Consider ending your variables with <code>_var</code> to make their role clear.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p><span epub:type="pagebreak" title="173" id="Page_173"/>Then you add a <code>select</code> statement that selects the population from your database and writes it into your <code>population_var</code> variable. This <code>select</code> statement is similar to those you’ve used before, except you’re now using the <code>into</code> keyword to select the value you got from the database into a variable.</p>
<p>You then return the value of <code>population_var</code> to the caller of the function with a <code>return</code> statement. Since functions always return one value, there must be a <code>return</code> statement in your function. The data type of the value being returned must match the <code>returns</code> statement at the beginning of the function. You use <code>returns</code> to declare the data type of the value you’ll return, and <code>return</code> to actually return the value.</p>
<p>Your <code>end</code> statement is followed by <code>//</code> because you redefined your delimiter to <code>//</code> earlier. Once you reach the <code>end</code> statement, your function body is complete, so you redefine your delimiter back to a semicolon.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="boxcustom1">
<h2>Try it Yourself</h2>
<p class="BoxListNumberCustom1"><b>11-1.</b>	In the <code>diet</code> database, the <code>calorie</code> table contains the following data:</p>
<pre><code>food    calorie_count
------  -------------
banana       110
pizza        700
apple        185</code></pre>
<p class="ListBody">Write a function called <code>f_get_calorie_count()</code> that accepts the name of a food as a parameter and returns the calorie count. The <code>food</code> parameter should be defined as <code>varchar(100)</code>. The characteristics should be <code>deterministic</code> and <code>reads sql data</code>.</p>
<p class="ListBody">You can test the function by calling it like so:</p>
<pre><code>select f_get_calorie_count('pizza');</code></pre>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-503007c11-0003"><a class="XrefDestination" id="CreatingProcedures"/><span class="XrefDestination" id="xref-503007c11-013"/>Creating Procedures</h2>
<p class="BodyFirst">Similar to functions, procedures accept parameters, include a code block surrounded by <code>begin</code> and <code>end</code>, can have defined variables, and can have a redefined delimiter.</p>
<p>Unlike functions, procedures don’t use the <code>returns</code> or <code>return</code> keyword because procedures don’t return one value in the way that functions do. Also, you can display values in procedures using the <code>select</code> keyword. Additionally, while MySQL requires you to specify characteristics like <code>deterministic</code> or <code>reads sql data</code> when creating functions, this is not required for procedures.</p>
<p><a href="#listing11-2">Listing 11-2</a> creates a procedure called <code>p_set_state_population()</code> that accepts a parameter for the state’s name, gets the latest population values <span epub:type="pagebreak" title="174" id="Page_174"/>for each county in the state from the <code>county_population</code> table, sums the populations, and writes the total population to the <code>state_population</code> table.</p>
<pre><code><span class="CodeAnnotationHang" aria-label="annotation1">❶</span> use population;

<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> drop procedure if exists p_set_state_population;

<span class="CodeAnnotationHang" aria-label="annotation3">❸</span> delimiter //

<span class="CodeAnnotationHang" aria-label="annotation4">❹</span> create procedure p_set_state_population(
  <span class="CodeAnnotationCode" aria-label="annotation5">❺</span> in state_param varchar(100)
)
begin
  <span class="CodeAnnotationCode" aria-label="annotation6">❻</span> delete from state_population
    where state = state_param;

  <span class="CodeAnnotationCode" aria-label="annotation7">❼</span> insert into state_population
    (
           state,
           population
    )
    select state,
         <span class="CodeAnnotationCode" aria-label="annotation8">❽</span> sum(population)
    from   county_population
    where  state = state_param
    group by state;

<span class="CodeAnnotationHang" aria-label="annotation9">❾</span> end//

delimiter ;</code></pre>
<p class="CodeListingCaption"><a id="listing11-2">Listing 11-2</a>: Creating the <code>p_set_state_population()</code> procedure</p>
<p>First, you set your current database to <code>population</code> with <code>use</code> so the procedure will be created in the <code>population</code> database <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Before creating the procedure, you check to see if it already exists, and if it does, the old version is deleted with the <code>drop</code> command <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Then you redefine your delimiter to <code>//</code> just as you did when creating functions <span class="CodeAnnotation" aria-label="annotation3">❸</span>.</p>
<p>Next, you create the procedure and call it <code>p_set_state_population() </code><span class="CodeAnnotation" aria-label="annotation4">❹</span>. As with functions, you name the parameter <code>state_param</code> and give it a <code>varchar(100)</code> data type, and you also specify <code>in</code> to set <code>state_param</code> as an input parameter <span class="CodeAnnotation" aria-label="annotation5">❺</span>. Let’s look at this step a little closer.</p>
<p>Unlike functions, procedures can accept parameter values as input and also pass values back to the caller as output. They can also accept multiple input and output parameters. (You’ll explore output parameters in depth later in this chapter.) When you write procedures, you specify the type of parameter using the keyword <code>in</code> for input, <code>out</code> for output, or <code>inout</code> for parameters that are both. This specification isn’t necessary for functions because function parameters are always assumed to be input. If you don’t specify <code>in</code>, <code>out</code>, or <code>inout</code> for your procedure parameters, MySQL defaults to <code>in</code>.</p>
<p>Next, the procedure body is between the <code>begin</code> and <code>end</code> statements. In this body, you delete the existing row in the <code>state_population</code> table for <span epub:type="pagebreak" title="175" id="Page_175"/>the state (if one exists) <span class="CodeAnnotation" aria-label="annotation6">❻</span>, then insert a new row into the <code>state_population</code> table <span class="CodeAnnotation" aria-label="annotation7">❼</span>. If you don’t delete the existing row(s) first, the table will have a row for every time you run the procedure. You want to start with a clean slate before you write the current information to the <code>state_population</code> table.</p>
<p>You get the state’s population by summing the populations of the individual counties in that state from the <code>county_population</code> table <span class="CodeAnnotation" aria-label="annotation8">❽</span>.</p>
<p>As you did with functions, when you’re done defining the procedure you redefine your delimiter to a semicolon <span class="CodeAnnotation" aria-label="annotation9">❾</span>.</p>
<h3 id="h2-503007c11-0005"><a class="XrefDestination" id="UsingselecttoDisplayValues"/><span class="XrefDestination" id="xref-503007c11-014"/>Using select to Display Values</h3>
<p class="BodyFirst">When you create procedures and functions, you can use the <code>select...into</code> syntax to write a value from the database into a variable. But unlike functions, procedures can also use <code>select</code> statements without the <code>into</code> keyword to display values.</p>
<p><a href="#listing11-3" id="listinganchor11-3">Listing 11-3</a> creates a procedure called <code>p_set_and_show_state_population()</code> to select the population of the state into a variable and then display a message to the procedure caller.</p>
<pre><code>use population;

drop procedure if exists p_set_and_show_state_population;

delimiter //

create procedure p_set_and_show_state_population(
    in state_param varchar(100)
)
begin
  <span class="CodeAnnotationCode" aria-label="annotation1">❶</span> declare population_var int;

    delete from state_population
    where state = state_param;

  <span class="CodeAnnotationCode" aria-label="annotation2">❷</span> select sum(population)
    into   population_var
    from   county_population
    where  state = state_param;

  <span class="CodeAnnotationCode" aria-label="annotation3">❸</span> insert into state_population
    (
           state,
           population
    )
    values
    (
           state_param,
           population_var
    );

  <span class="CodeAnnotationCode" aria-label="annotation4">❹</span> select concat(
               'Setting the population for ',
               state_param,
<span epub:type="pagebreak" title="176" id="Page_176"/>               ' to ',
               population_var
            );
end//

delimiter ;</code></pre>
<p class="CodeListingCaption"><a id="listing11-3">Listing 11-3</a>: Creating the <code>p_set_and_show_state_population()</code> procedure</p>
<p>In this procedure, you declare a variable called <code>population_var</code> as an integer <span class="CodeAnnotation" aria-label="annotation1">❶</span> and insert the sum of the county populations into it using a <code>select...into</code> statement <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Then you insert the <code>state_param</code> parameter value and the <code>population_var</code> variable value into your <code>state_population</code> table <span class="CodeAnnotation" aria-label="annotation3">❸</span>.</p>
<p>When you call the procedure, it not only sets the correct population of New York in the <code>state_population</code> table, but also displays an informative message:</p>
<pre><code>call p_set_and_show_state_population('New York');</code></pre>
<p>The message displayed is:</p>
<pre><code>Setting the population for New York to 20201249</code></pre>
<p>You used <code>select</code> to display the message, which you built by concatenating (using the <code>concat()</code> function), the text <code>Setting the population for</code>, the <code>state_param</code> value, the word <code>to</code>, and the <code>population_var</code> value <span class="CodeAnnotation" aria-label="annotation4">❹</span>.</p>
<h3 id="h2-503007c11-0006"><a class="XrefDestination" id="DefiningLocalVariablesandUserVariables"/><span class="XrefDestination" id="xref-503007c11-015"/>Defining Local Variables and User Variables</h3>
<p class="BodyFirst">The <code>population_var</code> variable is a local variable. <em>Local variables</em> are variables that you define in your procedures and functions using the <code>declare</code> command with a data type:</p>
<pre><code>declare population_var int;</code></pre>
<p>Local variables are only available—or <em>in scope</em>—during the execution of the procedure or function containing them. Because you’ve defined <code>population_var</code> as an <code>int</code>, it will accept only integer values.</p>
<p>You can also use a <em>user variable</em>, which starts with the at sign (<code>@</code>) and can be used for the entire length of your session. As long as you’re connected to your MySQL server, the user variable will be in scope. If you create a user variable from MySQL Workbench, for example, it will be available until you close the tool.</p>
<p>When creating a local variable, you must specify its data type; when creating a user variable, it’s not necessary.</p>
<p>You might see code in a function or procedure that uses both local variables and user variables:</p>
<pre><code>declare local_var int;
set local_var = 2;
set @user_var = local_var + 3;</code></pre>
<p><span epub:type="pagebreak" title="177" id="Page_177"/>You never declared the <code>@user_var</code> variable with a data type like <code>int</code>, <code>char</code>, or <code>bool</code>, but because it was being set to an integer value (the <code>local_var</code> value plus 3), MySQL automatically set it to <code>int</code> for you.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="box">
<h2><a class="XrefDestination" id="FunwithUserVariables"/><span class="XrefDestination" id="xref-503007c11-016"/>Fun with User Variables</h2>
<p class="BoxBodyFirst">Create a function in the <code>weird_math</code> database called <code>f_math_trick()</code>:</p>
<pre><code>use weird_math;

drop function if exists f_math_trick;

delimiter //

create function f_math_trick(
    input_param   int
)
returns int
no sql
begin
    set @a = input_param;
    set @b = @a * 3;
    set @c = @b + 6;
    set @d = @c / 3;
    set @e = @d - @a;

    return(@e);
end//

delimiter ;</code></pre>
<p>The function takes an integer parameter and returns an integer value. You’re using several user variables—<code>@a</code>, <code>@b</code>, <code>@c</code>, <code>@d</code>, and <code>@e</code>—to perform mathematical calculations based on the value of the input argument. The function takes the <code>input_param</code> parameter value and utilizes user variables to multiply it by 3, add 6, divide by 3, and subtract the parameter value. At the end of the function, you return the value of the <code>@e</code> user variable.</p>
<p>You can run the function like so:</p>
<pre><code>select f_math_trick(12);</code></pre>
<p>The result is:</p>
<pre><code>f_math_trick(12)
----------------
       2</code></pre>
<p><span epub:type="pagebreak" title="178" id="Page_178"/>You passed the <code>f_math_trick()</code> function an argument of <code>12</code>, and the function returned <code>2</code>. Try testing other values by calling the function three times with the arguments <code>-28</code>, <code>0</code>, and <code>175</code>.</p>
<pre><code>select f_math_trick(-28),
       f_math_trick(0),
       f_math_trick(175);

f_math_trick(-28)    f_math_trick(0)   f_math_trick(175)
-----------------    ---------------   -----------------
        2                   2                  2</code></pre>
<p>No matter what value you send as an argument to this function, it always returns <code>2</code>!</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-503007c11-0007"><a class="XrefDestination" id="UsingLogicinProcedures"/><span class="XrefDestination" id="xref-503007c11-017"/>Using Logic in Procedures</h3>
<p class="BodyFirst">In procedures, you can use similar programming logic to what you’d use in programming languages like Python, Java, or PHP. For example, you can control the flow of execution with conditional statements like <code>if</code> and <code>case</code> to execute parts of your code under specific conditions. You can also use loops to repeatedly execute parts of your code.</p>
<h4 id="h3-503007c11-0003"><a class="XrefDestination" id="ifStatements"/><span class="XrefDestination" id="xref-503007c11-018"/>if Statements</h4>
<p class="BodyFirst">An <code>if</code> statement is a decision-making statement that executes particular lines of code if a condition is true. <a href="#listing11-4" id="listinganchor11-4">Listing 11-4</a> creates a procedure called <code>p_compare_population()</code> that compares the population in the <code>state_population</code> table to the <code>county_population</code> table. If the population values match, it returns one message. If they don’t, it returns another.</p>
<pre><code>use population;

drop procedure if exists p_compare_population;

delimiter //

create procedure p_compare_population(
    in state_param varchar(100)
)
begin
    declare state_population_var int;
    declare county_population_var int;

    select  population
  <span class="CodeAnnotationCode" aria-label="annotation1">❶</span> into    state_population_var
    from    state_population
    where   state = state_param;

<span epub:type="pagebreak" title="179" id="Page_179"/>    select sum(population)
  <span class="CodeAnnotationCode" aria-label="annotation2">❷</span> into   county_population_var
    from   county_population
    where  state = state_param;

  <span class="CodeAnnotationCode" aria-label="annotation3">❸</span> if (state_population_var = county_population_var) then
       select 'The population values match';
  <span class="CodeAnnotationCode" aria-label="annotation4">❹</span> else
       select 'The population values are different';
    end if;

end//

delimiter ;</code></pre>
<p class="CodeListingCaption"><a id="listing11-4">Listing 11-4</a>: The <code>p_compare_population()</code> procedure</p>
<p>In the first <code>select</code> statement, you select the population for the state from the <code>state_population</code> table and write it into the <code>state_population_var</code> variable <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Then, in the second <code>select</code> statement, you select the sum of the populations for each county in the state from the <code>county_population</code> table and write it into the <code>county_population_var</code> variable <span class="CodeAnnotation" aria-label="annotation2">❷</span>. You compare the two variables with the <code>if...then</code> syntax. You’re saying <code>if</code> the values match <span class="CodeAnnotation" aria-label="annotation3">❸</span>, <code>then</code> execute the line that displays the message <code>The population values match</code>; <code>else</code> (otherwise) <span class="CodeAnnotation" aria-label="annotation4">❹</span>, execute the next line, displaying the message <code>The population values are different</code>. Then you use <code>end if</code> to mark the end of the <code>if</code> statement.</p>
<p>You call the procedure using the following <code>call</code> statement:</p>
<pre><code>call p_compare_population('New York');</code></pre>
<p>The result is:</p>
<pre><code>The population values are different</code></pre>
<p>The procedure shows that the values in the two tables don’t match. Perhaps the population table for the counties contains updated data, but the <code>state_population</code> table hasn’t been updated yet.</p>
<p>MySQL provides the <code>elseif</code> keyword to check for more conditions. You could expand your <code>if</code> statement to display one of <em>three</em> messages:</p>
<pre><code>if (state_population_var = county_population_var) then
    select 'The population values match';
<b>elseif (state_population_var &gt; county_population_var) then</b>
<b>    select 'State population is more than the sum of county population';</b>
else
    select 'The sum of county population is more than the state population';
end if;</code></pre>
<p>The first condition checks whether the <code>state_population_var</code> value equals the <code>county_population_var</code> value. If that condition is true, the code displays the text <code>The population values match</code> and control flows to the <code>end if</code> statement.</p>
<p><span epub:type="pagebreak" title="180" id="Page_180"/>If the first condition was not met, the code checks the <code>elseif</code> condition, which sees if <code>state_population_var</code> is greater than <code>county_population_var</code>. If that condition is true, your code displays the text <code>State population is more than the sum of county population</code> and control flows to the <code>end if</code> statement.</p>
<p>If neither condition is met, control flows to the <code>else</code> statement, the code displays <code>The sum of county population is more than the state population</code>, and control drops down to the <code>end if</code> statement.</p>
<h4 id="h3-503007c11-0004"><a class="XrefDestination" id="caseStatements"/><span class="XrefDestination" id="xref-503007c11-019"/>case Statements</h4>
<p class="BodyFirst">A <code>case</code> statement is a way to write complex conditional statements. For example, <a href="#listing11-5" id="listinganchor11-5">Listing 11-5</a> defines a procedure that uses a <code>case</code> statement to determine if a state has more than 30 million people, between 10 and 30 million people, or less than 10 million people.</p>
<pre><code>use population;

drop procedure if exists p_population_group;

delimiter //

create procedure p_population_group(
    in state_param varchar(100)
)
begin
    declare state_population_var int;

    select population
    into   state_population_var
    from   state_population
    where  state = state_param;

    case
    <span class="CodeAnnotationCode" aria-label="annotation1">❶</span> when state_population_var &gt; 30000000 then select 'Over 30 Million';
    <span class="CodeAnnotationCode" aria-label="annotation2">❷</span> when state_population_var &gt; 10000000 then select 'Between 10M and 30M';
    <span class="CodeAnnotationCode" aria-label="annotation3">❸</span> else select 'Under 10 Million';
    end case;

end//

delimiter ;</code></pre>
<p class="CodeListingCaption"><a id="listing11-5">Listing 11-5</a>: The <code>p_population_group()</code> procedure</p>
<p>Your <code>case</code> statement begins with <code>case</code> and ends with <code>end case</code>. It has two <code>when</code> conditions—which are similar to <code>if</code> statements—and an <code>else</code> statement.</p>
<p>When the condition <code>state_population_var &gt; 30000000</code> is true, the procedure displays <code>Over 30 Million</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span> and control flows to the <code>end case</code> statement.</p>
<p>When the condition <code>state_population_var &gt; 10000000</code> is true, the procedure displays <code>Between 10M and 30M</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span> and control flows to the <code>end case</code> statement.</p>
<p><span epub:type="pagebreak" title="181" id="Page_181"/>If neither <code>when</code> condition was met, the <code>else</code> statement is executed, the procedure displays <code>Under 10 Million</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span>, and control drops down to the <code>end case</code> statement.</p>
<p>You can call your procedure to find out which group a state falls into:</p>
<pre><code>call p_population_group('California');
Over 30 Million

call p_population_group('New York');
Between 10M and 30M

call p_population_group('Rhode Island');
Under 10 Million</code></pre>
<p>Based on the population retrieved from the database for the state, the <code>case</code> statement displays the correct population grouping for that state.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="boxcustom1">
<h2>Try it Yourself</h2>
<p class="BoxListNumberCustom1"><b>11-2.</b>	The <code>age</code> database contains the following table, called <code>family_member_age</code>, that contains family members’ names and ages:</p>
<pre><code>person   age
-------  ---
Junior     7
Ricky     16
Grandpa  102</code></pre>
<p class="ListBody">Create a procedure called <code>p_get_age_group()</code> that takes a parameter of the family member’s name and returns an age group. If the family member is less than 13 years old, the procedure should display the <code>Child</code> age group. If the family member is between 13 and 20 years old, the procedure should display the <code>Teenager</code> age group. Anybody else’s age group should appear as <code>Adult</code>.</p>
<p class="ListBody">You can test the procedure like so:</p>
<pre><code>call p_get_age_group('Ricky');</code></pre>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h4 id="h3-503007c11-0005"><a class="XrefDestination" id="Loops"/><span class="XrefDestination" id="xref-503007c11-021"/>Loops</h4>
<p class="BodyFirst">You can create <em>loops</em> in your procedures to execute parts of your code repeatedly. MySQL allows you to create simple loops, <code>repeat</code> loops, and <code>while</code> loops. This procedure uses a simple loop to display the text <code>Looping Again</code> over and over:</p>
<pre><code>drop procedure if exists p_endless_loop;

delimiter //
<span epub:type="pagebreak" title="182" id="Page_182"/>create procedure p_endless_loop()
begin
<b>loop</b>
<b>  select 'Looping Again';</b>
<b>end loop;</b>
end;
//
delimiter ;</code></pre>
<p>Now call the procedure:</p>
<pre><code>call p_endless_loop();</code></pre>
<p>You mark the beginning and end of your loop with the <code>loop</code> and <code>end loop</code> commands. The commands between them will be executed repeatedly.</p>
<p>This procedure displays the text <code>Looping Again</code> over and over, theoretically forever. This is called an <em>endless loop</em> and should be avoided. You created the loop but didn’t provide a way for it to stop. Whoops!</p>
<p>If you run this procedure in SQL Workbench, it opens a different result tab to display the text <code>Looping Again</code> each time you go through the loop. Thankfully, MySQL eventually senses that too many result tabs have been opened and gives you the option to stop running your procedure (<a href="#figure11-2" id="figureanchor11-2">Figure 11-2</a>).</p>
<figure>
<img src="image_fi/503007c11/f11002.png" class="keyline" alt="" width="694" height="496"/>
<figcaption><p><a id="figure11-2">Figure 11-2</a>: Running an endless loop in MySQL Workbench</p></figcaption>
</figure>
<p><span epub:type="pagebreak" title="183" id="Page_183"/>To avoid creating endless loops, you must design loops to end when some condition has been met. This procedure uses a more sensible simple loop that loops 10 times and then stops:</p>
<pre><code>drop procedure if exists p_more_sensible_loop;

delimiter //
create procedure p_more_sensible_loop()
begin
<span class="CodeAnnotationHang" aria-label="annotation1">❶</span> set @cnt = 0;
<span class="CodeAnnotationHang" aria-label="annotation2">❷</span> msl: loop
  select 'Looping Again';
<span class="CodeAnnotationCode" aria-label="annotation3">❸</span> set @cnt = @cnt + 1;
<span class="CodeAnnotationCode" aria-label="annotation4">❹</span> if @cnt = 10 then
  <span class="CodeAnnotationCode" aria-label="annotation5">❺</span> leave msl;
  end if;
end loop msl;
end;
//
delimiter ;</code></pre>
<p>In this procedure you define a user variable called <code>@cnt</code> (short for <em>counter</em>) and set it to <code>0</code> <span class="CodeAnnotation" aria-label="annotation1">❶</span>. You label the loop <code>msl</code> (for <em>more sensible loop</em>) by preceding the <code>loop</code> statement with <code>msl:</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. Each time you go around in the loop, you add 1 to <code>@cnt</code> <span class="CodeAnnotation" aria-label="annotation3">❸</span>. In order for the loop to end, the value of <code>@cnt</code> must reach <code>10</code> <span class="CodeAnnotation" aria-label="annotation4">❹</span>. Once it does, you exit the loop using the <code>leave</code> command with the name of the loop you want to exit, <code>msl</code> <span class="CodeAnnotation" aria-label="annotation5">❺</span>.</p>
<p>When you call this procedure, it runs the code between the <code>loop</code> and <code>end loop</code> statements 10 times, displaying <code>Looping Again</code> each time. After the code has been executed 10 times, the loop stops, control drops to the line after the <code>end loop</code> statement, and the procedure returns control to the caller.</p>
<p>You can also code a <code>repeat</code> loop with the <code>repeat...until</code> syntax, like so:</p>
<pre><code>drop procedure if exists p_repeat_until_loop;

delimiter //
create procedure p_repeat_until_loop()
begin
set @cnt = 0;
<b>repeat</b>
<b>   select 'Looping Again';</b>
<b>   set @cnt = @cnt + 1;</b>
<b>until @cnt = 10</b>
<b>end repeat;</b>
end;
//
delimiter ;</code></pre>
<p><span epub:type="pagebreak" title="184" id="Page_184"/>The code between <code>repeat</code> and <code>end repeat</code> is the body of your loop. The commands between them will be executed repeatedly until <code>@cnt</code> equals <code>10</code> and then control will drop down to the <code>end</code> statement. The <code>until</code> statement is at the end of the loop, so the commands in your loop will be executed at least once, because the condition <code>until @cnt = 10</code> isn’t checked until you’ve gone through the loop the first time.</p>
<p>You can also code a <code>while</code> loop using the <code>while</code> and <code>end while</code> statements:</p>
<pre><code>drop procedure if exists p_while_loop;

delimiter //
create procedure p_while_loop()
begin
set @cnt = 0;
<b>while @cnt &lt; 10 do</b>
<b>    select 'Looping Again';</b>
<b>    set @cnt = @cnt + 1;</b>
<b>end while;</b>
end;
//
delimiter ;</code></pre>
<p>Your <code>while</code> command specifies the condition that must be met in order for the commands in the loop to be executed. If your condition <code>@cnt &lt; 10</code> is met, the procedure will <code>do</code> the commands in the loop. When the <code>end while</code> statement is reached, control flows back to the <code>while</code> command and you check again if <code>@cnt</code> is still less than <code>10</code>. Once your counter is no longer less than 10, control flows to the <code>end</code> command and the loop ends.</p>
<p>Loops are a handy way to repeat functionality when you need to perform similar tasks again and again. Don’t forget to give your loops a way to exit so that you avoid writing endless loops, and if you need your loop to execute at least one time, use the <code>repeat...until</code> syntax.</p>
<h3 id="h2-503007c11-0008"><a class="XrefDestination" id="DisplayingProcedureResultswithselect"/><span class="XrefDestination" id="xref-503007c11-022"/>Displaying Procedure Results with select</h3>
<p class="BodyFirst">Since you can use the <code>select</code> statement in procedures, you can write procedures that query data from the database and display the results. When you write a query you’ll need to run again, you can save it as a procedure and call the procedure whenever you need it.</p>
<p>Say you wrote a query that selects the populations of all counties in a state, formats them with commas, and orders the counties from largest to smallest. You might want to save your work as a procedure and name it <code>p_get_county_population()</code>, like so:</p>
<pre><code>use population;

drop procedure if exists p_get_county_population;

<span epub:type="pagebreak" title="185" id="Page_185"/>delimiter //

create procedure p_get_county_population(
    in state_param varchar(100)
)
begin
    select county,
           format(population, 0)
    from   county_population
    where  state = state_param
    order by population desc;
end//

delimiter ;</code></pre>
<p>With that procedure in place, you can call it each time you need that information:</p>
<pre><code>call p_get_county_population('New York');</code></pre>
<p>The results show all 62 counties in New York, with their populations formatted appropriately:</p>
<pre><code>Kings          2,736,074
Queens         2,405,464
New York       1,694,251
Suffolk        1,525,920
Bronx          1,472,654
Nassau         1,395,774
Westchester    1,004,457
Erie             954,236
<var>--snip--</var></code></pre>
<p>The next time you want to see the latest version of this data, you can just call the procedure again.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="boxcustom1">
<h2>Try it Yourself</h2>
<p class="BoxListNumberCustom1"><b>11-3.</b>	Create a <code>diet</code> database and a procedure called <code>p_get_food()</code> that takes no parameters. The procedure should display the <code>food</code> and <code>calorie_count</code> columns from the <code>calorie</code> table. Order the results, showing foods with the highest <code>calorie_count</code> value first and the lowest <code>calorie_count</code> last.</p>
<p class="ListBody">You can test the procedure by calling it like so:</p>
<pre><code>call p_get_food();</code></pre>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p><span epub:type="pagebreak" title="186" id="Page_186"/>Using <code>select</code> in your procedure displays your results. You can also pass values back to the caller of the procedure using the <code>output</code> parameter.</p>
<h3 id="h2-503007c11-0009"><a class="XrefDestination" id="UsingaCursor"/><span class="XrefDestination" id="xref-503007c11-024"/>Using a Cursor</h3>
<p class="BodyFirst">While SQL is very good at quickly updating or deleting many rows in a table at once, you’ll occasionally need to loop through a dataset and process it one row at a time. You can accomplish this with a cursor.</p>
<p>A <em>cursor</em> is a database object that selects rows from the database, holds them in memory, and allows you to loop through them one at a time. To use a cursor, first declare the cursor, then open it, fetch each row from it, and close it. These steps are shown in <a href="#figure11-3" id="figureanchor11-3">Figure 11-3</a>.</p>
<figure>
<img src="image_fi/503007c11/f11003.png" class="" alt="" width="271" height="410"/>
<figcaption><p><a id="figure11-3">Figure 11-3</a>: Steps for using a cursor</p></figcaption>
</figure>
<p>Create a procedure called <code>p_split_big_ny_counties()</code> that uses a cursor. The procedure will use the <code>county_population</code> table, which contains the population of each county within a state. New York has 62 counties, the largest of which are shown here:</p>
<pre><code>county       population
-----------  ----------
Kings         2,736,074
Queens        2,405,464
New York      1,694,251
Suffolk       1,525,920
Bronx         1,472,654
Nassau        1,395,774
Westchester   1,004,457</code></pre>
<p><span epub:type="pagebreak" title="187" id="Page_187"/>Imagine you’re a database developer working for the State of New York. You’ve been asked to break up counties that have over 2 million people into two smaller counties, each containing half of the original county’s population.</p>
<p>For example, Kings County has a population of 2,736,074 people. You have been asked to create a county called <code>Kings-1</code> with 1,368,037 people and another called <code>Kings-2</code> with the remaining 1,368,037. Then you need to delete the original <code>Kings</code> row that had a population of 2,736,074. You could write the procedure shown in <a href="#listing11-6" id="listinganchor11-6">Listing 11-6</a> to accomplish this task.</p>
<pre><code>drop procedure if exists p_split_big_ny_counties;

delimiter //

create procedure p_split_big_ny_counties()
begin
<span class="CodeAnnotationCode" aria-label="annotation1">❶</span> declare  v_state       varchar(100);
  declare  v_county      varchar(100);
  declare  v_population  int;

<span class="CodeAnnotationCode" aria-label="annotation2">❷</span> declare done bool default false;

<span class="CodeAnnotationCode" aria-label="annotation3">❸</span> declare county_cursor cursor for
    select  state,
            county,
            population
    from    county_population
    where   state = 'New York'
    and     population &gt; 2000000;

<span class="CodeAnnotationCode" aria-label="annotation4">❹</span> declare continue handler for not found set done = true;

<span class="CodeAnnotationCode" aria-label="annotation5">❺</span> open county_cursor;

<span class="CodeAnnotationCode" aria-label="annotation6">❻</span> fetch_loop: loop
    fetch county_cursor into v_state, v_county, v_population;

  <span class="CodeAnnotationCode" aria-label="annotation7">❼</span> if done then
      leave fetch_loop;
    end if;

  <span class="CodeAnnotationCode" aria-label="annotation8">❽</span> set @cnt = 1;

  <span class="CodeAnnotationCode" aria-label="annotation9">❾</span> split_loop: loop

      insert into county_population
      (
        state,
        county,
        population
      )
<span epub:type="pagebreak" title="188" id="Page_188"/>      values
      (
        v_state,
        concat(v_county, '-', @cnt),
        round(v_population/2)
      );

      set @cnt = @cnt + 1;

      if @cnt &gt; 2 then
        leave split_loop;
      end if;

    end loop split_loop;

    -- delete the original county
  <span class="CodeAnnotationCode" aria-label="annotation10">❿</span> delete from county_population where county = v_county;

  end loop fetch_loop;

  close county_cursor;
end;
//

delimiter ;</code></pre>
<p class="CodeListingCaption"><a id="listing11-6">Listing 11-6</a>: Creating the <code>p_split_big_ny_counties()</code> procedure</p>
<p>This procedure uses a cursor to select the original state, county, and population values from the <code>county_population</code> table. You fetch one row at a time from the cursor and loop through your <code>fetch_loop</code> once per each row until all the rows have been processed. Let’s walk through it.</p>
<p>First you declare the <code>v_state</code>, <code>v_county</code>, and <code>v_population</code> variables that will hold the <code>state</code>, <code>county</code>, and <code>population</code> values for each county with more than 2 million people <span class="CodeAnnotation" aria-label="annotation1">❶</span>. You also declare a variable named <code>done</code> that will recognize when there are no more rows for your cursor to fetch. You define the <code>done</code> variable as a boolean and set its default value to <code>false</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>.</p>
<p>Then you declare a cursor, called <code>county_cursor</code>, whose <code>select</code> statement gets all counties from the <code>county_population</code> table that have a population of over 2 million: Kings and Queens counties, in this example <span class="CodeAnnotation" aria-label="annotation3">❸</span>.</p>
<p>Next, you declare a condition handler that will automatically set your <code>done</code> variable to <code>true</code> when your cursor has no more rows to read <span class="CodeAnnotation" aria-label="annotation4">❹</span>. <em>Condition handlers</em> define how MySQL should respond to situations that arise in your procedures. Your condition handler handles the condition <code>not found</code>; if no more rows are found by your <code>fetch</code> statement, the procedure will execute the <code>set done = true</code> statement, which will change the value of your <code>done</code> variable from <code>false</code> to <code>true</code>, letting you know that there are no more rows to fetch.</p>
<p>When you declare a condition handler, you can choose for it to <code>continue</code>—keep running the procedure—or <code>exit</code> after the condition has been handled. You choose <code>continue</code> in <a href="#listing11-6">Listing 11-6</a>.</p>
<p>Next, you <code>open</code> the <code>county_cursor</code> that you declared earlier to prepare it to be used <span class="CodeAnnotation" aria-label="annotation5">❺</span>. You create a <code>fetch_loop</code> loop that will fetch and iterate through <span epub:type="pagebreak" title="189" id="Page_189"/>each row of the <code>county_cursor</code>, one row at a time <span class="CodeAnnotation" aria-label="annotation6">❻</span>. After this, you fetch the state, county, and population values for a row from the cursor to your <code>v_state</code>, <code>v_county</code>, and <code>v_population</code> variables.</p>
<p>You check your <code>done</code> variable <span class="CodeAnnotation" aria-label="annotation7">❼</span>. If all the rows have been fetched from the cursor, you exit the <code>fetch_loop</code> and control flows to the line after the <code>end loop</code> statement. Then you close your cursor and exit the procedure.</p>
<p>If you aren’t done fetching rows from the cursor, set a user variable called <code>@cnt</code> to <code>1</code> <span class="CodeAnnotation" aria-label="annotation8">❽</span>. Then you enter a loop called <code>split_loop</code> that will do the work of splitting the county into two <span class="CodeAnnotation" aria-label="annotation9">❾</span>.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	Notice that your procedure has nested loops: an outer <code>fetch_loop</code> that reads the original county data from the table, and an inner <code>split_loop</code> that splits the counties into two smaller counties.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<p>In <code>split_loop</code>, you insert a row into the <code>county_population</code> table that has a county name with a <code>-1</code> or <code>-2</code> appended and a <code>population</code> that is half of the original county’s population. The <code>-1</code> or <code>-2</code> suffix is controlled by your <code>@cnt</code> user variable. You start <code>@cnt</code> as <code>1</code> and each time you loop through the <code>split_loop</code> loop, you add 1 to it. Then you concatenate the original county name to a dash and the <code>@cnt</code> variable. You halve the population by dividing your original population that is saved in the <code>v_population</code> variable by 2.</p>
<p>You can call functions from procedures; for example, you use <code>concat()</code> to add the suffix to the county name and you use <code>round()</code> to make sure the new <code>population</code> value doesn’t have a fractional part. If there were an odd number of people in your original county, you wouldn’t want the population of the new county to be a number like 1368036.5.</p>
<p>When the <code>@cnt</code> variable is more than 2, your work splitting this county is done, so you <code>leave</code> the <code>split_loop</code> and control flows to the line after your <code>end loop split_loop</code> statement. Then you delete the row for the original county from the database <span class="CodeAnnotation" aria-label="annotation10"><span class="CodeAnnotation">❿</span></span>.</p>
<p>You reach the end of your <code>fetch_loop</code>, which concludes your work for this county. Control flows back to the beginning of the <code>fetch_loop</code> where you fetch and begin processing for the next county.</p>
<p>Now you can call your procedure</p>
<pre><code>call p_split_big_ny_counties();</code></pre>
<p class="BodyContinued">and then look at the largest counties in New York in the database like so:</p>
<pre><code>select *
from   county_population
order by population desc;</code></pre>
<p>The results are:</p>
<pre><code>state     county       population
--------  -----------  ----------
New York  New York       1694251
New York  Suffolk        1525920
New York  Bronx          1472654
<span epub:type="pagebreak" title="190" id="Page_190"/>New York  Nassau         1395774
New York  Kings-1        1368037
New York  Kings-2        1368037
New York  Queens-1       1202732
New York  Queens-2       1202732
New York  Westchester    1004457
<var>--snip--</var></code></pre>
<p>Your procedure worked! You now have <code>Kings-1</code>, <code>Kings-2</code>, <code>Queens-1</code>, and <code>Queens-2</code> counties that are half the size of the original <code>Kings</code> and <code>Queens</code> counties. There are no counties with more than 2 million people, and the original <code>Kings</code> and <code>Queens</code> rows have been removed from the table.</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	Cursors are typically slower than SQL’s normal set processing, so when you have a choice of using a cursor or not, it’s usually best not to. However, there are times when you need to process each row individually.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h3 id="h2-503007c11-0010"><a class="XrefDestination" id="DeclaringOutputParameters"/><span class="XrefDestination" id="xref-503007c11-025"/>Declaring Output Parameters</h3>
<p class="BodyFirst">So far, all the parameters you’ve used in your procedures have been input, but procedures also allow you to use output parameters, which pass a value back to the procedure caller. As mentioned earlier, this caller may be a person using a tool like MySQL Workbench, a program written in another programming language like Python or PHP, or another MySQL procedure.</p>
<p>If the caller of the procedure is an end user who just needs to see some values but doesn’t need to do any further processing with them, you can use a <code>select</code> statement to display the values. But if the caller needs to use the values, you can pass them back from your procedure as output parameters.</p>
<p>This procedure, called <code>p_return_state_population()</code>, returns the population of a state back to the procedure caller using an output parameter:</p>
<pre><code>use population;

drop procedure if exists p_return_state_population;

delimiter //

create procedure p_return_state_population(
  <span class="CodeAnnotationCode" aria-label="annotation1">❶</span> in  state_param         varchar(100),
  <span class="CodeAnnotationCode" aria-label="annotation2">❷</span> out current_pop_param   int
)
begin
  <span class="CodeAnnotationCode" aria-label="annotation3">❸</span> select population
    into   current_pop_param
    from   state_population
    where  state = state_param;
end//

delimiter ;</code></pre>
<p>In the procedure, you declare an <code>in</code> (input) parameter named <code>state_param</code> as <code>varchar(100)</code>, a string of up to 100 characters <span class="CodeAnnotation" aria-label="annotation1">❶</span>. Then you define <span epub:type="pagebreak" title="191" id="Page_191"/>an <code>out</code> (output) parameter named <code>current_pop_param</code> as an <code>int</code> <span class="CodeAnnotation" aria-label="annotation2">❷</span>. You select the population of the state into your output parameter, <code>current_pop_param</code>, which will be automatically returned to the caller because you declared it as an <code>out</code> parameter <span class="CodeAnnotation" aria-label="annotation3">❸</span>.</p>
<p>Now call the procedure using a <code>call</code> statement and send <code>New York</code> as an input parameter. Declare that you want the procedure’s output parameter to be returned to you as a new user variable called <code>@pop_ny</code>:</p>
<pre><code>call p_return_state_population('New York', @pop_ny);</code></pre>
<p>The order of the arguments you send to the procedure matches the order of the parameters that you defined when you created the procedure. The procedure was defined to accept two parameters: <code>state_param</code> and <code>current_pop_param</code>. When you call the procedure, you supply the value of <code>New York</code> for the <code>state_param</code> input parameter. Then you supply <code>@pop_ny</code>, which is the name of the variable that will accept the procedure’s <code>current_pop_param</code> output parameter value.</p>
<p>You can see the results of the procedure by writing a <code>select</code> statement that displays the value of the <code>@pop_ny</code> variable:</p>
<pre><code>select @pop_ny;</code></pre>
<p>The result is:</p>
<pre><code>20201249</code></pre>
<p>The population of New York is saved for you in the <code>@pop_ny</code> user variable.</p>
<h3 id="h2-503007c11-0011"><a class="XrefDestination" id="WritingProceduresThatCallOtherProcedures"/><span class="XrefDestination" id="xref-503007c11-026"/>Writing Procedures That Call Other Procedures</h3>
<p class="BodyFirst">Procedures can call other procedures. For example, here you create a procedure named <code>p_population_caller()</code> that calls <code>p_return_state_population()</code>, gets the value of the <code>@pop_ny</code> variable, and does some additional processing with it:</p>
<pre><code>use population;

drop procedure if exists p_population_caller;

delimiter //

create procedure p_population_caller()
begin
  call p_return_state_population('New York', @pop_ny);
  call p_return_state_population('New Jersey', @pop_nj);

  set @pop_ny_and_nj = @pop_ny + @pop_nj;

  select concat(
     'The population of the NY and NJ area is ',
     @pop_ny_and_nj);

<span epub:type="pagebreak" title="192" id="Page_192"/>end//

delimiter ;</code></pre>
<p>The <code>p_population_caller()</code> procedure calls the <code>p_return_state_population()</code> procedure twice: once with an input parameter of <code>New York</code>, which returns a value to the <code>@pop_ny</code> variable, and once with an input parameter of <code>New Jersey</code>, which returns a value to the <code>@pop_nj</code> variable.</p>
<p>You then create a new user variable called <code>@pop_ny_and_nj</code> and use it to hold the combined populations of New York and New Jersey, by adding <code>@pop_ny</code> and <code>@pop_nj</code>. Then you display the value of the <code>@pop_ny_and_nj</code> variable.</p>
<p>Run your caller procedure using the <code>call</code> statement:</p>
<pre><code>call p_population_caller();</code></pre>
<p>The result is:</p>
<pre><code>The population of the NY and NJ area is 29468379</code></pre>
<p>The total population displayed from the caller procedure is 29,468,379, which is the sum of 20,201,249 people in New York and 9,267,130 in New Jersey.</p>
<h2 id="h1-503007c11-0004"><a class="XrefDestination" id="ListingtheStoredRoutinesinaDatabase"/><span class="XrefDestination" id="xref-503007c11-027"/>Listing the Stored Routines in a Database</h2>
<p class="BodyFirst">To get a list of the functions and procedures stored in a database, you can query the <code>routines</code> table in the <code>information_schema</code> database:</p>
<pre><code>select routine_type,
       routine_name
from   information_schema.routines
where  routine_schema = 'population';</code></pre>
<p>The results are:</p>
<pre><code>routine_type  routine_name
------------  -------------------------------
FUNCTION      f_get_state_population
PROCEDURE     p_compare_population
PROCEDURE     p_endless_loop
PROCEDURE     p_get_county_population
PROCEDURE     p_more_sensible_loop
PROCEDURE     p_population_caller
PROCEDURE     p_repeat_until_loop
PROCEDURE     p_return_state_population
PROCEDURE     p_set_and_show_state_population
PROCEDURE     p_set_state_population
PROCEDURE     p_split_big_ny_counties
PROCEDURE     p_while_loop</code></pre>
<p><span epub:type="pagebreak" title="193" id="Page_193"/>As you can see, this query returns a list of functions and procedures in the <code>population</code> database.</p>
<h2 id="h1-503007c11-0005"><a class="XrefDestination" id="Summary"/><span class="XrefDestination" id="xref-503007c11-028"/>Summary</h2>
<p class="BodyFirst">In this chapter, you learned to create and call procedures and functions. You used <code>if</code> statements, <code>case</code> statements, and repeatedly executed functionality with loops. You also saw the benefit of using cursors to process one row at a time.</p>
<p>In the next chapter, you’ll create triggers to automatically fire and perform processing for you based on events like rows getting inserted or deleted.</p>
</section>
</div>
</div>
</body></html>