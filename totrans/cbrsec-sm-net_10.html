<html><head></head><body>
<div id="sbo-rt-content"><section aria-labelledby="header1001" class="chapter" epub:type="chapter" id="ch10" role="doc-chapter">
<header id="header1001">
<h1 class="cn"><span aria-label="148" class="page" epub:type="pagebreak" id="p148" role="doc-pagebreak"/><span aria-label="149" class="page" epub:type="pagebreak" id="p149" role="doc-pagebreak"/><a class="xref" href="nsp-enoka501485-0007.xhtml#rch10">10</a></h1>
<h1 class="ct">Monitoring Your Network with Detection and Alerting</h1>
</header>
<figure class="figure">
<p class="fig"><img alt="Chapter opening icon" height="100" src="images/nsp-enoka501485-ct.jpg" width="100"/></p>
</figure>
<p class="pf"><span class="page" data-locator="p149"/>Network monitoring provides real-time visibility into your network activity, enabling you to stay ahead of potential threats and (ideally) stop adversaries before they’ve performed any disruptive action. Monitoring your network is a huge undertaking, so alerts are often a useful starting point for investigations. Without meaningful alerts, network monitoring is like finding a needle in a haystack—trying to identify malicious activity within a very large dataset.</p>
<p>Your firewalls, proxies, antivirus, and other solutions should be up and running for at least a month before you start trying to actively monitor your hosts and network traffic, just to ensure they’re functioning correctly. Up until this point, everything has been relatively passive; once set up, no further input from you is required, unless you need to update or change the configuration.</p>
<p><span aria-label="150" class="page" epub:type="pagebreak" id="p150" role="doc-pagebreak"/>Due to their nature, active monitoring and alerting can take considerable time and effort—not only to implement but to maintain, and that is especially true as a network expands. Not only will you need to check in regularly to see whether your network monitoring software has identified any threats or unusual behavior, but you’ll also need to investigate this behavior and potentially work to mitigate the identified activity. Depending on the size of the network, monitoring it could be a full-time job for one or more people.</p>
<p>This chapter will arm you with the knowledge and tools required to monitor your network and alert you to suspicious behavior successfully. We’ll discuss how, when, and where to implement network traffic access points (TAPs) and a switch port analyzer (SPAN) in your network to enable network traffic capture, monitoring, and analysis. Finally, we’ll build a network monitoring appliance using Security Onion—a free suite of network security monitoring tools—and discuss how best to utilize its built-in capabilities.</p>
<section>
<h2 class="ah" id="ah1201"><a class="xref" href="nsp-enoka501485-0007.xhtml#rah1201">Network Monitoring Methods</a></h2>
<p class="paft">You can use several methods to monitor and capture network traffic for real-time or post-facto analysis and alerting. The method you choose depends mostly on your network’s hardware, as each device has different capabilities. We’ll discuss two of the most common methods in the following sections.</p>
<section>
<h3 class="bh" id="bh1201"><a class="xref" href="nsp-enoka501485-0007.xhtml#rbh1201">Network Traffic Access Points</a></h3>
<p class="paft">In small networks without switches, you can install a network <i>traffic access point (TAP)</i> to monitor the data that passes through it. A TAP is an inline device, placed between two nodes on a network; it becomes an extension of the transmission medium (like an Ethernet cable) that already exists between those two devices. In <a class="xref" href="nsp-enoka501485-0019.xhtml#fig1001">Figure 10-1</a>, the TAP is between the firewall and router.</p>
<figure class="figure" id="fig1001">
<p class="fig"><img alt="Diagram of a small network with a network TAP where the main hosts (in this example, Desktop 1 and Laptop 1) are connected to a wireless router, which is connected to the TAP. The Network Security Monitoring Device is connected to the TAP as well. The TAP is connected to the Firewall, which sits between the TAP and the internet." height="1200" src="images/nsp-enoka501485-fig1001.jpg" style="width:95%; height:auto;" width="1055"/></p>
<figcaption>
<p class="figh"><span class="fighn">Figure 10-1</span>: Placement of a network TAP</p>
</figcaption>
</figure>
<p><span aria-label="151" class="page" epub:type="pagebreak" id="p151" role="doc-pagebreak"/>In this configuration, all traffic passing between the router and the firewall is sent by the TAP to a monitoring device, where it’s stored for analysis.</p>
<aside aria-labelledby="bxheader1001" class="box">
<div class="bxheader" id="bxheader1001">
<p class="bxh">TAPs and Intrusion Detection Systems</p>
</div>
<p class="bxo">Coupling TAPs with an <i>intrusion detection system (IDS)</i> allows administrators to identify suspicious activity occurring across this ingress and egress point. An IDS is a software or hardware tool that uses a set of rules or signatures to identify known-bad behavior. When an IDS identifies something suspicious in your network traffic, it will generate an alert that you can investigate to decide whether it’s actually malicious (a true positive) or benign (a false positive). You can then ignore the alert or take action to mitigate and remediate the problem, which we’ll discuss at length later.</p>
</aside>
<p>When placing a TAP, consider what you actually want to see and investigate. In a configuration like the one shown in <a class="xref" href="nsp-enoka501485-0019.xhtml#fig1001">Figure 10-1</a>, you’d capture all the traffic between your endpoints and the firewall (the network’s boundary). Monitoring your major egress point lets you investigate things like <i>data exfiltration</i>, where an adversary is trying to steal your data by sending it outside your network. However, with this configuration, you won’t be able to see traffic between your endpoint devices, as that is handled by the wireless router and never reaches the TAP.</p>
<p>If you placed the TAP behind the firewall (as opposed to on the internet side), you wouldn’t see any traffic from the internet attempting to reach the internal network that’s blocked by the firewall. If the TAP is in front of the firewall, you wouldn’t see the outbound traffic being blocked by the firewall; the security monitoring system also would lose the protection of that firewall and become an easy route into your network. Decide which of those scenarios you’re comfortable with and place your TAP accordingly. In most cases, it’s best to place the TAP behind the firewall (inside your network) and review the firewall logs for what the TAP doesn’t see.</p>
<p>A TAP is an inline device. Be aware that if the TAP becomes unavailable or goes offline—if any of its limited network ports fail—your entire network will lose access to the internet. Your endpoint devices should still be able to communicate with each other via the router, but traffic will no longer pass through the TAP.</p>
<p>Several TAP devices are available at reasonable prices. One of the simplest is the <i>Dualcomm ETAP</i>. One possible configuration of such a TAP would be to connect the firewall in <a class="xref" href="nsp-enoka501485-0019.xhtml#fig1001">Figure 10-1</a> to the A inline port, connect the B inline port to the wireless router, and connect a separate cable to the monitoring port of your network security monitoring device (discussed in the next section). Such a configuration would allow traffic to flow through the TAP as if it wasn’t there, except that it would be intercepted, monitored, and analyzed by the network security monitoring system.</p>
</section>
<section>
<h3 class="bh" id="bh1202"><span aria-label="152" class="page" epub:type="pagebreak" id="p152" role="doc-pagebreak"/><a class="xref" href="nsp-enoka501485-0007.xhtml#rbh1202">Switch Port Analyzers</a></h3>
<p class="paft">An alternative to a network TAP is the <i>switch port analyzer (SPAN)</i> or <i>mirror port</i> (interchangeable terms) functionality provided by a switch. A SPAN does the same thing as a TAP; it mirrors (or copies) all the data passing through a source port(s) to the destination SPAN port on the switch. Your network security monitoring system is then connected to the SPAN port to capture the network traffic for analysis and alerting. In most modern switches, it’s possible to create a SPAN configuration with multiple source ports, so you can capture data from any port(s) on a switch.</p>
<p>A SPAN configuration in a small network might look like the one shown <a class="xref" href="nsp-enoka501485-0019.xhtml#fig1002">Figure 10-2</a>, where the firewall or other system provides IP addresses to endpoints. Each host is connected by Ethernet to a port on the switch, and then the network security monitoring device is connected to the SPAN configured on the switch. Unlike TAPs, if a port on the switch fails, the rest of the network continues functioning, but if the entire switch goes offline due to a power failure, the entire network will go down with it.</p>
<figure class="figure" id="fig1002">
<p class="fig"><img alt="Diagram showing a small network with a switch and SPAN port that has the main hosts (in this example, Desktop 1 and Laptop 1) connected to a port on the switch. The Network Security Monitoring Device is connected to the switch as well. The switch is then connected to the firewall, which is placed between the switch and the internet." height="1200" src="images/nsp-enoka501485-fig1002.jpg" style="width:95%; height:auto;" width="1141"/></p>
<figcaption>
<p class="figh"><span class="fighn">Figure 10-2</span>: A small network with a switch and SPAN port</p>
</figcaption>
</figure>
<p>Unlike a TAP configuration, with a SPAN set up on a switch, you’ll be able to capture and analyze computer-to-computer traffic in addition to inbound and outbound data. You’ll still have the placement issue, though; when the switch is on the internal side of the firewall (as it should be), your security monitoring system won’t have visibility over the traffic blocked by the firewall.</p>
<p class="hd" id="hd1201"><span aria-label="153" class="page" epub:type="pagebreak" id="p153" role="doc-pagebreak"/><a class="xref" href="nsp-enoka501485-0007.xhtml#rhd1201"><span class="ccust2">#35: Configuring a SPAN Port</span></a></p>
<p class="paft">To configure a SPAN port on a managed switch, like the Netgear switch that we used in <a class="xref" href="nsp-enoka501485-0011.xhtml#ch02">Chapter 2</a>, follow these steps:</p>
<ol style="list-style-type:none">
<li class="nlf">1. Log in to the switch with administrator credentials.</li>
<li class="nl">2. Select <b>System▸Monitoring▸Mirroring</b>.</li>
<li class="nl">3. In the Port Mirroring Configuration table that appears, click the source ports from which you want to capture network traffic to select them. Selected ports will have a check mark.</li>
<li class="nl">4. In the Destination Port drop-down box, enter the port to use as the SPAN port you’ll connect to your security monitoring system.</li>
<li class="nll">5. Finally, in the Mirroring drop-down menu, select <b>Enable▸Apply</b>.</li>
</ol>
<p>Whether you choose to set up a TAP or a switch with a SPAN port, you’ll need a network monitoring solution capable of aggregating collected data. The best solution currently available for small networks is Security Onion, which includes various components for capturing and aggregating network data and enables you to quickly analyze that data.</p>
</section>
</section>
<section>
<h2 class="ah" id="ah1202"><a class="xref" href="nsp-enoka501485-0007.xhtml#rah1202">Security Onion</a></h2>
<p class="paft">Security Onion is an open source platform for threat hunting, network security monitoring, and log management. It’s an operating system, like Ubuntu, that includes several open source tools we’ll utilize to monitor our network for security and configuration issues.</p>
<p>Security Onion’s tools include suricata, an intrusion detection system, and zeek, a software framework for analyzing network traffic to identify anomalous behavior. Grafana is a set of visualizations and dashboards for monitoring the health of the Security Onion system, and osquery gathers data about the endpoints in your network and the operating systems they’re running for analysis. Wazuh is similar to osquery; it’s an agent-based tool that gathers analyzable data from your endpoints and is used for active endpoint detection and response (in the case of a security incident). Finally, Strelka is a real-time file-scanning utility that analyzes network traffic and scans any files traversing the network; it’s useful for identifying malware or data exfiltration.</p>
<aside aria-labelledby="bxheader1002" class="box">
<div class="bxheader" id="bxheader1002">
<p class="bxh"><span aria-label="154" class="page" epub:type="pagebreak" id="p154" role="doc-pagebreak"/>Security Onion Tools for Larger Networks</p>
</div>
<p class="bxaft">Security Onion makes use of the ELK stack (which includes Elastic, Logstash, and Kibana) to create visualizations and dashboards. ELK is similar to Grafana, except where Grafana is used to display information about the system itself, ELK displays information about the network data being captured, allowing the user to view and analyze the data easily. ELK is a powerful tool but is outside the scope of this book as it is more advanced than the tools within Security Onion’s security dashboard. However, many online resources discuss ELK and its use in great detail if you’d like to investigate it further.</p>
<p class="bxl">Security Onion is designed to be scalable and is capable of monitoring very large networks, so it includes tools that aren’t necessary on small networks, such as TheHive, an incident management system, and Playbook, a tool for creating incident management playbooks; those tools are primarily used in larger networks, so they aren’t covered here.</p>
</aside>
<p>In the following sections, we’ll discuss creating your network security monitoring system using Security Onion and its built-in tools. We’ll explore how to utilize these tools to start monitoring your network, and how to triage and investigate problems when they arise. It’s up to you whether you’d like to buy or build your Security Onion appliance. Security Onion Solutions has preconfigured appliances ready to go out of the box.</p>
<p class="hd" id="hd1202"><a class="xref" href="nsp-enoka501485-0007.xhtml#rhd1202"><span class="ccust2">#36: Building a Security Onion System</span></a></p>
<p class="paft">To build a Security Onion system, you’ll need a device with a minimum of two network interfaces: a management interface and a capture interface (connected to the TAP or SPAN). We’ll use an Intel NUC (a small form factor computing unit) with two Ethernet ports, which is very customizable and available at various price points depending on your budget and requirements. The following minimum hardware specifications are detailed in the Security Onion documentation:</p>
<ul style="list-style-type:none">
<li class="blf">• 12GB of RAM</li>
<li class="bl">• Four CPU cores</li>
<li class="bl">• 200GB of storage</li>
<li class="bll">• Two network interfaces</li>
</ul>
<p>One additional consideration is how much storage you need. For reference, a NUC with an internal storage space of 2TB might be capable of storing around three weeks of data, depending on the number of devices, number of users, and amount of network traffic in your network. After that point, the data will be kept on a rolling cycle, where older data is deleted in <span aria-label="155" class="page" epub:type="pagebreak" id="p155" role="doc-pagebreak"/>favor of newer data. To enable better incident response capabilities in your network, the more data you keep, the better. If you discover an adversary in your network that has been there for 12 months but you have only one month of data, you’ll never be able to determine root cause, making it difficult to kick them out and prevent the problem from recurring.</p>
<p>Once you have a NUC (or similar device), you’ll install Security Onion. At this stage, it’s also a good idea to connect the network port you plan to use for management (<i>not</i> the port you’ll use for capturing network traffic) to your network so you can set up its configuration. It doesn’t matter which of the two network ports you use for management and traffic capture. This device will need a static IP address, and while you could do that on the device itself, it’s better to configure the static addressing on your router or whichever device is responsible for IP address leases in your environment (like your wireless router or pfSense device). Having the management port on your NUC (and only this port) connected will make it easier to identify when installing and configuring the rest of the software. After this process is complete, you can then configure the capture port independently. You should configure the static IP address for the management interface now, as some of the agents we’ll install have requirements and dependencies based on this address, so changing it later can create challenges.</p>
<section>
<h3 class="bh" id="bh1203"><a class="xref" href="nsp-enoka501485-0007.xhtml#rbh1203">Installing Security Onion</a></h3>
<p class="paft">You can install Security Onion from an ISO file (available directly from Security Onion Solutions at <a class="url-i" href="https://securityonionsolutions.com/software/">https://securityonionsolutions.com/software/</a>) or manually using CentOS 7 as the base operating system and then installing the Security Onion package like any other application in a Linux environment (note that CentOS 7 is the only OS supported by Security Onion). Using the ISO file is a simpler and faster method of creating a Security Onion system, whereas manual installation requires slightly more effort. However, manual installation allows you to have more granular control over things like disk partitioning. If that is of interest to you, choose the manual installation method. If not, install Security Onion using the ISO file.</p>
<section>
<h4 class="ch" id="ch1201">Installing Security Onion from the ISO File</h4>
<p class="paft">Start by downloading the latest ISO from Security Onion Solutions, and follow the procedure outlined in <a class="xref" href="nsp-enoka501485-0010.xhtml#ch01">Chapter 1</a>’s “<a class="xref" href="nsp-enoka501485-0010.xhtml#hd0302">Creating a Physical Linux System</a>” to create a bootable USB drive from the ISO file. Plug your bootable USB into your NUC, turn on the NUC, and you’ll be presented with the Security Onion installation wizard. Follow these steps to complete the installation:</p>
<ol style="list-style-type:none">
<li class="nlf">1. The wizard will prompt you to install Security Onion, destroying all data and partitions. Type <b>yes</b> and press ENTER to accept this and begin the installation process.</li>
<li class="nl">2. Enter an administrator username when prompted; then press ENTER.</li>
<li class="nl"><span aria-label="156" class="page" epub:type="pagebreak" id="p156" role="doc-pagebreak"/>3. Enter a strong passphrase for the user; then press ENTER.</li>
<li class="nl">4. Repeat the passphrase to confirm it; then press ENTER to initiate the installation.</li>
<li class="nl">5. Once installation completes, the computer will reboot. Log in with your newly created credentials and the Security Onion setup wizard will pop up. Press ENTER to continue.</li>
<li class="nl">6. Using the arrow keys, select <b>Install</b> to run the standard Security Onion installation; then press ENTER.
                <p class="nlp">At this point, the process for completing the installation of Security Onion is the same for both the ISO file installation and the manual installation paths. Jump to the section “<a class="xref" href="nsp-enoka501485-0019.xhtml#ch1203">Completing the Security Onion Installation</a>” on <a class="xref" href="nsp-enoka501485-0019.xhtml#p157">page 157</a>.</p>
</li>
</ol>
</section>
<section>
<h4 class="ch" id="ch1202">Installing Security Onion Manually</h4>
<p class="paft">You can install Security Onion entirely from scratch by installing CentOS 7 on your NUC and then installing the Security Onion packages and tools on top. To do this, follow these steps:</p>
<ol style="list-style-type:none">
<li class="nlf">1. Download the most recent CentOS 7 ISO (the correct format is x86_64) from <a class="url-i" href="https://www.centos.org/">https://www.centos.org/</a>.</li>
<li class="nl">2. Follow the procedure outlined in <a class="xref" href="nsp-enoka501485-0010.xhtml#ch01">Chapter 1</a>’s “<a class="xref" href="nsp-enoka501485-0010.xhtml#hd0302">Creating a Physical Linux System</a>” section to create a bootable USB drive from the ISO file.</li>
<li class="nl">3. Plug your bootable USB into your NUC and boot from the USB. You’ll be presented with a few options; choose <b>Test this Media &amp; Install CentOS 7</b>.</li>
<li class="nl">4. At this point, a graphical installation wizard appears. Select your desired language and click <b>Continue</b>.</li>
<li class="nl">5. Set the correct time zone and keyboard layout.</li>
<li class="nl">6. Under Software Selection, it’s recommended to choose <b>Server with GUI</b> for ease of administration.</li>
<li class="nl">7. Under System▸Installation Destination, select the internal disk where you plan to install Security Onion and then choose <b>I Will Configure Partitioning</b>. Click <b>Done</b> to proceed to the partitioning wizard. Partitioning defines how the hard drive storage will be divided among the users and applications on the system.</li>
<li class="nl">8. Select <b>LVM Partitioning</b> and create the following partitions:
                <ol style="list-style-type:none">
<li class="nl1">a. <i>/boot</i>: CentOS will boot from this partition; it should have at least 500MB of space available.</li>
<li class="nl1">b. <i>/boot/efi</i>: Part of the boot partition; it should be at least 500MB.</li>
<li class="nl1">c. <i>/</i>: The root of the filesystem; should be 300GB.</li>
<li class="nl1">d. <i>/tmp</i>: For temporary files; should be 2GB.</li>
<li class="nl1"><span aria-label="157" class="page" epub:type="pagebreak" id="p157" role="doc-pagebreak"/>e. swap: For swap files; should be 8GB.</li>
<li class="nl1">f. <i>/home</i>: A space for any user files; should be 40GB.</li>
<li class="nl1">g. <i>/nsm</i>: For all the security tools and captured data; it should be assigned the remainder of drive space.</li>
</ol>
</li>
<li class="nl">9. Click <b>Done▸Accept Changes</b> to write the changes to disk.</li>
<li class="nl">10. Click <b>Begin Installation</b> to install the operating system.</li>
<li class="nl">11. Set your root passphrase and create a non-root, administrative account on the following screen. If you want to connect to this system via SSH, ensure that your administrative account has a strong passphrase.</li>
<li class="nl">12. Once the installation is complete, reboot the machine and remove the installation USB. Then, boot to your CentOS operating system.</li>
<li class="nl">13. Accept the license information.</li>
<li class="nl">14. You might need to turn the network card on to enable the network. Click <b>Network &amp; Host Name</b>, toggle the network button to <b>On</b>, and then click <b>Done</b>.</li>
<li class="nll">15. Click <b>Finish Configuration</b>.</li>
</ol>
<p>With CentOS installed, next install Security Onion. First, connect to your server via SSH or log in directly. Change directory to the <i>/nsm</i> partition you created during the initial setup:</p>
<pre>
<p class="cls">$ <code class="b">cd /nsm</code></p>
</pre>
<p>Use <code class="b">sudo yum install</code> to install Git (an application for software management) and then <code class="b">git clone</code> to download Security Onion:</p>
<pre>
<p class="clf">$ <code class="b">sudo yum install git -y</code></p>
<p class="cl">$ <code class="b">sudo git clone \</code></p>
<p class="cll"><code class="b">      https://github.com/Security-Onion-Solutions/securityonion</code></p>
</pre>
<p class="pcon">(Whereas Ubuntu is based on Debian Linux and uses the <code>apt</code> utility to manage software packages, CentOS is based on Red Hat Linux and uses <code>yum</code>.)</p>
<p>Navigate to the newly created <i>securityonion</i> directory and run the setup script:</p>
<pre>
<p class="clf">$ <code class="b">cd /nsm/securityonion/</code></p>
<p class="cll">$ <code class="b">sudo bash so-setup-network</code></p>
</pre>
<p>Running this script starts an interactive installation wizard that leads you through the initial setup and configuration of your Security Onion server.</p>
</section>
<section>
<h4 class="ch" id="ch1203">Completing the Security Onion Installation</h4>
<p class="paft">Now that the basic configuration of the operating system has been completed, you’ll start installing and configuring the tools you’ll use to monitor <span aria-label="158" class="page" epub:type="pagebreak" id="p158" role="doc-pagebreak"/>and analyze the network traffic. Zeek is a security monitoring platform that will enable you to analyze network traffic more efficiently and alert on suspicious activity within your network automatically. It does this by utilizing rulesets containing information on suspicious or malicious activity, software, and network traffic, such as the ETOPEN ruleset you’ll use here.</p>
<p>Regardless of how you’ve installed Security Onion, follow these steps to complete the process:</p>
<ol style="list-style-type:none">
<li class="nlf">1. Press ENTER to continue past the welcome screen (and to progress to all other screens).</li>
<li class="nl">2. On the Installation Type page, navigate to STANDALONE with the arrow keys, and press the spacebar to select the option.</li>
<li class="nl">3. If you used the Security Onion ISO, select <b>Standard</b> on the next page to indicate that this machine has internet access.</li>
<li class="nl">4. If you performed the manual installation of Security Onion, type <b>AGREE</b> to accept the Elastic License on the next page.</li>
<li class="nl">5. On the next page, keep the default hostname for simplicity or change it if you like (in larger installations that have more than one server, changing the hostname will be beneficial). If prompted to change the hostname, choose to proceed anyway.</li>
<li class="nl">6. On the next page, enter a short description for this computer or leave it blank.</li>
<li class="nl">7. On the network card configuration page, shown in <a class="xref" href="nsp-enoka501485-0019.xhtml#fig1003">Figure 10-3</a>, select the interface with the words <i>Link UP</i> next to it as the management interface. It should be the only interface plugged into the network at this point.</li>
</ol>
<figure class="figure" id="fig1003">
<p class="fig"><img alt="The Network Interface Card Setup window states link names followed by buttons labeled Ok and Cancel." height="635" src="images/nsp-enoka501485-fig1003.jpg" style="width:95%; height:auto;" width="1200"/></p>
<figcaption>
<p class="figh"><span class="fighn">Figure 10-3</span>: NIC setup wizard</p>
</figcaption>
</figure>
<ol style="list-style-type:none">
<li class="nl"><span aria-label="159" class="page" epub:type="pagebreak" id="p159" role="doc-pagebreak"/>8. Press the spacebar to set the monitor interface.
                <p class="nlp">On the management interface page, you may receive an informational error about using DHCP; as long as you’ve configured a static address for this device, you can ignore this message.</p>
</li>
<li class="nl">9. When asked how this computer should connect to the internet, select <b>Direct</b>.</li>
<li class="nl">10. Select <b>Automatic</b> on the OS Patch Schedule page to keep your operating system automatically up-to-date.</li>
<li class="nl">11. Specify your home network address range, identified in <a class="xref" href="nsp-enoka501485-0010.xhtml#ch01">Chapter 1</a>. If your network uses 10.0.0.0/8 addresses, leave that in the box provided and delete the other two subnets. If your network uses 192.168.0.0/16 addresses, keep that in the box and delete the other two, and so on.</li>
<li class="nl">12. When asked which type of manager to install, select <b>BASIC</b>.</li>
<li class="nl">13. Select <b>ZEEK</b> as the tool to use to generate metadata.</li>
<li class="nl">14. Select <b>ETOPEN</b> as the IDS ruleset to use to generate alerts.</li>
</ol>
<p class="pcust1"><span class="ccust1">Note</span> ETOPEN is an open source ruleset updated regularly with new and emerging threats and alerts. ETPRO and TALOS are similar to ETOPEN, but they require a subscription. For small networks, ETOPEN is sufficient.</p>
<ol style="list-style-type:none">
<li class="nlf">15. The wizard then asks which components of the Security Onion suite of tools you want to install. Select <b>Osquery</b>, <b>Wazuh</b>, and <b>Strelka</b>.</li>
<li class="nl">16. If asked if you’d like to keep the default Docker IP range, select <b>Yes</b>.</li>
<li class="nl">17. Enter your email address for the Security Onion administrator.</li>
<li class="nl">18. Enter and re-enter the password for your account.</li>
<li class="nl">19. When asked how you will access the web interface, select <b>IP</b>.</li>
<li class="nl">20. Set a strong passphrase for the <i>soremote</i> user account (for performing some administrative actions).</li>
<li class="nl">21. Choose <b>BASIC</b> to install the network security monitoring components with the recommended settings.</li>
<li class="nl">22. Type <b>2</b> for the number of Zeek and Suricata processes.
                <p class="nlp">The number of processes dictates how much network traffic your system can process. For small networks, two processes should be sufficient; you can change this later if necessary.</p>
</li>
<li class="nl">23. If asked if you’d like to configure NTP servers, choose <b>Yes</b>. Network Time Protocol (NTP) is used to keep endpoints synchronized. It’s best to keep your monitoring server in sync with a time server to prevent time drift, which can cause issues when troubleshooting alerts. Browse to <a class="url-i" href="https://www.ntppool.org/">https://www.ntppool.org/</a> and choose an NTP server in your region to keep your Security Onion server’s time in sync.</li>
<li class="nl"><span aria-label="160" class="page" epub:type="pagebreak" id="p160" role="doc-pagebreak"/>24. Select <b>NODEBASIC</b> when asked.</li>
<li class="nll">25. Run <b>so-allow</b> by pressing ENTER when asked to correctly configure the firewall on the system to allow access to all the tools being installed.</li>
</ol>
<p>When asked for an IP address to allow access to your network monitoring system, you can choose to allow access to the Security Onion web interfaces from a single computer or device or from any host in your network. For security purposes, you allow access only from a single IP address.</p>
<ol style="list-style-type:none">
<li class="nlf">26. Enter the IP address you plan to use; then press ENTER.</li>
<li class="nll">27. Finally, accept the configuration you’ve just created by pressing TAB to select <b>Yes</b>; then press ENTER to finish the setup wizard and commit the changes.</li>
</ol>
<p class="pcust1"><span class="ccust1">Note</span> Security Onion and some of its tools, like Zeek, can run in a cluster configuration, where the agents are installed on multiple systems for enhanced data collection and processing. In small networks, a stand-alone system is sufficient. In larger networks with multiple network segments and switches, a cluster configuration might make more sense.</p>
<p>At the end of the installation, the screen will display the URL to access the Security Onion web interface; write this down (it should be <i>http://&lt;your_server_ip&gt;/</i>). The system will reboot. Once it comes back up, you’ll be able to log in via the URL using the email address and passphrase you entered earlier. To test the Security Onion configuration, run the following:</p>
<pre>
<p class="cls">$ <code class="b">sudo so-status</code></p>
</pre>
<p>This command lists the tools Security Onion is running and the status of each, which should appear as <code>OK</code> if everything worked.</p>
<p>If any services haven’t started, wait a few minutes before running the status command again. If they still fail to start, try starting services manually using these commands:</p>
<pre>
<p class="clf">$ <code class="b">sudo so-servicename-stop</code></p>
<p class="cl">$ <code class="b">sudo so-servicename-start</code></p>
<p class="cll">$ <code class="b">sudo so-servicename-restart</code></p>
</pre>
<p>If you’re still unable to get the services to start, reboot the computer. If all else fails, reinstall Security Onion.</p>
<p>Once you can access the Security Onion console, you’ll see a menu on the left side that lists all the tools at your disposal (see <a class="xref" href="nsp-enoka501485-0019.xhtml#fig1004">Figure 10-4</a>).</p>
<figure class="figure" id="fig1004">
<p class="fig"><span aria-label="161" class="page" epub:type="pagebreak" id="p161" role="doc-pagebreak"/><img alt="Security Onion’s tools include: Kibana, Grafana, CyberChef, Playbook, Fleet, TheHive, and Navigator." height="1200" src="images/nsp-enoka501485-fig1004.jpg" style="width:95%; height:auto;" width="370"/></p>
<figcaption>
<p class="figh"><span class="fighn">Figure 10-4</span>: Security Onion tools</p>
</figcaption>
</figure>
<p>At this point, click <b>Kibana</b>, and a new tab will be launched in your browser. You should see a minimal number of records because you haven’t plugged in the capture port on your device.</p>
<p>Connect this port to the SPAN or TAP you configured earlier. Once that’s done, refresh the page after a few minutes to see Kibana populated with newly acquired data.</p>
<p class="hd" id="hd1203"><a class="xref" href="nsp-enoka501485-0007.xhtml#rhd1203"><span class="ccust2">#37: Installing Wazuh</span></a></p>
<p class="paft">Security Onion’s additional tools help you to understand what’s happening in your network and take action to investigate, mitigate, and remediate issues when they arise. One of these packages is Wazuh.</p>
<p><span aria-label="162" class="page" epub:type="pagebreak" id="p162" role="doc-pagebreak"/>Wazuh is an open source <i>endpoint detection and response (EDR)</i> platform that monitors your endpoints for malicious activity, alerts you within the Security Onion console, and provides the incident response capabilities of blocking network traffic, stopping malicious processes, and quarantining malware files.</p>
<p>Using agents like Wazuh can be controversial. In larger networks, oftentimes so much is going on that adding something new to the network, especially across all the systems, can cause stability issues or create/exacerbate challenges around limited resources like bandwidth. This is usually less of an issue in smaller networks because capacity isn’t shared between so many devices, users, or processes, and there generally aren’t as many solutions competing for resources.</p>
<p>Installing Wazuh won’t have a meaningful impact on the daily operations of your small network. Conversely, the value you receive from the additional monitoring and security uplift far outweighs any potential negative consequences of using multiple agents. Ultimately, it’s your decision whether to install these agents on one, some, or all of the endpoints in your network. The more complete your coverage and network monitoring, the more secure your network is likely to be.</p>
<p>This section provides instructions for installing the Wazuh agent on Windows, macOS, and Linux.</p>
</section>
</section>
<section>
<h3 class="bh" id="bh1204"><a class="xref" href="nsp-enoka501485-0007.xhtml#rbh1204">Installing Wazuh on Windows</a></h3>
<p class="paft">To install the Wazuh agent on your Windows endpoint(s), follow these steps:</p>
<ol style="list-style-type:none">
<li class="nlf">1. Log in to your Security Onion console and click <b>Downloads</b> in the left menu.</li>
<li class="nl">2. Click the <b>MSI</b> installer agent option to download the correct installer; then run the downloaded executable on your Windows computer.</li>
<li class="nl">3. Accept the license agreement and click <b>Install</b>.</li>
<li class="nl">4. Once the installation completes, tick the <b>Run Agent Configuration Interface</b> checkbox and click <b>Finish</b>.</li>
<li class="nl">5. To add this new system to your Security Onion, log in to Security Onion via SSH and run the <code>manage_agents</code> script. Following the prompts, add an agent with <code class="b">A</code>, list agents with <code class="b">L</code> to confirm the addition was successful, and extract the authentication key for your new agent with <code class="b">E</code>:
              <pre>
<p class="cl3f">$ <code class="b">sudo docker exec -it so-wazuh /var/ossec/bin/manage_agents</code></p>
<p class="cl3"><code class="i">--snip--</code></p>
<p class="cl3">Choose your action: A,E,L,R or Q: <code class="b">A</code></p>
<p class="cl3">- Adding a new agent (use '\q' to return to the main menu).</p>
<p class="cl3">  Please provide the following:</p>
<p class="cl3"> <!--<ccust1>1</ccust1>-->❶ * A name for the new agent: <code class="b">Test</code></p>
<p class="cl3">   * The IP Address of the new agent: <code class="b">192.168.1.50</code></p>
<p class="cl3">Confirm adding it?(y/n): <code class="b">y</code></p>
<p class="cl3">Agent added with ID 002.</p>
<p class="cl3"><code class="i">--snip--</code></p>
<p class="cl3">Choose your action: A,E,L,R or Q: <code class="b">L</code></p>
<p class="cl3"><span aria-label="163" class="page" epub:type="pagebreak" id="p163" role="doc-pagebreak"/>Available agents:</p>
<p class="cl3">   ID: 001, Name: securityonion, IP: 192.168.1.49</p>
<p class="cl3"> <!--<ccust1>2</ccust1>-->❷ ID: 002, Name: Test, IP: 192.168.1.50</p>
<p class="cl3">** Press ENTER to return to the main menu.</p>
<p class="cl3"><code class="i">--snip--</code></p>
<p class="cl3">Choose your action: A,E,L,R or Q: <code class="b">E</code></p>
<p class="cl3">Available agents:</p>
<p class="cl3">   ID: 001, Name: securityonion, IP: 192.168.1.49</p>
<p class="cl3">   ID: 002, Name: Test, IP: 192.168.1.50</p>
<p class="cl3">Provide the ID of the agent to extract the key (or '\q' to quit): <code class="b">002</code></p>
<p class="cl3">Agent key information for '002' is:</p>
<p class="pcust3"><!--<ccust1>3</ccust1>-->❸ MDAyIFJvcnkgMTkyLjE2OC4xL . . .</p>
<p class="cl3">** Press ENTER to return to the main menu.</p>
<p class="cl3"><code class="i">--snip--</code></p>
<p class="cl3">Choose your action: A,E,L,R or Q: <code class="b">Q</code></p>
<p class="cl3l">manage_agents: Exiting.</p>
</pre>
<p class="nlp">You’ll have to provide a name and IP address when you add an agent <!--<ccust1>1</ccust1>-->❶. For the name, use the hostname of the computer being added. Run the <code class="b">hostname</code> command to find the name:</p>
<pre>
<p class="cl3f">$ <code class="b">hostname</code></p>
<p class="cl3l">Test</p>
</pre>
<p class="nlp">Find your IP address (see <a class="xref" href="nsp-enoka501485-0010.xhtml#hd0308">Project 8</a> in <a class="xref" href="nsp-enoka501485-0010.xhtml#ch01">Chapter 1</a>) or consult the asset list or network map you’ve been maintaining. When you list the agents, verify that an agent with that name and IP address is present <!--<ccust1>2</ccust1>-->❷. Use the agent’s ID number to get its authentication key <!--<ccust1>3</ccust1>-->❸. Return to the main menu with <span class="ac">enter</span> and use the <code class="b">Q</code> option to quit.</p>
</li>
<li class="nl">6. Open the <b>Wazuh Agent Manager</b> on your Windows computer (see <a class="xref" href="nsp-enoka501485-0019.xhtml#fig1005">Figure 10-5</a>) and enter the IP address of your Security Onion system and the agent authentication key; click <b>Save</b>.
              <figure class="figure" id="fig1005">
<p class="fig"><img alt="screenshot of the wazuh agent manager window that shows information including the current version of wazuh, the agent, and the status. Text boxes below this information allow you to type in the Manager IP and the Authentication key. Below them are buttons to Save or Refresh." height="1052" src="images/nsp-enoka501485-fig1005.jpg" style="width:95%; height:auto;" width="1200"/></p>
<figcaption>
<p class="figh"><span class="fighn">Figure 10-5</span>: Wazuh agent configuration</p>
</figcaption>
</figure>
</li>
<li class="nl"><span aria-label="164" class="page" epub:type="pagebreak" id="p164" role="doc-pagebreak"/>7. Click <b>Manage▸Start</b> to start the agent.</li>
<li class="nl">8. Every time you add an agent or make a change to Security Onion or the systems that communicate with it, run the <code class="b">so-allow</code> script to enable communication between the devices (otherwise, the host firewall on Security Onion will block it). You should do this at the terminal, logged in to the Security Onion system via SSH:
              <pre>
<p class="cl3s">$ <code class="b">sudo so-allow</code></p>
</pre>
</li>
<li class="nll">9. When prompted, enter <code class="b">w</code> to add a firewall rule for a Wazuh agent; then enter the agent’s IP address.</li>
</ol>
<p>Wazuh will now manage this PC. Repeat the process for all other devices (computers, laptops, virtual machines, and so on) in your network that you want to manage in this way. System event logs will then start showing up in your Kibana dashboard, so expect to see new data and alerts in Security Onion.</p>
</section>
<section>
<h3 class="bh" id="bh1205"><a class="xref" href="nsp-enoka501485-0007.xhtml#rbh1205">Installing Wazuh on macOS</a></h3>
<p class="paft">To install the Wazuh agent on your macOS endpoint(s), follow these steps:</p>
<ol style="list-style-type:none">
<li class="nlf">1. Log in to your Security Onion console, click <b>Downloads</b>, and download the macOS package.</li>
<li class="nl">2. Run the installation wizard on your Mac.</li>
<li class="nl">3. Once complete, log in to your Security Onion system and run <code class="b">sudo so-allow</code> to allow your Mac access through the firewall (this must be done before agent registration; otherwise, the agent won’t be able to connect to the management server).</li>
<li class="nl">4. Following the prompts, choose the Wazuh registration service with <code class="b">r</code> and enter the IP address of your endpoint.</li>
<li class="nl">5. Now, register the agent with the Security Onion server:
              <pre>
<p class="cl3s">$ <code class="b">sudo /Library/Ossec/bin/agent-auth -m</code> <code class="bi">security_onion_IP</code></p>
</pre>
</li>
</ol>
<p>Next, you’ll add the Security Onion’s IP address to the agent configuration file on your Mac so the agent can communicate with the Security Onion server.</p>
<ol style="list-style-type:none">
<li class="nlf">6. Open <i>/Library/Ossec/etc/ossec.conf</i> with a text editor.</li>
<li class="nl">7. Find the following lines and change <code class="i">MANAGER_IP</code> to your Security Onion server’s IP address:
              <pre>
<p class="cl3f">&lt;client&gt;</p>
<p class="cl3">  &lt;server&gt;</p>
<p class="cl3l">    &lt;address&gt;<code class="i">MANAGER_IP</code>&lt;/address&gt;</p>
</pre>
</li>
<li class="nl">8. Restart the Wazuh agent:
              <pre>
<p class="cl3s"><span aria-label="165" class="page" epub:type="pagebreak" id="p165" role="doc-pagebreak"/>$ <code class="b">sudo /Library/Ossec/bin/ossec-control restart</code></p>
</pre>
</li>
<li class="nl">9. Confirm the agent has been successfully configured by listing the agents on the Security Onion server; run the <i>manage_agents</i> script and enter <code class="b">L</code> when prompted for an action:
              <pre>
<p class="cl3f">$ <code class="b">sudo docker exec -it so-wazuh /var/ossec/bin/manage_agents</code></p>
<p class="cl3"><code class="i">--snip--</code></p>
<p class="cl3">Choose your action: A,E,L,R or Q: <code class="b">L</code></p>
<p class="cl3">Available agents:</p>
<p class="cl3">   ID: 001, Name: securityonion, IP: 192.168.1.49</p>
<p class="cl3">   ID: 002, Name: Computer1, IP: 192.168.1.50</p>
<p class="cl3">   ID: 003, Name: MacBook-Pro.local, IP: 192.168.1.51</p>
<p class="cl3">** Press ENTER to return to the main menu.</p>
<p class="cl3"><code class="i">--snip--</code></p>
<p class="cl3">Choose your action: A,E,L,R or Q: <code class="b">Q</code></p>
<p class="cl3l">manage_agents: Exiting.</p>
</pre>
</li>
</ol>
<p>If you see the hostname and IP address of the Mac, the agent is active. Return to the main menu with <span class="ac">enter</span> and use the <code class="b">Q</code> option to quit.</p>
</section>
<section>
<h3 class="bh" id="bh1206"><a class="xref" href="nsp-enoka501485-0007.xhtml#rbh1206">Installing Wazuh on Linux</a></h3>
<p class="paft">To install the Wazuh agent on your Linux endpoint(s), follow these steps:</p>
<ol style="list-style-type:none">
<li class="nlf">1. Log in to your Security Onion console, click <b>Downloads</b>, and download the relevant package. For Ubuntu, this will be the DEB package (it’ll be the RPM package for CentOS and Fedora).
              <p class="nlp">You can download the package directly from your Ubuntu system, or you can download the package to your Windows or Mac computer and transfer it to your Ubuntu system:</p>
<pre>
<p class="cl3s">$ <code class="b">rsync -ruhP wazuh-agent.deb</code> <code class="bi">user@linux_ip</code><code class="b">:/home/</code><code class="bi">user</code></p>
</pre>
<p class="nlp">When installing packages directly from package files (like <i>.deb</i> files), use the dpkg utility instead of the APT package manager (dpkg is the Debian package manager and is used similarly to APT).</p>
</li>
<li class="nlf">2. To install the Wazuh agent, run the following:
              <pre>
<p class="cl3s">$ <code class="b">sudo dpkg -i wazuh-agent_</code><code class="i">3.13.1-1</code><code class="b">_amd64.deb</code></p>
</pre>
<p class="nlp">Your package’s version number may be different.</p>
</li>
<li class="nl">3. Next, log in to your Security Onion system via SSH and run <code class="b">sudo so-allow</code> to allow your Linux system access through the firewall.</li>
<li class="nl">4. Following the prompts, choose the Wazuh registration service with <code class="b">r</code> and enter your endpoint’s IP address.</li>
<li class="nl">5. Register the Linux agent and connect it to the Wazuh management server (that is, the Security Onion server):
              <pre>
<p class="cl3s"><span aria-label="166" class="page" epub:type="pagebreak" id="p166" role="doc-pagebreak"/>$ <code class="b">sudo /var/ossec/bin/agent-auth -m</code> <code class="bi">security_onion_IP</code></p>
</pre>
</li>
<li class="nl">6. Then, modify the configuration file on your Linux system to allow it to communicate with the management server by changing the <code class="i">MANAGER_IP</code> placeholder in the <i>ossec.conf</i> file to the IP address of your Security Onion server:
              <pre>
<p class="cl3f">$ <code class="b">sudo nano /var/ossec/etc/ossec.conf</code></p>
<p class="cl3"><code class="i">--snip--</code></p>
<p class="cl3">&lt;client&gt;</p>
<p class="cl3">  &lt;server&gt;</p>
<p class="cl3">    &lt;address&gt;<code class="i">security_onion_IP</code>&lt;/address&gt;</p>
<p class="cl3l"><code class="i">--snip--</code></p>
</pre>
</li>
<li class="nl">7. Restart the Wazuh agent to start sending data to Security Onion with this:
              <pre>
<p class="cl3s">$ <code class="b">sudo systemctl restart wazuh-agent</code></p>
</pre>
</li>
<li class="nl">8. Finally, confirm the agent has been successfully configured by listing the agents on the Security Onion server; run the <code class="b">manage_agents</code> script and enter <code class="b">L</code> when prompted for an action:
              <pre>
<p class="cl3f">$ <code class="b">sudo docker exec -it so-wazuh /var/ossec/bin/manage_agents</code></p>
<p class="cl3"><code class="i">--snip--</code></p>
<p class="cl3">Choose your action: A,E,L,R or Q: <code class="b">L</code></p>
<p class="cl3">Available agents:</p>
<p class="cl3">   ID: 001, Name: securityonion, IP: 192.168.1.49</p>
<p class="cl3">   ID: 002, Name: Computer1, IP: 192.168.1.50</p>
<p class="cl3">   ID: 003, Name: MacBook-Pro.local, IP: 192.168.1.51</p>
<p class="cl3">   ID: 004, Name: Linux1, IP: 192.168.1.52</p>
<p class="cl3">** Press ENTER to return to the main menu.</p>
<p class="cl3"><code class="i">--snip--</code></p>
<p class="cl3">Choose your action: A,E,L,R or Q: <code class="b">Q</code></p>
<p class="cl3l">manage_agents: Exiting.</p>
</pre>
</li>
<li class="nll">9. If you see the Linux computer’s hostname and IP address, the agent should be active. Press ENTER to return to the main menu, and enter <code class="b">Q</code> to quit.</li>
</ol>
<p>You can now manage all types of computers in your network with Wazuh.</p>
<p class="hd" id="hd1204"><a class="xref" href="nsp-enoka501485-0007.xhtml#rhd1204"><span class="ccust2">#38: Installing osquery</span></a></p>
<p class="paft">osquery provides improved visibility within your network. It gathers endpoint data such as the operating system details, installed software, command-line history, and details of running processes; you can then query this data to identify suspicious activity or devices not in compliance <span aria-label="167" class="page" epub:type="pagebreak" id="p167" role="doc-pagebreak"/>with your security policies or configurations. When used together with Wazuh, these tools provide a detailed view of the systems in your network and what each of them is doing or being used for, legitimately or not. Once installed, osquery uses a user interface called Fleet to display and manage the details of your monitored endpoints.</p>
</section>
<section>
<h3 class="bh" id="bh1207"><a class="xref" href="nsp-enoka501485-0007.xhtml#rbh1207">Installing osquery on Windows</a></h3>
<p class="paft">To install the osquery agent on your Windows endpoint(s), follow these steps:</p>
<ol style="list-style-type:none">
<li class="nlf">1. Log in to your Security Onion console, click <b>Downloads</b>, and download the osquery package for Windows (the MSI file).</li>
<li class="nl">2. Execute this file on your Windows system and complete the installation wizard.
              <p class="nlp">Once osquery is installed, it’ll be invisible and run in the background; there’s no user interface to deal with.</p>
</li>
<li class="nl">3. Next, log in to your Security Onion system via SSH and run <code class="b">sudo so-allow</code> to allow your computer and osquery access through the firewall. Enter <code class="b">o</code> (for osquery) and the IP address of your Windows system when prompted.</li>
<li class="nll">4. To view and manage systems with osquery, log in to your Security Onion console. In the left menu, click the <b>Fleet</b> link to open the Fleet Manager Dashboard.</li>
</ol>
<p>When you install osquery on an endpoint and after you run <code class="b">so-allow</code> to enable communication between the osquery agent and the Security Onion server, your managed hosts should show up here as cards; it can take a few minutes for communication to begin.</p>
</section>
<section>
<h3 class="bh" id="bh1208"><a class="xref" href="nsp-enoka501485-0007.xhtml#rbh1208">Installing osquery on macOS</a></h3>
<p class="paft">To install the osquery agent on your macOS endpoint(s), follow these steps:</p>
<ol style="list-style-type:none">
<li class="nlf">1. Log in to your Security Onion console, click <b>Downloads</b>, and download the osquery package for Mac (the PKG file).</li>
<li class="nl">2. Run <code class="b">sudo so-allow</code> on your Security Onion server and add your Mac to the list of allowed agents for osquery. Enter <code class="b">o</code> (for osquery) and the IP address of your Mac when prompted.</li>
<li class="nl">3. Execute the file you downloaded and complete the installation wizard on your Mac.</li>
<li class="nl">4. Log in to the Fleet Manager Dashboard and click <b>Add New Host</b> to find your Fleet Secret.</li>
<li class="nl">5. Add your Fleet Secret to the <i>/etc/so-launcher/secret</i> file using any text editor.</li>
<li class="nl">6. Update <i>/etc/so-launcher/launcher.flags</i> so the hostname value is <code class="bi">security_onion_IP</code><code class="b">:8090</code> and the root directory value is <code class="b">/var/so-launcher/</code><code class="bi">security_onion_IP</code><code class="b">-8090</code>:
              <pre>
<p class="cl3f"><span aria-label="168" class="page" epub:type="pagebreak" id="p168" role="doc-pagebreak"/>autoupdate</p>
<p class="cl3">hostname 192.168.1.200:8090</p>
<p class="cl3">root_directory /var/so-launcher/192.168.1.200-8090</p>
<p class="cl3">osqueryd_path /usr/local/so-launcher/bin/osqueryd</p>
<p class="cl3">enroll_secret_path /etc/so-launcher/secret</p>
<p class="cl3">update_channel stable</p>
<p class="cl3l">root_pem /etc/so-launcher/roots.pem</p>
</pre>
</li>
<li class="nll">7. Copy the contents of the <i>/etc/ssl/certs/intca.crt</i> file on your Security Onion server into the <i>/etc/so-launcher/roots.pem</i> file on your Mac.</li>
</ol>
<p>After a few minutes, your Mac should show up as a new card in the Fleet Manager Dashboard.</p>
</section>
<section>
<h3 class="bh" id="bh1209"><a class="xref" href="nsp-enoka501485-0007.xhtml#rbh1209">Installing osquery on Linux</a></h3>
<p class="paft">To install the osquery agent on your Linux endpoint(s), follow these steps:</p>
<ol style="list-style-type:none">
<li class="nlf">1. Log in to your Security Onion console, click <b>Downloads</b>, and download the osquery package for Linux (the DEB file for Ubuntu, RPM for CentOS, and so on).</li>
<li class="nl">2. Run <code class="b">sudo so-allow</code> on your Security Onion server to add your Linux system to the list of allowed agents for osquery. Enter <code class="b">o</code> (for osquery) and the IP address of your Linux system when prompted.</li>
<li class="nl">3. Install the downloaded file on your Linux system; here’s an example using dpkg on Ubuntu:
              <pre>
<p class="cl3s">$ <code class="b">sudo dpkg -i deb-launcher.deb</code></p>
</pre>
</li>
</ol>
<p>Your Linux system should automatically show up as a new card in your Fleet Manager dashboard.</p>
</section>
</section>
<section>
<h2 class="ah" id="ah1203"><a class="xref" href="nsp-enoka501485-0007.xhtml#rah1203">A Network Security Monitoring Crash Course</a></h2>
<p class="paft">You’ve now installed the necessary hardware and software to monitor your network for suspicious and malicious activity. You need to be able to identify issues, respond to incidents when they occur, and keep your network, users, and data secure. In this section, we’ll cover the fundamentals of how to configure and make use of osquery, Wazuh, and the Security Onion Alerts Dashboard.</p>
<section>
<h3 class="bh" id="bh1210"><a class="xref" href="nsp-enoka501485-0007.xhtml#rbh1210">Using osquery</a></h3>
<p class="paft">If you’re familiar with <i>relational databases</i> and <i>Structured Query Language (SQL)</i>, using osquery will be reasonably easy for you. If not, here are the basics. You can view all the data for the devices in your network that <span aria-label="169" class="page" epub:type="pagebreak" id="p169" role="doc-pagebreak"/>osquery manages in the Fleet Manager Dashboard. To reach the dashboard, log in to your Security Onion console at <i>https://&lt;security_onion_IP&gt;/</i> and click <b>Fleet</b> in the administrator menu on the left.</p>
<p>Data is stored in a series of <i>data tables</i>, wherein each table contains two or more columns (also called <i>tuples</i>) that include information such as hostname, IP address, MAC address, uptime, last shutdown time, and so on, for each device. Each row in the table relates to a specific entity, such as a computer or laptop, or something more atomic, like a specific user account on a device. For example, the <i>users</i> table looks similar to <a class="xref" href="nsp-enoka501485-0019.xhtml#tab1001">Table 10-1</a>.</p>
<table id="tab1001">
<thead>
<tr>
<th colspan="6">
<p class="th"><span class="thn">Table 10-1:</span> The osquery Users Table</p>
</th>
</tr>
<tr>
<th scope="col">
<p class="tch">UID</p>
</th>
<th scope="col">
<p class="tch">GID</p>
</th>
<th scope="col">
<p class="tch">UID_Signed</p>
</th>
<th scope="col">
<p class="tch">GID_Signed</p>
</th>
<th scope="col">
<p class="tch">Username</p>
</th>
<th scope="col">
<p class="tch">Description</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<p class="td">0</p>
</td>
<td>
<p class="td">0</p>
</td>
<td>
<p class="td">0</p>
</td>
<td>
<p class="td">0</p>
</td>
<td>
<p class="td">testuser</p>
</td>
<td>
<p class="td">A test user account</p>
</td>
</tr>
</tbody>
</table>
<p>The Username column’s first row of data pertains to the <i>testuser</i> account on a device. Each of these tables is related to one or more of the other tables in the database (of which there are more than 200). These tables and their relationships allow you to perform powerful queries about the details and status of each managed device.</p>
<p>We can ask questions of this data using a query language called SQL, a high-level language for accessing and manipulating databases. A SQL query looks like this:</p>
<pre>
<p class="cls"><code class="b">SELECT c1,c2 FROM tablename</code></p>
</pre>
<p class="pcon">In this query, the uppercase commands, <code>SELECT</code> and <code>FROM</code>, indicate the action you want to perform—in this case, asking for the data in columns 1 and 2, represented by the <code>c1</code> and <code>c2</code> parameters, from the table called <code>tablename</code>.</p>
<p>In practice, that query would look like this:</p>
<pre>
<p class="clf"><code class="b">SELECT username FROM users</code></p>
<p class="cll"><code class="b">SELECT * FROM users</code></p>
</pre>
<p class="pcon">The first command returns (displays to the user running the query) all the usernames that exist in the <code>users</code> table and no other columns. The second command returns all (<code>*</code>) of the columns and rows from the <code>users</code> table.</p>
<p class="pcust1"><span class="ccust1">Note</span> Several SQL commands are available for retrieving data in different ways; see the SQL cheat sheet at <a class="url-i" href="https://www.sqltutorial.org/sql-cheat-sheet/">https://www.sqltutorial.org/sql-cheat-sheet/</a> for more details. See also the osquery documentation at <a class="url-i" href="https://osquery.io/">https://osquery.io/</a> for a listing of all available tables and their data.</p>
<p>Fleet stores a lot of queries in your Fleet dashboard. Click the <b>Query</b> menu on the left of the page (see <a class="xref" href="nsp-enoka501485-0019.xhtml#fig1006">Figure 10-6</a>).</p>
<figure class="figure" id="fig1006">
<p class="fig"><span aria-label="170" class="page" epub:type="pagebreak" id="p170" role="doc-pagebreak"/><img alt="fleet manager’s query menu shows a search bar, stored queries, and options to manage queries or begin a new query." height="901" src="images/nsp-enoka501485-fig1006.jpg" style="width:95%; height:auto;" width="1200"/></p>
<figcaption>
<p class="figh"><span class="fighn">Figure 10-6</span>: Stored SQL queries in Fleet Manager</p>
</figcaption>
</figure>
<p>From this menu, you can scroll through the available queries or search for a specific query using the search bar at the top of the page. Once you’ve identified a query you want to run, click to select it, and then click the <b>EDIT/RUN QUERY</b> button on the right side. Before you’re able to execute the query, you need to select the devices you want to query for this information. Select the relevant device(s) from the Select Targets drop-down menu and then click <b>Run</b>. When the query completes, Fleet will present you with the results of the query at the bottom of the screen; you can filter the results using the column filters provided.</p>
<p>It’s up to you which queries you run, and it depends on what kinds of problems or examples of noncompliance are most concerning to your network. However, these are a few good places to start:</p>
<p class="pcust2"><code class="b">users</code> Useful for identifying user accounts that should or should not exist on given endpoints</p>
<p class="pcust2"><code class="b">browser_plugins</code> Shows all browser plug-ins on a device(s); useful if your users install potentially malicious browser plug-ins</p>
<p class="pcust2"><code class="b">chrome_extension</code> As previously, specifically looking for Chrome plug-ins</p>
<p class="pcust2"><code class="b">crontab</code> Identifies scheduled tasks on Linux systems performing suspicious or malicious activity</p>
<p class="pcust2"><code class="b">disk_free_space_pct</code> Identifies devices with low disk space</p>
<p class="pcust2"><code class="b">installed_applications</code> Identifies malicious or potentially unwanted applications installed on devices</p>
<p>The Hosts dashboard in Fleet shows the details for each managed device at a glance in the form of cards (see <a class="xref" href="nsp-enoka501485-0019.xhtml#fig1007">Figure 10-7</a>).</p>
<figure class="figure" id="fig1007">
<p class="fig"><span aria-label="171" class="page" epub:type="pagebreak" id="p171" role="doc-pagebreak"/><img alt="The Fleet Host dashboard shows information for various devices." height="1200" src="images/nsp-enoka501485-fig1007.jpg" style="width:95%; height:auto;" width="1199"/></p>
<figcaption>
<p class="figh"><span class="fighn">Figure 10-7</span>: Fleet Host dashboard view</p>
</figcaption>
</figure>
<p>Here you can see the hostname, operating system, osquery version, processor details, amount of RAM, uptime, MAC address, and IP address of this host. Clicking the blue query button (the stacked cylinders) at the top right will allow you to easily query this device.</p>
<p>Spend some time familiarizing yourself with the available queries and do some online research to find other potentially useful queries. Try reviewing some of the saved queries and edit or copy them to get the queries you want.</p>
</section>
<section>
<h3 class="bh" id="bh1211"><a class="xref" href="nsp-enoka501485-0007.xhtml#rbh1211">Using Wazuh</a></h3>
<p class="paft">We installed the Wazuh agent in <a class="xref" href="nsp-enoka501485-0019.xhtml#hd1201">Project 35</a>, and we’ll configure it in this section. Wazuh allows us to review the logs and alerts in Security Onion, which we’ll explore in the next section.</p>
<p>The primary Wazuh config file is located at <i>/opt/so/conf/wazuh/ossec.conf</i> on the Security Onion system. Each section of this configuration file is separate and identified with a line like the following:</p>
<pre>
<p class="cls">&lt;!-- Files/directories to ignore --&gt;</p>
</pre>
<p>You can revise the settings in this file to change the way Wazuh behaves, which can be useful if, for example, Wazuh reacts to a false positive detection and stops you from doing something benign. Review this file to get an understanding of the types of things Wazuh monitors for.</p>
<p>The section shown in the following snippet specifies files that contain lists of files that are known or expected to be malicious based on identified adversary behaviors, followed by files that are expected to contain trojans (a type of virus) and then files and folders to audit for various vulnerabilities:</p>
<div class="codeline1">
<p class="cl1f"><span aria-label="172" class="page" epub:type="pagebreak" id="p172" role="doc-pagebreak"/><code class="i">--snip--</code></p>
<p class="cl1">&lt;rootkit_files&gt;/var/ossec/etc/shared/rootkit_files.txt&lt;/rootkit_files&gt;</p>
<p class="cl1">    &lt;rootkit_trojans&gt;/var/ossec/etc/shared/rootkit_trojans.txt&lt;/rootkit_trojans&gt;</p>
<p class="cl1">    &lt;system_audit&gt;/var/ossec/etc/shared/system_audit_rcl.txt&lt;/system_audit&gt;</p>
<p class="cl1">    &lt;system_audit&gt;/var/ossec/etc/shared/system_audit_ssh.txt&lt;/system_audit&gt;</p>
<p class="cl1">    &lt;system_audit&gt;/var/ossec/etc/shared/cis_rhel7_linux_rcl.txt&lt;/system_audit&gt;</p>
<p class="cl1l"><code class="i">--snip--</code></p>
</div>
<p>Each of these files contains a list of things Wazuh will monitor. If the agent detects a file or configuration on a device that matches a behavior or setting in the <i>rootkit_files.txt</i> file, it will take action to remediate that threat. If you don’t want it to take that action, delete or comment out that line in the configuration file with a <code>#</code>.</p>
<p>When you update Wazuh as part of your efforts to consistently update and patch your Security Onion and other systems, the configuration files such as <i>rootkit_files.txt</i> may also receive updates. This ensures that as new threats are identified and indicators of compromise are made publicly available, your network stays protected. To avoid losing any changes you make to these files, consider creating new, custom configuration files (such as <i>my_custom_trojans.txt</i>) and adding a reference to this file in the <i>ossec.conf</i> file, such as the following example:</p>
<div class="codeline1">
<p class="cl1f"><code class="i">--snip--</code></p>
<p class="cl1">&lt;rootkit_files&gt;/var/ossec/etc/shared/rootkit_files.txt&lt;/rootkit_files&gt;</p>
<p class="cl1">    &lt;rootkit_trojans&gt;/var/ossec/etc/shared/rootkit_trojans.txt&lt;/rootkit_trojans&gt;</p>
<p class="cl1">    &lt;rootkit_trojans&gt;/var/ossec/etc/shared/my_custom_trojans.txt&lt;/rootkit_trojans&gt;</p>
<p class="cl1l"><code class="i">--snip--</code></p>
</div>
<p>Adding files to the <i>ossec.conf</i> file will result in Wazuh referring to those files for its configuration and settings, in addition to its default configuration files. Using custom files is a good way to add custom configurations that you might have.</p>
<p>If you want Wazuh to ignore a directory or list of directories on any of the endpoints on which it’s installed, add that information in the relevant section. You can also tell the agent to ignore specific files or file types, to exclude certain devices from active response (if you want the agent to never block activity on a specific device that might impact your network), and to set various other options. Familiarize yourself with these configuration files so you can tailor them to your environment.</p>
</section>
<section>
<h3 class="bh" id="bh1212"><a class="xref" href="nsp-enoka501485-0007.xhtml#rbh1212">Using Security Onion as a SIEM Tool</a></h3>
<p class="paft">Security Onion, in addition to the other useful capabilities it provides, acts as a <i>security information and event management (SIEM)</i> tool. Several SIEMs are available on the market, including Splunk, SolarWinds, or ManageEngine, all of which are commercial solutions and can be very expensive. Security Onion, on the other hand, is open source and free.</p>
<p><span aria-label="173" class="page" epub:type="pagebreak" id="p173" role="doc-pagebreak"/>A SIEM is designed to aggregate data from devices in a network and act as a central repository for logs and other data. Implementing a SIEM like Security Onion centralizes your logs, making it harder for an adversary to hide their tracks by deleting the logs on any one system. It also enables you to query your logs and other system data in one location so you don’t have to check every system or device individually, streamlining the process. Security Onion then analyzes this data and alerts you to potentially malicious activity. <a class="xref" href="nsp-enoka501485-0019.xhtml#fig1008">Figure 10-8</a> shows a list of alerts, found by logging in to the Security Onion console and clicking the Alerts option in the menu on the left.</p>
<figure class="figure" id="fig1008">
<p class="fig"><img alt="Security Onion’s alerts are listed in rows with the following columns: Count, rule.name, event.module, event.severity_label. For severity labels marked “low,” a yellow bell icon is at the start (the very left) of the row; for those marked “medium,” an orange bell icon is present; for “high,” the bell icon is red. For example, the first alert listed has a yellow bell, a count of 14,102 instances, a rule.name “Windows Logon Success,” the event.module “windows_eventlog,” and an event.severity_label of “low.”" height="474" src="images/nsp-enoka501485-fig1008.jpg" style="width:95%; height:auto;" width="1200"/></p>
<figcaption>
<p class="figh"><span class="fighn">Figure 10-8</span>: Security Onion alerts</p>
</figcaption>
</figure>
<p>When you click an alert, a context menu is displayed with filtering options; you can include, exclude, show only, or group by the alert you’ve selected. You can also drill down into an alert to show every instance of the alert in the timeframe you’re filtering for. By expanding any of these alerts, you can see all of its information, including metadata (see <a class="xref" href="nsp-enoka501485-0019.xhtml#fig1009">Figure 10-9</a>) such as the alert’s timestamp, the source and destination IP address of the network traffic, the full message associated with the alert, the actual decoded network data that caused the rule or alert to fire, the rule itself, and often a reference so that you can learn more about the alert, including potential remediation steps or other solutions.</p>
<figure class="figure" id="fig1009">
<p class="fig"><img alt="Security Onion alert’s metadata includes the following information for each alert: rule.name, rule.reference, rule.rev, rule.rule, rule.ruleset, rule.severity, rule.uuid, source.ip, and source.port." height="188" src="images/nsp-enoka501485-fig1009.jpg" style="width:95%; height:auto;" width="1200"/></p>
<figcaption>
<p class="figh"><span class="fighn">Figure 10-9</span>: Security Onion alert metadata</p>
</figcaption>
</figure>
<p>In practice, the alerts dashboard will show a lot of different categories and types of activity; you’ll almost always see alerts that require further investigation. Let’s discuss a few to help get you started.</p>
<table id="tab1002">
<thead>
<tr>
<th colspan="3">
<p class="th"><span aria-label="174" class="page" epub:type="pagebreak" id="p174" role="doc-pagebreak"/><span class="thn">Table 10-2:</span> Examples of Potentially Unwanted Software in an Environment</p>
</th>
</tr>
<tr>
<th scope="col">
<p class="tch">Rule name</p>
</th>
<th scope="col">
<p class="tch">Event module</p>
</th>
<th scope="col">
<p class="tch">Severity</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<p class="td">ET INFO [eSentire] Possible Kali Linux Updates</p>
</td>
<td>
<p class="td">suricata</p>
</td>
<td>
<p class="td">high</p>
</td>
</tr>
<tr>
<td>
<p class="td">ET USER_AGENTS Steam HTTP Client User-Agent</p>
</td>
<td>
<p class="td">suricata</p>
</td>
<td>
<p class="td">high</p>
</td>
</tr>
<tr>
<td>
<p class="td">ET POLICY curl User-Agent Outbound</p>
</td>
<td>
<p class="td">suricata</p>
</td>
<td>
<p class="td">medium</p>
</td>
</tr>
<tr>
<td>
<p class="td">ET POLICY <a class="url" href="http://www.Dropbox.com">Dropbox.com</a> Offsite File Backup in Use</p>
</td>
<td>
<p class="td">suricata</p>
</td>
<td>
<p class="td">high</p>
</td>
</tr>
<tr>
<td>
<p class="td">ET SCAN Possible Nmap User-Agent Observed</p>
</td>
<td>
<p class="td">suricata</p>
</td>
<td>
<p class="td">high</p>
</td>
</tr>
<tr>
<td>
<p class="td">ET TFTP Outbound TFTP Read Request</p>
</td>
<td>
<p class="td">suricata</p>
</td>
<td>
<p class="td">high</p>
</td>
</tr>
<tr>
<td>
<p class="td">ET P2P eMule KAD Network Connection Request</p>
</td>
<td>
<p class="td">suricata</p>
</td>
<td>
<p class="td">high</p>
</td>
</tr>
</tbody>
</table>
<p><a class="xref" href="nsp-enoka501485-0019.xhtml#tab1002">Table 10-2</a> shows several examples of software that is potentially vulnerable, could lead to or be used for malicious activity, or shouldn’t be on your network in the first place. Kali Linux, for example, is typically used for penetration testing, but attackers can also use it to compromise your network. If you receive this alert, investigate it, identify the system responsible, and remove it from the network. Security Onion provides all of the information you need to do this. You could choose to take the source IP address in the alert and add firewall rules (on your hosts as well as your border firewall) to block all traffic to and from that address, as an example of one mitigation strategy.</p>
<p>Looking at the other alerts in <a class="xref" href="nsp-enoka501485-0019.xhtml#tab1002">Table 10-2</a>, several pieces of software have been identified that might not be allowed or necessary in your network. Steam is a game client. Curl is a utility for transferring data to or from a server and can be used to exfiltrate data from your network or download malware. Dropbox is a cloud storage solution that can likewise be used to exfiltrate or steal data. Nmap is a network mapping tool that attackers can use to identify potential targets and vulnerabilities within your network. Trivial File Transfer Protocol (TFPT) is a vulnerable protocol used for transferring files, and eMule is a peer-to-peer application typically used for file sharing.</p>
<p>Generally, if you aren’t using a tool or application, you should uninstall or otherwise remove it to prevent attackers from using it and make your network more secure. If you don’t use curl, for example, track down the client responsible for this alert using the hostname, source and destination IP address, or other metadata in the alert itself, and uninstall or remove the offending software. If you use Dropbox, you can safely ignore the alert. Otherwise, investigate and remove it from your network. Do this for all software-related alerts.</p>
<p>Then, use the same process to investigate and remediate all the alerts related to potential malware activity; <a class="xref" href="nsp-enoka501485-0019.xhtml#tab1003">Table 10-3</a> shows an example. Drill down into each alert, identify the device(s) related to the alert, look at the references for the rule behind the alert, and identify and resolve the root cause. If you get stuck, an internet search is usually the best tool to solve a lot of problems.</p>
<table id="tab1003">
<thead>
<tr>
<th colspan="3">
<p class="th"><span aria-label="175" class="page" epub:type="pagebreak" id="p175" role="doc-pagebreak"/><span class="thn">Table 10-3:</span> Possible Malware Alerts in Security Onion</p>
</th>
</tr>
<tr>
<th scope="col">
<p class="tch">Rule name</p>
</th>
<th scope="col">
<p class="tch">Event module</p>
</th>
<th scope="col">
<p class="tch">Severity</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<p class="td">ET JA3 Hash - [Abuse.ch] Possible Adware</p>
</td>
<td>
<p class="td">suricata</p>
</td>
<td>
<p class="td">Low</p>
</td>
</tr>
<tr>
<td>
<p class="td">ET JA3 Hash - Possible Malware - Neutrino</p>
</td>
<td>
<p class="td">suricata</p>
</td>
<td>
<p class="td">Low</p>
</td>
</tr>
<tr>
<td>
<p class="td">ET INFO Packed Executable Download</p>
</td>
<td>
<p class="td">suricata</p>
</td>
<td>
<p class="td">Low</p>
</td>
</tr>
<tr>
<td>
<p class="td">ET INFO EXE IsDebuggerPresent (Used in Malware Anti-Debugging)</p>
</td>
<td>
<p class="td">suricata</p>
</td>
<td>
<p class="td">Low</p>
</td>
</tr>
<tr>
<td>
<p class="td">ET EXPLOIT Possible OpenSSL HeartBleed Large HeartBeat Response (Client Init Vuln Server)</p>
</td>
<td>
<p class="td">suricata</p>
</td>
<td>
<p class="td">Medium</p>
</td>
</tr>
<tr>
<td>
<p class="td">ET EXPLOIT Possible OpenSSL HeartBleed Large HeartBeat Response (Server Init Vuln Client)</p>
</td>
<td>
<p class="td">suricata</p>
</td>
<td>
<p class="td">Medium</p>
</td>
</tr>
</tbody>
</table>
<p>Other alerts of interest are those related to account login or log-off actions and elevation of privileges, such as Successful sudo to ROOT executed, as shown in <a class="xref" href="nsp-enoka501485-0019.xhtml#tab1004">Table 10-4</a>.</p>
<table id="tab1004">
<thead>
<tr>
<th colspan="3">
<p class="th"><span class="thn">Table 10-4:</span> Successful and Failed Login Alerts in Security Onion</p>
</th>
</tr>
<tr>
<th scope="col">
<p class="tch">Rule name</p>
</th>
<th scope="col">
<p class="tch">Event module</p>
</th>
<th scope="col">
<p class="tch">Severity</p>
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<p class="td">Windows Logon Success</p>
</td>
<td>
<p class="td">windows_eventlog</p>
</td>
<td>
<p class="td">Low</p>
</td>
</tr>
<tr>
<td>
<p class="td">PAM: Login session closed.</p>
</td>
<td>
<p class="td">ossec</p>
</td>
<td>
<p class="td">Low</p>
</td>
</tr>
<tr>
<td>
<p class="td">PAM: Login session opened.</p>
</td>
<td>
<p class="td">ossec</p>
</td>
<td>
<p class="td">Low</p>
</td>
</tr>
<tr>
<td>
<p class="td">Successful sudo to ROOT executed.</p>
</td>
<td>
<p class="td">ossec</p>
</td>
<td>
<p class="td">Low</p>
</td>
</tr>
<tr>
<td>
<p class="td">Logon Failure - Unknown user or bad password</p>
</td>
<td>
<p class="td">windows_eventlog</p>
</td>
<td>
<p class="td">Low</p>
</td>
</tr>
</tbody>
</table>
<p>While successful logon attempts alert you to accounts that may already be compromised, failed logon attempts can alert you to an attacker trying to break in. In both cases, investigate those alerts to determine whether it’s legitimate activity. If, for example, you see an account increasing their privileges to root on a Linux system, determine whether it was you or another trusted user in your network. If it wasn’t you or another administrator in your network, change your passwords and investigate any related activity that occurred around the same time.</p>
</section>
</section>
<section>
<h2 class="ah" id="ah1204"><a class="xref" href="nsp-enoka501485-0007.xhtml#rah1204">Summary</a></h2>
<p class="paft">Security Onion’s alerts provide a starting point for you to identify and chase down suspicious activity; use them to your advantage when securing your network. Use every tool you have at your disposal, as you can be sure that adversaries are doing the same. Simply increasing the visibility of activity on your network enables you to better protect it. With the instructions and tools described in this chapter, you’ll soon find a multitude of potential activity to investigate and remediate. Expect this investigation activity to be ongoing and try to keep up with the alerts in Security Onion as your network continues to grow and evolve over time.</p>
</section>
</section>
</div></body></html>