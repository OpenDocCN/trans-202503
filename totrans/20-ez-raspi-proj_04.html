<html><head></head><body>
<h2 class="h1-part" id="part03"><span epub:type="pagebreak" id="page_125"/><span class="violet">Sensors</span></h2>


<h2 class="h2" id="ch09"><span epub:type="pagebreak" id="page_126"/><strong>9<br/>All-in-One Weather Sensor Station</strong></h2>
<p class="noindent"><span class="violet">In this project, you’ll build a local weather station that detects the temperature, humidity, and barometric pressure with the Sense HAT. You’ll also create a graphical user interface to display temperature, humidity, and barometric pressure readings in real time.</span></p>
<div class="image"><span epub:type="pagebreak" id="page_127"/><img src="../images/f0127-01.jpg" alt="image"/></div>
<p class="cap"><span class="violet"><strong>PARTS REQUIRED</strong></span></p>
<p class="cap1">Raspberr y Pi (versions with 40 GPIOs)</p>
<p class="cap1">Sense HAT</p>
<h3 class="h3" id="lev97"><span epub:type="pagebreak" id="page_128"/><span class="violet"><strong>THE SENSE HAT AS A WEATHER STATION</strong></span></h3>
<p class="noindent">The Sense HAT makes an excellent small and affordable weather station, as it comes with temperature, humidity, and barometric pressure sensors. Reading sensor values with the Sense HAT is very straightforward, so this is a good starting point to learn about sensor readings.</p>
<h4 class="h4" id="lev98"><span class="violet"><strong>The Temperature Sensor</strong></span></h4>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>The temperature readings might be a few degrees off when compared to the real value. The Sense HAT fits over the Pi and the heat from the Raspberry Pi processor can alter the results slightly.</em></p>
</div>
<p class="noindent">As the name suggests, the temperature sensor measures temperature. By default, the Sense HAT reads the temperature in degrees Celsius, so if you prefer the temperature in degrees Fahrenheit, you’ll need to convert the reading. To do so, multiply the degrees in Celsius by 9, divide by 5, and add 32, as shown in the following formula.</p>
<div class="image1"><img src="../images/f0128-01.jpg" alt="image"/></div>
<p class="indent">You can add this formula to your code so that it does the conversion for you.</p>
<h4 class="h4" id="lev99"><span class="violet"><strong>The Humidity Sensor</strong></span></h4>
<p class="noindent">There are two common ways of expressing humidity: absolute humidity and relative humidity. <em>Absolute humidity</em> is the mass of water vapor in a certain volume of air, regardless of temperature, and it is expressed as kilograms per cubic meter (kg/m<sup>3</sup>). The amount of water vapor that the air can hold changes with temperature. The higher the temperature, the more water vapor it can hold. <em>Relative humidity</em> is expressed as a percentage and is the current water vapor in the air in relation to the maximum possible amount at a given temperature.</p>
<p class="indent">The Sense HAT records relative humidity because it’s more useful for weather forecasts: the greater the relative humidity percentage, the higher the probability of precipitation. As relative humidity changes with temperature, it’s always coupled with a temperature sensor.</p>
<h4 class="h4" id="lev100"><span class="violet"><strong>The Barometric Pressure Sensor</strong></span></h4>
<p class="noindent">The barometric pressure sensor reads atmospheric pressure, the “weight” of the air at a given point, measured in hPa (hectoPascal), which is equivalent to mbar (millibar). Why is it interesting to measure pressure? Because changes in atmospheric pressure can help you forecast the weather. Rising pressure tends to be a sign of good weather to come, and falling pressure a sign of bad weather, like rain or storms.</p>
<p class="indent"><span epub:type="pagebreak" id="page_129"/>Changes in pressure are really small. You need to follow your barometer readings meticulously to notice a trend.</p>
<h3 class="h3" id="lev101"><span class="violet"><strong>READING TEMPERATURE, HUMIDITY, AND PRESSURE</strong></span></h3>
<p class="noindent">Now let’s look at how to read from the sensors and print the readings to the Python shell.</p>
<p class="indent">Mount your Sense HAT on your Pi like you did in <a href="ch08.xhtml#ch08">Project 8</a> and make sure it’s well connected. When it’s first connected, the Sense HAT should display a rainbow background that matches the rainbow you see on the screen when you boot your Pi (see <a href="ch09.xhtml#ch09fig1">Figure 9-1</a>).</p>
<div class="image"><a id="ch09fig1"/><img src="../images/f0129-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 9-1:</strong> Sense HAT rainbow background</p>
<p class="indent">Inside your <em>Projects</em> folder create a new folder called <em>Sensors</em>. Then open <strong>Python 3 (IDLE)</strong> and go to <strong>File</strong> <span class="ent">▸</span> <strong>New</strong> to create a new script called <em>weather_data.py</em> and enter the code in <a href="ch09.xhtml#ch09list1">Listing 9-1</a> (remember that you can download all the scripts at <em><a href="https://www.nostarch.com/RaspberryPiProject/">https://www.nostarch.com/RaspberryPiProject/</a></em> ).</p>
<p class="listing" id="ch09list1"><strong>LISTING 9-1:</strong> Reading temperature, humidity, and pressure with the Sense HAT</p>
<div class="box">
<p class="programs"><span class="ent">➊</span> <span class="orange">from</span> sense_hat <span class="orange">import</span> SenseHat<br/>  <span class="red1">#from sense_emu import SenseHat</span><br/><br/>  <span class="orange">from</span> time <span class="orange">import</span> sleep<br/><br/>  <span class="red1">#create an object called sense</span><br/><span class="ent">➋</span> sense = SenseHat()<br/><br/>  <span class="orange">while True</span>:<br/>   <span class="ent">➌</span> temperature = sense.temperature<br/>   <span class="ent">➍</span> temperature = <span class="purple">str</span>(<span class="purple">round</span>(temperature, 2))<br/>   <span class="ent">➎</span> <span class="purple">print</span>(<span class="green">'Temperature: '</span> + temperature + <span class="green">'*C\n'</span>)<br/><span epub:type="pagebreak" id="page_130"/>     humidity = sense.humidity<br/>     humidity = <span class="purple">str</span>(<span class="purple">round</span>(humidity, 2))<br/>     <span class="purple">print</span> (<span class="green">'Humidity: '</span> + humidity + <span class="green">'%\n'</span>)<br/><br/>     pressure = sense.pressure<br/>     pressure = <span class="purple">str</span>(<span class="purple">round</span>(pressure, 2))<br/>     <span class="purple">print</span>(<span class="green">'Pressure: '</span> + pressure + <span class="green">'hPa\n'</span>)<br/><br/>     sleep(1)</p>
</div>
<p class="indent">First you import the <span class="literal">SenseHat</span> class from the sense_hat library <span class="ent">➊</span>. Then, you create an object called <span class="literal">sense</span> to refer to the Sense HAT <span class="ent">➋</span>.</p>
<p class="indent">Getting the sensor readings <span class="ent">➌</span> is simple thanks to the following, aptly named functions:</p>
<ul>
<li class="noindent"><span class="literal">sense.temperature</span> gets the temperature reading.</li>
<li class="noindent"><span class="literal">sense.humidity</span> gets the humidity reading.</li>
<li class="noindent"><span class="literal">sense.pressure</span> gets the pressure reading.</li>
</ul>
<p class="indent">The readings are given to several decimal places, so you use the function <span class="literal">round()</span> to round the numbers and make the results more readable. The <span class="literal">round()</span> function <span class="ent">➍</span> accepts as arguments the number you want to round and the number of decimal places you want to set, in that order—here, it’s set to two decimal places. You also use the <span class="literal">str()</span> function that converts the argument it takes into a string. You need to convert the readings into a string so you can concatenate them with the text you’ll print to the shell <span class="ent">➎</span>.</p>
<p class="indent">Now you’re almost a meteorologist! Next, you’ll build a user interface for your weather data.</p>
<h3 class="h3" id="lev102"><span class="violet"><strong>BUILDING A USER INTERFACE FOR YOUR READINGS</strong></span></h3>
<p class="noindent">Let’s take this project to another level and build a cool user interface to display your sensor readings. Your interface should feature:</p>
<ul>
<li class="noindent">A window in your desktop that displays temperature, humidity, and pressure</li>
<li class="noindent">The humidity displayed in a vertical progress bar from 0 to 100 percent</li>
<li class="noindent">The temperature and pressure displayed in numbers</li>
<li class="noindent">Labels for each reading</li>
</ul>
<p class="indent"><a href="ch09.xhtml#ch09fig2">Figure 9-2</a> shows a draft layout for the user interface that should help you work out how to go about the code.</p>
<div class="image"><span epub:type="pagebreak" id="page_131"/><a id="ch09fig2"/><img src="../images/f0131-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 9-2:</strong> Graphical user interface draft</p>
<p class="indent">You’ll also be able to edit the code to choose font type, size, and color, and how labels and readings are positioned within the window. The following table gives you a list of all the titles and values and how we’ll display them.</p>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="border_th-l"><p class="tab_th"><strong>WIDGET</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>OPTIONS</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">Window Title</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="violet">Text: “Local Weather Station”</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">Humidity Title</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="violet">Text: “Humidity”, Font: Helvetica, Size: 18, Vertical padding: 3</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">Humidity Value</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="violet">Font: Courier, Size: 20, Color: Blue, Position: North</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">Humidity Progress Bar</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="violet">Orientation: Vertical, Size: 20, Color: Blue, Position: North, Length: 200, Maximum Value: 100</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">Temperature Title</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="violet">Text: “Temperature”, Font: Helvetica, Size: 18, Position: South</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">Temperature Value</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="violet">Font: Courier, Size: 20, Color: Red, Position: North</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">Pressure Title</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="violet">Text: “Pressure”, Font: Helvetica, Size: 18, Position: South</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">Pressure Value</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="violet">Font: Courier, Size: 20, Color: Green, Position: North</span></p></td>
</tr>
</tbody>
</table>
<h3 class="h3" id="lev103"><span class="violet"><strong>WRITING THE SCRIPT</strong></span></h3>
<p class="noindent">Open <strong>Python 3 (IDLE)</strong> and go to <strong>File</strong> <span class="ent">▸</span> <strong>New File</strong> to create a new script. Copy the code in <a href="ch09.xhtml#ch09list2">Listing 9-2</a> to the Python Editor and save the script as <em>weather_station.py</em> inside the <em>Sensors</em> folder (remember <span epub:type="pagebreak" id="page_132"/>that you can download all the scripts at <em><a href="https://www.nostarch.com/RaspberryPiProject/">https://www.nostarch.com/RaspberryPiProject/</a></em>):</p>
<p class="listing" id="ch09list2"><strong>LISTING 9-2:</strong> Displaying the Sense HAT readings in a graphical user interface</p>
<div class="box">
<p class="programs">  <span class="red1">#import necessary libraries</span><br/><span class="ent">➊</span> <span class="orange">from</span> tkinter <span class="orange">import</span> *<br/>  <span class="orange">from</span> tkinter <span class="orange">import</span> ttk<br/>  <span class="orange">import</span> time<br/>  <span class="orange">from</span> sense_hat <span class="orange">import</span> SenseHat<br/>  <span class="red1">#from sense_emu import SenseHat</span><br/><br/>  <span class="red1">#create an object called sense</span><br/>  sense = SenseHat()<br/><br/>  <span class="red1">#create window</span><br/><span class="ent">➋</span> window = Tk()<br/>  window.title(<span class="green">'Local Weather Station'</span>)<br/>  window.geometry(<span class="green">'200x480'</span>)<br/><br/>  <span class="red1">#create humidity label for title and value</span><br/><span class="ent">➌</span> humidity_label = Label(window, text = <span class="green">'Humidity'</span>, font =<br/>  (<span class="green">'Helvetica'</span>, 18), pady = 3)<br/>  humidity_label.pack()<br/><br/><span class="ent">➍</span> humidity = StringVar()<br/><br/><span class="ent">➎</span> humidity_value=Label(window, textvariable = humidity,font =<br/>  (<span class="green">'Courier'</span>, 20), fg = <span class="green">'</span><span class="green">blue'</span>, anchor = N, width = 200)<br/>  humidity_value.pack()<br/><br/>  <span class="red1">#create humidity canvas</span><br/><span class="ent">➏</span> humidity_canvas = Canvas(window, width = 200, height = 200)<br/>  humidity_canvas.pack()<br/><br/>  <span class="red1">#create humidity progress bar</span><br/><span class="ent">➐</span> humidity_bar = DoubleVar()<br/><br/><span class="ent">➑</span> progressbar_humidity = ttk.Progressbar(humidity_canvas, variable =<br/>  humidity_bar, orient = VERTICAL, length = 200, maximum = 100)<br/>  progressbar_humidity.pack(fill=X, expand=1)<br/><br/>  <span class="red1">#create temperature label for title and value</span><br/>  temperature_label = Label(window, text = <span class="green">'Temperature'</span>, font =<br/>  (<span class="green">'Helvetica'</span>, 18),anchor = S, width = 200, height = 2)<br/>  temperature_label.pack()<br/><br/>  temperature = StringVar()<br/><br/>  temperature_value = Label(window, textvariable = temperature, font =<br/>  (<span class="green">'</span><span class="green">Courier'</span>, 20),fg = <span class="green">'red'</span>, anchor = N, width = 200)<br/>  temperature_value.pack()<br/><br/>  <span class="red1">#create pressure label for title and value</span><br/><span epub:type="pagebreak" id="page_133"/>  pressure_label = Label(window, text = <span class="green">'Pressure'</span>, font =<br/>  (<span class="green">'Helvetica'</span>, 18), anchor = S, width = 200, height = 2)<br/>  pressure_label.pack()<br/><br/>  pressure = StringVar()<br/><br/>  pressure_value = Label(window, textvariable = pressure, font =<br/>  (<span class="green">'Courier'</span>, 20), fg = <span class="green">'green'</span>, anchor = N, width = 200)<br/>  pressure_value.pack()<br/><br/><span class="ent">➒</span> <span class="orange">def</span> <span class="blue">update_readings</span>():<br/>      humidity.set(<span class="purple">str</span>(<span class="purple">round</span>(sense.humidity, 2)) + <span class="green">'%'</span>)<br/>      humidity_bar.set(sense.humidity)<br/>      temperature.set(<span class="purple">str</span>(<span class="purple">round</span>(sense.temperature, 2)) + <span class="green">'°C'</span>)<br/>      <span class="red1">#temperature.set(str(round(sense.temperature*(9/5)+32, 2))</span><br/>  <span class="red1">+ '*F')</span><br/>      pressure.set(<span class="purple">str</span>(<span class="purple">round</span>(sense.pressure)) + <span class="green">'hPa'</span>)<br/>      window.update_idletasks()<br/>      window.after(3000, update_readings)<br/><br/><span class="ent">➓</span> update_readings()<br/>  window.mainloop()</p>
</div>
<p class="indent">As usual, you start the code by importing the necessary libraries <span class="ent">➊</span>. You may wonder why we need to import ttk if we’ve already imported everything with <span class="literal">*</span> from the tkinter library in the previous line. In this case, when you import with the wildcard <span class="literal">*</span>, you’re importing only a subset of what’s stored in the library folder—there isn’t any particular reason for this, it’s just the way the author of the library decided to do it—so we need to import the ttk library that’s also needed for this user interface separately.</p>
<p class="indent">To gather weather data, you need to use the physical Sense HAT and the sense_hat library.</p>
<h4 class="h4" id="lev104"><span class="violet"><strong>Creating the User Interface</strong></span></h4>
<p class="noindent">After importing all of the libraries, you implement the part of the code that creates the user interface. First, you create a window that’s 200×480 pixels and give it the title <span class="literal">Local Weather Station</span> <span class="ent">➋</span>. Then, you create a label for the humidity title <span class="ent">➌</span> with the settings shown in the table on <a href="ch09.xhtml#page_131">page 131</a>. At <span class="ent">➍</span>, you create a string variable called <span class="literal">humidity</span> that will hold the humidity value. This value is then displayed at <span class="ent">➎</span>.</p>
<p class="indent">The lines of code at <span class="ent">➏</span> create a canvas to place the progress bar in—the canvas is like a reserved space for the progress bar. After that, the code initializes a variable called <span class="literal">humidity_bar</span> of type <span class="literal">double</span> <span class="ent">➐</span>, <span epub:type="pagebreak" id="page_134"/>which is the variable type accepted by the progress bar. Finally, the lines at <span class="ent">➑</span> create the humidity progress bar to place on the canvas.</p>
<p class="indent">The process for displaying titles and values for temperature and pressure follows the same steps as at <span class="ent">➌</span>, <span class="ent">➍</span>, and <span class="ent">➎</span>.</p>
<h4 class="h4" id="lev105"><span class="violet"><strong>Automatically Updating the Readings</strong></span></h4>
<p class="noindent">At <span class="ent">➒</span>, you define the <span class="literal">update_readings()</span> function, which updates the displayed values every three seconds to keep your weather readings up to date.</p>
<p class="indent">The following line updates the <span class="literal">temperature</span> variable:</p>
<div class="box">
<p class="programs">temperature.set(<span class="purple">str</span>(<span class="purple">round</span>(sense.temperature, 2)) + <span class="green">'*C'</span>)</p>
</div>
<p class="indent">Let’s break this line into its component parts:</p>
<ul>
<li class="noindent"><span class="literal">sense.temperature</span> retrieves the temperature reading from the Sense HAT.</li>
<li class="noindent"><span class="literal">round(sense.temperature,2)</span> rounds the temperature readings to two decimal places.</li>
<li class="noindent"><span class="literal">str(round(sense.temperature,2)</span> converts the rounded reading to a string.</li>
<li class="noindent"><span class="literal">(str(round(sense.temperature,2)) + '*C')</span> concatenates the degree symbol to the string.</li>
<li class="noindent"><span class="literal">temperature.set(str(round(sense.temperature, 2)) + '*C')</span> updates the <span class="literal">temperature</span> variable with the latest reading.</li>
</ul>
<p class="indent">The script uses a similar procedure for updating the <span class="literal">pressure</span> and <span class="literal">humidity</span> variables.</p>
<p class="indent">The <span class="literal">window.update_idletasks()</span> function keeps the window up to date while monitoring. Finally, <span class="literal">window.after(3000, update_readings)</span> adds <span class="literal">update_readings</span> as an event to the <span class="literal">mainloop()</span>, and tells the Pi to call this function every 3,000 milliseconds (3 seconds).</p>
<p class="indent">At <span class="ent">➓</span>, you call the <span class="literal">update_readings()</span> function and the <span class="literal">window.mainloop()</span> function that keeps the window running.</p>
<p class="indent">Finally, you can display the temperature in Fahrenheit by commenting and uncommenting these two lines:</p>
<div class="box">
<p class="programs"><span class="red1">#temperature.set(str(round(sense.temperature, 2)) + '*C')</span><br/>temperature.set(<span class="purple">str</span>(<span class="purple">round</span>(sense.temperature*(9/5)+32, 2)) + <span class="green">'*F'</span>)</p>
</div>
<h4 class="h4" id="lev106"><span epub:type="pagebreak" id="page_135"/><span class="violet"><strong>Running the Script</strong></span></h4>
<p class="noindent">Press <strong>F5</strong> or go to <strong>Run</strong> <span class="ent">▸</span> <strong>Run Module</strong> to run the script. You should see your weather data displayed in the user interface as shown at the beginning of the project.</p>
<p class="indent">Congratulations! You’ve made your own weather station. You are officially a budding meteorologist.</p>
<h3 class="h3" id="lev107"><span class="violet"><strong>TAKING IT FURTHER</strong></span></h3>
<p class="noindent">Here are some ideas for customizing this project:</p>
<ul>
<li class="noindent">Add the Fahrenheit conversion to the code and display the temperature as °F.</li>
<li class="noindent">Change the graphical user interface—layout, font color, size, and type—to suit your tastes.</li>
<li class="noindent">Use the LED matrix display on the Sense HAT to display information about the weather. For example, you can display text, relative bar graphs, or green and red arrows indicating temperature, humidity, or pressure rising or falling.</li>
<li class="noindent">In the rest of the projects within this part, you’ll learn how to send an email with Python and how to save sensor readings. Use these skills to send your weather data to your email or build a weather station data logger. Make sure you don’t miss the next projects!</li>
</ul>


<h2 class="h2" id="ch10"><span epub:type="pagebreak" id="page_136"/><strong>10<br/>Intruder Alarm with Email Notifications</strong></h2>
<p class="noindent"><span class="violet">In this project, you’ll create an intruder alarm that sends you email notifications. The alarm will detect whether someone has trespassed onto forbidden territory using a passive infrared (PIR) motion sensor. When the PIR motion sensor detects movement, it will send a warning email.</span></p>
<div class="image"><span epub:type="pagebreak" id="page_137"/><img src="../images/f0137-01.jpg" alt="image"/></div>
<p class="cap"><span class="violet"><strong>PARTS REQUIRED</strong></span></p>
<p class="cap1">Raspberry Pi</p>
<p class="cap1">Breadboard</p>
<p class="cap1">PIR mot ion sensor HC-SR501</p>
<p class="cap1">Two 5 mm LEDs (different colors)</p>
<p class="cap1">Two 330 Ω resistors</p>
<p class="cap1">Pushbutton</p>
<p class="cap1">Jumper wires</p>
<h3 class="h3" id="lev108"><span epub:type="pagebreak" id="page_138"/><span class="violet"><strong>INTRODUCING THE PIR MOTION SENSOR</strong></span></h3>
<p class="noindent">You’ve probably seen motion sensors in a wide variety of applications. They’re used in security lights, in commercial building lights that turn on when you walk by, and in burglar alarms.</p>
<p class="indent">A PIR motion sensor (see <a href="ch10.xhtml#ch10fig1">Figure 10-1</a>) measures infrared light emitted from objects in its field of view. It detects motion based on changes in infrared light, which indicate changes in temperature. This makes it ideal for detecting humans or animals because it will pick up living things that move within its range but not inanimate objects, like a leaf blowing in the wind. You can program the Pi to react to changes in infrared light by triggering an event such as turning on a light, sounding an alarm, or, as we’ll do in this project, sending an email.</p>
<div class="image"><a id="ch10fig1"/><img src="../images/f0138-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 10-1:</strong> PIR motion sensor</p>
<p class="indent">The sensor outputs HIGH if it detects movement or LOW if it doesn’t, and it has only 3 pins: VCC, GND, and data. Data outputs a 3.3 V signal, perfect for your Pi!</p>
<h3 class="h3" id="lev109"><span class="violet"><strong>SENDING AN EMAIL WITH PYTHON</strong></span></h3>
<p class="noindent">Python’s email library makes it straightforward to send emails through Python. We’ll write that script now before assembling the parts.</p>
<h4 class="h4" id="lev110"><span class="violet"><strong>Finding Your SMTP Server Details</strong></span></h4>
<p class="noindent">To send emails through code, you need to include your <em>Simple Mail Transfer Protocol (SMTP)</em> server details. SMTP is an internet standard for email transmission, and each email provider has a different SMTP server.</p>
<p class="indent">These details include your service provider’s <em>server address</em> and <em>port</em> and whether it uses <em>Transport Layer Security (TLS)</em>. TLS is <span epub:type="pagebreak" id="page_139"/>a protocol for establishing a secure connection between two email servers. To get this information simply search the internet for <em>SMTP server settings</em> along with the name of your email provider. You’ll plug these details into the script to personalize it.</p>
<h4 class="h4" id="lev111"><span class="violet"><strong>The Email-Sending Script</strong></span></h4>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>Don’t name your file</em> email.py <em>because that’s a Python library name, and your script won’t work.</em></p>
</div>
<p class="noindent">Open <strong>Python 3 (IDLE)</strong> and go to <strong>File</strong> <span class="ent">▸</span> <strong>New File</strong> to create a new script. Copy the code in <a href="ch10.xhtml#ch10list1">Listing 10-1</a> to the Python Editor and save the script as <em>send_email.py</em> inside the <em>Sensors</em> folder (remember that you can download all the scripts at <em><a href="https://www.nostarch.com/RaspberryPiProject/">https://www.nostarch.com/RaspberryPiProject/</a></em>):</p>
<p class="listing" id="ch10list1"><strong>LISTING 10-1:</strong> The email notification script</p>
<div class="box">
<p class="programs"><span class="ent">➊</span> <span class="orange">import</span> smtplib<br/>  <span class="orange">from</span> email.mime.text <span class="orange">import</span> MIMEText<br/><br/>  <span class="red1">#replace the next three lines with your credentials</span><br/><span class="ent">➋</span> from_email_addr = <span class="green">'</span><span class="green"><em>YOUR_EMAIL@gmail.com</em></span><span class="green">'</span><br/>  from_email_password = <span class="green">'</span><span class="green"><em>YOUR_EMAIL_PASSWORD</em></span><span class="green">'</span><br/>  to_email_addr = <span class="green">'</span><span class="green"><em>TO_YOUR_OTHER_EMAIL@gmail.com</em></span><span class="green">'</span><br/><br/>  <span class="red1">#set your email message</span><br/><span class="ent">➌</span> body = <span class="green">'Motion was detected in your room.'</span><br/>  msg = MIMEText(body)<br/><br/>  <span class="red1">#set sender and recipient</span><br/>  msg[<span class="green">'From'</span>] = from_email_addr<br/>  msg[<span class="green">'To'</span>] = to_email_addr<br/><br/>  <span class="red1">#set your email subject</span><br/>  msg[<span class="green">'Subject'</span>] = <span class="green">'INTRUDER ALERT'</span><br/><br/>  <span class="red1">#connecting to server and sending email</span><br/>  <span class="red1">#edit the following line with your provider's SMTP server details</span><br/><span class="ent">➍</span> server = smtplib.SMTP(<span class="green">'</span><span class="green"><em>smtp.gmail.com</em></span><span class="green">'</span>, <em>587</em>)<br/>  <span class="red1">#comment out the next line if your email provider doesn't use TLS</span><br/>  server.starttls()<br/><span class="ent">➎</span> server.login(from_email_addr, from_email_password)<br/>  server.sendmail(from_email_addr, to_email_addr, msg.as_string())<br/>  server.quit()<br/>  <span class="purple">print</span>(<span class="green">'Email sent'</span>)</p>
</div>
<div class="note">
<p class="notet"><span class="red"><strong>WARNING</strong></span></p>
<p class="notep"><em>If you use the snippet at</em> <span class="ent">➎</span> <em>inside a <span class="literal">while</span> loop without a delay, you will fill your inbox with thousands of emails and your account will probably be blocked, so make sure to include a delay if you use this snippet in any other project!</em></p>
</div>
<p class="indent">You start by importing the libraries you need for SMTP and email-related functions: smtplib and MIMEText <span class="ent">➊</span>. Next, you create variables for the email address to send from, that email’s password, and an email address to send to <span class="ent">➋</span>. We suggest you create a second email to send the notifications to your everyday email because you will be giving less secure apps access to the account you send <span epub:type="pagebreak" id="page_140"/>from. Make sure that you input your own information for these strings.</p>
<p class="indent">The code block at <span class="ent">➌</span> writes the email. You start by creating a <span class="literal">body</span> variable that stores your email body text. Then you create an object called <span class="literal">msg</span> that generates the email itself using <span class="literal">msg = MIMEText(body)</span>. Feel free to change the email body and subject by changing the string in the <span class="literal">body</span> and <span class="literal">msg['Subject']</span> variables, respectively.</p>
<p class="indent">At <span class="ent">➍</span>, you establish communication with an SMTP server. Pass the provider’s SMTP server address as a string as the first argument to <span class="literal">smtplib.SMTP()</span>, and the port as an int as the second argument. In this script, we’re using a Gmail SMTP server and port. If you use another email provider, make sure to change those values.</p>
<p class="indent">The <span class="literal">server.starttls()</span> function is necessary for email providers that use TLS to encrypt messages. If your email provider doesn’t use TLS, you can remove or comment out that line.</p>
<p class="indent">Next, the script logs into the sending email account <span class="ent">➎</span>, sends the email, and stops communication with the server. Last, the script prints an <span class="literal">'Email sent'</span> message to the Python shell to let the user know an email was sent.</p>
<h4 class="h4" id="lev112"><span class="violet"><strong>Running the Email-Sending Script</strong></span></h4>
<p class="noindent">It’s now time to see your script in action! Save your script and press <strong>F5</strong> or go to <strong>Run</strong> <span class="ent">▸</span> <strong>Run Module</strong> to run the script. Then check the email inbox you sent the message to. You should have a new email. You can see an email we received using this script in <a href="ch10.xhtml#ch10fig2">Figure 10-2</a>.</p>
<div class="image"><a id="ch10fig2"/><img src="../images/f0140-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 10-2:</strong> Email sent with <em>send_email.py</em></p>
<p class="indent">If you haven’t received an email, verify that the email and SMTP information in <em>send_email.py</em> are correct. Also verify that you have given permission to let less secure apps use your account in your email account settings.</p>
<h3 class="h3" id="lev113"><span epub:type="pagebreak" id="page_141"/><span class="violet"><strong>WIRING THE CIRCUIT</strong></span></h3>
<p class="noindent">Now let’s wire your PIR sensor to your Raspberry Pi so it can send you emails when the sensor detects movement. You’ll also include two LEDs into your system, one to indicate whether the alarm is armed and one to indicate whether it has been triggered, as well as a pushbutton to arm and disarm the sensor.</p>
<p class="indent">Follow these steps to build the intruder alarm circuit, using <a href="ch10.xhtml#ch10fig3">Figure 10-3</a> as a reference.</p>
<div class="image"><a id="ch10fig3"/><img src="../images/f0141-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 10-3:</strong> Circuit for the intruder alarm</p>
<ol>
<li class="noindent"><p class="list">Connect GND of the Pi to one of the breadboard’s blue rails.</p></li>
<li class="noindent"><p class="list">Insert a red LED and a green LED into the breadboard. Connect the green LED’s positive lead to GPIO 18 through a 330 Ω resistor, with the resistor between the LED lead and the GPIO pin, and connect the negative lead to the GND rail. Connect the red LED’s positive lead to GPIO 17 through another 330 Ω resistor and connect the negative lead to the GND rail.</p></li>
<li class="noindent"><p class="list">Insert the pushbutton in the middle of the breadboard so that it bridges the center break, as shown in <a href="ch10.xhtml#ch10fig3">Figure 10-3</a>. Connect the pin at the bottom right to the GND rail and the pin at the bottom left to GPIO 2.</p></li>
<li class="noindent"><p class="list">Connect the PIR motion sensor with the connections in the following table.</p></li>
</ol>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="border_th-l"><p class="tab_th"><span epub:type="pagebreak" id="page_142"/><strong>PIR MOTION SENSOR</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>RASPBERRY PI</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">GND</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">GND</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">OUT</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">GPIO 4</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">VCC</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">5 V</span></p></td>
</tr>
</tbody>
</table>
<h3 class="h3" id="lev114"><span class="violet"><strong>WRITING THE SCRIPT</strong></span></h3>
<p class="noindent">Open <strong>Python 3 (IDLE)</strong> and go to <strong>File</strong> <span class="ent">▸</span> <strong>New File</strong> to create a new script. Enter the code in <a href="ch10.xhtml#ch10list2">Listing 10-2</a> into the new file and save the script as <em>intruder_alarm.py</em> inside the <em>Sensors</em> folder (remember that you can download all the scripts at <em><a href="https://www.nostarch.com/RaspberryPiProject/">https://www.nostarch.com/RaspberryPiProject/</a></em>):</p>
<p class="listing" id="ch10list2"><strong>LISTING 10-2:</strong> The intruder alarm script</p>
<div class="box">
<p class="programs">  <span class="red1">#import necessary libraries</span><br/><span class="ent">➊</span> <span class="orange">from</span> gpiozero <span class="orange">import</span> LED, Button, MotionSensor<br/>  <span class="orange">import</span> smtplib<br/>  <span class="orange">from</span> email.mime.text <span class="orange">import</span> MIMEText<br/>  <span class="orange">from</span> signal <span class="orange">import</span> pause<br/><br/>  <span class="red1">#create objects to refer to each LED, the button, and the PIR sensor</span><br/><span class="ent">➋</span> led_status = LED(17)<br/>  led_triggered = LED(18)<br/>  button = Button(2)<br/>  pir = MotionSensor(4)<br/><br/>  <span class="red1">#control variables</span><br/><span class="ent">➌</span> motion_sensor_status = <span class="orange">False</span><br/>  email_sent = <span class="orange">False</span><br/><br/>  <span class="red1">#arm or disarm the PIR sensor</span><br/><span class="ent">➍</span> <span class="orange">def</span> <span class="blue">arm_motion_sensor()</span>:<br/>      <span class="orange">global</span> email_sent<br/>      <span class="orange">global</span> motion_sensor_status<br/>      <span class="orange">if</span> motion_sensor_status == <span class="orange">True</span>:<br/>          motion_sensor_status = <span class="orange">False</span><br/>          led_status.off()<br/>          led_triggered.off()<br/>      <span class="orange">else</span>:<br/>          motion_sensor_status = <span class="orange">True</span><br/>          email_sent = <span class="orange">False</span><br/>          led_status.on()<br/><br/>  <span class="red1">#send email when motion is detected and the PIR sensor is armed</span><br/><span class="ent">➎</span> <span class="orange">def</span> <span class="blue">send_email()</span>:<br/>      <span class="orange">global</span> email_sent<br/>      <span class="orange">global</span> motion_sensor_status<br/>      <span class="orange">if</span>(motion_sensor_status == <span class="orange">True</span> <span class="orange">and</span> email_sent == <span class="orange">False</span>):<br/><br/><span epub:type="pagebreak" id="page_143"/>          <span class="red1">#replace the next three lines with your credentials</span><br/>          from_email_addr = <span class="green">'</span><span class="green"><em>YOUR_EMAIL@gmail.com</em></span><span class="green">'</span><br/>          from_email_password = <span class="green">'</span><span class="green"><em>YOUR_EMAIL_PASSWORD</em></span><span class="green">'</span><br/>          to_email_addr = <span class="green">'</span><span class="green"><em>TO_YOUR_OTHER_EMAIL@gmail.com</em></span><span class="green">'</span><br/><br/>         <span class="red1">#set your email message</span><br/>          body = <span class="green">'Motion was detected in your room.'</span><br/>          msg = MIMEText(body)<br/><br/>          <span class="red1">#set sender and recipient</span><br/>          msg[<span class="green">'From'</span>] = from_email_addr<br/>          msg[<span class="green">'To'</span>] = to_email_addr<br/><br/>          <span class="red1">#set your email subject</span><br/>          msg[<span class="green">'Subject'</span>] = <span class="green">'INTRUDER ALERT'</span><br/><br/>          <span class="red1">#connect to server and send email</span><br/>          <span class="red1">#edit this line with your provider's SMTP server details</span><br/>          server = smtplib.SMTP(<span class="green">'</span><span class="green"><em>smtp.gmail.com</em></span><span class="green">'</span>, <em>587</em>)<br/>          <span class="red1">#comment out this line if your provider doesn't use TLS</span><br/>          server.starttls()<br/>          server.login(from_email_addr, from_email_password)<br/>          server.sendmail(from_email_addr, to_email_addr,<br/>  msg.as_string())<br/>          server.quit()<br/>          email_sent = <span class="orange">True</span><br/>          led_triggered.on()<br/>          <span class="purple">print</span>(<span class="green">'Email sent'</span>)<br/><br/>  <span class="red1">#assign a function that runs when the button is pressed</span><br/><span class="ent">➏</span> button.when_pressed = arm_motion_sensor<br/>  <span class="red1">#assign a function that runs when motion is detected</span><br/><span class="ent">➐</span> pir.when_motion = send_email<br/><br/><span class="ent">➑</span> pause()</p>
</div>
<p class="indent">This code is really straightforward and should all be familiar from <a href="ch10.xhtml#ch10list1">Listing 10-1</a>. You start by importing the needed libraries <span class="ent">➊</span> and creating <span class="literal">gpiozero</span> objects to refer to the LEDs, button, and motion sensor <span class="ent">➋</span>. At <span class="ent">➌</span>, you create the <span class="literal">motion_sensor_status</span> and <span class="literal">email_sent</span> control variables to identify whether the motion sensor was triggered and whether an email has been sent. You then create the <span class="literal">arm_motion_sensor()</span> function that arms and disarms the motion sensor when you press the pushbutton <span class="ent">➍</span>. The <span class="literal">send_email()</span> function at <span class="ent">➎</span> sends an email when the sensor detects motion, as long as the sensor is armed and the <span class="literal">email_sent</span> variable is equal to <span class="literal">False</span>.</p>
<p class="indent">Last, you assign functions to events: the <span class="literal">arm_motion_sensor()</span> function is called when the pushbutton is pressed <span class="ent">➏</span>, and the <span class="literal">send_email()</span> function is called when motion is detected <span class="ent">➐</span>. The <span class="literal">pause()</span> <span epub:type="pagebreak" id="page_144"/>function at the end of the code keeps the script running for events to be detected <span class="ent">➑</span>.</p>
<p class="indent">Notice that the <span class="literal">send_email()</span> function has an <span class="literal">if</span> statement condition that sets the script to send an email only if motion is detected and if the <span class="literal">email_sent</span> variable is equal to <span class="literal">False</span>. When an email is sent out, the <span class="literal">email_sent</span> variable changes to <span class="literal">True</span> and your script sends no more emails. You set the <span class="literal">email_sent</span> variable to <span class="literal">False</span> again by pressing the pushbutton twice, rearming the alarm.</p>
<p class="indent">This condition prevents the script from sending you a lot of unnecessary emails. For example, say you left your dog home when you were out and it triggered the sensor; with this condition, you only receive one email saying that motion was detected. If you didn’t have this condition, you would receive endless emails until your dog moved out of the sensor range.</p>
<p class="indent">Press <strong>F5</strong> or go to <strong>Run</strong> <span class="ent">▸</span> <strong>Run Module</strong> to run the script. Arm the sensor by pressing the pushbutton; the red status LED should light up. Test the alarm by moving your hand in front of the motion sensor. You should receive a new message in your inbox and the triggered green LED should light up.</p>
<p class="indent">Place this circuit in a strategic place and wait to see if someone enters your room while you’re out.</p>
<h3 class="h3" id="lev115"><span class="violet"><strong>TAKING IT FURTHER</strong></span></h3>
<p class="noindent">This project showed you how to use the PIR motion sensor with the Raspberry Pi and how to send emails with Python. These are handy skills that you can add to what you’ve learned in other projects to invent your own devices. Here are some simple ideas for projects you can build with the motion sensor:</p>
<ul>
<li class="noindent">Add a piezo buzzer to your alarm circuit so that when motion is detected not only is an email sent but an alarm is also sounded.</li>
<li class="noindent">Automate your room’s lights to automatically turn on when you enter. You may need a relay to do this—check <a href="ch16.xhtml#ch16">Project 16</a> where we explain how to use a relay.</li>
<li class="noindent">Use a relay and a photoresistor to make a security nightlight that turns on only when movement is detected in the dark.</li>
</ul>


<h2 class="h2" id="ch11"><span epub:type="pagebreak" id="page_145"/><strong>11<br/>Gas and Smoke Alarm</strong></h2>
<p class="noindent"><span class="violet">In this project, you’ll build a gas and smoke alarm using an MQ-2 gas and smoke sensor and a piezo buzzer. Every time the sensor detects gas or smoke in the atmosphere above a certain threshold, the buzzer will sound.</span></p>
<div class="image"><span epub:type="pagebreak" id="page_146"/><img src="../images/f0146-01.jpg" alt="image"/></div>
<p class="cap"><span class="violet"><strong>PARTS REQUIRED</strong></span></p>
<p class="cap1">Raspberry Pi</p>
<p class="cap1">Breadboard</p>
<p class="cap1">MQ-2 gas and smoke sensor</p>
<p class="cap1">MCP 3008 chip</p>
<p class="cap1">Piezo buzzer</p>
<p class="cap1">5 mm LED</p>
<p class="cap1">330 Ω resistor</p>
<p class="cap1">Pushbut ton</p>
<p class="cap1">Lighter</p>
<p class="cap1">Jumper wires</p>
<h3 class="h3" id="lev116"><span class="violet"><span epub:type="pagebreak" id="page_147"/><strong>INTRODUCING THE MQ-2 GAS AND SMOKE SENSOR</strong></span></h3>
<p class="noindent">The MQ-2 gas and smoke sensor is sensitive to smoke and the following flammable gases: propane, butane, methane, alcohol, and hydrogen. <a href="ch11.xhtml#ch11fig1">Figure 11-1</a> shows the sensor’s front and back views.</p>
<div class="image"><a id="ch11fig1"/><img src="../images/f0147-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 11-1:</strong> The MQ-2 gas and smoke sensor, front and back views</p>
<p class="indent">The MQ-2 has two ways of outputting gas levels. The first is to read the gas concentration in the atmosphere and output it as an analog signal from the analog output pin AO, where the higher the gas levels, the higher the output voltage.</p>
<p class="indent">The second is to set a certain threshold and then output a HIGH signal from the digital output pin DO if the gas levels are above that threshold, and a LOW signal if the gas levels are below that threshold. The MQ-2 has a potentiometer built into the back that you can adjust with a screwdriver to change this threshold.</p>
<p class="indent">The sensor also has a power LED in the back that indicates if the sensor is on, and a digital output LED that lights up when detected gas levels are above the set threshold.</p>
<p class="indent">You’ll be reading the analog signal, which provides a quantitative measure of the gas levels, allowing you to better define the threshold value above which you want the buzzer to warn you of higher gas levels. Remember that the Pi can read only digital signals, so to read the analog signals with the Pi, you’ll use an analog-to-digital converter module (MCP3008 chip), which was first introduced in <a href="ch03.xhtml#ch03">Project 3</a>.</p>
<h3 class="h3" id="lev117"><span epub:type="pagebreak" id="page_148"/><span class="violet"><strong>INTRODUCING THE PIEZO BUZZER</strong></span></h3>
<p class="noindent">The piezo buzzer sounds the alarm when it receives a digital signal from the Pi. The buzzer you’ll use, shown in <a href="ch11.xhtml#ch11fig2">Figure 11-2</a>, is about as simple as it comes.</p>
<div class="image"><a id="ch11fig2"/><img src="../images/f0148-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 11-2:</strong> Piezo buzzer</p>
<p class="indent">The buzzer’s case contains a disc that vibrates at a certain frequency when voltage is sent to it. Wiring the piezo buzzer is simple. All you need to do is connect one wire to your Pi’s GND pin and another to a GPIO pin.</p>
<h3 class="h3" id="lev118"><span class="violet"><strong>WIRING THE CIRCUIT</strong></span></h3>
<p class="noindent">To build the smoke and gas detector alarm circuit, you need to connect an LED and a pushbutton to the Pi; you should already know how to wire these from previous projects. You also need to connect the piezo buzzer and the MQ-2 sensor to the Pi—the latter will connect through the MCP3008 chip). Follow these instructions, using <a href="ch11.xhtml#ch11fig3">Figure 11-3</a> as a reference.</p>
<div class="image"><a id="ch11fig3"/><img src="../images/f0148-02.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 11-3:</strong> Smoke and gas detector circuit diagram</p>
<ol>
<li class="noindent"><p class="list"><span epub:type="pagebreak" id="page_149"/>Connect GND to the blue breadboard rail and 3.3 V to the red rail.</p></li>
<li class="noindent"><p class="list">Place the MCP3008 chip in the middle of the breadboard so that the legs run parallel on either side of the center divide, as shown in <a href="ch11.xhtml#ch11fig3">Figure 11-3</a>, and wire it according to the following table.</p>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="border_th-l"><p class="tab_th"><strong>MCP3008</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>CONNECT TO</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">1</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">MQ-2 AO pin</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">9</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">GND</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">10</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">GPIO 8</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">11</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">GPIO 10</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">12</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">GPIO 9</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">13</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">GPIO 11</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">14</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">GND</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">15</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">3.3 V</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">16</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">3.3 V</span></p></td>
</tr>
</tbody>
</table>
<p class="indentv">Remember that when the half-circle on the MCP3008 is at the top, pin 1 is the top pin on the left side; see <a href="ch03.xhtml#lev41">“Analog-to-Digital Converters”</a> on <a href="ch03.xhtml#page_55">page 55</a> for a complete MCP3008 pinout.</p></li>
<li class="noindent"><p class="list">Place the MQ-2 gas and smoke sensor in the breadboard and wire it as indicated.</p>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="border_th-l"><p class="tab_th"><strong>MQ-2 SENSOR</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>CONNECT TO</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">VCC</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">5 V</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">GND</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">GND</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">DO</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">No connection</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">AO</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">MCP3008 pin 1</span></p></td>
</tr>
</tbody>
</table></li>
<li class="noindent"><p class="list">Insert an LED into the breadboard. Connect the positive lead to GPIO 17 through a 330 Ω resistor and connect the negative lead to the GND rail.</p></li>
<li class="noindent"><p class="list">Insert the pushbutton in the middle of the breadboard, with two leads on either side of the center divide. Connect the bottom-right lead to GND power rail and the bottom-left lead to GPIO 2, making sure both connected leads are on the same side of the divide.</p></li>
<li class="noindent"><p class="list">Insert the buzzer into the breadboard and connect the black wire to GND and the red wire to GPIO 27.</p></li>
</ol>
<p class="indent"><span epub:type="pagebreak" id="page_150"/>With your circuit wired up, it’s time to upload some code.</p>
<h3 class="h3" id="lev119"><span class="violet"><strong>WRITING THE SCRIPT</strong></span></h3>
<p class="noindent">Open <strong>Python 3 (IDLE)</strong> and go to <strong>File</strong> <span class="ent">▸</span> <strong>New File</strong> to create a new script. Copy the code in <a href="ch11.xhtml#ch11list1">Listing 11-1</a> to the Python Editor and save the script as <em>smoke_detector.py</em> inside the <em>Sensors</em> folder. (remember that you can download all the scripts at <em><a href="https://www.nostarch.com/RaspberryPiProject/">https://www.nostarch.com/RaspberryPiProject/</a></em>):</p>
<p class="listing" id="ch11list1"><strong>LISTING 11-1:</strong> The smoke and gas detector script</p>
<div class="box">
<p class="programs">  <span class="red1">#import necessary libraries</span><br/><span class="ent">➊</span> <span class="orange">from</span> gpiozero <span class="orange">import</span> LED, Button, Buzzer, MCP3008<br/>  <span class="orange">from</span> time <span class="orange">import</span> sleep<br/><br/><span class="ent">➋</span> led = LED(17)<br/>  button = Button(2)<br/>  buzzer = Buzzer(27)<br/>  gas_sensor = MCP3008(0)<br/><br/><span class="ent">➌</span> gas_sensor_status = <span class="orange">False</span><br/><br/><span class="ent">➍</span> threshold = 0.1<br/><br/><span class="ent">➎</span> <span class="orange">def</span> <span class="blue">arm_gas_sensor</span>():<br/>      <span class="orange">global</span> gas_sensor_status<br/>      <span class="orange">if</span> gas_sensor_status == <span class="orange">True</span>:<br/>          gas_sensor_status = <span class="orange">False</span><br/>          led.off()<br/>      <span class="orange">else</span>:<br/>          gas_sensor_status = <span class="orange">True</span><br/>          led.on()<br/><span class="ent">➏</span> button.when_pressed = arm_gas_sensor<br/><br/><span class="ent">➐</span> <span class="orange">while True</span>:<br/><span class="ent">➑</span>     <span class="red1">#print(gas_sensor.value)</span><br/>      <span class="red1">#check if the gas sensor is armed and</span><br/>      <span class="red1">#reached the threshold value</span><br/>      <span class="orange">if</span>(gas_sensor_status == <span class="orange">True</span> <span class="orange">and</span> gas_sensor.value &gt; threshold):<br/>          buzzer.beep()<br/>      <span class="orange">else</span>:<br/>          buzzer.off()<br/>      sleep(2)</p>
</div>
<p class="indent">First, you import the <span class="literal">LED</span>, <span class="literal">Button</span>, <span class="literal">Buzzer</span>, and <span class="literal">MCP3008</span> classes from the gpiozero library and the <span class="literal">sleep</span> function from the time library <span class="ent">➊</span>; then, you create <span class="literal">gpiozero</span> objects to refer to the LED, button, MCP3008 (MQ-2 gas sensor), and buzzer <span class="ent">➋</span>. Next, you create a <span class="literal">gas_sensor_status</span> variable that will indicate whether the smoke sensor is armed <span class="ent">➌</span>; the sensor is armed if this variable <span epub:type="pagebreak" id="page_151"/>is <span class="literal">True</span> and not armed if it’s <span class="literal">False</span>. You need to set a <span class="literal">threshold</span> value so that the buzzer beeps only when the gas levels are above this threshold <span class="ent">➍</span>. We’ll cover finding out your threshold value in a moment.</p>
<p class="indent">The <span class="literal">arm_gas_sensor()</span> function <span class="ent">➎</span> arms and disarms the sensor by switching the value in the <span class="literal">gas_sensor_status</span> variable to the opposite of whatever it currently holds, whether that’s <span class="literal">True</span> or <span class="literal">False</span>, when the function is called. At <span class="ent">➏</span>, you set the function to call when the pushbutton is pressed so that you can arm and disarm the sensor manually. You also set an LED to turn on when the sensor is armed; that way, you can visually identify its status.</p>
<p class="indent">The final block of code is a <span class="literal">while</span> loop <span class="ent">➐</span> that continuously checks whether the sensor is armed and whether the gas levels are above the threshold. If the sensor is armed and the gas levels are above the threshold value, the buzzer beeps via the <span class="literal">buzzer.beep()</span> function. The final <span class="literal">buzzer.off()</span> function stops the buzzer.</p>
<h4 class="h4" id="lev120"><span class="violet"><strong>Setting the Threshold Value</strong></span></h4>
<p class="noindent">To accurately set a safe gas-level threshold, you first need to calibrate your sensor to your environment. That means you need to measure your gas levels when there is no gas present, and then set your threshold to a value slightly above that. First, find out what the gas levels of your environment usually are:</p>
<ol>
<li class="noindent"><p class="list">Uncomment the line at <span class="ent">➑</span>, and then save and run the script.</p></li>
<li class="noindent"><p class="list">You should see the <span class="literal">gas_sensor</span> values displayed on the Python shell. Those are the values read when there’s no gas or smoke in the sensor’s range. Your <span class="literal">threshold</span> value should be slightly higher than this. For example, if your default value is <span class="literal">0.07</span>, we recommend setting your threshold to <span class="literal">0.1</span>, but it depends on your desired sensitivity level.</p></li>
<li class="noindent"><p class="list">Grab a lighter and press the trigger (without igniting the lighter). Hold the lighter next to the sensor to release some gas. The <span class="literal">gas_sensor</span> value displayed on the Python shell should increase. Your <span class="literal">threshold</span> value should be lower than the maximum value you got when exposing the sensor to gas.</p>
<div class="note">
<p class="notet"><span class="red"><strong>WARNING</strong></span></p>
<p class="notep"><em>Always be careful when using lighters and gas; don’t hold the gas trigger down for too long, and do not ignite the lighter when gas has been released into the air.</em></p>
</div></li>
<li class="noindent"><p class="list">With the values obtained from the last two steps, tune the <span class="literal">threshold</span> value <span class="ent">➍</span> somewhere between these two so that it’s neither too sensitive nor too unresponsive.</p></li>
<li class="noindent"><p class="list">Comment out the <span class="literal">print</span> statement <span class="ent">➑</span> and save the script.</p></li>
</ol>
<h4 class="h4" id="lev121"><span epub:type="pagebreak" id="page_152"/><span class="violet"><strong>Running the Script</strong></span></h4>
<p class="noindent">Press <strong>F5</strong> or go to <strong>Run</strong> <span class="ent">▸</span> <strong>Run Module</strong> to run the script. Press the pushbutton to arm the sensor. The red LED should light up. Then test it out by using a lighter to release some gas next to the sensor until the buzzer beeps.</p>
<div class="note">
<p class="notet"><span class="red"><strong>WARNING</strong></span></p>
<p class="notep"><em>This gas and smoke alarm should not be used to replace an off-the-shelf smoke detector.</em></p>
</div>
<p class="indent">Congratulations! You now have a gas and smoke detector alarm to monitor your house and warn you of fire!</p>
<h3 class="h3" id="lev122"><span class="violet"><strong>TAKING IT FURTHER</strong></span></h3>
<p class="noindent">The aim of this project was to show you how to read sensors that output analog signals. Now you can add features to this project. For example, you can edit the script to send an email when gas or smoke is above the threshold value, as we did in <a href="ch10.xhtml#ch10">Project 10</a>.</p>


<h2 class="h2" id="ch12"><span epub:type="pagebreak" id="page_153"/><strong>12<br/>Temperature and Humidity Data Logger</strong></h2>
<p class="noindent"><span class="violet">In this project, you’re going to build a data logger that automatically stores data on temperature and humidity. You’ll learn how to read and log data from your environment, which is useful in numerous applications.</span></p>
<div class="image"><span epub:type="pagebreak" id="page_154"/><img src="../images/f0154-01.jpg" alt="image"/></div>
<p class="cap"><span class="violet"><strong>PARTS REQUIRED</strong></span></p>
<p class="cap1">Raspberry Pi</p>
<p class="cap1">Breadboard</p>
<p class="cap1">DHT22 temperature and humidity sensor (DHT11 and AM2302 also work)</p>
<p class="cap1">4.7 kΩ resistor</p>
<p class="cap1">Jumper wires</p>
<p class="cap"><span class="violet"><strong>SOFTWARE REQUIRED</strong></span></p>
<p class="cap1">Adafruit_Python_DHT library</p>
<p class="indentt"><span epub:type="pagebreak" id="page_155"/>You’ll use the DHT22 temperature and humidity sensor to collect data, which will then be saved in a <em>.txt</em> file that you can then use to build charts, graphs, and other visualizations. This project gives you the basics of data collection, which is useful in many different applications that use sensors—for example, monitoring soil dampness, taking the temperature of water in a fish tank, or even registering the exact time unexpected movement was detected around your house. You can apply the concepts from this project to any sensor.</p>
<h3 class="h3" id="lev123"><span class="violet"><strong>INTRODUCING THE DHT22 SENSOR</strong></span></h3>
<p class="noindent">The DHT22 (shown in <a href="ch12.xhtml#ch12fig1">Figure 12-1</a>) is a digital temperature and humidity sensor with a built-in chip that converts analog to digital signals, so there’s no need to use an analog-to-digital converter. This makes wiring really simple.</p>
<div class="image"><a id="ch12fig1"/><img src="../images/f0155-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 12-1:</strong> DHT22 temperature and humidity sensor</p>
<h3 class="h3" id="lev124"><span class="violet"><strong>WIRING THE CIRCUIT</strong></span></h3>
<p class="noindent">This is a simple circuit that just has the DHT22 sensor wired to your Pi via a resistor. Follow these instructions, using the circuit diagram in <a href="ch12.xhtml#ch12fig2">Figure 12-2</a> as a reference.</p>
<ol>
<li class="noindent"><p class="list">Connect GND and 3.3 V on the Pi to the breadboard’s blue and red power rails, respectively.</p></li>
<li class="noindent"><p class="list">Connect the DHT22 sensor according to the following table, with pins starting at 1 from left to right when the sensor is facing you. Make sure to wire the resistor between pin 2 of the sensor and the breadboard’s red power rail.</p></li>
</ol>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="border_th-l"><p class="tab_th"><span epub:type="pagebreak" id="page_156"/><strong>DHT22</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>RASPBERRY PI</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">1</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">3.3 V</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">2</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">GPIO 4; also connect to 3.3 V through a 4.7 kΩ resistor</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">3</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">Don’t connect</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">4</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">GND</span></p></td>
</tr>
</tbody>
</table>
<div class="image"><a id="ch12fig2"/><img src="../images/f0156-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 12-2:</strong> Wiring the DHT22 sensor to the Pi</p>
<h3 class="h3" id="lev125"><span class="violet"><strong>WRITING THE SCRIPT</strong></span></h3>
<p class="noindent">You’ll use the Adafruit_Python_DHT library, which allows you to easily control the DHT22 sensor and read the data.</p>
<h4 class="h4" id="lev126"><span class="violet"><strong>Installing the DHT22 Library</strong></span></h4>
<p class="noindent">This library can also be used with similar sensors, like DHT11 and AM2302 (the wired version of the DHT22 from Adafruit), if you’re using those instead.</p>
<p class="indent">Open the terminal and enter the following:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~ $ <span class="codestrong">sudo apt update</span><br/>pi@raspberrypi:~ $ <span class="codestrong">sudo apt install build-essential python-dev</span></p>
</div>
<p class="indent">From the terminal, navigate to the desktop, make a folder called <em>Libraries</em> if you haven’t already, and move into the newly created folder as follows:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~ $ <span class="codestrong">cd ~/Desktop</span><br/>pi@raspberrypi:~/Desktop $ <span class="codestrong">mkdir Libraries</span><br/><span epub:type="pagebreak" id="page_157"/>pi@raspberrypi:~/Desktop $ <span class="codestrong">cd Libraries</span><br/>pi@raspberrypi:~/Desktop/Libraries $</p>
</div>
<p class="indent">Clone the library by entering the following command:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~/Desktop/Libraries $ <span class="codestrong">git clone https://github.com/</span><br/><span class="codestrong">adafruit/Adafruit_Python_DHT.git</span></p>
</div>
<p class="indent">Finally, move to the <em>Adafruit_Python_DHT</em> directory and install the library with these commands:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~/Desktop/Libraries $ <span class="codestrong">cd Adafruit_Python_DHT</span><br/>pi@raspberrypi:~/Desktop/Libraries/Adafruit_Python_DHT $ <span class="codestrong">sudo python</span><br/><span class="codestrong">setup.py install</span></p>
</div>
<p class="indent">With the necessary library installed, it’s time to write the script.</p>
<h4 class="h4" id="lev127"><span class="violet"><strong>Entering the Script</strong></span></h4>
<p class="noindent">The DHT22 library is not supported by Python 3, so you need to use Python 2.7. Open <strong>Python 2.7 (IDLE)</strong> and go to <strong>File</strong> <span class="ent">▸</span> <strong>New File</strong> to create a new script. Copy the code from <a href="ch12.xhtml#ch12list1">Listing 12-1</a> to the Python Editor and save the script as <em>temperature_humidity_data_logger.py</em> inside the <em>Sensors</em> folder (remember that you can download all the scripts at <em><a href="https://www.nostarch.com/RaspberryPiProject/">https://www.nostarch.com/RaspberryPiProject/</a></em>):</p>
<p class="listing" id="ch12list1"><strong>LISTING 12-1:</strong> The temperature and humidity data logger script</p>
<div class="box">
<p class="programs">  <span class="red1">#import necessary libraries</span><br/><span class="ent">➊</span> <span class="orange">import</span> Adafruit_DHT<br/>  <span class="orange">import</span> time<br/><br/>  <span class="red1">#comment and uncomment the lines below depending on your sensor</span><br/>  <span class="red1">#sensor = Adafruit_DHT.DHT11</span><br/><span class="ent">➋</span> sensor = Adafruit_DHT.DHT22<br/>  <span class="red1">#sensor = Adafruit_DHT.AM2302</span><br/><br/>  <span class="red1">#DHT pin connects to GPIO 4</span><br/>  sensor_pin = 4<br/><br/>  <span class="red1">#create a variable to control the while loop</span><br/>  running = <span class="orange">True</span><br/><br/>  <span class="red1">#new .txt file created with header</span><br/><span class="ent">➌</span> file = <span class="purple">open</span>(<span class="green">'sensor_readings.txt'</span>, <span class="green">'w'</span>)<br/><span class="ent">➍</span> file.write(<span class="green">'time and date, temperature, humidity\n'</span>)<br/><br/>  <span class="red1">#loop forever</span><br/>  <span class="orange">while</span> running:<br/>      <span class="orange">try</span>:<br/>          <span class="red1">#read the humidity and temperature</span><br/>       <span class="ent">➎</span> humidity, temperature = Adafruit_DHT.read_retry(sensor,<br/>  sensor_pin)<br/><br/><span epub:type="pagebreak" id="page_158"/>          <span class="red1">#uncomment the line below to convert to Fahrenheit</span><br/>       <span class="ent">➏</span> <span class="red1">#temperature = temperature * 9/5.0 + 32</span><br/><br/>          <span class="red1">#sometimes you won't get a reading and</span><br/>          <span class="red1">#the results will be null</span><br/>          <span class="red1">#the next statement guarantees that</span><br/>          <span class="red1">#it only saves valid readings</span><br/>       <span class="ent">➐</span> <span class="orange">if</span> humidity <span class="orange">is not None</span> and temperature <span class="orange">is not None</span>:<br/>              <span class="red1">#print temperature and humidity</span><br/>              <span class="purple">print</span>(<span class="green">'Temperature = '</span> + <span class="purple">str</span>(temperature) +<br/>  <span class="green">', Humidity = '</span> + <span class="purple">str</span>(humidity))<br/>              <span class="red1">#save time, date, temperature and humidity in .txt file</span><br/>           <span class="ent">➑</span> file.write(time.strftime(<span class="green">'%H:%M:%S %d/%m/%Y'</span>) + <span class="green">', '</span> +<br/>                  <span class="purple">str</span>(temperature) + <span class="green">', '</span> + <span class="purple">str</span>(humidity) + <span class="green">'\n'</span>)<br/>          <span class="orange">else</span>:<br/>              <span class="purple">print</span>(<span class="green">'Failed to get reading. Try again!'</span>)<br/>          <span class="red1">#wait 10s between each sensor reading</span><br/>       <span class="ent">➒</span> time.sleep(10)<br/>      <span class="red1">#if KeyboardInterrupt triggered, stop loop and close .txt file</span><br/>      <span class="orange">except</span> <span class="purple">KeyboardInterrupt</span>:<br/>          <span class="purple">print</span> (<span class="green">'Program stopped'</span>)<br/>          running = <span class="orange">False</span><br/>       <span class="ent">➓</span> file.close()</p>
</div>
<p class="indent">First, you import the Adafruit_DHT library <span class="ent">➊</span> you just installed, as well as the built-in time library. Then, at <span class="ent">➋</span>, you uncomment the line that corresponds to the sensor you’re using. If you’re using DHT22, you don’t need to change anything.</p>
<p class="indent">The line at <span class="ent">➎</span> reads the temperature and humidity and saves the readings in the <span class="literal">temperature</span> and <span class="literal">humidity</span> variables, respectively. If you want your temperature readings in Fahrenheit, uncomment the line at <span class="ent">➏</span> to make the conversion from Celsius.</p>
<p class="indent">Sometimes the sensor can’t read the data and sends a <span class="literal">null</span> result to the Pi. The <span class="literal">if</span> statement at <span class="ent">➐</span> guarantees that the Pi saves data only if it is not <span class="literal">null</span>. You also timestamp each reading using <span class="literal">time.strftime("%H:%M:%S %d/%m/%Y")</span>—the argument in the parentheses here indicates the format you want the time and date to appear in: hours, minutes, seconds, day, month, and year, respectively.</p>
<p class="indent">This script reads and records the temperature and humidity every 10 seconds, but you can change this at <span class="ent">➒</span> by changing the delay time. The sensor is capable of taking readings every 2 seconds, but no faster than that.</p>
<h4 class="h4" id="lev128"><span class="violet"><strong>Creating, Writing, and Closing .txt files</strong></span></h4>
<p class="noindent">The DHT22 temperature and humidity readings are automatically saved in a <em>.txt</em> file that you create with the <span class="literal">open()</span> function <span class="ent">➌</span> and <span epub:type="pagebreak" id="page_159"/>store in the <span class="literal">file</span> variable. This function accepts the name you want to give the file as an argument and, in this case, a <span class="literal">'</span><span class="literal">w'</span> telling Python you want this file to be in <em>write mode</em>, meaning the program can write and make changes to the file. The write mode overwrites existing files with the same name.</p>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>Every time you run the code, it will overwrite whatever was already in the</em> sensor_readings.txt <em>file. If you don’t want this to happen, change the filename at</em> <span class="ent">➍</span> <em>to create a new file each time you run the script.</em></p>
</div>
<p class="indent">The <span class="literal">file.write()</span> function writes to the file and accepts a string as an argument. For example, with <span class="literal">file.write('time and date, temperature, humidity\n')</span> at <span class="ent">➍</span>, you write “time and date, temperature, humidity” into the file. At <span class="ent">➐</span>, you write the sensor data to the file and at<span class="ent">➑</span> the timestamp. The <span class="literal">\n</span> tells Python to start the next display text on the next line, known as a <em>newline</em>.</p>
<p class="indent">Finally, the <span class="literal">file.close()</span> function <span class="ent">➓</span> saves and closes the file.</p>
<h4 class="h4" id="lev129"><span class="violet"><strong>Running the Script</strong></span></h4>
<p class="noindent">Press <strong>F5</strong> or go to <strong>Run</strong> <span class="ent">▸</span> <strong>Run Module</strong> to run the script. Let the script run for a few hours to gather a decent amount of data, and when you’re happy with the data logging period, stop the script by pressing <small>CTRL</small>-C. You should then have a <em>sensor_readings.txt</em> file that contains all your data in your <em>Sensors</em> folder.</p>
<h3 class="h3" id="lev130"><span class="violet"><strong>TAKING IT FURTHER</strong></span></h3>
<p class="noindent">In this project you’ve learned a very useful concept: data logging. Now you can use data logging in other monitoring projects. Here are some ideas:</p>
<ul>
<li class="noindent">Use a PIR motion sensor that makes a timestamp every time it detects movement.</li>
<li class="noindent">Build a weather station data logger with the Sense HAT.</li>
<li class="noindent">Search for other monitoring sensor applications—for example, soil moisture, rain, and light sensors—to build a greenhouse data logger.<span epub:type="pagebreak" id="page_160"/></li>
</ul>
</body></html>