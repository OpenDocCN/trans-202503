<html><head></head><body>
<h2 class="h2" id="ch03"><span epub:type="pagebreak" id="page_25"/><strong><span class="big">3</span></strong><br/><strong>A BRIEF INTRODUCTION TO DYNAMIC ANALYSIS</strong></h2>
<div class="image1"><img alt="image" src="../images/common01.jpg"/></div>
<p class="noindent">In <a href="ch02.xhtml#ch02">Chapter 2</a>, you learned advanced static analysis techniques to disassemble the assembly code recovered from malware. Although static analysis can be an efficient way to gain useful information about malware by studying its different components on disk, it doesn’t allow us to observe malware behavior.</p>
<p class="indent">In this chapter, you’ll learn about the basics of dynamic malware analysis. Unlike static analysis, which focuses on what malware looks like in file form, dynamic analysis consists of running malware in a safe, contained environment to see how it behaves. This is like introducing a dangerous bacterial strain into a sealed environment to see its effects on other cells.</p>
<p class="indent">Using dynamic analysis, we can get around common static analysis hurdles, such as packing and obfuscation, as well as gain more direct insight into the purpose of a given malware sample. We begin by exploring basic dynamic analysis techniques, their relevance to malware data science, and their applications. We use open source tools like <em><a href="http://malwr.com">malwr.com</a></em> to study examples of dynamic analysis in action. Note that this is a condensed <span epub:type="pagebreak" id="page_26"/>survey of the topic and is not intended to be comprehensive. For a more complete introduction, check out <em>Practical Malware Analysis</em> (No Starch Press, 2012).</p>
<h3 class="h3" id="lev38"><strong>Why Use Dynamic Analysis?</strong></h3>
<p class="noindent">To understand why dynamic analysis matters, let’s consider the problem of packed malware. Recall that packing malware refers to compressing or obfuscating a malware’s x86 assembly code to hide the malicious nature of the program. A packed malware sample unpacks itself when it infects a target machine so that the code can execute.</p>
<p class="indent">We could try to disassemble a packed or obfuscated malware sample using the static analysis tools discussed in <a href="ch02.xhtml#ch02">Chapter 2</a>, but this is a laborious process. For example, with static analysis we’d first have to find the location of the obfuscated code in the malware file. Then we’d have to find the location of the deobfuscation subroutines that deobfuscate this code so that it can run. After locating the subroutines, we’d have to figure out how this deobfuscation procedure works in order to perform it on the code. Only then could we begin the actual process of reverse engineering the malicious code.</p>
<p class="indent">A simple yet clever alternative to this process is to execute the malware in a safe, contained environment called a <em>sandbox</em>. Running malware in a sandbox allows it to unpack itself as it would when infecting a real target. By simply running malware, we can find out what servers a particular malware binary connects to, what system configuration parameters it changes, and what device I/O (input/output) it attempts to perform.</p>
<h3 class="h3" id="lev39"><strong>Dynamic Analysis for Malware Data Science</strong></h3>
<p class="noindent">Dynamic analysis is useful not only for malware reverse engineering but also for malware data science. Because dynamic analysis reveals what a malware sample <em>does</em>, we can compare its actions to those of other malware samples. For example, because dynamic analysis shows what files malware samples write to disk, we can use this data to connect those malware samples that write similar filenames to disk. These kinds of clues help us categorize malware samples based on common traits. They can even help us identify malware samples that were authored by the same groups or are part of the same campaigns.</p>
<p class="indent">Most importantly, dynamic analysis is useful for building machine learning–based malware detectors. We can train a detector to distinguish between malicious and benign binaries by observing their behaviors during dynamic analysis. For example, after observing thousands of dynamic analysis logs from both malware and benign files, a machine learning system can learn that when <em>msword.exe</em> launches a process named <em>powershell.exe</em>, this action is malicious, but that when <em>msword.exe</em> launches Internet Explorer, this is probably harmless. <a href="ch08.xhtml#ch08">Chapter 8</a> will go into more detail about how we <span epub:type="pagebreak" id="page_27"/>can build malware detectors using data based on both static and dynamic analysis. But before we create sophisticated malware detectors, let’s look at some basic tools for dynamic analysis.</p>
<h3 class="h3" id="lev40"><strong>Basic Tools for Dynamic Analysis</strong></h3>
<p class="noindent">You can find a number of free, open source tools for dynamic analysis online. This section focuses on <em><a href="http://malwr.com">malwr.com</a></em> and CuckooBox. The <em><a href="http://malwr.com">malwr.com</a></em> site has a web interface that allows you to submit binaries for dynamic analysis for free<em>.</em> CuckooBox is a software platform that lets you set up your own dynamic analysis environment so that you can analyze binaries locally. The creators of the CuckooBox platform also operate <em><a href="http://malwr.com">malwr.com</a></em>, and <em><a href="http://malwr.com">malwr.com</a></em> runs CuckooBox behind the scenes. Therefore, learning how to analyze results on <em><a href="http://malwr.com">malwr.com</a></em> will allow you to understand CuckooBox results.</p>
<div class="note">
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>
<p class="notep"><em>At print time,</em> <a href="http://malwr.com">malwr.com</a>’<em>s CuckooBox interface was down for maintenance. Hopefully by the time you read this section the site will be back up. If not, the information provided in this chapter can be applied to output from your own CuckooBox instance, which you can set up by following the instructions at</em> <a href="https://cuckoosandbox.org/">https://cuckoosandbox.org/</a>.</p>
</div>
<h4 class="h4" id="lev41"><strong><em>Typical Malware Behaviors</em></strong></h4>
<p class="noindent">The following are the major categories of actions a malware sample may take upon execution:</p>
<p class="hang"><strong>Modifying the file system</strong> For example, writing a device driver to disk, changing system configuration files, adding new programs to the file system, and modifying registry keys to ensure the program auto-starts</p>
<p class="hang"><strong>Modifying the Windows registry to change the system configuration</strong> For example, changing firewall settings</p>
<p class="hang"><strong>Loading device drivers</strong> For example, loading a device driver that records user keystrokes</p>
<p class="hang"><strong>Network actions</strong> For example, resolving domain names and making HTTP requests</p>
<p class="indentt">We’ll examine these behaviors in more detail using a malware sample and analyzing its report on <em><a href="http://malwr.com">malwr.com</a></em>.</p>
<h4 class="h4" id="lev42"><strong><em>Loading a File on <a href="http://malwr.com">malwr.com</a></em></strong></h4>
<p class="indent">To run a malware sample through <em><a href="http://malwr.com">malwr.com</a></em>, navigate to <em><a href="https://malwr.com/">https://malwr.com/</a></em> and then click the <strong>Submit</strong> button to upload and submit a binary for analysis. We’ll use a binary whose SHA256 hash starts with the characters <em>d676d95</em>, which you can find in the data directory accompanying this chapter. I encourage you to submit this binary to <em><a href="http://malwr.com">malwr.com</a></em> and inspect the results yourself as we go. The submit page is shown in <a href="ch03.xhtml#ch03fig1">Figure 3-1</a>.</p>
<div class="image"><span epub:type="pagebreak" id="page_28"/><a id="ch03fig1"/><img alt="image" src="../images/f0028-01.jpg"/></div>
<p class="figcap"><em>Figure 3-1: The malware sample submission page</em></p>
<p class="indent">After you submit your sample through this form, the site should prompt you to wait for analysis to complete, which typically takes about five minutes. When the results load, you can inspect them to understand what the executable did when it was run in the dynamic analysis environment.</p>
<h4 class="h4" id="lev43"><strong><em>Analyzing Results on <a href="http://malwr.com">malwr.com</a></em></strong></h4>
<p class="noindent">The results page for our sample should look something like <a href="ch03.xhtml#ch03fig2">Figure 3-2</a>.</p>
<div class="image"><a id="ch03fig2"/><img alt="image" src="../images/f0028-02.jpg"/></div>
<p class="figcap"><em>Figure 3-2: The top of the results page for a malware sample on</em> <a href="http://malwr.com">malwr.com</a></p>
<p class="indent"><span epub:type="pagebreak" id="page_29"/>The results for this file illustrate some key aspects of dynamic analysis, which we’ll explore next.</p>
<h5 class="h5" id="lev44"><strong>Signatures Panel</strong></h5>
<p class="noindent">The first two panels you’ll see on the results page are Analysis and File Details. These contain the time the file was run and other static details about the file. The panel I will focus on here is the Signatures panel, shown in <a href="ch03.xhtml#ch03fig3">Figure 3-3</a>. This panel contains high-level information derived from the file itself and its behavior when it was run in the dynamic analysis environment. Let’s discuss what each of these signatures means.</p>
<div class="image"><a id="ch03fig3"/><img alt="image" src="../images/f0029-01.jpg"/></div>
<p class="figcap"><em>Figure 3-3: The</em> <a href="http://malwr.com">malwr.com</a> <em>signatures that match the behavior of our malware sample</em></p>
<p class="indent">The first three signatures shown in the figure result from static analysis (that is, these are results from the properties of the malware file itself, not its actions). The first signature simply tells us that a number of antivirus engines on the popular antivirus aggregator <em><a href="http://VirusTotal.com">VirusTotal.com</a></em> marked this file as malware. The second indicates that the binary contains compressed or encrypted data, a common sign of obfuscation. The third tells us that this binary was compressed with the popular UPX packer. Although these static indicators on their own don’t tell us what this file does, they do tell us that it’s likely malicious. (Note that the color doesn’t correspond to static versus dynamic categories; instead, it represents the severity of each rule, with red—the darker gray here—being more suspicious than yellow.)</p>
<p class="indent">The next three signatures result from dynamic analysis of the file. The first signature indicates that the program attempts to identify the system’s hardware and operating system. The second indicates that the program uses a pernicious feature of Windows known as <em>Alternate Data Streams (ADS)</em>, which allows malware to hide data on disk such that it’s invisible when using standard file system browsing tools. The third signature indicates that the file changes the Windows registry so that when the system reboots, a program that it specified will automatically execute. This would restart the malware whenever the user reboots their system.</p>
<p class="indent"><span epub:type="pagebreak" id="page_30"/>As you can see, even at the level of these automatically triggered signatures, dynamic analysis adds significantly to our knowledge of the file’s intended behavior.</p>
<h5 class="h5" id="lev45"><strong>Screenshots Panel</strong></h5>
<p class="noindent">Beneath the Signatures panel is the Screenshots panel. This panel shows a screenshot of the dynamic analysis environment desktop as the malware is running. <a href="ch03.xhtml#ch03fig4">Figure 3-4</a> shows an example of what this looks like.</p>
<div class="image"><a id="ch03fig4"/><img alt="image" src="../images/f0030-01.jpg"/></div>
<p class="figcap"><em>Figure 3-4: A screen capture of our malware sample’s dynamic behavior</em></p>
<p class="indent">You can see that the malware we’re dealing with is <em>ransomware</em>, which is a type of malware that encrypts a target’s files and forces them to pay up if they want to get their data back. By simply running our malware, we were able to uncover its purpose without resorting to reverse engineering.</p>
<h5 class="h5" id="lev46"><strong>Modified System Objects Panel</strong></h5>
<p class="noindent">A row of headings under Screenshots shows the malware sample’s network activity. Our binary did not engage in any network communications, but if it had, we would see the hosts it contacted here. <a href="ch03.xhtml#ch03fig5">Figure 3-5</a> shows the Summary panel.</p>
<div class="image"><span epub:type="pagebreak" id="page_31"/><a id="ch03fig5"/><img alt="image" src="../images/f0031-01.jpg"/></div>
<p class="figcap"><em>Figure 3-5: The Files tab of the Summary pane, showing which files our malware sample modified</em></p>
<p class="indent">This shows which system objects, like files, registry keys, and mutexes, the malware has modified.</p>
<p class="indent">Looking at the Files tab in <a href="ch03.xhtml#ch03fig6">Figure 3-6</a>, it’s clear that this ransomware malware has indeed encrypted the user files on disk.</p>
<div class="image"><a id="ch03fig6"/><img alt="image" src="../images/f0031-02.jpg"/></div>
<p class="figcap"><em>Figure 3-6: File paths in the Files tab of the Summary pane, suggesting that our sample is ransomware</em></p>
<p class="indent">After each file path is a file with a <em>.locked</em> extension, which we can infer is the encrypted version of the file it has replaced.</p>
<p class="indent">Next, we’ll look at the Registry Keys tab, shown in <a href="ch03.xhtml#ch03fig7">Figure 3-7</a>.</p>
<div class="image"><a id="ch03fig7"/><img alt="image" src="../images/f0031-03.jpg"/></div>
<p class="figcap"><em>Figure 3-7: The Registry Keys tab of the Summary pane, showing which registry keys our malware sample modified</em></p>
<p class="indent"><span epub:type="pagebreak" id="page_32"/>The registry is a database that Windows uses to store configuration information. Configuration parameters are stored as registry keys, and these keys have associated values. Similar to file paths on the Windows file system, registry keys are backslash delimited. <em><a href="http://Malwr.com">Malwr.com</a></em> shows us what registry keys our malware modified. Although this isn’t shown in <a href="ch03.xhtml#ch03fig7">Figure 3-7</a>, if you view the complete report on <em><a href="http://malwr.com">malwr.com</a></em>, you should see that one notable registry key our malware changed is <code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</code>, which is a registry key that tells Windows to run programs each time a user logs on. It’s very likely that our malware modifies this registry to tell Windows to restart the malware every time the system boots up, which ensures that the malware infection persists from reboot to reboot.</p>
<p class="indent">The Mutexes tab in the <em><a href="http://malwr.com">malwr.com</a></em> report contains the names of the mutexes the malware created, as shown in <a href="ch03.xhtml#ch03fig8">Figure 3-8</a>.</p>
<div class="image"><a id="ch03fig8"/><img alt="image" src="../images/f0032-01.jpg"/></div>
<p class="figcap"><em>Figure 3-8: The Mutexes tab of the Summary pane, showing which mutexes our malware sample created</em></p>
<p class="indent">Mutexes are lock files that signal that a program has taken possession of some resource. Malware often uses mutexes to prevent itself from infecting a system twice. It turns out that at least one mutex created (<em>CTF.TimListCache.FMPDefaultS-1-5-21-1547161642-507921405-839522115-1004MUTEX.DefaultS-1-5-21-1547161642-507921405-839522115-1004 ShimCacheMutex</em>) is known by the security community to be associated with malware and may be serving this purpose here.</p>
<h5 class="h5" id="lev47"><strong>API Call Analysis</strong></h5>
<p class="noindent">Clicking the Behavioral Analysis tab on the left panel of the <em><a href="http://malwr.com">malwr.com</a></em> UI, as shown in <a href="ch03.xhtml#ch03fig9">Figure 3-9</a>, should bring up detailed information about our malware binary’s behavior.</p>
<p class="indent">This shows what API calls were made by each process launched by the malware, along with their arguments and return values. Perusing this information is time consuming and requires expert knowledge of Windows APIs. Although a detailed discussion of malware API call analysis is beyond the scope of this book, if you’re interested in learning more, you can look up individual API calls to discover their effects.</p>
<div class="image"><span epub:type="pagebreak" id="page_33"/><a id="ch03fig9"/><img alt="image" src="../images/f0033-01.jpg"/></div>
<p class="figcap"><em>Figure 3-9: The Behavioral Analysis pane of the</em> <a href="http://malwr.com">malwr.com</a> <em>report for our malware sample, showing when API calls were made during the dynamic execution</em></p>
<p class="indent">Although <em><a href="http://malwr.com">malwr.com</a></em> is a great resource for dynamically analyzing individual malware samples, it isn’t great for performing dynamic analysis on large numbers of samples. Executing large numbers of samples in a dynamic environment is important for machine learning and data analysis because it identifies relationships between malware samples’ dynamic execution patterns. Creating machine learning systems that can detect instances of malware based on their dynamic execution patterns requires running thousands of malware samples.</p>
<p class="indent">In addition to this limitation, <em><a href="http://malwr.com">malwr.com</a></em> doesn’t provide malware analysis results in machine-parseable formats like XML or JSON. To address these issues you must set up and run your own CuckooBox. Fortunately, CuckooBox is free and open source. It also comes with step-by-step instructions for setting up your very own dynamic analysis environment. I encourage you to do so by going to <em><a href="http://cuckoosandbox.org/">http://cuckoosandbox.org/</a></em>. Now that you understand how to interpret dynamic malware results from <em><a href="http://malwr.com">malwr.com</a></em>, which uses CuckooBox behind the scenes, you’ll also know how to analyze CuckooBox results once you have CuckooBox up and running.</p>
<h3 class="h3" id="lev48"><strong>Limitations of Basic Dynamic Analysis</strong></h3>
<p class="noindent">Dynamic analysis is a powerful tool, but it is no malware analysis panacea. In fact, it has serious limitations. One limitation is that malware authors are aware of CuckooBox and other dynamic analysis frameworks and attempt to circumvent them by making their malware fail to execute when it detects that it’s running in CuckooBox. The CuckooBox maintainers are aware that malware authors try to do this, so they try to get around attempts by malware to circumvent CuckooBox. This cat-and-mouse game <span epub:type="pagebreak" id="page_34"/>plays out continuously such that some malware samples will inevitably detect that they are running in dynamic analysis environments and fail to execute when we try to run them.</p>
<p class="indent">Another limitation is that even without any circumvention attempts, dynamic analysis might not reveal important malware behaviors. Consider the case of a malware binary that connects back to a remote server upon execution and waits for commands to be issued. These commands may, for example, tell the malware sample to look for certain kinds of files on the victim host, to log keystrokes, or turn on the webcam. In this case, if the remote server sends no commands, or is no longer up, none of these malicious behaviors will be revealed. Because of these limitations, dynamic analysis is not a fix-all for malware analysis. In fact, professional malware analysts combine dynamic and static analysis to achieve the best possible results.</p>
<h3 class="h3" id="lev49"><strong>Summary</strong></h3>
<p class="noindent">In this chapter you ran dynamic analysis on a ransomware malware sample with <em><a href="http://malwr.com">malwr.com</a></em> to analyze the results. You also learned about the advantages and shortcomings of dynamic analysis. Now that you’ve learned how to conduct basic dynamic analysis, you’re ready to dive into malware data science.</p>
<p class="indent">The remainder of this book focuses on performing malware data science on static analysis–based malware data. I’ll focus on static analysis because it’s simpler and easier to get good results with compared to dynamic analysis, making it a good starting place for getting your hands dirty with malware data science. However, in each subsequent chapter I’ll also explain how you can apply data science methods to dynamic analysis–based data.</p>
</body></html>