<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;Advanced Active Record"><div class="titlepage"><div><div><h1 class="title"><a id="advanced_active_record"/>Chapter 8. Advanced Active Record</h1></div></div></div><p>When building a new application, work out the data model first. A <span class="emphasis"><em>data
          model</em></span> is a description of the models in your program, along with their
        attributes and associations. First, identify the models needed and the relationships between
        them, and then create tables for these models and test them in the Rails console. Once the
        data models are working properly, building the rest of the application is much
        easier.</p><p>Some people think of diagrams with boxes and arrows when they hear the words
          <span class="emphasis"><em>data model</em></span>. These diagrams are unnecessary if you understand how the
        models relate without them. This chapter does include some basic diagrams, however, to
        illustrate different associations. In each diagram, the arrows point from the foreign key in
        a child model to the primary key in the parent model.</p><p><a class="indexterm" id="iddle1034"/><a class="indexterm" id="iddle1192"/><a class="indexterm" id="iddle1227"/><a class="indexterm" id="iddle1314"/><a class="indexterm" id="iddle1447"/><a class="indexterm" id="iddle1448"/><a class="indexterm" id="iddle1584"/><a class="indexterm" id="iddle1666"/><a class="indexterm" id="iddle1849"/><a class="indexterm" id="iddle1932"/><a class="indexterm" id="iddle2146"/>In this chapter, you’re going to start building a new application from
        scratch. The application is a social network in the style of Tumblr. Users create accounts
        and then post text and images for other users to see. A user can follow other users so their
        friends’ posts appear on the timeline on their home page.</p><p>First, I’ll discuss several advanced data-modeling techniques. Then we’ll
        work our way through the models needed for your new social networking site.</p><div class="sect1" title="Advanced Data Modeling"><div class="titlepage"><div><div><h1 class="title"><a id="advanced_data_modeling"/>Advanced Data Modeling</h1></div></div></div><p>When building the blog, you worked with <code class="literal">has_many</code> and
            <code class="literal">belongs_to</code> associations. Real-world applications often require more
          complex associations.</p><p>For example, you sometimes need to model an association between two models of the same
          type, or you might need to model a many-to-many relationship between models. You also
          might need to store an object hierarchy in the database, but relational databases
          don’t really support inheritance. Finally, you might need to model a class that can
          associate with multiple different types of models.</p><p>I’ll discuss these four situations in this section, starting with modeling a
          relationship between two models of the same type using a self join association.</p><div class="sect2" title="Self Join Associations"><div class="titlepage"><div><div><h2 class="title"><a id="self_join_associations"/>Self Join Associations</h2></div></div></div><p>Imagine an application for managing employees at a company. In addition to data such
            as each employee’s name, job title, and salary, you need to store each
            employee’s manager’s name. Each employee <code class="literal">belongs_to</code> a
            manager, and a manager <code class="literal">has_many</code> subordinates. A manager is also an
            employee, so you need to set up an association between two different models of the same
            type.</p><p>Recall that a <code class="literal">belongs_to</code> association means the model needs a
            foreign key to link it to another model. A foreign key is a field that identifies the
            model on the other side of an association. So the <code class="literal">employees</code> table
            needs a field called <code class="literal">manager_id</code> to link each employee to a manager.
            The diagram in <a class="xref" href="ch08.html#self_join_association" title="Figure 8-1. Self join association">Figure 8-1</a> shows how this relationship
            works.</p><p>A <span class="emphasis"><em>self join association</em></span> allows you to model an organizational
            chart or other tree structure using a single table. The <code class="literal">manager_id</code>
            foreign key points to the id of the employee’s manager. This same type of
            association is also used to model other tree structures such as nested comments, where
            replies include a <code class="literal">parent_id</code> that points to the parent comment.</p><div class="figure"><a id="self_join_association"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00010"/><img alt="Self join association" src="httpatomoreillycomsourcenostarchimages2169078.png.jpg"/></div></div><p class="title">Figure 8-1. Self join association</p></div><p><a class="indexterm" id="iddle1190"/><a class="indexterm" id="iddle1228"/><a class="indexterm" id="iddle1536"/><a class="indexterm" id="iddle1667"/><a class="indexterm" id="iddle1777"/><a class="indexterm" id="iddle1818"/>Once the <code class="literal">manager_id</code> field has been added to the
              <code class="literal">employees</code> table, you can define the associations in the
              <code class="literal">Employee</code> model:</p><a id="pro_id00235"/><pre class="programlisting">  class Employee &lt; ActiveRecord::Base
➊   has_many :subordinates, class_name: 'Employee',
➋                           foreign_key: 'manager_id'
➌   belongs_to :manager, class_name: 'Employee'
  end</pre><p>First, you add a <code class="literal">has_many</code> association for subordinates. Because
            this association refers to the <code class="literal">Employee</code> model, and not a model named
              <code class="literal">Subordinate</code>, you must specify <code class="literal">class_name:
              'Employee'</code> ➊. You must also specify the foreign key name, in this
            case, <code class="literal">manager_id</code> ➋. Finally, add the
              <code class="literal">belongs_to</code> association for the <code class="literal">manager</code>. Again,
            you must explicitly state the model’s class name because Rails can’t figure
            it out based on the association name ➌.</p><p>With these associations in place, you can call the <code class="literal">subordinates</code>
            method to get a list of a manager’s subordinates. You can also use the methods
              <code class="literal">manager</code> and <code class="literal">manager=</code> to get and set an
            employee’s manager. Almost every employee should have a
              <code class="literal">manager_id</code>, as shown in <a class="xref" href="ch08.html#employees_table" title="Table 8-1. The employees Table">Table 8-1</a>. If your
              <code class="literal">manager_id</code> is <code class="literal">nil</code>, then you must be the
            boss!</p><div class="table"><a id="employees_table"/><p class="title">Table 8-1. The employees Table</p><div class="table-contents"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; " summary="The employees Table"><colgroup><col/><col/><col/></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>id</p></th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>name</p></th><th style="border-bottom: 0.5pt solid ; " valign="top"><p>manager_id</p></th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>1</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>Alice</p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>NULL</p></td></tr><tr><td style="border-right: 0.5pt solid ; " valign="top"><p>2</p></td><td style="border-right: 0.5pt solid ; " valign="top"><p>Bob</p></td><td style="" valign="top"><p>1</p></td></tr></tbody></table></div></div><p>Notice that the <code class="literal">manager_id</code> for Bob is 1. That means Alice is
            Bob’s manager. Alice’s <code class="literal">manager_id</code> is NULL, which is
              <code class="literal">nil</code> in Ruby. She’s the CEO of this two-person company.</p></div><div class="sect2" title="Many-to-Many Associations"><div class="titlepage"><div><div><h2 class="title"><a id="many-to-many_associations"/>Many-to-Many Associations</h2></div></div></div><p>Whereas a one-to-many association only involves two tables, a many-to-many
            association always involves a third table known as a <span class="emphasis"><em>join table</em></span>.
            The join table stores foreign keys for each side of the association. It
              <code class="literal">belongs_to</code> each of the models in the association.</p><p>Rails provides two different ways to set up a many-to-many association.</p><div class="sect3" title="has_and_belongs_to_many"><div class="titlepage"><div><div><h3 class="title"><a id="hasunderscoreandunderscorebelongsundersc"/>has_and_belongs_to_many</h3></div></div></div><p>If you’re using a join table strictly for the association and need no
              additional data, then use a <code class="literal">has_and_belongs_to_many</code> association.
              You still need to create the join table, but you don’t need to define a model
              for it. The join table must be named after the two models it joins.</p><p><a class="indexterm" id="iddle1585"/><a class="indexterm" id="iddle1838"/><a class="indexterm" id="iddle2266"/>For example, authors write many books, and some books have multiple
              authors. All of the data you need is stored in either the author or book model, so you
              can create a <code class="literal">has_and_belongs_to_many</code> association between authors
              and books, as in <a class="xref" href="ch08.html#hasunderscoreandunderscorebelong-id00018" title="Figure 8-2. has_and_belongs_to_many association">Figure 8-2</a>.</p><div class="figure"><a id="hasunderscoreandunderscorebelong-id00018"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00011"/><img alt="has_and_belongs_to_many association" src="httpatomoreillycomsourcenostarchimages2169080.png.jpg"/></div></div><p class="title">Figure 8-2. <code class="literal">has_and_belongs_to_many</code> association</p></div><p><a class="xref" href="ch08.html#hasunderscoreandunderscorebelong-id00018" title="Figure 8-2. has_and_belongs_to_many association">Figure 8-2</a> shows the
                <code class="literal">Author</code> and <code class="literal">Book</code> models with the join table
              between them. Define the association between these models as shown here:</p><a id="pro_id00236"/><pre class="programlisting">class Author &lt; ActiveRecord::Base
  has_and_belongs_to_many :books
end</pre><p>An author might write many books, but a book can also have many authors:</p><a id="pro_id00237"/><pre class="programlisting">class Book &lt; ActiveRecord::Base
  has_and_belongs_to_many :authors
end</pre><p>For this association to work, the join table between <code class="literal">authors</code>
              and <code class="literal">books</code> must be named <code class="literal">authors_books</code> and must
              contain fields <code class="literal">author_id</code> and <code class="literal">book_id</code>. Use the
                <code class="literal">rails generate</code> command to create an empty migration file:</p><a id="pro_id00238"/><pre class="programlisting">$ <span class="strong"><strong>bin/rails g migration CreateAuthorsBooks</strong></span>
  invoke   active_record
  create     db/migrate/..._create_authors_books.rb</pre><p>Then edit the migration file to remove the primary key and create the two foreign
              keys:</p><a id="pro_id00239"/><pre class="programlisting">  class CreateAuthorsBooks &lt; ActiveRecord::Migration
    def change
      create_table :authors_books<span class="strong"><strong>, id: false</strong></span> do |t|
➊       <span class="strong"><strong>t.references :author, null: false, index: true</strong></span>

        <span class="strong"><strong>t.references :book, null: false, index: true</strong></span>
      end
    end
  end</pre><p><a class="indexterm" id="iddle1189"/><a class="indexterm" id="iddle1396"/><a class="indexterm" id="iddle1673"/><a class="indexterm" id="iddle1727"/><a class="indexterm" id="iddle1776"/>The <code class="literal">t.references :author</code> statement ➊ indicates
              this field is a foreign key that references an <code class="literal">Author</code> model. The
              field is named <code class="literal">author_id</code>. The <code class="literal">null: false</code> option
              adds a constraint so NULL values are not allowed, and the <code class="literal">index:
                true</code> option creates a database index to speed up queries on this field.
              The next line creates the <code class="literal">book_id</code> field, also with a NULL
              constraint and database index.</p><p>You can also use the <code class="literal">create_join_table</code> method inside the
              migration to create the join table. This method takes the names of the associations
              and creates the correct table with no primary key and a foreign key for each
              association with a NULL constraint. This method does not automatically create indices
              for the foreign keys. You can add indices as shown here:</p><a id="pro_id00240"/><pre class="programlisting">class CreateAuthorsBooks &lt; ActiveRecord::Migration
  def change
    <span class="strong"><strong>create_join_table :authors, :books do |t|</strong></span>
      <span class="strong"><strong>t.index :author_id</strong></span>
      <span class="strong"><strong>t.index :book_id</strong></span>
    <span class="strong"><strong>end</strong></span>
  end
end</pre><p>After creating the join table, you don’t need to do anything to make the
              association work. There is no model associated with the join table. With a
                <code class="literal">has_and_belongs_to_many</code> association, Rails manages the join table
              for you.</p></div><div class="sect3" title="has_many :through"><div class="titlepage"><div><div><h3 class="title"><a id="hasunderscoremany_through"/>has_many :through</h3></div></div></div><p>If you would like to store additional information in the join table besides the
              foreign keys of the associated models, use a <code class="literal">has_many :through</code>
              association. For example, you could model the association between bands and venues
              using a join table named <code class="literal">performances.</code>
              <a class="xref" href="ch08.html#hasunderscoremany_through_association" title="Figure 8-3. has_many :through association">Figure 8-3</a> shows the relationship among
              bands, performances, and venues.</p><div class="figure"><a id="hasunderscoremany_through_association"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00012"/><img alt="has_many :through association" src="httpatomoreillycomsourcenostarchimages2169082.png.jpg"/></div></div><p class="title">Figure 8-3. <code class="literal">has_many :through</code> association</p></div><p>Each performance belongs to a band and a venue. It also has a show-time. The
              models look like this:</p><a id="pro_id00241"/><pre class="programlisting">class Band &lt; ActiveRecord::Base
  has_many :performances
  has_many :venues, through: :performances
end</pre><p><a class="indexterm" id="iddle1039"/><a class="indexterm" id="iddle1730"/><a class="indexterm" id="iddle2168"/>A band performs many times, and so the band is associated with many
              different venues through its performances:</p><a id="pro_id00242"/><pre class="programlisting">class Venue &lt; ActiveRecord::Base
  has_many :performances
  has_many :bands, through: :performances
end</pre><p>A venue hosts many performances. The venue is associated with many different bands
              through the performances it hosts:</p><a id="pro_id00243"/><pre class="programlisting">class Performance &lt; ActiveRecord::Base
  belongs_to :band
  belongs_to :venue
end</pre><p>Performances associate a band with a venue. A venue can also store additional
              data, such as the showtime of the performance, in the <code class="literal">performances</code>
              table.</p></div></div><div class="sect2" title="Single-Table Inheritance"><div class="titlepage"><div><div><h2 class="title"><a id="single-table_inheritance"/>Single-Table Inheritance</h2></div></div></div><p>Sometimes you need to store a hierarchy of classes in the database. Most relational
            databases don’t support inheritance, but you can use <span class="emphasis"><em>single-table
              inheritance</em></span> to create these models and store the inheritance structure in
            the database.</p><p>For example, imagine you are writing an application to manage a pet store. You need
            a way to model different types of pets such as dogs and fish. Pet dogs and pet fish
            share many of the same attributes and methods, so it makes sense for both of them to
            inherit from a parent class named <code class="literal">Pet</code>.</p><p>In Rails, you can create a single table for pets and then store records for the two
            child classes <code class="literal">Dog</code> and <code class="literal">Fish</code> in the same table.
            Rails uses a column named <span class="emphasis"><em>type</em></span> to keep track of the type of object
            stored in each row. In addition to the columns needed by the parent model, you also need
            to add all columns needed by the child models to the table. You need this because all
            models are stored in the same table.</p><p>The parent model <code class="literal">Pet</code> is a normal Active Record model. The
              <code class="literal">Pet</code> model inherits from
            <code class="literal">ActiveRecord::Base</code>:</p><a id="pro_id00244"/><pre class="programlisting">class Pet &lt; ActiveRecord::Base
end</pre><p>The <code class="literal">Dog</code> model inherits from <code class="literal">Pet</code>:</p><a id="pro_id00245"/><pre class="programlisting">class Dog &lt; Pet
end</pre><p><a class="indexterm" id="iddle1191"/><a class="indexterm" id="iddle1229"/><a class="indexterm" id="iddle1959"/>The <code class="literal">Fish</code> model also inherits from
            <code class="literal">Pet</code>:</p><a id="pro_id00246"/><pre class="programlisting">class Fish &lt; Pet
end</pre><p>With these models in place, you can store records of all three types in a single
            table named <code class="literal">pets</code>, shown in <a class="xref" href="ch08.html#pets_table" title="Table 8-2. The pets Table">Table 8-2</a>.</p><div class="table"><a id="pets_table"/><p class="title">Table 8-2. The pets Table</p><div class="table-contents"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; " summary="The pets Table"><colgroup><col/><col/><col/><col/></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>id</p></th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>type</p></th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>name</p></th><th style="border-bottom: 0.5pt solid ; " valign="top"><p>cost</p></th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>1</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>Dog</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>Collie</p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>200</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>2</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>Fish</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>Gold Fish</p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>5</p></td></tr><tr><td style="border-right: 0.5pt solid ; " valign="top"><p>3</p></td><td style="border-right: 0.5pt solid ; " valign="top"><p>Dog</p></td><td style="border-right: 0.5pt solid ; " valign="top"><p>Cocker Spaniel</p></td><td style="" valign="top"><p>100</p></td></tr></tbody></table></div></div><p>These three rows from the <code class="literal">pets</code> table hold data for the
              <code class="literal">Dog</code> and <code class="literal">Fish</code> models. You can now make calls like
              <code class="literal">Pet.count</code> to count the pets in the table. Calling
              <code class="literal">Dog.count</code> returns 2 and <code class="literal">Fish.count</code> returns 1.
            Because Rails knows teach record type, <code class="literal">pet = Pet.find(2)</code> returns an
            object of type <code class="literal">Fish</code>.</p><p>You’ll look at another example of single-table inheritance in the next
            section, when you create the post models for your new application.</p></div><div class="sect2" title="Polymorphic Associations"><div class="titlepage"><div><div><h2 class="title"><a id="polymorphic_associations"/>Polymorphic Associations</h2></div></div></div><p>With polymorphic associations, a model can belong to more than one other model using
            a single association. The classic example of a polymorphic association is allowing
            comments on multiple types of objects. For example, you might want to let people comment
            on both posts and images. Here is what your comment model might look like using a
            polymorphic association:</p><a id="pro_id00247"/><pre class="programlisting">class Comment &lt; ActiveRecord::Base
  belongs_to :commentable, polymorphic: true
end</pre><p>Instead of using <code class="literal">belongs_to :post</code> or <code class="literal">belongs_to
              :image</code>, you specify that a comment <code class="literal">belongs_to</code> something
            called <code class="literal">:commentable</code>. This name can be anything you like, but the
            convention is to make it an adjective form of the model name.</p><p>The <code class="literal">comments</code> table will need two fields for this association to
            work, an integer field named <code class="literal">commentable_id</code> and a string field named
              <code class="literal">commentable_type</code>. The <code class="literal">commentable_type</code> field
            holds the class name of the object that owns this comment. This setup is similar to the
              <code class="literal">type</code> column in the single-table inheritance example you saw in the
            previous section. The <code class="literal">commentable_id</code> is a foreign key referring to
            the <code class="literal">id</code> of the object that owns this comment.</p><p><a class="indexterm" id="iddle1449"/><a class="indexterm" id="iddle1668"/><a class="indexterm" id="iddle2175"/><a class="indexterm" id="iddle2177"/><a class="indexterm" id="iddle2179"/><a class="indexterm" id="iddle2267"/><a class="indexterm" id="iddle2296"/>Include <code class="literal">as: :commentable</code> on the <code class="literal">has_many
              :comments</code> associations in models that can have comments:</p><a id="pro_id00248"/><pre class="programlisting">class Post &lt; ActiveRecord::Base
  has_many :comments, as: :commentable
end

class Image &lt; ActiveRecord::Base
  has_many :comments, as: :commentable
end</pre><p>The <code class="literal">has_many</code> association works the same as always. A method call
            like <code class="literal">@post.comments</code> returns a list of comments associated with the
            post. It works by looking for comments that match both the <code class="literal">id</code> of the
              <code class="literal">@post</code> object and the class name <code class="literal">Post</code>.</p><p>If your application grows and you need comments on other models, you can add the
            same <code class="literal">has_many</code> association to the new model without changing anything
            in the <code class="literal">Comment</code> model.</p><p>That’s enough theory for now. Let’s put some of this knowledge to
            work.</p></div></div><div class="sect1" title="The Social Application"><div class="titlepage"><div><div><h1 class="title"><a id="social_application"/>The Social Application</h1></div></div></div><p>In this section, you’ll build the data model for a social networking service
          similar to Tumblr. You need models for users and posts. You also need to represent a user
          following another user as well as several different types of posts, and users should be
          able to comment on posts.</p><p>Start by creating a new, empty Rails application in your code directory:</p><a id="pro_id00249"/><pre class="programlisting">$ <span class="strong"><strong>cd code</strong></span>
$ <span class="strong"><strong>rails new social</strong></span>
$ <span class="strong"><strong>cd social</strong></span></pre><p>I’m calling my application <span class="emphasis"><em>social</em></span>, but call yours whatever
          you like. Who knows, you may launch this app and sell it for a billion dollars
          someday!</p><p>Now let’s work through the models needed for this application.</p><div class="sect2" title="User Model"><div class="titlepage"><div><div><h2 class="title"><a id="user_model"/>User Model</h2></div></div></div><p>If this is to be a social site, the first thing you need is a model for users and
            the relationships between them. Tumblr, like Twitter, doesn’t use the idea of
            friendship between users. Instead, you subscribe to another user’s updates by
            “following” that user.</p><p>Start by creating a new resource named <code class="literal">User</code>. For now, add string
            fields for <code class="literal">name</code> and <code class="literal">email</code>. You can always add more
            fields later by creating another database migration. The following command creates a
            controller, model, database migration, and other files for users:</p><a id="pro_id00250"/><pre class="programlisting">$ <span class="strong"><strong>bin/rails generate resource User name email</strong></span></pre><p><a class="indexterm" id="iddle1118"/><a class="indexterm" id="iddle1186"/><a class="indexterm" id="iddle1230"/><a class="indexterm" id="iddle1442"/><a class="indexterm" id="iddle1775"/><a class="indexterm" id="iddle2204"/>Create the <code class="literal">users</code> table by running this new database
            migration:</p><a id="pro_id00251"/><pre class="programlisting">$ <span class="strong"><strong>bin/rake db:migrate</strong></span></pre><p>Next, you need to create a model to represent the idea of subscriptions. A
            subscription is a type of self join, but it is a many-to-many association, so you need a
            join table. What should this model contain? You subscribe to another user’s posts
            by following them. You can call the user you are following a leader. So you need to
            store a <code class="literal">leader_id</code> and a <code class="literal">follower_id</code> in the
              <code class="literal">subscriptions</code> table.</p><p>When one user follows another user, the following user’s <code class="literal">id</code>
            is stored in the <code class="literal">follower_id</code> field and the other user’s
              <code class="literal">id</code> is stored in the <code class="literal">leader_id</code> field. This setup
            allows you to find a list of a user’s followers and leaders easily.</p><a id="pro_id00252"/><pre class="programlisting">$ <span class="strong"><strong>bin/rails g model Subscription leader:references follower:references</strong></span>
  invoke  active_record
  create    db/migrate/..._create_subscriptions.rb
  create    app/models/subscription.rb
  invoke    test_unit
  create      test/models/subscription_test.rb
  create      test/fixtures/subscriptions.yml</pre><p>Because this is a join table, use the model generator to create a database migration
            and model for subscriptions. Don’t forget to update your database:</p><a id="pro_id00253"/><pre class="programlisting">$ <span class="strong"><strong>bin/rake db:migrate</strong></span></pre><p>Now that you’ve created the tables, you need to update the model files to
            define the associations. First, open the file
              <span class="emphasis"><em>app/models/subscription.rb</em></span> in your editor:</p><a id="pro_id00254"/><pre class="programlisting">class Subscription &lt; ActiveRecord::Base
  belongs_to :leader<span class="strong"><strong>, class_name: 'User'</strong></span>
  belongs_to :follower<span class="strong"><strong>, class_name: 'User'</strong></span>
end</pre><p>You used <code class="literal">leader:references</code> and
              <code class="literal">follower:references</code> when creating the model, so the Rails model
            generator added two <code class="literal">belongs_to</code> associations to the
              <code class="literal">Subscription</code> model for you. Both <code class="literal">:leader</code> and
              <code class="literal">:follower</code> actually refer to a <code class="literal">User</code>, so you need
            to add the class name <code class="literal">User</code>. By default, Rails looks for model names
            that match association names. If you don’t specify a class name, Rails looks for
            models named <code class="literal">Leader</code> and <code class="literal">Follower</code>. <a class="xref" href="ch08.html#subscription_associations" title="Figure 8-4. Subscription associations">Figure 8-4</a> shows the tables for <code class="literal">users</code>
            and <code class="literal">subscriptions</code>.</p><div class="note" title="Note"><h3 class="title"><a id="ch08note01"/>Note</h3><p><span class="emphasis"><em>In reality, these tables also include <code class="literal">created_at</code> and
                  <code class="literal">updated_at</code> timestamps, but I left these out of the diagrams in
                this chapter for brevity.</em></span></p></div><div class="figure"><a id="subscription_associations"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00013"/><img alt="Subscription associations" src="httpatomoreillycomsourcenostarchimages2169084.png.jpg"/></div></div><p class="title">Figure 8-4. Subscription associations</p></div><p><a class="indexterm" id="iddle1119"/><a class="indexterm" id="iddle1581"/><a class="indexterm" id="iddle1992"/><a class="indexterm" id="iddle2205"/><a class="indexterm" id="iddle2289"/>In the <code class="literal">subscriptions</code> table, both
              <code class="literal">leader_id</code> and <code class="literal">follower_id</code> are foreign keys
            referring to a user. Now that the <code class="literal">Subscription</code> associations are done,
            let’s add the <code class="literal">User</code> associations. Open the file
              <span class="emphasis"><em>app/models/user.rb</em></span> in your editor:</p><a id="pro_id00255"/><pre class="programlisting">  class User &lt; ActiveRecord::Base
➊   <span class="strong"><strong>has_many :subscriptions, foreign_key: :follower_id,</strong></span>
➋                            <span class="strong"><strong>dependent: :destroy</strong></span>
➌   <span class="strong"><strong>has_many :leaders, through: :subscriptions</strong></span>
  end</pre><p>Start with the fact that a user has many subscriptions. In this case, you need to
            specify the foreign key to use. Normally, you would call this
            <code class="literal">user_id</code>, but you’re modeling leaders and followers, so call it
              <code class="literal">follower_id</code> instead ➊. Also specify what happens if this
            user is deleted with <code class="literal">dependent: :destroy</code> ➋. This tells Rails
            to destroy any associated subscriptions if this user is ever destroyed. Finally, add the
              <code class="literal">has_many:through</code> association to leaders ➌.</p><p>Next, add a few methods to the model to make working with the associations easier.
            You can also use these methods to test the associations in the Rails console:</p><a id="pro_id00256"/><pre class="programlisting">  class User &lt; ActiveRecord::Base
    has_many :subscriptions, foreign_key: :follower_id,
                             dependent: :destroy
    has_many :leaders, through: :subscriptions

➊   <span class="strong"><strong>def following?(leader)</strong></span>
        <span class="strong"><strong>leaders.include? leader</strong></span>
    <span class="strong"><strong>end</strong></span>

➋   <span class="strong"><strong>def follow!(leader)</strong></span>
➌     <span class="strong"><strong>if leader != self &amp;&amp; !following?(leader)</strong></span>
        <span class="strong"><strong>leaders &lt;&lt; leader</strong></span>
      <span class="strong"><strong>end</strong></span>
    <span class="strong"><strong>end</strong></span>
  end</pre><p>First, add a <span class="emphasis"><em>predicate method</em></span>, a method returning a
              <code class="literal">true</code> or <code class="literal">false</code> value, called
              <code class="literal">following?</code> ➊ to see if the current user is following another
            user. This method checks to see if the current user’s <code class="literal">leaders</code>
            collection includes the <code class="literal">leader</code> passed as an argument to the
            method.</p><p><a class="indexterm" id="iddle1194"/><a class="indexterm" id="iddle1582"/><a class="indexterm" id="iddle2232"/>Then, add the <code class="literal">follow!</code> method ➋ to indicate that
            the current user is following another user. This method ensures the current user
            isn’t trying to follow himself or herself and isn’t already following the
            other user ➌. If neither case is true, the <code class="literal">leader</code> passed to
            this method is inserted into the current user’s <code class="literal">leaders</code>
            collection with <code class="literal">&lt;&lt;</code>, the insertion operator.</p><p>With these methods in place, you can now launch a Rails console and test your
            associations:</p><a id="pro_id00257"/><pre class="programlisting">$ <span class="strong"><strong>bin/rails console</strong></span></pre><p>Start by creating two users:</p><a id="pro_id00258"/><pre class="programlisting">irb(main):001:0&gt; <span class="strong"><strong>alice = User.create name: "Alice"</strong></span>
   (0.1ms) begin transaction
  SQL (0.6ms) INSERT INTO "users" ...
   (0.8ms) commit transaction
 =&gt; #&lt;User id: 1, name: "Alice", ...&gt;
irb(main):002:0&gt; <span class="strong"><strong>bob = User.create name: "Bob"</strong></span>
   (0.1ms) begin transaction
  SQL (0.6ms) INSERT INTO "users" ...
   (0.8ms) commit transaction
 =&gt; #&lt;User id: 2, name: "Bob", ...&gt;</pre><p>Now, call the <code class="literal">follow!</code> method on <code class="literal">alice</code> and pass
            in <code class="literal">bob</code>. Then call the <code class="literal">following?</code> method on
              <code class="literal">alice</code> to confirm that <code class="literal">follow</code> worked correctly.
            Finally, call <code class="literal">following?</code> again to see if <code class="literal">bob</code> is
            following <code class="literal">alice</code>:</p><a id="pro_id00259"/><pre class="programlisting">irb(main):003:0&gt; <span class="strong"><strong>alice.follow! bob</strong></span>
  User Exists (0.2ms) SELECT ...
   (0.1ms) begin transaction
  SQL (16.1ms) INSERT INTO ...
   (20.4ms) commit transaction
  User Load (0.3ms) SELECT ...
 =&gt; #&lt;ActiveRecord::Associations::CollectionProxy ...&gt;
irb(main):004:0&gt; <span class="strong"><strong>alice.following? bob</strong></span>
 =&gt; true
irb(main):005:0&gt; <span class="strong"><strong>bob.following? alice</strong></span>
User Exists (0.2ms) SELECT ...
 =&gt; false</pre><p>The call to <code class="literal">alice.follow! bob</code> adds <code class="literal">bob</code> to
            collection of <code class="literal">leaders</code> for <code class="literal">alice</code>. Next, the call to
              <code class="literal">alice.following? bob</code> checks to see if the
              <code class="literal">alice.leaders</code> collection includes <code class="literal">bob</code>. It does,
            so the method returns <code class="literal">true</code>. Of course, it doesn’t actually look
            for <code class="literal">bob</code>, but the <code class="literal">id</code> of the <code class="literal">User</code>
            referred to as <code class="literal">bob</code>. The call to <code class="literal">bob.following?
              alice</code> returns <code class="literal">false</code>. The <code class="literal">bob.leaders</code>
            collection is empty, so <code class="literal">bob</code> is not following
            <code class="literal">alice</code>. <a class="xref" href="ch08.html#users_table" title="Table 8-3. The users Table">Table 8-3</a> and <a class="xref" href="ch08.html#subscriptions_table" title="Table 8-4. The subscriptions Table">Table 8-4</a> show the <code class="literal">users</code> and
              <code class="literal">subscriptions</code> tables after Alice follows Bob, again with the
            timestamp fields omitted.</p><div class="table"><a id="users_table"/><p class="title">Table 8-3. The users Table</p><div class="table-contents"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; " summary="The users Table"><colgroup><col/><col/><col/></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><a class="indexterm" id="iddle1669"/><a class="indexterm" id="iddle1793"/><a class="indexterm" id="iddle2111"/>id</p></th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>name</p></th><th style="border-bottom: 0.5pt solid ; " valign="top"><p>email</p></th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>1</p></td><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>Alice</p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>NULL</p></td></tr><tr><td style="border-right: 0.5pt solid ; " valign="top"><p>2</p></td><td style="border-right: 0.5pt solid ; " valign="top"><p>Bob</p></td><td style="" valign="top"><p>NULL</p></td></tr></tbody></table></div></div><p>The <code class="literal">users</code> table holds records for <code class="literal">alice</code> and
              <code class="literal">bob</code>.</p><div class="table"><a id="subscriptions_table"/><p class="title">Table 8-4. The subscriptions Table</p><div class="table-contents"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; " summary="The subscriptions Table"><colgroup><col/><col/><col/></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>id</p></th><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>leader_id</p></th><th style="border-bottom: 0.5pt solid ; " valign="top"><p>follower_id</p></th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; " valign="top"><p>1</p></td><td style="border-right: 0.5pt solid ; " valign="top"><p>2</p></td><td style="" valign="top"><p>1</p></td></tr></tbody></table></div></div><p>The <code class="literal">subscriptions</code> table holds a single record representing the
            association between <code class="literal">alice</code> and <code class="literal">bob</code>. The
              <code class="literal">leader_id</code> is 2, the <code class="literal">id</code> of
              <code class="literal">bob</code><span class="strong"><strong>;</strong></span> and the
              <code class="literal">follower_id</code> is 1, the <code class="literal">id</code> of
              <code class="literal">alice</code>. This means <code class="literal">alice</code> is following
              <code class="literal">bob</code>.</p><p>At this point, you can get a list of every user that <code class="literal">alice</code> is
            following by calling the <code class="literal">leaders</code> method. Having this list is helpful,
            but it’s only half of what you need. You also want to be able to list a
            user’s followers. To do this, use the <code class="literal">subscriptions</code> table
            again, only this time going in the opposite direction.</p><p>You need another <code class="literal">has_many</code> association on the
              <code class="literal">Subscription</code> model that is the reverse of the existing association.
            You can then use that association to find followers.</p><a id="pro_id00260"/><pre class="programlisting">  class User &lt; ActiveRecord::Base
    has_many :subscriptions, foreign_key: :follower_id,
                             dependent: :destroy
    has_many :leaders, through: :subscriptions

➊   <span class="strong"><strong>has_many :reverse_subscriptions, foreign_key: :leader_id,</strong></span>
➋                                    <span class="strong"><strong>class_name: 'Subscription',</strong></span>
                                     <span class="strong"><strong>dependent: :destroy</strong></span>
➌   <span class="strong"><strong>has_many :followers, through: :reverse_subscriptions</strong></span>

    def following?(leader)
      leaders.include? leader
    end

    def follow!(leader)
      if leader != self &amp;&amp; !following?(leader)
        leaders &lt;&lt; leader
      end
    end
  end</pre><p>This association is the reverse of the existing <code class="literal">:subscriptions</code>
            association. There’s no clever word for the reverse of a subscription, so name the
            association <code class="literal">:reverse_subscriptions</code>. This association uses the
              <code class="literal">leader_id</code> field as the foreign key ➊. Because the
            association name doesn’t match the name of <a class="indexterm" id="iddle1480"/><a class="indexterm" id="iddle1674"/><a class="indexterm" id="iddle1972"/><a class="indexterm" id="iddle2178"/>the model, you also need to specify a class name ➋. As with the
            subscription association, also specify <code class="literal">dependent: :destroy</code> so you
            aren’t left with orphan records in the <code class="literal">subscriptions</code> table if a
            user is destroyed. After adding the <code class="literal">:reverse_subscriptions</code>
            association, you can use it to add another <code class="literal">has_many :through</code>
            association for <code class="literal">:followers</code> ➌.</p><p>Restart the Rails console for these changes to take effect, and then try the new
            association:</p><a id="pro_id00261"/><pre class="programlisting">➊ irb(main):001:0&gt; <span class="strong"><strong>alice = User.find(1)</strong></span>
    User Load (0.3ms) SELECT ...
  =&gt; #&lt;User id: 1, name: "Alice", ...&gt;
  irb(main):002:0&gt; <span class="strong"><strong>bob = User.find(2)</strong></span>
    User Load (0.3ms) SELECT ...
  =&gt; #&lt;User id: 2, name: "Bob", ...&gt;
➋ irb(main):003:0&gt; <span class="strong"><strong>alice.followers</strong></span>
    User Load (0.2ms) SELECT ...
  =&gt; #&lt;ActiveRecord::Associations::CollectionProxy []&gt;
➌ irb(main):004:0&gt; <span class="strong"><strong>alice.followers.to_a</strong></span>
  =&gt; []
  irb(main):005:0&gt; <span class="strong"><strong>bob.followers.to_a</strong></span>
    User Load (0.2ms) SELECT ...
  =&gt; [#&lt;User id: 1, name: "Alice", ...&gt;]</pre><p>Because you restarted the console, you first need to find your users in the database
            ➊. Call the <code class="literal">followers</code> method on <code class="literal">alice</code> to
            see if she has any followers ➋. This method returns a type of relation called an
              <code class="literal">ActiveRecord::Associations::CollectionProxy</code>. I made the output a
            little easier to read by chaining <code class="literal">to_a</code> after
              <code class="literal">followers</code>, which converts the output to an array ➌.</p><p>The output shows that <code class="literal">alice</code> has no followers and
              <code class="literal">bob</code> has a single follower—<code class="literal">alice</code>. The
              <code class="literal">User</code> associations and methods are working correctly so far. Now
            that users can follow each other, let’s move on to posts.</p></div><div class="sect2" title="Post Models"><div class="titlepage"><div><div><h2 class="title"><a id="post_models"/>Post Models</h2></div></div></div><p>People don’t just want to share plain text on a social network—they also
            want to share images, links, and videos. We should allow our users to create a different
            kind of post for each type of content, though the post types will share some common
            functionality. This sounds like a perfect use for inheritance.</p><p>First, create a base model called <code class="literal">Post</code>, and then inherit from
            that class to create models for <code class="literal">TextPost</code>,
              <code class="literal">ImagePost</code>, and so on. You can use singletable inheritance to create
            these models and store the inheritance structure in the database. Because the
              <code class="literal">posts</code> table holds records for all types of posts, you must add
            columns needed by the other models to the <code class="literal">posts</code> table. In addition to
            the usual <code class="literal">title</code> and <code class="literal">body</code> fields, add a
              <code class="literal">url</code> field to store the address of an image for image posts and a
              <code class="literal">type</code> field for single-table inheritance.</p><p><a class="indexterm" id="iddle1115"/><a class="indexterm" id="iddle1116"/><a class="indexterm" id="iddle1443"/><a class="indexterm" id="iddle1848"/><a class="indexterm" id="iddle2288"/><a class="indexterm" id="iddle2297"/><a class="indexterm" id="iddle2304"/>With those requirements in mind, generate the post resource and update your
            application’s database:</p><a id="pro_id00262"/><pre class="programlisting">$ <span class="strong"><strong>bin/rails g resource Post title body:text url type user:references</strong></span>
$ <span class="strong"><strong>bin/rake db:migrate</strong></span></pre><p>The <code class="literal">user:references</code> option adds a <code class="literal">user_id</code>
            field so you can associate posts with users. Don’t forget to update your
            application’s database.</p><p>Now you’re ready to create resources for the different types of posts.</p><a id="pro_id00263"/><pre class="programlisting">$ <span class="strong"><strong>bin/rails g resource TextPost --parent=Post --migration=false</strong></span>
$ <span class="strong"><strong>bin/rails g resource ImagePost --parent=Post --migration=false</strong></span></pre><p>Here, I’ve passed two options to the resource generator. The
              <code class="literal">--parent=Post</code> option indicates that these models inherit from
              <code class="literal">Post</code> and the <code class="literal">--migration=false</code> option tells the
            generator to not create a database migration for this resource. A database migration is
            not needed because these resources are stored in the <code class="literal">posts</code> table you
            created earlier.</p><p>First, let’s update the newly created <code class="literal">Post</code> model in
              <span class="emphasis"><em>app/models/post.rb</em></span> to make sure all posts have an associated user
            and type:</p><a id="pro_id00264"/><pre class="programlisting">  class Post &lt; ActiveRecord::Base
    belongs_to :user
➊   <span class="strong"><strong>validates :user_id, presence: true</strong></span>
➋   <span class="strong"><strong>validates :type, presence: true</strong></span>
  end</pre><p>All posts in our social application belong to an individual user. This validation
            ensures that a <code class="literal">Post</code> can’t be created without an associated
              <code class="literal">user_id</code> ➊. The type validation ➋ validates that all
            records are identified as either a <code class="literal">TextPost</code> or an
              <code class="literal">ImagePost</code>.</p><p>Now add validations to the <code class="literal">TextPost</code> and
              <code class="literal">ImagePost</code> models. First, edit
              <span class="emphasis"><em>app/models/image_post.rb</em></span> and add a URL validation to the
              <code class="literal">ImagePost</code> model:</p><a id="pro_id00265"/><pre class="programlisting">class ImagePost &lt; Post
  <span class="strong"><strong>validates :url, presence: true</strong></span>
end</pre><p>The <code class="literal">url</code> field holds the address of the image for an
              <code class="literal">ImagePost</code>. Users can copy a URL from an image sharing site such as
            Flickr or Imgur. The application shouldn’t allow an <code class="literal">ImagePost</code>
            to be saved without an image <code class="literal">url</code>.</p><p>Then update the <code class="literal">TextPost</code> model in
              <span class="emphasis"><em>app/models/text_post.rb</em></span> to check for a post body:</p><a id="pro_id00266"/><pre class="programlisting">class TextPost &lt; Post
  <span class="strong"><strong>validates :body, presence: true</strong></span>
end</pre><p><a class="indexterm" id="iddle1122"/>The application also shouldn’t allow a <code class="literal">TextPost</code> to
            be saved without <code class="literal">body</code> text.</p><p>While you’re editing models, also add the associations for the new post models
            under the rest of the <code class="literal">has_many</code> associations to the
              <code class="literal">User</code> model at <span class="emphasis"><em>app/models/user.rb:</em></span></p><a id="pro_id00267"/><pre class="programlisting">class User &lt; ActiveRecord::Base
  has_many :subscriptions, foreign_key: :follower_id,
                           dependent: :destroy
  has_many :leaders, :through =&gt; :subscriptions

  has_many :reverse_subscriptions, foreign_key: :leader_id,
                                   class_name: 'Subscription',
                                   dependent: :destroy
  has_many :followers, through: :reverse_subscriptions

  <span class="strong"><strong>has_many :posts, dependent: :destroy</strong></span>
  <span class="strong"><strong>has_many :text_posts, dependent: :destroy</strong></span>
  <span class="strong"><strong>has_many :image_posts, dependent: :destroy</strong></span>

  --<span class="emphasis"><em>snip</em></span>--</pre><p>Now you can restart the Rails console and use these new models:</p><a id="pro_id00268"/><pre class="programlisting">➊ irb(main):001:0&gt; <span class="strong"><strong>alice = User.find(1)</strong></span>
    User Load (42.0ms) SELECT ...
   =&gt; #&lt;User id: 1, ...&gt;
  irb(main):002:0&gt; <span class="strong"><strong>post1 = alice.text_posts.create(body: "First Post")</strong></span>
     (0.1ms) begin transaction
    SQL (0.7ms) INSERT INTO ...
     (1.9ms) commit transaction
   =&gt; #&lt;TextPost id: 1, ...&gt;
  irb(main):003:0&gt; <span class="strong"><strong>post2 = alice.image_posts.create(</strong></span>
                                   <span class="strong"><strong>url: "http://i.imgur.com/Y7syDEa.jpg")</strong></span>
     (0.1ms) begin transaction
    SQL (0.7ms) INSERT INTO ...
     (1.9ms) commit transaction
   =&gt; #&lt;ImagePost id: 2, ...&gt;
➋ irb(main):004:0&gt; <span class="strong"><strong>alice.posts.to_a</strong></span>
    Post Load (32.3ms) SELECT ...
   =&gt; [#&lt;TextPost id: 1, ...&gt;, #&lt;ImagePost id: 2, ...&gt;]
➌ irb(main):005:0&gt; <span class="strong"><strong>alice.text_posts.to_a</strong></span>
    TextPost Load (0.4ms) SELECT ...
   =&gt; [#&lt;TextPost id: 1, ...&gt;]</pre><p>Because you restarted the console, first find the <code class="literal">User</code>
            representing <code class="literal">alice</code> ➊. Then create a
              <code class="literal">TextPost</code> and an <code class="literal">ImagePost</code> belonging to
              <code class="literal">alice</code>. The <code class="literal">posts</code> method on the
              <code class="literal">User</code> model returns all posts associated with that user regardless
            of type ➋. Note that the <code class="literal">TextPost</code> and
              <code class="literal">ImagePost</code> you just created are both returned in the same
            collection. The <code class="literal">text_posts</code> method returns only
              <code class="literal">TextPost</code> objects ➌.</p></div><div class="sect2" title="Comment Model"><div class="titlepage"><div><div><h2 class="title"><a id="comment_model"/>Comment Model</h2></div></div></div><p><a class="indexterm" id="iddle1338"/><a class="indexterm" id="iddle2176"/>Now that the models for users and posts are in place, create the comments
            model for the application. Add a text field to hold the <code class="literal">body</code> of the
            comment, a <code class="literal">post_id</code> to reference the post that owns this comment, and
            a <code class="literal">user_id</code> to reference the user who left the comment.</p><p>Note that I am not using a polymorphic association with these comments. Because my
            different post types all inherit from the base class <code class="literal">Post</code>, I can
            simply associate <code class="literal">Comment</code> with <code class="literal">Post</code>, allowing
            comments on any type of post.</p><a id="pro_id00269"/><pre class="programlisting">$ <span class="strong"><strong>bin/rails g resource Comment body:text post:references user:references</strong></span>
$ <span class="strong"><strong>bin/rake db:migrate</strong></span></pre><p>Also add <code class="literal">has_many :comments</code> to the <code class="literal">User</code> and
              <code class="literal">Post</code> model to complete the associations among users, posts, and
            comments. <a class="xref" href="ch08.html#social_application_data_modelcomma_with" title="Figure 8-5. The social application data model, with timestamps omitted">Figure 8-5</a> shows the tables you
            created in this chapter and their associations.</p><div class="figure"><a id="social_application_data_modelcomma_with"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00014"/><img alt="The social application data model, with timestamps omitted" src="httpatomoreillycomsourcenostarchimages2169086.png.jpg"/></div></div><p class="title">Figure 8-5. The social application data model, with timestamps omitted</p></div><p>With this, you have all of your models and are well on your way to building your new
            social network.</p></div></div><div class="sect1" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="summary-id00019"/>Summary</h1></div></div></div><p>I covered some pretty advanced database modeling techniques in this chapter. The
            <code class="literal">User</code> model has several complex associations. The different types of
          posts demonstrate single-table inheritance. Luckily, the <code class="literal">Comment</code> model
          didn’t contain any surprises.</p><p>In the next chapter, I’ll talk about authentication, and you’ll start
          adding controller actions and views so users can sign up and log in to your social
          network.</p></div><div class="sect1" title="Exercises"><div class="titlepage"><div><div><h1 class="title"><a id="exercises-id00020"/>Exercises</h1></div></div></div><div class="qandaset" title="Frequently Asked Questions"><a id="ch08qa1"/><table border="0" summary="Q and A Set" width="100%"><col align="left" width="1%"/><col/><tbody><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch08qa1qe1"/><a id="ch08qa1q1"/><p>Q:</p></td><td align="left" valign="top"><p>1. You specified <code class="literal">dependent: :destroy</code> on all
                  <code class="literal">has_many</code> associations in this chapter to ensure that dependent
                models would be removed. For example, because the <code class="literal">Post</code> model has
                a <code class="literal">dependent: :destroy</code> association with the
                  <code class="literal">User</code> model, if a <code class="literal">User</code> is destroyed, then all
                of the user’s posts are also destroyed. What do you think would happen if you
                specified <code class="literal">dependent: :destroy</code> on a <code class="literal">belongs_to</code>
                association?</p></td></tr><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch08qa1qe2"/><a id="ch08qa1q2"/><p>Q:</p></td><td align="left" valign="top"><p>2. Add validations to the <code class="literal">Comment</code> model to ensure that every
                comment belongs to a <code class="literal">User</code> and a <code class="literal">Post</code>. Your
                application shouldn’t allow a <code class="literal">Comment</code> to be created without
                a <code class="literal">user_id</code> and <code class="literal">post_id</code>. You should also ensure
                that all comments have text in the <code class="literal">body</code> field.</p></td></tr><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch08qa1qe3"/><a id="ch08qa1q3"/><p>Q:</p></td><td align="left" valign="top"><p>3. Use the Rails console to create a new <code class="literal">User</code>. Create a
                  <code class="literal">TextPost</code> or <code class="literal">ImagePost</code> belonging to this
                  <code class="literal">User</code> and at least one <code class="literal">Comment</code>. Now destroy
                the <code class="literal">User</code>, and make sure the associated <code class="literal">Post</code>
                and <code class="literal">Comment</code> are also destroyed.</p></td></tr></tbody></table></div></div></div></body></html>