<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en">
<head>
<title>Chapter 11: Technical Email Controls</title>
<link href="NSTemplate_v1.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:5e8bb34b-260b-4fef-91f3-caabb4446e65" name="Adept.expected.resource"/>
</head>
<body epub:type="bodymatter chapter">
<section>
<header>
<h1 class="chapter">
<span class="ChapterNumber"><span epub:type="pagebreak" id="Page_149" title="149"/>11</span><br/>
<span class="ChapterTitle">Technical Email Controls</span></h1>
</header>
<figure class="opener">
<img alt="" src="image_fi/book_art/chapterart.png"/>
</figure>
<p class="ChapterIntro">So far, we’ve performed phishing attacks and learned how to train users to notice them. We’ve also discussed how to respond when people fall victim to social engineering despite our training. This chapter covers the implementation of technical email controls to help provide a safety net for the organization and remove some of this burden from the user.</p>
<p>In addition, we’ll discuss email appliances and services that can filter and manage emails. But before we get into those, let’s look at the actual standards associated with the technical side of email controls. </p>
<h2 id="h1-500983c11-0001">Standards</h2>
<p class="BodyFirst">As email has evolved, so have the technologies to protect it. And as those technologies have evolved, so have the attack patterns, becoming, as with <span epub:type="pagebreak" id="Page_150" title="150"/>anything in the information security field, a continuous game of cat and mouse. Over time, security professionals have proposed, debated, and approved a variety of standards. When it comes to securing email, there are three major ones: <em>Domain Keys Identified Mail (DKIM)</em>, <em>Sender Policy Framework (SPF)</em>, and <em>Domain-based Message Authentication, Reporting, and Conformance (DMARC)</em>. We’ll discuss each of these in this section.</p>
<p>What do these three standards do? A common misconception is that they protect your emails from incoming phishing or spoofing attempts. To some degree, they do, but it’s more accurate to describe them as protecting your <em>reputation</em>: if you send an email with these standards implemented, and the recipient domain is configured to check the associated records, they can detect attempts at spoofing your domain. While this may seem counterintuitive and unproductive, follow along through the remainder of this chapter to see how this might help you. </p>
<p>In short, SPF checks whether a host or IP address is in the sender’s list, DKIM sends a digital signature, and DMARC implements both SPF and DKIM, in addition to checking alignment. DMARC also establishes reporting. SPF is considered the lowest of the security standards. The caveat is that the recipient must have their mail servers configured to check for guidance from the sender regarding the standards and then actually perform the actions.</p>
<h3 id="h2-500983c11-0001">“From” Fields</h3>
<p class="BodyFirst">To grasp how these standards work, you need to understand the various types of From fields in an email. In addition to a Reply-to field, emails have From and MailFrom. The <em>From</em> field, also called <em>5322.From</em>, displays the sender. The <em>MailFrom</em> field, or <em>5321.MailFrom</em>, is the actual service that sent the email. For example, if I sent emails using MailChimp, my email address would be in the 5322.From field, and MailChimp’s server and address would be in the 5321.MailFrom field. </p>
<p>The numbers attached to these fields come from the RFCs that they were defined in. Here’s another easy way to think about it: the 5321.MailFrom field is the equivalent of a return address on an envelope mailed using the postal service, while the 5322.From field is the equivalent of a return address at the top of a letter contained within the envelope.</p>
<p>Now let’s cover these three standards in chronological order, beginning with DKIM.</p>
<h3 id="h2-500983c11-0002">Domain Keys Identified Mail</h3>
<p class="BodyFirst">DKIM became an internet standard in 2011. It seeks to authenticate emails and prevent spoofing by requiring senders to cryptographically sign parts of the email, including the 5322.From field. Seeing as an attacker probably won’t have access to the private key used to digitally sign the field, the email recipients can rapidly identify spoofing attempts. </p>
<p>The <em>DKIM header</em>, a field included in the email message, specifies where to get the public key that can verify the signature. The public key gets stored in a DNS TXT record using the DNS domain (<code>d=</code>) and selector (<code>s=</code>) <span epub:type="pagebreak" id="Page_151" title="151"/>tags you can find in the email message. The DKIM public key is the only part of the framework viewable to the general population, but finding it hinges upon knowing the selector, which you can do only if you received an email from the domain (or manage to brute-force it). </p>
<p>The DKIM process is as follows. First, you compose an email. As the email is sent, the private key associated with your DKIM entry creates two digital signatures that prove the authenticity of the email. One signature is for the DKIM header itself, and the other is for the body of the email. Each email has a unique pair of signatures. The signatures get placed in the header and sent along with the email. Once it’s received, and if the recipient mail server has DKIM configured, the server will verify the message’s authenticity by using the public key published to the DNS records. If the key is able to successfully decrypt the email, the email is authentic and wasn’t altered.</p>
<p> This said, DKIM isn’t often used for authentication. Instead, we mostly use it to verify the authenticity, and for something called DMARC alignment, discussed in <span class="xref" itemid="xref_target_“Domain-Based Message Authentication, Reporting, and Conformance” later in this chapter">“Domain-Based Message Authentication, Reporting, and Conformance” later in this chapter</span>. One of the shortcomings of DKIM is that it’s effective only if both the sender and recipient implement it. Furthermore, even if your organization implements DKIM internally, it can protect your users only from external actors spoofing other internal employees, which is good for your reputation, but does little to achieve security otherwise. After all, actors might spoof a trusted third party. But as mentioned earlier, the recipient must have their mail servers configured to check the DKIM authentication, which is typically accomplished through implementing DMARC. In the absence of DMARC, authentication failures are still passed to the recipient.</p>
<p>DKIM was first introduced in RFC 6376. Later, RFC 8301 amended it with the following specification regarding the type of encryption DKIM could use: </p>
<blockquote class="review">
<p class="Blockquote">Two algorithms are defined by this specification at this time: rsa-sha1 and rsa-sha256. Signers MUST sign using rsa-sha256. Verifiers MUST be able to verify using rsa-sha256. rsa-sha1 MUST NOT be used for signing or verifying.</p></blockquote>
<p>In 2018, another RFC dealing with DKIM was released; RFC 8463 added a new signing algorithm, ed25519, which uses SHA-256 and Edwards-curve Digital Signature Algorithm (EdDSA) in place of an RSA key.</p>
<h4 id="h3-500983c11-0001">Implementing DKIM</h4>
<p class="BodyFirst">For DKIM to be effective, you have to configure it not only in your DNS server but on the mail server as well. Otherwise, it acts as a deterrent at best. Let’s walk through configuring DKIM on a domain hosted through Google Workspace. Other mail servers have similar features. </p>
<p>Regular Gmail uses Google’s default DKIM keys, as do domains hosted in Workspace that do not have DKIM configured. You cannot set up your own DKIM for a Gmail account hosted at <em>gmail.com</em>, but you can for a <span epub:type="pagebreak" id="Page_152" title="152"/>domain using Workspace. According to Google’s support documents, if a user doesn’t set up their own DKIM public key, Google will use the following default one: <code>d=*.gappssmtp.com</code>. </p>
<p>Let’s set up our own private key. First, navigate to your Workspace administrator’s console as a Super Admin. Once you’re in the console, click <b>Authenticate email</b>, as shown in <a href="#figure11-1" id="figureanchor11-1">Figure 11-1</a>.</p>
<figure>
<img alt="&lt;&lt;Google admin console's &quot;Settings for Gmail&quot; page, including user settings, labs, hosts, default routing, authenticate email (outlined in red), and manage quarantines.&gt;&gt;" class="keyline" src="image_fi/500983c11/f11001.png"/>
<figcaption><p><a id="figure11-1">Figure 11-1</a>: Selecting the Authenticate email option</p></figcaption>
</figure>
<p>You should now see the DKIM authentication option and be prompted to select a domain to configure DKIM to support (<a href="#figure11-2" id="figureanchor11-2">Figure 11-2</a>).</p>
<figure>
<img alt="&lt;&lt;Google admin console's &quot;Authenticate email&quot; page listing DKIM authentication options, including domain selection. &quot;Generate New Record&quot; and &quot;Stop Authentication&quot; buttons shown.&gt;&gt;" class="keyline" src="image_fi/500983c11/f11002.png"/>
<figcaption><p><a id="figure11-2">Figure 11-2</a>: Beginning the DKIM configuration</p></figcaption>
</figure>
<p><span epub:type="pagebreak" id="Page_153" title="153"/>Once you select Generate New Record, you will need to select a key length and the selector (<a href="#figure11-3" id="figureanchor11-3">Figure 11-3</a>). Note that some hosting providers and DNS platforms do not support 2,048-bit key lengths. Per Google, if this is the case, default back to 1,024-bit keys.</p>
<figure>
<img alt="&lt;&lt;&quot;Generate New Record&quot; box shows option selections for the DKIM key bit length (2048) and prefix selector (google).&gt;&gt;" class="keyline" src="image_fi/500983c11/f11003.png"/>
<figcaption><p><a id="figure11-3">Figure 11-3</a>: Generating the DKIM record and RSA key</p></figcaption>
</figure>
<p>From here, select the domain as appropriate and click <b>Generate New Record</b>. This will create the key (censored in <a href="#figure11-4" id="figureanchor11-4">Figure 11-4</a>). Open a new window to copy and paste this into DNS. Once this is complete, click <b>Start Authenticating</b>.</p>
<figure>
<img alt="&lt;&lt;Google admin console's &quot;Authenticate email&quot; page. Outlined in red: the selected domain (theosintion.com), the DNS Host name/TXT record name (partially censored by author), and the TXT record value (partially censored by author).&gt;&gt;" class="keyline" src="image_fi/500983c11/f11004.png"/>
<figcaption><p><a id="figure11-4">Figure 11-4</a>: DKIM record in Google Workspace</p></figcaption>
</figure>
<p>After this stage, enter the cPanel, a common domain management tool used by many hosting providers. The cPanel should include a DNS Zone Editor, with a box that allows you to enter your public key into a TXT record (<a href="#figure11-5" id="figureanchor11-5">Figure 11-5</a>).</p>
<span epub:type="pagebreak" id="Page_154" title="154"/><figure>
<img alt="&lt;&lt;DNS Zone Editor shows the fields Select domain, Create new record, and Manage DNS records, which includes the type, name, and value. Name and Value information is partially censored by author.&gt;&gt;" class="keyline" src="image_fi/500983c11/f11005.png"/>
<figcaption>
<p><a id="figure11-5">Figure 11-5</a>: Adding a DNS TXT record</p><p/></figcaption>
</figure>
<p>Note that these panels might limit you to 255 characters: too short for the 2,048-bit-long key recommended by industry standards. (When this happened to me, I contacted support and asked them to manually enter the information on my behalf, which they reluctantly did.)</p>
<p>Once you save the key, propagating the record could take up to 48 hours. You’ll need to click Start Authentication on the dashboard to verify it after propagation is complete. Propagation typically takes 24–48 hours, but sometimes as long as 72 hours, depending on the infrastructure and provider.</p>
<p>Here’s another important consideration, discussed further in the next section: you must validate that your hosting and DNS provider supports concatenated DNS entries before using anything above a 1,024-bit RSA key. Essentially, certain providers impose limits on the number of characters that can be entered into a single entry in DNS. Your DMARC implementation will fail alignment if the provider does not support the concatenation, as DNS will interpret it as two unrelated TXT entries and fail to accomplish its purpose.</p>
<p>For setting up DKIM on other email providers, like Exchange, Office 365, and Sendmail, you can find links to several tutorials at <a class="LinkURL" href="http://email-security.seosint.xyz/">http://email-security.seosint.xyz/</a>. </p>
<h4 id="h3-500983c11-0002"><span epub:type="pagebreak" id="Page_155" title="155"/>Shortcomings of DKIM</h4>
<p class="BodyFirst">The encryption used in DKIM has at times included vulnerabilities. Until 2018, DKIM allowed the use of the SHA-1 algorithm for signing and verification. Yet the security community has known SHA-1 to be insecure since 2010, before the DKIM standard was even created. Researchers at CWI Amsterdam and Google have since successfully performed a collision attack on the protocol, at which point most parties in the cryptography and security communities deprecated it. The collision attack allowed the parties to take hashes of two files that didn’t match and produce the same hash from them, making it appear that they matched. All major web browser vendors announced they would stop accepting SHA-1 certificates in 2017. </p>
<p>It’s true that creating a collision at the precise location within the process of DKIM operations would still require a lot of computational power, so only sophisticated and well-funded organizations, such as nation-states or large tech companies, could have the capabilities to perform such an attack. After all, Google was one of the two parties to produce the SHA-1 collision (and it’s unlikely that Google will be attempting to send unauthorized emails to your organization). But if you have the autonomy to do so, use the more secure SHA-256.</p>
<p>Secondly, vulnerabilities exist in RSA, used as the public-key infrastructure of the DKIM standard. As I mentioned earlier, Google’s DKIM tool supports two 1,024-bit and 2,048-bit RSAs. The 2,048-bit RSA is the current industry minimum standard. There is significant debate as to whether RSA is secure, given mathematic, computational, and cryptographic advances since RSA’s introduction. Several academics and researchers have claimed to be able to crack RSA or reduce the RSA cryptosystem. Reducing the cryptosystem is a method of weakening its strength by identifying large prime numbers used and factorization.</p>
<p>Using 1,024-bit RSA is certainly a vulnerability on paper, while using 2,048-bit RSA is discouraged but not prohibited. Pragmatically, without massive computational resources or access to quantum computing facilities, neither 1,024- nor 2,048-bit RSA can be broken in less than two million years on a single system. Later versions of DKIM added Ed25519-SHA256 as an accepted algorithm, although it has not been widely adopted.</p>
<p>The final weakness in DKIM is not a vulnerability, but rather a shortcoming. DKIM is excellent to implement, and it can protect an organization’s reputation—but only if the recipient’s mail server is configured to check the DKIM signature and take action against emails claiming to come from a domain with DKIM enabled; otherwise, your organization’s reputation can still be damaged. </p>
<h3 id="h2-500983c11-0003">Sender Policy Framework</h3>
<p class="BodyFirst">Like DKIM, the Sender Policy Framework (SPF) seeks to prevent spoofing using DNS TXT records. In these TXT records, SPF defines the domains, lists of hosts, domains, and IP addresses, and IP addresses allowed to send emails from within a mail environment or on behalf of a domain. </p>
<p><span epub:type="pagebreak" id="Page_156" title="156"/>While some sources describe SPF as authenticating the sender, it’s more appropriate to describe the framework as validating it; if configured to do so, the recipient will check the sender information from the 5322 and 5321 fields to authorize the senders, as defined in the SPF record. If the record is configured to <em>hard fail</em>, the email will fail, and if it’s configured to <em>soft fail</em>, the email will succeed. </p>
<p>To see how this works, imagine that someone spoofs an email from a domain. The recipient checks the SPF record and observes that the sending domain has hard fails configured; also, the sender isn’t listed in the record. In addition, the SPF policy is set to pass. In that case, the email will fail to reach its destination. If there hadn’t been an SPF record, or if the policy was set to <code>none</code> or configured to soft fail, the email would have succeeded.</p>
<p>Since SPF does not require cryptography, SPF and DKIM are complementary, not competitors. SPF is logic based, as it compares incoming values to a list. The host, domain, or IP address is either in the record or it isn’t. DKIM employs both logic and cryptography in the form of digital signatures. You can read more about SPF in RFC 7208, which introduced it in 2014. </p>
<h4 id="h3-500983c11-0003">Implementing SPF</h4>
<p class="BodyFirst">Let’s implement SPF in Google Workspace. Begin by determining any service providers, such as Google or Outlook, and the associated domains allowed to send email on behalf of your organization. (You might specify those domains in the MX record.) If you’re running an internal mail server, like Exchange, also determine the network blocks authorized to email on behalf of the organization.</p>
<p>Then, for these domains and IP addresses, choose a policy for various situations:</p>
<ol class="none">
<li><span class="RunInHead">Pass (<span class="LiteralBold"><code>+</code></span>)</span>  Allows all email to pass through (not recommended, unless for brief troubleshooting)</li>
<li><span class="RunInHead">No policy (<span class="LiteralBold"><code>?</code></span>), neutral</span>  Essentially means <em>no policy</em></li>
<li><span class="RunInHead">Soft fail (<span class="LiteralBold"><code>~</code></span>)</span>  Somewhere between fail and neutral; generally these emails are accepted but tagged</li>
<li><span class="RunInHead">Hard fail (<span class="LiteralBold"><code>-</code></span>)</span>  Rejects the email</li>
</ol>
<p>As backups, you might configure something like <code>+all</code> (not recommended, as it would allow all mail), <code>+mx</code> (allows emails from the host listed in the MX record; not recommended if using cloud email like Google or Office 365), or <code>+nostarch.com</code> (which would allow emails from <em>nostarch.com</em>).</p>
<p>Once you have this information, you’re ready to create the record. To start, navigate to the DNS editor for your hosting provider and create a new TXT record. Alternatively, edit any existing TXT records that have <code>v=spf1</code> in the body, as shown here:</p>
<pre><code>dig walmart.com txt

; &lt;&lt;&gt;&gt; DiG 9.11.3-1ubuntu1.13-Ubuntu &lt;&lt;&gt;&gt; walmart.com txt
<span epub:type="pagebreak" id="Page_157" title="157"/>;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 6907
;; flags: qr rd ra; QUERY: 1, ANSWER: 15, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
; walmart.com.                   IN      TXT

;; ANSWER SECTION:
walmart.com.            300     IN      TXT     "v=spf1 
include:_netblocks.walmart.com include:_smartcomm.walmart.com 
include:_vspf1.walmart.com include:_vspf2.walmart.com 
include:_vspf3.walmart.com ip4:161.170.248.0/24 ip4:161.170.244.0/24 
ip4:161.170.241.16/30 ip4:161.170.245.0/24 ip4:161.170.249.0/24" " ~all"
<var>--snip--</var>
;; Query time: 127 msec
;; SERVER: 127.0.0.53#53(127.0.0.53)
;; WHEN: Tue Sep 08 05:42:49 UTC 2020
;; MSG SIZE  rcvd: 1502 </code></pre>
<p>Set the time-to-live (TTL) value to the default of 14,400. The <em>TTL value</em> is the time DNS recursive resolvers have to cache our SPF record before pulling down a new one (if it changed). Some things, like critical assets and load balancers, operate best with a very small TTL. Assets that should not change frequently or have redundancy built in (such as MX records) are recommended to have larger TTL values. This is to attempt to combat techniques like fast flux or dynamic DNS records commonly used in sophisticated phishing campaigns and attacks against social media sites. </p>
<p>Then name the TXT record after the organization’s domain. For the actual text, enter <code class="bold">v=spf1</code>, followed by the mechanisms and the policy, as discussed earlier. To define these mechanisms, you’ll need to know the five types of fields allowed:</p>
<ol class="none">
<li><span class="RunInHead"><span class="LiteralBold"><code>ip4</code></span></span>  IPv4 address or CIDR range</li>
<li><span class="RunInHead"><span class="LiteralBold"><code>ip6</code></span></span>  IPv6 address</li>
<li><span class="RunInHead"><span class="LiteralBold"><code>mx</code></span></span>  The sender’s MX record in DNS</li>
<li><span class="RunInHead"><span class="LiteralBold"><code>a</code></span></span>  Address record for host in DNS</li>
<li><span class="RunInHead"><span class="LiteralBold"><code>include</code></span></span>  References the policy of another domain</li>
</ol>
<p>Now, build the string to input into DNS. Let’s say that you’ll allow hosts using <em>nostarch.com</em>’s MX record, in addition to MailChimp and a private, non-routable IP address range, with a hard fail. The text to enter into DNS would look like this:</p>
<pre><code>v=spf1 +mx include:192.168.1.22 include:192.168.2.0/24 include:servers.mcsv.net -all</code></pre>
<p>You could write this record in an alternative way, as well. In <span class="xref" itemid="xref_target_Chapter 4">Chapter 4</span>, you learned that No Starch uses Google Workspace, so you could replace <span epub:type="pagebreak" id="Page_158" title="158"/>the <code>+mx</code> portion with Google’s servers (which can be found in the Workspace dashboard). To keep this to one line, you will remove the MailChimp SPF <code>include </code>mechanism. The alternative entry would look like this:</p>
<pre><code>v=spf1 include:_spf.google.com include:192.168.1.22 include:192.168.2.0/24 -all</code></pre>
<p>Once you paste this into the DNS record, allow up to 72 hours for it to propagate. It takes time for the various DNS servers on the internet to copy the updated information. This time is heavily dependent upon the TTL times, which direct servers to cache information for a period of seconds before refreshing. In my experience, SPF can become valid almost immediately, unlike DKIM. Whether you use Google as your mail provider or not, you can still use the Google Admin Toolbox Check MX site to validate the information provided. You can find the toolbox at <a class="LinkURL" href="https://toolbox.googleapps.com/apps/checkmx/">https://toolbox.googleapps.com/apps/checkmx/</a>. You can find instructions for configuring SPF on other platforms at <a class="LinkURL" href="http://email-security.seosint.xyz/">http://email-security.seosint.xyz/</a>.</p>
<h4 id="h3-500983c11-0004">Shortcomings of SPF</h4>
<p class="BodyFirst">Remember from <span class="xref" itemid="xref_target_Chapter 4">Chapter 4</span> that SPF allows attackers to enumerate domains, IP addresses, and ranges of IP addresses that an organization either owns or uses. Attackers may also be able to tell if the target has hard fail or soft fail configured by checking the <code>-all</code> (hard fail), <code>~all</code><em> </em>(soft fail), or <code>~?</code> (neutral) part of the TXT record. This information may influence their decision about whether to spoof your organization’s domain, or perhaps squat on something similar. A detail-oriented social engineer may even configure DKIM and SPF on their phishing domain to bypass any checks that an organization may have in place, should they actually be enforcing any policies.</p>
<p>SPF can also alert attackers to your working relationships with other organizations. If other domains need the authority to send emails on your behalf, you may need to create SPF records for them. Examples of domains that will need permission to send emails on an organization’s behalf are mailing lists like MailChimp, Mailgun, or Constant Contact. Also account for other providers that send emails on behalf of the organization, such as GoToMeeting or similar collaboration platforms. </p>
<p>The final aspect of SPF is not a vulnerability, but rather a shortcoming. Like DKIM, SPF is good to implement, and it can protect an organization’s reputation, but only if the recipient mail server is configured to check for the SPF records and enforce the defined policy. Failure to do so, however, may damage your organization’s reputation. </p>
<h3 id="h2-500983c11-0004">Domain-Based Message Authentication, Reporting, and Conformance</h3>
<p class="BodyFirst">DMARC takes existing SPF and DKIM implementations and uses them to create a more robust solution for preventing spoofing, business email compromise, and reputational harm. First introduced as an internet standard in 2015 (RFC 7489), it seeks to overcome the limitations of both SPF and DKIM: it implements both of the earlier standards, but also reports successes and failures to the sending domain. DMARC checks an email’s <em>alignment</em>, or <span epub:type="pagebreak" id="Page_159" title="159"/>whether the 5322.From<em> </em>field matches the authenticated domain names. In other words, it verifies that an email with a <em>From</em> field claiming to be from info@nostarch.com actually originated from that domain. An email can pass SPF and DKIM but fail in alignment. </p>
<p>Here is what happens when a communication uses DMARC. First, a user writes an email. The sending email server inserts a DKIM header into it, and then sends it to the recipient. From there, in order for the email to traverse an organization with an enforced DMARC policy implemented, two things must happen. First, the email must pass DKIM signature checks (5322.From, with validation using a public key contained in DNS). Second, it must pass SPF checks (5322.From) and TXT records. Depending on the outcome of those checks, the DMARC record will specify that the server should either accept or reject the email. Reporting will occur for failures. The email undergoes any processes or filters enacted by the recipient, and if everything passes, it arrives in the recipient’s inbox.</p>
<p>DMARC is widely used. Several compliance frameworks require it, along with US federal agencies, as directed by Department of Homeland Security Binding Operational Directive 18-01. If you keep up with vendor marketing materials, you may recall the flood of vendors using this directive to sell DMARC and email security tools in 2017. But these implementations are worthless without an enforced policy, or a technical configuration that directs actions to occur with minimal human intervention. Additionally, the recipient must actually check the records and enforce the policy they have in place. </p>
<p>Two RFCs exist to update DMARC: RFC 8553, which addresses using underscores in node names; and RFC 8616, which addresses the use of ASCII characters in SPF, DKIM, and DMARC when they don’t address internationally used characters.</p>
<h4 id="h3-500983c11-0005">Implementing DMARC</h4>
<p class="BodyFirst">Before you can implement DMARC, you have to implement SPF and DKIM. Then you’ll need to collect the information to put in the TXT record. You can find the full record format defined in Section 6.3 of RFC 7489, but you’ll need the following, at a minimum:</p>
<ol class="none">
<li><span class="RunInHead">The version of DMARC (<span class="LiteralBold"><code>v</code></span>)</span>  The version of DMARC in use. This is currently 1, indicated by <code>v=DMARC1</code>.</li>
<li><span class="RunInHead">The policy (<span class="LiteralBold"><code>p</code></span>)</span>  The policy to be applied for a given domain.</li>
<li><span class="RunInHead">The subdomain policy (<span class="LiteralBold"><code>sp</code></span>)</span>  Policy that is applicable only to subdomains of the sending domain, such as emails from info@us.nostarch.com but not info@nostarch.com. In the absence of an <code>sp</code> field or qualifier, the organization will enforce the main <code>p</code> field.</li>
<li><span class="RunInHead">The percent of “bad emails” to apply the policy to (<span class="LiteralBold"><code>pct</code></span>)</span>  A number between 0 and 100 that determines the percentage of emails from a domain owner to apply the policy to.</li>
<li><span class="RunInHead">The <span class="LiteralBold"><code>rua</code></span> tag</span>  The email address to which the reports are sent. OSINT collectors can read and weaponize this, so an alias is recommended.</li>
</ol>
<p><span epub:type="pagebreak" id="Page_160" title="160"/>All fields in the DMARC record, aside from the version, require qualifiers. For example, the <code>policy</code> field takes either <code>none</code>, <code>quarantine</code>, or <code>reject</code>. The <code>none</code> qualifier takes no action, while <code>quarantine</code> redirects the email to be placed into spam folders or sent to administrators, and <code>reject</code> rejects the email.</p>
<p>You can also add forensic reporting options and an address for forwarding forensic reports. The forensic failure reporting tag (<code>fo</code>) determines which events will generate forensic reporting. It has four options: <code>0</code>, which creates a failure report if all mechanisms fail; <code>1</code>, which creates a failure report if any mechanisms fail; <code>d</code>, which creates a DKIM failure report if DKIM fails, regardless of alignment; and <code>s</code>, which<code> </code>creates a SPF failure report if SPF fails, regardless of alignment. The <code>ruf</code> tag specifies the email address to which the forensic reports are sent. Like the <code>rua</code> tag, OSINT collectors can read and weaponize this, so use an alias.</p>
<p>Two additional fields, <code>adkim</code> and <code>aspf</code>, determine whether the owner requires alignment mode, which dictates the actions to take if the email fails SPF or DKIM. Both have possible values of <code>r</code> for relaxed and <code>s</code> for strict. Relaxed requires an exact match for the domain only, while strict requires a complete exact match to pass. Both values are optional and, by default, set to relaxed. </p>
<p>This might seem like a lot of information. To put it to use, let’s configure a DMARC record for <em>nostarch.com</em>: </p>
<pre><code>v=DMARC1; p=quarantine;pct=95; rua=mailto:dmarc@nostarch.com; fo=1; ruf=mailto:soc@nostarch.com;</code></pre>
<p>This record has a quarantine policy for domains only. It applies to 95 percent of the emails, and any failure causes forensic reporting, with forensic reports going to soc@nostarch.com. You’ll set the email address to receive the general DMARC reports to dmarc@nostarch.com<em>. </em></p>
<p>Once you’ve drafted this, you’d add it to a TXT record in <em>nostarch.com</em>’s DNS zone file with the name <em>dmarc</em> and a TTL of <code>14400</code>. </p>
<h4 id="h3-500983c11-0006">Shortcomings of DMARC</h4>
<p class="BodyFirst">Aside from the same information disclosures present in SPF, and the fact that your email recipients might not check for SPF or DKIM, DMARC itself introduces no significant issues or vulnerabilities. </p>
<p>That said, simply creating the DNS TXT records for DMARC does not immediately make you secure. For example, you could easily misconfigure your DMARC implementation. When you’re initially configuring DMARC, avoid rejecting emails, as that removes the ability for humans to review the email for validity and may cause business interruptions or misdirected communications. </p>
<p>Mitigating this is simple: start by setting the initial DMARC policy to <code>none</code> and review 100 percent of the emails (<code>p=none; pct=100;</code>). As time progresses, lower the <code>pct</code> field incrementally until you’re comfortable with the reports and the performance. Once you’ve attained a good level, change the review percentage to a manageable but realistic value. I recommend <span epub:type="pagebreak" id="Page_161" title="161"/>60 to 85 percent for enterprises, depending on your resources. Then update the DMARC TXT record to reflect this (<code>p=quarantine; pct=75;</code>). </p>
<p>Keep in mind that actors who use email to attempt to gain access to your organization’s enterprise may leverage tools to enhance their legitimacy, so don’t rely solely on SPF, DKIM, and DMARC. For example, if an actor compromises another organization with SPF, DKIM, and DMARC configured, and then sends your organization an email through legitimate channels, it will pass all checks associated with these three standards. </p>
<p>Another threat vector not addressed by DMARC is encryption. The three standards do not provide a means to encrypt emails. Sure, DKIM uses cryptography, but only to sign emails. The next sections cover how to address this gap.</p>
<h2 id="h1-500983c11-0002">Opportunistic TLS </h2>
<p class="BodyFirst">When originally designed, the SMTP, POP, and IMAP mail protocols didn’t include encryption. As attacks evolved, researchers created <em>Opportunistic Transport Layer Security (TLS)</em> to encrypt them. You’ll sometimes see it nicknamed <em>STARTTLS</em>, after the command used to start the service.</p>
<p>Here’s how STARTTLS works. First, the sending server connects to the receiving server as normal. It then requests Extended SMTP, which allows images and attachments. From here, the sender asks the recipient server if it supports STARTTLS. If the response is yes, the connection restarts and encrypts the email using the version of the SSL or TLS protocol agreed upon by both hosts. If the answer is no, the email proceeds unencrypted. Another variant, called <em>Enforced TLS</em>, won’t let the email send unless the connection is secured. The use of Enforced TLS is not widely adopted because of the possibility of mail being blocked for the inability to negotiate encryption.</p>
<p>The biggest problem with STARTTLS is that it is <em>opportunistic,</em> which means it uses encryption only if available. In the absence of available encryption or support for it, the message will be sent in plaintext. Another problem with STARTTLS is that the encryption handshake itself occurs in plaintext, which enables would-be attackers to steal the session information or modify the messages via man-in-the-middle attacks. You can see both of these problems exploited in <em>STRIPTLS attacks,</em> whereby an attacker either disables the actual STARTTLS command or makes it appear as if TLS is unavailable. By configuring SMTP to require TLS for outgoing connections, you can mitigate STRIPTLS but might lose outgoing email services if you misconfigure the TLS or if the recipient is not configured to receive TLS emails/blocks the port. </p>
<p>Another mitigation of STRIPTLS exists in a subordinate function of Domain Name System Security Extensions (DNSSEC) called DNS-based Authentication of Named Entities (DANE). Implementing DANE requires organizations to create a DNS record that directs all communications on a specific port or protocol to negotiate the session using a public key placed into DNS. This could also be misused or collected as part of an OSINT <span epub:type="pagebreak" id="Page_162" title="162"/>effort, as with anything in public DNS entries, as an adversary can query DNS records and draw inferences from the entries. While this mitigation itself is simple to implement, DNSSEC overall is not, so we haven’t seen widespread adoption of it. </p>
<p>Around the same time that DANE was being developed, a different solution to the same problem (STRIPTLS) was being drafted: SMTP MTA Strict Transport Security (MTA-STS).</p>
<h2 id="h1-500983c11-0003">MTA-STS</h2>
<p class="BodyFirst"><em>SMTP MTA Strict Transport Security (MTA-STS)</em> is another way of implementing TLS for securing email communications. In this method, the two parties negotiate the TLS handshake using DNS TXT records, as well as files uploaded to specific directories in a predefined, publicly accessible subdomain of the sending domain. </p>
<p>This standard applies to only SMTP traffic between mail servers. The communication between client and server is accomplished using HTTP Strict Transport Security (HSTS). Because of the complexity of implementing MTA-STS, I won’t walk through the process here. You can find links to tutorials at <a class="LinkURL" href="http://email-security.seosint.xyz/">http://email-security.seosint.xyz/</a><em>.</em></p>
<h2 id="h1-500983c11-0004">TLS-RPT</h2>
<p class="BodyFirst"><em>SMTP TLS Reporting (TLS-RPT)</em> is a method of gathering statistics about potential failures when negotiating TLS and associated domains. Think of this as comparable to DMARC, if MTA-STS were the DKIM element. You can use this information for troubleshooting or threat intelligence. </p>
<p>Setting up TLS-RPT is relatively easy, as it merely requires a DNS TXT record with <code>_smtp._tls.</code><var>domain.tld</var> and a reporting address in the body. If an error occurs with an email using an encrypted method (DANE or MTA-STS), the reporting email will receive a notification. The following is an example for <em>nostarch.com</em>: </p>
<pre><code>_smtp._tls.nostarch.com  300 
"v=TLSRPTv1;rua=mailto:soc@nostarch.com"</code></pre>
<p>The top line is the field name and TTL. The second line is the value. Here, we’ve set the TTL to 300 and reporting to <a href="http://mailto:soc@nostarch.com">soc@nostarch.com</a>. </p>
<h2 id="h1-500983c11-0005">Email Filtering Technologies</h2>
<p class="BodyFirst">The final step to achieving email security Zen is using filtering technologies. This typically means hiring a vendor or service provider to receive your emails before you do. The vendor will scan them for patterns they observe across all clients, and check for SPF, DKIM, and DMARC, if configured. Email filtering isn’t perfect, but it does remove a lot of the burden from the technical staff. Keep in mind, though, that hiring a vendor will <span epub:type="pagebreak" id="Page_163" title="163"/>likely require you to make changes to your public DNS records, and you can discover these relationships using OSINT techniques, as discussed previously. </p>
<p>Many configurations and products are out there. When choosing a vendor, consider their throughput of emails per minute or second. Also decide whether you’d like to maintain the email filtering through software, an appliance, or a cloud service. Each option presents unique challenges, particularly with respect to implementation, support, availability, and reporting, and each offers different features. Email filtering may be easier to implement in cloud instances, as these would best protect the availability of email. However, any decision that requires configuration, especially beyond DNS records, might afford opportunities for failure, disruption, or poor security. If you choose to use a cloud provider, you’ll also be reliant upon the SLA and your contract with the vendor. That said, they do simplify the process; you’ll be responsible for just updating your MX record in the DNS zone file and selecting the proper options. </p>
<p>Some vendors will also maintain and manage your SPF, DKIM, and DMARC implementations for you. Weigh the risks of what could occur to disrupt the system against what you gain from using the system. Does the vendor provide you their threat intelligence? Is this the service that the vendor specializes in? What does the contract entail? </p>
<h2 id="h1-500983c11-0006">Other Protections</h2>
<p class="BodyFirst">As security professionals, we must build our systems so that they can not only handle ordinary use, but also withstand abuse in a way that contains the actions long enough for us to detect and respond to them. This is the crux of Winn Schwartau’s book <em>Time Based Security </em>(Impact PR, 1999). </p>
<p>When securing your systems against phishing, consider implementing controls beyond those used solely for email. While we won’t discuss them in this chapter, implement malware protection, whether it’s antivirus, endpoint detection and response (EDR), or any other anti-malware product. Most malware finds its way into networks via email when users download it from a successful phish.</p>
<p>Two other technologies can prevent catastrophic outcomes from phishing: file integrity monitoring (FIM) and data loss prevention (DLP) systems. FIM monitors a set of files for modification. You could write a simple FIM solution that takes a cryptographic hash of every file and stores it somewhere. It would then validate that the files haven’t changed, and if they have, check whether the change was authorized. This is important for detecting malicious actors already in the network. If the file contents changed without authorization, this could indicate new applications running or being installed, ransomware, or someone tampering with important files.</p>
<p>DLP aims to prevent users from emailing files outside the organization, uploading files to the public internet and file-sharing websites (like Google Drive, Box, and Dropbox), and saving data to unauthorized USB devices <span epub:type="pagebreak" id="Page_164" title="164"/>(if any at all). Many DLP solutions also have the capability to prevent users from sharing sensitive or regulated data like Payment Card Industry (PCI) data, PHI, and PII. This is important because it prevents users from handing over trade secrets, intellectual property, and crown jewels. It also takes away many of the reasons they would have to plug a USB drive into their workstations in the first place, reducing the likelihood of a successful baiting attack.</p>
<h2 id="h1-500983c11-0007">Conclusion</h2>
<p class="BodyFirst">In this chapter, you took steps to make your organization a little safer. You learned about the three email security standards that aim to curb email spoofing, as well as the shortcomings of each. (If you’re like me, you’ve developed a special hatred of the letters <em>RFC</em>.) </p>
<p>Using the information in this chapter, you can apply the concepts and standards to your organization to create layers of defense. You may have to explain to management that SPF, DKIM, and DMARC aren’t absolute solutions to phishing, and that even when they’re in place, the organization should consider installing more controls, like email filtering solutions. </p>
<p>After the organization chooses the email filtering solution that best fits with its compliance needs and budget, take the time to properly implement the solution. Then test it with phishing simulations. If the simulations get caught, great. Next, you could release them from quarantine to test users. If the simulations make it through, work with the vendor to determine why and how to fix the problem.</p>
<p/>
</section>
</body>
</html>