<html><head></head><body>
<h2 class="h2" id="ch08"><span epub:type="pagebreak" id="page_208"/><span epub:type="pagebreak" id="page_209"/><span class="big">8</span><br/>LIBRARY INTERFACE VERSIONING AND RUNTIME DYNAMIC LINKING</h2>&#13;
<p class="quote"><em>Occasionally he stumbled over the truth, but hastily picked himself up and hurried on as if nothing had happened.<br/>—Sir Winston Churchill, quoted in</em> The Irrepressible Churchill</p>&#13;
<div class="image1"><img src="../images/common.jpg" alt="Image"/></div>&#13;
<p class="noindent">In the last chapter, I explained the concepts of dynamically loadable shared libraries. I also showed you how easy it is to add Libtool shared-library functionality and flexibility to your projects, whether your projects provide shared libraries, static libraries, convenience archives, or some mixture of these. There are still two major Libtool topics we need to cover. The first is library versioning, and the second involves using the Libtool <em>ltdl</em> library to portably build and consume dynamically loadable modules within your projects.</p>&#13;
<p class="indent">When I talk about the version of a library, I’m referring specifically to the version of the library’s public interface, but I need to clearly define the term <em>interface</em> in this context. A <em>shared-library interface</em> refers to all aspects of a shared library’s connections with the outside world. Besides the function and data signatures that a library exports, these connections include files and file formats, network connections and wire data formats, IPC channels <span epub:type="pagebreak" id="page_210"/>and protocols, and so on. When considering whether to assign a new version to a shared library, you should carefully examine all aspects of the library’s interactions with the world to determine if a change will cause the library to act differently from a user’s perspective.</p>&#13;
<p class="indent">Libtool’s attempts to hide the differences among shared-library platforms are so well conceived that if you’ve always used Libtool to build shared libraries, you may not even realize that the way shared libraries are versioned is significantly different between platforms.</p>&#13;
<h3 class="h3" id="ch08sec1">System-Specific Versioning</h3>&#13;
<p class="noindent">Let’s examine how shared-library versioning works on a few different systems to put the Libtool abstraction into context.</p>&#13;
<p class="indent">Shared-library versioning can be done either internally or externally. <em>Internal versioning</em> means that the library name does not reflect its version in any way. Thus, internal versioning implies that some form of executable header information provides the linker with the appropriate function calls for the requested <em>application binary interface (ABI)</em>. This also implies that all function calls for all versions of the library are maintained within the same shared-library file. Libtool supports internal versioning where mandated by platform requirements, but it prefers to use external versioning. With <em>external versioning</em>, version information is specified in the filename itself.</p>&#13;
<p class="indent">In addition to library-level versioning, wherein a particular version number or string refers to the entire library interface, many Unix systems support a form of export- or symbol-level versioning, wherein a shared library exports multiple named or numbered versions of the same function or global data item. While Libtool does not hinder the use of such export-level versioning schemes on a per-system basis, it does not provide any specific portability support for them, either. Therefore, I won’t go into great detail on this subject.</p>&#13;
<h4 class="h4" id="ch08sec1-1"><em>Linux and Solaris Library Versioning</em></h4>&#13;
<p class="noindent">Modern Linux borrows much of its library versioning system from Oracle’s Solaris operating system, version 9.<sup><a id="ch08fn_1" href="footnote.xhtml#ch08fn1">1</a></sup> These systems use a form of external library versioning in which version information is encoded in the shared-library filename, following a specific pattern or template. Let’s look at a partial directory listing for the <em>/usr/lib/x86_64-linux-gnu</em> directory on a typical Linux system—specifically, the files associated with a fairly typical library, <em>libcurl</em>:</p>&#13;
<pre>   <span epub:type="pagebreak" id="page_211"/>$ <span class="codestrong1">ls -lr /usr/lib/x86_64-linux-gnu/libcurl*</span>&#13;
<span class="ent">➊</span> -rw-r--r-- ... 947448 ... libcurl.a&#13;
   lrwxrwxrwx ...     19 ... libcurl-gnutls.so.3 -&gt; libcurl-gnutls.so.4&#13;
   lrwxrwxrwx ...     23 ... libcurl-gnutls.so.4 -&gt; libcurl-gnutls.so.4.4.0&#13;
   -rw-r--r-- ... 444800 ... libcurl-gnutls.so.4.4.0&#13;
   -rw-r--r-- ...    953 ... libcurl.la&#13;
<span class="ent">➋</span> lrwxrwxrwx ...     16 ... libcurl.so -&gt; libcurl.so.4.4.0&#13;
   lrwxrwxrwx ...     12 ... libcurl.so.3 -&gt; libcurl.so.4&#13;
<span class="ent">➌</span> lrwxrwxrwx ...     16 ... libcurl.so.4 -&gt; libcurl.so.4.4.0&#13;
<span class="ent">➍</span> -rw-r--r-- ... 452992 ... libcurl.so.4.4.0&#13;
   $</pre>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>The content in this console directory listing is specific to my system, which is based on a Debian distribution. If your distribution is not based on Debian, you will probably see a somewhat different listing—perhaps even significantly different. In this case, do not try to follow along on your system. Instead, just follow my example here as you read the following description. The concepts, not the filenames, are the important part of this discussion</em>.</p>&#13;
</div>&#13;
<p class="indent">Library names on Linux systems conform to a standard format: <em>lib</em>name<em>.so.</em>X<em>.</em>Y. The X<em>.</em>Y portion of the format represents the version information, where X is the major version number (always a single number) and Y is the minor version number (which may contain multiple dot-separated parts). The general rule is that changes in X represent non-backward-compatible changes to the library’s ABI, while changes in Y represent backward-compatible modifications, including isolated additions to the library’s interface and nonintrusive bug fixes.</p>&#13;
<p class="indent">Often, you’ll see what appears to be a third numbered component. The entry at <span class="ent">➍</span>, for example, represents the actual <em>curl</em> shared library, <em>libcurl.so.4.4.0</em>. In this example, the last two numbers (<em>4.0</em>) really just represent a two-part minor version number. Such additional numeric information in the minor version number is sometimes referred to as the library’s <em>patch level</em>.<sup><a id="ch08fn_2" href="footnote.xhtml#ch08fn2">2</a></sup></p>&#13;
<p class="indent">The <em>libcurl.so.4</em> entry at <span class="ent">➌</span> is referred to as the library’s <em>shared object name (soname)</em><sup><a id="ch08fn_3" href="footnote.xhtml#ch08fn3">3</a></sup> and is actually a soft link that points to the binary file. The soname is the format that consuming programs and libraries reference internally—that is, the linker embeds this name in the consuming program or library when it’s built. The soft link is created by the <code>ldconfig</code> utility, which (among other things) ensures that an appropriate soname <span epub:type="pagebreak" id="page_212"/>can locate the latest minor version of an installed library. The <code>ldconfig</code> utility is usually executed by post-install scripts and triggers of RPM and Debian packages. Therefore, while the soname is not created or installed by the <code>make install</code> target, it is most often created by distro installation packages and, therefore, by Linux packagers.</p>&#13;
<p class="indent">Notice how this versioning scheme allows multiple sonames for different major versions and multiple binaries with different major and minor versions to all coexist within a single directory.</p>&#13;
<p class="indent">Development packages for a library (ending in <em>-dev</em> or <em>-devel</em>) often install a so-called <em>linker name</em> entry (at <span class="ent">➋</span>) as well. The linker name is a soft link ending only in <em>.so</em> that usually points to the soname, though in some cases (such as this one), it may refer directly to the binary shared library. The linker name is the name by which a library is referred to on the linker command line. The development library allows you to run programs on your system that are linked against the latest version of a library but develop against an older version of that library, or vice versa.</p>&#13;
<p class="indent">The entry at <span class="ent">➊</span> refers to the static archive form of the library, which has a <em>.a</em> extension on Linux and Solaris systems. The remaining entries represent other forms of the <em>curl</em> library set generated for purposes specific to the <em>curl</em> package.</p>&#13;
<p class="indent">The <em>curl</em> library has become an important part of modern Linux systems over the years; it’s used by many other programs installed on the system, some of which have not been upgraded to the latest major version. The maintainers assert that major version 4 is backward compatible with major version 3. Therefore, sonames referring to version 3 are directed toward version 4 of the libraries on systems where version 4 is installed. This is not necessarily a common practice, but it happens to work in this case.</p>&#13;
<p class="indent">From here on out, the waters become muddied by a strange array of external and internal shared-library versioning techniques. Each of these less-than-intuitive systems is designed to overcome some of the fundamental problems that have been discovered in the Solaris system over the years.<sup><a id="ch08fn_4" href="footnote.xhtml#ch08fn4">4</a></sup> Let’s look at a few of them.</p>&#13;
<h4 class="h4" id="ch08sec1-2"><em>IBM AIX Library Versioning</em></h4>&#13;
<p class="noindent">Traditionally, IBM’s AIX used a form of internal versioning, storing all library code within a single archive file that follows the pattern <em>lib</em>name.<em>a</em>. This file may actually contain both static and shared forms of code, as well as 32-bit and 64-bit code. Internally, all shared-library code is stored in a single, logical, shared-object file within the archive file, while static library objects are stored as individual logical object files within the archive.</p>&#13;
<p class="indent">I say “traditionally” because more recent versions of AIX (including all 64-bit versions) now support the concept of loading shared-library code directly from physical <em>.so</em> files.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_213"/>Libtool generates shared-library code on AIX using both of these schemes. If the AIX <code>-brtl</code> native linker flag is specified on the command line, Libtool generates shared libraries with <em>.so</em> extensions. Otherwise, it generates combined libraries following the older, single-file scheme.<sup><a id="ch08fn_5" href="footnote.xhtml#ch08fn5">5</a></sup></p>&#13;
<p class="indent">When using the <em>.so</em> file scheme on AIX, Libtool generates libraries named in the Linux/Solaris pattern in order to maintain a degree of alliance with these more popular platforms. Regardless of the shared-library extension used, however, version information is still not stored in the filename; it is stored internally, within the library and consuming executables. As far as I can tell, Libtool ensures that the correct internal structures are created to reflect the proper versioning information within the shared-library header. It does this by passing appropriate flags to the native linker with embedded version information derived from the Libtool version string.</p>&#13;
<p class="indent">Executables on most Unix systems also support the concept of an embedded runtime library search path (called a <em><code>LIBPATH</code></em> on AIX), which usually specifies a set of colon-separated filesystem paths to be searched for shared-library dependencies. You can use Libtool’s <code>-R</code> command line option to specify a library search path for both programs and libraries. Libtool will translate this option to the appropriate GNU or native linker option on any given system.</p>&#13;
<p class="indent">I say executables <em>usually</em> support this option because on AIX, there are a few nuances. If all of the directories specified in the <code>LIBPATH</code> are real directories, everything works as expected—that is, the <code>LIBPATH</code> acts purely as a library search path. However, if the first segment of the <code>LIBPATH</code> is not a real filesystem entry, it acts as a so-called <em>loader domain</em>, which is basically a namespace for a particular shared library. Thus, multiple shared libraries of the same name can be stored within the same AIX archive (<em>.a</em>) file, each assigned (by linker options) to a different loader domain. The library that matches the loader domain specified in the <code>LIBPATH</code> is loaded from the archive. This can have nasty side effects if you assign a loader domain via the <code>LIBPATH</code> that later becomes (by chance) a real filesystem entry. On the other hand, you could also specify a search directory in the <code>LIBPATH</code> that happens to match a loader domain in a shared library. If that directory is removed later, you’ll unintentionally begin to use the loader domain. As you can imagine, strange behavior ensues. Most of these issues have been solved by AIX developers by ensuring that loader domain strings look nothing like filesystem paths.</p>&#13;
<p class="indent">On AIX systems, all code, whether static or shared, is compiled as position-independent code because AIX has only ever been ported to PowerPC and RS/6000 processors. The architectures of these processors only allow for PIC code, so AIX compilers can’t generate non-PIC code.</p>&#13;
<h4 class="h4" id="ch08sec1-3"><span epub:type="pagebreak" id="page_214"/><em>Microsoft DLL Versioning</em></h4>&#13;
<p class="noindent">Consider Microsoft Windows <em>dynamic link libraries (DLLs)</em>, which are shared libraries in every sense of the word and provide a proper application programming interface (API). But unfortunately, Microsoft has, in the past, provided no integrated DLL interface versioning scheme. As a result, Windows developers have often referred to DLL versioning issues (tongue-in-cheek, I’m sure) as <em>DLL hell</em>.</p>&#13;
<p class="indent">As a sort of Band-Aid fix to this problem, DLLs on Windows systems can be installed into the same directory as the program that uses them. The Windows operating system loader will always attempt to use the local copy before searching for a copy in the system path. This alleviates a part of the problem because it allows you to install a specific version of the library with the package that requires it. While this is a fair solution, it’s not really a good solution, because one of the major benefits of shared libraries is that they can be shared—both on disk and in memory. If every application has its own copy of a different version of the library, then this benefit of shared libraries is lost—both on disk and in memory.</p>&#13;
<p class="indent">Since the introduction of this partial solution years ago, Microsoft hasn’t paid much attention to DLL-sharing efficiency issues. The reasons for this include both a cavalier attitude regarding the cost of disk space and RAM and a technical issue regarding the implementation of Windows DLLs. Instead of generating position-independent code, Microsoft system architects chose to link DLLs with a specific base address and then list all of the absolute address references in a base table in the library image header. When a DLL can’t be loaded at the desired base address (because of a conflict with another DLL), the loader <em>rebases</em> the DLL by picking a new base address and changing all of the absolute addresses in the code segment that are referred to in the base table. When a DLL is rebased in this manner, it can only be shared with processes that happen to rebase the DLL to the same address. The odds of accidentally encountering such a scenario—especially among applications with many DLL components—are pretty slim.</p>&#13;
<p class="indent">More recently, Microsoft invented the concept of the <em>side-by-side cache</em> (sometimes referred to as <em>SxS</em>), which allows developers to associate a unique identification value (a GUID, in fact) with a particular version of a DLL installed in a system location. The location directory name is derived from the DLL name and the version identifier. Applications built against SxS-versioned libraries have metadata stored in their executable headers indicating the specifically versioned DLLs they require. If the right version is found (by newer OS loaders) in the SxS cache, then it is loaded. Based on policy in the EXE header’s metadata, the loader can revert to the older scheme of looking for a local copy and then a global copy of the DLL. This is a vast improvement over earlier solutions, and it provides a very flexible versioning system.</p>&#13;
<p class="indent">The side-by-side cache effectively moves the Windows DLL architecture a step closer to the Unix way of managing shared libraries. Think of the SxS <span epub:type="pagebreak" id="page_215"/>as a system installation location for libraries—much like the <em>/usr/lib</em> directory on Unix systems. Also similar to Unix, multiple versions of the same DLL may be co-installed in the side-by-side cache.</p>&#13;
<p class="indent">Regardless of the similarities, since DLLs use the rebasing technique as opposed to PIC code, the side-by-side cache is still a fairly benign efficiency improvement with respect to applications that manage dozens of shared libraries. SxS is really intended for system libraries that many applications are likely to consume. These are generally based at different addresses so that the odds of clashing (and thus rebasing) are decreased but not entirely eliminated.</p>&#13;
<p class="indent">The entire based approach to shared libraries has the major drawback that the program address space may become fairly fragmented as the system loader honors randomly chosen base addresses throughout a 32-bit address space. Fortunately, 64-bit addressing helps tremendously in this area, so you may find the side-by-side cache to be much more effective with respect to improving memory-use efficiency on 64-bit Windows systems, which are the norm these days anyway.</p>&#13;
<h4 class="h4" id="ch08sec1-4"><em>HP-UX/AT&amp;T SVR4 Library Versioning</em></h4>&#13;
<p class="noindent">Hewlett Packard’s version of Unix (since HP-UX version 10.0) adds a form of library-level versioning that’s very similar to the versioning used in AT&amp;T UNIX System V Release 4. For our purposes, you can consider these two types of systems to work nearly the same way.</p>&#13;
<p class="indent">The native linker looks for libraries specified by their base name with a <em>.sl</em> extension. However, consuming programs and libraries contain a reference to that library’s <em>internal name</em>. The internal name is assigned to the library by a linker command line option and should contain the library’s interface version number.</p>&#13;
<p class="indent">The actual library is named with only the major interface version as an extension, and a soft link is created with a <em>.sl</em> extension pointing to the library. Thus, a shared library on these systems will follow this pattern:</p>&#13;
<pre>lib<span class="codeitalic1">name</span>.<span class="codeitalic1">X</span>&#13;
lib<span class="codeitalic1">name</span>.sl -&gt; lib<span class="codeitalic1">name</span>.<span class="codeitalic1">X</span></pre>&#13;
<p class="indent">The only version information we have to work with is a major version number, which should be used to indicate non-backward-compatible changes from one version to the next. Since there’s no minor version number, as on Linux or Solaris, we can’t keep multiple revisions of a particular interface version around. The only option is to replace version zero of a library with an updated version zero if bug fixes or backward-compatible enhancements (that is to say, non-intrusive additions to the interface) are made.</p>&#13;
<p class="indent">However, we can still have multiple major versions of the library co-installed, and Libtool takes full advantage of what’s available on these systems.</p>&#13;
<h3 class="h3" id="ch08sec2"><span epub:type="pagebreak" id="page_216"/>The Libtool Library Versioning Scheme</h3>&#13;
<p class="noindent">The authors of Libtool tried hard to provide a versioning scheme that could be mapped to any of the schemes used by any Libtool platform. The Libtool versioning scheme is designed to be flexible enough to be forward compatible with reasonable future changes to existing Libtool platforms and even to new Libtool platforms.</p>&#13;
<p class="indent">Nevertheless, it’s not a panacea. When Libtool has been extended for a new type of shared-library platform, situations have occurred (and continue to occur) that require some serious and careful evaluation. No one can be an expert on all systems, so the Libtool developers rely heavily on outside contributions to create proper mappings from the Libtool versioning scheme to the schemes of new or would-be Libtool platforms.</p>&#13;
<h4 class="h4" id="ch08sec2-1"><em>Library Versioning Is Interface Versioning</em></h4>&#13;
<p class="noindent">You should consciously avoid thinking of library version numbers (either Libtool’s or those of a particular platform) as product <em>major</em>, <em>minor</em>, and <em>revision</em> (also called <em>patch</em> or <em>micro</em>) values. In fact, these values have very specific meanings to the operating system loader, and they must be updated properly for each new library version in order to keep from confusing the loader. A confused loader could load the wrong version of a library based on incorrect version information assigned to the library.</p>&#13;
<p class="indent">Several years ago, I was working with my company’s corporate versioning committee to come up with a software-versioning policy for the company as a whole. The committee wanted the engineers to ensure that the version numbers incorporated into our shared-library names were in alignment with the corporate software-versioning strategy. It took me the better part of a day to convince them that a shared-library version was not related to a product version in any way, nor should such a relationship be established or enforced by them or by anyone else.</p>&#13;
<p class="indent">Here’s why: the version number on a shared library is not really a library version but an interface version. The <em>interface</em> I’m referring to here is the application binary interface presented by a library to the user, another programmer desiring to call functions presented by the interface. An executable program has a single, well-defined, standard entry point (usually called <code>main</code> in the C language). But a shared library has multiple entry points that are generally not standardized in a manner that is widely understood. This makes it much more difficult to determine whether or not a particular version of a library is interface compatible with another version of the same library.</p>&#13;
<p class="indent">In Libtool’s versioning scheme, shared libraries are said to support a range of interface versions, each identified by a unique integer value. If any publicly visible aspect of an interface changes between public releases, it can no longer be considered the same interface; it therefore becomes a <span epub:type="pagebreak" id="page_217"/>new interface, identified by a new integer identifier. Each public release of a library in which the interface has changed simply acquires the next consecutive interface version number. Libraries that change in a backward-compatible manner between releases are said to support both the old and the new interface; thus, a particular release of a library may support interface versions 2 through 5, for example.</p>&#13;
<p class="indent">Libtool library version information is specified on the <code>libtool</code> command line with the <code>-version-info</code> option, as shown in <a href="ch08.xhtml#ch08ex1">Listing 8-1</a>.</p>&#13;
<pre>lib<span class="codeitalic1">name</span>_la_LDFLAGS = -version-info 0:0:0</pre>&#13;
<p class="caption" id="ch08ex1"><em>Listing 8-1: Setting shared-library version information in a</em> Makefile.am <em>file</em></p>&#13;
<p class="indent">The Libtool developers wisely chose the colon separator over the period in an effort to keep developers from trying to directly associate Libtool version string values with the version numbers appended to the end of shared-library files on various platforms. The three values in the version string are respectively called the interface <em>current</em>, <em>revision</em>, and <em>age</em> values.</p>&#13;
<p class="indent">The <em>current</em> value represents the current interface version number. This is the value that changes when a new interface version must be declared because the interface has changed in some publicly visible way since the last public release of the library. The first interface in a library is given a version number of zero by convention. Consider a shared library in which the developer has added a new function to the set of functions exposed by this library since the last public release. The interface can’t be considered the same in this new version because there’s one additional function. Thus, its <em>current</em> number must be increased from zero to one.</p>&#13;
<p class="indent">The <em>age</em> value represents the number of back versions supported by the shared library. In mathematical terms, the library is said to support the interface range, <em>current − age</em> through <em>current</em>. In the example I just gave, a new function was added to the library, so the interface presented in this version of the library is not the same as it was in the previous version. However, the previous version is still fully supported, because the previous interface is a proper subset of the current interface. Therefore, the <em>age</em> value should also be incremented from zero to one.</p>&#13;
<p class="indent">The <em>revision</em> value merely represents a serial revision of the current interface. That is, if no publicly visible changes are made to a library’s interface between releases—perhaps only an internal function was optimized—then the library name should change in some manner, if only to distinguish between the two releases. But both the <em>current</em> and <em>age</em> values would be the same, because the interface has not changed from the user’s perspective. Therefore, the <em>revision</em> value is incremented to reflect the fact that this is a new release of the same interface. In the previous example, the <em>revision</em> value would be left at zero, because one or both of the other values were incremented.</p>&#13;
<p class="indentb"><span epub:type="pagebreak" id="page_218"/>To simplify the release process for shared libraries, the Libtool versioning algorithm should be followed step-wise for each new version of a library that is about to be publicly released:<sup><a id="ch08fn_6" href="footnote.xhtml#ch08fn6">6</a></sup></p>&#13;
<ol class="ul0">&#13;
<li class="noindent">Start with version information 0:0:0 for each new Libtool library. (This is done automatically if you simply omit the <code>-version-info</code> option from the list of linker flags passed to the <code>libtool</code> script.) For existing libraries, start with the previous public release’s Libtool version information.</li>&#13;
<li class="noindent">If the library source code has changed at all since the last update, then increment <em>revision</em> (<em>c</em>:<em>r</em>:<em>a</em> becomes <em>c</em>:<em>r</em>+1:<em>a</em>).</li>&#13;
<li class="noindent">If any exported functions or data have been added, removed, or changed since the last update, increment <em>current</em> and set <em>revision</em> to 0.</li>&#13;
<li class="noindent">If any exported functions or data have been added since the last public release, increment <em>age</em>.</li>&#13;
<li class="noindent">If any exported functions or data have been removed since the last public release, set <em>age</em> to 0.</li></ol>&#13;
<p class="indentt">Keep in mind that this is an algorithm; as such, it’s designed to be followed step-by-step as opposed to jumping directly to the steps that appear to apply to your case. For example, if you removed an API function from your library since the last release, you would not simply jump to the last step and set <em>age</em> to zero. Rather, you would follow all of the steps until you reached the last step, and <em>then</em> set <em>age</em> to zero.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Remember to update the version information only immediately before a public release of your software. More frequent updates are unnecessary and only guarantee that the <em>current</em> interface number becomes larger faster</em>.</p>&#13;
</div>&#13;
<p class="indent">Let’s look at an example. Assume that this is the second release of a library and the first release used a <code>-version-info</code> string of <code>0:0:0</code>. One new function was added to the library interface during this development cycle, and one existing function was deleted. The effect on the version information string for this new release of the library would be as follows:</p>&#13;
<ol class="ul0">&#13;
<li class="noindent">Begin with the previous version information: <code>0:0:0</code>.</li>&#13;
<li class="noindent"><code>0:0:0</code> becomes <code>0:1:0</code> (the library’s source was changed).</li>&#13;
<li class="noindent"><code>0:1:0</code> becomes <code>1:0:0</code> (the library’s interface was modified).</li>&#13;
<li class="noindent"><code>1:0:0</code> becomes <code>1:0:1</code> (one new function was added).</li>&#13;
<li class="noindent"><code>1:0:1</code> becomes <code>1:0:0</code> (one old function was removed).</li>&#13;
</ol>&#13;
<p class="indent">It should be clear by now that there is no <em>direct</em> correlation between Libtool’s <em>current</em>, <em>revision</em>, and <em>age</em> values and Linux’s major, minor, and optional patch-level values. Instead, mapping rules are used to transform the values in one scheme to values in the other.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_219"/>Returning to the preceding example, wherein a second release of a library added one function and removed one function, we ended up with a new Libtool version string of <code>1:0:0</code>. The version string <code>1:0:0</code> indicates that the library is not backward compatible with the previous version (<em>age</em> is zero), so the Linux shared-library file would be named <em>lib</em>name.<em>so.1.0.0</em>. This looks suspiciously like the Libtool version string—but don’t be fooled. This fairly common coincidence is perhaps one of the most confusing aspects of the Libtool versioning abstraction.</p>&#13;
<p class="indentb">Let’s modify our example just a little to say that we’ve added a new library interface function but haven’t removed anything. Start again with the original version information of <code>0:0:0</code> and follow the algorithm:</p>&#13;
<ol class="ul0">&#13;
<li class="noindent">Begin with the previous version information: <code>0:0:0</code>.</li>&#13;
<li class="noindent"><code>0:0:0</code> becomes <code>0:1:0</code> (the library’s source was changed).</li>&#13;
<li class="noindent"><code>0:1:0</code> becomes <code>1:0:0</code> (the library’s interface was modified).</li>&#13;
<li class="noindent"><code>1:0:0</code> becomes <code>1:0:1</code> (one new function was added).</li>&#13;
<li class="noindent">Not applicable (nothing was removed).</li>&#13;
</ol>&#13;
<p class="indentt">This time, we end up with a Libtool version string of <code>1:0:1</code>, but the resulting Linux or Solaris shared-library filename is <em>lib</em>name.<em>so.0.1.0</em>. Consider for a moment what it means, in the face of major, minor, and patch-level values, to have a nonzero <em>age</em> value in the Libtool version string. An <em>age</em> value of one (as in this case) means that we are effectively still supporting a Linux major value of zero, because this new version of the library is 100 percent backward compatible with the previous version. The minor value in the shared-library filename has been incremented from zero to one to indicate that this is, in fact, an updated version of the soname, <em>lib</em>name.<em>so.0</em>. The patch-level value remains at zero because this value indicates a bug fix to a particular minor revision of an soname.</p>&#13;
<p class="indent">Once you fully understand Libtool versioning, you’ll find that even this algorithm does not cover all possible interface modification scenarios. Consider, for example, version information of <code>0:0:0</code> for a shared library that you maintain. Now assume you add a new function to the interface for the next public release. This second release properly defines version information of <code>1:0:1</code> because the library supports both interface versions 0 and 1. However, just before the third release of the library, you realize you didn’t really need that new function after all, so you remove it. This is the only publicly visible change made to the library interface in this release. The algorithm would have set the version information string to <code>2:0:0</code>. But in fact, you’ve merely removed the second interface and are now presenting the original interface once again. Technically, this library would be properly configured with a version information string of <code>0:1:0</code> because it presents a second release of version 0 of the shared-library interface. The moral of this story is that you need to fully understand the way Libtool versioning works and then decide, based on that understanding, what the proper next-version values should be.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_220"/>I’d also like to point out that the <em>GNU Libtool Manual</em> makes little effort to describe the myriad ways an interface can be different from one version of a library to another. An interface version indicates functional semantics as well as API syntax. If you change the way a function works semantically but leave the function signature untouched, you’ve still changed the function. If you change the network wire format of data sent by a shared library, then it’s not really the same shared library from the perspective of the consuming code. All the operating system loader really cares about when attempting to determine which library to load is, <em>will this library work just as well as that one?</em> In these cases, the answer would have to be no, because even though the API interface is identical, the publicly visible way the two libraries do things is not the same.</p>&#13;
<h4 class="h4" id="ch08sec2-2"><em>When Library Versioning Just Isn’t Enough</em></h4>&#13;
<p class="noindent">These types of changes to a library’s interface are so complex that project maintainers will often simply rename the library, thereby skirting library-versioning issues entirely. One excellent way to rename your library is to use Libtool’s <code>-release</code> flag. This flag adds a separate class of library versioning information into the base name of the library, effectively making it an entirely new library from the perspective of the operating system loader. The <code>-release</code> flag is used in the manner shown in <a href="ch08.xhtml#ch08ex2">Listing 8-2</a>.</p>&#13;
<pre>lib<span class="codeitalic1">name</span>_la_LDFLAGS = -release 2.9.0 -version-info 0:0:0</pre>&#13;
<p class="caption" id="ch08ex2"><em>Listing 8-2: Setting shared-library release information in a</em> Makefile.am <em>file</em></p>&#13;
<p class="indent">In this example, I used <code>-release</code> and <code>-version-info</code> in the same set of Libtool flags, just to show you that they can be used together. You’ll note here that the release string is specified as a series of dot-separated values. In this case, the final name of your Linux or Solaris shared library will be <em>lib</em>name-<em>2.9.0.so.0.0.0</em>.</p>&#13;
<p class="indent">Another reason developers choose to use release strings is to provide some sort of correlation between library versions across platforms. As demonstrated earlier, a particular Libtool version information string will probably result in different library names across platforms because Libtool maps version information into library names differently from platform to platform. Release information remains stable across platforms, but you should carefully consider how you want to use release strings and version information in your shared libraries, because the way you choose to use them will affect binary compatibility between releases of your libraries. The OS loader will not consider two versions of a library compatible if they have different release strings, regardless of the values of those strings.</p>&#13;
<h3 class="h3" id="ch08sec3"><span epub:type="pagebreak" id="page_221"/>Using libltdl</h3>&#13;
<p class="noindent">Now let’s move on to a discussion of Libtool’s <em>ltdl</em> library. Once again, we need to add some functionality to the Jupiter project in order to illustrate these concepts. The goal here is to create a plug-in interface that the <code>jupiter</code> program can use to modify output based on end-user policy choices.</p>&#13;
<h4 class="h4" id="ch08sec3-1"><em>Necessary Infrastructure</em></h4>&#13;
<p class="noindent">Currently, <code>jupiter</code> prints <em>Hello from jupiter!</em> (Actually, the name printed is more likely, at this point, to be a long, ugly path containing some Libtool directory garbage and some derivation of the name <em>jupiter</em>, but just pretend it prints <em>jupiter</em> for now.) We’re going to add an additional parameter named <code>salutation</code> to the <em>common</em> static library method, <code>print_routine</code>. This parameter will also be of type pointer-to-<code>char</code> and will contain the leading word or phrase—the salutation—in <code>jupiter</code>’s greeting.</p>&#13;
<p class="indent"><a href="ch08.xhtml#ch08ex3">Listings 8-3</a> and <a href="ch08.xhtml#ch08ex4">8-4</a> indicate the changes we need to make to files in the <em>common</em> subdirectory.</p>&#13;
<p class="margin">Git tag 8.0</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">static void * print_it(void * data)</span>&#13;
<span class="ash">{</span>&#13;
    const char ** strings = data;&#13;
    <span class="ash">printf("</span>%s <span class="ash">from %s!\n",</span> strings[0], strings[1]<span class="ash">);</span>&#13;
    <span class="ash">return 0;</span>&#13;
<span class="ash">}</span>&#13;
&#13;
<span class="ash">int print_routine(</span>const char * salutation, <span class="ash">const char * name)</span>&#13;
<span class="ash">{</span>&#13;
    const char * strings[] = {salutation, name};&#13;
<span class="ash">#if ASYNC_EXEC</span>&#13;
    <span class="ash">pthread_t tid;</span>&#13;
    <span class="ash">pthread_create(&amp;tid, 0, print_it,</span> strings<span class="ash">);</span>&#13;
    <span class="ash">pthread_join(tid, 0);</span>&#13;
<span class="ash">#else</span>&#13;
    <span class="ash">print_it(</span>strings<span class="ash">);</span>&#13;
<span class="ash">#endif</span>&#13;
    <span class="ash">return 0;</span>&#13;
<span class="ash">}</span></pre>&#13;
<p class="caption" id="ch08ex3"><em>Listing 8-3:</em> common/print.c: <em>Adding a salutation to the <code>print_routine</code> function</em></p>&#13;
<pre><span class="ash">int print_routine(</span>const char * salutation, <span class="ash">const char * name);</span></pre>&#13;
<p class="caption" id="ch08ex4"><em>Listing 8-4:</em> common/jupcommon.h: <em>Adding a salutation to the <code>print_routine</code> prototype</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_222"/><a href="ch08.xhtml#ch08ex5">Listings 8-5</a> and <a href="ch08.xhtml#ch08ex6">8-6</a> show the changes we need to make to files in the <em>libjup</em> and <em>include</em> subdirectories.</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">int jupiter_print(</span>const char * salutation, <span class="ash">const char * name)</span>&#13;
<span class="ash">{</span>&#13;
    <span class="ash">print_routine(</span>salutation, <span class="ash">name);</span>&#13;
<span class="ash">}</span></pre>&#13;
<p class="caption" id="ch08ex5"><em>Listing 8-5:</em> libjup/jup_print.c: <em>Adding a salutation to the <code>jupiter_print</code> function</em></p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">int jupiter_print(</span>const char * salutation, <span class="ash">const char * name);</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch08ex6"><em>Listing 8-6:</em> include/libjupiter.h: <em>Adding a salutation to the <code>jupiter_print</code> prototype</em></p>&#13;
<p class="indent">And finally, <a href="ch08.xhtml#ch08ex7">Listing 8-7</a> shows what we need to do to <em>main.c</em> in the <em>src</em> directory.</p>&#13;
<pre><span class="codeitalic1">--snip--</span>&#13;
#define DEFAULT_SALUTATION "Hello"&#13;
&#13;
<span class="ash">int main(int argc, char * argv[])</span>&#13;
<span class="ash">{</span>&#13;
    const char * salutation = DEFAULT_SALUTATION;&#13;
    <span class="ash">return jupiter_print(</span>salutation, <span class="ash">argv[0]);</span>&#13;
<span class="ash">}</span></pre>&#13;
<p class="caption" id="ch08ex7"><em>Listing 8-7:</em> src/main.c: <em>Passing a salutation to <code>jupiter_print</code></em></p>&#13;
<p class="indent">To be clear, all we’ve really done here is parameterize the salutation throughout the print routines. That way, we can indicate from <code>main</code> which salutation we’d like to use. I’ve set the default salutation to <em>Hello</em> so that nothing will have changed from the user’s perspective. Thus, the overall effect of these changes is benign. Note also that these are all source code changes—we’ve made no changes to the build system. I wanted to compartmentalize these changes so as to not confuse this necessary refactoring with what we’re doing to the build system to add the new module-loading functionality.</p>&#13;
<p class="indent">After making these changes, should you update the version number of this shared library? That depends on whether you’ve already shipped this library (that is, posted a tarball) before you made the changes. The point of versioning is to maintain some semblance of control over your public interface—but if you’re the only one who has ever seen it, there’s no point in changing the version number.</p>&#13;
<h4 class="h4" id="ch08sec3-2"><em>Adding a Plug-In Interface</em></h4>&#13;
<p class="noindent">I’d like to make it possible to change the salutation displayed by simply changing which plug-in module is loaded at runtime. All of the changes <span epub:type="pagebreak" id="page_223"/>we’ll need to make to the code and build system to add this functionality will be limited to the <em>configure.ac</em> file and to files within the <em>src</em> directory and its subdirectories.</p>&#13;
<p class="indent">First, we need to define the actual plug-in interface. We’ll do this by creating a new private header file in the <em>src</em> directory called <em>module.h</em>. This file is shown in <a href="ch08.xhtml#ch08ex8">Listing 8-8</a>.</p>&#13;
<p class="margin">Git tag 8.1</p>&#13;
<pre>   #ifndef MODULE_H_INCLUDED&#13;
   #define MODULE_H_INCLUDED&#13;
&#13;
<span class="ent">➊</span> #define GET_SALUTATION_SYM "get_salutation"&#13;
&#13;
<span class="ent">➋</span> typedef const char * get_salutation_t(void);&#13;
<span class="ent">➌</span> const char * get_salutation(void);&#13;
&#13;
   #endif /* MODULE_H_INCLUDED */</pre>&#13;
<p class="caption" id="ch08ex8"><em>Listing 8-8:</em> src/module.h: <em>The initial contents of this file</em></p>&#13;
<p class="indent">This header file has a number of interesting aspects. First, let’s look at the preprocessor definition, <code>GET_SALUTATION_SYM</code>, at <span class="ent">➊</span>. This string represents the name of the function you need to import from the plug-in module. I like to define these in the header file so all the information that needs to be reconciled exists in one place. In this case, the symbol name, the function type definition, and the function prototype must all be in alignment, and you can use this single definition for all three.</p>&#13;
<p class="indent">Another interesting item is the type definition<sup><a id="ch08fn_7" href="footnote.xhtml#ch08fn7">7</a></sup> at <span class="ent">➋</span>. If we don’t provide one, the user is going to have to invent one, or else use a complex typecast on the return value of the <code>dlsym</code> function. Therefore, we’ll provide it here for consistency and convenience.</p>&#13;
<p class="indent">Finally, look at the function prototype at <span class="ent">➌</span>. This isn’t so much for the caller as it is for the module itself. Modules providing this function should include this header file so the compiler can catch potential misspellings of the function name.</p>&#13;
<h4 class="h4" id="ch08sec3-3"><em>Doing It the Old-Fashioned Way</em></h4>&#13;
<p class="noindent">For this first attempt, let’s use the <em>dl</em> interface provided by the Solaris/Linux <em>libdl.so</em> library. In the next section, we’ll convert this code over to the Libtool <em>ltdl</em> interface for greater portability.</p>&#13;
<p class="indent">To do this right, we need to add checks to <em>configure.ac</em> to look for both the <em>libdl</em> library and the <em>dlfcn.h</em> header file. These changes to <em>configure.ac</em> are highlighted in <a href="ch08.xhtml#ch08ex9">Listing 8-9</a>.</p>&#13;
<pre>   <span epub:type="pagebreak" id="page_224"/><span class="codeitalic1a">--snip--</span>&#13;
   <span class="ash"># Checks for header files.</span>&#13;
<span class="ent">➊</span> <span class="ash">AC_CHECK_HEADERS([stdlib.h</span> dlfcn.h<span class="ash">])</span>&#13;
   <span class="codeitalic1a">--snip</span><span class="codeitalic1a">--</span>&#13;
   <span class="ash"># Checks for libraries.</span>&#13;
&#13;
   <span class="ash"># Checks for typedefs, structures, and compiler characteristics.</span>&#13;
&#13;
   <span class="ash"># Checks for library functions.</span>&#13;
<span class="ent">➋</span> AC_SEARCH_LIBS([dlopen], [dl])&#13;
   <span class="codeitalic1a">--snip--</span>&#13;
   <span class="ash">cat &lt;&lt; EOF</span>&#13;
   <span class="ash">-------------------------------------------------</span>&#13;
&#13;
   <span class="ash">${PACKAGE_NAME} Version ${PACKAGE_VERSION}</span>&#13;
&#13;
   <span class="ash">Prefix: '${prefix}'.</span>&#13;
   <span class="ash">Compiler: '${CC} ${CFLAGS} ${CPPFLAGS}'</span>&#13;
<span class="ent">➌</span> Libraries: '${LIBS}'&#13;
   <span class="codeitalic1">--snip--</span></pre>&#13;
<p class="caption" id="ch08ex9"><em>listing 8-9:</em> configure.ac: <em>Adding checks for the</em> dl <em>library and public header file</em></p>&#13;
<p class="indent">At <span class="ent">➊</span>, I added the <em>dlfcn.h</em> header file to the list of files passed to the <code>AC_CHECK_HEADERS</code> macro, and then at <span class="ent">➋</span>, I added a check for the <code>dlopen</code> function in the <em>dl</em> library. Note here that the <code>AC_SEARCH_LIBS</code> macro searches a list of libraries for a function, so this call goes in the “Checks for library functions” section rather than the “Checks for libraries” section. To help us see which libraries we’re actually linking against, I’ve also added a line to the <code>cat</code> command at the end of the file. The <code>Libraries:</code> line at <span class="ent">➌</span> displays the contents of the <code>LIBS</code> variable, which is modified by the <code>AC_SEARCH_LIBS</code> macro.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>The <em><code>LT_INIT</code></em> macro also checks for the existence of the</em> dlfcn.h <em>header file, but I do it here explicitly so it’s obvious to observers that I wish to use this header file. This is a good rule of thumb to follow, as long as it doesn’t negatively affect performance too much. Since Autoconf caches the results of checks, it’s not likely to do so. You can tell this is happening when you see <em><code>(cached) ...</code></em> after a check in <em><code>configure</code></em>’s output.</em></p>&#13;
</div>&#13;
<p class="indent">Adding a module requires several changes, so we’ll make them all here, beginning with the following command:</p>&#13;
<pre>$ <span class="codestrong1">mkdir -p src/modules/hithere</span>&#13;
$</pre>&#13;
<p class="indent">I’ve created two new subdirectories. The first is <em>modules</em>, beneath <em>src</em>, and the second is <em>hithere</em>, beneath <em>modules</em>. Each new module added to this project will have its own directory beneath <em>modules</em>. The <em>hithere</em> module will provide the salutation <em>Hi there</em>.</p>&#13;
<p class="indent"><a href="ch08.xhtml#ch08ex10">Listing 8-10</a> illustrates how to add a <code>SUBDIRS</code> variable to the <em>src/Makefile.am</em> file to ensure that the build system processes the <em>modules/hithere</em> directory.</p>&#13;
<pre><span epub:type="pagebreak" id="page_225"/><span class="ent">➊</span> SUBDIRS = modules/hithere&#13;
&#13;
   <span class="ash">bin_PROGRAMS = jupiter</span>&#13;
<span class="ent">➋</span> <span class="ash">jupiter_SOURCES = main.c</span> module.h&#13;
   <span class="codeitalic1a">--snip--</span>&#13;
   <span class="ash">greptest.sh:</span>&#13;
<span class="ent">➌</span> <span class="ash">echo './jupiter | grep ".* from .*jupiter!"' &gt; greptest.sh</span>&#13;
   <span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch08ex10"><em>Listing 8-10:</em> src/Makefile.am: <em>Adding a <code>SUBDIRS</code> variable to this</em> Makefile.am <em>file</em></p>&#13;
<p class="indent">The way I’ve used <code>SUBDIRS</code> at <span class="ent">➊</span> presents a new concept. Until now, Jupiter’s <em>Makefile.am</em> files have only referenced direct descendants of the current directory, but this is not strictly necessary, as you can see. In fact, for Jupiter, the <em>modules</em> directory will only contain additional subdirectories, so it makes little sense to provide a <em>modules/Makefile.am</em> file just so you can reference its subdirectories.</p>&#13;
<p class="indent">While you’re editing the file, you should add the new <em>module.h</em> header file to the <code>SOURCES</code> variable at <span class="ent">➋</span>. If you don’t do this, <code>jupiter</code> will still compile and build correctly for you as the maintainer, but the <code>distcheck</code> target will fail because none of the <em>Makefile.am</em> files will have mentioned <em>module.h</em>.</p>&#13;
<p class="indent">We also need to change the way the <code>greptest.sh</code> shell script is built so it can test for any type of salutation. A simple modification of the regular expression at <span class="ent">➌</span> will suffice.</p>&#13;
<p class="indent">I created a <em>Makefile.am</em> file in the new <em>hithere</em> subdirectory that contains instructions on how to build the <em>hithere.c</em> source file, and then I added the <em>hithere.c</em> source file to this directory. These files are shown in <a href="ch08.xhtml#ch08ex11">Listings 8-11</a> and <a href="ch08.xhtml#ch08ex12">8-12</a>, respectively.</p>&#13;
<pre>   pkglib_LTLIBRARIES = hithere.la&#13;
   hithere_la_SOURCES = hithere.c&#13;
<span class="ent">➊</span> hithere_la_LDFLAGS = -module -avoid-version</pre>&#13;
<p class="caption" id="ch08ex11"><em>Listing 8-11:</em> src/modules/hithere/Makefile.am: <em>The initial version of this file</em></p>&#13;
<pre>#include "../../module.h"&#13;
&#13;
const char * get_salutation(void)&#13;
{&#13;
    return "Hi there";&#13;
}</pre>&#13;
<p class="caption" id="ch08ex12"><em>Listing 8-12:</em> src/modules/hithere/hithere.c: <em>The initial version of this file</em></p>&#13;
<p class="indent">The <em>hithere.c</em> source file includes the semi-private <em>module.h</em> header file using a double-quoted relative path. Since Automake automatically adds <code>-I$(srcdir)</code> to the list of <em>include</em> paths used, the C preprocessor will properly sort out the relative path. The file then defines the <code>get_salutation</code> function, whose prototype is in the <em>module.h</em> header file. This implementation simply returns a pointer to a static string, and as long as the library is loaded, the <span epub:type="pagebreak" id="page_226"/>caller can access the string. However, callers must be aware of the scope of data references returned by plug-in modules; otherwise, the program may unload a module before a caller is done using it.</p>&#13;
<p class="indent">The last line of <em>hithere/Makefile.am</em> (at <span class="ent">➊</span> in <a href="ch08.xhtml#ch08ex11">Listing 8-11</a>) requires some explanation. Here, we’re using a <code>-module</code> option on the <code>hithere_la_LDFLAGS</code> variable. This is a Libtool option that tells Libtool you want to call your library <em>hithere</em>, not <em>libhithere</em>. The <em>GNU Libtool Manual</em> makes the statement that modules do not need to be prefixed with <em>lib</em>. And since your code will be loading these modules manually, it should not have to be concerned with determining and properly using a platform-specific library name prefix.</p>&#13;
<p class="indent">If you don’t care to use module versioning on your dynamically loadable (<code>dlopen</code>-ed) modules, try using the Libtool <code>-avoid-version</code> option. This option causes Libtool to generate a shared library whose name is <em>lib</em>name.<em>so</em>, rather than <em>lib</em>name.<em>so.0.0.0</em>. It also suppresses generation of the <em>lib</em>name.<em>so.0</em> and <em>lib</em>name.<em>so</em> soft links that refer to the binary image. Because I’m using both options, my module will simply be named <em>hithere.so</em>.</p>&#13;
<p class="indent">In order to get this module to build, we need to add the new <em>hithere</em> module’s makefile to the <code>AC_CONFIG_FILES</code> macro in <em>configure.ac</em>, as shown in <a href="ch08.xhtml#ch08ex13">Listing 8-13</a>.</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">AC_CONFIG_FILES([Makefile</span>&#13;
                 <span class="ash">common/Makefile</span>&#13;
                 <span class="ash">include/Makefile</span>&#13;
                 <span class="ash">libjup/Makefile</span>&#13;
                 <span class="ash">src/Makefile</span>&#13;
                src/modules/hithere/Makefile<span class="ash">])</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch08ex13"><em>Listing 8-13:</em> configure.ac: <em>Adding the</em> hithere <em>directory makefile to <code>AC_CONFIG_FILES</code></em></p>&#13;
<p class="indent">Finally, in order to use the module, we need to modify <em>src/main.c</em> so that it loads the module, imports the symbol, and calls it. These changes to <em>src/main.c</em> are highlighted in bold in <a href="ch08.xhtml#ch08ex14">Listing 8-14</a>.</p>&#13;
<pre>   <span class="ash">#include "config.h"</span>&#13;
&#13;
   <span class="ash">#include "libjupiter.h"</span>&#13;
<span class="ent">➊</span> #include "module.h"&#13;
&#13;
<span class="ent">➋</span> <span class="ash">#if HAVE_DLFCN_H</span>&#13;
   <span class="ash"># include &lt;dlfcn.h&gt;</span>&#13;
   <span class="ash">#endif</span>&#13;
&#13;
   <span class="ash">#define DEFAULT_SALUTATION "Hello"</span>&#13;
&#13;
   <span class="ash">int main(int argc, char * argv[])</span>&#13;
   <span class="ash">{</span>&#13;
       <span class="ash">int rv;</span>&#13;
       <span class="ash">const char * salutation = DEFAULT_SALUTATION;</span>&#13;
<span epub:type="pagebreak" id="page_227"/><span class="ent">➌</span> #if HAVE_DLFCN_H&#13;
       void * module;&#13;
       get_salutation_t * get_salutation_fp = 0;&#13;
    <span class="ent">➍</span> module = dlopen("./module.so", RTLD_NOW);&#13;
       if (module != 0)&#13;
       {&#13;
           get_salutation_fp = (get_salutation_t *)dlsym(&#13;
                     module, GET_SALUTATION_SYM);&#13;
           if (get_salutation_fp != 0)&#13;
               salutation = get_salutation_fp();&#13;
       }&#13;
   #endif&#13;
&#13;
       <span class="ash">rv = jupiter_print(salutation, argv[0]);</span>&#13;
&#13;
<span class="ent">➎</span> #if HAVE_DLFCN_H&#13;
       if (module != 0)&#13;
           dlclose(module);&#13;
   #endif&#13;
&#13;
       <span class="ash">return rv;</span>&#13;
   <span class="ash">}</span></pre>&#13;
<p class="caption" id="ch08ex14"><em>Listing 8-14:</em> src/main.c: <em>Using the new plug-in module from the <code>main</code> function</em></p>&#13;
<p class="indent">I’m including the new private <em>module.h</em> header file at <span class="ent">➊</span>, and I added a preprocessor directive to conditionally include <em>dlfcn.h</em> at <span class="ent">➋</span>. Finally, I added two sections of code, one before and one after the original call to <code>jupiter_print</code> (at <span class="ent">➌</span> and <span class="ent">➎</span>, respectively). Both are conditionally compiled based on the existence of a dynamic loader, allowing the code to build and run correctly on systems that do not provide the <em>libdl</em> library.</p>&#13;
<p class="indent">The general philosophy I use when deciding whether or not code should be conditionally compiled is this: If <code>configure</code> fails because a library or header file is missing, then I don’t need to conditionally compile the code that uses the item <code>configure</code> checks for. If I check for a library or header file in <code>configure</code> but allow it to continue if it’s missing, then I’d better use conditional compilation.</p>&#13;
<p class="indent">There are just a few more minor points to bring up regarding the use of <em>dl</em> interface functions. First, at <span class="ent">➍</span>, <code>dlopen</code> accepts two parameters: a filename or <em>path</em> (absolute or relative) and a <em>flags</em> word, which is the bitwise composite of your choice of several flag values defined in <em>dlfcn.h</em>. Check the man page for <code>dlopen</code> to learn more about these flag bits. If you use a path, then <code>dlopen</code> honors that path verbatim, but if you use a filename, the library search path is searched in an attempt to locate your module. By prefixing the name with <em>./</em>, we’re telling <code>dlopen</code> not to search the library path.</p>&#13;
<p class="indent">We want to be able to configure which module <code>jupiter</code> uses, so we’re loading a generic name, <em>module.so</em>. In fact, the built module is located several directories below the <em>src</em> directory in the build tree, so we need to create a soft link in the current directory called <em>module.so</em> that points to the module we want to load. This is a rather shabby form of configuration <span epub:type="pagebreak" id="page_228"/>for Jupiter, but it works. In a real application, you would define the desired module to load using policy defined in some sort of configuration file, but in this example, I’m simply ignoring these details for the sake of simplicity.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>I’m ignoring some error handling in <a href="ch08.xhtml#ch08ex14">Listing 8-14</a>. In production code, you would probably want to log or display something if the module doesn’t load or if the symbol is not exported by the module.</em></p>&#13;
</div>&#13;
<p class="indent">The following command sequence shows our loadable module in action:</p>&#13;
<pre>$ <span class="codestrong1">autoreconf -i</span>&#13;
<span class="codeitalic1">--snip--</span>&#13;
$ <span class="codestrong1">./configure &amp;&amp; make</span>&#13;
<span class="codeitalic1">--snip--</span>&#13;
$ <span class="codestrong1">cd src</span>&#13;
$ <span class="codestrong1">./jupiter</span>&#13;
Hello from ...jupiter!&#13;
$&#13;
$ <span class="codestrong1">ln -s modules/hithere/.libs/hithere.so module.so</span>&#13;
$ <span class="codestrong1">./jupiter</span>&#13;
Hi there from ...jupiter!&#13;
$</pre>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>The symlink <em><code>module.so</code></em> refers to a file in a hidden</em> .libs <em>directory. Executables and libraries are generated into a</em> .libs <em>directory within the associated source directory by Autotools build systems</em>.</p>&#13;
</div>&#13;
<h3 class="h3" id="ch08sec4">Converting to Libtool’s ltdl Library</h3>&#13;
<p class="noindent">Libtool provides a wrapper library called <em>ltdl</em> that abstracts and hides some of the portability issues surrounding the use of shared libraries across many different platforms. Most applications ignore the <em>ltdl</em> library because of the added complexity involved in using it, but there are really only a few issues to deal with. I’ll enumerate them here and then cover them in detail later.</p>&#13;
<ul>&#13;
<li class="noindent">The <em>ltdl</em> functions follow a naming convention based on the <em>dl</em> library. The rule of thumb is that <em>dl</em> functions in the <em>ltdl</em> library have the prefix <code>lt_</code>. For example, <code>dlopen</code> is named <code>lt_dlopen</code>.</li>&#13;
<li class="noindent">Unlike the <em>dl</em> library, the <em>ltdl</em> library must be initialized and terminated at appropriate locations within a consuming application.</li>&#13;
<li class="noindent">Applications should be built using the <code>-dlopen</code> <em><code>modulename</code></em> option on the linker command line (in the <code>*_LDFLAGS</code> variable). This tells Libtool to link the code for the module into the application when building on platforms without shared libraries or when linking statically.</li>&#13;
<li class="noindent">The <code>LTDL_SET_PRELOADED_SYMBOLS()</code> macro should be used at an appropriate location within your program source code to ensure that module code can be accessed on non-shared-library platforms or when building static-only configurations.</li>&#13;
<li class="noindent"><span epub:type="pagebreak" id="page_229"/>Shared-library modules designed to be <code>dlopen</code>-ed using <em>ltdl</em> should use the <code>-module</code> option (and, optionally, the <code>-avoid-version</code> option) on the linker command line (in the <code>*_LDFLAGS</code> variable).</li>&#13;
<li class="noindent">The <em>ltdl</em> library provides extensive functionality beyond the <em>dl</em> library; this can be intimidating, but know that all of this other functionality is optional.</li>&#13;
</ul>&#13;
<p class="indent">Let’s look at what we need to do to the Jupiter project build system in order to use the <em>ltdl</em> library. First, we need to modify <em>configure.ac</em> to look for the <em>ltdl.h</em> header and search for the <code>lt_dlopen</code> function. This means modifying references to <em>dlfcn.h</em> and the <em>dl</em> library in the <code>AC_CHECK_HEADERS</code> and <code>AC_SEARCH_LIBS</code> macros, as highlighted in <a href="ch08.xhtml#ch08ex15">Listing 8-15</a>.</p>&#13;
<p class="margin">Git tag 8.2</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash"># Checks for header files.</span>&#13;
<span class="ash">AC_CHECK_HEADERS([stdlib.h</span> ltdl.h<span class="ash">])</span>&#13;
<span class="codeitalic1a">--snip--</span>&#13;
<span class="ash"># Checks for libraries.</span>&#13;
&#13;
<span class="ash"># Checks for typedefs, structures, and compiler characteristics.</span>&#13;
&#13;
<span class="ash"># Checks for library functions.</span>&#13;
<span class="ash">AC_SEARCH_LIBS([</span>lt_dlopen<span class="ash">], [</span>ltdl<span class="ash">])</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch08ex15"><em>Listing 8-15:</em> configure.ac: <em>Switching from <code>dl</code> to <code>ltdl</code> in</em> configure.ac</p>&#13;
<p class="indent">Even though we’re using Libtool, we need to check for <em>ltdl.h</em> and <em>libltdl</em>, because <em>ltdl</em> is a separate library that must be installed on the end user’s system. It should be treated the same as any other required third-party library. By searching for these installed resources on the user’s system and failing configuration if they’re not found, or by properly using preprocessor definitions in your source code, you can provide the same sort of configuration experience with <em>ltdl</em> that I’ve presented throughout this book when using other third-party resources.</p>&#13;
<p class="indent">I’d like you to recognize that this is the first time we’ve seen the requirement for the user to install an Autotools package on his system—and this is the very reason most people avoid using <em>ltdl</em>. The <em>GNU Libtool Manual</em> provides a detailed description of how to package the <em>ltdl</em> library with your project so it is built and installed on the user’s system when your package is built and installed.<sup><a id="ch08fn_8" href="footnote.xhtml#ch08fn8">8</a></sup></p>&#13;
<p class="indent">Interestingly, shipping the source code for the <em>ltdl</em> library with your package is the only way to get your program to <em>statically</em> link with the <em>ltdl</em> library. Linking statically with <em>ltdl</em> has the side effect of not requiring the user to install the <em>ltdl</em> library on their system, since the library becomes part of the <span epub:type="pagebreak" id="page_230"/>project’s executable images. There are a few caveats, however. If your project also uses a third-party library that dynamically links to <em>ltdl</em>, you’ll have a symbol conflict between the shared and static versions of the <em>ltdl</em> libraries.<sup><a id="ch08fn_9" href="footnote.xhtml#ch08fn9">9</a></sup></p>&#13;
<p class="indent">The next major change we need to make is in the source code—it is limited, in this case, to <em>src/main.c</em> and highlighted in <a href="ch08.xhtml#ch08ex16">Listing 8-16</a>.</p>&#13;
<pre><span class="ash">#include "config.h"</span>&#13;
&#13;
<span class="ash">#include "libjupiter.h"</span>&#13;
<span class="ash">#include "module.h"</span>&#13;
&#13;
<span class="ash">#if HAVE_</span>LTDL<span class="ash">_H</span>&#13;
<span class="ash"># include &lt;</span>ltdl<span class="ash">.h&gt;</span>&#13;
<span class="ash">#endif</span>&#13;
&#13;
<span class="ash">#define DEFAULT_SALUTATION "Hello"</span>&#13;
&#13;
<span class="ash">int main(int argc, char * argv[])</span>&#13;
<span class="ash">{</span>&#13;
    <span class="ash">int rv;</span>&#13;
    <span class="ash">const char * salutation = DEFAULT_SALUTATION;</span>&#13;
&#13;
<span class="ash">#if HAVE_</span>LTDL<span class="ash">_H</span>&#13;
    int ltdl;&#13;
  <span class="ent">➊</span> lt_dlhandle <span class="ash">module;</span>&#13;
     <span class="ash">get_salutation_t * get_salutation_fp = 0;</span>&#13;
&#13;
  <span class="ent">➋</span> LTDL_SET_PRELOADED_SYMBOLS();&#13;
&#13;
  <span class="ent">➌</span> ltdl = lt_dlinit();&#13;
     if (ltdl == 0)&#13;
     {&#13;
      <span class="ent">➍</span> <span class="ash">module =</span> lt_<span class="ash">dlopen("</span>modules/hithere/hithere.la<span class="ash">");</span>&#13;
         <span class="ash">if (module != 0)</span>&#13;
         <span class="ash">{</span>&#13;
             <span class="ash">get_salutation_fp = (get_salutation_t *)</span>lt_<span class="ash">dlsym(</span>&#13;
                       <span class="ash">module, GET_SALUTATION_SYM);</span>&#13;
             <span class="ash">if (get_salutation_fp != 0)</span>&#13;
                 <span class="ash">salutation = get_salutation_fp();</span>&#13;
         <span class="ash">}</span>&#13;
      }&#13;
<span class="ash">#endif</span>&#13;
&#13;
    <span class="ash">rv = jupiter_print(salutation, argv[0]);</span>&#13;
&#13;
<span class="ash">#if HAVE_</span>LTDL<span class="ash">_H</span>&#13;
    if (ltdl == 0)&#13;
    {&#13;
<span epub:type="pagebreak" id="page_231"/>        <span class="ash">if (module != 0)</span>&#13;
            lt_<span class="ash">dlclose(module);</span>&#13;
        lt_dlexit();&#13;
    }&#13;
<span class="ash">#endif</span>&#13;
&#13;
    <span class="ash">return rv;</span>&#13;
<span class="ash">}</span></pre>&#13;
<p class="caption" id="ch08ex16"><em>Listing 8-16:</em> src/main.c: <em>Switching from <code>dl</code> to <code>ltdl</code> in source code</em></p>&#13;
<p class="indent">These changes are very symmetrical with respect to the original code. Mostly, items that previously referred to <code>DL</code> or <code>dl</code> now refer to <code>LTDL</code> or <code>lt_dl</code>. For example, <code>#if HAVE_DLFCN_H</code> becomes <code>#if HAVE_LTDL_H</code>, and so forth.</p>&#13;
<p class="indent">One important change is that the <em>ltdl</em> library must be initialized at <span class="ent">➌</span> with a call to <code>lt_dlinit</code>, whereas the <em>dl</em> library did not require initialization. In a larger program, the overhead of calling <code>lt_dlinit</code> and <code>lt_dlexit</code> would be amortized over a much larger code base.</p>&#13;
<p class="indent">Another important detail is the addition of the <code>LTDL_SET_PRELOADED_SYMBOLS</code> macro invocation at <span class="ent">➋</span>. This macro configures global variables required by the <code>lt_dlopen</code> and <code>lt_dlsym</code> functions on systems that don’t support shared libraries or in cases where the end user has specifically requested static libraries. It’s benign on systems that use shared libraries.</p>&#13;
<p class="indent">One last detail is that the return type of <code>dlopen</code> is <code>void *</code>, or a generic pointer, whereas the return type of <code>lt_dlopen</code> is <code>lt_dlhandle</code> (see <span class="ent">➊</span> and <span class="ent">➍</span>). This abstraction exists so <em>ltdl</em> can be ported to systems that use return types that are incompatible with a generic pointer.</p>&#13;
<p class="indent">When a system doesn’t support shared libraries, Libtool actually links all of the modules that might be loaded right into the program. Thus, the <code>jupiter</code> program’s linker (<code>libtool</code>) command line must contain some form of reference to these modules. This is done using the <code>-dlopen</code> <em><code>modulename</code></em> construct, as shown in <a href="ch08.xhtml#ch08ex17">Listing 8-17</a>.</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">jupiter_LDADD = ../libjup/libjupiter.la</span> -dlopen modules/hithere/hithere.la&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch08ex17"><em>Listing 8-17:</em> src/Makefile.am: <em>Adding a <code>-dlopen</code> option to the <code>LDADD</code> line</em></p>&#13;
<p class="indent">If you forget this addition to <em>src/Makefile.am</em>, you’ll get a linker error about an undefined symbol—something like <code>lt__PROGRAM__LTX_preloaded _symbols</code>. If it doesn’t detect any modules being linked into the application, Libtool won’t clutter your program’s global symbol space with symbols that will never be referenced; the symbols required by the <em>ltdl</em> library will be missing if the symbol table is empty.</p>&#13;
<p class="indent">It appears that <em>ltdl</em> is not quite as flexible as <em>dl</em> regarding the sort of path information you can specify in <code>lt_dlopen</code> to reference a module. In order to fix this problem, I hardwired the proper relative path (<em>modules/hithere/hithere.la</em>) into <em>main.c</em>. Additionally, this example is sensitive to the current working directory. If you run <code>jupiter</code> from another directory, it will <span epub:type="pagebreak" id="page_232"/>also fail to find the module. A real program would undoubtedly use a more robust method of configuration, such as a configuration file containing the absolute path to the desired module name.<sup><a id="ch08fn_10" href="footnote.xhtml#ch08fn10">10</a></sup></p>&#13;
<h4 class="h4" id="ch08sec4-1"><em>Preloading Multiple Modules</em></h4>&#13;
<p class="noindent">If Libtool links multiple modules into a program on a system without shared-library support, and if those modules each provide their own version of <code>get_salutation</code>, then there will be a conflict of public symbols within the program’s global symbol space. This is because all of these modules’ symbols become part of the program’s global symbol space and the linker generally won’t allow two symbols of the same name to be added to the executable symbol table. Which module’s <code>get_salutation</code> function should be honored? Unfortunately, there’s no good heuristic to resolve this conflict. The <em>GNU Libtool Manual</em> provides for this condition by defining a convention for maintaining symbol-naming uniqueness:</p>&#13;
<ul>&#13;
<li class="noindent">All exported interface symbols should be prefixed with <em><code>modulename</code></em><code>_LTX _</code> (for example, <code>hithere_LTX_get_salutation</code>).</li>&#13;
<li class="noindent">All remaining non-static symbols should be reasonably unique. The method Libtool suggests is to prefix them with <em><code>_modulename_</code></em> (as in <code>_jupiter_</code><em><code>somefunction</code></em>).</li>&#13;
<li class="noindent">Modules should be named differently even if they’re built in different directories.</li>&#13;
</ul>&#13;
<p class="indent">Although it’s not explicitly stated in the manual, the <code>lt_dlsym</code> function first searches for the specified symbol as <em><code>modulename</code></em><code>_LTX_</code><em><code>symbolname</code></em>, and then, if it can’t find a prefixed version of the symbol, it searches for exactly <em><code>symbolname</code></em>. You can see that this convention is necessary, but only for cases in which Libtool may statically link such loadable modules directly into the application on systems that don’t support shared libraries. The price you have to pay for Libtool’s illusion of shared libraries on systems that don’t support them is pretty high, but it’s the going rate for getting the same loadable module functionality on all platforms.</p>&#13;
<p class="indent">To fix the <em>hithere</em> module’s source code so that it conforms to this convention, we need to make one change to <em>hithere.c</em>, shown in <a href="ch08.xhtml#ch08ex18">Listing 8-18</a>.</p>&#13;
<pre><span class="ent">➊</span> #define get_salutation hithere_LTX_get_salutation&#13;
<span class="ent">➋</span> <span class="ash">#include "../../module.h"</span>&#13;
&#13;
   <span class="ash">const char * get_salutation(void)</span>&#13;
   <span epub:type="pagebreak" id="page_233"/><span class="ash">{</span>&#13;
      <span class="ash">return "Hi there";</span>&#13;
   <span class="ash">}</span></pre>&#13;
<p class="caption" id="ch08ex18"><em>Listing 8-18:</em> src/modules/hithere/hithere.c: <em>Ensuring public symbols are unique when using <code>ltdl</code></em></p>&#13;
<p class="indent">By defining the replacement for <code>get_salutation</code> at <span class="ent">➊</span> before the inclusion of the <em>module.h</em> header file at <span class="ent">➋</span>, we’re also able to change the prototype in the header file so that it matches the modified version of the function name. Because of the way the C preprocessor works, this substitution only affects the function prototype in <em>module.h</em>, not the quoted symbol string or the type definition. At this point, you may want to go back and examine the way <em>module.h</em> is written to prove to yourself that this actually works.</p>&#13;
<h4 class="h4" id="ch08sec4-2"><em>Checking It All Out</em></h4>&#13;
<p class="noindent">You can test your program and modules for both static and dynamic shared-library systems by using the <code>--disable-shared</code> option on the <code>configure</code> command line, like this:</p>&#13;
<pre>   $ <span class="codestrong1">make clean</span>&#13;
   <span class="codeitalic1">--snip--</span>&#13;
   $ <span class="codestrong1">autoreconf</span>&#13;
   $ <span class="codestrong1">./configure --disable-shared &amp;&amp; make</span>&#13;
   <span class="codeitalic1">--snip--</span>&#13;
   $ <span class="codestrong1">cd src</span>&#13;
   $ <span class="codestrong1">ls -1p modules/hithere/.libs</span>&#13;
<span class="ent">➊</span> hithere.a&#13;
   hithere.la&#13;
   hithere.lai&#13;
   $&#13;
   $ <span class="codestrong1">./jupiter</span>&#13;
<span class="ent">➋</span> Hi there, from ./jupiter!&#13;
   $&#13;
   $ <span class="codestrong1">cd ..</span>&#13;
   $ <span class="codestrong1">make clean</span>&#13;
   <span class="codeitalic1">--snip--</span>&#13;
   $ <span class="codestrong1">./configure &amp;&amp; make</span>&#13;
   $ <span class="codestrong1">cd src</span>&#13;
   $ <span class="codestrong1">ls -1p modules/hithere/.libs</span>&#13;
   hithere.a&#13;
   hithere.la&#13;
   hithere.lai&#13;
   hithere.o&#13;
   hithere.so&#13;
   $&#13;
   $ <span class="codestrong1">./jupiter</span>&#13;
<span class="ent">➌</span> Hi there, from ...jupiter!&#13;
   $</pre>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_234"/>As you can see, the output at <span class="ent">➋</span> and <span class="ent">➌</span> contains the <em>hithere</em> module’s salutation in both configurations, yet the file listing at <span class="ent">➊</span> shows us that, in the <code>--disable-shared</code> version, the shared library doesn’t even exist. It appears that <em>ltdl</em> is doing its job.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>You may have noticed the difference in the example’s output for the two executions of <em><code>jupiter</code></em>. In the first case, the output shows the name of the program as exactly <em><code>./jupiter</code></em>, while in the second case, it shows <em><code>...jupiter</code></em>. This was my attempt at removing the cruft in the output caused by Libtool’s redirection of the shared-library-consuming version referring to the actual program</em>—<code>lt-jupiter</code>—<em>in the</em> jupiter /src/.libs <em>directory. Libtool uses a wrapper around programs linked to built shared libraries in order to make it simpler for uninstalled programs to find the built shared libraries upon which they depend</em>.</p>&#13;
</div>&#13;
<p class="indent">The Jupiter code base has become rather fragile, because I’ve ignored the issue of where to find shared libraries at runtime. As I’ve already mentioned, you would ultimately have to fix this problem in a real program. But given that I’ve finished my task of showing you how to properly use the Libtool <em>ltdl</em> library, I’ll leave that as an exercise for you.</p>&#13;
<h3 class="h3" id="ch08sec5">Summary</h3>&#13;
<p class="noindent">The decision to use shared libraries brings with it a whole truckload of issues, and if you’re interested in maximum portability, you must deal with each of them. The <em>ltdl</em> library is not a solution to every problem. It solves some problems but brings others to the surface. Suffice it to say that using <em>ltdl</em> has trade-offs, but if you don’t mind the extra maintenance effort, it’s a good way to add maximum portability to your loadable-module project.</p>&#13;
<p class="indent">I hope that by spending some time going through the exercises in this book, you’ve been able to get your head around the Autotools enough to know how they work and what they’re doing for you. At this point, you should be very comfortable <em>autotool-izing</em> your own projects—at least at the basic level.</p>&#13;
<p class="indent">In the coming chapters, I’ll discuss additional tools and utilities that are also considered part of the GNU toolbox (and one or two that are not). I’ll also show you how to convert a real-world project from a handcoded build system to a much more concise, and probably more correct, Autotools build system.</p>&#13;
</body></html>