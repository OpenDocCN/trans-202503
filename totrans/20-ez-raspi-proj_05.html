<html><head></head><body>
<h2 class="h1-part" id="part04"><span epub:type="pagebreak" id="page_161"/><span class="green3">Cameras</span></h2>


<h2 class="h2" id="ch13"><span epub:type="pagebreak" id="page_162"/><strong>13<br/>Burglar Detector with Photo Capture</strong></h2>
<p class="noindent"><span class="green3">This project will teach you to use the Raspberry Pi Camera Module v2, which, along with the PIR motion sensor, will detect and photograph trespassers. When the motion sensor detects movement, it triggers an event that takes a photo so you know who was in your house while you were out</span>.</p>
<div class="image"><span epub:type="pagebreak" id="page_163"/><img src="../images/f0163-01.jpg" alt="image"/></div>
<p class="cap"><span class="green3"><strong>PARTS REQUIRED</strong></span></p>
<p class="cap1">Raspberry Pi</p>
<p class="cap1">Breadboard</p>
<p class="cap1">Raspberry Pi Camera Module v2</p>
<p class="cap1">PIR mot ion sensor HC-SR501</p>
<p class="cap1">Pushbut ton</p>
<p class="cap1">Jumper wires</p>
<h3 class="h3" id="lev131"><span epub:type="pagebreak" id="page_164"/><span class="green3"><strong>INTRODUCING THE RASPBERRY PI CAMERA MODULE V2</strong></span></h3>
<p class="noindent">The Raspberry Pi Camera Module v2, shown in <a href="ch13.xhtml#ch13fig1">Figure 13-1</a>, features an 8 MP Sony IMX219 image sensor with a fixed-focus lens. It’s capable of 3280×2464 pixel static images and supports video with resolutions of 1080p at 30 frames, 720p at 60 frames, and 640×480 at 90 frames—all of which means it’s a pretty good camera for its size! You’ll just use the static image capabilities in this project.</p>
<div class="image"><a id="ch13fig1"/><img src="../images/f0164-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 13-1:</strong> Raspberry Pi Camera Module v2</p>
<p class="indent">This camera is compatible with all Raspberry Pi models—1, 2, 3, and zero—and comes with a 15 cm ribbon cable that makes it easy to connect to the CSI port on the Raspberry Pi, designed to interface with cameras. If you want your camera to reach farther than 15 cm from your Pi, you should be able to find and purchase longer cables.</p>
<p class="indent">The Raspberry Pi Camera Module v2 is one of the most popular Raspberry Pi add-ons because it gives users an affordable way to take still photographs and record video in full HD. One interesting example of a Camera Module v2 project comes from the Naturebytes community, which provides kits to remotely capture wildlife photos. <a href="ch13.xhtml#ch13fig2">Figure 13-2</a> shows the wildlife camera in action.</p>
<div class="image"><a id="ch13fig2"/><img src="../images/f0164-02.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 13-2:</strong> Raspberry Pi camera with PIR motion sensor pointed at a bird feeder</p>
<p class="indent"><span epub:type="pagebreak" id="page_165"/>The Naturebytes kit is also equipped with a PIR motion sensor, so if a bird perches on the feeder in <a href="ch13.xhtml#ch13fig2">Figure 13-2</a>, it will trigger the camera to take a photo of the bird. You’ll use the same principles for this project’s burglar detector.</p>
<h3 class="h3" id="lev132"><span class="green3"><strong>BUILDING THE BURGLAR DETECTOR</strong></span></h3>
<p class="noindent">The burglar detector consists of a PIR motion sensor, a pushbutton, and a camera module you’ll connect to your Pi. You’ll use the built-in picamera library, which makes it simple to control the camera.</p>
<h4 class="h4" id="lev133"><span class="green3"><strong>Enabling the Camera</strong></span></h4>
<p class="noindent">You need to enable your Pi’s camera software before you can use the camera module. In the desktop environment, go to the main menu and select <strong>Preferences</strong> <span class="ent">▸</span> <strong>Raspberry Pi Configuration</strong>. You should see a window like the one in <a href="ch13.xhtml#ch13fig3">Figure 13-3</a>.</p>
<div class="image"><a id="ch13fig3"/><img src="../images/f0165-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 13-3:</strong> Enabling the camera software</p>
<p class="indent">Select <strong>Enabled</strong> on the Camera row, then click <strong>OK</strong>, and you’re ready to go.</p>
<h4 class="h4" id="lev134"><span class="green3"><strong>Connecting the Camera</strong></span></h4>
<p class="noindent">With the camera software enabled, shut down your Pi and then connect the camera to the CSI port. Make sure the camera is connected with the blue letters facing up and oriented as shown in <a href="ch13.xhtml#ch13fig4">Figure 13-4</a>. Then start up your Pi again.</p>
<div class="image"><span epub:type="pagebreak" id="page_166"/><a id="ch13fig4"/><img src="../images/f0166-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 13-4:</strong> Connecting the Raspberry Pi camera to the CSI port</p>
<h3 class="h3" id="lev135"><span class="green3"><strong>WIRING THE CIRCUIT</strong></span></h3>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>Be careful when moving the camera. The ribbon is very fragile, and if it touches the GPIOs, they may permanently damage your camera. Try using some modeling clay or sticky tack to secure the camera.</em></p>
</div>
<p class="noindent">With the camera connected, follow these instructions to wire the rest of the circuit, using <a href="ch13.xhtml#ch13fig5">Figure 13-5</a> as a reference.</p>
<ol>
<li class="noindent"><p class="list">Connect a GND pin to the breadboard GND rails.</p></li>
<li class="noindent"><p class="list">Insert a pushbutton into the breadboard so that it straddles the center divide. Connect one lead to GND and the other lead on the same side of the button to GPIO 2.</p></li>
<li class="noindent"><p class="list">Wire the PIR motion sensor with the connections shown in the following table.</p>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="border_th-n"><p class="tab_th"><strong>PIR MOTION SENSOR</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>RASPBERRY PI</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-n"><p class="tabc"><span class="green3">GND</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green3">GND</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-n"><p class="tabc"><span class="green3">OUT</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green3">GPIO 4</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-n"><p class="tabc"><span class="green3">VCC</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green3">5 V</span></p></td>
</tr>
</tbody>
</table></li>
</ol>
<div class="image"><span epub:type="pagebreak" id="page_167"/><a id="ch13fig5"/><img src="../images/f0167-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 13-5:</strong> The burglar detector circuit</p>
<h3 class="h3" id="lev136"><span class="green3"><strong>WRITING THE SCRIPT</strong></span></h3>
<p class="noindent">To control the camera, you’ll use the built-in picamera library. It’s a very straightforward library, so this script will be a piece of cake. Here’s an overview of what the code should do:</p>
<ol>
<li class="noindent"><p class="list">Initialize the camera.</p></li>
<li class="noindent"><p class="list">Take a photo when the PIR motion sensor detects movement.</p></li>
<li class="noindent"><p class="list">Save the photos in your <em>Desktop</em> folder.</p></li>
<li class="noindent"><p class="list">Name the photos incrementally so you know what order they were taken in—for example, <em>image_1.jpg</em>, <em>image_2.jpg</em>, and so on.</p></li>
<li class="noindent"><p class="list">Stop the camera when the pushbutton is pressed. If you don’t include this feature, you won’t be able to exit the camera preview that pops up on your screen.</p></li>
</ol>
<h4 class="h4" id="lev137"><span class="green3"><strong>Entering the Script</strong></span></h4>
<p class="noindent">Go to your <em>Projects</em> folder and create a new folder called <em>Cameras</em>. Then open <strong>Python 3 (IDLE)</strong> and go to <strong>File</strong> <span class="ent">▸</span> <strong>New</strong> to create a new script called <em>burglar_detector.py</em>, and copy the following code into it (remember that you can download all the scripts at <em><a href="https://www.nostarch.com/RaspberryPiProject/">https://www.nostarch.com/RaspberryPiProject/</a></em>).</p>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>You can’t name any of your files</em> picamera.py <em>because picamera is a Python library name and cannot be used.</em></p>
</div>
<div class="box">
<pre><span epub:type="pagebreak" id="page_168"/>  <span class="red1">#import the necessary libraries</span><br/><span class="ent">➊</span> <span class="orange">from</span> gpiozero <span class="orange">import</span> Button, MotionSensor<br/>  <span class="orange">from</span> picamera <span class="orange">import</span> PiCamera<br/>  <span class="orange">from</span> time <span class="orange">import</span> sleep<br/>  <span class="orange">from</span> signal <span class="orange">import</span> pause<br/><br/>  <span class="red1">#create objects that refer to a button,</span><br/>  <span class="red1">#a motion, sensor, and the PiCamera</span><br/><span class="ent">➋</span> button = Button(2)<br/>  pir = MotionSensor(4)<br/>  camera = PiCamera()<br/><br/>  <span class="red1">#start the camera</span><br/>  camera.rotation = 180<br/><span class="ent">➌</span> camera.start_preview()<br/><br/>  <span class="red1">#create image names</span><br/><span class="ent">➍</span> i = 0<br/><br/>  <span class="red1">#stop the camera when the pushbutton is pressed</span><br/><span class="ent">➎</span> <span class="orange">def</span> <span class="blue">stop_camera</span>():<br/>      camera.stop_preview()<br/>      <span class="red1">#exit the program</span><br/>      <span class="purple">exit</span>()<br/><br/>  <span class="red1">#take a photo when motion is detected</span><br/><span class="ent">➏</span> <span class="orange">def</span> <span class="blue">take_photo</span>():<br/>      <span class="orange">global</span> i<br/>      i = i + 1<br/>      camera.capture(<span class="green">'/home/pi/Desktop/image_%s.jpg'</span> % i)<br/>      <span class="purple">print</span>(<span class="green">'A photo has been taken'</span>)<br/><span class="ent">➐</span>    sleep(10)<br/><br/>  <span class="red1">#assign a function that runs when the button is pressed</span><br/><span class="ent">➑</span> button.when_pressed = stop_camera<br/>  <span class="red1">#assign a function that runs when motion is detected</span><br/><span class="ent">➒</span> pir.when_motion = take_photo<br/><br/>  pause()</pre>
</div>
<p class="indent">First you import the libraries you need <span class="ent">➊</span>; as we’ve said, the program uses the picamera library to control the camera. You should be familiar with all the other modules used here from previous projects. Then you create objects to refer to the pushbutton, the PIR motion sensor, and the camera <span class="ent">➋</span>, and initialize the camera with <code>camera.start_preview()</code> <span class="ent">➌</span>. Depending on how your camera is oriented, you might also need to rotate it 180 degrees with <code>camera.rotation = 180</code> so that it doesn’t take the photos upside down. If your image is <span epub:type="pagebreak" id="page_169"/>upside down when you test this code, go back and set the rotation to <code>0</code> or comment out this line.</p>
<p class="indent">Next, you initialize an <code>i</code> variable that starts at <code>0</code> <span class="ent">➍</span>. The <code>take_photo()</code> function, defined at <span class="ent">➏</span>, will use this variable to count and number the images, incrementing the number in the filename by one with each picture taken.</p>
<p class="indent">You then define the <code>stop_camera()</code> function that stops the camera with the <code>camera.stop_preview()</code> method <span class="ent">➎</span>. At <span class="ent">➏</span>, you define the <code>take_photo()</code> function we just mentioned, which takes a photo. For this, you use the <code>camera.capture()</code> method, specifying the directory you want to save the image to inside the parentheses. In this case, we’re saving the images in the <em>Desktop</em> folder and naming the images <code>image_%s.jpg</code>, where <code>%s</code> is replaced with the number we incremented earlier in <code>i</code>. If you want to save your files to a different folder, replace this directory with the path to your chosen folder.</p>
<p class="indent">You then impose a 10-second delay <span class="ent">➐</span>, meaning the camera takes photos at 10-second intervals for as long as the PIR sensor detects movement. Feel free to increase or decrease the delay time, but be careful to not overload the Pi with tons of images by making the delay time too small.</p>
<p class="indent">At <span class="ent">➑</span>, you define the behavior to trigger the <code>stop_camera()</code> function when you press the pushbutton. This function stops the camera preview and exits the program. The <code>exit()</code> function pops up a window asking if you want to close the program; to close it, just click <strong>OK</strong>. Finally, you tell the camera to take a photo by triggering the <code>take_photo()</code> function when motion is detected <span class="ent">➒</span>.</p>
<h4 class="h4" id="lev138"><span class="green3"><strong>Running the Script</strong></span></h4>
<p class="noindent">Press <strong>F5</strong> or go to <strong>Run</strong> <span class="ent">▸</span> <strong>Run Module</strong> to run the script. While the script is running, you should see a preview of what the camera sees on your screen. To shut down the camera preview, press the pushbutton and click <strong>OK</strong> in the window that pops up.</p>
<p class="indent">Congratulations! Your burglar detector is ready to catch some burglars. Place the burglar detector in a strategic place and come back later to check any saved photos. <a href="ch13.xhtml#ch13fig6">Figure 13-6</a> shows a photo taken by our burglar detector, catching someone stealing a computer from our lab.</p>
<div class="image"><span epub:type="pagebreak" id="page_170"/><a id="ch13fig6"/><img src="../images/f0170-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 13-6:</strong> Picture taken with the burglar detector</p>
<h3 class="h3" id="lev139"><span class="green3"><strong>TAKING IT FURTHER</strong></span></h3>
<p class="noindent">As you’ve seen, projects with cameras are fun! Here’s an idea on how to improve your security system: redesign your project so that, when the sensor detects motion, the Raspberry Pi takes a photo, sends you an email notification, and sounds an alarm. You should already know how to do all of this using the skills you’ve learned from <a href="ch09.xhtml#ch09">Projects 9</a>–<a href="ch12.xhtml#ch12">12</a>.</p>


<h2 class="h2" id="ch14"><span epub:type="pagebreak" id="page_171"/><strong>14<br/>Home Surveillance Camera</strong></h2>
<p class="noindent"><span class="green3">In this project, you’ll create a home surveillance camera system that streams live video on a web page that you can access from any device with browser capabilities connected to the same network as your Pi. This means you’ll be able to monitor any part of your house without getting off the sofa!</span></p>
<div class="image"><span epub:type="pagebreak" id="page_172"/><img src="../images/f0172-01.jpg" alt="image"/></div>
<p class="cap"><span class="green3"><strong>PARTS REQUIRED</strong></span></p>
<p class="cap1">Raspberry Pi</p>
<p class="cap1">Raspberry Pi Camera Module v2</p>
<p class="indentt"><span epub:type="pagebreak" id="page_173"/>In this project, you need to connect the camera to the Raspberry Pi, as we’ve shown you in <a href="ch13.xhtml#lev134">“Connecting the Camera”</a> on <a href="ch13.xhtml#page_165">page 165</a>. If you haven’t enabled the software camera yet, go back to <a href="ch13.xhtml#ch13">Project 13</a> and follow the instructions to set up the camera before continuing.</p>
<h3 class="h3" id="lev140"><span class="green3"><strong>RECORDING VIDEO TO A FILE</strong></span></h3>
<p class="noindent">Before building your home surveillance camera system, you need to learn how to record video to a file.</p>
<p class="indent">Using <a href="ch13.xhtml#ch13">Project 13</a> as a reference, connect your Raspberry Pi Camera Module v2 to your Pi using the CSI port. Create a new script called <em>record_file.py</em> in <strong>Python 3 (IDLE)</strong>, save it inside the <em>Cameras</em> folder, and enter the code in <a href="ch14.xhtml#ch14list1">Listing 14-1</a>.</p>
<p class="listing" id="ch14list1"><strong>LISTING 14-1:</strong> Record video to a file</p>
<div class="box">
<pre><span class="ent">➊</span> <span class="orange">import</span> picamera<br/><br/><span class="ent">➋</span> camera = picamera.PiCamera()<br/><br/><span class="ent">➌</span> camera.resolution = (640, 480)<br/><span class="ent">➍</span> camera.start_recording(<span class="green">'videotest.h264'</span>)<br/><span class="ent">➎</span> camera.wait_recording(60)<br/><span class="ent">➏</span> camera.stop_recording()<br/><br/>  <span class="purple">print</span>(<span class="green">'Finished recording'</span>)</pre>
</div>
<p class="indent">As usual, you first import the picamera library to control the camera <span class="ent">➊</span>. You create an object called <code>camera</code> to refer to the camera <span class="ent">➋</span> and then set the camera resolution to 640×480 <span class="ent">➌</span>. The camera resolution is configurable; the maximum resolution for video recording is 1920×1080 and the minimum resolution is 64×64. To enable maximum resolution, you also need to set the frame rate to 15 by adding the line of code <code>camera.framerate = 15</code>. You can try testing this script now with different resolutions and see what works best for you, or you can just go with our settings for now and come back to it later.</p>
<p class="indent">The camera then starts recording to a file called <em>videotest.h264</em> <span class="ent">➍</span>. Feel free to change the filename, though you should keep the extension <em>.h264</em>, which is a format for video files. You then specify the amount of time that the camera should record for <span class="ent">➎</span>. In this case, the camera is recording for 60 seconds. The <code>wait_recording()</code> method also repeatedly checks for errors, such as the disk space being too full for more recording.</p>
<p class="indent">Last, you stop the video recording <span class="ent">➏</span> and print a message saying that the recording is finished. Press <strong>F5</strong> or go to <strong>Run</strong> <span class="ent">▸</span> <strong>Run Module</strong> to run the script. Your video file is located in the script’s <span epub:type="pagebreak" id="page_174"/>folder, <em>Cameras</em>. From the terminal, enter the following commands to navigate to the video folder and watch it:</p>
<div class="box">
<pre>pi@raspberrypi:~ $ <span class="codestrong">cd ~/Desktop/Projects/Cameras</span><br/>pi@raspberrypi:~/Desktop/Projects/Cameras $ <span class="codestrong">omxplayer videotest.h264</span></pre>
</div>
<p class="indent">This opens a new window and plays the whole video in fullscreen. <a href="ch14.xhtml#ch14fig1">Figure 14-1</a> shows a screenshot of our video recording test.</p>
<div class="image"><a id="ch14fig1"/><img src="../images/f0174-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 14-1:</strong> Recording video with the Raspberry Pi camera</p>
<h3 class="h3" id="lev141"><span class="green3"><strong>WRITING THE SCRIPT</strong></span></h3>
<p class="noindent">Now for the important bit: you’re going to build a web page that is hosted in your Raspberry Pi—also known as a <em>web server</em>—that streams live video. (We’ll cover web servers in more detail in <a href="ch15.xhtml#ch15">Projects 15</a>, <a href="ch16.xhtml#ch16">16</a>, and <a href="ch17.xhtml#ch17">17</a>.)</p>
<p class="indent">The script for this project is advanced, so we won’t explain each line in detail. Here’s an overview of what the code should do:</p>
<ol>
<li class="noindent"><p class="list">Initialize a web server and the Pi camera.</p></li>
<li class="noindent"><p class="list">Set the web server, available at the Raspberry Pi IP address port 8000, to show a web page you can customize using HTML.</p></li>
<li class="noindent"><p class="list">Set the web page to contain the camera video streaming.</p></li>
<li class="noindent"><p class="list">Make the web server accessible from any browser connected to the same network as your Pi.</p></li>
</ol>
<h4 class="h4" id="lev142"><span epub:type="pagebreak" id="page_175"/><span class="green3"><strong>Entering the Script</strong></span></h4>
<p class="noindent">Open <strong>Python 3 (IDLE)</strong> and go to <strong>File</strong> <span class="ent">▸</span> <strong>New</strong> to create a new script. Enter the code in <a href="ch14.xhtml#ch14list2">Listing 14-2</a>, and save it as <em>surveillance_system.py</em> in the <em>Cameras</em> folder (remember that you can download all the scripts at <em><a href="https://www.nostarch.com/RaspberryPiProject/">https://www.nostarch.com/RaspberryPiProject/</a></em>).</p>
<p class="indent">This script was based on the web streaming example at <em><a href="http://picamera.readthedocs.io/en/latest/recipes2.html">http://picamera.readthedocs.io/en/latest/recipes2.html</a></em>.</p>
<p class="listing" id="ch14list2"><strong>LISTING 14-2:</strong> Stream video to a web page</p>
<div class="box">
<pre>  <span class="orange">import</span> io<br/>  <span class="orange">import</span> picamera<br/>  <span class="orange">import</span> logging<br/>  <span class="orange">import</span> socketserver<br/>  <span class="orange">from</span> threading <span class="orange">import</span> Condition<br/>  <span class="orange">from</span> http <span class="orange">import</span> server<br/><br/><span class="ent">➊</span> PAGE=<span class="green">"""\</span><br/>  <span class="green">&lt;html&gt;</span><br/>  <span class="green">&lt;head&gt;</span><br/>  <span class="green">&lt;title&gt;Raspberry Pi - Surveillance Camera&lt;/title&gt;</span><br/>  <span class="green">&lt;/head&gt;</span><br/>  <span class="green">&lt;body&gt;</span><br/>  <span class="green">&lt;center&gt;&lt;h1&gt;Raspberry Pi - Surveillance Camera&lt;/h1&gt;&lt;/center&gt;</span><br/>  <span class="green">&lt;center&gt;&lt;img src="stream.mjpg" width="640" height="480"&gt;&lt;/center&gt;</span><br/>  <span class="green">&lt;/body&gt;</span><br/>  <span class="green">&lt;/html&gt;</span><br/>  <span class="green">"""</span><br/><br/>  <span class="orange">class</span> <span class="blue">StreamingOutput</span>(object):<br/>      <span class="orange">def</span> <span class="blue">__init__</span>(self):<br/>          self.frame = <span class="orange">None</span><br/>          self.buffer = io.BytesIO()<br/>          self.condition = Condition()<br/><br/>      <span class="orange">def</span> <span class="blue">write</span>(self, buf):<br/>          <span class="orange">if</span> buf.startswith(<span class="green">b'\xff\xd8'</span>):<br/>              <span class="red1">#new frame, copy the existing buffer's content and</span><br/>              <span class="red1">#notify all clients it's available</span><br/>              self.buffer.truncate()<br/>              <span class="orange">with</span> self.condition:<br/>                  self.frame = self.buffer.getvalue()<br/>                  self.condition.notify_all()<br/>              self.buffer.seek(0)<br/>          <span class="orange">return</span> self.buffer.write(buf)<br/><br/>  <span class="orange">class</span> <span class="blue">StreamingHandler</span>(server.BaseHTTPRequestHandler):<br/>      <span class="orange">def</span> <span class="blue">do_GET</span>(self):<br/>          <span class="orange">if</span> self.path == <span class="green">'/'</span>:<br/>              self.send_response(301)<br/>              self.send_header(<span class="green">'Location', '/index.html'</span>)<br/>              self.end_headers()<br/>          <span class="orange">elif</span> self.path == <span class="green">'/index.html'</span>:<br/><span epub:type="pagebreak" id="page_176"/>              content = PAGE.encode(<span class="green">'utf-8'</span>)<br/>              self.send_response(200)<br/>              self.send_header(<span class="green">'Content-Type', 'text/html'</span>)<br/>              self.send_header(<span class="green">'Content-Length'</span>, <span class="purple">len</span>(content))<br/>              self.end_headers()<br/>              self.wfile.write(content)<br/>          <span class="orange">elif</span> self.path == <span class="green">'</span><span class="green">/stream.mjpg'</span>:<br/>              self.send_response(200)<br/>              self.send_header(<span class="green">'Age'</span>, 0)<br/>              self.send_header(<span class="green">'Cache-Control'</span>, <span class="green">'no-cache, private'</span>)<br/>              self.send_header(<span class="green">'Pragma'</span>, <span class="green">'no-cache'</span>)<br/>              self.send_header(<span class="green">'Content-Type'</span>, <br/>  <span class="green">'multipart/x-mixed-replace; boundary=FRAME'</span>)<br/>              self.end_headers()<br/>              <span class="orange">try</span>:<br/>                  <span class="orange">while</span> <span class="orange">True</span>:<br/>                      <span class="orange">with</span> output.condition:<br/>                          output.condition.wait()<br/>                          frame = output.frame<br/>                      self.wfile.write(<span class="green">b'--FRAME\r\n'</span>)<br/>                      self.send_header(<span class="green">'Content-Type', 'image/jpeg'</span>)<br/>                      self.send_header(<span class="green">'Content-Length'</span>, <span class="purple">len</span>(frame))<br/>                      self.end_headers()<br/>                      self.wfile.write(frame)<br/>                      self.wfile.write(<span class="green">b'\r\n'</span>)<br/>              <span class="orange">except</span> <span class="purple">Exception</span> <span class="orange">as</span> e:<br/>                  logging.warning(<br/>                      <span class="green">'</span><span class="green">Removed streaming client %s: %s'</span>,<br/>                      self.client_address, <span class="purple">str</span>(e))<br/>          <span class="orange">else</span>:<br/>              self.send_error(404)<br/>              self.end_headers()<br/><br/>  <span class="orange">class</span> <span class="blue">StreamingServer</span>(socketserver.ThreadingMixIn,<br/>  server.HTTPServer):<br/>      allow_reuse_address = <span class="orange">True</span><br/>      daemon_threads = <span class="orange">True</span><br/><br/><span class="ent">➋</span> <span class="orange">with</span> picamera.PiCamera(resolution=<span class="green">'640x480'</span>, framerate=24) <span class="orange">as</span><br/>  camera:<br/>      output = StreamingOutput()<br/>      camera.start_recording(output, <span class="purple">format</span>=<span class="green">'mjpeg'</span>)<br/>      <span class="orange">try</span>:<br/>          address = (<span class="green">''</span>, 8000)<br/>          server = StreamingServer(address, StreamingHandler)<br/>          server.serve_forever()<br/>      <span class="orange">finally</span>:<br/>          camera.stop_recording()</pre>
</div>
<p class="indent"><a href="ch14.xhtml#ch14list2">Listing 14-2</a> is more complicated than the scripts we’ve been writing so far, and explaining each class and function necessary for video streaming goes beyond the book’s scope, so we won’t go into it here.</p>
<p class="indent"><span epub:type="pagebreak" id="page_177"/>There is space for customization, though. You can edit the way your web page looks and the camera settings:</p>
<ul>
<li class="noindent">At <span class="ent">➊</span>, you define your web page content using HTML; here you can change the title and heading of your web page. Check <a href="ch15.xhtml#ch15">Project 15</a> for more information about HTML, as well as to learn how to style your web page using CSS.</li>
<li class="noindent">At <span class="ent">➋</span>, you initialize the camera; here you can change the camera resolution and frame rate.</li>
</ul>
<h4 class="h4" id="lev143"><span class="green3"><strong>Running the Script</strong></span></h4>
<p class="noindent">Press <strong>F5</strong> or go to <strong>Run</strong> <span class="ent">▸</span> <strong>Run Module</strong> to run the script. Once the script is running, your camera will stream to the web page. To access this page, you need to find the IP address for your Pi and enter the URL <em>http://&lt;Pi IP address&gt;:8000</em>, replacing <em>&lt;Pi IP address&gt;</em> with your Pi’s IP address.</p>
<p class="indent">To find your Pi’s IP address, go to the terminal and enter the following:</p>
<div class="box">
<pre>pi@raspberrypi:~ $ <span class="codestrong">hostname -I</span></pre>
</div>
<p class="indent">This will print the Pi’s IP address, as highlighted in <a href="ch14.xhtml#ch14fig2">Figure 14-2</a>.</p>
<div class="image"><a id="ch14fig2"/><img src="../images/f0177-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 14-2:</strong> Finding your Raspberry Pi’s IP address</p>
<p class="indent">Congratulations—you’ve built your own home surveillance system! You can access the video streaming from a computer, smartphone, or tablet browser connected to the local network. In this example, since our IP address is 192.168.1.112, we enter <em>http://192.168.1.112:8000</em>. Make sure you use your own IP address.</p>
<h3 class="h3" id="lev144"><span epub:type="pagebreak" id="page_178"/><span class="green3"><strong>TAKING IT FURTHER</strong></span></h3>
<p class="noindent">In this project you’ve learned how to record video and how to build a web server that streams live video footage. You can mix what you’ve learned here with other projects to enhance them. For example:</p>
<ul>
<li class="noindent">Edit <a href="ch13.xhtml#ch13">Project 13</a> so that the Pi records video for a specified time when it detects movement inside your house while you’re out.</li>
<li class="noindent">Customize the streaming web page with CSS using the skills you’ll learn in <a href="ch15.xhtml#ch15">Project 15</a>.</li>
</ul>
</body></html>