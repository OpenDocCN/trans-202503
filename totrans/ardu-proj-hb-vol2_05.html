<html><head></head><body>
<h1 class="h1-part" id="part04"><span epub:type="pagebreak" id="page_105"/><strong><span class="voilet">LCDs</span></strong></h1>&#13;


<h2 class="h2s" id="ch13"><span epub:type="pagebreak" id="page_106"/><strong>13<br/>Ultrasonic Range Finder</strong></h2>&#13;
<p class="intro"><span class="voilet">In this project we’ll create a simple ultrasonic range finder with a screen that displays the distance of an object up to 5 meters from the sensor.</span></p>&#13;
<div class="image"><img alt="Image" src="../images/p0106-01.jpg"/></div>&#13;
<div class="image"><span epub:type="pagebreak" id="page_107"/><img alt="Image" src="../images/p0107-01.jpg"/></div>&#13;
<p class="capv"><strong>PARTS REQUIRED</strong></p>&#13;
<p class="cap1"><strong>Arduino board</strong></p>&#13;
<p class="cap1"><strong>Breadboard</strong></p>&#13;
<p class="cap1"><strong>Jumper wires</strong></p>&#13;
<p class="cap1"><strong>HD44780 16x2 LCD screen</strong></p>&#13;
<p class="cap1"><strong>HC-SR04 ultrasonic sensor</strong></p>&#13;
<p class="cap1"><strong>50k-ohm potentiometer</strong></p>&#13;
<p class="capv"><strong>LIBRARY REQUIRED</strong></p>&#13;
<p class="cap1"><strong>LiquidCrystal</strong></p>&#13;
<h3 class="h3" id="ch00lev1sec51"><span epub:type="pagebreak" id="page_108"/><span class="voilet"><strong>HOW IT WORKS</strong></span></h3>&#13;
<p class="noindent">The ultrasonic range finder sends out a burst of ultrasound and listens for the echo that bounces off an object. The Arduino sends out a short pulse on the trigger pin to send the ultrasonic burst, then listens for a pulse on the echo pin using the <code>pulseIn</code> function.</p>&#13;
<p class="indent">This duration between sending and receiving the pulse is equal to the time taken by the ultrasound to travel to the object and back to the sensor. The Arduino converts this time to distance and displays it on the LCD screen. You can find an HC-SR04 unit (<a href="ch13.xhtml#ch13fig1">Figure 13-1</a>) from one of the sources listed in the “<a href="app02.xhtml#ch00lev1sec170">Retailer List</a>” on <a href="app02.xhtml#page_249">page 249</a>, or you can search online for <em>HC-SR04 ultrasonic module</em>.</p>&#13;
<p class="figcap"><a id="ch13fig1"/><strong>FIGURE 13-1:</strong> The HC-SR04 ultrasonic sensor</p>&#13;
<div class="image"><img alt="Image" src="../images/f13-01.jpg"/></div>&#13;
<p class="indent">An LCD (liquid crystal display) screen is made of two sheets of polarizing material with a liquid crystal solution between them. Current passing through the solution makes the screen opaque, so by controlling which areas of the screen current passes through, the Arduino creates an image or, in this case, characters. You’ll need an LCD screen that’s compatible with the Hitachi HD44780 driver for it to work with the Arduino; there are lots of them out there and you can usually identify them by their 16-pin interface. We’ll use the LiquidCrystal library to send characters to the LCD screen (refer to the primer if you need a refresher on libraries). The LiquidCrystal library maps the characters and uses the <code>print</code> commands to send messages to the screen.</p>&#13;
<h3 class="h3" id="ch00lev1sec52"><span epub:type="pagebreak" id="page_109"/><span class="voilet"><strong>PREPARING THE LCD SCREEN</strong></span></h3>&#13;
<p class="noindent">The LCD screen will probably require a bit of assembly. Your screen should have come with 16 holes, as shown in <a href="ch13.xhtml#ch13fig2">Figure 13-2</a>, and a separate strip of header pins. Break off a row of 16 pins from the strip. Insert the shorter side of the pins into the 16 LCD holes. You’ll need to solder these in place; the primer has a quick soldering guide if you need pointers. Solder the far-right and far-left pins first to hold the strip in place and wait a moment for them to set. Then solder each pin in turn. Holding the iron to the pins for too long will damage them, so solder them only for a couple of seconds.</p>&#13;
<p class="figcap"><a id="ch13fig2"/><strong>FIGURE 13-2:</strong> A 16×2 LCD screen</p>&#13;
<div class="image"><img alt="Image" src="../images/f13-02.jpg"/></div>&#13;
<h3 class="h3" id="ch00lev1sec53"><span class="voilet"><strong>THE BUILD</strong></span></h3>&#13;
<ol>&#13;
<li><p class="noindents">Place your LCD screen in the breadboard, inserting the header pins into the breadboard holes. Also place the potentiometer in the breadboard, and use jumper wires to connect your LCD screen, Arduino, and potentiometer as shown in the following table. The pins of the LCD screen should be labeled or numbered, either on the back or the front. If not, they usually start at 1 from the left when the pins are along the top. There are a number of connections from the LCD screen to Arduino GND, so use the breadboard ground rail to make multiple connections to the Arduino GND pin.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thv" style="vertical-align: top;"><span epub:type="pagebreak" id="page_110"/><p class="tablec"><strong>LCD SCREEN</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">1 VSS</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">2 VDD</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">3 VO contrast</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Potentiometer center pin</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">4 RS</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 11</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">5 R/W</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 10</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">6 Enable</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 9</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">7 D0</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">No connection</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">8 D1</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">No connection</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">9 D2</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">No connection</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">10 D3</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">No connection</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">11 D4</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 7</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">12 D5</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 6</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">13 D6</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 5</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">14 D7</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 4</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">15 A BcL+</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">16 K BcL–</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindents">You should have already connected the center pin of the 50kohm potentiometer to LCD pin 3 (VO). Now connect one of the outer potentiometer pins to GND and the other to +5V. Twist the potentiometer to control the contrast of your LCD screen.</p></li>&#13;
<li><p class="noindents">Backlit LCD screens will have resistors built in, but if you have a nonbacklit LCD screen, insert a 220-ohm resistor between LCD 15 and +5V. Check the data sheet for your screen if you’re unsure.</p></li>&#13;
<li><p class="noindents">Add the ultrasonic sensor module to your breadboard and connect VCC to +5V, Trig to Arduino pin 13, Echo to Arduino pin 12, and GND to GND, as shown in the following table.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thv" style="vertical-align: top;"><p class="tablec"><strong>ULTRASONIC SENSOR</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">VCC</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Trig</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 13</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Echo</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 12</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindents"><span epub:type="pagebreak" id="page_111"/>Connect your breadboard rails to Arduino +5V and GND for power.</p></li>&#13;
<li><p class="noindents">Check that your setup matches the circuit diagram in <a href="ch13.xhtml#ch13fig3">Figure 13-3</a>, and upload the code in “<a href="ch13.xhtml#ch00lev1sec54">The Sketch</a>” on <a href="ch13.xhtml#page_112">page 112</a>.</p>&#13;
<p class="figcap"><a id="ch13fig3"/><strong>FIGURE 13-3:</strong> The circuit diagram for the ultrasonic range finder</p>&#13;
<div class="image"><img alt="Image" src="../images/f13-03.jpg"/></div></li>&#13;
</ol>&#13;
<h3 class="h3" id="ch00lev1sec54"><span epub:type="pagebreak" id="page_112"/><span class="voilet"><strong>THE SKETCH</strong></span></h3>&#13;
<p class="noindent">The sketch first calls on the LiquidCrystal library and defines the LCD pins connected to the Arduino. Pin 13 on the Arduino, connected to the trigger pin of the sensor, sends an ultrasonic signal out, and Arduino pin 12, connected to the echo pin of the sensor, receives the returning signal. The Arduino converts the time between sending and receiving the signal into distance and displays the result on the LCD screen, in both inches and centimeters. This sketch can be found on the Arduino site, so I’ve copied it here exactly as it appears there.</p>&#13;
<p class="programs1"><span class="ash">/*</span><br/>   <span class="ash">Created 3 Nov 2008 by David A. Mellis;</span><br/>   <span class="ash">Modified 30 Aug 2011 by Tom Igoe</span><br/>   <span class="ash">This example code is in the public domain.</span><br/> <span class="ash">*/</span><br/>#include &lt;<span class="orange">LiquidCrystal</span>.h&gt;<br/><br/><span class="orange">LiquidCrystal</span> lcd(11, 10, 9, 7, 6, 5, 4);<br/><span class="green1">int</span> pingPin = 13;<br/><span class="green1">int</span> inPin = 12;<br/><br/><span class="green1">void</span> <span class="green2">setup</span>() {<br/>  lcd.<span class="orange">begin</span>(16, 2);<br/>  lcd.<span class="orange">print</span>(<span class="green1">"testing..."</span>);<br/>}<br/><br/><span class="green1">void</span> <span class="orange">loop</span>() {<br/>  <span class="ash">// Establish variables for duration of the ping,</span><br/>  <span class="ash">// and the distance result in inches and centimeters:</span><br/>  <span class="ash">// long duration, inches, cm;</span><br/><br/>  <span class="ash">// The PING))) is triggered by a HIGH pulse of 2 ms or more</span><br/>  <span class="ash">// Give a short LOW pulse beforehand to ensure a clean HIGH pulse:</span><br/>  <span class="orange">pinMode</span>(pingPin, <span class="green1">OUTPUT</span>);<br/>  <span class="orange">digitalWrite</span>(pingPin, <span class="green1">LOW</span>);<br/>  <span class="orange">delayMicroseconds</span>(2);<br/>  <span class="orange">digitalWrite</span>(pingPin, <span class="green1">HIGH</span>);<br/>  <span class="orange">delayMicroseconds</span>(10);<br/>  <span class="orange">digitalWrite</span>(pingPin, <span class="green1">LOW</span>);<br/><br/>  <span class="ash">// The same pin is used to read the signal from the PING))):</span><br/>  <span class="ash">// a HIGH pulse whose duration is the time (in microseconds)</span><br/>  <span class="ash">// from the sending of the ping to the reception of its echo off</span><br/>  <span class="ash">// of an object.</span><br/>  <span class="orange">pinMode</span>(inPin, <span class="green1">INPUT</span>);<br/>  duration = <span class="orange">pulseIn</span>(inPin, <span class="green1">HIGH</span>);<br/><br/>  <span class="ash">// Convert the time into a distance</span><br/>  inches = microsecondsToInches(duration);<br/>  cm = microsecondsToCentimeters(duration);<br/><span epub:type="pagebreak" id="page_113"/><br/>  lcd.<span class="orange">clear</span>();<br/>  lcd.<span class="orange">setCursor</span>(0, 0);<br/>  lcd.<span class="orange">print</span>(inches);<br/>  lcd.<span class="orange">print</span>(<span class="green1">"in, "</span>);<br/>  lcd.<span class="orange">print</span>(cm);<br/>  lcd.<span class="orange">print</span>(<span class="green1">"cm"</span>);<br/><br/>  <span class="orange">delay</span>(100);<br/>}<br/><br/><span class="green1">long</span> microsecondsToInches(<span class="green1">long</span> microseconds) {<br/>  <span class="ash">// According to Parallax's datasheet for the PING))),</span><br/>  <span class="ash">// there are 73.746 ms/in (i.e. sound travels at 1130 fps).</span><br/>  <span class="ash">// This gives the distance traveled by the ping, outbound,</span><br/>  <span class="ash">// and return, so divide by 2 to get the distance of the obstacle.</span><br/>  <span class="green2">return</span> microseconds / 74 / 2;<br/>}<br/><br/><span class="green1">long</span> microsecondsToCentimeters(<span class="green1">long</span> microseconds) {<br/>  <span class="ash">// The speed of sound is 340 m/s or 29 ms/cm.</span><br/>  <span class="ash">// The ping travels out and back, so to find the distance</span><br/>  <span class="ash">// of the object, take half of the distance traveled.</span><br/>  <span class="green2">return</span> microseconds / 29 / 2;<br/>}</p>&#13;
<h3 class="h3" id="ch00lev1sec55"><span class="voilet"><strong>TROUBLESHOOTING</strong></span></h3>&#13;
<p class="ques"><strong>Q.</strong> <em>Nothing is displayed on the LCD screen.</em></p>&#13;
<p class="bull">• Make sure you’ve connected power to the breadboard rails and the connections match the tables given earlier.</p>&#13;
<p class="bull">• Turn the potentiometer to change the contrast of the screen until you see text.</p>&#13;
<p class="bull">• If the screen has garbled messages on it, you have not wired it up correctly; recheck your wiring against <a href="ch13.xhtml#ch13fig3">Figure 13-3</a>.</p>&#13;


<h2 class="h2s" id="ch14"><span epub:type="pagebreak" id="page_114"/><strong>14<br/>Digital Thermometer</strong></h2>&#13;
<p class="intro"><span class="voilet">This project will add an LM35 temperature sensor to an LCD screen and Arduino to give you a digital thermometer.</span></p>&#13;
<div class="image"><img alt="Image" src="../images/p0114-01.jpg"/></div>&#13;
<div class="image"><span epub:type="pagebreak" id="page_115"/><img alt="Image" src="../images/p0115-01.jpg"/></div>&#13;
<p class="capv"><strong>PARTS REQUIRED</strong></p>&#13;
<p class="cap1"><strong>Arduino board</strong></p>&#13;
<p class="cap1"><strong>Breadboard</strong></p>&#13;
<p class="cap1"><strong>Jumper wires</strong></p>&#13;
<p class="cap1"><strong>HD44780 16×2 LCD screen</strong></p>&#13;
<p class="cap1"><strong>LM35 temperature sensor</strong></p>&#13;
<p class="cap1"><strong>50k-ohm potentiometer</strong></p>&#13;
<p class="capv"><strong>LIBRARY REQUIRED</strong></p>&#13;
<p class="cap1"><strong>LiquidCrystal</strong></p>&#13;
<h3 class="h3" id="ch00lev1sec56"><span epub:type="pagebreak" id="page_116"/><span class="voilet"><strong>HOW IT WORKS</strong></span></h3>&#13;
<p class="noindent">The Arduino takes the voltage reading from the same LM35 temperature sensor we used in Project 12 and converts that value to temperature in degrees Celsius. The sketch then changes this value to Fahrenheit by multiplying the value by 9, dividing the result by 5, and adding 32. The LiquidCrystal library does all the hard work in displaying the temperature on the LCD screen using the <code>lcd.print</code> command. This project can easily be adapted with more sensors for an all-around weather center.</p>&#13;
<h3 class="h3" id="ch00lev1sec57"><span class="voilet"><strong>THE BUILD</strong></span></h3>&#13;
<p class="noindent">First, prepare the LCD screen according to “<a href="ch13.xhtml#ch00lev1sec52">Preparing the LCD Screen</a>” on <a href="ch13.xhtml#page_109">page 109</a>. Then follow these steps:</p>&#13;
<ol>&#13;
<li><p class="noindents">Insert your LCD screen and potentiometer into the breadboard; then use your breadboard and jumper wires to make the connections for the LCD screen as shown in the following table.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thv" style="vertical-align: top;"><p class="tablec"><strong>LCD SCREEN</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">1 VSS</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">2 VDD</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">3 VO contrast</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Potentiometer center pin</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">4 RS</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 12</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">5 R/W</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">6 Enable</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 11</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">7 D0</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">No connection</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">8 D1</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">No connection</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">9 D2</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">No connection</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">10 D3</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">No connection</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">11 D4</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 5</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">12 D5</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 4</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">13 D6</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 3</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">14 D7</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 2</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">15 A BcL+</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">16 K BcL–</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindents"><span epub:type="pagebreak" id="page_117"/>Connect the GND and +5V rails to Arduino GND and +5V.</p></li>&#13;
<li><p class="noindents">You should have already connected the center pin of the 50k-ohm potentiometer to LCD pin 3 (VO). Now connect one of the outer pins to GND and the other to +5V.</p></li>&#13;
<li><p class="noindents">Connect the center pin of the LM35 temperature sensor to Arduino A0, the left pin to the +5V rail, and the right pin to the GND rail, as shown in the following table.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thv" style="vertical-align: top;"><p class="tablec"><strong>LM35 SENSOR</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Left</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Center</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">A0</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Right</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindents">Make sure your setup matches the circuit diagram shown in Figure 14-2, and upload the code in “<a href="ch14.xhtml#ch00lev1sec58">The Sketch</a>” on <a href="ch14.xhtml#page_118">page 118</a>.</p>&#13;
<p class="figcap"><a id="ch14fig1"/><strong>FIGURE 14-1:</strong> The circuit diagram for the digital thermometer</p>&#13;
<div class="image"><img alt="Image" src="../images/f14-01.jpg"/></div></li>&#13;
</ol>&#13;
<h3 class="h3" id="ch00lev1sec58"><span epub:type="pagebreak" id="page_118"/><span class="voilet"><strong>THE SKETCH</strong></span></h3>&#13;
<p class="noindent">The sketch uses the LiquidCrystal library to display a value on the screen according to what the LM35 sensor detects. The LM35 sensor sends a reading to Arduino pin A0, which is read as voltage. The sketch converts the voltage reading to a temperature value in Celsius, and then it uses a couple of calculations to show the final reading in Fahrenheit. The sketch updates and displays the reading every second.</p>&#13;
<p class="programs1">#include &lt;<span class="orange">LiquidCrystal</span>.h&gt; <span class="ash">// Call the LCD library</span><br/>#define sensor A0 <span class="ash">// Pin connected to LM35 sensor (A0)</span><br/><span class="green1">int</span> Vin; <span class="ash">// Reads the value from the Arduino pin</span><br/><span class="green1">float</span> Temperature; <span class="ash">// Receives the voltage value converted to temp</span><br/><span class="green1">float</span> TF; <span class="ash">// Receives the converted value in °F</span><br/><span class="orange">LiquidCrystal</span> lcd(12, 11, 5, 4, 3, 2); <span class="ash">// Pins connected the LCD</span><br/><br/><span class="green1">void</span> <span class="green2">setup</span>() {<br/>  lcd.<span class="orange">begin</span>(16, 2); <span class="ash">// The display is 16x2</span><br/>  lcd.<span class="orange">print</span>(<span class="green1">"Temperature: "</span>); <span class="ash">// Sends text to the LCD</span><br/>}<br/><br/><span class="green1">void</span> <span class="green2">loop</span>() {<br/>  <span class="ash">// Reads the A0 pin and stores the value in Vin</span><br/>  Vin = <span class="orange">analogRead</span> (sensor);<br/>  <span class="ash">// Converts voltage value to temperature and</span><br/>  <span class="ash">// stores value in Temperature (in °C)</span><br/>  Temperature = (500 * Vin) / 1023;<br/>  TF = ((9 * Temperature) / 5) + 32; <span class="ash">// Changes °C to °F</span><br/>  lcd.<span class="orange">setCursor</span>(0, 1); <span class="ash">// Move cursor of LCD to next line</span><br/>  lcd.<span class="orange">print</span>(TF); <span class="ash">// Display the temperature on the LCD screen</span><br/>  lcd.<span class="orange">print</span>(<span class="green1">" F"</span>); <span class="ash">// Write F for the Fahrenheit scale</span><br/>  <span class="orange">delay</span>(1000); <span class="ash">// Wait for a second before reading the pin again</span><br/>}</p>&#13;
<h3 class="h3" id="ch00lev1sec59"><span class="voilet"><strong>TROUBLESHOOTING</strong></span></h3>&#13;
<p class="ques"><strong>Q.</strong> <em>Nothing is displayed on the LCD screen.</em></p>&#13;
<p class="bull">• Make sure you’ve connected power to the breadboard rails and that the connections match the tables given earlier.</p>&#13;
<p class="bull">• Turn the potentiometer to change the contrast of the screen until you see text.</p>&#13;
<p class="bull">• If the screen has garbled messages on it, you probably haven’t wired it up correctly; recheck your wiring against Figure 14-2.</p>&#13;
<p class="bull">• If the value shown seems too high, make sure the LM35 sensor is firmly inserted in the breadboard and allow a moment for the reading to stabilize.</p>&#13;


<h2 class="h2s" id="ch15"><span epub:type="pagebreak" id="page_119"/><strong>15<br/>Bomb Decoder Game</strong></h2>&#13;
<p class="intro"><span class="voilet">In this project we’ll build a code-breaking bomb-decoding game. We’ll use an LCD screen and a keypad to give the players instructions and take input.</span></p>&#13;
<div class="image"><img alt="Image" src="../images/p0119-01.jpg"/></div>&#13;
<div class="image"><span epub:type="pagebreak" id="page_120"/><img alt="Image" src="../images/p0120-01.jpg"/></div>&#13;
<p class="capv"><strong>PARTS REQUIRED</strong></p>&#13;
<p class="cap1"><strong>Arduino board</strong></p>&#13;
<p class="cap1"><strong>Breadboard</strong></p>&#13;
<p class="cap1"><strong>Jumper wires</strong></p>&#13;
<p class="cap1"><strong>HD44780 16×2 LCD screen</strong></p>&#13;
<p class="cap1"><strong>10k-ohm potentiometer</strong></p>&#13;
<p class="cap1"><strong>Piezo sounder</strong></p>&#13;
<p class="cap1"><strong>3×4 membrane keypad</strong></p>&#13;
<p class="cap1"><strong>3 220-ohm resistors</strong></p>&#13;
<p class="cap1"><strong>Red LED</strong></p>&#13;
<p class="cap1"><strong>Yellow LED</strong></p>&#13;
<p class="cap1"><strong>Green LED</strong></p>&#13;
<p class="capv"><strong>LIBRARIES REQUIRED</strong></p>&#13;
<p class="cap1"><strong>LiquidCrystal</strong></p>&#13;
<p class="cap1"><strong>Keypad</strong></p>&#13;
<p class="cap1"><strong>Tone</strong></p>&#13;
<h3 class="h3" id="ch00lev1sec60"><span epub:type="pagebreak" id="page_121"/><span class="voilet"><strong>HOW IT WORKS</strong></span></h3>&#13;
<p class="noindent">When you power up the Arduino, one player enters a four-digit code to start the bomb timer. They give the timer to another player, who presses the * button to begin decoding the bomb—this player (the “defuser”) must crack the code entered by the first player to defuse the bomb in time. If the defuser presses a wrong key, they can press # to delete their input and start again. If they enter the wrong code or the timer reaches zero, the bomb detonates and they lose.</p>&#13;
<p class="indent">During the game, the yellow LED flashes and the piezo sounder beeps in time to the countdown. The LCD screen displays the countdown and code input. When the bomb detonates, all the LEDs flash and the piezo sounds an explosion.</p>&#13;
<p class="indent">A good way to take this game further would be to ask the defuser four questions, each giving the defuser one digit of the bomb code. The defuser has a set time to answer the questions and input the four-digit code. Answer incorrectly or too late, and the bomb explodes!</p>&#13;
<h3 class="h3" id="ch00lev1sec61"><span class="voilet"><strong>THE BUILD</strong></span></h3>&#13;
<ol>&#13;
<li><p class="noindents">If required, prepare the LCD screen by soldering the header pins as described in “<a href="ch13.xhtml#ch00lev1sec52">Preparing the LCD Screen</a>” on <a href="ch13.xhtml#page_109">page 109</a>.</p></li>&#13;
<li><p class="noindents">Place your LCD screen in the breadboard, inserting the header pins into the breadboard holes. Also place the potentiometer in the breadboard, and use the breadboard and jumper wires to connect your LCD screen, Arduino, and potentiometer as shown in the following table. There are multiple GND connections, so use the breadboard rail to make those connections to the Arduino GND pin.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thv" style="vertical-align: top;"><p class="tablec"><strong>LCD SCREEN</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">1 VSS</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">2 VDD</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">3 VO contrast</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Potentiometer center pin</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">4 RS</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 7</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">5 R/W</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">6 Enable</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 8</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">7 D0</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">No connection</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><span epub:type="pagebreak" id="page_122"/><p class="tablec"><span class="voilet">8 D1</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">No connection</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">9 D2</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">No connection</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">10 D3</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">No connection</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">11 D4</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 10</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">12 D5</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 11</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">13 D6</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 12</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">14 D7</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 13</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">15 A BcL+</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">16 K BcL–</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindents">You should have already connected the center pin of the 10k-ohm potentiometer to LCD pin 3 (VO). Now connect one of the outer pins to GND and the other to +5V, as shown in <a href="ch15.xhtml#ch15fig1">Figure 15-1</a>. This controls the contrast of your LCD screen.</p>&#13;
<p class="figcap"><a id="ch15fig1"/><strong>FIGURE 15-1:</strong> The potentiometer controls the contrast of your LCD screen.</p>&#13;
<div class="image"><img alt="Image" src="../images/f15-01.jpg"/></div></li>&#13;
<li><p class="noindents">Looking at the keypad head-on, as in <a href="ch15.xhtml#ch15fig2">Figure 15-2</a>, the pins are numbered 1–7 from left to right. Connect the keypad pins as shown in the following table.</p>&#13;
<p class="figcap"><span epub:type="pagebreak" id="page_123"/><a id="ch15fig2"/><strong>FIGURE 15-2:</strong> The 3×4 numeric keypad with seven pin connections</p>&#13;
<div class="image"><img alt="Image" src="../images/f15-02.jpg"/></div>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thv" style="vertical-align: top;"><p class="tablec"><strong>KEYPAD</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 1</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 5</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 2</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin A5</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 3</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin A4</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 4</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin A2</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 5</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin A1</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 6</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin A0</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 7</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin A3</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindents">Connect the piezo sounder’s red wire directly to Arduino pin 9 and its black wire to Arduino GND.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thv" style="vertical-align: top;"><p class="tablec"><strong>PIEZO SOUNDER</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Red wire</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 9</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Black wire</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindents"><span epub:type="pagebreak" id="page_124"/>Place the green LED in the breadboard, connecting the short, negative leg to the negative breadboard rail via a 220-ohm resistor. Connect the green LED’s long, positive leg to pin 2. Do the same with the yellow LED to pin 3 and the red LED to pin 4, as shown in <a href="ch15.xhtml#ch15fig3">Figure 15-3</a> and the table that follows.</p>&#13;
<p class="figcap"><a id="ch15fig3"/><strong>FIGURE 15-3:</strong> Connect the LEDs to the Arduino via a 220-ohm resistor.</p>&#13;
<div class="image"><img alt="Image" src="../images/f15-03.jpg"/></div>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thv" style="vertical-align: top;"><p class="tablec"><strong>LEDS</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Negative legs</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Green positive leg</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 2 via 220-ohm resistor</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Yellow positive leg</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 3 via 220-ohm resistor</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Red positive leg</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 4 via 220-ohm resistor</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindents">Connect the positive and negative breadboard power rails to +5V and GND, respectively.</p></li>&#13;
<li><p class="noindents">Make sure your completed project circuit matches <a href="ch15.xhtml#ch15fig4">Figure 15-4</a>, remember to add the required libraries to your <em>Libraries</em> folder, and then upload the code in “<a href="ch15.xhtml#ch00lev1sec63">The Sketch</a>” on <a href="ch15.xhtml#page_127">page 127</a>.</p>&#13;
<p class="figcap"><span epub:type="pagebreak" id="page_125"/><a id="ch15fig4"/><strong>FIGURE 15-4:</strong> The circuit diagram for the bomb decoder game</p>&#13;
<div class="image"><img alt="Image" src="../images/f15-04.jpg"/></div></li>&#13;
</ol>&#13;
<h3 class="h3" id="ch00lev1sec62"><span epub:type="pagebreak" id="page_126"/><span class="voilet"><strong>PLAYING THE GAME</strong></span></h3>&#13;
<p class="noindent"><a href="ch15.xhtml#ch15fig5">Figure 15-5</a> shows the different stages of playing the game.</p>&#13;
<p class="figcap"><a id="ch15fig5"/><strong>FIGURE 15-5:</strong> Playing the game</p>&#13;
<div class="image"><img alt="Image" src="../images/f15-05.jpg"/></div>&#13;
<ol>&#13;
<li><p class="noindents">Enter the code to set up the bomb.</p></li>&#13;
<li><p class="noindents">The bomb confirms the code entered.</p></li>&#13;
<li><p class="noindents">The timer starts the countdown sequence.</p></li>&#13;
<li><p class="noindents">The yellow LED flashes in time to the countdown.</p></li>&#13;
<li><p class="noindents">Pass the keypad to another player (the defuser). They press the * button on the keypad, then enter the defuse code.</p></li>&#13;
<li><p class="noindents">The screen does not show the numbers entered to defuse the bomb.</p></li>&#13;
<li><p class="noindents">If the correct code is entered, the bomb is defused . . .</p></li>&#13;
<li><p class="noindents">. . . but if not . . . Boom!</p></li>&#13;
</ol>&#13;
<div class="noter">&#13;
<p class="notet"><span epub:type="pagebreak" id="page_127"/><strong>NOTE</strong></p>&#13;
<p class="notep"><em>All libraries and code can be downloaded from</em> <a href="https://www.nostarch.com/arduinohandbook2/">https://www.nostarch.com/arduinohandbook2/</a>.</p>&#13;
</div>&#13;
<h3 class="h3" id="ch00lev1sec63"><span class="voilet"><strong>THE SKETCH</strong></span></h3>&#13;
<p class="noindent">The sketch calls on the Keypad, LiquidCrystal, and Tone libraries. LiquidCrystal is included in your IDE, but you’ll have to download Keypad and Tone from the book’s resources at <em><a href="https://www.nostarch.com/arduinohandbook2/">https://www.nostarch.com/arduinohandbook2/</a></em> and save them in your <em>Libraries</em> folder for the Arduino (see the primer for details on how to do that if you’re unsure).</p>&#13;
<p class="indent">First the sketch defines the timer duration, password length, LED pins, and keypad. It requests a code input from the first player by displaying “Enter Code:” and then stores that value as the bomb defusal code. When the second player (the defuser) presses *, the timer starts and waits for a code to be entered, and the yellow LED flashes in time to the countdown. If the code the defuser enters does not match the defusal code, the text “The Bomb Has Exploded!” displays on the screen and the LEDs and piezo indicate an explosion. If the defuser’s input is correct, the timer stops, the green LED lights, and the message “Bomb Defused” displays on the screen. The bomb will also explode if the timer reaches zero with no input. When the game ends, the code resets, ready for another game.</p>&#13;
<p class="programs1"><span class="ash">// Original code by Joey Meyer and Chase Cooley</span><br/><span class="ash">// and used with kind permission</span><br/><br/>#include &lt;Keypad.h&gt;<br/>#include &lt;<span class="orange">LiquidCrystal</span>.h&gt;<br/>#include &lt;Tone.h&gt;<br/><br/>Tone tone1;<br/><br/><span class="green1">int</span> Scount = 10; <span class="ash">// Change this to the number of seconds to start from</span><br/><span class="green1">int</span> Mcount = 5;  <span class="ash">// Change this to the number of minutes to start from</span><br/><span class="green1">int</span> Hcount = 0;  <span class="ash">// Count hours</span><br/><span class="green1">int</span> DefuseTimer = 0; <span class="ash">// Set timer to 0</span><br/><br/><span class="green1">long</span> secMillis = 0; <span class="ash">// Store last time for second add</span><br/><span class="green1">long</span> interval = 1000; <span class="ash">// Interval for seconds</span><br/><br/><span class="green1">char</span> password[4]; <span class="ash">// Number of characters in password</span><br/><span class="green1">int</span> currentLength = 0; <span class="ash">// Defines number currently writing</span><br/><span class="green1">int</span> i = 0;<br/><span class="green1">char</span> entered[4];<br/><br/><span class="green1">int</span> ledPin = 4;  <span class="ash">// Red LED</span><br/><span class="green1">int</span> ledPin2 = 3; <span class="ash">// Yellow LED</span><br/><span class="green1">int</span> ledPin3 = 2; <span class="ash">// Green LED</span><br/><span class="ash"><span epub:type="pagebreak" id="page_128"/>// The pins we use on the LCD</span><br/><span class="orange">LiquidCrystal</span> lcd(7, 8, 10, 11, 12, 13);<br/><br/><span class="green1">const byte</span> ROWS = 4; <span class="ash">// Four rows</span><br/><span class="green1">const byte</span> COLS = 3; <span class="ash">// Three columns</span><br/><span class="green1">char</span> keys[ROWS][COLS] = {<br/>  {<span class="green1">'1'</span>, <span class="green1">'2</span>', <span class="green1">'3</span>'},<br/>  {<span class="green1">'4'</span>, <span class="green1">'5</span>', <span class="green1">'6</span>'},<br/>  {<span class="green1">'7'</span>, <span class="green1">'8</span>', <span class="green1">'9</span>'},<br/>  {<span class="green1">'*'</span>, <span class="green1">'0</span>', <span class="green1">'#</span>'}<br/>};<br/><span class="green1">byte</span> rowPins[ROWS] = {5, A5, A4, A2}; <span class="ash">// Connect to the row pinouts</span><br/>                                      <span class="ash">// of the keypad</span><br/><span class="green1">byte</span> colPins[COLS] = {A1, A0, A3}; <span class="ash">// Connect to the column pinouts</span><br/>                                   <span class="ash">// of the keypad</span><br/><br/>Keypad keypad = Keypad(makeKeymap(keys), rowPins, colPins, ROWS, COLS);<br/><br/><span class="green1">void</span> <span class="green2">setup</span>() {<br/>  <span class="orange">pinMode</span>(ledPin, <span class="green1">OUTPUT</span>);  <span class="ash">// Sets the digital pin as output</span><br/>  <span class="orange">pinMode</span>(ledPin2, <span class="green1">OUTPUT</span>); <span class="ash">// Sets the digital pin as output</span><br/>  <span class="orange">pinMode</span>(ledPin3, <span class="green1">OUTPUT</span>); <span class="ash">// Sets the digital pin as output</span><br/>  tone1.<span class="orange">begin</span>(9);<br/>  lcd.<span class="orange">begin</span>(16, 2);<br/>  <span class="orange">Serial</span>.<span class="orange">begin</span>(9600);<br/>  lcd.<span class="orange">clear</span>();<br/>  lcd.<span class="orange">setCursor</span>(0,0);<br/>  lcd.<span class="orange">print</span>(<span class="green1">"Enter Code: "</span>);<br/>  <span class="green2">while</span> (currentLength &lt; 4) {<br/>    lcd.<span class="orange">setCursor</span>(currentLength + 6, 1);<br/>    lcd.<span class="orange">cursor</span>();<br/>    <span class="green1">char</span> key = keypad.getKey();<br/>    key == NO_KEY;<br/>    <span class="green2">if</span> (key != NO_KEY) {<br/>      <span class="green2">if</span> ((key != <span class="green1">'*'</span>)&amp;&amp;(key != <span class="green1">'#'</span>)) {<br/>        lcd.<span class="orange">print</span>(key);<br/>        password[currentLength] = key;<br/>        currentLength++;<br/>        tone1.play(NOTE_C6, 200);<br/>      }<br/>    }<br/>  }<br/><br/>  <span class="green2">if</span> (currentLength == 4) {<br/>    <span class="orange">delay</span>(500);<br/>    lcd.<span class="orange">noCursor</span>();<br/>    lcd.<span class="orange">clear</span>();<br/>    lcd.<span class="orange">home</span>();<br/>    lcd.<span class="orange">print</span>(<span class="green1">"You've Entered: "</span>);<br/>    lcd.<span class="orange">setCursor</span>(6, 1);<br/>    lcd.<span class="orange">print</span>(password[0]);<br/>    lcd.<span class="orange">print</span>(password[1]);<br/>    lcd.<span class="orange">print</span>(password[2]);<br/><span epub:type="pagebreak" id="page_129"/>    lcd.<span class="orange">print</span>(password[3]);<br/>    tone1.play(NOTE_E6, 200);<br/>    <span class="orange">delay</span>(3000);<br/>    lcd.<span class="orange">clear</span>();<br/>    currentLength = 0;<br/>  }<br/>}<br/><br/><span class="green1">void</span> <span class="green2">loop</span>() {<br/>  timer();<br/>  <span class="green1">char</span> key2 = keypad.getKey(); <span class="ash">// Get the key</span><br/>  <span class="green2">if</span> (key2 == <span class="green1">'*'</span>) {<br/>    lcd.<span class="orange">clear</span>();<br/>    lcd.<span class="orange">setCursor</span>(0, 0);<br/>    lcd.<span class="orange">print</span>(<span class="green1">"Code: "</span>);<br/>    <span class="green2">while</span> (currentLength &lt; 4) {<br/>      timer();<br/>      <span class="green1">char</span> key2 = keypad.getKey();<br/>      <span class="green2">if</span> (key2 == <span class="green1">'#'</span>) {<br/>        currentLength = 0;<br/>        lcd.<span class="orange">clear</span>();<br/>        lcd.<span class="orange">setCursor</span>(0, 0);<br/>        lcd.<span class="orange">print</span>(<span class="green1">"Code: "</span>);<br/>      }<br/>      <span class="green2">else if</span> (key2 != NO_KEY) {<br/>        lcd.<span class="orange">setCursor</span>(currentLength + 7, 0);<br/>        lcd.<span class="orange">cursor</span>();<br/>        lcd.<span class="orange">print</span>(key2);<br/>        entered[currentLength] = key2;<br/>        currentLength++;<br/>        tone1.play(NOTE_C6, 200);<br/>        <span class="orange">delay</span>(100);<br/>        lcd.<span class="orange">noCursor</span>();<br/>        lcd.<span class="orange">setCursor</span>(currentLength + 6, 0);<br/>        lcd.<span class="orange">print</span>(<span class="green1">"*"</span>);<br/>        lcd.<span class="orange">setCursor</span>(currentLength + 7, 0);<br/>        lcd.<span class="orange">cursor</span>();<br/>      }<br/>    }<br/>    <span class="green2">if</span> (currentLength == 4) {<br/>      <span class="green2">if</span> (entered[0] == password[0] &amp;&amp; entered[1] == password[1] &amp;&amp; entered[2] == password[2] &amp;&amp;entered[3] == password[3]) {<br/>        lcd.<span class="orange">noCursor</span>();<br/>        lcd.<span class="orange">clear</span>();<br/>        lcd.<span class="orange">home</span>();<br/>        lcd.<span class="orange">print</span>(<span class="green1">"Bomb Defused"</span>);<br/>        currentLength = 0;<br/>        <span class="orange">digitalWrite</span>(ledPin3, <span class="green1">HIGH</span>);<br/>        <span class="orange">delay</span>(2500);<br/>        lcd.<span class="orange">setCursor</span>(0, 1);<br/>        lcd.<span class="orange">print</span>(<span class="green1">"Reset the Bomb"</span>);<br/>        <span class="orange">delay</span>(1000000);<br/>      }<br/><span epub:type="pagebreak" id="page_130"/><br/>      <span class="green2">else</span> {<br/>        lcd.<span class="orange">noCursor</span>();<br/>        lcd.<span class="orange">clear</span>();<br/>        lcd.<span class="orange">home</span>();<br/>        lcd.<span class="orange">print</span>(<span class="green1">"Wrong Password!"</span>);<br/>        <span class="green2">if</span> (Hcount &gt; 0) {<br/>          Hcount = Hcount - 1;<br/>        }<br/>        <span class="green2">if</span> (Mcount &gt; 0) {<br/>          Mcount = Mcount - 59;<br/>        }<br/>        <span class="green2">if</span> (Scount &gt; 0) {<br/>          Scount = Scount - 59;<br/>        }<br/>        <span class="orange">delay</span>(1500);<br/>        currentLength = 0;<br/>      }<br/>    }<br/>  }<br/>}<br/><br/><span class="green1">void</span> timer() {<br/>  <span class="orange">Serial</span>.<span class="orange">print</span>(Scount);<br/>  <span class="orange">Serial</span>.<span class="orange">println</span>();<br/>  <span class="green2">if</span> (Hcount &lt;= 0) { <span class="ash">// If timer reaches 0, LCD displays explosion</span><br/>    <span class="green2">if</span> ( Mcount &lt; 0 ) {<br/>      lcd.<span class="orange">noCursor</span>();<br/>      lcd.<span class="orange">clear</span>();<br/>      lcd.<span class="orange">home</span>();<br/>      lcd.<span class="orange">print</span>(<span class="green1">"The Bomb Has "</span>);<br/>      lcd.<span class="orange">setCursor</span>(0, 1);<br/>      lcd.<span class="orange">print</span>(<span class="green1">"Exploded!"</span>);<br/>      <span class="green2">while</span> (Mcount &lt; 0) {<br/>        <span class="orange">digitalWrite</span>(ledPin, <span class="green1">HIGH</span>); <span class="ash">// Sets the LED on</span><br/>        tone1.play(NOTE_A2, 90);<br/>        <span class="orange">delay</span>(100);<br/>        <span class="orange">digitalWrite</span>(ledPin, <span class="green1">LOW</span>); <span class="ash">// Sets the LED off</span><br/>        tone1.play(NOTE_A2, 90);<br/>        <span class="orange">delay</span>(100);<br/>        <span class="orange">digitalWrite</span>(ledPin2, <span class="green1">HIGH</span>); <span class="ash">// Sets the LED on</span><br/>        tone1.play(NOTE_A2, 90);<br/>        <span class="orange">delay</span>(100);<br/>        <span class="orange">digitalWrite</span>(ledPin2, <span class="green1">LOW</span>); <span class="ash">// Sets the LED off</span><br/>        tone1.play(NOTE_A2, 90);<br/>        <span class="orange">delay</span>(100);<br/>        <span class="orange">digitalWrite</span>(ledPin3, <span class="green1">HIGH</span>); <span class="ash">// Sets the LED on</span><br/>        tone1.play(NOTE_A2, 90);<br/>        <span class="orange">delay</span>(100);<br/>        <span class="orange">digitalWrite</span>(ledPin3, <span class="green1">LOW</span>); <span class="ash">// Sets the LED off</span><br/>        tone1.play(NOTE_A2, 90);<br/>        <span class="orange">delay</span>(100);<br/>      }<br/>    }<br/>  }<br/><span epub:type="pagebreak" id="page_131"/><br/>  lcd.<span class="orange">setCursor</span>(0, 1); <span class="ash">// Sets cursor to 2nd line</span><br/>  lcd.<span class="orange">print</span>(<span class="green1">"Timer:"</span>);<br/><br/>  <span class="green2">if</span> (Hcount &gt;= 10) {<br/>    lcd.<span class="orange">setCursor</span>(7, 1);<br/>    lcd.<span class="orange">print</span>(Hcount);<br/>  }<br/>  <span class="green2">if</span> (Hcount &lt; 10) {<br/>    lcd.<span class="orange">setCursor</span>(7, 1);<br/>    lcd.<span class="orange">write</span>(<span class="green1">"0"</span>);<br/>    lcd.<span class="orange">setCursor</span>(8, 1);<br/>    lcd.<span class="orange">print</span>(Hcount);<br/>  }<br/><br/>  lcd.<span class="orange">print</span>(<span class="green1">":"</span>);<br/><br/>  <span class="green2">if</span> (Mcount &gt;= 10) {<br/>    lcd.<span class="orange">setCursor</span>(10, 1);<br/>    lcd.<span class="orange">print</span>(Mcount);<br/>  }<br/>  <span class="green2">if</span> (Mcount &lt; 10) {<br/>    lcd.<span class="orange">setCursor</span>(10, 1);<br/>    lcd.<span class="orange">write</span>(<span class="green1">"0"</span>);<br/>    lcd.<span class="orange">setCursor</span>(11, 1);<br/>    lcd.<span class="orange">print</span>(Mcount);<br/>  }<br/><br/>  lcd.<span class="orange">print</span> (<span class="green1">":"</span>);<br/><br/>  <span class="green2">if</span> (Scount &gt;= 10) {<br/>    lcd.<span class="orange">setCursor</span>(13, 1);<br/>    lcd.<span class="orange">print</span>(Scount);<br/>  }<br/>  <span class="green2">if</span> (Scount &lt; 10) {<br/>    lcd.<span class="orange">setCursor</span>(13, 1);<br/>    lcd.<span class="orange">write</span>(<span class="green1">"0"</span>);<br/>    lcd.<span class="orange">setCursor</span>(14, 1);<br/>    lcd.<span class="orange">print</span>(Scount);<br/>  }<br/><br/>  <span class="green2">if</span> (Hcount &lt; 0) {<br/>    Hcount = 0;<br/>  }<br/><br/>  <span class="green2">if</span> (Mcount &lt; 0) {<br/>    Hcount --;<br/>    Mcount = 59;<br/>  }<br/><br/>  <span class="green2">if</span> (Scount &lt; 1) { <span class="ash">// If 60 do this operation</span><br/>    Mcount --; <span class="ash">// Add 1 to Mcount</span><br/>    Scount = 59; <span class="ash">// Reset Scount</span><br/>  }<br/><span epub:type="pagebreak" id="page_132"/><br/>  <span class="green2">if</span> (Scount &gt; 0) { <span class="ash">// Do this operation 59 times</span><br/>    <span class="green1">unsigned long</span> currentMillis = <span class="orange">millis</span>();<br/>    <span class="green2">if</span> (currentMillis - secMillis &gt; interval) {<br/>      tone1.play(NOTE_G5, 200);<br/>      secMillis = currentMillis;<br/>      Scount --; <span class="ash">// Add 1 to Scount</span><br/>      <span class="orange">digitalWrite</span>(ledPin2, <span class="green1">HIGH</span>); <span class="ash">// Sets the LED on</span><br/>      <span class="orange">delay</span>(10); <span class="ash">// Waits for a second</span><br/>      <span class="orange">digitalWrite</span>(ledPin2, <span class="green1">LOW</span>); <span class="ash">// Sets the LED off</span><br/>      <span class="orange">delay</span>(10); <span class="ash">// Waits for a second</span><br/>    }<br/>  }<br/>}</p>&#13;
<h3 class="h3" id="ch00lev1sec64"><span class="voilet"><strong>TROUBLESHOOTING</strong></span></h3>&#13;
<p class="ques"><strong>Q.</strong> <em>Nothing is displayed on the LCD screen.</em></p>&#13;
<p class="bull">• Make sure you’ve connected power to the breadboard rails and the connections match the tables in this chapter.</p>&#13;
<p class="bull">• Turn the potentiometer to change the contrast of the screen until you see text.</p>&#13;
<p class="bull">• If the screen has garbled messages on it, you haven’t wired it up correctly; recheck your wiring against the circuit diagram in <a href="ch15.xhtml#ch15fig4">Figure 15-4</a>.</p>&#13;
<p class="ques"><strong>Q.</strong> <em>The LEDs do not light when expected.</em></p>&#13;
<p class="bull">• Check your wiring against the circuit diagram in <a href="ch15.xhtml#ch15fig4">Figure 15-4</a> and ensure that the short leg of the LED is connected to the ground rail of the breadboard.</p>&#13;
<p class="bull">• It’s easy to forget to add power to the breadboard rails, so make sure you connect the ground and power rails on either side of the breadboard to the Arduino with a jumper wire.</p>&#13;
<p class="bull">• Check that your LEDs and resistors are firmly inserted into the breadboard and they line up with one another.</p>&#13;
<p class="bull">• If the wrong LED lights up, you’ve probably connected to the wrong pin numbers by mistake, so just change them around.</p>&#13;
<p class="ques"><strong>Q.</strong> <em>The piezo sounder does not make a noise.</em></p>&#13;
<p class="bull">• The positive red wire of the sounder should be connected to pin 9 and the black ground wire to GND. If the sounder does still not make a noise, try replacing it with another one.</p>&#13;
<p class="ques"><span epub:type="pagebreak" id="page_133"/><strong>Q.</strong> <em>When the keypad is pressed, the numbers are incorrect or do not register.</em></p>&#13;
<p class="bull">• Make sure the connections of the keypad to the Arduino match the circuit diagram in <a href="ch15.xhtml#ch15fig4">Figure 15-4</a> exactly.</p>&#13;
<p class="bull">• The configuration is set up specifically for this project’s 3×4 numeric keypad, so if your keypad is different, check the data sheet to find out which pins you need to connect.</p>&#13;


<h2 class="h2s" id="ch16"><span epub:type="pagebreak" id="page_134"/><strong>16<br/>Serial LCD Screen</strong></h2>&#13;
<p class="intro"><span class="voilet">In this project we’ll take a 16×2 character LCD screen and a serial module to create a serial LCD that’s controlled by only two wires.</span></p>&#13;
<div class="image"><img alt="Image" src="../images/p0134-01.jpg"/></div>&#13;
<div class="image"><span epub:type="pagebreak" id="page_135"/><img alt="Image" src="../images/p0135-01.jpg"/></div>&#13;
<p class="capv"><strong>PARTS REQUIRED</strong></p>&#13;
<p class="cap1"><strong>Arduino board</strong></p>&#13;
<p class="cap1"><strong>Female-to-male jumper wires</strong></p>&#13;
<p class="cap1"><strong>HD44780 16×2 LCD screen</strong></p>&#13;
<p class="cap1"><strong>Serial LCD screen module</strong></p>&#13;
<p class="capv"><strong>LIBRARIES REQUIRED</strong></p>&#13;
<p class="cap1"><strong>Wire</strong></p>&#13;
<p class="cap1"><strong>LiquidCrystal_I2C</strong></p>&#13;
<h3 class="h3" id="ch00lev1sec65"><span epub:type="pagebreak" id="page_136"/><span class="voilet"><strong>HOW IT WORKS</strong></span></h3>&#13;
<p class="noindent">LCD screens are very useful in projects, but they use up a lot of pins on the Arduino. This means that if you’re incorporating them into a more complex project, you might run out of pins. Thankfully there is a solution: use a <em>serial</em> LCD screen. Serial LCDs use the communication protocol <em>I2C</em>, which stands for <em>Inter-Integrated Circuit</em>, and differ from normal 16×2 LCD screens in that they can be controlled by your Arduino with only power and two pins.</p>&#13;
<p class="indent">Serial LCD screens usually come in kit form and require you to solder header pins, which I’ll cover later in the chapter. You’ll usually receive the 16×2 LCD screen and the serial module separately, as shown in <a href="ch16.xhtml#ch16fig1">Figure 16-1</a>.</p>&#13;
<p class="figcap"><a id="ch16fig1"/><strong>FIGURE 16-1:</strong> 16×2 LCD screen and serial module</p>&#13;
<div class="image"><img alt="Image" src="../images/f16-01.jpg"/></div>&#13;
<h3 class="h3" id="ch00lev1sec66"><span class="voilet"><strong>PREPARING THE SERIAL LCD SCREEN</strong></span></h3>&#13;
<ol>&#13;
<li><p class="noindents">The serial module has a strip of 16 header pins already attached to one side. Turn the LCD screen over and you’ll see 16 corresponding holes, as shown in <a href="ch16.xhtml#ch16fig2">Figure 16-2</a>.</p>&#13;
<p class="figcap"><a id="ch16fig2"/><strong>FIGURE 16-2:</strong> The reverse side of the LCD screen</p>&#13;
<div class="image"><img alt="Image" src="../images/f16-02.jpg"/></div></li>&#13;
<li><p class="noindents"><span epub:type="pagebreak" id="page_137"/>Place the serial controller header pins into those holes, as shown in <a href="ch16.xhtml#ch16fig3">Figure 16-3</a>.</p>&#13;
<p class="figcap"><a id="ch16fig3"/><strong>FIGURE 16-3:</strong> Insert the serial module into the LCD screen holes.</p>&#13;
<div class="image"><img alt="Image" src="../images/f16-03.jpg"/></div></li>&#13;
<li><p class="noindents">Carefully add a small amount of solder to each of the pins to make a connection and hold the serial monitor to the screen. Turn to the primer for a quick soldering guide.</p></li>&#13;
</ol>&#13;
<h3 class="h3" id="ch00lev1sec67"><span class="voilet"><strong>THE BUILD</strong></span></h3>&#13;
<p class="noindent">Your serial LCD screen has an assigned address that your Arduino needs in order to communicate with it. The addresses differ depending on the make, so you need to check the address of your specific screen, as you’ll need it for the sketch later. To check the address, connect the LCD screen to your Arduino and run a quick sketch to scan the module—or you could also refer to the data sheet for your screen.</p>&#13;
<ol>&#13;
<li><p class="noindents">Connect your female-to-male jumper wires to the four pins on the controller for the LCD screen.</p></li>&#13;
<li><p class="noindents">Wire up the serial LCD screen to the Arduino with GND to GND, VCC to +5V, SDA to Arduino pin A4, and SCL to Arduino pin A5, as shown in the following table and the circuit diagram in <a href="ch16.xhtml#ch16fig4">Figure 16-4</a>.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thv" style="vertical-align: top;"><p class="tablec"><strong>SERIAL LCD SCREEN</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">VCC</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">SDA</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin A4 (SDA)</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">SCL</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin A5 (SCL)</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<p class="figcap"><span epub:type="pagebreak" id="page_138"/><a id="ch16fig4"/><strong>FIGURE 16-4:</strong> The circuit diagram for the serial LCD screen</p>&#13;
<div class="image"><img alt="Image" src="../images/f16-04.jpg"/></div></li>&#13;
<li><p class="noindents">Upload the following sketch to the Arduino. We’ll get the address in <em>hexadecimal</em>, a number system that uses letters and numbers in an abbreviated form to represent a much larger number.</p>&#13;
<p class="programs1">#include &lt;<span class="orange">Wire</span>.h&gt;<br/><span class="green1">void</span> <span class="green2">setup</span>() {<br/>  <span class="orange">Wire</span>.<span class="orange">begin</span>();<br/>  <span class="orange">Serial</span>.<span class="orange">begin</span>(9600);<br/>  <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"I2C Scanner"</span>);<br/>}<br/><span class="green1">void</span> <span class="green2">loop</span>() {<br/>  <span class="green1">byte</span> error, address;<br/>  <span class="green1">int</span> nDevices;<br/>  <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"Scanning..."</span>);<br/>  nDevices = 0;<br/>  <span class="green2">for</span> (address = 1; address &lt; 127; address++)  {<br/>    <span class="orange">Wire</span>.<span class="orange">beginTransmission</span>(address);<br/>    error = <span class="orange">Wire</span>.<span class="orange">endTransmission</span>();<br/>    <span class="green2">if</span> (error == 0) {<br/>      <span class="orange">Serial</span>.<span class="orange">print</span>(<span class="green1">"I2C device found at address 0x"</span>);<br/>      <span class="green2">if</span> (address &lt; 16)<br/>        <span class="orange">Serial</span>.<span class="orange">print</span>(<span class="green1">"0"</span>);<br/>      <span class="orange">Serial</span>.<span class="orange">print</span>(address, <span class="green1">HEX</span>);<br/>      <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">" !"</span>);<br/>      nDevices++;<br/>    }<br/>    <span class="green2">else if</span> (error == 4) {<br/>      <span class="orange">Serial</span>.<span class="orange">print</span>(<span class="green1">"Unknown error at address 0x"</span>);<br/>      <span class="green2">if</span> (address &lt; 16)<br/>        <span class="orange">Serial</span>.<span class="orange">print</span>(<span class="green1">"0"</span>);<br/>      <span class="orange">Serial</span>.<span class="orange">println</span>(address, <span class="green1">HEX</span>);<br/>    }<br/>  }<br/>  <span class="green2">if</span> (nDevices == 0)<br/>    <span class="orange">Serial</span>.<span class="orange">println</span>(<span class="green1">"No I2C devices found\n"</span>);<br/>  <span class="green2">else</span><br/>    <span class="orange">Serial</span>.println(<span class="green1">"done\n"</span>);<br/>  <span class="orange">delay</span>(5000); <span class="ash">// Wait 5 seconds for next scan</span><br/>}</p></li>&#13;
</ol>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_139"/>The sketch scans for all addresses on the Arduino’s I2C bus and displays the output in the Serial Monitor, as shown in <a href="ch16.xhtml#ch16fig5">Figure 16-5</a>.</p>&#13;
<p class="figcap"><a id="ch16fig5"/><strong>FIGURE 16-5:</strong> The hexadecimal number of your module will be shown in the IDE Serial Monitor.</p>&#13;
<div class="image"><img alt="Image" src="../images/f16-05.jpg"/></div>&#13;
<p class="indent">The address is the number that comes after the 0x. In my case that is 27, so I need to make a note of 0x27. You’ll use this address in the final sketch.</p>&#13;
<h3 class="h3" id="ch00lev1sec68"><span class="voilet"><strong>THE SKETCH</strong></span></h3>&#13;
<p class="noindent">This sketch calls on the Wire and LiquidCrystal_I2C libraries. The Wire library is included in the Arduino IDE, but you will need to install the LiquidCrystal_I2C library by downloading it from <em><a href="https://www.nostarch.com/arduinohandbook2/">https://www.nostarch.com/arduinohandbook2/</a></em>. The libraries allow the Arduino to control the module using serial communication via just the SDA and SCL pins.</p>&#13;
<p class="indent">Change the code at <span class="ent">➊</span> so that the <code>0x27</code> is replaced with the address you just noted from your scan in the test sketch.</p>&#13;
<p class="programs1">#include &lt;<span class="orange">Wire</span>.h&gt; <span class="ash">// Call the wire library</span><br/>#include &lt;LiquidCrystal_I2C.h&gt; <span class="ash">// Call the I2C library</span><br/>LiquidCrystal_I2C lcd(0x27<span class="ent">➊</span>,16,2); <span class="ash">// Set LCD address to 0x27 for a</span><br/>                                    <span class="ash">// 16-character and 2-line display</span><br/><span class="green1">void</span> <span class="green2">setup</span>() {<br/> lcd.<span class="orange">begin</span>(); <span class="ash">// Initialize the lcd</span><br/> lcd.backlight();<br/> lcd.<span class="orange">print</span>(<span class="green1">"Arduino Handbook"</span>); <span class="ash">// Print a message to the LCD</span><br/>}<br/><br/><span class="green1">void</span> <span class="green2">loop</span>() { <span class="ash">// Loop around again</span><br/>}</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_140"/>There is a potentiometer built into the module to control the contrast of the LCD screen, shown in <a href="ch16.xhtml#ch16fig6">Figure 16-6</a>. Turn this carefully with a small screwdriver until the contrast on the screen looks right.</p>&#13;
<p class="figcap"><a id="ch16fig6"/><strong>FIGURE 16-6:</strong> The small blue box on the back of the module is a potentiometer to control the contrast.</p>&#13;
<div class="image"><img alt="Image" src="../images/f16-06.jpg"/></div>&#13;
<h3 class="h3" id="ch00lev1sec69"><span class="voilet"><strong>TROUBLESHOOTING</strong></span></h3>&#13;
<p class="ques"><strong>Q.</strong> <em>The code compiles, but nothing shows on the screen.</em></p>&#13;
<p class="bull">• Double-check that the SDA and SCL pins are connected to the correct Arduino pins. If the LCD screen is lit but shows no characters, carefully turn the small potentiometer at the back of the module until the letters appear.</p>&#13;
<p class="bull">• If the screen still shows nothing and all the connections are correct, it may be that the solder on the header pins is not making a clean connection or you have soldered more than one pin together. Heat the area again with your soldering iron to melt the solder, and then use a solder sucker to remove any excess and resolder the header pins.</p>&#13;


<h2 class="h2s" id="ch17"><span epub:type="pagebreak" id="page_141"/><strong>17<br/>Ultrasonic People Counter</strong></h2>&#13;
<p class="intro"><span class="voilet">This project teaches you how to use the HC-SR04 ultrasonic sensor to sense when people pass and then show that count on a serial LCD screen.</span></p>&#13;
<div class="image"><img alt="Image" src="../images/p0141-01.jpg"/></div>&#13;
<div class="image"><span epub:type="pagebreak" id="page_142"/><img alt="Image" src="../images/p0142-01.jpg"/></div>&#13;
<p class="capv"><strong>PARTS REQUIRED</strong></p>&#13;
<p class="cap1"><strong>Arduino board</strong></p>&#13;
<p class="cap1"><strong>Mini-breadboard</strong></p>&#13;
<p class="cap1"><strong>Jumper wires, male-to-male and female-to-male</strong></p>&#13;
<p class="cap1"><strong>LED</strong></p>&#13;
<p class="cap1"><strong>Serial LCD screen module</strong></p>&#13;
<p class="cap1"><strong>220-ohm resistor</strong></p>&#13;
<p class="cap1"><strong>HC-SR04 ultrasonic sensor</strong></p>&#13;
<p class="capv"><strong>LIBRARIES REQUIRED</strong></p>&#13;
<p class="cap1"><strong>NewPing</strong></p>&#13;
<p class="cap1"><strong>Wire</strong></p>&#13;
<p class="cap1"><strong>LiquidCrystal_I2C</strong></p>&#13;
<h3 class="h3" id="ch00lev1sec70"><span epub:type="pagebreak" id="page_143"/><span class="voilet"><strong>HOW IT WORKS</strong></span></h3>&#13;
<p class="noindent">People counters are often used in shops or tourist attractions to count the number of visitors, but you could also use one to record the volume of traffic on a highway or in a parking lot, or to count how many times someone entered your room while you were out!</p>&#13;
<p class="indent">The ultrasonic sensor we’ll use is the HC-SR04, shown in <a href="ch17.xhtml#ch17fig1">Figure 17-1</a>, which you first saw in Project 13. It uses an ultrasonic signal, or <em>ping</em>, to calculate the distance between the sensor and an object. In this project we’ll use this function to count every time someone or something passes in front of the sensor. An LED will flash when a count is registered, and the serial LCD screen will show the total number counted.</p>&#13;
<p class="figcap"><a id="ch17fig1"/><strong>FIGURE 17-1:</strong> The HC-SR04 ultrasonic sensor uses a ping to calculate distances.</p>&#13;
<div class="image"><img alt="Image" src="../images/f17-01.jpg"/></div>&#13;
<h3 class="h3" id="ch00lev1sec71"><span class="voilet"><strong>THE BUILD</strong></span></h3>&#13;
<ol>&#13;
<li><p class="noindents">Use the female-to-male jumper wires to connect the HC-SR04 ultrasonic sensor to the Arduino with the VCC pin to Arduino +5V, GND to GND, and Trig and Echo to pins 7 and 8 on the Arduino, respectively, as shown in the following table and in <a href="ch17.xhtml#ch17fig2">Figure 17-2</a>. Use the mini-breadboard for multiple connections.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thv" style="vertical-align: top;"><p class="tablec"><strong>ULTRASONIC SENSOR</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">VCC</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Trig</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 7</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Echo</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 8</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<p class="figcap"><span epub:type="pagebreak" id="page_144"/><a id="ch17fig2"/><strong>FIGURE 17-2:</strong> The connections from the ultrasonic sensor</p>&#13;
<div class="image"><img alt="Image" src="../images/f17-02.jpg"/></div></li>&#13;
<li><p class="noindents">Make sure to download the LiquidCrystal I2C and NewPing libraries and add them to the relevant folder on your computer (see the primer for guidance). The Wire library comes with the Arduino IDE, so you do not need to add it.</p></li>&#13;
<li><p class="noindents">Connect the serial LCD screen to the Arduino as follows, using the mini-breadboard to connect to +5V.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thv" style="vertical-align: top;"><p class="tablec"><strong>SERIAL LCD SCREEN</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">VCC</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">SDA</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin A4 (SDA)</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">SCL</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin A5 (SCL)</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindents">Insert the LED into the mini-breadboard so that the shorter, negative (GND) leg is to the left and the longer, positive (+5V) leg is to the right, as shown in the following table and in <a href="ch17.xhtml#ch17fig3">Figure 17-3</a>. Connect the 220-ohm resistor to the positive leg of the LED, making sure the other leg of the resistor straddles the break in the breadboard. Connect this other resistor leg to pin 13 on the Arduino. Connect the shorter leg of the LED to GND on the Arduino.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thv" style="vertical-align: top;"><p class="tablec"><strong>LED</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">+5V</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 13 via 220-ohm resistor</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<p class="figcap"><span epub:type="pagebreak" id="page_145"/><a id="ch17fig3"/><strong>FIGURE 17-3:</strong> We use the mini-breadboard to hold the LED and for multiple connections to the Arduino +5V.</p>&#13;
<div class="image"><img alt="Image" src="../images/f17-03.jpg"/></div></li>&#13;
<li><p class="noindents">Make sure your final circuit looks like <a href="ch17.xhtml#ch17fig4">Figure 17-4</a>, and then upload the code in “<a href="ch17.xhtml#ch00lev1sec72">The Sketch</a>” on <a href="ch17.xhtml#page_146">page 146</a> to the Arduino.</p>&#13;
<p class="figcap"><a id="ch17fig4"/><strong>FIGURE 17-4:</strong> The circuit diagram for the ultrasonic people counter</p>&#13;
<div class="image"><img alt="Image" src="../images/f17-04.jpg"/></div></li>&#13;
</ol>&#13;
<h3 class="h3" id="ch00lev1sec72"><span epub:type="pagebreak" id="page_146"/><span class="voilet"><strong>THE SKETCH</strong></span></h3>&#13;
<p class="noindent">The sketch begins by calling on the LiquidCrystal I2C, NewPing, and Wire libraries to control the serial LCD screen and ultrasonic sensor. Next it defines the ultrasonic sensor Trig and Echo pins as Arduino pins 7 and 8, respectively. We set the maximum distance for the sensor to read to 200 centimeters (any reading beyond 200 centimeters is ignored). Then we define pin 13 on the Arduino as the LED, which will be our counting indicator, and create variables to hold the distance and number of people. We create a <code>count</code> state so the Arduino can determine a valid record, and then we define the type of LCD screen. We initiate the LCD screen so that <code>People:</code> is printed to the screen, and set the LED pin as an output.</p>&#13;
<p class="indent">The loop section sends a ping from the sensor and if the ping that’s returned is from a distance of more than 100 centimeters, the space in front of the sensor is considered empty and nothing is registered. If the distance recorded is less than 100 centimeters, it means something is within range in front of the sensor. In order for the <code>people:</code> variable to increment, someone has to move in front of the sensor, then out of the way. The sensor will keep counting every time a valid register is received, and the latest total is shown on the LCD screen.</p>&#13;
<p class="indent">The sensor could be placed to one side of an entrance, facing across the threshold, so as someone enters the sensor picks it up and registers a count. If the sensor is pointing toward a wall that’s less than 100 centimeters away, you’ll need to change the following line of code to a distance less than the distance to the wall; otherwise, the sensor will record a count every time the wall is detected.</p>&#13;
<p class="programs1"><span class="green2">if</span> (distance &lt; 100 &amp;&amp; distance != 0 &amp;&amp; !count)</p>&#13;
<p class="indent">Here is the full code:</p>&#13;
<p class="programs1">#include &lt;LiquidCrystal_I2C.h&gt; <span class="ash">// Call on the libraries</span><br/>#include &lt;NewPing.h&gt;<br/>#include &lt;<span class="orange">Wire</span>.h&gt;<br/><br/>#define TRIGGER_PIN 7  <span class="ash">// Ultrasonic sensor trig to Arduino pin 7</span><br/>#define ECHO_PIN 8     <span class="ash">// Ultrasonic sensor echo to Arduino pin 8</span><br/>#define MAX_DISTANCE 200<br/>NewPing sonar(TRIGGER_PIN, ECHO_PIN, MAX_DISTANCE);<br/><br/><span class="green1">int</span> LEDPin = 13; <span class="ash">// Set LED to pin 13</span><br/><span class="green1">int</span> distance; <span class="ash">// Variable for distance</span><br/><span class="green1">int</span> people = 0; <span class="ash">// Variable for number of people</span><br/><span class="green1"><span epub:type="pagebreak" id="page_147"/>boolean</span> count = false; <span class="ash">// State for counting</span><br/>LiquidCrystal_I2C lcd(0x27, 16, 2);<br/><br/><span class="green1">void</span> <span class="green2">setup()</span> { <span class="ash">// Run once to set up the LCD screen and LED</span><br/>  lcd.<span class="orange">begin</span>();<br/>  lcd.backlight();<br/>  <span class="orange">pinMode</span>(LEDPin, <span class="green1">OUTPUT);</span> <span class="ash">// Set the LED as an output</span><br/>  lcd.<span class="orange">print</span>(<span class="green1">"People:"</span>); <span class="ash">// Print People: to the LCD screen</span><br/>}<br/><br/><span class="green1">void</span> <span class="green2">loop()</span> { <span class="ash">// This loops forever to check for number of people</span><br/>  <span class="orange">delay</span>(50);<br/>  distance = sonar.ping_cm(); <span class="ash">// Ping every 50 milliseconds</span><br/>  <span class="ash">// If more than 100 cm away, don't count</span><br/>  <span class="green2">if</span> (distance &gt; 100 &amp;&amp; count) {<br/>    count = false;<br/>    <span class="orange">digitalWrite</span>(LEDPin, <span class="green1">LOW</span>);<br/>  }<br/>  <span class="ash">// If less than 100 cm away, count 1</span><br/>  <span class="green2">if</span> (distance &lt; 100 &amp;&amp; distance != 0 &amp;&amp; !count) {<br/>    count = true;<br/>    people ++; <span class="ash">// Keep adding 1 per count</span><br/>    <span class="orange">digitalWrite</span>(LEDPin, <span class="green1">HIGH</span>);<br/>    lcd.<span class="orange">setCursor</span>(10, 0);<br/>    lcd.<span class="orange">print</span>(people); <span class="ash">// Print number of people to LCD screen</span><br/>  }<br/>}</p>&#13;
<h3 class="h3" id="ch00lev1sec73"><span class="voilet"><strong>TROUBLESHOOTING</strong></span></h3>&#13;
<p class="ques"><strong>Q.</strong> <em>The code compiles, but nothing shows on the screen.</em></p>&#13;
<p class="bull">• Double-check that the SDA and SCL pins are connected to the correct Arduino pins.</p>&#13;
<p class="bull">• If the LCD screen is lit up but nothing shows, carefully turn the small potentiometer at the back of the module to change the contrast until the letters appear.</p>&#13;
<p class="ques"><strong>Q.</strong> <em>The sensor does not register a count or the LED does not light when expected.</em></p>&#13;
<p class="bull">• Make sure that the ultrasonic sensor trigger pin is connected to Arduino pin 7 and the Echo pin to Arduino pin 8, and that power is connected to GND and +5V.</p>&#13;
<p class="bull">• If a count is registered and the LED does not light, recheck that the short leg of the LED is connected to GND and the long leg to +5V. The resistor should straddle the break in the breadboard and be connected to the LED’s long leg on one side and Arduino pin 13 on the other.</p>&#13;
<p class="bull"><span epub:type="pagebreak" id="page_148"/>• Remember that the positioning of the sensor is important. If the distance to a fixed object (like a wall) is less than the distance in the sketch, the count will be incorrect.</p>&#13;
<p class="bull">• Your device may have a different address than the one we’ve used here. To check the address of your device, use the I2C scanner sketch available on the Arduino website (<em><a href="http://playground.arduino.cc/Main/I2cScanner">http://playground.arduino.cc/Main/I2cScanner</a></em>). Run the sketch with your device attached to the Arduino and open the IDE Serial Monitor, and you should see the address of your device. Update the following line in this sketch with the address shown:</p>&#13;
<p class="programs1">LiquidCrystal_I2C lcd(<span class="codestrong">0x27</span>,16,2);</p>&#13;


<h2 class="h2s" id="ch18"><span epub:type="pagebreak" id="page_149"/><strong>18<br/>Nokia 5110 LCD Screen Pong Game</strong></h2>&#13;
<p class="intro"><span class="voilet">This project shows you how to connect a Nokia 5110 LCD screen to your Arduino to recreate a <em>Pong</em>-style arcade game.</span></p>&#13;
<div class="image"><img alt="Image" src="../images/p0149-01.jpg"/></div>&#13;
<div class="image"><span epub:type="pagebreak" id="page_150"/><img alt="Image" src="../images/p0150-01.jpg"/></div>&#13;
<p class="capv"><strong>PARTS REQUIRED</strong></p>&#13;
<p class="cap1"><strong>Arduino board</strong></p>&#13;
<p class="cap1"><strong>Breadboard</strong></p>&#13;
<p class="cap1"><strong>Jumper wires</strong></p>&#13;
<p class="cap1"><strong>Nokia 5110 LCD screen</strong></p>&#13;
<p class="cap1"><strong>4 10k-ohm resistors</strong></p>&#13;
<p class="cap1"><strong>2 1k-ohm resistors</strong></p>&#13;
<p class="cap1"><strong>2 50k-ohm potentiometers</strong></p>&#13;
<h3 class="h3" id="ch00lev1sec74"><span epub:type="pagebreak" id="page_151"/><span class="voilet"><strong>HOW IT WORKS</strong></span></h3>&#13;
<p class="noindent">Nokia 5110 LCD screens were used for all Nokia phones a few years back, so you should find plenty available online. We’ll wire one up to the Arduino and create a simple <em>Pong</em>-style game by adding some potentiometers as controllers.</p>&#13;
<div class="noter">&#13;
<p class="notet"><strong>NOTE</strong></p>&#13;
<p class="notep"><em>See Project 13 for instructions on soldering header pins, and see the primer for general soldering instructions if you haven’t soldered before.</em></p>&#13;
</div>&#13;
<p class="indent">The screen is 84×48 pixels, which, with spaces between the characters so they aren’t touching, gives us a 12×6-character screen. The screen works in the same way as the LCD screen in Project 13: by sending current through the liquid crystal from the Arduino to make certain pixels opaque and form letters or images.</p>&#13;
<p class="indent">Most screens come with the header pins separate for ease of transport, so you may need to solder them in place if you want to plug the screen into a breadboard. You’ll need to solder a strip of eight header pins into the row of holes on one side of the screen, as you can see in <a href="ch18.xhtml#ch18fig1">Figure 18-1</a>.</p>&#13;
<p class="figcap"><a id="ch18fig1"/><strong>FIGURE 18-1:</strong> The reverse of the Nokia 5110 LCD screen showing the pin connections</p>&#13;
<div class="image"><img alt="Image" src="../images/f18-01.jpg"/></div>&#13;
<p class="indent">This project connects to +3.3V on the Arduino, rather than +5V.</p>&#13;
<h3 class="h3" id="ch00lev1sec75"><span class="voilet"><strong>THE BUILD</strong></span></h3>&#13;
<ol>&#13;
<li><p class="noindents">Insert the Nokia 5110 screen into the breadboard.</p></li>&#13;
<li><p class="noindents">The Nokia screen has eight pins. Insert a 10k-ohm resistor for Nokia pins 1, 3, 4, and 5, making sure they straddle the center break. Insert a 1k-ohm resistor for Nokia pins 2 and 7, as shown in <a href="ch18.xhtml#ch18fig2">Figure 18-2</a>.</p>&#13;
<p class="figcap"><span epub:type="pagebreak" id="page_152"/><a id="ch18fig2"/><strong>FIGURE 18-2:</strong> Insert the resistors for the Nokia LCD screen as shown here.</p>&#13;
<div class="image"><img alt="Image" src="../images/f18-02.jpg"/></div>&#13;
<div class="noter">&#13;
<p class="notet"><strong>WARNING</strong></p>&#13;
<p class="notep"><em>It’s really important to use the +3.3V power from the Arduino for the Nokia 5110 screen and not +5V for this project; otherwise, you will damage the screen.</em></p>&#13;
</div></li>&#13;
<li><p class="noindents">Use jumper wires to make the connections from the Nokia screen to Arduino pins 3–7 and to the breadboard power rails. Make sure to add the right value resistor to the correct pin, as shown in the following table. Some breakout boards may have the pins in different locations, so match the pin names on the Nokia screen with the Arduino pin.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thv" style="vertical-align: top;"><p class="tablec"><strong>NOKIA 5110 SCREEN</strong></p></td>&#13;
<td class="table_thr" style="vertical-align: top;"><p class="tablec"><strong>RESISTOR</strong></p></td>&#13;
<td class="table_thv" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">1 RESET</span></p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="tablec"><span class="voilet">10k-ohm</span></p></td>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 6</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">2 CE</span></p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="tablec"><span class="voilet">1k-ohm</span></p></td>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 7</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">3 DC</span></p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="tablec"><span class="voilet">10k-ohm</span></p></td>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 5</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">4 DIN</span></p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="tablec"><span class="voilet">10k-ohm</span></p></td>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 4</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">5 CLK</span></p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="tablec"><span class="voilet">10k-ohm</span></p></td>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin 3</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">6 VCC</span></p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="tablec"><span class="voilet">None</span></p></td>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">+3.3V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">7 Light</span></p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="tablec"><span class="voilet">1k-ohm</span></p></td>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">8 GND</span></p></td>&#13;
<td class="table_1" style="vertical-align: top;"><p class="tablec"><span class="voilet">None</span></p></td>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindents">Insert the potentiometers into the breadboard as shown in <a href="ch18.xhtml#ch18fig3">Figure 18-3</a>. Connect the center pin of one potentiometer to Arduino A0 and the center pin of the other potentiometer to Arduino A1. Connect an outer pin of each potentiometer to the +5V rail of the breadboard and the other outer pins to the GND rail.</p></li>&#13;
<li><p class="noindents"><span epub:type="pagebreak" id="page_153"/>Connect the power rails of the breadboard to +5V and GND on the Arduino (this is for the potentiometers only).</p></li>&#13;
<li><p class="noindents">Confirm that your setup matches <a href="ch18.xhtml#ch18fig3">Figure 18-3</a>, and upload the code in “<a href="ch18.xhtml#ch00lev1sec76">The Sketch</a>” below.</p>&#13;
<p class="figcap"><a id="ch18fig3"/><strong>FIGURE 18-3:</strong> The circuit diagram for the Nokia 5110 LCD Screen <em>Pong</em> Game</p>&#13;
<div class="image"><img alt="Image" src="../images/f18-03.jpg"/></div></li>&#13;
</ol>&#13;
<h3 class="h3" id="ch00lev1sec76"><span class="voilet"><strong>THE SKETCH</strong></span></h3>&#13;
<p class="noindent">The game starts with two bars on opposite sides of the screen and a ball bouncing between them. The object of the game is to use the potentiometers to move the bars like paddles, hitting the ball back and forth to stop it from going out of the play (beyond the screen perimeter). The ball bounces off the bars and gradually gets faster and faster. The game is over when the ball goes beyond the screen <span epub:type="pagebreak" id="page_154"/>limit, at which point the display will invert and the game will start over again. Note that the ball can appear quite faint the faster it moves, due to the limitation of the screen graphics.</p>&#13;
<p class="indent">The first part of the sketch defines the pins connected to the Nokia 5110 LCD screen. It then defines the size of the screen, which is the area of our game that counts as in-play, and the size and starting positions of the bars and ball. The potentiometers read the analog signal from Arduino pins A0 and A1 and move their corresponding bars onscreen depending on how they’re twisted. The calculations that follow determine whether the ball and the bar have met at certain coordinates. If they have, the ball bounces back; if they haven’t, it means the bar has missed the ball, so the screen inverts and flashes to indicate the game is over.</p>&#13;
<p class="programs1"><span class="ash">// Arduino Pong by Onur Avun and reproduced with kind permission</span><br/><br/>#define PIN_SCE   7<br/>#define PIN_RESET 6<br/>#define PIN_DC    5<br/>#define PIN_SDIN  4<br/>#define PIN_SCLK  3<br/>#define LCD_C     <span class="green1">LOW</span><br/>#define LCD_D     <span class="green1">HIGH</span><br/>#define LCD_X     84<br/>#define LCD_Y     6<br/><br/><span class="green1">int</span> barWidth = 16;<br/><span class="green1">int</span> barHeight = 4;<br/><span class="green1">int</span> ballPerimeter = 4;<br/><br/><span class="green1">unsigned int</span> bar1X = 0;<br/><span class="green1">unsigned int</span> bar1Y = 0;<br/><span class="green1">unsigned int</span> bar2X = 0;<br/><span class="green1">unsigned int</span> bar2Y = LCD_Y * 8 - barHeight;<br/><br/><span class="green1">int</span> ballX = 0;<br/><span class="green1">int</span> ballY = 0;<br/><br/><span class="green1">boolean</span> isBallUp = <span class="green1">false</span>;<br/><span class="green1">boolean</span> isBallRight = <span class="green1">true</span>;<br/><span class="green1">byte</span> pixels[LCD_X][LCD_Y];<br/><span class="green1">unsigned long</span> lastRefreshTime;<br/><span class="green1">const int</span> refreshInterval = 150;<br/><br/><span class="green1">byte</span> gameState = 1;<br/><span class="green1">byte</span> ballSpeed = 2;<br/><span class="green1">byte</span> player1WinCount = 0;<br/><span class="green1">byte</span> player2WinCount = 0;<br/><span class="green1">byte</span> hitCount = 0;<br/><span class="green1"><span epub:type="pagebreak" id="page_155"/>void</span> <span class="green2">setup</span>() {<br/>  LcdInitialise();<br/>  restartGame();<br/>}<br/><br/><span class="green1">void</span> <span class="green2">loop</span>() {<br/>  <span class="green1">unsigned long</span> now = <span class="orange">millis</span>();<br/>  <span class="green2">if</span> (now - lastRefreshTime &gt; refreshInterval) {<br/>    <span class="orange">update</span>();<br/>    refreshScreen();<br/>    lastRefreshTime = now;<br/>  }<br/>}<br/><br/><span class="green1">void</span> restartGame() {<br/>  ballSpeed = 1;<br/>  gameState = 1;<br/>  ballX = <span class="orange">random</span>(0, 60);<br/>  ballY = 20;<br/>  isBallUp = false;<br/>  isBallRight = true;<br/>  hitCount = 0;<br/>}<br/><br/><span class="green1">void</span> refreshScreen() {<br/>  <span class="green2">if</span> (gameState == 1) {<br/>    <span class="green2">for</span> (<span class="green1">int</span> y = 0; y &lt; LCD_Y; y++) {<br/>      <span class="green2">for</span> (<span class="green1">int</span> x = 0; x &lt; LCD_X; x++) {<br/>        <span class="green1">byte</span> pixel = 0x00;<br/>        <span class="green1">int</span> realY = y * 8;<br/>        <span class="ash">// Draw ball if in frame</span><br/>        <span class="green2">if</span> (x &gt;= ballX &amp;&amp; x &lt;= ballX + ballPerimeter -1 &amp;&amp; ballY +<br/>            ballPerimeter &gt; realY &amp;&amp; ballY &lt; realY + 8 ) {<br/>          <span class="green1">byte</span> ballMask = 0x00;<br/>          <span class="green2">for</span> (int i = 0; i &lt; realY + 8 - ballY; i++) {<br/>            ballMask = ballMask &gt;&gt; 1;<br/>            <span class="green2">if</span> (i &lt; ballPerimeter)<br/>              ballMask = 0x80 | ballMask;<br/>          }<br/>          pixel = pixel | ballMask;<br/>        }<br/><br/>        <span class="ash">// Draw bars if in frame</span><br/>        <span class="green2">if</span> (x &gt;= bar1X &amp;&amp; x &lt;= bar1X + barWidth -1 &amp;&amp; bar1Y +<br/>            barHeight &gt; realY &amp;&amp; bar1Y &lt; realY + 8 ) {<br/>          <span class="green1">byte</span> barMask = 0x00;<br/>          <span class="green2">for</span> (int i = 0; i &lt; realY + 8 - bar1Y; i++) {<br/>            barMask = barMask &gt;&gt; 1;<br/>            <span class="green2">if</span> (i &lt; barHeight)<br/>              barMask = 0x80 | barMask;<br/>          }<br/>          pixel = pixel | barMask;<br/>        }<br/><span epub:type="pagebreak" id="page_156"/><br/>        <span class="green2">if</span> (x &gt;= bar2X &amp;&amp; x &lt;= bar2X + barWidth -1 &amp;&amp; bar2Y +<br/>            barHeight &gt; realY &amp;&amp; bar2Y &lt; realY + 8 ) {<br/>          <span class="green1">byte</span> barMask = 0x00;<br/>          <span class="green2">for</span> (int i = 0; i &lt; realY + 8 - bar2Y; i++) {<br/>            barMask = barMask &gt;&gt; 1;<br/>            <span class="green2">if</span> (i &lt; barHeight)<br/>              barMask = 0x80 | barMask;<br/>          }<br/>          pixel = pixel | barMask;<br/>        }<br/>        LcdWrite(LCD_D, pixel);<br/>      }<br/>    }<br/>  } <span class="green2">else if</span> (gameState == 2) {<br/>  }<br/>}<br/><br/><span class="green1">void</span> <span class="orange">update</span>() {<br/>  <span class="green2">if</span> (gameState == 1) {<br/>    <span class="green1">int</span> barMargin = LCD_X - barWidth;<br/>    <span class="green1">int</span> pot1 = <span class="orange">analogRead</span>(A0); <span class="ash">// Read pots and set bar positions</span><br/>    <span class="green1">int</span> pot2 = <span class="orange">analogRead</span>(A1);<br/>    bar1X = pot1 / 2 * LCD_X / 512;<br/>    bar2X = pot2 / 2 * LCD_X / 512;<br/><br/>    <span class="green2">if</span> (bar1X &gt; barMargin) bar1X = barMargin;<br/>    <span class="green2">if</span> (bar2X &gt; barMargin) bar2X = barMargin;<br/><br/>    <span class="ash">// Move the ball now</span><br/>    <span class="green2">if</span> (isBallUp)<br/>      ballY -= ballSpeed;<br/>    <span class="green2">else</span><br/>      ballY += ballSpeed;<br/>    <span class="green2">if</span> (isBallRight)<br/>      ballX += ballSpeed;<br/>    <span class="green2">else</span><br/>      ballX -= ballSpeed;<br/>    <span class="ash">// Check collisions</span><br/>    <span class="green2">if</span> (ballX &lt; 1) {<br/>      isBallRight = true;<br/>      ballX = 0;<br/>    }<br/>    <span class="green2">else if</span> (ballX &gt; LCD_X - ballPerimeter - 1) {<br/>      isBallRight = false;<br/>      ballX = LCD_X - ballPerimeter;<br/>    }<br/>    <span class="green2">if</span> (ballY &lt; barHeight) {<br/>      <span class="green2">if</span> (ballX + ballPerimeter &gt;= bar1X &amp;&amp; ballX &lt;= bar1X + barWidth) {<br/>      <span class="ash">// Ball bounces from bar1</span><br/>        isBallUp = false;<br/>        <span class="green2">if</span> (ballX + ballPerimeter / 2 &lt; bar1X + barWidth / 2)<br/>          isBallRight = false;<br/>        <span class="green2">else</span><br/>          isBallRight = true;<br/><span epub:type="pagebreak" id="page_157"/>        ballY = barHeight;<br/>        <span class="green2">if</span> (++hitCount % 10 == 0 &amp;&amp; ballSpeed &lt; 5)<br/>          ballSpeed++;<br/>      } <span class="green2">else</span> { <span class="ash">// Player 2 wins</span><br/>        gameState = 2;<br/>        player2WinCount++;<br/>      }<br/>    }<br/>    <span class="green2">if</span> (ballY + ballPerimeter &gt; LCD_Y * 8 - barHeight) {<br/>      <span class="green2">if</span> (ballX + ballPerimeter &gt;= bar2X &amp;&amp; ballX &lt;= bar2X + barWidth) {<br/>      <span class="ash">// Ball bounces from bar2</span><br/>        isBallUp = true;<br/>        <span class="green2">if</span> (ballX + ballPerimeter / 2 &lt; bar2X + barWidth / 2)<br/>          isBallRight = false;<br/>        <span class="green2">else</span><br/>          isBallRight = true;<br/>        ballY = LCD_Y * 8 - barHeight - ballPerimeter;<br/>        <span class="green2">if</span> (++hitCount % 10 == 0 &amp;&amp; ballSpeed &lt; 5)<br/>          ballSpeed++;<br/>      } <span class="green2">else</span> { <span class="ash">// Player 1 wins</span><br/>        gameState = 2;<br/>        player1WinCount++;<br/>      }<br/>    }<br/>  } <span class="green2">else if</span> (gameState == 2) {<br/>    <span class="green2">for</span> (<span class="green1">int</span> i =0; i &lt; 4; i++) {<br/>      LcdWrite(LCD_C, 0x0D); <span class="ash">// LCD in inverse mode.</span><br/>      <span class="orange">delay</span>(300);<br/>      LcdWrite(LCD_C, 0x0C); <span class="ash">// LCD in inverse mode.</span><br/>      <span class="orange">delay</span>(300);<br/>    }<br/>    restartGame();<br/>  }<br/>}<br/><br/><span class="green1">void</span> LcdInitialise(<span class="green1">void</span>) {<br/>  <span class="orange">pinMode</span>(PIN_SCE, <span class="green1">OUTPUT</span>);<br/>  <span class="orange">pinMode</span>(PIN_RESET, <span class="green1">OUTPUT</span>);<br/>  <span class="orange">pinMode</span>(PIN_DC, <span class="green1">OUTPUT</span>);<br/>  <span class="orange">pinMode</span>(PIN_SDIN, <span class="green1">OUTPUT</span>);<br/>  <span class="orange">pinMode</span>(PIN_SCLK, <span class="green1">OUTPUT</span>);<br/>  <span class="orange">delay</span>(200);<br/>  <span class="orange">digitalWrite</span>(PIN_RESET, <span class="green1">LOW</span>);<br/>  <span class="orange">delay</span>(500);<br/>  digitalWrite(PIN_RESET, <span class="green1">HIGH</span>);<br/>  LcdWrite(LCD_C, 0x21 );  <span class="ash">// LCD Extended Commands</span><br/>  LcdWrite(LCD_C, 0xB1 );  <span class="ash">// Set LCD Vop (Contrast)</span><br/>  LcdWrite(LCD_C, 0x04 );  <span class="ash">// Set Temp coefficent. //0x04</span><br/>  LcdWrite(LCD_C, 0x14 );  <span class="ash">// LCD bias mode 1:48. //0x13</span><br/>  LcdWrite(LCD_C, 0x0C );  <span class="ash">// LCD in normal mode.</span><br/>  LcdWrite(LCD_C, 0x20 );<br/>  LcdWrite(LCD_C, 0x80 );  <span class="ash">// Select X Address 0 of the LCD ram</span><br/>  LcdWrite(LCD_C, 0x40 );  <span class="ash">// Select Y Address 0 of the LCD ram</span><br/>  LcdWrite(LCD_C, 0x0C );<br/><span epub:type="pagebreak" id="page_158"/><br/>}<br/><br/><span class="green1">void</span> LcdWrite(<span class="green1">byte</span> dc, <span class="green1">byte</span> data) {<br/>  <span class="orange">digitalWrite</span>(PIN_DC, dc);<br/>  <span class="orange">digitalWrite</span>(PIN_SCE, <span class="green1">LOW</span>);<br/>  <span class="orange">shiftOut</span>(PIN_SDIN, PIN_SCLK, <span class="green1">MSBFIRST</span>, data);<br/>  <span class="orange">digitalWrite</span>(PIN_SCE, <span class="green1">HIGH</span>);<br/>}</p>&#13;
<h3 class="h3" id="ch00lev1sec77"><span class="voilet"><strong>TROUBLESHOOTING</strong></span></h3>&#13;
<p class="ques"><strong>Q.</strong> <em>Nothing is displayed on the LCD screen.</em></p>&#13;
<p class="bull">• Make sure you’ve connected power to the LCD screen direct to the Arduino +3.3V power pin and the connections match the tables in this chapter.</p>&#13;
<p class="bull">• Make sure your resistors line up with the correct LCD pins, as well as the wires to the Arduino pins.</p>&#13;
<p class="bull">• If the backlight of the LCD screen is lit but there is no image, you may have some wires mixed up; they need to match the circuit in <a href="ch18.xhtml#ch18fig3">Figure 18-3</a> exactly.</p>&#13;
<p class="ques"><strong>Q.</strong> <em>When the player turns the potentiometer, one or both of the bars do not move.</em></p>&#13;
<p class="bull">• Make sure the potentiometers are connected firmly in the breadboard and that the wires connecting to the power rails and Arduino line up with the potentiometer pins.</p>&#13;
<p class="bull">• Remember that the potentiometers require +5V power and GND from the Arduino. These pins should be hooked up to the breadboard power rails via jumper wires.</p>&#13;
<p class="bull">• Make sure you also use jumper wires to connect the corresponding power rails on either side of the breadboard to each other.</p>&#13;


<h2 class="h2s" id="ch19"><span epub:type="pagebreak" id="page_159"/><strong>19<br/>OLED Breathalyzer</strong></h2>&#13;
<p class="intro"><span class="voilet">In this project we’ll use the MQ3 alcohol sensor and an OLED LCD screen to make a mini-breathalyzer.</span></p>&#13;
<div class="image"><img alt="Image" src="../images/p0159-01.jpg"/></div>&#13;
<div class="image"><span epub:type="pagebreak" id="page_160"/><img alt="Image" src="../images/p0160-01.jpg"/></div>&#13;
<p class="capv"><strong>PARTS REQUIRED</strong></p>&#13;
<p class="cap1"><strong>Arduino board</strong></p>&#13;
<p class="cap1"><strong>Female-to-male jumper wires</strong></p>&#13;
<p class="cap1"><strong>Keyes MQ3 alcohol sensor module</strong></p>&#13;
<p class="cap1"><strong>OLED monochrome screen (128×64)</strong></p>&#13;
<p class="capv"><strong>LIBRARIES REQUIRED</strong></p>&#13;
<p class="cap1"><strong>SPI</strong></p>&#13;
<p class="cap1"><strong>Wire</strong></p>&#13;
<p class="cap1"><strong>Adafruit_GFX</strong></p>&#13;
<p class="cap1"><strong>Adafruit_SSD1306</strong></p>&#13;
<h3 class="h3" id="ch00lev1sec78"><span epub:type="pagebreak" id="page_161"/><span class="voilet"><strong>HOW IT WORKS</strong></span></h3>&#13;
<p class="noindent">The MQ3 is part of a family of gas sensors that also includes the MQ2, sensitive to methane, butane, and smoke; the MQ4, sensitive to compressed natural gas; the MQ6, sensitive to butane and LPG gas; and the MQ7, sensitive to carbon monoxide. The MQ3 is sensitive to alcohol and ethanol, so it’s the one we’ll use in our breathalyzer.</p>&#13;
<div class="noter">&#13;
<p class="notet"><strong>DISCLAIMER</strong></p>&#13;
<p class="notep"><em>This project is for amusement only and should not be used to accurately determine anyone’s alcohol intake.</em></p>&#13;
</div>&#13;
<p class="indent">The Keyes MQ3 module (<a href="ch19.xhtml#ch19fig1">Figure 19-1</a>) has the wiring we need for this project, including a built-in potentiometer and resistor. The three pin connections on the module are OUT, VCC, and GND.</p>&#13;
<p class="figcap"><a id="ch19fig1"/><strong>FIGURE 19-1:</strong> The Keyes MQ3 alcohol sensor module. As with most MQ sensors, the module has a small heater inside with an electrochemical sensor used to measure the gas level. The value of the reading is sent to the OUT pin, which is then read by an analog pin on our Arduino.</p>&#13;
<div class="image"><img alt="Image" src="../images/f19-01.jpg"/></div>&#13;
<p class="indent">To display the sensor readings, we’ll use an OLED screen (<a href="ch19.xhtml#ch19fig2">Figure 19-2</a>). OLED, which stands for <em>organic light-emitting diode</em>, is a light-emitting technology composed of a thin, multilayered organic film placed between an anode and cathode. When voltage is applied, an image is created through <em>electroluminescence</em>, which means the screen does not require a backlight. Our OLED screen is an I2C 128×64 monochrome version, meaning we can control it using only two pins to the Arduino and it measures 128 pixels by 64 pixels. This screen uses the same communication protocol as our serial LCD in Project 16 and is explained further there.</p>&#13;
<p class="figcap"><a id="ch19fig2"/><strong>FIGURE 19-2:</strong> 128×64 OLED monochrome screen. When the MQ3 reads the value, the Arduino sends a message to the OLED screen indicating whether or not alcohol has been detected.</p>&#13;
<div class="image"><img alt="Image" src="../images/f19-02.jpg"/></div>&#13;
<div class="noter">&#13;
<p class="notet"><span epub:type="pagebreak" id="page_162"/><strong>WARNING</strong></p>&#13;
<p class="notep"><em>As mentioned earlier, the MQ3 uses an internal heater as part of the sensor process. This heater can reach 120–140 degrees when powered, so take care when handling it when it’s in use.</em></p>&#13;
</div>&#13;
<h3 class="h3" id="ch00lev1sec79"><span class="voilet"><strong>THE BUILD</strong></span></h3>&#13;
<ol>&#13;
<li><p class="noindents">Before you use the sensor for the first time, you need to “burn it in.” This process, which simply involves powering it up for a few hours to heat the mechanism inside, improves the sensor’s accuracy. To do this, connect the VCC and GND pins of the sensor to +5V and GND on your Arduino, respectively, using female-to-male jumper wires. When you power the Arduino, it will send the correct voltage to the MQ3. Leave it powered for two to three hours—you may notice a burning smell and the sensor will get hot, but this is normal.</p></li>&#13;
<li><p class="noindents">Once the sensor is burned in, disconnect the power to the Arduino and connect the sensor to the Arduino using the female-to-male jumper wires, with the MQ3’s OUT pin connected to Arduino pin A0, and the power and GND still connected as before (see the following table).</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thv" style="vertical-align: top;"><p class="tablec"><strong>MQ3 ALCOHOL SENSOR</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">OUT</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin A0</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">VCC</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">+5V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindents">Next, connect the OLED screen to the Arduino as shown in the following table, with SCL connected to pin A5, SDA to pin A4, VCC to +3.3V, and GND to GND.</p>&#13;
<table class="all">&#13;
<thead>&#13;
<tr>&#13;
<td class="table_thv" style="vertical-align: top;"><p class="tablec"><strong>OLED SCREEN</strong></p></td>&#13;
<td class="table_th" style="vertical-align: top;"><p class="tablec"><strong>ARDUINO</strong></p></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">SCL</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin A5</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">SDA</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">Pin A4</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">VCC</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">+3.3V</span></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td class="table_1v" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
<td class="table_2" style="vertical-align: top;"><p class="tablec"><span class="voilet">GND</span></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table></li>&#13;
<li><p class="noindents">This project requires a number of libraries to work correctly; the SPI and Wire libraries are built into the Arduino IDE, but we also need the Adafruit_GFX and Adafruit_SSD1306 libraries to control the OLED screen. Both are available from <em><a href="https://www.nostarch.com/arduinohandbook2/">https://www.nostarch.com/arduinohandbook2/</a></em>. Refer to the primer if you need a reminder on how to add libraries to the IDE.</p></li>&#13;
<li><p class="noindents"><span epub:type="pagebreak" id="page_163"/>Check that your setup matches the circuit diagram in <a href="ch19.xhtml#ch19fig3">Figure 19-3</a>, and upload the code in “<a href="ch19.xhtml#ch00lev1sec80">The Sketch</a>” below.</p>&#13;
<p class="figcap"><a id="ch19fig3"/><strong>FIGURE 19-3:</strong> The circuit diagram for the OLED breathalyzer</p>&#13;
<div class="image"><img alt="Image" src="../images/f19-03.jpg"/></div></li>&#13;
<li><p class="noindents">The heater inside the MQ3 sensor needs to heat up for about 4 minutes before it can operate accurately. The sketch has a timer so that when you power it up for the first time, the values won’t appear onscreen until the required time has passed. The “Warming up” text will display with a small countdown bar until the sensor is ready.</p></li>&#13;
</ol>&#13;
<h3 class="h3" id="ch00lev1sec80"><span class="voilet"><strong>THE SKETCH</strong></span></h3>&#13;
<p class="noindent">The sketch starts by calling on the SPI, Wire, Adafruit_GFX, and Adafruit_SSD1306 libraries to control communication and the OLED screen. We assign a time for the warm-up session (4 minutes) and set the analog pin as Arduino A0.</p>&#13;
<p class="indent">Next we set up the OLED screen. The Arduino sends different messages to the screen depending on the value read from the analog pin. For instance, if the sensor reading is above 200, the Arduino will ask you if you’ve had a beer. If the reading is below this value, the Arduino will say you’re sober. The minimum level of alcohol the MQ3 will read is about 180. For anything over 450, the breathalyzer will let you know you’re drunk!</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_164"/>The sketch loops every second to read the analog sensor. To use the breathalyzer, wait for the sensor to heat up for 4 minutes, then gently breathe onto the sensor. Try not to get the sensor wet or expose it to a smoky environment, as this will affect the reading.</p>&#13;
<p class="programs1"><span class="ash">// Re-created with kind permission from Nick Koumaris educ8s.tv</span><br/><br/><span class="ash">// Call the SPI, Wire, Adafruit_GFX, and Adafruit_SDD1306 libraries</span><br/>#include &lt;<span class="orange">SPI</span>.h&gt;<br/>#include &lt;<span class="orange">Wire.h</span>&gt;<br/>#include &lt;Adafruit_GFX.h&gt;<br/>#include &lt;Adafruit_SSD1306.h&gt;<br/>#define OLED_RESET 4 <span class="ash">// Define the OLED screen</span><br/><span class="green1">int</span> TIME_UNTIL_WARMUP = 4; <span class="ash">// Time for the warm-up delay in minutes</span><br/><span class="green1">unsigned long</span> <span class="orange">time</span>;<br/><span class="green1">int</span> analogPin = 0; <span class="ash">// Set analog pin as A0</span><br/><span class="green1">int</span> val = 0; <span class="ash">// Set a value to read from the analog pin</span><br/>Adafruit_SSD1306 <span class="orange">display</span>(OLED_RESET);<br/><br/><span class="green1">void</span> <span class="green2">setup</span>() { <span class="ash">// Set up the OLED screen</span><br/>  <span class="orange">display.begin</span>(SSD1306_SWITCHCAPVCC, 0x3C);<br/>  <span class="orange">display</span>.clearDisplay();<br/>}<br/><br/><span class="green1">void</span> <span class="green2">loop</span>() { <span class="ash">// Take the reading and show it onscreen</span><br/>  <span class="orange">delay</span>(100);<br/>  val = readAlcohol();<br/>  printTitle();<br/>  printWarming();<br/>  <span class="orange">time</span> = <span class="orange">millis</span>() / 1000;<br/>  <span class="orange">time</span> /= 60;<br/>  <span class="green2">if</span> <span class="orange">(time</span> &lt;= TIME_UNTIL_WARMUP) { <span class="ash">// If warm-up is less than 4 mins</span><br/>    <span class="orange">time</span> = <span class="orange">map</span>(<span class="orange">time</span>, 0, TIME_UNTIL_WARMUP, 0, 100); <span class="ash">// Show countdown</span><br/>    <span class="orange">display</span>.drawRect(10, 50, 110, 10, WHITE); <span class="ash">// Empty bar</span><br/>    <span class="orange">display</span>.fillRect(10, 50, <span class="orange">time</span>, 10, WHITE);<br/>  } <span class="green2">else</span> { <span class="ash">// When warm-up time has passed</span><br/>           <span class="ash">// the value and message are printed on the screen</span><br/>     printTitle();<br/>     printAlcohol(val);<br/>     printAlcoholLevel(val);<br/>  }<br/>  <span class="orange">display</span>.<span class="orange">display</span>();<br/>}<br/><br/><span class="green1">void</span> printTitle() { <span class="ash">// Position and text of title on the screen</span><br/>  <span class="orange">display</span>.clearDisplay();<br/>  <span class="orange">display</span>.setTextSize(1);<br/>  <span class="orange">display</span>.setTextColor(WHITE);<br/>  <span class="orange">display</span>.<span class="orange">setCursor</span>(22, 0);<br/>  <span class="orange">display</span>.<span class="orange">println</span>(<span class="green1">"Breath Analyzer"</span>);<br/>}<br/><span class="green1"><span epub:type="pagebreak" id="page_165"/>void</span> printWarming() { <span class="ash">// Warm-up message</span><br/>  <span class="orange">display</span>.setTextSize(1);<br/>  <span class="orange">display</span>.setTextColor(WHITE);<br/>  <span class="orange">display</span>.<span class="orange">setCursor</span>(30, 24);<br/>  <span class="orange">display</span>.<span class="orange">println</span>(<span class="green1">"Warming up"</span>);<br/>}<br/><br/><span class="green1">void</span> printAlcohol(<span class="green1">int</span> value) { <span class="ash">// Print alcohol value to screen</span><br/>  <span class="orange">display</span>.setTextSize(2);<br/>  <span class="orange">display</span>.setTextColor(WHITE);<br/>  <span class="orange">display</span>.<span class="orange">setCursor</span>(50, 10);<br/>  <span class="orange">display</span>.<span class="orange">println</span>(val);<br/>}<br/><br/><span class="green1">void</span> printAlcoholLevel(<span class="green1">int</span> value) { <span class="ash">// Print message to screen</span><br/>  <span class="orange">display</span>.setTextSize(1);<br/>  <span class="orange">display</span>.setTextColor(WHITE);<br/>  <span class="orange">display</span>.setCursor(20, 25);<br/>  <span class="green2">if</span> (value &lt; 200) { <span class="ash">// If value read is less than 200, you are sober</span><br/>    <span class="orange">display</span>.<span class="orange">println</span>(<span class="green1">"You are sober..."</span>);<br/>  }<br/>  <span class="green2">if</span> (value &gt;= 200 &amp;&amp; value &lt; 280) {<br/>    <span class="orange">display</span>.<span class="orange">println</span>(<span class="green1">"You had a beer?"</span>);<br/>  }<br/>  <span class="green2">if</span> (value &gt;= 280 &amp;&amp; value &lt; 350) {<br/>    <span class="orange">display</span>.<span class="orange">println</span>(<span class="green1">"Two or more beers.</span>");<br/>  }<br/>  <span class="green2">if</span> (value &gt;= 350 &amp;&amp; value &lt; 450) {<br/>    <span class="orange">display</span>.<span class="orange">println</span>(<span class="green1">"I smell VODKA!"</span>);<br/>  }<br/>  <span class="green2">if</span> (value &gt; 450) {<br/>     <span class="orange">display</span>.<span class="orange">println</span>(<span class="green1">"You are drunk!"</span>);<br/>  }<br/>}<br/><br/><span class="ash">// Finds average by summing three readings and</span><br/><span class="ash">// dividing by 3 for better accuracy</span><br/><span class="green1">int</span> readAlcohol() {<br/>  <span class="green1">int</span> val = 0;<br/>  <span class="green1">int</span> val1;<br/>  <span class="green1">int</span> val2;<br/>  <span class="green1">int</span> val3;<br/>  <span class="orange">display</span>.clearDisplay();<br/>  val1 = <span class="orange">analogRead</span>(analogPin);<br/>  <span class="orange">delay</span>(10);<br/>  val2 = <span class="orange">analogRead</span>(analogPin);<br/>  <span class="orange">delay</span>(10);<br/>  val3 = <span class="orange">analogRead</span>(analogPin);<br/>  val = (val1 + val2 + val3) / 3;<br/>  <span class="green2">return</span> val;<br/>}</p>&#13;
<h3 class="h3" id="ch00lev1sec81"><span epub:type="pagebreak" id="page_166"/><span class="voilet"><strong>TROUBLESHOOTING</strong></span></h3>&#13;
<p class="ques"><strong>Q.</strong> <em>The display is not showing readings correctly.</em></p>&#13;
<p class="bull">• Recheck that your wiring matches the diagram in <a href="ch19.xhtml#ch19fig3">Figure 19-3</a>.</p>&#13;
<p class="bull">• If all your wiring is in the correct place, make sure you’ve carried out the earlier step to burn the sensor in by leaving it powered for a few hours.</p>&#13;
<p class="bull">• To check whether your components are faulty, temporarily swap a potentiometer in for the sensor. Connect the center pin of the potentiometer to A0 and add power to either side. If the potentiometer is working okay, it means your sensor is probably faulty, so replace your sensor—they are very inexpensive.</p>&#13;
</body></html>