<?xml version='1.0' encoding='utf-8'?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" epub:prefix="z3998: http://www.daisy.org/z3998/2012/vocab/structure/#" lang="en" xml:lang="en">
  <head>
    <title>Project 10: Intruder Alarm with Email Notifications</title>
    <link href="../styles/9781593278717.css" rel="stylesheet" type="text/css"/>
    <link href="../68851547a55f.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <div id="sbo-rt-content"><h2 class="h2" id="ch10"><span epub:type="pagebreak" id="page_136"/><strong>10<br/>Intruder Alarm with Email Notifications</strong></h2>
<p class="noindent"><span class="violet">In this project, you’ll create an intruder alarm that sends you email notifications. The alarm will detect whether someone has trespassed onto forbidden territory using a passive infrared (PIR) motion sensor. When the PIR motion sensor detects movement, it will send a warning email.</span></p>
<div class="image"><span epub:type="pagebreak" id="page_137"/><img src="../images/f0137-01.jpg" alt="image"/></div>
<p class="cap"><span class="violet"><strong>PARTS REQUIRED</strong></span></p>
<p class="cap1">Raspberry Pi</p>
<p class="cap1">Breadboard</p>
<p class="cap1">PIR mot ion sensor HC-SR501</p>
<p class="cap1">Two 5 mm LEDs (different colors)</p>
<p class="cap1">Two 330 Ω resistors</p>
<p class="cap1">Pushbutton</p>
<p class="cap1">Jumper wires</p>
<h3 class="h3" id="lev108"><span epub:type="pagebreak" id="page_138"/><span class="violet"><strong>INTRODUCING THE PIR MOTION SENSOR</strong></span></h3>
<p class="noindent">You’ve probably seen motion sensors in a wide variety of applications. They’re used in security lights, in commercial building lights that turn on when you walk by, and in burglar alarms.</p>
<p class="indent">A PIR motion sensor (see <a href="ch10.xhtml#ch10fig1">Figure 10-1</a>) measures infrared light emitted from objects in its field of view. It detects motion based on changes in infrared light, which indicate changes in temperature. This makes it ideal for detecting humans or animals because it will pick up living things that move within its range but not inanimate objects, like a leaf blowing in the wind. You can program the Pi to react to changes in infrared light by triggering an event such as turning on a light, sounding an alarm, or, as we’ll do in this project, sending an email.</p>
<div class="image"><a id="ch10fig1"/><img src="../images/f0138-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 10-1:</strong> PIR motion sensor</p>
<p class="indent">The sensor outputs HIGH if it detects movement or LOW if it doesn’t, and it has only 3 pins: VCC, GND, and data. Data outputs a 3.3 V signal, perfect for your Pi!</p>
<h3 class="h3" id="lev109"><span class="violet"><strong>SENDING AN EMAIL WITH PYTHON</strong></span></h3>
<p class="noindent">Python’s email library makes it straightforward to send emails through Python. We’ll write that script now before assembling the parts.</p>
<h4 class="h4" id="lev110"><span class="violet"><strong>Finding Your SMTP Server Details</strong></span></h4>
<p class="noindent">To send emails through code, you need to include your <em>Simple Mail Transfer Protocol (SMTP)</em> server details. SMTP is an internet standard for email transmission, and each email provider has a different SMTP server.</p>
<p class="indent">These details include your service provider’s <em>server address</em> and <em>port</em> and whether it uses <em>Transport Layer Security (TLS)</em>. TLS is <span epub:type="pagebreak" id="page_139"/>a protocol for establishing a secure connection between two email servers. To get this information simply search the internet for <em>SMTP server settings</em> along with the name of your email provider. You’ll plug these details into the script to personalize it.</p>
<h4 class="h4" id="lev111"><span class="violet"><strong>The Email-Sending Script</strong></span></h4>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>Don’t name your file</em> email.py <em>because that’s a Python library name, and your script won’t work.</em></p>
</div>
<p class="noindent">Open <strong>Python 3 (IDLE)</strong> and go to <strong>File</strong> <span class="ent">▸</span> <strong>New File</strong> to create a new script. Copy the code in <a href="ch10.xhtml#ch10list1">Listing 10-1</a> to the Python Editor and save the script as <em>send_email.py</em> inside the <em>Sensors</em> folder (remember that you can download all the scripts at <em><a href="https://www.nostarch.com/RaspberryPiProject/">https://www.nostarch.com/RaspberryPiProject/</a></em>):</p>
<p class="listing" id="ch10list1"><strong>LISTING 10-1:</strong> The email notification script</p>
<div class="box">
<p class="programs"><span class="ent">➊</span> <span class="orange">import</span> smtplib<br/>  <span class="orange">from</span> email.mime.text <span class="orange">import</span> MIMEText<br/><br/>  <span class="red1">#replace the next three lines with your credentials</span><br/><span class="ent">➋</span> from_email_addr = <span class="green">'</span><span class="green"><em>YOUR_EMAIL@gmail.com</em></span><span class="green">'</span><br/>  from_email_password = <span class="green">'</span><span class="green"><em>YOUR_EMAIL_PASSWORD</em></span><span class="green">'</span><br/>  to_email_addr = <span class="green">'</span><span class="green"><em>TO_YOUR_OTHER_EMAIL@gmail.com</em></span><span class="green">'</span><br/><br/>  <span class="red1">#set your email message</span><br/><span class="ent">➌</span> body = <span class="green">'Motion was detected in your room.'</span><br/>  msg = MIMEText(body)<br/><br/>  <span class="red1">#set sender and recipient</span><br/>  msg[<span class="green">'From'</span>] = from_email_addr<br/>  msg[<span class="green">'To'</span>] = to_email_addr<br/><br/>  <span class="red1">#set your email subject</span><br/>  msg[<span class="green">'Subject'</span>] = <span class="green">'INTRUDER ALERT'</span><br/><br/>  <span class="red1">#connecting to server and sending email</span><br/>  <span class="red1">#edit the following line with your provider's SMTP server details</span><br/><span class="ent">➍</span> server = smtplib.SMTP(<span class="green">'</span><span class="green"><em>smtp.gmail.com</em></span><span class="green">'</span>, <em>587</em>)<br/>  <span class="red1">#comment out the next line if your email provider doesn't use TLS</span><br/>  server.starttls()<br/><span class="ent">➎</span> server.login(from_email_addr, from_email_password)<br/>  server.sendmail(from_email_addr, to_email_addr, msg.as_string())<br/>  server.quit()<br/>  <span class="purple">print</span>(<span class="green">'Email sent'</span>)</p>
</div>
<div class="note">
<p class="notet"><span class="red"><strong>WARNING</strong></span></p>
<p class="notep"><em>If you use the snippet at</em> <span class="ent">➎</span> <em>inside a <span class="literal">while</span> loop without a delay, you will fill your inbox with thousands of emails and your account will probably be blocked, so make sure to include a delay if you use this snippet in any other project!</em></p>
</div>
<p class="indent">You start by importing the libraries you need for SMTP and email-related functions: smtplib and MIMEText <span class="ent">➊</span>. Next, you create variables for the email address to send from, that email’s password, and an email address to send to <span class="ent">➋</span>. We suggest you create a second email to send the notifications to your everyday email because you will be giving less secure apps access to the account you send <span epub:type="pagebreak" id="page_140"/>from. Make sure that you input your own information for these strings.</p>
<p class="indent">The code block at <span class="ent">➌</span> writes the email. You start by creating a <span class="literal">body</span> variable that stores your email body text. Then you create an object called <span class="literal">msg</span> that generates the email itself using <span class="literal">msg = MIMEText(body)</span>. Feel free to change the email body and subject by changing the string in the <span class="literal">body</span> and <span class="literal">msg['Subject']</span> variables, respectively.</p>
<p class="indent">At <span class="ent">➍</span>, you establish communication with an SMTP server. Pass the provider’s SMTP server address as a string as the first argument to <span class="literal">smtplib.SMTP()</span>, and the port as an int as the second argument. In this script, we’re using a Gmail SMTP server and port. If you use another email provider, make sure to change those values.</p>
<p class="indent">The <span class="literal">server.starttls()</span> function is necessary for email providers that use TLS to encrypt messages. If your email provider doesn’t use TLS, you can remove or comment out that line.</p>
<p class="indent">Next, the script logs into the sending email account <span class="ent">➎</span>, sends the email, and stops communication with the server. Last, the script prints an <span class="literal">'Email sent'</span> message to the Python shell to let the user know an email was sent.</p>
<h4 class="h4" id="lev112"><span class="violet"><strong>Running the Email-Sending Script</strong></span></h4>
<p class="noindent">It’s now time to see your script in action! Save your script and press <strong>F5</strong> or go to <strong>Run</strong> <span class="ent">▸</span> <strong>Run Module</strong> to run the script. Then check the email inbox you sent the message to. You should have a new email. You can see an email we received using this script in <a href="ch10.xhtml#ch10fig2">Figure 10-2</a>.</p>
<div class="image"><a id="ch10fig2"/><img src="../images/f0140-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 10-2:</strong> Email sent with <em>send_email.py</em></p>
<p class="indent">If you haven’t received an email, verify that the email and SMTP information in <em>send_email.py</em> are correct. Also verify that you have given permission to let less secure apps use your account in your email account settings.</p>
<h3 class="h3" id="lev113"><span epub:type="pagebreak" id="page_141"/><span class="violet"><strong>WIRING THE CIRCUIT</strong></span></h3>
<p class="noindent">Now let’s wire your PIR sensor to your Raspberry Pi so it can send you emails when the sensor detects movement. You’ll also include two LEDs into your system, one to indicate whether the alarm is armed and one to indicate whether it has been triggered, as well as a pushbutton to arm and disarm the sensor.</p>
<p class="indent">Follow these steps to build the intruder alarm circuit, using <a href="ch10.xhtml#ch10fig3">Figure 10-3</a> as a reference.</p>
<div class="image"><a id="ch10fig3"/><img src="../images/f0141-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 10-3:</strong> Circuit for the intruder alarm</p>
<ol>
<li class="noindent"><p class="list">Connect GND of the Pi to one of the breadboard’s blue rails.</p></li>
<li class="noindent"><p class="list">Insert a red LED and a green LED into the breadboard. Connect the green LED’s positive lead to GPIO 18 through a 330 Ω resistor, with the resistor between the LED lead and the GPIO pin, and connect the negative lead to the GND rail. Connect the red LED’s positive lead to GPIO 17 through another 330 Ω resistor and connect the negative lead to the GND rail.</p></li>
<li class="noindent"><p class="list">Insert the pushbutton in the middle of the breadboard so that it bridges the center break, as shown in <a href="ch10.xhtml#ch10fig3">Figure 10-3</a>. Connect the pin at the bottom right to the GND rail and the pin at the bottom left to GPIO 2.</p></li>
<li class="noindent"><p class="list">Connect the PIR motion sensor with the connections in the following table.</p></li>
</ol>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="border_th-l"><p class="tab_th"><span epub:type="pagebreak" id="page_142"/><strong>PIR MOTION SENSOR</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>RASPBERRY PI</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">GND</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">GND</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">OUT</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">GPIO 4</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-l"><p class="tabc"><span class="violet">VCC</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="violet">5 V</span></p></td>
</tr>
</tbody>
</table>
<h3 class="h3" id="lev114"><span class="violet"><strong>WRITING THE SCRIPT</strong></span></h3>
<p class="noindent">Open <strong>Python 3 (IDLE)</strong> and go to <strong>File</strong> <span class="ent">▸</span> <strong>New File</strong> to create a new script. Enter the code in <a href="ch10.xhtml#ch10list2">Listing 10-2</a> into the new file and save the script as <em>intruder_alarm.py</em> inside the <em>Sensors</em> folder (remember that you can download all the scripts at <em><a href="https://www.nostarch.com/RaspberryPiProject/">https://www.nostarch.com/RaspberryPiProject/</a></em>):</p>
<p class="listing" id="ch10list2"><strong>LISTING 10-2:</strong> The intruder alarm script</p>
<div class="box">
<p class="programs">  <span class="red1">#import necessary libraries</span><br/><span class="ent">➊</span> <span class="orange">from</span> gpiozero <span class="orange">import</span> LED, Button, MotionSensor<br/>  <span class="orange">import</span> smtplib<br/>  <span class="orange">from</span> email.mime.text <span class="orange">import</span> MIMEText<br/>  <span class="orange">from</span> signal <span class="orange">import</span> pause<br/><br/>  <span class="red1">#create objects to refer to each LED, the button, and the PIR sensor</span><br/><span class="ent">➋</span> led_status = LED(17)<br/>  led_triggered = LED(18)<br/>  button = Button(2)<br/>  pir = MotionSensor(4)<br/><br/>  <span class="red1">#control variables</span><br/><span class="ent">➌</span> motion_sensor_status = <span class="orange">False</span><br/>  email_sent = <span class="orange">False</span><br/><br/>  <span class="red1">#arm or disarm the PIR sensor</span><br/><span class="ent">➍</span> <span class="orange">def</span> <span class="blue">arm_motion_sensor()</span>:<br/>      <span class="orange">global</span> email_sent<br/>      <span class="orange">global</span> motion_sensor_status<br/>      <span class="orange">if</span> motion_sensor_status == <span class="orange">True</span>:<br/>          motion_sensor_status = <span class="orange">False</span><br/>          led_status.off()<br/>          led_triggered.off()<br/>      <span class="orange">else</span>:<br/>          motion_sensor_status = <span class="orange">True</span><br/>          email_sent = <span class="orange">False</span><br/>          led_status.on()<br/><br/>  <span class="red1">#send email when motion is detected and the PIR sensor is armed</span><br/><span class="ent">➎</span> <span class="orange">def</span> <span class="blue">send_email()</span>:<br/>      <span class="orange">global</span> email_sent<br/>      <span class="orange">global</span> motion_sensor_status<br/>      <span class="orange">if</span>(motion_sensor_status == <span class="orange">True</span> <span class="orange">and</span> email_sent == <span class="orange">False</span>):<br/><br/><span epub:type="pagebreak" id="page_143"/>          <span class="red1">#replace the next three lines with your credentials</span><br/>          from_email_addr = <span class="green">'</span><span class="green"><em>YOUR_EMAIL@gmail.com</em></span><span class="green">'</span><br/>          from_email_password = <span class="green">'</span><span class="green"><em>YOUR_EMAIL_PASSWORD</em></span><span class="green">'</span><br/>          to_email_addr = <span class="green">'</span><span class="green"><em>TO_YOUR_OTHER_EMAIL@gmail.com</em></span><span class="green">'</span><br/><br/>         <span class="red1">#set your email message</span><br/>          body = <span class="green">'Motion was detected in your room.'</span><br/>          msg = MIMEText(body)<br/><br/>          <span class="red1">#set sender and recipient</span><br/>          msg[<span class="green">'From'</span>] = from_email_addr<br/>          msg[<span class="green">'To'</span>] = to_email_addr<br/><br/>          <span class="red1">#set your email subject</span><br/>          msg[<span class="green">'Subject'</span>] = <span class="green">'INTRUDER ALERT'</span><br/><br/>          <span class="red1">#connect to server and send email</span><br/>          <span class="red1">#edit this line with your provider's SMTP server details</span><br/>          server = smtplib.SMTP(<span class="green">'</span><span class="green"><em>smtp.gmail.com</em></span><span class="green">'</span>, <em>587</em>)<br/>          <span class="red1">#comment out this line if your provider doesn't use TLS</span><br/>          server.starttls()<br/>          server.login(from_email_addr, from_email_password)<br/>          server.sendmail(from_email_addr, to_email_addr,<br/>  msg.as_string())<br/>          server.quit()<br/>          email_sent = <span class="orange">True</span><br/>          led_triggered.on()<br/>          <span class="purple">print</span>(<span class="green">'Email sent'</span>)<br/><br/>  <span class="red1">#assign a function that runs when the button is pressed</span><br/><span class="ent">➏</span> button.when_pressed = arm_motion_sensor<br/>  <span class="red1">#assign a function that runs when motion is detected</span><br/><span class="ent">➐</span> pir.when_motion = send_email<br/><br/><span class="ent">➑</span> pause()</p>
</div>
<p class="indent">This code is really straightforward and should all be familiar from <a href="ch10.xhtml#ch10list1">Listing 10-1</a>. You start by importing the needed libraries <span class="ent">➊</span> and creating <span class="literal">gpiozero</span> objects to refer to the LEDs, button, and motion sensor <span class="ent">➋</span>. At <span class="ent">➌</span>, you create the <span class="literal">motion_sensor_status</span> and <span class="literal">email_sent</span> control variables to identify whether the motion sensor was triggered and whether an email has been sent. You then create the <span class="literal">arm_motion_sensor()</span> function that arms and disarms the motion sensor when you press the pushbutton <span class="ent">➍</span>. The <span class="literal">send_email()</span> function at <span class="ent">➎</span> sends an email when the sensor detects motion, as long as the sensor is armed and the <span class="literal">email_sent</span> variable is equal to <span class="literal">False</span>.</p>
<p class="indent">Last, you assign functions to events: the <span class="literal">arm_motion_sensor()</span> function is called when the pushbutton is pressed <span class="ent">➏</span>, and the <span class="literal">send_email()</span> function is called when motion is detected <span class="ent">➐</span>. The <span class="literal">pause()</span> <span epub:type="pagebreak" id="page_144"/>function at the end of the code keeps the script running for events to be detected <span class="ent">➑</span>.</p>
<p class="indent">Notice that the <span class="literal">send_email()</span> function has an <span class="literal">if</span> statement condition that sets the script to send an email only if motion is detected and if the <span class="literal">email_sent</span> variable is equal to <span class="literal">False</span>. When an email is sent out, the <span class="literal">email_sent</span> variable changes to <span class="literal">True</span> and your script sends no more emails. You set the <span class="literal">email_sent</span> variable to <span class="literal">False</span> again by pressing the pushbutton twice, rearming the alarm.</p>
<p class="indent">This condition prevents the script from sending you a lot of unnecessary emails. For example, say you left your dog home when you were out and it triggered the sensor; with this condition, you only receive one email saying that motion was detected. If you didn’t have this condition, you would receive endless emails until your dog moved out of the sensor range.</p>
<p class="indent">Press <strong>F5</strong> or go to <strong>Run</strong> <span class="ent">▸</span> <strong>Run Module</strong> to run the script. Arm the sensor by pressing the pushbutton; the red status LED should light up. Test the alarm by moving your hand in front of the motion sensor. You should receive a new message in your inbox and the triggered green LED should light up.</p>
<p class="indent">Place this circuit in a strategic place and wait to see if someone enters your room while you’re out.</p>
<h3 class="h3" id="lev115"><span class="violet"><strong>TAKING IT FURTHER</strong></span></h3>
<p class="noindent">This project showed you how to use the PIR motion sensor with the Raspberry Pi and how to send emails with Python. These are handy skills that you can add to what you’ve learned in other projects to invent your own devices. Here are some simple ideas for projects you can build with the motion sensor:</p>
<ul>
<li class="noindent">Add a piezo buzzer to your alarm circuit so that when motion is detected not only is an email sent but an alarm is also sounded.</li>
<li class="noindent">Automate your room’s lights to automatically turn on when you enter. You may need a relay to do this—check <a href="ch16.xhtml#ch16">Project 16</a> where we explain how to use a relay.</li>
<li class="noindent">Use a relay and a photoresistor to make a security nightlight that turns on only when movement is detected in the dark.</li>
</ul>
</div>
  </body>
</html>
