<html><head></head><body>
<div id="sbo-rt-content" class="calibre1"><section aria-labelledby="ch20" epub:type="chapter" role="doc-chapter">
<hgroup>
<h2 class="title" id="ch20">
<span class="cn"><span aria-label=" Page 231. " epub:type="pagebreak" id="pg_231" role="doc-pagebreak" class="calibre2"/><span class="sans_dogma_ot_bold_b_">20</span></span>
<span class="ct1"><span class="sans_dogma_ot_bold_b_">ADVANCED FOR TECHNIQUES</span></span>
</h2>
</hgroup>
<figure class="opener"><img alt="" class="opener1" height="407" src="../images/chapter.jpg" width="408"/>
</figure>
<p class="chapterintro">The previous three chapters have shown the power of the <span class="sans_thesansmonocd_w5regular_1">for</span> command, but they’ve also demonstrated how tricky it can be to use and even exposed some limitations. In this chapter, I’ll explore some advanced topics, including techniques for working around some of those limitations.</p>
<p class="tx">In this chapter, I’ll explain how to perform the following tasks:</p>
<ul class="ul">
<li class="listbullet">Make the interpreter honor null values between consecutive delimiter characters in the data interrogated by the <span class="sans_thesansmonocd_w5regular_">for /F</span> command</li>
<li class="listbullet">Force a string to uppercase (or lowercase) with traditional Batch or by embedding either a PowerShell or Python command into the Batch code, a technique you can extend to other commands, languages, and applications</li>
<li class="listbullet">Implement two levels of delayed expansion inside the code block of a <span class="sans_thesansmonocd_w5regular_">for</span> command</li>
<li class="listbullet">Handle escaping in a <span class="sans_thesansmonocd_w5regular_">for</span> command, particularly using the double quote in the <span class="sans_thesansmonocd_w5regular_">delims</span> clause</li>
</ul>
<p class="tx"><span aria-label=" Page 232. " epub:type="pagebreak" id="pg_232" role="doc-pagebreak"/>These techniques will allow you to process more types of data and more complex variables. If you code bat files long enough, at least a couple of these topics will become relevant to you. More important, they should demonstrate a means of problem solving that will spark your imagination when other yet unknown problems arise.</p>
<section aria-labelledby="sec1" epub:type="division">
<h3 class="h" id="sec1"><span id="h1-138"/><span class="sans_futura_std_bold_b_">Honoring Nulls</span></h3>
<p class="tni">In <span class="xref"><a href="chapter19.xhtml" class="calibre3">Chapter 19</a></span>, I alluded to the fact that when using the <span class="sans_thesansmonocd_w5regular_">delims</span> clause to divvy a string up into individual tokens, the interpreter doesn’t honor nulls. Consider the contents of a file named <i class="calibre6">staff.csv</i> that contains five items in each employee’s record: first, middle, and last names followed by job title and government ID:</p>
<pre class="pre"><code class="calibre11">Amy,Amanda,Andersen,Architect,111-11-1111
Colin,,Clark,Coder,222-22-2222
Mai,Maria,McManus,Manager,333-33-3333
</code></pre>
<p class="tx">The data is well organized, but not very readable. However, the following code displays a rudimentary report to the console with data from the first four tokens, while not displaying the sensitive data at the end of the record—or at least that’s the intention:</p>
<pre class="pre"><code class="calibre11">set cnt=0
for /F "usebackq tokens=1-4 delims=," %%a in ("C:\Batch\staff.csv") do (
   set /A cnt += 1
   &gt; con echo Employee !cnt!:
   &gt; con echo    First Name: %%a
   &gt; con echo   Middle Name: %%b
   &gt; con echo     Last Name: %%c
   &gt; con echo     Job Title: %%d
)
</code></pre>
<p class="tx">The first two records generate the following, but notice that there’s a major problem:</p>
<pre class="pre"><code class="calibre11">Employee 1:
   First Name: Amy
  Middle Name: Amanda
    Last Name: Andersen
    Job Title: Architect
Employee 2:
   First Name: Colin
  Middle Name: Clark
    Last Name: Coder
    Job Title: 222-22-2222
</code></pre>
<p class="tx"><span aria-label=" Page 233. " epub:type="pagebreak" id="pg_233" role="doc-pagebreak"/>Colin doesn’t have a middle name as you can see in the data <span class="sans_thesansmonocd_w5regular_">Colin,,Clark</span>, but the <span class="sans_thesansmonocd_w5regular_">for /F</span> command just skips over the null between the two commas, skewing the later data and exposing Colin’s government ID. In many situations, such as when delimiting on any number of spaces, this behavior is exactly what you might want as a coder, but not here. When presented with data like this, you need a means of forcing Batch to honor the null.</p>
<p class="tx">This solution inserts a space between consecutive comma delimiters with the use of nested <span class="sans_thesansmonocd_w5regular_">for /F</span> commands:</p>
<pre class="pre"><code class="calibre11">set cnt=0
<span aria-label="annotation1" class="codeannotationhang">❶</span> for /F "usebackq tokens=*" %%r in ("C:\Batch\staff.csv") do (
   set inRec=%%r
 <span aria-label="annotation2" class="code_codeannotation">❷</span> for /F "tokens=1-4 delims=," %%a in ("!inRec:,,=, ,!") do (
      set /A cnt += 1
      &gt; con echo Employee !cnt!:
      &gt; con echo    First Name: %%a
    <span aria-label="annotation3" class="code_codeannotation">❸</span> &gt; con echo   Middle Name: %%b
      &gt; con echo     Last Name: %%c
      &gt; con echo     Job Title: %%d
)  )
</code></pre>
<p class="tx">At the beginning of the outer <span class="sans_thesansmonocd_w5regular_">for /F</span> command <span aria-label="annotation1" class="codeannotation">❶</span>, I store the entire record in the <span class="sans_thesansmonocd_w5regular_">inRec</span> variable and then use it as text input of the inner <span class="sans_thesansmonocd_w5regular_">for /F</span> command <span aria-label="annotation2" class="codeannotation">❷</span>, but take a close look at that input: <span class="sans_thesansmonocd_w5regular_">!inRec:,,=, ,!</span>. First, I resolve <span class="sans_thesansmonocd_w5regular_">inRec</span> with exclamation marks because I’ve assigned it in the code block. More important, this syntax replaces double commas with two commas separated by a space, which in effect inserts a space. The inner <span class="sans_thesansmonocd_w5regular_">for /F</span> command <span aria-label="annotation2" class="codeannotation">❷</span> passes four comma-delimited tokens into its code block, and when processing Colin’s data, that inserted space becomes the second token, <span class="sans_thesansmonocd_w5regular_">%%b</span>, and I write it to the console as the middle name <span aria-label="annotation3" class="codeannotation">❸</span> with the rest of the information.</p>
<p class="tx">The report for Amy is unchanged, and Colin’s entry looks much better:</p>
<pre class="pre"><code class="calibre11">Employee 2:
   First Name: Colin
  Middle Name: 
    Last Name: Clark
    Job Title: Coder
</code></pre>
<p class="tx">His middle name correctly displays as nothing, and his government ID is hidden from sight.</p>
<p class="tx">While these nested commands work for this particular data, the logic is far from bulletproof. It doesn’t work when a null is the very first token in a record because such a null doesn’t present as double commas; the null first token manifests as just a comma leading the record, followed by the second token. It also doesn’t catch two consecutive nulls, or triple commas, inserting a space before the second comma, but not after it. Finally, these nested <span class="sans_thesansmonocd_w5regular_">for</span> commands change the null to a space, so it is altered. Depending on how you plan to use the data, that often won’t be an issue, but at times you’ll want to maintain data integrity.</p>
<p class="tx"><span aria-label=" Page 234. " epub:type="pagebreak" id="pg_234" role="doc-pagebreak"/>All of these stipulations might seem to disqualify this approach, but if you know your data, it may be perfectly acceptable. For instance, in this example data, if you’re confident that the middle name is the only token that might be missing and you’re fine writing an extra space after the tag for the middle name, this syntax works just fine. But there’s always room for improvement.</p>
<p class="tx">With a few tweaks to the prior solution, the following code corrects for all of the limitations just discussed:</p>
<pre class="pre"><code class="calibre11">set cnt=0
<span aria-label="annotation1" class="codeannotationhang">❶</span> for /F "usebackq tokens=*" %%r in ("C:\Batch\staff.csv") do (
   set inRec=%%r
 <span aria-label="annotation2" class="code_codeannotation">❷</span> for /F "tokens=1-4 delims=," %%a in ("_!inRec:,=,_!") do (
    <span aria-label="annotation3" class="code_codeannotation">❸</span> set a=%%a&amp; set b=%%b&amp; set c=%%c&amp; set d=%%d
      set /A cnt += 1
      &gt; con echo Employee !cnt!:
    <span aria-label="annotation4" class="code_codeannotation">❹</span> &gt; con echo     First Name: !a:~1!
      &gt; con echo   Middle Name: !b:~1!
      &gt; con echo     Last Name: !c:~1!
      &gt; con echo     Job Title: !d:~1!
)  )
</code></pre>
<p class="tx">The outer <span class="sans_thesansmonocd_w5regular_">for /F</span> command <span aria-label="annotation1" class="codeannotation">❶</span> is the same. The inner <span class="sans_thesansmonocd_w5regular_">for /F</span> command <span aria-label="annotation2" class="codeannotation">❷</span> is still passing four comma-delimited tokens, but its input (<span class="sans_thesansmonocd_w5regular_">_!inRec:,=,_!</span>) prepends every token with an underscore. This leading underscore prepends the entire record, which in effect prepends just the first token with an underscore. Then the replacement syntax changes every comma to a comma followed by an underscore, which inserts an underscore after every comma, effectively prepending each of the remaining tokens with an underscore. The null token is now an underscore (<span class="sans_thesansmonocd_w5regular_">,_,</span>), so the interpreter honors it.</p>
<p class="tx">While this solves one problem, it causes another; we must strip the newly minted leading underscore off each data item or token before using it. I don’t often merge multiple commands on a single line of code, but I’ve done so with four <span class="sans_thesansmonocd_w5regular_">set</span> commands because they’re short, simple, and redundant <span aria-label="annotation3" class="codeannotation">❸</span>. The first command, <span class="sans_thesansmonocd_w5regular_">set a=%%a</span>, assigns the token <span class="sans_thesansmonocd_w5regular_">%%a</span> to the variable <span class="sans_thesansmonocd_w5regular_">a</span>, allowing me to substring off the first character later in the code block, <span class="sans_thesansmonocd_w5regular_">!a:~1!</span> <span aria-label="annotation4" class="codeannotation">❹</span>, leaving only the data after the leading underscore, which is the original content. I then use the same technique for the other three tokens because I’m confident that every token has a leading underscore.</p>
<p class="tx">This technique that prepends every token with a character and then strips it off is far more universal.</p>
</section>
<section aria-labelledby="sec2" epub:type="division">
<h3 class="h" id="sec2"><span id="h1-139"/><span class="sans_futura_std_bold_b_">Forcing a String to Uppercase</span></h3>
<p class="tni">If you haven’t picked up on this yet, I love Batch coding, but there are times when another coding language offers a different solution, maybe even a better solution, from what I can devise in Batch. For instance, forcing text <span aria-label=" Page 235. " epub:type="pagebreak" id="pg_235" role="doc-pagebreak"/>to uppercase is a trivial exercise in modern languages that have some sort of callable method, such as <span class="sans_thesansmonocd_w5regular_">.toUpper()</span> found in PowerShell or Python’s <span class="sans_thesansmonocd_w5regular_">.upper()</span>. Unfortunately, Batch doesn’t have a command, or any built-in mechanism, that converts text to uppercase, but I’ll show some different means of completing this task.</p>
<p class="tx">By now you’ve seen a few instances of where we’ve built something from scratch, and for this solution we’ll use the case-insensitivity endemic to Batch to create a routine that actually alters the case of text. The following routine accepts a variable name of a string as input and returns the same variable with its contents forced to uppercase:</p>
<pre class="pre"><code class="calibre11">:ToUpper
 for %%u in (A B C D E F G H I J K L M N O P Q R S T U V W X Y Z) do (
    set %~1=!%~1:%%u=%%u!
 )
 goto :eof
</code></pre>
<p class="tx">This optionless <span class="sans_thesansmonocd_w5regular_">for</span> command executes the <span class="sans_thesansmonocd_w5regular_">set</span> command to update the variable with delayed expansion 26 times, once for each character of the alphabet, where each pass resolves <span class="sans_thesansmonocd_w5regular_">%%u</span> to an uppercase character. (Maybe I should’ve broken with my convention and used <span class="sans_thesansmonocd_w5regular_">%%U</span> here.)</p>
<p class="tx">The first pass changes <span class="sans_thesansmonocd_w5regular_">A</span> to <span class="sans_thesansmonocd_w5regular_">A</span>, which looks redundant until you remember that the Batch text replacement syntax is case-insensitive, meaning that this technique changes <span class="sans_thesansmonocd_w5regular_">A</span> and <span class="sans_thesansmonocd_w5regular_">a</span> both to <span class="sans_thesansmonocd_w5regular_">A</span>. Next, we change <span class="sans_thesansmonocd_w5regular_">B</span> to <span class="sans_thesansmonocd_w5regular_">B</span>, <span class="sans_thesansmonocd_w5regular_">C</span> to <span class="sans_thesansmonocd_w5regular_">C</span>, and so on until we exhaust the entire alphabet.</p>
<p class="tx">When the <span class="sans_thesansmonocd_w5regular_">for</span> loop completes, it has changed all lowercase letters to their uppercase counterparts without affecting the existing uppercase letters and nonalphabetical characters. The variable passed into this logic as the lone parameter now contains the uppercase text.</p>
<p class="tx">You can create a similar routine to force a string to lowercase by changing the input list of values to the set of all lowercase characters. The only other change might be to the label, which you might update to something like <span class="sans_thesansmonocd_w5regular_">:ToLower</span>.</p>
<section aria-labelledby="sec3" epub:type="division">
<h4 class="h1" id="sec3"><span id="h2-65"/><span class="sans_futura_std_heavy_oblique_bi_">Embedding a PowerShell Command</span></h4>
<p class="tni">An alternative solution is to use that PowerShell command mentioned earlier as input to a Batch <span class="sans_thesansmonocd_w5regular_">for /F</span> command. Yes, you read that correctly; you can embed logic from another coding language into Batch code. But before seeing the PowerShell command as part of the <span class="sans_thesansmonocd_w5regular_">for /F</span> command, let’s see it run at the command prompt.</p>
<p class="tx">If your Windows computer is loaded with PowerShell, you can execute PowerShell commands at the command prompt, and unless you purchased your computer before the first iPhone was released, it’s on there, packaged with every Windows operating system since XP SP2 (circa 2006).</p>
<p class="tx">Enter this at the command prompt:</p>
<pre class="pre"><code class="calibre11"><b class="calibre10">powershell 'Set this to Upper-Case'.toUpper^(^)</b></code></pre>
<p class="tni"><span aria-label=" Page 236. " epub:type="pagebreak" id="pg_236" role="doc-pagebreak"/>The interpreter writes the text between the single quotes to the console, with every alpha character capitalized.</p>
<p class="tx">At a glance, this looks like a Batch command named <span class="sans_thesansmonocd_w5regular_">powershell</span>, but there’s no such command. Instead, this is the program, <i class="calibre6">powershell.exe</i>, and the interpreter should find it as part of the <span class="sans_thesansmonocd_w5regular_">path</span> hierarchy (<i class="calibre6">C:\Windows\System32\WindowsPowerShell\v1.0\</i> on most computers). The argument to the program is the PowerShell command that converts text to uppercase, which happens to use dot notation, the antithesis of traditional Batch. The text being forced to uppercase is inside the single quotes, followed by the dot and the appropriate PowerShell method for the task with its parentheses escaped.</p>
<p class="tx">You can also put this command into a bat file, and it works great if you’re happy seeing <span class="sans_thesansmonocd_w5regular_">SET THIS TO UPPER-CASE</span> written to stdout, but you want this text assigned to a variable. That’s where the <span class="sans_thesansmonocd_w5regular_">for /F</span> command comes into play:</p>
<pre class="pre"><code class="calibre11">:ToUpper
 for /F "usebackq tokens=*" %%u in (`powershell '!%~1!'.toUpper^(^)`) do (
    set %~1=%%u
 )
 goto :eof
</code></pre>
<p class="tni">As in the first solution, this routine has one parameter that functions as input and output—that is, the name of the variable containing the text.</p>
<p class="tx">The back quotes encasing the input of the <span class="sans_thesansmonocd_w5regular_">for /F</span> command tell the interpreter that a command is the input, in this case an embedded PowerShell command. Notice that this command looks very much like the command that we earlier entered at the command prompt. The only difference is that <span class="sans_thesansmonocd_w5regular_">!%~1!</span> now replaces the hardcoded text. The <span class="sans_thesansmonocd_w5regular_">%~1</span> parameter resolves to the input variable name; then the exclamation marks and delayed expansion resolve the variable to its value. The output of the PowerShell command is the uppercase version of this text, and the interpreter sends that text into the code block as the variable <span class="sans_thesansmonocd_w5regular_">%%u</span> where we finally reassign it to the same input parameter: <span class="sans_thesansmonocd_w5regular_">%~1</span>.</p>
</section>
<section aria-labelledby="sec4" epub:type="division">
<h4 class="h1" id="sec4"><span id="h2-66"/><span class="sans_futura_std_heavy_oblique_bi_">Embedding a Python Command</span></h4>
<p class="tni">There’s no need to stop with a PowerShell command. Anything that you can enter at the command prompt can be valid input to a <span class="sans_thesansmonocd_w5regular_">for /F</span> command, including the invocation of any program, not just Batch commands. For this demonstration, I’ll invoke the Python runtime, but you can use the runtime for any language as long as you can execute it at the command prompt. You can even execute a program that you’ve written and compiled in another language and treat its output as input to a <span class="sans_thesansmonocd_w5regular_">for /F</span> command.</p>
<p class="tx">Unlike PowerShell, your Windows computer probably didn’t come with the Python runtime installed, but you can download it from <i class="calibre6"><a href="https://www.python.org/downloads/" class="calibre3">https://<wbr/>www<wbr/>.python<wbr/>.org<wbr/>/downloads<wbr/>/</a></i>. This isn’t a Python book (although No Starch Press does have some great offerings), so I won’t delve into the syntax in detail, but with Python installed on your computer, the following routine is functionally equivalent to the previous two that share the same label:</p>
<pre class="pre"><code class="calibre11"><span aria-label=" Page 237. " epub:type="pagebreak" id="pg_237" role="doc-pagebreak"/>:ToUpper
 set subopts=usebackq tokens=*
 for /F "%subopts%" %%u in (`python -c ^"print^('!%~1!'.upper^(^)^)^"`) do (
    set %~1=%%u
 )
 goto :eof
</code></pre>
<p class="tni">I promised not to delve, but very briefly, <span class="sans_thesansmonocd_w5regular_">python</span> is the extensionless executable, or runtime, and <span class="sans_thesansmonocd_w5regular_">-c</span> tells the runtime that a single Python command comes next. The <span class="sans_thesansmonocd_w5regular_">print()</span> function writes the output generated from what’s inside its parentheses, which is the resolved input variable encased in single quotes, a dot, and the Python method that converts a string to uppercase. The Python command is much easier to read when you remove the six escape characters: <span class="sans_thesansmonocd_w5regular_">"print('!%~1!'.upper())"</span>.</p>
<p class="tx">The <span class="sans_thesansmonocd_w5regular_">set</span> command in the code block once again assigns the output from the embedded command to its lone parameter. But also notice that I’m setting a variable to text containing both the <span class="sans_thesansmonocd_w5regular_">usebackq</span> keyword and the <span class="sans_thesansmonocd_w5regular_">tokens</span> clause, and then I resolve that text as part of the <span class="sans_thesansmonocd_w5regular_">for /F</span> command. There are two reasons for this. The first and most immediate is that the command wouldn’t have fit on the page otherwise (although it would’ve been perfectly valid). Second, this is another opportunity for me to remind you how we can piece together commands in an uncompiled scripting language.</p>
<p class="tx">The actual PowerShell and Python commands themselves are certainly simple, but the Batch machinations needed to use them do add some complexity. It’s usually not the first technique that comes to mind to solve a problem, but when you can really make use of a command from another language, the <span class="sans_thesansmonocd_w5regular_">for /F</span> command offers you an effective means of assigning its output.</p>
<blockquote class="calibre8">
<p class="warning"><span class="sans_dogma_ot_bold_b_1">NOTE</span></p>
</blockquote>
<p class="warning-txt"><i class="calibre6">In <a href="chapter19.xhtml" class="calibre3">Chapter 19</a>, for the sake of consistency, I recommended getting into the habit of using usebackq when a command is the input to a for /F command. Part of my rationale was that while neither the back quote nor the single quote is typically found in such commands, the single quote is the more likely of the two. For these last two examples, the keyword and encasing back quotes aren’t just good practice; they’re required because the embedded PowerShell and Python commands both contain single quotes.</i></p>
</section>
</section>
<section aria-labelledby="sec5" epub:type="division">
<h3 class="h" id="sec5"><span id="h1-140"/><span class="sans_futura_std_bold_b_">Two Levels of Delayed Expansion</span></h3>
<p class="tni">Delayed expansion is one great feature of Batch that’s not available in most other languages. As you gain experience and start building a more interesting and complex codebase, you’ll come upon the fairly common issue of handling two levels of delayed expansion inside a <span class="sans_thesansmonocd_w5regular_">for</span> command’s code block.</p>
<p class="tx">In <span class="xref"><a href="chapter3.xhtml" class="calibre3">Chapter 3</a></span>, I demonstrated delayed expansion by defining variables containing the culinary delights of five cities. Here are two:</p>
<pre class="pre"><code class="calibre11">set foodNash=Hot Chicken
set foodNYC=Thin Crust Pizza
</code></pre>
<p class="tx"><span aria-label=" Page 238. " epub:type="pagebreak" id="pg_238" role="doc-pagebreak"/>Using the same abbreviations, I also set up variables for the full name of each city:</p>
<pre class="pre"><code class="calibre11">set NashFull=Nashville
set NYCFull=New York City
</code></pre>
<p class="tx">Ultimately, the following <span class="sans_thesansmonocd_w5regular_">echo</span> command contains two examples of delayed expansion that resolve these variables, assuming that <span class="sans_thesansmonocd_w5regular_">city</span> is assigned a valid city abbreviation:</p>
<pre class="pre"><code class="calibre11">&gt; con echo The best !food%city%! can be found only in !%city%Full!.</code></pre>
<p class="tx">Now let’s build on this example to make a list of all 50 states in the United States and assign a culinary capital to each. For instance, while Jefferson City is the capital of Missouri, St. Louis with its frozen custard is considered by many its culinary capital. In the state where I grew up, Connecticut, a long-standing debate still brews between the thin crust pizza unique to New Haven and Middletown’s steamed cheeseburger. I’ve no desire to get into the middle of that rhubarb, but for the sake of this exercise, some authoritative body (me) has been given the power to define the culinary capital of each state, along with that city’s, and therefore that state’s, dish. Given a list of state postal abbreviation codes, I can define the culinary capital of each like so:</p>
<pre class="pre"><code class="calibre11">set culCapTN=Nash
set culCapNY=NYC
set culCapIL=Chic
set culCapLA=NO
set culCapMO=STL
</code></pre>
<p class="tx">For instance, the culinary capital of <span class="sans_thesansmonocd_w5regular_">TN</span> (Tennessee), <span class="sans_thesansmonocd_w5regular_">culCapTN</span>, is <span class="sans_thesansmonocd_w5regular_">Nash</span> (Nashville). Now we can use the two-digit state codes as input to a <span class="sans_thesansmonocd_w5regular_">for</span> command where delayed expansion resolves the culinary capital variable into city abbreviations. Then a second level of delayed expansion resolves those abbreviations into foods and full city names.</p>
<p class="tx">These state codes could be coming from data in a file, but to keep this exercise as simple as possible, I’m using a hardcoded list of state codes as the input to an optionless <span class="sans_thesansmonocd_w5regular_">for</span> command:</p>
<pre class="pre"><code class="calibre11">for %%s in (TN NY IL LA MO) do (
   set city=!culCap%%s!
   &gt; con echo The best !food%city%! can be found only in !%city%Full!.
)
</code></pre>
<p class="tx">The <span class="sans_thesansmonocd_w5regular_">%%s</span> variable resolves to the state code in each of the five passes. In the first pass of the data, <span class="sans_thesansmonocd_w5regular_">!culCap%%s!</span> resolves to <span class="sans_thesansmonocd_w5regular_">!culCapTN!</span>, which then resolves to <span class="sans_thesansmonocd_w5regular_">Nash</span>, which we assign to the <span class="sans_thesansmonocd_w5regular_">city</span> variable. Then the <span class="sans_thesansmonocd_w5regular_">echo</span> command, lifted verbatim from <span class="xref"><a href="chapter3.xhtml" class="calibre3">Chapter 3</a></span>, resolves the two examples of delayed expansion just as it did in the prior chapter, right?</p>
<p class="tx"><span aria-label=" Page 239. " epub:type="pagebreak" id="pg_239" role="doc-pagebreak"/>Wrong! If such a scenario had worked, I wouldn’t label it an “advanced technique.” While the interpreter successfully assigns a city abbreviation to <span class="sans_thesansmonocd_w5regular_">city</span>, when inside a code block such as this one, a variable has two different values: exclamation mark delimiters resolve it to the value it has taken on in the code block, and percent sign delimiters resolve it to its value before the block was ever executed.</p>
<p class="tx">Hence, <span class="sans_thesansmonocd_w5regular_">%city%</span> resolves to nothing (or whatever it was set to in prior code), and then <span class="sans_thesansmonocd_w5regular_">!food%city%!</span> resolves to <span class="sans_thesansmonocd_w5regular_">!food!</span>, which in turn most likely resolves to nothing as well. The code doesn’t hang or throw an abort—even worse, it just displays an incomplete sentence.</p>
<p class="tx">We’re in a quandary. Since <span class="sans_thesansmonocd_w5regular_">city</span> was set inside the code block, the only way of resolving it to its current value involves exclamation marks, but delayed expansion demands that we resolve the inner variable with percent signs. (When first faced with this dilemma, most every coder, if not every coder, tries interchanging the delimiters. Try if you must, but it just doesn’t work.) In some way, shape, or form, you must make <span class="sans_thesansmonocd_w5regular_">city</span> resolvable via percent signs.</p>
<p class="tx">One solution involves a hidden routine. This technique doesn’t assign the results of the first delayed expansion resolution to a variable such as <span class="sans_thesansmonocd_w5regular_">city</span>; instead, it passes the value to a routine:</p>
<pre class="pre"><code class="calibre11">for %%s in (TN NY IL LA MO) do (
   call :WriteFoodText "!culCap%%s!"
)
if 0 equ 1 (
  :WriteFoodText
   &gt; con echo The best !food%~1! can be found only in !%~1Full!.
   goto :eof
)
</code></pre>
<p class="tni">The code in the routine then resolves the city as a simple parameter with the <span class="sans_thesansmonocd_w5regular_">%~1</span> syntax. Since the routine is performing the resolution outside of the <span class="sans_thesansmonocd_w5regular_">for</span> command’s code block, the variable <span class="sans_thesansmonocd_w5regular_">!food%~1!</span> resolves nicely to <span class="sans_thesansmonocd_w5regular_">!foodTN!</span>, which resolves again to <span class="sans_thesansmonocd_w5regular_">Hot Chicken</span>.</p>
<p class="tx">This technique isn’t without issues, however. It’s not the type of involved routine that would normally lend itself to being placed at the end of a bat file, and it definitely would not appear in its own bat file. It’s really a single command (plus the label and terminating <span class="sans_thesansmonocd_w5regular_">goto :eof</span> command), so it’s best kept close to the <span class="sans_thesansmonocd_w5regular_">call</span> command. But if I had placed the label immediately after this <span class="sans_thesansmonocd_w5regular_">for</span> command, the interpreter would execute the routine once for each state and then again one more time when the <span class="sans_thesansmonocd_w5regular_">for</span> command completes and control falls to the next command. To correct for this, I use a clunky conditional clause that can never be true, <span class="sans_thesansmonocd_w5regular_">0 equ 1</span>, in an <span class="sans_thesansmonocd_w5regular_">if</span> command that acts as the routine’s gatekeeper.</p>
<p class="tx">This technique can easily confuse anyone reading the code, but it successfully conceals a hidden routine placed near a <span class="sans_thesansmonocd_w5regular_">call</span> command that is the only means of accessing it. It works, and I’ve used it often, but it’s not the kind of logic you’ll want to hang up on the fridge next to your kid’s artwork.</p>
<p class="tx"><span aria-label=" Page 240. " epub:type="pagebreak" id="pg_240" role="doc-pagebreak"/>The far more elegant solution is to nest a second <span class="sans_thesansmonocd_w5regular_">for</span> command inside the first:</p>
<pre class="pre"><code class="calibre11">for %%s in (TN NY IL LA MO) do (
   for /F "tokens=*" %%c in ("!culCap%%s!") do (
     &gt; con echo The best !food%%c! can be found only in !%%cFull!.
)  )
</code></pre>
<p class="tx">First, the <span class="sans_thesansmonocd_w5regular_">%%s</span> resolves to the state code; then <span class="sans_thesansmonocd_w5regular_">!culCap%%s!</span>, which resolves to the corresponding city abbreviation, is the string input to the inner <span class="sans_thesansmonocd_w5regular_">for</span> command, where we assign it to <span class="sans_thesansmonocd_w5regular_">%%c</span>. Hence, the inner <span class="sans_thesansmonocd_w5regular_">for</span> command is nothing more than a means of assigning the city to a variable that we can resolve with percent signs. Notice that I’ve replaced what was being resolved to null in the problem statement, <span class="sans_thesansmonocd_w5regular_">%city%</span>, with the <span class="sans_thesansmonocd_w5regular_">%%c</span> variable. Again, taking Tennessee as the example, <span class="sans_thesansmonocd_w5regular_">%%c</span> resolves to <span class="sans_thesansmonocd_w5regular_">Nash</span>, and then <span class="sans_thesansmonocd_w5regular_">!food%%c!</span> becomes <span class="sans_thesansmonocd_w5regular_">!foodNash!</span>, which in turn resolves to delicious <span class="sans_thesansmonocd_w5regular_">Hot Chicken</span>. Similarly, <span class="sans_thesansmonocd_w5regular_">!%%cFull!</span> resolves to <span class="sans_thesansmonocd_w5regular_">!NashFull!</span>, which resolves to <span class="sans_thesansmonocd_w5regular_">Nashville</span>. Now, that’s some fridge-worthy code!</p>
<p class="tx">I use the <span class="sans_thesansmonocd_w5regular_">/F</span> option with the inner <span class="sans_thesansmonocd_w5regular_">for</span> command along with double quotes encasing the text input. Setting the <span class="sans_thesansmonocd_w5regular_">tokens</span> keyword to an asterisk ensures that <span class="sans_thesansmonocd_w5regular_">%%c</span> resolves to the entire text string, even if it has embedded spaces, meaning that the code block executes exactly once. (A much simpler optionless <span class="sans_thesansmonocd_w5regular_">for</span> command would have worked as the inner <span class="sans_thesansmonocd_w5regular_">for</span> command for this particular data, but the <span class="sans_thesansmonocd_w5regular_">for /F</span> command is a more universal solution because it handles inputs both with and without embedded spaces.)</p>
<p class="tx">Both solutions detailed in this section write the following output to the console:</p>
<pre class="pre"><code class="calibre11">The best Hot Chicken can be found only in Nashville.
The best Thin Crust Pizza can be found only in New York City.
The best Deep Dish Pizza can be found only in Chicago.
The best Muffuletta Sandwich can be found only in New Orleans.
The best Frozen Custard can be found only in St Louis.
</code></pre>
<p class="tx">The problem statement that I’ve provided may seem a bit contrived, but the need for this technique presents itself often. More realistic examples usually involve a far more complex situation involving files, arrays, hash tables, and more topics I haven’t delved into yet. For instance, to retrieve a target path for a <span class="sans_thesansmonocd_w5regular_">robocopy</span> command, you might read the destination city from a file and then look up the city in a hash table to get that path. But every one of those situations boils down to the same issue: you need to use delayed expansion on a variable previously set in a code block. Be on the lookout for similar situations.</p>
</section>
<section aria-labelledby="sec6" epub:type="division">
<h3 class="h" id="sec6"><span id="h1-141"/><span class="sans_futura_std_bold_b_">Escaping with the for Command</span></h3>
<p class="tni">Escaping special characters in a <span class="sans_thesansmonocd_w5regular_">for</span> command is a challenge that can manifest itself in many different ways, and one such example is in the suboptions <span aria-label=" Page 241. " epub:type="pagebreak" id="pg_241" role="doc-pagebreak"/>clause. Input data is often completely outside of our hands as coders. It would be great if all data files were comma- or pipe-delimited, but many times you are forced to use a more complex set of delimiters. The worst possible situation is text delimited by the double quote. If you’re trying to extract six tokens, you might consider this suboptions clause, but it’s invalid:</p>
<pre class="pre"><code class="calibre11">"tokens=1-6 delims=""</code></pre>
<p class="tx">While the interpreter sees the first double quote correctly as the start of the clause, the second terminates the clause, and the third is out of context. But this cryptic-looking clause performs the task:</p>
<pre class="pre"><code class="calibre11">tokens^=1-6^ delims^=^"</code></pre>
<p class="tx">There’s no double quote opening the clause, and the double quote at the end doesn’t close the clause—it’s the sole entry in the set of delimiters. The double quotes encasing the clause are no more. This allows you to include the double quote in the <span class="sans_thesansmonocd_w5regular_">delims</span> clause, as long as you escape it with a preceding caret. But the lack of double quotes encasing the options clause causes other issues. Equal signs and even spaces are no longer protected by the encasing double quotes and are now also in need of escaping.</p>
<p class="tx">I’ve placed a caret before both equal signs. The space in between the two keyword clauses would terminate the larger suboptions clause, so that also needs escaping. That particular caret appears to trail the <span class="sans_thesansmonocd_w5regular_">6</span>, but it really leads the space. In a less-than-well-documented feature of Batch, you can drop the encasing double quotes as long as you escape special characters and spaces.</p>
<p class="tx">Now let’s put this all together and test it. Consider the very small file, <i class="calibre6">UglyData.txt</i>, with just this one line of data with five double quotes delimiting the six words:</p>
<pre class="pre"><code class="calibre11">This"is"some"messed"up"data</code></pre>
<p class="tx">This <span class="sans_thesansmonocd_w5regular_">for /F</span> command contains the options clause discussed earlier:</p>
<pre class="pre"><code class="calibre11">for /F tokens^=1-6^ delims^=^" %%a in (C:\Batch\UglyData.txt) do (
   &gt; con echo %%a %%f %%b no longer %%d %%e.
)
</code></pre>
<p class="tni">Here’s the output to the console:</p>
<pre class="pre"><code class="calibre11">This data is no longer messed up.</code></pre>
<p class="tx">In <span class="xref"><a href="chapter19.xhtml" class="calibre3">Chapter 19</a></span>, I mentioned that I usually use <span class="sans_thesansmonocd_w5regular_">usebackq</span> when reading a file. I didn’t here because the suboptions are already getting messy, but if you put double quotes around the input file, you would need to add <span class="sans_thesansmonocd_w5regular_">usebackq^</span> and a space before the <span class="sans_thesansmonocd_w5regular_">tokens</span> clause. (You’ll see something similar to this shortly.)</p>
<p class="tx"><span aria-label=" Page 242. " epub:type="pagebreak" id="pg_242" role="doc-pagebreak"/>The same principle works when there are multiple delimiters. Let’s make <i class="calibre6">UglyData.txt</i> even uglier by adding caret, pipe, percent sign, and ampersand delimiters:</p>
<pre class="pre"><code class="calibre11">This^is|some%messed"up&amp;data</code></pre>
<p class="tni">Now the following suboptions clause makes this work:</p>
<pre class="pre"><code class="calibre11">tokens^=1-6^ delims^=^"^|%%^^^&amp;</code></pre>
<p class="tx">A caret escapes all of these special characters (even the caret delimiter) except for one; we can only escape the percent sign with another percent sign.</p>
<p class="tx">The need for a double quote in the set of delimiters might not come up often, but this technique is indispensable when it does.</p>
<p class="tx">We aren’t done escaping just yet. In this next example, I’ll use the same data and write the same output to the console, but the source of the data will be different. I’ll pull the ugly data out of a file and set it to a variable, which will require changes to both the data and the <span class="sans_thesansmonocd_w5regular_">for /F</span> command.</p>
<p class="tx">I’ll start with the data. In <span class="xref"><a href="chapter14.xhtml" class="calibre3">Chapter 14</a></span>, you learned that when setting a variable, you must escape all special characters, but even this leaves you with a variable containing special characters that can’t be resolved later without exposing them. The solution is two levels of escaping:</p>
<pre class="pre"><code class="calibre11">set uglyData=This^^^^is^^^|some%%%%messed^^^"up^^^&amp;data</code></pre>
<p class="tx">With this <span class="sans_thesansmonocd_w5regular_">set</span> command, all of the double carets resolve to single carets. The interpreter discards all of the other carets because they are escaping other characters; the double percent signs resolve to one, resulting in four becoming two. Finally, the interpreter sets <span class="sans_thesansmonocd_w5regular_">uglyData</span> to the <span class="sans_thesansmonocd_w5regular_">This^^is^|some%%messed^"up^&amp;data</span> text. The next time we resolve this variable, the existing escape characters will be dropped.</p>
<p class="tx">There are changes to the <span class="sans_thesansmonocd_w5regular_">for /F</span> command as well:</p>
<pre class="pre"><code class="calibre11">for /F usebackq^ tokens^=1-6^ delims^=^"^|%%^^^&amp; %%a in ('%uglyData%') do (
   &gt; con echo %%a %%f %%b no longer %%d %%e.
)
</code></pre>
<p class="tni">The command contains the more complex <span class="sans_thesansmonocd_w5regular_">delims</span> clause with the set of five delimiters, all of which are escaped. The <span class="sans_thesansmonocd_w5regular_">%uglyData%</span> text input to the <span class="sans_thesansmonocd_w5regular_">for</span> command resolves to <span class="sans_thesansmonocd_w5regular_">This^is|some%messed"up&amp;data</span>, encased in single quotes, and the <span class="sans_thesansmonocd_w5regular_">usebackq</span> keyword is in place with its trailing escape character.</p>
<p class="tx">Since a double quote is part of the input, this <span class="sans_thesansmonocd_w5regular_">for /F</span> command must use single quotes around the input string, which necessitates the <span class="sans_thesansmonocd_w5regular_">usebackq</span> keyword. (It’s one of those blue moon situations mentioned in <span class="xref"><a href="chapter19.xhtml" class="calibre3">Chapter 19</a></span>.) Notice that Batch more easily handled the double quote when it was inside a file being read; parsing strings is usually more complex than parsing file data. Finally, we see <span class="sans_thesansmonocd_w5regular_">This data is no longer messed up.</span> written to the console.</p>
<p class="tx"><span aria-label=" Page 243. " epub:type="pagebreak" id="pg_243" role="doc-pagebreak"/>The biggest takeaway from this discussion is that you should always figure out how many levels of escaping to expect and make sure that the code can support all expected special characters in the input.</p>
</section>
<section aria-labelledby="sec7" epub:type="division">
<h3 class="h" id="sec7"><span id="h1-142"/><span class="sans_futura_std_bold_b_">Summary</span></h3>
<p class="tni">In this chapter, I presented some advanced techniques that I’ve come across in my career as a Batch coder. It’s not an exhaustive list of interesting <span class="sans_thesansmonocd_w5regular_">for</span> command conundrums, but it’s representative of many. To tap into the full power of Batch, you must understand the <span class="sans_thesansmonocd_w5regular_">for</span> command, and that requires experimentation and exploration. Don’t be intimidated. If you code in Batch long enough, you’ll encounter something not covered here, but if you follow the thought process that went into these examples, you should be able to experiment your way to a solution.</p>
<p class="tx">This rounds out <span class="xref"><a href="part2.xhtml" class="calibre3">Part II</a></span>, but it’s by no means the last you’ll see of the <span class="sans_thesansmonocd_w5regular_">for</span> command in the pages ahead. Many more applications of this command are yet to come, but in the next chapter, I’ll step back and explore some important pseudo-environment variables.</p>
</section>
</section>
</div></body></html>