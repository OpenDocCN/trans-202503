<?xml version='1.0' encoding='utf-8'?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" epub:prefix="z3998: http://www.daisy.org/z3998/2012/vocab/structure/#" lang="en" xml:lang="en">
  <head>
    <title>Project 5: Rainbow Light Strip</title>
    <link href="../styles/9781593278717.css" rel="stylesheet" type="text/css"/>
    <link href="../68851547a55f.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <div id="sbo-rt-content"><h2 class="h2" id="ch05"><span epub:type="pagebreak" id="page_70"/><strong>5<br/>Rainbow Light Strip</strong></h2>
<p class="noindent"><span class="green1">In this project you’ll create a rainbow light effect using an addressable RGB LED strip. You’ll use a pushbutton to start and stop the rainbow effect, and you’ll control the rainbow’s speed and brightness using two potentiometers.</span></p>
<div class="image"><span epub:type="pagebreak" id="page_71"/><img src="../images/f0071-01.jpg" alt="image"/></div>
<p class="cap"><span class="green1"><strong>PARTS REQUIRED</strong></span></p>
<p class="cap1">Raspberry Pi</p>
<p class="cap1">Breadboard</p>
<p class="cap1">WS2812B addressable RGB LED strip</p>
<p class="cap1">Logic level conver ter module BSS 138</p>
<p class="cap1">Two 10 kΩ potentiometers</p>
<p class="cap1">MCP 3 008 chip</p>
<p class="cap1">Pushbutton</p>
<p class="cap1">Three header pins</p>
<p class="cap1">Jumper wires</p>
<p class="cap"><span class="green1"><strong>SOFTWARE REQUIRED</strong></span></p>
<p class="cap1">WS2 81X library</p>
<h3 class="h3" id="lev55"><span epub:type="pagebreak" id="page_72"/><span class="green1"><strong>INTRODUCING THE WS2812B ADDRESSABLE RGB LED STRIP</strong></span></h3>
<p class="noindent">For the rainbow light effect, you’ll use the WS2812B RGB LED strip, which is available in many different sizes. The strip comes in a reel, as shown in <a href="ch05.xhtml#ch05fig1">Figure 5-1</a>, and you can cut off as long a section as you need.</p>
<div class="image"><a id="ch05fig1"/><img src="../images/f0072-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 5-1:</strong> WS2812B addressable RGB LED strip on a reel</p>
<p class="indent">The strip shown in <a href="ch05.xhtml#ch05fig1">Figure 5-1</a> is 5 meters long with 300 addressable WS2812B RGB LEDs wired in series, and later you’ll cut a section of 14 LEDs to use in this project. There are cutting marks, shown in <a href="ch05.xhtml#ch05fig2">Figure 5-2</a>, along the entire length of the strip.</p>
<div class="image"><a id="ch05fig2"/><img src="../images/f0072-02.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 5-2:</strong> WS2812B addressable RGB LED strip pins</p>
<p class="indent">The color and brightness of each LED can be controlled individually, allowing you to produce amazing effects easily. Each LED has an integrated circuit (IC) built right in, which means you can control the whole strip using just one GPIO pin, connected to the middle pin—the Data pin—at the end of the strip (see <a href="ch05.xhtml#ch05fig2">Figure 5-2</a>).</p>
<p class="indent"><span epub:type="pagebreak" id="page_73"/>Prepare the LED strip for this project as follows:</p>
<ol>
<li class="noindent"><p class="list">Cut a strip of 14 LEDs along the cutting marks shown on the strip.</p></li>
<li class="noindent"><p class="list">Solder header pins to the 5 V, Data, and GND pins as shown in <a href="ch05.xhtml#ch05fig2">Figure 5-2</a>.</p></li>
</ol>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>We’ve found that a Raspberry Pi 5 V pin (such as pin 2 or pin 4) is capable of powering a strip of 20 LEDs or fewer, but in projects where you’re using a longer strip, you’ll need to use an external 5 V power supply to provide enough current.</em></p>
</div>
<p class="indent">Now you need to figure out your power supply. The LED strip requires a 5 V power source. You can determine the amps you need from the amount of power each LED requires. An individual LED draws up to 60 mA at full brightness (which produces white light), but since you’ll rarely need all LEDs at their maximum value for any length of time, you can safely estimate 20 mA per LED. So if your strip is 14 LEDs long, you’ll need a 5 V power source with approximately 20 × 14 = 280 mA.</p>
<p class="indent">The Data pin that controls the strip needs a 5 V signal, but the Pi GPIOs operate at 3.3 V. To get the 5 V you need, you’ll use a component called a logic level converter.</p>
<h3 class="h3" id="lev56"><span class="green1"><strong>INTRODUCING THE LOGIC LEVEL CONVERTER</strong></span></h3>
<p class="noindent">A <em>logic level converter</em> allows you to convert 3.3 V signals to 5 V signals. There are many types of logic level converter, but in this project you’ll use the two-channel logic level converter bidirectional module shown in <a href="ch05.xhtml#ch05fig3">Figure 5-3</a>. (To find the same logic level converter module we’re using, search online for <em>logic level converter module bss138</em>.)</p>
<p class="indent">The bidirectionality of this module allows you to convert data in both ways—from 3.3 V to 5 V and from 5 V to 3.3 V. You won’t need to convert 5 V to 3.3 V in this project, but having this more flexible model in your toolkit (versus a unidirectional model) can come in handy for future projects. This logic level converter also has two channels, channel 1 and channel 2. In this project you’ll use only one of the channels to control the LED strip’s Data pin.</p>
<div class="image"><a id="ch05fig3"/><img src="../images/f0073-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 5-3:</strong> Two-channel logic level converter bidirectional module</p>
<p class="indent"><span epub:type="pagebreak" id="page_74"/>More likely than not, your module will come with the header pins separate, so you’ll need to solder the pins to it to make it breadboard-friendly. Break off two rows of six header pins, and solder one pin to each tiny hole.</p>
<p class="indent">The module has a low-voltage side (left side of <a href="ch05.xhtml#ch05fig3">Figure 5-3</a>), to which you attach everything that’s at 3.3 V, and a high-voltage side (right side), where you attach everything at 5 V. For this project, you need to use one of the pins highlighted in red, as you want to send 3.3 V data and convert it to 5 V.</p>
<p class="indent">To use the logic level converter, connect GND on both sides, 3.3 V on the low-voltage side, and 5 V on the high-voltage side. Then, connect data from the Pi on one of the TX1 pins—you can use either channel 1 or channel 2—and get the 5 V data on the corresponding TX0 pin.</p>
<h3 class="h3" id="lev57"><span class="green1"><strong>WIRING THE CIRCUIT</strong></span></h3>
<p class="noindent">At this point, you should have cut your strip to size (14 LEDs) and soldered header pins both to the end of the strip and to the logic level converter. Now you’re ready to wire the circuit. To do so, you’ll connect together a pushbutton, two potentiometers via the MCP3008 chip, and the addressable RGB LED strip using the logic level converter module, as shown in <a href="ch05.xhtml#ch05fig4">Figure 5-4</a>.</p>
<div class="image"><a id="ch05fig4"/><img src="../images/f0074-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 5-4:</strong> Circuit for controlling the RGB LED strip</p>
<div class="note">
<p class="notet"><span epub:type="pagebreak" id="page_75"/><span class="red"><strong>WARNING</strong></span></p>
<p class="notep"><em>Remember that you can’t connect 5 V to the Pi GPIOs, as that can permanently damage your board.</em></p>
</div>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>To identify the MCP3008 pins, orient the chip so it’s facing you with the half-circle cutout at the top. The first pin is the top left and the last pin is the top right. See <a href="ch03.xhtml#lev41">“Analog-to-Digital Converters”</a> on <a href="ch03.xhtml#page_55">page 55</a> for a full MCP3008 pinout description.</em></p>
</div>
<ol>
<li class="noindent"><p class="list">Connect the GND and 3.3 V pins to the breadboard rails.</p></li>
<li class="noindent"><p class="list">Insert the MCP3008 chip in the middle of the breadboard with the two sides straddling the center divide.</p></li>
<li class="noindent"><p class="list">Insert two potentiometers in the breadboard, wiring one’s outer lead to GND and the other’s outer lead to 3.3 V.</p></li>
<li class="noindent"><p class="list">Connect the MCP3008 chip as shown in the following table. It doesn’t matter which potentiometer you connect to which pins; they will work the same way.</p>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="border_thb"><p class="tab_th"><strong>MCP3008</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>CONNECT TO</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-ca"><p class="tabc"><span class="green1">1</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green1">One potentiometer’s middle lead</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ca"><p class="tabc"><span class="green1">2</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green1">Other potentiometer’s middle lead</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ca"><p class="tabc"><span class="green1">9</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green1">GND</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ca"><p class="tabc"><span class="green1">10</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green1">GPIO 8</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ca"><p class="tabc"><span class="green1">11</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green1">GPIO 10</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ca"><p class="tabc"><span class="green1">12</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green1">GPIO 9</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ca"><p class="tabc"><span class="green1">13</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green1">GPIO 11</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ca"><p class="tabc"><span class="green1">14</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green1">GND</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ca"><p class="tabc"><span class="green1">15</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green1">3.3 V</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ca"><p class="tabc"><span class="green1">16</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green1">3.3 V</span></p></td>
</tr>
</tbody>
</table></li>
<li class="noindent"><p class="list">Insert a pushbutton into the breadboard, straddling the center divide. On one side of the center divide, connect one pin to GND and the other pin to GPIO 2.</p></li>
<li class="noindent"><p class="list">Insert the RGB LED strip pins into the breadboard.</p></li>
<li class="noindent"><p class="list">Insert the logic level converter into the breadboard. Connect the low-voltage side as directed.</p>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="border_thb"><p class="tab_th"><strong>LOGIC LEVEL CONVERTER</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>RASPBERRY PI</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-ca"><p class="tabc"><span class="green1">TX1 (channel 2)</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green1">GPIO 18</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ca"><p class="tabc"><span class="green1">LV</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green1">3.3 V</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ca"><p class="tabc"><span class="green1">GND</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green1">GND</span></p></td>
</tr>
</tbody>
</table></li>
<li class="noindent"><p class="list"><span epub:type="pagebreak" id="page_76"/>Connect the high-voltage side as directed.</p>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="border_thb"><p class="tab_th"><strong>LOGIC LEVEL CONVERTER</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>CONNECT TO</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-ca"><p class="tabc"><span class="green1">TX0 (channel 2)</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green1">RGB LED strip’s Data pin (middle pin)</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ca"><p class="tabc"><span class="green1">HV</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green1">5 V</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ca"><p class="tabc"><span class="green1">GND</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green1">GND</span></p></td>
</tr>
</tbody>
</table></li>
<li class="noindent"><p class="list">With the logic level converter connected, connect the RGB LED strip as directed.</p>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="border_thb"><p class="tab_th"><strong>RGB LED STRIP</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>CONNECT TO</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-ca"><p class="tabc"><span class="green1">5 V</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green1">5 V</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ca"><p class="tabc"><span class="green1">Din</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green1">Logic level converter TX0 pin</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ca"><p class="tabc"><span class="green1">GND</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green1">GND</span></p></td>
</tr>
</tbody>
</table></li>
</ol>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>If you choose to do this project with a strip of more than 20 LEDs, you’ll need to connect your 5 V power source to the strip’s 5 V pin and the GND power source to the GND rail.</em></p>
</div>
<h3 class="h3" id="lev58"><span class="green1"><strong>WRITING THE SCRIPT</strong></span></h3>
<p class="noindent">This script relies on the WS281X library to control the individual LEDs, so you need to install that library and then enable the Serial Peripheral Interface (SPI) communication the strip needs to communicate with the Pi.</p>
<h4 class="h4" id="lev59"><span class="green1"><strong>Installing the WS281X Library</strong></span></h4>
<p class="noindent">There are a few steps to installing the WS281X library, as it requires you to set up the libraries it depends on first.</p>
<ol>
<li class="noindent"><p class="list">Open a terminal window and install the scons, python3-dev, and swig libraries:</p>
<div class="box">
<pre>pi@raspberrypi:~ $ <span class="codestrong">sudo apt install scons python3-dev swig</span></pre>
</div></li>
<li class="noindent"><p class="list">Still in the terminal, navigate to the desktop, create a folder called <em>Libraries</em>, and then navigate to the newly created folder:</p>
<div class="box">
<pre>pi@raspberrypi:~ $ <span class="codestrong">cd ~/Desktop</span><br/>pi@raspberrypi:~/Desktop $ <span class="codestrong">mkdir Libraries</span><br/>pi@raspberrypi:~/Desktop $ <span class="codestrong">cd Libraries</span><br/>pi@raspberrypi:~/Desktop/Libraries $</pre>
</div></li>
<li class="noindent"><p class="list">Clone the library to download it.</p>
<div class="box">
<pre><span epub:type="pagebreak" id="page_77"/>pi@raspberrypi:~/Desktop/Libraries $ <span class="codestrong">git clone https://</span><br/><span class="codestrong">github.com/jgarff/rpi_ws281x.git</span></pre>
</div></li>
<li class="noindent"><p class="list">Move to the <em>rpi_ws281x</em> library folder and run the <code>scons</code> command:</p>
<div class="box">
<pre>pi@raspberrypi:~/Desktop/Libraries $ <span class="codestrong">cd rpi_ws281x</span><br/>pi@raspberrypi:~/Desktop/Libraries/rpi_ws281x $ <span class="codestrong">sudo scons</span></pre>
</div></li>
<li class="noindent"><p class="list">Navigate to the <em>python</em> folder and install the WS281X library on your Pi:</p>
<div class="box">
<pre>pi@raspberrypi:~/Desktop/Libraries/rpi_ws281x $ <span class="codestrong">cd python</span><br/>pi@raspberrypi:~/Desktop/Libraries/rpi_ws281x/python $ <span class="codestrong">sudo</span><br/><span class="codestrong">python3 setup.py install</span></pre>
</div></li>
</ol>
<p class="indent">Now you’re ready to use the WS281X library in your code.</p>
<h4 class="h4" id="lev60"><span class="green1"><strong>Enabling SPI Communication</strong></span></h4>
<p class="noindent">To communicate with the MCP3008 chip, you need to enable SPI communication. Go to the taskbar main menu and select <strong>Preferences</strong> <span class="ent">▸</span> <strong>Raspberry Pi Configuration</strong>. In the Interfaces tab, click <strong>Enabled</strong> in the SPI row, as shown in <a href="ch05.xhtml#ch05fig5">Figure 5-5</a>, and then click <strong>OK</strong>.</p>
<div class="image"><a id="ch05fig5"/><img src="../images/f0077-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 5-5:</strong> Enabling SPI communication</p>
<h4 class="h4" id="lev61"><span class="green1"><strong>ENTERING THE SCRIPT</strong></span></h4>
<p class="noindent">Let’s recap how the circuit works to help you better understand the script before entering it:</p>
<ul>
<li class="noindent">Your RGB LED strip displays a moving rainbow.</li>
<li class="noindent">One potentiometer controls the rainbow speed.</li>
<li class="noindent">Another potentiometer controls the rainbow brightness.</li>
<li class="noindent">The pushbutton starts and stops the rainbow animation.</li>
</ul>
<div class="box2">
<p class="box-title"><span epub:type="pagebreak" id="page_78"/><span class="green1"><strong>TROUBLESHOOTING CRAZY PIXELS</strong></span></p>
<p class="box-p">At the time of this writing, there is an issue with the strip pixels on newer versions of Raspbian. The pin used to control the strip is shared with analog audio output, so the pixels can go crazy and not work properly. If this happens when you load the code, you need to add two lines to the <em>config.txt</em> file. Go to the terminal and enter the following:</p>
<div class="box">
<pre>pi@raspberrypi:~ $ <span class="codestrong">sudo nano /boot/config.txt</span></pre>
</div>
<p class="box-pi">In the file that opens, add the following two lines (anywhere should be fine):</p>
<div class="box">
<pre>hdmi_force_hotplug = 1<br/>hdmi_force_edid_audio = 1</pre>
</div>
<p class="box-pi">Press <small>CTRL</small>-X to save the file and then, when prompted, type <strong>Y</strong> and press <small>ENTER</small>. Reboot your Pi for the changes to take effect, and then proceed to the library installation.</p>
</div>
<p class="indent">Open <strong>Python 3 (IDLE)</strong> and go to <strong>File</strong> <span class="ent">▸</span> <strong>New File</strong> to create a new script. Copy the code in <a href="ch05.xhtml#ch05list1">Listing 5-1</a> to the Python Editor and save the script as <em>rainbow_effect.py</em> inside the <em>LEDs</em> folder (remember that you can download all the scripts at <em><a href="https://www.nostarch.com/RaspberryPiProject/">https://www.nostarch.com/RaspberryPiProject/</a></em>):</p>
<p class="listing" id="ch05list1"><strong>LISTING 5-1:</strong> The Rainbow Strip <em>rainbow_effect.py</em> code</p>
<div class="box">
<pre>  <span class="red1">#based on Tony DiCola's NeoPixel library strandtest example</span><br/><br/>  <span class="red1">#import necessary libraries</span><br/><span class="ent">➊</span> <span class="orange">from</span> neopixel <span class="orange">import</span> *<br/>  <span class="orange">from</span> time <span class="orange">import</span> sleep<br/>  <span class="orange">from</span> gpiozero <span class="orange">import</span> Button, MCP3008<br/><br/>  <span class="red1">#LED strip configuration</span><br/><span class="ent">➋</span> LED_COUNT = 14 <span class="red1">#number of LED pixels</span><br/>  LED_PIN = 18 <span class="red1">#GPIO pin connected to the pixels (must support PWM!)</span><br/>  LED_FREQ_HZ = 800000 <span class="red1">#LED signal frequency in Hz (usually 800 kHz)</span><br/>  LED_DMA = 5 <span class="red1">#DMA channel to use for generating signal (try 5)</span><br/>  LED_INVERT = <span class="orange">False</span> <span class="red1">#set True to invert the signal</span><br/><br/>  <span class="red1">#create pot objects to refer to MCP3008 channel 0 and 1</span><br/><span class="ent">➌</span> pot_brightness = MCP3008(0)<br/>  pot_speed = MCP3008(1)<br/><br/><span epub:type="pagebreak" id="page_79"/>  <span class="red1">#connect pushbutton to GPIO 2, pull-up</span><br/>  button_start = Button(2)<br/><br/>  <span class="red1">#animation running control variable</span><br/>  running_animation = <span class="orange">False</span><br/><br/>  <span class="red1">#generate rainbow colors across 0-255 positions</span><br/><span class="ent">➍</span> <span class="orange">def</span> <span class="blue">wheel</span>(pos):<br/>      <span class="orange">if</span> pos &lt; 85:<br/>          <span class="orange">return</span> Color(pos * 3, 255 - pos * 3, 0)<br/>      <span class="orange">elif</span> pos &lt; 170:<br/>          pos -= 85<br/>          <span class="orange">return</span> Color(255 - pos * 3, 0, pos * 3)<br/>      <span class="orange">else</span>:<br/>          pos -= 170<br/>          <span class="orange">return</span> Color(0, pos * 3, 255 - pos * 3)<br/><br/>  <span class="red1">#draw rainbow that uniformly distributes itself across all pixels</span><br/><span class="ent">➎</span> <span class="orange">def</span> <span class="blue">rainbowCycle</span>(strip):<br/>      <span class="orange">for</span> j <span class="orange">in</span> <span class="purple">range</span>(256):<br/>          <span class="orange">for</span> i <span class="orange">in</span> <span class="purple">range</span>(strip.numPixels()):<br/>              strip.setPixelColor(i, wheel((<span class="purple">int</span>(i * 256 /<br/>  strip.numPixels()) + j) &amp; 255))<br/>          strip.show()<br/><span class="ent">➏</span>         sleep((pot_speed.value*40)/1000.0)<br/><br/>  <span class="red1">#function to start and stop the animation</span><br/><span class="ent">➐</span> <span class="orange">def</span> <span class="blue">start_animation</span>():<br/>      <span class="orange">global</span> running_animation<br/>      <span class="orange">if</span> running_animation == <span class="orange">True</span>:<br/>          running_animation = <span class="orange">False</span><br/>      <span class="orange">else</span>:<br/>          running_animation = <span class="orange">True</span><br/><br/>  <span class="red1">#assign a function that runs when the button is pressed</span><br/><span class="ent">➑</span> button_start.when_pressed = start_animation<br/><br/>  <span class="red1">#create NeoPixel object with appropriate configuration</span><br/><span class="ent">➒</span> strip = Adafruit_NeoPixel(LED_COUNT, LED_PIN, LED_FREQ_HZ, LED_DMA,<br/>  LED_INVERT, <span class="purple">int</span>(pot_brightness.value*255))<br/><br/>  <span class="red1">#initialize the strip</span><br/>  strip.begin()<br/><span class="ent">➓</span> <span class="orange">while True</span>:<br/>      <span class="orange">if</span> running_animation == <span class="orange">True</span>:<br/>          <span class="red1">#set LED strip brightness</span><br/>          strip.setBrightness(int(pot_brightness.value*255))<br/>          rainbowCycle(strip)</pre>
</div>
<p class="indent">First, you import the libraries you’ll use to control the project <span class="ent">➊</span>. You need the neopixel library to control the LED strip, the time library to import the <code>sleep()</code> function for controlling the delay time, and from <span epub:type="pagebreak" id="page_80"/>gpiozero you import the <code>Button()</code> and <code>MCP3008()</code> interfaces to read the pushbutton and potentiometer values, respectively.</p>
<h5 class="h5"><strong>Setting the Strip Parameters</strong></h5>
<p class="noindent">At <span class="ent">➋</span>, you create variables for configuring the RGB LED strip, including the number of LEDs and the GPIO pin used. Then, at <span class="ent">➌</span>, you create objects to refer to the two potentiometers, with the brightness on MCP3008 channel 0 (pin 1) and the speed on MCP3008 channel 1 (pin 2), and an object for the button on GPIO 2. You also create a variable for starting and stopping the animation called <code>running_animation</code>, which takes a Boolean and is <code>False</code> (off ) by default.</p>
<h5 class="h5"><strong>Creating the Rainbow Effect Functions</strong></h5>
<p class="noindent">At <span class="ent">➍</span> and <span class="ent">➎</span>, you create the functions that produce the moving rainbow effect. These functions are the same as the ones used in the <em>strandtest.py</em> example that comes with the neopixel library. In simple terms, the <code>wheel()</code> function generates the color spectrum by varying each color parameter between 0 and 255. Each color is composed of red, green, and blue (RGB) parameters, and varying each parameter between 0 and 255 produces different colors, resulting in a rainbow effect. The <code>rainbowCycle()</code> function distributes the rainbow across the number of LEDs on your strip.</p>
<p class="indent">The line at <span class="ent">➏</span> sets the delay time for the <code>sleep()</code> function. To calculate the delay time, you multiply the value read from one of the potentiometers (which is between 0 and 1) by 40 and then divide that result by 1,000. Multiplying the potentiometer value by 40 produces a noticeable delay time; otherwise, the delay would be so short that the rainbow effect would happen too fast for you to detect the movement of the lights. Dividing by 1,000 gives you a delay time in milliseconds.</p>
<h5 class="h5"><strong>Controlling the Pushbutton</strong></h5>
<p class="noindent">Using the gpiozero library, you assign a particular action to a pushbutton press as follows:</p>
<div class="box">
<pre>button.when_pressed = <em>function_name</em></pre>
</div>
<p class="indent">The <span class="codeitalic">function_name</span> function refers to a generic function that will be called when the button is pressed; that function must be defined before it is called. In this case, that function is <code>start_animation</code> <span class="ent">➑</span>, defined at <span class="ent">➐</span>. Notice that <span class="codeitalic">function_name</span> doesn’t have parentheses. This happens because we’re just assigning a function to another <span epub:type="pagebreak" id="page_81"/>function instead of running the function. In our case, we’re telling the code to run the <code>start_animation</code> function when the <code>button_start.when_pressed</code> function is triggered.</p>
<p class="indent">When the button is pressed, the <code>running_animation</code> value changes. When the <code>running_animation</code> variable is <code>False</code> and the button is pressed, it changes to <code>True</code>, and vice versa. This allows you to start and stop the rainbow effect.</p>
<h5 class="h5"><strong>Controlling the Animation with the while Loop</strong></h5>
<p class="noindent">At <span class="ent">➒</span>, you create an <code>Adafruit_Neopixel</code> object called <code>strip</code> that takes in the strip parameters you defined earlier at <span class="ent">➋</span>. To control the strip’s LED brightness, you use <code>int(pot_brightness.value*255)</code>. The brightness changes according to the value read from one of the potentiometers (between 0 and 1). You multiply that value by 255 because the strip’s LED brightness has a range of 0 to 255. Using the <code>int()</code> function rounds the number to an integer. This way, you can adjust the LED brightness by rotating the potentiometer.</p>
<p class="indent">Then, you use <code>strip.begin()</code>, which you need to call before making other calls on the <code>Adafruit_Neopixel</code> object.</p>
<p class="indent">The <code>while</code> loop <span class="ent">➓</span> keeps the program running. Then, you set the strip brightness before starting the animation. If the <code>running_animation</code> variable is equal to <code>True</code>, the <code>rainbowCycle()</code> function will run, starting the animation. If you press the pushbutton, the <code>running_animation</code> variable changes to <code>False</code>, and the animation stops.</p>
<h4 class="h4" id="lev62"><span class="green1"><strong>Running the Script</strong></span></h4>
<p class="noindent">To run this script, you need to use the terminal window. Running it from the Python 3 IDLE editor will give you a permissions error.</p>
<p class="indent">Save the script as <em>rainbow_effect.py</em> inside the <em>LEDs</em> folder within the <em>Projects</em> directory, and open the terminal. Then, navigate to the <em>LEDs</em> folder and run the script:</p>
<div class="box">
<pre>pi@raspberrypi:~ $ <span class="codestrong">cd ~/Desktop/Projects/LEDs</span><br/>pi@raspberrypi:~/Desktop/Projects/LEDs $ <span class="codestrong">sudo python3</span><br/><span class="codestrong">rainbow_effect.py</span></pre>
</div>
<p class="indent">Now you can control the speed and brightness by rotating their respective potentiometers and stop and start the animation by pressing the pushbutton.</p>
<p class="indent">Congratulations! You have an awesome decoration for your home!</p>
<h3 class="h3" id="lev63"><span epub:type="pagebreak" id="page_82"/><span class="green1"><strong>TAKING IT FURTHER</strong></span></h3>
<p class="noindent">Here are some simple ideas you can try if you want to increase your level of control over the strip:</p>
<ul>
<li class="noindent">Light up a specific LED in the middle of the strip.</li>
<li class="noindent">Light all the LEDs in just one color.</li>
<li class="noindent">Add a pushbutton to change between preset effects.</li>
<li class="noindent">Blink the LEDs like Christmas lights.</li>
<li class="noindent">Invent your own effects.</li>
</ul>
</div>
  </body>
</html>
