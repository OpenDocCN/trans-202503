<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:ibooks="http://vocabulary.itunes.apple.com/rdf/ibooks/vocabulary-extensions-1.0" xmlns:m="http://www.w3.org/1998/Math/MathML" xmlns:svg="http://www.w3.org/2000/svg" epub:prefix="ibooks: http://vocabulary.itunes.apple.com/rdf/ibooks/vocabulary-extensions-1.0  index: http://www.index.com/" lang="en" xml:lang="en">
<head>
<title>The Art of Mac Malware</title>
<link href="NSTemplate_v1.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:a248aa67-aa2c-49b1-a34e-c916914c0e30" name="Adept.expected.resource"/>
</head>

<body epub:type="frontmatter">
<nav class="tocList" epub:type="toc" id="toc">
<h1 class="FrontmatterTitle">Contents In Detail</h1>
<ol>
<li class="TOCChapter"><a href="f01.xhtml"><span>Title Page</span></a></li>
<li class="TOCChapter"><a href="f02.xhtml"><span>Copyright</span></a></li>
<li class="TOCChapter"><a href="f03.xhtml"><span>Dedication</span></a></li>
<li class="TOCChapter"><a href="f04.xhtml"><span>About the Author</span></a></li>
<li class="TOCChapter"><a href="f05.xhtml"><span>Foreword</span></a></li>
<li class="TOCChapter"><a href="f06.xhtml"><span>Acknowledgments</span></a></li>
<li class="TOCChapter"><a href="f07.xhtml"><span>Introduction</span></a>
<ol>
<li class="TOCH2"><a href="f07.xhtml#h1-501942f07-0001">Who Should Read This Book?</a></li>
<li class="TOCH2"><a href="f07.xhtml#h1-501942f07-0002">What You’ll Find in This Book</a></li>
<li class="TOCH2"><a href="f07.xhtml#h1-501942f07-0003">A Note on Mac Malware Terminology</a></li>
<li class="TOCH2"><a href="f07.xhtml#h1-501942f07-0004">A Note on Safely Analyzing Malware</a></li>
<li class="TOCH2"><a href="f07.xhtml#h1-501942f07-0005">Additional Resources</a>
<ol>
<li class="TOCH3"><a href="f07.xhtml#h2-501942f07-0001">Books </a></li>
<li class="TOCH3"><a href="f07.xhtml#h2-501942f07-0002">Websites</a></li>
</ol>
</li>
<li class="TOCH2"><a href="f07.xhtml#h1-501942f07-0006">Downloading This Book’s Malware Specimens</a></li>
<li class="TOCH2"><a href="f07.xhtml#h1-501942f07-0007">Endnotes</a></li>
</ol>
</li>
<li class="TOCPart"><a href="p01.xhtml"><span>Part I: Mac Malware Basics</span></a>
<ol>
<li class="TOCChapter"><a href="c01.xhtml"><span>Chapter 1: Infection Vectors</span></a>
<ol>
<li class="TOCH2"><a href="c01.xhtml#h1-501942c01-0001">Mac Protections</a></li>
<li class="TOCH2"><a href="c01.xhtml#h1-501942c01-0002">Malicious Emails</a></li>
<li class="TOCH2"><a href="c01.xhtml#h1-501942c01-0003">Fake Tech and Support </a></li>
<li class="TOCH2"><a href="c01.xhtml#h1-501942c01-0004">Fake Updates</a></li>
<li class="TOCH2"><a href="c01.xhtml#h1-501942c01-0005">Fake Applications</a></li>
<li class="TOCH2"><a href="c01.xhtml#h1-501942c01-0006">Trojanized Applications</a></li>
<li class="TOCH2"><a href="c01.xhtml#h1-501942c01-0007">Pirated and Cracked Applications</a></li>
<li class="TOCH2"><a href="c01.xhtml#h1-501942c01-0008">Custom URL Schemes</a></li>
<li class="TOCH2"><a href="c01.xhtml#h1-501942c01-0009">Office Macros</a></li>
<li class="TOCH2"><a href="c01.xhtml#h1-501942c01-0010">Xcode Projects</a></li>
<li class="TOCH2"><a href="c01.xhtml#h1-501942c01-0011">Supply Chain Attacks</a></li>
<li class="TOCH2"><a href="c01.xhtml#h1-501942c01-0012">Account Compromises of Remote Services</a></li>
<li class="TOCH2"><a href="c01.xhtml#h1-501942c01-0013">Exploits</a></li>
<li class="TOCH2"><a href="c01.xhtml#h1-501942c01-0014">Physical Access</a></li>
<li class="TOCH2"><a href="c01.xhtml#h1-501942c01-0015">Up Next</a></li>
<li class="TOCH2"><a href="c01.xhtml#h1-501942c01-0016">Endnotes</a></li>
</ol>
</li>
<li class="TOCChapter"><a href="c02.xhtml"><span>Chapter 2: Persistence</span></a>
<ol>
<li class="TOCH2"><a href="c02.xhtml#h1--0001">Login Items</a></li>
<li class="TOCH2"><a href="c02.xhtml#h1--0002">Launch Agents and Daemons</a></li>
<li class="TOCH2"><a href="c02.xhtml#h1--0003">Scheduled Jobs and Tasks</a>
<ol>
<li class="TOCH3"><a href="c02.xhtml#h2--0001">Cron Jobs</a></li>
<li class="TOCH3"><a href="c02.xhtml#h2--0002">At Jobs</a></li>
<li class="TOCH3"><a href="c02.xhtml#h2--0003">Periodic Scripts</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c02.xhtml#h1--0004">Login and Logout Hooks</a></li>
<li class="TOCH2"><a href="c02.xhtml#h1--0005">Dynamic Libraries</a>
<ol>
<li class="TOCH3"><a href="c02.xhtml#h2--0004">DYLD_* Environment Variables</a></li>
<li class="TOCH3"><a href="c02.xhtml#h2--0005">Dylib Proxying</a></li>
<li class="TOCH3"><a href="c02.xhtml#h2--0006">Dylib Hijacking</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c02.xhtml#h1--0006">Plug-ins</a></li>
<li class="TOCH2"><a href="c02.xhtml#h1--0007">Scripts</a></li>
<li class="TOCH2"><a href="c02.xhtml#h1--0008">Event Monitor Rules</a></li>
<li class="TOCH2"><a href="c02.xhtml#h1--0009">Reopened Applications</a></li>
<li class="TOCH2"><a href="c02.xhtml#h1--0010">Application and Binary Modifications</a></li>
<li class="TOCH2"><a href="c02.xhtml#h1--0011">KnockKnock . . . Who’s There?</a></li>
<li class="TOCH2"><a href="c02.xhtml#h1--0012">Up Next</a></li>
<li class="TOCH2"><a href="c02.xhtml#h1--0013">Endnotes</a></li>
</ol>
</li>
<li class="TOCChapter"><a href="c03.xhtml"><span>Chapter 3: Capabilities</span></a>
<ol>
<li class="TOCH2"><a href="c03.xhtml#h1-501942c03-0001">Categorizing Mac Malware Capabilities</a></li>
<li class="TOCH2"><a href="c03.xhtml#h1-501942c03-0002">Survey and Reconnaissance</a></li>
<li class="TOCH2"><a href="c03.xhtml#h1-501942c03-0003">Privilege Escalation</a>
<ol>
<li class="TOCH3"><a href="c03.xhtml#h2-501942c03-0001">Escaping Sandboxes</a></li>
<li class="TOCH3"><a href="c03.xhtml#h2-501942c03-0002">Gaining Root Privileges</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c03.xhtml#h1-501942c03-0004">Adware-Related Hijacks and Injections </a></li>
<li class="TOCH2"><a href="c03.xhtml#h1-501942c03-0005">Cryptocurrency Miners</a></li>
<li class="TOCH2"><a href="c03.xhtml#h1-501942c03-0006">Remote Shells</a></li>
<li class="TOCH2"><a href="c03.xhtml#h1-501942c03-0007">Remote Process and Memory Execution</a></li>
<li class="TOCH2"><a href="c03.xhtml#h1-501942c03-0008">Remote Download and Upload</a></li>
<li class="TOCH2"><a href="c03.xhtml#h1-501942c03-0009">File Encryption</a></li>
<li class="TOCH2"><a href="c03.xhtml#h1-501942c03-0010">Stealth</a></li>
<li class="TOCH2"><a href="c03.xhtml#h1-501942c03-0011">Other Capabilities</a></li>
<li class="TOCH2"><a href="c03.xhtml#h1-501942c03-0012">Up Next</a></li>
<li class="TOCH2"><a href="c03.xhtml#h1-501942c03-0013">Endnotes</a></li>
</ol>
</li>
</ol>
</li>
<li class="TOCPart"><a href="p02.xhtml"><span>Part II: Mac Malware Analysis</span></a>
<ol>
<li class="TOCChapter"><a href="c04.xhtml"><span>Chapter 4: Nonbinary Analysis</span></a>
<ol>
<li class="TOCH2"><a href="c04.xhtml#h1-501942c04-0001">Identifying File Types</a></li>
<li class="TOCH2"><a href="c04.xhtml#h1-501942c04-0002">Extracting Malicious Files from Distribution Packaging</a>
<ol>
<li class="TOCH3"><a href="c04.xhtml#h2-501942c04-0001">Apple Disk Images (.dmg)</a></li>
<li class="TOCH3"><a href="c04.xhtml#h2-501942c04-0002">Packages (.pkg)</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c04.xhtml#h1-501942c04-0003">Analyzing Scripts</a>
<ol>
<li class="TOCH3"><a href="c04.xhtml#h2-501942c04-0003">Bash Shell Scripts</a></li>
<li class="TOCH3"><a href="c04.xhtml#h2-501942c04-0004">Python Scripts</a></li>
<li class="TOCH3"><a href="c04.xhtml#h2-501942c04-0005">AppleScript</a></li>
<li class="TOCH3"><a href="c04.xhtml#h2-501942c04-0006">Perl Scripts</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c04.xhtml#h1-501942c04-0004">Microsoft Office Documents</a></li>
<li class="TOCH2"><a href="c04.xhtml#h1-501942c04-0005">Applications</a></li>
<li class="TOCH2"><a href="c04.xhtml#h1-501942c04-0006">Up Next</a></li>
<li class="TOCH2"><a href="c04.xhtml#h1-501942c04-0007">Endnotes</a></li>
</ol>
</li>
<li class="TOCChapter"><a href="c05.xhtml"><span>Chapter 5: Binary Triage</span></a>
<ol>
<li class="TOCH2"><a href="c05.xhtml#h1-501942c05-0001">The Mach-O File Format</a>
<ol>
<li class="TOCH3"><a href="c05.xhtml#h2-501942c05-0001">The Header</a></li>
<li class="TOCH3"><a href="c05.xhtml#h2-501942c05-0002">The Load Commands</a></li>
<li class="TOCH3"><a href="c05.xhtml#h2-501942c05-0003">The Data Segment</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c05.xhtml#h1-501942c05-0002">Classifying Mach-O Files</a>
<ol>
<li class="TOCH3"><a href="c05.xhtml#h2-501942c05-0004">Hashes</a></li>
<li class="TOCH3"><a href="c05.xhtml#h2-501942c05-0005">Code-Signing Information</a></li>
<li class="TOCH3"><a href="c05.xhtml#h2-501942c05-0006">Strings</a></li>
<li class="TOCH3"><a href="c05.xhtml#h2-501942c05-0007">Objective-C Class Information</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c05.xhtml#h1-501942c05-0003">“Nonbinary” Binaries</a>
<ol>
<li class="TOCH3"><a href="c05.xhtml#h2-501942c05-0008">Identifying the Tool Used to Build the Binary</a></li>
<li class="TOCH3"><a href="c05.xhtml#h2-501942c05-0009">Extracting the Nonbinary Component</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c05.xhtml#h1-501942c05-0004">Up Next</a></li>
<li class="TOCH2"><a href="c05.xhtml#h1-501942c05-0005">Endnotes</a></li>
</ol>
</li>
<li class="TOCChapter"><a href="c06.xhtml"><span>Chapter 6: Disassembly and Decompilation</span></a>
<ol>
<li class="TOCH2"><a href="c06.xhtml#h1-501942c06-0001">Assembly Language Basics</a>
<ol>
<li class="TOCH3"><a href="c06.xhtml#h2-501942c06-0001">Registers </a></li>
<li class="TOCH3"><a href="c06.xhtml#h2-501942c06-0002">Assembly Instructions</a></li>
<li class="TOCH3"><a href="c06.xhtml#h2-501942c06-0003">Calling Conventions</a></li>
<li class="TOCH3"><a href="c06.xhtml#h2-501942c06-0004">The objc_msgSend Function</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c06.xhtml#h1-501942c06-0002">Disassembly</a>
<ol>
<li class="TOCH3"><a href="c06.xhtml#h2-501942c06-0005">Objective-C Disassembly</a></li>
<li class="TOCH3"><a href="c06.xhtml#h2-501942c06-0006">Swift Disassembly</a></li>
<li class="TOCH3"><a href="c06.xhtml#h2-501942c06-0007">C/C++ Disassembly</a></li>
<li class="TOCH3"><a href="c06.xhtml#h2-501942c06-0008">Control Flow Disassembly</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c06.xhtml#h1-501942c06-0003">Decompilation</a></li>
<li class="TOCH2"><a href="c06.xhtml#h1-501942c06-0004">Reverse Engineering with Hopper</a>
<ol>
<li class="TOCH3"><a href="c06.xhtml#h2-501942c06-0009">Creating a Binary to Analyze</a></li>
<li class="TOCH3"><a href="c06.xhtml#h2-501942c06-0010">Loading the Binary</a></li>
<li class="TOCH3"><a href="c06.xhtml#h2-501942c06-0011">Exploring the Interface</a></li>
<li class="TOCH3"><a href="c06.xhtml#h2-501942c06-0012">Viewing the Disassembly</a></li>
<li class="TOCH3"><a href="c06.xhtml#h2-501942c06-0013">Changing the Display Mode </a></li>
</ol>
</li>
<li class="TOCH2"><a href="c06.xhtml#h1-501942c06-0005">Up Next</a></li>
<li class="TOCH2"><a href="c06.xhtml#h1-501942c06-0006">Endnotes</a></li>
</ol>
</li>
<li class="TOCChapter"><a href="c07.xhtml"><span>Chapter 7: Dynamic Analysis Tools</span></a>
<ol>
<li class="TOCH2"><a href="c07.xhtml#h1-501942c07-0001">Process Monitoring</a>
<ol>
<li class="TOCH3"><a href="c07.xhtml#h2-501942c07-0001">The ProcessMonitor Utility</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c07.xhtml#h1-501942c07-0002">File Monitoring</a>
<ol>
<li class="TOCH3"><a href="c07.xhtml#h2-501942c07-0002">The fs_usage Utility</a></li>
<li class="TOCH3"><a href="c07.xhtml#h2-501942c07-0003">The FileMonitor Utility</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c07.xhtml#h1-501942c07-0003">Network Monitoring</a>
<ol>
<li class="TOCH3"><a href="c07.xhtml#h2-501942c07-0004">macOS’s Network Status Monitors</a></li>
<li class="TOCH3"><a href="c07.xhtml#h2-501942c07-0005">The Netiquette Utility</a></li>
<li class="TOCH3"><a href="c07.xhtml#h2-501942c07-0006">Network Traffic Monitors</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c07.xhtml#h1-501942c07-0004">Up Next</a></li>
<li class="TOCH2"><a href="c07.xhtml#h1-501942c07-0005">Endnotes</a></li>
</ol>
</li>
<li class="TOCChapter"><a href="c08.xhtml"><span>Chapter 8: Debugging</span></a>
<ol>
<li class="TOCH2"><a href="c08.xhtml#h1-501942c08-0001">Why You Need a Debugger</a></li>
<li class="TOCH2"><a href="c08.xhtml#h1-501942c08-0002">The LLDB Debugger</a>
<ol>
<li class="TOCH3"><a href="c08.xhtml#h2-501942c08-0001">Starting a Debugger Session</a></li>
<li class="TOCH3"><a href="c08.xhtml#h2-501942c08-0002">Controlling Execution</a></li>
<li class="TOCH3"><a href="c08.xhtml#h2-501942c08-0003">Using Breakpoints</a></li>
<li class="TOCH3"><a href="c08.xhtml#h2-501942c08-0004">Examining All the Things</a></li>
<li class="TOCH3"><a href="c08.xhtml#h2-501942c08-0005">Modifying Process State</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c08.xhtml#h1-501942c08-0003">LLDB Scripting</a></li>
<li class="TOCH2"><a href="c08.xhtml#h1-501942c08-0004">A Sample Debugging Session: Uncovering Hidden Cryptocurrency Mining Logic in an App Store Application</a></li>
<li class="TOCH2"><a href="c08.xhtml#h1-501942c08-0005">Up Next</a></li>
<li class="TOCH2"><a href="c08.xhtml#h1-501942c08-0006">Endnotes</a></li>
</ol>
</li>
<li class="TOCChapter"><a href="c09.xhtml"><span>Chapter 9: Anti-Analysis</span></a>
<ol>
<li class="TOCH2"><a href="c09.xhtml#h1-501942c09-0001">Anti-Static-Analysis Approaches</a>
<ol>
<li class="TOCH3"><a href="c09.xhtml#h2-501942c09-0001">Sensitive Strings Disguised as Constants</a></li>
<li class="TOCH3"><a href="c09.xhtml#h2-501942c09-0002">Encrypted Strings</a></li>
<li class="TOCH3"><a href="c09.xhtml#h2-501942c09-0003">Locating Obfuscated Strings</a></li>
<li class="TOCH3"><a href="c09.xhtml#h2-501942c09-0004">Finding the Deobfuscation Code</a></li>
<li class="TOCH3"><a href="c09.xhtml#h2-501942c09-0005">String Deobfuscation via a Hopper Script</a></li>
<li class="TOCH3"><a href="c09.xhtml#h2-501942c09-0006">Forcing the Malware to Execute Its Decryption Routine</a></li>
<li class="TOCH3"><a href="c09.xhtml#h2-501942c09-0007">Code-Level Obfuscations </a></li>
<li class="TOCH3"><a href="c09.xhtml#h2-501942c09-0008">Bypassing Packed Binary Code</a></li>
<li class="TOCH3"><a href="c09.xhtml#h2-501942c09-0009">Decrypting Encrypted Binaries</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c09.xhtml#h1-501942c09-0002">Anti-Dynamic-Analysis Approaches</a>
<ol>
<li class="TOCH3"><a href="c09.xhtml#h2-501942c09-0010">Checking the System Model Name</a></li>
<li class="TOCH3"><a href="c09.xhtml#h2-501942c09-0011">Counting the System’s Logical and Physical CPUs</a></li>
<li class="TOCH3"><a href="c09.xhtml#h2-501942c09-0012">Checking the System’s MAC Address</a></li>
<li class="TOCH3"><a href="c09.xhtml#h2-501942c09-0013">Checking System Integrity Protection Status</a></li>
<li class="TOCH3"><a href="c09.xhtml#h2-501942c09-0014">Detecting or Killing Specific Tools </a></li>
<li class="TOCH3"><a href="c09.xhtml#h2-501942c09-0015">Detecting a Debugger</a></li>
<li class="TOCH3"><a href="c09.xhtml#h2-501942c09-0016">Preventing Debugging with ptrace</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c09.xhtml#h1-501942c09-0003">Bypassing Anti-Dynamic-Analysis Logic</a>
<ol>
<li class="TOCH3"><a href="c09.xhtml#h2-501942c09-0017">Modifying the Execution Environment</a></li>
<li class="TOCH3"><a href="c09.xhtml#h2-501942c09-0018">Patching the Binary Image</a></li>
<li class="TOCH3"><a href="c09.xhtml#h2-501942c09-0019">Modifying the Malware’s Instruction Pointer</a></li>
<li class="TOCH3"><a href="c09.xhtml#h2-501942c09-0020">Modifying a Register Value</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c09.xhtml#h1-501942c09-0004">A Remaining Challenge: Environmentally Generated Keys</a></li>
<li class="TOCH2"><a href="c09.xhtml#h1-501942c09-0005">Up Next</a></li>
<li class="TOCH2"><a href="c09.xhtml#h1-501942c09-0006">Endnotes</a></li>
</ol>
</li>
</ol>
</li>
<li class="TOCPart"><a href="p03.xhtml"><span>Part III: Analyzing EvilQuest</span></a>
<ol>
<li class="TOCChapter"><a href="c10.xhtml"><span>Chapter 10: EvilQuest’s Infection, Triage, and Deobfuscation</span></a>
<ol>
<li class="TOCH2"><a href="c10.xhtml#h1-501942c10-0001">The Infection Vector</a></li>
<li class="TOCH2"><a href="c10.xhtml#h1-501942c10-0002">Triage</a>
<ol>
<li class="TOCH3"><a href="c10.xhtml#h2-501942c10-0001">Confirming the File Type</a></li>
<li class="TOCH3"><a href="c10.xhtml#h2-501942c10-0002">Extracting the Contents</a></li>
<li class="TOCH3"><a href="c10.xhtml#h2-501942c10-0003">Exploring the Package</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c10.xhtml#h1-501942c10-0003">Extracting Embedded Information from the patch Binary</a></li>
<li class="TOCH2"><a href="c10.xhtml#h1-501942c10-0004">Analyzing the Command Line Parameters</a>
<ol>
<li class="TOCH3"><a href="c10.xhtml#h2-501942c10-0004">--silent</a></li>
<li class="TOCH3"><a href="c10.xhtml#h2-501942c10-0005">--noroot</a></li>
<li class="TOCH3"><a href="c10.xhtml#h2-501942c10-0006">--ignrp</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c10.xhtml#h1-501942c10-0005">Analyzing Anti-Analysis Logic</a>
<ol>
<li class="TOCH3"><a href="c10.xhtml#h2-501942c10-0007">Virtual Machine–Thwarting Logic?</a></li>
<li class="TOCH3"><a href="c10.xhtml#h2-501942c10-0008">Debugging-Thwarting Logic</a></li>
<li class="TOCH3"><a href="c10.xhtml#h2-501942c10-0009">Obfuscated Strings</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c10.xhtml#h1-501942c10-0006">Up Next</a></li>
<li class="TOCH2"><a href="c10.xhtml#h1-501942c10-0007">Endnotes</a></li>
</ol>
</li>
<li class="TOCChapter"><a href="c11.xhtml"><span>Chapter 11: EvilQuest’s Persistence and Core Functionality Analysis</span></a>
<ol>
<li class="TOCH2"><a href="c11.xhtml#h1-501942c11-0001">Persistence</a>
<ol>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0001">Killing Unwanted Processes</a></li>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0002">Making Copies of Itself</a></li>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0003">Persisting the Copies as Launch Items</a></li>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0004">Starting the Launch Items</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c11.xhtml#h1-501942c11-0002">The Repersistence Logic</a></li>
<li class="TOCH2"><a href="c11.xhtml#h1-501942c11-0003">The Local Viral Infection Logic</a>
<ol>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0005">Listing Candidate Files for Infection </a></li>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0006">Checking Whether to Infect Each File</a></li>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0007">Infecting Target Files</a></li>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0008">Executing and Repersisting from Infected Files</a></li>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0009">Executing the Infected File’s Original Code</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c11.xhtml#h1-501942c11-0004">The Remote Communications Logic</a>
<ol>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0010">The Mediator and Command and Control Servers</a></li>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0011">Remote Tasking Logic</a></li>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0012">react_exec (0x1)</a></li>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0013">react_save (0x2)</a></li>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0014">react_start (0x4)</a></li>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0015">react_keys (0x8)</a></li>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0016">react_ping (0x10)</a></li>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0017">react_host (0x20)</a></li>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0018">react_scmd (0x40)</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c11.xhtml#h1-501942c11-0005">The File Exfiltration Logic</a>
<ol>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0019">Directory Listing Exfiltration</a></li>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0020">Certificate and Cryptocurrency File Exfiltration</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c11.xhtml#h1-501942c11-0006">File Encryption Logic</a></li>
<li class="TOCH2"><a href="c11.xhtml#h1-501942c11-0007">EvilQuest Updates</a>
<ol>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0021">Better Anti-Analysis Logic</a></li>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0022">Modified Server Addresses</a></li>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0023">A Longer List of Security Tools to Terminate</a></li>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0024">New Persistence Paths</a></li>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0025">A Personal Shoutout</a></li>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0026">Better Functions</a></li>
<li class="TOCH3"><a href="c11.xhtml#h2-501942c11-0027">Removed Ransomware Logic</a></li>
</ol>
</li>
<li class="TOCH2"><a href="c11.xhtml#h1-501942c11-0008">Conclusion</a></li>
<li class="TOCH2"><a href="c11.xhtml#h1-501942c11-0009">Endnotes</a></li>
</ol>
</li>
</ol>
</li>
<li class="TOCChapter"><a href="b01.xhtml"><span>Index</span></a></li>
</ol></nav>
<nav class="FigureList" epub:type="lot">
<h2><b>List of Tables</b></h2>
<ol>
<li><a href="c06.xhtml#table6-1">Table 6-1: Mnemonics and Example Instructions</a></li>
<li><a href="c06.xhtml#table6-2">Table 6-2: The macOS (Intel 64-Bit) Calling Convention</a></li>
<li><a href="c06.xhtml#table6-3">Table 6-3: Calling Convention, in the Context of the <code>objc_msgSend</code> Function</a></li>
<li><a href="c08.xhtml#table8-1">Table 8-1: LLDB Commands for Controlling Execution</a></li>
<li><a href="c08.xhtml#table8-2">Table 8-2: LLDB Commands for Managing Breakpoints</a></li>
<li><a href="c08.xhtml#table8-3">Table 8-3: LLDB Commands for Displaying Memory Contents</a></li>
<li><a href="c11.xhtml#table11-1">Table 11-1: The Structure of the File Created by the Viral Infection Logic </a></li>
</ol>
</nav>
<nav class="FigureList" epub:type="loi">
<h2><b>List of Illustrations</b></h2>
<ol>
<li><a href="c01.xhtml#figure1-1">Figure 1-1: Instructions for a user-assisted notarization bypass (Shlayer)</a></li>
<li><a href="c01.xhtml#figure1-2">Figure 1-2: Fake security alerts (Shlayer)</a></li>
<li><a href="c01.xhtml#figure1-3">Figure 1-3: A fake Flash Player update (Shlayer)</a></li>
<li><a href="c01.xhtml#figure1-4">Figure 1-4: The <em>message-whatsapp.com</em> homepage (Siggen)</a></li>
<li><a href="c01.xhtml#figure1-5">Figure 1-5: The JMTTrading homepage</a></li>
<li><a href="c01.xhtml#figure1-6">Figure 1-6: A trojanized cryptocurrency trading application (Lazarus Group backdoor)</a></li>
<li><a href="c01.xhtml#figure1-7">Figure 1-7: Pirated applications (iWorm)</a></li>
<li><a href="c01.xhtml#figure1-8">Figure 1-8: Safari’s Open “safe” files after downloading feature</a></li>
<li><a href="c01.xhtml#figure1-9">Figure 1-9: A browser warning . . . but is it enough?</a></li>
<li><a href="c01.xhtml#figure1-10">Figure 1-10: Microsoft Word’s macro warning</a></li>
<li><a href="c01.xhtml#figure1-11">Figure 1-11: Malicious build script in an infected Xcode project (XCSSET)</a></li>
<li><a href="c01.xhtml#figure1-12">Figure 1-12: Users who visited <em>macupdate.com</em> and downloaded and ran the trojanized applications may unfortunately have infected themselves—at no fault of their own, really.</a></li>
<li><a href="c01.xhtml#figure1-13">Figure 1-13: Zero-day exploits for sale</a></li>
<li><a href="c02.xhtml#figure2-1">Figure 2-1: Persistent login items. The Finder item is actually malware (NetWire).</a></li>
<li><a href="c02.xhtml#figure2-2">Figure 2-2: A trojanized application (GMERA)</a></li>
<li><a href="c02.xhtml#figure2-3">Figure 2-3: A malicious browser extension (adware)</a></li>
<li><a href="c02.xhtml#figure2-4">Figure 2-4: The reopen applications prompt</a></li>
<li><a href="c02.xhtml#figure2-5">Figure 2-5: KnockKnock? Who’s there? . . . Hopefully only legitimate software!</a></li>
<li><a href="c03.xhtml#figure3-1">Figure 3-1: A categorization of malware’s capabilities</a></li>
<li><a href="c03.xhtml#figure3-2">Figure 3-2: An authorization prompt (EvilQuest)</a></li>
<li><a href="c03.xhtml#figure3-3">Figure 3-3: An authorization prompt, via the <span class="LiteralInCaption"><code>AuthorizationExecuteWithPrivileges</code></span> API (ColdRoot)</a></li>
<li><a href="c03.xhtml#figure3-4">Figure 3-4: Safari’s homepage hijacked (Mughthesec/Safe Finder)</a></li>
<li><a href="c03.xhtml#figure3-5">Figure 3-5: An infected user’s new home page (Mughthesec/Safe Finder)</a></li>
<li><a href="c03.xhtml#figure3-6">Figure 3-6: A network capture of fraudulent ad monetization (IPStorm)</a></li>
<li><a href="c03.xhtml#figure3-7">Figure 3-7: Decryption instructions (KeRanger)</a></li>
<li><a href="c04.xhtml#figure4-1">Figure 4-1: Using WhatsYourSign to identify an application (WindTail)</a></li>
<li><a href="c04.xhtml#figure4-2">Figure 4-2: Using WYS to identify a disk image (EvilQuest)</a></li>
<li><a href="c04.xhtml#figure4-3">Figure 4-3: Using Suspicious Package to examine a package (CPUMeaner)</a></li>
<li><a href="c04.xhtml#figure4-4">Figure 4-4: Using Suspicious Package to export a file (CPUMeaner)</a></li>
<li><a href="c04.xhtml#figure4-5">Figure 4-5: Using Suspicious Package to examine a post-install script (CPUMeaner)</a></li>
<li><a href="c04.xhtml#figure4-6">Figure 4-6: Using Suspicious Package to examine a package (AppleJeus)</a></li>
<li><a href="c04.xhtml#figure4-7">Figure 4-7: A script-based payload (Siggen)</a></li>
<li><a href="c04.xhtml#figure4-8">Figure 4-8: Apple’s Script Editor</a></li>
<li><a href="c04.xhtml#figure4-9">Figure 4-9: Synthetic click via AppleScript (DevilRobber)</a></li>
<li><a href="c04.xhtml#figure4-10">Figure 4-10: Generating a run-only AppleScript</a></li>
<li><a href="c04.xhtml#figure4-11">Figure 4-11: Viewing the contents of an application bundle (WindTail)</a></li>
<li><a href="c04.xhtml#figure4-12">Figure 4-12: Using Apparency to view the contents of an application bundle (WindTail)</a></li>
<li><a href="c05.xhtml#figure5-1">Figure 5-1: Layout of a Mach-O binary</a></li>
<li><a href="c05.xhtml#figure5-2">Figure 5-2: Viewing a Mach-O header with MachOView (WindTail)</a></li>
<li><a href="c05.xhtml#figure5-3">Figure 5-3: The layout of a load command</a></li>
<li><a href="c05.xhtml#figure5-4">Figure 5-4: Leveraging Google to identify a malicious file from its hash (WindTail)</a></li>
<li><a href="c05.xhtml#figure5-5">Figure 5-5: Leveraging VirusTotal to identify a malicious file from its hash (WindTail)</a></li>
<li><a href="c05.xhtml#figure5-6">Figure 5-6: Leveraging Google to identify a malicious file via its code-signing team identifier (WindTail)</a></li>
<li><a href="c05.xhtml#figure5-7">Figure 5-7: Leveraging Google to identify malware via embedded strings (WindTail)</a></li>
<li><a href="c05.xhtml#figure5-8">Figure 5-8: A simple script-based application, likely built via Appify (Shlayer)</a></li>
<li><a href="c05.xhtml#figure5-9">Figure 5-9: A security warning from MacUpdate</a></li>
<li><a href="c05.xhtml#figure5-10">Figure 5-10: A malicious installer script embedded via Platypus (CreativeUpdate)</a></li>
<li><a href="c05.xhtml#figure5-11">Figure 5-11: Archived source code (GravityRAT)</a></li>
<li><a href="c05.xhtml#figure5-12">Figure 5-12: Unpacked source code files (GravityRAT)</a></li>
<li><a href="c06.xhtml#figure6-1">Figure 6-1: Loader window in Hopper</a></li>
<li><a href="c06.xhtml#figure6-2">Figure 6-2: Basic file information in Hopper</a></li>
<li><a href="c06.xhtml#figure6-3">Figure 6-3: Procedure view in Hopper</a></li>
<li><a href="c06.xhtml#figure6-4">Figure 6-4: Embedded strings view in Hopper</a></li>
<li><a href="c06.xhtml#figure6-5">Figure 6-5: Selecting the option to view cross-references to the “Hello, World!” string.</a></li>
<li><a href="c06.xhtml#figure6-6">Figure 6-6: Cross-references to the “Hello, World!” string</a></li>
<li><a href="c06.xhtml#figure6-7">Figure 6-7: Cross-references to the <span class="LiteralInCaption"><code>NSLog</code></span> function</a></li>
<li><a href="c06.xhtml#figure6-8">Figure 6-8: Display modes in Hopper</a></li>
<li><a href="c07.xhtml#figure7-1">Figure 7-1: A network monitor reveals the address of a command and control server (WindTail)</a></li>
<li><a href="c07.xhtml#figure7-2">Figure 7-2: Using Netiquette to uncover the address of a command and control server (Dacls)</a></li>
<li><a href="c07.xhtml#figure7-3">Figure 7-3: Using Wireshark to capture survey data (ColdRoot)</a></li>
<li><a href="c07.xhtml#figure7-4">Figure 7-4: Using Wireshark to uncover capabilities, in this case a command that returns the malware’s location on an infected system (FruitFly)</a></li>
<li><a href="c07.xhtml#figure7-5">Figure 7-5: Using Wireshark to uncover capabilities, in this case a command that returns a screen capture of the infected system (FruitFly)</a></li>
<li><a href="c08.xhtml#figure8-1">Figure 8-1: A surreptitious cryptocurrency miner in Apple’s official Mac App Store</a></li>
<li><a href="c09.xhtml#figure9-1">Figure 9-1: Embedded obfuscated data (NetWire)</a></li>
<li><a href="c09.xhtml#figure9-2">Figure 9-2: Cross-references to <span class="LiteralInCaption"><code>@</code></span><span class="LiteralInCaption"><code>selector(</code></span><span class="LiteralInCaption"><code>yoop:)</code></span> (WindTail)</a></li>
<li><a href="c09.xhtml#figure9-3">Figure 9-3: UPX section header (ColdRoot)</a></li>
<li><a href="c10.xhtml#figure10-1">Figure 10-1: Pirated version of Little Snitch trojanized with EvilQuest </a></li>
<li><a href="c10.xhtml#figure10-2">Figure 10-2: The trojanized <em>Mixed </em><em>In</em><em> Key 8.dmg</em> file on VirusTotal</a></li>
<li><a href="c10.xhtml#figure10-3">Figure 10-3: WYS confirms the item as a disk image</a></li>
<li><a href="c10.xhtml#figure10-4">Figure 10-4: WYS confirms the item as an unsigned package</a></li>
<li><a href="c10.xhtml#figure10-5">Figure 10-5: Using Suspicious Package to explore files within the trojanized <em>Mixed in Key</em> package </a></li>
<li><a href="c10.xhtml#figure10-6">Figure 10-6: The still validly signed application (via WYS) </a></li>
<li><a href="c10.xhtml#figure10-7">Figure 10-7: The malware’s authentication prompt, via <span class="LiteralInCaption"><code>osascript</code></span></a></li>
<li><a href="c11.xhtml#figure11-1">Figure 11-1: Typecasting the file’s header as a Mach-O header</a></li>
<li><a href="c11.xhtml#figure11-2">Figure 11-2: EvilQuest’s ransom note</a></li>
<li><a href="c11.xhtml#figure11-3">Figure 11-3: Cross-references to the <span class="LiteralInCaption"><code>ei_run_memory_hrd</code></span> function</a></li>
<li><a href="c11.xhtml#figure11-4">Figure 11-4: An interesting observation</a></li>
</ol>
</nav>
<nav class="FigureList" epub:type="lol">
<h2><b>List of Listings</b></h2>
<ol>
<li><a href="c01.xhtml#listing1-1">Listing 1-1: Notarized malware (Shlayer)</a></li>
<li><a href="c01.xhtml#listing1-2">Listing 1-2: An <em>Info.plist</em> file, containing a custom URL scheme <code>openurl2622007</code> (WindTail)</a></li>
<li><a href="c01.xhtml#listing1-3">Listing 1-3: Observing the launch services daemon (<code>lsd</code>) file I/O events</a></li>
<li><a href="c01.xhtml#listing1-4">Listing 1-4: WindTail (<em>Final_Presentation.app</em>), now registered as a custom URL handler </a></li>
<li><a href="c01.xhtml#listing1-5">Listing 1-5: Downloading and launching WindTail via Safari (a proof of concept)</a></li>
<li><a href="c01.xhtml#listing1-6">Listing 1-6: Malicious macro code (Lazarus Group backdoor)</a></li>
<li><a href="c01.xhtml#listing1-7">Listing 1-7: Malicious build script <em>Assets.xcassets</em> (XCSSET)</a></li>
<li><a href="c01.xhtml#listing1-8">Listing 1-8: Remote infection logic (IPStorm)</a></li>
<li><a href="c02.xhtml#listing2-1">Listing 2-1: Login item persistence (NetWire)</a></li>
<li><a href="c02.xhtml#listing2-2">Listing 2-2: Imports, including <code>LSSharedFileList*</code> APIs (WindTail)</a></li>
<li><a href="c02.xhtml#listing2-3">Listing 2-3: macOS utilities for parsing <em>.plist</em> files</a></li>
<li><a href="c02.xhtml#listing2-4">Listing 2-4: An example launch item property list</a></li>
<li><a href="c02.xhtml#listing2-5">Listing 2-5: A launch item property list template (NetWire)</a></li>
<li><a href="c02.xhtml#listing2-6">Listing 2-6: Launch agent persistence logic (NetWire)</a></li>
<li><a href="c02.xhtml#listing2-7">Listing 2-7: A malicious launch item property list (NetWire)</a></li>
<li><a href="c02.xhtml#listing2-8">Listing 2-8: A malicious installer script, <em>run.sh</em> (GMERA)</a></li>
<li><a href="c02.xhtml#listing2-9">Listing 2-9: A malicious launch agent plist (GMERA)</a></li>
<li><a href="c02.xhtml#listing2-10">Listing 2-10: A decrypted property list template (EvilQuest)</a></li>
<li><a href="c02.xhtml#listing2-11">Listing 2-11: A launch item plist (EvilQuest)</a></li>
<li><a href="c02.xhtml#listing2-12">Listing 2-12: Cron job persistence (EmPyre)</a></li>
<li><a href="c02.xhtml#listing2-13">Listing 2-13: Cron job persistence (Janicab)</a></li>
<li><a href="c02.xhtml#listing2-14">Listing 2-14: Enabling the at scheduler</a></li>
<li><a href="c02.xhtml#listing2-15">Listing 2-15: Periodic scripts</a></li>
<li><a href="c02.xhtml#listing2-16">Listing 2-16: An example <code>LoginHook</code></a></li>
<li><a href="c02.xhtml#listing2-17">Listing 2-17: <code>DYLD_INSERT_LIBRARIES</code> persistence (FlashBack)</a></li>
<li><a href="c02.xhtml#listing2-18">Listing 2-18: A proxy dynamic library </a></li>
<li><a href="c02.xhtml#listing2-19">Listing 2-19: A dynamic library hijacker, PhotoFoundation, loaded by Apple’s Photo Stream Agent</a></li>
<li><a href="c02.xhtml#listing2-20">Listing 2-20: A dylib hijacking persistence module, <em>CreateHijacker.py</em></a></li>
<li><a href="c02.xhtml#listing2-21">Listing 2-21: Subversion of the <em>rc.common</em> file for persistence (iKitten)</a></li>
<li><a href="c02.xhtml#listing2-22">Listing 2-22: The reopened applications property list</a></li>
<li><a href="c02.xhtml#listing2-23">Listing 2-23: Viral infection logic (EvilQuest)</a></li>
<li><a href="c03.xhtml#listing3-1">Listing 3-1: Detection of the LittleSnitch firewall (Proton)</a></li>
<li><a href="c03.xhtml#listing3-2">Listing 3-2: Survey-related methods (MacDownloader)</a></li>
<li><a href="c03.xhtml#listing3-3">Listing 3-3: A survey (MacDownloader)</a></li>
<li><a href="c03.xhtml#listing3-4">Listing 3-4: Escaping the sandbox via a launch agent </a></li>
<li><a href="c03.xhtml#listing3-5">Listing 3-5: Invocation of the <code>AuthorizationExecuteWithPrivileges</code> API (ColdRoot)</a></li>
<li><a href="c03.xhtml#listing3-6">Listing 3-6: Exploitation of a writeconfig XPC service zero-day (XSLCmd)</a></li>
<li><a href="c03.xhtml#listing3-7">Listing 3-7: A persistent launch item plist (CreativeUpdate)</a></li>
<li><a href="c03.xhtml#listing3-8">Listing 3-8: A persistent remote shell (Dummy)</a></li>
<li><a href="c03.xhtml#listing3-9">Listing 3-9: Command execution via the <code>popen</code> API (Lazarus Group backdoor) </a></li>
<li><a href="c03.xhtml#listing3-10">Listing 3-10: A file execution method (Komplex)</a></li>
<li><a href="c03.xhtml#listing3-11">Listing 3-11: File execution logic (Komplex)</a></li>
<li><a href="c03.xhtml#listing3-12">Listing 3-12: In-memory code execution (Lazarus Group backdoor)</a></li>
<li><a href="c03.xhtml#listing3-13">Listing 3-13: File download connections (WindTail)</a></li>
<li><a href="c03.xhtml#listing3-14">Listing 3-14: File exfiltration wrapper (MacDownloader)</a></li>
<li><a href="c03.xhtml#listing3-15">Listing 3-15: File exfiltration (MacDownloader)</a></li>
<li><a href="c03.xhtml#listing3-16">Listing 3-16: The libcurl API (leveraged by a Lazarus Group implant)</a></li>
<li><a href="c03.xhtml#listing3-17">Listing 3-17: Kernel symbol resolution (FinSpy)</a></li>
<li><a href="c03.xhtml#listing3-18">Listing 3-18: Kernel-mode process hiding (FinSpy)</a></li>
<li><a href="c04.xhtml#listing4-1">Listing 4-1: An unknown file type </a></li>
<li><a href="c04.xhtml#listing4-2">Listing 4-2: Using <code>file</code> to identify a byte-compiled Python script </a></li>
<li><a href="c04.xhtml#listing4-3">Listing 4-3: Using <code>file</code> to identify a compiled 64-bit Mach-O executable (WindTail)</a></li>
<li><a href="c04.xhtml#listing4-4">Listing 4-4: With disk images, <code>file</code> struggles (EvilQuest)</a></li>
<li><a href="c04.xhtml#listing4-5">Listing 4-5: Using <code>hdiutil</code> to mount an infected disk image (CreativeUpdate)</a></li>
<li><a href="c04.xhtml#listing4-6">Listing 4-6: Listing a disk image’s files (AppleJeus)</a></li>
<li><a href="c04.xhtml#listing4-7">Listing 4-7: A post-install script, containing installer logic (AppleJeus)</a></li>
<li><a href="c04.xhtml#listing4-8">Listing 4-8: A malicious bash script (Siggen)</a></li>
<li><a href="c04.xhtml#listing4-9">Listing 4-9: Another malicious bash script (Siggen)</a></li>
<li><a href="c04.xhtml#listing4-10">Listing 4-10: A malicious Python script (Dummy)</a></li>
<li><a href="c04.xhtml#listing4-11">Listing 4-11: A decoded Python payload (Siggen)</a></li>
<li><a href="c04.xhtml#listing4-12">Listing 4-12: Decoded configuration data (Siggen)</a></li>
<li><a href="c04.xhtml#listing4-13">Listing 4-13: Decompiled Python code (unspecified adware)</a></li>
<li><a href="c04.xhtml#listing4-14">Listing 4-14: Deobfuscated Python code (unspecified adware) </a></li>
<li><a href="c04.xhtml#listing4-15">Listing 4-15: “Hello, World!” in AppleScript</a></li>
<li><a href="c04.xhtml#listing4-16">Listing 4-16: Using <code>file</code> to identify compiled AppleScript</a></li>
<li><a href="c04.xhtml#listing4-17">Listing 4-17: “Hello, World!” via AppleScript </a></li>
<li><a href="c04.xhtml#listing4-18">Listing 4-18: Malicious AppleScript (unspecified adware)</a></li>
<li><a href="c04.xhtml#listing4-19">Listing 4-19: Synthetic click via AppleScript (DevilRobber)</a></li>
<li><a href="c04.xhtml#listing4-20">Listing 4-20: Decompiling a run-only AppleScript via <code>osadecompile</code> fails</a></li>
<li><a href="c04.xhtml#listing4-21">Listing 4-21: A persistent launch item plist (OSAMiner)</a></li>
<li><a href="c04.xhtml#listing4-22">Listing 4-22: Decompiling run-only AppleScript via <code>osadecompile</code> fails (OSAMiner)</a></li>
<li><a href="c04.xhtml#listing4-23">Listing 4-23: Decompiling run-only AppleScript via the AppleScript disassembler</a></li>
<li><a href="c04.xhtml#listing4-24">Listing 4-24: Decompiling run-only AppleScripts via an AppleScript disassembler and <code>aevt_decompile</code></a></li>
<li><a href="c04.xhtml#listing4-25">Listing 4-25: Further decompiling run-only AppleScript via <code>aevt_decompile</code> (OSAMiner)</a></li>
<li><a href="c04.xhtml#listing4-26">Listing 4-26: Obfuscated Perl (FruitFly)</a></li>
<li><a href="c04.xhtml#listing4-27">Listing 4-27: Beautified, though still somewhat obfuscated, Perl (FruitFly)</a></li>
<li><a href="c04.xhtml#listing4-28">Listing 4-28: Using <code>file</code> to identify an Office document </a></li>
<li><a href="c04.xhtml#listing4-29">Listing 4-29: Using <code>olevba</code> to extract macros </a></li>
<li><a href="c04.xhtml#listing4-30">Listing 4-30: Using <code>olevba</code> to extract malicious macros</a></li>
<li><a href="c04.xhtml#listing4-31">Listing 4-31: Using <code>find</code> to view the contents of an application bundle (WindTail)</a></li>
<li><a href="c04.xhtml#listing4-32">Listing 4-32: An <em>Info.plist</em> file (WindTail)</a></li>
<li><a href="c04.xhtml#listing4-33">Listing 4-33: Using <code>file</code> to identify a binary property list (Siggen) </a></li>
<li><a href="c04.xhtml#listing4-34">Listing 4-34: Using <code>defaults</code> to read a binary property list (Siggen)</a></li>
<li><a href="c05.xhtml#listing5-1">Listing 5-1: The <code>mach_header_64</code> structure </a></li>
<li><a href="c05.xhtml#listing5-2">Listing 5-2: Viewing a Mach-O header with <code>otool</code> (WindTail)</a></li>
<li><a href="c05.xhtml#listing5-3">Listing 5-3: A universal binary (Pirrit)</a></li>
<li><a href="c05.xhtml#listing5-4">Listing 5-4: Viewing a fat header with <code>otool</code><code> -f</code> (Pirrit)</a></li>
<li><a href="c05.xhtml#listing5-5">Listing 5-5: Extracting a Mach-O from a universal binary with <code>lipo</code> (Pirrit)</a></li>
<li><a href="c05.xhtml#listing5-6">Listing 5-6: Viewing load commands with <code>otool</code> (WindTail)</a></li>
<li><a href="c05.xhtml#listing5-7">Listing 5-7: The <code>load_command</code> structure (Pirrit)</a></li>
<li><a href="c05.xhtml#listing5-8">Listing 5-8: The <code>entry_point_command</code> structure </a></li>
<li><a href="c05.xhtml#listing5-9">Listing 5-9: The <code>dylib_command</code> and <code>dylib</code> structures</a></li>
<li><a href="c05.xhtml#listing5-10">Listing 5-10: Dependencies of a trojanized iTerm application (ZuRu)</a></li>
<li><a href="c05.xhtml#listing5-11">Listing 5-11: Computing hashes with <code>md5</code> and <code>shasum</code> (WindTail)</a></li>
<li><a href="c05.xhtml#listing5-12">Listing 5-12: Viewing code-signing information for a self-signed file with <code>codesign</code> (WindTail)</a></li>
<li><a href="c05.xhtml#listing5-13">Listing 5-13: Viewing code-signing information for an Apple application with <code>codesign</code></a></li>
<li><a href="c05.xhtml#listing5-14">Listing 5-14: Viewing code-signing information for a third-party application with <code>codesign</code></a></li>
<li><a href="c05.xhtml#listing5-15">Listing 5-15: Viewing the notarization status of a file via <code>spctl</code></a></li>
<li><a href="c05.xhtml#listing5-16">Listing 5-16: Viewing the certificate status of a file with <code>codesign</code> (WindTail)</a></li>
<li><a href="c05.xhtml#listing5-17">Listing 5-17: Extracting embedded strings with <code>strings</code></a></li>
<li><a href="c05.xhtml#listing5-18">Listing 5-18: Reconstructing embedded class information with <code>class-dump</code> (Crisis)</a></li>
<li><a href="c05.xhtml#listing5-19">Listing 5-19: Reconstructing embedded class information with <code>class-dump</code> (XAgent)</a></li>
<li><a href="c05.xhtml#listing5-20">Listing 5-20: A binary invoking PyInstaller’s entry point </a></li>
<li><a href="c05.xhtml#listing5-21">Listing 5-21: A malicious installer script (Shlayer)</a></li>
<li><a href="c05.xhtml#listing5-22">Listing 5-22: A malicious installer script (CreativeUpdate)</a></li>
<li><a href="c05.xhtml#listing5-23">Listing 5-23: MinerGate’s command line cryptocurrency miner</a></li>
<li><a href="c05.xhtml#listing5-24">Listing 5-24: Triaging a binary via <code>file</code> and <code>strings</code> (GravityRAT)</a></li>
<li><a href="c05.xhtml#listing5-25">Listing 5-25: Extracting the contents of a “PyInstallered” binary with <code>pyinstxtractor</code> (GravityRAT)</a></li>
<li><a href="c05.xhtml#listing5-26">Listing 5-26: Extracted Python files (GravityRAT) </a></li>
<li><a href="c05.xhtml#listing5-27">Listing 5-27: Viewing linked frameworks (including Electron) with <code>otool</code> (GravityRAT)</a></li>
<li><a href="c05.xhtml#listing5-28">Listing 5-28: Unpacking source code with <code>npx</code> (GravityRAT)</a></li>
<li><a href="c05.xhtml#listing5-29">Listing 5-29: Persistence via a cron job (GravityRAT) </a></li>
<li><a href="c06.xhtml#listing6-1">Listing 6-1: Initializing a URL object via Objective-C</a></li>
<li><a href="c06.xhtml#listing6-2">Listing 6-2: Initializing a URL object, disassembled</a></li>
<li><a href="c06.xhtml#listing6-3">Listing 6-3: Initializing a <code>NSData</code> object, disassembled (Komplex)</a></li>
<li><a href="c06.xhtml#listing6-4">Listing 6-4: Reconstructed Objective-C code (Komplex)</a></li>
<li><a href="c06.xhtml#listing6-5">Listing 6-5: Writing out a file, disassembled (Komplex)</a></li>
<li><a href="c06.xhtml#listing6-6">Listing 6-6: Reconstructed Objective-C (Komplex)</a></li>
<li><a href="c06.xhtml#listing6-7">Listing 6-7: An embedded Mach-O binary (Komplex)</a></li>
<li><a href="c06.xhtml#listing6-8">Listing 6-8: Swift disassembly of an <code>NSTask</code> initialization (Dacls)</a></li>
<li><a href="c06.xhtml#listing6-9">Listing 6-9: More Swift disassembly of an <code>NSTask</code> initialization (Dacls)</a></li>
<li><a href="c06.xhtml#listing6-10">Listing 6-10: Embedded arguments (Dacls)</a></li>
<li><a href="c06.xhtml#listing6-11">Listing 6-11: Disassembly of an <code>NSTask</code> launch (Dacls)</a></li>
<li><a href="c06.xhtml#listing6-12">Listing 6-12: Disassembly of a <code>getDeviceSerial</code> function (AppleJeus)</a></li>
<li><a href="c06.xhtml#listing6-13">Listing 6-13: Network connectivity check and control flow (Komplex)</a></li>
<li><a href="c06.xhtml#listing6-14">Listing 6-14: Network connectivity check and control flow, reconstructed (Komplex)</a></li>
<li><a href="c06.xhtml#listing6-15">Listing 6-15: Decompilation of the <code>getDeviceSerial</code> function (AppleJeus)</a></li>
<li><a href="c06.xhtml#listing6-16">Listing 6-16: Decompilation of the <code>connectedToInternet</code> function (Komplex)</a></li>
<li><a href="c06.xhtml#listing6-17">Listing 6-17: Apple’s “Hello, World!”</a></li>
<li><a href="c06.xhtml#listing6-18">Listing 6-18: Compiling “Hello, World!”</a></li>
<li><a href="c06.xhtml#listing6-19">Listing 6-19: “Hello, World!” disassembled by Hopper</a></li>
<li><a href="c06.xhtml#listing6-20">Listing 6-20: “Hello, World!” decompiled</a></li>
<li><a href="c06.xhtml#listing6-21">Listing 6-21: The original “Hello, World!” source code for comparison</a></li>
<li><a href="c07.xhtml#listing7-1">Listing 7-1: Using ProcessMonitor to observe installer commands (AppleJeus variant)</a></li>
<li><a href="c07.xhtml#listing7-2">Listing 7-2: Using ProcessMonitor to uncover file exfiltration functionality (WindTail)</a></li>
<li><a href="c07.xhtml#listing7-3">Listing 7-3: Using <code>fs_usage</code> to observe file accesses (ColdRoot)</a></li>
<li><a href="c07.xhtml#listing7-4">Listing 7-4: Configuration file (ColdRoot)</a></li>
<li><a href="c07.xhtml#listing7-5">Listing 7-5: Using FileMonitor to uncover persistence (BirdMiner)</a></li>
<li><a href="c07.xhtml#listing7-6">Listing 7-6: Using FileMonitor to uncover a persistent backdoor component (Yort)</a></li>
<li><a href="c07.xhtml#listing7-7">Listing 7-7: Embedded command and control server, encrypted to thwart static analysis efforts (WindTail)</a></li>
<li><a href="c07.xhtml#listing7-8">Listing 7-8: Using <code>lsof</code> to uncover the address of a command and control server (Mokes)</a></li>
<li><a href="c07.xhtml#listing7-9">Listing 7-9: Using <code>tcpdump</code> to observe downloads (InstallCore)</a></li>
<li><a href="c08.xhtml#listing8-1">Listing 8-1: Encrypted data (Mami)</a></li>
<li><a href="c08.xhtml#listing8-2">Listing 8-2: Decrypted configuration data (Mami)</a></li>
<li><a href="c08.xhtml#listing8-3">Listing 8-3: Starting a debugging session</a></li>
<li><a href="c08.xhtml#listing8-4">Listing 8-4: Waiting to attach to a process (named malware)</a></li>
<li><a href="c08.xhtml#listing8-5">Listing 8-5: Process attachment, triggered by the <code>--</code><code>waitfor</code> flag</a></li>
<li><a href="c08.xhtml#listing8-6">Listing 8-6: Setting a breakpoint on a program’s <code>main</code> function</a></li>
<li><a href="c08.xhtml#listing8-7">Listing 8-7: Breakpoint hit; execution halted</a></li>
<li><a href="c08.xhtml#listing8-8">Listing 8-8: Setting a breakpoint by address</a></li>
<li><a href="c08.xhtml#listing8-9">Listing 8-9: Setting a breakpoint on an <code>installPayload</code> method (FinFisher)</a></li>
<li><a href="c08.xhtml#listing8-10">Listing 8-10: Setting a conditional breakpoint</a></li>
<li><a href="c08.xhtml#listing8-11">Listing 8-11: Adding breakpoint commands</a></li>
<li><a href="c08.xhtml#listing8-12">Listing 8-12: Printing a dictionary object (Mami)</a></li>
<li><a href="c08.xhtml#listing8-13">Listing 8-13: Modifying the instruction pointer </a></li>
<li><a href="c08.xhtml#listing8-14">Listing 8-14: Modifying a register</a></li>
<li><a href="c08.xhtml#listing8-15">Listing 8-15: Setting a breakpoint via a debugger script</a></li>
<li><a href="c08.xhtml#listing8-16">Listing 8-16: Implementing a breakpoint action via a debugger script</a></li>
<li><a href="c08.xhtml#listing8-17">Listing 8-17: Our debugger script in action</a></li>
<li><a href="c08.xhtml#listing8-18">Listing 8-18: Cryptocurrency mining logic within an App Store application?</a></li>
<li><a href="c08.xhtml#listing8-19">Listing 8-19: Initializing a debugging session and setting an initial breakpoint</a></li>
<li><a href="c08.xhtml#listing8-20">Listing 8-20: Breakpoint hit; execution halted</a></li>
<li><a href="c08.xhtml#listing8-21">Listing 8-21: Stepping through instructions and over method calls</a></li>
<li><a href="c08.xhtml#listing8-22">Listing 8-22: Stepping through instructions until the call of interest is reached</a></li>
<li><a href="c08.xhtml#listing8-23">Listing 8-23: Displaying the <code>startMiningWithPort:</code><code>...</code> method’s parameters</a></li>
<li><a href="c08.xhtml#listing8-24">Listing 8-24: Displaying a network object containing cryptocurrency miner account information and statistics </a></li>
<li><a href="c09.xhtml#listing9-1">Listing 9-1: Basic string obfuscation (Dacls)</a></li>
<li><a href="c09.xhtml#listing9-2">Listing 9-2: Deobfuscated strings (Dacls)</a></li>
<li><a href="c09.xhtml#listing9-3">Listing 9-3: Decryption of a command and control server (WindTail)</a></li>
<li><a href="c09.xhtml#listing9-4">Listing 9-4: A decrypted command and control address (WindTail)</a></li>
<li><a href="c09.xhtml#listing9-5">Listing 9-5: Obfuscated strings (WindTail)</a></li>
<li><a href="c09.xhtml#listing9-6">Listing 9-6: Dumping now-decrypted configuration parameters (NetWire)</a></li>
<li><a href="c09.xhtml#listing9-7">Listing 9-7: Possible string deobfuscation (WindTail)</a></li>
<li><a href="c09.xhtml#listing9-8">Listing 9-8: The <code>yoop:</code> method (WindTail)</a></li>
<li><a href="c09.xhtml#listing9-9">Listing 9-9: An encrypted string, and a call to a possible string-decryption function (DoubleFantasy)</a></li>
<li><a href="c09.xhtml#listing9-10">Listing 9-10: A simple string-decryption algorithm (DoubleFantasy)</a></li>
<li><a href="c09.xhtml#listing9-11">Listing 9-11: A re-implementation of DoubleFantasy’s string decryption algorithm in Python</a></li>
<li><a href="c09.xhtml#listing9-12">Listing 9-12: Leveraging the Hopper API to decrypt embedded strings (DoubleFantasy)</a></li>
<li><a href="c09.xhtml#listing9-13">Listing 9-13: Disassembly, now annotated with the decrypted string (DoubleFantasy)</a></li>
<li><a href="c09.xhtml#listing9-14">Listing 9-14: Obfuscated strings (EvilQuest)</a></li>
<li><a href="c09.xhtml#listing9-15">Listing 9-15: Invocation of a deobfuscation function, <code>ei_str</code> (EvilQuest)</a></li>
<li><a href="c09.xhtml#listing9-16">Listing 9-16: Our dynamic string deobfuscator library (EvilQuest)</a></li>
<li><a href="c09.xhtml#listing9-17">Listing 9-17: Deobfuscated strings (EvilQuest)</a></li>
<li><a href="c09.xhtml#listing9-18">Listing 9-18: Spurious function calls (Pirrit)</a></li>
<li><a href="c09.xhtml#listing9-19">Listing 9-19: Spurious instructions (Pirrit)</a></li>
<li><a href="c09.xhtml#listing9-20">Listing 9-20: Unpacking via UPX (ColdRoot)</a></li>
<li><a href="c09.xhtml#listing9-21">Listing 9-21: An encrypted installer; note that the <code>flags</code> field is set to <code>0x8</code>, <code>SG_PROTECTED_VERSION_1</code> (HackingTeam)</a></li>
<li><a href="c09.xhtml#listing9-22">Listing 9-22: macOS’s support of encrypted Mach-O binaries</a></li>
<li><a href="c09.xhtml#listing9-23">Listing 9-23: Obfuscated anti-VM logic (MacRansom)</a></li>
<li><a href="c09.xhtml#listing9-24">Listing 9-24: Deobfuscated anti-VM command (MacRansom)</a></li>
<li><a href="c09.xhtml#listing9-25">Listing 9-25: System’s hardware model (in a virtual machine)</a></li>
<li><a href="c09.xhtml#listing9-26">Listing 9-26: System’s hardware model (on native hardware)</a></li>
<li><a href="c09.xhtml#listing9-27">Listing 9-27: Retrieving the primary MAC address (Mughthesec)</a></li>
<li><a href="c09.xhtml#listing9-28">Listing 9-28: Retrieving the System Integrity Protection status (Pirrit)</a></li>
<li><a href="c09.xhtml#listing9-29">Listing 9-29: Basic firewall detection (Proton)</a></li>
<li><a href="c09.xhtml#listing9-30">Listing 9-30: Debugger detection (via the <code>P_TRACED</code> flag)</a></li>
<li><a href="c09.xhtml#listing9-31">Listing 9-31: Debugger detection (Komplex)</a></li>
<li><a href="c09.xhtml#listing9-32">Listing 9-32: A premature exit due to <code>ptrace</code> with the <code>PT_DENY_ATTACH</code> flag (Proton)</a></li>
<li><a href="c09.xhtml#listing9-33">Listing 9-33: Obfuscated anti-debugger logic via <code>ptrace</code>, <code>PT_DENY_ATTACH</code> (Proton)</a></li>
<li><a href="c09.xhtml#listing9-34">Listing 9-34: Anti-analysis functions? (EvilQuest)</a></li>
<li><a href="c09.xhtml#listing9-35">Listing 9-35: Anti-debugging logic (EvilQuest)</a></li>
<li><a href="c09.xhtml#listing9-36">Listing 9-36: Anti-analysis logic, now <code>nop</code>’d out (KeRanger)</a></li>
<li><a href="c09.xhtml#listing9-37">Listing 9-37: Skipping anti-debugger logic (EvilQuest)</a></li>
<li><a href="c09.xhtml#listing9-38">Listing 9-38: Modifying register values to bypass anti-debugging logic</a></li>
<li><a href="c10.xhtml#listing10-1">Listing 10-1: Listing the mounted disk image’s contents</a></li>
<li><a href="c10.xhtml#listing10-2">Listing 10-2: Checking the package’s signature </a></li>
<li><a href="c10.xhtml#listing10-3">Listing 10-3: <em>Mixed </em><em>In</em><em> Key 8.pkg</em>’s post-install script</a></li>
<li><a href="c10.xhtml#listing10-4">Listing 10-4: Monitoring the actions of the malicious post-install script</a></li>
<li><a href="c10.xhtml#listing10-5">Listing 10-5: Extracting embedded strings</a></li>
<li><a href="c10.xhtml#listing10-6">Listing 10-6: Extracting embedded names (API calls, functions, and so on)</a></li>
<li><a href="c10.xhtml#listing10-7">Listing 10-7: Anti-sandbox check, through time checks</a></li>
<li><a href="c10.xhtml#listing10-8">Listing 10-8: The start of anti-debugging logic, via the <code>sysctl</code> API</a></li>
<li><a href="c10.xhtml#listing10-9">Listing 10-9: Is the <code>P_TRACED</code> flag (<code>0x800</code>) set? If so, the process is being debugged.</a></li>
<li><a href="c10.xhtml#listing10-10">Listing 10-10: Anti-debugging logic that uses <code>sysctl</code> and <code>P_TRACED</code></a></li>
<li><a href="c10.xhtml#listing10-11">Listing 10-11: A premature exit if a debugger is detected</a></li>
<li><a href="c10.xhtml#listing10-12">Listing 10-12: Anti-debugging logic via the <code>ptrace</code> API</a></li>
<li><a href="c10.xhtml#listing10-13">Listing 10-13: Bypassing anti-debugging logic with a breakpoint command</a></li>
<li><a href="c10.xhtml#listing10-14">Listing 10-14: Obfuscated strings, passed to the <code>ei_str</code> function</a></li>
<li><a href="c10.xhtml#listing10-15">Listing 10-15: The <code>ei_str</code> function, decompiled</a></li>
<li><a href="c10.xhtml#listing10-16">Listing 10-16: Decrypting all EvilQuest’s embedded strings</a></li>
<li><a href="c11.xhtml#listing11-1">Listing 11-1: <code>ei_persistence_main</code>, decompiled</a></li>
<li><a href="c11.xhtml#listing11-2">Listing 11-2: Process enumeration via the <code>sysctl</code> API</a></li>
<li><a href="c11.xhtml#listing11-3">Listing 11-3: EvilQuest’s “unwanted” programs</a></li>
<li><a href="c11.xhtml#listing11-4">Listing 11-4: Unwanted process termination </a></li>
<li><a href="c11.xhtml#listing11-5">Listing 11-5: Unwanted process termination, observed in a debugger</a></li>
<li><a href="c11.xhtml#listing11-6">Listing 11-6: The start of the malware’s copy operation, seen in FileMonitor </a></li>
<li><a href="c11.xhtml#listing11-7">Listing 11-7: Hashes confirm the copies are identical</a></li>
<li><a href="c11.xhtml#listing11-8">Listing 11-8: Parameters passed to the <code>install_daemon</code> function</a></li>
<li><a href="c11.xhtml#listing11-9">Listing 11-9: A (decrypted) launch item property list template</a></li>
<li><a href="c11.xhtml#listing11-10">Listing 11-10: The malware’s launch agent plist (<em>~</em><em>/Library/LaunchAgents/com.apple.questd.plist</em>)</a></li>
<li><a href="c11.xhtml#listing11-11">Listing 11-11: The malware’s launch daemon plist (<em>/Library/LaunchDaemons/com.apple.questd.plist</em>)</a></li>
<li><a href="c11.xhtml#listing11-12">Listing 11-12: The malware, running as both a launch daemon and an agent</a></li>
<li><a href="c11.xhtml#listing11-13">Listing 11-13: The <code>run_daemon</code> function, invoked twice</a></li>
<li><a href="c11.xhtml#listing11-14">Listing 11-14: Arguments passed to the <code>run_daemon</code> function</a></li>
<li><a href="c11.xhtml#listing11-15">Listing 11-15: Constructing the path for the launch item’s property list</a></li>
<li><a href="c11.xhtml#listing11-16">Listing 11-16: Observing the <code>AppleScript</code> launch of a launch item</a></li>
<li><a href="c11.xhtml#listing11-17">Listing 11-17: “Important” files</a></li>
<li><a href="c11.xhtml#listing11-18">Listing 11-18: Observing repersistence logic </a></li>
<li><a href="c11.xhtml#listing11-19">Listing 11-19: Spawning a background thread</a></li>
<li><a href="c11.xhtml#listing11-20">Listing 11-20: The <code>ei_loader_thread</code> function</a></li>
<li><a href="c11.xhtml#listing11-21">Listing 11-21: Core logic of the <code>is_executable</code> function</a></li>
<li><a href="c11.xhtml#listing11-22">Listing 11-22: Reading the start of a candidate file </a></li>
<li><a href="c11.xhtml#listing11-23">Listing 11-23: Calculating the candidate file’s size</a></li>
<li><a href="c11.xhtml#listing11-24">Listing 11-24: Checking for Mach-O constants</a></li>
<li><a href="c11.xhtml#listing11-25">Listing 11-25: Checking the file’s Mach-O type </a></li>
<li><a href="c11.xhtml#listing11-26">Listing 11-26: Arguments passed to the <code>append_ei</code> function</a></li>
<li><a href="c11.xhtml#listing11-27">Listing 11-27: Checking a candidate’s file accessibility </a></li>
<li><a href="c11.xhtml#listing11-28">Listing 11-28: The malware, reading itself into memory</a></li>
<li><a href="c11.xhtml#listing11-29">Listing 11-29: Reading the target binary into memory</a></li>
<li><a href="c11.xhtml#listing11-30">Listing 11-30: Checking if the target file is already infected</a></li>
<li><a href="c11.xhtml#listing11-31">Listing 11-31: Writing the malware and target file out to disk</a></li>
<li><a href="c11.xhtml#listing11-32">Listing 11-32: Writing the trailer out to disk</a></li>
<li><a href="c11.xhtml#listing11-33">Listing 11-33: Hexdump of an infected file</a></li>
<li><a href="c11.xhtml#listing11-34">Listing 11-34: Examining the trailer data </a></li>
<li><a href="c11.xhtml#listing11-35">Listing 11-35: The malware resaving, repersisting, and relaunching itself</a></li>
<li><a href="c11.xhtml#listing11-36">Listing 11-36: Arguments of the <code>persist_executable_frombundle</code> function</a></li>
<li><a href="c11.xhtml#listing11-37">Listing 11-37: Observing the recreation of both the malicious launch agent binary and plist</a></li>
<li><a href="c11.xhtml#listing11-38">Listing 11-38: Observing the relaunch of newly repersisted malware</a></li>
<li><a href="c11.xhtml#listing11-39">Listing 11-39: Executing a pristine instance of the infected binary to ensure nothing appears amiss </a></li>
<li><a href="c11.xhtml#listing11-40">Listing 11-40: Observing the execution of a pristine instance of the infected binary</a></li>
<li><a href="c11.xhtml#listing11-41">Listing 11-41: Argument initializations and a call to the <code>get_mediator</code> function</a></li>
<li><a href="c11.xhtml#listing11-42">Listing 11-42: Fallback logic for a backup command and control server</a></li>
<li><a href="c11.xhtml#listing11-43">Listing 11-43: The <code>ei_get_host_info</code> survey logic</a></li>
<li><a href="c11.xhtml#listing11-44">Listing 11-44: Dumping the survey</a></li>
<li><a href="c11.xhtml#listing11-45">Listing 11-45: Perhaps a cache of received commands?</a></li>
<li><a href="c11.xhtml#listing11-46">Listing 11-46: Invocation of the <code>react_exec</code> function </a></li>
<li><a href="c11.xhtml#listing11-47">Listing 11-47: The <code>ei_run_memory_hrd</code>’s in-memory coded execution logic</a></li>
<li><a href="c11.xhtml#listing11-48">Listing 11-48: A bug in the malware’s code</a></li>
<li><a href="c11.xhtml#listing11-49">Listing 11-49: The core logic of the <code>react_save</code> function</a></li>
<li><a href="c11.xhtml#listing11-50">Listing 11-50: The <code>react_start</code> function remains unimplemented </a></li>
<li><a href="c11.xhtml#listing11-51">Listing 11-51: Keylogger logic, found within the <code>eilf_rglk_watch_routine</code> function</a></li>
<li><a href="c11.xhtml#listing11-52">Listing 11-52: The callback argument for the <code>CGEventTapCreate</code> function</a></li>
<li><a href="c11.xhtml#listing11-53">Listing 11-53: The keylogger’s callback function, <code>process_event</code></a></li>
<li><a href="c11.xhtml#listing11-54">Listing 11-54: The core logic of the <code>react_ping</code> function</a></li>
<li><a href="c11.xhtml#listing11-55">Listing 11-55: The core logic of the <code>react_scmd</code> function</a></li>
<li><a href="c11.xhtml#listing11-56">Listing 11-56: Executing the <code>ei_forensic_thread</code> function via a background thread</a></li>
<li><a href="c11.xhtml#listing11-57">Listing 11-57: Invoking the <code>lfsc_dirlist</code> function</a></li>
<li><a href="c11.xhtml#listing11-58">Listing 11-58: The generated (recursive) directory listing</a></li>
<li><a href="c11.xhtml#listing11-59">Listing 11-59: Core logic of the <code>is_lfsc_target</code> function</a></li>
<li><a href="c11.xhtml#listing11-60">Listing 11-60: Encrypted list of files of “interest” </a></li>
<li><a href="c11.xhtml#listing11-61">Listing 11-61: Decrypted list of files of “interest” </a></li>
<li><a href="c11.xhtml#listing11-62">Listing 11-62: File exfiltration via the <code>ei_forensic_sendfile</code> function</a></li>
<li><a href="c11.xhtml#listing11-63">Listing 11-63: Observing file exfiltration logic via the debugger</a></li>
<li><a href="c11.xhtml#listing11-64">Listing 11-64: Following timer checks, the <code>ei_carver_main</code> function is invoked.</a></li>
<li><a href="c11.xhtml#listing11-65">Listing 11-65: Encrypting (ransoming) target files</a></li>
<li><a href="c11.xhtml#listing11-66">Listing 11-66: Obfuscated function names</a></li>
<li><a href="c11.xhtml#listing11-67">Listing 11-67: Newly added anti-debugging logic</a></li>
<li><a href="c11.xhtml#listing11-68">Listing 11-68: Additional “unwanted” programs, now including my very own ReiKey and KnockKnock</a></li>
<li><a href="c11.xhtml#listing11-69">Listing 11-69: Updated persistence paths</a></li>
</ol>
</nav>
<nav class="guideList" epub:type="landmarks" id="guide">
<h2>Guide</h2>
<ol>
<li><a epub:type="cover" href="cover.xhtml">Cover</a></li>
<li><a epub:type="frontmatter" href="f01.xhtml">Front Matter</a></li>
<li><a epub:type="dedication" href="f03.xhtml">Dedication</a></li>
<li><a epub:type="foreword" href="f05.xhtml">Foreword</a></li>
<li><a epub:type="introduction" href="f07.xhtml">Introduction</a></li>
<li><a epub:type="ibooks:reader-start-page" href="c01.xhtml">Start Reading</a></li>
<li><a epub:type="appendix" href="b01.xhtml">Index</a></li>
</ol>
</nav>
<nav class="pageList" epub:type="page-list" hidden="hidden" id="pages">
<h2>Pages</h2>
<ol>
<li><a href="f01.xhtml#Page_iii">iii</a></li>
<li><a href="f02.xhtml#Page_iv">iv</a></li>
<li><a href="f03.xhtml#Page_v">v</a></li>
<li><a href="f04.xhtml#Page_vii">vii</a></li>
<li><a href="f05.xhtml#Page_xvii">xvii</a></li>
<li><a href="f05.xhtml#Page_xviii">xviii</a></li>
<li><a href="f06.xhtml#Page_xix">xix</a></li>
<li><a href="f06.xhtml#Page_xx">xx</a></li>
<li><a href="f07.xhtml#Page_xxi">xxi</a></li>
<li><a href="f07.xhtml#Page_xxii">xxii</a></li>
<li><a href="f07.xhtml#Page_xxiii">xxiii</a></li>
<li><a href="f07.xhtml#Page_xxiv">xxiv</a></li>
<li><a href="f07.xhtml#Page_xxv">xxv</a></li>
<li><a href="f07.xhtml#Page_xxvi">xxvi</a></li>
<li><a href="f07.xhtml#Page_xxvii">xxvii</a></li>
<li><a href="f07.xhtml#Page_xxviii">xxviii</a></li>
<li><a href="f07.xhtml#Page_xxix">xxix</a></li>
<li><a href="p01.xhtml#Page_1">1</a></li>
<li><a href="c01.xhtml#Page_3">3</a></li>
<li><a href="c01.xhtml#Page_4">4</a></li>
<li><a href="c01.xhtml#Page_5">5</a></li>
<li><a href="c01.xhtml#Page_6">6</a></li>
<li><a href="c01.xhtml#Page_7">7</a></li>
<li><a href="c01.xhtml#Page_8">8</a></li>
<li><a href="c01.xhtml#Page_9">9</a></li>
<li><a href="c01.xhtml#Page_10">10</a></li>
<li><a href="c01.xhtml#Page_11">11</a></li>
<li><a href="c01.xhtml#Page_12">12</a></li>
<li><a href="c01.xhtml#Page_13">13</a></li>
<li><a href="c01.xhtml#Page_14">14</a></li>
<li><a href="c01.xhtml#Page_15">15</a></li>
<li><a href="c01.xhtml#Page_16">16</a></li>
<li><a href="c01.xhtml#Page_17">17</a></li>
<li><a href="c01.xhtml#Page_18">18</a></li>
<li><a href="c01.xhtml#Page_19">19</a></li>
<li><a href="c01.xhtml#Page_20">20</a></li>
<li><a href="c01.xhtml#Page_21">21</a></li>
<li><a href="c01.xhtml#Page_22">22</a></li>
<li><a href="c02.xhtml#Page_23">23</a></li>
<li><a href="c02.xhtml#Page_24">24</a></li>
<li><a href="c02.xhtml#Page_25">25</a></li>
<li><a href="c02.xhtml#Page_26">26</a></li>
<li><a href="c02.xhtml#Page_27">27</a></li>
<li><a href="c02.xhtml#Page_28">28</a></li>
<li><a href="c02.xhtml#Page_29">29</a></li>
<li><a href="c02.xhtml#Page_30">30</a></li>
<li><a href="c02.xhtml#Page_31">31</a></li>
<li><a href="c02.xhtml#Page_32">32</a></li>
<li><a href="c02.xhtml#Page_33">33</a></li>
<li><a href="c02.xhtml#Page_34">34</a></li>
<li><a href="c02.xhtml#Page_35">35</a></li>
<li><a href="c02.xhtml#Page_36">36</a></li>
<li><a href="c02.xhtml#Page_37">37</a></li>
<li><a href="c02.xhtml#Page_38">38</a></li>
<li><a href="c02.xhtml#Page_39">39</a></li>
<li><a href="c02.xhtml#Page_40">40</a></li>
<li><a href="c02.xhtml#Page_41">41</a></li>
<li><a href="c02.xhtml#Page_42">42</a></li>
<li><a href="c02.xhtml#Page_43">43</a></li>
<li><a href="c02.xhtml#Page_44">44</a></li>
<li><a href="c02.xhtml#Page_45">45</a></li>
<li><a href="c02.xhtml#Page_46">46</a></li>
<li><a href="c03.xhtml#Page_47">47</a></li>
<li><a href="c03.xhtml#Page_48">48</a></li>
<li><a href="c03.xhtml#Page_49">49</a></li>
<li><a href="c03.xhtml#Page_50">50</a></li>
<li><a href="c03.xhtml#Page_51">51</a></li>
<li><a href="c03.xhtml#Page_52">52</a></li>
<li><a href="c03.xhtml#Page_53">53</a></li>
<li><a href="c03.xhtml#Page_54">54</a></li>
<li><a href="c03.xhtml#Page_55">55</a></li>
<li><a href="c03.xhtml#Page_56">56</a></li>
<li><a href="c03.xhtml#Page_57">57</a></li>
<li><a href="c03.xhtml#Page_58">58</a></li>
<li><a href="c03.xhtml#Page_59">59</a></li>
<li><a href="c03.xhtml#Page_60">60</a></li>
<li><a href="c03.xhtml#Page_61">61</a></li>
<li><a href="c03.xhtml#Page_62">62</a></li>
<li><a href="c03.xhtml#Page_63">63</a></li>
<li><a href="c03.xhtml#Page_64">64</a></li>
<li><a href="c03.xhtml#Page_65">65</a></li>
<li><a href="c03.xhtml#Page_66">66</a></li>
<li><a href="p02.xhtml#Page_67">67</a></li>
<li><a href="c04.xhtml#Page_69">69</a></li>
<li><a href="c04.xhtml#Page_70">70</a></li>
<li><a href="c04.xhtml#Page_71">71</a></li>
<li><a href="c04.xhtml#Page_72">72</a></li>
<li><a href="c04.xhtml#Page_73">73</a></li>
<li><a href="c04.xhtml#Page_74">74</a></li>
<li><a href="c04.xhtml#Page_75">75</a></li>
<li><a href="c04.xhtml#Page_76">76</a></li>
<li><a href="c04.xhtml#Page_77">77</a></li>
<li><a href="c04.xhtml#Page_78">78</a></li>
<li><a href="c04.xhtml#Page_79">79</a></li>
<li><a href="c04.xhtml#Page_80">80</a></li>
<li><a href="c04.xhtml#Page_81">81</a></li>
<li><a href="c04.xhtml#Page_82">82</a></li>
<li><a href="c04.xhtml#Page_83">83</a></li>
<li><a href="c04.xhtml#Page_84">84</a></li>
<li><a href="c04.xhtml#Page_85">85</a></li>
<li><a href="c04.xhtml#Page_86">86</a></li>
<li><a href="c04.xhtml#Page_87">87</a></li>
<li><a href="c04.xhtml#Page_88">88</a></li>
<li><a href="c04.xhtml#Page_89">89</a></li>
<li><a href="c04.xhtml#Page_90">90</a></li>
<li><a href="c04.xhtml#Page_91">91</a></li>
<li><a href="c04.xhtml#Page_92">92</a></li>
<li><a href="c04.xhtml#Page_93">93</a></li>
<li><a href="c04.xhtml#Page_94">94</a></li>
<li><a href="c04.xhtml#Page_95">95</a></li>
<li><a href="c04.xhtml#Page_96">96</a></li>
<li><a href="c04.xhtml#Page_97">97</a></li>
<li><a href="c05.xhtml#Page_99">99</a></li>
<li><a href="c05.xhtml#Page_100">100</a></li>
<li><a href="c05.xhtml#Page_101">101</a></li>
<li><a href="c05.xhtml#Page_102">102</a></li>
<li><a href="c05.xhtml#Page_103">103</a></li>
<li><a href="c05.xhtml#Page_104">104</a></li>
<li><a href="c05.xhtml#Page_105">105</a></li>
<li><a href="c05.xhtml#Page_106">106</a></li>
<li><a href="c05.xhtml#Page_107">107</a></li>
<li><a href="c05.xhtml#Page_108">108</a></li>
<li><a href="c05.xhtml#Page_109">109</a></li>
<li><a href="c05.xhtml#Page_110">110</a></li>
<li><a href="c05.xhtml#Page_111">111</a></li>
<li><a href="c05.xhtml#Page_112">112</a></li>
<li><a href="c05.xhtml#Page_113">113</a></li>
<li><a href="c05.xhtml#Page_114">114</a></li>
<li><a href="c05.xhtml#Page_115">115</a></li>
<li><a href="c05.xhtml#Page_116">116</a></li>
<li><a href="c05.xhtml#Page_117">117</a></li>
<li><a href="c05.xhtml#Page_118">118</a></li>
<li><a href="c05.xhtml#Page_119">119</a></li>
<li><a href="c05.xhtml#Page_120">120</a></li>
<li><a href="c05.xhtml#Page_121">121</a></li>
<li><a href="c05.xhtml#Page_122">122</a></li>
<li><a href="c05.xhtml#Page_123">123</a></li>
<li><a href="c06.xhtml#Page_125">125</a></li>
<li><a href="c06.xhtml#Page_126">126</a></li>
<li><a href="c06.xhtml#Page_127">127</a></li>
<li><a href="c06.xhtml#Page_128">128</a></li>
<li><a href="c06.xhtml#Page_129">129</a></li>
<li><a href="c06.xhtml#Page_130">130</a></li>
<li><a href="c06.xhtml#Page_131">131</a></li>
<li><a href="c06.xhtml#Page_132">132</a></li>
<li><a href="c06.xhtml#Page_133">133</a></li>
<li><a href="c06.xhtml#Page_134">134</a></li>
<li><a href="c06.xhtml#Page_135">135</a></li>
<li><a href="c06.xhtml#Page_136">136</a></li>
<li><a href="c06.xhtml#Page_137">137</a></li>
<li><a href="c06.xhtml#Page_138">138</a></li>
<li><a href="c06.xhtml#Page_139">139</a></li>
<li><a href="c06.xhtml#Page_140">140</a></li>
<li><a href="c06.xhtml#Page_141">141</a></li>
<li><a href="c06.xhtml#Page_142">142</a></li>
<li><a href="c06.xhtml#Page_143">143</a></li>
<li><a href="c06.xhtml#Page_144">144</a></li>
<li><a href="c06.xhtml#Page_145">145</a></li>
<li><a href="c06.xhtml#Page_146">146</a></li>
<li><a href="c06.xhtml#Page_147">147</a></li>
<li><a href="c07.xhtml#Page_149">149</a></li>
<li><a href="c07.xhtml#Page_150">150</a></li>
<li><a href="c07.xhtml#Page_151">151</a></li>
<li><a href="c07.xhtml#Page_152">152</a></li>
<li><a href="c07.xhtml#Page_153">153</a></li>
<li><a href="c07.xhtml#Page_154">154</a></li>
<li><a href="c07.xhtml#Page_155">155</a></li>
<li><a href="c07.xhtml#Page_156">156</a></li>
<li><a href="c07.xhtml#Page_157">157</a></li>
<li><a href="c07.xhtml#Page_158">158</a></li>
<li><a href="c07.xhtml#Page_159">159</a></li>
<li><a href="c07.xhtml#Page_160">160</a></li>
<li><a href="c07.xhtml#Page_161">161</a></li>
<li><a href="c07.xhtml#Page_162">162</a></li>
<li><a href="c07.xhtml#Page_163">163</a></li>
<li><a href="c08.xhtml#Page_165">165</a></li>
<li><a href="c08.xhtml#Page_166">166</a></li>
<li><a href="c08.xhtml#Page_167">167</a></li>
<li><a href="c08.xhtml#Page_168">168</a></li>
<li><a href="c08.xhtml#Page_169">169</a></li>
<li><a href="c08.xhtml#Page_170">170</a></li>
<li><a href="c08.xhtml#Page_171">171</a></li>
<li><a href="c08.xhtml#Page_172">172</a></li>
<li><a href="c08.xhtml#Page_173">173</a></li>
<li><a href="c08.xhtml#Page_174">174</a></li>
<li><a href="c08.xhtml#Page_175">175</a></li>
<li><a href="c08.xhtml#Page_176">176</a></li>
<li><a href="c08.xhtml#Page_177">177</a></li>
<li><a href="c08.xhtml#Page_178">178</a></li>
<li><a href="c08.xhtml#Page_179">179</a></li>
<li><a href="c08.xhtml#Page_180">180</a></li>
<li><a href="c08.xhtml#Page_181">181</a></li>
<li><a href="c08.xhtml#Page_182">182</a></li>
<li><a href="c08.xhtml#Page_183">183</a></li>
<li><a href="c08.xhtml#Page_184">184</a></li>
<li><a href="c08.xhtml#Page_185">185</a></li>
<li><a href="c09.xhtml#Page_187">187</a></li>
<li><a href="c09.xhtml#Page_188">188</a></li>
<li><a href="c09.xhtml#Page_189">189</a></li>
<li><a href="c09.xhtml#Page_190">190</a></li>
<li><a href="c09.xhtml#Page_191">191</a></li>
<li><a href="c09.xhtml#Page_192">192</a></li>
<li><a href="c09.xhtml#Page_193">193</a></li>
<li><a href="c09.xhtml#Page_194">194</a></li>
<li><a href="c09.xhtml#Page_195">195</a></li>
<li><a href="c09.xhtml#Page_196">196</a></li>
<li><a href="c09.xhtml#Page_197">197</a></li>
<li><a href="c09.xhtml#Page_198">198</a></li>
<li><a href="c09.xhtml#Page_199">199</a></li>
<li><a href="c09.xhtml#Page_200">200</a></li>
<li><a href="c09.xhtml#Page_201">201</a></li>
<li><a href="c09.xhtml#Page_202">202</a></li>
<li><a href="c09.xhtml#Page_203">203</a></li>
<li><a href="c09.xhtml#Page_204">204</a></li>
<li><a href="c09.xhtml#Page_205">205</a></li>
<li><a href="c09.xhtml#Page_206">206</a></li>
<li><a href="c09.xhtml#Page_207">207</a></li>
<li><a href="c09.xhtml#Page_208">208</a></li>
<li><a href="c09.xhtml#Page_209">209</a></li>
<li><a href="c09.xhtml#Page_210">210</a></li>
<li><a href="c09.xhtml#Page_211">211</a></li>
<li><a href="c09.xhtml#Page_212">212</a></li>
<li><a href="c09.xhtml#Page_213">213</a></li>
<li><a href="c09.xhtml#Page_214">214</a></li>
<li><a href="c09.xhtml#Page_215">215</a></li>
<li><a href="c09.xhtml#Page_216">216</a></li>
<li><a href="c09.xhtml#Page_217">217</a></li>
<li><a href="c09.xhtml#Page_218">218</a></li>
<li><a href="p03.xhtml#Page_219">219</a></li>
<li><a href="c10.xhtml#Page_221">221</a></li>
<li><a href="c10.xhtml#Page_222">222</a></li>
<li><a href="c10.xhtml#Page_223">223</a></li>
<li><a href="c10.xhtml#Page_224">224</a></li>
<li><a href="c10.xhtml#Page_225">225</a></li>
<li><a href="c10.xhtml#Page_226">226</a></li>
<li><a href="c10.xhtml#Page_227">227</a></li>
<li><a href="c10.xhtml#Page_228">228</a></li>
<li><a href="c10.xhtml#Page_229">229</a></li>
<li><a href="c10.xhtml#Page_230">230</a></li>
<li><a href="c10.xhtml#Page_231">231</a></li>
<li><a href="c10.xhtml#Page_232">232</a></li>
<li><a href="c10.xhtml#Page_233">233</a></li>
<li><a href="c10.xhtml#Page_234">234</a></li>
<li><a href="c10.xhtml#Page_235">235</a></li>
<li><a href="c10.xhtml#Page_236">236</a></li>
<li><a href="c10.xhtml#Page_237">237</a></li>
<li><a href="c10.xhtml#Page_238">238</a></li>
<li><a href="c10.xhtml#Page_239">239</a></li>
<li><a href="c10.xhtml#Page_240">240</a></li>
<li><a href="c10.xhtml#Page_241">241</a></li>
<li><a href="c10.xhtml#Page_242">242</a></li>
<li><a href="c11.xhtml#Page_243">243</a></li>
<li><a href="c11.xhtml#Page_244">244</a></li>
<li><a href="c11.xhtml#Page_245">245</a></li>
<li><a href="c11.xhtml#Page_246">246</a></li>
<li><a href="c11.xhtml#Page_247">247</a></li>
<li><a href="c11.xhtml#Page_248">248</a></li>
<li><a href="c11.xhtml#Page_249">249</a></li>
<li><a href="c11.xhtml#Page_250">250</a></li>
<li><a href="c11.xhtml#Page_251">251</a></li>
<li><a href="c11.xhtml#Page_252">252</a></li>
<li><a href="c11.xhtml#Page_253">253</a></li>
<li><a href="c11.xhtml#Page_254">254</a></li>
<li><a href="c11.xhtml#Page_255">255</a></li>
<li><a href="c11.xhtml#Page_256">256</a></li>
<li><a href="c11.xhtml#Page_257">257</a></li>
<li><a href="c11.xhtml#Page_258">258</a></li>
<li><a href="c11.xhtml#Page_259">259</a></li>
<li><a href="c11.xhtml#Page_260">260</a></li>
<li><a href="c11.xhtml#Page_261">261</a></li>
<li><a href="c11.xhtml#Page_262">262</a></li>
<li><a href="c11.xhtml#Page_263">263</a></li>
<li><a href="c11.xhtml#Page_264">264</a></li>
<li><a href="c11.xhtml#Page_265">265</a></li>
<li><a href="c11.xhtml#Page_266">266</a></li>
<li><a href="c11.xhtml#Page_267">267</a></li>
<li><a href="c11.xhtml#Page_268">268</a></li>
<li><a href="c11.xhtml#Page_269">269</a></li>
<li><a href="c11.xhtml#Page_270">270</a></li>
<li><a href="c11.xhtml#Page_271">271</a></li>
<li><a href="c11.xhtml#Page_272">272</a></li>
<li><a href="c11.xhtml#Page_273">273</a></li>
<li><a href="c11.xhtml#Page_274">274</a></li>
<li><a href="c11.xhtml#Page_275">275</a></li>
<li><a href="c11.xhtml#Page_276">276</a></li>
<li><a href="c11.xhtml#Page_277">277</a></li>
<li><a href="c11.xhtml#Page_278">278</a></li>
<li><a href="c11.xhtml#Page_279">279</a></li>
<li><a href="c11.xhtml#Page_280">280</a></li>
<li><a href="c11.xhtml#Page_281">281</a></li>
<li><a href="c11.xhtml#Page_282">282</a></li>
<li><a href="b01.xhtml#Page_283">283</a></li>
<li><a href="b01.xhtml#Page_284">284</a></li>
<li><a href="b01.xhtml#Page_285">285</a></li>
<li><a href="b01.xhtml#Page_286">286</a></li>
<li><a href="b01.xhtml#Page_287">287</a></li>
<li><a href="b01.xhtml#Page_288">288</a></li>
<li><a href="b01.xhtml#Page_289">289</a></li>
<li><a href="b01.xhtml#Page_290">290</a></li>
<li><a href="b01.xhtml#Page_291">291</a></li>
<li><a href="b01.xhtml#Page_292">292</a></li>
<li><a href="b01.xhtml#Page_293">293</a></li>
<li><a href="b01.xhtml#Page_294">294</a></li>
</ol>
</nav>
</body>
</html>