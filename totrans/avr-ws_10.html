<html><head></head><body>
<div id="sbo-rt-content" class="calibre1">
 <div class="chapter" id="ch10">
  <div id="header1001" class="chapter">
   <h1 class="cn">
    <span class="page" id="p205">
    </span>
    <a class="xref" href="nsp-boxall502581-0008.xhtml#rch10">
     10
    </a>
   </h1>
   <h1 class="ctfm">
    Writing Your Own AVR Libraries
   </h1>
  </div>
  <div class="figure" id="ct10">
   <p class="fig">
    <img alt="" src="images/nsp-boxall502581-ct.jpg" class="calibre9"/>
   </p>
  </div>
  <p class="pf">
   <span>
   </span>
   Cast your mind back to
   <a class="url" href="nsp-boxall502581-0013.xhtml#pro15">
    Project 15
   </a>
   in
   <a class="url" href="nsp-boxall502581-0013.xhtml#ch03">
    Chapter 3
   </a>
   , which required us to convert the voltage measured by the TMP36 temperature sensor to degrees Celsius. To complete those calculations, we called the math library and used the functions within it to perform operations on floating-point numbers. Using this library meant we didn’t have to create our own mathematical functions or include their code in the project, saving time and effort.
  </p>
  <p class="calibre8">
   In this chapter, you’ll learn to create your own libraries, allowing you to reuse tested functions in multiple projects to increase your efficiency. You’ll build a simple library for a repetitive task, a library that accepts values to perform a function, and a library that processes data from a sensor and returns values in an easy-to-use form. These examples will equip you with the skills required to make your own custom libraries.
  </p>
  <div class="chapter">
   <h2 class="ah" id="ah1201">
    <span class="page" id="p206">
    </span>
    <a class="xref" href="nsp-boxall502581-0008.xhtml#rah1201">
     Creating Your First Library
    </a>
   </h2>
   <p class="paft">
    In this section you’ll create your first library, which you’ll then use in
    <a class="url" href="nsp-boxall502581-0020.xhtml#pro41">
     Project 41
    </a>
    . First, consider the functions defined in
    <a class="url" href="nsp-boxall502581-0020.xhtml#list1001">
     Listing 10-1
    </a>
    ,
    <code class="calibre23">
     blinkSlow()
    </code>
    and
    <code class="calibre23">
     blinkFast()
    </code>
    . These two functions blink an LED (connected via a resistor between PORTB0 and GND) at a slow or fast rate, respectively.
   </p>
   <div class="figure" id="list1001">
    <div class="codeline">
     <p class="clf">
      #include &lt;avr/io.h&gt;
     </p>
     <p class="cl">
      #include &lt;util/delay.h&gt;
     </p>
     <p class="clf">
      void blinkSlow()
     </p>
     <p class="cl">
      {
     </p>
     <p class="cl">
      uint8_t i;
     </p>
     <p class="cl">
      for (i = 0; i &lt; 5; i++)
     </p>
     <p class="cl">
      {
     </p>
     <p class="cl">
      PORTB |= (1 &lt;&lt; PORTB0);
     </p>
     <p class="cl">
      _delay_ms(1000);
     </p>
     <p class="cl">
      PORTB &amp;= ~(1 &lt;&lt; PORTB0);
     </p>
     <p class="cl">
      _delay_ms(1000);
     </p>
     <p class="cl">
      }
     </p>
     <p class="cl">
      }
     </p>
     <p class="clf">
      void blinkFast()
     </p>
     <p class="cl">
      {
     </p>
     <p class="cl">
      uint8_t i;
     </p>
     <p class="cl">
      for (i = 0; i &lt; 5; i++)
     </p>
     <p class="cl">
      {
     </p>
     <p class="cl">
      PORTB |= (1 &lt;&lt; PORTB0);
     </p>
     <p class="cl">
      _delay_ms(250);
     </p>
     <p class="cl">
      PORTB &amp;= ~(1 &lt;&lt; PORTB0);
     </p>
     <p class="cl">
      _delay_ms(250);
     </p>
     <p class="cl">
      }
     </p>
     <p class="cl">
      }
     </p>
     <p class="clf">
      int main(void)
     </p>
     <p class="cl">
      {
     </p>
     <p class="cl">
      DDRB |= (1 &lt;&lt; PORTB0); // Set PORTB0 as outputs
     </p>
     <p class="cl">
      while (1)
     </p>
     <p class="cl">
      {
     </p>
     <p class="cl">
      blinkSlow();
     </p>
     <p class="cl">
      _delay_ms(1000);
     </p>
     <p class="cl">
      blinkFast();
     </p>
     <p class="cl">
      _delay_ms(1000);
     </p>
     <p class="cl">
      }
     </p>
     <p class="cll">
      }
     </p>
    </div>
    <p class="figh">
     <span class="calibre4">
      Listing 10-1:
     </span>
     Example code that demonstrates two functions that blink LEDs slow and fast
    </p>
   </div>
   <p class="calibre8">
    The custom functions to blink the LED slowly or rapidly are convenient, but it’s not very efficient to enter them into your project code every time you want to use them. However, if you offload the code that describes the functions into a library, you can simply call the library with one line in future projects, then use the functions as needed without rewriting them. Let’s create such a library now.
   </p>
   <div class="chapter">
    <h3 class="bh" id="bh1201">
     <span class="page" id="p207">
     </span>
     <a class="xref" href="nsp-boxall502581-0008.xhtml#rbh1201">
      Anatomy of a Library
     </a>
    </h3>
    <p class="paft">
     A library consists of two files:
     <i class="calibre5">
      library.h
     </i>
     , the header file, and
     <i class="calibre5">
      library.c
     </i>
     , the source file, where “library” is a placeholder for an individual library’s name. We’ll call our first example library the
     <i class="calibre5">
      blinko
     </i>
     library, so our two files will be
     <i class="calibre5">
      blinko.h
     </i>
     and
     <i class="calibre5">
      blinko.c
     </i>
     .
    </p>
    <p class="calibre8">
     A header file contains the definitions of the functions, variables, or other components the library contains. The following is our header file:
    </p>
    <div class="codeline">
     <p class="clf">
      // blinko.h
     </p>
     <p class="clf">
      void blinkSlow();
     </p>
     <p class="cl">
      // Blinks PORTB0 slowly, five times
     </p>
     <p class="clf">
      void blinkFast();
     </p>
     <p class="cll">
      // Blinks PORTB0 rapidly, five times
     </p>
    </div>
    <p class="calibre8">
     The file declares the names of the two functions inside the library,
     <code class="calibre23">
      void blinkSlow()
     </code>
     and
     <code class="calibre23">
      void blinkFast()
     </code>
     . Each of these lines is followed by a comment describing the function’s purpose. Get into the habit of including comments like these about the custom functions in your library.
    </p>
    <p class="calibre8">
     Our source file contains the code that will be made available to the main code in
     <a class="url" href="nsp-boxall502581-0020.xhtml#pro41">
      Project 41
     </a>
     when we include this library:
    </p>
    <div class="codeline">
     <p class="clf">
      // blinko.c
     </p>
     <p class="cl2f">
      <!--<ccust1>1</ccust1>-->
      ❶ #include &lt;avr/io.h&gt;
     </p>
     <p class="cl">
      #include &lt;util/delay.h&gt;
     </p>
     <p class="cl2f">
      <!--<ccust1>2</ccust1>-->
      ❷ void blinkSlow()
     </p>
     <p class="cl">
      {
     </p>
     <p class="cl">
      uint8_t i;
     </p>
     <p class="cl">
      for (i = 0; i &lt; 5; i++)
     </p>
     <p class="cl">
      {
     </p>
     <p class="cl">
      PORTB |= (1 &lt;&lt; PORTB0);
     </p>
     <p class="cl">
      _delay_ms(1000);
     </p>
     <p class="cl">
      PORTB &amp;= ~(1 &lt;&lt; PORTB0);
     </p>
     <p class="cl">
      _delay_ms(1000);
     </p>
     <p class="cl">
      }
     </p>
     <p class="cl">
      }
     </p>
     <p class="cl2f">
      <!--<ccust1>3</ccust1>-->
      ❸ void blinkFast()
     </p>
     <p class="cl">
      {
     </p>
     <p class="cl">
      uint8_t i;
     </p>
     <p class="cl">
      for (i = 0; i &lt; 5; i++)
     </p>
     <p class="cl">
      {
     </p>
     <p class="cl">
      PORTB |= (1 &lt;&lt; PORTB0);
     </p>
     <p class="cl">
      _delay_ms(250);
     </p>
     <p class="cl">
      PORTB &amp;= ~(1 &lt;&lt; PORTB0);
     </p>
     <p class="cl">
      _delay_ms(250);
     </p>
     <p class="cl">
      }
     </p>
     <p class="cll">
      }
     </p>
    </div>
    <p class="calibre8">
     <span id="p208">
     </span>
     The
     <i class="calibre5">
      blinko.c
     </i>
     file is identical to the first section of
     <a class="url" href="nsp-boxall502581-0020.xhtml#list1001">
      Listing 10-1
     </a>
     . We first include the other libraries required by the code in our own library
     <!--<ccust1>1</ccust1>-->
     ❶—this allows us to use the functions for I/O and
     <code class="calibre23">
      _delay_ms()
     </code>
     . We then add the
     <code class="calibre23">
      blinkSlow()
     </code>
     <!--<ccust1>2</ccust1>-->
     ❷ and
     <code class="calibre23">
      blinkFast()
     </code>
     <!--<ccust1>3</ccust1>-->
     ❸ custom functions we want to include in the library.
    </p>
   </div>
   <div class="chapter">
    <h3 class="bh" id="bh1202">
     <a class="xref" href="nsp-boxall502581-0008.xhtml#rbh1202">
      Installing the Library
     </a>
    </h3>
    <p class="paft">
     To make the library available to the main code for
     <a class="url" href="nsp-boxall502581-0020.xhtml#pro41">
      Project 41
     </a>
     , we have to do two things. First, we copy the header and source files into the same project directory as the
     <i class="calibre5">
      main.c
     </i>
     file and Makefile, as shown in the directory listing screen capture in
     <a class="url" href="nsp-boxall502581-0020.xhtml#f10001">
      Figure 10-1
     </a>
     . You can find these in the
     <i class="calibre5">
      Project 41
     </i>
     subfolder of this book’s
     <i class="calibre5">
      Chapter 10
     </i>
     folder.
    </p>
    <div class="figure" id="f10001">
     <p class="fig">
      <img alt="Contents of the Project 41 subfolder (Makefile, blinko.c, blinko.h, main.c)" height="326" src="images/nsp-boxall502581-f10001.jpg" width="1200" class="calibre11"/>
     </p>
     <div class="chapter">
      <p class="figh">
       <span class="calibre4">
        Figure 10-1:
       </span>
       Place the library files in the same directory as the project files.
      </p>
     </div>
    </div>
    <p class="calibre8">
     Second, we edit the project’s Makefile so that the toolchain knows to look for the library when compiling the code to upload to the microcontroller. To do so, we add
     <code class="calibre23">
      blinko.c
     </code>
     after
     <code class="calibre23">
      main.o
     </code>
     in the Makefile’s
     <code class="calibre23">
      OBJECTS
     </code>
     line, as shown in
     <a class="url" href="nsp-boxall502581-0020.xhtml#f10002">
      Figure 10-2
     </a>
     .
    </p>
    <div class="figure" id="f10002">
     <p class="fig">
      <img alt="Line 22 of the Makefile for Project 41: OBJECTS = main.o blinko.c" height="245" src="images/nsp-boxall502581-f10002.jpg" width="1200" class="calibre11"/>
     </p>
     <div class="chapter">
      <p class="figh">
       <span class="calibre4">
        Figure 10-2:
       </span>
       Adding the
       <i class="calibre12">
        blinko.c
       </i>
       library to the Makefile for
       <a class="url" href="nsp-boxall502581-0020.xhtml#pro41">
        Project 41
       </a>
      </p>
     </div>
    </div>
    <p class="calibre8">
     Now that we’ve installed the library, let’s put it to the test by using it to program a simple circuit.
    </p>
    <p class="hd" id="pro41">
     <a class="xref" href="nsp-boxall502581-0008.xhtml#rpro41">
      <span class="ccust1">
       Project 41: Your First Library
      </span>
     </a>
    </p>
    <p class="paft">
     You will need the following hardware for this project:
    </p>
    <ul class="calibre10">
     <li class="blf">
      • USBasp programmer
     </li>
     <li class="bl">
      • Solderless breadboard
     </li>
     <li class="bl">
      • ATmega328P-PU microcontroller
     </li>
     <li class="bl">
      • One LED
     </li>
     <li class="bll">
      • One 560
      <span lang="el" xml:lang="el">
       Ω
      </span>
      resistor
     </li>
    </ul>
    <p class="calibre8">
     <span id="p209">
     </span>
     Assemble the circuit shown in
     <a class="url" href="nsp-boxall502581-0020.xhtml#f10003">
      Figure 10-3
     </a>
     on your breadboard.
    </p>
    <div class="figure" id="f10003">
     <p class="fig">
      <img alt="Schematic diagram for Project 41" height="1200" src="images/nsp-boxall502581-f10003.jpg" width="890" class="calibre11"/>
     </p>
     <div class="chapter">
      <p class="figh">
       <span class="calibre4">
        Figure 10-3:
       </span>
       Schematic for
       <a class="url" href="nsp-boxall502581-0020.xhtml#pro41">
        Project 41
       </a>
      </p>
     </div>
    </div>
    <p class="calibre8">
     Keep this circuit together, as you’ll use it again in the
     <a class="url" href="nsp-boxall502581-0020.xhtml#pro42">
      following project
     </a>
     .
    </p>
    <p class="calibre8">
     Next, open a terminal window, navigate to the
     <i class="calibre5">
      Project 41
     </i>
     subfolder of this book’s
     <i class="calibre5">
      Chapter 10
     </i>
     folder, and enter the command
     <code class="b">
      make flash
     </code>
     . The LED should blink rapidly five times, then blink slowly five times, then repeat.
    </p>
    <p class="calibre8">
     The code for this project is quite simple:
    </p>
    <div class="codeline">
     <p class="clf">
      // Project 41 - Your First Library
     </p>
     <p class="clf">
      #include &lt;avr/io.h&gt;
     </p>
     <p class="cl">
      #include &lt;util/delay.h&gt;
     </p>
     <p class="cl2">
      <!--<ccust1>1</ccust1>-->
      ❶ #include "blinko.h"   // Use our new library
     </p>
     <p class="clf">
      int main(void)
     </p>
     <p class="cl">
      {
     </p>
     <p class="cl">
      DDRB = 0b11111111; // Set PORTB as outputs
     </p>
     <p class="cl">
      for(;;)
     </p>
     <p class="cl">
      <span id="p210">
      </span>
      {
     </p>
     <p class="cl">
      <!--<ccust1>2</ccust1>-->
      ❷ blinkSlow();
     </p>
     <p class="cl">
      _delay_ms(1000);
     </p>
     <p class="cl">
      blinkFast();
     </p>
     <p class="cl">
      _delay_ms(1000);
     </p>
     <p class="cl">
      }
     </p>
     <p class="cl">
      return 0;
     </p>
     <p class="cll">
      }
     </p>
    </div>
    <p class="calibre8">
     First, we include our new library
     <!--<ccust1>1</ccust1>-->
     ❶. (Note that the custom library name is surrounded by quotes, not left and right angle brackets.) We then take advantage of our library functions to blink the LED
     <!--<ccust1>2</ccust1>-->
     ❷.
    </p>
    <p class="calibre8">
     Although this project is a somewhat minimal demonstration, it illustrates the basic process for creating and using your own AVR libraries. Next, we’ll look at some more complex examples.
    </p>
   </div>
  </div>
  <div class="chapter">
   <h2 class="ah" id="ah1202">
    <a class="xref" href="nsp-boxall502581-0008.xhtml#rah1202">
     Creating a Library That Accepts Values to Perform a Function
    </a>
   </h2>
   <p class="paft">
    Now that you know how to create a basic library, you’re ready for the next level: creating a library that can accept values and act on them. Again, we’ll begin with an example function and convert that into a library.
   </p>
   <p class="calibre8">
    Consider the code in
    <a class="url" href="nsp-boxall502581-0020.xhtml#list1002">
     Listing 10-2
    </a>
    , which uses the
    <code class="calibre23">
     blinkType()
    </code>
    function to set the number of times to blink the LED connected to PORTB0, as well as the on/off period.
   </p>
   <div class="figure" id="list1002">
    <div class="codeline">
     <p class="clf">
      #include &lt;avr/io.h&gt;
     </p>
     <p class="cl">
      #define __DELAY_BACKWARD_COMPATIBLE__ // Required for macOS users
     </p>
     <p class="cl">
      #include &lt;util/delay.h&gt;
     </p>
     <p class="clf">
      void blinkType(int blinks, int duration)
     </p>
     <p class="cl">
      // blinks - number of times to blink the LED
     </p>
     <p class="cl">
      // duration - blink duration in milliseconds
     </p>
     <p class="cl">
      {
     </p>
     <p class="cl">
      uint8_t i;
     </p>
     <p class="cl">
      for (i = 0; i &lt; blinks; i++)
     </p>
     <p class="cl">
      {
     </p>
     <p class="cl">
      PORTB |= (1 &lt;&lt; PORTB0);
     </p>
     <p class="cl">
      _delay_ms(duration);
     </p>
     <p class="cl">
      PORTB &amp;= ~(1 &lt;&lt; PORTB0);
     </p>
     <p class="cl">
      _delay_ms(duration);
     </p>
     <p class="cl">
      }
     </p>
     <p class="cl">
      }
     </p>
     <p class="clf">
      int main(void)
     </p>
     <p class="cl">
      {
     </p>
     <p class="cl">
      DDRB |= (1 &lt;&lt; PORTB0);             // Set PORTB0 as outputs
     </p>
     <p class="cl">
      while (1)
     </p>
     <p class="cl">
      {
     </p>
     <p class="cl">
      // Blink LED 10 times, with 150 ms duration
     </p>
     <p class="cl">
      blinkType(10, 150);
     </p>
     <p class="cl">
      _delay_ms(1000);
     </p>
     <p class="clf">
      <span id="p211">
      </span>
      // Blink LED 5 times, with 1 s duration
     </p>
     <p class="cl">
      blinkType(5, 1000);
     </p>
     <p class="cl">
      _delay_ms(1000);
     </p>
     <p class="cl">
      }
     </p>
     <p class="cll">
      }
     </p>
    </div>
    <p class="figh">
     <span class="calibre4">
      Listing 10-2:
     </span>
     An example sketch that demonstrates our LED blinking function, which will be converted into a library
    </p>
   </div>
   <p class="calibre8">
    As you can see,
    <code class="calibre23">
     blinkType()
    </code>
    accepts two values and then acts on them. The
    <code class="calibre23">
     blinks
    </code>
    value is the number of times you’d like to turn the onboard LED on and off, and the
    <code class="calibre23">
     duration
    </code>
    value is the delay in milliseconds for each blink. Let’s turn this into a library named
    <i class="calibre5">
     blinko2
    </i>
    .
   </p>
   <p class="calibre8">
    First we need to create the
    <i class="calibre5">
     blinko2.h
    </i>
    header file, which contains the definitions of the functions and variables used inside the library:
   </p>
   <div class="codeline">
    <p class="clf">
     // blinko2.h
    </p>
    <p class="clf">
     void blinkType(int blinks, int duration);
    </p>
    <p class="cl">
     // blinks - number of times to blink the LED
    </p>
    <p class="cll">
     // duration - blink duration in milliseconds
    </p>
   </div>
   <p class="calibre8">
    As before, we declare the name of the function inside the library, followed by a comment describing its purpose. In this case, we provide comments describing the function’s parameters.
   </p>
   <p class="calibre8">
    Next, we build our
    <i class="calibre5">
     blinko2.c
    </i>
    source file:
   </p>
   <div class="codeline">
    <p class="clf">
     // blinko2.c
    </p>
    <p class="cl2f">
     <!--<ccust1>1</ccust1>-->
     ❶ #include &lt;avr/io.h&gt;
    </p>
    <p class="cl2">
     <!--<ccust1>2</ccust1>-->
     ❷ #define __DELAY_BACKWARD_COMPATIBLE__
    </p>
    <p class="cl">
     #include &lt;util/delay.h&gt;
    </p>
    <p class="cl2f">
     <!--<ccust1>3</ccust1>-->
     ❸ void blinkType(int blinks, int duration)
    </p>
    <p class="cl">
     // blinks - number of times to blink the LED
    </p>
    <p class="cl">
     // duration - blink duration in milliseconds
    </p>
    <p class="cl">
     {
    </p>
    <p class="cl">
     uint8_t i;
    </p>
    <p class="cl">
     for (i = 0; i &lt; blinks; i++)
    </p>
    <p class="cl">
     {
    </p>
    <p class="cl">
     PORTB |= (1 &lt;&lt; PORTB0);
    </p>
    <p class="cl">
     _delay_ms(duration);
    </p>
    <p class="cl">
     PORTB &amp;= ~(1 &lt;&lt; PORTB0);
    </p>
    <p class="cl">
     _delay_ms(duration);
    </p>
    <p class="cl">
     }
    </p>
    <p class="cll">
     }
    </p>
   </div>
   <p class="calibre8">
    The source file includes the necessary libraries for operating our library
    <!--<ccust1>1</ccust1>-->
    ❶, then our library’s function
    <!--<ccust1>3</ccust1>-->
    ❸, as usual. The line at
    <!--<ccust1>2</ccust1>-->
    ❷ is required for those of you using Apple computers, as the version of the compiler is slightly different.
   </p>
   <p class="calibre8">
    The next step is to edit the Makefile of the project in which we’ll use this library, which you can find in the
    <i class="calibre5">
     Project 42
    </i>
    subfolder of the book’s
    <i class="calibre5">
     Chapter 10
    </i>
    folder. Add the library name
    <code class="calibre23">
     blinko2.c
    </code>
    after
    <code class="calibre23">
     main.o
    </code>
    in the
    <code class="calibre23">
     OBJECTS
    </code>
    line, as shown in
    <a class="url" href="nsp-boxall502581-0020.xhtml#f10004">
     Figure 10-4
    </a>
    .
   </p>
   <div class="figure" id="f10004">
    <p class="fig">
     <span id="p212">
     </span>
     <img alt="Line 22 of the Makefile for Project 42: OBJECTS = main.o blinko2.c" height="155" src="images/nsp-boxall502581-f10004.jpg" width="1200" class="calibre11"/>
    </p>
    <div class="chapter">
     <p class="figh">
      <span class="calibre4">
       Figure 10-4:
      </span>
      Adding the
      <i class="calibre12">
       blinko2.c
      </i>
      library to the Makefile for
      <a class="url" href="nsp-boxall502581-0020.xhtml#pro42">
       Project 42
      </a>
     </p>
    </div>
   </div>
   <p class="calibre8">
    Now that you have the library set up, let’s test it out.
   </p>
   <p class="hd" id="pro42">
    <a class="xref" href="nsp-boxall502581-0008.xhtml#rpro42">
     <span class="ccust1">
      Project 42: Using the blinko2.c Library
     </span>
    </a>
   </p>
   <p class="paft">
    You can use the hardware you assembled for
    <a class="url" href="nsp-boxall502581-0020.xhtml#pro41">
     Project 41
    </a>
    for this project as well. Open a terminal window, navigate to the
    <i class="calibre5">
     Project 42
    </i>
    subfolder of this book’s
    <i class="calibre5">
     Chapter 10
    </i>
    folder, and enter the command
    <code class="b">
     make flash
    </code>
    . The LED should blink rapidly 10 times, then blink slowly 5 times, then repeat.
   </p>
   <p class="calibre8">
    Let’s see how this works:
   </p>
   <div class="codeline">
    <p class="clf">
     // Project 42 - Using the blinko2.c Library
    </p>
    <p class="clf">
     #include &lt;avr/io.h&gt;
    </p>
    <p class="cl">
     #include &lt;util/delay.h&gt;
    </p>
    <p class="cl2">
     <!--<ccust1>1</ccust1>-->
     ❶ #include "blinko2.h"  // Use our new library
    </p>
    <p class="clf">
     int main(void)
    </p>
    <p class="cl">
     {
    </p>
    <p class="cl">
     DDRB = 0b11111111; // Set PORTB as outputs
    </p>
    <p class="cl">
     for(;;)
    </p>
    <p class="cl">
     {
    </p>
    <p class="cl">
     // Blink LED 10 times, with 150 ms duration
    </p>
    <p class="cl">
     <!--<ccust1>2</ccust1>-->
     ❷ blinkType(10, 150);
    </p>
    <p class="cl">
     _delay_ms(1000);
    </p>
    <p class="clf">
     // Blink LED 5 times, with 1 s duration
    </p>
    <p class="cl">
     <!--<ccust1>3</ccust1>-->
     ❸ blinkType(5, 1000);
    </p>
    <p class="cl">
     _delay_ms(1000);
    </p>
    <p class="cl">
     }
    </p>
    <p class="cl">
     return 0;
    </p>
    <p class="cll">
     }
    </p>
   </div>
   <p class="calibre8">
    As before, we include our new library
    <!--<ccust1>1</ccust1>-->
    ❶, then use that library’s function to blink the LED rapidly with the short duration
    <!--<ccust1>2</ccust1>-->
    ❷, then slowly with a longer duration
    <!--<ccust1>3</ccust1>-->
    ❸. Again, this is intended as a simple demonstration that gives you the framework for creating your own AVR libraries with functions that can accept values. If you’d like a challenge, you can try creating your own PWM library based on the example code from
    <a class="url" href="nsp-boxall502581-0017.xhtml#ch07">
     Chapter 7
    </a>
    .
   </p>
  </div>
  <div class="chapter">
   <h2 class="ah" id="ah1203">
    <a class="xref" href="nsp-boxall502581-0008.xhtml#rah1203">
     Creating a Library That Processes Data and Returns Values
    </a>
   </h2>
   <p class="paft">
    For this chapter’s
    <a class="url" href="nsp-boxall502581-0020.xhtml#pro43">
     final project
    </a>
    , you’ll learn how to create a library that can return values back to the main code. We’ll create a “thermometer” library
    <span id="p213">
    </span>
    that not only returns values from an Analog Devices TMP36 temperature sensor but also has a function to simplify displaying numbers on a seven-segment LED display.
   </p>
   <p class="calibre8">
    Our library source code, which you’ll find in the
    <i class="calibre5">
     Project 43
    </i>
    subfolder of this book’s
    <i class="calibre5">
     Chapter 10
    </i>
    folder, contains two functions: one to return the value in degrees Celsius from the temperature sensor as a float variable, and another that accepts an integer between 0 and 99 to display on the single-digit LED display from
    <a class="url" href="nsp-boxall502581-0013.xhtml#pro15">
     Project 15
    </a>
    . Let’s take a look at the
    <i class="calibre5">
     temperature.h
    </i>
    header file defining the functions and variables used inside the library:
   </p>
   <div class="codeline">
    <p class="clf">
     // thermometer.h
    </p>
    <p class="clf">
     void displayNumber(uint8_t value);
    </p>
    <p class="cl">
     // Displays a number between 0 and 99 on the seven-segment LED display
    </p>
    <p class="clf">
     float readTMP36();
    </p>
    <p class="cll">
     // Returns temperature from TMP36 sensor using ATmega328P-PU pin PC5
    </p>
   </div>
   <p class="calibre8">
    As usual, we declare the names of the functions inside the library and provide comments describing their use. Note that the type of the
    <code class="calibre23">
     readTMP36()
    </code>
    function is
    <code class="calibre23">
     float
    </code>
    , not
    <code class="calibre23">
     void
    </code>
    , as this function will return a floating-point value for the temperature to our project’s main code.
   </p>
   <p class="calibre8">
    Next, let’s examine our
    <i class="calibre5">
     thermometer.c
    </i>
    source file:
   </p>
   <div class="codeline">
    <p class="clf">
     // thermometer.c
    </p>
    <p class="cl2f">
     <!--<ccust1>1</ccust1>-->
     ❶ #include &lt;avr/io.h&gt;
    </p>
    <p class="cl">
     #include &lt;math.h&gt;
    </p>
    <p class="cl">
     #include &lt;util/delay.h&gt;
    </p>
    <p class="cl2f">
     <!--<ccust1>2</ccust1>-->
     ❷ float readTMP36()
    </p>
    <p class="cl">
     // Returns temperature from TMP36 sensor using ATmega328P-PU pin PC5
    </p>
    <p class="cl">
     {
    </p>
    <p class="cl">
     float temperatureC;
    </p>
    <p class="cl">
     float voltage;
    </p>
    <p class="cl">
     uint16_t ADCvalue;
    </p>
    <p class="clf">
     ADCSRA |= (1 &lt;&lt; ADSC);                 // Start ADC measurement
    </p>
    <p class="cl">
     while (ADCSRA &amp; (1 &lt;&lt; ADSC) );         // Wait for conversion to finish
    </p>
    <p class="cl">
     _delay_ms(10);
    </p>
    <p class="clf">
     // Get value from ADC (which is 10-bit) register, store in ADCvalue
    </p>
    <p class="cl">
     ADCvalue = ADC;
    </p>
    <p class="clf">
     // Convert reading to temperature value (Celsius)
    </p>
    <p class="cl">
     voltage = (ADCvalue * 5);
    </p>
    <p class="cl">
     voltage = voltage / 1024;
    </p>
    <p class="cl">
     temperatureC = ((voltage - 0.5) * 100);
    </p>
    <p class="cl">
     <!--<ccust1>3</ccust1>-->
     ❸ return temperatureC;
    </p>
    <p class="cl">
     }
    </p>
    <p class="cl2f">
     <!--<ccust1>4</ccust1>-->
     ❹ void displayNumber(uint8_t value)
    </p>
    <p class="cl">
     <span id="p214">
     </span>
     // Displays a number between 0 and 99 on the seven-segment LED display
    </p>
    <p class="cl">
     {
    </p>
    <p class="cl">
     uint8_t tens=0;
    </p>
    <p class="cl">
     uint8_t ones=0;
    </p>
    <p class="cl">
     uint8_t delayTime=250;
    </p>
    <p class="cl">
     tens = value / 10;
    </p>
    <p class="cl">
     ones = value % 10;
    </p>
    <p class="cl">
     switch(tens)
    </p>
    <p class="cl">
     {
    </p>
    <p class="cl">
     case 0 : PORTB = 0b00111111; break; // 0
    </p>
    <p class="cl">
     case 1 : PORTB = 0b00000110; break; // 1
    </p>
    <p class="cl">
     case 2 : PORTB = 0b01011011; break; // 2
    </p>
    <p class="cl">
     case 3 : PORTB = 0b01001111; break; // 3
    </p>
    <p class="cl">
     case 4 : PORTB = 0b01100110; break; // 4
    </p>
    <p class="cl">
     case 5 : PORTB = 0b01101101; break; // 5
    </p>
    <p class="cl">
     case 6 : PORTB = 0b01111101; break; // 6
    </p>
    <p class="cl">
     case 7 : PORTB = 0b00000111; break; // 7
    </p>
    <p class="cl">
     case 8 : PORTB = 0b01111111; break; // 8
    </p>
    <p class="cl">
     case 9 : PORTB = 0b01101111; break; // 9
    </p>
    <p class="cl">
     }
    </p>
    <p class="cl">
     _delay_ms(delayTime);
    </p>
    <p class="cl">
     switch(ones)
    </p>
    <p class="cl">
     {
    </p>
    <p class="cl">
     case 0 : PORTB = 0b00111111; break; // 0
    </p>
    <p class="cl">
     case 1 : PORTB = 0b00000110; break; // 1
    </p>
    <p class="cl">
     case 2 : PORTB = 0b01011011; break; // 2
    </p>
    <p class="cl">
     case 3 : PORTB = 0b01001111; break; // 3
    </p>
    <p class="cl">
     case 4 : PORTB = 0b01100110; break; // 4
    </p>
    <p class="cl">
     case 5 : PORTB = 0b01101101; break; // 5
    </p>
    <p class="cl">
     case 6 : PORTB = 0b01111101; break; // 6
    </p>
    <p class="cl">
     case 7 : PORTB = 0b00000111; break; // 7
    </p>
    <p class="cl">
     case 8 : PORTB = 0b01111111; break; // 8
    </p>
    <p class="cl">
     case 9 : PORTB = 0b01101111; break; // 9
    </p>
    <p class="cl">
     }
    </p>
    <p class="cl">
     _delay_ms(delayTime);
    </p>
    <p class="cl">
     PORTB = 0; // Turn off display
    </p>
    <p class="cll">
     }
    </p>
   </div>
   <p class="calibre8">
    All the code in the library should be familiar to you by now. First, we include the required libraries for use in our library
    <!--<ccust1>1</ccust1>-->
    ❶. The
    <code class="calibre23">
     readTMP36()
    </code>
    function
    <!--<ccust1>2</ccust1>-->
    ❷ sends the temperature back in degrees Celsius, using the
    <code class="calibre23">
     return
    </code>
    function
    <!--<ccust1>3</ccust1>-->
    ❸ in the same way as the custom function explained in
    <a class="url" href="nsp-boxall502581-0013.xhtml#pro11">
     Project 11
    </a>
    in
    <a class="url" href="nsp-boxall502581-0013.xhtml#ch03">
     Chapter 3
    </a>
    . The
    <code class="calibre23">
     displayNumber(uint8_t value)
    </code>
    function displays an integer between 0 and 99 on the single-digit LED display
    <!--<ccust1>4</ccust1>-->
    ❹.
   </p>
   <p class="calibre8">
    As before, to make this library available for use in
    <a class="url" href="nsp-boxall502581-0020.xhtml#pro43">
     Project 43
    </a>
    , we add it to line 22 in the Makefile, as shown in
    <a class="url" href="nsp-boxall502581-0020.xhtml#f10005">
     Figure 10-5
    </a>
    .
   </p>
   <div class="figure" id="f10005">
    <p class="fig">
     <img alt="Line 22 of the Makefile for Project 43: OBJECTS = main.o thermometer.c" height="120" src="images/nsp-boxall502581-f10005.jpg" width="1200" class="calibre11"/>
    </p>
    <div class="chapter">
     <p class="figh">
      <span class="calibre4">
       Figure 10-5:
      </span>
      Adding the
      <i class="calibre12">
       thermometer.c
      </i>
      library to the Makefile for
      <a class="url" href="nsp-boxall502581-0020.xhtml#pro43">
       Project 43
      </a>
     </p>
    </div>
   </div>
   <p class="calibre8">
    You’re now ready to build your digital thermometer using this library.
   </p>
   <p class="hd" id="pro43">
    <span class="page" id="p215">
    </span>
    <a class="xref" href="nsp-boxall502581-0008.xhtml#rpro43">
     <span class="ccust1">
      Project 43: Creating a Digital Thermometer with the thermometer.c Library
     </span>
    </a>
   </p>
   <p class="paft">
    In this project, you’ll read an analog temperature sensor (the TMP36) with your microcontroller, which will use the seven-segment LED from
    <a class="url" href="nsp-boxall502581-0013.xhtml#pro15">
     Project 15
    </a>
    to display the temperature one digit at a time.
   </p>
   <p class="calibre8">
    You’ll need the following hardware:
   </p>
   <ul class="calibre10">
    <li class="blf">
     • USBasp programmer
    </li>
    <li class="bl">
     • Solderless breadboard
    </li>
    <li class="bl">
     • 5 V breadboard power supply
    </li>
    <li class="bl">
     • ATmega328P-PU microcontroller
    </li>
    <li class="bl">
     • One TMP36 temperature sensor
    </li>
    <li class="bl">
     • One common-cathode seven-segment LED display
    </li>
    <li class="bl">
     • Seven 560
     <span lang="el" xml:lang="el">
      Ω
     </span>
     resistors (R1–R7)
    </li>
    <li class="bl">
     • 0.1
     <span lang="el" xml:lang="el">
      μF
     </span>
     ceramic capacitor
    </li>
    <li class="bll">
     • Jumper wires
    </li>
   </ul>
   <p class="calibre8">
    Assemble your circuit as shown in
    <a class="url" href="nsp-boxall502581-0020.xhtml#f10006">
     Figure 10-6
    </a>
    .
   </p>
   <div class="figure" id="f10006">
    <p class="fig">
     <img alt="Schematic diagram for Project 43" height="1087" src="images/nsp-boxall502581-f10006.jpg" width="1200" class="calibre11"/>
    </p>
    <div class="chapter">
     <p class="figh">
      <span class="calibre4">
       Figure 10-6:
      </span>
      Schematic for
      <a class="url" href="nsp-boxall502581-0020.xhtml#pro43">
       Project 43
      </a>
     </p>
    </div>
   </div>
   <p class="calibre8">
    <span id="p216">
    </span>
    Note that the power supply to the project must be as close to 5 V as possible, since the TMP36 is an analog sensor whose output is a function of the supply voltage and the temperature.
   </p>
   <p class="calibre8">
    Now open a terminal window, navigate to the
    <i class="calibre5">
     Project 43
    </i>
    subfolder in the
    <i class="calibre5">
     Chapter 10
    </i>
    folder, and upload the code for
    <a class="url" href="nsp-boxall502581-0020.xhtml#pro43">
     Project 43
    </a>
    as usual. Once you’ve completed this, you should be presented with the temperature in degrees Celsius on the LED display—first the left-hand digit, then the right.
   </p>
   <p class="calibre8">
    Let’s see how this works:
   </p>
   <div class="codeline">
    <p class="clf">
     // Project 43 - Creating a Digital Thermometer with the thermometer.c Library
    </p>
    <p class="cl2f">
     <!--<ccust1>1</ccust1>-->
     ❶ #include &lt;avr/io.h&gt;
    </p>
    <p class="cl">
     #include &lt;util/delay.h&gt;
    </p>
    <p class="cl">
     #include "thermometer.h"                  // Use our new library
    </p>
    <p class="cl2f">
     <!--<ccust1>2</ccust1>-->
     ❷ void startADC()
    </p>
    <p class="cl">
     // Set up the ADC
    </p>
    <p class="cl">
     {
    </p>
    <p class="cl">
     ADMUX |= (1 &lt;&lt; REFS0);                 // Use AVcc pin with ADC
    </p>
    <p class="cl">
     ADMUX |= (1 &lt;&lt; MUX2) | (1 &lt;&lt; MUX0);    // Use ADC5 (pin 28)
    </p>
    <p class="cl">
     ADCSRA |= (1 &lt;&lt; ADPS1) | (1 &lt;&lt; ADPS0); // Prescaler for 1MHz (/8)
    </p>
    <p class="cl">
     ADCSRA |= (1 &lt;&lt; ADEN);                 // Enable ADC
    </p>
    <p class="cl">
     }
    </p>
    <p class="clf">
     int main(void)
    </p>
    <p class="cl">
     {
    </p>
    <p class="cl">
     <!--<ccust1>3</ccust1>-->
     ❸ float temperature;
    </p>
    <p class="cl">
     uint8_t finalTemp;
    </p>
    <p class="clf">
     <!--<ccust1>4</ccust1>-->
     ❹ startADC();
    </p>
    <p class="clf">
     <!--<ccust1>5</ccust1>-->
     ❺ DDRB = 0b11111111;                     // Set PORTB as outputs
    </p>
    <p class="cl">
     for(;;)
    </p>
    <p class="cl">
     {
    </p>
    <p class="cl">
     <!--<ccust1>6</ccust1>-->
     ❻ temperature = readTMP36();          // Get temperature from sensor
    </p>
    <p class="cl">
     finalTemp = (int)temperature;
    </p>
    <p class="clf">
     <!--<ccust1>7</ccust1>-->
     ❼ displayNumber(finalTemp);
    </p>
    <p class="cl">
     _delay_ms(1000);
    </p>
    <p class="cl">
     }
    </p>
    <p class="cl">
     return 0;
    </p>
    <p class="cll">
     }
    </p>
   </div>
   <p class="calibre8">
    Now that we have placed the measurement and calculation code in the thermometer library, you can see how simple the main code can be. We first include the required libraries
    <!--<ccust1>1</ccust1>-->
    ❶ and define the function to start the ADC
    <!--<ccust1>2</ccust1>-->
    ❷. In the main section of the code we declare two variables
    <!--<ccust1>3</ccust1>-->
    ❸, to store the value from the temperature library and to pass to the
    <code class="calibre23">
     displayNumber()
    </code>
    function. We start the ADC for the TMP36 temperature sensor
    <!--<ccust1>4</ccust1>-->
    ❹, then set the pins on PORTB to outputs for the LED display
    <!--<ccust1>5</ccust1>-->
    ❺.
   </p>
   <p class="calibre8">
    Finally, we retrieve the temperature from the sensor via the
    <code class="calibre23">
     readTMP36()
    </code>
    function from our thermometer library
    <!--<ccust1>6</ccust1>-->
    ❻, convert it to an integer, and show it on the LED display
    <!--<ccust1>7</ccust1>-->
    ❼.
   </p>
   <p class="calibre8">
    <span id="p217">
    </span>
    For another challenge, see if you can modify
    <code class="calibre23">
     readTMP36()
    </code>
    so that it can return temperatures in either Celsius or Fahrenheit, or make your own ADC initialization or PWM library, or simplify the numerical display code in
    <code class="calibre23">
     displayNumber(uint8_t value)
    </code>
    . Whichever you choose, I hope you see how easy it is to rework your own custom functions into a convenient library. This is a key tool in your box of programming tricks.
   </p>
   <p class="calibre8">
    In the
    <a class="url" href="nsp-boxall502581-0021.xhtml#ch11">
     next chapter
    </a>
    , you’ll learn how to use many more interesting and useful parts via the SPI data bus, including LED display drivers, shift registers, and analog-to-digital converters.
   </p>
  </div>
 </div>
</div></body></html>