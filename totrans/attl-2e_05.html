<html><head></head><body>
<h2 class="h2" id="ch05"><span epub:type="pagebreak" id="page_113"/><span class="big">5</span><br/>MORE FUN WITH AUTOCONF: CONFIGURING USER OPTIONS</h2>&#13;
<p class="quote"><em>Hope is not the conviction that something will turn out well, but the certainty that something makes sense, regardless of how it turns out.<br/>—Václav Havel</em>, Disturbing the Peace</p>&#13;
<div class="image1"><img src="../images/common.jpg" alt="Image"/></div>&#13;
<p class="noindent">In <a href="ch04.xhtml">Chapter 4</a>, we discussed the essentials of Autoconf—how to bootstrap a new or existing project and how to understand some of the basic aspects of <em>configure.ac</em> files. In this chapter, we cover some of the more complex Autoconf macros. We’ll begin by discussing how to substitute our own variables into template files (for example, <em>Makefile.in</em>) and how to define our own preprocessor definitions from within the configuration script. Throughout this chapter, we’ll continue to develop functionality in the Jupiter project by adding important checks and tests. We’ll cover the all-important <code>AC_OUTPUT</code> macro, and we’ll conclude by discussing the application of user-defined project configuration options as specified in the <em>configure.ac</em> file.</p>&#13;
<p class="indent">In addition to all this, I’ll present an analysis technique you can use to decipher the inner workings of macros. Using the somewhat complex <code>AC_CHECK</code><code>_PROG</code> macro as an example, I’ll show you some ways to find out what’s going on under the hood.</p>&#13;
<h3 class="h3" id="ch05sec1"><span epub:type="pagebreak" id="page_114"/>Substitutions and Definitions</h3>&#13;
<p class="noindent">We’ll begin this chapter by discussing three of the most important macros in the Autoconf suite: <code>AC_SUBST</code> and <code>AC_DEFINE</code>, along with the latter’s twin brother, <code>AC_DEFINE_UNQUOTED</code>.</p>&#13;
<p class="indent">These macros provide the primary mechanisms for communication between the configuration process and the build and execution processes. Values that are <em>substituted</em> into generated files provide configuration information to the build process, while values defined in preprocessor variables provide configuration information at build time to the compiler and at runtime to the built programs and libraries. As a result, it’s well worth becoming thoroughly familiar with <code>AC_SUBST</code> and <code>AC_DEFINE</code>.</p>&#13;
<h4 class="h4" id="ch05sec1-1"><em>AC_SUBST</em></h4>&#13;
<p class="noindent">You can use <code>AC_SUBST</code> to extend the variable substitution functionality that’s such an integral part of Autoconf. Every Autoconf macro that has anything to do with substitution variables ultimately calls this macro to create the substitution variables from existing shell variables. Sometimes the shell variables are inherited from the environment; other times, higher-level macros set the shell variables as part of their functionality before calling <code>AC_SUBST</code>. The signature of this macro is rather trivial (note that the square brackets in this prototype represent optional arguments, not Autoconf quotes):</p>&#13;
<pre>AC_SUBST(<span class="codeitalic1">shell_var</span>[, <span class="codeitalic1">value</span>])</pre>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>If you choose to omit any trailing optional parameters when invoking M4 macros, you may also omit the trailing commas.<sup><a id="ch05fn_1" href="footnote.xhtml#ch05fn1">1</a></sup> However, if you omit any arguments from the middle of the list, you must provide the commas as placeholders for the missing arguments.</em></p>&#13;
</div>&#13;
<p class="indent">The first argument, <em><code>shell_var</code></em>, represents a shell variable whose value you wish to substitute into all files generated by <code>config.status</code> from templates. The optional second parameter is the value assigned to the variable. If it isn’t specified, the shell variable’s current value will be used, whether it’s inherited or set by some previous shell code.</p>&#13;
<p class="indent">The substitution variable will have the same name as the shell variable, except that it will be bracketed with at signs (<code>@</code>) in the template files. Thus, a shell variable named <code>my_var</code> would become the substitution variable reference <code>@my_var@</code>, and you could use it in any template file.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_115"/>Calls to <code>AC_SUBST</code> in <em>configure.ac</em> should not be made conditionally; that is, they should not be called within conditional shell statements like <code>if</code>-<code>then</code>-<code>else</code> constructs. The reason becomes clear when you carefully consider the purpose of <code>AC_SUBST</code>: you’ve already hardcoded substitution variable references into your template files, so you’d better use <code>AC_SUBST</code> for each variable unconditionally, or else your output files will retain the variable references rather than the values that should have been substituted.</p>&#13;
<h4 class="h4" id="ch05sec1-2"><em>AC_DEFINE</em></h4>&#13;
<p class="noindent">The <code>AC_DEFINE</code> and <code>AC_DEFINE_UNQUOTED</code> macros define C-preprocessor macros, which can be simple or function-like macros. These are either defined in the <em>config.h.in</em> template (if you use <code>AC_CONFIG_HEADERS</code>) or passed on the compiler command line (via the <code>@DEFS@</code> substitution variable) in <em>Makefile.in</em> templates. Recall that if you don’t write <em>config.h.in</em> yourself, <code>autoheader</code> will write it based on calls to these macros in your <em>configure.ac</em> file.</p>&#13;
<p class="indent">These two macro names actually represent four different Autoconf macros. Here are their prototypes:</p>&#13;
<pre>AC_DEFINE(<span class="codeitalic1">variable</span>, <span class="codeitalic1">value</span>[, <span class="codeitalic1">description</span>])&#13;
AC_DEFINE(<span class="codeitalic1">variable</span>)&#13;
AC_DEFINE_UNQUOTED(<span class="codeitalic1">variable</span>, <span class="codeitalic1">value</span>[, <span class="codeitalic1">description</span>])&#13;
AC_DEFINE_UNQUOTED(<span class="codeitalic1">variable</span>)</pre>&#13;
<p class="indent">The difference between the normal and the <code>UNQUOTED</code> versions of these macros is that the normal versions use, verbatim, the specified value as the value of the preprocessor macro. The <code>UNQUOTED</code> versions perform shell expansion on the <em><code>value</code></em> argument, and they use the result as the value of the preprocessor macro. Thus, you should use <code>AC_DEFINE_UNQUOTED</code> if the value contains shell variables that you want <code>configure</code> to expand. (Setting a C-preprocessor macro in a header file to an unexpanded shell variable makes no sense, because neither the C compiler nor the preprocessor will know what to do with it when the source code is compiled.)</p>&#13;
<p class="indent">The difference between the single- and multi-argument versions lies in the way the preprocessor macros are defined. The single-argument versions simply guarantee that the macro is <em>defined</em> in the preprocessor namespace, while the multi-argument versions ensure that the macro is defined with a specific value.</p>&#13;
<p class="indent">The optional third parameter, <em><code>description</code></em>, tells <code>autoheader</code> to add a comment for this macro to the <em>config.h.in</em> template. (If you don’t use <code>autoheader</code>, it makes no sense to pass a description here—hence, its optional status.) If you wish to define a preprocessor macro without a value and provide a <em><code>description</code></em>, you should use the multi-argument versions of these macros but leave the <code>value</code> argument empty. Another option is to use <code>AH_TEMPLATE</code>—an <code>autoheader</code>-specific macro—which does the same thing as <code>AC_DEFINE</code> when a <em><code>description</code></em> is given but no <em><code>value</code></em> is required.</p>&#13;
<h3 class="h3" id="ch05sec2"><span epub:type="pagebreak" id="page_116"/>Checking for Compilers</h3>&#13;
<p class="noindent">The <code>AC_PROG_CC</code> macro ensures that the user’s system has a working C-language compiler. Here’s the prototype for this macro:</p>&#13;
<pre>AC_PROG_CC([<span class="codeitalic1">compiler-search-list</span>])</pre>&#13;
<p class="indent">If your code requires a particular flavor or brand of C compiler, you can pass a whitespace-separated list of program names in this argument. For example, if you use <code>AC_PROG_CC([cc cl gcc]</code>), the macro expands into shell code that searches for <code>cc</code>, <code>cl</code>, and <code>gcc</code>, in that order. Usually, the optional argument is omitted, allowing the macro to find the best compiler option available on the user’s system.</p>&#13;
<p class="indent">You’ll recall from “An Even Quicker Start with <code>autoscan</code>” on <a href="ch04.xhtml#page_95">page 95</a> that when <code>autoscan</code> noticed C source files in the directory tree, it inserted a no-argument call to this macro into Jupiter’s <em>configure.scan</em> file. <a href="ch05.xhtml#ch05ex1">Listing 5-1</a> reproduces the relevant portion of the generated <em>configure.scan</em> file.</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash"># Checks for programs.</span>&#13;
AC_PROG_CC&#13;
<span class="ash">AC_PROG_INSTALL</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch05ex1"><em>Listing 5-1:</em> configure.scan: <em>Checking for compilers and other programs</em></p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>If the source files in Jupiter’s directory tree had been suffixed with</em> .cc, .cxx, <em>or</em> .C <em>(all common extensions for C++ source files), <em><code>autoscan</code></em> would have instead inserted a call to <em><code>AC_PROG_CXX</code></em>.</em></p>&#13;
</div>&#13;
<p class="indent">The <code>AC_PROG_CC</code> macro looks for <code>gcc</code> and then <code>cc</code> in the system search path. If it doesn’t find either, it looks for other C compilers. When it finds a compatible compiler, the macro sets a well-known variable, <code>CC</code>, to the full path of the program, with options for portability as needed, unless the user has already set <code>CC</code> in the environment or on the <code>configure</code> command line.</p>&#13;
<p class="indent">The <code>AC_PROG_CC</code> macro also defines the following Autoconf substitution variables, some of which you may recognize as <em>user variables</em> (listed in <a href="ch03.xhtml#ch03tab2">Table 3-2</a> on <a href="ch03.xhtml#page_71">page 71</a>):</p>&#13;
<ul>&#13;
<li class="noindent"><code>@CC@</code> (full path of compiler)</li>&#13;
<li class="noindent"><code>@CFLAGS@</code> (for example, <code>-g -O2</code> for <code>gcc</code>)</li>&#13;
<li class="noindent"><code>@CPPFLAGS@</code> (empty by default)</li>&#13;
<li class="noindent"><code>@EXEEXT@</code> (for example, <em>.exe</em>)</li>&#13;
<li class="noindent"><code>@OBJEXT@</code> (for example, <em>o</em>)<sup><a id="ch05fn_2" href="footnote.xhtml#ch05fn2">2</a></sup></li>&#13;
</ul>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_117"/><code>AC_PROG_CC</code> configures these substitution variables, but unless you use them in your <em>Makefile.in</em> templates, you’re just wasting time running <code>./configure</code>. Conveniently, we’re already using them in our <em>Makefile.in</em> templates, because earlier in the Jupiter project, we added them to our compiler command line and then added a default value for <code>CFLAGS</code> that the user could override on the <code>make</code> command line.</p>&#13;
<p class="indent">The only thing left to do is ensure that <code>config.status</code> substitutes values for these variable references. <a href="ch05.xhtml#ch05ex2">Listing 5-2</a> shows the relevant portions of the <em>src</em> directory <em>Makefile.in</em> template and the changes necessary to make this happen.</p>&#13;
<p class="margin">Git tag 5.0</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash"># VPATH-specific substitution variables</span>&#13;
<span class="ash">srcdir = @srcdir@</span>&#13;
<span class="ash">VPATH = @srcdir@</span>&#13;
&#13;
# Tool-specific substitution variables&#13;
CC = @CC@&#13;
<span class="ash">CFLAGS =</span> @CFLAGS@&#13;
CPPFLAGS = @CPPFLAGS@&#13;
&#13;
<span class="ash">all: jupiter</span>&#13;
&#13;
<span class="ash">jupiter: main.c</span>&#13;
        <span class="ash">$(CC) $(CPPFLAGS) $(CFLAGS) -I. -I$(srcdir) -I.. -o $@ $(srcdir)/main.c</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
&#13;
<p class="caption" id="ch05ex2"><em>Listing 5-2:</em> src/Makefile.in: <em>Using Autoconf compiler and flag substitution variables</em></p>&#13;
<h3 class="h3" id="ch05sec3">Checking for Other Programs</h3>&#13;
<p class="noindent">Immediately following the call to <code>AC_PROG_CC</code> (refer to <a href="ch05.xhtml#ch05ex1">Listing 5-1</a>) is a call to <code>AC_PROG_INSTALL</code>. All of the <code>AC_PROG_*</code> macros set (and then substitute, using <code>AC_SUBST</code>) various environment variables that point to the located utilities. <code>AC_PROG_INSTALL</code> does the same thing for the <code>install</code> utility. To use this check, you need to use the associated Autoconf substitution variables in your <em>Makefile.in</em> templates, just as we did earlier with <code>@CC@</code>, <code>@CFLAGS@</code>, and <code>@CPPFLAGS@</code>. <a href="ch05.xhtml#ch05ex3">Listing 5-3</a> illustrates these changes.</p>&#13;
<p class="margin">Git tag 5.1</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash"># Tool-specific substitution variables</span>&#13;
<span class="ash">CC = @CC@</span>&#13;
<span class="ash">CFLAGS = @CFLAGS@</span>&#13;
<span class="ash">CPPFLAGS = @CPPFLAGS@</span>&#13;
INSTALL = @INSTALL@&#13;
INSTALL_DATA = @INSTALL_DATA@&#13;
INSTALL_PROGRAM = @INSTALL_PROGRAM@&#13;
INSTALL_SCRIPT = @INSTALL_SCRIPT@&#13;
<span class="codeitalic1a"><span class="ash">--snip--</span></span>&#13;
<span class="ash">install:</span>&#13;
        $(INSTALL) <span class="ash">-d $(DESTDIR)$(bindir)</span>&#13;
<span epub:type="pagebreak" id="page_118"/>        $(INSTALL_PROGRAM) <span class="ash">-m 0755 jupiter $(DESTDIR)$(bindir)</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch05ex3"><em>Listing 5-3:</em> src/Makefile.in: <em>Substituting the <code>install</code> utility in your Makefile.in templates</em></p>&#13;
<p class="indent">The value of <code>@INSTALL@</code> is obviously the path of the located installation program. The value of <code>@INSTALL_DATA@</code> is <code>${INSTALL} -m 0644</code>. Based on this, you might think that the values of <code>@INSTALL_PROGRAM@</code> and <code>@INSTALL_SCRIPT@</code> would be something like <code>${INSTALL} -m 0755</code>, but they’re not. These values are set simply to <code>${INSTALL}</code>.<sup><a id="ch05fn_3" href="footnote.xhtml#ch05fn3">3</a></sup></p>&#13;
<p class="indent">You might also need to test for other important utility programs, including <code>lex</code>, <code>yacc</code>, <code>sed</code>, and <code>awk</code>. If your program requires one or more of these tools, you can add invocations of <code>AC_PROG_LEX</code>, <code>AC_PROG_YACC</code>, <code>AC_PROG_SED</code>, or <code>AC_PROG_AWK</code>. If it detects files in your project’s directory tree with <em>.yy</em> or <em>.ll</em> extensions, <code>autoscan</code> will add invocations of <code>AC_PROG_YACC</code> and <code>AC_PROG_LEX</code> to <em>configure.scan</em>.</p>&#13;
<p class="indent">You can check for about a dozen different programs using these more specialized macros. If a program check fails, the resulting <code>configure</code> script will fail with a message indicating that the required utility could not be found and that the build cannot continue until it has been properly installed.</p>&#13;
<p class="indent">The program and compiler checks cause <code>autoconf</code> to substitute specially named variables into template files. You can find the names of the variables for each macro in the <em>GNU Autoconf Manual</em>. You should use these <code>make</code> variables in commands within your <em>Makefile.in</em> templates to invoke the tools they represent. The Autoconf macros will set the values of these variables according to the tools they find installed on the user’s system, <em>if the user has not already set them in the environment</em>.</p>&#13;
<p class="indent">This is a key aspect of Autoconf-generated <code>configure</code> scripts—the user can <em>always</em> override anything <code>configure</code> will do to the environment by exporting or setting an appropriate variable before executing <code>configure</code>.<sup><a id="ch05fn_4" href="footnote.xhtml#ch05fn4">4</a></sup></p>&#13;
<p class="indent">For example, if the user chooses to build with a specific version of <code>bison</code> installed in the home directory, they could enter the following command in order to ensure that <code>$(YACC)</code> refers to the correct version of <code>bison</code> and that the shell code <code>AC_PROG_YACC</code> generates does little more than substitute the existing value of <code>YACC</code> for <code>@YACC@</code> in your <em>Makefile.in</em> templates:</p>&#13;
<pre>$ <span class="codestrong1">cd jupiter</span>&#13;
$ <span class="codestrong1">./configure YACC="$HOME/bin/bison -y"</span>&#13;
<span class="codeitalic1">--snip--</span></pre>&#13;
&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><span epub:type="pagebreak" id="page_119"/><em>Passing the variable setting to <em><code>configure</code></em> as a parameter is functionally similar to setting the variable for the <em><code>configure</code></em> process on the command line in the shell environment (for example, <em><code>YACC="$HOME/bin/bison -y" ./configure</code></em>). The advantage of using the syntax given in this example is that <em><code>config.status --recheck</code></em> can then track the value and properly re-execute <em><code>configure</code></em> from the makefile with the options that were originally given to it. Thus, you should always use the parameter syntax, rather than the shell environment syntax, to set variables for <em><code>configure</code></em>. For ways to enforce the use of this syntax, see the documentation for <em><code>AC_ARG_VAR</code></em> in the Autoconf manual.</em></p>&#13;
</div>&#13;
<p class="indent">To check for the existence of a program not covered by these more specialized macros, you can use the generic <code>AC_CHECK_PROG</code> macro or write your own special-purpose macro (see <a href="ch16.xhtml">Chapter 16</a>).</p>&#13;
<p class="indent">The key points to take away here are as follows:</p>&#13;
<ul>&#13;
<li class="noindent"><code>AC_PROG_*</code> macros check for the existence of programs.</li>&#13;
<li class="noindent">If they find a program, a substitution variable is created.</li>&#13;
<li class="noindent">You should use these substitution variables in your <em>Makefile.in</em> templates to execute associated utilities.</li>&#13;
</ul>&#13;
<h3 class="h3" id="ch05sec4">A Common Problem with Autoconf</h3>&#13;
<p class="noindent">We should take this opportunity to address a particular problem developers new to the Autotools consistently encounter. Here’s the formal definition of <code>AC_CHECK_PROG</code>, as you will find it in the <em>GNU Autoconf Manual</em>:</p>&#13;
<div class="indentin">&#13;
<pre>AC_CHECK_PROG(<span class="codeitalic1">variable</span>, <span class="codeitalic1">prog-to-check-for</span>, <span class="codeitalic1">value-if-found</span>,&#13;
    [<span class="codeitalic1">value-if-not-found</span>], [<span class="codeitalic1">path</span>], [<span class="codeitalic1">reject</span>])</pre>&#13;
</div>&#13;
<p class="bqpara">Check whether program <code>prog-to-check-for</code> exists in <em><code>path</code></em>. If it is found, set <em><code>variable</code></em> to <em><code>value-if-found</code></em>, otherwise to <em><code>value-if-not-found</code></em>, if given. Always pass over <em><code>reject</code></em> (an absolute filename) even if it is the first found in the search path; in that case, set <em><code>variable</code></em> using the absolute filename of the <em><code>prog-to-check-for</code></em> found that is not <em><code>reject</code></em>. If <em><code>variable</code></em> was already set, do nothing. Calls <em><code>AC_SUBST</code></em> for <em><code>variable</code></em>. The result of this test can be overridden by setting the <em><code>variable</code></em> variable or the cache variable <em><code>ac_cv_prog_variable</code></em>.<sup><a id="ch05fn_5" href="footnote.xhtml#ch05fn5">5</a></sup></p>&#13;
<p class="indent">This is pretty dense language, but after a careful reading, you can extract the following from this description:</p>&#13;
<ul>&#13;
<li class="noindent">If <em><code>prog-to-check-for</code></em> is found in the system search path, then <em><code>variable</code></em> is set to <em><code>value-if-found</code></em>; otherwise, it’s set to <em><code>value-if-not-found</code></em>.</li>&#13;
<li class="noindent">If <em><code>reject</code></em> is specified (as a full path), and it’s the same as the program found in the system search path in the previous step, then skip it and continue to the next matching program in the system search path.</li>&#13;
<li class="noindent"><span epub:type="pagebreak" id="page_120"/>If <em><code>reject</code></em> is found first in <em><code>path</code></em> and then another match (other than <em><code>reject</code></em>) is found, set <em><code>variable</code></em> to the absolute path name of the second (non-<em><code>reject</code></em>) match.</li>&#13;
<li class="noindent">If the user has already set <em><code>variable</code></em> in the environment, then <em><code>variable</code></em> is left untouched (thereby allowing the user to override the check by setting <em><code>variable</code></em> before running <code>configure</code>).</li>&#13;
<li class="noindent"><code>AC_SUBST</code> is called on <em><code>variable</code></em> to make it an Autoconf substitution variable.</li>&#13;
</ul>&#13;
<p class="indent">Upon first reading this description, there appears to be a conflict: we see in the first item that <em><code>variable</code></em> will be set to one of two specified values, based on whether or not <em><code>prog-to-check-for</code></em> is found in the system search path. But then we see in the third item that <em><code>variable</code></em> will be set to the full path of some program if <em><code>reject</code></em> is found first and skipped.</p>&#13;
<p class="indent">Discovering the real functionality of <code>AC_CHECK_PROG</code> is as easy as reading a little shell script. While you could refer to the definition of <code>AC_CHECK_PROG</code> in Autoconf’s <em>programs.m4</em> macro file, you’ll be one level removed from the actual shell code that performs the check. Wouldn’t it be better to just look at the shell script that <code>AC_CHECK_PROG</code> generates? We’ll use Jupiter’s <em>configure.ac</em> file to play with this concept. Temporarily modify your <em>configure.ac</em> file according to the changes highlighted in <a href="ch05.xhtml#ch05ex4">Listing 5-4</a>.</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">AC_PREREQ(2.69)</span>&#13;
<span class="ash">AC_INIT([Jupiter], [1.0], [jupiter-bugs@example.org])</span>&#13;
<span class="ash">AC_CONFIG_SRCDIR([src/main.c])</span>&#13;
<span class="ash">AC_CONFIG_HEADER([config.h])</span>&#13;
&#13;
<span class="ash"># Checks for programs.</span>&#13;
<span class="ash">AC_PROG_CC</span>&#13;
_DEBUG_START_&#13;
AC_CHECK_PROG([bash_var], [bash], [yes], [no],, [/usr/sbin/bash])&#13;
_DEBUG_END_&#13;
<span class="ash">AC_PROG_INSTALL</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch05ex4"><em>Listing 5-4: A first attempt at using <code>AC_CHECK_PROG</code></em></p>&#13;
<p class="indent">Now execute <code>autoconf</code>, open the resulting <code>configure</code> script, and search for <code>_DEBUG_START_</code>.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>The <em><code>_DEBUG_START_</code></em> and <em><code>_DEBUG_END_</code></em> strings are known as picket fences. I added these to</em> configure.ac <em>for the sole purpose of helping me find the beginning and end of the shell code generated by the <em><code>AC_CHECK_PROG</code></em> macro. I chose these names in particular because you’re not likely to find them anywhere else in the generated <em><code>configure</code></em> script.<sup><a id="ch05fn_6" href="footnote.xhtml#ch05fn6">6</a></sup></em></p>&#13;
</div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_121"/><a href="ch05.xhtml#ch05ex5">Listing 5-5</a> shows the portion of <code>configure</code> this macro generates.</p>&#13;
<pre>   <span class="codeitalic1">--snip--</span>&#13;
   <span class="codestrong1">_DEBUG_START_</span>&#13;
<span class="ent">➊</span> # Extract the first word of "bash" so it can be a program name with args.&#13;
   set dummy bash; ac_word=$2&#13;
   { $as_echo "$as_me:${as_lineno-$LINENO}: checking for $ac_word" &gt;&amp;5&#13;
   $as_echo_n "checking for $ac_word... " &gt;&amp;6; }&#13;
   if ${ac_cv_prog_bash_var+:} false; then :&#13;
     $as_echo_n "(cached) " &gt;&amp;6&#13;
   else&#13;
     if test -n "$bash_var"; then&#13;
     ac_cv_prog_bash_var="$bash_var" # Let the user override the test.&#13;
   else&#13;
     ac_prog_rejected=no&#13;
   as_save_IFS=$IFS; IFS=$PATH_SEPARATOR&#13;
   for as_dir in $PATH&#13;
   do&#13;
     IFS=$as_save_IFS&#13;
     test -z "$as_dir" &amp;&amp; as_dir=.&#13;
       for ac_exec_ext in '' $ac_executable_extensions; do&#13;
     if as_fn_executable_p "$as_dir/$ac_word$ac_exec_ext"; then&#13;
     <span class="ent">➋</span> if test "$as_dir/$ac_word$ac_exec_ext" = "/usr/sbin/bash"; then&#13;
           ac_prog_rejected=yes&#13;
           continue&#13;
         fi&#13;
        ac_cv_prog_bash_var="yes"&#13;
        $as_echo "$as_me:${as_lineno-$LINENO}: found $as_dir/$ac_word$ac_exec_ext"&#13;
    &gt;&amp;5&#13;
        break 2&#13;
      fi&#13;
    done&#13;
      done&#13;
  IFS=$as_save_IFS&#13;
&#13;
<span class="ent">➌</span> if test $ac_prog_rejected = yes; then&#13;
    # We found a bogon in the path, so make sure we never use it.&#13;
    set dummy $ac_cv_prog_bash_var&#13;
    shift&#13;
    if test $# != 0; then&#13;
      # We chose a different compiler from the bogus one.&#13;
      # However, it has the same basename, so the bogon will be chosen&#13;
      # first if we set bash_var to just the basename; use the full file name.&#13;
      shift&#13;
      ac_cv_prog_bash_var="$as_dir/$ac_word${1+' '}$@"&#13;
    fi&#13;
  fi&#13;
    test -z "$ac_cv_prog_bash_var" &amp;&amp; ac_cv_prog_bash_var="no"&#13;
  fi&#13;
  fi&#13;
  bash_var=$ac_cv_prog_bash_var&#13;
  if test -n "$bash_var"; then&#13;
    { $as_echo "$as_me:${as_lineno-$LINENO}: result: $bash_var" &gt;&amp;5&#13;
  $as_echo "$bash_var" &gt;&amp;6; }&#13;
  else&#13;
   <span epub:type="pagebreak" id="page_122"/>    { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" &gt;&amp;5&#13;
  $as_echo "no" &gt;&amp;6; }&#13;
  fi&#13;
&#13;
&#13;
  <span class="codestrong1">_DEBUG_END_</span>&#13;
  <span class="codeitalic1">--snip--</span></pre>&#13;
<p class="caption" id="ch05ex5"><em>Listing 5-5: A portion of <code>configure</code> generated by <code>AC_CHECK_PROG</code></em></p>&#13;
<p class="indent">The opening comment at <span class="ent">➊</span> in this shell script is a clue that <code>AC_CHECK_PROG</code> has some undocumented functionality. Apparently, you may pass in arguments along with the program name in the <em><code>prog-to-check-for</code></em> parameter. Shortly, we’ll look at a situation in which you might want to do that.</p>&#13;
<p class="indent">Farther down in the script at <span class="ent">➋</span>, you can see that the <em><code>reject</code></em> parameter was added into the mix in order to allow <code>configure</code> to search for a particular version of a tool. From the code at <span class="ent">➌</span>, we can see that our <code>bash_var</code> variable can have three different values: either empty if the requested program is not found in the search path, the program specified if it’s found, or the full path of the program specified if <em><code>reject</code></em> is found first.</p>&#13;
<p class="indent">Where do you use <em><code>reject</code></em>? Well, for instance, on Solaris systems with proprietary Sun tools installed, the default C compiler is often the Solaris C compiler. But some software may require the use of the GNU C compiler instead. As maintainers, we don’t know which compiler will be found first in a user’s search path. <code>AC_CHECK_PROG</code> allows us to ensure that <code>gcc</code> is used with a full path if another C compiler is found first in the search path.</p>&#13;
<p class="indent">As I mentioned earlier, M4 macros are aware of the fact that arguments are given, empty, or missing, and they do different things based on these conditions. Many of the standard Autoconf macros are written to take full advantage of empty or unspecified optional arguments and generate entirely different shell code in each of these conditions. Autoconf macros may also optimize the generated shell code for these different conditions.</p>&#13;
<p class="indent">Given what we now know, we probably should have called <code>AC_CHECK_PROG</code> in this manner instead:</p>&#13;
<pre><span class="ash">AC_CHECK_PROG([</span>bash_shell<span class="ash">],[bash</span> -x<span class="ash">],[</span>bash -x<span class="ash">],,,[/usr/sbin/bash])</span></pre>&#13;
<p class="indent">You can see in this example that the manual is technically accurate. If <em><code>reject</code></em> isn’t specified and <code>bash</code> is found in the system path, then <code>bash_shell</code> will be set to <code>bash -x</code>. If <code>bash</code> is <em>not</em> found in the system path, then <code>bash_shell</code> will be set to the empty string. If, on the other hand, <em><code>reject</code></em> <em>is</em> specified and the undesired version of <code>bash</code> is found <em>first</em> in the path, then <code>bash_shell</code> will be set to the full path of the <em>next</em> version found in the path, along with the originally specified argument (<code>-x</code>). The reason the macro uses the full path in this case is to make sure that <code>configure</code> will avoid executing the version that was found first in the path—<em><code>reject</code></em>. The rest of the configuration script can now use the <code>bash_shell</code> variable to run the desired Bash shell, as long as it doesn’t test out empty.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>If you’re following along in your own code, don’t forget to remove the temporary code from <a href="ch05.xhtml#ch05ex4">Listing 5-4</a> from your</em> configure.ac <em>file</em>.</p>&#13;
</div>&#13;
<h3 class="h3" id="ch05sec5"><span epub:type="pagebreak" id="page_123"/>Checks for Libraries and Header Files</h3>&#13;
<p class="noindent">The decision of whether or not to use an external library in a project is a tough one. On one hand, you want to reuse existing code to provide required functionality instead of writing it yourself. Reuse is one of the hallmarks of the open source software world. On the other hand, you don’t want to depend on functionality that may not exist on all target platforms or that may require significant porting in order to make the libraries you need available where you need them.</p>&#13;
<p class="indent">Occasionally, library-based functionality can differ in minor ways between platforms. Although the functionality may be essentially equivalent, the libraries may have different package names or different API signatures. The POSIX threads (<em>pthread</em>) library, for example, is similar in functionality to many native threading libraries, but the libraries’ APIs are usually different in minor ways, and their package and library names are almost always different. Consider what would happen if we tried to build a multithreaded project on a system that didn’t support <em>pthread</em>; in a case like this, you might want to use the <em>libthreads</em> library on Solaris instead.</p>&#13;
<p class="indent">Autoconf library selection macros allow generated configuration scripts to intelligently select the libraries that provide the necessary functionality, even if those libraries are named differently between platforms. To illustrate the use of the Autoconf library selection macros, we’ll add some trivial (and fairly contrived) multithreading capabilities to the Jupiter project that will allow <code>jupiter</code> to print its message using a background thread. We’ll use the <em>pthread</em> API as our base threading model. In order to accomplish this with our Autoconf-based configuration script, we need to add the <em>pthread</em> library to our project build system.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>The proper use of multithreading requires the definition of additional substitution variables containing appropriate flags, libraries, and definitions. The <em><code>AX_PTHREAD</code></em> macro does all of this for you. You can find the documentation for <em><code>AX_PTHREAD</code></em> at the Autoconf Macro Archive website.<sup><a id="ch05fn_7" href="footnote.xhtml#ch05fn7">7</a></sup> See “Doing Threads the Right Way” on <a href="ch14.xhtml#page_384">page 384</a> for examples of using <em><code>AX_PTHREAD</code></em>.</em></p>&#13;
</div>&#13;
<p class="indent">First, let’s tackle the changes to the source code. We’ll modify <em>main.c</em> so that the message is printed by a secondary thread, as shown in <a href="ch05.xhtml#ch05ex6">Listing 5-6</a>.</p>&#13;
<p class="margin">Git tag 5.2</p>&#13;
<pre><span class="ash">#include &lt;stdio.h&gt;</span>&#13;
<span class="ash">#include &lt;stdlib.h&gt;</span>&#13;
#include &lt;pthread.h&gt;&#13;
&#13;
static void * print_it(void * data)&#13;
{&#13;
    printf("Hello from %s!\n", (const char *)data);&#13;
    return 0;&#13;
}&#13;
&#13;
<span class="ash">int main(int argc, char * argv[])</span>&#13;
<span epub:type="pagebreak" id="page_124"/><span class="ash">{</span>&#13;
    pthread_t tid;&#13;
    pthread_create(&amp;tid, 0, print_it, argv[0]);&#13;
    pthread_join(tid, 0);&#13;
    <span class="ash">return 0;</span>&#13;
<span class="ash">}</span></pre>&#13;
<p class="caption" id="ch05ex6"><em>Listing 5-6:</em> src/main.c: <em>Adding multithreading to the Jupiter project source code</em></p>&#13;
<p class="indent">This is clearly a ridiculous use of a thread; nevertheless, it <em>is</em> the prototypical form of thread usage. Consider a hypothetical situation in which the background thread performs some long calculation and <code>main</code> is doing other things while <code>print_it</code> is working. On a multiprocessor machine, using a thread in this manner could literally double a program’s throughput.</p>&#13;
<p class="indent">Now all we need is a way to determine which libraries should be added to the compiler (linker) command line. If we weren’t using Autoconf, we’d just add the library to our linker command line in the makefile, as shown in <a href="ch05.xhtml#ch05ex7">Listing 5-7</a>.</p>&#13;
<pre><span class="ash">program: main.c</span>&#13;
        <span class="ash">$(CC) ...</span> -lpthread <span class="ash">...</span></pre>&#13;
<p class="caption" id="ch05ex7"><em>Listing 5-7: Manually adding the</em> pthread <em>library to the compiler command line</em></p>&#13;
<p class="indent">Instead, we’ll use the Autoconf-provided <code>AC_SEARCH_LIBS</code> macro, an enhanced version of the basic <code>AC_CHECK_LIB</code> macro. The <code>AC_SEARCH_LIBS</code> macro allows us to test for required functionality within a list of libraries. If the functionality exists in one of the specified libraries, an appropriate command line option is added to the <code>@LIBS@</code> substitution variable, which we would then use in a <em>Makefile.in</em> template on the compiler (linker) command line. Here is the formal definition of <code>AC_SEARCH_LIBS</code> from the <em>GNU Autoconf Manual</em>:</p>&#13;
<div class="indentin">&#13;
<pre>AC_SEARCH_LIBS(<span class="codeitalic1">function</span>, <span class="codeitalic1">search-libs</span>,&#13;
    [<span class="codeitalic1">action-if-found</span>], [<span class="codeitalic1">action-if-not-found</span>], [<span class="codeitalic1">other-libraries</span>])</pre>&#13;
</div>&#13;
<p class="bqpara1">Search for a library defining <em><code>function</code></em> if it’s not already available. This equates to calling <code>AC_LINK_IFELSE([AC_LANG_CALL([],</code> <code>[</code><em><code>function</code></em><code>])])</code> first with no libraries, then for each library listed in <em><code>search-libs</code></em>.</p>&#13;
<p class="bqpara0">Add <code>-l</code><em><code>library</code></em> to <code>LIBS</code> for the first library found to contain <em><code>function</code></em>, and run <em><code>action-if-found</code></em>. If <em><code>function</code></em> is not found, run <em><code>action-if-not-found</code></em>.</p>&#13;
<p class="bqpara0">If linking with <em><code>library</code></em> results in unresolved symbols that would be resolved by linking with additional libraries, give those libraries as the <em><code>other-libraries</code></em> argument, separated by spaces: for example, <code>-lXt -lX11</code>. Otherwise, this macro fails to detect that <em><code>function</code></em> is present, because linking the test program always fails with unresolved symbols.</p>&#13;
<p class="bqpara0"><span epub:type="pagebreak" id="page_125"/> The result of this test is cached in the <code>ac_cv_search</code> <em><code>function</code></em> variable as <code>none required</code> if <em><code>function</code></em> is already available, as <code>no</code> if no library containing <em><code>function</code></em> was found, otherwise as the <code>-l</code><em><code>library</code></em> option that needs to be prepended to <code>LIBS</code>.<sup><a id="ch05fn_8" href="footnote.xhtml#ch05fn8">8</a></sup></p>&#13;
<p class="indentt">Can you see why the generated configuration script is so large? When you pass a particular function in a call to <code>AC_SEARCH_LIBS</code>, linker command line arguments are added to a substitution variable called <code>@LIBS@</code>. These arguments ensure that you will link with a library that contains the function passed in. If multiple libraries are listed in the second parameter, separated by whitespace, <code>configure</code> will determine which of these libraries are available on your user’s system and use the most appropriate one.</p>&#13;
<p class="indent"><a href="ch05.xhtml#ch05ex8">Listing 5-8</a> shows how to use <code>AC_SEARCH_LIBS</code> in Jupiter’s <em>configure.ac</em> file to find the library that contains the <code>pthread_create</code> function. <code>AC_SEARCH_LIBS</code> won’t add anything to the <code>@LIBS@</code> variable if it doesn’t find <code>pthread_create</code> in the <em>pthread</em> library.</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash"># Checks for libraries.</span>&#13;
AC_SEARCH_LIBS([pthread_create], [pthread])&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch05ex8"><em>Listing 5-8:</em> configure.ac: <em>Using <code>AC_SEARCH_LIBS</code> to check for the</em> pthread <em>library on the system</em></p>&#13;
<p class="indent">As we’ll discuss in detail in <a href="ch07.xhtml">Chapter 7</a>, naming patterns for libraries differ among systems. For example, some systems name libraries <em>lib</em>basename<em>.so</em>, while others use <em>lib</em>basename<em>.sa</em> or <em>lib</em>basename<em>.a</em>. Cigwin-based systems generate libraries named <em>cig</em>basename<em>.dll</em>. <code>AC_SEARCH_LIBS</code> addresses this situation (quite elegantly) by using the compiler to calculate the actual name of the library from its <em>basename</em>; it does this by attempting to link a small test program with the requested function from the test library. Only <code>-l</code><em><code>basename</code></em> is passed on the compiler command line—a near-universal convention among Unix compilers.</p>&#13;
<p class="indent">We’ll have to modify <em>src/Makefile.in</em> again in order to properly use the now-populated <code>@LIBS@</code> variable, as shown in <a href="ch05.xhtml#ch05ex9">Listing 5-9</a>.</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash"># Tool-specific substitution variables</span>&#13;
<span class="ash">CC = @CC@</span>&#13;
LIBS = @LIBS@&#13;
<span class="ash">CFLAGS = @CFLAGS@</span>&#13;
<span class="ash">CPPFLAGS = @CPPFLAGS@</span>&#13;
<span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">jupiter: main.c</span>&#13;
        <span class="ash">$(CC) $(CFLAGS) $(CPPFLAGS) -I. -I$(srcdir) -I..\</span>&#13;
          <span class="ash">-o $@ $(srcdir)/main.c</span> $(LIBS)&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch05ex9"><em>Listing 5-9:</em> src/Makefile.in: <em>Using the <code>@LIBS@</code> substitution variable</em></p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><span epub:type="pagebreak" id="page_126"/><em>I added <em><code>$(LIBS)</code></em> after the source files on the compiler command line because the linker cares about object file order—it searches files for required functions in the order they are specified on the command line.</em></p>&#13;
</div>&#13;
<p class="indent">I want <em>main.c</em> to be the primary source of object code for <code>jupiter</code>, so I’ll continue to add additional objects, including libraries, to the command line after this file.</p>&#13;
<h4 class="h4" id="ch05sec5-1"><em>Is It Right or Just Good Enough?</em></h4>&#13;
<p class="noindent">At this point, we’ve ensured that our build system will properly use <em>pthread</em> on most systems.<sup><a id="ch05fn_9" href="footnote.xhtml#ch05fn9">9</a></sup> If our system needs a particular library, that library’s name will be added to the <code>@LIBS@</code> variable and then subsequently used on the compiler command line. But we’re not done yet.</p>&#13;
<p class="indent">This system <em>usually</em> works fine, but it still fails in corner cases. Because we want to provide an excellent user experience, we’ll take Jupiter’s build system to the next level. In doing this, we need to make a design decision: in case <code>configure</code> fails to locate a <em>pthread</em> library on a user’s system, should we fail the build process or build a <code>jupiter</code> program without multithreading?</p>&#13;
<p class="indent">If we choose to fail the build, the user will notice, because the build will stop with an error message (though it may not be a very friendly one—either the compile or link process will fail with a cryptic error message about a missing header file or an undefined symbol). On the other hand, if we choose to build a single-threaded version of <code>jupiter</code>, we’ll need to display some clear message that the program is being built without multithreading functionality and explain why.</p>&#13;
<p class="indent">One potential problem is that some users’ systems may have a <em>pthread</em> shared library installed but not the <em>pthread.h</em> header file—most likely because the <em>pthread</em> executable (shared-library) package was installed but the developer package wasn’t. Shared libraries are often packaged independently of static libraries and header files, and while executables are installed as part of a dependency chain for higher-level applications, developer packages are typically installed directly by a user.<sup><a id="ch05fn_10" href="footnote.xhtml#ch05fn10">10</a></sup> For this reason, <span epub:type="pagebreak" id="page_127"/>Autoconf provides macros to test for the existence of both libraries and header files. We can use the <code>AC_CHECK_HEADERS</code> macro to ensure the existence of a particular header file.</p>&#13;
<p class="indent">Autoconf checks are very thorough. They usually ensure not only that a file exists but also that the file is the correct one, because they allow you to specify assertions about the file that the macro then verifies. The <code>AC_CHECK_HEADERS</code> macro doesn’t just scan the filesystem for the requested header. Like <code>AC_SEARCH_LIBS</code>, the <code>AC_CHECK_HEADERS</code> macro builds a short test program in the appropriate language and then compiles it to ensure that the compiler can both find and use the file. In essence, Autoconf macros try to test not just for the existence of specific features but for the functionality required from those features.</p>&#13;
<p class="indent">The <code>AC_CHECK_HEADERS</code> macro is defined in the <em>GNU Autoconf Manual</em> as follows:</p>&#13;
<div class="indentin">&#13;
<pre>AC_CHECK_HEADERS(<span class="codeitalic1">header-file</span>..., [<span class="codeitalic1">action-if-found</span>],&#13;
    [<span class="codeitalic1">action-if-not-found</span>], [<span class="codeitalic1">includes</span> = 'AC_INCLUDES_DEFAULT'])</pre>&#13;
</div>&#13;
<p class="bqpara1">For each given system header file <em><code>header-file</code></em> in the blank-separated argument list that exists, define <code>HAVE_</code><em><code>header-file</code></em> (in all capitals). If <em><code>action-if-found</code></em> is given, it is additional shell code to execute when one of the header files is found. You can give it a value of <code>break</code> to break out of the loop on the first match. If <em><code>action-if-not-found</code></em> is given, it is executed when one of the header files is not found.</p>&#13;
<p class="bqpara0"><em><code>includes</code></em> is interpreted as in <code>AC_CHECK_HEADER</code>, in order to choose the set of preprocessor directives supplied before the header under test.<sup><a id="ch05fn_11" href="footnote.xhtml#ch05fn11">11</a></sup></p>&#13;
<p class="indentt">Normally, <code>AC_CHECK_HEADERS</code> is called only with a list of desired header files in the first argument. The remaining arguments are optional and are not often used because the macro works pretty well without them.</p>&#13;
<p class="indent">We’ll add a check for the <em>pthread.h</em> header file to <em>configure.ac</em> using <code>AC_CHECK_HEADERS</code>. As you may have noticed, <em>configure.ac</em> already calls <code>AC_CHECK_HEADERS</code> looking for <em>stdlib.h</em>. <code>AC_CHECK_HEADERS</code> accepts a list of filenames, so we’ll just add <em>pthread.h</em> to the list, using a space to separate the filenames, as shown in <a href="ch05.xhtml#ch05ex10">Listing 5-10</a>.</p>&#13;
<p class="margin">Git tag 5.3</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash"># Checks for header files.</span>&#13;
<span class="ash">AC_CHECK_HEADERS([stdlib.h</span> pthread.h<span class="ash">])</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch05ex10"><em>Listing 5-10:</em> configure.ac: <em>Adding</em> pthread.h <em>to the <code>AC_CHECK_HEADERS</code> macro</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_128"/>In order to make this package available to as many people as possible, we’ll use the dual-mode build approach, which will allow us to provide at least <em>some</em> form of the <code>jupiter</code> program to users without a <em>pthread</em> library. In order to accomplish this, we need to add some conditional preprocessor statements to <em>src/main.c</em>, as shown in <a href="ch05.xhtml#ch05ex11">Listing 5-11</a>.</p>&#13;
<pre>#include "config.h"&#13;
&#13;
<span class="ash">#include &lt;stdio.h&gt;</span>&#13;
<span class="ash">#include &lt;stdlib.h&gt;</span>&#13;
&#13;
#if HAVE_PTHREAD_H&#13;
<span class="ash"># include &lt;pthread.h&gt;</span>&#13;
#endif&#13;
&#13;
<span class="ash">static void * print_it(void * data)</span>&#13;
<span class="ash">{</span>&#13;
    <span class="ash">printf("Hello from %s!\n", (const char *)data);</span>&#13;
    <span class="ash">return 0;</span>&#13;
<span class="ash">}</span>&#13;
&#13;
<span class="ash">int main(int argc, char * argv[])</span>&#13;
<span class="ash">{</span>&#13;
#if HAVE_PTHREAD_H&#13;
    <span class="ash">pthread_t tid;</span>&#13;
    <span class="ash">pthread_create(&amp;tid, 0, print_it, argv[0]);</span>&#13;
    <span class="ash">pthread_join(tid, 0);</span>&#13;
#else&#13;
    print_it(argv[0]);&#13;
#endif&#13;
    <span class="ash">return 0;</span>&#13;
<span class="ash">}</span></pre>&#13;
<p class="caption" id="ch05ex11"><em>Listing 5-11:</em> src/main.c: <em>Adding conditional code, based on the existence of</em> pthread.h</p>&#13;
<p class="indent">In this version of <em>main.c</em>, we’ve added a conditional check for the header file. If the shell script generated by <code>AC_CHECK_HEADERS</code> locates the <em>pthread.h</em> header file, the <code>HAVE_PTHREAD_H</code> macro will be defined with the value <code>1</code> in the user’s <em>config.h</em> file. If the shell script doesn’t find the header file, the original <code>#undef</code> statement will be left commented out in <em>config.h</em>. Because we rely on these definitions, we also need to include <em>config.h</em> at the top of <em>main.c</em>.</p>&#13;
<p class="indent">If you choose not to use the <code>AC_CONFIG_HEADERS</code> macro in <em>configure.ac</em>, then <code>@DEFS@</code> will contain all the definitions generated by all the macros that call <code>AC_DEFINE</code>. In this example, we’ve used <code>AC_CONFIG_HEADERS</code>, so <em>config.h.in</em> will contain most of these definitions, and <code>@DEFS@</code> will only contain <code>HAVE_CONFIG_H</code>, which we don’t actually use.<sup><a id="ch05fn_12" href="footnote.xhtml#ch05fn12">12</a></sup> The <em>config.h.in</em> template method significantly <span epub:type="pagebreak" id="page_129"/>shortens the compiler command line (and also makes it simple to take a snapshot of the template and modify it by hand for non-Autotools platforms). <a href="ch05.xhtml#ch05ex12">Listing 5-12</a> shows the required changes to the <em>src/Makefile.in</em> template.</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash"># Tool-related substitution variables</span>&#13;
<span class="ash">CC = @CC@</span>&#13;
DEFS = @DEFS@&#13;
<span class="ash">LIBS = @LIBS@</span>&#13;
<span class="ash">CFLAGS = @CFLAGS@</span>&#13;
<span class="ash">CPPFLAGS = @CPPFLAGS@</span>&#13;
<span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">jupiter: main.c</span>&#13;
        <span class="ash">$(CC) $(CFLAGS)</span> $(DEFS) <span class="ash">$(CPPFLAGS) -I. -I$(srcdir) -I..\</span>&#13;
          <span class="ash">-o $@ $(srcdir)/main.c $(LIBS)</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch05ex12"><em>Listing 5-12:</em> src/Makefile.in: <em>Adding the use of <code>@DEFS@</code> to the src-level makefile</em></p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>I’ve added <em><code>$(DEFS)</code></em> before <em><code>$(CPPFLAGS)</code></em>, giving the end user the option to override any of my policy decisions on the command line</em>.</p>&#13;
</div>&#13;
<p class="indent">We now have everything we need to conditionally build the <code>jupiter</code> program. If the user’s system has <em>pthread</em> functionality installed, the user will automatically build a version of <code>jupiter</code> that uses multiple threads of execution; otherwise, they’ll have to settle for serialized execution. The only thing left to do is to add some code to <em>configure.ac</em> such that if <code>configure</code> can’t find the <em>pthread</em> library, it will display a message indicating that it will build a program that uses serialized execution.</p>&#13;
<p class="indent">Now, consider the unlikely scenario of a user who has the header file installed but doesn’t have the library. For example, if the user executes <code>./configure</code> with <code>CPPFLAGS=-I/usr/local/include</code> but neglects to add <code>LDFLAGS=-L/usr/local/lib</code>, it will seem to <code>configure</code> that the header is available but the library is missing. This condition is easily remedied by simply skipping the header file check entirely if <code>configure</code> can’t find the library. <a href="ch05.xhtml#ch05ex13">Listing 5-13</a> shows the required changes to <em>configure.ac</em>.</p>&#13;
<p class="margin">Git tag 5.4</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash"># Checks for libraries.</span>&#13;
have_pthreads=no&#13;
<span class="ash">AC_SEARCH_LIBS([pthread_create], [pthread],</span> [have_pthreads=yes]<span class="ash">)</span>&#13;
&#13;
<span class="ash"># Checks for header files.</span>&#13;
<span class="ash">AC_CHECK_HEADERS([stdlib.h])</span>&#13;
&#13;
if test "x${have_pthreads}" = xyes; then&#13;
    AC_CHECK_HEADERS([pthread.h], [], [have_pthreads=no])&#13;
fi&#13;
&#13;
if test "x${have_pthreads}" = xno; then&#13;
    AC_MSG_WARN([&#13;
<span epub:type="pagebreak" id="page_130"/>  ------------------------------------------&#13;
  Unable to find pthreads on this system.&#13;
  Building a single-threaded version.&#13;
  ------------------------------------------])&#13;
fi&#13;
<span class="codeitalic1">--snip--</span></pre>&#13;
<p class="caption" id="ch05ex13"><em>Listing 5-13:</em> configure.ac: <em>Adding code to indicate that multithreading is not available during configuration</em></p>&#13;
<p class="indent">Now, when we run <code>./bootstrap.sh</code> and <code>./configure</code>, we’ll see some additional output (highlighted here):</p>&#13;
<pre>$ <span class="codestrong1">./bootstrap.sh</span>&#13;
$ <span class="codestrong1">./configure</span>&#13;
<span class="ash">checking for gcc... gcc</span>&#13;
<span class="codeitalic1a">--snip--</span>&#13;
checking for library containing pthread_create... -lpthread&#13;
<span class="codeitalic1">--snip--</span>&#13;
checking pthread.h usability... yes&#13;
checking pthread.h presence... yes&#13;
checking for pthread.h... yes&#13;
<span class="ash">configure: creating ./config.status</span>&#13;
<span class="ash">config.status: creating Makefile</span>&#13;
<span class="ash">config.status: creating src/Makefile</span>&#13;
<span class="ash">config.status: creating config.h</span>&#13;
$</pre>&#13;
<p class="indent">If a user’s system is missing the <em>pthread.h</em> header file, for instance, they’d see different output. To emulate this for testing purposes, we can use a trick involving Autoconf cache variables. By presetting the cache variable that represents the presence of the <em>pthread.h</em> header to <code>no</code>, we can trick <code>configure</code> into not even looking for <em>pthread.h</em> because it assumes the search has already been done if the cache variable is already set. Let’s try it out:</p>&#13;
<pre>$ <span class="codestrong1">./configure ac_cv_header_pthread_h=no</span>&#13;
<span class="ash">checking for gcc... gcc</span>&#13;
<span class="codeitalic1">--snip--</span>&#13;
checking for library containing pthread_create... -lpthread&#13;
<span class="codeitalic1">--snip--</span>&#13;
checking for pthread.h... (cached) no&#13;
configure: WARNING:&#13;
  ------------------------------------------&#13;
  Unable to find pthreads on this system.&#13;
  Building a single-threaded version.&#13;
  ------------------------------------------&#13;
<span class="ash">configure: creating ./config.status</span>&#13;
<span class="ash">config.status: creating Makefile</span>&#13;
<span class="ash">config.status: creating src/Makefile</span>&#13;
<span class="ash">config.status: creating config.h</span>&#13;
$</pre>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_131"/>Had we chosen to fail the build if the <em>pthread.h</em> header file or the <em>pthread</em> libraries were not found, then the source code would have been simpler; there would have been no need for conditional compilation. In that case, we could change <em>configure.ac</em> to look like <a href="ch05.xhtml#ch05ex14">Listing 5-14</a>.</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash"># Checks for libraries.</span>&#13;
<span class="ash">have_pthreads=no</span>&#13;
<span class="ash">AC_SEARCH_LIBS([pthread_create], [pthread], [have_pthreads=yes])</span>&#13;
&#13;
<span class="ash"># Checks for header files.</span>&#13;
<span class="ash">AC_CHECK_HEADERS([stdlib.h])</span>&#13;
&#13;
if test "x${have_pthreads}" = xyes; then&#13;
    AC_CHECK_HEADERS([pthread.h], [], [have_pthreads=no])&#13;
fi&#13;
&#13;
if test "x${have_pthreads}" = xno; then&#13;
    AC_MSG_ERROR([&#13;
  ------------------------------------------&#13;
  The pthread library and header files are&#13;
  required to build jupiter. Stopping...&#13;
  Check 'config.log' for more information.&#13;
  ------------------------------------------])&#13;
fi&#13;
<span class="codeitalic1">--snip--</span></pre>&#13;
<p class="caption" id="ch05ex14"><em>Listing 5-14: Failing the build if no</em> pthread <em>library is found</em></p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Autoconf macros generate shell code that checks for the existence of system features and sets variables based on these tests. However, it’s up to you as maintainer to add shell code to</em> configure.ac <em>that makes functional decisions based on the contents of the resulting variables</em>.</p>&#13;
</div>&#13;
<h4 class="h4" id="ch05sec5-2"><em>Printing Messages</em></h4>&#13;
<p class="noindent">In the preceding examples, we used a few Autoconf macros to display messages to the user during configuration: <code>AC_MSG_WARN</code> and <code>AC_MSG_ERROR</code>. Here are the prototypes for the various <code>AC_MSG_*</code> macros provided by Autoconf:</p>&#13;
<pre>AC_MSG_CHECKING(<span class="codeitalic1">feature-description</span>)&#13;
AC_MSG_RESULT(<span class="codeitalic1">result-description</span>)&#13;
AC_MSG_NOTICE(<span class="codeitalic1">message</span>)&#13;
AC_MSG_ERROR(<span class="codeitalic1">error-description</span>[, <span class="codeitalic1">exit-status</span>])&#13;
AC_MSG_FAILURE(<span class="codeitalic1">error-description</span>[, <span class="codeitalic1">exit-status</span>])&#13;
AC_MSG_WARN(<span class="codeitalic1">problem-description</span>)</pre>&#13;
<p class="indent">The <code>AC_MSG_CHECKING</code> and <code>AC_MSG_RESULT</code> macros are designed to be used together. The <code>AC_MSG_CHECKING</code> macro prints a line indicating that it’s checking for a particular feature, but it doesn’t print a carriage return at the end of this line. Once the feature has been found (or not found) on the user’s machine, the <code>AC_MSG_RESULT</code> macro prints the result at the end of <span epub:type="pagebreak" id="page_132"/>the line, followed by a carriage return that completes the line started by <code>AC_MSG_CHECKING</code>. The <em><code>result-description</code></em> text should make sense in the context of the <em><code>feature-description</code></em> message. For instance, the message <code>Looking for a C compiler...</code> might be terminated either with the name of the compiler found or with the text <code>not found</code>.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>You as the</em> configure.ac <em>author should strive to not allow additional text to be displayed between these two macro invocations, as it becomes difficult for the user to follow if there is unrelated text between the two sets of output</em>.</p>&#13;
</div>&#13;
<p class="indent">The <code>AC_MSG_NOTICE</code> and <code>AC_MSG_WARN</code> macros simply print a string to the screen. The leading text for <code>AC_MSG_WARN</code> is <code>configure: WARNING:</code>, whereas that of <code>AC_MSG_NOTICE</code> is simply <code>configure:</code>.</p>&#13;
<p class="indent">The <code>AC_MSG_ERROR</code> and <code>AC_MSG_FAILURE</code> macros generate an error message, stop the configuration process, and return an error code to the shell. The leading text for <code>AC_MSG_ERROR</code> is <code>configure: error:</code>. The <code>AC_MSG_FAILURE</code> macro prints a notice indicating the directory in which the error occurred, the user-specified message, and then the text <code>See 'config.log' for more details</code>. The optional second parameter (<em><code>exit-status</code></em>) in these macros allows the maintainer to specify a particular status code to be returned to the shell. The default value is <code>1</code>.</p>&#13;
<p class="indent">The text messages output by these macros are displayed to <code>stdout</code> and sent to the <em>config.log</em> file, so it’s important to use these macros instead of simply using shell <code>echo</code> or <code>printf</code> statements.</p>&#13;
<p class="indent">Supplying multiple lines of text in the first argument of these macros is especially important in the case of warning messages that merely indicate that the build is continuing with limitations. On a fast build machine in a large configuration process, a single-line warning message could zip right past without even being noticed by the user. This is less of a problem in cases where <code>configure</code> terminates with an error, because the user will easily discover the issue at the end of the output.<sup><a id="ch05fn_13" href="footnote.xhtml#ch05fn13">13</a></sup></p>&#13;
<h3 class="h3" id="ch05sec6">Supporting Optional Features and Packages</h3>&#13;
<p class="noindent">We’ve discussed the different ways to handle situations when a <em>pthread</em> library exists and when it doesn’t. But what if a user wants to build a single-threaded version of <code>jupiter</code> when the <em>pthread</em> library <em>is</em> installed? <span epub:type="pagebreak" id="page_133"/>We certainly don’t want to add a note to Jupiter’s <em>README</em> file telling the user to rename their <em>pthread</em> libraries! Neither do we want the user to have to use our Autoconf cache variable trick.</p>&#13;
<p class="indent">Autoconf provides two macros for working with optional features and external software packages: <code>AC_ARG_ENABLE</code> and <code>AC_ARG_WITH</code>. Their prototypes are as follows:</p>&#13;
<pre>AC_ARG_WITH(<span class="codeitalic1">package</span>, <span class="codeitalic1">help-string</span>, [<span class="codeitalic1">action-if-given</span>], [<span class="codeitalic1">action-if-not-given</span>])&#13;
AC_ARG_ENABLE(<span class="codeitalic1">feature</span>, <span class="codeitalic1">help-string</span>, [<span class="codeitalic1">action-if-given</span>], [<span class="codeitalic1">action-if-not-given</span>])</pre>&#13;
<p class="indent">As with many Autoconf macros, these two are used simply to set some environment variables:</p>&#13;
<p class="indentt"><span class="codestrong1">AC_ARG_WITH</span> <code>${withval}</code> and <code>${with_</code><span class="codeitalic1">package</span><code>}</code></p>&#13;
<p class="indent"><span class="codestrong1">AC_ARG_ENABLE</span> <code>${enableval}</code> and <code>${enable_</code><span class="codeitalic1">feature</span><code>}</code></p>&#13;
<p class="indentt">The macros can also be used in a more complex form, where the environment variables are used by shell script in the macros’ optional arguments. In either case, the resulting variable must be used in <em>configure.ac</em>, or it will be pointless to perform the check.</p>&#13;
<p class="indent">The macros are designed to add the options <code>--enable-feature[=yes|no]</code> (or <code>--disable-feature</code>) and <code>--with-package[=arg]</code> (or <code>--without-package</code>) to the generated configuration script’s command line interface, along with appropriate help text to the output generated when the user enters <code>./configure --help</code>. If the user gives these options, the macros set the preceding environment variables within the script. (The values of these variables may be used later in the script to set or clear various preprocessor definitions or substitution variables.)</p>&#13;
<p class="indent"><code>AC_ARG_WITH</code> controls your project’s use of optional external software packages, while <code>AC_ARG_ENABLE</code> controls the inclusion or exclusion of optional software features. The choice to use one or the other is often a matter of perspective on the software you’re considering, and sometimes it’s simply a matter of preference, as these macros provide somewhat overlapping sets of functionality.</p>&#13;
<p class="indent">For instance, in the Jupiter project, it could be justifiably argued that Jupiter’s use of <em>pthread</em> constitutes the use of an external software package, so you’d use <code>AC_ARG_WITH</code>. However, it could also be said that <em>asynchronous processing</em> is a software feature that might be enabled via <code>AC_ARG_ENABLE</code>. In fact, both of these statements are true, and which option you use should be dictated by a high-level architectural perspective on the feature or package to which you’re providing optional access. The <em>pthread</em> library supplies more than just thread creation functions—it also provides mutexes and condition variables, both of which may be used by a library package that doesn’t create threads. If a project provides a library that needs to act in a thread-safe manner within a multithreaded process, it will probably use mutex objects from the <em>pthread</em> library, but it may never create a thread. Thus, a user may choose to disable asynchronous execution as a feature <span epub:type="pagebreak" id="page_134"/>at configuration time, but the project will still need to link to the <em>pthread</em> library in order to access the mutex functionality. In such cases, it makes more sense to specify <code>--enable-async-exec</code> than <code>--with-pthreads</code>.</p>&#13;
<p class="indent">In general, you should use <code>AC_ARG_WITH</code> when the user needs to choose between implementations of a feature provided by different packages or internally within the project. For instance, if <code>jupiter</code> had some reason to encrypt a file, it might be written to use either an internal encryption algorithm or an external encryption library. The default configuration might use an internal algorithm, but the package might allow the user to override the default with the command line option <code>--with-libcrypto</code>. When it comes to security, the use of a widely understood library can really help your package gain community trust.</p>&#13;
<h4 class="h4" id="ch05sec6-1"><em>Coding Up the Feature Option</em></h4>&#13;
<p class="noindent">Having decided to use <code>AC_ARG_ENABLE</code>, how do we enable or disable the <code>async-exec</code> feature by default? The difference in how these two cases are encoded in <em>configure.ac</em> is limited to the help text and the shell script passed in the <em><code>action-if-not-given</code></em> argument. The help text describes the available options and the default value, and the shell script indicates what we want to happen if the option is <em>not</em> specified. (Of course, if it is specified, we don’t need to assume anything.)</p>&#13;
<p class="indent">Say we decide that asynchronous execution is a risky or experimental feature that we want to disable by default. In this situation, we could add the code shown in <a href="ch05.xhtml#ch05ex15">Listing 5-15</a> to <em>configure.ac</em>.</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">AC_ARG_ENABLE([async-exec],</span>&#13;
    <span class="ash">[  --</span>enable<span class="ash">-async-exec</span>     enable<span class="ash">async exec],</span>&#13;
    <span class="ash">[async_exec=${enableval}], [async_exec=</span>no<span class="ash">])</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch05ex15"><em>Listing 5-15: Feature disabled by default</em></p>&#13;
<p class="indent">On the other hand, if we decide that asynchronous execution is fundamental to Jupiter, we should probably enable it by default, as in <a href="ch05.xhtml#ch05ex16">Listing 5-16</a>.</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">AC_ARG_ENABLE([async-exec],</span>&#13;
    <span class="ash">[  --</span>disable<span class="ash">-async-exec</span>    disable<span class="ash">async exec],</span>&#13;
    <span class="ash">[async_exec=${enableval}], [async_exec=</span>yes<span class="ash">])</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch05ex16"><em>Listing 5-16: Feature enabled by default</em></p>&#13;
<p class="indent">Now, the question is, do we check for the library and header file regardless of the user’s desire for this feature, or do we only check for them if the <code>async-exec</code> feature is enabled? In this case, it’s a matter of preference, because <span epub:type="pagebreak" id="page_135"/>we’re using the <em>pthread</em> library only for this feature. (If we were also using it for non-feature-specific reasons, we’d have to check for it in either case.)</p>&#13;
<p class="indent">In cases where we need the library even if the feature is disabled, we would add <code>AC_ARG_ENABLE</code>, as in the preceding example, and an additional invocation of <code>AC_DEFINE</code> to create a <em>config.h</em> definition specifically for this feature. Since we don’t really want to enable the feature if the library or header file is missing—even if the user specifically requested it—we’ll also add some shell code to turn the feature off if either is missing, as shown in <a href="ch05.xhtml#ch05ex17">Listing 5-17</a>.</p>&#13;
<p class="margin">Git tag 5.5</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash"># Checks for programs.</span>&#13;
<span class="ash">AC_PROG_CC</span>&#13;
<span class="ash">AC_PROG_INSTALL</span>&#13;
&#13;
<span class="ash"># Checks for header files.</span>&#13;
<span class="ash">AC_CHECK_HEADERS([stdlib.h])</span>&#13;
&#13;
# Checks for command line options&#13;
AC_ARG_ENABLE([async-exec],&#13;
    [  --disable-async-exec    disable async execution feature],&#13;
    [async_exec=${enableval}], [async_exec=yes])&#13;
&#13;
<span class="ash">have_pthreads=no</span>&#13;
<span class="ash">AC_SEARCH_LIBS([pthread_create], [pthread], [have_pthreads=yes])</span>&#13;
&#13;
<span class="ash">if test "x${have_pthreads}" = xyes; then</span>&#13;
    <span class="ash">AC_CHECK_HEADERS([pthread.h], [], [have_pthreads=no])</span>&#13;
<span class="ash">fi</span>&#13;
&#13;
<span class="ash">if test "x${have_pthreads}" = xno; then</span>&#13;
 <span class="ent">➊</span> if test "x${async_exec}" = xyes; then&#13;
        <span class="ash">AC_MSG_WARN([</span>&#13;
  <span class="ash">------------------------------------------</span>&#13;
  <span class="ash">Unable to find pthreads on this system.</span>&#13;
  <span class="ash">Building a single-threaded version.</span>&#13;
  <span class="ash">------------------------------------------])</span>&#13;
    fi&#13;
    async_exec=no&#13;
<span class="ash">fi</span>&#13;
&#13;
if test "x${async_exec}" = xyes; then&#13;
    AC_DEFINE([ASYNC_EXEC], [1], [async execution enabled])&#13;
fi&#13;
&#13;
<span class="ash"># Checks for libraries.</span>&#13;
&#13;
<span class="ash"># Checks for typedefs, structures, and compiler characteristics.</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch05ex17"><em>Listing 5-17:</em> configure.ac: <em>Properly managing an optional feature during configuration</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_136"/>We’re replacing our original library check with a new check for command line arguments, which has the added benefit of checking for the library for the default case that occurs when the user doesn’t specify a preference. As you can see, much of the existing code is the same, with some additional script around it to account for user command line choices.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>There are places in <a href="ch05.xhtml#ch05ex17">Listing 5-17</a> that appear to have gratuitous whitespace or arbitrary indentation. This is intentional, as it causes output to be formatted properly when <em><code>configure</code></em> is being run. We’ll fix some of this later as we add additional macros to our toolbox</em>.</p>&#13;
</div>&#13;
<p class="indent">Notice that at <span class="ent">➊</span>, I’ve also added an additional test for a <code>yes</code> value in the <code>async_exec</code> variable, because this text really belongs to the feature test, not to the <em>pthread</em> library test. Remember, we’re trying to create a logical separation between testing for <em>pthread</em> functionality and testing for the requirements of the <code>async-exec</code> feature itself.</p>&#13;
<p class="indent">Of course, now we also have to modify <em>src/main.c</em> to use the new definition, as shown in <a href="ch05.xhtml#ch05ex18">Listing 5-18</a>.</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">#if HAVE_PTHREAD_H</span>&#13;
<span class="ash"># include &lt;pthread.h&gt;</span>&#13;
<span class="ash">#endif</span>&#13;
&#13;
<span class="ash">static void * print_it(void * data)</span>&#13;
<span class="ash">{</span>&#13;
    <span class="ash">printf("Hello from %s!\n", (const char *)data);</span>&#13;
    <span class="ash">return 0;</span>&#13;
<span class="ash">}</span>&#13;
&#13;
<span class="ash">int main(int argc, char * argv[])</span>&#13;
<span class="ash">{</span>&#13;
<span class="ash">#if</span> ASYNC_EXEC&#13;
    <span class="ash">pthread_t tid;</span>&#13;
    <span class="ash">pthread_create(&amp;tid, 0, print_it, argv[0]);</span>&#13;
    <span class="ash">pthread_join(tid, 0);</span>&#13;
<span class="ash">#else</span>&#13;
    <span class="ash">print_it(argv[0]);</span>&#13;
<span class="ash">#endif</span>&#13;
    <span class="ash">return 0;</span>&#13;
<span class="ash">}</span></pre>&#13;
<p class="caption" id="ch05ex18"><em>Listing 5-18:</em> src/main.c: <em>Changing the conditional around <code>async-exec</code>-specific code</em></p>&#13;
<p class="indent">Notice that we’ve left the <code>HAVE_PTHREAD_H</code> check around the inclusion of the header file in order to facilitate the use of <em>pthread.h</em> in ways besides those required by this feature.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_137"/>In order to check for the library and header file only if the feature is enabled, we wrap the original check code in a test of <code>async_exec</code>, as shown in <a href="ch05.xhtml#ch05ex19">Listing 5-19</a>.</p>&#13;
<p class="margin">Git tag 5.6</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash"># Checks for command line options.</span>&#13;
<span class="ash">AC_ARG_ENABLE([async-exec],</span>&#13;
  <span class="ash">[    --disable-async-exec        disable async execution feature],</span>&#13;
  <span class="ash">[async_exec=${enableval}], [async_exec=yes])</span>&#13;
&#13;
if test "x${async_exec}" = xyes; then&#13;
    <span class="ash">have_pthreads=no</span>&#13;
    <span class="ash">AC_SEARCH_LIBS([pthread_create], [pthread], [have_pthreads=yes])</span>&#13;
&#13;
    <span class="ash">if test "x${have_pthreads}" = xyes; then</span>&#13;
        <span class="ash">AC_CHECK_HEADERS([pthread.h], [], [have_pthreads=no])</span>&#13;
    <span class="ash">fi</span>&#13;
&#13;
    <span class="ash">if test "x${have_pthreads}" = xno; then</span>&#13;
        <span class="ash">AC_MSG_WARN([</span>&#13;
  <span class="ash">-----------------------------------------</span>&#13;
  <span class="ash">Unable to find pthreads on this system.</span>&#13;
  <span class="ash">Building a single-threaded version.</span>&#13;
  <span class="ash">-----------------------------------------])</span>&#13;
        <span class="ash">async_exec=no</span>&#13;
    <span class="ash">fi</span>&#13;
fi&#13;
&#13;
<span class="ash">if test "x${async_exec}" = xyes; then</span>&#13;
    <span class="ash">AC_DEFINE([ASYNC_EXEC], 1, [async execution enabled])</span>&#13;
<span class="ash">fi</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch05ex19"><em>Listing 5-19:</em> configure.ac: <em>Checking for the library and header file only if a feature is enabled</em></p>&#13;
<p class="indent">This time, we’ve moved the test for <code>async_exec</code> from being just around the message statement to being around the entire set of header and library checks, which means we won’t even look for <em>pthread</em> header and libraries if the user has disabled the <code>async_exec</code> feature.</p>&#13;
<h4 class="h4" id="ch05sec6-2"><em>Formatting Help Strings</em></h4>&#13;
<p class="noindent">We’ll make one final change to our use of <code>AC_ARG_ENABLE</code> in <a href="ch05.xhtml#ch05ex17">Listing 5-17</a>. Notice that in the second argument, there are exactly two spaces between the open square bracket and the start of the argument text. You’ll also notice that the number of spaces between the argument and the description depends on the length of the argument text, because the description text is supposed to be presented to the user aligned with a particular column. There are four spaces between <code>--disable-async-exec</code> and the description in <a href="ch05.xhtml#ch05ex16">Listings 5-16</a> and <a href="ch05.xhtml#ch05ex17">5-17</a>, but there are five spaces after <code>--enable-async-exec</code> in <a href="ch05.xhtml#ch05ex15">Listing 5-15</a> because the word <em>enable</em> is one character shorter than the word <em>disable</em>.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_138"/>But what if the Autoconf project maintainers decide to change the format of the help text for configuration scripts? Or what if you modify your option name but forget to adjust the indentation on your help text?</p>&#13;
<p class="indent">To solve these potential problems, we’ll turn to an Autoconf helper macro called <code>AS_HELP_STRING</code>, whose prototype is as follows:</p>&#13;
<pre>AS_HELP_STRING(<span class="codeitalic1">left-hand-side</span>, <span class="codeitalic1">right-hand-side</span>,&#13;
    [<span class="codeitalic1">indent-column</span> = '26'], [<span class="codeitalic1">wrap-column</span> = '79'])</pre>&#13;
<p class="indent">This macro’s sole purpose is to abstract away knowledge about the number of spaces that should be embedded in the help text at various places. To use it, replace the second argument in <code>AC_ARG_ENABLE</code> with a call to <code>AS_HELP_STRING</code>, as shown in <a href="ch05.xhtml#ch05ex20">Listing 5-20</a>.</p>&#13;
<p class="margin">Git tag 5.7</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">AC_ARG_ENABLE([async-exec],</span>&#13;
    <span class="ash">[</span>AS_HELP_STRING([--disable-async-exec],&#13;
        [disable asynchronous execution @&lt;:@default: no@:&gt;@])<span class="ash">],</span>&#13;
    <span class="ash">[async_exec=${enableval}], [async_exec=yes])</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch05ex20"><em>Listing 5-20:</em> configure.ac: <em>Using <code>AS_HELP_STRING</code></em></p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>For details on the funky character sequences around <em><code>default: no</code></em> in <a href="ch05.xhtml#ch05ex20">Listing 5-20</a>, see “Quadrigraphs” on <a href="ch05.xhtml#page_143">page 143</a>.</em></p>&#13;
</div>&#13;
<h3 class="h3" id="ch05sec7">Checks for Type and Structure Definitions</h3>&#13;
<p class="noindent">Now let’s consider how we might test for system- or compiler-provided type and structure definitions. When writing cross-platform networking software, one quickly learns that the data sent between machines needs to be formatted in a way that doesn’t depend on a particular CPU or operating system architecture. Some systems’ native integer sizes are 32 bits, while others’ are 64 bits. Some systems store integer values in memory and on disk from least-significant byte to most-significant byte, while others do the reverse.</p>&#13;
<p class="indent">Let’s consider an example. When using C-language structures to format network messages, one of the first roadblocks you’ll encounter is the lack of basic C-language types that have the same size from one platform to another. A CPU with a 32-bit machine word size would likely have a C compiler with 32-bit <code>int</code> and <code>unsigned</code> types. The sizes of the basic integer types in the C language are implementation defined. This is by design, in order to allow implementations to use sizes for <code>char</code>, <code>short</code>, <code>int</code>, and <code>long</code> that are optimal for each platform.</p>&#13;
<p class="indent">While this language feature is great for optimizing software designed to run on one platform, it’s not very helpful when choosing types to move data <em>between</em> platforms. In order to address this problem, engineers have tried everything from sending network data as strings (think XML and JSON) to inventing their own sized types.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_139"/>In an attempt to remedy this shortcoming in the language, the C99 standard provides the sized types <code>int</code><em><code>N</code></em><code>_t</code> and <code>uint</code><em><code>N</code></em><code>_t</code>, where <em><code>N</code></em> may be <code>8</code>, <code>16</code>, <code>32</code>, or <code>64</code>. Unfortunately, not all of today’s compilers provide these types. (Not surprisingly, GNU C has been at the forefront for some time now, providing C99-sized types with the inclusion of the <em>stdint.h</em> header file.)</p>&#13;
&#13;
<p class="indent">To alleviate the pain to some extent, Autoconf provides macros for determining whether C99-specific standardized types exist on a user’s platform and then defining them if they don’t exist. For example, you can add a call to <code>AC_TYPE_UINT16_T</code> to <em>configure.ac</em> in order to ensure that <code>uint16_t</code> exists on your users’ platforms, either as a system definition in <em>stdint.h</em> or the non-standard but more prolific <em>inttypes.h</em>, or as an Autoconf definition in <em>config.h</em>.</p>&#13;
<p class="indent">The compiler tests for such integer-based types are typically written by a configuration script as a bit of C code that looks like the code shown in <a href="ch05.xhtml#ch05ex21">Listing 5-21</a>.</p>&#13;
<pre>int main()&#13;
{&#13;
 <span class="ent">➊</span> static int test_array[1 - 2 * !((uint16_t) -1 &gt;&gt; (16 - 1) == 1)];&#13;
    test_array[0] = 0;&#13;
    return 0;&#13;
}</pre>&#13;
<p class="caption" id="ch05ex21"><em>Listing 5-21: A compiler check for a proper implementation of <code>uint16_t</code></em></p>&#13;
<p class="indent">You’ll notice that the important line in <a href="ch05.xhtml#ch05ex21">Listing 5-21</a> is at <span class="ent">➊</span>, which is where <code>test_array</code> is declared. Autoconf is relying on the fact that all C compilers will generate an error if you attempt to define an array with a negative size. If <code>uint16_t</code> isn’t exactly 16 bits of unsigned data on this platform, the array size will be negative.</p>&#13;
<p class="indent">Notice, too, that the bracketed expression in the listing is a compile-time expression.<sup><a id="ch05fn_14" href="footnote.xhtml#ch05fn14">14</a></sup> Whether this could have been done with simpler syntax is anyone’s guess, but this code does the trick on all the compilers Autoconf supports. The array is defined with a nonnegative size only if the following three conditions are met:</p>&#13;
<ul>&#13;
<li class="noindent"><code>uint16_t</code> is defined in one of the included header files.</li>&#13;
<li class="noindent">The size of <code>uint16_t</code> is exactly 16 bits.</li>&#13;
<li class="noindent"><code>uint16_t</code> is unsigned on this platform.</li>&#13;
</ul>&#13;
<p class="indentt">Follow the pattern shown in <a href="ch05.xhtml#ch05ex22">Listing 5-22</a> to use the definitions provided by this macro. Even on systems where <em>stdint.h</em> or <em>inttypes.h</em> is not available, Autoconf will add code to <em>config.h</em> that defines <code>uint16_t</code> if the system header files don’t provide it, so you can use the type in your source code without additional tests.</p>&#13;
<pre><span epub:type="pagebreak" id="page_140"/><span class="ash">#include "config.h"</span>&#13;
&#13;
#if HAVE_STDINT_H&#13;
# include &lt;stdint.h&gt;&#13;
#elif HAVE_INTTYPES_H&#13;
# include &lt;inttypes.h&gt;&#13;
#endif&#13;
<span class="codeitalic1">--snip--</span>&#13;
uint16_t x;&#13;
<span class="codeitalic1">--snip--</span></pre>&#13;
<p class="caption" id="ch05ex22"><em>Listing 5-22: Source code that properly uses Autoconf’s <code>uint16_t</code> definitions</em></p>&#13;
<p class="indent">Autoconf offers a few dozen type checks like <code>AC_TYPE_UINT16_T</code>, as detailed in Section 5.9 of the <em>GNU Autoconf Manual</em>. In addition, a generic type check macro, <code>AC_CHECK_TYPES</code>, allows you to specify a comma-separated list of questionable types that your project needs.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>This list is comma separated because some definitions (like <em><code>struct fooble</code></em>) may have embedded spaces. Since they are comma delimited, you must use Autoconf’s square-bracket quotes around this parameter if you list more than one type.</em></p>&#13;
</div>&#13;
<p class="indent">Here is the formal declaration of <code>AC_CHECK_TYPES</code>:</p>&#13;
<pre>AC_CHECK_TYPES(<span class="codeitalic1">types</span>, [<span class="codeitalic1">action-if-found</span>], [<span class="codeitalic1">action-if-not-found</span>],&#13;
    [<span class="codeitalic1">includes</span> = '<span class="codeitalic1">AC_INCLUDES_DEFAULT</span>'])</pre>&#13;
<p class="indent">If you don’t specify a list of header files in the last parameter, the default headers will be used in the compiler test by way of the macro <code>AC_INCLUDES_DEFAULT</code>, which expands to the text shown in <a href="ch05.xhtml#ch05ex23">Listing 5-23</a>.</p>&#13;
<pre>#include &lt;stdio.h&gt;&#13;
#ifdef HAVE_SYS_TYPES_H&#13;
# include &lt;sys/types.h&gt;&#13;
#endif&#13;
#ifdef HAVE_SYS_STAT_H&#13;
# include &lt;sys/stat.h&gt;&#13;
#endif&#13;
#ifdef STDC_HEADERS&#13;
# include &lt;stdlib.h&gt;&#13;
# include &lt;stddef.h&gt;&#13;
#else&#13;
# ifdef HAVE_STDLIB_H&#13;
#  include &lt;stdlib.h&gt;&#13;
# endif&#13;
#endif&#13;
#ifdef HAVE_STRING_H&#13;
# if !defined STDC_HEADERS &amp;&amp; defined HAVE_MEMORY_H&#13;
#  include &lt;memory.h&gt;&#13;
# endif&#13;
# include &lt;string.h&gt;&#13;
<span epub:type="pagebreak" id="page_141"/>#endif&#13;
#ifdef HAVE_STRINGS_H&#13;
# include &lt;strings.h&gt;&#13;
#endif&#13;
#ifdef HAVE_INTTYPES_H&#13;
# include &lt;inttypes.h&gt;&#13;
#endif&#13;
#ifdef HAVE_STDINT_H&#13;
# include &lt;stdint.h&gt;&#13;
#endif&#13;
#ifdef HAVE_UNISTD_H&#13;
# include &lt;unistd.h&gt;&#13;
#endif</pre>&#13;
<p class="caption" id="ch05ex23"><em>Listing 5-23: The definition of <code>AC_INCLUDES_DEFAULT</code>, as of Autoconf version 2.69</em></p>&#13;
<p class="indent">If you know that your type is not defined in one of these header files, you should specify one or more header files to be included in the test, as shown in <a href="ch05.xhtml#ch05ex24">Listing 5-24</a>. This listing includes the default header files first, followed by the additional header files (which will often need some of the defaults anyway).</p>&#13;
<pre>   AC_CHECK_TYPES([struct doodah], [], [], [&#13;
<span class="ent">➊</span> AC_INCLUDES_DEFAULT&#13;
   #include&lt;doodah.h&gt;&#13;
   #include&lt;doodahday.h&gt;])</pre>&#13;
<p class="caption" id="ch05ex24"><em>Listing 5-24: Using a nondefault set of <code>include</code>s in the check for <code>struct doodah</code></em></p>&#13;
<p class="indent">Notice at <span class="ent">➊</span> in <a href="ch05.xhtml#ch05ex24">Listing 5-24</a> that I’ve wrapped the last parameter of the macro over three lines in <em>configure.ac</em>, without indentation. The text of this argument is included verbatim in the test source file, so you’ll want to be sure that whatever you put into this argument is actually valid code in the language you’re using.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Test-related problems are often the sorts of things that developers complain about with regard to Autoconf. When you have problems with such syntax, check the</em> config.log <em>file for the complete source code for all failed tests, including the compiler output generated during compilation of the test. This information often provides the solution to your problem</em>.</p>&#13;
</div>&#13;
<h3 class="h3" id="ch05sec8">The AC_OUTPUT Macro</h3>&#13;
<p class="noindent">Finally, we come to the <code>AC_OUTPUT</code> macro, which expands, within <code>configure</code>, into shell code that generates the <code>config.status</code> script based on the data specified in the previous macro expansions. All other macros must be used before <code>AC_OUTPUT</code> is expanded, or they will be of little value to your generated <code>configure</code> script. (Additional shell script may be placed in <em>configure.ac</em> after <code>AC_OUTPUT</code>, but it will not affect the configuration or file generation performed by <code>config.status</code>.)</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_142"/>Consider adding shell <code>echo</code> or <code>printf</code> statements after <code>AC_OUTPUT</code> to tell the user how the build system is configured based on the specified command line options. You can also use these statements to tell the user about additional useful targets for <code>make</code>. For example, we might add code to Jupiter’s <em>configure.ac</em> file <em>after</em> <code>AC_OUTPUT</code>, as shown in <a href="ch05.xhtml#ch05ex25">Listing 5-25</a>.</p>&#13;
<p class="margin">Git tag 5.8</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash">AC_OUTPUT</span>&#13;
&#13;
cat &lt;&lt; EOF&#13;
-------------------------------------------------&#13;
&#13;
${PACKAGE_NAME} Version ${PACKAGE_VERSION}&#13;
&#13;
Prefix: '${prefix}'.&#13;
Compiler: '${CC} ${CFLAGS} ${CPPFLAGS}'&#13;
&#13;
Package features:&#13;
  Async Execution: ${async_exec}&#13;
&#13;
Now type 'make @&lt;:@&lt;target&gt;@:&gt;@'&#13;
  where the optional &lt;target&gt; is:&#13;
    all                - build all binaries&#13;
    install            - install everything&#13;
&#13;
--------------------------------------------------&#13;
EOF</pre>&#13;
<p class="caption" id="ch05ex25"><em>Listing 5-25:</em> configure.ac: <em>Adding configuration summary text to the output of <code>configure</code></em></p>&#13;
<p class="indent">Adding such output to the end of <em>configure.ac</em> is a handy project feature, because it tells the user, at a glance, exactly what happened during configuration. Since variables such as <code>async_exec</code> are set to <code>yes</code> or <code>no</code> based on configuration, the user can see whether the requested configuration actually took place.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Version 2.62 (and later) of Autoconf does a much better job of deciphering the user’s intent with respect to the use of square brackets than earlier versions do. In the past, you might have needed to use a quadrigraph to force Autoconf to display a square bracket, but now you can use the character itself. Most of the problems that occur are a result of not properly quoting arguments. This enhanced functionality comes primarily from enhancements to Autoconf library macros that might accept square bracket characters in arguments. To ensure that square brackets are not misinterpreted in your own</em> configure.ac <em>code, you should read up on M4 double quotation in “Quoting Rules” on <a href="ch16.xhtml#page_438">page 438</a></em>.</p>&#13;
</div>&#13;
<div class="box5">&#13;
<p class="sidebart"><span epub:type="pagebreak" id="page_143"/><strong>QUADRIGRAPHS</strong></p>&#13;
<p class="noindent">Those funny character sequences around the word <code>&lt;target&gt;</code> in <a href="ch05.xhtml#ch05ex25">Listing 5-25</a> are called <em>quadrigraph sequences</em> or simply <em>quadrigraphs</em>. They serve the same purpose as escape sequences, but quadrigraphs are a little more reliable than escaped characters or escape sequences because they’re never subject to ambiguity.</p>&#13;
<p class="indent">The sequence <code>@&lt;:@</code> is the quadrigraph sequence for the open square bracket character, while <code>@:&gt;@</code> is the quadrigraph for the closed square bracket character. These quadrigraphs will <em>always</em> be output by <code>autom4te</code> as literal square bracket characters. This happens after M4 is finished with the file, so it has no opportunity to misinterpret them as Autoconf quote characters.</p>&#13;
<p class="indent">If you’re interested in studying quadrigraphs in more detail, check out Section 8 of the <em>GNU Autoconf Manual</em>.</p>&#13;
</div>&#13;
<h3 class="h3" id="ch05sec9">Summary</h3>&#13;
<p class="noindent">In this chapter, we covered some of the more advanced constructs found in the <em>configure.ac</em> files for many projects. We started with the macros required to generate substitution variables. I refer to these as “advanced” macros because many of the higher-level Autoconf macros use <code>AC_SUBST</code> and <code>AC_DEFINE</code> internally, making them somewhat transparent to you. However, knowing about them helps you to understand how Autoconf works and provides some of the background information necessary for you to learn to write your own macros.</p>&#13;
<p class="indent">We covered checks for compilers and other tools, as well as checks for less common data types and structures on your users’ systems. The examples in this chapter were designed to help you to understand the proper use of the Autoconf type- and structure-definition check macros, as well as others.</p>&#13;
<p class="indent">We also examined a technique for debugging the use of complex Autoconf macros: using picket fences around a macro invocation in <em>configure.ac</em> in order to quickly locate the associated generated text in <code>configure</code>. We looked at checks for libraries and header files, and we examined some of the details involved in the proper use of these Autoconf macros. We went into great detail about building a robust and user-friendly configuration process, including the addition of project-specific command line options to Autoconf-generated <code>configure</code> scripts.</p>&#13;
<p class="indent">Finally, we discussed the proper placement of the <code>AC_OUTPUT</code> macro in <em>configure.ac</em>, as well as the addition of some summary-generation shell code designed to help your users understand what happened during the configuration of your project on their system.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_144"/>An important Autconf concept to take away from <a href="ch04.xhtml">Chapters 4</a> and <a href="ch05.xhtml">5</a> was stated at the very start of <a href="ch04.xhtml">Chapter 4</a>: Autoconf generates shell scripts from the shell source code you write into <em>configure.ac</em>. That means you have <em>complete</em> control over what ends up in your configuration script, as long as you understand the proper use of the macros you’re invoking. In fact, you can do anything you want in <em>configure.ac</em>. Autoconf macros are there simply to make what you choose to do more consistent and simpler for you to write. The less you rely on Autoconf macros to perform configuration tasks, the less consistent your users’ configuration experiences will be relative to other open source projects they download and build.</p>&#13;
<p class="indent">The next chapter takes us away from Autoconf for a while, as we turn our attention to GNU Automake, an Autotools toolchain add-on that abstracts many of the details of creating very functional makefiles for software projects.</p>&#13;
</body></html>