<html><head></head><body>
<h2 class="h2" id="ch02"><span epub:type="pagebreak" id="page_11"/><strong><span class="big">2</span><br/>OPEN REDIRECT</strong></h2>&#13;
<div class="image1"><img alt="Image" src="../images/common.jpg"/></div>&#13;
<p class="noindent">We’ll begin our discussion with <em>open redirect</em> vulnerabilities, which occur when a target visits a website and that website sends their browser to a different URL, potentially on a separate domain. Open redirects exploit the trust of a given domain to lure targets to a malicious website. A phishing attack can also accompany a redirect to trick users into believing they’re submitting information to a trusted site when, in reality, their information is being sent to a malicious site. When combined with other attacks, open redirects can also enable attackers to distribute malware from the malicious site or to steal OAuth tokens (a topic we’ll explore in <a href="ch17.xhtml#ch17">Chapter 17</a>).</p>&#13;
<p class="indent">Because open redirects only redirect users, they’re sometimes considered low impact and not deserving of a bounty. For example, the Google bug bounty program typically considers open redirects too low risk to reward. The Open Web Application Security Project (OWASP), which is a community that focuses on application security and curates a list of the most critical security flaws in web applications, also removed open redirects from its 2017 list of top 10 vulnerabilities.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_12"/>Although open redirects are low-impact vulnerabilities, they’re great for learning how browsers handle redirects in general. In this chapter, you’ll learn how to exploit open redirects and how to identify key parameters, using three bug reports as examples.</p>&#13;
<h3 class="h3" id="ch02lev1sec1"><strong>How Open Redirects Work</strong></h3>&#13;
<p class="noindent">Open redirects occur when a developer mistrusts attacker-controlled input to redirect to another site, usually via a URL parameter, HTML <span class="literal">&lt;meta&gt;</span> refresh tags, or the DOM window location property.</p>&#13;
<p class="indent">Many websites intentionally redirect users to other sites by placing a destination URL as a parameter in an original URL. The application uses this parameter to tell the browser to send a <span class="literal">GET</span> request to the destination URL. For example, suppose Google had the functionality to redirect users to Gmail by visiting the following URL:</p>&#13;
<p class="programs">https://www.google.com/?redirect_to=https://www.gmail.com</p>&#13;
<p class="indent">In this scenario, when you visit this URL, Google receives a <span class="literal">GET</span> HTTP request and uses the <span class="literal">redirect_to</span> parameter’s value to determine where to redirect your browser. After doing so, Google servers return an HTTP response with a status code instructing the browser to redirect the user. Typically, the status code is 302, but in some cases it could be 301, 303, 307, or 308. These HTTP response codes tell your browser that a page has been found; however, the code also informs the browser to make a <span class="literal">GET</span> request to the <span class="literal">redirect_to</span> parameter’s value, <em><a href="https://www.gmail.com/">https://www.gmail.com/</a></em>, which is denoted in the HTTP response’s <span class="literal">Location</span> header. The <span class="literal">Location</span> header specifies where to redirect <span class="literal">GET</span> requests.</p>&#13;
<p class="indent">Now, suppose an attacker changed the original URL to the following:</p>&#13;
<p class="programs">https://www.google.com/?redirect_to=https://www.<span class="codeitalic1">attacker</span>.com</p>&#13;
<p class="indent">If Google isn’t validating that the <span class="literal">redirect_to</span> parameter is for one of its own legitimate sites where it intends to send visitors, an attacker could substitute the parameter with their own URL. As a result, an HTTP response could instruct your browser to make a <span class="literal">GET</span> request to <em>https://www.</em><span class="codeitalic">&lt;</span><em>attacker</em><span class="codeitalic">&gt;</span><em>.com/</em>. After the attacker has you on their malicious site, they could carry out other attacks.</p>&#13;
<p class="indent">When looking for these vulnerabilities, keep an eye out for URL parameters that include certain names, such as <span class="literal">url=</span>, <span class="literal">redirect=</span>, <span class="literal">next=</span>, and so on, which might denote URLs that users will be redirected to. Also keep in mind that redirect parameters might not always be obviously named; parameters will vary from site to site or even within a site. In some cases, parameters might be labeled with just single characters, such as <span class="literal">r=</span> or <span class="literal">u=</span>.</p>&#13;
<p class="indent">In addition to parameter-based attacks, HTML <span class="literal">&lt;meta&gt;</span> tags and JavaScript can redirect browsers. HTML <span class="literal">&lt;meta&gt;</span> tags can tell browsers to <span epub:type="pagebreak" id="page_13"/>refresh a web page and make a <span class="literal">GET</span> request to a URL defined in the tag’s <span class="literal">content</span> attribute. Here is what one might look like:</p>&#13;
<p class="programs">&lt;meta http-equiv="refresh" content="0; url=https://www.google.com/"&gt;</p>&#13;
<p class="indent">The <span class="literal">content</span> attribute defines how browsers make an HTTP request in two ways. First, the <span class="literal">content</span> attribute defines how long the browser waits before making the HTTP request to the URL; in this case, <span class="literal">0</span> seconds. Secondly, the <span class="literal">content</span> attribute specifies the URL parameter in the website the browser makes the <span class="literal">GET</span> request to; in this case, <span class="literal">https://www.google.com</span>. Attackers can use this redirect behavior in situations where they have the ability to control the <span class="literal">content</span> attribute of a <span class="literal">&lt;meta&gt;</span> tag or to inject their own tag via some other vulnerability.</p>&#13;
<p class="indent">An attacker can also use JavaScript to redirect users by modifying the window’s <span class="literal">location</span> property through the <em>Document Object Model (DOM)</em>. The DOM is an API for HTML and XML documents that allows developers to modify the structure, style, and content of a web page. Because the <span class="literal">location</span> property denotes where a request should be redirected to, browsers will immediately interpret this JavaScript and redirect to the specified URL. An attacker can modify the window’s <span class="literal">location</span> property by using any of the following JavaScript:</p>&#13;
<p class="programs">window.location = https://www.google.com/<br/>&#13;
window.location.href = https://www.google.com<br/>&#13;
window.location.replace(https://www.google.com)</p>&#13;
<p class="indent">Typically, opportunities to set the <span class="literal">window.location</span> value occur only where an attacker can execute JavaScript, either via a cross-site scripting vulnerability or where the website intentionally allows users to define a URL to redirect to, as in the HackerOne interstitial redirect vulnerability detailed later in the chapter on <a href="ch02.xhtml#page_15">page 15</a>.</p>&#13;
<p class="indent">When you’re searching for open redirect vulnerabilities, you’ll usually be monitoring your proxy history for a <span class="literal">GET</span> request sent to the site you’re testing that includes a parameter specifying a URL redirect.</p>&#13;
<h3 class="h3" id="ch02lev1sec2"><strong>Shopify Theme Install Open Redirect</strong></h3>&#13;
<p class="hangt"><strong>Difficulty:</strong> Low</p>&#13;
<p class="hang"><strong>URL:</strong> <em>https://apps.shopify.com/services/google/themes/preview/supply--blue?domain_name=&lt;anydomain&gt;</em></p>&#13;
<p class="hang"><strong>Source:</strong> <em><a href="https://www.hackerone.com/reports/101962/">https://www.hackerone.com/reports/101962/</a></em></p>&#13;
<p class="hang"><strong>Date reported:</strong> November 25, 2015</p>&#13;
<p class="hangb"><strong>Bounty paid:</strong> $500</p>&#13;
<p class="noindent">The first example of an open redirect you’ll learn about was found on Shopify, which is a commerce platform that allows people to create stores to sell goods. Shopify allows administrators to customize the look and feel of <span epub:type="pagebreak" id="page_14"/>their stores by changing their theme. As part of that functionality, Shopify offered a feature to provide a preview for the theme by redirecting the store owners to a URL. The redirect URL was formatted as such:</p>&#13;
<p class="programs">https://app.shopify.com/services/google/themes/preview/supply--blue?domain_name=<span class="codeitalic1">attacker</span>.com</p>&#13;
<p class="indent">The <span class="literal">domain_name</span> parameter at the end of the URL redirected to the user’s store domain and added <span class="literal">/admin</span> to the end of the URL. Shopify was expecting that the <span class="literal">domain_name</span> would always be a user’s store and wasn’t validating its value as part of the Shopify domain. As a result, an attacker could exploit the parameter to redirect a target to <em>http://&lt;attacker&gt;.com/admin/</em> where the malicious attacker could carry out other attacks.</p>&#13;
<h4 class="h4" id="ch02lev2sec1"><strong><em>Takeaways</em></strong></h4>&#13;
<p class="noindent">Not all vulnerabilities are complex. For this open redirect, simply changing the <span class="literal">domain_name</span> parameter to an external site would redirect the user offsite from Shopify.</p>&#13;
<h3 class="h3" id="ch02lev1sec3"><strong>Shopify Login Open Redirect</strong></h3>&#13;
<p class="hangt"><strong>Difficulty:</strong> Low</p>&#13;
<p class="hang"><strong>URL:</strong> <em><a href="http://mystore.myshopify.com/account/login/">http://mystore.myshopify.com/account/login/</a></em></p>&#13;
<p class="hang"><strong>Source:</strong> <em><a href="https://www.hackerone.com/reports/103772/">https://www.hackerone.com/reports/103772/</a></em></p>&#13;
<p class="hang"><strong>Date reported:</strong> December 6, 2015</p>&#13;
<p class="hangb"><strong>Bounty paid:</strong> $500</p>&#13;
<p class="noindent">This second example of an open redirect is similar to the first Shopify example except in this case, Shopify’s parameter isn’t redirecting the user to the domain specified by the URL parameter; instead, the open redirect tacks the parameter’s value onto the end of a Shopify subdomain. Normally, this functionality would be used to redirect a user to a specific page on a given store. However, attackers can still manipulate these URLs into redirecting the browser away from Shopify’s subdomain and to an attacker’s website by adding characters to change the meaning of the URL.</p>&#13;
<p class="indent">In this bug, after the user logged into Shopify, Shopify used the parameter <span class="literal">checkout_url</span> to redirect the user. For example, let’s say a target visited this URL:</p>&#13;
<p class="programs">http://mystore.myshopify.com/account/login?checkout_url=.<span class="codeitalic1">attacker</span>.com</p>&#13;
<p class="indent">They would have been redirected to the URL <em>http://mystore.myshopify.com.&lt;attacker&gt;.com/</em>, which isn’t a Shopify domain.</p>&#13;
<p class="indent">Because the URL ends in <em>.&lt;attacker&gt;.com</em> and DNS lookups use the rightmost domain label, the redirect goes to the <em>&lt;attacker&gt;.com</em> domain. So when <em>http://mystore.myshopify.com.&lt;attacker&gt;.com/</em> is submitted for DNS lookup, it will match on <em>&lt;attacker&gt;.com</em>, which Shopify doesn’t own, and not <em>myshopify.com</em> as <span epub:type="pagebreak" id="page_15"/>Shopify would have intended. Although an attacker wouldn’t be able to freely send a target anywhere, they could send a user to another domain by adding special characters, such as a period, to the values they can manipulate.</p>&#13;
<h4 class="h4" id="ch02lev2sec2"><strong><em>Takeaways</em></strong></h4>&#13;
<p class="noindent">If you can only control a portion of the final URL used by a site, adding special URL characters might change the meaning of the URL and redirect a user to another domain. Let’s say you can only control the <span class="literal">checkout_url</span> parameter value, and you also notice that the parameter is being combined with a hardcoded URL on the backend of the site, such as the store URL <em><a href="http://mystore.myshopify.com/">http://mystore.myshopify.com/</a></em>. Try adding special URL characters, like a period or the @ symbol, to test whether you can control the redirected location.</p>&#13;
<h3 class="h3" id="ch02lev1sec4"><strong>HackerOne Interstitial Redirect</strong></h3>&#13;
<p class="hangt"><strong>Difficulty:</strong> Low</p>&#13;
<p class="hang"><strong>URL:</strong> N/A</p>&#13;
<p class="hang"><strong>Source:</strong> <em><a href="https://www.hackerone.com/reports/111968/">https://www.hackerone.com/reports/111968/</a></em></p>&#13;
<p class="hang"><strong>Date reported:</strong> January 20, 2016</p>&#13;
<p class="hangb"><strong>Bounty paid:</strong> $500</p>&#13;
<p class="noindent">Some websites try to protect against open redirect vulnerabilities by implementing <em>interstitial web pages</em>, which display before the expected content. Any time you redirect a user to a URL, you can show an interstitial web page with a message explaining to the user that they’re leaving the domain they’re on. As a result, if the redirect page shows a fake login or tries to pretend to be the trusted domain, the user will know that they’re being redirected. This is the approach HackerOne takes when following most URLs off its site; for example, when following links in submitted reports.</p>&#13;
<p class="indent">Although you can use interstitial web pages to avoid redirect vulnerabilities, complications in the way sites interact with one another can lead to compromised links. HackerOne uses Zendesk, a customer service support ticketing system, for its <em><a href="https://support.hackerone.com/">https://support.hackerone.com/</a></em> subdomain. Previously, when you followed <em><a href="http://hackerone.com">hackerone.com</a></em> with <em>/zendesk_session</em>, the browser redirected from HackerOne’s platform to HackerOne’s Zendesk platform without an interstitial page because URLs containing the <em><a href="http://hackerone.com">hackerone.com</a></em> domain were trusted links. (HackerOne now redirects <em><a href="https://support.hackerone.com">https://support.hackerone.com</a></em> to <em><a href="http://docs.hackerone.com">docs.hackerone.com</a></em> unless you are submitting a support request via the URL <em>/hc/en-us/requests/new</em>.) However, anyone could create custom Zendesk accounts and pass them to the <span class="literal">/redirect_to_account?state=</span> parameter. The custom Zendesk account could then redirect to another website not owned by Zendesk or HackerOne. Because Zendesk allowed for redirecting between accounts without interstitial pages, the user could be taken to the untrusted site without warning. As a solution, HackerOne identified links containing <span class="literal">zendesk_session</span> as external links, thereby rendering an interstitial warning page when clicked.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_16"/>In order to confirm this vulnerability, the hacker Mahmoud Jamal created an account on Zendesk with the subdomain <em><a href="http://compayn.zendesk.com">http://compayn.zendesk.com</a></em>. He then added the following JavaScript code to the header file using the Zendesk theme editor, which allows administrators to customize their Zendesk site’s look and feel:</p>&#13;
<p class="programs">&lt;script&gt;document.location.href = «http://evil.com»;&lt;/script&gt;</p>&#13;
<p class="indent">Using this JavaScript, Jamal instructed the browser to visit <em><a href="http://evil.com">http://evil.com</a></em>. The <span class="literal">&lt;script&gt;</span> tag denotes code in HTML and <span class="literal">document</span> refers to the entire HTML document that Zendesk returns, which is the information for the web page. The dots and names following <span class="literal">document</span> are its properties. Properties hold information and values that either describe an object or can be manipulated to change the object. So you can use the <span class="literal">location</span> property to control the web page your browser displays and use the <span class="literal">href</span> subproperty (which is a property of the <span class="literal">location</span>) to redirect the browser to the defined website. Visiting the following link redirected targets to Jamal’s Zendesk subdomain, which made the target’s browser run Jamal’s script and redirected them to <em><a href="http://evil.com">http://evil.com</a></em>:</p>&#13;
<p class="programs">https://hackerone.com/zendesk_session?locale_id=1&amp;return_to=https://support.hackerone.com/<br/>&#13;
ping/redirect_to_account?state=compayn:/</p>&#13;
<p class="indent">Because the link includes the domain <em><a href="http://hackerone.com">hackerone.com</a></em>, the interstitial web page doesn’t display, and the user wouldn’t know the page they were visiting is unsafe. Interestingly, Jamal originally reported the missing interstitial page redirect issue to Zendesk, but it was disregarded and not marked as a vulnerability. Naturally, he kept digging to see how the missing interstitial could be exploited. Eventually, he found the JavaScript redirect attack that convinced HackerOne to pay him a bounty.</p>&#13;
<h4 class="h4" id="ch02lev2sec3"><strong><em>Takeaways</em></strong></h4>&#13;
<p class="noindent">As you search for vulnerabilities, note the services a site uses because each represents new attack vectors. This HackerOne vulnerability was made possible by combining HackerOne’s use of Zendesk and the known redirect HackerOne was permitting.</p>&#13;
<p class="indent">Additionally, as you find bugs, there will be times when the security implications aren’t readily understood by the person reading and responding to your report. For this reason, I’ll discuss vulnerability reports in <a href="ch19.xhtml#ch19">Chapter 19</a>, which details the findings you should include in a report, how to build relationships with companies, and other information. If you do some work up front and respectfully explain the security implications in your report, your efforts will help ensure a smoother resolution.</p>&#13;
<p class="indent">That said, there will be times when companies don’t agree with you. If that’s the case, continue to dig like Jamal did and see if you can prove the exploit or combine it with another vulnerability to demonstrate impact.</p>&#13;
<h3 class="h3" id="ch02lev1sec5"><span epub:type="pagebreak" id="page_17"/><strong>Summary</strong></h3>&#13;
<p class="noindent">Open redirects allow a malicious attacker to redirect people unknowingly to a malicious website. Finding them, as you learned from the example bug reports, often requires keen observation. Redirect parameters are sometimes easy to spot when they have names like <span class="literal">redirect_to=</span>, <span class="literal">domain_name=</span>, or <span class="literal">checkout_url=</span>, as mentioned in the examples. Other times, they might have less obvious names, such as <span class="literal">r=</span>, <span class="literal">u=</span>, and so on.</p>&#13;
<p class="indent">The open redirect vulnerability relies on an abuse of trust where targets are tricked into visiting an attacker’s site while thinking they’re visiting a site they recognize. When you spot likely vulnerable parameters, be sure to test them thoroughly and add special characters, like a period, if some part of the URL is hardcoded.</p>&#13;
<p class="indent">The HackerOne interstitial redirect shows the importance of recognizing the tools and services websites use while you hunt for vulnerabilities. Keep in mind that you’ll sometimes need to be persistent and clearly demonstrate a vulnerability to persuade a company to accept your findings and pay a bounty.<span epub:type="pagebreak" id="page_18"/></p>&#13;
</body></html>