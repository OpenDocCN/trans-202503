<html><head></head><body>
<section epub:type="appendix" role="doc-appendix" aria-labelledby="appB">&#13;
<span role="doc-pagebreak" epub:type="pagebreak" id="pg_423" aria-label="423"/>&#13;
<hgroup>&#13;
&#13;
<h1 class="CHAPTER" id="appB">&#13;
<span class="APN"><samp class="SANS_Futura_Std_Bold_Condensed_B_11">B</samp></span>&#13;
<span class="APT"><samp class="SANS_Dogma_OT_Bold_B_11">WINDOWS FUNCTIONS USED FOR EVASION</samp></span>&#13;
</h1>&#13;
</hgroup>&#13;
<figure class="opener"><img class="opener" src="../images/opener.jpg" alt=""/></figure>&#13;
<p class="TNI2">This appendix describes Windows functions that are commonly used for some of the evasion techniques discussed in this book. While it’s not a comprehensive list of functions that might be abused by threat actors, these are some of the ones I believe are the most interesting or important to be familiar with for the purposes of malware analysis.</p>&#13;
<p class="TX">Note that the functions are written without their <i>A</i> and <i>W</i> suffixes. For example, <samp class="SANS_TheSansMonoCd_W5Regular_11">CreateFileW</samp> is listed only as <samp class="SANS_TheSansMonoCd_W5Regular_11">CreateFile</samp>. Also, some functions have both an <i>Nt</i> and a <i>Zw</i> variant, such as <samp class="SANS_TheSansMonoCd_W5Regular_11">NtLoadDriver</samp> and <samp class="SANS_TheSansMonoCd_W5Regular_11">ZwLoadDriver</samp>, but only the <i>Nt</i> variant is listed here. For more information on these variations, see <span class="Xref"><a href="chapter1.xhtml">Chapter 1</a></span>.</p>&#13;
<p class="TX">You can find a more complete list of commonly abused functions at <a href="https://malapi.io"><i>https://<wbr/>malapi<wbr/>.io</i></a>.</p>&#13;
<p class="GlossaryTerm"><span role="doc-pagebreak" epub:type="pagebreak" id="pg_424" aria-label="424"/><samp class="SANS_TheSansMonoCd_W7Bold_B_11">AddAtom</samp></p>&#13;
<p class="GlossaryDefinition">Adds a string to the local atom table. Can be used as part of certain process injection techniques, such as atom bombing.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">AddVectoredExceptionHandler</samp></p>&#13;
<p class="GlossaryDefinition">Registers a new vectored exception handler. Can be used to abuse exceptions for the purposes of anti-analysis and anti-debugging. An alternative function is <samp class="SANS_TheSansMonoCd_W5Regular_11">RtlAddVectoredExceptionHandler</samp>.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">AdjustTokenPrivileges</samp></p>&#13;
<p class="GlossaryDefinition">Enables or disables privileges of an access token. Can be abused to elevate privileges.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">BCrypt*</samp></p>&#13;
<p class="GlossaryDefinition">See the <samp class="SANS_TheSansMonoCd_W5Regular_11">Crypt*</samp> functions. All functions that begin with <samp class="SANS_TheSansMonoCd_W5Regular_11">BCrypt*</samp> (such as <samp class="SANS_TheSansMonoCd_W5Regular_11">BCryptEncrypt</samp> and <samp class="SANS_TheSansMonoCd_W5Regular_11">BCryptDestroyKey</samp>) align to their equivalent <samp class="SANS_TheSansMonoCd_W5Regular_11">Crypt*</samp> function (such as <samp class="SANS_TheSansMonoCd_W5Regular_11">CryptEncrypt</samp> and <samp class="SANS_TheSansMonoCd_W5Regular_11">CryptDestroyKey</samp>).</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">BlockInput</samp></p>&#13;
<p class="GlossaryDefinition">Blocks input from reaching applications. Can be used as an anti-debugging technique to block interaction with the debugger.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">CallNtPowerInformation</samp></p>&#13;
<p class="GlossaryDefinition">Returns information such as the battery state and last sleep time, which can be used to infer if the system is a VM.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">CheckRemoteDebuggerPresent</samp></p>&#13;
<p class="GlossaryDefinition">Returns a nonzero value if the current process is being debugged; otherwise, returns zero. Can be used to detect a debugger in use.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">CloseHandle</samp></p>&#13;
<p class="GlossaryDefinition">Closes an open handle. Can be used as an anti-debugging technique to crash certain debuggers under specific circumstances. An alternative is the now-deprecated <samp class="SANS_TheSansMonoCd_W5Regular_11">NtClose</samp> function.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">CreateFile</samp></p>&#13;
<p class="GlossaryDefinition">Gets a handle to a file or creates a new file. Can be used for many purposes, including VM and sandbox detection (to search for hypervisor-related files and pipes, for example). An alternative is the <samp class="SANS_TheSansMonoCd_W5Regular_11">NtCreateFile</samp> function.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">CreateFileTransacted</samp></p>&#13;
<p class="GlossaryDefinition">Creates or opens a file as an NTFS transacted operation. Can be used for process manipulation, such as process doppelganging.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">CreateMutex(Ex)</samp></p>&#13;
<p class="GlossaryDefinition">Opens a mutex object or creates a new mutex. Can be used to enumerate mutexes related to hypervisors as a VM and sandbox detection technique.</p>&#13;
<p class="GlossaryTerm"><span role="doc-pagebreak" epub:type="pagebreak" id="pg_425" aria-label="425"/><samp class="SANS_TheSansMonoCd_W7Bold_B_11">CreateProcess</samp></p>&#13;
<p class="GlossaryDefinition">Creates a new process and is often called as part of process injection or during unpacking. Alternatives are the <samp class="SANS_TheSansMonoCd_W5Regular_11">NtCreateProcess(Ex)</samp>, <samp class="SANS_TheSansMonoCd_W5Regular_11">CreateProcessInternal</samp>, and <samp class="SANS_TheSansMonoCd_W5Regular_11">NtCreateUserProcess</samp> functions.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">CreateProcessWithToken</samp></p>&#13;
<p class="GlossaryDefinition">Creates a new process, assigning it the permissions of an existing token. Can be abused for privilege elevation and defense evasion.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">CreateRemoteThread</samp></p>&#13;
<p class="GlossaryDefinition">Executes a new thread in the address space of another process and is often used as part of various process injection techniques. Alternatives include the <samp class="SANS_TheSansMonoCd_W5Regular_11">NtCreateThreadEx</samp> and <samp class="SANS_TheSansMonoCd_W5Regular_11">RtlCreateUserThread</samp> functions.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">CreateService</samp></p>&#13;
<p class="GlossaryDefinition">Creates a service. Can be used for persistence or for loading malicious kernel modules.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">CreateToolhelp32Snapshot</samp></p>&#13;
<p class="GlossaryDefinition">Creates a snapshot of the currently running processes on the system. Can be used to locate processes on the system for injection or for VM detection. Typically called before <samp class="SANS_TheSansMonoCd_W5Regular_11">GetProcess32First</samp> and <samp class="SANS_TheSansMonoCd_W5Regular_11">GetProcess32Next</samp>.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">CreateTransaction</samp></p>&#13;
<p class="GlossaryDefinition">Creates a new NTFS transaction object. An alternative is the <samp class="SANS_TheSansMonoCd_W5Regular_11">NtCreateTransaction</samp> function. <i>See also</i> <samp class="SANS_TheSansMonoCd_W5Regular_11">CreateFileTransacted</samp>.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">Crypt*</samp></p>&#13;
<p class="GlossaryDefinition">Functions that begin with <samp class="SANS_TheSansMonoCd_W5Regular_11">Crypt</samp> (such as <samp class="SANS_TheSansMonoCd_W5Regular_11">CryptEncrypt</samp>, <samp class="SANS_TheSansMonoCd_W5Regular_11">CryptDecrypt</samp>, and <samp class="SANS_TheSansMonoCd_W5Regular_11">CryptCreateHash</samp>) are used for various cryptographic operations, such as encrypting and hashing data, often for the purposes of obfuscation and defense evasion.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">DebugActiveProcess</samp></p>&#13;
<p class="GlossaryDefinition">Enables a debugger to attach to an active process. Can be used to detect a debugger.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">DeleteFile</samp></p>&#13;
<p class="GlossaryDefinition">Deletes a file or directory. Can be used to hide artifacts on disk by removing them. An alternative is the <samp class="SANS_TheSansMonoCd_W5Regular_11">NtDeleteFile</samp> function.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">DeviceIOControl</samp></p>&#13;
<p class="GlossaryDefinition">Allows a process in user space to send a control code to a driver in kernel space. Often used by rootkits to send control codes to malicious kernel drivers.</p>&#13;
<p class="GlossaryTerm"><span role="doc-pagebreak" epub:type="pagebreak" id="pg_426" aria-label="426"/><samp class="SANS_TheSansMonoCd_W7Bold_B_11">DsGetDcName</samp></p>&#13;
<p class="GlossaryDefinition">Retrieves the name of the system’s domain controller and is often used to detect if the system is part of a domain for context awareness, targeting, or sandbox detection purposes.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">DuplicateToken(Ex)</samp></p>&#13;
<p class="GlossaryDefinition">Creates a “copy” of a token assigned to another process. Often followed by a call to a function such as <samp class="SANS_TheSansMonoCd_W5Regular_11">ImpersonateLoggedOnUser</samp> as part of privilege elevation and defense evasion.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">EnumDisplayMonitors</samp></p>&#13;
<p class="GlossaryDefinition">Identifies the number of monitors configured on the system to infer if the system is a VM or sandbox.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">EnumServiceStatus(Ex)</samp></p>&#13;
<p class="GlossaryDefinition">Enumerates services on the system. Can be used to identify hypervisor-related services for VM detection.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">EnumSystemFirmwareTables</samp></p>&#13;
<p class="GlossaryDefinition">Enumerates system firmware tables. Can be used to identify hardware on the system and detect a VM.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">EnumWindows</samp></p>&#13;
<p class="GlossaryDefinition">Enumerates open windows. Can be used to detect malware analysis tools and debuggers.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">ExitProcess</samp></p>&#13;
<p class="GlossaryDefinition">Ends a process and can be used as an anti-analysis technique.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">ExitWindows(Ex)</samp></p>&#13;
<p class="GlossaryDefinition">Logs out of the current user account or shuts down the system. Can be used as an anti-analysis and anti-sandbox technique.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">FindFirstFile(Ex)</samp></p>&#13;
<p class="GlossaryDefinition">Enumerates files on the filesystem. Can be used to locate hypervisor-related files for VM and sandbox detection. Called prior to <samp class="SANS_TheSansMonoCd_W5Regular_11">FindNextFile</samp>, which iterates through each file on the system.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">FindFirstUrlCacheEntry(Ex)</samp></p>&#13;
<p class="GlossaryDefinition">Enumerates the browser cache. Lack of browser cache data could indicate a VM or sandbox environment. Called prior to <samp class="SANS_TheSansMonoCd_W5Regular_11">FindNextUrlCacheEntry(Ex)</samp>.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">FindWindow(Ex)</samp></p>&#13;
<p class="GlossaryDefinition">Locates a certain window, such as a specific analysis tool or debugger.</p>&#13;
<p class="GlossaryTerm"><span role="doc-pagebreak" epub:type="pagebreak" id="pg_427" aria-label="427"/><samp class="SANS_TheSansMonoCd_W7Bold_B_11">FltEnumerateFilters</samp></p>&#13;
<p class="GlossaryDefinition">Can be used by rootkits to enumerate minifilter drivers in the system, sometimes in preparation for installing a hook. Alternatives are the <samp class="SANS_TheSansMonoCd_W5Regular_11">FltEnumerateInstances</samp> and <samp class="SANS_TheSansMonoCd_W5Regular_11">FltGetFilterFromName</samp> functions.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">FltRegisterFilter</samp></p>&#13;
<p class="GlossaryDefinition">Registers a new minifilter driver. May be seen in rootkits that attempt to install minifilter drivers.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetAdaptersAddresses</samp></p>&#13;
<p class="GlossaryDefinition">Retrieves the IP and MAC addresses of the host’s network interfaces. Can be abused for VM and sandbox detection.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetAsyncKeyState</samp></p>&#13;
<p class="GlossaryDefinition">Retrieves a certain keyboard key state. Can be used for sandbox evasion (for example, to wait for a certain keypress).</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetComputerName(Ex)</samp></p>&#13;
<p class="GlossaryDefinition">Retrieves the computer name of the system and is sometimes used to identify sandbox-related computer names.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetCursorPos</samp></p>&#13;
<p class="GlossaryDefinition">Gets the current mouse cursor position. Can be used for human-interaction detection for sandbox evasion purposes.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetDiskFreeSpace(Ex)</samp></p>&#13;
<p class="GlossaryDefinition">Returns the free disk space on the system and can be used to detect an analysis environment, especially if the VM is configured with a small amount of disk space.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetForegroundWindow</samp></p>&#13;
<p class="GlossaryDefinition">Gets information about the active foreground window and is sometimes used for analysis tool detection or sandbox evasion.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetKeyboardLayout</samp></p>&#13;
<p class="GlossaryDefinition">Returns the active keyboard language of the host and is sometimes used for target profiling.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetKeyboardLayoutList</samp></p>&#13;
<p class="GlossaryDefinition">Returns a complete list of all keyboard languages that are installed on the host.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetLastError</samp></p>&#13;
<p class="GlossaryDefinition">Retrieves the calling thread’s last error value. Can be used in combination with <samp class="SANS_TheSansMonoCd_W5Regular_11">SetLastError</samp> and <samp class="SANS_TheSansMonoCd_W5Regular_11">OutputDebugString</samp> to detect debuggers and for other anti-analysis purposes.</p>&#13;
<p class="GlossaryTerm"><span role="doc-pagebreak" epub:type="pagebreak" id="pg_428" aria-label="428"/><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetLocalTime</samp></p>&#13;
<p class="GlossaryDefinition">Gets the current date and time of the system. Can be used to detect debugging or for other anti-analysis techniques, such as time bombing.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetLogicalProcessorInformation(Ex)</samp></p>&#13;
<p class="GlossaryDefinition">Returns information about the system’s processor. Can be used to identify a VM or sandbox environment.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetModuleFileName(Ex)</samp></p>&#13;
<p class="GlossaryDefinition">Retrieves the path for the file that contains a specific module, or retrieves the path of the executable file of the current process. Can be used to enumerate loaded modules, such as anomalous modules injected by analysis tools, or to retrieve its own executable’s path.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetModuleHandle(Ex)</samp></p>&#13;
<p class="GlossaryDefinition">Returns a handle to a loaded module.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetPhysicallyInstalledSystemMemory</samp></p>&#13;
<p class="GlossaryDefinition">Returns the amount of physical system memory. Can be abused to identify a VM or sandbox environment.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetProcAddress</samp></p>&#13;
<p class="GlossaryDefinition">Gets the procedure address of a function. Can be combined with <samp class="SANS_TheSansMonoCd_W5Regular_11">LoadLibrary</samp> to dynamically load libraries and functions for endpoint defense evasion and anti-analysis.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetSystemFirmwareTable</samp></p>&#13;
<p class="GlossaryDefinition">Retrieves various firmware tables from the system. Can be used to search for hypervisor-related firmware as a VM and sandbox detection technique. An alternative is the <samp class="SANS_TheSansMonoCd_W5Regular_11">EnumSystemFirmwareTables</samp> function.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetSystemInfo</samp></p>&#13;
<p class="GlossaryDefinition">Returns information about the system. Can be used to detect a VM environment.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetSystemMetrics</samp></p>&#13;
<p class="GlossaryDefinition">Returns information about system metrics and configurations.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetSystemTime</samp></p>&#13;
<p class="GlossaryDefinition"><i>See</i> <samp class="SANS_TheSansMonoCd_W5Regular_11">GetLocalTime</samp>.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetTcpTable</samp></p>&#13;
<p class="GlossaryDefinition">Returns the system’s IPv4 TCP connection table. May be used to detect a VM or sandbox that isn’t connected to a network or the internet.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetThreadContext</samp></p>&#13;
<p class="GlossaryDefinition">Retrieves the context of the current thread. Can be used for detecting hardware breakpoints. An alternative is the <samp class="SANS_TheSansMonoCd_W5Regular_11">Wow64GetThreadContext</samp> function.</p>&#13;
<p class="GlossaryTerm"><span role="doc-pagebreak" epub:type="pagebreak" id="pg_429" aria-label="429"/><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetThreadLocale</samp></p>&#13;
<p class="GlossaryDefinition">Returns locale information about a running thread, such as the language in use. Can be used for target profiling.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetTickCount</samp></p>&#13;
<p class="GlossaryDefinition">Retrieves the number of milliseconds that have elapsed since the system was started. Can be used for many anti-analysis techniques, such as debugger detection. An alternative is the <samp class="SANS_TheSansMonoCd_W5Regular_11">GetTickCount64</samp> function.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetUserDefaultUILanguage</samp></p>&#13;
<p class="GlossaryDefinition">Returns the currently logged-in user’s interface language. Can be used for the same purposes as <samp class="SANS_TheSansMonoCd_W5Regular_11">GetThreadLocale</samp>. Alternatives are the <samp class="SANS_TheSansMonoCd_W5Regular_11">GetSystemDefaultUILanguage</samp>, <samp class="SANS_TheSansMonoCd_W5Regular_11">GetSystemDefaultLCID</samp>, <samp class="SANS_TheSansMonoCd_W5Regular_11">GetUserDefaultLCID,</samp> and <samp class="SANS_TheSansMonoCd_W5Regular_11">GetProcessPreferredUILanguages</samp> functions.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetVersion(Ex)</samp></p>&#13;
<p class="GlossaryDefinition">Retrieves the version information for the operating system. Can be used for target profiling.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GetWindowText</samp></p>&#13;
<p class="GlossaryDefinition">Obtains the title text of the window. Can be used to detect malware analysis tools.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GlobalAddAtom(Ex)</samp></p>&#13;
<p class="GlossaryDefinition">Adds a string to the global atom table. <i>See also</i> <samp class="SANS_TheSansMonoCd_W5Regular_11">AddAtom</samp>.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">GlobalGetAtomName</samp></p>&#13;
<p class="GlossaryDefinition">Retrieves the string in the specified global atom. <i>See also</i> <samp class="SANS_TheSansMonoCd_W5Regular_11">AddAtom</samp>.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">ImpersonateLoggedOnUser</samp></p>&#13;
<p class="GlossaryDefinition">Allows the calling thread to impersonate the security context of the logged-in user. <i>See also</i> <samp class="SANS_TheSansMonoCd_W5Regular_11">DuplicateToken(Ex)</samp>.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">InitiateShutdown</samp></p>&#13;
<p class="GlossaryDefinition">Shuts down and restarts the system. Can be used as an anti-analysis and anti-sandbox technique. An alternative is the <samp class="SANS_TheSansMonoCd_W5Regular_11">InitiateSystemShutdown(Ex)</samp> function.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">InternetConnect</samp></p>&#13;
<p class="GlossaryDefinition">Opens an FTP or HTTP internet connection. Can be used for many different evasion techniques, such as identifying whether or not a system is connected to the internet to detect a sandbox or VM. Often used in combination with <samp class="SANS_TheSansMonoCd_W5Regular_11">InternetOpen</samp> and <samp class="SANS_TheSansMonoCd_W5Regular_11">InternetReadFile</samp>.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">IsDebuggerPresent</samp></p>&#13;
<p class="GlossaryDefinition">Checks whether the calling process is being debugged. <i>See also</i> <samp class="SANS_TheSansMonoCd_W5Regular_11">CheckRemoteDebuggerPresent</samp>.</p>&#13;
<p class="GlossaryTerm"><span role="doc-pagebreak" epub:type="pagebreak" id="pg_430" aria-label="430"/><samp class="SANS_TheSansMonoCd_W7Bold_B_11">IsProcessorFeaturePresent</samp></p>&#13;
<p class="GlossaryDefinition">Returns the status of various processor features, which can indicate a VM.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">LoadLibrary</samp></p>&#13;
<p class="GlossaryDefinition">Loads a module into the process address space of the calling process. <i>See also</i> <samp class="SANS_TheSansMonoCd_W5Regular_11">GetProcAddress</samp>.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">Module32First</samp></p>&#13;
<p class="GlossaryDefinition">Gets information about the first module loaded into a process. Can be used in combination with <samp class="SANS_TheSansMonoCd_W5Regular_11">Module32Next</samp> to enumerate and identify modules associated with analysis tools.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">NtCreateTransaction</samp></p>&#13;
<p class="GlossaryDefinition">Creates a new NTFS transaction object. Can be used for process manipulation techniques, such as process doppelganging.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">NtLoadDriver</samp></p>&#13;
<p class="GlossaryDefinition">Loads a driver into the system. Can be invoked to load a malicious kernel module.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">NtMapViewOfSection</samp></p>&#13;
<p class="GlossaryDefinition">Maps a view of a section into the process address space of a target process. Can be used to manually map a library or code into memory as part of process injection.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">NtOpenDirectoryObject</samp></p>&#13;
<p class="GlossaryDefinition">Can be used to query device and driver objects on the system. Sometimes used to locate VM-related artifacts as part of VM detection. An alternative is the <samp class="SANS_TheSansMonoCd_W5Regular_11">NtQueryDirectoryObject</samp> function.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">NtQueryInformationProcess</samp></p>&#13;
<p class="GlossaryDefinition">Returns a great deal of information about a target process. Can be used to identify attached debuggers.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">NtQueryObject</samp></p>&#13;
<p class="GlossaryDefinition">Returns information on different operating system objects. Can be used to identify debugger objects, indicating to the malware that it is being debugged.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">NtQuerySystemInformation</samp></p>&#13;
<p class="GlossaryDefinition">Returns a lot of different system information. Can be used to enumerate firmware tables to identify a VM or sandbox.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">NtQuerySystemTime</samp></p>&#13;
<p class="GlossaryDefinition"><i>See</i> <samp class="SANS_TheSansMonoCd_W5Regular_11">GetLocalTime</samp>.</p>&#13;
<p class="GlossaryTerm"><span role="doc-pagebreak" epub:type="pagebreak" id="pg_431" aria-label="431"/><samp class="SANS_TheSansMonoCd_W7Bold_B_11">NtSetInformationThread</samp></p>&#13;
<p class="GlossaryDefinition">Sets the priority of a thread. Can be used to hide code execution from a debugger or, in certain circumstances, to crash the debugger.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">NtUnmapViewOfSection</samp></p>&#13;
<p class="GlossaryDefinition">Unmaps a view of a section from memory. Sometimes used as part of process injection techniques.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">OpenMutex</samp></p>&#13;
<p class="GlossaryDefinition">Opens a mutex object. <i>See also</i> <samp class="SANS_TheSansMonoCd_W5Regular_11">CreateMutex</samp>.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">OpenProcess</samp></p>&#13;
<p class="GlossaryDefinition">Opens a process object and is often a precursor to process injection. An alternative is the <samp class="SANS_TheSansMonoCd_W5Regular_11">NtOpenProcess</samp> function.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">OpenProcessToken</samp></p>&#13;
<p class="GlossaryDefinition">Opens the access token of a process and is often a precursor to techniques such as privilege elevation. <i>See also</i> <samp class="SANS_TheSansMonoCd_W5Regular_11">AdjustTokenPrivileges</samp>.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">OpenService</samp></p>&#13;
<p class="GlossaryDefinition">Opens a service. Can be used to identify services related to sandboxes and hypervisors.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">OpenThread</samp></p>&#13;
<p class="GlossaryDefinition">Opens a thread object. Can be used for process injection techniques, such as thread hijacking.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">OutputDebugString</samp></p>&#13;
<p class="GlossaryDefinition">Sends a string to the debugger. Can be used for anti-debugging purposes. <i>See also</i> <samp class="SANS_TheSansMonoCd_W5Regular_11">GetLastError</samp>.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">PostMessage</samp></p>&#13;
<p class="GlossaryDefinition">Closes application windows when the parameter <samp class="SANS_TheSansMonoCd_W5Regular_11">WS_CLOSE</samp> is passed to the window’s handle. Can be used as an anti-analysis technique.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">Process32First</samp></p>&#13;
<p class="GlossaryDefinition">Gathers information about the first process in a process snapshot. <i>See also</i> <samp class="SANS_TheSansMonoCd_W5Regular_11">CreateToolhelp32Snapshot</samp>.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">Process32Next</samp></p>&#13;
<p class="GlossaryDefinition">Gathers information about the next process in a process snapshot. <i>See also</i> <samp class="SANS_TheSansMonoCd_W5Regular_11">CreateToolhelp32Snapshot</samp>.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">PsLookupProcessByProcessID</samp></p>&#13;
<p class="GlossaryDefinition">Gets a pointer to a process’s <samp class="SANS_TheSansMonoCd_W5Regular_11">EPROCESS</samp> structure. Sometimes used by rootkits in preparation for evasion techniques such as DKOM.</p>&#13;
<p class="GlossaryTerm"><span role="doc-pagebreak" epub:type="pagebreak" id="pg_432" aria-label="432"/><samp class="SANS_TheSansMonoCd_W7Bold_B_11">PsSetCreateProcessNotifyRoutine(Ex)</samp></p>&#13;
<p class="GlossaryDefinition">Registers a driver callback that will be triggered when any new process is created or terminated. Sometimes used by rootkits to monitor process creations.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">PsSetCreateThreadNotifyRoutine(Ex)</samp></p>&#13;
<p class="GlossaryDefinition">Similar to <samp class="SANS_TheSansMonoCd_W5Regular_11">PsSetCreateProcessNotifyRoutine(Ex)</samp>, but for thread creation.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">PsSetLoadImageNotifyRoutine(Ex)</samp></p>&#13;
<p class="GlossaryDefinition">Registers a callback that will be triggered when a process loads an image into memory, such as a DLL module, or when a new driver is loaded. Sometimes used by rootkits to monitor module loads.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">QueryPerformanceCounter</samp></p>&#13;
<p class="GlossaryDefinition">Queries the processor’s performance counter and returns the current value. Can be used as part of anti-debugging and VM detection techniques.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">QueueUserAPC</samp></p>&#13;
<p class="GlossaryDefinition">Queues a new asynchronous procedure call and is sometimes invoked for process injection techniques, such as APC injection. An alternative function is <samp class="SANS_TheSansMonoCd_W5Regular_11">NtQueueApcThread</samp>.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">ReadProcessMemory</samp></p>&#13;
<p class="GlossaryDefinition">Reads data from a memory region inside a target process. Can be used for many reasons, such as inspecting process memory for hooks as part of anti-hooking techniques. An alternative is the <samp class="SANS_TheSansMonoCd_W5Regular_11">NtReadVirtualMemory</samp> function.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">RegEnumKey(Ex)</samp></p>&#13;
<p class="GlossaryDefinition">Enumerates a registry key. Can be used for VM detection or to otherwise identify registry keys of interest.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">RegEnumValue</samp></p>&#13;
<p class="GlossaryDefinition">Enumerates a registry key value.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">RegOpenKey(Ex)</samp></p>&#13;
<p class="GlossaryDefinition">Opens a registry key for reading or writing.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">ResumeThread</samp></p>&#13;
<p class="GlossaryDefinition">Resumes execution of a thread and is often used for process injection, such as process hollowing. An alternative is the <samp class="SANS_TheSansMonoCd_W5Regular_11">NtResumeThread</samp> function.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">RollbackTransaction</samp></p>&#13;
<p class="GlossaryDefinition">Rolls back an NTFS transaction and is used for process manipulation, such as in the process-doppelganging technique.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">RtlCopyMemory</samp></p>&#13;
<p class="GlossaryDefinition">Copies the contents of a source buffer in memory to another memory region. Can be invoked to write malicious code into memory, such as injecting a hook.</p>&#13;
<p class="GlossaryTerm"><span role="doc-pagebreak" epub:type="pagebreak" id="pg_433" aria-label="433"/><samp class="SANS_TheSansMonoCd_W7Bold_B_11">RtlQueryProcessHeapInformation</samp></p>&#13;
<p class="GlossaryDefinition">Returns information about the current process’s heap. Can be used to detect a debugger.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">RtlZeroMemory</samp></p>&#13;
<p class="GlossaryDefinition">Fills a region of memory with zeros. Can be used as an anti-forensics and defense evasion technique.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">SetFileAttributes</samp></p>&#13;
<p class="GlossaryDefinition">Sets various attributes for a file or directory. Can be used to hide files and directories via the <samp class="SANS_TheSansMonoCd_W5Regular_11">hidden</samp> attribute.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">SetFileTime</samp></p>&#13;
<p class="GlossaryDefinition">Sets various timestamps for a file or directory. Can be used to falsify file timestamps (timestomping).</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">SetPriorityClass</samp></p>&#13;
<p class="GlossaryDefinition">Sets the priority of a process. Can be abused to lower the priority of endpoint defense processes in an attempt to circumvent them.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">SetThreadContext</samp></p>&#13;
<p class="GlossaryDefinition">Sets the context of a thread and is sometimes used for process injection techniques, specifically process hollowing.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">SetUnhandledExceptionFilter</samp></p>&#13;
<p class="GlossaryDefinition">Allows the calling program to supersede the top-level exception handler. Can be used as part of anti-debugging and covert code execution techniques.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">SetWindowsHookEx</samp></p>&#13;
<p class="GlossaryDefinition">Installs an application-defined hook. Can be used for multiple purposes, such as hooking keyboard and mouse events and injecting malicious code.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">Sleep(Ex)</samp></p>&#13;
<p class="GlossaryDefinition">Suspends the execution of a thread for a specified amount of time. Can be used for many malicious purposes, such as sandbox evasion and various anti-debugging techniques.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">StartService</samp></p>&#13;
<p class="GlossaryDefinition">Starts a service on the system. Can be used to establish persistence or load a malicious module.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">SuspendThread</samp></p>&#13;
<p class="GlossaryDefinition">Suspends a thread and is used in certain process injection techniques, such as thread hijacking. An alternative is the <samp class="SANS_TheSansMonoCd_W5Regular_11">Wow64SuspendThread</samp> function.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">TerminateProcess</samp></p>&#13;
<p class="GlossaryDefinition">Terminates a specified process. Can be used as an anti-analysis technique.</p>&#13;
<p class="GlossaryTerm"><span role="doc-pagebreak" epub:type="pagebreak" id="pg_434" aria-label="434"/><samp class="SANS_TheSansMonoCd_W7Bold_B_11">VirtualAlloc(Ex)</samp></p>&#13;
<p class="GlossaryDefinition">Allocates (reserves or commits) a region of virtual memory and is part of various process injection techniques. An alternative is the <samp class="SANS_TheSansMonoCd_W5Regular_11">NtAllocateVirtualMemory</samp> function.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">VirtualQuery(Ex)</samp></p>&#13;
<p class="GlossaryDefinition">Returns information about a region of memory. Can be used to detect hardware and memory breakpoints. An alternative is the <samp class="SANS_TheSansMonoCd_W5Regular_11">NtQueryVirtualMemory</samp> function.</p>&#13;
<p class="GlossaryTerm"><samp class="SANS_TheSansMonoCd_W7Bold_B_11">WriteProcessMemory</samp></p>&#13;
<p class="GlossaryDefinition">Writes data to a region of memory in a process and is used as part of various process injection techniques. An alternative is the <samp class="SANS_TheSansMonoCd_W5Regular_11">NtWriteVirtualMemory</samp> function.</p>&#13;
</section>&#13;
</body></html>