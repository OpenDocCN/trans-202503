<html><head></head><body>
<div id="sbo-rt-content"><section aria-labelledby="ch28" epub:type="chapter" role="doc-chapter">
<span aria-label="541" epub:type="pagebreak" id="pg_541" role="doc-pagebreak"/>
<hgroup>
<h2 class="CHAPTER" id="ch28">
<span class="CN"><span class="SANS_Futura_Std_Bold_Condensed_B_11">28</span></span>
<span class="CT"><span class="SANS_Dogma_OT_Bold_B_11">DATABASE PROGRAMMING WITH THE PDO LIBRARY</span></span>
</h2>
</hgroup>
<figure class="opener"><img alt="" class="opener" height="380" src="../images/opener.jpg" width="380"/>
</figure>
<p class="INTRO">Incorporating a database into a web application requires writing code to perform operations such as opening a connection to the database system; creating a database and its table structure; manipulating database data through insertions, deletions, and updates; and querying and retrieving data matching your desired criteria. In this chapter, you’ll learn about the PHP Data Objects (PDO) library, which makes it easy to carry out these sorts of database operations. We’ll use the library to progressively develop a simple, multipage web application that pulls information from a database.</p>
<section aria-labelledby="sec1" epub:type="division">
<span aria-label="542" epub:type="pagebreak" id="pg_542" role="doc-pagebreak"/>
<h3 class="H1" id="sec1"><span id="toc-link_361"/><span class="SANS_Futura_Std_Bold_B_11">The PDO Library</span></h3>
<p class="TNI1">The PDO library for database operations has been a built-in feature of the PHP language since 2005 and is compatible (through various drivers) with many DBMSs, including MySQL and SQLite, as we’ll see in this chapter. This makes it incredibly easy to develop flexible web applications that can switch DBMSs with minimal changes required to the code. Before PDO, switching to a different DBMS meant using a different library.</p>
<p class="TX">In addition to offering a standard (and therefore reusable) way to run SQL commands on different relational database systems, PDO also makes it much easier to write more secure database communication code through the use of <i>prepared statements</i>. These are templates for database queries, including placeholders for certain fields that can be set to actual values when the query is to be executed. The basic pattern is to build the SQL statement as a string (including any placeholders), pass that string to a PDO connection object to “prepare” the statement, pass along any values for filling in the placeholders, and then execute the prepared statement on the database.</p>
<p class="TX">Handling SQL code through prepared statements avoids problems of SQL injection attacks, and so we’ll be using only prepared statements in this book. In a <i>SQL injection</i>, text that’s received from the user (for example, through a web form or a login field) is concatenated into an SQL query string and executed on the database. Malicious users can take advantage of this common web application vulnerability to modify the original SQL query or add an additional SQL query that will then also be executed on the database. The web comic XKCD took a humorous look at SQL injection, shown in <a href="#fig28-1">Figure 28-1</a>.</p>
<figure class="IMG"><a id="fig28-1"/><img alt="" class="img100" height="520" src="../images/figure28-1.jpg" width="1688"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 28-1: Randall Munroe’s “Bobby Tables” cartoon (</span><span class="SANS_Futura_Std_Book_11"><a href="https://xkcd.com/327/">https://xkcd.com/327/</a></span><span class="SANS_Futura_Std_Book_Oblique_11">) is a lighthearted example of the damage an SQL injection attack can do.</span></p></figcaption>
</figure>
<p class="TX">Yet another bonus of using PDO is that it offers an <i>object fetch mode</i>, whereby data queried from the database is automatically packaged into objects of the appropriate classes in your PHP code (<i>model classes</i>). All you have to do is tell PDO which classes correspond to which database tables. Without this feature, you’d have to write code to handle the details of building the objects based on the results of the query, which often requires fussing with multidimensional arrays and column headers.</p>
<p class="TX"><span aria-label="543" epub:type="pagebreak" id="pg_543" role="doc-pagebreak"/>We’ll explore the basics of using the PDO library throughout this chapter as we develop an object-oriented, database-driven web application.</p>
<blockquote>
<p class="Note"><span class="SANS_Dogma_OT_Bold_B_15">NOTE</span></p>
</blockquote>
<p class="NOTE-TXT"><i>This chapter only scratches the surface of the PDO library’s capabilities. For more information about what it can do, I recommend the modestly titled “(The Only Proper) PDO Tutorial,” available online at</i> <span class="note_LinkURL"><a href="https://phpdelusions.net/pdo">https://phpdelusions.net/pdo</a></span><i>.</i></p>
</section>
<section aria-labelledby="sec2" epub:type="division">
<h3 class="H1" id="sec2"><span id="toc-link_362"/><span class="SANS_Futura_Std_Bold_B_11">A Simple Database-Driven Web Application</span></h3>
<p class="TNI1">To get started using PDO, we’ll first create a bare-bones application with a single page that retrieves and displays information about a selection of products stored in a database. This will illustrate how to connect to a database, create a table, populate it with data, and retrieve that data for use in the application, all in an object-oriented way. In <span class="Xref">“A Multipage Database-Driven Web Application” on <a href="#pg_553">page 553</a></span>, we’ll expand the application to include multiple pages, well-organized controller logic, and Twig templating.</p>
<p class="TX">For now, the project will have the following file structure:</p>
<figure class="IMG-1"><img alt="" class="img100" height="498" src="../images/pg543.jpg" width="1389"/>
</figure>
<p class="TX">To begin, create a new project folder and add the usual <i>composer.json</i> file declaring that <span class="SANS_TheSansMonoCd_W5Regular_11">Mattsmithdev</span> namespaced classes are located in the <i>src</i> folder. Then add a <i>public</i> folder containing the usual <i>index.php</i> script that reads in the autoloader, creates an <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> object, and invokes its <span class="SANS_TheSansMonoCd_W5Regular_11">run()</span> method. With that, we’re ready to set up the databases. The <i>db</i> folder will contain the scripts to create both MySQL and SQLite versions of a database to support our application.</p>
<section aria-labelledby="sec3" epub:type="division">
<h4 class="H2" id="sec3"><span id="toc-link_363"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Setting Up the Database Schema</span></h4>
<p class="TNI1">Our web application will be able to use MySQL or SQLite as a DBMS, and in this section we’ll write PHP scripts to set up a new database schema using both systems. For small, local projects, an SQLite database file in the <i>var</i> folder of the project is often sufficient. For large-scale, production-ready web applications, MySQL is more common, with the database running on a different server (or multiple servers).</p>
<p class="TX"><span aria-label="544" epub:type="pagebreak" id="pg_544" role="doc-pagebreak"/>For this simple example, we’ll save the MySQL and SQLite database setup scripts in the project’s <i>db</i> folder. In a more realistic scenario, however, the database structure would be fixed and the database already set up, so such scripts wouldn’t usually be kept as part of the application’s folder structure.</p>
<p class="TX">For our database, we’ll create a simple schema consisting of a single table called <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> and insert two example records into that table. <a href="#fig28-2">Figure 28-2</a> shows an ER model of this table.</p>
<figure class="IMG"><a id="fig28-2"/><img alt="" class="img50" height="202" src="../images/figure28-2.jpg" width="522"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 28-2: An ER model for the</span> <span class="SANS_TheSansMonoCd_W5Regular_Italic_11">product</span> <span class="SANS_Futura_Std_Book_Oblique_11">table</span></p></figcaption>
</figure>
<p class="TX">As the diagram shows, the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> table will have fields for the product’s <span class="SANS_TheSansMonoCd_W5Regular_11">id</span> (a unique numerical identifier), its <span class="SANS_TheSansMonoCd_W5Regular_11">description</span>, and its <span class="SANS_TheSansMonoCd_W5Regular_11">price</span>.</p>
<section aria-labelledby="sec4" epub:type="division">
<h5 class="H3" id="sec4"><span class="SANS_Futura_Std_Bold_Condensed_B_11">MySQL</span></h5>
<p class="TNI1">Listing 28-1 uses PDO to create a MySQL database schema, define the structure of a <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> table, and insert two example records into that table. Name this script <i>create_database.php</i> and save it in the <i>db</i> folder.</p>
<span id="lis28-1"/>
<pre><code>&lt;?php&#13;
<span aria-label="annotation1" class="codeannotated_CodeAnnotation">❶</span> define('DB_NAME', 'demo1');&#13;
&#13;
<span aria-label="annotation2" class="codeannotated_CodeAnnotation">❷</span> $connection = new \PDO(&#13;
    'mysql:host=localhost:3306',&#13;
    '<span class="TheSansMonoCd_W5Regular_Italic_11">root</span>',&#13;
    '<span class="TheSansMonoCd_W5Regular_Italic_11">passpass</span>'&#13;
);&#13;
&#13;
<span aria-label="annotation3" class="codeannotated_CodeAnnotation">❸</span> $sql = 'CREATE DATABASE ' . DB_NAME ;&#13;
$stmt0 = $connection-&gt;prepare($sql);&#13;
$stmt0-&gt;execute();&#13;
&#13;
$connection = new \PDO(&#13;
  <span aria-label="annotation4" class="Code_CodeAnnotation">❹</span> 'mysql:dbname=' . DB_NAME . ';host=localhost:3306',&#13;
    '<span class="TheSansMonoCd_W5Regular_Italic_11">root</span>',&#13;
    '<span class="TheSansMonoCd_W5Regular_Italic_11">passpass</span>'&#13;
);&#13;
&#13;
$sql = 'CREATE TABLE IF NOT EXISTS product ('&#13;
  <span aria-label="annotation5" class="Code_CodeAnnotation">❺</span> . 'id integer PRIMARY KEY AUTO_INCREMENT,'&#13;
    . 'description text,'&#13;
    . 'price float'&#13;
    . ')';&#13;
$stmt1 = $connection-&gt;prepare($sql);&#13;
$stmt1-&gt;execute();&#13;
&#13;
<span aria-label="545" epub:type="pagebreak" id="pg_545" role="doc-pagebreak"/>$sql = "INSERT INTO product (description, price) VALUES ('hammer', 9.99)";&#13;
$stmt2 = $connection-&gt;prepare($sql);&#13;
$stmt2-&gt;execute();&#13;
&#13;
$sql = "INSERT INTO product (description, price) VALUES ('ladder', 59.99)";&#13;
$stmt3 = $connection-&gt;prepare($sql);&#13;
$stmt3-&gt;execute();</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 28-1: A script to create our MySQL database</span></p>
<p class="TX">First, we define a <span class="SANS_TheSansMonoCd_W5Regular_11">DB_NAME</span> constant to hold the database schema name, <span class="SANS_TheSansMonoCd_W5Regular_11">'demo1'</span> <span aria-label="annotation1" class="CodeAnnotation">❶</span>. Putting the name in a constant makes this script easy to edit and reuse on other database schemas—just update the name in the constant.</p>
<p class="TX">Next, we create a new <span class="SANS_TheSansMonoCd_W5Regular_11">PDO</span> object to establish a connection with a database, storing the result in the <span class="SANS_TheSansMonoCd_W5Regular_11">$connection</span> variable <span aria-label="annotation2" class="CodeAnnotation">❷</span>. The first argument is the <i>data source name (DSN)</i>, a standardized string providing information about the database connection. The DSN string begins with <span class="SANS_TheSansMonoCd_W5Regular_11">'mysql:'</span>, telling PDO that we want to connect to a MySQL server, followed by one or more <span class="SANS_TheSansMonoCd_W5Regular_Italic_11">key</span><span class="SANS_TheSansMonoCd_W5Regular_11">=</span><span class="SANS_TheSansMonoCd_W5Regular_Italic_11">value</span> pairs, separated by semicolons. For now, we need just one <span class="SANS_TheSansMonoCd_W5Regular_Italic_11">key</span><span class="SANS_TheSansMonoCd_W5Regular_11">=</span><span class="SANS_TheSansMonoCd_W5Regular_Italic_11">value</span> pair to specify that the <span class="SANS_TheSansMonoCd_W5Regular_11">host</span> the MySQL database is running on is the <span class="SANS_TheSansMonoCd_W5Regular_11">localhost</span> server at port <span class="SANS_TheSansMonoCd_W5Regular_11">3306</span>. We don’t include the schema name here, since we haven’t created the schema yet. The second and third arguments passed to the <span class="SANS_TheSansMonoCd_W5Regular_11">PDO</span> constructor provide the username <span class="SANS_TheSansMonoCd_W5Regular_11">'</span><span class="SANS_TheSansMonoCd_W5Regular_Italic_11">root</span><span class="SANS_TheSansMonoCd_W5Regular_11">'</span> and the password <span class="SANS_TheSansMonoCd_W5Regular_11">'</span><span class="SANS_TheSansMonoCd_W5Regular_Italic_11">passpass</span><span class="SANS_TheSansMonoCd_W5Regular_11">'</span>. Replace these with the database username and password for your MySQL setup (see <span class="Xref"><a href="appendix-b.xhtml">Appendix B</a></span>).</p>
<p class="TX">We next build and execute an SQL statement to create the database schema named in the <span class="SANS_TheSansMonoCd_W5Regular_11">DB_NAME</span> constant <span aria-label="annotation3" class="CodeAnnotation">❸</span>. We create the SQL statement as a string in the <span class="SANS_TheSansMonoCd_W5Regular_11">$sql</span> variable, consisting of the SQL keywords <span class="SANS_TheSansMonoCd_W5Regular_11">'CREATE DATABASE'</span> plus the schema name. We pass that string to the <span class="SANS_TheSansMonoCd_W5Regular_11">$connection</span> object’s <span class="SANS_TheSansMonoCd_W5Regular_11">prepare()</span> method to securely prepare the statement, placing the result, an object of the PDO library’s <span class="SANS_TheSansMonoCd_W5Regular_11">PDOStatement</span> class, in the <span class="SANS_TheSansMonoCd_W5Regular_11">$stmt0</span> variable. Then we execute the prepared statement. We’ll use this basic pattern of preparing and executing SQL statements over and over when working with databases. In most cases, we’d then perform an action after the statement has been executed, such as returning a list of retrieved objects or confirming the database has been changed as expected and then informing the user if it has.</p>
<p class="TX">Now that we’ve created the schema, we need to create the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> table within it. First, we overwrite <span class="SANS_TheSansMonoCd_W5Regular_11">$connection</span> with a new connection to the database schema itself, rather than to the MySQL server in general. Notice that this time we specify the schema name as part of the DSN string when constructing the <span class="SANS_TheSansMonoCd_W5Regular_11">PDO</span> object <span aria-label="annotation4" class="CodeAnnotation">❹</span>. Specifically, we assign the <span class="SANS_TheSansMonoCd_W5Regular_11">DB_NAME</span> constant as the value of the <span class="SANS_TheSansMonoCd_W5Regular_11">dbname</span> key, followed by a semicolon (<span class="SANS_TheSansMonoCd_W5Regular_11">;</span>) to separate this key/value pair from the others in the DSN string. Then we build and execute another SQL statement creating the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> table with <span class="SANS_TheSansMonoCd_W5Regular_11">id</span>, <span class="SANS_TheSansMonoCd_W5Regular_11">description</span>, and <span class="SANS_TheSansMonoCd_W5Regular_11">price</span> fields. MySQL databases support auto-incrementing, which automatically generates unique numeric keys in sequence. Our SQL statement uses this feature as part of the primary-key declaration for the <span class="SANS_TheSansMonoCd_W5Regular_11">id</span> field, so we don’t have to worry about manually setting the product IDs <span aria-label="annotation5" class="CodeAnnotation">❺</span>.</p>
<p class="TX"><span aria-label="546" epub:type="pagebreak" id="pg_546" role="doc-pagebreak"/>We finish the script by creating and executing two <span class="SANS_TheSansMonoCd_W5Regular_11">INSERT</span> SQL statements to add two rows to the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> table: a <span class="SANS_TheSansMonoCd_W5Regular_11">'hammer'</span> costing <span class="SANS_TheSansMonoCd_W5Regular_11">9.99</span> and a <span class="SANS_TheSansMonoCd_W5Regular_11">'ladder'</span> costing <span class="SANS_TheSansMonoCd_W5Regular_11">59.99</span>. We don’t include values for each product’s <span class="SANS_TheSansMonoCd_W5Regular_11">id</span> field since MySQL will automatically generate them.</p>
<p class="TX">Once you’ve written this script, run it by entering <span class="SANS_TheSansMonoCd_W7Bold_11">php db/create_database.php</span> at the command line. This will create and populate the MySQL schema.</p>
</section>
<section aria-labelledby="sec5" epub:type="division">
<h5 class="H3" id="sec5"><span class="SANS_Futura_Std_Bold_Condensed_B_11">SQLite</span></h5>
<p class="TNI1">Now let’s adapt the script from <a href="#lis28-1">Listing 28-1</a> to create the same schema as an SQLite database file. As you’ll see, the process is similar, since the PDO library can work with SQLite just as easily as with MySQL. Save the contents of <a href="#lis28-2">Listing 28-2</a> as <i>create_databaseSQLite.php</i> in your project’s <i>db</i> subdirectory. The SQLite database file itself will be located in the <i>var</i> subdirectory, which is created as part of the script.</p>
<span id="lis28-2"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
define('FILENAME', 'demo1.db');&#13;
<span aria-label="annotation1" class="codeannotated_CodeAnnotation">❶</span> define('FOLDER_PATH', __DIR__ . '/../var/');&#13;
&#13;
if (!file_exists(FOLDER_PATH)) {&#13;
    mkdir(FOLDER_PATH);&#13;
}&#13;
&#13;
$connection = new \PDO(&#13;
<b>  </b><span aria-label="annotation2" class="Code_CodeAnnotation">❷</span><b> </b>'sqlite:' . FOLDER_PATH . FILENAME&#13;
);&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$sql = 'CREATE TABLE IF NOT EXISTS product ('</span>&#13;
<b>  </b><span aria-label="annotation3" class="Code_CodeAnnotation">❸</span><b> </b>. 'id integer PRIMARY KEY AUTOINCREMENT,'&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    . 'description text,'</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    . 'price float'</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    . ')';</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$stmt1 = $connection-&gt;prepare($sql);</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$stmt1-&gt;execute();</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$sql = "INSERT INTO product (description, price) VALUES ('hammer', 9.99)";</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$stmt2 = $connection-&gt;prepare($sql);-</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$stmt2-&gt;execute();</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$sql = "INSERT INTO product (description, price) VALUES ('ladder', 59.99)";</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$stmt3 = $connection-&gt;prepare($sql);</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$stmt3-&gt;execute();</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 28-2: A script to create our SQLite database</span></p>
<p class="TX">First, we define constants for the database filename (<span class="SANS_TheSansMonoCd_W5Regular_11">'demo1.db'</span>) and folder path. Remember that a double dot (<span class="SANS_TheSansMonoCd_W5Regular_11">..</span>) in a path refers to a parent directory, so <i>/../var</i> indicates that <i>var</i> should be at the same hierarchy level as the running script’s directory <span aria-label="annotation1" class="CodeAnnotation">❶</span>. We create this directory if it doesn’t already exist.</p>
<p class="TX">Then we create a new <span class="SANS_TheSansMonoCd_W5Regular_11">PDO</span> object, once again passing a DSN string as an argument to provide information about the database we want to connect to <span aria-label="annotation2" class="CodeAnnotation">❷</span>. <span aria-label="547" epub:type="pagebreak" id="pg_547" role="doc-pagebreak"/>This time, the DSN string begins with <span class="SANS_TheSansMonoCd_W5Regular_11">'sqlite:'</span>, telling PDO that we want to connect to an SQLite server, followed by the full filepath, including the directory path and filename, to the desired database. Unlike with MySQL, we don’t need to write and execute an SQL statement creating the database schema; if necessary, the SQLite database file is created when the connection is established. Also, since SQLite is just working with a file, there’s no need for any username or password.</p>
<p class="TX">Once PDO establishes a database connection, it mostly doesn’t matter what DBMS it’s working with, so the rest of the script is virtually identical to <a href="#lis28-1">Listing 28-1</a>: we create and execute SQL statements to create the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> table and add two entries to it. The only difference is that SQLite uses the keyword <span class="SANS_TheSansMonoCd_W5Regular_11">AUTOINCREMENT</span> with no underscore (unlike MySQL’s <span class="SANS_TheSansMonoCd_W5Regular_11">AUTO_INCREMENT</span>) <span aria-label="annotation3" class="CodeAnnotation">❸</span>.</p>
<p class="TX">As with the MySQL version, you need to run this script to create and populate the SQLite database schema. Enter <span class="SANS_TheSansMonoCd_W7Bold_11">php db/create_databaseSQLite.php</span> at the command line.</p>
</section>
</section>
<section aria-labelledby="sec6" epub:type="division">
<h4 class="H2" id="sec6"><span id="toc-link_364"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Writing the PHP Classes</span></h4>
<p class="TNI1">Now we’ll organize the logic of our simple web application by writing some PHP classes. For now, we need three. As usual, we’ll create an <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class to serve as a front controller for the application. We’ll also write a <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> class with properties corresponding to the fields in our database’s <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> table, to make it easy to move data back and forth between the database and our PHP code. Finally, we’ll design a <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span> class to encapsulate the logic of creating a database connection. Not only will this help keep our code tidy and object-oriented, but it will also enable us to easily refactor the application to switch between MySQL and SQLite with little to no effect on the rest of the code.</p>
<p class="TX">We’ll start with the <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class. Declare this class in <i>src/Application.php</i>, as shown in <a href="#lis28-3">Listing 28-3</a>.</p>
<span id="lis28-3"/>
<pre><code>&lt;?php&#13;
namespace Mattsmithdev;&#13;
&#13;
use Mattsmithdev\Product;&#13;
&#13;
class Application&#13;
{&#13;
  <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> private ?\PDO $connection;&#13;
&#13;
    public function __construct()&#13;
    {&#13;
        $db = new Database();&#13;
      <span aria-label="annotation2" class="Code_CodeAnnotation">❷</span> $this-&gt;connection = $db-&gt;getConnection();&#13;
    }&#13;
&#13;
    public function run()&#13;
    {&#13;
        if (NULL != $this-&gt;connection){&#13;
          <span aria-label="annotation3" class="Code_CodeAnnotation">❸</span> $products = $this-&gt;getProducts();&#13;
<span aria-label="548" epub:type="pagebreak" id="pg_548" role="doc-pagebreak"/>            print '&lt;pre&gt;';&#13;
            var_dump($products);&#13;
            print '&lt;/pre&gt;';&#13;
        } else {&#13;
            print '&lt;p&gt;Application::run() - sorry '&#13;
                . '- there was a problem with the database connection';&#13;
        }&#13;
    }&#13;
&#13;
    public function getProducts(): array&#13;
    {&#13;
        $sql = 'SELECT * FROM product';&#13;
        $stmt = $this-&gt;connection-&gt;prepare($sql);&#13;
        $stmt-&gt;execute();&#13;
      <span aria-label="annotation4" class="Code_CodeAnnotation">❹</span> $stmt-&gt;setFetchMode(\PDO::FETCH_CLASS, Product::class);&#13;
        $products = $stmt-&gt;fetchAll();&#13;
&#13;
        return $products;&#13;
    }&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 28-3: The</span> <span class="TheSansMonoCd_W5Regular_Italic_11">Application</span> <span class="SANS_Futura_Std_Book_Oblique_11">class</span></p>
<p class="TX">We start by giving the class a private <span class="SANS_TheSansMonoCd_W5Regular_11">connection</span> property <span aria-label="annotation1" class="CodeAnnotation">❶</span>. This property has the nullable data type of <span class="SANS_TheSansMonoCd_W5Regular_11">?\PDO</span>, so it will be either a reference to a <span class="SANS_TheSansMonoCd_W5Regular_11">PDO</span> database connection object or <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span> (if the connection fails). In the class’s constructor method, we create a new <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span> object and invoke its <span class="SANS_TheSansMonoCd_W5Regular_11">getConnection()</span> method (we’ll define that class and method shortly).</p>
<p class="TX">Next, we store the resulting database connection reference into the <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class’s <span class="SANS_TheSansMonoCd_W5Regular_11">connection</span> property <span aria-label="annotation2" class="CodeAnnotation">❷</span>. This may seem more roundabout than directly connecting to a database as we did earlier in the setup code, but relegating the details of establishing the connection to the <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span> class allows this <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class to work regardless of the DBMS we’re using.</p>
<p class="TX">We next declare the application’s <span class="SANS_TheSansMonoCd_W5Regular_11">run()</span> method. In it, we test the <span class="SANS_TheSansMonoCd_W5Regular_11">connection</span> property to make sure it isn’t <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span> and invoke the <span class="SANS_TheSansMonoCd_W5Regular_11">getProducts()</span> method if it isn’t <span aria-label="annotation3" class="CodeAnnotation">❸</span>, which returns an array of <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> objects retrieved from the database. For simplicity, we print the array preceded by an HTML <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;pre&gt;</span> tag. (We’ll refine this project to output valid HTML when we expand the application later in the chapter.) If <span class="SANS_TheSansMonoCd_W5Regular_11">connection</span> is <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span>, we print an error message instead.</p>
<p class="TX">We close out the class by declaring the <span class="SANS_TheSansMonoCd_W5Regular_11">getProducts()</span> method. It uses the <span class="SANS_TheSansMonoCd_W5Regular_11">connection</span> property to prepare and execute an SQL statement that selects all the rows from the database’s <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> table. The raw results of this query are in the <span class="SANS_TheSansMonoCd_W5Regular_11">PDOStatement</span> object referenced by the <span class="SANS_TheSansMonoCd_W5Regular_11">$stmt</span> variable, but we want to represent the results as <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> objects.</p>
<p class="TX">This is where the PDO library’s object fetch mode comes in handy. We set it up by invoking <span class="SANS_TheSansMonoCd_W5Regular_11">$stmt-&gt;setFetchMode()</span> <span aria-label="annotation4" class="CodeAnnotation">❹</span>, passing the <span class="SANS_TheSansMonoCd_W5Regular_11">\PDO::FETCH_CLASS</span> constant as a first argument to indicate that we want the results to be objects of a class. The second argument, <span class="SANS_TheSansMonoCd_W5Regular_11">Product::class</span>, tells PDO which (namespaced) class to use. The <span class="SANS_TheSansMonoCd_W5Regular_11">::class</span> magic constant returns the fully qualified class name string (in this case, <span class="SANS_TheSansMonoCd_W5Regular_11">'Mattsmithdev\\Product'</span>). Then we <span aria-label="549" epub:type="pagebreak" id="pg_549" role="doc-pagebreak"/>invoke <span class="SANS_TheSansMonoCd_W5Regular_11">$stmt-&gt;fetchAll()</span> to retrieve the results. Since we selected multiple rows from the database, this creates an array of <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> objects rather than just a single object. We return this array via the <span class="SANS_TheSansMonoCd_W5Regular_11">$products</span> variable.</p>
<p class="TX">Now we’ll create the <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> model class. The properties of this class must correspond to the columns of the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> database table (that is, have the same names and data types) for PDO to be able to successfully return query results as <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> objects. Save the contents of <a href="#lis28-4">Listing 28-4</a> in <i>src/Product.php</i>.</p>
<span id="lis28-4"/>
<pre><code>&lt;?php&#13;
namespace Mattsmithdev;&#13;
&#13;
class Product&#13;
{&#13;
    private int $id;&#13;
    private string $description;&#13;
    private float $price;&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 28-4: The</span> <span class="TheSansMonoCd_W5Regular_Italic_11">Product</span> <span class="SANS_Futura_Std_Book_Oblique_11">class</span></p>
<p class="TX">All this code does is declare three private properties for the class (<span class="SANS_TheSansMonoCd_W5Regular_11">id</span>, <span class="SANS_TheSansMonoCd_W5Regular_11">description</span>, and <span class="SANS_TheSansMonoCd_W5Regular_11">price</span>) with names and data types matching the fields in the <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> table. That’s all the PDO library needs in order to retrieve rows from the table as objects of this class. Since for now our application is simply using <span class="SANS_TheSansMonoCd_W5Regular_11">var_dump()</span> to display an array of <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> objects, we never need to access the class’s private properties. When we expand the application, we’ll add accessor methods to the <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> class so that we can write a more elegant template page that loops through and outputs each object’s properties in customizable and valid HTML.</p>
<p class="TX">Finally, let’s declare the <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span> class to manage the process of establishing and storing a live MySQL database connection. Create the file <i>src/Database.php</i> containing the contents of <a href="#lis28-5">Listing 28-5</a>.</p>
<span id="lis28-5"/>
<pre><code>&lt;?php&#13;
namespace Mattsmithdev;&#13;
&#13;
class Database&#13;
{&#13;
  <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> const MYSQL_HOST = 'localhost';&#13;
    const MYSQL_PORT = '3306';&#13;
    const MYSQL_USER = '<span class="TheSansMonoCd_W5Regular_Italic_11">root</span>';&#13;
    const MYSQL_PASSWORD = '<span class="TheSansMonoCd_W5Regular_Italic_11">passpass</span>';&#13;
    const MYSQL_DATABASE = 'demo1';&#13;
&#13;
    const DATA_SOURCE_NAME =  'mysql:dbname=' . self::MYSQL_DATABASE&#13;
      <span aria-label="annotation2" class="Code_CodeAnnotation">❷</span> . ';host=' . self::MYSQL_HOST . ':' . self::MYSQL_PORT;&#13;
&#13;
  <span aria-label="annotation3" class="Code_CodeAnnotation">❸</span> private ?\PDO $connection;&#13;
&#13;
    public function getConnection(): ?\PDO&#13;
    {&#13;
        return $this-&gt;connection;&#13;
<span aria-label="550" epub:type="pagebreak" id="pg_550" role="doc-pagebreak"/>    }&#13;
&#13;
    public function __construct()&#13;
    {&#13;
      <span aria-label="annotation4" class="Code_CodeAnnotation">❹</span> try {&#13;
            $connection = new \PDO(&#13;
                self::DATA_SOURCE_NAME,&#13;
                self::MYSQL_USER,&#13;
                self::MYSQL_PASSWORD&#13;
            );&#13;
            $this-&gt;connection = $connection;&#13;
      <span aria-label="annotation5" class="Code_CodeAnnotation">❺</span>} catch (\Exception $e) {&#13;
            print "Database::__construct() - Exception '&#13;
                . '- error trying to create database connection";&#13;
        }&#13;
    }&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 28-5: The</span> <span class="TheSansMonoCd_W5Regular_Italic_11">Database</span> <span class="SANS_Futura_Std_Book_Oblique_11">class</span></p>
<p class="TX">We declare class constants for the five individual pieces of data needed to create a live connection to a MySQL database <span aria-label="annotation1" class="CodeAnnotation">❶</span>: the host (<span class="SANS_TheSansMonoCd_W5Regular_11">localhost</span>), the port (<span class="SANS_TheSansMonoCd_W5Regular_11">3306</span>), the MySQL username and password (fill these in as appropriate), and the name of the database schema we want to work with (<span class="SANS_TheSansMonoCd_W5Regular_11">demo1</span>). Then we combine some of these constants into another constant representing the DSN string that we’ll need to pass as the first argument when creating the <span class="SANS_TheSansMonoCd_W5Regular_11">PDO</span> object <span aria-label="annotation2" class="CodeAnnotation">❷</span>.</p>
<p class="TX">We next declare a private <span class="SANS_TheSansMonoCd_W5Regular_11">connection</span> property for the class <span aria-label="annotation3" class="CodeAnnotation">❸</span>, along with a public <span class="SANS_TheSansMonoCd_W5Regular_11">getConnection()</span> method to return its value. This property has the nullable data type of <span class="SANS_TheSansMonoCd_W5Regular_11">?\PDO</span>, so it will be either <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span> or a reference to a <span class="SANS_TheSansMonoCd_W5Regular_11">PDO</span> object.</p>
<p class="TX">In the <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span> class’s constructor method, we attempt to connect to the MySQL database by creating a new <span class="SANS_TheSansMonoCd_W5Regular_11">PDO</span> object, using the class constants to provide the necessary DSN string, username, and password. A reference to the database connection is stored in the class’s <span class="SANS_TheSansMonoCd_W5Regular_11">connection</span> property. These actions are wrapped inside a <span class="SANS_TheSansMonoCd_W5Regular_11">try</span> statement <span aria-label="annotation4" class="CodeAnnotation">❹</span>, so any exception thrown in the process will be caught <span aria-label="annotation5" class="CodeAnnotation">❺</span> and an error message will be printed out. Therefore, whenever a new <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span> object is created (from within the <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class), the constructor method will attempt to connect to the database. A subsequent call to <span class="SANS_TheSansMonoCd_W5Regular_11">getConnection()</span> will return either a <span class="SANS_TheSansMonoCd_W5Regular_11">PDO</span> connection object or <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span> if a problem occurred when creating the connection.</p>
<p class="TX">With that, we’re ready to run the application and see the results. When you visit the localhost server running the web application, you should see something like <a href="#fig28-3">Figure 28-3</a>.</p>
<span aria-label="551" epub:type="pagebreak" id="pg_551" role="doc-pagebreak"/>
<figure class="IMG"><a id="fig28-3"/><img alt="" class="img100" height="881" src="../images/figure28-3.jpg" width="1101"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 28-3: The web page showing the contents of the</span> <span class="SANS_TheSansMonoCd_W5Regular_Italic_11">$products</span> <span class="SANS_Futura_Std_Book_Oblique_11">array</span></p></figcaption>
</figure>
<p class="TX">At this stage, the web page doesn’t look like much; all it shows is a <span class="SANS_TheSansMonoCd_W5Regular_11">var_dump()</span> of the <span class="SANS_TheSansMonoCd_W5Regular_11">$products</span> array. Since we haven’t yet included any decision logic in the <span class="SANS_TheSansMonoCd_W5Regular_11">run()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class, this page will always be displayed, regardless of any URL-encoded request variables. However, the printed contents of the array indicate that we’ve successfully retrieved entries from the <span class="SANS_TheSansMonoCd_W5Regular_11">products</span> MySQL database table and mapped them to objects of our custom <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> class, an important first step in database-driven application development.</p>
</section>
<section aria-labelledby="sec7" epub:type="division">
<h4 class="H2" id="sec7"><span id="toc-link_365"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Switching from MySQL to SQLite</span></h4>
<p class="TNI1">Earlier, we set up the same database schema in both MySQL and SQLite; what would it take to refactor our application to use the SQLite schema rather than MySQL? We’ve designed the application so that all the DBMS-specific logic is encapsulated in the <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span> class, and we reference this class only once, in the constructor method for the <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class (see <a href="#lis28-3">Listing 28-3</a>). There we use the statement <span class="SANS_TheSansMonoCd_W5Regular_11">$db = new Database()</span> to get a reference to a new <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span> object before invoking its <span class="SANS_TheSansMonoCd_W5Regular_11">getConnection()</span> method to obtain a PDO database connection.</p>
<p class="TX">Let’s replace this statement with one that creates an instance of a <span class="SANS_TheSansMonoCd_W5Regular_11">DatabaseSQLite</span> class that will connect to SQLite instead of MySQL. <a href="#lis28-6">Listing 28-6</a> shows the necessary change to <i>src/Application.php</i>.</p>
<span id="lis28-6"/>
<pre><code><span aria-label="552" epub:type="pagebreak" id="pg_552" role="doc-pagebreak"/><span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
    <span class="TheSansMonoCd_W5Regular_Grey_11">public function __construct()</span>&#13;
    <span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
        $db = new DatabaseSQLite();&#13;
        <span class="TheSansMonoCd_W5Regular_Grey_11">$this-&gt;connection = $db-&gt;getConnection();</span>&#13;
    <span class="TheSansMonoCd_W5Regular_Grey_11">}</span>&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 28-6: Updating the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">Application</span> <span class="SANS_Futura_Std_Book_Oblique_11">class to create a</span> <span class="TheSansMonoCd_W5Regular_Italic_11">DatabaseSQLite</span> <span class="SANS_Futura_Std_Book_Oblique_11">object instead of a</span> <span class="TheSansMonoCd_W5Regular_Italic_11">Database</span> <span class="SANS_Futura_Std_Book_Oblique_11">object</span></p>
<p class="TX">Now we need to declare the <span class="SANS_TheSansMonoCd_W5Regular_11">DatabaseSQLite</span> class to encapsulate the work of creating and storing a live SQLite database connection. For the rest of our application code to work as before, it needs to have a <span class="SANS_TheSansMonoCd_W5Regular_11">getConnection()</span> method that returns a reference to a <span class="SANS_TheSansMonoCd_W5Regular_11">PDO</span> connection object, just like the <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span> class. Create <i>src/DatabaseSQLite.php</i> containing the code in <a href="#lis28-7">Listing 28-7</a>.</p>
<span id="lis28-7"/>
<pre><code>&lt;?php&#13;
namespace Mattsmithdev;&#13;
&#13;
class DatabaseSQLite&#13;
{&#13;
    const DB_DIRECTORY = __DIR__ . '/../var';&#13;
    const DB_FILE_PATH = self::DB_DIRECTORY . '/demo1.db';&#13;
&#13;
    const DATA_SOURCE_NAME =  'sqlite:'  . self::DB_FILE_PATH;&#13;
&#13;
    private ?\PDO $connection = NULL;&#13;
&#13;
    public function getConnection(): ?\PDO&#13;
    {&#13;
        return $this-&gt;connection;&#13;
    }&#13;
&#13;
    public function __construct()&#13;
    {&#13;
        try {&#13;
            $this-&gt;connection = new \PDO(self::DATA_SOURCE_NAME);&#13;
        } catch (\Exception $e){&#13;
            print 'DatabaseSQLite::__construct() - Exception - '&#13;
                . 'error trying to create database connection'&#13;
                . PHP_EOL;&#13;
        }&#13;
    }&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 28-7: The</span> <span class="TheSansMonoCd_W5Regular_Italic_11">DatabaseSQLite</span> <span class="SANS_Futura_Std_Book_Oblique_11">class</span></p>
<p class="TX">This new class follows the same contours as the old <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span> class; only the SQLite-specific details differ. We first declare constants for the data needed to create a live SQLite database connection: the location of the directory containing the database file (<span class="SANS_TheSansMonoCd_W5Regular_11">DB_DIRECTORY</span>); the full filepath, including the <span aria-label="553" epub:type="pagebreak" id="pg_553" role="doc-pagebreak"/>directory location and filename (<span class="SANS_TheSansMonoCd_W5Regular_11">DB_FILE_PATH</span>); and the DSN string, including the full filepath (<span class="SANS_TheSansMonoCd_W5Regular_11">DATA_SOURCE_NAME</span>). Then we declare a private <span class="SANS_TheSansMonoCd_W5Regular_11">connection</span> property with a nullable <span class="SANS_TheSansMonoCd_W5Regular_11">\PDO</span> data type of <span class="SANS_TheSansMonoCd_W5Regular_11">?\PDO</span> and its public <span class="SANS_TheSansMonoCd_W5Regular_11">getConnection()</span> getter method, as before. Finally, we declare a constructor method that uses <span class="SANS_TheSansMonoCd_W5Regular_11">try</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">catch</span> statements to attempt to create a new <span class="SANS_TheSansMonoCd_W5Regular_11">PDO</span> database connection object and report any errors—again, just like the <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span> class.</p>
<p class="TX">Try running the web server again and you should see the application function exactly as before, displaying the contents of the <span class="SANS_TheSansMonoCd_W5Regular_11">$products</span> array that features data retrieved from the database. It’s just that now we’re using SQLite rather than MySQL. This switch required virtually no updates to the code aside from declaring the new <span class="SANS_TheSansMonoCd_W5Regular_11">DatabaseSQLite</span> class and changing one line to create a <span class="SANS_TheSansMonoCd_W5Regular_11">DatabaseSQLite</span> object instead of <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span>.</p>
</section>
</section>
<section aria-labelledby="sec8" epub:type="division">
<h3 class="H1" id="sec8"><span id="toc-link_366"/><span class="SANS_Futura_Std_Bold_B_11">A Multipage Database-Driven Web Application</span></h3>
<p class="TNI1">Now let’s expand our database-driven web application to encompass multiple pages, including a home page, a product list page, a page for displaying details about a single product, and a page for showing error messages. We’ll also use Twig templating to streamline the process of designing these pages. This expanded project will have the following file structure:</p>
<figure class="IMG-1"><img alt="" class="img100" height="898" src="../images/pg553.jpg" width="1382"/>
</figure>
<p class="TX"><a href="#fig28-4">Figure 28-4</a> shows the four pages of this website.</p>
<span aria-label="554" epub:type="pagebreak" id="pg_554" role="doc-pagebreak"/>
<figure class="IMG"><a id="fig28-4"/><img alt="" class="img100" height="1214" src="../images/figure28-4.jpg" width="1677"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 28-4: The expanded web application</span></p></figcaption>
</figure>
<p class="TX">The pages feature HTML formatted with Bootstrap and offer a navigation bar with links to the home page and the list of products. When the <i>(show)</i> link is clicked next to a listed product, the details of that product are displayed on a new page. Notice that the ID of the clicked product appears as part of the query string in the page’s URL (for example, <i>id=1</i> on the page displaying information about the hammer). If an error occurs, such as a missing ID or an ID that doesn’t match a row in the database, an error page will be shown with an appropriate error message; the example in <a href="#fig28-4">Figure 28-4</a> shows an ID of 99 in the browser address bar, and an error message stating that no product could be found with this ID.</p>
<p class="TX">Since the application will involve several actions, we’ll create two controller classes: <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span> for listing all products and displaying a details page for an individual item, and <span class="SANS_TheSansMonoCd_W5Regular_11">DefaultController</span> with methods to display the home page and the error message page. We’ll revert to using MySQL and the original <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span> class to manage the database connection, but keep in mind that you can always sub in SQLite by switching to the <span class="SANS_TheSansMonoCd_W5Regular_11">DatabaseSQLite</span> class instead. Since the project will use Twig templating, be sure to run <span class="SANS_TheSansMonoCd_W7Bold_11">composer require twig/twig</span> at the command line to add the Twig library to the project.</p>
<section aria-labelledby="sec9" epub:type="division">
<span aria-label="555" epub:type="pagebreak" id="pg_555" role="doc-pagebreak"/>
<h4 class="H2" id="sec9"><span id="toc-link_367"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Managing the Product Information</span></h4>
<p class="TNI1">Let’s begin expanding the application by focusing on the classes that manage product information through database interaction. To start, we’ll add getter and setter methods to the <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> class. This is necessary since the application will now need to individually access a <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> object’s properties to display them in a more elegant way than a simple <span class="SANS_TheSansMonoCd_W5Regular_11">var_dump()</span>. Update <i>src/Product.php</i> to match the contents of <a href="#lis28-8">Listing 28-8</a>.</p>
<span id="lis28-8"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">namespace Mattsmithdev;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">class Product</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private int $id;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private string $description;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    private float $price;</span>&#13;
&#13;
    public function getId(): int&#13;
    {&#13;
        return $this-&gt;id;&#13;
    }&#13;
&#13;
    public function setId(int $id): void&#13;
    {&#13;
        $this-&gt;id = $id;&#13;
    }&#13;
&#13;
    public function getDescription(): string&#13;
    {&#13;
        return $this-&gt;description;&#13;
    }&#13;
&#13;
    public function setDescription(string $description): void&#13;
    {&#13;
        $this-&gt;description = $description;&#13;
    }&#13;
&#13;
    public function getPrice(): float&#13;
    {&#13;
        return $this-&gt;price;&#13;
    }&#13;
&#13;
    public function setPrice(float $price): void&#13;
    {&#13;
        $this-&gt;price = $price;&#13;
    }&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 28-8: The</span> <span class="TheSansMonoCd_W5Regular_Italic_11">Product</span> <span class="SANS_Futura_Std_Book_Oblique_11">class, now with getters and setters for each property</span></p>
<p class="TX">Here we add simple getter and setter methods for each of the three properties of the <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> class: <span class="SANS_TheSansMonoCd_W5Regular_11">id</span>, <span class="SANS_TheSansMonoCd_W5Regular_11">description</span>, and <span class="SANS_TheSansMonoCd_W5Regular_11">price</span>. That’s a total of six new methods for this class.</p>
<p class="TX"><span aria-label="556" epub:type="pagebreak" id="pg_556" role="doc-pagebreak"/>We’ll now start organizing our application code a little better by putting any logic pertaining to retrieving products from the database in a <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> class. It’s common in database-driven applications to use these sorts of classes, called <i>repository classes</i>, to separate logic accessing the database from the other logic in the application. The repository class methods take in and return objects, and handle any access to the database (with help establishing the database connection from the <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span> class itself). The rest of the application works with the resulting objects and has nothing at all to do with the database.</p>
<p class="TX">Our <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> class will include a method to retrieve all the products, as we originally had in the <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class, as well as a new method to retrieve a single product with a given ID. (Often repository classes have methods for other database operations as well, such as adding, updating, or deleting entries. We’ll discuss these operations in <span class="Xref"><a href="chapter29.xhtml">Chapter 29</a></span>.) Since this new class needs to interact with the database, it will now be responsible for creating the necessary <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span> object. These changes will free up the main <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class to focus on controller logic.</p>
<p class="TX">Create the new <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> class in <i>src/ProductRepository.php</i> as shown in <a href="#lis28-9">Listing 28-9</a>. The black code is brand new; the grayed-out code has been taken from the <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class (see <a href="#lis28-3">Listing 28-3</a>).</p>
<span id="lis28-9"/>
<pre><code>&lt;?php&#13;
namespace Mattsmithdev;&#13;
&#13;
class ProductRepository&#13;
{&#13;
    <span class="TheSansMonoCd_W5Regular_Grey_11">private ?\PDO $connection = NULL;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    public function __construct()</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $db = new Database();</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $this-&gt;connection = $db-&gt;getConnection();</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    }</span>&#13;
&#13;
    public function findAll(): array&#13;
    {&#13;
      <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> if (NULL == $this-&gt;connection) return [];&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $sql = 'SELECT * FROM product';</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $stmt = $this-&gt;connection-&gt;prepare($sql);</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $stmt-&gt;execute();</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $stmt-&gt;setFetchMode(\PDO::FETCH_CLASS, Product::class);</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $products = $stmt-&gt;fetchAll();</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        return $products;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    }</span>&#13;
&#13;
    public function find(int $id): ?Product&#13;
    {&#13;
        if (NULL == $this-&gt;connection) return NULL;&#13;
&#13;
<span aria-label="557" epub:type="pagebreak" id="pg_557" role="doc-pagebreak"/>        $sql = 'SELECT * FROM product WHERE id = :id';&#13;
        $stmt = $this-&gt;connection-&gt;prepare($sql);&#13;
&#13;
      <span aria-label="annotation2" class="Code_CodeAnnotation">❷</span> $stmt-&gt;bindParam(':id', $id);&#13;
        $stmt-&gt;execute();&#13;
&#13;
        $stmt-&gt;setFetchMode(\PDO::FETCH_CLASS, Product::class);&#13;
      <span aria-label="annotation3" class="Code_CodeAnnotation">❸</span> $product = $stmt-&gt;fetch();&#13;
&#13;
      <span aria-label="annotation4" class="Code_CodeAnnotation">❹</span> if ($product == false) {&#13;
            return NULL;&#13;
        }&#13;
&#13;
        return $product;&#13;
    }&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 28-9: The new</span> <span class="TheSansMonoCd_W5Regular_Italic_11">ProductRepository</span> <span class="SANS_Futura_Std_Book_Oblique_11">class</span></p>
<p class="TX">We declare a private <span class="SANS_TheSansMonoCd_W5Regular_11">connection</span> property, followed by a constructor method that creates a new <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span> object and invokes its <span class="SANS_TheSansMonoCd_W5Regular_11">getConnection()</span> method to retrieve a database connection. This is just like the original <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class. Next, we declare a <span class="SANS_TheSansMonoCd_W5Regular_11">findAll()</span> method containing the logic from the <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class’s <span class="SANS_TheSansMonoCd_W5Regular_11">getProducts()</span> method. (Since this is now a method in the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> class, we don’t need to use the word <i>product</i> in the method name.) The method starts with an extra line of code that tests whether the database connection is <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span> and returns an empty array if it is <span aria-label="annotation1" class="CodeAnnotation">❶</span>. This is necessary because the <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class no longer has access to the database connection. If the connection isn’t <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span>, the method retrieves all the products from the database and returns them as an array of <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> objects, just like before.</p>
<p class="TX">We next declare the new <span class="SANS_TheSansMonoCd_W5Regular_11">find()</span> method. It takes in an integer <span class="SANS_TheSansMonoCd_W5Regular_11">$id</span> argument, which is used to retrieve a single <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> object from the database table. Again, the first statement of this method is a <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span> test on the database connection. If the connection is <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span>, this method will immediately return <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span> and finish executing. If the connection isn’t <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span>, we prepare the <span class="SANS_TheSansMonoCd_W5Regular_11">'SELECT * FROM product WHERE id = :id'</span> string as an SQL query. The <span class="SANS_TheSansMonoCd_W5Regular_11">:id</span> at the end is a named PDO placeholder, consisting of a colon followed by an identifier (<span class="SANS_TheSansMonoCd_W5Regular_11">id</span>) for a part of the SQL statement that needs to be filled in by the value of a variable.</p>
<p class="TX">We use the <span class="SANS_TheSansMonoCd_W5Regular_11">bindParam()</span> method of the PDO statement object to connect the placeholder with the value of the <span class="SANS_TheSansMonoCd_W5Regular_11">$id</span> argument <span aria-label="annotation2" class="CodeAnnotation">❷</span>. This mechanism is what makes PDO’s prepared statements safe from SQL injection attacks. The placeholder syntax forces the value of <span class="SANS_TheSansMonoCd_W5Regular_11">$id</span> to be treated as a possible value to look for in the <span class="SANS_TheSansMonoCd_W5Regular_11">id</span> column. The value of the variable can’t possibly change the query itself into something more malicious.</p>
<p class="TX">The method uses PDO’s object fetch mode to retrieve the result of the query as a <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> object (or <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span> if no product in the database has a matching ID). Notice that we obtain the <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> object by calling <span class="SANS_TheSansMonoCd_W5Regular_11">$stmt-&gt;fetch()</span> <span aria-label="annotation3" class="CodeAnnotation">❸</span> rather than <span class="SANS_TheSansMonoCd_W5Regular_11">$stmt-&gt;fetchAll()</span> as we did in the <span class="SANS_TheSansMonoCd_W5Regular_11">findAll()</span> method, since this <span aria-label="558" epub:type="pagebreak" id="pg_558" role="doc-pagebreak"/>time we’re expecting only a single result. Since the <span class="SANS_TheSansMonoCd_W5Regular_11">fetch()</span> method returns <span class="SANS_TheSansMonoCd_W5Regular_11">false</span> (not <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span>) on failure, we test for this value and return <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span> if no object was successfully retrieved <span aria-label="annotation4" class="CodeAnnotation">❹</span>.</p>
</section>
<section aria-labelledby="sec10" epub:type="division">
<h4 class="H2" id="sec10"><span id="toc-link_368"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Implementing the Controller Logic</span></h4>
<p class="TNI1">Next, we’ll focus on the classes that implement the application’s controller logic. First, we’ll remove the database-related code from the <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class (since that code now lives in <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span>) and update the class to take in requests and delegate them to the appropriate controller. Modify <i>src/Application.php</i> to match the contents of <a href="#lis28-10">Listing 28-10</a>.</p>
<span id="lis28-10"/>
<pre><code>&lt;?php&#13;
namespace Mattsmithdev;&#13;
&#13;
class Application&#13;
{&#13;
    private DefaultController $defaultController;&#13;
    private ProductController $productController;&#13;
&#13;
    public function __construct()&#13;
    {&#13;
        $this-&gt;defaultController = new DefaultController();&#13;
        $this-&gt;productController = new ProductController();&#13;
    }&#13;
&#13;
    public function run(): void&#13;
    {&#13;
        $action = filter_input(INPUT_GET, 'action');&#13;
&#13;
        switch ($action)&#13;
        {&#13;
            case 'products': <span aria-label="annotation1" class="codewide_CodeAnnotation">❶</span>&#13;
                $this-&gt;productController-&gt;list();&#13;
                break;&#13;
&#13;
            case 'show': <span aria-label="annotation2" class="codewide_CodeAnnotation">❷</span>&#13;
                $id = filter_input(INPUT_GET, 'id', FILTER_SANITIZE_NUMBER_INT);&#13;
                if (empty($id)) {<span aria-label="annotation3" class="codewide_CodeAnnotation">❸</span>&#13;
                    $this-&gt;defaultController-&gt;&#13;
error('error - To show a product, an integer ID must be provided');&#13;
                } else {<span aria-label="annotation4" class="codewide_CodeAnnotation">❹</span>&#13;
                    $this-&gt;productController-&gt;show($id);&#13;
                }&#13;
                break;&#13;
&#13;
            default: <span aria-label="annotation5" class="codewide_CodeAnnotation">❺</span>&#13;
                $this-&gt;defaultController-&gt;homepage();&#13;
        }&#13;
    }&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 28-10: The updated</span> <span class="TheSansMonoCd_W5Regular_Italic_11">Application</span> <span class="SANS_Futura_Std_Book_Oblique_11">class with simple front-controller logic</span></p>
<p class="TX"><span aria-label="559" epub:type="pagebreak" id="pg_559" role="doc-pagebreak"/>We declare two private <span class="SANS_TheSansMonoCd_W5Regular_11">defaultController</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">productController</span> properties and then use the constructor to fill them with <span class="SANS_TheSansMonoCd_W5Regular_11">DefaultController</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span> objects. Then we declare the <span class="SANS_TheSansMonoCd_W5Regular_11">run()</span> method, which retrieves the value of <span class="SANS_TheSansMonoCd_W5Regular_11">$action</span> from the incoming URL and passes it to a <span class="SANS_TheSansMonoCd_W5Regular_11">switch</span> statement to decide what to do. If the value is <span class="SANS_TheSansMonoCd_W5Regular_11">'products'</span> <span aria-label="annotation1" class="CodeAnnotation">❶</span>, we invoke the <span class="SANS_TheSansMonoCd_W5Regular_11">list()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span> object to display the page listing all the products.</p>
<p class="TX">If the value of <span class="SANS_TheSansMonoCd_W5Regular_11">$action</span> is <span class="SANS_TheSansMonoCd_W5Regular_11">'show'</span> <span aria-label="annotation2" class="CodeAnnotation">❷</span>, we want to display a page with details about just one product. For that, we attempt to extract an integer <span class="SANS_TheSansMonoCd_W5Regular_11">$id</span> variable from the URL, using <span class="SANS_TheSansMonoCd_W5Regular_11">FILTER_SANITIZE_NUMBER_INT</span> to remove any non-integer characters from the variable. If <span class="SANS_TheSansMonoCd_W5Regular_11">$id</span> ends up being empty <span aria-label="annotation3" class="CodeAnnotation">❸</span>, we display an error page by passing a string error message to the <span class="SANS_TheSansMonoCd_W5Regular_11">error()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">DefaultController</span> object. If the value of <span class="SANS_TheSansMonoCd_W5Regular_11">$id</span> isn’t empty <span aria-label="annotation4" class="CodeAnnotation">❹</span>, we pass it to the <span class="SANS_TheSansMonoCd_W5Regular_11">show()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span> object to display the product page. Finally, we declare the <span class="SANS_TheSansMonoCd_W5Regular_11">switch</span> statement’s default action <span aria-label="annotation5" class="CodeAnnotation">❺</span>, which is to display the home page by invoking the <span class="SANS_TheSansMonoCd_W5Regular_11">homepage()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">DefaultController</span> object.</p>
<p class="TX">Now we’ll create an abstract <span class="SANS_TheSansMonoCd_W5Regular_11">Controller</span> class that will become the superclass for both our controller classes, <span class="SANS_TheSansMonoCd_W5Regular_11">DefaultController</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span>. Create <i>src/Controller.php</i> containing the contents of <a href="#lis28-11">Listing 28-11</a>. Note that this class is just the same as <span class="Xref">Listing 22-8 on <a href="chapter22.xhtml#pg_436">page 436</a></span>.</p>
<span id="lis28-11"/>
<pre><code>&lt;?php&#13;
namespace Mattsmithdev;&#13;
&#13;
use Twig\Loader\FilesystemLoader;&#13;
use Twig\Environment;&#13;
&#13;
abstract class Controller&#13;
{&#13;
    const PATH_TO_TEMPLATES = __DIR__ . '/../templates';&#13;
&#13;
    protected Environment $twig;&#13;
&#13;
    public function __construct()&#13;
    {&#13;
        $loader = new FilesystemLoader(self::PATH_TO_TEMPLATES);&#13;
        $this-&gt;twig = new Environment($loader);&#13;
    }&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 28-11: The abstract</span> <span class="TheSansMonoCd_W5Regular_Italic_11">Controller</span> <span class="SANS_Futura_Std_Book_Oblique_11">superclass, providing a</span> <span class="TheSansMonoCd_W5Regular_Italic_11">twig</span> <span class="SANS_Futura_Std_Book_Oblique_11">property</span></p>
<p class="TX">We declare this class to be <span class="SANS_TheSansMonoCd_W5Regular_11">abstract</span> so that it can’t be instantiated. We declare a class a constant for the path to the Twig templates directory. Then we declare a <span class="SANS_TheSansMonoCd_W5Regular_11">twig</span> property with <span class="SANS_TheSansMonoCd_W5Regular_11">protected</span> visibility so that it will be available to methods of subclasses to this class. Within the class’s constructor, we create two Twig objects: <span class="SANS_TheSansMonoCd_W5Regular_11">FilesystemLoader</span> object and <span class="SANS_TheSansMonoCd_W5Regular_11">Environment</span>. The latter holds the all-important <span class="SANS_TheSansMonoCd_W5Regular_11">render()</span> method and is stored in the <span class="SANS_TheSansMonoCd_W5Regular_11">twig</span> property, while the former helps the <span class="SANS_TheSansMonoCd_W5Regular_11">Environment</span> object access the template files.</p>
<p class="TX"><span aria-label="560" epub:type="pagebreak" id="pg_560" role="doc-pagebreak"/>With this <span class="SANS_TheSansMonoCd_W5Regular_11">Controller</span> superclass declared, we can now declare the subclasses that will inherit from it. We’ll start with <span class="SANS_TheSansMonoCd_W5Regular_11">DefaultController</span>, which will handle displaying the home page and error page. Declare the class in <i>src/DefaultController.php</i> as shown in <a href="#lis28-12">Listing 28-12</a>.</p>
<span id="lis28-12"/>
<pre><code>&lt;?php&#13;
namespace Mattsmithdev;&#13;
&#13;
class DefaultController extends Controller&#13;
{&#13;
  <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> public function homepage(): void&#13;
    {&#13;
        $template = 'home.xhtml.twig';&#13;
        $args = [];&#13;
        print $this-&gt;twig-&gt;render($template, $args);&#13;
    }&#13;
&#13;
  <span aria-label="annotation2" class="Code_CodeAnnotation">❷</span> public function error(string $message): void&#13;
    {&#13;
        $template = 'error.xhtml.twig';&#13;
        $args = [&#13;
            'message' =&gt; $message&#13;
        ];&#13;
        print $this-&gt;twig-&gt;render($template, $args);&#13;
    }&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 28-12: The</span> <span class="TheSansMonoCd_W5Regular_Italic_11">DefaultController</span> <span class="SANS_Futura_Std_Book_Oblique_11">class for simple page actions</span></p>
<p class="TX">We declare that this class extends <span class="SANS_TheSansMonoCd_W5Regular_11">Controller</span> so that it will inherit the superclass’s <span class="SANS_TheSansMonoCd_W5Regular_11">twig</span> property. The class’s <span class="SANS_TheSansMonoCd_W5Regular_11">homepage()</span> method <span aria-label="annotation1" class="CodeAnnotation">❶</span> invokes the <span class="SANS_TheSansMonoCd_W5Regular_11">render()</span> method of the inherited <span class="SANS_TheSansMonoCd_W5Regular_11">twig</span> property to render the <i>home.xhtml.twig</i> template, then prints out the text received. Similarly, the <span class="SANS_TheSansMonoCd_W5Regular_11">error()</span> method <span aria-label="annotation2" class="CodeAnnotation">❷</span> renders and prints the <i>error.xhtml.twig</i> template. For this template, we pass along the value of the <span class="SANS_TheSansMonoCd_W5Regular_11">$message</span> argument so that the error page will include a custom error message.</p>
<p class="TX">Now we’ll create the other controller subclass, <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span>, for displaying product-related pages. Create <i>src/ProductController.php</i> to match the code in <a href="#lis28-13">Listing 28-13</a>.</p>
<span id="lis28-13"/>
<pre><code>&lt;?php&#13;
namespace Mattsmithdev;&#13;
&#13;
class ProductController extends Controller&#13;
{&#13;
    private ProductRepository $productRepository;&#13;
&#13;
    public function __construct()&#13;
    {&#13;
        parent::__construct();&#13;
        $this-&gt;productRepository = new ProductRepository();&#13;
    }&#13;
&#13;
<span aria-label="561" epub:type="pagebreak" id="pg_561" role="doc-pagebreak"/>  <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> public function list(): void&#13;
    {&#13;
        $products = $this-&gt;productRepository-&gt;findAll();&#13;
&#13;
        $template = 'product/list.xhtml.twig';&#13;
        $args = [&#13;
            'products' =&gt; $products&#13;
        ];&#13;
        print $this-&gt;twig-&gt;render($template, $args);&#13;
    }&#13;
&#13;
  <span aria-label="annotation2" class="Code_CodeAnnotation">❷</span> public function show(int $id): void&#13;
    {&#13;
        $product = $this-&gt;productRepository-&gt;find($id);&#13;
&#13;
        if (empty($product)) {&#13;
            $defaultController = new DefaultController();&#13;
            $defaultController-&gt;error(&#13;
                'error - No product found with ID = ' . $id);&#13;
        } else {&#13;
            $template = 'product/show.xhtml.twig';&#13;
            $args = [&#13;
                'product' =&gt; $product&#13;
            ];&#13;
            print $this-&gt;twig-&gt;render($template, $args);&#13;
        }&#13;
    }&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 28-13: The</span> <span class="TheSansMonoCd_W5Regular_Italic_11">ProductController</span> <span class="SANS_Futura_Std_Book_Oblique_11">class</span></p>
<p class="TX">Like <span class="SANS_TheSansMonoCd_W5Regular_11">DefaultController</span>, this class is declared as extending <span class="SANS_TheSansMonoCd_W5Regular_11">Controller</span>. Its constructor method first invokes the parent (<span class="SANS_TheSansMonoCd_W5Regular_11">Controller</span>) constructor, which sets up the inherited <span class="SANS_TheSansMonoCd_W5Regular_11">twig</span> property. Then the constructor creates a new <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> object and stores it in the <span class="SANS_TheSansMonoCd_W5Regular_11">productRepository</span> property. The class will be able to use this object to get product information from the database.</p>
<p class="TX">The class’s <span class="SANS_TheSansMonoCd_W5Regular_11">list()</span> method <span aria-label="annotation1" class="CodeAnnotation">❶</span> obtains an array of <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> objects by invoking the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> object’s <span class="SANS_TheSansMonoCd_W5Regular_11">findAll()</span> method. Then it renders and prints the <i>list.xhtml.twig</i> template, passing along the array of products, to display the full product list page. The <span class="SANS_TheSansMonoCd_W5Regular_11">show()</span> method <span aria-label="annotation2" class="CodeAnnotation">❷</span> is similar to <span class="SANS_TheSansMonoCd_W5Regular_11">list()</span>, but it uses the provided integer <span class="SANS_TheSansMonoCd_W5Regular_11">$id</span> argument to retrieve a single <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> object from the database (via the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> object’s <span class="SANS_TheSansMonoCd_W5Regular_11">find()</span> method). Then it displays a page with just this product’s information by rendering and printing the <i>show.xhtml.twig</i> template. The <span class="SANS_TheSansMonoCd_W5Regular_11">if</span> statement in this method tests whether <span class="SANS_TheSansMonoCd_W5Regular_11">NULL</span> was received from the repository instead of an object, indicating no product with the provided ID exists in the database. If so, an error page will be displayed.</p>
</section>
<section aria-labelledby="sec11" epub:type="division">
<h4 class="H2" id="sec11"><span id="toc-link_369"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Designing the Templates</span></h4>
<p class="TNI1">All that remains is to design the Twig templates for the application’s various pages. The templates will all extend a common base template that <span aria-label="562" epub:type="pagebreak" id="pg_562" role="doc-pagebreak"/>defines the HTML skeleton for each page and includes the Bootstrap CSS stylesheets. We’ll write that base template first. Create <i>templates/base.xhtml.twig</i> containing the Twig code in <a href="#lis28-14">Listing 28-14</a>.</p>
<span id="lis28-14"/>
<pre><code>&lt;html lang="en"&gt;&#13;
&lt;head&gt;&#13;
    &lt;title&gt;MGW - {% block title %}{% endblock %}&lt;/title&gt; <span aria-label="annotation1" class="codewide_CodeAnnotation">❶</span>&#13;
    &lt;meta name="viewport" content="width=device-width"&gt;&#13;
    &lt;link rel="stylesheet"&#13;
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"&gt;&#13;
&lt;/head&gt;&#13;
&#13;
&lt;body class="container"&gt;&#13;
&lt;ul class="nav nav-pills"&gt; <span aria-label="annotation2" class="codewide_CodeAnnotation">❷</span>&#13;
    &lt;li class="nav-item"&gt;&#13;
        &lt;a class="nav-link {% block homeLink %}{% endblock %}" href="/"&gt;Home page&lt;/a&gt;&#13;
    &lt;/li&gt;&#13;
    &lt;li class="nav-item"&gt;&#13;
        &lt;a class="nav-link {% block productLink %}{% endblock %}"&#13;
           href="/?action=products"&gt;Product List page&lt;/a&gt;&#13;
    &lt;/li&gt;&#13;
&lt;/ul&gt;&#13;
&#13;
{% block body %} <span aria-label="annotation3" class="codewide_CodeAnnotation">❸</span>&#13;
{% endblock %}&#13;
&lt;/body&gt;&lt;/html&gt;</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 28-14: The top-level</span> <span class="SANS_Futura_Std_Book_11">base.xhtml.twig</span> <span class="SANS_Futura_Std_Book_Oblique_11">template</span></p>
<p class="TX">The HTML <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;head&gt;</span> element includes a Twig <span class="SANS_TheSansMonoCd_W5Regular_11">title</span> block where the page title can be inserted <span aria-label="annotation1" class="CodeAnnotation">❶</span>. Each individual page template will declare its own title to be appended to the <span class="SANS_TheSansMonoCd_W5Regular_11">MGW</span> text immediately before this block. The <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;head&gt;</span> element also contains a link to download the Bootstrap 5 minimized stylesheets from <i><a href="https://www.jsdelivr.com">https://www.jsdelivr.com</a></i>.</p>
<p class="TX">Inside the HTML <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;body&gt;</span>, we declare an unordered list styled with the <span class="SANS_TheSansMonoCd_W5Regular_11">nav nav-pills</span> CSS class to represent the navigation bar at the top of each page <span aria-label="annotation2" class="CodeAnnotation">❷</span>. We want the bar to include links to the home page and the product list. We declare each item as a list element styled with the <span class="SANS_TheSansMonoCd_W5Regular_11">nav-item</span> CSS class and an anchor link element styled with the <span class="SANS_TheSansMonoCd_W5Regular_11">nav-link</span> CSS class. The class declaration for each anchor link element features an empty Twig block (called <span class="SANS_TheSansMonoCd_W5Regular_11">homeLink</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">productLink</span>, respectively), which we can override in the page templates to add the <span class="SANS_TheSansMonoCd_W5Regular_11">active</span> CSS class. This way, the current page will be highlighted in the navigation bar. The base template ends with a <span class="SANS_TheSansMonoCd_W5Regular_11">body</span> Twig block, where we’ll fill in the page-specific content <span aria-label="annotation3" class="CodeAnnotation">❸</span>.</p>
<p class="TX">Now that we have the base Twig template, we can begin declaring the individual child templates, starting with the home page. Create the new Twig template <i>templates/home.xhtml.twig</i> containing the code in <a href="#lis28-15">Listing 28-15</a>.</p>
<span id="lis28-15"/>
<pre><code><span aria-label="563" epub:type="pagebreak" id="pg_563" role="doc-pagebreak"/>{% extends 'base.xhtml.twig' %}&#13;
&#13;
{% block title %}Home page{% endblock %}&#13;
&#13;
{% block homeLink %}active{% endblock %}&#13;
&#13;
{% block body %}&#13;
    &lt;h1&gt;Home page&lt;/h1&gt;&#13;
    &lt;p&gt;&#13;
        Welcome to the home page&#13;
    &lt;/p&gt;&#13;
{% endblock %}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 28-15: The</span> <span class="SANS_Futura_Std_Book_11">home.xhtml.twig</span> <span class="SANS_Futura_Std_Book_Oblique_11">template for the home page</span></p>
<p class="TX">We first declare that this template extends the base template. As such, the file is very short, since we have to fill in only the page-specific content. We override the <span class="SANS_TheSansMonoCd_W5Regular_11">title</span> block with the text content <span class="SANS_TheSansMonoCd_W5Regular_11">home page</span> so that the page’s title will be <span class="SANS_TheSansMonoCd_W5Regular_11">MGW - home page</span>. Then we override the <span class="SANS_TheSansMonoCd_W5Regular_11">homeLink</span> block with the text content <span class="SANS_TheSansMonoCd_W5Regular_11">active</span>, so the home page link will appear as a colored button when this template page is displayed. Finally, we override the <span class="SANS_TheSansMonoCd_W5Regular_11">body</span> block with a basic heading and paragraph.</p>
<p class="TX">Now we’ll create the Twig template for the error page. Enter the contents of <a href="#lis28-16">Listing 28-16</a> into <i>templates/error.xhtml.twig</i>.</p>
<span id="lis28-16"/>
<pre><code>{% extends 'base.xhtml.twig' %}&#13;
&#13;
{% block title %}error page{% endblock %}&#13;
&#13;
{% block body %}&#13;
    &lt;h1&gt;Error&lt;/h1&gt;&#13;
    &lt;p class="alert alert-danger"&gt;&#13;
        {{message}}&#13;
    &lt;/p&gt;&#13;
{% endblock %}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 28-16: The</span> <span class="SANS_Futura_Std_Book_11">error.xhtml.twig</span> <span class="SANS_Futura_Std_Book_Oblique_11">template for the error page</span></p>
<p class="TX">First, we override the <span class="SANS_TheSansMonoCd_W5Regular_11">title</span> block with the text content <span class="SANS_TheSansMonoCd_W5Regular_11">error page</span>, making this page’s title <span class="SANS_TheSansMonoCd_W5Regular_11">MGW - error page</span>. Then we override the <span class="SANS_TheSansMonoCd_W5Regular_11">body</span> block with a heading and paragraph. The paragraph is styled with the <span class="SANS_TheSansMonoCd_W5Regular_11">alert alert-danger</span> CSS class to make it a nicely spaced, pink warning message to the viewer. The text content of this paragraph is the Twig <span class="SANS_TheSansMonoCd_W5Regular_11">message</span> variable, which will be passed in via the <span class="SANS_TheSansMonoCd_W5Regular_11">$args</span> array from the <span class="SANS_TheSansMonoCd_W5Regular_11">DefaultController</span> class’s <span class="SANS_TheSansMonoCd_W5Regular_11">error()</span> method. <a href="#fig28-5">Figure 28-5</a> shows this error page displayed in a web browser.</p>
<span aria-label="564" epub:type="pagebreak" id="pg_564" role="doc-pagebreak"/>
<figure class="IMG"><a id="fig28-5"/><img alt="" class="img80" height="527" src="../images/figure28-5.jpg" width="1150"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 28-5: The error page when an integer product ID hasn’t been provided</span></p></figcaption>
</figure>
<p class="TX">Next, we’ll create a Twig template for the Product List page in <i>templates/product/list.xhtml.twig</i>.</p>
<p class="TX">To prepare for templates for other model classes, we create a subdirectory of <i>templates</i> named <i>product</i>, and we will create our templates for the <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> class here. Also, since templates for the <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> class are in this folder, we don’t need to prefix the template names with the class name. For example, we can name this list template <i>list.xhtml.twig</i> rather than <i>productList.xhtml.twig</i> and so on.</p>
<p class="TX">The code for <i>templates/product/list.xhtml.twig</i> is shown in <a href="#lis28-17">Listing 28-17</a>.</p>
<span id="lis28-17"/>
<pre><code>{% extends 'base.xhtml.twig' %}&#13;
&#13;
{% block title %}Product List page{% endblock %}&#13;
&#13;
{% block productLink %}active{% endblock %}&#13;
&#13;
{% block body %}&#13;
    &lt;h1&gt;Product List page&lt;/h1&gt;&#13;
&#13;
    &lt;ul&gt;&#13;
      <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> {% for product in products %}&#13;
        &lt;li&gt;&#13;
            id: {{product.id}}&#13;
            &lt;br&gt;&#13;
            description: {{  product.description}}&#13;
            &lt;br&gt;&#13;
          <span aria-label="annotation2" class="Code_CodeAnnotation">❷</span> price: $ {{product.price | number_format(2)}}&#13;
            &lt;br&gt;&#13;
          <span aria-label="annotation3" class="Code_CodeAnnotation">❸</span> &lt;a href="/?action=show&amp;id={{product.id}}"&gt;(show)&lt;/a&gt;&#13;
        &lt;/li&gt;&#13;
&#13;
        {% endfor %}&#13;
    &lt;/ul&gt;&#13;
{% endblock %}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 28-17: The</span> <span class="SANS_Futura_Std_Book_11">list.xhtml.twig</span> <span class="SANS_Futura_Std_Book_Oblique_11">template for listing all products</span></p>
<p class="TX"><span aria-label="565" epub:type="pagebreak" id="pg_565" role="doc-pagebreak"/>We override the <span class="SANS_TheSansMonoCd_W5Regular_11">title</span> block with the text content <span class="SANS_TheSansMonoCd_W5Regular_11">product list page</span> and override the <span class="SANS_TheSansMonoCd_W5Regular_11">productLink</span> block with the text content <span class="SANS_TheSansMonoCd_W5Regular_11">active</span>, much as we did for the home page. Then, inside the <span class="SANS_TheSansMonoCd_W5Regular_11">body</span> block, we use a Twig <span class="SANS_TheSansMonoCd_W5Regular_11">for</span> loop <span aria-label="annotation1" class="CodeAnnotation">❶</span> to iterate over the <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> objects in the <span class="SANS_TheSansMonoCd_W5Regular_11">products</span> variable, formatting each one as a list item in an unordered list. (These <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> objects were passed to the template in an array as part of the <span class="SANS_TheSansMonoCd_W5Regular_11">list()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span> class.)</p>
<p class="TX">We extract each property of each object individually for display on its own line, using Twig’s double curly bracket notation. For example, <span class="SANS_TheSansMonoCd_W5Regular_11">{{product.id}}</span> accesses the <span class="SANS_TheSansMonoCd_W5Regular_11">id</span> property of the current <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> object. Notice that we format the product’s price to include two decimal places <span aria-label="annotation2" class="CodeAnnotation">❷</span>. Each product’s list item ends with an anchor link element to show the details page for just that one product <span aria-label="annotation3" class="CodeAnnotation">❸</span>. We insert the product’s ID into the link’s URL. This ID, in turn, will be passed to the <span class="SANS_TheSansMonoCd_W5Regular_11">find()</span> method of the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> class to retrieve just that product’s information from the database.</p>
<p class="TX">Finally, we’ll create the individual Product Details page template in <i>templates/product/show.xhtml.twig</i>. <a href="#lis28-18">Listing 28-18</a> shows how.</p>
<span id="lis28-18"/>
<pre><code>{% extends 'base.xhtml.twig' %}&#13;
&#13;
{% block title %}Product Details page{% endblock %}&#13;
&#13;
{% block body %}&#13;
    &lt;h1&gt;Product Details page&lt;/h1&gt;&#13;
&#13;
    id: {{product.id}}&#13;
    &lt;br&gt;&#13;
    description: {{  product.description}}&#13;
    &lt;br&gt;&#13;
    price: $ {{product.price | number_format(2)}}&#13;
{% endblock %}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 28-18: The</span> <span class="SANS_Futura_Std_Book_11">show.xhtml.twig</span> <span class="SANS_Futura_Std_Book_Oblique_11">template to display a single product’s details</span></p>
<p class="TX">This template is simpler than the main Product List page template, since only a single <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> object’s properties are being displayed inside the <span class="SANS_TheSansMonoCd_W5Regular_11">body</span> block. The object is the Twig <span class="SANS_TheSansMonoCd_W5Regular_11">product</span> variable that was passed to this template from the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span> class’s <span class="SANS_TheSansMonoCd_W5Regular_11">show()</span> method. Just as in the Product List page template, we output each of the object’s properties individually, accessing them via double curly bracket notation.</p>
<p class="TX">With that, the application is complete. Try launching it and visiting its four pages, clicking the <i>(show)</i> link to view the Product Details page about each product. You should see that the application is able to retrieve all the products from the database, or just one of the products based on the appropriate integer ID. You should also be able to toggle between MySQL and SQLite simply by substituting the <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span> class with the <span class="SANS_TheSansMonoCd_W5Regular_11">SQLiteDatabase</span> class.</p>
</section>
</section>
<section aria-labelledby="sec12" epub:type="division">
<span aria-label="566" epub:type="pagebreak" id="pg_566" role="doc-pagebreak"/>
<h3 class="H1" id="sec12"><span id="toc-link_370"/><span class="SANS_Futura_Std_Bold_B_11">Summary</span></h3>
<p class="TNI1">In this chapter, we explored the basics of PHP’s built-in PDO library for interacting with databases. We used the library to create a database schema and to insert data into a table. We then retrieved data from a table, mapping the results of a query to objects of a PHP model class using PDO’s object fetch mode. We also used prepared SQL statements, which add a layer of protection against SQL injection attacks.</p>
<p class="TX">We integrated our database schema into a well-organized, multipage web application. The code to manage the database connection was abstracted into a suitable class, either <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span> or <span class="SANS_TheSansMonoCd_W5Regular_11">SQLiteDatabase</span>, allowing us to switch seamlessly between MySQL and SQLite as the application’s DBMS. The logic to retrieve data from the database and into <span class="SANS_TheSansMonoCd_W5Regular_11">Product</span> objects was encapsulated in the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> class, front-controller logic was placed in an <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class, and logic for displaying simple pages was located in the <span class="SANS_TheSansMonoCd_W5Regular_11">DefaultController</span> class. Actions relating to requests for one or many products went into the <span class="SANS_TheSansMonoCd_W5Regular_11">ProductController</span> class, which used <span class="SANS_TheSansMonoCd_W5Regular_11">ProductRepository</span> methods to query the database.</p>
<p class="TX">This architecture could easily be scaled up, with additional repository, model, and controller classes for other database tables (users, customers, orders, suppliers, and so on). The entire application was styled using Twig templating, with a base (parent) template to efficiently share common page elements across all the individual child templates.</p>
</section>
<section aria-labelledby="sec13" epub:type="division">
<h3 class="H1" id="sec13"><span id="toc-link_371"/><span class="SANS_Futura_Std_Bold_B_11">Exercises</span></h3>
<p class="ListNumber">1.   Create a new model class called <span class="SANS_TheSansMonoCd_W5Regular_11">Book</span> with the following properties:</p>
<p class="ListPlainSub"><span class="SANS_TheSansMonoCd_W5Regular_11">id</span> (integer), an auto-incrementing primary key</p>
<p class="ListPlainSub"><span class="SANS_TheSansMonoCd_W5Regular_11">title</span> (string)</p>
<p class="ListPlainSub"><span class="SANS_TheSansMonoCd_W5Regular_11">author</span> (string)</p>
<p class="ListPlainSub"><span class="SANS_TheSansMonoCd_W5Regular_11">price</span> (float)</p>
<p class="ListBody">Create a setup script (based on <a href="#lis28-1">Listings 28-1</a> and <a href="#lis28-2">28-2</a>) to create a database with a <span class="SANS_TheSansMonoCd_W5Regular_11">book</span> table, mapped to the <span class="SANS_TheSansMonoCd_W5Regular_11">Book</span> class’s properties and types (use <span class="SANS_TheSansMonoCd_W5Regular_11">int</span>, <span class="SANS_TheSansMonoCd_W5Regular_11">text</span>, and <span class="SANS_TheSansMonoCd_W5Regular_11">float</span> for the SQL data types). Also insert at least two book records into the database table with title, author, and price properties of your choice. Then write an object-oriented project (or adapt the example from this chapter) to retrieve and list all the books from the database. The project should include the following:</p>
<p class="ListPlainSub">A <span class="SANS_TheSansMonoCd_W5Regular_11">Database</span> class to create a connection to your database</p>
<p class="ListPlainSub">A <i>public/index.php</i> script that creates an <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> object and invokes its <span class="SANS_TheSansMonoCd_W5Regular_11">run()</span> method</p>
<p class="ListPlainSub">An <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> class with a <span class="SANS_TheSansMonoCd_W5Regular_11">run()</span> method to get an array of <span class="SANS_TheSansMonoCd_W5Regular_11">Book</span> objects and <span class="SANS_TheSansMonoCd_W5Regular_11">var_dump()</span> them</p>
<p class="ListPlainSub">Your <span class="SANS_TheSansMonoCd_W5Regular_11">Book</span> model class</p>
<p class="ListNumber"><span aria-label="567" epub:type="pagebreak" id="pg_567" role="doc-pagebreak"/>2.   Extend your project from Exercise 1 as follows:</p>
<p class="ListNumberSub">a.   Add getter and setter accessor methods for each property in your <span class="SANS_TheSansMonoCd_W5Regular_11">Book</span> class.</p>
<p class="ListNumberSub">b.   Change your <span class="SANS_TheSansMonoCd_W5Regular_11">Application</span> logic to test for an <span class="SANS_TheSansMonoCd_W5Regular_11">action</span> variable in the URL. The default action should be to display a home page using an appropriate template. If the action is <span class="SANS_TheSansMonoCd_W5Regular_11">books</span>, the application should display a page with information about all the books, using an appropriate template.</p>
</section>
</section>
</div></body></html>