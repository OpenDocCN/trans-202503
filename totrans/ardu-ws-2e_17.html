<html><head></head><body>
		<section>&#13;
			<header>&#13;
				<h1 class="chapter"><span class="ChapterNumber"><span epub:type="pagebreak" id="Page_325" title="325"/>18</span><br/><span class="ChapterTitle">Reading RFID Tags</span></h1>&#13;
			</header>&#13;
			<p class="ChapterIntro">In this chapter you will</p>&#13;
			<ul>&#13;
				<li>Learn how to implement RFID readers with your Arduino</li>&#13;
				<li>See how to save variables in the Arduino EEPROM</li>&#13;
				<li>Design the framework for an Arduino-based RFID access system</li>&#13;
			</ul>&#13;
			<p><em>Radio-frequency identification (RFID)</em> is a wireless system that uses electromagnetic fields to transfer data from one object to another, without the two objects touching. You can build an Arduino that reads common RFID tags and cards to create access systems and to control digital outputs. You may have used an RFID card before, such as an access card that you use to unlock a door or a public transport card that you hold in front of a reader on the bus. <a href="#figure18-1" id="figureanchor18-1">Figure 18-1</a> shows some examples of RFID tags and cards.</p>&#13;
			<span epub:type="pagebreak" id="Page_326" title="326"/>&#13;
			<figure>&#13;
				<img alt="f18001" src="image_fi/500587c18/f18001.png"/>&#13;
				<figcaption>&#13;
					<p><a id="figure18-1">Figure 18-1</a>: Example RFID devices</p>&#13;
				</figcaption>&#13;
			</figure>&#13;
			<h2 id="h1-500587c18-0001">Inside RFID Devices</h2>&#13;
			<p class="BodyFirst">Inside an RFID tag is a tiny integrated circuit with memory that can be accessed by a specialized reader. Most tags don’t have a battery inside; instead, a wire coil antenna in the RFID reader broadcasts a jolt of electromagnetic energy to the tags. They absorb this energy and use it to power their own circuitry, which broadcasts a response back to the RFID reader. <a href="#figure18-2" id="figureanchor18-2">Figure 18-2</a> shows the antenna coil of the RFID reader that we’ll use in this chapter.</p>&#13;
			<figure>&#13;
				<img alt="f18002" src="image_fi/500587c18/f18002.png"/>&#13;
				<figcaption>&#13;
					<p><a id="figure18-2">Figure 18-2</a>: Our RFID reader</p>&#13;
				</figcaption>&#13;
			</figure>&#13;
			<p><span epub:type="pagebreak" id="Page_327" title="327"/>The card reader we’ll use in this chapter is from PMD Way (part number 113990014). It’s cheap and easy to use, and it operates at 125 kHz; be sure to purchase two or more RFID tags that match that frequency, such as those found at <a class="LinkURL" href="https://pmdway.com/collections/rfid-tags/">https://pmdway.com/collections/rfid-tags/</a>.</p>&#13;
			<h2 id="h1-500587c18-0002">Testing the Hardware</h2>&#13;
			<p class="BodyFirst">In this section, you’ll connect the RFID reader to the Arduino. Then you’ll test that it’s working with a simple sketch that reads RFID cards and sends the data to the Serial Monitor. To avoid conflict with the serial port between the PC and Arduino, the RFID will be connected to other digital pins and use SoftwareSerial, as we did in <span class="xref" itemid="xref_target_Chapter 15">Chapter 15</span> with the GPS receiver module.</p>&#13;
			<h3 id="h2-500587c18-0001">The Schematic</h3>&#13;
			<p class="BodyFirst"><a href="#figure18-3" id="figureanchor18-3">Figure 18-3</a> shows a diagram of the RFID module connections, looking at the top side of the module.</p>&#13;
			<figure>&#13;
				<img alt="f18003" src="image_fi/500587c18/f18003.png"/>&#13;
				<figcaption>&#13;
					<p><a id="figure18-3">Figure 18-3</a>: RFID module connections</p>&#13;
				</figcaption>&#13;
			</figure>&#13;
			<h3 id="h2-500587c18-0002">Testing the Schematic</h3>&#13;
			<p class="BodyFirst">To make the connections between the RFID reader and the Arduino, follow these steps, using female-to-male jumper wires:</p>&#13;
			<ol class="decimal">&#13;
				<li value="1">Connect the included coil plug to the antenna pins at the bottom left of the RFID reader board. They are not polarized and can connect either way.</li>&#13;
				<li value="2">Connect the reader’s GND (pin 2) to Arduino GND.</li>&#13;
				<li value="3">Connect the reader’s 5 V (pin 1) to Arduino 5 V.</li>&#13;
				<li value="4">Connect the reader’s RX (pin 4) to Arduino pin D3.</li>&#13;
				<li value="5">Connect the reader’s TX (pin 5) to Arduino pin D2.</li>&#13;
			</ol>&#13;
			<h3 id="h2-500587c18-0003">The Test Sketch</h3>&#13;
			<p class="BodyFirst">Enter and upload <a href="#listing18-1" id="listinganchor18-1">Listing 18-1</a>.</p>&#13;
			<pre><code>// Listing 18-1&#13;
#include &lt;SoftwareSerial.h&gt;&#13;
SoftwareSerial Serial2(2, 3); &#13;
int data1 = 0;&#13;
void setup()<span epub:type="pagebreak" id="Page_328" title="328"/>{ Serial.begin(9600); Serial2.begin(9600);&#13;
}&#13;
void loop() &#13;
{ if (Serial2.available() &gt; 0) { data1 = Serial2.read(); // display incoming number Serial.print(" "); Serial.print(data1, DEC); }</code></pre>&#13;
			<p class="CodeListingCaption"><a id="listing18-1">Listing 18-1</a>: RFID test sketch</p>&#13;
			<h3 id="h2-500587c18-0004">Displaying the RFID Tag ID Number</h3>&#13;
			<p class="BodyFirst">Open the Serial Monitor window and wave an RFID tag over the coil. The results should look similar to <a href="#figure18-4" id="figureanchor18-4">Figure 18-4</a>.</p>&#13;
			<figure>&#13;
				<img alt="f18004" src="image_fi/500587c18/f18004.png"/>&#13;
				<figcaption>&#13;
					<p><a id="figure18-4">Figure 18-4</a>: Example output from <a href="#listing18-1">Listing 18-1</a></p>&#13;
				</figcaption>&#13;
			</figure>&#13;
			<p>Notice that 14 numbers are displayed in the Serial Monitor window. Collectively, these are the RFID tag’s unique ID number, which we’ll use in future sketches to identify the tag being read. Scan all your RFID tags and record their ID numbers, because you’ll need them for the next few projects.</p>&#13;
			<h2 class="HeadProject" id="h1-500587c18-0003"><span>Project #52: Creating a Simple RFID Control System</span></h2>&#13;
			<p class="BodyFirst">Now let’s put the RFID system to use. In this project, you’ll learn how to trigger an Arduino event when one of two correct RFID tags is read. The sketch stores two RFID tag numbers; when a card whose ID matches one of those numbers is read by the reader, it will display <em>Accepted</em> in the Serial Monitor. If a card whose ID does not match one of the stored IDs is presented, then the Serial Monitor will display <em>Rejected</em>. We’ll use this as a base to add RFID controls to existing projects.</p>&#13;
			<h3 id="h2-500587c18-0005"><span epub:type="pagebreak" id="Page_329" title="329"/>The Sketch</h3>&#13;
			<p class="BodyFirst">Enter and upload the following sketch. However, at <span aria-label="annotation1" class="CodeAnnotation">1</span> and <span aria-label="annotation2" class="CodeAnnotation">2</span>, replace the <var>x</var>’s in the array with the set of numbers you noted for two of your RFID tags in the previous section. (We discussed arrays in <span class="xref" itemid="xref_target_Chapter 6">Chapter 6</span>.)</p>&#13;
			<pre><code>// Project 52 – Creating a Simple RFID Control System&#13;
#include &lt;SoftwareSerial.h&gt;&#13;
SoftwareSerial Serial2(2, 3);&#13;
int data1 = 0;&#13;
int ok = -1;&#13;
// use Listing 18-1 to find your tags' numbers<span aria-label="annotation1" class="CodeAnnotationHang">1</span> int tag1[14] = {<em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>};<span aria-label="annotation2" class="CodeAnnotationHang">2</span> int tag2[14] = {<em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>};&#13;
int newtag[14] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};&#13;
// used for read comparisons<span aria-label="annotation3" class="CodeAnnotationHang">3</span> boolean comparetag(int aa[14], int bb[14])&#13;
{ boolean ff = false; int fg = 0; for (int cc = 0 ; cc &lt; 14 ; cc++) { if (aa[cc] == bb[cc]) { fg++; } } if (fg == 14) { ff = true; } return ff;&#13;
}<span aria-label="annotation4" class="CodeAnnotationHang">4</span> void checkmytags() // compares each tag against the tag just read&#13;
{ ok = 0;          // This variable supports decision making. // If it is 1, we have a match; 0 is a read but no match, // -1 is no read attempt made. if (comparetag(newtag, tag1) == true) {<span aria-label="annotation5" class="CodeAnnotationHang">5</span>     ok++; } if (comparetag(newtag, tag2) == true) {<span aria-label="annotation6" class="CodeAnnotationHang">6</span>     ok++; }&#13;
}&#13;
void setup()<span epub:type="pagebreak" id="Page_330" title="330"/>{ Serial.begin(9600); Serial2.begin(9600); Serial2.flush(); // need to flush serial buffer // otherwise first read may not be correct&#13;
}&#13;
void loop()&#13;
{ ok = -1; if (Serial2.available() &gt; 0)     // if a read has been attempted { // read the incoming number on serial RX delay(100); // needed to allow time for the data // to come in from the serial buffer<span aria-label="annotation7" class="CodeAnnotationHang">7</span>     for (int z = 0 ; z &lt; 14 ; z++) // read the rest of the tag { data1 = Serial2.read(); newtag[z] = data1; } Serial2.flush(); // stops multiple reads // now to match tags up<span aria-label="annotation8" class="CodeAnnotationHang">8</span>     checkmytags(); }<span aria-label="annotation9" class="CodeAnnotationHang">9</span>   // now do something based on tag type if (ok &gt; 0)        // if we had a match { Serial.println("Accepted"); ok = -1; } else if (ok == 0)  // if we didn't have a match { Serial.println("Rejected"); ok = -1; }&#13;
}</code></pre>&#13;
			<h3 id="h2-500587c18-0006">Understanding the Sketch</h3>&#13;
			<p class="BodyFirst">When a tag is presented to the RFID reader, it sends the tag’s numbers, which collectively are its ID number, through the serial port. We capture all 14 of these numbers and place them in the array <code>newtag[]</code> at <span aria-label="annotation7" class="CodeAnnotation">7</span>. Next, the tag ID is compared against the two tag ID numbers stored at <span aria-label="annotation1" class="CodeAnnotation">1</span> and <span aria-label="annotation2" class="CodeAnnotation">2</span> using the function <code>checkmytags()</code> at <span aria-label="annotation4" class="CodeAnnotation">4</span> and <span aria-label="annotation8" class="CodeAnnotation">8</span>, with the actual comparisons of the tag arrays performed by the function <code>comparetag()</code> at <span aria-label="annotation3" class="CodeAnnotation">3</span>.</p>&#13;
			<p>&#13;
				The <code>comparetag()</code> function accepts the two number arrays as parameters and returns (in Boolean) whether the arrays are identical (<code>true</code>) or different (<code>false</code>). If a match is made, the variable <code>ok</code> is set to <code>1</code> at <span aria-label="annotation5" class="CodeAnnotation">5</span> and <span aria-label="annotation6" class="CodeAnnotation">6</span>. Finally, at <span aria-label="annotation9" class="CodeAnnotation">9</span>, we have the actions to take once the tag read succeeds.</p>&#13;
			<p><span epub:type="pagebreak" id="Page_331" title="331"/>After uploading the sketch, open the Serial Monitor window and present some tags to the reader. The results should be similar to those in <a href="#figure18-5" id="figureanchor18-5">Figure 18-5</a>.</p>&#13;
			<figure>&#13;
				<img alt="f18005" src="image_fi/500587c18/f18005.png"/>&#13;
				<figcaption>&#13;
					<p><a id="figure18-5">Figure 18-5</a>: Results of Project 52</p>&#13;
				</figcaption>&#13;
			</figure>&#13;
			<h2 id="h1-500587c18-0004">Storing Data in the Arduino’s Built-in EEPROM</h2>&#13;
			<p class="BodyFirst">When you define and use a variable in your Arduino sketches, the stored data lasts only until the Arduino is reset or the power is turned off. But what if you want to keep the values for future use, as in the case of the user-changeable secret code for the numeric keypad in <span class="xref" itemid="xref_target_Chapter 11">Chapter 11</span>? That’s where the <em>EEPROM (electrically erasable read-only memory) </em>comes in. The EEPROM stores variables in memory inside an ATmega328 microcontroller, and the values aren’t lost when the power is turned off.</p>&#13;
			<p>The EEPROM in the Arduino can store 1,024-byte variables in positions numbered from 0 to 1,023. Recall that a byte can store an integer with a value between 0 and 255, and you begin to see why it’s perfect for storing RFID tag numbers. To use the EEPROM in our sketches, we first call the EEPROM library (included with the Arduino IDE) using the following:</p>&#13;
			<pre><code>#include &lt;EEPROM.h&gt;</code></pre>&#13;
			<p>Then, to write a value to the EEPROM, we simply use this:</p>&#13;
			<pre><code>EEPROM.write(<em>a</em>, <em>b</em>);</code></pre>&#13;
			<p>&#13;
				Here, <var>a</var> is the position in the EEPROM memory where the information will be stored, and <var>b</var> is the variable holding the information we want to store in the EEPROM at position <var>a</var>.</p>&#13;
			<p>To retrieve data from the EEPROM, we use this function:</p>&#13;
			<pre><code><em>value</em> = EEPROM.read<em>(position)</em>; </code></pre>&#13;
			<p>&#13;
				This takes the data stored in EEPROM position number <var>position</var> and stores it in the variable <var>value</var>.</p>&#13;
			<aside epub:type="sidebar">&#13;
				<div class="top hr">&#13;
					<hr/>&#13;
				</div>&#13;
				<section class="note"><span epub:type="pagebreak" id="Page_332" title="332"/>&#13;
				<h2><span class="NoteHead">NOTE</span></h2>&#13;
					<p>	The EEPROM has a finite life, and it can eventually wear out! According to the manufacturer, Atmel, it can sustain 100,000 write/erase cycles for each position. Reads are unlimited.</p>&#13;
					<div class="bottom hr">&#13;
						<hr/>&#13;
					</div>&#13;
				</section>&#13;
			</aside>&#13;
			<h3 id="h2-500587c18-0007">Reading and Writing to the EEPROM</h3>&#13;
			<p class="BodyFirst">Here’s an example of how to read and write to the EEPROM. Enter and upload <a href="#listing18-2" id="listinganchor18-2">Listing 18-2</a>.</p>&#13;
			<pre><code>// Listing 18-2&#13;
#include &lt;EEPROM.h&gt;&#13;
int zz;&#13;
void setup()&#13;
{ Serial.begin(9600); randomSeed(analogRead(0));&#13;
}&#13;
void loop()&#13;
{ Serial.println("Writing random numbers..."); for (int i = 0; i &lt; 1024; i++)  { zz = random(255);<span aria-label="annotation1" class="CodeAnnotationHang">1</span>     EEPROM.write(i, zz);  } Serial.println(); for (int a = 0; a &lt; 1024; a++) {<span aria-label="annotation2" class="CodeAnnotationHang">2</span>     zz = EEPROM.read(a);  Serial.print("EEPROM position: "); Serial.print(a); Serial.print(" contains ");<span aria-label="annotation3" class="CodeAnnotationHang">3</span>     Serial.println(zz);  delay(25); }&#13;
}</code></pre>&#13;
			<p class="CodeListingCaption"><a id="listing18-2">Listing 18-2</a>: EEPROM demonstration sketch</p>&#13;
			<p>&#13;
				In the loop at <span aria-label="annotation1" class="CodeAnnotation">1</span>, a random number between 0 and 255 is stored in each EEPROM position. The stored values are retrieved in the second loop at <span aria-label="annotation2" class="CodeAnnotation">2</span>, to be displayed in the Serial Monitor at <span aria-label="annotation3" class="CodeAnnotation">3</span>.</p>&#13;
			<p>&#13;
				Once the sketch has been uploaded, open the Serial Monitor. You should see something like <a href="#figure18-6" id="figureanchor18-6">Figure 18-6</a>.</p>&#13;
				<span epub:type="pagebreak" id="Page_333" title="333"/>&#13;
				<figure>&#13;
				<img alt="f18006" src="image_fi/500587c18/f18006.png"/>&#13;
				<figcaption>&#13;
					<p><a id="figure18-6">Figure 18-6</a>: Example output from <a href="#listing18-2">Listing 18-2</a></p>&#13;
				</figcaption>&#13;
			</figure>&#13;
			<p>Now you’re ready to create a project using the EEPROM.</p>&#13;
			<h2 class="HeadProject" id="h1-500587c18-0005"><span>Project #53: Creating an RFID Control with “Last Action” Memory</span></h2>&#13;
			<p class="BodyFirst">Although Project 52 showed how to use RFID to control something, such as a light or electric door lock, we had to assume that nothing would be remembered if the system were reset or the power went out. For example, if a light was on and the power went out, then the light would be off when the power returned. However, you may prefer the Arduino to remember what was happening before the power went out and return to that state. Let’s solve that problem now.</p>&#13;
			<p>In this project, the last action will be stored in the EEPROM (for example, “locked” or “unlocked”). When the sketch restarts after a power failure or an Arduino reset, the system will revert to the previous state stored in the EEPROM.</p>&#13;
			<h3 id="h2-500587c18-0008">The Sketch</h3>&#13;
			<p class="BodyFirst">Enter and upload the following sketch. As you did for Project 52, replace each <var>x</var> in the arrays at <span aria-label="annotation1" class="CodeAnnotation">1</span> and <span aria-label="annotation2" class="CodeAnnotation">2</span> with the numbers for two of your RFID tags.</p>&#13;
			<pre><code>// Project 53 – Creating an RFID Control with "Last Action" Memory&#13;
#include &lt;SoftwareSerial.h&gt;&#13;
SoftwareSerial Serial2(2, 3);&#13;
#include &lt;EEPROM.h&gt;&#13;
int data1 = 0;&#13;
int ok = -1;&#13;
int lockStatus = 0;&#13;
// use Listing 18-1 to find your tags' numbers<span aria-label="annotation1" class="CodeAnnotationHang">1</span> int tag1[14] = { <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>&#13;
};<span aria-label="annotation2" class="CodeAnnotationHang">2</span> int tag2[14] = { <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>, <em>x</em>&#13;
};<span epub:type="pagebreak" id="Page_334" title="334"/>int newtag[14] = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0&#13;
}; // used for read comparisons&#13;
// comparetag compares two arrays and returns true if identical&#13;
// this is good for comparing tags&#13;
boolean comparetag(int aa[14], int bb[14])&#13;
{ boolean ff = false; int fg = 0; for (int cc = 0; cc &lt; 14; cc++) { if (aa[cc] == bb[cc]) { fg++; } } if (fg == 14) { ff = true; } return ff;&#13;
}&#13;
void checkmytags()&#13;
// compares each tag against the tag just read&#13;
{ ok = 0; if (comparetag(newtag, tag1) == true) { ok++; } if (comparetag(newtag, tag2) == true) { ok++; }&#13;
}<span aria-label="annotation3" class="CodeAnnotationHang">3</span> void checkLock()&#13;
{ Serial.print("System Status after restart "); lockStatus = EEPROM.read(0); if (lockStatus == 1) { Serial.println("- locked"); digitalWrite(13, HIGH); } if (lockStatus == 0) { Serial.println("- unlocked"); digitalWrite(13, LOW); } if ((lockStatus != 1) &amp;&amp; (lockStatus != 0)) { Serial.println("EEPROM fault - Replace Arduino hardware");<span epub:type="pagebreak" id="Page_335" title="335"/>  }&#13;
}&#13;
void setup()&#13;
{ Serial.begin(9600); Serial2.begin(9600); Serial2.flush(); // need to flush serial buffer pinMode(13, OUTPUT);<span aria-label="annotation4" class="CodeAnnotationHang">4</span>   checkLock();&#13;
}&#13;
void loop()&#13;
{ ok = -1; if (Serial2.available() &gt; 0)   // if a read has been attempted { // read the incoming number on serial RX delay(100); for (int z = 0; z &lt; 14; z++) // read the rest of the tag { data1 = Serial2.read(); newtag[z] = data1; } Serial2.flush();             // prevents multiple reads // now to match tags up checkmytags(); }<span aria-label="annotation5" class="CodeAnnotationHang">5</span>   if (ok &gt; 0)                    // if we had a match { lockStatus = EEPROM.read(0); if (lockStatus == 1)         // if locked, unlock it {<span aria-label="annotation6" class="CodeAnnotationHang">6</span>       Serial.println("Status - unlocked"); digitalWrite(13, LOW); EEPROM.write(0, 0); } if (lockStatus == 0) {<span aria-label="annotation7" class="CodeAnnotationHang">7</span>       Serial.println("Status - locked"); digitalWrite(13, HIGH); EEPROM.write(0, 1); } if ((lockStatus != 1) &amp;&amp; (lockStatus != 0)) {<span aria-label="annotation8" class="CodeAnnotationHang">8</span>       Serial.println("EEPROM fault - Replace Arduino hardware"); } } else if (ok == 0)              // if we didn't have a match { Serial.println("Incorrect tag"); ok = -1; } delay(500);&#13;
}</code></pre>&#13;
			<h3 id="h2-500587c18-0009"><span epub:type="pagebreak" id="Page_336" title="336"/>Understanding the Sketch</h3>&#13;
			<p class="BodyFirst">This sketch is a modification of Project 52. We use the onboard LED to simulate the status of something that we want to turn on or off every time an acceptable RFID ID tag is read. After a tag has been read and matched, the status of the lock is changed at <span aria-label="annotation5" class="CodeAnnotation">5</span>. We store the status of the lock in the first position of the EEPROM. The status is represented by a number: <code>0</code> is unlocked and <code>1</code> is locked. This status will change (from locked to unlocked and back to locked) after every successful tag read at <span aria-label="annotation6" class="CodeAnnotation">6</span> or <span aria-label="annotation7" class="CodeAnnotation">7</span>.</p>&#13;
			<p>&#13;
				We’ve also introduced a fail-safe in case the EEPROM has worn out. If the value returned from reading the EEPROM is not <code>0</code> or <code>1</code>, we should be notified at <span aria-label="annotation8" class="CodeAnnotation">8</span>. Furthermore, the status is checked when the sketch restarts after a reset using the function <code>checkLock()</code> at <span aria-label="annotation1" class="CodeAnnotation">1</span>, <span aria-label="annotation2" class="CodeAnnotation">2</span>, <span aria-label="annotation3" class="CodeAnnotation">3</span>, and <span aria-label="annotation4" class="CodeAnnotation">4</span>, which reads the EEPROM value, determines the last status, and then sets the lock to that status (locked or unlocked).</p>&#13;
			<h2 id="h1-500587c18-0006">Looking Ahead</h2>&#13;
			<p class="BodyFirst">Once again, we have used an Arduino board to re-create simply what could be a very complex project. You now have a base to add RFID control to your projects that will allow you to create professional-quality access systems and control digital outputs with the swipe of an RFID card. We’ll demonstrate this again when we revisit RFID in <span class="xref" itemid="xref_target_Chapter 20">Chapter 20</span>.</p>&#13;
		</section>&#13;
	</body></html>