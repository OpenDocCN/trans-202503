<html><head></head><body>
<p class="calibre1">$ <b class="calibre3">tcpdump -n -r icmp.pcap dst net 192.168.2.0</b></p>
<p class="calibre1">reading from file icmp.pcap, link-type EN10MB (Ethernet)</p>
<p class="calibre1">20:30:28.844237 IP 192.168.2.108 &gt; 173.194.75.104: ICMP echo request, id 1, seq 5, length 40</p>
<p class="calibre1">20:30:29.850913 IP 192.168.2.108 &gt; 173.194.75.104: ICMP echo request, id 1, seq 6, length 40</p>
<p class="calibre1">20:30:29.987013 IP 192.168.2.127 &gt; 173.194.75.99: ICMP echo request, id 47441, seq 1, length 64</p>
<p class="calibre1"> <i class="calibre4">Listing 6-11: Capturing traffic to a network via BPF with Tcpdump</i></p>
<p class="calibre1">Many protocols offer BPF primitives that allow you to look at specific </p>
<p class="calibre1">aspects of the traffic, and you can also combine elements of the previous </p>
<p class="calibre1">examples to limit what you see. For example, Listing 6-12 shows only ICMP </p>
<p class="calibre1">echo replies from IP address 192.168.2.127. </p>
<p class="calibre1">$ <b class="calibre3">tcpdump -n -r icmp.pcap 'icmp[icmptype] = icmp-echoreply' and dst host 192.168.2.127</b></p>
<p class="calibre1">reading from file icmp.pcap, link-type EN10MB (Ethernet)</p>
<p class="calibre1">20:30:30.013728 IP 173.194.75.99 &gt; 192.168.2.127: ICMP echo reply, id 47441, seq 1, length 64</p>
<p class="calibre1"> <i class="calibre4">Listing 6-12: Capturing ICMP echo replies to a host via BPF with Tcpdump</i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Extracting Details from Tcpdump Output</b></i></p>
<p class="calibre1">In addition to displaying traffic more specifically, with Tcpdump, you can </p>
<p class="calibre1">also extract more details from the results. For example, Listing 6-13 tells </p>
<p class="calibre1">Tcpdump to show timestamps as  <i class="calibre4">YYYY</i>- <i class="calibre4">MM</i>- <i class="calibre4">DD</i>  <i class="calibre4">HH</i>: <i class="calibre4">MM</i>: <i class="calibre4">SS.milli seconds</i> via </p>
<p class="calibre1">–tttt, adds layer 2 headers with –e, and tells Tcpdump to show all  headers </p>
<p class="calibre1">and data in hex and ASCII format with -XX. </p>
<p class="calibre1">$ <b class="calibre3">tcpdump -n -tttt -e -XX -r icmp.pcap 'icmp[icmptype] = icmp-echoreply' and dst host 192.168.2.127</b></p>
<p class="calibre1">reading from file icmp.pcap, link-type EN10MB (Ethernet)</p>
<p class="calibre1">2013-02-16 20:30:30.013728 00:0d:b9:27:f1:48 &gt; 00:13:10:65:2f:ac, ethertype IPv4 (0x0800), length 98: 173.194.75.99 &gt; 192.168.2.127: ICMP echo reply, id 47441, seq 1, length 64</p>
<p class="calibre1">0x0000:  0013 1065 2fac 000d b927 f148 0800 4500  ...e/....'.H..E. </p>
<p class="calibre1">0x0010:  0054 0000 0000 fb01 035c adc2 4b63 c0a8  .T.......\..Kc.. </p>
<p class="calibre1">0x0020:  027f 0000 2092 b951 0001 65ec 1f51 0000  .......Q..e..Q.. </p>
<p class="calibre1">0x0030:  0000 d30a 0f00 0000 0000 1011 1213 1415  ................ </p>
<p class="calibre1">0x0040:  1617 1819 1a1b 1c1d 1e1f 2021 2223 2425  ...........!"#$%</p>
<p class="calibre1">0x0050:  2627 2829 2a2b 2c2d 2e2f 3031 3233 3435  &amp;'()*+,-./012345</p>
<p class="calibre1">0x0060:  3637                                     67</p>
<p class="calibre1"> <i class="calibre4">Listing 6-13: Extracting more details from Tcpdump output</i></p>
<p class="calibre1"><b class="calibre3">N o T e </b> <i class="calibre4"> </i></p>
<p class="calibre1"> <i class="calibre4">Tcpdump offers other matching and storage options. For more information, see </i></p>
<p class="calibre1"> <i class="calibre4">the Tcpdump manual page on SO. Type  <b class="calibre3">man tcpdump</b> at a command prompt to </i></p>
<p class="calibre1"> <i class="calibre4">read the manual. </i></p>
<p class="calibre1">Command Line Packet Analysis Tools   <b class="calibre3">121</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p156"/> <i class="calibre4"><b class="calibre3">Examining Full Content Data with Tcpdump</b></i></p>
<p class="calibre1">Because Tcpdump also works on saved traces, you can use it to examine the </p>
<p class="calibre1">full content data saved on SO stand-alone or sensor platforms in the  <i class="calibre4">/nsm/</i></p>
<p class="calibre1"> <i class="calibre4">sensor_data/&lt;sensorname&gt;/dailylogs</i> directory. When searching for indicators of compromise in network traffic, you may want to search every file in these </p>
<p class="calibre1">directories. You can use Tcpdump and a BPF modifier to hone your output. </p>
<p class="calibre1">For example, Listing 6-14 looks through all files for traffic involving </p>
<p class="calibre1">host 8.8.8.8 and TCP thanks to a for loop and the find command. Note the </p>
<p class="calibre1">backticks (on the same key as the tilde symbol) in front of the find and after </p>
<p class="calibre1">-type f. </p>
<p class="calibre1">$ <b class="calibre3">for i in `find /nsm/sensor_data/sademo-eth1/dailylogs/ -type f`; do tcpdump -n -c 1 -r $i</b> <b class="calibre3">host 8.8.8.8 and tcp; done</b></p>
<p class="calibre1">reading from file /nsm/sensor_data/sademo-eth1/dailylogs/2013-02-16/snort.log.1361019690, link-type EN10MB (Ethernet) u</p>
<p class="calibre1">reading from file /nsm/sensor_data/sademo-eth1/dailylogs/2013-02-16/snort.log.1361045719, link-type EN10MB (Ethernet) v</p>
<p class="calibre1">21:02:06.430169 IP 192.168.2.126.44334 &gt; 8.8.8.8.53:</p>
<p class="calibre1">Flags [S], seq 1330246822, win 42340, options</p>
<p class="calibre1">[mss 1460,sackOK,TS val 157066547 ecr 0,nop,wscale 11], length 0 w</p>
<p class="calibre1">reading from file /nsm/sensor_data/sademo-eth1/dailylogs/2013-02-16/snort.log.1361017706, link-type EN10MB (Ethernet) x</p>
<p class="calibre1"> <i class="calibre4">-- snip --</i></p>
<p class="calibre1"> <i class="calibre4">Listing 6-14: Looping through pcap files</i></p>
<p class="calibre1">Listing 6-14 shows that the first trace u did not contain any traffic </p>
<p class="calibre1">matching the BPF. The second trace v contains a matching SYN packet w. </p>
<p class="calibre1">The third trace at x did not contain any matching packets. </p>
<p class="calibre1">With a repository of full content data at your disposal, you give greater </p>
<p class="calibre1">context to your NSM analysis. While most NSM analysts use many tools to </p>
<p class="calibre1">access full content data, I often use Tcpdump to take a quick look at specific </p>
<p class="calibre1">network activity, applying a BPF for a certain port or host of interest. </p>
<p class="calibre1"><b class="calibre3">using dumpcap and Tshark</b></p>
<p class="calibre1">The Dumpcap and Tshark tools are shipped with the Wireshark ( <i class="calibre4">http://</i></p>
<p class="calibre1"> <i class="calibre4">www.wireshark.org/</i>) suite. Dumpcap is a simple traffic collection tool, and </p>
<p class="calibre1">Tshark is the command line version of the Wireshark network traffic ana-</p>
<p class="calibre1">lyzer. Dumpcap, and by extension Tshark, depend on the libpcap traffic </p>
<p class="calibre1">capture library to access packets. Both Dumpcap and Tshark are avail-</p>
<p class="calibre1">able on SO, but they are not running by default. Analysts can invoke each </p>
<p class="calibre1">on demand, most often to access full content data in  <i class="calibre4">/nsm/sensor_data/ </i></p>
<p class="calibre1"> <i class="calibre4">&lt;sensorname&gt;/dailylogs</i>. </p>
<p class="calibre1"><b class="calibre3">N o T e </b> <i class="calibre4"> </i></p>
<p class="calibre1"> <i class="calibre4">Gerald Combs is the original author of Dumpcap, and he and the Wireshark team </i></p>
<p class="calibre1"> <i class="calibre4">code under the GNU General Public License version 2 (</i> http://www.wireshark </p>
<p class="calibre1">.org/faq.html <i class="calibre4">). </i></p>
<p class="calibre1"><b class="calibre3">122</b>   Chapter 6</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p157"/>Tshark’s strength lies in protocol analysis, thanks to the hundreds of protocols it understands, and, unlike Tcpdump, it allows you access just </p>
<p class="calibre1">about any aspect of a protocol using fairly human-friendly syntax. For this </p>
<p class="calibre1">reason, if I need to decode a specific protocol in a command line environ-</p>
<p class="calibre1">ment, I choose Tshark over Tcpdump. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Running Tshark</b></i></p>
<p class="calibre1">You can run Tshark from a command terminal, although if you start it </p>
<p class="calibre1">with sudo, it will likely report the following error and warning as shown </p>
<p class="calibre1">in Listing 6-15. </p>
<p class="calibre1">$ <b class="calibre3">sudo tshark -i eth1</b> </p>
<p class="calibre1">tshark: Lua: Error during loading:</p>
<p class="calibre1">[string "/usr/share/wireshark/init.lua"]:45: dofile has been disabled</p>
<p class="calibre1">Running as user "root" and group "root". This could be dangerous. </p>
<p class="calibre1">Capturing on eth1</p>
<p class="calibre1"> <i class="calibre4">Listing 6-15: Lua error when starting Tshark</i></p>
<p class="calibre1">The protocol dissectors shipped with Wireshark and Tshark may con-</p>
<p class="calibre1">tain vulnerabilities. Clever intruders could exploit those vulnerabilities by </p>
<p class="calibre1">sending specially crafted network traffic past a sensor. If malicious packets </p>
<p class="calibre1">exploit Wireshark or Tshark while it is sniffing traffic, an intruder could </p>
<p class="calibre1">gain control of the sensor. If Wireshark or Tshark is running with root privi-</p>
<p class="calibre1">leges when exploitation occurs, the intruder could gain total  control of the </p>
<p class="calibre1">sensor. </p>
<p class="calibre1">To partially mitigate the risk of granting intruders unauthorized access, </p>
<p class="calibre1">the Wireshark developers recommend that users not run either program </p>
<p class="calibre1">with root privileges. Instead, they suggest capturing traffic with Dumpcap </p>
<p class="calibre1">first, and then analyzing saved packets with Wireshark or Tshark. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Running Dumpcap</b></i></p>
<p class="calibre1">Dumpcap uses the same BPF syntax as Tcpdump, as shown in Listing 6-16. </p>
<p class="calibre1">$ <b class="calibre3">sudo dumpcap -i eth1 -c 2 -w /tmp/tshark-icmp.pcap -f "icmp and host 192.168.2.108" </b></p>
<p class="calibre1">File: /tmp/tshark-icmp.pcap</p>
<p class="calibre1">Packets captured: 2</p>
<p class="calibre1">Packets Received/Dropped on Interface eth1: 2/0</p>
<p class="calibre1"> <i class="calibre4">Listing 6-16: Capturing two ICMP packets with Dumpcap </i></p>
<p class="calibre1">The command in Listing 6-16 tells Dumpcap to listen to the eth1 inter-</p>
<p class="calibre1">face, save two packets, write to the  <i class="calibre4">/tmp/tshark-icmp.pcap</i> file, and limit capture to ICMP traffic involving the computer at IP address 192.168.2.108. </p>
<p class="calibre1">As you can see in the listing, you don’t need to specify a snaplength via -s </p>
<p class="calibre1">as you do with Tcpdump, because Dumpcap uses a default maximum value. </p>
<p class="calibre1">Listing 6-15 writes to the  <i class="calibre4">/tmp</i> directory because the operating system won’t </p>
<p class="calibre1">Command Line Packet Analysis Tools   <b class="calibre3">123</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p158"/>let me write to my home directory as root through sudo. I must write to a directory that the root user can also write to, which doesn’t include my </p>
<p class="calibre1">user’s home directory. </p>
<p class="calibre1">Besides using sudo and writing to a directory writable by root, you can </p>
<p class="calibre1">reconfigure Wireshark on SO to create a wireshark group, and then add your </p>
<p class="calibre1">user account to that group. Doing so will allow your users to capture packets </p>
<p class="calibre1">with Dumpcap without invoking sudo to elevate privileges. To accomplish this </p>
<p class="calibre1">goal, run the following command:</p>
<p class="calibre1">$ <b class="calibre3">sudo dpkg-reconfigure wireshark-common</b></p>
<p class="calibre1">If you run this command within an OpenSSH session, the screen should </p>
<p class="calibre1">look like Listing 6-17. </p>
<p class="calibre1">âââââââââââââââââââââââ¤ Configuring wireshark-common âââââââââââââââââââââââ</p>
<p class="calibre1">â                                                                           â</p>
<p class="calibre1">â Dumpcap can be installed in a way that allows members of the "wireshark"  â â system group to capture packets. This is recommended over the             â</p>
<p class="calibre1">â alternative of running Wireshark/Tshark directly as root, because less    â</p>
<p class="calibre1">â of the code will run with elevated privileges.                            â</p>
<p class="calibre1">â                                                                           â</p>
<p class="calibre1">â For more detailed information please see                                  â</p>
<p class="calibre1">â /usr/share/doc/wireshark-common/README.Debian.                            â</p>
<p class="calibre1">â                                                                           â</p>
<p class="calibre1">â Enabling this feature may be a security risk, so it is disabled by        â</p>
<p class="calibre1">â default. If in doubt, it is suggested to leave it disabled.               â</p>
<p class="calibre1">â                                                                           â</p>
<p class="calibre1">â Should non-superusers be able to capture packets?                         â</p>
<p class="calibre1">â                                                                           â</p>
<p class="calibre1">â                    &lt;Yes&gt;                       &lt;No&gt;                       â â                                                                           â</p>
<p class="calibre1">âââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââââ</p>
<p class="calibre1"> <i class="calibre4">Listing 6-17: Configuring wireshark-common via OpenSSH session</i></p>
<p class="calibre1">Use the tab or arrow keys to select <b class="calibre3">Yes</b>, and then press enter. The script </p>
<p class="calibre1">will add a wireshark user to the  <i class="calibre4">/etc/group</i> file. Next, add your user to the </p>
<p class="calibre1">wireshark group. Here, the username is sademo:</p>
<p class="calibre1">$ <b class="calibre3">sudo usermod -a -G wireshark sademo</b></p>
<p class="calibre1">Now log out of the system and log back in. (If you try to capture traffic </p>
<p class="calibre1">without logging in again, you will get an error.) Try capturing traffic as a </p>
<p class="calibre1">normal user, as shown in Listing 6-18. </p>
<p class="calibre1">$ <b class="calibre3">dumpcap -i eth1 -c 2 -w tshark-icmp.pcap  -f "icmp and host 192.168.2.108" </b></p>
<p class="calibre1">File: tshark-icmp.pcap</p>
<p class="calibre1">Packets captured: 2</p>
<p class="calibre1">Packets received/dropped on interface eth1: 2/0</p>
<p class="calibre1"> <i class="calibre4">Listing 6-18: Capturing traffic with user-level privileges with Dumpcap. You can now</i> <i class="calibre4"> capture traffic with Dumpcap without using sudo and encountering errors. </i></p>
<p class="calibre1"><b class="calibre3">124</b>   Chapter 6</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p159"/> <i class="calibre4"><b class="calibre3">Running Tshark on Dumpcap’s Traffic</b></i></p>
<p class="calibre1">Once Dumpcap has captured traffic, analyze it with Tshark. To run Tshark </p>
<p class="calibre1">in its most basic mode, use the -r switch, as shown in Listing 6-19. </p>
<p class="calibre1">$ <b class="calibre3">tshark -r tshark-icmp.pcap</b></p>
<p class="calibre1">1   0.000000 192.168.2.108 -&gt; 8.8.8.8      ICMP 74 Echo (ping) request  </p>
<p class="calibre1">id=0x0001, seq=17/4352, ttl=127</p>
<p class="calibre1">2   0.022643      8.8.8.8 -&gt; 192.168.2.108 ICMP 74 Echo (ping) reply    </p>
<p class="calibre1">id=0x0001, seq=17/4352, ttl=251</p>
<p class="calibre1"> <i class="calibre4">Listing 6-19: Reading a trace with Tshark</i></p>
<p class="calibre1">This output should be fairly easy to understand, although the time field </p>
<p class="calibre1">may be unfamiliar. Specifically, host 192.168.2.108 issues an ICMP echo </p>
<p class="calibre1">request to host 8.8.8.8 in packet 1, and host 8.8.8.8 responds with an ICMP </p>
<p class="calibre1">echo reply in packet 2. By default, Tshark shows an initial time of 0, fol-</p>
<p class="calibre1">lowed by time elapsed since the first packet. You can change that to show </p>
<p class="calibre1">a more readable format with the -t ad switch, as shown in Listing 6-20. </p>
<p class="calibre1">$ <b class="calibre3">tshark -t ad -r tshark-icmp.pcap</b></p>
<p class="calibre1">1 2013-02-17 13:37:45.922462 192.168.2.108 -&gt; 8.8.8.8      ICMP 74 Echo </p>
<p class="calibre1">(ping) request  id=0x0001, seq=17/4352, ttl=127</p>
<p class="calibre1">2 2013-02-17 13:37:45.945105      8.8.8.8 -&gt; 192.168.2.108 ICMP 74 Echo </p>
<p class="calibre1">(ping) reply    id=0x0001, seq=17/4352, ttl=251</p>
<p class="calibre1"> <i class="calibre4">Listing 6-20: Showing absolute timestamps using the -t ad switch in Tshark</i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Using Display Filters with Tshark</b></i></p>
<p class="calibre1">Tshark provides a robust language to show packets that match  <i class="calibre4">display </i></p>
<p class="calibre1"> <i class="calibre4">filters</i>. Tshark and Wireshark use display filters to control what traffic is </p>
<p class="calibre1">shown, but display filters do not affect packet capture. Use BPF syntax if you </p>
<p class="calibre1">want to influence what Tshark (or Dumpcap, for that matter) collects and </p>
<p class="calibre1">stores. For example, Listing 6-21 invokes a display filter to show only ICMP </p>
<p class="calibre1">echo replies (ICMP type 0 messages). </p>
<p class="calibre1">$ <b class="calibre3">tshark -t ad -r tshark-icmp.pcap -R "icmp.type == 0" </b></p>
<p class="calibre1">2 2013-02-17 13:37:45.945105      8.8.8.8 -&gt; 192.168.2.108 ICMP 74 Echo </p>
<p class="calibre1">(ping) reply    id=0x0001, seq=17/4352, ttl=251</p>
<p class="calibre1"> <i class="calibre4">Listing 6-21: Showing an ICMP echo reply in Tshark</i></p>
<p class="calibre1">This output may not seem very different from that of the Tcpdump fil-</p>
<p class="calibre1">ter shown in Listing 6-20, but the power of Tshark (and Wireshark) comes </p>
<p class="calibre1">from the extensive catalog of available display filters. The ICMP protocol has </p>
<p class="calibre1">64 display filters available as of this writing, as listed at  <i class="calibre4">http://www.wireshark </i></p>
<p class="calibre1"> <i class="calibre4">.org/docs/dfref/i/icmp.html</i>. All of these can be used to define specific values to be matched with a display filter. </p>
<p class="calibre1">Command Line Packet Analysis Tools   <b class="calibre3">125</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p160"/>Tshark reveals its depth of knowledge for protocols when you pass it the </p>
<p class="calibre1">-V switch, which tells Tshark to produce a verbose protocol decode for the </p>
<p class="calibre1">specified traffic. Add -x to display a hex and ASCII listing of the packet. </p>
<p class="calibre1">Both options are shown in Listing 6-22. </p>
<p class="calibre1">$ <b class="calibre3">tshark -t ad -r tshark-icmp.pcap -R "icmp.type == 0" -x -V</b></p>
<p class="calibre1">uFrame 2: 74 bytes on wire (592 bits), 74 bytes captured (592 bits)</p>
<p class="calibre1">Arrival Time: Feb 17, 2014 13:37:45.945105000 UTC</p>
<p class="calibre1">Epoch Time: 1361108265.945105000 seconds</p>
<p class="calibre1">[Time delta from previous captured frame: 0.022643000 seconds]</p>
<p class="calibre1">[Time delta from previous displayed frame: 0.000000000 seconds]</p>
<p class="calibre1">[Time since reference or first frame: 0.022643000 seconds]</p>
<p class="calibre1">Frame Number: 2</p>
<p class="calibre1">Frame Length: 74 bytes (592 bits)</p>
<p class="calibre1">Capture Length: 74 bytes (592 bits)</p>
<p class="calibre1">[Frame is marked: False]</p>
<p class="calibre1">[Frame is ignored: False]</p>
<p class="calibre1">[Protocols in frame: eth:ip:icmp:data]</p>
<p class="calibre1">vEthernet II, Src: PcEngine_27:f1:48 (00:0d:b9:27:f1:48), Dst: Cisco-Li_65:2f:ac </p>
<p class="calibre1">(00:13:10:65:2f:ac)</p>
<p class="calibre1">Destination: Cisco-Li_65:2f:ac (00:13:10:65:2f:ac)</p>
<p class="calibre1">Address: Cisco-Li_65:2f:ac (00:13:10:65:2f:ac)</p>
<p class="calibre1">.... ...0 .... .... .... .... = IG bit: Individual address (unicast)</p>
<p class="calibre1">.... ..0. .... .... .... .... = LG bit: Globally unique address (factory default)</p>
<p class="calibre1">Source: PcEngine_27:f1:48 (00:0d:b9:27:f1:48)</p>
<p class="calibre1">Address: PcEngine_27:f1:48 (00:0d:b9:27:f1:48)</p>
<p class="calibre1">.... ...0 .... .... .... .... = IG bit: Individual address (unicast)</p>
<p class="calibre1">.... ..0. .... .... .... .... = LG bit: Globally unique address (factory default)</p>
<p class="calibre1">Type: IP (0x0800)</p>
<p class="calibre1">wInternet Protocol Version 4, Src: 8.8.8.8 (8.8.8.8), Dst: 192.168.2.108 (192.168.2.108) Version: 4</p>
<p class="calibre1">Header length: 20 bytes</p>
<p class="calibre1">Differentiated Services Field: 0x00 (DSCP 0x00: Default; ECN: 0x00: Not-ECT (Not </p>
<p class="calibre1">ECN-Capable Transport))</p>
<p class="calibre1">0000 00.. = Differentiated Services Codepoint: Default (0x00)</p>
<p class="calibre1">.... ..00 = Explicit Congestion Notification: Not-ECT (Not ECN-Capable Transport) </p>
<p class="calibre1">(0x00)</p>
<p class="calibre1">Total Length: 60</p>
<p class="calibre1">Identification: 0x0000 (0)</p>
<p class="calibre1">Flags: 0x00</p>
<p class="calibre1">0... .... = Reserved bit: Not set</p>
<p class="calibre1">.0.. .... = Don't fragment: Not set</p>
<p class="calibre1">..0. .... = More fragments: Not set</p>
<p class="calibre1">Fragment offset: 0</p>
<p class="calibre1">Time to live: 251</p>
<p class="calibre1">Protocol: ICMP (1)</p>
<p class="calibre1">Header checksum: 0xec9c [correct]</p>
<p class="calibre1">[Good: True]</p>
<p class="calibre1">[Bad: False]</p>
<p class="calibre1">Source: 8.8.8.8 (8.8.8.8)</p>
<p class="calibre1">Destination: 192.168.2.108 (192.168.2.108)</p>
<p class="calibre1"><b class="calibre3">126</b>   Chapter 6</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p161"/>xInternet Control Message Protocol</p>
<p class="calibre1">Type: 0 (Echo (ping) reply)</p>
<p class="calibre1">Code: 0</p>
<p class="calibre1">Checksum: 0x554a [correct]</p>
<p class="calibre1">Identifier (BE): 1 (0x0001)</p>
<p class="calibre1">Identifier (LE): 256 (0x0100)</p>
<p class="calibre1">Sequence number (BE): 17 (0x0011)</p>
<p class="calibre1">Sequence number (LE): 4352 (0x1100)</p>
<p class="calibre1">[Response To: 1]</p>
<p class="calibre1">[Response Time: 22.643 ms]</p>
<p class="calibre1">Data (32 bytes)</p>
<p class="calibre1">Data: 6162636465666768696a6b6c6d6e6f707172737475767761... </p>
<p class="calibre1">[Length: 32]</p>
<p class="calibre1">y0000  00 13 10 65 2f ac 00 0d b9 27 f1 48 08 00 45 00   ...e/....'.H..E. </p>
<p class="calibre1">0010  00 3c 00 00 00 00 fb 01 ec 9c 08 08 08 08 c0 a8   .&lt;.............. </p>
<p class="calibre1">0020  02 6c 00 00 55 4a 00 01 00 11 61 62 63 64 65 66   .l..UJ....abcdef</p>
<p class="calibre1">0030  67 68 69 6a 6b 6c 6d 6e 6f 70 71 72 73 74 75 76   ghijklmnopqrstuv</p>
<p class="calibre1">0040  77 61 62 63 64 65 66 67 68 69                     wabcdefghilll</p>
<p class="calibre1"> <i class="calibre4">Listing 6-22: Full decode of the ICMP echo reply in Tshark</i></p>
<p class="calibre1">The full decode for this packet is broken into five main sections:</p>
<p class="calibre1">•  Section u displays frame information, with metadata on time, frame </p>
<p class="calibre1">size, and other details. </p>
<p class="calibre1">•  Section v shows details found in the Ethernet header such as source, </p>
<p class="calibre1">destination, and Media Access Control (MAC) addresses. </p>
<p class="calibre1">•  Section w offers information from the IP header, like source and desti-</p>
<p class="calibre1">nation IP addresses and other IP protocol data. </p>
<p class="calibre1">•  Section x shows details on the ICMP protocol itself. </p>
<p class="calibre1">•  Section y is a hexadecimal and ASCII representation of the entire frame. </p>
<p class="calibre1">Tools like Tshark are helpful because they expose every detail of a </p>
<p class="calibre1">protocol. For example, you may find that it is important to know an ICMP </p>
<p class="calibre1">sequence number, if that element may have been used for suspicious or </p>
<p class="calibre1">malicious purposes. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Tshark Display Filters in Action</b></i></p>
<p class="calibre1">In this section, we’ll look at some display filter examples that demonstrate </p>
<p class="calibre1">the power of Tshark. </p>
<p class="calibre1">Imagine you want to search traffic for Simple Mail Transport Protocol </p>
<p class="calibre1">(SMTP) commands. You could use the smtp.req.command display filter, as </p>
<p class="calibre1">shown in Listing 6-23. </p>
<p class="calibre1">$ <b class="calibre3">tshark -t ad -r smtp.pcap -R 'smtp.req.command' </b></p>
<p class="calibre1">4 2014-02-17 14:09:14.659043 192.168.2.127 -&gt; 68.87.26.155 SMTP 76 C: helo test</p>
<p class="calibre1">10 2014-02-17 14:09:19.090208 192.168.2.127 -&gt; 68.87.26.155 SMTP 71 C: quit</p>
<p class="calibre1"> <i class="calibre4">Listing 6-23: Tshark display filter for SMTP</i></p>
<p class="calibre1">Command Line Packet Analysis Tools   <b class="calibre3">127</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p162"/>To look for user agents in HTTP GET request traffic generated by curl, you could use two filters together. Listing 6-24 uses a for loop to search an </p>
<p class="calibre1">entire directory. The echo statement shows the trace in question as Tshark </p>
<p class="calibre1">searches it. </p>
<p class="calibre1">$ <b class="calibre3">for i in `find /nsm/sensor_data/sademo-eth1/dailylogs/2013-02-17/ -type f`; do echo $i;</b> <b class="calibre3">tshark -t ad -r $i -R 'http.user_agent contains "curl" and http.request.method == GET'; done</b></p>
<p class="calibre1">/nsm/sensor_data/sademo-eth1/dailylogs/2013-02-17/snort.log.1361107364</p>
<p class="calibre1">143841 2014-02-17 14:26:43.875022 192.168.2.127 -&gt; 217.160.51.31 HTTP 223 GET / HTTP/1.1</p>
<p class="calibre1"> <i class="calibre4">Listing 6-24: Looping through data with Tshark to find HTTP traffic</i></p>
<p class="calibre1">Tshark display filters also make it easy to search for traffic to or from </p>
<p class="calibre1">a range of IP addresses. For example, Listing 6-25 looks for traffic with IP </p>
<p class="calibre1">addresses between 192.168.2.100 and 192.168.2.110 inclusive that is not TCP </p>
<p class="calibre1">or UDP. </p>
<p class="calibre1">$ <b class="calibre3">tshark -t ad -r /nsm/sensor_data/sademo-eth1/dailylogs/2013-02-17/snort.log.1361107364 -R </b></p>
<p class="calibre1"><b class="calibre3">'ip.dst &gt;= 192.168.2.100 and ip.dst &lt;= 192.168.2.110 and not tcp and not udp' </b></p>
<p class="calibre1">10327 2014-02-17 13:33:01.775757      8.8.8.8 -&gt; 192.168.2.108</p>
<p class="calibre1">ICMP 74 Echo (ping) reply    id=0x0001, seq=16/4096, ttl=251</p>
<p class="calibre1">12519 2014-02-17 13:37:45.945105      8.8.8.8 -&gt; 192.168.2.108</p>
<p class="calibre1">ICMP 74 Echo (ping) reply    id=0x0001, seq=17/4352, ttl=251</p>
<p class="calibre1"> <i class="calibre4">Listing 6-25: Searching for a range of IP addresses with a Tshark display filter</i></p>
<p class="calibre1">For more detail, add the -V and/or -x switch. </p>
<p class="calibre1">As you can see, I like to use Tshark to review saved traces for specific </p>
<p class="calibre1">elements. It would be difficult to create the equivalent BPF syntax for many </p>
<p class="calibre1">of these display filters. While technically possible, the BPF syntax can be </p>
<p class="calibre1">horribly complex. </p>
<p class="calibre1"><b class="calibre3">running argus and the ra client</b></p>
<p class="calibre1">Our final command line tool is Argus ( <i class="calibre4">http://www.qosient.com/argus/</i>), a </p>
<p class="calibre1">session data generation and analysis suite, and its client for reading data, </p>
<p class="calibre1">Ra. The Argus server is running by default on SO, but analysts must use </p>
<p class="calibre1">the Argus client tools to access the data stored in the  <i class="calibre4">/nsm/sensor_data/ </i></p>
<p class="calibre1"> <i class="calibre4">&lt;sensorname&gt;/argus</i> directory. </p>
<p class="calibre1"><b class="calibre3">N o T e </b> <i class="calibre4"> </i></p>
<p class="calibre1"> <i class="calibre4">Carter Bullard first started writing Argus at Carnegie Mellon’s Software Engineering</i> <i class="calibre4">Institute (SEI) in 1993, and released the code publicly as Argus 1.5 in early 1996. </i></p>
<p class="calibre1"> <i class="calibre4">Today, the code exists as a server component and multiple client components, licensed</i> <i class="calibre4">under the GNU General Public License version 3. </i></p>
<p class="calibre1">You can validate the status of the Argus server by running the nsm_sensor_ </p>
<p class="calibre1">ps-status script with the --only-argus switch, as shown in Listing 6-26. </p>
<p class="calibre1"><b class="calibre3">128</b>   Chapter 6</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p163"/>$ <b class="calibre3">sudo nsm_sensor_ps-status --only-argus</b></p>
<p class="calibre1">Status: sademo-eth1</p>
<p class="calibre1">* argus                                                         [  OK  ]</p>
<p class="calibre1"> <i class="calibre4">Listing 6-26: Checking Argus status</i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Stopping and Starting Argus</b></i></p>
<p class="calibre1">If Argus is not running, you can restart it. Let’s stop it, and then restart it, </p>
<p class="calibre1">as shown in Listing 6-27. </p>
<p class="calibre1">$ <b class="calibre3">sudo nsm_sensor_ps-stop --only-argus</b></p>
<p class="calibre1">Stopping: sademo-eth1</p>
<p class="calibre1">* stopping: argus                                               [  OK  ]</p>
<p class="calibre1">$ <b class="calibre3">sudo nsm_sensor_ps-start --only-argus</b></p>
<p class="calibre1">Starting: sademo-eth1</p>
<p class="calibre1">* starting: argus                                               [  OK  ]</p>
<p class="calibre1">* disk space currently at 21%</p>
<p class="calibre1"> <i class="calibre4">Listing 6-27: Stopping and starting Argus</i></p>
<p class="calibre1">The Argus data stored in the  <i class="calibre4">/nsm/sensor_data/&lt;sensorname&gt;/argus</i> direc-</p>
<p class="calibre1">tory appears as individual files, one for each day, named  <i class="calibre4">YYYY-MM-DD.log</i>. </p>
<p class="calibre1">Stopping and starting the Argus server will not destroy the previous file, </p>
<p class="calibre1">only append to it. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">The Argus File Format</b></i></p>
<p class="calibre1">The files in the Argus directory are binary files readable only by the Argus </p>
<p class="calibre1">client tools. The binary format keeps the files compact. In comparison, a </p>
<p class="calibre1">sample sensor with 48 days of NSM data shows the following directory usage </p>
<p class="calibre1">for full content and Argus session data. Listing 6-28 has the details. </p>
<p class="calibre1">$ <b class="calibre3">sudo du -csh /nsm/sensor_data/soe-eth0/argus/</b></p>
<p class="calibre1">1.8G    /nsm/sensor_data/soe-eth0/argus/</p>
<p class="calibre1">1.8G    total</p>
<p class="calibre1">$ <b class="calibre3">sudo du -csh /nsm/sensor_data/soe-eth0/dailylogs/</b></p>
<p class="calibre1">83G     /nsm/sensor_data/soe-eth0/dailylogs/</p>
<p class="calibre1">83G     total</p>
<p class="calibre1"> <i class="calibre4">Listing 6-28: Sample Argus and pcap storage</i></p>
<p class="calibre1">As you can see, 48 days of full content data in <i class="calibre4"> </i> pcap format on this sen-</p>
<p class="calibre1">sor occupies 83GB, but Argus session data for the same period occupies </p>
<p class="calibre1">only 1.8GB, or 1/46 of the space. This ratio is likely to be quite different </p>
<p class="calibre1">depending on the nature of each network, but you can see the space advan-</p>
<p class="calibre1">tage associated with session data compared to full content data. </p>
<p class="calibre1">Command Line Packet Analysis Tools   <b class="calibre3">129</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p164"/>This comparison demonstrates the power of session data. If you just </p>
<p class="calibre1">need to know the IP address, protocol, and/or ports associated with a con-</p>
<p class="calibre1">nection, you can acquire all of that information from session data. You </p>
<p class="calibre1">don’t need to capture or search through piles of full content data to get it. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Examining Argus Data</b></i></p>
<p class="calibre1">Analysts who enjoy parsing data using command line tools are likely to find </p>
<p class="calibre1">Argus data particularly useful. I’ll show a few ways to examine this data for </p>
<p class="calibre1">interesting results. You might take this approach if you want to look for spe-</p>
<p class="calibre1">cific information or script searches of session data for anomalous activity. </p>
<p class="calibre1">First, we’ll compare reading session data using two Argus clients, Ra </p>
<p class="calibre1">and Racluster. Listing 6-29 shows an example of using Ra to look for session </p>
<p class="calibre1">records with destination port 21, which is used by many FTP servers. </p>
<p class="calibre1">$ <b class="calibre3">ra -n -r 2014-02-10.log - tcp and dst port 21 -s stime saddr sport daddr dport sbytes dbytes</b> StartTime            SrcAddr  Sport            DstAddr  Dport     SrcBytes     DstBytes u 11:10:53.939711      192.168.2.127.60102       202.12.29.205.21              140           74</p>
<p class="calibre1">v 11:11:04.434637      192.168.2.127.60102       202.12.29.205.21              769         1633</p>
<p class="calibre1">w 11:11:10.003721      192.168.2.127.60102       202.12.29.205.21              204          301</p>
<p class="calibre1">11:11:25.561995      192.168.2.127.50732      192.149.252.20.21              917         1195</p>
<p class="calibre1">11:11:25.806418      192.168.2.127.50734      192.149.252.20.21              979         1198</p>
<p class="calibre1">11:12:07.851453      192.168.2.127.48178         200.3.14.11.21              939         1346</p>
<p class="calibre1">11:12:09.236747      192.168.2.127.48180         200.3.14.11.21              935         1345</p>
<p class="calibre1">11:12:16.019452      192.168.2.127.41655         193.0.6.140.21             1114         1279</p>
<p class="calibre1">11:12:17.357230      192.168.2.127.41657         193.0.6.140.21              840          979</p>
<p class="calibre1">11:12:23.449643      192.168.2.127.41657         193.0.6.140.21              348          301</p>
<p class="calibre1"> <i class="calibre4">Listing 6-29: Argus Ra output for port 21</i></p>
<p class="calibre1">The -n switch tells Ra to not resolve port numbers to names. The BPF </p>
<p class="calibre1">syntax filter tcp and dst port 21 specifies a protocol and port of interest. The </p>
<p class="calibre1">-s switch tells Ra which fields to display. (The Ra man page lists all output </p>
<p class="calibre1">fields controlled by the -s switch.) The SrcBytes and DstBytes columns in </p>
<p class="calibre1">the results count transaction data bytes, which include packet headers. (To </p>
<p class="calibre1">get application layer bytes, use sappbytes and dappbytes instead of sbytes and </p>
<p class="calibre1">dbytes on the command line.)</p>
<p class="calibre1">Notice that there are several session records for certain conversations. </p>
<p class="calibre1">The Argus server wrote these records as it saw the connection stay active. </p>
<p class="calibre1">That’s fine for a short result like the one in Listing 6-29, but not for con-</p>
<p class="calibre1">nections that stay open longer. To collapse these records, use Racluster, as </p>
<p class="calibre1">shown in Listing 6-30. </p>
<p class="calibre1">$ <b class="calibre3">racluster -n -r 2013-02-10.log - tcp and dst port 21 -s stime saddr sport daddr dport sbytes</b> <b class="calibre3">dbytes</b></p>
<p class="calibre1">StartTime            SrcAddr  Sport            DstAddr  Dport     SrcBytes     DstBytes u 11:10:53.939711      192.168.2.127.60102       202.12.29.205.21             1113         2008</p>
<p class="calibre1">11:11:25.561995      192.168.2.127.50732      192.149.252.20.21              917         1195</p>
<p class="calibre1">11:11:25.806418      192.168.2.127.50734      192.149.252.20.21              979         1198</p>
<p class="calibre1">11:12:07.851453      192.168.2.127.48178         200.3.14.11.21              939         1346</p>
<p class="calibre1">11:12:09.236747      192.168.2.127.48180         200.3.14.11.21              935         1345</p>
<p class="calibre1"><b class="calibre3">130</b>   Chapter 6</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p165"/>   11:12:16.019452      192.168.2.127.41655         193.0.6.140.21             1114         1279</p>
<p class="calibre1">11:12:17.357230      192.168.2.127.41657         193.0.6.140.21             1188         1280</p>
<p class="calibre1"> <i class="calibre4">Listing 6-30: Argus Racluster output for port 21</i></p>
<p class="calibre1">Notice that the first three records (u, v, and w) from the Ra record in </p>
<p class="calibre1">Listing 6-29 have been collapsed into one record u in Listing 6-30, though </p>
<p class="calibre1">when you add the byte counts from the same sessions in the Ra output, </p>
<p class="calibre1">you’ll find that they match the total byte count in the Racluster output. For </p>
<p class="calibre1">example, the SrcBytes count for the session to 202.12.29.205 in the Ra out-</p>
<p class="calibre1">put is 140 + 769 + 204 = 1113, which is the same value as the SrcBytes field </p>
<p class="calibre1">for the session to 202.12.29.205 in the Racluster output. </p>
<p class="calibre1">I often use Argus with Racluster to quickly search a large collection </p>
<p class="calibre1">of session data via the command line, especially for unexpected entries. </p>
<p class="calibre1">Rather than searching for specific data, I tell Argus what to omit, and then </p>
<p class="calibre1">I review what’s left. </p>
<p class="calibre1">As an example, we’ll walk through building a fairly complicated Racluster </p>
<p class="calibre1">search. It will tell Racluster to search three Argus archives for UDP traffic, </p>
<p class="calibre1">but to exclude ports 53 (DNS), 123 (Network Time Protocol, or NTP), or </p>
<p class="calibre1">host 192.168.2.120. </p>
<p class="calibre1">This will require the use of the -m saddr daddr switch, which instructs Ra </p>
<p class="calibre1">to group records by source and destination IP address, and the -s switch, </p>
<p class="calibre1">which specifies the desired output fields. Two additional elements add the </p>
<p class="calibre1">year, month, and day to the timestamps in this report. To add these, first </p>
<p class="calibre1">create the  <i class="calibre4">/tmp/ra.conf</i> file, as shown in Listing 6-31, with a variable telling Ra how to display the time. (To learn more about this format, see the manual page for the date command.)</p>
<p class="calibre1">cat /tmp/ra.conf</p>
<p class="calibre1">RA_TIME_FORMAT="%Y-%m-%d %T" </p>
<p class="calibre1"> <i class="calibre4">Listing 6-31: Contents of the </i>/tmp/ra .conf <i class="calibre4"> file</i></p>
<p class="calibre1">Next, add the stime element of the -s switch that tells Ra to provide </p>
<p class="calibre1">enough room in the print buffer to show the entire date and timestamp. </p>
<p class="calibre1">Listing 6-32 assembles all these components and shows the output. </p>
<p class="calibre1">$ <b class="calibre3">racluster -F /tmp/ra.conf -n -r 2014-02-10.log 2013-02-16.log 2014-02-17.log - udp and not \</b> <b class="calibre3">(port 53 or port 123 or host 192.168.2.120\) -m saddr daddr -s stime:20 saddr sport daddr dport</b> <b class="calibre3">sbytes dbytes</b></p>
<p class="calibre1">StartTime                SrcAddr  Sport            DstAddr  Dport     SrcBytes     DstBytes 2013-02-17 13:26:49      192.168.2.114.16403      17.173.254.222.0u             540          540</p>
<p class="calibre1">2013-02-17 13:26:49      192.168.2.114.16403      17.173.254.223.16386           240          240</p>
<p class="calibre1">2013-02-17 13:26:49      192.168.2.114.16403       96.231.180.71.0v             660            0</p>
<p class="calibre1">2013-02-16 20:35:09      192.168.2.115.16403      17.173.254.222.0w            6000         6000</p>
<p class="calibre1">2013-02-16 20:35:09      192.168.2.115.16403      17.173.254.223.16386          2820         2820</p>
<p class="calibre1">2013-02-16 20:35:09      192.168.2.115.16403       96.231.180.71.0x            7740            0</p>
<p class="calibre1">2013-02-10 11:28:29      192.168.2.116.58444         23.23.189.8.0y             534          918</p>
<p class="calibre1">2013-02-10 11:28:29      192.168.2.116.58444        23.23.189.44.33434           382            0</p>
<p class="calibre1">2013-02-17 19:12:09      192.168.2.117.63517      157.56.106.184.3544           2472         3624</p>
<p class="calibre1">Command Line Packet Analysis Tools   <b class="calibre3">131</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p166"/>2013-02-17 19:12:09      192.168.2.117.63517      157.56.106.185.3544            206          302</p>
<p class="calibre1">2013-02-16 13:37:19      192.168.2.117.0z         157.56.149.60.3544          33372        48169</p>
<p class="calibre1">2013-02-16 13:37:19      192.168.2.117.0{         157.56.149.61.3544            515          755</p>
<p class="calibre1"> <i class="calibre4">Listing 6-32: Using Racluster to look for UDP traffic while ignoring port 53, port 123, and host 192.168.2.120</i></p>
<p class="calibre1">In Listing 6-32, you see entries where the destination port is 0 at u, v, </p>
<p class="calibre1">w, x, and y, and where the source port is 0 at z and {. When the destina-</p>
<p class="calibre1">tion port shows 0, Racluster has aggregated multiple destination ports into </p>
<p class="calibre1">one record. For example, Listing 6-33 shows a similar Racluster search that </p>
<p class="calibre1">looks at Argus records involving 192.168.2.117 as the source IP address and </p>
<p class="calibre1">157.56.149.0/24 (meaning any fourth octet is acceptable) as the destination </p>
<p class="calibre1">net block. </p>
<p class="calibre1">$ <b class="calibre3">racluster -F /tmp/ra.conf -n -r 2014-02-10.log 2013-02-16.log 2014-02-17.log - src host</b> <b class="calibre3">192.168.2.117 and dst net 157.56.149.0/24 and udp and not \(port 53 or port 123 or host</b> <b class="calibre3">192.168.2.120\) -s stime:20 saddr sport daddr dport sbytes dbytes</b></p>
<p class="calibre1">StartTime            SrcAddr  Sport            DstAddr  Dport     SrcBytes     DstBytes 2013-02-16 13:37:19      192.168.2.117.64412       157.56.149.60.3544u        20909        30653</p>
<p class="calibre1">2013-02-16 13:37:19      192.168.2.117.64412       157.56.149.61.3544w          412          604</p>
<p class="calibre1">2013-02-17 14:27:57      192.168.2.117.57672       157.56.149.60.3544v        12463        17516</p>
<p class="calibre1">2013-02-17 14:27:57      192.168.2.117.57672       157.56.149.61.3544x          103          151</p>
<p class="calibre1"> <i class="calibre4">Listing 6-33: Using Racluster with 192.168.2.117 as the source IP address and 157.56.149.0/24 as the</i> <i class="calibre4"> destination net block</i></p>
<p class="calibre1">Notice that this output represents four distinct connections: two to </p>
<p class="calibre1">157.56.149.60 at u and v, and two to 157.56.149.61 at w and x. When you </p>
<p class="calibre1">aggregate results using the source IP address, as in Listing 6-32, you lose </p>
<p class="calibre1">this granularity. </p>
<p class="calibre1">I mentioned earlier that I like to use Argus and its Ra or Racluster client </p>
<p class="calibre1">to omit certain traffic, and then review what’s left for anomalies. Listing 6-32 </p>
<p class="calibre1">contains some data that I could review for suspicious or malicious entries. </p>
<p class="calibre1">Doing this sort of review requires some ability to recognize net blocks and </p>
<p class="calibre1">protocols, but it can yield interesting results. </p>
<p class="calibre1">Taking a net block approach means determining the source or destina-</p>
<p class="calibre1">tion of traffic. Tools like the Robtex website ( <i class="calibre4">http://www.robtex.com/</i>) can </p>
<p class="calibre1">help identify network owners. For example, traffic in Listing 6-32 to the </p>
<p class="calibre1">17.0.0.0/8 traffic is likely related to Apple protocols, because Apple owns </p>
<p class="calibre1">that entire Class A net block. Doing similar analysis shows Microsoft owns </p>
<p class="calibre1">the 157.56.0.0/14 net block, Amazon owns 23.20.0.0/14, and Verizon owns </p>
<p class="calibre1">96.224.0.0/11. </p>
<p class="calibre1">Taking a protocol approach requires looking at the protocols involved, </p>
<p class="calibre1">often by deciphering which applications use certain TCP or UDP ports. </p>
<p class="calibre1">Online resources like the SANS Internet Storm Center (ISC) Port Report </p>
<p class="calibre1">( <i class="calibre4">https://isc.sans.edu/portreport.html</i>) provide clues concerning the functions of various TCP and UDP ports. For example, Apple uses port 3544 UDP for </p>
<p class="calibre1">its push notification service, and port 16386 UDP for its FaceTime service. </p>
<p class="calibre1">Many systems run UDP-based Traceroute using port 33434. Based on this </p>
<p class="calibre1"><b class="calibre3">132</b>   Chapter 6</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p167"/>knowledge, I can determine that the applications depicted in Listing 6-32 </p>
<p class="calibre1">are likely all benign, and that they’re associated with Apple traffic and net-</p>
<p class="calibre1">work path discovery using Traceroute. Of course, in order to firmly identify </p>
<p class="calibre1">these sessions, I would need access to full content data or logs from other </p>
<p class="calibre1">sources. Still, this approach provides a way to identify interesting activity </p>
<p class="calibre1">with a minimum amount of effort. </p>
<p class="calibre1"><b class="calibre3">conclusion</b></p>
<p class="calibre1">This chapter began by explaining the three types of tools available in SO: </p>
<p class="calibre1">software for data collection, presentation, and delivery. Within the presen-</p>
<p class="calibre1">tation category, we find tools for packet analysis, and applications that work </p>
<p class="calibre1">best as NSM consoles. Some of the packet analysis tools rely on command </p>
<p class="calibre1">line interfaces, and others use graphical interfaces. This chapter discussed </p>
<p class="calibre1">several packet analysis data presentation tools that are used from the com-</p>
<p class="calibre1">mand line: Tcpdump, Tshark, and the Argus Ra client. You also saw how to </p>
<p class="calibre1">use Dumpcap in concert with Tshark. </p>
<p class="calibre1">In Chapter 7, we’ll look at the graphical interface packet analysis tools: </p>
<p class="calibre1">Wireshark, Xplico, and NetworkMiner. You’ll see that GUI access to packets </p>
<p class="calibre1">offers several distinct advantages, including the availability of more forms </p>
<p class="calibre1">of NSM data. </p>
<p class="calibre1">Command Line Packet Analysis Tools   <b class="calibre3">133</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p168"/><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p169"/><b class="calibre3">7</b></p>
<p class="calibre1"><b class="calibre3">g r a P h i c a l   Pa c k e T </b></p>
<p class="calibre1"><b class="calibre3">a N a ly S i S   T o o l S</b></p>
<p class="calibre1">Chapter 6 introduced the categories of </p>
<p class="calibre1">NSM tools: data presentation, data collec-</p>
<p class="calibre1">tion, and data delivery. As explained in that </p>
<p class="calibre1">chapter, within the data presentation category, </p>
<p class="calibre1">some tools are more suited to packet analysis, and </p>
<p class="calibre1">others are intended to function as NSM consoles. </p>
<p class="calibre1">Chapter 6 focused on data presentation tools that </p>
<p class="calibre1">offer access to packets on the command line. </p>
<p class="calibre1">This chapter focuses on packet analysis tools that give analysts </p>
<p class="calibre1">GUI access to traffic. Tools in this family include Wireshark, Xplico, and </p>
<p class="calibre1">NetworkMiner (NM). All of these applications ship with SO and are avail-</p>
<p class="calibre1">able on demand from the distribution. We’ll start with the most popular </p>
<p class="calibre1">of these types of tools: Wireshark. </p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p170"/><img src="index-170_1.png" alt="Image 72" class="calibre2"/></p>
<p class="calibre1"><b class="calibre3">using wireshark</b></p>
<p class="calibre1">Wireshark is the main tool in the Wireshark suite, which also includes </p>
<p class="calibre1">Tshark and Dumpcap. This section highlights the Wireshark features I use </p>
<p class="calibre1">most regularly when conducting NSM operations. To learn more about </p>
<p class="calibre1">Wireshark, refer to one of the excellent books about it, such as Laura </p>
<p class="calibre1">Chappell’s work at  <i class="calibre4">http://www.wiresharkbook.com/</i>. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Running Wireshark</b></i></p>
<p class="calibre1">Like Tcpdump and Tshark, Wireshark operates on the full content data </p>
<p class="calibre1">stored in the / <i class="calibre4">nsm/sensor_data/&lt;sensorname&gt;/dailylogs</i> directory. You can launch Wireshark either directly or from other tools (such as Sguil, as </p>
<p class="calibre1">explained in Chapter 8). </p>
<p class="calibre1"><b class="calibre3">N o T e </b> <i class="calibre4"> </i></p>
<p class="calibre1"> <i class="calibre4">Wireshark is not necessarily the best tool for processing large collections of full content</i> <i class="calibre4">data, and I typically don’t suggest you begin your analysis of network traffic by loading a</i> <i class="calibre4">gigantic trace into Wireshark. Instead, identify traffic of interest using another means,</i> <i class="calibre4">such as by reviewing session data, and then apply Wireshark to just that traffic. </i></p>
<p class="calibre1">Wireshark is an on-demand tool in SO and will run only if you launch </p>
<p class="calibre1">it manually by entering <b class="calibre3">wireshark</b> in a terminal window, or by choosing </p>
<p class="calibre1"><b class="calibre3">Security Onion</b>4<b class="calibre3">Wireshark </b>from the GUI. Wireshark displays an opening </p>
<p class="calibre1">screen, as shown in Figure 7-1. </p>
<p class="calibre1"> <i class="calibre4">Figure 7-1: Default Wireshark screen</i></p>
<p class="calibre1"><b class="calibre3">136</b>   Chapter 7</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p171"/><img src="index-171_1.jpg" alt="Image 73" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Viewing a Packet Capture in Wireshark</b></i></p>
<p class="calibre1">To open a packet capture in pcap format, follow these steps:</p>
<p class="calibre1">1.  Choose <b class="calibre3">File</b>4<b class="calibre3">Open</b> and navigate to the  <i class="calibre4">/nsm/sensor_data/&lt;sensorname&gt;/</i></p>
<p class="calibre1"> <i class="calibre4">dailylogs</i> directory. </p>
<p class="calibre1">2.  Choose one of the  <i class="calibre4">YYYY-MM-DD</i> directories, and then select a trace of </p>
<p class="calibre1">interest. Wireshark presents some basic statistics about that trace. For </p>
<p class="calibre1">example, in Figure 7-2, the sample trace is 11.9MB (shown in the Size </p>
<p class="calibre1">column) with 19,866 packets (shown in the Packets field). As you can </p>
<p class="calibre1">see in the First Packet field, the trace begins at 2013-02-10 13:09:28 and </p>
<p class="calibre1">lasts 8 minutes and 16 seconds (shown in the Elapsed Time field). </p>
<p class="calibre1">3.  Uncheck the Enable MAC Name Resolution and Enable Transport Name </p>
<p class="calibre1">Resolution options so that you’ll see numbers rather than names for </p>
<p class="calibre1">these fields, and then click <b class="calibre3">Open</b>. </p>
<p class="calibre1"> <i class="calibre4">Figure 7-2: Opening a trace in Wireshark</i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Modifying the Default Wireshark Layout</b></i></p>
<p class="calibre1">After opening a trace, the default Wireshark layout displays the fields shown </p>
<p class="calibre1">in Figure 7-3. These include information such as the packet number, a time-</p>
<p class="calibre1">stamp measured in time since the first packet, source and destination IP </p>
<p class="calibre1">addresses, the protocol, and messages about the packet (in the Info field). </p>
<p class="calibre1">If you would prefer a different layout, you can change the default either </p>
<p class="calibre1">through the GUI or by editing the preferences file. </p>
<p class="calibre1">Graphical Packet Analysis Tools   <b class="calibre3">137</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p172"/><img src="index-172_1.jpg" alt="Image 74" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 7-3: Default columns in Wireshark</i></p>
<p class="calibre1"><b class="calibre3">Modifying the Layout Using the GUI</b></p>
<p class="calibre1">I prefer a Wireshark layout that shows absolute date and time, along with </p>
<p class="calibre1">the source and destination port numbers. We’ll set up that layout as an </p>
<p class="calibre1">example of how to use the Wireshark GUI to modify displayed columns to </p>
<p class="calibre1">better show relevant packet fields. </p>
<p class="calibre1">To change the default layout settings, follow these steps:</p>
<p class="calibre1">1.  Select <b class="calibre3">Edit</b>4<b class="calibre3">Preferences</b>4<b class="calibre3">Columns</b>. </p>
<p class="calibre1">2.  Highlight the Time row. </p>
<p class="calibre1">3.  Change the Field Type field to <b class="calibre3">Absolute Date and Time</b>. </p>
<p class="calibre1">4.  Change the Source Address field to <b class="calibre3">Src Addr (unresolved)</b> and the </p>
<p class="calibre1">Destination Address field to <b class="calibre3">Dest Addr (unresolved)</b>. </p>
<p class="calibre1">5.  Click <b class="calibre3">Add</b>, and then select <b class="calibre3">Source Port (unresolved)</b>. </p>
<p class="calibre1">6.  Double-click the New Column field and replace the Title entry with </p>
<p class="calibre1"><b class="calibre3">SrcPort</b>. </p>
<p class="calibre1">7.  Click <b class="calibre3">Add</b> again, and add <b class="calibre3">Dest Port (unresolved)</b>. </p>
<p class="calibre1">8.  Double-click the New Column field and replace the Title entry with </p>
<p class="calibre1"><b class="calibre3">DstPort</b>. </p>
<p class="calibre1">9.  To hide the Length field that shows the packet length in bytes, high-</p>
<p class="calibre1">light that field and click <b class="calibre3">Remove</b>. </p>
<p class="calibre1"><b class="calibre3">138</b>   Chapter 7</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p173"/><img src="index-173_1.jpg" alt="Image 75" class="calibre2"/></p>
<p class="calibre1">10.  Click and drag each of the new columns to the locations shown in </p>
<p class="calibre1">Figure 7-4. </p>
<p class="calibre1"> <i class="calibre4">Figure 7-4: Customizing the Wireshark layout</i></p>
<p class="calibre1">11.  Click <b class="calibre3">Apply</b>, and then click <b class="calibre3">OK</b>. </p>
<p class="calibre1"><b class="calibre3">Modifying the Preferences File</b></p>
<p class="calibre1">If you prefer a more direct approach to modifying the screen layout, edit </p>
<p class="calibre1">the  <i class="calibre4">.wireshark/preferences</i> file. First, you need to create this file by choosing <b class="calibre3">Edit</b>4<b class="calibre3">Preferences</b>4<b class="calibre3">Columns</b>4<b class="calibre3">Apply</b>4<b class="calibre3">OK</b>, with or without making changes. Then you should find a  <i class="calibre4">.wireshark/preferences</i> file in your home directory. This file controls Wireshark’s column layout and is shown in Listing 7-1. </p>
<p class="calibre1"># Packet list column format. </p>
<p class="calibre1"># Each pair of strings consists of a column title and its format. </p>
<p class="calibre1">column.format:</p>
<p class="calibre1">"No.", "%m", </p>
<p class="calibre1">"Time", "%t", </p>
<p class="calibre1">"Source", "%s", </p>
<p class="calibre1">"Destination", "%d", </p>
<p class="calibre1">"Protocol", "%p", </p>
<p class="calibre1">"Length", "%L", </p>
<p class="calibre1">"Info", "%i" </p>
<p class="calibre1"> <i class="calibre4">Listing 7-1: Contents of the </i> .wireshark/preferences <i class="calibre4"> file</i></p>
<p class="calibre1">Graphical Packet Analysis Tools   <b class="calibre3">139</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p174"/><img src="index-174_1.jpg" alt="Image 76" class="calibre2"/></p>
<p class="calibre1">Close Wireshark and edit the fields in  <i class="calibre4">.wireshark/preferences</i> so that they </p>
<p class="calibre1">appear as shown in Listing 7-2 (with changes shown in bold). Also, delete </p>
<p class="calibre1">the Length field entirely. </p>
<p class="calibre1"># Packet list column format. </p>
<p class="calibre1"># Each pair of strings consists of a column title and its format. </p>
<p class="calibre1">column.format:</p>
<p class="calibre1">"No.", "%m", </p>
<p class="calibre1">"Time", "%<b class="calibre3">Y</b>t", </p>
<p class="calibre1">"Source", "%<b class="calibre3">u</b>s", </p>
<p class="calibre1"><b class="calibre3">"SrcPort", "%uS", </b></p>
<p class="calibre1">"Destination", "%<b class="calibre3">u</b>d", </p>
<p class="calibre1"><b class="calibre3">"DstPort", "%uD", </b></p>
<p class="calibre1">"Protocol", "%p", </p>
<p class="calibre1">"Info", "%i" </p>
<p class="calibre1"> <i class="calibre4">Listing 7-2: Edited contents of the </i> .wireshark/preferences <i class="calibre4"> file</i></p>
<p class="calibre1">When you restart Wireshark and open a trace, the GUI will now display </p>
<p class="calibre1">columns as shown in Figure 7-5. This is a trace from a demo SO stand-</p>
<p class="calibre1">alone system with the display filter arp or ip.addr==192.168.2.127, which tells </p>
<p class="calibre1">Wireshark to show Address Resolution Protocol (ARP) frames, or any traf-</p>
<p class="calibre1">fic involving 192.168.2.127. </p>
<p class="calibre1"> <i class="calibre4">Figure 7-5: Wireshark showing new column preferences and display filter</i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Some Useful Wireshark Features</b></i></p>
<p class="calibre1">Now that you have Wireshark up and running, we’ll discuss a few of my </p>
<p class="calibre1">favorite Wireshark features, including the ability to see low-level proto-</p>
<p class="calibre1">col features in detail. Although Tshark offers this feature, Wireshark’s </p>
<p class="calibre1"><b class="calibre3">140</b>   Chapter 7</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p175"/><img src="index-175_1.jpg" alt="Image 77" class="calibre2"/></p>
<p class="calibre1">graphical nature makes it easier to jump from one element to another. </p>
<p class="calibre1">I also enjoy adding and removing display filters in Wireshark. Again, </p>
<p class="calibre1">you can do this with Tshark, but each new filter requires running Tshark </p>
<p class="calibre1">again. In Wireshark, all it takes is applying the new filter in the GUI. Also, </p>
<p class="calibre1">Wireshark exposes features for controlling how data is decoded, following </p>
<p class="calibre1">streams, and exporting object functions; these help analysts manipulate </p>
<p class="calibre1">traffic in ways not offered in Tshark. </p>
<p class="calibre1"><b class="calibre3">Viewing Lower-Level Protocol Features in Detail</b></p>
<p class="calibre1">Wireshark permits analysts to see lower-level protocol features in extreme </p>
<p class="calibre1">detail. Its deep understanding of protocols allows it to decode just about </p>
<p class="calibre1">every field it encounters, assuming the traffic is unencrypted and recog-</p>
<p class="calibre1">nized by its protocol dissectors. (Should you encounter encrypted sessions, </p>
<p class="calibre1">Wireshark offers some capabilities for incorporating cryptographic keys to </p>
<p class="calibre1">decrypt traffic.)</p>
<p class="calibre1">For example, Figure 7-6 displays an ARP request message. Looking only </p>
<p class="calibre1">at the hex and ASCII values in the bottom pane, you would be hard-pressed </p>
<p class="calibre1">to understand all of the elements of this frame. However, the protocol decode </p>
<p class="calibre1">in the middle pane explains every field quite clearly. Whatever field you high-</p>
<p class="calibre1">light in the middle pane is highlighted in the corresponding hex and ASCII </p>
<p class="calibre1">output in the bottom pane. </p>
<p class="calibre1"> <i class="calibre4">Figure 7-6: Wireshark explains an ARP request message. </i></p>
<p class="calibre1"><b class="calibre3">Omitting traffic to See remnants</b></p>
<p class="calibre1">Another particularly useful feature of Wireshark is its ability to filter traf-</p>
<p class="calibre1">fic to show you interesting remnants. Sometimes I hunt for traffic by tell-</p>
<p class="calibre1">ing Wireshark what to ignore so that I can examine what’s left behind. I </p>
<p class="calibre1">Graphical Packet Analysis Tools   <b class="calibre3">141</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p176"/><img src="index-176_1.jpg" alt="Image 78" class="calibre2"/></p>
<p class="calibre1">start with a simple filter, review the results, add another filter, review the </p>
<p class="calibre1">results, and so on until I’m left with a small amount of traffic to analyze. </p>
<p class="calibre1">For example, Listing 7-3 shows how I progressively built a display filter to </p>
<p class="calibre1">search for noteworthy traffic. </p>
<p class="calibre1">not http and not ntp and not dns and not tcp.port==443 and not tcp.port==80 </p>
<p class="calibre1">and not icmp and not tcp.port==5223 and not arp</p>
<p class="calibre1"> <i class="calibre4">Listing 7-3: Display filter omit ing traffic in Wireshark</i></p>
<p class="calibre1">This filter omits the following:</p>
<p class="calibre1">•  HTTP traffic</p>
<p class="calibre1">•  NTP traffic</p>
<p class="calibre1">•  DNS traffic</p>
<p class="calibre1">•  Any traffic on port 443 TCP</p>
<p class="calibre1">•  Any traffic on port 80 TCP</p>
<p class="calibre1">•  ICMP traffic</p>
<p class="calibre1">•  Any TCP traffic on port 5223 (Apple Push Notification service)</p>
<p class="calibre1">•  Address Resolution Protocol (ARP) traffic</p>
<p class="calibre1">The result is shown in Figure 7-7. </p>
<p class="calibre1"> <i class="calibre4">Figure 7-7: Traffic remaining after applying the display filter in Listing 7-3</i></p>
<p class="calibre1"><b class="calibre3">142</b>   Chapter 7</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p177"/><img src="index-177_1.jpg" alt="Image 79" class="calibre2"/></p>
<p class="calibre1"><b class="calibre3">Following Streams</b></p>
<p class="calibre1">Figure 7-7 shows two sets of TCP streams. The destination port for each is </p>
<p class="calibre1">10002, but the source port for one stream is 60560 and the other is 60563. </p>
<p class="calibre1">With the two streams intertwined, it is somewhat difficult to follow what is </p>
<p class="calibre1">happening. Another drawback to this approach is that I’m more interested </p>
<p class="calibre1">in the content of the conversation, rather than a packet-by-packet list. This </p>
<p class="calibre1">brings me to my third favorite Wireshark feature: following streams. </p>
<p class="calibre1">Wireshark can identify all TCP segments in a stream, reassemble them </p>
<p class="calibre1">using a specific algorithm, and present the results as text. This capabil-</p>
<p class="calibre1">ity makes it easy to identify the purpose of a conversation and determine </p>
<p class="calibre1">whether it is benign, suspicious, or malicious. </p>
<p class="calibre1">To tell Wireshark to reassemble a TCP stream, highlight one of the </p>
<p class="calibre1">packets in a stream, right-click, and choose <b class="calibre3">Follow TCP Stream</b>, as shown </p>
<p class="calibre1">in Figure 7-8. </p>
<p class="calibre1"> <i class="calibre4">Figure 7-8: Choosing Fol ow TCP Stream in Wireshark</i></p>
<p class="calibre1">For this example, Wireshark renders the stream shown in Figure 7-9. </p>
<p class="calibre1">The text at the top shows a GET request from a web browser. The text begin-</p>
<p class="calibre1">ning with HTTP/1.1 200 OK shows a web server’s reply. </p>
<p class="calibre1">Notice that the web client mentions the Accept-Encoding: gzip, deflate </p>
<p class="calibre1">option. The reply from the web server is actually gzip-encoded, but Wireshark </p>
<p class="calibre1">unzips the content and displays cleartext. We recognize this traffic as HTTP, </p>
<p class="calibre1">Graphical Packet Analysis Tools   <b class="calibre3">143</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p178"/><img src="index-178_1.jpg" alt="Image 80" class="calibre2"/></p>
<p class="calibre1">even though Wireshark did not identify it as such by default. (In the figure, </p>
<p class="calibre1">I’ve redacted possibly sensitive information from the transcript involving </p>
<p class="calibre1">the cookie used during this exchange.)</p>
<p class="calibre1"> <i class="calibre4">Figure 7-9: Wireshark displays a reassembled TCP stream. </i></p>
<p class="calibre1"><b class="calibre3">Setting the Protocol Decode Method with Decode as</b></p>
<p class="calibre1">After reassembling a stream as discussed in the previous section, Wireshark </p>
<p class="calibre1">will display only the packets in that stream in the main window. To change </p>
<p class="calibre1">the way that Wireshark sees this traffic, use the Decode As option. This tells </p>
<p class="calibre1">Wireshark to apply a certain protocol decode method to specific traffic. </p>
<p class="calibre1">As an example, we’ll tell Wireshark to think of traffic to port 10002 </p>
<p class="calibre1">as HTTP. </p>
<p class="calibre1">1.  Right-click one of the packets in the stream to be decoded, and click </p>
<p class="calibre1"><b class="calibre3">Decode As</b>, as shown in Figure 7-10. </p>
<p class="calibre1">2.  You will see a menu asking which ports Wireshark should decode. For </p>
<p class="calibre1">this example, choose <b class="calibre3">Destination (10002)</b> in the TCP Port(s) field. </p>
<p class="calibre1">3.  Scroll through the protocols listed on the right to find and select <b class="calibre3">HTTP</b>. </p>
<p class="calibre1">4.  Click <b class="calibre3">Apply</b>. </p>
<p class="calibre1"><b class="calibre3">144</b>   Chapter 7</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p179"/><img src="index-179_1.jpg" alt="Image 81" class="calibre2"/></p>
<p class="calibre1"><img src="index-179_2.jpg" alt="Image 82" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 7-10: Selecting Decode As </i></p>
<p class="calibre1">You’ll see that Wireshark now understands a GET request and a web </p>
<p class="calibre1">server reply, as shown in Figure 7-11. For example, notice how frames 11636 </p>
<p class="calibre1">and 11648 are now listed as HTTP in Wireshark’s Protocol column. </p>
<p class="calibre1"> <i class="calibre4">Figure 7-11: Wireshark decodes port 10002 TCP as HTTP. </i></p>
<p class="calibre1">Graphical Packet Analysis Tools   <b class="calibre3">145</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p180"/><img src="index-180_1.jpg" alt="Image 83" class="calibre2"/></p>
<p class="calibre1"><b class="calibre3">Following Other Streams</b></p>
<p class="calibre1">Depending on the protocol, Wireshark can also follow other sorts of streams, </p>
<p class="calibre1">such as UDP or Secure Sockets Layer (SSL). (Because UDP is not a session-</p>
<p class="calibre1">oriented protocol like TCP, Wireshark makes its best assessment of which </p>
<p class="calibre1">UDP packets make up a UDP “session.”) </p>
<p class="calibre1">Additionally, Wireshark can extract content from some streams, such </p>
<p class="calibre1">as HTTP objects, Server Message Block (SMB) objects, and Digital Imaging </p>
<p class="calibre1">and Communications in Medicine (DICOM) objects. For example, at the </p>
<p class="calibre1">bottom of Figure 7-9, we see that the web server sent a 43-byte  <i class="calibre4">.gif</i> file to </p>
<p class="calibre1">the web client. We can use Wireshark’s HTTP objects export function to </p>
<p class="calibre1">investigate this file. Select<b class="calibre3"> File</b>4<b class="calibre3">Export</b>4 <b class="calibre3">Objects</b>4<b class="calibre3">HTTP</b> to access this feature. You’ll see a window showing all HTTP objects that Wireshark recognizes in the trace, including HTML pages, JavaScript, text, images, and </p>
<p class="calibre1">other objects. To access the packet of interest here, scroll down to packet </p>
<p class="calibre1">11648, which contains the HTTP/1.1 200 OK (GIF89a) message, as shown in </p>
<p class="calibre1">Figure 7-12. Then click <b class="calibre3">Save As</b>, name the file, and save it. </p>
<p class="calibre1"> <i class="calibre4">Figure 7-12: Wireshark HTTP object list</i></p>
<p class="calibre1">Upon reviewing the  <i class="calibre4">.gif</i>, you’ll find that it’s a 1×1 pixel image, perhaps </p>
<p class="calibre1">for tracking and advertisement purposes. The web server in question at </p>
<p class="calibre1">74.201.145.181 is owned by OwnerIQ, described at  <i class="calibre4">http://www.owneriq.com/</i> </p>
<p class="calibre1">as “THE advertising network that pioneered the concept of Ownership </p>
<p class="calibre1"><b class="calibre3">146</b>   Chapter 7</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p181"/>Targeting. . . . We enable advertisers to define and reach their ideal online consumer.” That sounds like the sort of service that might deploy a 1×1 “web </p>
<p class="calibre1">bug” image on a nonstandard port for tracking purposes. </p>
<p class="calibre1">As you can see, Wireshark equips us with the ability to pivot from one </p>
<p class="calibre1">datatype to another, applying extra processing to certain protocols when </p>
<p class="calibre1">possible. That’s just the beginning! As I suggested at the beginning of this </p>
<p class="calibre1">section, read a book devoted to Wireshark to learn more about its capabilities. </p>
<p class="calibre1"><b class="calibre3">using xplico</b></p>
<p class="calibre1">Xplico ( <i class="calibre4">http://www.xplico.org/</i>) is an open source network forensic analysis </p>
<p class="calibre1">(NFA) tool that understands many network protocols and will carve out the </p>
<p class="calibre1">information it recognizes. </p>
<p class="calibre1"><b class="calibre3">N o T e </b> <i class="calibre4"> </i></p>
<p class="calibre1"> <i class="calibre4">Gianluca Costa and Andrea De Franceschi developed Xplico under the GNU General </i></p>
<p class="calibre1"> <i class="calibre4">Public License version 2. </i></p>
<p class="calibre1">As an NFA tool, Xplico is most often used against a saved trace file to </p>
<p class="calibre1">extract and interpret interesting content, as we will do in this chapter’s </p>
<p class="calibre1">example. Xplico can also sniff traffic live from the wire. However, the </p>
<p class="calibre1">authors don’t recommend running Xplico against a live interface and say </p>
<p class="calibre1">that is more for demonstrations than production use. </p>
<p class="calibre1">To understand Xplico, we’ll use it to analyze network traffic available </p>
<p class="calibre1">through the Digital Corpora project ( <i class="calibre4">http://www.digitalcorpora.org/</i>). Digital Corpora is a National Science Foundation grant–funded collection of digital evidence, led by forensics guru Simson Garfinkel. Analysts and students </p>
<p class="calibre1">can use the Digital Corpora project to download and interpret data from </p>
<p class="calibre1">cell phones, hard drives, and network traffic in order to learn how to use </p>
<p class="calibre1">forensic tools and techniques. </p>
<p class="calibre1">We’ll use the pcap file bundled in the “Nitroba University Harass-</p>
<p class="calibre1">ment Scenario” ( <i class="calibre4">http://digitalcorpora.org/corpora/scenarios/nitroba-university </i></p>
<p class="calibre1"> <i class="calibre4">-harassment-scenario/</i>) posted at  <i class="calibre4">http://digitalcorpora.org/corp/nps/packets/ </i></p>
<p class="calibre1"> <i class="calibre4">2008-nitroba/nitroba.pcap</i>. The trace is approximately 55MB and contains a </p>
<p class="calibre1">variety of network traffic suitable for NSM and forensic review. Download </p>
<p class="calibre1">the  <i class="calibre4">nitroba.pcap</i> file before trying to use Xplico. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Running Xplico</b></i></p>
<p class="calibre1">Xplico is managed via a web browser. By default, SO is configured to allow </p>
<p class="calibre1">only local access to the Xplico web server. Remote users must either tunnel </p>
<p class="calibre1">traffic via OpenSSH (as discussed in Chapter 5) or alter the firewall rules </p>
<p class="calibre1">to permit remote access to port 9876 TCP. Choose the option that best meets </p>
<p class="calibre1">your needs. </p>
<p class="calibre1">When first accessing Xplico, you may see an error like the one shown in </p>
<p class="calibre1">Figure 7-13. </p>
<p class="calibre1">Graphical Packet Analysis Tools   <b class="calibre3">147</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p182"/><img src="index-182_1.png" alt="Image 84" class="calibre2"/></p>
<p class="calibre1"><img src="index-182_2.jpg" alt="Image 85" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 7-13: By default, Xplico is not running. </i></p>
<p class="calibre1">This error means that while the Apache web server on SO is serving </p>
<p class="calibre1">pages, the Xplico service is not yet active. Fix that by running the command </p>
<p class="calibre1">shown in Listing 7-4. </p>
<p class="calibre1">$ <b class="calibre3">sudo service xplico start</b></p>
<p class="calibre1">* Starting  Xplico                                                          </p>
<p class="calibre1">Modifying priority to -1                                 [ OK ]</p>
<p class="calibre1"> <i class="calibre4">Listing 7-4: Starting the Xplico service</i></p>
<p class="calibre1">Now reload the web browser and choose a language. Next, use the </p>
<p class="calibre1">username <b class="calibre3">xplico</b> and the password <b class="calibre3">xplico</b> to log in, as shown in Figure 7-14. </p>
<p class="calibre1">(Selecting the language changes the URL but does not show the language </p>
<p class="calibre1">choice in the Language drop-down box.)</p>
<p class="calibre1"> <i class="calibre4">Figure 7-14: Logging in to Xplico</i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Creating Xplico Cases and Sessions</b></i></p>
<p class="calibre1">Xplico organizes network traffic as  <i class="calibre4">sessions</i> and refers to analysis sessions as <i class="calibre4">cases</i>. To start a new case and a session to interpret, follow these steps:</p>
<p class="calibre1">1.  Select <b class="calibre3">New Case</b> and leave the default Data Acquisition method set to </p>
<p class="calibre1"><b class="calibre3">Uploading PCAP Capture File/s</b>, as shown in Figure 7-15. </p>
<p class="calibre1">2.  Enter a case name, and then click <b class="calibre3">Create</b>. </p>
<p class="calibre1"><b class="calibre3">148</b>   Chapter 7</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p183"/><img src="index-183_1.jpg" alt="Image 86" class="calibre2"/></p>
<p class="calibre1"><img src="index-183_2.jpg" alt="Image 87" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 7-15: Creating a new case in Xplico</i></p>
<p class="calibre1">3.  After creating a new case, you should see it listed in a cases list. Click </p>
<p class="calibre1">the name of the case to continue. </p>
<p class="calibre1">4.  Click the <b class="calibre3">New Session</b> link in the upper-left menu to create a new session. </p>
<p class="calibre1">5.  Give the session a name, as shown in Figure 7-16, and then click <b class="calibre3">Create</b>. </p>
<p class="calibre1">(Xplico will allow only alphanumeric characters in session names, so </p>
<p class="calibre1">you cannot use dashes in the name.)</p>
<p class="calibre1"> <i class="calibre4">Figure 7-16: Creating a new session in Xplico</i></p>
<p class="calibre1">With the new session created, Xplico is now ready to process network </p>
<p class="calibre1">traffic. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Processing Network Traffic</b></i></p>
<p class="calibre1">To process network traffic, click the name of the session. You will see a </p>
<p class="calibre1">screen like the one shown in Figure 7-17. Because we have not processed </p>
<p class="calibre1">any traffic yet, Xplico will not show any results. </p>
<p class="calibre1">Select <b class="calibre3">Choose File</b>, browse to the  <i class="calibre4">nitroba.pcap </i> file you downloaded earlier, click <b class="calibre3">Open</b>, and then click <b class="calibre3">Upload</b>. The web browser should report that it is uploading the file. Once the file has been uploaded, Xplico will display </p>
<p class="calibre1">“File uploaded, wait start decoding…” at the top of the screen. </p>
<p class="calibre1">It will probably take a few minutes for Xplico to process the traffic, </p>
<p class="calibre1">depending on your hardware. Once Xplico has finished decoding the </p>
<p class="calibre1">traffic, it should report <b class="calibre3">Decoding Completed</b> in the Status field. Its main </p>
<p class="calibre1">screen will display statistics on the sorts of traffic it recognized and inter-</p>
<p class="calibre1">preted, as shown in Figure 7-18. </p>
<p class="calibre1">Graphical Packet Analysis Tools   <b class="calibre3">149</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p184"/><img src="index-184_1.png" alt="Image 88" class="calibre2"/></p>
<p class="calibre1"><img src="index-184_2.png" alt="Image 89" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 7-17: Xplico session screen</i></p>
<p class="calibre1"> <i class="calibre4">Figure 7-18: Xplico has finished decoding the trace file. </i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Understanding the Decoded Traffic</b></i></p>
<p class="calibre1">At this point, an analyst can peruse the decoded traffic for content of inter-</p>
<p class="calibre1">est. This investigative method differs from that of the previous tools, which </p>
<p class="calibre1">interact with packets or sessions. With Xplico, analysts manipulate and </p>
<p class="calibre1">browse extracted content. </p>
<p class="calibre1">For example, an analyst may want to know if video content was trans-</p>
<p class="calibre1">ferred during a web browsing session. In fact, Figure 7-18 shows <b class="calibre3">1</b> in the </p>
<p class="calibre1"><b class="calibre3">150</b>   Chapter 7</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p185"/><img src="index-185_1.png" alt="Image 90" class="calibre2"/></p>
<p class="calibre1"><img src="index-185_2.jpg" alt="Image 91" class="calibre2"/></p>
<p class="calibre1">Video field in the HTTP section of the summary screen. This means Xplico </p>
<p class="calibre1">extracted video content from the network traffic and can make it viewable </p>
<p class="calibre1">to users. To access the content, click the <b class="calibre3">Web</b> link in the upper-left corner </p>
<p class="calibre1">of the Xplico display, and then click the <b class="calibre3">Site</b> link that appears next. </p>
<p class="calibre1">By default, Xplico will show the last 16 web sessions, with the newest </p>
<p class="calibre1">listed first, as shown in Figure 7-19. </p>
<p class="calibre1"> <i class="calibre4">Figure 7-19: Xplico’s list of web sessions</i></p>
<p class="calibre1">To access the video content that Xplico identified, click the <b class="calibre3">Video</b> radio </p>
<p class="calibre1">button at the top of the screen, and then click <b class="calibre3">Go</b>. Xplico shows a link to a </p>
<p class="calibre1"> <i class="calibre4">googlevideo.com</i> site, as shown in Figure 7-20. </p>
<p class="calibre1"> <i class="calibre4">Figure 7-20: One video link in the Digital Corpora trace</i></p>
<p class="calibre1">Graphical Packet Analysis Tools   <b class="calibre3">151</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p186"/><img src="index-186_1.jpg" alt="Image 92" class="calibre2"/></p>
<p class="calibre1"><img src="index-186_2.jpg" alt="Image 93" class="calibre2"/></p>
<p class="calibre1">Clicking the  <i class="calibre4">info.xml</i> link at the far right reveals options to see metadata </p>
<p class="calibre1">about the trace, as well as a link to download pcap. Most interesting, clicking </p>
<p class="calibre1">the URL shown in Figure 7-20 or the gray box to the right of the link will </p>
<p class="calibre1">open the video for viewing, as shown in Figure 7-21. This video is not being </p>
<p class="calibre1">streamed from the Web; it’s a reconstruction of the video as downloaded </p>
<p class="calibre1">when the network traffic was originally captured. </p>
<p class="calibre1"> <i class="calibre4">Figure 7-21: Reconstructing a video downloaded from the Web</i></p>
<p class="calibre1">It’s also possible to browse thumbnails of images downloaded while this </p>
<p class="calibre1">network trace was being captured. As shown in Figure 7-22, someone went </p>
<p class="calibre1">shopping for a backpack at eBay. </p>
<p class="calibre1"> <i class="calibre4">Figure 7-22: Reconstructing images downloaded from the Web</i></p>
<p class="calibre1"><b class="calibre3">152</b>   Chapter 7</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p187"/><img src="index-187_1.jpg" alt="Image 94" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Getting Metadata and Summarizing Traffic</b></i></p>
<p class="calibre1">Besides reconstructing interesting content, Xplico provides some metadata </p>
<p class="calibre1">and summarization of the traffic it understands. To see this in action, fol-</p>
<p class="calibre1">low these steps:</p>
<p class="calibre1">1.  Under the <b class="calibre3">Graphs</b> menu item in the upper-left portion of the screen, </p>
<p class="calibre1">click the <b class="calibre3">DNS</b> link to tell Xplico to show a sorted list of DNS queries. </p>
<p class="calibre1">2.  At the top of the screen, a red, yellow, and green pie chart icon will </p>
<p class="calibre1">appear. Click that icon to display a bar chart of DNS responses, with </p>
<p class="calibre1">a tab for Host Popularity in the upper-right corner. </p>
<p class="calibre1">3.  Click the <b class="calibre3">Host Popularity</b> tab to see a chart with DNS queries ordered </p>
<p class="calibre1">by frequency, as shown in Figure 7-23. </p>
<p class="calibre1"> <i class="calibre4">Figure 7-23: Xplico graphs DNS queries by frequency. </i></p>
<p class="calibre1">4.  Highlight any bar to display the hostname queried and a response </p>
<p class="calibre1">count. </p>
<p class="calibre1">Xplico makes it very easy to review a variety of content captured in a </p>
<p class="calibre1">network trace. By publishing the data through SO’s Apache web server, the </p>
<p class="calibre1">authors allow anyone with a web browser and authenticated access to review </p>
<p class="calibre1">the data. This is one tool that really brings NSM extracted content to life. </p>
<p class="calibre1"><b class="calibre3">examining content with NetworkMiner</b></p>
<p class="calibre1">NM ( <i class="calibre4">http://sourceforge.net/projects/networkminer/</i>) is an open source NFA tool that also exists as a commercial version. </p>
<p class="calibre1"><b class="calibre3">N o T e </b> <i class="calibre4"> </i></p>
<p class="calibre1"> <i class="calibre4">Erik Hjelmvik develops NM under the GNU General Public License version 2. </i></p>
<p class="calibre1">Graphical Packet Analysis Tools   <b class="calibre3">153</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p188"/><img src="index-188_1.jpg" alt="Image 95" class="calibre2"/></p>
<p class="calibre1">The commercial version of NM at  <i class="calibre4">http://www.netresec.com/</i> enables remote </p>
<p class="calibre1">packet capture via Pcap-over-IP, Port Independent Protocol Identification </p>
<p class="calibre1">(PIPI; see  <i class="calibre4">http://taosecurity.blogspot.com/2006/09/port-independent-protocol </i></p>
<p class="calibre1"> <i class="calibre4">.html</i> for a description), and other features. The free version bundled with </p>
<p class="calibre1">SO contains the core features an analyst would want in order to examine </p>
<p class="calibre1">content. </p>
<p class="calibre1">In this section, we’ll see what NM does with the Digital Corpora trace </p>
<p class="calibre1">examined earlier in the Xplico discussion. If you haven’t already down-</p>
<p class="calibre1">loaded  <i class="calibre4">nitroba.pcap</i> onto the SO platform, do that before continuing. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Running NetworkMiner</b></i></p>
<p class="calibre1">NM is a Windows application, but the SO team configured it to run under </p>
<p class="calibre1">the open source Mono ( <i class="calibre4">http://www.mono-project.com/</i>) implementation of </p>
<p class="calibre1">Microsoft’s .NET Framework. </p>
<p class="calibre1">To access NM from the SO desktop click the blue-and-white mouse </p>
<p class="calibre1">icon, then <b class="calibre3">Security Onion</b>, and finally <b class="calibre3">NetworkMiner</b>. By default, NM wants to watch a live interface to collect traffic. To start the analysis process, select </p>
<p class="calibre1"><b class="calibre3">File</b>4<b class="calibre3">Open</b> in NM and browse to the location of the  <i class="calibre4">nitroba.pcap</i> file. </p>
<p class="calibre1">Once the file is loaded, NM should display a flurry of analysis activity, </p>
<p class="calibre1">including extracting content and resolving all of the domain names it finds </p>
<p class="calibre1">in the trace, as shown in Figure 7-24. This process may take an hour or two </p>
<p class="calibre1">and will keep your SO platform busy. </p>
<p class="calibre1"> <i class="calibre4">Figure 7-24: NM processes the </i> nitroba .pcap <i class="calibre4"> trace. </i></p>
<p class="calibre1"><b class="calibre3">154</b>   Chapter 7</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p189"/><img src="index-189_1.png" alt="Image 96" class="calibre2"/></p>
<p class="calibre1"><b class="calibre3">N o T e </b> <i class="calibre4"> </i></p>
<p class="calibre1"> <i class="calibre4">NM on Windows is much faster than it is on Mono and Linux. You may want to </i></p>
<p class="calibre1"> <i class="calibre4">install it on a Windows workstation with plenty of memory, or limit its use on SO </i></p>
<p class="calibre1"> <i class="calibre4">to processing smaller trace files. </i></p>
<p class="calibre1">The remainder of this section focuses on how to interact with the same </p>
<p class="calibre1"> <i class="calibre4">nitroba.pcap</i> trace using the Windows version of NM, which is functionally </p>
<p class="calibre1">equivalent to NM on Linux. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Col ecting and Organizing Traffic Details</b></i></p>
<p class="calibre1">Many analysts begin reviewing NM data in its Hosts tab, which lists all IP </p>
<p class="calibre1">addresses that it sees in a network trace, as you can see in Figure 7-25. The </p>
<p class="calibre1">IP address 192.168.15.5 is shown highlighted and expanded in the figure. </p>
<p class="calibre1">To expand an entry for an IP address, click the small box to the left of that </p>
<p class="calibre1">address. </p>
<p class="calibre1"> <i class="calibre4">Figure 7-25: Metadata from NM for IP address 192.168.15.5</i></p>
<p class="calibre1">As you can see, although NM couldn’t identify the operating system, it </p>
<p class="calibre1">does tell us that the MAC address is assigned to TRENDnet, a maker of net-</p>
<p class="calibre1">working equipment. The Universal Plug and Play (UPnP) queries involving </p>
<p class="calibre1">MediaRenderer indicate that this device may be an audiovisual platform. </p>
<p class="calibre1">The details and metadata for IP 192.168.15.4 are very different from </p>
<p class="calibre1">that of 192.168.15.5, as shown in Figure 7-26. </p>
<p class="calibre1">Graphical Packet Analysis Tools   <b class="calibre3">155</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p190"/><img src="index-190_1.png" alt="Image 97" class="calibre2"/></p>
<p class="calibre1"><img src="index-190_2.png" alt="Image 98" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 7-26: Metadata from NM for IP address 192.168.15.4</i></p>
<p class="calibre1">The hardware at this address appears to be an Apple device. In addition, </p>
<p class="calibre1">the Host Details section shows a variety of web browser user-agent strings, </p>
<p class="calibre1">which tells us that this system is much more active than 192.168.15.5, as </p>
<p class="calibre1">shown by the number of outgoing sessions (1658). </p>
<p class="calibre1">At the bottom of the Host Details section, the screen resolutions observed </p>
<p class="calibre1">during the traffic capture that NM obtained from Google Analytics are listed, </p>
<p class="calibre1">as shown in Figure 7-27. </p>
<p class="calibre1"> <i class="calibre4">Figure 7-27: NM lists three screen resolutions for IP address 192.168.15.4. </i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Rendering Content</b></i></p>
<p class="calibre1">In addition to collecting and organizing details about hosts seen on the wire, </p>
<p class="calibre1">NM extracts content and renders it for easy viewing. Figure 7-28 shows an </p>
<p class="calibre1">example involving email. </p>
<p class="calibre1"><b class="calibre3">156</b>   Chapter 7</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p191"/><img src="index-191_1.png" alt="Image 99" class="calibre2"/></p>
<p class="calibre1">The Messages tab in Figure 7-28 shows an email sent from 192.168.15.4, </p>
<p class="calibre1">the Apple computer that we reviewed in Figure 7-26. A sender with the email </p>
<p class="calibre1">address  <i class="calibre4">the_whole_world_is_watching@nitroba.org</i> sent an unpleasant email </p>
<p class="calibre1">message to  <i class="calibre4">lilytuckrige@yahoo.com</i>. Now we understand why this is a harass-</p>
<p class="calibre1">ment case. </p>
<p class="calibre1"> <i class="calibre4">Figure 7-28: Harassing email extracted by NM</i></p>
<p class="calibre1">Like Xplico, NM extracts and displays all captured images, along with </p>
<p class="calibre1">various other forms of content. It can be a bit easier to use than Xplico </p>
<p class="calibre1">because you scroll through output, rather than click from page to page as </p>
<p class="calibre1">with Xplico’s web server. NM can simplify the process of extracting content </p>
<p class="calibre1">in bulk from a network trace. </p>
<p class="calibre1"><b class="calibre3">conclusion</b></p>
<p class="calibre1">This chapter described three graphical packet analysis tools: Wireshark, </p>
<p class="calibre1">Xplico, and NM. Wireshark is undoubtedly the most popular, with support </p>
<p class="calibre1">for thousands of protocols and an ever-expanding set of capabilities. Lesser-</p>
<p class="calibre1">known projects like Xplico and NM are more forensics focused, providing </p>
<p class="calibre1">parsers to extract content automatically and giving analysts an overview of </p>
<p class="calibre1">network-derived artifacts. </p>
<p class="calibre1">Choosing which tool to use depends on the needs of the investiga-</p>
<p class="calibre1">tion. When you require deep understanding of a protocol, I recommend </p>
<p class="calibre1">Wireshark. When you want rapid overviews of content exchanged between </p>
<p class="calibre1">computers, Xplico or NM may be more appropriate. </p>
<p class="calibre1">Each of these tools offers different capabilities and exposes various </p>
<p class="calibre1">forms of NSM data. While these tools are powerful additions to the analyst’s </p>
<p class="calibre1">arsenal, they don’t function as NSM consoles. Chapter 8 concludes the data </p>
<p class="calibre1">presentation tool discussion by looking at the NSM consoles Sguil, Squert, </p>
<p class="calibre1">Snorby, and ELSA. </p>
<p class="calibre1">Graphical Packet Analysis Tools   <b class="calibre3">157</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p192"/><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p193"/><b class="calibre3">8</b></p>
<p class="calibre1"><b class="calibre3">N S M   c o N S o l e S</b></p>
<p class="calibre1">Chapters 6 and 7 discussed tools for packet </p>
<p class="calibre1">analysis. This chapter covers NSM con-</p>
<p class="calibre1">soles, which are tools built specifically for </p>
<p class="calibre1">NSM. Applications like Tcpdump, Tshark, </p>
<p class="calibre1">Wireshark, Xplico, and NetworkMiner process live </p>
<p class="calibre1">traffic or traffic saved in pcap format. When reading</p>
<p class="calibre1">this chapter, you may recall features of those tools that share certain simi-</p>
<p class="calibre1">larities with the software discussed here. Some of them generate session or </p>
<p class="calibre1">extracted content data, for example, or present multiple forms of data in </p>
<p class="calibre1">a single interface. The difference between the tools covered in Chapters 6 </p>
<p class="calibre1">and 7 and those presented in this chapter is that the NSM consoles help </p>
<p class="calibre1">analysts drive a decision-making process, rather than a troubleshooting or </p>
<p class="calibre1">forensic process. </p>
<p class="calibre1">Furthermore, NSM consoles tend not to work on raw packets, whether </p>
<p class="calibre1">in the form of live traffic or traffic saved in pcap format. All of the tools in </p>
<p class="calibre1">Chapters 6 and 7 contained features that let analysts tell the software to </p>
<p class="calibre1">sniff traffic from the wire or open a saved trace. NSM consoles, in contrast, </p>
<p class="calibre1">offer a framework and interface to manipulate and interact with multiple </p>
<p class="calibre1">NSM datatypes, but generally not via processing a saved trace. This is a </p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p194"/>limitation in some respects, because it restricts their use to live operational scenarios. This is not necessarily true of some commercial tools, but the </p>
<p class="calibre1">focus of this book is open source software packaged with the free SO distri-</p>
<p class="calibre1">bution: Sguil, Squert, Snorby, and ELSA. </p>
<p class="calibre1"><b class="calibre3">an NSM-centric look at Network Traffic</b></p>
<p class="calibre1">The tools we’ve explored so far generate one or more forms of NSM data. </p>
<p class="calibre1">Here’s a brief recap of the NSM datatypes (introduced in Chapter 1):</p>
<p class="calibre1"><b class="calibre3">Full content data</b>  Network traffic stored to disk in pcap format. </p>
<p class="calibre1"><b class="calibre3">Extracted content</b>  Information carved from network traffic, such as </p>
<p class="calibre1">files or web pages. </p>
<p class="calibre1"><b class="calibre3">Session data</b>  A high-level summary of network conversations, focusing </p>
<p class="calibre1">on who talked to whom, at what time, plus how much information was </p>
<p class="calibre1">exchanged. </p>
<p class="calibre1"><b class="calibre3">Transaction data</b>  A more granular form of session data, exposing </p>
<p class="calibre1">details of protocols with request-reply characteristics like HTTP, FTP, </p>
<p class="calibre1">and SMTP. </p>
<p class="calibre1"><b class="calibre3">Statistical data</b>  Descriptive information that characterizes network </p>
<p class="calibre1">activity, like counts of various aspects of conversations. </p>
<p class="calibre1"><b class="calibre3">Metadata</b>  “Data about data,” or an integration of external information </p>
<p class="calibre1">like geography or ownership, applied to network information. </p>
<p class="calibre1"><b class="calibre3">Alert data</b>  Reflects whether traffic triggered some sort of notification. </p>
<p class="calibre1">It’s a judgment made by a tool, typically an IDS, about some characteris-</p>
<p class="calibre1">tic of network traffic. </p>
<p class="calibre1">That’s a lot of data to manage. NSM isn’t about collecting evidence for </p>
<p class="calibre1">the sake of having it, though. CIRTs collect NSM data because it enables </p>
<p class="calibre1">them to achieve a specific business objective. The outcome of an NSM-</p>
<p class="calibre1">centric look at network traffic is a decision: Is the event in question benign, </p>
<p class="calibre1">suspicious, or malicious? The answer to that question determines what a </p>
<p class="calibre1">CIRT analyst does next. Mature CIRTs answer these questions to meet busi-</p>
<p class="calibre1">ness goals, such as conducting detection and response in one hour or less. </p>
<p class="calibre1">Many forms of network data, and tools to inspect that data, help ana-</p>
<p class="calibre1">lysts meet business security goals. Tools built specifically for NSM, however, </p>
<p class="calibre1">assist in three specific ways:</p>
<p class="calibre1">•  They make it easy for analysts to review multiple forms of NSM data, </p>
<p class="calibre1">often within a single interface. </p>
<p class="calibre1">•  They enable analysts to “pivot,” or transition, from one form of NSM </p>
<p class="calibre1">data to another. </p>
<p class="calibre1">•  They capture the outcome of the analyst’s decision-making process. </p>
<p class="calibre1">NSM-specific tools make a workflow possible, usually coordinating the </p>
<p class="calibre1">actions of multiple analysts to complete a shared objective. </p>
<p class="calibre1"><b class="calibre3">160</b>   Chapter 8</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p195"/>Sguil, Squert, Snorby, and ELSA are four open source tools written by NSM practitioners, for NSM practitioners. These software authors realized </p>
<p class="calibre1">that other tools for analyzing network-centric data were helpful but not </p>
<p class="calibre1">sufficient for conducting NSM as a continuous business process. Each tool </p>
<p class="calibre1">offers a way to integrate several types of NSM data, pivoting among the </p>
<p class="calibre1">information, and, in most cases, classifying the outcome of an investigation. </p>
<p class="calibre1">The NSM consoles packaged with SO work with several overlapping sets </p>
<p class="calibre1">of NSM data. Whereas the packet analysis tools discussed in Chapters 6 and 7 </p>
<p class="calibre1">tend to be  <i class="calibre4">producers</i> of NSM data, the consoles in this chapter are more like </p>
<p class="calibre1"> <i class="calibre4">consumers</i> of NSM data. Similar to the tools profiled in Chapters 6 and 7, </p>
<p class="calibre1">the consoles in this chapter are available in SO by default, except for ELSA. </p>
<p class="calibre1">(The setup wizard asks if you want to run ELSA when installing SO.) This </p>
<p class="calibre1">chapter highlights the key features of each tool to help you decide which </p>
<p class="calibre1">best suits the needs of your NSM operation. </p>
<p class="calibre1"><b class="calibre3">using Sguil</b></p>
<p class="calibre1">Sguil ( <i class="calibre4">http://www.sguil.net/</i>) is an open source NSM, first written as a </p>
<p class="calibre1">proprietary application, but then recoded and released as open source </p>
<p class="calibre1">in early 2003. </p>
<p class="calibre1"><b class="calibre3">N o T e </b> <i class="calibre4"> </i></p>
<p class="calibre1"> <i class="calibre4">Bamm Visscher codes Sguil under the Qt Public License </i>( <i class="calibre4">QPL, </i> http://sourceforge </p>
<p class="calibre1">.net/projects/sguil/) <i class="calibre4">. </i></p>
<p class="calibre1">Sguil is one of the main applications packaged with SO. Its components </p>
<p class="calibre1">collect, store, and present data that other SO tools use, and certain applica-</p>
<p class="calibre1">tions rely on Sguil’s authentication database. Even if you decide not to use </p>
<p class="calibre1">the Sguil console to review NSM data, you’ll benefit from its collection and </p>
<p class="calibre1">management of NSM data. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Running Sguil</b></i></p>
<p class="calibre1">Sguil is a client/server application written in Tcl/Tk. Its server coordinates </p>
<p class="calibre1">with Sguil agents deployed on sensors to collect NSM data. The Sguil client </p>
<p class="calibre1">is the analyst’s window into Sguil’s data. You can start the Sguil console </p>
<p class="calibre1">via the Sguil icon on the SO desktop, or you can install the Sguil client on </p>
<p class="calibre1">another computer. </p>
<p class="calibre1">The tools we’ve discussed so far work by analyzing live or saved network </p>
<p class="calibre1">traffic; they’re meant for use in live operations or when conducting review </p>
<p class="calibre1">on historical activity. In contrast, Sguil is a solely a live tool. You can’t use </p>
<p class="calibre1">Sguil to “open” a saved network trace; you can interact with Sguil only as its </p>
<p class="calibre1">various components and dependencies collect and generate traffic gathered </p>
<p class="calibre1">from a live network interface. As an example, we’ll use the Sguil client to </p>
<p class="calibre1">interact with a sample server and sensor. </p>
<p class="calibre1">NSM Consoles   <b class="calibre3">161</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p196"/><b class="calibre3">N o T e </b> <i class="calibre4"> </i></p>
<p class="calibre1"> <i class="calibre4">If you’ve already installed SO, you should be able to follow along with the example. </i></p>
<p class="calibre1"> <i class="calibre4">However, the data you see will not match the data shown because you’ll be watching</i> <i class="calibre4">new, live data, although the analysis process is the same. </i></p>
<p class="calibre1">Before running Sguil, make sure that all of its underlying services are </p>
<p class="calibre1">running on the sensor with the service command, as shown in Listing 8-1. </p>
<p class="calibre1">You should see OK in each field. </p>
<p class="calibre1">$ <b class="calibre3">sudo service nsm status</b></p>
<p class="calibre1">Status: securityonion</p>
<p class="calibre1">* sguil server                                                       [  OK  ]</p>
<p class="calibre1">Status: HIDS</p>
<p class="calibre1">* ossec_agent (sguil)                                                [  OK  ]</p>
<p class="calibre1">Status: Bro</p>
<p class="calibre1">Name       Type       Host       Status        Pid    Peers  Started            </p>
<p class="calibre1">bro        standalone localhost  running       2433   0      24 Feb 18:27:19</p>
<p class="calibre1">Status: sademo-eth1</p>
<p class="calibre1">* netsniff-ng (full packet data)                                     [  OK  ]</p>
<p class="calibre1">* pcap_agent (sguil)                                                 [  OK  ]</p>
<p class="calibre1">* snort_agent-1 (sguil)                                              [  OK  ]</p>
<p class="calibre1">* snort-1 (alert data)                                               [  OK  ]</p>
<p class="calibre1">* barnyard2-1 (spooler, unified2 format)                             [  OK  ]</p>
<p class="calibre1">* prads (sessions/assets)                                            [  OK  ]</p>
<p class="calibre1">* sancp_agent (sguil)                                                [  OK  ]</p>
<p class="calibre1">* pads_agent (sguil)                                                 [  OK  ]</p>
<p class="calibre1">* argus                                                              [  OK  ]</p>
<p class="calibre1">* http_agent (sguil)                                                 [  OK  ]</p>
<p class="calibre1"> <i class="calibre4">Listing 8-1: Output of the sudo service nsm status command</i></p>
<p class="calibre1">If one or more components are not running, you can try restarting all </p>
<p class="calibre1">of the software using the following command:</p>
<p class="calibre1">$ <b class="calibre3">sudo service nsm restart</b></p>
<p class="calibre1">If one or more components are still not running, you may need to rerun </p>
<p class="calibre1">the SO setup script or consult the SO mailing list for additional assistance. </p>
<p class="calibre1">Once you’ve confirmed that all services are running, connect to the Sguil </p>
<p class="calibre1">console by clicking the Sguil icon on the SO desktop. In this example, the </p>
<p class="calibre1">Sguil client will connect to the Sguil server on localhost. (You could connect </p>
<p class="calibre1">to the server from another computer running a Sguil client, but it’s easier to </p>
<p class="calibre1">use the SO platform.) </p>
<p class="calibre1">1.  Connect to your instance of an SO server, and enter the username and </p>
<p class="calibre1">password you selected for Sguil during the SO installation process, as </p>
<p class="calibre1">shown in Figure 8-1, and then click <b class="calibre3">OK</b>. </p>
<p class="calibre1">2.  The Sguil client asks you to select network(s) to monitor. Click <b class="calibre3">Select </b></p>
<p class="calibre1"><b class="calibre3">All</b>, and then click <b class="calibre3">Start Sguil</b>. </p>
<p class="calibre1"><b class="calibre3">162</b>   Chapter 8</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p197"/><img src="index-197_1.jpg" alt="Image 100" class="calibre2"/></p>
<p class="calibre1"><img src="index-197_2.png" alt="Image 101" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 8-1: Logging in to Sguil</i></p>
<p class="calibre1">3.  The Sguil console appears. Highlight any row in the top section, and </p>
<p class="calibre1">then check the <b class="calibre3">Reverse DNS</b>, <b class="calibre3">Show Packet Data</b>, and <b class="calibre3">Show Rule</b> boxes. </p>
<p class="calibre1">The Sguil console will display data like that shown in Figure 8-2. </p>
<p class="calibre1"> <i class="calibre4">Figure 8-2: The Sguil console displaying data</i></p>
<p class="calibre1">If you see information similar to that in Figure 8-2, your Sguil installa-</p>
<p class="calibre1">tion is working as expected. </p>
<p class="calibre1">NSM Consoles   <b class="calibre3">163</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p198"/> <i class="calibre4"><b class="calibre3">Sguil’s Six Key Functions</b></i></p>
<p class="calibre1">Sguil enables six key functions helpful to NSM analysts: </p>
<p class="calibre1">•  Sguil performs simple aggregation of similar alert data records. </p>
<p class="calibre1">•  Sguil makes certain types of metadata, and related data, readily </p>
<p class="calibre1">available. </p>
<p class="calibre1">•  Sguil allows queries and review of alert data. </p>
<p class="calibre1">•  Sguil permits queries and review of session data. </p>
<p class="calibre1">•  Sguil provides a right-click menu that lets you pivot, or move from </p>
<p class="calibre1">either of those two categories of data to full content data, rendered as </p>
<p class="calibre1">text in a  <i class="calibre4">transcript</i>, in a protocol analyzer like Wireshark, or in a network </p>
<p class="calibre1">forensic tool like NM. </p>
<p class="calibre1">•  Sguil exposes features so analysts can count and classify events, thereby </p>
<p class="calibre1">enabling escalation and other incident response decisions. </p>
<p class="calibre1">The following sections explain how to use these features. </p>
<p class="calibre1"><b class="calibre3">Simple aggregation</b></p>
<p class="calibre1">A powerful but possibly underappreciated Sguil feature is its ability to aggre-</p>
<p class="calibre1">gate similar records into single lines of output in the console. Figure 8-2 </p>
<p class="calibre1">shows this feature in action. The CNT column is Sguil’s mechanism to dis-</p>
<p class="calibre1">play record counts. The top row, for example, shows how Sguil aggregated </p>
<p class="calibre1">four similar records into a single entry in the console. </p>
<p class="calibre1">This simple act of grouping similar records into single lines reduces the </p>
<p class="calibre1">analyst’s workload. The review process can focus on unique records rather </p>
<p class="calibre1">than repetitive entries that differ only by timestamp. Because Sguil is a </p>
<p class="calibre1">live, or “real-time,” tool, it processes and aggregates entries as the console </p>
<p class="calibre1">receives them. Entries in the CNT column may increase as new but repeti-</p>
<p class="calibre1">tive events reach the sensor. </p>
<p class="calibre1"><b class="calibre3">Metadata and related Data</b></p>
<p class="calibre1">Sguil doesn’t expose a great deal of metadata, but it makes three important </p>
<p class="calibre1">types easily accessible. In Figure 8-2, you can see two forms of metadata in </p>
<p class="calibre1">the lower-left corner of the console. The entries labeled  <i class="calibre4">Src IP</i>,  <i class="calibre4">Src Name</i>, <i class="calibre4">Dst IP</i>, and  <i class="calibre4">Dst Name</i> represent the IP addresses and hostnames (if available via DNS) for the source and destination IP addresses of any highlighted </p>
<p class="calibre1">record. Under this IP and hostname information, Sguil displays WHOIS </p>
<p class="calibre1">data for either the source or destination IP address. Analysts can choose </p>
<p class="calibre1">which to display via a radio button. </p>
<p class="calibre1">Sguil shows one other form of metadata and one form of related data </p>
<p class="calibre1">in the lower-right corner of the console. When showing alert data gener-</p>
<p class="calibre1">ated by an IDS like Snort or Suricata (discussed in the next section), Sguil </p>
<p class="calibre1">displays the rule that triggered the generation of the alert data. Under the </p>
<p class="calibre1">rule, Sguil shows the packet that triggered the creation of the alert data. </p>
<p class="calibre1"><b class="calibre3">164</b>   Chapter 8</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p199"/>This metadata and related data give analysts more context about the </p>
<p class="calibre1">systems involved in network traffic. They can also choose to disable the dis-</p>
<p class="calibre1">play of this information. </p>
<p class="calibre1">Now let’s take a closer look at the alert data to understand what it </p>
<p class="calibre1">means in the context of the Sguil console. </p>
<p class="calibre1"><b class="calibre3">Querying alert Data in Sguil</b></p>
<p class="calibre1">When you start Sguil, alert data is the first form of NSM evidence you will see. </p>
<p class="calibre1">Sguil calls alerts  <i class="calibre4">event data</i>. The database supporting Sguil stores the alert data in an  <i class="calibre4">event table</i>, so you’ll see references to that term, rather than  <i class="calibre4">alert</i>. </p>
<p class="calibre1">Sguil incorporates four forms of alert data: </p>
<p class="calibre1">•  Network IDS engines like Snort and Suricata generate alert data when </p>
<p class="calibre1">traffic they observe triggers one of their rules. These rules are indica-</p>
<p class="calibre1">tors of compromises that may require human analysis to determine if </p>
<p class="calibre1">they represent benign, suspicious, or malicious activity. Alert data from </p>
<p class="calibre1">the Snort or Suricata IDSs bear entries in the Event Messages column </p>
<p class="calibre1">that begin with text like  <i class="calibre4">ET</i> (for  <i class="calibre4">Emerging Threats</i>, an IDS rule source) or  <i class="calibre4">GPL</i> (another rule source). </p>
<p class="calibre1">•  Host-based IDS engines like OSSEC ( <i class="calibre4">http://www.ossec.net/</i>), if enabled, </p>
<p class="calibre1">provide similar warnings based on analyzing information about indi-</p>
<p class="calibre1">vidual computers. Using OSSEC requires installing an OSSEC software </p>
<p class="calibre1">agent on servers. By default, SO runs OSSEC on its own operating sys-</p>
<p class="calibre1">tem. Alerts from OSSEC have event messages beginning with  <i class="calibre4">[OSSEC]</i>. </p>
<p class="calibre1">(For more information on OSSEC, see the online manual at  <i class="calibre4">http://</i></p>
<p class="calibre1"> <i class="calibre4">www.ossec.net/doc/</i>.)</p>
<p class="calibre1">•  Sguil also integrates data in the event table from some sources that are </p>
<p class="calibre1">not IDS engines. For example, Sguil collects network profiling data </p>
<p class="calibre1">created by the Passive Real-time Asset Detection System (PRADS) tool </p>
<p class="calibre1">( <i class="calibre4">https://github.com/gamelinux/prads/</i>). Alert data from PRADS begins </p>
<p class="calibre1">with  <i class="calibre4">PADS</i>. PADS is a reference to the Passive Asset Detection System, </p>
<p class="calibre1">the precursor to PRADS. </p>
<p class="calibre1">•  Sguil stores HTTP transaction data generated by Bro. This data records </p>
<p class="calibre1">Uniform Resource Locators (URLs) observed by Bro, such as  <i class="calibre4">www </i></p>
<p class="calibre1"> <i class="calibre4">.testmyids.com</i>. Sguil displays these messages by prepending them with </p>
<p class="calibre1">the label  <i class="calibre4">URL</i>. Because HTTP activity is so common on networks, URL </p>
<p class="calibre1">data is not displayed by default, unlike data from Snort/Suricata, </p>
<p class="calibre1">OSSEC, and PRADS. </p>
<p class="calibre1">Data from Snort/Suricata, OSSEC, and PRADS appear by default in </p>
<p class="calibre1">Figure 8-2, in the top half of the Sguil console. If you want to query for </p>
<p class="calibre1">HTTP URL data recorded by Bro, you must ask Sguil manually. As an </p>
<p class="calibre1">example, we’ll create a query for HTTP data. Sguil refers to this as an </p>
<p class="calibre1"> <i class="calibre4">event query</i>. </p>
<p class="calibre1">NSM Consoles   <b class="calibre3">165</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p200"/><img src="index-200_1.png" alt="Image 102" class="calibre2"/></p>
<p class="calibre1"><img src="index-200_2.png" alt="Image 103" class="calibre2"/></p>
<p class="calibre1">To run an event query, choose <b class="calibre3">Query</b>4<b class="calibre3">Query Event Table</b> from the </p>
<p class="calibre1">Sguil menu. In the Query Builder window, modify the default text as shown </p>
<p class="calibre1">in Listing 8-2. Note the use of single quote characters (to the left of the </p>
<p class="calibre1">enter key on the US keyboard). </p>
<p class="calibre1">WHERE event.timestamp &gt; '2014-02-10 11:13:00' AND event.timestamp &lt; '2013-02-</p>
<p class="calibre1">10 11:16:00' AND event.signature LIKE 'URL%' </p>
<p class="calibre1"> <i class="calibre4">Listing 8-2: Running an event query for signatures beginning with URL%</i></p>
<p class="calibre1">Figure 8-3 shows this query in the Sguil console. </p>
<p class="calibre1"> <i class="calibre4">Figure 8-3: Sguil event query for 'URL%' </i></p>
<p class="calibre1">This query looks for events in the Sguil database with timestamps </p>
<p class="calibre1">between 11:13:00 and 11:16:00 UTC on February 10, 2013, where the signa-</p>
<p class="calibre1">ture or message begins with the string URL. Figure 8-4 shows the results of </p>
<p class="calibre1">this query on our demo system. </p>
<p class="calibre1"> <i class="calibre4">Figure 8-4: Querying Sguil for URL events</i></p>
<p class="calibre1"><b class="calibre3">166</b>   Chapter 8</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p201"/>These URL events are drawn from the Bro application’s  <i class="calibre4">http.log</i> file, which contains a summary of observed HTTP traffic. A Sguil agent read </p>
<p class="calibre1"> <i class="calibre4">http.log</i> and inserted the results into the MySQL database. </p>
<p class="calibre1">Notice that certain details—such as the timestamp, source and destina-</p>
<p class="calibre1">tion IP addresses and ports, and URL—are available as individual rows. </p>
<p class="calibre1">Highlight any row and check the <b class="calibre3">Display Detail</b> box to see the rest of the </p>
<p class="calibre1">information associated with this event. The text after the UID: element of </p>
<p class="calibre1">the detailed display is a unique identifier created by Bro for this session. </p>
<p class="calibre1">You could use this UID to query Bro logs later. </p>
<p class="calibre1"><b class="calibre3">Querying Session Data in Sguil</b></p>
<p class="calibre1">The ability to query for NSM session data is another one of Sguil’s key func-</p>
<p class="calibre1">tions. Sguil refers to session data as  <i class="calibre4">SANCP data</i>. SANCP stands for Security </p>
<p class="calibre1">Analyst Network Connection Profiler, which is a tool written by John Curry </p>
<p class="calibre1">packaged with earlier versions of Sguil to generate session data. In SO, </p>
<p class="calibre1">Doug Burks replaced SANCP with PRADS in late 2012. </p>
<p class="calibre1">In addition to generating session data, PRADS performs network device </p>
<p class="calibre1">profiling and tracks the systems it sees. Despite the new code, Sguil’s data-</p>
<p class="calibre1">base maintains a  <i class="calibre4">sancp table</i> for storing session data. This form of NSM data </p>
<p class="calibre1">keeps thorough records of every conversation seen by the sensor. </p>
<p class="calibre1">Unlike alert data, session data is always written to disk, regardless of </p>
<p class="calibre1">whether any system considers it normal or troublesome. The same neutral </p>
<p class="calibre1">approach also applies to full content data, extracted content data, transac-</p>
<p class="calibre1">tion data, statistical data, and metadata. </p>
<p class="calibre1"><b class="calibre3">N o T e </b> <i class="calibre4"> </i></p>
<p class="calibre1"> <i class="calibre4">Collecting and generating data beyond IDS alerts is a key aspect of network security</i> <i class="calibre4">monitoring. The availability of other forms of data, stored regardless of any relationship to an IDS alert, is a core differentiator between NSM-centric operations and</i> <i class="calibre4">alert-centric operations. With NSM, the alert is only the beginning of the analysis</i> <i class="calibre4">process, not the end. If your network monitoring model relies on IDS alerts, or IDS </i></p>
<p class="calibre1"> <i class="calibre4">alerts triggering packet capture, you’re not conducting NSM. Why not convert today? </i></p>
<p class="calibre1">Session data isn’t displayed by default in the Sguil console. Analysts can </p>
<p class="calibre1">query for session data using a process similar to running an event query, as </p>
<p class="calibre1">described in the previous section. The difference involves querying the sancp </p>
<p class="calibre1">table instead of the event table. More common, however, is the process of </p>
<p class="calibre1"> <i class="calibre4">pivoting</i> from alert data to session data. With pivoting, you start with one form of data, identify an item of interest, and use that item as the jumping-off </p>
<p class="calibre1">point for a new query. </p>
<p class="calibre1">To demonstrate how to query for session data using a pivot methodology, </p>
<p class="calibre1">we’ll begin with the results of the URL-based alert data query. Suppose that </p>
<p class="calibre1">we want to know more about activity involving the destination IP address </p>
<p class="calibre1">for one of the URL records. Rather than run a new search from the Query </p>
<p class="calibre1">menu, we’ll pivot on the highlighted message. Right-click the destination IP </p>
<p class="calibre1">address of the highlighted event, and then select <b class="calibre3">Advanced Query</b>4<b class="calibre3">Query </b></p>
<p class="calibre1"><b class="calibre3">Sancp Table</b>4<b class="calibre3">Query DstIP/1 Hour</b>, as shown in Figure 8-5. </p>
<p class="calibre1">NSM Consoles   <b class="calibre3">167</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p202"/><img src="index-202_1.png" alt="Image 104" class="calibre2"/></p>
<p class="calibre1"><img src="index-202_2.png" alt="Image 105" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 8-5: Pivoting from a message to SANCP data</i></p>
<p class="calibre1">Sguil displays the Query Builder window with prepopulated syntax that </p>
<p class="calibre1">looks for session records 30 minutes prior and 30 minutes following the </p>
<p class="calibre1">highlighted record, as shown in Figure 8-6. The timestamp on the high-</p>
<p class="calibre1">lighted event is 11:14:57, so the query starts at 10:44:57 and ends at 11:44:57 </p>
<p class="calibre1">on February 10, 2013. </p>
<p class="calibre1"> <i class="calibre4">Figure 8-6: Query for SANCP records in the Query Builder window</i></p>
<p class="calibre1">As you can see in Figure 8-7, this query returns only one session data </p>
<p class="calibre1">record. The PRADS application created this session record. A Sguil software </p>
<p class="calibre1">agent running on the sensor read the PRADS output and loaded the session </p>
<p class="calibre1">record into the MySQL database on the SO server. This is an example of </p>
<p class="calibre1">how an NSM console like Sguil integrates data from multiple systems and </p>
<p class="calibre1">platforms. </p>
<p class="calibre1"><b class="calibre3">168</b>   Chapter 8</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p203"/><img src="index-203_1.png" alt="Image 106" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 8-7: Session data displayed in Sguil</i></p>
<p class="calibre1">Select the <b class="calibre3">Display Sancp Details</b> option to see a summary of the TCP </p>
<p class="calibre1">flags counted during this session. The TCP protocol uses flags like SYN, </p>
<p class="calibre1">ACK, FIN, ACK, RST, URG, and PSH to coordinate the transfer of data during a ses-</p>
<p class="calibre1">sion. PRADS keeps track of the total set of flags seen when two computers </p>
<p class="calibre1">exchange data using TCP. Sguil can display those flags in the console to </p>
<p class="calibre1">help analysts recognize patterns of communication. For example, the pat-</p>
<p class="calibre1">tern ACK PSH SYN FIN shown in Figure 8-7 reflects all of the flags that would </p>
<p class="calibre1">be used at some point during a normal TCP session. </p>
<p class="calibre1">The information in this record is similar to what we saw generated </p>
<p class="calibre1">by Argus in Chapter 6, including timestamps, source and destination IP </p>
<p class="calibre1">addresses and ports, protocol (6 here for TCP), and source and destination </p>
<p class="calibre1">packet and byte counts. These elements are the core features of session </p>
<p class="calibre1">data: who talked to whom, when, and how much data they exchanged. </p>
<p class="calibre1"><b class="calibre3">N o T e </b> <i class="calibre4"> </i></p>
<p class="calibre1"> <i class="calibre4">Just before this book went to press, the PRADS developers changed their code and </i></p>
<p class="calibre1"> <i class="calibre4">the way they count bytes of data sent by source and destination computers in session</i> <i class="calibre4">records. PRADS, along with Bro and NM, count bytes in the IP header, the TCP or </i></p>
<p class="calibre1"> <i class="calibre4">UDP header, and any application data when reporting bytes of data sent or received</i> <i class="calibre4">in a session. In contrast, Argus and Wireshark count bytes in the Ethernet header, the</i> <i class="calibre4">IP header, the TCP or UDP header, and any application data bytes. The decision to</i> <i class="calibre4">exclude bytes from the Ethernet header means PRADS, Bro, and NM will report fewer</i> <i class="calibre4">bytes compared to Argus and Wireshark results. These choices are arbitrary and harm-less, but important to understand when comparing data from these different tools. </i></p>
<p class="calibre1"><b class="calibre3">Pivoting to Full Content Data</b></p>
<p class="calibre1">Just as we pivoted from an event to session data, Sguil allows us to pivot from </p>
<p class="calibre1">alert or session data to full content data. To see how this works, click the </p>
<p class="calibre1"><b class="calibre3">RealTime Events</b> tab and highlight an interesting alert. This example uses </p>
<p class="calibre1">an alert about an outdated version of Java. An IDS like Snort or Suricata </p>
<p class="calibre1">generated an ET POLICY Vulnerable Java Version alert when the detection </p>
<p class="calibre1">engine noticed traffic from a computer running an old version of Java. </p>
<p class="calibre1">The IDS wrote the alert to disk, and then a Sguil agent read the data and </p>
<p class="calibre1">inserted it into the MySQL database. Using Sguil, we can learn more about </p>
<p class="calibre1">this event by right-clicking the <b class="calibre3">Alert ID</b> field and selecting <b class="calibre3">Transcript</b>, as shown in Figure 8-8. </p>
<p class="calibre1">NSM Consoles   <b class="calibre3">169</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p204"/><img src="index-204_1.png" alt="Image 107" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 8-8: Pivoting from alert data to a transcript</i></p>
<p class="calibre1">Sguil generates a new window called a  <i class="calibre4">transcript</i>, as shown in Figure 8-9 </p>
<p class="calibre1">(similar to the window that appears after rebuilding a TCP session in </p>
<p class="calibre1">Wireshark). We see a computer with IP address 192.168.2.108 connecting </p>
<p class="calibre1">to a server in the  <i class="calibre4">oracle.com</i> domain. This is HTTP traffic, as demonstrated </p>
<p class="calibre1">by the GET request and the HTTP/1.1 reply. The ET POLICY rule for Vulnerable </p>
<p class="calibre1">Java Version noticed that 192.168.2.108 is running an outdated version of </p>
<p class="calibre1">Java, as reported by the User-Agent field and the UA-Java-Version (1.7.0_13). </p>
<p class="calibre1">This data is important for several reasons:</p>
<p class="calibre1">•  It’s a reconstruction of the full content data saved by Netsniff-ng. This </p>
<p class="calibre1">data was  <i class="calibre4">not</i> collected because the IDS detected suspicious or malicious </p>
<p class="calibre1">activity and decided to trigger the capture of full content data. Rather, </p>
<p class="calibre1">we simply used the ET POLICY rule for Vulnerable Java Version alert as a </p>
<p class="calibre1">reason to pivot from alert data to full content data. </p>
<p class="calibre1">•  It shows all of the content for this session—exactly what the source sent </p>
<p class="calibre1">and how the destination replied. This data can be critical when trying </p>
<p class="calibre1">to understand what is happening during an intrusion. </p>
<p class="calibre1">•  Although this data appeared in a Sguil Tcl/Tk window, it could just as </p>
<p class="calibre1">easily have automatically gone to Wireshark, as shown in Figure 8-10, or </p>
<p class="calibre1">NM. In fact, you can open Wireshark by right-clicking the Alert ID field </p>
<p class="calibre1">and selecting either option. </p>
<p class="calibre1"><b class="calibre3">170</b>   Chapter 8</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p205"/><img src="index-205_1.png" alt="Image 108" class="calibre2"/></p>
<p class="calibre1"><img src="index-205_2.jpg" alt="Image 109" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 8-9: Sguil transcript</i></p>
<p class="calibre1"> <i class="calibre4">Figure 8-10: Pivoting to Wireshark from Sguil alert data</i></p>
<p class="calibre1">NSM Consoles   <b class="calibre3">171</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p206"/><img src="index-206_1.png" alt="Image 110" class="calibre2"/></p>
<p class="calibre1"><b class="calibre3">N o T e </b> <i class="calibre4"> </i></p>
<p class="calibre1"> <i class="calibre4">Every time Sguil retrieves full content data from the sensor, it saves a copy in the </i>/nsm/</p>
<p class="calibre1">server_data/&lt;servername&gt;/archive <i class="calibre4"> directory. The Sguil client also saves a copy for</i> <i class="calibre4">local use. For example, the pcap file required to build a transcript might be archived</i> <i class="calibre4">on the SO server at </i>/nsm/server_data/securityonion/archive/2013-02-24/</p>
<p class="calibre1">sademo-eth1/192.168.2.117:49207_184.51.126.91:80-6.raw <i class="calibre4">. The format of the </i></p>
<p class="calibre1"> <i class="calibre4">filename is </i> SourceIP:SourcePort_DestinationIP:DestinationPort-Protocol.raw <i class="calibre4">. </i></p>
<p class="calibre1">Sguil’s full content capabilities are powerful for several reasons. First, </p>
<p class="calibre1">they’re easy to use. Analysts who are more familiar with manual retrieval of </p>
<p class="calibre1">network traffic via the command line are usually thrilled to interact with </p>
<p class="calibre1">Sguil on a right-click basis. Also, Sguil, through its Netsniff-ng component, </p>
<p class="calibre1">is  <i class="calibre4">always</i> capturing full content data to disk. Whether or not there’s an alert, Sguil will have the data. The only limitation is the amount of hard drive </p>
<p class="calibre1">space reserved for capture. Wait too long, and the hard drive housekeeping </p>
<p class="calibre1">scripts running on SO will erase older captures to make room for new cap-</p>
<p class="calibre1">tures. This is why Sguil’s ability to keep archived copies of requested tran-</p>
<p class="calibre1">scripts on the server and client is so helpful: SO may delete the original full </p>
<p class="calibre1">content data to make room for new files. As long as an analyst requested a </p>
<p class="calibre1">transcript, the associated full content evidence is preserved in two locations. </p>
<p class="calibre1"><b class="calibre3">Categorizing alert Data</b></p>
<p class="calibre1">Sguil was designed as a real-time console for analysts sitting in a CIRT or </p>
<p class="calibre1">a security operations center (SOC). Sguil is not an “alert browser” for pag-</p>
<p class="calibre1">ing through security information. Analysts should not treat Sguil like a log </p>
<p class="calibre1">management platform that passively stores records. Instead, analysts should </p>
<p class="calibre1">monitor the Sguil console and investigate alerts as they appear. They must </p>
<p class="calibre1">decide whether an event is benign, suspicious, or malicious. After making this </p>
<p class="calibre1">decision, the analyst can assign a label to the event conveying that informa-</p>
<p class="calibre1">tion. This process of classification changes the status of the event from  <i class="calibre4">RT</i> </p>
<p class="calibre1">(for  <i class="calibre4">Real Time</i>) to another code chosen by the user. </p>
<p class="calibre1">To support this workflow, </p>
<p class="calibre1">Sguil allows you to categorize </p>
<p class="calibre1">alert data. Select <b class="calibre3">File</b>4<b class="calibre3">Display </b></p>
<p class="calibre1"><b class="calibre3">Incident Categories</b> to see the </p>
<p class="calibre1">categories built into Sguil by </p>
<p class="calibre1">default, as shown in Figure 8-11. </p>
<p class="calibre1">Highlight any event in Sguil and </p>
<p class="calibre1">click the corresponding func-</p>
<p class="calibre1">tion key (F1 for Category I, F2 </p>
<p class="calibre1"> <i class="calibre4">Figure 8-11: Sguil incident categories</i></p>
<p class="calibre1">for Category II, and so on) to </p>
<p class="calibre1">classify an alert. For example, </p>
<p class="calibre1">if you find evidence of an intruder achieving root-level access to a system, </p>
<p class="calibre1">pressing F1 will classify the event as an Unauthorized Root/Admin Access </p>
<p class="calibre1">incident. Crucially,  <i class="calibre4">the alert will disappear from the real-time display</i>. The event is still preserved in the database, but from Sguil’s perspective, the event has </p>
<p class="calibre1">been “handled.” To classify an event as being of no consequence, press F8 </p>
<p class="calibre1">instead. </p>
<p class="calibre1"><b class="calibre3">172</b>   Chapter 8</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p207"/><img src="index-207_1.jpg" alt="Image 111" class="calibre2"/></p>
<p class="calibre1">Note that you can classify only alert data—not session data. Analysts </p>
<p class="calibre1">who use Sguil tend to assign their own meanings to the different function </p>
<p class="calibre1">keys, so devise a plan that suits your needs. </p>
<p class="calibre1">Sguil users don’t let alert data pile up in the console. Instead, they work </p>
<p class="calibre1">to clear the screen as efficiently as possible. </p>
<p class="calibre1">The case studies later in this book demonstrate how to apply this NSM </p>
<p class="calibre1">operational model to hunt for intrusions using NSM data. For now, it’s </p>
<p class="calibre1">enough to understand that Sguil provides CIRT members a way to perform </p>
<p class="calibre1">six key functions: viewing aggregated alerts, accessing some metadata and </p>
<p class="calibre1">related data, querying for alert data, querying for session data, pivoting to </p>
<p class="calibre1">full content data, and classifying alert data. </p>
<p class="calibre1"><b class="calibre3">using Squert</b></p>
<p class="calibre1">Squert ( <i class="calibre4">http://www.squertproject.org/</i>) is an open source web interface for </p>
<p class="calibre1">NSM data. Paul Halliday wrote Squert to provide access to the Sguil data-</p>
<p class="calibre1">bases using a web browser. </p>
<p class="calibre1"><b class="calibre3">N o T e </b> <i class="calibre4"> </i></p>
<p class="calibre1"> <i class="calibre4">Paul codes Squert under the GNU General Public License version 3 </i>(https://</p>
<p class="calibre1">github.com/int13h/squert/blob/master/COPYING/) <i class="calibre4">. </i></p>
<p class="calibre1">As you saw in the previous examples, the Sguil client focuses on pre-</p>
<p class="calibre1">senting key elements of different datatypes as records in rows. Squert adds </p>
<p class="calibre1">features like visualizations and supporting information to events in the </p>
<p class="calibre1">Sguil database. Figure 8-12 shows the Events tab of the Squert page with </p>
<p class="calibre1">the PING TEST alerts selected. </p>
<p class="calibre1"> <i class="calibre4">Figure 8-12: Events tab in Squert 1.0</i></p>
<p class="calibre1">NSM Consoles   <b class="calibre3">173</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p208"/><img src="index-208_1.png" alt="Image 112" class="calibre2"/></p>
<p class="calibre1">The Squert dashboard presents several data visualizations. For example, </p>
<p class="calibre1">the events grouped by minute and hour graph shows spikes and valleys in </p>
<p class="calibre1">counts of alerts created by the Snort or Suricata IDS engines, as shown in </p>
<p class="calibre1">Figure 8-13. </p>
<p class="calibre1"> <i class="calibre4">Figure 8-13: Squert visualization of IDS alerts over time</i></p>
<p class="calibre1">Future versions of Squert should allow analysts to pivot from alert data </p>
<p class="calibre1">to packet details and full content data. </p>
<p class="calibre1">The Squert project expands beyond the key datatypes captured and </p>
<p class="calibre1">integrated by Sguil and its components, but the Snorby project takes that </p>
<p class="calibre1">integration a step further. </p>
<p class="calibre1"><b class="calibre3">using Snorby</b></p>
<p class="calibre1">Snorby ( <i class="calibre4">http://www.snorby.org/</i>) is a newer open source web interface for </p>
<p class="calibre1">NSM data. </p>
<p class="calibre1"><b class="calibre3">N o T e </b> <i class="calibre4"> </i></p>
<p class="calibre1"> <i class="calibre4">Dustin Webber codes Snorby under a GNU General Public License version 3 </i></p>
<p class="calibre1">(https://github.com/Snorby/snorby/blob/master/LICENSE) <i class="calibre4">. </i></p>
<p class="calibre1">SO users can access Snorby by pointing a web browser to port 444 TCP </p>
<p class="calibre1">on the SO server. Log in using the email address and password selected </p>
<p class="calibre1">during the SO installation process to see a summary dashboard of data </p>
<p class="calibre1">from the Sguil database, as shown in Figure 8-14. As with Sguil, Snorby </p>
<p class="calibre1">users can classify events using function keys. </p>
<p class="calibre1">Most users find the Snorby interface to be intuitive. For example, click-</p>
<p class="calibre1">ing the High Severity portion of the dashboard takes you to the list of high-</p>
<p class="calibre1">severity alerts (as designated by the IDS engine). Clicking any record in the </p>
<p class="calibre1">list displays additional data for the event in question, as shown in Figure 8-15. </p>
<p class="calibre1">Snorby also supports creating transcripts, thanks to Paul Halliday’s </p>
<p class="calibre1">CapMe program ( <i class="calibre4">https://github.com/int13h/capme</i>). To use it, select <b class="calibre3">Packet </b></p>
<p class="calibre1"><b class="calibre3">Capture Options</b>, and then select <b class="calibre3">Custom</b>. The Packet Capture Builder </p>
<p class="calibre1">window will appear, as shown in Figure 8-16. </p>
<p class="calibre1"><b class="calibre3">174</b>   Chapter 8</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p209"/><img src="index-209_1.jpg" alt="Image 113" class="calibre2"/></p>
<p class="calibre1"><img src="index-209_2.jpg" alt="Image 114" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 8-14: The initial Snorby screen</i></p>
<p class="calibre1"> <i class="calibre4">Figure 8-15: Snorby alert detail</i></p>
<p class="calibre1">NSM Consoles   <b class="calibre3">175</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p210"/><img src="index-210_1.png" alt="Image 115" class="calibre2"/></p>
<p class="calibre1"><img src="index-210_2.jpg" alt="Image 116" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 8-16: Packet Capture Builder window in Snorby</i></p>
<p class="calibre1">Click <b class="calibre3">Fetch Packet</b> to open a new window titled  <i class="calibre4">capME! </i>, as shown in </p>
<p class="calibre1">Figure 8-17. This window is prepopulated with the fields necessary to retrieve </p>
<p class="calibre1">full content data associated with the particular event. All that remains is to </p>
<p class="calibre1">enter a username and password to authenticate to the SO sensor that stores </p>
<p class="calibre1">the full content data. </p>
<p class="calibre1"> <i class="calibre4">Figure 8-17: CapMe ready to build a transcript</i></p>
<p class="calibre1">When you’re ready, click <b class="calibre3">Submit</b>, and CapMe will retrieve full content </p>
<p class="calibre1">data from the appropriate sensor, return it to the server, and render it via </p>
<p class="calibre1">the web browser, as shown in Figure 8-18. </p>
<p class="calibre1"><b class="calibre3">176</b>   Chapter 8</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p211"/><img src="index-211_1.png" alt="Image 117" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 8-18: CapMe returns a transcript. </i></p>
<p class="calibre1">In this example, we see HTTP traffic, with HEAD and GET requests, fol-</p>
<p class="calibre1">lowed by an HTTP/1.1 status code. It looks as if 192.168.2.117 is retrieving an </p>
<p class="calibre1">update from Microsoft. </p>
<p class="calibre1">Snorby can also offer data to analysts in nontraditional ways, such as via </p>
<p class="calibre1">iPhone apps. For example, the Snorby iPhone app ( <i class="calibre4">https://itunes.apple.com/</i></p>
<p class="calibre1"> <i class="calibre4">us/app/snorby/id570584212?mt=8/</i>) offers an innovative way to review Snorby </p>
<p class="calibre1">alerts on the go, as shown in Figure 8-19. </p>
<p class="calibre1"><b class="calibre3">N o T e </b> <i class="calibre4"> </i></p>
<p class="calibre1"> <i class="calibre4">In 2013 Dustin Webber published a cloud-based version of Snorby called Threat </i></p>
<p class="calibre1"> <i class="calibre4">Stack </i>(https://www.threatstack.com/) <i class="calibre4">, mentioned in the conclusion. He plans to</i> <i class="calibre4">continue to support the open source version of Snorby, but the cloud edition contains</i> <i class="calibre4">many compelling features. </i></p>
<p class="calibre1">NSM Consoles   <b class="calibre3">177</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p212"/><img src="index-212_1.jpg" alt="Image 118" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 8-19: Snorby iPhone app displays suspicious scan alerts. </i></p>
<p class="calibre1"><b class="calibre3">using elSa</b></p>
<p class="calibre1">ELSA, the Enterprise Log Search and Archive ( <i class="calibre4">https://code.google.com/p/</i></p>
<p class="calibre1"> <i class="calibre4">enterprise-log-search-and-archive/</i>), provides a fully asynchronous web-based </p>
<p class="calibre1">query interface that normalizes logs and makes searching billions of them </p>
<p class="calibre1">for arbitrary strings as easy as searching the Web, as stated on the project’s </p>
<p class="calibre1">website. </p>
<p class="calibre1"><b class="calibre3">N o T e </b> <i class="calibre4"> </i></p>
<p class="calibre1"> <i class="calibre4">Martin Holste codes ELSA under a GNU General Public License version 2 </i></p>
<p class="calibre1"> <i class="calibre4">(</i> http://enterprise-log-search-and-archive.googlecode.com/svn/trunk/ </p>
<p class="calibre1">elsa/LICENSE/ <i class="calibre4">). </i></p>
<p class="calibre1">ELSA relies on Syslog-ng ( <i class="calibre4">http://www.balabit.com/network-security/syslog-ng/</i>) to collect remote log events, stores them in MySQL, and provides search </p>
<p class="calibre1">capabilities using the search server Sphinx ( <i class="calibre4">http://sphinxsearch.com/</i>). ELSA </p>
<p class="calibre1">is closely tied to the Bro tool, and many analysts use it to interpret Bro logs. </p>
<p class="calibre1">Because ELSA has been integrated into SO, using it is as easy as point-</p>
<p class="calibre1">ing a web browser to the address and port listening on the SO server, and </p>
<p class="calibre1">then authenticating using the username and password you set for the Sguil </p>
<p class="calibre1">database. ELSA should listen on port 3154 TCP by default and must be </p>
<p class="calibre1">accessed via HTTPS. After authentication, it offers the query window shown </p>
<p class="calibre1">in Figure 8-20. </p>
<p class="calibre1"><b class="calibre3">178</b>   Chapter 8</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p213"/><img src="index-213_1.png" alt="Image 119" class="calibre2"/></p>
<p class="calibre1"><img src="index-213_2.png" alt="Image 120" class="calibre2"/></p>
<p class="calibre1"><img src="index-213_3.png" alt="Image 121" class="calibre2"/></p>
</body></html>