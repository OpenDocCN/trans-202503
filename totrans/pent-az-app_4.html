<html><head></head><body>
<h2 class="h2b" id="ch05"><span epub:type="pagebreak" id="page_91" class="calibre1"/><strong class="calibre2"><span class="big">5</span></strong><br class="calibre9"/><strong class="calibre2">TARGETING VIRTUAL MACHINES</strong></h2>
<div class="image"><img src="../images/00015.jpeg" alt="image" class="calibre3"/></div>
<p class="noindent">Every penetration tester is likely to encounter numerous virtual machines (VMs) in Azure. As you’ll learn in this chapter, attackers can leverage Azure Storage as a vector to steal secrets from, and take control of, Azure virtual machines. With the right level of access to these systems, an attacker could take complete control over any service running on the VMs and surreptitiously collect data about the users who connect to them.</p>
<p class="indent">To demonstrate this, I begin with a look at how to obtain the <em class="calibre7">virtual hard disk (VHD)</em> images for virtual machines, without ever gaining Azure portal access. Once a copy of the VM’s VHD is obtained, I explain how to extract important data. Finally, I show you how to leverage the VM password reset option in the Azure portal.</p>
<h3 class="h1" id="lev115"><span epub:type="pagebreak" id="page_92" class="calibre1"/><strong class="calibre2">Best Practices: VM Security</strong></h3>
<p class="noindent">Virtual machines are one of the most common cloud workloads, because they allow businesses to quickly migrate on-premises servers into the cloud. Although VMs are a great way to take advantage of the benefits of the cloud with limited engineering effort, this approach can lead to security problems if companies don’t fully consider the new threats they might encounter as a result of such a move.</p>
<p class="indent">Most importantly, administrators of on-premises servers often take for granted the firewalls and other security appliances on the border of the corporate network. By default, cloud-hosted VMs are internet-facing, so every open port must be carefully considered, with only the minimum number of services exposed, as each is a potential target for attack. Use network security groups in addition to the VM’s host firewall to restrict access to all unneeded ports. Additionally, consider using virtual networks that aren’t exposed to the internet for those VMs that host services that need to be accessed only from other cloud resources.</p>
<p class="indent">If you do expose a management service to the internet, such as RDP or SSH, you can reduce the risk of successful password spray or brute-force password attacks by ensuring that user accounts on the system use unusual account names (avoid common privileged account names like <em class="calibre7">administrator</em>, <em class="calibre7">admin</em>, and <em class="calibre7">root</em>) and strong passwords or, if possible, certificate-based or multi-factor authentication. Encourage the use of a password manager so users don’t balk at remembering strange usernames and complex passwords.</p>
<p class="indent">Next, whenever possible, utilize full disk encryption on your VMs to protect any data that resides on them. This prevents offline VHD analysis, as described in “<a href="part0014.html#lev119" class="calibre6">Exploring the VHD with Autopsy</a>” on <a href="part0014.html#page_95" class="calibre6">page 95</a>. Azure Disk Encryption is a convenient way to encrypt VHDs. It utilizes Key Vault to store the encryption keys for the disk, so you don’t need to worry about managing the keys. It is a free service in Azure and is available for most VM pricing tiers.</p>
<p class="indent">Finally, make sure that all relevant events for the VM are being monitored. Enabling Azure’s VM logs and including them in your blue team’s security log analysis tools is a good start. However, even more events can be detected by using Azure Security Center (ASC) and Operations Management Suite (OMS). ASC monitors VMs for known threats, while OMS provides detailed logs for any system where its agent is installed. Both solutions are described in detail in <a href="part0017.html#ch08" class="calibre6">Chapter 8</a>.</p>
<h3 class="h1" id="lev116"><strong class="calibre2">Virtual Hard Disk Theft and Analysis</strong></h3>
<p class="noindent">Because one can obtain credentials for Azure Storage without full access to a subscription (as discussed in <a href="part0013.html#ch04" class="calibre6">Chapter 4</a>), an attacker may be able to control a running VM with just a storage account key. To do this, the attacker needs to obtain a VHD, retrieve passwords or certificates stored on the VHD, and then use those secrets to access the VM. Let’s start by looking at how a penetration tester can acquire a copy of a VM’s VHD.</p>
<h4 class="h2" id="lev117"><span epub:type="pagebreak" id="page_93" class="calibre1"/><strong class="calibre2"><em class="calibre10">Downloading a VHD Snapshot</em></strong></h4>
<p class="noindent">In order to download the disk image, you’ll need the key for the storage account that contains the desired VM’s VHD. This can be obtained directly from the Azure portal or through Azure PowerShell’s cmdlet <span class="literal">Get-AzureRmStorageAccountKey</span> if you have subscription access. Alternatively, you can use any of the storage key recovery methods described in <a href="part0013.html#ch04" class="calibre6">Chapter 4</a> if you don’t have subscription access. Once you’ve procured storage credentials, launch either Microsoft Azure Storage Explorer or ClumsyLeaf CloudXplorer. These are the only two tools that can create snapshots of files in Azure Storage. I’ll show how to use Microsoft Azure Storage Explorer because it is the free option.</p>
<div class="note">
<p class="notet"><strong class="calibre2"><span class="notes">NOTE</span></strong></p>
<p class="notep"><em class="calibre7">If you attempt to download a file from Azure while it’s in use, such as a VHD being used by a running VM, the download will be interrupted and the file will be corrupt or incomplete. The snapshot API creates a consistent (meaning non-corrupt) point-in-time duplicate of a file that you can copy. Because you can’t tell if a VHD is in use, you should always assume that it is and make a snapshot.</em></p>
</div>
<p class="indent">Follow these steps to download a snapshot in Microsoft Azure Storage Explorer:</p>
<ol class="calibre16">
<li class="noindent1" value="1"><p class="list">Click the VHD file you want to copy and then click the <strong class="calibre4">Make Snapshot</strong> button in the ribbon menu, as shown in <a href="part0014.html#ch05fig1" class="calibre6">Figure 5-1</a>.</p>
<div class="image1"><a id="ch05fig1" class="calibre6"/><img src="../images/00035.jpeg" alt="image" class="calibre3"/></div>
<p class="figcap"><em class="calibre7">Figure 5-1: Creating a snapshot for a VHD in Microsoft Azure Storage Explorer</em></p></li>
<li class="noindent1" value="2">Click the <strong class="calibre4">Manage Snapshot</strong> button. You should see all of the selected file’s snapshots in the file list. Their names should start with the name of the VHD, followed by a date and time in parentheses.</li>
<li class="noindent1" value="3">To save the snapshot to your PC, select the snapshot and click <strong class="calibre4">Download</strong> in the ribbon.</li>
</ol>
<p class="indent">Be sure to delete the snapshot from the storage account once you’ve downloaded the VHD snapshot. Not only might a user notice the duplicate file, but the duplicate also takes up additional space in the storage account, which will lead to additional charges on the subscription’s monthly invoice. <span epub:type="pagebreak" id="page_94"/>Although having the snapshot around for an hour or two while copying the VHD will likely go unnoticed, a full month’s worth of charges for potentially hundreds of gigabytes of blob storage will stand out to a good accountant.</p>
<div class="sidebar">
<p class="sidebart"><strong class="calibre4">DEFENDER’S TIP</strong></p>
<p class="spara">Azure Storage Analytics logging will record Azure Storage activity for blobs, queues, and tables. This includes successful and failed authentication attempts, uploads, downloads, deletions, and snapshot operations. Be sure to enable it and review this data for unusual activity. For more information see <em class="calibre10"><a href="https://docs.microsoft.com/en-us/rest/api/storageservices/enabling-storage-logging-and-accessing-log-data/" class="calibre11">https://docs.microsoft.com/en-us/rest/api/storageservices/enabling-storage-logging-and-accessing-log-data/</a></em>.</p>
<p class="spara1">Also, billing data can be a surprisingly helpful tool to alert you if someone is exploiting your subscription. If you expect a subscription’s usage to be constant from month to month, a sudden change in cost warrants an investigation. The cause might be something innocuous, like a change in Azure’s rates, but it also might be someone running additional services in your subscription for nefarious purposes!</p>
</div>
<p class="indent">To delete snapshots in Microsoft Azure Storage Explorer, click the snapshot in the list of files to highlight it and then click the <strong class="calibre4">Delete</strong> button on the ribbon. If you don’t see any snapshots listed, click <strong class="calibre4">Manage Snapshot</strong> in the ribbon menu first.</p>
<h4 class="h2" id="lev118"><strong class="calibre2"><em class="calibre10">Retrieving a VHD’s Secrets</em></strong></h4>
<p class="noindent">Once you have a copy of the VHD on your computer, you can review it for useful information. The files to look for will depend on the guest’s operating system, but the goal is the same: identify information that is either valuable as a penetration test finding in its own right (for example, not-yet-released financials) or information that furthers your access to target systems (for example, passwords).</p>
<p class="indent">Finding a password for the same VM that uses the stolen VHD is quite desirable. Although having that credential might seem moot with the VHD in hand, once you’ve found a password, you can perform many useful actions against a running VM that would not work against a static VHD copy. For example, with access to a VM, you could run Mimikatz to look for credentials you haven’t yet obtained. You could also modify a running service on the VM to covertly forward information to you as it arrives. You could even use it to send phishing emails, because users are typically more trusting of links to a server that they already know. The possibilities are limited only by your imagination.</p>
<p class="indent"><span epub:type="pagebreak" id="page_95"/>Reviewing the contents of VHD files can become a lengthy exercise in computer forensics, depending on the number of VHDs you obtain. Because you likely won’t have time to dig through every file in every disk image, let’s focus on a few key areas that are usually the most fruitful.</p>
<h3 class="h1" id="lev119"><strong class="calibre2">Exploring the VHD with Autopsy</strong></h3>
<p class="noindent">Before you can review the contents of a VHD, you have to find a way to open it. If you are using Windows 10 and your target VM is also running a version of Windows, you should be able to right-click the VHD and select <strong class="calibre4">Mount</strong> to mount the VHD as a new virtual disk in Windows Explorer. If you’re running Linux and you have a VHD library installed, you should be able to use the <span class="codestrong">mount</span> command to attach the VHD. However, I prefer to explore the VHD using disk forensic tools like Autopsy. Using a disk forensic program has several advantages over native mount options:</p>
<p class="hang"><strong class="calibre4">Broad disk format support</strong> Whereas Windows can only mount disk images in NTFS and FAT formats, forensic tools can open dozens of formats—even when running on Windows. And on Linux, forensic tools often do a better job reading from unusual formats than Linux itself does.</p>
<p class="hang"><strong class="calibre4">Better protection from malware</strong> When mounting an untrusted file system directly into your system, you run the risk that any malware on the VHD could end up infecting your host. By using the forensic tool to extract only a few specific files of interest, you greatly reduce that risk.</p>
<p class="hang"><strong class="calibre4">Protection for the integrity of the VHD</strong> Forensic tools are designed to mount disk images in read-only mode, which prevents you from accidentally modifying or deleting files in the VHD. This not only prevents mistakes, but can also help quell skepticism when you present your findings.</p>
<p class="hang"><strong class="calibre4">Ability to recover deleted files</strong> Forensic tools specialize in re-creating files in disk images that users have deleted but that haven’t yet been overwritten by new data. You might come across some very interesting files that wouldn’t appear with a native mount command.</p>
<p class="indentt">My go-to forensic tool is the free, open source Autopsy (<em class="calibre7"><a href="http://www.sleuthkit.org/" class="calibre6">http://www.sleuthkit.org/</a></em>). You can run it on Windows, Linux, and macOS. Although it lacks some of the advanced features and polish of commercial forensic programs, it’s more than sufficient for penetration testing, and it avoids the high cost associated with niche commercial tools.</p>
<h4 class="h2" id="lev120"><strong class="calibre2"><em class="calibre10">Importing the VHD</em></strong></h4>
<p class="noindent">Regardless of your computer’s operating system or that of the VHD, the instructions for using Autopsy to import the VHD for examination are as follows:</p>
<ol class="calibre16">
<li class="noindent1" value="1">Start Autopsy and choose <strong class="calibre4">Create New Case</strong> on the Welcome screen.</li>
<li class="noindent1" value="2">Give the case a name (use the name of the VM) and select a directory for Autopsy to save its working files. Click <strong class="calibre4">Next</strong>.</li>
<li class="noindent1" value="3"><span epub:type="pagebreak" id="page_96"/>Leave the Case Number and Examiner fields blank and then click <strong class="calibre4">Finish</strong> to open the Add Data Source Wizard.</li>
<li class="noindent1" value="4">On the Add Data Source window, browse to the downloaded VHD, select it, and click <strong class="calibre4">Next</strong>.</li>
<li class="noindent1" value="5">The Configure Ingest Modules screen, depicted in <a href="part0014.html#ch05fig2" class="calibre6">Figure 5-2</a>, allows you to select what post-processing Autopsy will perform on the VHD, such as creating a search index and thumbnails of all pictures. Make your choices and then click <strong class="calibre4">Next</strong>, followed by <strong class="calibre4">Finish</strong> on the next screen.</li>
</ol>
<div class="image1"><a id="ch05fig2" class="calibre6"/><img src="../images/00036.jpeg" alt="image" class="calibre3"/></div>
<p class="figcap"><em class="calibre7">Figure 5-2: Selecting ingestion options in Autopsy</em></p>
<div class="note">
<p class="notet"><strong class="calibre2"><span class="notes">NOTE</span></strong></p>
<p class="notep">Ingestion <em class="calibre7">is the process used by forensics software to automatically scan through the contents of the disk being examined and call out items of interest for the examiner. Autopsy provides a number of preconfigured ingestion options, such as email and credit card number identification and photo retrieval. It also supports custom filters so examiners can add their own.</em></p>
</div>
<p class="indent">At this point, you should be at the main Autopsy interface, as shown in <a href="part0014.html#ch05fig3" class="calibre6">Figure 5-3</a>. Double-click the VHD file in the Directory Listing area and you’ll see a list of partitions within the VHD, including unallocated partitions that represent unused space in the virtual disk.</p>
<div class="image1"><span epub:type="pagebreak" id="page_97"/><a id="ch05fig3" class="calibre6"/><img src="../images/00037.jpeg" alt="image" class="calibre3"/></div>
<p class="figcap"><em class="calibre7">Figure 5-3: Navigating the disk image using Autopsy</em></p>
<p class="indent">If Autopsy fails to load the VHD, either the VHD is corrupt and should be downloaded again, or the VM owner has enabled Azure Disk Encryption, in which case there’s nothing else you can do here. To check if encryption is enabled, try mounting the VHD on a Windows system using PowerShell:</p>
<p class="programs">PS C:\&gt; <span class="codestrong1">Mount-DiskImage</span> <span class="codestrong1">-ImagePath</span> <span class="codestrongitalic">C:\temp\file.</span><span class="codestrong1">vhdx -StorageType VHDX</span><br class="calibre5"/>    <span class="codestrong1">-Access ReadOnly</span></p>
<p class="indent">If the image is corrupt, PowerShell will display the error <span class="literal">The file or directory is corrupted and unreadable</span>. If it is encrypted, a new Windows Explorer window will open attempting to display the VHD’s contents, but will report that the drive is not accessible.</p>
<div class="sidebar">
<p class="sidebart"><strong class="calibre4">DEFENDER’S TIP</strong></p>
<p class="spara">Azure Disk Encryption allows you to encrypt the contents of your VHDs in Azure Storage. It leverages BitLocker for Windows VMs and DM-Crypt for Linux VMs in order to fully encrypt the virtual disk, so if the VHD is removed from Azure, you won’t be able to read its contents. The encryption keys for the VHD are stored in Azure Key Vault. Note that to use Azure Disk Encryption, you must be using Standard or Premium tier VMs and the VMs must be ARM-based. You can learn more about Azure Disk Encryption at <em class="calibre10"><a href="https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption/" class="calibre11">https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption/</a></em>.</p>
</div>
<p class="indent">When the VHD loads, double-click the first partition not labeled <em class="calibre7">unallocated</em>. You should see a list of the files on the VHD, as shown in <a href="part0014.html#ch05fig4" class="calibre6">Figure 5-4</a>.</p>
<div class="image1"><span epub:type="pagebreak" id="page_98"/><a id="ch05fig4" class="calibre6"/><img src="../images/00038.jpeg" alt="image" class="calibre3"/></div>
<p class="figcap"><em class="calibre7">Figure 5-4: Examining a VHD in Autopsy</em></p>
<p class="indent">From within this interface, browse through the file system in search of interesting files. You can use the built-in hex viewer in the lower portion of the screen to preview files. To take a deeper look, select the file, right-click it, and then select <strong class="calibre4">Extract File(s)</strong> to save the file to your host system.</p>
<p class="indent">Now let’s look at some of the most interesting files to seek out on Windows and Linux VHDs.</p>
<h4 class="h2" id="lev121"><strong class="calibre2"><em class="calibre10">Analyzing Windows VHDs</em></strong></h4>
<p class="noindent">When I’m analyzing a VM’s disk, my first priority is to collect credentials. When analyzing a Windows VHD, I start with the <em class="calibre7">Security Account Manager (SAM)</em> database at <em class="calibre7">\Windows\System32\config\SAM</em>. The SAM stores password hashes for all local, non-domain users on a system, such as the local administrator account. Windows uses an encryption key, called a <em class="calibre7">Syskey</em>, to protect the SAM. You can find this key in <em class="calibre7">\Windows\System32\config\SYSTEM</em>.</p>
<p class="indent">Here’s how to decrypt the SAM file and obtain the hashes:</p>
<ol class="calibre16">
<li class="noindent1" value="1">Extract the SYSTEM and SAM registry hive files from the VHD to your computer using Autopsy.</li>
<li class="noindent1" value="2">Launch Cain &amp; Abel (available from <em class="calibre7"><a href="http://www.oxid.it/cain.html" class="calibre6">http://www.oxid.it/cain.html</a></em>).</li>
<li class="noindent1" value="3">Click the <strong class="calibre4">Cracker</strong> tab.</li>
<li class="noindent1" value="4">Click <strong class="calibre4">File</strong> <span class="ent">▸</span> <strong class="calibre4">Add to list</strong>.</li>
<li class="noindent1" value="5">Select the <strong class="calibre4">Import Hashes from a SAM database</strong> option.</li>
<li class="noindent1" value="6"><span epub:type="pagebreak" id="page_99"/>Click the browse button (<strong class="calibre4">...</strong>) next to SAM Filename and select the extracted SAM file.</li>
<li class="noindent1" value="7">Click the browse button next to Boot Key and select the extracted SAM file.</li>
<li class="noindent1" value="8">On the Syskey Decoder box that opens, click the browse button and select the SYSTEM file you extracted.</li>
<li class="noindent1" value="9">Highlight and copy the displayed boot key.</li>
<li class="noindent1" value="10">Close the Syskey Decoder box and then paste the key into the Boot Key field.</li>
<li class="noindent1" value="11">Click <strong class="calibre4">Next</strong>.</li>
</ol>
<p class="indent">You should see the hashes for every account on the system, as shown in <a href="part0014.html#ch05fig5" class="calibre6">Figure 5-5</a>. (We’ll look at what to do with these hashes in “<a href="part0014.html#lev129" class="calibre6">Password Hash Attack Tools</a>” on <a href="part0014.html#page_103" class="calibre6">page 103</a>, including how Cain &amp; Abel can use them to obtain cleartext passwords.)</p>
<div class="image1"><a id="ch05fig5" class="calibre6"/><img src="../images/00039.jpeg" alt="image" class="calibre3"/></div>
<p class="figcap"><em class="calibre7">Figure 5-5: Hashes in Cain &amp; Abel</em></p>
<p class="indent">Aside from passwords, when examining a VHD I’m also interested in source code, configuration files, and documents. What you’ll find depends on how the VM is being used and what software is installed on it. Check these locations, if present, for a good chance of finding valuable content:</p>
<ul class="calibre8">
<li class="noindent1">The <em class="calibre7">\InetPub</em> directory for website source code and configuration files (usually <em class="calibre7">web.config</em>). These may contain passwords and other secrets.</li>
<li class="noindent1">Each user’s home directory within <em class="calibre7">\Users</em>—especially their <em class="calibre7">Documents</em> folder for specifications and deployment documents about the target environment; <em class="calibre7">Desktop</em> folder for documents, keys, and notes; <em class="calibre7">Downloads</em> folder for hints about what tools may be used on the VM; and <em class="calibre7">AppData\Roaming</em> folder for Internet Explorer, Firefox, and Chrome subdirectories that contain web history, cookies, and saved passwords.</li>
<li class="noindent1">Directories that SQL uses.</li>
<li class="noindent1">Any directories that Azure management tools use.</li>
<li class="noindent1"><span epub:type="pagebreak" id="page_100"/>Temp directories for output of scheduled tasks, test scripts, and other random gems.</li>
<li class="noindent1">Directories containing backups.</li>
</ul>
<p class="indent">Also, perform a full-VHD search for file extensions like <em class="calibre7">*.pfx</em> for certificate private keys; <em class="calibre7">*.doc</em>, <em class="calibre7">*.docx</em>, <em class="calibre7">*.xls</em>, <em class="calibre7">*.xlsx</em>, <em class="calibre7">*.ppt</em>, and <em class="calibre7">*.pptx</em> for Microsoft Office files; <em class="calibre7">*.bak</em> for backups; and <em class="calibre7">*.txt</em> for notes, which will sometimes contain passwords. You might also want to search for files that password managers use, like <em class="calibre7">*.kdx</em> and <em class="calibre7">*.kdbx</em> for KeePass, <em class="calibre7">*.psafe3</em> for Password Safe, and <em class="calibre7">*.dash</em> or <em class="calibre7">*.dashlane</em> for Dashlane. Finally, find copies of any scripts not included with the operating system, like <em class="calibre7">*.bat</em>, <em class="calibre7">*.cmd</em>, and <em class="calibre7">*.ps1</em> from any directory besides <em class="calibre7">\Windows</em>, and see what they are used for.</p>
<h4 class="h2" id="lev122"><strong class="calibre2"><em class="calibre10">Analyzing Linux VHDs</em></strong></h4>
<p class="noindent">To retrieve password hashes from a Linux VHD, export the <em class="calibre7">/etc/passwd</em> and <em class="calibre7">/etc/shadow</em> files to get a list of users and their password hashes. It’s also a good idea to copy <em class="calibre7">/etc/group</em> and <em class="calibre7">/etc/gshadow</em> to determine what group memberships, and what rights, user accounts have.</p>
<p class="indent">The <em class="calibre7">/etc/samba</em>, <em class="calibre7">/etc/ssl</em>, and <em class="calibre7">/etc/ssh</em> directories should contain configuration files and certificates that the system uses. Additionally, <em class="calibre7">/etc/hostname</em> will contain the name of the VM, <em class="calibre7">/etc/fstab</em> will list any other mounted disks in the VM, and <em class="calibre7">/etc/hosts</em> may show static name-to-IP mappings of other servers that the VM interacts with.</p>
<p class="indent">It’s a good idea to try to retrieve source code and configuration files for any websites hosted on the VM because they may contain secrets. This is especially true of Apache’s <em class="calibre7">.htpasswd</em> and <em class="calibre7">.htaccess</em> files, which control access to web content. Common locations for these files include <em class="calibre7">/var/www</em>, <em class="calibre7">/usr/share/nginx</em>, and <em class="calibre7">/httpd</em>.</p>
<p class="indent">Users’ home directories are another good source of information; these directories are typically found in <em class="calibre7">/home</em> and also <em class="calibre7">/root</em>. Saved Secure Shell (SSH) key files for connecting to remote systems and the history of commands, usually named <em class="calibre7">.bash_history</em>, are particularly interesting. Command histories will often have the names of other servers worth investigating. Look for commands like <span class="literal">ssh</span>, <span class="literal">telnet</span>, <span class="literal">scp</span>, and <span class="literal">smbclient</span>, as well as for a valid username for those systems.</p>
<p class="indent">Even though Linux doesn’t use file extensions as universally as Windows does, you should perform a file extension search on Linux VHDs because many users and applications use extensions. Scan for certificate-related files (<em class="calibre7">*.pfx</em>, <em class="calibre7">*.p12</em>, <em class="calibre7">*.jks</em>) as well as shell scripts (<em class="calibre7">*.sh</em>) and text files (<em class="calibre7">*.txt</em>). You might also find something interesting in database files such as <em class="calibre7">*.sql</em>, <em class="calibre7">*.db</em>, and <em class="calibre7">*.myd</em>.</p>
<h3 class="h1" id="lev123"><strong class="calibre2">Cracking Password Hashes</strong></h3>
<p class="noindent">Once you successfully obtain password hashes from either Linux or Windows VMs, you will need to recover their plaintext values in order to use them. Hashes are meant to be <em class="calibre7">one directional</em>, meaning that you should not be able to determine the actual plaintext password from only the hash. But as you’ll <span epub:type="pagebreak" id="page_101"/>see in this section, there are a few possible ways to retrieve passwords from hashes, including dictionary attacks, brute-force attacks, hybrid attacks, and rainbow table attacks.</p>
<h4 class="h2" id="lev124"><strong class="calibre2"><em class="calibre10">Dictionary Attacks</em></strong></h4>
<p class="noindent">In a dictionary attack, an attacker compiles a list of common words or phrases and then hashes each item in the list with the same hashing algorithm the target server’s password system uses. Then, the attacker compares the hash of each dictionary word to the password hash list and displays the matches.</p>
<p class="indent">Dictionary attacks are great if you have a list of passwords that the target organization commonly uses, if you suspect users have simple one-word passwords that would appear in your compiled list of English words, or if you have a large password dictionary. You can usually find these large dictionaries online after criminals have compromised a popular website and released the stolen passwords. A good source is <em class="calibre7"><a href="https://github.com/danielmiessler/SecLists/" class="calibre6">https://github.com/danielmiessler/SecLists/</a></em>.</p>
<div class="note">
<p class="notet"><strong class="calibre2"><span class="notes">WARNING</span></strong></p>
<p class="notep"><em class="calibre7">Always check with the legal teams at your company and at your target company before using leaked password lists. Simply because they are publicly available does not mean that you are free to use them. Some organizations might consider these files stolen property and deem them off limits. If you intend to use these lists, consider mentioning that fact in your rules of engagement.</em></p>
</div>
<h4 class="h2" id="lev125"><strong class="calibre2"><em class="calibre10">Brute-Force Attacks</em></strong></h4>
<p class="noindent">When brute-forcing passwords, you generate every possible password combination of letters, numbers, and special characters and then hash that until a match is found. This method is very time consuming and is generally not practical for passwords greater than about eight characters in length, but it may find a short password that an attacker wouldn’t find in a typical dictionary, such as <em class="calibre7">f8i!R+</em>.</p>
<h4 class="h2" id="lev126"><strong class="calibre2"><em class="calibre10">Hybrid Attacks</em></strong></h4>
<p class="noindent">Hybrid attacks combine dictionary and brute-force attacks to try to recover complex passwords quickly. In this method, an attacker combines a base dictionary word with a sequence of characters, tests the result against the hash, and then moves on to the next word. For example, a password like <em class="calibre7">hippopotamus200</em> would likely not show up in any dictionary word list, and brute-forcing a 15-character password would take an unreasonable amount of time. However, a hybrid attack that uses one English word followed by one to four numbers would likely find this password in a matter of hours or days. The biggest drawback to a hybrid attack is that you need some idea of what the password’s format looks like. For example, the “word plus one to four characters” paradigm would not successfully find <em class="calibre7">200hippopotamus</em>.</p>
<h4 class="h2" id="lev127"><span epub:type="pagebreak" id="page_102" class="calibre1"/><strong class="calibre2"><em class="calibre10">Rainbow Table Attacks</em></strong></h4>
<p class="noindent">A rainbow table attack is a bit like a brute-force attack, where the attacker computes and stores all the hashes ahead of time to match against captured target hashes. However, truly storing every possible hash for a password of a given length would require a massive amount of space, making it impractical. To avoid this problem, the designers of rainbow tables perform a complex cryptographic operation (called a reduction function) that chains hashes together and only stores the beginning and end of each chain. (To learn how, see the original paper on the topic by Philippe Oechslin at <em class="calibre7"><a href="https://lasec.epfl.ch/pub/lasec/doc/Oech03.pdf" class="calibre6">https://lasec.epfl.ch/pub/lasec/doc/Oech03.pdf</a></em>.)</p>
<p class="indent">In order for an attacker to use the rainbow table, a program takes in the target hash and begins computations against the precomputed table by passing the captured hash through the reduction function and seeing if the result matches the end of any chain. If so, it takes the value at the beginning of that chain and begins hashing and then reducing from the start of that chain until the value that created the original hash is found. If the reduced version of the captured hash doesn’t match the end of any chain, it is passed through the hash and reduction functions, and the cycle is performed again until the correct chain is identified.</p>
<p class="indent">Attackers optimize rainbow tables for either speed or size: a smaller rainbow table will take longer to return the password (though it will still be considerably faster than brute-forcing), whereas a larger table will return the result faster but consume more disk space.</p>
<p class="indent">Although rainbow tables can be considerably faster than the other attacks discussed in this section, they have three major drawbacks. First, you must precompute them, so they require more planning and preparation than the other methods. Second, a rainbow table is only good for one hash format, such as MD5. This means that you’ll need different rainbow tables for each type of hash you encounter. At a minimum, expect to find LM and NTLM hashes on Windows, and MD5 and SHA1 hashes on Linux. Third, they are ineffective against salted hash formats.</p>
<h4 class="h2" id="lev128"><strong class="calibre2"><em class="calibre10">Weaknesses in Windows Password Hashes</em></strong></h4>
<p class="noindent">For Azure-based Windows VMs, Azure mandates that the username not be <em class="calibre7">admin</em> or <em class="calibre7">administrator</em>, that the password be between 12 and 123 characters in length, and that the password include at least three of the four character types: lowercase letters, uppercase letters, numbers, and symbols. This would normally make brute-force attacks infeasible except that Windows stores passwords in both NTLM and LM hash formats for compatibility reasons. Early versions of Windows use the LM hash format whereas later ones use the more secure NTLM. LM has a number of weaknesses:</p>
<ul class="calibre8">
<li class="noindent1">Passwords are padded with null characters as needed to get a total length of 14 characters, which is then split into two equal parts. Both parts are hashed separately and then concatenated to form the final LM hash value, so an attacker only needs to attack the hashes for two 7-character strings, which can be done in parallel.</li>
<li class="noindent1"><span epub:type="pagebreak" id="page_103"/>Passwords are limited to 14 characters.</li>
<li class="noindent1">Letters in passwords are converted to uppercase before hashing, making them case insensitive.</li>
</ul>
<p class="indent">If a user has a password that is fewer than 15 characters on Windows, it is likely stored in both NTLM and LM formats in the SAM. When a password is seven characters or fewer, LM sets the second half of the LM hash to AAD3B435B51404EE (the hashed value of 7 null bytes), so an attacker only has to crack the first half. For passwords over 14 characters, Windows doesn’t store an LM hash and instead stores a default value of AAD3B435B51404EEAAD3B435B51404EE. Windows uses this same hash value for accounts with no password at all, so if you come across it, try that account with a blank password and you might just get lucky!</p>
<p class="indent">Because any password stored with an LM hash is essentially just the hash of two seven-character passwords and because neither hash contains lowercase characters, the keyspace that must be attacked for an LM hash is rather small. Therefore, an attacker can very quickly recover any password stored in LM format. Once an attacker cracks an LM hash, the resulting password might not be the account’s actual password, due to the case insensitivity of LM. Thus, an attacker will need to perform a short brute-force test of each of that password’s case permutations against the NTLM hash to find the final correct password. For example, if the LM hash is the password <em class="calibre7">DOG</em>, the user’s actual password could be <em class="calibre7">dog</em>, <em class="calibre7">Dog</em>, <em class="calibre7">dOg</em>, <em class="calibre7">doG</em>, <em class="calibre7">DOg</em>, <em class="calibre7">DoG</em>, <em class="calibre7">dOG</em>, or <em class="calibre7">DOG</em>.</p>
<div class="sidebar">
<p class="sidebart"><strong class="calibre4">DEFENDER’S TIP</strong></p>
<p class="spara">To make your passwords harder to attack, ensure they have at least 15 characters so that Windows doesn’t store LM hashes. Additionally, be sure that your passwords contain uppercase letters, lowercase letters, symbols, and numbers, and that they are not based on dictionary words. Such passwords can be hard to remember, so consider using a secure password manager with a very strong master password!</p>
</div>
<h3 class="h1" id="lev129"><strong class="calibre2">Password Hash Attack Tools</strong></h3>
<p class="noindent">You will probably use one of two tools to perform password hash attacks: Cain &amp; Abel or hashcat. Cain &amp; Abel is a jack-of-all-trades security tool that has been an industry standard for years. In addition to having numerous features, it also has a GUI that makes it easy to learn. Hashcat is a newer addition to the penetration tester’s toolkit. It lacks a GUI and has only <span epub:type="pagebreak" id="page_104"/>one feature: cracking hashes. However, what hashcat lacks in ease of use it makes up for in performance and support for a huge number of hash types. As a penetration tester, it is useful to know how to use each tool.</p>
<h4 class="h2" id="lev130"><strong class="calibre2"><em class="calibre10">Attacking Hashes with Cain &amp; Abel</em></strong></h4>
<p class="noindent">Cain &amp; Abel offers hash cracking in the Cracker tab (the same tab you used for decrypting a SAM file in “<a href="part0014.html#lev121" class="calibre6">Analyzing Windows VHDs</a>” on <a href="part0014.html#page_98" class="calibre6">page 98</a>). Once you load the hashes in the Cracker tab, highlight the hashes you want to crack and then right-click any of the selected hashes. A context menu should appear with three cracking options at the top: Dictionary Attack, Brute-Force Attack, and Cryptanalysis Attack, as shown in <a href="part0014.html#ch05fig6" class="calibre6">Figure 5-6</a>.</p>
<div class="image1"><a id="ch05fig6" class="calibre6"/><img src="../images/00040.jpeg" alt="image" class="calibre3"/></div>
<p class="figcap"><em class="calibre7">Figure 5-6: The Cain &amp; Abel hash context menu</em></p>
<p class="indent">Selecting Dictionary Attack presents a screen where you can select dictionary wordlists and perform some limited modifications on dictionary terms, such as trying each word in all uppercase and all lowercase, as shown in <a href="part0014.html#ch05fig7" class="calibre6">Figure 5-7</a>.</p>
<p class="indent">The Brute-Force Attack option opens a different window where you can enter the characters to include in the attack, as well as the length of passwords to attempt, as shown in <a href="part0014.html#ch05fig8" class="calibre6">Figure 5-8</a>.</p>
<div class="image1"><span epub:type="pagebreak" id="page_105"/><a id="ch05fig7" class="calibre6"/><img src="../images/00041.jpeg" alt="image" class="calibre3"/></div>
<p class="figcap"><em class="calibre7">Figure 5-7: The Cain &amp; Abel Dictionary Attack window</em></p>
<div class="image1"><a id="ch05fig8" class="calibre6"/><img src="../images/00042.jpeg" alt="image" class="calibre3"/></div>
<p class="figcap"><em class="calibre7">Figure 5-8: The Cain &amp; Abel Brute-Force Attack window</em></p>
<p class="indent">Cain &amp; Abel includes logic that automatically adjusts the brute-force options, depending on the hash type. When you’re targeting LM hashes, the default keyspace doesn’t include lowercase characters and is preset to try passwords between one and seven characters in length, because these <span epub:type="pagebreak" id="page_106"/>are known limitations of LM hashes. Once the attack is started, Cain &amp; Abel shows test progress, including the rate of passwords tried per second and the total time remaining.</p>
<p class="indent">Finally, the Cryptanalysis Attack option will perform a rainbow table attack against the hashes. The option screen for this attack is very simple, providing only an option to specify paths to the rainbow tables. As with a brute-force attack, it also displays the attack’s progress.</p>
<h4 class="h2" id="lev131"><strong class="calibre2"><em class="calibre10">Testing Hashes with hashcat</em></strong></h4>
<p class="noindent">Hashcat is a free, open source, cross-platform password hash cracking tool, optimized to make full use of the processing power of the GPUs in modern graphics cards as well as the CPU. You can download hashcat from <em class="calibre7"><a href="https://hashcat.net/hashcat/" class="calibre6">https://hashcat.net/hashcat/</a></em>.</p>
<p class="indent">Much like Cain &amp; Abel, hashcat offers both dictionary and brute-force options, but it really shines in hybrid mode. By leveraging the power of the GPU, hashcat can test a huge number of password permutations each second—on the order of millions, billions, or even trillions, depending on the graphics card and the hash type. Hashcat also supports the use of complex rules to control its password generation, which can prove very useful if you can determine a target company’s password policy. For example, if you know that all passwords must be at least eight characters and contain a number and a symbol, you can start your testing by eliminating all passwords that do not meet that criteria.</p>
<p class="indent">Hashcat offers extensive support for various hash formats. Whereas Cain &amp; Abel supports only about 30 hash formats, hashcat supports over 200. This extensive support will come in really handy should you encounter a VM running some operating system or software that keeps its own password list (like PeopleSoft, Lotus Notes, or Joomla).</p>
<p class="indent">To learn how to use hashcat, I suggest reading the wiki at <em class="calibre7"><a href="https://hashcat.net/wiki/" class="calibre6">https://hashcat.net/wiki/</a></em>. Note that a misconfigured hashcat job could take orders of magnitude longer than one that is properly configured with a good dictionary and proper rules. Worse, a hastily created job might inadvertently exclude legitimate passwords for a target system. Few things are more painful during a penetration test than realizing that you need to restart a cracking job that has been running for several days because of a command line error!</p>
<div class="note">
<p class="notet"><strong class="calibre2"><span class="notes">NOTE</span></strong></p>
<p class="notep"><em class="calibre7">If the GPU in your computer isn’t very powerful, you might want to consider running hashcat on specialty Azure VMs that include NVIDIA-based GPUs, which are designed for computationally intensive tasks. Unfortunately, the cost of running these VMs for an extended period is usually costlier than building and operating your own PC with a few high-end video cards. You might prefer using the Azure GPUs under two circumstances, though. The first is if you need to crack a very important password very quickly. Using Azure, you could create dozens of these special VMs and assign each a different subset of the keyspace to test. The other is if you find password cracking to be a very rarely used technique in your engagements. In this case, it may make more sense to use Azure rather than make the initial capital investment in GPU hardware.</em></p>
</div>
<h3 class="h1" id="lev132"><span epub:type="pagebreak" id="page_107" class="calibre1"/><strong class="calibre2">Using a VHD’s Secrets Against a VM</strong></h3>
<p class="noindent">Once you’ve recovered a username and password from a VHD, you can begin to assess the running VM in Azure—but first you’ll need to know how to connect to the VM. To do this, you’ll need its hostname or IP address and you’ll need to know which remote administration service is running on the VM and its port. Azure VMs running Windows will usually have Remote Desktop Protocol (RDP) available, whereas Linux VMs will typically have Secure Shell (SSH) open. Less frequently, Virtual Network Computing (VNC) protocol or telnet will be exposed, but these protocols aren’t encrypted by default and shouldn’t be used, especially over the internet.</p>
<h4 class="h2" id="lev133"><strong class="calibre2"><em class="calibre10">Determining the Hostname</em></strong></h4>
<p class="noindent">Given the choice of hostname or IP, I prefer to use the hostname because IPs may be dynamically assigned. By default, Azure names its VHDs after the hostname of their associated VM. For example, if a VHD filename is <em class="calibre7">myazurevm20151231220005.vhd</em>, its hostname would usually be <em class="calibre7">myazurevm.cloudapp.net</em>.</p>
<p class="indent">Of course, VHDs can be renamed, or their VM could be assigned a different hostname. If you find that to be the case, you can try to retrieve the hostname information from Azure or from within the VHD. The easiest way to do so is to use Azure PowerShell and the <span class="literal">Get-AzureVM</span> cmdlet to return the hostnames of every VM in the subscription, but that assumes you have an account with proper access.</p>
<p class="indent">Alternatively, you can turn to the VHD itself. Windows stores the hostname in the SYSTEM registry hive, which we exported earlier in “<a href="part0014.html#lev121" class="calibre6">Analyzing Windows VHDs</a>” on <a href="part0014.html#page_98" class="calibre6">page 98</a>. To see this value, you’ll need to load this file into a registry viewer.</p>
<h5 class="h3" id="lev134"><strong class="calibre2">Recovering the Hostname from the VHD on Windows</strong></h5>
<p class="noindent">Be very careful when using the Windows built-in <span class="literal">regedit</span> tool to recover the hostname from the VHD; it’s just too easy to accidentally overwrite your own PC’s registry with values from the VM. A better choice is to use MiTeC’s Windows Registry Recovery (<em class="calibre7"><a href="http://www.mitec.cz/wrr.html" class="calibre6">http://www.mitec.cz/wrr.html</a></em>), as follows.</p>
<ol class="calibre16">
<li class="noindent1" value="1">Install Windows Registry Recovery and then click <strong class="calibre4">File</strong><span class="ent">▸</span><strong class="calibre4">Open</strong>.</li>
<li class="noindent1" value="2">Select the <em class="calibre7">SYSTEM</em> file exported from the VHD and click <strong class="calibre4">OK</strong>.</li>
<li class="noindent1" value="3">Click the <strong class="calibre4">Raw Data</strong> option in the menu on the left (see <a href="part0014.html#ch05fig9" class="calibre6">Figure 5-9</a>).</li>
<li class="noindent1" value="4">In the middle pane, navigate to <em class="calibre7">ROOT\ControlSet001\Control\ComputerName\ComputerName</em>.</li>
<li class="noindent1" value="5">The hostname should be in the ComputerName string in the pane on the right, as shown in <a href="part0014.html#ch05fig9" class="calibre6">Figure 5-9</a>.</li>
<li class="noindent1" value="6">If you see directories named <em class="calibre7">ControlSet002</em> or <em class="calibre7">ControlSet003</em> under <em class="calibre7">ROOT</em>, be sure to check those as well because the hostname may have changed.</li>
</ol>
<div class="image1"><span epub:type="pagebreak" id="page_108"/><a id="ch05fig9" class="calibre6"/><img src="../images/00043.jpeg" alt="image" class="calibre3"/></div>
<p class="figcap"><em class="calibre7">Figure 5-9: Viewing the hostname from the SYSTEM registry hive</em></p>
<p class="indent">There are other files in a Windows VM’s VHD that may contain the hostname, but the SYSTEM hive is the most reliable way to obtain it.</p>
<h5 class="h3" id="lev135"><strong class="calibre2">Recovering the Hostname from the VHD on Linux</strong></h5>
<p class="noindent">It’s quite simple to recover the hostname from the VHD on Linux. To do so, simply locate the <em class="calibre7">/etc/hostname</em> file and display it. It should contain the VM’s hostname.</p>
<h4 class="h2" id="lev136"><strong class="calibre2"><em class="calibre10">Finding a Remote Administration Service</em></strong></h4>
<p class="noindent">Once you know the hostname, you should determine if the VM has an accessible remote administration tool. Although the RDP, SSH, VNC, and telnet services have default ports, the target VM may not use those ports, so you’ll need to determine which one the remote service is using. This can be done by using information from the subscription, checking known ports, or performing a full port scan.</p>
<h5 class="h3" id="lev137"><span epub:type="pagebreak" id="page_109" class="calibre1"/><strong class="calibre2">Using PowerShell</strong></h5>
<p class="noindent">The best way to find any accessible remote ports in a VM, provided you have proper credentials, is to use the PowerShell reconnaissance you learned in “<a href="part0012.html#lev76" class="calibre6">Gathering Information on Networking</a>” on <a href="part0012.html#page_56" class="calibre6">page 56</a>. This data will contain the open ports allowed through the firewall for each VM from the output of the <span class="literal">Get-AzureEndpoint</span> and <span class="literal">Get-AzureRmNetworkSecurityGroup</span> cmdlets. Review this output and compare any listed open ports with well-known administration ports, as listed in <a href="part0014.html#ch05tab1" class="calibre6">Table 5-1</a>.</p>
<p class="tabcap" id="ch05tab1"><strong class="calibre4">Table 5-1:</strong> Common Administration Ports</p>
<table class="topbot-d">
<thead class="calibre12">
<tr class="calibre13">
<td class="table-h"><p class="tab_th"><strong class="calibre4">Service</strong></p></td>
<td class="table-h"><p class="tab_th"><strong class="calibre4">TCP port(s)</strong></p></td>
</tr>
</thead>
<tbody class="calibre14">
<tr class="calibre13">
<td class="table-a"><p class="taba">RDP</p></td>
<td class="table-a"><p class="taba">3389</p></td>
</tr>
<tr class="calibre13">
<td class="table-b"><p class="taba">SSH</p></td>
<td class="table-b"><p class="taba">22</p></td>
</tr>
<tr class="calibre13">
<td class="table-a"><p class="taba">VNC</p></td>
<td class="table-a"><p class="taba">5900</p></td>
</tr>
<tr class="calibre13">
<td class="table-b"><p class="taba">telnet</p></td>
<td class="table-b"><p class="taba">21</p></td>
</tr>
<tr class="calibre13">
<td class="table-ab"><p class="taba">Windows Remote Management (PowerShell remoting)</p></td>
<td class="table-ab"><p class="taba">5985, 5986</p></td>
</tr>
</tbody>
</table>
<p class="indent">If you find any matches, try to connect to the VM using a client for that protocol. For example, in Windows, you could use the built-in <em class="calibre7">mstsc.exe</em> application to connect to RDP endpoints, PuTTY (<em class="calibre7"><a href="https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html" class="calibre6">https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html</a></em>) for SSH and telnet, or TightVNC (<em class="calibre7"><a href="http://tightvnc.net/" class="calibre6">http://tightvnc.net/</a>)</em> for VNC servers. If you are running Linux, clients for SSH, VNC, and telnet are usually built in. For RDP, freeRDP (<em class="calibre7"><a href="http://www.freerdp.com/" class="calibre6">http://www.freerdp.com/</a></em>) is a popular choice.</p>
<p class="indent">If Windows Remote Management is available, you can connect using PowerShell. To do so, run the following:</p>
<p class="programs"><span class="ent">➊</span> PS C:\&gt; <span class="codestrong1">$s = New-PSSessionOption</span> <span class="codestrong1">–SkipCACheck –SkipCNCheck –SkipRevocationCheck</span>e<br class="calibre5"/><span class="ent">➋</span> PS C:\&gt; <span class="codestrong1">$c = Get-Credential</span><br class="calibre5"/><span class="ent">➌</span> PS C:\&gt; <span class="codestrong1">Enter-PSSession -Credential $c -ComputerName</span> <span class="codestrongitalic">TARGET_IP</span> <span class="codestrong1">-UseSSL -SessionOption $s</span><br class="calibre5"/><span class="ent">➍</span> [<span class="codeitalic">TARGET_IP</span>]: PS C:\Users\Administrator\Documents&gt; <span class="codestrong1">hostname</span><br class="calibre5"/>   WebhostSrv2012<br class="calibre5"/>   [<span class="codeitalic">TARGET_IP</span>]: PS C:\Users\Administrator\Documents&gt; <span class="codestrong1">exit</span><br class="calibre5"/>   PS C:\&gt;</p>
<p class="indent">This will instruct PowerShell to bypass SSL certificate validation <span class="ent">➊</span> (since your client doesn’t trust this host), prompt you for credentials for the target machine <span class="ent">➋</span>, and then connect <span class="ent">➌</span>. If the connection succeeds, the command prompt will change to show that you are connected to the remote host and can now run commands on that machine <span class="ent">➍</span>.</p>
<h5 class="h3" id="lev138"><strong class="calibre2">Testing Default Ports</strong></h5>
<p class="noindent">If PowerShell access to the subscription isn’t an option, try testing the common default ports for each service in <a href="part0014.html#ch05tab1" class="calibre6">Table 5-1</a>. This can be performed <span epub:type="pagebreak" id="page_110"/>quickly on Windows using the built-in <span class="literal">Test-NetConnection</span> PowerShell cmdlet, with no subscription access needed. Simply run the command for each port you need to test:</p>
<p class="programs"><span class="ent">➊</span> PS C:\&gt; <span class="codestrong1">Test-NetConnection -ComputerName</span> <span class="codestrongitalic">TARGET_IP</span> <span class="codestrong1">-Port 3389</span><br class="calibre5"/>   ComputerName     : <span class="codeitalic">TARGET_IP</span><br class="calibre5"/>   RemoteAddress    : <span class="codeitalic">TARGET_IP</span><br class="calibre5"/>   RemotePort       : 3389<br class="calibre5"/>   InterfaceAlias   : Ethernet<br class="calibre5"/>   SourceAddress    : 192.168.0.114<br class="calibre5"/><span class="ent">➋</span> TcpTestSucceeded : True<br class="calibre5"/><br class="calibre5"/><span class="ent">➌</span> PS C:\&gt; <span class="codestrong1">Test-NetConnection -ComputerName</span> <span class="codestrongitalic">TARGET_IP</span> <span class="codestrong1">-Port 21</span><br class="calibre5"/>   WARNING: TCP connect to (<span class="codeitalic">TARGET_IP</span> : 21) failed<br class="calibre5"/>   WARNING: Ping to <span class="codeitalic">TARGET_IP</span> failed with status: TimedOut<br class="calibre5"/><br class="calibre5"/>   ComputerName           : <span class="codeitalic">TARGET_IP</span><br class="calibre5"/>   RemoteAddress          : <span class="codeitalic">TARGET_IP</span><br class="calibre5"/>   RemotePort             : 21<br class="calibre5"/>   InterfaceAlias         : Ethernet<br class="calibre5"/>   SourceAddress          : 192.168.0.114<br class="calibre5"/>   PingSucceeded          : False<br class="calibre5"/>   PingReplyDetails (RTT) : 0 ms<br class="calibre5"/><span class="ent">➍</span> TcpTestSucceeded       : False</p>
<p class="indent">In this example, a test connection to port 3389 was attempted <span class="ent">➊</span> and succeeded <span class="ent">➋</span>, whereas the connection to port 21 <span class="ent">➌</span> failed <span class="ent">➍</span>. Because 3389 is the port for RDP, I would then attempt to connect to this VM using <em class="calibre7">mstsc.exe</em>.</p>
<h5 class="h3" id="lev139"><strong class="calibre2">Port Scanning</strong></h5>
<p class="noindent">If your test of default ports fails and you don’t have proper PowerShell access, move on to a full TCP port scan of the VM. This will take several minutes, depending on the speed of your internet connection and the VM’s current load, but it will reliably determine every available port that is both open on the VM and accessible from your PC.</p>
<p class="indent">The best port-scanning tool for this task is Nmap (<em class="calibre7"><a href="https://nmap.org/" class="calibre6">https://nmap.org/</a></em>). It can be installed on Windows or Linux, though I recommend using it on Linux, if possible, because it runs faster there. After installing Nmap, open a command prompt and run the following:</p>
<p class="programs"># <span class="codestrong1">nmap -Pn -p 0-65535 -sV</span> <span class="codestrongitalic">hostname</span><br class="calibre5"/><br class="calibre5"/>Starting Nmap 7.01 ( https://nmap.org )<br class="calibre5"/>Nmap scan report for <span class="codeitalic">hostname (IP)</span><br class="calibre5"/>Host is up (0.041s latency).<br class="calibre5"/>Not shown: 65534 filtered ports<br class="calibre5"/>PORT     STATE SERVICE            VERSION<br class="calibre5"/>3389/tcp open  ssl/ms-wbt-server?<br class="calibre5"/>5986/tcp open  ssl/http           Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)<br class="calibre5"/><span epub:type="pagebreak" id="page_111"/>Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows<br class="calibre5"/><br class="calibre5"/>Service detection performed. Please report any incorrect results at https://nmap.org/submit/.<br class="calibre5"/>Nmap done: 1 IP address (1 host up) scanned in 10081.46 seconds</p>
<p class="indent">The <span class="literal">-Pn</span> switch tells Nmap to continue even if the host doesn’t respond to a ping request. The <span class="literal">-p</span> switch tells Nmap which ports to scan (in this case, all possible TCP ports). Finally, <span class="literal">-sV</span> instructs Nmap to try to determine which service is running on any open ports it finds. Based on these results, you should learn which remote administration services are available in your target VM and on which ports they run.</p>
<p class="indent">These techniques can fail for three possible reasons: either the VM is currently shut down, all administration services have been disabled (or their ports have been restricted by a firewall), or the hostname or IP address isn’t correct. The only options in this case are to try again later or to give up and move on to other parts of the penetration test.</p>
<h3 class="h1" id="lev140"><strong class="calibre2">Resetting a Virtual Machine’s Credentials</strong></h3>
<p class="noindent">Combining VHD forensics with password cracking, as discussed previously, is a powerful way to obtain credentials from a VM, but it’s limited to cases where Azure Disk Encryption isn’t enabled and when the attacker has time to crack the administrator password. If you manage to gain administrative rights to a subscription, you can use another, much faster method that doesn’t rely on obtaining information from disks: you can reset a VM’s administrator password. Although this method is fast and reliable, it also has a high likelihood of being detected, so I save it as a last resort.</p>
<h4 class="h2" id="lev141"><strong class="calibre2"><em class="calibre10">How to Reset a VM’s Credentials</em></strong></h4>
<p class="noindent">To avoid permanently locking users out of VMs when they’ve forgotten their password, the Azure portal offers a reset option for VM passwords, as shown in <a href="part0014.html#ch05fig10" class="calibre6">Figure 5-10</a>. To access it for your target VM, sign in to the portal, click the <strong class="calibre4">Virtual Machines</strong> section, click your target VM, and then select <strong class="calibre4">Reset password</strong>.</p>
<p class="indent">This form has a few nice features. For one, it shows the VM’s built-in administrator or root account name (<em class="calibre7">azureadmin</em> in this case), even if it has been changed. This can be very helpful even if you aren’t planning to perform a password reset, because it allows you to determine a valid account name that can be used for things like dictionary attacks. Second, when a password is too weak, a red exclamation point appears at the right end of the password box. If you hover over the exclamation point, you’ll be able to read a tool tip about password complexity requirements. This would be perfect information to use to configure hashcat’s rules.</p>
<div class="image1"><span epub:type="pagebreak" id="page_112"/><a id="ch05fig10" class="calibre6"/><img src="../images/00044.jpeg" alt="image" class="calibre3"/></div>
<p class="figcap"><em class="calibre7">Figure 5-10: Reset password screen for an Azure VM</em></p>
<p class="indent">To actually complete the password reset and change the administrator password, simply enter your desired password in the Password field and click <strong class="calibre4">Update</strong>. If you modify the User Name field, the administrator account should also be renamed. Additionally, if the built-in administrator account is disabled, the password reset option should re-enable it.</p>
<p class="indent">This form also contains an option in the Mode drop-down menu to reset the remote access configuration. This option will leave the original password intact but will enable RDP (Windows) or SSH (Linux) on the VM to restore the ability to connect remotely. This feature is intended to restore an administrator’s ability to connect to a VM after a misconfiguration, but for a penetration tester, it can re-open a remote access service on a VM that has been hardened.</p>
<h4 class="h2" id="lev142"><strong class="calibre2"><em class="calibre10">Downsides to Password Resets</em></strong></h4>
<p class="noindent">Even though a password reset is a fairly reliable way to gain access to a VM, it has some downsides. Most importantly, when the password is successfully changed via the portal, you’ll have no way to determine what the previous password was. That means that the password can’t be set back to its original value, and you are now the only one with the credentials. Of course, this also means that as soon as a legitimate user of the VM’s administrator account tries to connect to the VM, they will realize something is wrong. They won’t necessarily be blocked from accessing the VM because they can just perform a password reset themselves (assuming they have Azure portal access), but even inexperienced users will likely realize that a security incident may have occurred and will begin investigating or report it to their security monitoring team.</p>
<p class="indent"><span epub:type="pagebreak" id="page_113"/>Second, even though you will have the credentials, you will likely have little to no idea how the target VM is configured. If the software running in the VM is actively using the account you reset, resetting the password may cause unforeseen outages in other services, which expect a different password.</p>
<p class="indent">Finally, this method has some technical limitations. The VM must be in a running state for the password reset option to be available. Additionally, the Azure VM agent software must be installed on the VM. The default OS images in Azure typically have this agent already installed, but some VMs may have had the agent removed by an administrator, may be running a less popular or older operating system with no agent available, or may have been built from nonstandard images.</p>
<h3 class="h1" id="lev143"><strong class="calibre2">Summary</strong></h3>
<p class="noindent">In this chapter, we discussed how an attacker can create and download a snapshot for a virtual machine’s disk image from Azure Storage and then recover password hashes and other sensitive data from it with forensic recovery tools like Autopsy. We then examined how to crack these hashes in either Cain &amp; Abel or hashcat to determine the original plaintext passwords. From there, we determined what management services were accessible on the VM using PowerShell or port scanning. Then, we used the cracked passwords to connect back to the VMs.</p>
<p class="indent">After that, we looked at Azure’s VM password reset option. You can use this option to gain administrator level access to any VM that you can access in the portal, with no additional knowledge about the VM’s configuration. Finally, we considered some possible limitations to this attack.</p>
<p class="indent">In the next chapter, we’ll look at Azure networking to examine how to target internet-facing VMs, as well as how systems within a corporate network can interact with Azure services.<span epub:type="pagebreak" id="page_114"/></p>
</body></html>