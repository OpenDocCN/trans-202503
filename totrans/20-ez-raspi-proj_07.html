<html><head></head><body>
<h2 class="h1-part" id="part06"><span epub:type="pagebreak" id="page_223"/><span class="orange">Games and Toys</span></h2>


<h2 class="h2" id="ch18"><span epub:type="pagebreak" id="page_224"/><strong>18<br/>Digital Drum Set</strong></h2>
<p class="noindent"><span class="orange">In this project you’ll create a button-controlled digital drum set with just a breadboard circuit and a few buttons. Pressing different buttons will produce different drum sounds, including two drumbeat loops.</span></p>
<div class="image"><span epub:type="pagebreak" id="page_225"/><img src="../images/f0225-01.jpg" alt="image"/></div>
<p class="cap"><span class="orange"><strong>PARTS REQUIRED</strong></span></p>
<p class="cap1">Raspberry Pi</p>
<p class="cap1">Breadboard</p>
<p class="cap1">Eight pushbuttons</p>
<p class="cap1">Headphones, or monitor with speakers connected to the Pi via HDMI</p>
<p class="cap1">Jumper wires</p>
<p class="cap"><span class="orange"><strong>SOFTWARE REQUIRED</strong></span></p>
<p class="cap1">avconv</p>
<p class="noindentt"><span epub:type="pagebreak" id="page_226"/>This project uses samples from the Sonic Pi sample library, but you’re free to adapt it to use any sounds you want.</p>
<h3 class="h3" id="lev183"><span class="orange"><strong>PREPARING THE AUDIO</strong></span></h3>
<p class="noindent">First you’ll need to configure the Raspberry Pi audio properly and get set up to use audio samples from Sonic Pi.</p>
<h4 class="h4" id="lev184"><span class="orange"><strong>Configuring the Audio</strong></span></h4>
<p class="noindent">First, plug your headphones or speakers into the Raspberry Pi audio jack. If your monitor has built-in speakers and is connected to the Pi with an HDMI cable, you don’t need to connect anything to the audio jack—you can listen to the sound through the monitor speakers.</p>
<p class="indent">On the top-right corner of your desktop environment, right-click the audio symbol and select the audio source as shown in <a href="ch18.xhtml#ch18fig1">Figure 18-1</a>. Select Analog if you’re using headphones, or HDMI if you’re using a monitor with speakers.</p>
<div class="image"><a id="ch18fig1"/><img src="../images/f0226-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 18-1:</strong> Selecting the audio source</p>
<h4 class="h4" id="lev185"><span class="orange"><strong>Getting the Audio Sample Files</strong></span></h4>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>We won’t be covering Sonic Pi in this book, but if you want to explore it on your own, go to <strong>Programming</strong></em> <span class="ent">▸</span> <em><strong>Sonic Pi</strong> in the taskbar main menu to open the software and take a look around.</em></p>
</div>
<p class="noindent">The Sonic Pi software comes installed in the Pi’s operating system and allows you to create your own digital music using code, but in this project you’ll just be using the Sonic Pi’s sample audio files.</p>
<p class="indent">In the terminal, enter the following commands to create a new folder called <em>Games_and_Toys</em> inside the <em>Projects</em> folder, and move into the new folder. You’ll save the samples here.</p>
<div class="box">
<p class="programs">pi@raspberrypi:~ $ <span class="codestrong">cd ~/Desktop/Projects</span><br/>pi@raspberrypi:~/Desktop/Projects $ <span class="codestrong">mkdir Games_and_Toys</span><br/>pi@raspberrypi:~/Desktop/Projects $ <span class="codestrong">cd Games_and_Toys</span></p>
</div>
<p class="indent">Then enter the following to copy the Sonic Pi’s <em>samples</em> folder to the <em>Games_and_Toys</em> folder (note that there is a space between the final <span class="literal">/</span> and the period at the end):</p>
<div class="box">
<p class="programs">pi@raspberrypi:~/Desktop/Projects/Games_and_Toys $ <span class="codestrong">cp -r /opt/</span><br/><span class="codestrong">sonic-pi/etc/samples/ .</span></p>
</div>
<p class="indent"><span epub:type="pagebreak" id="page_227"/>Next, enter these commands to list the contents of the <em>samples</em> folder to check that they transferred correctly:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~/Desktop/Projects/Games_and_Toys $ <span class="codestrong">cd samples</span><br/>pi@raspberrypi:~/Desktop/Projects/Games_and_Toys/samples $ <span class="codestrong">ls</span></p>
</div>
<p class="indent">If all went as planned, you should see a list of files like so:</p>
<div class="box">
<p class="programs">ambi_choir.flac        drum_cowbell.flac        elec_ping.flac<br/>ambi_dark_woosh.flac   drum_cymbal_closed.flac  elec_plip.flac<br/>...</p>
</div>
<p class="indent">You may notice these files have the unusual extension <em>.flac</em>. This format is used in Sonic Pi, but to use them with Python you need to convert them to <em>.wav</em> files. For that, you’ll use the avconv software. Enter the following command to install avconv:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~/Desktop/Projects/Games_and_Toys/samples $ <span class="codestrong">sudo apt</span><br/><span class="codestrong">install libav-tools</span></p>
</div>
<p class="indent">Then enter the following command, which will go through all the files in the <em>samples</em> folder and convert each <em>.flac</em> file into a <em>.wav</em> file:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~/Desktop/Projects/Games_and_Toys/samples $ <span class="codestrong">for f in</span><br/><span class="codestrong">*.flac; do avconv -i "$f" "${f%.flac}.wav"; done</span></p>
</div>
<p class="indent">Next, use the <span class="literal">ls</span> command to list the items in your <em>samples</em> folder and check that you now have <em>.wav</em> files to work with:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~/Desktop/Projects/Games_and_Toys/samples $ <span class="codestrong">ls</span></p>
</div>
<p class="indent">You should have both a <em>.wav</em> and a <em>.flac</em> file for each sample. To remove the <em>.flac</em> files from your <em>samples</em> folder, enter the following command:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~/Desktop/Projects/Games_and_Toys/samples $ <span class="codestrong">rm *.flac</span></p>
</div>
<p class="indent">You can double-check that you have the correct files with the <span class="literal">ls</span> command again if you like.</p>
<p class="indent">You can play the sounds with the <em>omxplayer</em> software that’s installed on your operating system by default. To listen to the sample called <em>drum_snare_soft.wav</em>, enter the following at your command line:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~/Desktop/Projects/Games_and_Toys/samples $ <span class="codestrong">omxplayer</span><br/><span class="codestrong">drum_snare_soft.wav</span></p>
</div>
<p class="indent"><span epub:type="pagebreak" id="page_228"/>If you explore the samples files, you’ll see a wide variety of sounds, from guitar sounds to cow bell and drums. Choose eight different drum sounds to include in your drum set (or any other sounds that strike your fancy).</p>
<p class="indent">The sounds we’ve chosen are as follows; the last two are drum beats, while the others refer to single drum sounds:</p>
<ul>
<li class="noindent"><em>drum_cymbal_open.wav</em></li>
<li class="noindent"><em>drum_heavy_kick.wav</em></li>
<li class="noindent"><em>drum_snare_hard.wav</em></li>
<li class="noindent"><em>drum_cymbal_closed.wav</em></li>
<li class="noindent"><em>drum_roll.wav</em></li>
<li class="noindent"><em>perc_snap.wav</em></li>
<li class="noindent"><em>loop_amen_full.wav</em></li>
<li class="noindent"><em>loop_mika.wav</em></li>
</ul>
<h3 class="h3" id="lev186"><span class="orange"><strong>WIRING THE CIRCUIT</strong></span></h3>
<p class="noindent">The circuitry for this project simply involves wiring eight pushbuttons to the Pi. Each pushbutton is associated with a different sound.</p>
<p class="indent">To wire the circuit, follow these instructions, using <a href="ch18.xhtml#ch18fig2">Figure 18-2</a> as a reference.</p>
<div class="image"><a id="ch18fig2"/><img src="../images/f0228-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 18-2:</strong> The digital drum set circuit</p>
<ol>
<li class="noindent"><p class="list"><span epub:type="pagebreak" id="page_229"/>Connect the GND pin to the breadboard GND rail.</p></li>
<li class="noindent"><p class="list">Insert eight pushbuttons into the breadboard at equal distances over the center divide.</p></li>
<li class="noindent"><p class="list">Connect the bottom-left pushbutton leads to GND and the bottom-right leads to one of the following GPIO pins in turn: GPIO 2, 3, 14, 15, 17, 18, 22, and 27.</p>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="border_th-r"><p class="tab_th"><strong>PUSHBUTTON</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>RASPBERRY PI</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">GPIO 2</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">2</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">GPIO 3</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">3</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">GPIO 14</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">4</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">GPIO 15</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">5</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">GPIO 17</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">6</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">GPIO 18</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">7</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">GPIO 22</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">8</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">GPIO 27</span></p></td>
</tr>
</tbody>
</table></li>
</ol>
<h3 class="h3" id="lev187"><span class="orange"><strong>WRITING THE SCRIPT</strong></span></h3>
<p class="noindent">Open <strong>Python 3 (IDLE)</strong> and go to <strong>File</strong> <span class="ent">▸</span> <strong>New File</strong> to create a new script. Copy the following code into the Python Editor and save the script as <em>digital_drum_set.py</em> inside the <em>Games_and_Toys</em> folder (remember that you can download all the scripts at <em><a href="https://www.nostarch.com/RaspberryPiProject/">https://www.nostarch.com/RaspberryPiProject/</a></em>):</p>
<div class="box">
<p class="programs">  <span class="red1">#import the necessary libraries</span><br/><span class="ent">➊</span> <span class="orange">import</span> pygame.mixer<br/>  <span class="orange">from</span> pygame.mixer <span class="orange">import</span> Sound<br/>  <span class="orange">from</span> gpiozero <span class="orange">import</span> Button<br/>  <span class="orange">from</span> signal <span class="orange">import</span> pause<br/><br/>  <span class="red1">#create an object for the mixer module that loads and plays sounds</span><br/><span class="ent">➋</span> pygame.mixer.init()<br/><br/>  <span class="red1">#assign each button to a drum sound</span><br/><span class="ent">➌</span> button_sounds = {<br/>      Button(2): Sound(<span class="green">"samples/</span><span class="green">drum_cymbal_open.wav</span><span class="green">"</span>),<br/>      Button(3): Sound(<span class="green">"samples/</span><span class="green">drum_heavy_kick.wav</span><span class="green">"</span>),<br/>      Button(14): Sound(<span class="green">"samples/</span><span class="green">drum_snare_hard.wav</span><span class="green">"</span>),<br/>      Button(15): Sound(<span class="green">"samples/</span><span class="green">drum_cymbal_closed.wav</span><span class="green">"</span>),<br/>      Button(17): Sound(<span class="green">"samples/</span><span class="green">drum_roll.wav</span><span class="green">"</span>),<br/>      Button(18): Sound(<span class="green">"samples/</span><span class="green">perc_snap.wav</span><span class="green">"</span>),<br/><span epub:type="pagebreak" id="page_230"/>      Button(22): Sound(<span class="green">"samples/</span><span class="green">loop_amen_full.wav</span><span class="green">"</span>),<br/>      Button(27): Sound(<span class="green">"samples/</span><span class="green">loop_mika.wav</span><span class="green">"</span>),<br/>  }<br/>  <span class="red1">#the sound plays when the button is pressed</span><br/><span class="ent">➍</span> <span class="orange">for</span> button, sound <span class="orange">in</span> button_sounds.items():<br/>      button.when_pressed = sound.play<br/>  <span class="red1">#keep the program running to detect events</span><br/><span class="ent">➎</span> pause()</p>
</div>
<p class="indent">As usual, you start your script by importing the necessary libraries <span class="ent">➊</span>. The new library here is the <span class="literal">pygame.mixer</span>, used for loading and playing sounds. From <span class="literal">pygame.mixer</span> you also import the <span class="literal">Sound</span> module, used to create sound objects.</p>
<p class="indent">Then you initialize the Pygame mixer <span class="ent">➋</span> and create a dictionary that holds sounds <span class="ent">➌</span>. In Python, a <em>dictionary</em> is a data structure used to store relationships between items. In this case, you’re associating a button with a specific sound. The basic structure of a dictionary is as follows:</p>
<div class="box">
<p class="programs">dictionary_name = {key_1: value_1, key_2: value_2}</p>
</div>
<p class="indent">The dictionary is enclosed by curly brackets, <span class="literal">{}</span>, and is composed of key/value pairs. You use a colon (<span class="literal">:</span>) to assign each key to its corresponding value, and you use commas (<span class="literal">,</span>) to separate each key/value pair.</p>
<p class="indent">In this project, the keys are the buttons, and the values are the sounds. To create a sound object, you pass the sound file path as a string to the <span class="literal">Sound()</span> function. In this case, since the <em>samples</em> folder is inside the <em>Games_and_Toys</em> folder, you don’t need to provide an entire path, just the folder name followed by the sound filename. You’ll need to change the sound filenames in this script, highlighted in bold, to your chosen sound files.</p>
<p class="indent">Next, assign each button to a sound effect <span class="ent">➍</span>; this means that, when a pushbutton is pressed, the corresponding sound will play. Finally, the <span class="literal">pause()</span> function <span class="ent">➎</span> at the end of the script keeps the program running, so events can be detected.</p>
<p class="indent">To run the script, press <strong>F5</strong> or go to <strong>Run</strong> <span class="ent">▸</span> <strong>Run Module</strong>.</p>
<p class="indent">Congratulations—you’ve just built your own digital drum set! Now, press the pushbuttons and compose your own music clips.</p>
<h3 class="h3" id="lev188"><span epub:type="pagebreak" id="page_231"/><span class="orange"><strong>TAKING IT FURTHER</strong></span></h3>
<p class="noindent">This was a cool project and so simple to build. We encourage you to extend this project by trying the following:</p>
<ul>
<li class="noindent">Adding other sounds to your digital drum set</li>
<li class="noindent">Recording your own sounds or searching the web for free sounds</li>
<li class="noindent">Building a digital piano, a digital guitar, or a hybrid music box with mixed sounds</li>
</ul>


<h2 class="h2" id="ch19"><span epub:type="pagebreak" id="page_232"/><strong>19<br/>Make a Game in Scratch: Hungry Monkey</strong></h2>
<p class="noindent"><span class="orange">In this project you’ll use the block-based programming language Scratch to create a game that can be controlled with two pushbuttons and your Pi.</span></p>
<div class="image"><span epub:type="pagebreak" id="page_233"/><img src="../images/f0233-01.jpg" alt="image"/></div>
<p class="cap"><span class="orange"><strong>PARTS REQUIRED</strong></span></p>
<p class="cap1">Raspberry Pi</p>
<p class="cap1">Two pushbuttons</p>
<p class="cap1">Breadboard</p>
<p class="cap1">Jumper wires</p>
<p class="noindentt"><span epub:type="pagebreak" id="page_234"/>In this project, you’ll create your own game called Hungry Monkey. The object of the game is for the monkey to catch as many ripe bananas as possible in 30 seconds, while avoiding the rotten ones. You’ll be able to move the monkey left and right with two pushbuttons that you’ll wire to your Raspberry Pi.</p>
<h3 class="h3" id="lev189"><span class="orange"><strong>INTRODUCING SCRATCH 2</strong></span></h3>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>To find out more about Scratch, visit the official Scratch website at</em> <a href="http://scratch.mit.edu/">http://scratch.mit.edu/</a>.</p>
</div>
<p class="noindent">Scratch is a visual programming language you can use to create animations, stories, and games using drag-and-drop code blocks. Although Scratch was developed to teach kids how to program, it’s suitable for anyone who wants to learn some fundamental programming concepts or just wants to have fun building their own games.</p>
<p class="indent">Scratch 2 is installed on Raspbian by default. You can open it from the desktop main menu by going to <strong>Programming</strong> <span class="ent">▸</span> <strong>Scratch 2</strong>. When you open Scratch 2, you should see a window like the one in <a href="ch19.xhtml#ch19fig1">Figure 19-1</a>.</p>
<div class="image"><a id="ch19fig1"/><img src="../images/f0234-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 19-1:</strong> The Scratch 2 window</p>
<p class="indent"><span epub:type="pagebreak" id="page_235"/>The Scratch window divides the screen into four main sections. The Stage <span class="ent">➊</span> is where your game or animations will play out. At the top right, you’ll see a green flag and a stop sign; you can use these icons to start and stop the game, respectively. When you first open Scratch, you should see a cat on your stage by default.</p>
<p class="indent">The Sprite List <span class="ent">➋</span> shows all of your <em>sprites</em>, which are your game characters or any object that performs an action in your project. In the middle of the window is the Blocks Area <span class="ent">➌</span>, which has three tabs: Scripts, Costumes, and Sounds. The Scripts tab contains programming blocks you use to build your program. Each block is a different programming instruction that you can drag and drop into place in your program. You’ll see different categories of blocks organized according to what they do. Each category has a specific color; for example, blocks from the <strong>Motion</strong> category, which tell your sprites how to move around, are dark blue.</p>
<p class="indent">The Costumes tab <span class="ent">➍</span> shows options for customizing and creating new costumes for your sprites, and the Sounds tab <span class="ent">➎</span> allows you to add sounds to your sprites. The Scripts Area <span class="ent">➏</span> is where you drag the blocks and put them together to create a script.</p>
<p class="indent">The menu bar <span class="ent">➐</span> at the top shows the File and Edit main menus at the left side. The icons at the center allow you to duplicate, delete, grow, and shrink your sprites, and also get help from Scratch.</p>
<h3 class="h3" id="lev190"><span class="orange"><strong>WIRING THE CIRCUIT</strong></span></h3>
<p class="noindent">The circuit for this project consists of two pushbuttons and the Raspberry Pi. Follow these instructions to wire them, using <a href="ch19.xhtml#ch19fig2">Figure 19-2</a> as a reference.</p>
<ol>
<li class="noindent"><p class="list">Connect a GND pin to your breadboard’s GND rail.</p></li>
<li class="noindent"><p class="list">Insert two pushbuttons into the breadboard.</p></li>
<li class="noindent"><p class="list">Connect the bottom-right pushbutton pins to the GND rail.</p></li>
<li class="noindent"><p class="list">Connect the bottom-left pin of one pushbutton to GPIO 2 and the other to GPIO 3.</p></li>
</ol>
<div class="image"><a id="ch19fig2"/><img src="../images/f0235-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 19-2:</strong> Wiring two pushbuttons to the Raspberry Pi</p>
<p class="indent"><span epub:type="pagebreak" id="page_236"/>That’s it! You’re ready to code the game.</p>
<h3 class="h3" id="lev191"><span class="orange"><strong>BUILDING THE SCRIPT</strong></span></h3>
<p class="noindent">Before creating a game, it’s useful to outline the features you want your game to have so you know exactly what you need to do.</p>
<p class="indent">In the Hungry Monkey game, the player controls a monkey who needs to catch as many ripe bananas as possible while avoiding rotten bananas. For each good banana caught, the player gets a point; if the player catches a rotten banana, the game deducts a point. Here’s a list of the main steps to build the Hungry Monkey game:</p>
<ol>
<li class="noindent"><p class="list">Create the main character, the monkey, and allow the player to control its movement using two pushbuttons: one moves the monkey right and the other moves the monkey left. Also allow the player to move the monkey with keyboard keys.</p></li>
<li class="noindent"><p class="list">Create the good and rotten banana sprites and make them fall from the sky.</p></li>
<li class="noindent"><p class="list">Program the monkey so that it catches the bananas when it touches them.</p></li>
<li class="noindent"><p class="list">Create a score system that adds one point when the monkey catches a good banana and subtracts a point when it catches a rotten one.</p></li>
<li class="noindent"><p class="list">Create a timer and end the game when the timer hits 0.</p></li>
<li class="noindent"><p class="list">Display the player’s score when the game is over.</p></li>
</ol>
<p class="indent">The Scratch file for this project is available at <em><a href="https://www.nostarch.com/RaspberryPiProject/">https://www.nostarch.com/RaspberryPiProject/</a></em>. To upload a saved program to Scratch, go to <strong>File <span class="ent">▸</span> Load Project</strong>. To build the script, follow the next few sections.</p>
<h4 class="h4" id="lev192"><span class="orange"><strong>Creating the Sprites and Choosing the Stage Background</strong></span></h4>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>You can also create a sprite from scratch using the paintbrush icon, upload your own sprite by clicking the folder icon, or take a photo with a webcam for your sprite with the camera icon.</em></p>
</div>
<p class="noindent">In the Hungry Monkey Game, you’ll use a monkey sprite, and a banana sprite from the Sprite Library. You won’t need to use the cat sprite that appears on the Stage by default, so you can delete it by right-clicking the sprite and selecting <strong>Delete</strong> to delete this sprite.</p>
<p class="indent">Go to the Sprite List and click the leftmost icon that looks like a character (see <a href="ch19.xhtml#ch19fig3">Figure 19-3</a>) to open the Sprite Library.</p>
<div class="image"><span epub:type="pagebreak" id="page_237"/><a id="ch19fig3"/><img src="../images/f0237-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 19-3:</strong> Icons to create new sprites</p>
<p class="indent">From the Animals category, choose the <span class="literal">Monkey2</span> sprite and click <strong>OK</strong>. Then, open the Sprite Library again, select the <span class="literal">Bananas</span> sprite from the Things category, and then click <strong>OK</strong>.</p>
<p class="indent">You can choose a background for your game from the leftmost side of the Sprite List. There you’ll find a set of icons for the background. Click the first icon—highlighted in <a href="ch19.xhtml#ch19fig4">Figure 19-4</a>—to choose a background from the backdrop library. We’ve chosen the one called <em>blue sky</em>.</p>
<div class="image"><a id="ch19fig4"/><img src="../images/f0237-02.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 19-4:</strong> Selecting the background from the backdrop library</p>
<p class="indent">Now your sprites section should look like <a href="ch19.xhtml#ch19fig5">Figure 19-5</a>.</p>
<div class="image"><a id="ch19fig5"/><img src="../images/f0237-03.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 19-5:</strong> Sprite List with the selected sprites and background</p>
<h4 class="h4" id="lev193"><span class="orange"><strong>Editing the Sprites</strong></span></h4>
<p class="noindent">Scratch allows you to increase or decrease the size of a sprite, change its color, or edit it as you would do in an image-editing program. Scratch built-in image editor is called <em>Paint Editor</em>. Here you’ll make some changes to your sprites’ appearance.</p>
<p class="indent">Select the <span class="literal">Monkey2</span> sprite in the Sprite List; if a sprite is selected, it will be outlined in blue, as shown in <a href="ch19.xhtml#ch19fig5">Figure 19-5</a>. Next, click the <span class="literal">Monkey2</span> sprite in the Costumes tab, and edit the first costume, called <span class="literal">monkey2-a</span>. With the mouse pointer drag a corner of the sprite until its size matches 98×138 pixels, or use the shrink <span epub:type="pagebreak" id="page_238"/>tool until you get the desired size; the sprite size is displayed below the <span class="literal">monkey2-a</span> costume. Also change the <span class="literal">Bananas</span> sprite’s size to 28×28 pixels.</p>
<p class="indent">When adjusting the sprites’ size, make sure they’re at the center of the canvas in order to keep the sprite’s reference point.</p>
<h4 class="h4" id="lev194"><span class="orange"><strong>Adding Controls to the Monkey Sprite</strong></span></h4>
<p class="noindent">Now you’ll add controls to the monkey so you can make it go left or right by pressing the pushbuttons or the left and right arrows on the keyboard.</p>
<p class="indent">To allow the Raspberry Pi GPIOs to interface with Scratch so the program will react when a pushbutton is pressed, you need to add an extension library to Scratch. Select the <span class="literal">Monkey2</span> sprite in the Scripts tab, select <strong>More Blocks</strong>, and click <strong>Add an Extension</strong>. Next select the Pi GPIO icon, as shown in <a href="ch19.xhtml#ch19fig6">Figure 19-6</a>, and click <strong>OK</strong>.</p>
<div class="image"><a id="ch19fig6"/><img src="../images/f0238-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 19-6:</strong> Adding the Pi GPIO extension</p>
<p class="indent">The extension library adds new blocks to control the Pi GPIOs, which should appear in the More Blocks category.</p>
<p class="indent">There are many different ways to make your sprite move in Scratch. You’ll use the (x,y) coordinate system, in which the (0,0) position is the middle of the Stage. Increasing the x-coordinate moves your sprites to the right, and decreasing it moves your sprites to the left. Increasing the y-coordinate moves your sprites up, and decreasing it moves your sprites down. The blocks that control movement are in the dark blue <strong>Motion</strong> category.</p>
<p class="indent">To control the monkey, select the <span class="literal">Monkey2</span> sprite and drag the blocks in <a href="ch19.xhtml#ch19fig7">Figure 19-7</a> into the Script Area. Then change the settings in the blocks to match <a href="ch19.xhtml#ch19fig7">Figure 19-7</a>.</p>
<div class="image"><span epub:type="pagebreak" id="page_239"/><a id="ch19fig7"/><img src="../images/f0239-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 19-7:</strong> Blocks for controlling the monkey</p>
<p class="indent">You first set the <span class="literal">Monkey2</span> sprite’s x-position to 0 and y-position to –110. Setting x to 0 centers your sprite horizontally, and setting y to –110 moves your sprite to the floor. This way the sprite is always in this position every time you start the game.</p>
<p class="indent">The next two blocks set GPIO 2 and GPIO 3 to inputs, so the program will be able to tell if the pushbuttons have been pressed.</p>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>Finding the blocks is easy. Remember that each blocks category has a specific color and each block within it is colored accordingly.</em></p>
</div>
<p class="indent">Then you add a forever loop that continuously checks if the player is pressing the pushbuttons or the left and right arrow keys. If the player presses the pushbutton connected to GPIO 3, or the right arrow key, the sprite’s x-position is changed by 30, moving it to the right; if the player presses the pushbutton connected to GPIO 2, or the left arrow key, the sprite’s x-position is changed by –30, moving it to the left. You can increase this number to make your monkey move faster, or decrease it to make the monkey move slower.</p>
<p class="indent">Once you’ve added the blocks, double-check them against <a href="ch19.xhtml#ch19fig7">Figure 19-7</a>, and then you can test it out.</p>
<h4 class="h4" id="lev195"><span class="orange"><strong>Testing Your Script</strong></span></h4>
<p class="noindent">To start a script in Scratch, you use the green flag block, <img src="../images/f0239-02.jpg" alt="image"/>. This block will start your game and synchronize all the scripts in your sprites. When you click the green flag icon at the top right of the stage section, Scratch starts all the scripts that are under this block.</p>
<p class="indent">Click the green flag icon <img src="../images/f0239-03.jpg" alt="image"/> at the upper-right corner of the stage now. Test that the sprite moves appropriately by pressing the pushbuttons and arrow keys. When you have everything working, move on to the timer.</p>
<h4 class="h4" id="lev196"><span epub:type="pagebreak" id="page_240"/><span class="orange"><strong>Creating the Countdown Timer</strong></span></h4>
<p class="noindent">The player needs to know how much time they have left to catch bananas, so next you’ll create a countdown timer.</p>
<p class="indent">To add the timer to your game, select the <span class="literal">Monkey2</span> sprite, and then add the blocks in <a href="ch19.xhtml#ch19fig8">Figure 19-8</a> to the Script Area. You may notice you can’t find the <span class="codestrong">show variable</span> block. That’s because you need to create the variable to hold the time. To create variables, navigate to the <strong>Data</strong> blocks category, and click the <strong>Make a Variable</strong> button. Call the new variable <span class="codestrong">time</span> and make it available for all sprites by checking the <strong>For all sprites</strong> box. Now drag that block into the Script Area.</p>
<div class="image"><a id="ch19fig8"/><img src="../images/f0240-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 19-8:</strong> Blocks to create a countdown timer</p>
<p class="indent">To create the countdown timer, you’ll use a block called <span class="codestrong">timer</span>. This block counts the time that has passed since the script started. When you click the green flag icon, the script resets the timer, so it starts counting from 0 every time you start the game. Next you include a block that shows the <span class="literal">time</span> variable on the stage. You can position the <span class="literal">time</span> variable by dragging it across the stage section; move it to the stage’s top-right corner.</p>
<p class="indent">Next, the <span class="codestrong">forever</span> loop keeps updating the <span class="literal">time</span> variable so that it starts at 30 and decreases by one every second. You use the <span class="codestrong">round</span> block so the countdown time is shown only in integer numbers. If you want to change your game duration, you can adjust the number in the <span class="codestrong">round</span> block.</p>
<p class="indent">Pay careful attention to the nesting here (see <a href="ch19.xhtml#ch19fig9">Figure 19-9</a>); you’ll notice that the <span class="codestrong">set time to</span> block comes first, then the <span class="codestrong">round</span> block. Then, on top of that, you need to drop the green <span class="codestrong">-</span> block with two empty circles. Inside the first empty circle, enter <span class="codestrong">30</span>, and inside the second empty circle, drop a <span class="codestrong">timer</span> block from the <strong>Sensing</strong> category.</p>
<div class="image"><span epub:type="pagebreak" id="page_241"/><a id="ch19fig9"/><img src="../images/f0241-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 19-9:</strong> The nested <span class="codestrong">if</span> block</p>
<p class="indent">The <span class="codestrong">if</span> block at the end (see <a href="ch19.xhtml#ch19fig8">Figure 19-8</a>) hides the <span class="literal">time</span> variable from the stage when <span class="literal">time</span> hits 0. Now try it out!</p>
<h4 class="h4" id="lev197"><span class="orange"><strong>Counting and Displaying the Score</strong></span></h4>
<p class="noindent">To create the score system, first you need to create a variable to keep track of the score. In the <strong>Data</strong> blocks category, create a new variable called <span class="literal">score</span> and make it available for all sprites. Select the <span class="literal">Monkey2</span> sprite, and then add the blocks in <a href="ch19.xhtml#ch19fig10">Figure 19-10</a> to the scripts area.</p>
<div class="image"><a id="ch19fig10"/><img src="../images/f0241-02.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 19-10:</strong> Blocks to display the score and stop the game</p>
<p class="indent">Set the <span class="codestrong">set score to</span> block to <span class="literal">0</span> so your score will restart when the game starts. Then add the <span class="codestrong">show variable</span> block to display the score on the stage.</p>
<p class="indent">At the end of the game, when the time hits 0, the monkey should say the score in a speech bubble and all the scripts will stop, ending the game. To make the monkey talk, add some purple <strong>Looks</strong> blocks to show a speech bubble—you can enter whatever text you want your monkey to say here.</p>
<p class="indent">Again, be careful with the nesting here, and look at <a href="ch19.xhtml#ch19fig10">Figure 19-10</a> carefully.</p>
<h4 class="h4" id="lev198"><span class="orange"><strong>Making the Bananas Fall from the Sky</strong></span></h4>
<p class="noindent">Now that you’ve created all the <span class="literal">Monkey2</span> animations and controls, you need to set the <span class="literal">Bananas</span> sprite to fall from the sky. Here’s the to-do list for the <span class="literal">Bananas</span> sprite:</p>
<ul>
<li class="noindent">The bananas should fall from the sky, starting from a random x-position and then decreasing in y-position until they hit the floor.</li>
<li class="noindent">The bananas should disappear when they hit the floor.</li>
<li class="noindent"><span epub:type="pagebreak" id="page_242"/>When the bananas touch the monkey, a sound should play, one point should be added to the score, and the bananas should disappear.</li>
<li class="noindent">All the bananas should be deleted when the time hits 0, so they don’t continue to fall after the game is over.</li>
</ul>
<p class="indent">First you need to add a sound from the Sound Library to the blocks section.</p>
<h5 class="h5"><strong>Adding a Sound from the Sound Library</strong></h5>
<p class="noindent">You’ll add a pop sound to the <span class="literal">Bananas</span> sprite to play when it hits the <span class="literal">Monkey2</span> sprite. For that, select the <span class="literal">Bananas</span> sprite, and in the blocks section select the <strong>Sounds</strong> tab. Then click the <img src="../images/f0242-01.jpg" alt="image"/> icon to choose a sound from the Sound Library and choose <span class="literal">pop</span>. Select the <strong>Scripts</strong> tab to add your action blocks.</p>
<h5 class="h5"><strong>Making the Bananas Fall</strong></h5>
<p class="noindent">To accomplish everything in the to-do list, select the <span class="literal">Bananas</span> sprite, and then add the blocks in <a href="ch19.xhtml#ch19fig11">Figure 19-11</a> to its scripts area.</p>
<div class="image"><a id="ch19fig11"/><img src="../images/f0242-02.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 19-11:</strong> Blocks for creating and controlling the <span class="literal">Bananas</span> sprite</p>
<p class="indent">With the upper-left set of blocks <span class="ent">➊</span> in <a href="ch19.xhtml#ch19fig11">Figure 19-11</a>, you create a clone of the <span class="literal">Bananas</span> sprite every second. In other words, you make a new <span class="literal">Bananas</span> sprite appear every second.</p>
<p class="indent"><span epub:type="pagebreak" id="page_243"/>In the set of blocks to the right <span class="ent">➌</span>, you initialize the values for the <span class="literal">Bananas</span> clones. The <span class="codestrong">show</span> block ensures that the bananas appear on the screen. You set the bananas’ y-position to 170, which corresponds to the top of the Stage, and set the x-position to a random number between –230 and 230, which is the horizontal Stage space from left to right.</p>
<p class="indent">Then you initialize a <span class="codestrong">repeat until</span> block, which is like a <span class="literal">while</span> loop that is active until the <span class="literal">time</span> variable hits 0. The <span class="codestrong">change y by</span> block inside the <span class="codestrong">repeat until</span> block decreases the y-position of the bananas so they look like they’re falling from the sky. In this case, we’re decreasing the y-position by 5. If you want to make them fall faster, increase the y-value; if you want them to fall more slowly, decrease it.</p>
<p class="indent">The first <span class="codestrong">if</span> block inside the <span class="codestrong">repeat until</span> block makes the bananas disappear when they reach the bottom of the stage, at y &lt; –160. The second <span class="codestrong">if</span> block adds one point to the <span class="literal">score</span> variable and plays the <span class="literal">pop</span> sound when the bananas hit the monkey, and makes the bananas disappear. Finally, when the <span class="codestrong">repeat until</span> block is over, the <span class="literal">Bananas</span> clones are hidden from the stage.</p>
<p class="indent">The blocks in the lower left <span class="ent">➋</span> of <a href="ch19.xhtml#ch19fig11">Figure 19-11</a> stop the creation of new <span class="literal">Bananas</span> clones when the <span class="literal">time</span> variable hits 0.</p>
<h4 class="h4" id="lev199"><span class="orange"><strong>Adding the Rotten Bananas</strong></span></h4>
<p class="noindent">You now have the monkey, the good bananas, the timer, and the score. You’re just missing the rotten bananas. The script for the rotten bananas is really similar to the script in <a href="ch19.xhtml#ch19fig11">Figure 19-11</a>; you just need to make these changes:</p>
<ul>
<li class="noindent">Create rotten bananas every 2 seconds instead of 1.</li>
<li class="noindent">Decrease the score by one when the rotten bananas touch the monkey.</li>
<li class="noindent">Play a different sound when the monkey touches the rotten bananas. We’ve chosen the sound called <span class="literal">F elec bass</span>.</li>
<li class="noindent">Change how the rotten bananas look.</li>
</ul>
<p class="indent">Because this script is so similar to the previous one, you’re going to duplicate the good bananas and then make the changes. Right-click the <span class="literal">Bananas</span> sprite and select <strong>duplicate</strong>. The sprite and its script should be duplicated and automatically named <span class="literal">Bananas2</span>. Right-click the <span class="literal">Bananas2</span> sprite and select <strong>info</strong>; a menu should <span epub:type="pagebreak" id="page_244"/>appear that allows you to change the sprite’s name. Enter <span class="literal">Rotten</span> as the new name. The changes you need to make to the script are highlighted in <a href="ch19.xhtml#ch19fig12">Figure 19-12</a>.</p>
<div class="image"><a id="ch19fig12"/><img src="../images/f0244-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 19-12:</strong> Blocks for controlling the rotten bananas</p>
<p class="indent">Change the <span class="codestrong">wait</span> block value to <span class="literal">2</span> <span class="ent">➊</span>, so a new <span class="literal">Rotten</span> clone will fall every 2 seconds, instead of every second. Also change the sound block to play <span class="literal">F elec bass</span> <span class="ent">➋</span>, and in the <span class="codestrong">set score to</span> block, reduce the score by <span class="literal">1</span> <span class="ent">➌</span>. Remember that you have to add this sound from the library in the Sounds tab first.</p>
<p class="indent">With the script for rotten bananas complete, next you’ll change the <span class="literal">Rotten</span> sprite colors so that the bananas look rotten. Select the <span class="literal">Rotten</span> sprite and click the <strong>Costumes</strong> tab. The Paint Editor screen should appear (see <a href="ch19.xhtml#ch19fig13">Figure 19-13</a>).</p>
<p class="indent">On the right side of the window, select the bucket icon <span class="ent">➊</span>; then, at the bottom, select different colors <span class="ent">➋</span> to fill each individual banana with a different color. Choose colors like brown, olive green, and dark green to show that they’re rotten.</p>
<div class="image"><span epub:type="pagebreak" id="page_245"/><a id="ch19fig13"/><img src="../images/f0245-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 19-13:</strong> Editing the <strong>Rotten</strong> sprite colors</p>
<h3 class="h3" id="lev200"><span class="orange"><strong>PLAYING THE GAME</strong></span></h3>
<p class="noindent">Congratulations! Your game is ready. To play the game in fullscreen, click the fullscreen icon at the top-left corner of the stage, and then click the green flag icon. Playing the game in fullscreen makes it run smoother and quicker.</p>
<p class="indent">Remember that you can use either the pushbuttons or the keyboard keys to play the game. When the game is over, just click the green flag icon to restart.</p>
<h3 class="h3" id="lev201"><span epub:type="pagebreak" id="page_246"/><span class="orange"><strong>TAKING IT FURTHER</strong></span></h3>
<p class="noindent">This project was just a glimpse of what you can do with Scratch. Here are some ideas to improve this game:</p>
<ul>
<li class="noindent">Increase the bananas’ falling speed as the game progresses.</li>
<li class="noindent">Increase the number of rotten bananas as the game progresses.</li>
<li class="noindent">Make this game multiplayer by creating another sprite with different controls. (You’ll need to add another <span class="literal">score</span> variable to hold player 2’s score.)</li>
<li class="noindent">Add other electronics to your circuit that you can interface with Scratch, like buttons, buzzers, or sensors.</li>
</ul>
<p class="indent">Have fun and create your own games!</p>


<h2 class="h2" id="ch20"><span epub:type="pagebreak" id="page_247"/><strong>20<br/>Wi-Fi Remote-Controlled Robot</strong></h2>
<p class="noindent"><span class="orange">In this project you’re going to build a two-wheel, battery-powered robot with a Raspberry Pi Zero W and the MotoZero add-on. You can control it over Wi-Fi using a web app you’ll make with Node-RED.</span></p>
<div class="image"><span epub:type="pagebreak" id="page_248"/><img src="../images/f0248-01.jpg" alt="image"/></div>
<p class="cap"><span class="orange"><strong>PARTS REQUIRED</strong></span></p>
<p class="cap1">Raspberry Pi Zero W (or other 40 GPIO Raspberry Pi)</p>
<p class="cap1">Smart robot car chassis kit</p>
<p class="cap1">MotoZero add-on board (or other motor controller add-on)</p>
<p class="cap1">Four AA batteries</p>
<p class="cap1">Portable charger</p>
<p class="cap1">Jumper wires</p>
<p class="cap"><span class="orange"><strong>SOFTWARE REQUIRED</strong></span></p>
<p class="cap1">Node-RED dashboard</p>
<h3 class="h3" id="lev202"><span epub:type="pagebreak" id="page_249"/><span class="orange"><strong>PROJECT OUTLINE</strong></span></h3>
<p class="noindent">Rather than going straight into the project, we’ll highlight the most important parts of the robot to give you an idea of how it will all work.</p>
<p class="noindentt"><span class="orange"><strong>Wi-Fi</strong></span></p>
<p class="noindent1">You’ll control the robot with a Node-RED application, so your Raspberry Pi needs to have Wi-Fi. Raspberry Pi models 3 and Zero W have built-in Wi-Fi, but if your board doesn’t, you can use a Wi-Fi dongle compatible with the Pi.</p>
<p class="noindentt"><span class="orange"><strong>Raspberry Pi Board</strong></span></p>
<p class="noindent1">We’re using the Raspberry Pi Zero W because its small size makes it perfect for the small robot chassis. But any Raspberry Pi version with 40 GPIOs is compatible with this project as long as it has Wi-Fi.</p>
<p class="noindentt"><span class="orange"><strong>Robot Chassis Kit</strong></span></p>
<p class="noindent1">We’re using a robot chassis kit that comes with everything you need to build the robot, including wheels, motors, and screws. You can find the kit in online marketplaces like Amazon or eBay by searching for <em>Smart Car Robot Chassis Kit</em>. You need the kit with two DC motors.</p>
<p class="noindentt"><span class="orange"><strong>MotoZero Add-on</strong></span></p>
<p class="noindent1">The DC motors will make the robot move, and you’ll control them using an add-on board called MotoZero. One place to find the board is online at The Pi Hut (<em><a href="https://thepihut.com/motozero/">https://thepihut.com/motozero/</a></em>). You can also use any other Raspberry Pi–compatible motor driver add-on for this project or build a circuit with the LC293D IC chip. We won’t cover how to build that circuit here, but there are plenty of tutorials online if you want to make your own.</p>
<p class="noindentt"><span class="orange"><strong>Power</strong></span></p>
<p class="noindent1">We don’t want to connect the Pi robot to a wall socket, because we want it to be portable, so we need to power the robot with a portable charger, or <em>power bank</em>. The power bank must be capable of outputting 5 V and 2 A. We tested this project with a power bank that has 2,200 mAh capacity and it worked fine; incorporating a power bank with more capacity will make the robot run for longer.</p>
<p class="indent1">The DC motors need to be powered independently from the Pi, meaning you need two independent power sources. To power up the motors, we’re using the battery holder that comes with the chassis kit along with four AA batteries, not included in the kit.</p>
<p class="noindentt"><span epub:type="pagebreak" id="page_250"/><span class="orange"><strong>Node-RED Application</strong></span></p>
<p class="noindent1">The Node-RED application you’ll use to control your robot should be able to make the robot go forward and backward, move right and left, and stop. Since you’re not running the Pi as a desktop computer, the Pi needs to automatically start Node-RED when it boots. You’ll also add an off button to the application so you can turn the Raspberry Pi off remotely.</p>
<p class="indentt"><a href="ch20.xhtml#ch20fig1">Figure 20-1</a> shows a high-level overview of how your robot will work.</p>
<div class="image"><a id="ch20fig1"/><img src="../images/f0250-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 20-1:</strong> The robot structure</p>
<h3 class="h3" id="lev203"><span class="orange"><strong>PREPARING THE RASPBERRY PI</strong></span></h3>
<p class="noindent">We’re using the Raspberry Pi Zero W board, shown in <a href="ch20.xhtml#ch20fig2">Figure 20-2</a>, which is a variant of Raspberry Pi Zero that has built-in wireless LAN and Bluetooth, but remember that you can use another Wi-Fi compatible board or a Wi-Fi dongle. The Raspberry Pi Zero W measures only 2.56 inches × 1.18 inches × 0.20 inches (65 mm × 30 mm × 5 mm) and costs around $10.</p>
<p class="indent">The Pi Zero has 40 GPIO pins with the same pinout as the Pi 3. As you can see in <a href="ch20.xhtml#ch20fig2">Figure 20-2</a>, it features a mini HDMI connector and two micro USB connectors, one of which is used exclusively for power. To use the Pi Zero as a desktop computer, you need a few extra accessories like a USB hub, a USB-to-micro-USB adapter, and an HDMI-to-mini-HDMI adapter to connect the peripherals. To save <span epub:type="pagebreak" id="page_251"/>you some money, we’ll prepare everything on our regular Raspberry Pi 3 and then switch the micro SD card to the Pi Zero W.</p>
<div class="image"><a id="ch20fig2"/><img src="../images/f0251-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 20-2:</strong> Raspberry Pi Zero W</p>
<p class="indent">We recommend using a new micro SD card for this project. Refer to <a href="ch00.xhtml#lev10">“Uploading the Operating System”</a> on <a href="ch00.xhtml#page_10">page 10</a> to see how to install the latest Raspbian release on your new micro SD card.</p>
<p class="indent">After installing the operating system, insert the micro SD card on your regular Pi. Power up the Pi and wait a few seconds for the system to start. Then configure the Wi-Fi from the desktop’s top-right corner by clicking <strong>Wi-Fi</strong>. Next, enter your Wi-Fi password, and wait a few seconds for the Wi-Fi connection to successfully establish.</p>
<p class="indent">The Node-RED software is preinstalled on the Pi’s operating system, but you still need to install the Node-RED dashboard. For that, first update the library repositories, and then install npm (Node Package Management) by entering the following at your command line:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~ $ <span class="codestrong">sudo apt update</span><br/>pi@raspberrypi:~ $ <span class="codestrong">sudo apt install npm</span></p>
</div>
<p class="indent">When prompted, type <span class="codestrong">Y</span> and press <small>ENTER</small>. The installation may take a few minutes. Then enter the following commands to upgrade npm to the latest 3.x version, which is the version recommended for use with Node-RED:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~ $ <span class="codestrong">sudo npm install -g npm@3.x</span><br/>pi@raspberrypi:~ $ <span class="codestrong">hash –r</span></p>
</div>
<p class="indent">Finally, enter the following to install the Node-RED dashboard:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~ $ <span class="codestrong">sudo npm install --unsafe-perm -g node-red-dashboard</span></p>
</div>
<p class="indent">Again, Node-RED needs to start automatically when the Pi boots. For that, enter the following command in the terminal.</p>
<div class="box">
<p class="programs"><span epub:type="pagebreak" id="page_252"/>pi@raspberrypi:~ $ <span class="codestrong">sudo systemctl enable nodered.service</span></p>
</div>
<p class="indent">With that done, shut down your Pi and switch the micro SD card to the Raspberry Pi Zero W.</p>
<h3 class="h3" id="lev204"><span class="orange"><strong>WIRING THE CIRCUIT</strong></span></h3>
<p class="noindent">To build the robot structure you need a chassis for the robot, two DC motors with corresponding wheels, the MotoZero add-on, jumper wires, and your Pi (with Wi-Fi). Use <a href="ch20.xhtml#ch20fig1">Figure 20-1</a> as a reference. We’ll start by mounting the MotoZero at the top of the Raspberry Pi and then wire the motors to MotoZero.</p>
<h4 class="h4" id="lev205"><span class="orange"><strong>Wiring the DC Motors to MotoZero</strong></span></h4>
<p class="noindent">MotoZero allows you to control four motors independently, but you need to control just two DC motors. The MotoZero will come unassembled, so you need to solder its parts. The Pi Hut provides an assembly manual on the product’s page, so go to <em><a href="https://thepihut.com/motozero/">https://thepihut.com/motozero/</a></em> and follow the instructions there before continuing. Your MotoZero should look like <a href="ch20.xhtml#ch20fig3">Figure 20-3</a> after assembly.</p>
<div class="image"><a id="ch20fig3"/><img src="../images/f0252-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 20-3:</strong> Assembled MotoZero add-on</p>
<p class="indent"><a href="ch20.xhtml#ch20fig3">Figure 20-3</a> shows the connections you can make to MotoZero: positive (+) and negative (–) connections for four DC motors, and a positive (+) and negative (–) connection for the power supply. You need an external power source for driving the motors. The motors require a big jump in current to move, so using a separate power source prevents the Pi from suddenly losing power when this jump occurs.</p>
<p class="indent">Follow these instructions and refer to <a href="ch20.xhtml#ch20fig1">Figure 20-1</a> to wire the motors and battery holder.</p>
<ol>
<li class="noindent"><p class="list">Connect the right DC motor’s red wire to the Motor 1 positive (+) pin on the MotoZero, and its black wire to the Motor 1 negative (–) pin. You’ll need to loosen the screws, place the wires in the pin slot, and then tighten the screws again.</p></li>
<li class="noindent"><p class="list"><span epub:type="pagebreak" id="page_253"/>Repeat the previous instruction for the left motor, connecting the power wires to the MotoZero Motor 2 connections.</p></li>
<li class="noindent"><p class="list">Without inserting the batteries, connect the battery holder’s red wire to the positive (+) pin on the MotoZero power connector and its black wire to the negative (–) pin, shown at the bottom of the board in <a href="ch20.xhtml#ch20fig3">Figure 20-3</a>.</p></li>
</ol>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>If you find the robot’s wheels are spinning in the opposite direction of what you intended, you may have to switch the DC motors’ red wires with the black wires on the positive (+) and negative (–) Motor 1 or Motor 2 terminals. You’ll know if you need to do this when you test the application at the end of the project.</em></p>
</div>
<h4 class="h4" id="lev206"><span class="orange"><strong>Controlling the Motors with MotoZero</strong></span></h4>
<p class="noindent">Each DC motor has three GPIO pins associated with it. One pin, known as the <em>enable</em> pin, enables the motor and is like an on and off switch. The other two pins control the power to the positive and negative motor wires. Applying power to one wire and GND to the other makes the motor turn in one direction, while applying power and GND to the opposite motor wires moves the motor in the opposite direction.</p>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>For information about the Motor 3 and Motor 4 GPIOs, you can check the MotoZero manual at The Pi Hut’s product page</em> (<a href="https://thepihut.com/motozero/">https://thepihut.com/motozero/</a>).</p>
</div>
<p class="indent">We’re just using the Motor 1 and Motor 2 terminals, which are controlled by the GPIOs shown in the following table, when you mount the MotoZero on the top of the Pi.</p>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="border_th-r"><p class="tab_th"><strong>MOTOR 1</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>MOTOR 2</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">enable: GPIO 5</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">enable: GPIO 6</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">Motor 1 (+): GPIO 27</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">Motor 2 (+): GPIO 22</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">Motor 1 (–): GPIO 24</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">Motor 2 (–): GPIO 17</span></p></td>
</tr>
</tbody>
</table>
<p class="indent">To make a motor spin, the enable pin must be HIGH to turn the motor on, and one—and only one—of the positive or negative pins should be HIGH. For example, if you want Motor 1 to spin in one direction, use the following setup:</p>
<ul>
<li class="noindent">GPIO 5: HIGH</li>
<li class="noindent">GPIO 27: HIGH</li>
<li class="noindent">GPIO 24: LOW</li>
</ul>
<p class="indent">To make the same motor spin in the opposite direction, use this:</p>
<ul>
<li class="noindent">GPIO 5: HIGH</li>
<li class="noindent">GPIO 27: LOW</li>
<li class="noindent">GPIO 24: HIGH</li>
</ul>
<p class="indent">To turn off the motor, you’d send a LOW signal to all the GPIOs. The same logic applies to the other motors.</p>
<h3 class="h3" id="lev207"><span epub:type="pagebreak" id="page_254"/><span class="orange"><strong>WRITING THE APPLICATION</strong></span></h3>
<p class="noindent">Once you’ve built your hardware, it’s time to create the Node-RED application. As your Pi is already in your robot chassis, the most practical way to create the robot Node-RED application is to use your regular desktop or laptop computer and control it from there.</p>
<p class="indent">First you’ll need to find your Raspberry Pi Zero W IP address; you’ll use it to access the Pi’s Node-RED application dashboard, where you can create a robot application.</p>
<p class="indent">You need to make sure the Raspberry Pi is turned on and that your computer and Pi are connected to the same network before continuing.</p>
<h4 class="h4" id="lev208"><span class="orange"><strong>Finding the Raspberry Pi IP Address</strong></span></h4>
<div class="note">
<p class="notet"><span class="red"><strong>WARNING</strong></span></p>
<p class="notep"><em>The Raspberry Pi Zero W has two mini USB ports, and one of them, labeled</em> PWR IN, <em>is designated for powering up the Pi.</em></p>
</div>
<p class="noindent">Power up the Raspberry Pi by connecting the 5 V power adapter to a wall socket. You’ll only use this power source while creating the Node-RED application; once it’s ready, you should change to the portable power source.</p>
<p class="indent">You’ll find the Pi’s IP address using Angry IP Scanner software. Download it onto your regular desktop or laptop computer for free from <em><a href="http://angryip.org/download/">http://angryip.org/download/</a></em>, and then follow the prompts to install it.</p>
<p class="indent">Once the installation is complete, open Angry IP Scanner and click the <strong>Start</strong> button. Wait a few seconds until it shows the available IP addresses. Your Pi IP address should have <em>raspberrypi.lan</em> as a hostname, so jot down the corresponding IP address. <a href="ch20.xhtml#ch20fig4">Figure 20-4</a> highlights our Raspberry Pi IP address, which is 192.168.1.122.</p>
<div class="image"><a id="ch20fig4"/><img src="../images/f0254-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 20-4:</strong> Finding the Raspberry Pi IP address with the Angry IP Scanner software</p>
<h4 class="h4" id="lev209"><span epub:type="pagebreak" id="page_255"/><span class="orange"><strong>Creating the Node-RED Flow</strong></span></h4>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>For an introduction to Node-RED, see <a href="ch17.xhtml#ch17">Project 17</a>.</em></p>
</div>
<p class="noindent">On your regular computer, making sure it’s on the same network as your Pi, open a web browser tab and go to <em>http://&lt;Pi IP address&gt;:1880</em>, replacing <em>&lt;Pi IP address&gt;</em> with the Raspberry Pi IP address you noted earlier. In our case, we navigated to <em>http://192.168.1.122:1880</em>. Your Raspberry Pi Node-RED web server should open.</p>
<p class="indent">In the top-right corner of the window, select the <strong>dashboard</strong> tab and, inside the <strong>Layout</strong> tab, create a tab called <strong>Robot</strong>. Next, create two groups inside that Robot tab, called <strong>Main</strong> and <strong>Poweroff</strong>. The Main group is where you’ll organize the buttons that control the robot, and the Poweroff group is where you’ll add the button to remotely turn off your Raspberry Pi. Once you’ve completed these tabs and groups, your layout should look like <a href="ch20.xhtml#ch20fig5">Figure 20-5</a>.</p>
<div class="image"><a id="ch20fig5"/><img src="../images/f0255-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 20-5:</strong> Node-RED application dashboard layout</p>
<p class="indent">Add five buttons, a function, six rpi gpio output nodes, and an exec node to the flow. Wire the nodes and edit their names to match the ones in <a href="ch20.xhtml#ch20fig6">Figure 20-6</a>.</p>
<div class="image"><a id="ch20fig6"/><img src="../images/f0255-02.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 20-6:</strong> Node-RED application nodes</p>
<p class="indent"><span epub:type="pagebreak" id="page_256"/>Edit the function’s properties so that it has six outputs, assigning all of the nodes’ properties as shown in <a href="ch20.xhtml#ch20tab1">Table 20-1</a>.</p>
<p class="tabcap" id="ch20tab1"><strong>TABLE 20-1:</strong> Properties assigned to each node</p>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="border_th-r"><p class="tab_th"><strong>NODE</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>PROPERTIES</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">Forward</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">Group: Main [Robot]<br/>Size: auto<br/>Icon: fa-arrow-up<br/>Label: Forward<br/>Payload: forward</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">Left</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">Group: Main [Robot]<br/>Size: auto<br/>Icon: fa-arrow-left<br/>Label: Left<br/>Payload: left</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">Right</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">Group: Main [Robot]<br/>Size: auto<br/>Icon: fa-arrow-right<br/>Label: Right<br/>Payload: right</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">Reverse</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">Group: Main [Robot]<br/>Size: auto<br/>Icon: fa-arrow-down<br/>Label: Reverse<br/>Payload: reverse</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">Stop</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">Group: Main [Robot]<br/>Size: auto<br/>Icon: fa-hand-paper-o<br/>Label: Stop<br/>Payload: stop</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">f</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">Function: enter the code in <a href="ch20.xhtml#ch20list1">Listing 20-1</a><br/>Outputs: 6</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">Enable M1</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">GPIO: GPIO5 – 29<br/>Type: Digital output</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">+ M1</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">GPIO: GPIO27 – 13<br/>Type: Digital output</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">– M1</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">GPIO: 18 – GPIO24<br/>Type: Digital output</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">Enable M2</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">GPIO: GPIO17 – 11<br/>Type: Digital output</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">+ M2</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">GPIO: GPIO6 – 31<br/>Type: Digital output</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span epub:type="pagebreak" id="page_257"/><span class="orange">– M2</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">GPIO: GPIO22 – 15<br/>Type: Digital output</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">Poweroff</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">Group: Poweroff [Robot]<br/>Size: auto<br/>Icon: fa-power-off<br/>Label: Poweroff<br/>Background: red</span></p></td>
</tr>
<tr>
<td style="vertical-align: middle;" class="table-r"><p class="tabc"><span class="orange">exec</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="taba"><span class="orange">Command: <span class="literal">/usr/bin/sudo</span><br/>+ Append: not checked<br/>poweroff<br/>Name: Poweroff</span></p></td></tr>
</tbody>
</table>
<p class="indent"><a href="ch20.xhtml#ch20fig7">Figure 20-7</a> shows how the exec node is set up.</p>
<div class="image"><a id="ch20fig7"/><img src="../images/f0257-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 20-7:</strong> exec node properties</p>
<p class="indent">All nodes should be in the Main group, except the Poweroff button, which should be part of the Poweroff group.</p>
<h4 class="h4" id="lev210"><span class="orange"><strong>Entering the Script</strong></span></h4>
<p class="noindent">Insert the JavaScript code in <a href="ch20.xhtml#ch20list1">Listing 20-1</a> (also available for download from <em><a href="https://www.nostarch.com/RaspberryPiProject/">https://www.nostarch.com/RaspberryPiProject/</a></em>) into the function node:</p>
<p class="listing" id="ch20list1"><strong>LISTING 20-1:</strong> The remote-controlled robot script</p>
<div class="box">
<p class="programs"><span class="ent">➊</span> <span class="purple">var</span> msg1 <span class="blue">=</span> { payload: <span class="orange">0</span> };<br/>  <span class="purple">var</span> msg2 <span class="blue">=</span> { payload: <span class="orange">0</span> };<br/>  <span class="purple">var</span> msg3 <span class="blue">=</span> { payload: <span class="orange">0</span> };<br/><span epub:type="pagebreak" id="page_258"/>  <span class="purple">var</span> msg4 <span class="blue">=</span> { payload: <span class="orange">0</span> };<br/>  <span class="purple">var</span> msg5 <span class="blue">=</span> { payload: <span class="orange">0</span> };<br/>  <span class="purple">var</span> msg6 = { payload: <span class="orange">0</span> };<br/><span class="ent">➋</span> <span class="purple">if</span> (msg.payload <span class="blue">===</span> <span class="green">"forward"</span>) {<br/>     msg1.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>     msg2.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>     msg4.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>     msg5.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>  }<br/>  <span class="purple">else if</span> (msg.payload <span class="blue">===</span> <span class="green">"left"</span>) {<br/>     msg1.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>     msg2.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>  }<br/>  <span class="purple">else if</span> (msg.payload <span class="blue">===</span> <span class="green">"right"</span>) {<br/>     msg4.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>     msg5.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>  }<br/>  <span class="purple">else if</span> (msg.payload <span class="blue">===</span> <span class="green">"reverse"</span>) {<br/>     msg1.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>     msg3.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>     msg4.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>     msg6.payload <span class="blue">=</span> <span class="orange">1</span>;<br/>  }<br/><span class="ent">➌</span> <span class="purple">return</span> [msg1, msg2, msg3, msg4, msg5, msg6];</p>
</div>
<p class="indent">This function sends messages to the connected rpi gpio output nodes in the order they’re connected to the function node. This means that <span class="literal">msg1</span> is sent to the Enable M1 node, <span class="literal">msg2</span> to + M1, <span class="literal">msg3</span> to – M1, and so on (see <a href="ch20.xhtml#ch20fig6">Figure 20-6</a>).</p>
<p class="indent">First you initialize all the payload message variable values to <span class="literal">0</span> <span class="ent">➊</span>. Then the series of <span class="literal">if</span> and <span class="literal">else if</span> statements checks which button was pressed <span class="ent">➋</span>, depending on the payload received by the function, and sets the message values according to the action the robot should take. For example, if you press the Forward button, the payload received by the function node is <span class="literal">forward</span>, so the condition at <span class="ent">➋</span> is met and the code changes the <span class="literal">msg1</span>, <span class="literal">msg2</span>, <span class="literal">msg4</span>, and <span class="literal">msg5</span> payload values to <span class="literal">1</span>, while <span class="literal">msg3</span> and <span class="literal">msg6</span> remain <span class="literal">0</span>.</p>
<p class="indent">Then, the function node sends the <span class="literal">msg.payload</span> values to the corresponding nodes <span class="ent">➌</span>. For the robot to go forward, the payloads would need to be:</p>
<ul>
<li class="noindent">Enable M1: <span class="literal">1</span></li>
<li class="noindent">+ M1: <span class="literal">1</span></li>
<li class="noindent">– M2: <span class="literal">0</span></li>
<li class="noindent"><span epub:type="pagebreak" id="page_259"/>Enable M2: <span class="literal">1</span></li>
<li class="noindent">+ M2: <span class="literal">1</span></li>
<li class="noindent">– M2: <span class="literal">0</span></li>
</ul>
<p class="indent">Here, both motors are enabled and moving in the same direction—forward. The following table shows the messages the function should send to each node for each action.</p>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>ACTION</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>ENABLE M1</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>+ M1</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>– M1</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>ENABLE M2</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>+ M2</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>– M2</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">Forward</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">Left</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">0</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">Right</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">Reverse</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">1</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="orange">1</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">Stop</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
<td style="vertical-align: top;" class="table-r"><p class="tabc"><span class="orange">0</span></p></td>
</tr>
</tbody>
</table>
<p class="indent">When the Stop button is clicked, none of the conditions set in the code is met, and the function sends the values initialized at the start <span class="ent">➊</span>.</p>
<p class="indent">Outside the function node, when the Poweroff button is clicked, the exec node executes the <span class="literal">poweroff</span> command to turn off the Pi. Remember that you’ve filled the <span class="literal">exec</span> command property with <em>/usr/bin/sudo/poweroff</em>—see <a href="ch20.xhtml#ch20tab1">Table 20-1</a>.</p>
<p class="indent">Once everything is in place, click the <strong>Deploy</strong> button at the top-right corner to save the changes and run the flow.</p>
<h4 class="h4" id="lev211"><span class="orange"><strong>Running the Application</strong></span></h4>
<p class="noindent">Now your Node-RED application is ready. Go to <em>http://&lt;Pi IP address&gt;:1880/ui</em> (replacing <em>&lt;Pi IP address&gt;</em> with your own) to see your application dashboard. It should look something like <a href="ch20.xhtml#ch20fig8">Figure 20-8</a>.</p>
<p class="indent">Test the controls to see if the wheels are moving in the right direction, and don’t forget that you need to insert the four AA batteries into the battery holder in order to power the motors.</p>
<p class="indent">If one or both motors are spinning in the wrong direction, switch the black and red wires on the MotoZero for that motor terminal, or change the payload messages to match the required directions.</p>
<div class="image"><span epub:type="pagebreak" id="page_260"/><a id="ch20fig8"/><img src="../images/f0260-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 20-8:</strong> Node-RED application to remotely control the robot</p>
<h3 class="h3" id="lev212"><span class="orange"><strong>POWERING UP THE ROBOT</strong></span></h3>
<p class="noindent">Now that the application is ready, click the <strong>Poweroff</strong> button to shut down the Pi. Then wait a few seconds for it to shut down.</p>
<p class="indent">Change the Pi’s power source from the wall socket to the power bank. Wait a few minutes for the Pi to power up and autostart Node-RED. On a smartphone or other device that’s on the same network as your Pi, open a new browser tab and go to <em>http://&lt;Pi IP address&gt;:1880/ui</em>. Then click on the buttons to remotely control your robot.</p>
<p class="indent">Congratulations—you now have a Wi-Fi-controlled robot!</p>
<h3 class="h3" id="lev213"><span class="orange"><strong>TAKING IT FURTHER</strong></span></h3>
<p class="noindent">There’s a lot of room for upgrades on your robot. Here are some ideas for upgrades that will need both hardware and software changes. You’ll need to experiment a bit with Node-RED to get these working:</p>
<ul>
<li class="noindent">Get a robot chassis with four wheels and control four motors instead of two.</li>
<li class="noindent">Add LEDs and buzzers to the robot to make it more interactive.</li>
<li class="noindent">Add sensors, like an ultrasonic sensor, so the robot can avoid obstacles by itself.</li>
</ul>
</body></html>