<html><head></head><body>
<h2 class="h2" id="ch14"><span epub:type="pagebreak" id="page_139"/><strong><span class="big">14</span><br/>SUBDOMAIN TAKEOVER</strong></h2>&#13;
<div class="image1"><img alt="Image" src="../images/common.jpg"/></div>&#13;
<p class="noindent">A <em>subdomain takeover</em> vulnerability occurs when a malicious attacker is able to claim a subdomain from a legitimate site. Once the attacker controls the subdomain, they either serve their own content or intercept traffic.</p>&#13;
<h3 class="h3" id="ch14lev1sec1"><strong>Understanding Domain Names</strong></h3>&#13;
<p class="noindent">To understand how a subdomain takeover vulnerability works, we’ll first need to look at how you register and use domain names. Domains are the URLs that access websites, and they’re mapped to IP addresses by Domain Name Servers (DNS). Domains are organized as a hierarchy, and each part is separated by a period. The final part of a domain—the rightmost part—is a <em>top-level domain</em>. Examples of top-level domains include <em>.com</em>, <em>.ca</em>, <em>.info</em>, and so on. The next level up in the domain hierarchy is the domain name that people or companies register. This part of the hierarchy accesses websites. For example, let’s say <em>&lt;example&gt;.com</em> is a registered domain with a <em>.com</em> top-level domain. The next step in the hierarchy is the focus of this chapter: <em>subdomains</em>. <span epub:type="pagebreak" id="page_140"/>Subdomains comprise the leftmost part of URLs and can host separate websites on the same registered domain. For example, if Example Company had a customer-facing website but also needed a separate email website, it could have separate <em>www.&lt;example&gt;.com</em> and <em>webmail.&lt;example&gt;.com</em> subdomains. Each of these subdomains could serve its own site content.</p>&#13;
<p class="indent">Site owners can create subdomains using several methods, but the two most common methods are adding an A record or a CNAME record in a site’s DNS records. An <em>A record</em> maps a site name to one or more IP addresses. A <em>CNAME</em> should be a unique record that maps a site name to another site name. Only site administrators can create DNS records for a site (unless you find a vulnerability, of course).</p>&#13;
<h3 class="h3" id="ch14lev1sec2"><strong>How Subdomain Takeovers Work</strong></h3>&#13;
<p class="noindent">A subdomain takeover occurs when a user can control the IP addresses or URLs that an A record or a CNAME record points to. A common example of this vulnerability involves the website hosting platform Heroku. In a typical workflow, a site developer creates a new application and hosts it on Heroku. Then the developer creates a CNAME record for a subdomain of their main site and points that subdomain to Heroku. Here’s a hypothetical example where this situation can go wrong:</p>&#13;
<ol>&#13;
<li class="noindent">Example Company registers an account on the Heroku platform and doesn’t use SSL.</li>&#13;
<li class="noindent">Heroku assigns Example Company the subdomain <em><a href="http://unicorn457.herokuapp.com">unicorn457.herokuapp.com</a></em> for its new application.</li>&#13;
<li class="noindent">Example Company creates a CNAME record with its DNS provider pointing the subdomain <em>test.&lt;example&gt;.com</em> to <em><a href="http://unicorn457.herokuapp.com">unicorn457.herokuapp.com</a></em>.</li>&#13;
<li class="noindent">After a couple of months, Example Company decides to remove its <em>test.&lt;example&gt;.com</em> subdomain. It closes its Heroku account and deletes the site content from its servers. But it doesn’t delete the CNAME record.</li>&#13;
<li class="noindent">A malicious person notices the CNAME record pointing to an unregistered URL on Heroku and claims the domain <em>unicorn457.heroku.com</em>.</li>&#13;
<li class="noindent">The attacker can now serve their own content from <em>test.&lt;example&gt;.com</em>, which appears to be a legitimate Example Company site because of the URL.</li>&#13;
</ol>&#13;
<p class="indent">As you can see, this vulnerability often occurs when a site doesn’t delete a CNAME (or an A record) pointing to an external site that an attacker can claim. Commonly used external services that have been associated with subdomain takeovers include Zendesk, Heroku, GitHub, Amazon S3, and SendGrid.</p>&#13;
<p class="indent">The impact of a subdomain takeover depends on the configuration of the subdomain and parent domain. For example, in “Web Hacking Pro Tips #8” (<em><a href="https://www.youtube.com/watch?v=76TIDwaxtyk">https://www.youtube.com/watch?v=76TIDwaxtyk</a></em>), Arne Swinnen describes how cookies can be scoped so browsers send stored cookies to <span epub:type="pagebreak" id="page_141"/>only the appropriate domain. But a cookie can be scoped so browsers send cookies to all subdomains by specifying the subdomain only as a period, such as in the value <em>.&lt;example&gt;.com</em>. When a site has this configuration, browsers will send <em>&lt;example&gt;.com</em> cookies to any Example Company subdomain a user visits. If an attacker controls <em>test.&lt;example&gt;.com</em>, they could steal <em>&lt;example&gt;.com</em> cookies from targets who visit the malicious <em>test.&lt;example&gt;.com</em> subdomain.</p>&#13;
<p class="indent">Alternatively, if the cookies aren’t scoped this way, a malicious attacker could still create a site on the subdomain that mimics the parent domain. If the attacker includes a login page on the subdomain, they could potentially phish users into submitting their credentials. Two common attacks are made possible by subdomain takeovers. But in the following examples, we’ll also look at other attacks, such as email intercepts.</p>&#13;
<p class="indent">Finding subdomain takeover vulnerabilities involves looking up the DNS records for a site. A great way to do this is to use the KnockPy tool, which enumerates subdomains and searches for common subdomain takeover related error messages from services like S3. KnockPy comes with a list of common subdomains to test, but you can also provide your own list of subdomains. The GitHub repository SecLists (<em><a href="https://github.com/danielmiessler/SecLists/">https://github.com/danielmiessler/SecLists/</a></em>) also lists commonly found subdomains among its many other security-related lists.</p>&#13;
<h3 class="h3" id="ch14lev1sec3"><strong>Ubiquiti Subdomain Takeover</strong></h3>&#13;
<p class="hangt"><strong>Difficulty:</strong> Low</p>&#13;
<p class="hang"><strong>URL:</strong> <em>http://assets.goubiquiti.com/</em></p>&#13;
<p class="hang"><strong>Source:</strong> <em><a href="https://hackerone.com/reports/109699/">https://hackerone.com/reports/109699/</a></em></p>&#13;
<p class="hang"><strong>Date reported:</strong> January 10, 2016</p>&#13;
<p class="hangb"><strong>Bounty paid:</strong> $500</p>&#13;
<p class="noindent">Amazon Simple Storage, or S3, is a file hosting service provided by Amazon Web Services (AWS). An account on S3 is a <em>bucket</em> that you can access using a special AWS URL, which begins with the bucket name. Amazon uses a global namespace for its bucket URLs, which means that once someone registers a bucket, no one else can register it. For example, if I registered the bucket <em>&lt;example&gt;</em>, it would have the URL <em>&lt;example&gt;.s3.amazonaws.com</em> and I would own it. Amazon also allows users to register any name they want as long as it hasn’t already been claimed, meaning an attacker can claim any unregistered S3 bucket.</p>&#13;
<p class="indent">In this report, Ubiquiti created a CNAME record for <em>assets.goubiquiti.com</em> and pointed it to the S3 bucket <em>uwn-images</em>. This bucket was accessible via the URL <em>uwn-images.s3.website.us-west-1.amazonaws.com</em>. Because Amazon has servers around the world, the URL includes information about the Amazon geographical region where the bucket is located. In this case, <em>us-west-1</em> is Northern California.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_142"/>But Ubiquiti either hadn’t registered the bucket or had removed it from its AWS account without deleting the CNAME record. So, visiting <em>assets.goubiquiti.com</em> would still attempt to serve content from S3. As a result, a hacker claimed the S3 bucket and reported the vulnerability to Ubiquiti.</p>&#13;
<h4 class="h4" id="ch14lev2sec1"><strong><em>Takeaways</em></strong></h4>&#13;
<p class="noindent">Keep an eye out for DNS entries that point to third-party services like S3. When you find such entries, confirm whether the company has properly configured that service. In addition to doing an initial check on a website’s DNS records, you can continually monitor entries and services using automated tools like KnockPy. It’s best to do so just in case a company removes a subdomain but forgets to update its DNS records.</p>&#13;
<h3 class="h3" id="ch14lev1sec4"><strong>Scan.me Pointing to Zendesk</strong></h3>&#13;
<p class="hangt"><strong>Difficulty:</strong> Low</p>&#13;
<p class="hang"><strong>URL:</strong> <em>http://support.scan.me/</em></p>&#13;
<p class="hang"><strong>Source:</strong> <em><a href="https://hackerone.com/reports/114134/">https://hackerone.com/reports/114134/</a></em></p>&#13;
<p class="hang"><strong>Date reported:</strong> February 2, 2016</p>&#13;
<p class="hangb"><strong>Bounty paid:</strong> $1,000</p>&#13;
<p class="noindent">The Zendesk platform offers customer support service on a website’s subdomain. For instance, if Example Company used Zendesk, its associated subdomain might be <em>support.&lt;example&gt;.com</em>.</p>&#13;
<p class="indent">Similar to the previous Ubiquiti example, owners of the site <em>scan.me</em> created a CNAME record pointing <em>support.scan.me</em> to <em><a href="http://scan.zendesk.com">scan.zendesk.com</a></em>. Later, Snapchat acquired <em>scan.me</em>. Close to the time of acquisition, <em>support.scan.me</em> released the subdomain on Zendesk but forgot to delete the CNAME record. The hacker harry_mg found the subdomain, claimed <em><a href="http://scan.zendesk.com">scan.zendesk.com</a></em>, and served his own content from Zendesk on it.</p>&#13;
<h4 class="h4" id="ch14lev2sec2"><strong><em>Takeaways</em></strong></h4>&#13;
<p class="noindent">Keep an eye out for company acquisitions that can change how a company provides services. As optimizations take place between the parent company and the acquisition, some subdomains might be deleted. Such changes could result in subdomain takeovers if companies don’t update DNS entries. Again, because subdomains can change at any time, it’s best to continually check records over time after a company announces an acquisition.</p>&#13;
<h3 class="h3" id="ch14lev1sec5"><strong>Shopify Windsor Subdomain Takeover</strong></h3>&#13;
<p class="hangt"><strong>Difficulty:</strong> Low</p>&#13;
<p class="hang"><strong>URL:</strong> <em>http://windsor.shopify.com/</em></p>&#13;
<p class="hang"><strong>Source:</strong> <em><a href="https://hackerone.com/reports/150374/">https://hackerone.com/reports/150374/</a></em></p>&#13;
<p class="hang"><span epub:type="pagebreak" id="page_143"/><strong>Date reported:</strong> July 10, 2016</p>&#13;
<p class="hangb"><strong>Bounty paid:</strong> $500</p>&#13;
<p class="noindent">Not all subdomain takeovers involve registering an account on a third-party service. In July 2016, the hacker zseano found that Shopify had created a CNAME for <em>windsor.shopify.com</em> that pointed to <em>aislingofwindsor.com</em>. He discovered this by searching for all Shopify subdomains on the site <em><a href="http://crt.sh">crt.sh</a></em>, which tracks all SSL certificates registered by a site and the subdomains the certificates are associated with. This information is available because all SSL certificates must register with a certificate authority for browsers to confirm the certificate’s authenticity when you visit their sites. The site <em><a href="http://crt.sh">crt.sh</a></em> tracks these registrations over time and makes the information available to visitors. Sites can also register wildcard certificates, which provide SSL protections to any subdomain of the site. On <em><a href="http://crt.sh">crt.sh</a></em>, this is denoted by an asterisk in the place of the subdomain.</p>&#13;
<p class="indent">When a site registers a wildcard certificate, <em><a href="http://crt.sh">crt.sh</a></em> can’t identify the subdomains where the certificate is used, but each certificate includes a unique hash value. Another site, <em><a href="http://censys.io">censys.io</a></em>, tracks certificate hashes and the subdomains they’re used on by scanning the internet. Searching <em><a href="http://censys.io">censys.io</a></em> for a wildcard certificate hash might allow you to identify new subdomains.</p>&#13;
<p class="indent">By browsing through the list of subdomains on <em><a href="http://crt.sh">crt.sh</a></em> and visiting each, zseano noticed that <em>windsor.shopify.com</em> was returning a 404 page not found error. This meant Shopify was either serving no content from the subdomain or it no longer owned <em>aislingofwindsor.com</em>. Testing the latter, zseano visited a domain registration site, searched for <em>aislingofwindsor.com</em>, and found he could buy it for $10. He did and reported the vulnerability to Shopify as a subdomain takeover.</p>&#13;
<h4 class="h4" id="ch14lev2sec3"><strong><em>Takeaways</em></strong></h4>&#13;
<p class="noindent">Not all subdomains involve the use of third-party services. If you find a subdomain that is pointed to another domain and is returning a 404 page, check whether you can register that domain. The site <em><a href="http://crt.sh">crt.sh</a></em> provides a great reference of SSL certificates registered by sites as an initial step to identifying subdomains. If wildcard certificates have been registered on <em><a href="http://crt.sh">crt.sh</a></em>, search for the certificate hash on <em><a href="http://censys.io">censys.io</a></em>.</p>&#13;
<h3 class="h3" id="ch14lev1sec6"><strong>Snapchat Fastly Takeover</strong></h3>&#13;
<p class="hangt"><strong>Difficulty:</strong> Medium</p>&#13;
<p class="hang"><strong>URL:</strong> <em>http://fastly.sc-cdn.net/takeover.html</em></p>&#13;
<p class="hang"><strong>Source:</strong> <em><a href="https://hackerone.com/reports/154425/">https://hackerone.com/reports/154425/</a></em></p>&#13;
<p class="hang"><strong>Date reported:</strong> July 27, 2016</p>&#13;
<p class="hangb"><strong>Bounty paid:</strong> $3,000</p>&#13;
<p class="noindent"><span epub:type="pagebreak" id="page_144"/>Fastly is a <em>content delivery network (CDN)</em>. A CDN stores copies of content on servers across the world so content can be delivered in a shorter time and distance for users requesting it.</p>&#13;
<p class="indent">On July 27, 2016, the hacker Ebrietas reported to Snapchat that it had a DNS misconfiguration on its domain <em>sc-cdn.net</em>. The URL <em>http://fastly.sc-cdn.net</em> had a CNAME record that pointed to a Fastly subdomain that Snapchat had not properly claimed. At the time, Fastly allowed users to register custom subdomains if users were encrypting their traffic with Transport Layer Security (TLS) and using the Fastly shared wildcard certificate to do so. Misconfiguring the custom subdomain resulted in an error message on the domain that read “Fastly error: unknown domain: <em>&lt;misconfigured domain&gt;</em>. Please check that this domain has been added to a service.”</p>&#13;
<p class="indent">Before reporting the bug, Ebrietas looked up the domain <em>sc-cdn.net</em> on <em><a href="http://censys.io">censys.io</a></em> and confirmed Snapchat’s ownership of the domain by using the registration information on the domain’s SSL certificate. This is significant because the domain <em>sc-cdn.net</em> doesn’t explicitly include any identifying information about Snapchat the way <em><a href="http://snapchat.com">snapchat.com</a></em> does. He also configured a server to receive traffic from the URL to confirm the domain was actually in use.</p>&#13;
<p class="indent">When resolving the report, Snapchat confirmed that a very small subset of users were using an old version of their app, which made requests to this subdomain for unauthenticated content. The users’ configuration was later refreshed and pointed to another URL. In theory, an attacker could have served malicious files to users for that limited amount of time through the subdomain.</p>&#13;
<h4 class="h4" id="ch14lev2sec4"><strong><em>Takeaways</em></strong></h4>&#13;
<p class="noindent">Be on the lookout for sites pointing to services that return error messages. When you find an error, confirm how those services are used by reading their documentation. Then check whether you can find misconfigurations that allow you to take over the subdomain. Additionally, always go the extra steps to confirm what you think are vulnerabilities. In this case, Ebrietas looked up the SSL certificate information to confirm that Snapchat owned the domain before reporting. Then he configured his server to receive requests, making sure Snapchat was using the domain.</p>&#13;
<h3 class="h3" id="ch14lev1sec7"><strong>Legal Robot Takeover</strong></h3>&#13;
<p class="hangt"><strong>Difficulty:</strong> Medium</p>&#13;
<p class="hang"><strong>URL:</strong> <em>https://api.legalrobot.com/</em></p>&#13;
<p class="hang"><strong>Source:</strong> <em><a href="https://hackerone.com/reports/148770/">https://hackerone.com/reports/148770/</a></em></p>&#13;
<p class="hang"><strong>Date reported:</strong> July 1, 2016</p>&#13;
<p class="hangb"><strong>Bounty paid:</strong> $100</p>&#13;
<p class="noindent">Even when sites configure their subdomains correctly on third-party services, those services may themselves be vulnerable to misconfigurations. <span epub:type="pagebreak" id="page_145"/>This is what Frans Rosen found on July 1, 2016, when he submitted a report to Legal Robot. He notified the company that he had a DNS CNAME entry for <em>api.legalrobot.com</em> pointing to <em><a href="http://Modulus.io">Modulus.io</a></em>, which he could take over.</p>&#13;
<p class="indent">As you likely recognize by now, after seeing such an error page, a hacker’s next step should be to visit the service to claim the subdomain. But attempting to claim <em>api.legalrobot.com</em> resulted in an error because Legal Robot had already claimed it.</p>&#13;
<p class="indent">Instead of walking away, Rosen tried to claim the wildcard subdomain for Legal Robot, <em>*.legalrobot.com</em>, which was available. Modulus’s configuration allowed for wildcard subdomains to override more specific subdomains, which included <em>api.legalrobot.com</em> in this case. After claiming the wildcard domain, Rosen was able to host his own content at <em>api.legalrobot.com</em>, as shown in <a href="ch14.xhtml#ch14fig01">Figure 14-1</a>.</p>&#13;
<div class="image"><a id="ch14fig01"/><img alt="image" src="../images/14fig01.jpg"/></div>&#13;
<p class="figcap"><em>Figure 14-1: HTML page source provided as a proof of concept for the subdomain takeover claimed by Frans Rosen</em></p>&#13;
<p class="indent">Note the content Rosen hosted in <a href="ch14.xhtml#ch14fig01">Figure 14-1</a>. Rather than publishing an embarrassing page stating the subdomain had been taken over, he used a nonintrusive text page with an HTML comment verifying that he was responsible for the content.</p>&#13;
<h4 class="h4" id="ch14lev2sec5"><strong><em>Takeaways</em></strong></h4>&#13;
<p class="noindent">When sites rely on third-party services to host a subdomain, they’re relying on the security of that service as well. In this case, Legal Robot thought it had properly claimed its subdomain on Modulus when in fact the service had a vulnerability that allowed wildcard subdomains to override all other subdomains. Also keep in mind that if you’re able to claim a subdomain, it’s best to use a nonintrusive proof of concept to avoid embarrassing the company you’re reporting to.</p>&#13;
<h3 class="h3" id="ch14lev1sec8"><strong>Uber SendGrid Mail Takeover</strong></h3>&#13;
<p class="hangt"><strong>Difficulty:</strong> Medium</p>&#13;
<p class="hang"><strong>URL:</strong> <em>https://em.uber.com/</em></p>&#13;
<p class="hang"><strong>Source:</strong> <em><a href="https://hackerone.com/reports/156536/">https://hackerone.com/reports/156536/</a></em></p>&#13;
<p class="hang"><strong>Date reported:</strong> August 4, 2016</p>&#13;
<p class="hangb"><strong>Bounty paid:</strong> $10,000</p>&#13;
<p class="noindent">SendGrid is a cloud-based email service. At the time of this writing, Uber was one of its customers. As the hacker Rojan Rijal was reviewing Uber’s DNS records, he noticed a CNAME record for <em>em.uber.com</em> pointing to SendGrid.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_146"/>Because Uber had a SendGrid CNAME, Rijal decided to poke around the service to confirm how Uber was configured. His first step was to confirm the services provided by SendGrid and whether it allowed for content hosting. It didn’t. Digging into the SendGrid documentation, Rijal came across a different option called white labeling. White labeling is a functionality that allows internet service providers to confirm that SendGrid has a domain’s permission to send an email on the domain’s behalf. This permission is granted by creating <em>mail exchanger (MX)</em>, records for a site that points to SendGrid. An MX record is a type of DNS record that specifies a mail server responsible for sending and receiving email on behalf of a domain. Recipient email servers and services query DNS servers for these records to verify an email’s authenticity and to prevent spam.</p>&#13;
<p class="indent">The white labeling functionality caught Rijal’s eye because it involved trusting a third-party service provider to manage an Uber subdomain. When Rijal reviewed the DNS entries for <em>em.uber.com</em>, he confirmed that an MX record was pointing to <em>mx.sendgrid.net</em>. But only site owners can create DNS records (assuming there’s no other vulnerability to abuse), so Rijal couldn’t modify Uber’s MX records directly to takeover the subdomain. Instead, he turned to SendGrid’s documentation, which described another service called Inbound Parse Webhook. This service allows customers to parse attachments and contents of incoming emails, then send the attachments to a specified URL. To use the functionality, sites need to:</p>&#13;
<ol>&#13;
<li class="noindent">Create an MX record of a domain/hostname or subdomain and point it to <em>mx.sendgrid.net</em>.</li>&#13;
<li class="noindent">Associate the domain/hostname and a URL in the parse API settings page with the Inbound Parse Webhook.</li>&#13;
</ol>&#13;
<p class="indent">Bingo. Rijal already confirmed that the MX record existed, but Uber hadn’t set up the second step. Uber hadn’t claimed the <em>em.uber.com</em> subdomain as an Inbound Parse Webhook. Rijal claimed the domain as his own and set up a server to receive the data sent by the SendGrid parse API. After confirming he could receive emails, he stopped intercepting them and reported the issue to Uber and SendGrid. As part of the fix, SendGrid confirmed that it had added an additional security check, requiring accounts to verify their domain before allowing an Inbound Parse Webhook. As a result, the security check should protect other sites from a similar exploit.</p>&#13;
<h4 class="h4" id="ch14lev2sec6"><strong><em>Takeaways</em></strong></h4>&#13;
<p class="noindent">This report demonstrates how valuable third-party documentation can be. By reading the developer documentation, learning what services SendGrid provides, and identifying how those services are configured, Rijal found a vulnerability in the third-party service that impacted Uber. It’s incredibly important to explore all functionality that third-party services offer when a target site is using their services. EdOverflow maintains a list of <span epub:type="pagebreak" id="page_147"/>vulnerable services, which you can find at <em><a href="https://github.com/EdOverflow/can-i-take-over-xyz/">https://github.com/EdOverflow/can-i-take-over-xyz/</a></em>. But even if his list identifies a service as protected, be sure to double check or look for alternative methods, like Rijal did.</p>&#13;
<h3 class="h3" id="ch14lev1sec9"><strong>Summary</strong></h3>&#13;
<p class="noindent">Subdomain takeovers can simply be caused by a site with an unclaimed DNS entry pointing to a third-party service. Examples in this chapter include Heroku, Fastly, S3, Zendesk, SendGrid, and unregistered domains, but other services are also vulnerable to this type of bug. You can find these vulnerabilities using tools like KnockPy, <em><a href="http://crt.sh">crt.sh</a></em>, and <em><a href="http://censys.io">censys.io</a></em> as well as other tools in <a href="app01.xhtml#app01">Appendix A</a>.</p>&#13;
<p class="indent">Managing a takeover might require additional ingenuity, such as when Rosen claimed a wildcard domain and Rijal registered a custom webhook. When you’ve found a potential vulnerability, but the basic methods to exploit it don’t work, be sure to read the service documentation. Additionally, explore all functionality offered regardless of whether the target site is using it or not. When you do find a takeover, be sure to provide proof of the vulnerability, but do so in a respectful and unobtrusive way.<span epub:type="pagebreak" id="page_148"/></p>&#13;
</body></html>