<html><head></head><body><div id="sbo-rt-content"><span epub:type="pagebreak" id="page_529"/>
<h2 class="h2" id="ch23"><strong><span class="big">23</span><br/>BINARY DIFFERENCING AND VERSION TRACKING</strong></h2>
<div class="image1"><img src="Images/com.jpg" alt="Image" width="204" height="204"/></div>
<p class="noindents">We have spent the previous chapters introducing you to ways that Ghidra can assist your reverse engineering analysis efforts. Throughout this journey, we have introduced many ways to transform and annotate your work to document and facilitate understanding of the binary.</p>
<p class="indent">In this chapter, we introduce binary differencing and Ghidra’s Version Tracking tool to help you identify similarities and differences between files and functions and facilitate the application of previous analysis results to new files. We also discuss file differences from three perspectives: binary differencing, function comparison, and version tracking.</p>
<h3 class="h3" id="ch23lev437"><strong>Binary Differencing</strong></h3>
<p class="noindent">In the preceding chapter, we patched a binary to modify the flow of a function to bypass a call to <code>exit</code> by changing a single byte in a single instruction: <code>JZ</code> (74) to <code>JNZ</code> (75). To confirm the change and document exactly what was <span epub:type="pagebreak" id="page_530"/>changed, we could use an external tool such as <code>VBinDiff</code> or <code>WinDiff</code> to compare the two files at the byte level. However, to compare files at the instruction level, we need a much more sophisticated tool: the Program Diff tool available in Ghidra’s Listing window. Once the differences have been computed, they can be viewed using custom displays designed to emphasize the differences, facilitate understanding of each change, and provide opportunities to take action based on the type of difference.</p>
<p class="indent">To compare two files that have been imported to a project and are in the same state (for example, both analyzed or neither analyzed), open one of the files in the CodeBrowser and then choose <strong>Tools</strong> ▸ <strong>Program Differences</strong> and select another file within the current project for comparison. Alternatively, you can use the Listing window tool icon shown in <a href="ch23.xhtml#fig23_1">Figure 23-1</a>. This icon serves as a toggle to open or close the Program Diff tool.</p>
<div class="image"><img src="Images/fig23-1.jpg" alt="image" width="675" height="63"/></div>
<p class="figcap" id="fig23_1"><em>Figure 23-1: CodeBrowser Diff View toggle icon</em></p>
<p class="indent">For this example, we will start by opening the unpatched version of the file, selecting the Diff View icon, and choosing the patched version of the file. This opens the Determine Program Differences dialog shown in <a href="ch23.xhtml#fig23_2">Figure 23-2</a>.</p>
<div class="image"><img src="Images/fig23-2.jpg" alt="image" width="507" height="434"/></div>
<p class="figcap" id="fig23_2"><em>Figure 23-2: The Diff tool’s Determine Program Differences dialog</em></p>
<p class="indent">While all available differences fields will be selected by default, in this case Bytes is the appropriate choice to confirm that the patch worked correctly, so it is the only difference option selected. When you click OK, you <span epub:type="pagebreak" id="page_531"/>can see the two binaries in the Listing window, which has been split into side-by-side listings, with one file displayed in each. By default, the listings are synchronized, so navigating in one also navigates the other. There are several ways to navigate the detected differences within this tool, which we present later in the chapter.</p>
<p class="indent">When you open two files for diffing, Ghidra initially positions the Listing view at the beginning of each file. The down arrow tool on the Listing window toolbar (or <span class="smallcaps">CTRL-ALT-</span>N) may be used to navigate to the first difference between the two files. To call your attention to the differing code, changes are indicated with color-highlighted disassembly lines in each file’s Listing window as well as in the Decompiler window if the difference is within a function. (The Decompiler window is synchronized with the first of the two files.) Navigating to the first detected difference reveals the single byte that is <code>JZ</code> (74) in the original listing and <code>JNZ</code> (75) in the second listing.</p>
<p class="indent">To view more details, choose <strong>Window</strong> ▸ <strong>Diff</strong> ▸ <strong>Diff Details</strong>. You will see the following report in the Diff Details window at the bottom of the CodeBrowser window:</p>
<pre>Diff address range 1 of 1.<br/>
Difference details for address range: [ 00100708 - 00100709 ]<br/>
<br/>
Byte Diffs :<br/>
    Address   Program1  Program2<br/>
    00100708    0x74       0x75<br/>
<br/>
Code Unit Diffs :<br/>
    Program1 CH23:/DiffDemo/debug_check_x64 :<br/>
            00100708 - 00100709    JZ 0x00100720<br/>
                                   Instruction Prototype hash = 16af243b<br/>
    Program2 CH23:/DiffDemo/debug_check_x64.patched :<br/>
            00100708 - 00100709    JNZ 0x00100720<br/>
                                   Instruction Prototype hash = 176d4e0c</pre>
<p class="indent">The first line indicates the number of address ranges that contain differences. In this case, only one range in the file contains differences, so you can be confident that the two programs differ by only a single byte. This simple example barely scratches the surface of the capabilities associated with Ghidra’s Program Diff tool, so let’s take some time to investigate other capabilities that this tool provides.</p>
<h4 class="h4" id="ch23lev438"><strong><em>Program Diff Tool</em></strong></h4>
<p class="noindent">The nine options at the top of <a href="ch23.xhtml#fig23_2">Figure 23-2</a> form the basis of your comparison, and you can select any or all of them. By default, the Program Diff tool operates on the entire program for each file. If you wish to limit your comparison to a specific address range, you must highlight the range in the first file before opening the tool. Once you have made your selections and clicked OK, the split Listing window you see is called a Program Diff.</p>
<span epub:type="pagebreak" id="page_532"/>
<h5 class="h5" id="ch23lev439"><strong>Program Diff</strong></h5>
<p class="noindent">Program Diff View lets you view both files simultaneously. Basically, the Listing window now has two listings, one on the left side and one on the right. When you open the Diff Details window, it opens at the bottom of the CodeBrowser window. Within the Diff Details window, the left file is considered Program1 (the file you opened originally), while the right file is considered Program2 (the file you chose to compare to Program1). The Decompiler window reflects the contents of Program1. When you are comparing two files, Ghidra can compute the differences in either direction. It is up to you to remember which file is which as you use the Program Diff tool.</p>
<p class="indent">A common workflow is to begin analyzing a file and then realize that some or all of the code looks familiar, which may prompt you to open a file you have previously analyzed in order to begin diffing. Fortunately, Program Diff maintains alignment between the two files by inserting blank lines when necessary. Differences are highlighted, and the Program Diff toolbar provides you navigational capability and the means to determine how you wish to handle the differences.</p>
<h5 class="h5" id="ch23lev440"><strong>Program Diff Toolbar</strong></h5>
<p class="noindent">The Program Diff toolbar extends the Listing window toolbar options by adding the tools shown in <a href="ch23.xhtml#fig23_3">Figure 23-3</a>.</p>
<div class="image"><img src="Images/fig23-3.jpg" alt="image" width="674" height="539"/></div>
<p class="figcap" id="fig23_3"><em>Figure 23-3: Program Diff toolbar options</em></p>
<span epub:type="pagebreak" id="page_533"/>
<h5 class="h5" id="ch23lev441"><strong>Diff Apply Settings</strong></h5>
<p class="noindent">The Diff Apply Settings define the actions that you would like to take when there is a difference between the two files. Choosing the Display Diff Apply Settings option displays the window shown in <a href="ch23.xhtml#fig23_4">Figure 23-4</a>.</p>
<div class="image"><img src="Images/fig23-4.jpg" alt="image" width="694" height="326"/></div>
<p class="figcap" id="fig23_4"><em>Figure 23-4: Diff Apply Settings window</em></p>
<p class="indentb">Each setting specifies a default action you would like to apply from the second program to the first program you opened and how you would like that option applied. The following four options are available from each drop-down:</p>
<p class="uln-indent"><strong>Ignore</strong> Do not change the first program (available for all cases).</p>
<p class="uln-indent"><strong>Replace</strong> Change the first program’s content to match the second program’s content (available for all cases).</p>
<p class="uln-indent"><strong>Merge</strong> Add the difference from the second program to the first program. If applied to a label, this will not change which label is set to primary (available for only Comments and Labels).</p>
<p class="uln-indent"><strong>Merge &amp; Set Primary</strong> The action is the same as Merge, but the primary label is set to the second program label if that is possible (available for only Labels).</p>
<p class="indenta">At the top of <a href="ch23.xhtml#fig23_4">Figure 23-4</a>, there are two toolbar icons. The Save as Default icon saves the current Diff Apply Settings. The arrow opens a menu that allows you to make changes to all of the settings at one time by choosing one of the options shown in <a href="ch23.xhtml#fig23_5">Figure 23-5</a>.</p>
<div class="image"><img src="Images/fig23-5.jpg" alt="image" width="354" height="130"/></div>
<p class="figcap" id="fig23_5"><em>Figure 23-5: Diff Apply Settings pull-down menu</em></p>
<span epub:type="pagebreak" id="page_534"/>
<p class="indent">If you select the Set Merge option and Merge is not a valid choice for a particular setting, it will be changed to Set Replace. For labels, it will be changed to Merge &amp; Set Primary.</p>
<p class="indent">Choose Apply Differences from the toolbar if you wish to apply all of the default changes. When you have finished with the Program Diff tool, toggle the Diff View icon in the Listing window and you will see the dialog displayed in <a href="ch23.xhtml#fig23_6">Figure 23-6</a>.</p>
<div class="image"><img src="Images/fig23-6.jpg" alt="image" width="405" height="204"/></div>
<p class="figcap" id="fig23_6"><em>Figure 23-6: Close Diff Session confirmation dialog</em></p>
<p class="indent">Confirming that you wish to close the current diff session will close the display of the second file and return you to a normal Listing window with the first file (and all of the changes that you have selected from the diff analysis) displayed.</p>
<p class="indent">The Program Diff tool was designed for two primary use cases: first, to compare files analyzed by two different users who don’t share a Ghidra Server instance; second, to compare code generated from different versions of the same source code base (for example, unpatched and patched versions of a shared library). In the following example, we walk through the process of using this tool to reconcile two copies of the same binary, each of which was analyzed independently.</p>
<h4 class="h4" id="ch23lev442"><strong><em>Example: Merging Two Analyzed Files</em></strong></h4>
<p class="noindent">Assume that you are analyzing a binary that contains a crypto routine. A colleague mentions that she is midway through analyzing a binary that also appears to have a crypto routine and is likely from the same malware family. She agrees to provide you with her project so that you can compare the two files. When you look at the files in Diff View, you immediately notice that the two of you appear to be analyzing the same binary.</p>
<p class="indent">The challenge is that you have each made progress and have modified the contents of the file based on your individual analysis. You need to merge the two analyzed files so that you can each benefit from the other’s analysis. You have agreed to take on this responsibility and have opened your binary in the CodeBrowser and initiated a Program Diff session, adding your colleague’s binary for comparison.</p>
<p class="indent">Choosing the down arrow on the Program Diff toolbar takes you to the first difference in this file. At this point, you can open the Diff Details window by choosing the option from the Program Diff toolbar (or hotkey <span epub:type="pagebreak" id="page_535"/>F5). This provides you with the following listing (broken into two sections to facilitate discussion). In the first section at the top of the Diff Details, you see the following:</p>
<pre>Diff address range 1 of 4. <span class="ent">➊</span><br/>
Difference details for address: 0010075a <span class="ent">➋</span><br/>
<br/>
Function Diffs : <span class="ent">➌</span><br/>
  Program1 CH23:/Crypto/diff_sample1 :<br/>
    Signature: void encrypt_rot13(char * inbuffer, char * outbuffer) <span class="ent">➍</span><br/>
    Thunk? : no<br/>
    Stack Frame:<br/>
       Parameters: <span class="ent">➎</span><br/>
         DataType    Storage        FirstUse Name      Size Source<br/>
         /char *     RDI:8          0x0      inbuffer  8    USER_DEFINED<br/>
         /char *     RSI:8          0x0      outbuffer 8    USER_DEFINED<br/>
       Local Variables: <span class="ent">➏</span><br/>
         DataType    Storage        FirstUse Name      Size Source<br/>
         /int        EAX:4          0xc0     length    4    USER_DEFINED<br/>
         /int        Stack[-0x1c]:4 0x0      idx       4    USER_DEFINED<br/>
         /char       Stack[-0x1d]:1 0x0      curr_char 1    USER_DEFINED<br/>
  Program2 CH23:/Crypto/diff_sample1a : <span class="ent">➐</span><br/>
    Signature: void encrypt(char * param_1, long param_2)<br/>
    Thunk? : no<br/>
    Stack Frame:<br/>
       Parameters:<br/>
         DataType    Storage        FirstUse Name      Size Source<br/>
         /char *     RDI:8          0x0      param_1   8    DEFAULT<br/>
         /long       RSI:8          0x0      param_2   8    DEFAULT<br/>
       Local Variables:<br/>
         DataType    Storage        FirstUse Name      Size Source<br/>
         /undefined4 Stack[-0x1c]:4 0x0      local_1c  4    DEFAULT<br/>
         /undefined1 Stack[-0x1d]:1 0x0      local_1d  1    DEFAULT</pre>
<p class="indent">The first of four identified difference address ranges <span class="ent">➊</span> in this file is being displayed and is associated with the current address, <code>0010075a</code> <span class="ent">➋</span>. The listing begins by detailing a difference in the function headers of the two binaries <span class="ent">➌</span>. For your binary, you have provided a meaningful name for the function and the parameters in the function signature <span class="ent">➍</span>. Further, each parameter has an appropriately defined type <span class="ent">➎</span>. Likewise, the local variables have been given meaningful names and types <span class="ent">➏</span>. In the second program <span class="ent">➐</span>, the analyst did not make any changes to the default Ghidra header for the corresponding function.</p>
<p class="indent">You want to retain your version of the changes for the function definition and local variables. You could use the toolbar icon to reject the change, but this would reject all of the differences associated with this address. Since you have not yet reviewed all of the differences, just scroll down to the next difference in the Diff Details window.</p>
<p class="indent">The next section of the differences associated with the first address range contains the label and comment differences.</p>
<span epub:type="pagebreak" id="page_536"/>
<pre><span class="ent">➊</span> Label Diffs :<br/>
    Program1 CH23:/Crypto/diff_sample1 at 0010075a :<br/>
      0010075a is an External Entry Point.<br/>
        Name           Type           Primary  Source        Namespace<br/>
      <span class="ent">➋</span> encrypt_rot13  Function       yes      USER_DEFINED  Global<br/>
<br/>
    Program2 CH23:/Crypto/diff_sample1a at 0010075a :<br/>
      0010075a is an External Entry Point.<br/>
        Name           Type           Primary  Source        Namespace<br/>
      <span class="ent">➌</span> encrypt        Function       yes      USER_DEFINED  Global<br/>
<br/>
<span class="ent">➍</span> Plate-Comment Diffs :<br/>
<span class="ent">➎</span> Program1 CH23:/Crypto/diff_sample1 at 0010075a :<br/>
      ****************************************************************<br/>
      *                      FUNCTION                                *<br/>
      * This is a crypto function originally named cryptor. Renamed  *<br/>
      * to use our standard format encrypt_rot13. Changed the        *<br/>
      * function parameters to char *. Added meaningful variable     *<br/>
      * names. Function first seen in fileC13d by Ken H              *<br/>
      ****************************************************************<br/>
    Program2 CH23:/Crypto/diff_sample1a at 0010075a :<br/>
      No Plate-Comment.<br/>
<br/>
<span class="ent">➏</span> EOL-Comment Diffs :<br/>
    Program1 CH23:/Crypto/diff_sample1 at 0010075a :<br/>
      No EOL-Comment.<br/>
  <span class="ent">➐</span> Program2 CH23:/Crypto/diff_sample1a at 0010075a :<br/>
      This looks like an encryption routine. TODO: Analyze to get more information.</pre>
<p class="indent">Within the label differences <span class="ent">➊</span>, the only difference is the name of the function <span class="ent">➋ ➌</span>, which has already been discussed. In the <code>Plate-Comment</code> section <span class="ent">➍</span>, your file has a detailed comment <span class="ent">➎</span>, but the other file has no plate comments. In the <code>EOL-Comment</code> section <span class="ent">➏</span>, there is a brief comment by the other analyst <span class="ent">➐</span> but none in your file. When you examine the comment, you see that it is a <code>TODO</code> action item that you have already done in your file.</p>
<p class="indent">After evaluating all of the differences between the two files, your decision is to retain your content and not accept any new content from the other binary. You accomplish this by choosing the Ignore Differences and Move icon. This takes you to the next difference. Since you already have the Diff Details window open, its contents are updated as soon as you navigate, and you see the following:</p>
<pre>Diff address range 1 of 3. <span class="ent">➊</span><br/>
Difference details for address range: [ 0010081a - 0010081e ]<br/>
<br/>
Reference Diffs :<br/>
  Program1 CH23:/Crypto/diff_sample1 at 0010081a :<br/>
    Reference Type: WRITE  From: 0010081a  Mnemonic  To: register: <br/>
      RAX  USER_DEFINED  Primary<br/>
<br/>
  Program2 CH23:/Crypto/diff_sample1a at 0010081a :<br/>
    No unmatched references.</pre>
<span epub:type="pagebreak" id="page_537"/>
<p class="indent">You have decreased the number of ranges containing differences by rejecting the previous difference <span class="ent">➊</span>. Once again, your file has more information than the second file. This time you will navigate to the next difference by clicking the down arrow. This takes you to the following:</p>
<pre>Diff address range 2 of 3. <span class="ent">➊</span><br/>
Difference details for address: 00100830<br/>
<br/>
Function Diffs :<br/>
  Program1 CH23:/Crypto/diff_sample1 :<br/>
    Signature: undefined display_message()<br/>
    Thunk? : no<br/>
    Calling Convention: unknown<br/>
    Return Value :<br/>
         DataType    Storage        FirstUse Name      Size Source<br/>
         /undefined  AL:1           0x0      &lt;RETURN&gt;  1    IMPORTED<br/>
      Parameters:<br/>
        No parameters.<br/>
  Program2 CH23:/Crypto/diff_sample1a :<br/>
    Signature: void display_message(char * message) <span class="ent">➋</span><br/>
    Thunk? : no<br/>
    Calling Convention: __stdcall<br/>
    Return Value :<br/>
         DataType    Storage        FirstUse Name      Size Source<br/>
         /void       &lt;VOID&gt;         0x0      &lt;RETURN&gt;  0    IMPORTED<br/>
      Parameters:<br/>
         DataType    Storage        FirstUse Name      Size Source<br/>
         /char *     RDI:8          0x0      message   8    USER_DEFINED</pre>
<p class="indent">Notice that the number of ranges has not changed <span class="ent">➊</span>. You have just been moved to the next difference range without impacting the total number of difference ranges. Evaluating this new difference shows that the second file contains information provided by the other analyst that is not available in your file. The function signature has a return type, and a parameter has been added to the function signature <span class="ent">➋</span>. You can include this in your binary by right-clicking the difference in the right-hand Listing window and choosing Apply Selection (hotkey F3), or by clicking the Apply Differences icon on the toolbar.</p>
<p class="indent">Navigating to the next difference, you see the following details:</p>
<pre><span class="ent">➊</span> Diff address range 2 of 2.<br/>
  Difference details for address range: [ 00100848 - 0010084c ]<br/>
<br/>
  Pre-Comment Diffs :<br/>
    Program1 CH23:/Crypto/diff_sample1 at 00100848 :<br/>
      No Pre-Comment.<br/>
<br/>
    Program2 CH23:/Crypto/diff_sample1a at 00100848 :<br/>
    <span class="ent">➋</span> This is a potential vulnerability.  The parameter is being passed<br/>
      in to printf as the first/only parameter which may result in a format<br/>
      string vulnerability.</pre>
<span epub:type="pagebreak" id="page_538"/>
<p class="indent">The number of difference ranges has decreased because you applied the differences in the previous range <span class="ent">➊</span>. In this final difference, you see an interesting entry in the <code>Pre-Comment</code> section <span class="ent">➋</span> in the other file. The analyst has detected a potential vulnerability. To be sure this information is included in your file, you choose <strong>Apply Differences</strong>.</p>
<p class="indent">Now that you have completed the comparison of the two files, you can click the Diff View icon and confirm that you want to close the current Program Diff session. Your listing view now reflects the combined analysis from both binaries, and you can save and close your file.</p>
<p class="indent">The Ghidra Program Diff tool provides the ability to investigate the differences between two versions of the same file. While it will attempt to diff two unrelated files, any results are likely to reflect only coincidental similarities. Let’s shift our focus to a different tool that facilitates comparisons between selected functions within the same or different programs.</p>
<h3 class="h3" id="ch23lev443"><strong>Comparing Functions</strong></h3>
<p class="noindent">If you see a function that is reminiscent of a function you have analyzed in the past, it can be helpful to directly compare the two functions so the outcome of your initial analysis can be applied to the current function when appropriate. Ghidra provides this capability through its Function Comparison window which allows you to view two functions at the same time as shown in <a href="ch23.xhtml#fig23_7">Figure 23-7</a>.</p>
<div class="image"><img src="Images/fig23-7.jpg" alt="image" width="681" height="418"/></div>
<p class="figcap" id="fig23_7"><em>Figure 23-7: Listing view in Function Comparison window</em></p>
<h4 class="h4" id="ch23lev444"><strong><em>Function Comparison Window</em></strong></h4>
<p class="noindent">To use the Function Comparison window, open the one or more binaries that contain the functions in the CodeBrowser, load an initial function by <span epub:type="pagebreak" id="page_539"/>highlighting a function in the active CodeBrowser tab, and select Compare Selected Functions (hotkey <span class="smallcaps">SHIFT</span>-C) from the right-click context menu. The Function Comparison window shows two functions side by side with potential differences highlighted, as shown in <a href="ch23.xhtml#fig23_7">Figure 23-7</a>. (If you have selected only one function, it will be displayed in both windows until you load more functions.)</p>
<p class="indent">To add additional functions to compare, choose the Add Functions icon <span class="ent">➊</span>. This will display a list of all functions in the active program in the CodeBrowser. You can select a function from the list or switch to the CodeBrowser window to change the active program by selecting another program tab in the Listing window.</p>
<p class="indent">To the left of the active listing (indicated by a box around the listing <span class="ent">➏</span>) is a cursor arrow <span class="ent">➐</span>. If the functions match, the arrow will also appear at the same location in the other window. In <a href="ch23.xhtml#fig23_7">Figure 23-7</a>, the instruction in the primary window does not match the instruction in the other window, so the cursor arrow is not shown in both windows.</p>
<p class="indent">The Function Comparison window provides the opportunity to load more than two functions from more than two binaries. You can add and remove functions from each panel when needed. A helpful pull-down menu lets you choose the function to be displayed in the associated window <span class="ent">➋ ➌</span>.</p>
<p class="indent">This window lets you easily switch between Decompile View <span class="ent">➍</span> and Listing View <span class="ent">➎</span> for the two functions and change the function displayed in either window. The Decompile View for this example is shown in <a href="ch23.xhtml#fig23_8">Figure 23-8</a>.</p>
<div class="image"><img src="Images/fig23-8.jpg" alt="image" width="790" height="488"/></div>
<p class="figcap" id="fig23_8"><em>Figure 23-8: Decompile view in the Function Comparison window</em></p>
<span epub:type="pagebreak" id="page_540"/>
<p class="indent">The exploratory capabilities available in this window overlap significantly with the Program Diff tool, except you are comparing only two functions at a time and you can easily switch between the decompiled code and the listing. The toolbar menu for this window is shown in <a href="ch23.xhtml#fig23_9">Figure 23-9</a>.</p>
<div class="image"><img src="Images/fig23-9.jpg" alt="image" width="674" height="919"/></div>
<p class="figcap" id="fig23_9"><em>Figure 23-9: Function Comparison toolbar options</em></p>
<p class="indent">Let’s walk through an example that demonstrates some additional Function Comparison tool capabilities.</p>
<span epub:type="pagebreak" id="page_541"/>
<h4 class="h4" id="ch23lev445"><strong><em>Example: Comparing Crypto Routines</em></strong></h4>
<p class="noindent">Congratulations on your promotion! Based on your successful analysis and use of the Program Diff tool for crypto routines, you have now been labeled the crypto expert in your shop. Every time one of your colleagues suspects that they have a crypto routine, they send you the binary to see if it is a crypto routine you recognize.</p>
<p class="indent">You now have a new file from a colleague and wish to determine whether the crypto routine used in this file is something new or is a routine you have identified in the past. Rather than loading and comparing each crypto routine against the new function, you have set up a special Ghidra project that contains all of your previously analyzed and documented crypto routines. Your goal is to load your crypto routines on one side of the Function Comparison window and then import the new file on the other side to compare against the existing crypto routines. (To simplify this example, you currently have only one analyzed crypto routine in your collection: the ROT13 routine that you merged in the previous example.)</p>
<p class="indent">After you load your complete collection of analyzed crypto files into the CodeBrowser and have loaded your function, <code>encrypt_rot13</code>, in the Function Comparison window, you need to load the new file into the same CodeBrowser instance (File ▸ Open) and make it the active file. At this point, you can explore the file, but it isn’t necessary. You can always switch back to the CodeBrowser window if you can’t find the function you need. In this case, choosing the Add Functions option from the Function Comparison toolbar, you see the complete list of functions in the new binary, and halfway down the list is a function with a name that intrigues you, <code>encrypt</code>, as shown in <a href="ch23.xhtml#fig23_10">Figure 23-10</a>.</p>
<div class="image"><img src="Images/fig23-10.jpg" alt="image" width="694" height="455"/></div>
<p class="figcap" id="fig23_10"><em>Figure 23-10: Select Functions window with the</em> <span class="codeitalic">encrypt</span> <em>function selected</em></p>
<span epub:type="pagebreak" id="page_542"/>
<p class="indent">A cursory glance at the loaded files in the Decompile View of the functions, shown in <a href="ch23.xhtml#fig23_11">Figure 23-11</a>, suggests that these two functions are quite different.</p>
<div class="image"><img src="Images/fig23-11.jpg" alt="image" width="844" height="774"/></div>
<p class="figcap" id="fig23_11"><em>Figure 23-11: Decompile View of Function Comparison window for two crypto routines</em></p>
<p class="indent">The Listing View, shown in <a href="ch23.xhtml#fig23_12">Figure 23-12</a>, confirms that these two functions have significant differences.</p>
<span epub:type="pagebreak" id="page_543"/>
<div class="image"><img src="Images/fig23-12.jpg" alt="image" width="844" height="611"/></div>
<p class="figcap" id="fig23_12"><em>Figure 23-12: Listing View of Function Comparison window for two crypto routines with differences highlighted</em></p>
<p class="indent">On further analysis, you discover that the new routine XORs each byte with the constant value <code>0xa5</code>. This is definitely different from the current crypto routine that you have, so you name and document this new function and add it to your collection (which will then have two members!). Returning to the CodeBrowser, you update the function signature and add comments to document the new crypto routine. The changes you make are reflected in the Function Comparison window as well.</p>
<p class="indent">As you are documenting, you notice the new binary has a function called <code>display_message</code>, as does the binary you are comparing it against. You recall that this function was identified as having a vulnerability in your current binary, so you decide to compare these two functions. You load them into the Function Comparison window to see if they have similarities beyond the common name. They seem different in both the Decompile and Listing Views, as shown in <a href="ch23.xhtml#fig23_13">Figure 23-13</a>.</p>
<span epub:type="pagebreak" id="page_544"/>
<div class="image"><img src="Images/fig23-13.jpg" alt="image" width="844" height="865"/></div>
<p class="figcap" id="fig23_13"><em>Figure 23-13: Decompile and Listing views for</em> <span class="codeitalic">display_message</span> <em>functions</em></p>
<p class="indent">In the second example, <code>param_1</code> is being passed to <code>puts</code> for output, which fixes the vulnerability.</p>
<p class="indent">Now that you have documented this crypto routine, you see that you have received yet another binary from your colleagues. To reset to the start of your crypto comparison process, you can use the Function Comparison toolbar icon to remove the <code>display_message</code> functions from the window, leaving you with your crypto routine collection, which now has two distinct members: <code>encrypt_rot13</code> and <code>encrypt_XOR_a5</code>.</p>
<span epub:type="pagebreak" id="page_545"/>
<p class="indentb">An initial exploration of this new file indicates that three functions seem to involve encryption: <code>encrypt</code>, <code>encrypt_strong</code>, and <code>encrypt_super_strong</code>. You load these into the Function Comparison window so you can compare them to your existing crypto routines. After comparing <code>encrypt_rot13</code> against each of the new functions, you notice the following:</p>
<p class="uln-indent"><span class="codestrong">encrypt_rot13</span> <strong>vs.</strong> <span class="codestrong">encrypt</span> Almost entirely different. The <code>encrypt</code> routine is just a test that may call one of the other two encryption routines.</p>
<p class="uln-indent"><span class="codestrong">encrypt_rot13</span> <strong>vs.</strong> <span class="codestrong">encrypt_strong</span> Almost entirely the same.</p>
<p class="uln-indent"><span class="codestrong">encrypt_rot13</span> <strong>vs.</strong> <span class="codestrong">encrypt_super_strong</span> Very different. A closer look at the differences between these two functions leads you to believe that they are not the same function.</p>
<p class="indenta">A closer look at the differences shows that the instructions in <code>encrypt_rot13</code> and <code>encrypt_strong</code> are identical—the differences primarily consist of address labels, as shown in <a href="ch23.xhtml#fig23_14">Figure 23-14</a>.</p>
<div class="image"><img src="Images/fig23-14.jpg" alt="image" width="844" height="400"/></div>
<p class="figcap" id="fig23_14"><em>Figure 23-14: Function Comparison window with address label differences</em></p>
<p class="indent">You would not expect address labels to match perfectly in this case, as the locations of the functions within the binaries are different. The locations are consistent relative to the current address, so we are likely dealing with the same function. The only other difference is 1 byte associated with the call to <code>strlen</code>, as shown in <a href="ch23.xhtml#fig23_15">Figure 23-15</a>. This is a similar issue and can be explained by the difference in the relative positions of the encryption function and <code>strlen</code> in each binary.</p>
<span epub:type="pagebreak" id="page_546"/>
<div class="image"><img src="Images/fig23-15.jpg" alt="image" width="844" height="269"/></div>
<p class="figcap" id="fig23_15"><em>Figure 23-15: Function Comparison window with byte difference in call to</em> <span class="codeitalic">strlen</span></p>
<p class="indent">After determining that these are the same function, you can right-click the previously analyzed function and choose Apply Function Signature To Other Side from the right-click context window. This will update the function signature in all needed locations, including the Listing window and Symbol Tree. Note that the Function Comparison window does not provide all of the capabilities available in the Diff View. To copy additional information (such as the detailed comments associated with the function), use the Program Diff tool.</p>
<p class="indentb">Having completed your comparative analysis of <code>encrypt_rot13</code>, you turn your attention to <code>encrypt_XOR_a5</code> and observe the following relationships with each of the new functions:</p>
<p class="uln-indent"><span class="codestrong">encrypt_XOR_a5</span> <strong>vs.</strong> <span class="codestrong">encrypt</span> Almost entirely different.</p>
<p class="uln-indent"><span class="codestrong">encrypt_XOR_a5</span> <strong>vs.</strong> <span class="codestrong">encrypt_strong</span> Very different. A closer look at the differences between these two functions also leads you to believe that they are not the same function.</p>
<p class="uln-indent"><span class="codestrong">encrypt_XOR_a5</span> <strong>vs.</strong> <span class="codestrong">encrypt_super_strong</span> Almost entirely the same.</p>
<p class="indenta">The identified differences between <code>encrypt_XOR_a5</code> and <code>encrypt_super_strong</code> are also just address labels and some bytes in the call to <code>strlen</code>. You can handle this situation the same way you did the previous matching functions.</p>
<p class="indent">While this is a trivial example (and not likely consistent with the actual crypto routines you might see in the wild), it does demonstrate how Function Comparison can be used to minimize the duplication of analysis effort when you encounter familiar routines in new binaries.</p>
<p class="indent">The final tool for investigating two files is the most complex: the Version Tracking tool.</p>
<h3 class="h3" id="ch23lev446"><strong>Version Tracking</strong> </h3>
<p class="noindent">Imagine that you have spent months analyzing a very large binary. The binary has hundreds or thousands of functions and no symbols. As part of your effort, you have provided meaningful names to the majority of the <span epub:type="pagebreak" id="page_547"/>functions; renamed data, local variables, and function parameters; and added a mountain of comments that would take days or longer to re-create.</p>
<p class="indent">Now imagine that a new version of the binary is released, and the world stops using the version you know so much about. You could continue to analyze the old version to learn more about it under the assumption that the new version behaves similarly, but you would fail to learn about any new or modified behaviors in the updated binary. Instead, you decide to begin working on the newer version of the binary and quickly realize that you spend significant amounts of time reading the markup in the older binary to help guide you through the new binary.</p>
<p class="indent">Alternating back and forth between two CodeBrowser windows is not an optimal use of your time. It’s time to switch from the CodeBrowser to the other default tool that Ghidra provides in the Project Tool Chest, as shown in <a href="ch23.xhtml#fig23_16">Figure 23-16</a>.</p>
<div class="image"><img src="Images/fig23-16.jpg" alt="image" width="406" height="175"/></div>
<p class="figcap" id="fig23_16"><em>Figure 23-16: The Version Tracking tool (footprints) in the Project Tool Chest</em></p>
<p class="indent">Ghidra’s Version Tracking tool is designed to help you with precisely this situation. Through the use of various correlators, Ghidra attempts to match items, such as functions or data, in a source binary with their corresponding versions in a destination binary. Once functions have been matched between the two binaries, Ghidra can automatically migrate information, including your labels and comments, from the source binary to the destination binary. In addition to rapidly migrating your existing analysis, the Version Tracking tool makes it easy to identify which things haven’t changed, which things have only minor changes (detected by diffing), and which things are entirely new.</p>
<p class="indent">The Version Tracking tool is one of the most configurable tools in Ghidra, which makes it easy to adapt to a particular line of inquiry. It is also a challenging tool to present in its entirety. In the following sections, we walk you through the version tracking process at a very high level and point you to resources that can help you discover the correct settings and components to use when using the Version Tracking tool to assist you in discovering the relationship between two files.</p>
<h4 class="h4" id="ch23lev447"><strong><em>Version Tracking Concepts</em></strong></h4>
<p class="noindent">While Function Comparison and Program Diff tools answered specific questions about the atomic differences between two files or functions, the Version Tracking tool provides you with functionality to answer a more <span epub:type="pagebreak" id="page_548"/>holistic question: how similar are these two binaries, and can you highlight and provide insight about the similarities between them? The foundational work unit is called a <em>session</em>, and each session is configured to identify and handle <em>correlations</em> between two files.</p>
<h5 class="h5" id="ch23lev448"><strong>Correlators</strong></h5>
<p class="noindent">At a high level, the Version Tracking tool is looking for correlations between two files. There are seven types of correlators that generate matches between two binaries:</p>
<ul>
<li><p class="noindent">Data Match correlators</p></li>
<li><p class="noindent">Function Match correlators</p></li>
<li><p class="noindent">Legacy Import correlators</p></li>
<li><p class="noindent">Implied correlators</p></li>
<li><p class="noindent">Manual Match correlators</p></li>
<li><p class="noindent">Symbol Name Match correlators</p></li>
<li><p class="noindent">Reference correlators</p></li>
</ul>
<p class="indentb">Rather than just counting and compiling a list of specific differences in each of the categories, the Version Tracking tool extends correlations between the two files to identify matches with varying levels of exactness:</p>
<p class="uln-indent"><strong>Exact matches</strong> These are one-to-one matches between the two files and can match data, function bytes, function instructions, or function mnemonics (for example, when two binaries contain the exact same function).</p>
<p class="uln-indent"><strong>Duplicate data match</strong> These are exact matches that are not one-to-one matches (for example, when a string appears once in one file and seven times in the other file).</p>
<p class="uln-indent"><strong>Similar matches</strong> These are matches that pass a user-controlled similarity threshold. The matching is similar to the approach used for word models described in <a href="ch13.xhtml#ch13">Chapter 13</a>, but uses 4-grams as well as trigrams.</p>
<p class="indenta">With the ability to introduce thresholds, and accept and reject matches, this tool offers a powerful capability to migrate your previous analysis to new versions of a binary. Further, the information associated with each session provides an effective analysis audit trail that can help capture the incremental changes of a binary or the evolution of a malware family.</p>
<h5 class="h5" id="ch23lev449"><strong>Sessions</strong></h5>
<p class="noindent">While an in-depth walk-through of a complete session would take a significant amount of time, a basic version tracking session might include the following steps:</p>
<ol>
<li><p class="noindent">Open Ghidra's Version Tracking tool.</p></li>
<li><p class="noindent">Create a new session by choosing a source file and a destination file.</p></li>
<li><p class="noindent"><span epub:type="pagebreak" id="page_549"/>For all appropriate correlators: add to the existing session, choose the correlator, select all resulting matches, and accept all matches and apply their markup items.</p></li>
<li><p class="noindent">Save the session.</p></li>
<li><p class="noindent">Close the session.</p></li>
</ol>
<p class="indent">The preceding workflow provides a very general overview, and the combinatorial potential associated with the correlator step is extensive. The potential of and the nuances associated with this tool cannot be covered in a single chapter. The Ghidra team has provided sample workflows (as well as significant documentation about the Version Tracking tool) in Ghidra Help. It is up to you to determine how best to apply the capabilities of this tool in your reverse engineering workflow.</p>
<h3 class="h3" id="ch23lev450"><strong>Summary</strong></h3>
<p class="noindent">In this chapter, we stepped away from a single binary to begin looking at ways to identify differences and similarities between binaries by using the Program Diff, Function Comparison, and Version Tracking tools. These tools are valuable time-savers for porting existing work to new binaries, merging annotations from your colleagues, and rapidly identifying exactly what has changed between two versions of the same program.</p>
<p class="indent">As we wrap up our tour of Ghidra’s vast landscape of features, know that we have only scratched the surface of Ghidra’s capabilities. You should now have a deeper understanding of Ghidra and how it can be applied to the reverse engineering challenges you face. When you have questions, the Ghidra community is there to help through resources like GitHub, Stack Exchange, Reddit, YouTube, and many other forums.</p>
<p class="indent">More importantly, you should now be in a position to contribute by answering questions and providing help to others. Ghidra is community-supported software and continually evolving. We hope you participate by posting tutorials, writing and publishing Ghidra scripts and modules, identifying and addressing issues, or perhaps even developing new functionality for Ghidra itself. The future of Ghidra will be determined by the community, and that now includes you. Welcome, and happy reversing!</p>
<span epub:type="pagebreak" id="page_550"/>
</div>



  </body></html>