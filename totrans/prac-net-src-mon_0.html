<html><head></head><body>
<p class="calibre1"><b class="calibre3">Yes, skip network configuration! </b>, as shown in Figure 3-16. </p>
<p class="calibre1"> <i class="calibre4">Figure 3-16: Skipping network configuration</i></p>
<p class="calibre1">To simplify setup for this first example, choose the Quick Setup option, </p>
<p class="calibre1">as shown in Figure 3-17. This will have the server running SO as a stand-</p>
<p class="calibre1">alone system with minimum configuration. </p>
<p class="calibre1"> <i class="calibre4">Figure 3-17: Choosing Quick Setup</i></p>
<p class="calibre1">You will need to tell SO the interface for some of its components to </p>
<p class="calibre1">mon itor. As shown in Figure 3-18, I tell SO that I want Snort to sniff traffic </p>
<p class="calibre1">on eth1. (As part of Quick Setup, SO chooses to use the Snort network IDS </p>
<p class="calibre1">to generate alert data.)</p>
<p class="calibre1">Now provide a username for accessing the NSM software component </p>
<p class="calibre1">Sguil (covered in Chapter 8), as shown in Figure 3-19. SO will use this </p>
<p class="calibre1">username for several other NSM tools. </p>
<p class="calibre1"><b class="calibre3">68</b>   Chapter 3</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p103"/><img src="index-103_1.jpg" alt="Image 38" class="calibre2"/></p>
<p class="calibre1"><img src="index-103_2.jpg" alt="Image 39" class="calibre2"/></p>
<p class="calibre1"><img src="index-103_3.jpg" alt="Image 40" class="calibre2"/></p>
<p class="calibre1"><img src="index-103_4.jpg" alt="Image 41" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 3-18: Tel ing SO where Snort </i></p>
<p class="calibre1"> <i class="calibre4">Figure 3-19: Entering a Sguil username</i></p>
<p class="calibre1"> <i class="calibre4">should sniff</i></p>
<p class="calibre1">At the next screen, enter an email address for SO to use for logging </p>
<p class="calibre1">into the Snorby NSM console and authenticating users. (SO will not use </p>
<p class="calibre1">this email address to send spam to you! In fact, the SO project does not </p>
<p class="calibre1">track users in any way.) Snorby (also covered in Chapter 8) is a tool for pre-</p>
<p class="calibre1">senting NSM data to analysts, and it uses a separate authentication mecha-</p>
<p class="calibre1">nism based on email addresses. </p>
<p class="calibre1">Now you’ll choose an alphanumeric password for use in authenticat-</p>
<p class="calibre1">ing to NSM software installed with SO, as shown in Figure 3-20. (You can </p>
<p class="calibre1">change this password later through the Sguil and Snorby interfaces.) </p>
<p class="calibre1"> <i class="calibre4">Figure 3-20: Entering a password for SO NSM applications</i></p>
<p class="calibre1">After you create credentials for SO NSM applications, the configu-</p>
<p class="calibre1">ration script asks if you want to install the Enterprise Log Search and </p>
<p class="calibre1">Archive (ELSA) software, as shown in Figure 3-21. Choose <b class="calibre3">Yes, enable </b></p>
<p class="calibre1"><b class="calibre3">ELSA! </b> unless you are working with very constrained hardware. ELSA </p>
<p class="calibre1">provides a search engine interface to NSM log data. </p>
<p class="calibre1"> <i class="calibre4">Figure 3-21: Choosing to enable ELSA</i></p>
<p class="calibre1">Stand-alone NSM Deployment and Installation   <b class="calibre3">69</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p104"/><img src="index-104_1.jpg" alt="Image 42" class="calibre2"/></p>
<p class="calibre1"><img src="index-104_2.jpg" alt="Image 43" class="calibre2"/></p>
<p class="calibre1"><img src="index-104_3.jpg" alt="Image 44" class="calibre2"/></p>
<p class="calibre1">SO should now summarize the changes it is about to make. If you like </p>
<p class="calibre1">the results, select <b class="calibre3">Yes, proceed with the changes! </b>, as shown in Figure 3-22. </p>
<p class="calibre1"> <i class="calibre4">Figure 3-22: SO is ready to proceed with changes. </i></p>
<p class="calibre1">Next, SO configures the system’s time zone to use UTC, and then sets </p>
<p class="calibre1">up all the NSM applications packaged with it. When finished, it should </p>
<p class="calibre1">report some helpful information about your system. You can check the sta-</p>
<p class="calibre1">tus of the setup in the  <i class="calibre4">/var/log/nsm/sosetup.log</i> file, as shown in Figure 3-23. </p>
<p class="calibre1">Finally, you’ll see information on IDS rule management, as shown in </p>
<p class="calibre1">Figure 3-24. </p>
<p class="calibre1"> <i class="calibre4">Figure 3-23: SO setup is now complete. </i></p>
<p class="calibre1"> <i class="calibre4">Figure 3-24: Notes concerning IDS rule </i></p>
<p class="calibre1"> <i class="calibre4">management</i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Checking Your Instal ation</b></i></p>
<p class="calibre1">Once you’ve finished installing your stand-alone system, you should take </p>
<p class="calibre1">some steps to make sure that it’s functioning as expected. </p>
<p class="calibre1"><b class="calibre3">70</b>   Chapter 3</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p105"/>First, open a terminal and run the following command to see if all the NSM agents are live. Remember that you run a terminal by executing the </p>
<p class="calibre1">Terminal application on the desktop. </p>
<p class="calibre1">$ <b class="calibre3">sudo service nsm status</b></p>
<p class="calibre1">[sudo] password for sademo:</p>
<p class="calibre1">Status: securityonion</p>
<p class="calibre1">* sguil server                                                      [  OK  ]</p>
<p class="calibre1">Status: HIDS</p>
<p class="calibre1">* ossec_agent (sguil)                                               [  OK  ]</p>
<p class="calibre1">Status: Bro</p>
<p class="calibre1">Name       Type       Host       Status        Pid    Peers  Started            </p>
<p class="calibre1">bro        standalone localhost  running       5813   0      10 Feb 11:10:32</p>
<p class="calibre1">Status: sademo-eth1</p>
<p class="calibre1">* netsniff-ng (full packet data)                                    [  OK  ]</p>
<p class="calibre1">* pcap_agent (sguil)                                                [  OK  ]</p>
<p class="calibre1">* snort_agent-1 (sguil)                                             [  OK  ]</p>
<p class="calibre1">* snort-1 (alert data)                                              [  OK  ]</p>
<p class="calibre1">* barnyard2-1 (spooler, unified2 format)                            [  OK  ]</p>
<p class="calibre1">* prads (sessions/assets)                                           [  OK  ]</p>
<p class="calibre1">* sancp_agent (sguil)                                               [  OK  ]</p>
<p class="calibre1">* pads_agent (sguil)                                                [  OK  ]</p>
<p class="calibre1">* argus                                                             [  OK  ]</p>
<p class="calibre1">* http_agent (sguil)                                                [  OK  ]</p>
<p class="calibre1">Now, in the same window, run the following command to generate </p>
<p class="calibre1">activity that will trigger a Snort alert. I’m assuming that your sensor can see </p>
<p class="calibre1">traffic to and from the stand-alone system’s management port. If not, run </p>
<p class="calibre1">this command from a system monitored by the new sensor, or visit the URL </p>
<p class="calibre1">with a web browser on a system monitored by the new sensor. </p>
<p class="calibre1"><b class="calibre3">$ curl www.testmyids.com</b></p>
<p class="calibre1">uid=0(root) gid=0(root) groups=0(root)</p>
<p class="calibre1">To determine if at least part of your NSM setup is working, visit the </p>
<p class="calibre1">Snorby NSM application using a web browser. Point your web browser to </p>
<p class="calibre1">the IP address of your stand-alone sensor that you assigned earlier. You will </p>
<p class="calibre1">receive an error saying the certificate for HTTPS is not trusted because </p>
<p class="calibre1">it is not signed, as shown in Figure 3-25. Unless you suspect that an inter-</p>
<p class="calibre1">nal user is conducting a man-in-the-middle attack against you, it is safe to </p>
<p class="calibre1">choose <b class="calibre3">Proceed Anyway</b> or the equivalent. (If you later choose to deploy a </p>
<p class="calibre1">certificate trusted by the browser, you will not see these warnings.)</p>
<p class="calibre1">You will now see the SO welcome page, as shown in Figure 3-26, with </p>
<p class="calibre1">links to SO applications accessible via the web servers running on the SO </p>
<p class="calibre1">system. Click the link for Snorby to determine if it captured data triggered </p>
<p class="calibre1">by visiting  <i class="calibre4">http://www.testmyids.com/</i>. </p>
<p class="calibre1">Stand-alone NSM Deployment and Installation   <b class="calibre3">71</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p106"/><img src="index-106_1.png" alt="Image 45" class="calibre2"/></p>
<p class="calibre1"><img src="index-106_2.jpg" alt="Image 46" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 3-25: Certificate warning</i></p>
<p class="calibre1"> <i class="calibre4">Figure 3-26: SO welcome page</i></p>
<p class="calibre1">Clicking the Snorby link should open a new tab or window to your SO </p>
<p class="calibre1">IP address and port 444. Snorby should ask for the email address and pass-</p>
<p class="calibre1">word you chose during setup, as shown in Figure 3-27. Enter them and click </p>
<p class="calibre1"><b class="calibre3">Welcome, Sign In</b>. </p>
<p class="calibre1"><b class="calibre3">72</b>   Chapter 3</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p107"/><img src="index-107_1.jpg" alt="Image 47" class="calibre2"/></p>
<p class="calibre1"><img src="index-107_2.jpg" alt="Image 48" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 3-27: Snorby login screen</i></p>
<p class="calibre1">Depending on where you deployed your sensor and the amount of </p>
<p class="calibre1">traffic active on the network, you will see different amounts of infor-</p>
<p class="calibre1">mation on the initial dashboard. We’re interested in seeing two specific </p>
<p class="calibre1">alerts at the right side of the screen: either ET Policy curl User-Agent or GPL </p>
<p class="calibre1">ATTACK_RESPONSE id ch. If you see either or both (as shown in Figure 3-28), </p>
<p class="calibre1">your sensor is seeing traffic and at least one NSM application (in this case, </p>
<p class="calibre1">Snort) observed and reported it correctly. </p>
<p class="calibre1"> <i class="calibre4">Figure 3-28: Snorby dashboard confirms stand-alone sensor operation. </i></p>
<p class="calibre1">Stand-alone NSM Deployment and Installation   <b class="calibre3">73</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p108"/><b class="calibre3">conclusion</b></p>
<p class="calibre1">In this chapter, we created a stand-alone SO platform. We booted the SO </p>
<p class="calibre1"> <i class="calibre4">.iso</i> file and installed the Xubuntu Linux distribution to a hard drive. Next, we updated the operating system and began the process of installing the </p>
<p class="calibre1">SO software. We began by configuring the network interfaces, choosing </p>
<p class="calibre1">one for system management and the other for data collection or sniffing. </p>
<p class="calibre1">With the network interfaces prepared, we turned to configuring a variety </p>
<p class="calibre1">of SO tools via a helpful wizard process. Once all the software was installed </p>
<p class="calibre1">and configured, we viewed the Snorby console to ensure it could see at least </p>
<p class="calibre1">some data derived from the network. </p>
<p class="calibre1">In Chapter 4, we’ll advance from the world of the stand-alone platform </p>
<p class="calibre1">into one where distributed systems rule. Stand-alone platforms work well </p>
<p class="calibre1">for isolated deployments, but some of the power of the NSM model is appar-</p>
<p class="calibre1">ent only when analysts can interact with data from multiple vantage points. </p>
<p class="calibre1">Stand-alone platforms can sometimes watch more than one network seg-</p>
<p class="calibre1">ment if those segments are physically nearby. When monitored segments </p>
<p class="calibre1">are geographically dispersed, a distributed deployment works best to unify </p>
<p class="calibre1">collection and presentation of NSM data. Chapter 4 will show how to make </p>
<p class="calibre1">that a reality. </p>
<p class="calibre1"><b class="calibre3">74</b>   Chapter 3</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p109"/><b class="calibre3">4</b></p>
<p class="calibre1"><b class="calibre3">D i S T r i B u T e D   D e P l oy M e N T</b></p>
<p class="calibre1">Chapter 3 discussed NSM platforms built </p>
<p class="calibre1">on the open source SO project, focusing on </p>
<p class="calibre1">how to install SO as a stand-alone platform. </p>
<p class="calibre1">Single-system solutions are a great starting point </p>
<p class="calibre1">for newcomers to the NSM world, but most organi-</p>
<p class="calibre1">zations have more than one network to manage and </p>
<p class="calibre1">monitor. Based on what you learned in Chapters 2 and 3, you may recognize </p>
<p class="calibre1">locations in your environment where you need multiple sensors cooperat-</p>
<p class="calibre1">ing to provide multisite visibility. Thankfully, as described in the previous </p>
<p class="calibre1">chapter, SO supports distributed deployment models (server-plus-sensor </p>
<p class="calibre1">platforms) to accommodate these requirements. </p>
<p class="calibre1">In addition to covering distributed SO deployments, this chapter also </p>
<p class="calibre1">explains how to use SO Personal Package Archives (PPA) to build SO plat-</p>
<p class="calibre1">forms without using the SO  <i class="calibre4">.iso</i> image. Installing SO using the project’s official  <i class="calibre4">.iso</i> file is probably the easiest way to get started, but some organizations prefer to begin with their own version of Ubuntu Linux. The SO project’s </p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p110"/>PPAs allow administrators to install SO packages on Ubuntu Linux-derived systems. You can install your own version of Ubuntu Linux, add SO PPAs, </p>
<p class="calibre1">and then enjoy full SO functionality. </p>
<p class="calibre1">We’ll begin by building a distributed SO setup. </p>
<p class="calibre1"><b class="calibre3">installing an So Server using the So .iso image</b></p>
<p class="calibre1">If you followed the instructions in Chapter 3, you now have a stand-alone </p>
<p class="calibre1">SO platform collecting and interpreting network traffic. More challenging </p>
<p class="calibre1">situations require a server-plus-sensors deployment. </p>
<p class="calibre1">As explained in Chapter 3, in a server-plus-sensors configuration, one </p>
<p class="calibre1">or more sensors collect NSM data, and a server acts as the central “brain” </p>
<p class="calibre1">for the operation, as well as an aggregation and storage point for certain </p>
<p class="calibre1">types of NSM data. This section describes how to install an SO server. After </p>
<p class="calibre1">setting up the server, we’ll install a sensor that will cooperate with the server </p>
<p class="calibre1">to collect and present NSM data. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">SO Server Considerations</b></i></p>
<p class="calibre1">When considering an SO server, remember that the server will be the cen-</p>
<p class="calibre1">tral collection and storage point for certain types of NSM data. Keep the </p>
<p class="calibre1">following in mind:</p>
<p class="calibre1">•  An  <i class="calibre4">SO server</i> operates a central MySQL database to which all SO sensors </p>
<p class="calibre1">transmit session data. The aggregate session data is a key factor when </p>
<p class="calibre1">considering RAM and hard drive requirements for the SO server. </p>
<p class="calibre1">•  An  <i class="calibre4">SO sensor</i> stores network traffic as pcap files. The SO sensor stores </p>
<p class="calibre1">this data locally until it’s copied to the SO server. This locally stored </p>
<p class="calibre1">data is a key factor when considering hard drive requirements for the </p>
<p class="calibre1">SO sensor. </p>
<p class="calibre1">You also need to understand what data resides where and know how </p>
<p class="calibre1">many sensors will likely contribute data to the server. You will need the </p>
<p class="calibre1">following:</p>
<p class="calibre1">•  A lot of hard drive space in a RAID configuration that you’ll use to </p>
<p class="calibre1">store session and associated NSM data</p>
<p class="calibre1">•  At least 4GB of RAM, with more RAM available to satisfy MySQL’s needs</p>
<p class="calibre1">•  A multicore CPU</p>
<p class="calibre1">•  At least one network interface for management purposes</p>
<p class="calibre1">Because the server is not connected to network taps or SPAN ports, you </p>
<p class="calibre1">can think of it more as a traditional server system. Clients, like SO sensors </p>
<p class="calibre1">or CIRT analysts, will connect to the SO server to access data. The number </p>
<p class="calibre1">of clients accessing the server and the amount of centralized data you want </p>
<p class="calibre1">available to them are the primary factors to consider when designing an SO </p>
<p class="calibre1">server. </p>
<p class="calibre1"><b class="calibre3">76</b>   Chapter 4</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p111"/><img src="index-111_1.jpg" alt="Image 49" class="calibre2"/></p>
<p class="calibre1"><b class="calibre3">N o T e </b> <i class="calibre4"> </i></p>
<p class="calibre1"> <i class="calibre4">Some CIRTs choose to separate functions on their central servers. For example, they</i> <i class="calibre4">run separate database systems that cooperate with the central server. SO does not</i> <i class="calibre4">support this sort of configuration out-of-the-box. Therefore, we leave that sort of</i> <i class="calibre4">configuration out of this discussion. The configuration described here works well in</i> <i class="calibre4">production for many CIRTs. </i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Building Your SO Server</b></i></p>
<p class="calibre1">To build your server, boot the SO  <i class="calibre4">.iso</i> image, choose <b class="calibre3">Live</b>, and wait until you see the SO desktop. Begin the installation process by clicking the Install </p>
<p class="calibre1">Security Onion 12.04 icon. Follow the configuration process explained in </p>
<p class="calibre1"><a href="index_split_001.html#p94">“Installing SO to a Hard Drive” on page 62. </a> In summary, you will perform the following steps, as in the previous chapter:</p>
<p class="calibre1">1.  Validate space, connectivity, updates, and third-party software. </p>
<p class="calibre1">2.  Choose to erase the disk to install SO. </p>
<p class="calibre1">3.  Choose a username, computer name, and password. </p>
<p class="calibre1">4.  Complete installation and reboot the system. </p>
<p class="calibre1">5.  Update installed software using <b class="calibre3">sudo apt-get update &amp;&amp; sudo apt-get </b></p>
<p class="calibre1"><b class="calibre3">dist-upgrade</b>. </p>
<p class="calibre1">After completing this process, the SO software should be installed on </p>
<p class="calibre1">the server, but nothing is configured for NSM duties. This is the point at </p>
<p class="calibre1">which we turn the system into a live SO server. </p>
<p class="calibre1">The first task is to manually assign a static IP address to the system. To </p>
<p class="calibre1">do so, follow these steps:</p>
<p class="calibre1">1.  Click the blue-and-white mouse icon at the upper-left side of the screen, </p>
<p class="calibre1">select <b class="calibre3">Settings</b>, and then choose <b class="calibre3">Network Connections</b>, as shown in </p>
<p class="calibre1">Figure 4-1. </p>
<p class="calibre1"> <i class="calibre4">Figure 4-1: Selecting to view set ings for Network Connections</i></p>
<p class="calibre1">Distributed Deployment   <b class="calibre3">77</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p112"/><img src="index-112_1.jpg" alt="Image 50" class="calibre2"/></p>
<p class="calibre1">2.  Highlight <b class="calibre3">Wired connection 1</b>, and then click <b class="calibre3">Edit</b>. Click the <b class="calibre3">IPv4 </b></p>
<p class="calibre1"><b class="calibre3">Settings</b> tab, and then change the Method to <b class="calibre3">Manual</b>. Enter values </p>
<p class="calibre1">appropriate for your server by clicking <b class="calibre3">Add</b> and then entering the </p>
<p class="calibre1">information required, as shown in Figure 4-2. (These values represent </p>
<p class="calibre1">choices appropriate for my sample network; be sure to use values that </p>
<p class="calibre1">match your environment.)</p>
<p class="calibre1"> <i class="calibre4">Figure 4-2: Configuring Wired connection 1 with  </i></p>
<p class="calibre1"> <i class="calibre4">static IP addressing</i></p>
<p class="calibre1">3.  When you’re finished, click <b class="calibre3">Save</b>. The dialog will turn gray while the </p>
<p class="calibre1">system reconfigures networking. </p>
<p class="calibre1">4.  Click <b class="calibre3">Close</b> to complete the process. </p>
<p class="calibre1">5.  Reboot the system. </p>
<p class="calibre1">At this point, the server is running the correct operating system, with </p>
<p class="calibre1">updated components, and is reachable via a static management IP address. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Configuring Your SO Server</b></i></p>
<p class="calibre1">Now we can begin configuring the system as an SO server. To do so, follow </p>
<p class="calibre1">these steps:</p>
<p class="calibre1">1.  Click the <b class="calibre3">Setup</b> icon and enter your password to perform administra-</p>
<p class="calibre1">tive tasks. Select <b class="calibre3">Yes, Continue! </b> when prompted. </p>
<p class="calibre1">2.  When asked if you want to configure interfaces, choose <b class="calibre3">No, not right now</b>. </p>
<p class="calibre1">3.  When prompted, choose <b class="calibre3">Advanced Setup</b>. </p>
<p class="calibre1"><b class="calibre3">78</b>   Chapter 4</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p113"/><img src="index-113_1.jpg" alt="Image 51" class="calibre2"/></p>
<p class="calibre1"><img src="index-113_2.jpg" alt="Image 52" class="calibre2"/></p>
<p class="calibre1">4.  The next screen asks what sort of system you want to build. Select <b class="calibre3">Server</b>, as shown in Figure 4-3, and then click <b class="calibre3">OK</b>. </p>
<p class="calibre1"> <i class="calibre4">Figure 4-3: Choosing to build a server</i></p>
<p class="calibre1">5.  Now choose between running the Snort or Suricata IDS engine. Select </p>
<p class="calibre1">the IDS engine you plan to run on your sensors, and then click <b class="calibre3">OK</b>. </p>
<p class="calibre1">6.  When asked to choose an IDS ruleset, choose <b class="calibre3">Emerging Threats GPL</b>, </p>
<p class="calibre1">as shown in Figure 4-4. (The Emerging Threats ruleset is free and per-</p>
<p class="calibre1">fect for our purposes.)</p>
<p class="calibre1"> <i class="calibre4">Figure 4-4: Choosing the Emerging Threats GPL ruleset</i></p>
<p class="calibre1">7.  The setup wizard asks for a Sguil username, Snorby email address, and </p>
<p class="calibre1">password. Enter the responses appropriate for your environment. When </p>
<p class="calibre1">asked if you want to enable ELSA, choose <b class="calibre3">Yes, enable ELSA! </b>. The setup </p>
<p class="calibre1">wizard summarizes your choices and asks if you’re ready to proceed, as </p>
<p class="calibre1">shown in Figure 4-5. </p>
<p class="calibre1">Distributed Deployment   <b class="calibre3">79</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p114"/><img src="index-114_1.jpg" alt="Image 53" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 4-5: Setup summary before proceeding with SO server changes</i></p>
<p class="calibre1">8.  Click <b class="calibre3">Yes, proceed with the changes! </b>, and the setup wizard will com-</p>
<p class="calibre1">plete the SO server installation. The script should report that the setup </p>
<p class="calibre1">is complete. </p>
<p class="calibre1">9.  To confirm that installation succeeded, visit the web page hosted on the </p>
<p class="calibre1">server, and then access a web-enabled NSM application, such as Snorby. </p>
<p class="calibre1">At this point, you have only an SO server active. It is not running any </p>
<p class="calibre1">tools that collect and interpret NSM data. The Snorby console will be empty </p>
<p class="calibre1">until you build an SO sensor, as described next. </p>
<p class="calibre1"><b class="calibre3">installing an So Sensor using the So .iso image</b></p>
<p class="calibre1">Our SO server won’t do us much good without one or more sensors to col-</p>
<p class="calibre1">lect and interpret NSM data. In this section, we’ll build an SO sensor using </p>
<p class="calibre1">the SO  <i class="calibre4">.iso</i> file. For hardware, choose the same sort of equipment you used </p>
<p class="calibre1">in the stand-alone scenario. </p>
<p class="calibre1">To build your sensor, boot the  <i class="calibre4">.iso</i> image, choose <b class="calibre3">Live</b>, and wait until you see the SO desktop. Begin the installation process by clicking the </p>
<p class="calibre1">Install Security Onion 12.04 icon, and then follow the configuration pro-</p>
<p class="calibre1">cess explained i<a href="index_split_001.html#p94">n “Installing SO to a Hard Drive” on page 62</a>. </p>
<p class="calibre1">In summary, you will perform the following steps:</p>
<p class="calibre1">1.  Validate space, connectivity, updates, and third-party software. </p>
<p class="calibre1">2.  Choose to erase the disk to install SO. </p>
<p class="calibre1">3.  Choose a username, computer name, and password. </p>
<p class="calibre1">4.  Complete installation and reboot the system. </p>
<p class="calibre1">5.  Update installed software using <b class="calibre3">sudo apt-get update &amp;&amp; sudo apt-get </b></p>
<p class="calibre1"><b class="calibre3">dist-upgrade</b>. </p>
<p class="calibre1"><b class="calibre3">80</b>   Chapter 4</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p115"/><img src="index-115_1.jpg" alt="Image 54" class="calibre2"/></p>
<p class="calibre1">After completing this process, the SO software should be installed on </p>
<p class="calibre1">the sensor, but nothing is configured for NSM duties. In the next section, </p>
<p class="calibre1">we will choose a static IP address within the SO setup wizard, since that is </p>
<p class="calibre1">part of a larger network configuration process required for SO sensors. We </p>
<p class="calibre1">are ready to turn the system into a live SO sensor, and tell it to cooperate </p>
<p class="calibre1">with the SO server we just created. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Configuring the SO Sensor</b></i></p>
<p class="calibre1">To configure the system as an SO sensor, follow these steps: </p>
<p class="calibre1">1.  Click the Setup icon and enter your password to perform administra-</p>
<p class="calibre1">tive tasks. Select <b class="calibre3">Yes, Continue! </b> when prompted. </p>
<p class="calibre1">2.  When prompted, select <b class="calibre3">eth0</b> for the management interface (or whatever </p>
<p class="calibre1">interface you choose for management), configure a static IP address, </p>
<p class="calibre1">and choose <b class="calibre3">eth1</b> for sniffing (or whatever interface(s) you want to use </p>
<p class="calibre1">to collect and interpret traffic). </p>
<p class="calibre1">3.  Accept your selections by choosing <b class="calibre3">Yes, make changes and reboot! </b>. </p>
<p class="calibre1">When the system reboots, it will be ready to be configured as an SO </p>
<p class="calibre1">sensor. To configure the sensor, follow these steps:</p>
<p class="calibre1">1.  Click the Setup icon and enter your password to perform administra-</p>
<p class="calibre1">tive tasks. Select <b class="calibre3">Yes, Continue! </b> when prompted. </p>
<p class="calibre1">2.  The setup script should notice that you’ve already configured network </p>
<p class="calibre1">interfaces, so choose <b class="calibre3">Yes, skip network configuration! </b>. </p>
<p class="calibre1">3.  Select <b class="calibre3">Sensor</b>, as shown in Figure 4-6. </p>
<p class="calibre1"> <i class="calibre4">Figure 4-6: Choosing to build a sensor</i></p>
<p class="calibre1">4.  As an SO sensor, this system will cooperate with our SO server. Accord-</p>
<p class="calibre1">ingly, the setup wizard should prompt you to enter the hostname or IP </p>
<p class="calibre1">address of the SO server, as shown in Figure 4-7. As you can see, I enter </p>
<p class="calibre1">192.168.2.129, which I statically assigned to the SO server earlier. Enter </p>
<p class="calibre1">the IP address for your SO server. </p>
<p class="calibre1">Distributed Deployment   <b class="calibre3">81</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p116"/><img src="index-116_1.jpg" alt="Image 55" class="calibre2"/></p>
<p class="calibre1"><img src="index-116_2.jpg" alt="Image 56" class="calibre2"/></p>
<p class="calibre1"><img src="index-116_3.jpg" alt="Image 57" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 4-7: Providing the SO sensor setup wzard program with the IP address  </i></p>
<p class="calibre1"> <i class="calibre4">of the SO server</i></p>
<p class="calibre1">5.  The setup wizard will ask for a username for the SO sensor processes </p>
<p class="calibre1">to use to connect via OpenSSH. SO uses OpenSSH for communica-</p>
<p class="calibre1">tion between the server and one or more sensors. The username you </p>
<p class="calibre1">selected when building the SO server will suffice for demo purposes, but </p>
<p class="calibre1">in production environments, you should create a new user on the server </p>
<p class="calibre1">for each sensor that you expect to report. Separate users will limit your </p>
<p class="calibre1">system’s exposure if any single sensor is compromised. I enter <b class="calibre3">svrdemiso</b> for </p>
<p class="calibre1">the user account, as shown in Figure 4-8. Use a value appropriate for </p>
<p class="calibre1">your setup. </p>
<p class="calibre1"> <i class="calibre4">Figure 4-8: Configuring the username to connect to the SO server</i></p>
<p class="calibre1">6.  The setup wizard asks for the interface(s) to be monitored, as in the </p>
<p class="calibre1">stand-alone setup. I choose <b class="calibre3">eth1</b>, and then I choose to enable <b class="calibre3">ELSA</b> and </p>
<p class="calibre1">automatically update the ELSA server (which helps the ELSA server on </p>
<p class="calibre1">the SO server know that a new node is checking in with data), as shown </p>
<p class="calibre1">in Figure 4-9. </p>
<p class="calibre1"> <i class="calibre4">Figure 4-9: Tel ing the setup script to update the ELSA server</i></p>
<p class="calibre1">7.  It’s time to commit these changes. The setup script summarizes the </p>
<p class="calibre1">results. If you’re satisfied with the output, click <b class="calibre3">Yes, proceed with the </b></p>
<p class="calibre1"><b class="calibre3">changes! </b>, as shown in Figure 4-10. </p>
<p class="calibre1"><b class="calibre3">82</b>   Chapter 4</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p117"/><img src="index-117_1.jpg" alt="Image 58" class="calibre2"/></p>
<p class="calibre1"><img src="index-117_2.png" alt="Image 59" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 4-10: SO summary before proceeding with SO sensor  </i></p>
<p class="calibre1"> <i class="calibre4">changes</i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Completing Setup</b></i></p>
<p class="calibre1">As noted earlier, distributed SO deployments rely on OpenSSH for commu-</p>
<p class="calibre1">nication. During setup, the OpenSSH client will likely report that it can’t </p>
<p class="calibre1">verify the authenticity of the SO server. It will probably show the ECDSA key </p>
<p class="calibre1">fingerprint of the SO server and ask if you want to continue connecting. </p>
<p class="calibre1">Log in to the SO server locally and run the following commands to </p>
<p class="calibre1">obtain a fingerprint of the ECDSA key. (Your key will differ from the output </p>
<p class="calibre1">in Listing 4-1.)</p>
<p class="calibre1">$ <b class="calibre3">ls /etc/ssh/*key*</b></p>
<p class="calibre1">/etc/ssh/ssh_host_dsa_key      /etc/ssh/ssh_host_ecdsa_key.pub</p>
<p class="calibre1">/etc/ssh/ssh_host_dsa_key.pub  /etc/ssh/ssh_host_rsa_key</p>
<p class="calibre1">/etc/ssh/ssh_host_ecdsa_key    /etc/ssh/ssh_host_rsa_key.pub</p>
<p class="calibre1">$ <b class="calibre3">ssh-keygen -lf /etc/ssh/ssh_host_ecdsa_key.pub</b></p>
<p class="calibre1">256 33:6c:38:9a:48:ce:fc:b2:c2:26:57:c3:81:a7:9d:b9  root@svrdemiso (ECDSA)</p>
<p class="calibre1"> <i class="calibre4">Listing 4-1: Examining SSH keys</i></p>
<p class="calibre1">Verify that the key fingerprint you see matches the key on your SO </p>
<p class="calibre1">server, and then type <b class="calibre3">yes</b> and press enter, as shown in Figure 4-11. </p>
<p class="calibre1"> <i class="calibre4">Figure 4-11: Validating the OpenSSH ECDSA key fingerprint</i></p>
<p class="calibre1">A few more configuration messages will pass by, and another termi-</p>
<p class="calibre1">nal will appear, prompting you to enter your password to log in to the SO </p>
<p class="calibre1">server. Once you’ve entered your password correctly, the setup wizard will </p>
<p class="calibre1">report that it is complete. </p>
<p class="calibre1">Distributed Deployment   <b class="calibre3">83</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p118"/> <i class="calibre4"><b class="calibre3">Verifying that the Sensors Are Working</b></i></p>
<p class="calibre1">Now verify that the sensors are running with the <b class="calibre3">sudo service nsm status</b> </p>
<p class="calibre1">command. If you see output like that in Listing 4-2, everything is probably </p>
<p class="calibre1">working fine:</p>
<p class="calibre1">$ <b class="calibre3">sudo service nsm status</b></p>
<p class="calibre1">Status: HIDS</p>
<p class="calibre1">* ossec_agent (sguil)                                                [  OK  ]</p>
<p class="calibre1">Status: Bro</p>
<p class="calibre1">Name             Type        Host            Status        Pid    Peers  Started              </p>
<p class="calibre1">manager          manager     192.168.2.130   running       2501   2      10 Feb 17:17:26  </p>
<p class="calibre1">proxy            proxy       192.168.2.130   running       2659   2      10 Feb 17:17:28  </p>
<p class="calibre1">sendemiso-eth1-1 worker      192.168.2.130   running       3275   2      10 Feb 17:17:31  </p>
<p class="calibre1">Status: sendemiso-eth1</p>
<p class="calibre1">* netsniff-ng (full packet data)                                     [  OK  ]</p>
<p class="calibre1">* pcap_agent (sguil)                                                 [  OK  ]</p>
<p class="calibre1">* snort_agent (sguil)                                                [  OK  ]</p>
<p class="calibre1">* suricata (alert data)                                              [  OK  ]</p>
<p class="calibre1">* barnyard2 (spooler, unified2 format)                               [  OK  ]</p>
<p class="calibre1">* prads (sessions/assets)                                            [  OK  ]</p>
<p class="calibre1">* sancp_agent (sguil)                                                [  OK  ]</p>
<p class="calibre1">* pads_agent (sguil)                                                 [  OK  ]</p>
<p class="calibre1">* argus                                                              [  OK  ]</p>
<p class="calibre1">* http_agent (sguil)                                                 [  OK  ]</p>
<p class="calibre1"> <i class="calibre4">Listing 4-2: Checking NSM service status</i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Verifying that the Autossh Tunnel Is Working</b></i></p>
<p class="calibre1">If you notice that one or more NSM components aren’t working, try running </p>
<p class="calibre1">the <b class="calibre3">sudo service nsm restart</b> command to stop and start each application. If </p>
<p class="calibre1">that doesn’t result in each component working as expected, you may have a </p>
<p class="calibre1">more serious problem. You might need to restart your setup, or consult the </p>
<p class="calibre1">online SO mailing list for assistance. You should also verify that the autossh </p>
<p class="calibre1">tunnel that connects the sensor to the server is operational. Use the follow-</p>
<p class="calibre1">ing command as shown in Listing 4-3. </p>
<p class="calibre1">$ <b class="calibre3">ps aux | grep autoss[h]</b></p>
<p class="calibre1">root      9775  0.0  0.0   4308   324 ?        Ss   17:01   0:00 /usr/lib/</p>
<p class="calibre1">autossh/autossh -M 0    -q -N -o ServerAliveInterval 60 -o ServerAliveCountMax </p>
<p class="calibre1">3 -i /root/.ssh/securityonion -L 3306:127.0.0.1:3306 -R 50000:localhost:50000 </p>
<p class="calibre1">-R 50001:localhost:9306 svrdemiso@192.168.2.129</p>
<p class="calibre1"> <i class="calibre4">Listing 4-3: Looking for autossh processes</i></p>
<p class="calibre1">You can get similar results with <b class="calibre3">pgrep -lf autossh</b>. If the output is blank, you do not have an autossh tunnel established. Try rerunning the SO setup script. </p>
<p class="calibre1">You can run a test by visiting  <i class="calibre4">http://www.testmyids.com/</i>. If you see results </p>
<p class="calibre1">in the Snorby application, your SO sensor is communicating events to your </p>
<p class="calibre1">SO server. Congratulations—you have built a distributed NSM system! </p>
<p class="calibre1"><b class="calibre3">84</b>   Chapter 4</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p119"/><b class="calibre3">building an So Server using PPas</b></p>
<p class="calibre1">The previous installations used the SO  <i class="calibre4">.iso</i> file provided by the SO project, </p>
<p class="calibre1">but that’s not the only installation option. You can also build SO function-</p>
<p class="calibre1">ality on a locally installed Ubuntu Linux-based operating system using </p>
<p class="calibre1">the SO project’s PPAs, available at  <i class="calibre4">https://launchpad.net/~securityonion/</i>. </p>
<p class="calibre1">Some organizations prefer to avoid using Linux distributions built by other </p>
<p class="calibre1">teams. If your organization follows this model and uses its own Ubuntu </p>
<p class="calibre1">Linux-derived base installation, you can use SO PPAs to deploy SO on your </p>
<p class="calibre1">platforms. </p>
<p class="calibre1">The SO project builds stable, test, and development PPAs. You should </p>
<p class="calibre1">use stable in production environments. If you want to help keep SO mov-</p>
<p class="calibre1">ing forward, run the test PPA. The development PPA is best suited to SO </p>
<p class="calibre1">developers. </p>
<p class="calibre1">In the remainder of this chapter, we’ll build an entirely new server-plus-</p>
<p class="calibre1">sensor deployment solely for the purpose of demonstrating an alternative </p>
<p class="calibre1">setup option. Instead of using an  <i class="calibre4">.iso</i> image from the SO project, we’ll use </p>
<p class="calibre1">the 64-bit, Long Term Support (LTS) version of Ubuntu Server 12.04 as the </p>
<p class="calibre1">base operating system for an SO server and sensor. </p>
<p class="calibre1">You can download the  <i class="calibre4">.iso</i> file for this distribution from the Ubuntu </p>
<p class="calibre1">project website at  <i class="calibre4">http://www.ubuntu.com/download/server/</i>. When visiting </p>
<p class="calibre1">that page, you’ll see a Get Ubuntu 12.04 LTS option, which will be avail-</p>
<p class="calibre1">able through April 2017. I chose this distribution because the SO project </p>
<p class="calibre1">tests against the LTS and cannot guarantee support for other variants. </p>
<p class="calibre1">This is a popular option that your organization may use itself, thanks to </p>
<p class="calibre1">the extended availability of the release. </p>
<p class="calibre1"><b class="calibre3">N o T e </b> <i class="calibre4"> </i></p>
<p class="calibre1"> <i class="calibre4">Building your own system using PPAs requires knowledge of Linux that exceeds that</i> <i class="calibre4">required for using the SO </i>.iso <i class="calibre4"> installation method. For example, you need to know</i> <i class="calibre4">how to forward X sessions. (I show how to accomplish that task, and other Linux </i></p>
<p class="calibre1"> <i class="calibre4">steps, later in the chapter.) If you are not comfortable with this process, or don’t understand what it means, ask a Linux-experienced friend or install SO from the </i>.iso <i class="calibre4"> files</i> <i class="calibre4">as previously described. </i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Instal ing Ubuntu Server as the SO Server Operating System</b></i></p>
<p class="calibre1">Begin the Ubuntu server installation process by booting the Ubuntu Server </p>
<p class="calibre1">LTS  <i class="calibre4">.iso</i> image on the hardware chosen to run the SO server. The installation </p>
<p class="calibre1">wizard will prompt you to make a number of choices. Make the following </p>
<p class="calibre1">selections, adjusted as appropriate for your environment. </p>
<p class="calibre1">1.  Language: <b class="calibre3">English</b></p>
<p class="calibre1">2. <b class="calibre3">Install Ubuntu Server</b></p>
<p class="calibre1">3.  Select a language: <b class="calibre3">English</b></p>
<p class="calibre1">4.  Select your location: <b class="calibre3">United States</b></p>
<p class="calibre1">Distributed Deployment   <b class="calibre3">85</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p120"/>5.  Configure the keyboard:</p>
<p class="calibre1">•  Detect keyboard layout? <b class="calibre3">No</b></p>
<p class="calibre1">•  <b class="calibre3">English (US)</b></p>
<p class="calibre1">•  Keyboard layout: <b class="calibre3">English (US)</b></p>
<p class="calibre1">6.  Hostname: <b class="calibre3">serverdemo</b></p>
<p class="calibre1">7.  Set up users and passwords:</p>
<p class="calibre1">•  Full name for the new user: <b class="calibre3">serverdemo</b></p>
<p class="calibre1">•  Username for your account: <b class="calibre3">serverdemo</b></p>
<p class="calibre1">•  Choose a password for the new user: <b class="calibre3">&lt;enter password&gt; </b></p>
<p class="calibre1">•  Reenter password to verify: <b class="calibre3">&lt;enter password&gt; </b></p>
<p class="calibre1">•  Encrypt your home directory? <b class="calibre3">No</b></p>
<p class="calibre1">8.  Configure the clock. Is this time zone correct? <b class="calibre3">Yes</b></p>
<p class="calibre1">9.  Partition disks:</p>
<p class="calibre1">•  Partitioning method: <b class="calibre3">Guided – use entire disk and set up LVM</b></p>
<p class="calibre1">•  Select disk to partition: <b class="calibre3">&lt;choose your disk&gt; </b></p>
<p class="calibre1">•  Write the changes to disks and configure LVM? <b class="calibre3">Yes</b></p>
<p class="calibre1">•  Amount of volume group to use for guided partitioning: <b class="calibre3">&lt;accept </b></p>
<p class="calibre1"><b class="calibre3">default&gt;, Continue</b></p>
<p class="calibre1">•  Write the changes to disks? <b class="calibre3">Yes</b></p>
<p class="calibre1">10.  Configure the package manager. HTTP proxy information (blank for </p>
<p class="calibre1">none): <b class="calibre3">&lt;blank&gt;, Continue</b></p>
<p class="calibre1">11.  Configure tasksel. How do you want to manage upgrades on this system? </p>
<p class="calibre1"><b class="calibre3">No automatic updates. </b></p>
<p class="calibre1">12.  Software selection. Choose software to install: <b class="calibre3">&lt;click spacebar on </b></p>
<p class="calibre1"><b class="calibre3">OpenSSH server&gt;, Continue</b></p>
<p class="calibre1">13.  Install the GRUB boot loader on a hard disk. Install the GRUB boot </p>
<p class="calibre1">loader to the master boot record? <b class="calibre3">Yes</b></p>
<p class="calibre1">14.  Finish the installation. <b class="calibre3">Continue</b></p>
<p class="calibre1">When installation is complete, the system will reboot. When you log in, </p>
<p class="calibre1">you should see the IP address assigned via DHCP, as well as messages about </p>
<p class="calibre1">the number of updates that can be applied, as shown in Figure 4-12. </p>
<p class="calibre1">In some cases, Ubuntu may not show you an IP address or other system </p>
<p class="calibre1">information. In these cases, the login script determined that the system is </p>
<p class="calibre1">under load, and it will report that condition. This is normal for systems that </p>
<p class="calibre1">start a significant number of input/output (I/O) sensitive operations after </p>
<p class="calibre1">booting. </p>
<p class="calibre1"><b class="calibre3">86</b>   Chapter 4</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p121"/><img src="index-121_1.png" alt="Image 60" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 4-12: Ubuntu server is instal ed. </i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Choosing a Static IP Address</b></i></p>
<p class="calibre1">We installed the operating system and allowed a dynamic IP address, </p>
<p class="calibre1">but now we want to transition from DHCP to static IP addressing. In this </p>
<p class="calibre1">example, we’ll edit a specific configuration file, which is one of the ways to </p>
<p class="calibre1">set a static IP address. (Earlier I showed you how to set a static IP address </p>
<p class="calibre1">using a GUI menu.) First open the  <i class="calibre4">/etc/network/interfaces</i> file to edit it with the vi editor like this (enter your password when prompted):</p>
<p class="calibre1">$ <b class="calibre3">sudo vi /etc/network/interfaces</b></p>
<p class="calibre1">The file should contain entries like those in Listing 4-4. </p>
<p class="calibre1"># This file describes the network interfaces available on your system</p>
<p class="calibre1"># and how to activate them. For more information, see interfaces(5). </p>
<p class="calibre1"># The loopback network interface</p>
<p class="calibre1">auto lo</p>
<p class="calibre1">iface lo inet loopback</p>
<p class="calibre1"># The primary network interface</p>
<p class="calibre1">auto eth0</p>
<p class="calibre1">iface eth0 inet dhcp</p>
<p class="calibre1"> <i class="calibre4">Listing 4-4: Default contents of </i>/etc/network/interfaces</p>
<p class="calibre1">Distributed Deployment   <b class="calibre3">87</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p122"/>Comment out the entries in the eth0 section with hashmarks (#) and </p>
<p class="calibre1">add entries like the ones shown in Listing 4-5 in bold to match your setup. </p>
<p class="calibre1">(Ask your administrators for the settings most compatible with your net-</p>
<p class="calibre1">work, if necessary.)</p>
<p class="calibre1"># The primary network interface</p>
<p class="calibre1"><b class="calibre3"># </b>auto eth0</p>
<p class="calibre1"><b class="calibre3"># </b>iface eth0 inet dhcp</p>
<p class="calibre1">auto eth0</p>
<p class="calibre1">iface eth0 inet static</p>
<p class="calibre1"><b class="calibre3">address 192.168.2.128</b></p>
<p class="calibre1"><b class="calibre3">netmask 255.255.255.0</b></p>
<p class="calibre1"><b class="calibre3">network 192.168.2.0</b></p>
<p class="calibre1"><b class="calibre3">broadcast 192.168.2.255</b></p>
<p class="calibre1"><b class="calibre3">gateway 192.168.2.1</b></p>
<p class="calibre1"><b class="calibre3">dns-search taosecurity.com</b></p>
<p class="calibre1"><b class="calibre3">dns-nameservers 172.16.2.1</b></p>
<p class="calibre1"> <i class="calibre4">Listing 4-5: Edited contents of </i>/etc/network/interfaces</p>
<p class="calibre1">Finally, restart the networking services to enable the static IP address </p>
<p class="calibre1">with the command shown in Listing 4-6. </p>
<p class="calibre1">$ <b class="calibre3">sudo /etc/init.d/networking restart</b></p>
<p class="calibre1">* Running /etc/init.d/networking restart is deprecated because it may not </p>
<p class="calibre1">enable again some interfaces</p>
<p class="calibre1">* Reconfiguring network interfaces... </p>
<p class="calibre1">ssh stop/waiting</p>
<p class="calibre1">ssh start/running, process 16814                                 [ OK ]</p>
<p class="calibre1"> <i class="calibre4">Listing 4-6: Restarting network services to use a static IP address</i></p>
<p class="calibre1">Now reboot the system to kill the virtual dhclient process, which assigns </p>
<p class="calibre1">IP addresses via DHCP. After rebooting, your system should have a static IP </p>
<p class="calibre1">address. </p>
<p class="calibre1">To confirm that your static IP address is configured as expected, connect </p>
<p class="calibre1">via OpenSSH to the IP address of the server to continue with the next tasks. </p>
<p class="calibre1">From a different workstation, open a terminal and execute <b class="calibre3">ssh  <i class="calibre4">username</i></b><b class="calibre3">@ <i class="calibre4">server </i></b></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">IP</b></i>, where  <i class="calibre4"><b class="calibre3">username</b></i> is the username you configured, and  <i class="calibre4"><b class="calibre3">server IP</b></i> is the static management IP address you applied to the server. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Updating the Software</b></i></p>
<p class="calibre1">Next, update the software running on your server. Run these commands:</p>
<p class="calibre1">$ <b class="calibre3">sudo apt-get update &amp;&amp; sudo apt-get dist-upgrade</b></p>
<p class="calibre1">When asked if you want to continue, type <b class="calibre3">Y</b> and press enter. The </p>
<p class="calibre1">server will download and install any updates. Once it’s finished, enter </p>
<p class="calibre1"><b class="calibre3">sudo reboot</b> to complete the process and reboot the server. </p>
<p class="calibre1"><b class="calibre3">88</b>   Chapter 4</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p123"/> <i class="calibre4"><b class="calibre3">Beginning MySQL and PPA Setup on the SO Server</b></i></p>
<p class="calibre1">After rebooting, log in. Now we’ll start configuring our system as an SO </p>
<p class="calibre1">server. First, issue the following command to tell MySQL not to prompt for </p>
<p class="calibre1">a root password during installation. </p>
<p class="calibre1">$ <b class="calibre3">echo "debconf debconf/frontend select noninteractive" | sudo debconf-set-selections</b> Now install the python-software-properties package. </p>
<p class="calibre1">$ <b class="calibre3">sudo apt-get -y install python-software-properties</b></p>
<p class="calibre1">Next, add the securityonion/stable PPA to the list of repositories recog-</p>
<p class="calibre1">nized by this Ubuntu server, as shown in Listing 4-7. </p>
<p class="calibre1">$ <b class="calibre3">sudo add-apt-repository -y ppa:securityonion/stable</b></p>
<p class="calibre1">gpg: keyring `/tmp/tmpnOilj5/secring.gpg' created</p>
<p class="calibre1">gpg: keyring `/tmp/tmpnOilj5/pubring.gpg' created</p>
<p class="calibre1">gpg: requesting key 23F386C7 from hkp server keyserver.ubuntu.com</p>
<p class="calibre1">gpg: /tmp/tmpnOilj5/trustdb.gpg: trustdb created</p>
<p class="calibre1">gpg: key 23F386C7: public key "Launchpad PPA for Security Onion" imported</p>
<p class="calibre1">gpg: Total number processed: 1</p>
<p class="calibre1">gpg:               imported: 1  (RSA: 1)</p>
<p class="calibre1">OK</p>
<p class="calibre1"> <i class="calibre4">Listing 4-7: Adding the securityonion/stable PPA to the list of repositories</i></p>
<p class="calibre1">Update the package listing with the following command. </p>
<p class="calibre1">$ <b class="calibre3">sudo apt-get update</b></p>
<p class="calibre1">Now install the securityonion-server package. </p>
<p class="calibre1">$ <b class="calibre3">sudo apt-get install securityonion-server</b></p>
<p class="calibre1">Notice in Listing 4-8 that in addition to many dependencies, the system </p>
<p class="calibre1">plans to install a lot of SO-specific packages. This is normal during software </p>
<p class="calibre1">installation. </p>
<p class="calibre1"> <i class="calibre4">-- snip --</i></p>
<p class="calibre1">securityonion-capme securityonion-daq securityonion-et-rules</p>
<p class="calibre1">securityonion-limits securityonion-login-screen</p>
<p class="calibre1">securityonion-nsmnow-admin-scripts securityonion-ossec-rules</p>
<p class="calibre1">securityonion-passenger securityonion-passenger-conf</p>
<p class="calibre1">securityonion-pfring-daq securityonion-pfring-ld securityonion-pfring-module</p>
<p class="calibre1">securityonion-pfring-userland securityonion-pulledpork</p>
<p class="calibre1">securityonion-rule-update securityonion-server securityonion-setup</p>
<p class="calibre1">securityonion-sguil-agent-ossec securityonion-sguil-db-purge</p>
<p class="calibre1">securityonion-sguil-server securityonion-sguild-add-user</p>
<p class="calibre1">securityonion-snorby securityonion-snort securityonion-sostat</p>
<p class="calibre1">Distributed Deployment   <b class="calibre3">89</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p124"/>  securityonion-squert securityonion-squert-cron securityonion-web-page securityonion-wkhtmltopdf shared-mime-info sound-theme-freedesktop sox</p>
<p class="calibre1">sqlite3 ssl-cert tcl-tls tcl8.5 tcllib tclx8.4 tcpflow tcpflow-no-tags</p>
<p class="calibre1">tshark ttf-dejavu-core ttf-liberation wireshark-common x11-common xplico</p>
<p class="calibre1">zenity zenity-common</p>
<p class="calibre1">0 upgraded, 288 newly installed, 0 to remove and 0 not upgraded. </p>
<p class="calibre1">Need to get 287 MB of archives. </p>
<p class="calibre1">After this operation, 643 MB of additional disk space will be used. </p>
<p class="calibre1">Do you want to continue [Y/n]? </p>
<p class="calibre1"> <i class="calibre4">Listing 4-8: Instal ing the securityonion-server package</i></p>
<p class="calibre1">Type <b class="calibre3">Y</b> and press enter to continue. You will probably need to wait sev-</p>
<p class="calibre1">eral minutes while the server downloads and installs the required software. </p>
<p class="calibre1">Once it’s finished, install the securityonion-elsa and securityonion-elsa-extras </p>
<p class="calibre1">packages. </p>
<p class="calibre1">$ <b class="calibre3">sudo apt-get install securityonion-elsa securityonion-elsa-extras</b></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Configuring Your SO Server via PPA</b></i></p>
<p class="calibre1">Now set up this server using sosetup. Connect via SSH from a Linux system </p>
<p class="calibre1">to take advantage of X forwarding. Here, I’m connecting from a separate </p>
<p class="calibre1">Linux system named ubuntu. Notice the use of the capital -X switch to enable </p>
<p class="calibre1">X forwarding. X is a protocol for displaying graphical user interfaces. For-</p>
<p class="calibre1">warding means sending a GUI window someplace other than the computer </p>
<p class="calibre1">on which it is run. The -X switch tells the remote server to display client win-</p>
<p class="calibre1">dows through the SSH connection so that they appear on the local desktop, </p>
<p class="calibre1">not the remote system. This allows you to interact with those client windows </p>
<p class="calibre1">and configure software as necessary. Listing 4-9 explains the details. </p>
<p class="calibre1">richard@ubuntu:~$ <b class="calibre3">ssh -X serverdemo@192.168.2.128</b></p>
<p class="calibre1">The authenticity of host '192.168.2.128 (192.168.2.128)' can't be established. </p>
<p class="calibre1">ECDSA key fingerprint is 7f:a5:75:69:66:07:d9:1a:90:e5:42:1a:91:5a:ab:65. </p>
<p class="calibre1">Are you sure you want to continue connecting (yes/no)? <b class="calibre3">yes</b></p>
<p class="calibre1">Warning: Permanently added '192.168.2.128' (ECDSA) to the list of known hosts. </p>
<p class="calibre1">serverdemo@192.168.2.128's password: <b class="calibre3">******</b></p>
<p class="calibre1">Welcome to Ubuntu 12.04.2 LTS (GNU/Linux 3.2.0-37-generic x86_64)</p>
<p class="calibre1">* Documentation:  https://help.ubuntu.com/</p>
<p class="calibre1">System information as of Sun Feb 10 10:02:59 EST 2014</p>
<p class="calibre1">System load:  0.0               Processes:           94</p>
<p class="calibre1">Usage of /:   7.2% of 35.20GB   Users logged in:     1</p>
<p class="calibre1">Memory usage: 7%                IP address for eth0: 192.168.2.128</p>
<p class="calibre1">Swap usage:   0%</p>
<p class="calibre1">Graph this data and manage this system at https://landscape.canonical.com/</p>
<p class="calibre1"><b class="calibre3">90</b>   Chapter 4</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p125"/><img src="index-125_1.jpg" alt="Image 61" class="calibre2"/></p>
<p class="calibre1"><img src="index-125_2.png" alt="Image 62" class="calibre2"/></p>
<p class="calibre1">Last login: Sun Feb 10 09:59:57 2014</p>
<p class="calibre1">/usr/bin/xauth:  file /home/serverdemo/.Xauthority does not exist</p>
<p class="calibre1">serverdemo@serverdemo:~$ <b class="calibre3">sudo sosetup</b></p>
<p class="calibre1">[sudo] password for serverdemo: <b class="calibre3">*******</b></p>
<p class="calibre1"> <i class="calibre4">Listing 4-9: Connecting to the SO server and configuring X forwarding</i></p>
<p class="calibre1">When you run <b class="calibre3">sudo sosetup</b>, you will see a screen appear on your local </p>
<p class="calibre1">workstation, like the one shown in Figure 4-13. </p>
<p class="calibre1"> <i class="calibre4">Figure 4-13: Preparing to run SO Setup</i></p>
<p class="calibre1">Now configure this SO server in the same manner as when configur-</p>
<p class="calibre1">ing the SO server built on the  <i class="calibre4">.iso</i> file earlier in this chapter, i<a href="#p112">n “Configuring </a></p>
<p class="calibre1"><a href="#p112">Your SO Server” on page 78</a>. Once you’ve made your choices, the setup wizard will summarize them and ask whether you want to proceed with </p>
<p class="calibre1">the changes, as shown in Figure 4-14. </p>
<p class="calibre1"> <i class="calibre4">Figure 4-14: SO summary before proceeding with SO server changes</i></p>
<p class="calibre1">After you click <b class="calibre3">Yes, proceed with the changes! </b>, the setup wizard will </p>
<p class="calibre1">complete installation. </p>
<p class="calibre1">As discussed i<a href="#p112">n “Configuring Your SO Server” on page 78, t</a>o confirm the installation was successful, visit the web page hosted on the server and </p>
<p class="calibre1">access a web-enabled NSM application like Snorby. </p>
<p class="calibre1">With your server active, it’s time to build a sensor. </p>
<p class="calibre1">Distributed Deployment   <b class="calibre3">91</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p126"/><img src="index-126_1.png" alt="Image 63" class="calibre2"/></p>
<p class="calibre1"><b class="calibre3">building an So Sensor using PPas</b></p>
<p class="calibre1">With the server running, we can turn to building an SO sensor using PPAs. </p>
<p class="calibre1">This sensor will cooperate with the server we just built. We’ll continue the </p>
<p class="calibre1">theme of using an Ubuntu server distribution as our operating system, and </p>
<p class="calibre1">add SO components using PPAs. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Instal ing Ubuntu Server as the SO Sensor Operating System</b></i></p>
<p class="calibre1">Begin the Ubuntu server installation process by booting the Ubuntu Server </p>
<p class="calibre1">LTS  <i class="calibre4">.iso</i> file on the hardware chosen to run the SO sensor. The installation </p>
<p class="calibre1">wizard will prompt you to make a number of choices. Make the following </p>
<p class="calibre1">selections, adjusted as appropriate for your environment:</p>
<p class="calibre1">1.  Language: <b class="calibre3">English</b></p>
<p class="calibre1">2. <b class="calibre3">Install Ubuntu Server</b></p>
<p class="calibre1">3.  Select a language: <b class="calibre3">English</b></p>
<p class="calibre1">4.  Select your location: <b class="calibre3">United States</b></p>
<p class="calibre1">5.  Configure the keyboard: </p>
<p class="calibre1">•  Detect keyboard layout? <b class="calibre3">No</b></p>
<p class="calibre1">•  <b class="calibre3">English (US)</b></p>
<p class="calibre1">•  Keyboard layout: <b class="calibre3">English (US)</b></p>
<p class="calibre1">6.  Configure the network. Hostname: <b class="calibre3">sensordemo</b></p>
<p class="calibre1">When prompted to choose a primary network interface (as in Fig-</p>
<p class="calibre1">ure 4-15), you must tell the setup wizard which NIC to use for management. </p>
<p class="calibre1">In Figure 4-15, I select eth0 for management as the primary network inter-</p>
<p class="calibre1">face. The setup wizard should automatically look for an IP address from a </p>
<p class="calibre1">DHCP server for eth0. (We’ll set a static IP when we run the SO setup script.)</p>
<p class="calibre1"> <i class="calibre4">Figure 4-15: Selecting the primary network interface</i></p>
<p class="calibre1">Now follow these steps to continue installing the operating system. </p>
<p class="calibre1">I’ve entered values like usernames and passwords for demonstration only. </p>
<p class="calibre1">Choose values that meet your needs in production. </p>
<p class="calibre1"><b class="calibre3">92</b>   Chapter 4</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p127"/><img src="index-127_1.png" alt="Image 64" class="calibre2"/></p>
<p class="calibre1">1.  Set up users and passwords:</p>
<p class="calibre1">•  Full name for the new user: <b class="calibre3">sensordemo</b></p>
<p class="calibre1">•  Username for your account: <b class="calibre3">sensordemo</b></p>
<p class="calibre1">•  Choose a password for the new user: <b class="calibre3">&lt;enter password&gt; </b></p>
<p class="calibre1">•  Reenter password to verify: <b class="calibre3">&lt;enter password&gt; </b></p>
<p class="calibre1">•  Encrypt your home directory? <b class="calibre3">No</b></p>
<p class="calibre1">2.  Configure the clock. Is this time zone correct? <b class="calibre3">Yes</b></p>
<p class="calibre1">3.  Partition disks:</p>
<p class="calibre1">•  Partitioning method: <b class="calibre3">Guided – use entire disk and set up LVM</b></p>
<p class="calibre1">•  Select disk to partition: <b class="calibre3">&lt;choose your disk&gt; </b></p>
<p class="calibre1">•  Write the changes to disks and configure LVM? <b class="calibre3">Yes</b></p>
<p class="calibre1">•  Amount of volume group to use for guided partitioning: <b class="calibre3">&lt;accept </b></p>
<p class="calibre1"><b class="calibre3">default&gt;, Continue</b></p>
<p class="calibre1">•  Write the changes to disks? <b class="calibre3">Yes</b></p>
<p class="calibre1">4.  Configure the package manager. HTTP proxy information (blank for </p>
<p class="calibre1">none): <b class="calibre3">&lt;blank&gt;, Continue</b></p>
<p class="calibre1">5.  Configure tasksel. How do you want to manage upgrades on this sys-</p>
<p class="calibre1">tem? <b class="calibre3">No automatic updates. </b></p>
<p class="calibre1">6.  Software select ion. Choose software to install: <b class="calibre3">&lt;click spacebar on </b></p>
<p class="calibre1"><b class="calibre3">OpenSSH server&gt;, Continue</b></p>
<p class="calibre1">7.  Install the GRUB boot loader on a hard disk. Install the GRUB boot </p>
<p class="calibre1">loader to the master boot record? <b class="calibre3">Yes</b></p>
<p class="calibre1">8.  Finish the installation. <b class="calibre3">Continue</b></p>
<p class="calibre1">When the installation is complete, the system will reboot. </p>
<p class="calibre1">Upon log in, you may see the IP address assigned via DHCP, along with </p>
<p class="calibre1">various messages. Note the IP address if it’s displayed. If the system is under </p>
<p class="calibre1">load, you may not see the system information screen that reports an IP </p>
<p class="calibre1">address. To get the IP address of the management NIC, run <b class="calibre3">ifconfig eth0</b> </p>
<p class="calibre1">at the command prompt, as shown in Figure 4-16. </p>
<p class="calibre1"> <i class="calibre4">Figure 4-16: Running ifconfig eth0 to learn the management IP address</i></p>
<p class="calibre1">Distributed Deployment   <b class="calibre3">93</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p128"/>Now it’s time to update the sensor software. Connect to the server with OpenSSH and enter this command: </p>
<p class="calibre1">$ <b class="calibre3">sudo apt-get update &amp;&amp; sudo apt-get dist-upgrade</b></p>
<p class="calibre1">Type <b class="calibre3">Y</b> to continue when prompted, and then press enter. The sensor </p>
<p class="calibre1">should download and install updates. When it’s finished, enter the <b class="calibre3">sudo </b></p>
<p class="calibre1"><b class="calibre3">reboot</b> command to restart the server and complete the process. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Configuring the System as a Sensor</b></i></p>
<p class="calibre1">Our next task is to configure the SO sensor. First, enter the following com-</p>
<p class="calibre1">mand to tell MySQL not to prompt for a root password during installation. </p>
<p class="calibre1">$ <b class="calibre3">echo "debconf debconf/frontend select noninteractive" | sudo debconf-set-selections</b> Now install the python-software-properties package. </p>
<p class="calibre1">$ <b class="calibre3">sudo apt-get -y install python-software-properties</b></p>
<p class="calibre1">Next, add the securityonion/stable PPA to the list of repositories recog-</p>
<p class="calibre1">nized by this Ubuntu system, as shown in Listing 4-10. </p>
<p class="calibre1">$ <b class="calibre3">sudo add-apt-repository -y ppa:securityonion/stable</b></p>
<p class="calibre1">gpg: keyring `/tmp/tmpBByK4H/secring.gpg' created </p>
<p class="calibre1">gpg: keyring `/tmp/tmpBByK4H/pubring.gpg' created</p>
<p class="calibre1">gpg: requesting key 23F386C7 from hkp server keyserver.ubuntu.com</p>
<p class="calibre1">gpg: /tmp/tmpBByK4H/trustdb.gpg: trustdb created</p>
<p class="calibre1">gpg: key 23F386C7: public key "Launchpad PPA for Security Onion" imported</p>
<p class="calibre1">gpg: Total number processed: 1</p>
<p class="calibre1">gpg:               imported: 1  (RSA: 1)</p>
<p class="calibre1">OK</p>
<p class="calibre1"> <i class="calibre4">Listing 4-10: Adding the securityonion/stable PPA to the list of repositories</i></p>
<p class="calibre1">Update the package listing with the following command. </p>
<p class="calibre1">$ <b class="calibre3">sudo apt-get update</b></p>
<p class="calibre1">Install the following packages. </p>
<p class="calibre1">$ <b class="calibre3">sudo apt-get install securityonion-sensor securityonion-elsa securityonion-elsa-extras</b> When asked whether you want to continue, answer <b class="calibre3">Y</b> and press enter. </p>
<p class="calibre1"><b class="calibre3">94</b>   Chapter 4</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p129"/><img src="index-129_1.png" alt="Image 65" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Running the Setup Wizard</b></i></p>
<p class="calibre1">In order to run the setup wizard we need to use OpenSSH and X forward-</p>
<p class="calibre1">ing. Do the following, but use the username and IP address appropriate for </p>
<p class="calibre1">your environment. In Listing 4-11, I chose sensordemo as the username, and </p>
<p class="calibre1">the IP address assigned via DHCP was 192.168.2.147. </p>
<p class="calibre1">richard@ubuntu:~$ <b class="calibre3">ssh -X sensordemo@192.168.2.147</b></p>
<p class="calibre1">The authenticity of host '192.168.2.147 (192.168.2.147)' can't be established. </p>
<p class="calibre1">ECDSA key fingerprint is a5:a9:08:16:b5:d2:3c:ce:59:f7:08:91:a0:04:0b:47. </p>
<p class="calibre1">Are you sure you want to continue connecting (yes/no)? <b class="calibre3">yes</b></p>
<p class="calibre1">Warning: Permanently added '192.168.2.147' (ECDSA) to the list of known hosts. </p>
<p class="calibre1">sensordemo@192.168.2.147's password: <b class="calibre3">*******</b></p>
<p class="calibre1">Welcome to Ubuntu 12.04.2 LTS (GNU/Linux 3.2.0-37-generic x86_64)</p>
<p class="calibre1">* Documentation:  https://help.ubuntu.com/</p>
<p class="calibre1">System information as of Sun Feb 10 13:06:46 EST 2013</p>
<p class="calibre1">System load:  0.11              Processes:           82</p>
<p class="calibre1">Usage of /:   5.3% of 35.20GB   Users logged in:     1</p>
<p class="calibre1">Memory usage: 1%                IP address for eth0: 192.168.2.147</p>
<p class="calibre1">Swap usage:   0%</p>
<p class="calibre1">Graph this data and manage this system at https://landscape.canonical.com/</p>
<p class="calibre1">Last login: Sun Feb 10 13:03:59 2013</p>
<p class="calibre1">/usr/bin/xauth:  file /home/sensordemo/.Xauthority does not exist</p>
<p class="calibre1">sensordemo@sensordemo:~$ <b class="calibre3">sudo sosetup</b></p>
<p class="calibre1">[sudo] password for sensordemo: <b class="calibre3">******</b></p>
<p class="calibre1"> <i class="calibre4">Listing 4-11: Connecting to the SO sensor and configuring X forwarding</i></p>
<p class="calibre1">When you run this command, you will see a screen like the one shown </p>
<p class="calibre1">in Figure 4-17. You will need to configure network interfaces because this </p>
<p class="calibre1">platform is a sensor. </p>
<p class="calibre1"> <i class="calibre4">Figure 4-17: Prompt to configure network interfaces</i></p>
<p class="calibre1">Distributed Deployment   <b class="calibre3">95</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p130"/><img src="index-130_1.png" alt="Image 66" class="calibre2"/></p>
<p class="calibre1"><img src="index-130_2.png" alt="Image 67" class="calibre2"/></p>
<p class="calibre1">Remember to use the IP address, username, and password of the SO </p>
<p class="calibre1">server from the PPAs. The setup wizard will summarize your configuration </p>
<p class="calibre1">choices and ask whether you wish to proceed with the changes, as shown in </p>
<p class="calibre1">Figure 4-18. </p>
<p class="calibre1"> <i class="calibre4">Figure 4-18: SO summary before proceeding with changes to the network interface</i></p>
<p class="calibre1">After the system reboots, connect to the SO sensor again via </p>
<p class="calibre1">OpenSSH and enable X forwarding. Rerun the setup wizard, and then </p>
<p class="calibre1">choose <b class="calibre3">Advanced Setup</b>4<b class="calibre3">Sensor</b>. Enter the IP or hostname of the SO </p>
<p class="calibre1">server, followed by the username that can connect via OpenSSH and run </p>
<p class="calibre1">sudo. Choose the appropriate NIC to monitor, enable ELSA, update the </p>
<p class="calibre1">ELSA server, and then review the summarization of changes, which will </p>
<p class="calibre1">look similar to Figure 4-19. </p>
<p class="calibre1"> <i class="calibre4">Figure 4-19: SO summary before proceeding with sensor changes</i></p>
<p class="calibre1"><b class="calibre3">96</b>   Chapter 4</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p131"/>You will be prompted to continue connecting via OpenSSH when the </p>
<p class="calibre1">authenticity of the SO server’s ECDSA key cannot be verified. You will also </p>
<p class="calibre1">need to log in to the SO server, and then enter the sudo password. Once </p>
<p class="calibre1">you’ve finished, the setup wizard will report that it is complete. After the </p>
<p class="calibre1">GUI disappears, run the status script to see if the NSM applications are </p>
<p class="calibre1">running, as shown in Listing 4-12. </p>
<p class="calibre1">$ <b class="calibre3">sudo service nsm status</b></p>
<p class="calibre1">Status: HIDS</p>
<p class="calibre1">* ossec_agent (sguil)                                                [  OK  ]</p>
<p class="calibre1">Status: Bro</p>
<p class="calibre1">Name              Type       Host           Status        Pid    Peers  Started              </p>
<p class="calibre1">manager           manager    192.168.2.131  running       3173   2      10 Feb 18:18:27  </p>
<p class="calibre1">proxy             proxy      192.168.2.131  running       3228   2      10 Feb 18:18:29  </p>
<p class="calibre1">sensordemo-eth1-1 worker     192.168.2.131  running       3275   2      10 Feb 18:18:32  </p>
<p class="calibre1">Status: sensordemo-eth1</p>
<p class="calibre1">* netsniff-ng (full packet data)                                     [  OK  ]</p>
<p class="calibre1">* pcap_agent (sguil)                                                 [  OK  ]</p>
<p class="calibre1">* snort_agent (sguil)                                                [  OK  ]</p>
<p class="calibre1">* suricata (alert data)                                              [  OK  ]</p>
<p class="calibre1">* barnyard2 (spooler, unified2 format)                               [  OK  ]</p>
<p class="calibre1">* prads (sessions/assets)                                            [  OK  ]</p>
<p class="calibre1">* sancp_agent (sguil)                                                [  OK  ]</p>
<p class="calibre1">* pads_agent (sguil)                                                 [  OK  ]</p>
<p class="calibre1">* argus                                                              [  OK  ]</p>
<p class="calibre1">* http_agent (sguil)                                                 [  OK  ]</p>
<p class="calibre1"> <i class="calibre4">Listing 4-12: Checking NSM service status</i></p>
<p class="calibre1">Also check for the establishment of the autossh tunnel as shown in </p>
<p class="calibre1">Listing 4-13. </p>
<p class="calibre1">$ <b class="calibre3">ps aux | grep autoss[h]</b></p>
<p class="calibre1">root      3046  0.0  0.0   4308   320 ?        Ss   18:18   0:00 /usr/lib/</p>
<p class="calibre1">autossh/autossh -M 0    -q -N -o ServerAliveInterval 60 -o ServerAliveCountMax </p>
<p class="calibre1">3 -i /root/.ssh/securityonion -L 3306:127.0.0.1:3306 -R 50000:localhost:50000 </p>
<p class="calibre1">-R 50001:localhost:9306 serverdemo@192.168.2.128</p>
<p class="calibre1"> <i class="calibre4">Listing 4-13: Looking for autossh processes</i></p>
<p class="calibre1">These results (with OK in every field) are all good signs. If you get differ-</p>
<p class="calibre1">ent results, try rerunning the setup wizard. </p>
<p class="calibre1">To verify that everything is working as expected, access the web server </p>
<p class="calibre1">running on your new SO server, and then run Snorby and look for events </p>
<p class="calibre1">captured by the Suricata IDS engine. If you see events, congratulations—</p>
<p class="calibre1">you’ve built a distributed NSM system using Ubuntu Linux PPAs! </p>
<p class="calibre1">Distributed Deployment   <b class="calibre3">97</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p132"/><b class="calibre3">conclusion</b></p>
<p class="calibre1">In this chapter, you took a step beyond the normal stand-alone SO model </p>
<p class="calibre1">and entered the world of distributed NSM operations. We looked at two </p>
<p class="calibre1">possible ways to deploy server-plus-sensor systems:</p>
<p class="calibre1">•  Using the  <i class="calibre4">.iso</i> images provided by the SO project to build an SO server, </p>
<p class="calibre1">and then using the same  <i class="calibre4">.iso</i> file to build an SO sensor. </p>
<p class="calibre1">•  Using a standard  <i class="calibre4">.iso</i> image from the Ubuntu Server distribution to </p>
<p class="calibre1">replace the SO project  <i class="calibre4">.iso</i> file. We used SO project PPAs to build an </p>
<p class="calibre1">SO server and an SO sensor. </p>
<p class="calibre1">Using each approach—an  <i class="calibre4">.iso</i> file from the SO project or a “stock”  <i class="calibre4">.iso</i> </p>
<p class="calibre1">from the Ubuntu developers—we built a distributed NSM setup. </p>
<p class="calibre1">In Chapter 5, we’ll take a brief look at a variety of SO housekeeping </p>
<p class="calibre1">issues, such as keeping platforms up-to-date, limiting network access for </p>
<p class="calibre1">security purposes, and managing platform storage. </p>
<p class="calibre1"><b class="calibre3">98</b>   Chapter 4</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p133"/><b class="calibre3">5</b></p>
<p class="calibre1"><b class="calibre3">S o   P l aT f o r M   h o u S e k e e P i N g</b></p>
<p class="calibre1">In Chapters 3 and 4, we built stand-alone, </p>
<p class="calibre1">server, and sensor SO platforms. All of </p>
<p class="calibre1">these platforms are Linux systems that </p>
<p class="calibre1">require a certain amount of care and house-</p>
<p class="calibre1">keeping. This chapter explains key tasks common to </p>
<p class="calibre1">all three systems. These administrative duties include </p>
<p class="calibre1">keeping software up-to-date, limiting network access to promote security, </p>
<p class="calibre1">and managing system storage. By following the recommendations in this </p>
<p class="calibre1">chapter, you’ll keep your SO platforms running smoothly while providing </p>
<p class="calibre1">vital data to NSM analysts. </p>
<p class="calibre1"><b class="calibre3">keeping So up-to-date</b></p>
<p class="calibre1">All NSM platforms run code that may need to be updated periodically, </p>
<p class="calibre1">and SO is no different. If you don’t periodically update the operating sys-</p>
<p class="calibre1">tem and various applications, you could find yourself running code with </p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p134"/><img src="index-134_1.jpg" alt="Image 68" class="calibre2"/></p>
<p class="calibre1"><img src="index-134_2.jpg" alt="Image 69" class="calibre2"/></p>
<p class="calibre1">vulnerabilities. Thankfully, SO is not difficult to update. The easiest path is </p>
<p class="calibre1">to use the GUI, but the SO team recommends updating from the command </p>
<p class="calibre1">line because that approach provides a little more control over the update </p>
<p class="calibre1">process. We’ll start with the simplest method, and then look at using the </p>
<p class="calibre1">recommended one. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Updating via the GUI</b></i></p>
<p class="calibre1">To update via the GUI, log in to the SO console. You may see a notice like </p>
<p class="calibre1">the one shown in Figure 5-1, informing you that updates are available. </p>
<p class="calibre1"> <i class="calibre4">Figure 5-1: SO informs you when updates are available. </i></p>
<p class="calibre1">Click the exclamation point icon to open a menu with update options, </p>
<p class="calibre1">and select <b class="calibre3">Show Updates</b>. You will likely see both important and recom-</p>
<p class="calibre1">mended updates, as shown in Figure 5-2. </p>
<p class="calibre1"> <i class="calibre4">Figure 5-2: Important security updates and recommended updates are available. </i></p>
<p class="calibre1"><b class="calibre3">100</b>   Chapter 5</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p135"/>I suggest installing all updates. The exception is if the SO project has encountered problems with certain updates, in which case it may suggest </p>
<p class="calibre1">additional procedures to follow or certain updates to avoid. If there are warn-</p>
<p class="calibre1">ings, they will be posted on the SO website at  <i class="calibre4">http://securityonion.blogspot.com/</i>. </p>
<p class="calibre1">To continue, click <b class="calibre3">Install Updates</b>. When finished, the Update Manager </p>
<p class="calibre1">will report that the software is up-to-date, and it may require a system reboot. </p>
<p class="calibre1">Follow any additional instructions. </p>
<p class="calibre1">As you can see, updates via the GUI are easy. However, you can find </p>
<p class="calibre1">yourself accepting updates that might not be compatible with the recom-</p>
<p class="calibre1">mendations of the SO project. For example, MySQL database updates can </p>
<p class="calibre1">be tricky. For this reason, I suggest following the SO project’s suggestion: </p>
<p class="calibre1">update via the command line. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Updating via the Command Line</b></i></p>
<p class="calibre1">The SO project blog posts usually tell users to conduct updates via the com-</p>
<p class="calibre1">mand line, and provide specific syntax. To perform a generic update, open </p>
<p class="calibre1">a terminal on the desktop and enter the following:</p>
<p class="calibre1">$ <b class="calibre3">sudo apt-get update</b></p>
<p class="calibre1">Now check for outdated software with the command shown in Listing 5-1. </p>
<p class="calibre1">$ <b class="calibre3">sudo apt-get upgrade</b></p>
<p class="calibre1">Reading package lists... Done</p>
<p class="calibre1">Building dependency tree</p>
<p class="calibre1">Reading state information... Done</p>
<p class="calibre1">The following packages will be upgraded:</p>
<p class="calibre1">ecryptfs-utils fonts-opensymbol gstreamer0.10-plugins-good</p>
<p class="calibre1">gstreamer0.10-pulseaudio language-selector-common language-selector-gnome</p>
<p class="calibre1">libecryptfs0 libpciaccess0 libpq5</p>
<p class="calibre1">9 upgraded, 0 newly installed, 0 to remove and 0 not upgraded. </p>
<p class="calibre1">Need to get 2,861 kB of archives. </p>
<p class="calibre1">After this operation, 114 kB disk space will be freed. </p>
<p class="calibre1">Do you want to continue [Y/n]? </p>
<p class="calibre1"> <i class="calibre4">Listing 5-1: Running sudo apt-get upgrade</i></p>
<p class="calibre1">Remembering to heed any warnings about updates from the SO team, </p>
<p class="calibre1">decide if you want to continue, and respond with yes or no. If you answer <b class="calibre3">Y</b>, </p>
<p class="calibre1">Apt will download and install updates. </p>
<p class="calibre1">Reboot to make sure that your SO applications are working correctly. </p>
<p class="calibre1"><b class="calibre3">N o T e </b> <i class="calibre4"> </i></p>
<p class="calibre1"> <i class="calibre4">See the appendix for more guidance on updating SO. </i></p>
<p class="calibre1">SO Platform Housekeeping   <b class="calibre3">101</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p136"/><b class="calibre3">limiting access to So</b></p>
<p class="calibre1">By default, SO ships with the Linux iptables firewall enabled. A local fire-</p>
<p class="calibre1">wall like iptables helps enforce a network security policy appropriate for a </p>
<p class="calibre1">server. To see the default access control settings, run the Uncomplicated </p>
<p class="calibre1">Firewall (UFW) configuration program with <b class="calibre3">sudo ufw status</b>. (I added the </p>
<p class="calibre1">rightmost column to Listing 5-2 manually to show the services associated </p>
<p class="calibre1">with each open port.)</p>
<p class="calibre1">$ <b class="calibre3">sudo ufw status</b></p>
<p class="calibre1">[sudo] password for sademo: <b class="calibre3">******</b></p>
<p class="calibre1">Status: active</p>
<p class="calibre1">To                         Action      From</p>
<p class="calibre1">--                         ------      ----</p>
<p class="calibre1">22/tcp                     ALLOW       Anywhere OpenSSH</p>
<p class="calibre1">514                        ALLOW       Anywhere Syslog</p>
<p class="calibre1">1514/udp                   ALLOW       Anywhere OSSEC</p>
<p class="calibre1">443/tcp                    ALLOW       Anywhere Apache</p>
<p class="calibre1">444/tcp                    ALLOW       Anywhere Snorby</p>
<p class="calibre1">7734/tcp                   ALLOW       Anywhere Sguil client to server</p>
<p class="calibre1">7736/tcp                   ALLOW       Anywhere Sguil agents to server</p>
<p class="calibre1">3154/tcp                   ALLOW       Anywhere ELSA</p>
<p class="calibre1">22/tcp                     ALLOW       Anywhere (v6)  OpenSSH</p>
<p class="calibre1">514                        ALLOW       Anywhere (v6)  Syslog</p>
<p class="calibre1">1514/udp                   ALLOW       Anywhere (v6)  OSSEC</p>
<p class="calibre1">443/tcp                    ALLOW       Anywhere (v6)  Apache</p>
<p class="calibre1">444/tcp                    ALLOW       Anywhere (v6)  Snorby</p>
<p class="calibre1">7734/tcp                   ALLOW       Anywhere (v6)  Sguil client to server</p>
<p class="calibre1">7736/tcp                   ALLOW       Anywhere (v6)  Sguil agents to server</p>
<p class="calibre1">3154/tcp                   ALLOW       Anywhere (v6)  ELSA</p>
<p class="calibre1"> <i class="calibre4">Listing 5-2: Firewal  policy</i></p>
<p class="calibre1">The firewall policy listed by this command shows all of the ALLOW state-</p>
<p class="calibre1">ments permitting network traffic to designated ports. The firewall policy </p>
<p class="calibre1">implicitly denies inbound access to any other ports. That means that if, for </p>
<p class="calibre1">example, you need to modify the configuration to start your Apache web </p>
<p class="calibre1">server on another port, you will need to change the iptables firewall access </p>
<p class="calibre1">control lists accordingly. </p>
<p class="calibre1">In the default configuration, Apache listens on port 443 TCP, and </p>
<p class="calibre1">remote systems are allowed to connect to port 443 TCP per the firewall </p>
<p class="calibre1">policy. Apache listening on port 4443, however, would be unreachable </p>
<p class="calibre1">unless an administrator changed the firewall policy. </p>
<p class="calibre1">Rather than expose more ports to remote access, some administrators </p>
<p class="calibre1">choose to limit the number of services that listen on public interfaces. Instead </p>
<p class="calibre1">of letting applications listen on the public network interface, administrators </p>
<p class="calibre1">“bind” them to nonpublic interfaces. </p>
<p class="calibre1">One way to use nonpublic interfaces for tighter security is to configure </p>
<p class="calibre1">an application to listen only on localhost (127.0.0.1). When an application </p>
<p class="calibre1"><b class="calibre3">102</b>   Chapter 5</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p137"/>is listening only on localhost, it can’t be reached remotely; it can be reached only via the local system (hence the localhost, nonpublic IP address). </p>
<p class="calibre1">However, you can “simulate” local access by cleverly configuring OpenSSH. </p>
<p class="calibre1">You can set up an SSH proxy from an authorized remote client to the sen-</p>
<p class="calibre1">sor running the application listening on localhost. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Connecting via a SOCKS Proxy </b></i></p>
<p class="calibre1">To demonstrate accessing an application listening only on localhost, we’ll </p>
<p class="calibre1">work with the Xplico application. You may remember seeing a warning </p>
<p class="calibre1">on the SO welcome page that says port 9876 TCP for Xplico isn’t available </p>
<p class="calibre1">remotely. By default, if you try to connect from a remote computer to port </p>
<p class="calibre1">9876 TCP on an SO system, iptables will deny the connection. Port 9876 TCP </p>
<p class="calibre1">is available locally. If you open a web browser on the SO platform itself and </p>
<p class="calibre1">point it to port 9876 TCP, Xplico is listening. </p>
<p class="calibre1">If you want to access Xplico from your desktop, though, you need </p>
<p class="calibre1">to simulate local access. You can connect to that port if you use SSH as a </p>
<p class="calibre1">SOCKS proxy (a protocol designed to allow this sort of “tunnel” that simu-</p>
<p class="calibre1">lates local access). </p>
<p class="calibre1">Setting up a SOCKS proxy using SSH will allow you to remotely access </p>
<p class="calibre1">an application listening only on localhost. You can achieve this goal using </p>
<p class="calibre1">either a Microsoft Windows desktop or a Linux desktop. </p>
<p class="calibre1">If your remote client runs Microsoft Windows, you can use the free PuTTY </p>
<p class="calibre1">( <i class="calibre4">http://www.chiark.greenend.org.uk/~sgtatham/putty/</i>) SSH client. PuTTY is </p>
<p class="calibre1">available as a single  <i class="calibre4">.exe</i> binary that doesn’t require any sort of installation procedure. Follow these steps:</p>
<p class="calibre1">1.  Run the  <i class="calibre4">putty.exe</i> program and navigate to <b class="calibre3">Connection</b>4<b class="calibre3">SSH</b>4<b class="calibre3">Tunnels</b>. </p>
<p class="calibre1">In the Source port field, enter a TCP port that will listen on your local </p>
<p class="calibre1">system. (In this example, I use 8080 TCP). </p>
<p class="calibre1">2.  Select the <b class="calibre3">Dynamic</b> and <b class="calibre3">Auto</b> radio buttons, and then click <b class="calibre3">Add</b>. Your setup should look like Figure 5-3. </p>
<p class="calibre1">3.  Return to PuTTY’s Session section and enter the hostname or IP address </p>
<p class="calibre1">and port of your remote SO stand-alone system, and then click <b class="calibre3">Open</b>. </p>
<p class="calibre1">4.  Log in to the SO system with the username and password you chose </p>
<p class="calibre1">during setup. </p>
<p class="calibre1">5.  Open your web browser and choose the option for configuring network </p>
<p class="calibre1">settings. For example, if you’re using Firefox, choose <b class="calibre3">Options</b>4<b class="calibre3">Network</b>4 </p>
<p class="calibre1"><b class="calibre3">Settings</b>, and then configure the connection settings for Manual Proxy </p>
<p class="calibre1">Configuration with SOCKS Host set to 127.0.0.1 and Port set to the port </p>
<p class="calibre1">you configured in PuTTY. Figure 5-4 shows my settings. Click <b class="calibre3">OK</b> to </p>
<p class="calibre1">continue. </p>
<p class="calibre1">6.  Point Firefox to  <i class="calibre4">https://127.0.0.1:9876</i>. Your browser should redirect to </p>
<p class="calibre1"> <i class="calibre4">https://127.0.0.1:9876/users/login</i> and warn that Xplico is not running. </p>
<p class="calibre1">This is okay; you’ve accessed the web server at port 9876 TCP, which </p>
<p class="calibre1">was previously not reachable remotely. </p>
<p class="calibre1">SO Platform Housekeeping   <b class="calibre3">103</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p138"/><img src="index-138_1.png" alt="Image 70" class="calibre2"/></p>
<p class="calibre1"><img src="index-138_2.png" alt="Image 71" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 5-3: Configuring PuTTY for SSH port forwarding</i></p>
<p class="calibre1"> <i class="calibre4">Figure 5-4: Configuring proxy set ings in Firefox</i></p>
<p class="calibre1"><b class="calibre3">104</b>   Chapter 5</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p139"/>If your remote client is a Linux system, you can achieve the same goal using the integrated SSH client. On your Linux desktop, run the following </p>
<p class="calibre1">command:</p>
<p class="calibre1"><b class="calibre3">ssh -L 9876:localhost:9876  <i class="calibre4">username</i></b><b class="calibre3">@ <i class="calibre4">SO server IP</i></b></p>
<p class="calibre1">With your tunnel established, follow steps 4 and 5 in the preceding pro-</p>
<p class="calibre1">cedure for configuring the Firefox web browser for a Windows remote client </p>
<p class="calibre1">and accessing the web server. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Changing the Firewall Policy </b></i></p>
<p class="calibre1">If you don’t want to tunnel traffic to bypass the firewall, you could modify </p>
<p class="calibre1">the firewall rules. For example, the following command changes the ruleset </p>
<p class="calibre1">to permit remote access to port 9876 TCP. </p>
<p class="calibre1">$ <b class="calibre3">sudo ufw allow 9876/tcp</b></p>
<p class="calibre1">Rule added</p>
<p class="calibre1">Rule added (v6)</p>
<p class="calibre1">To disallow that port again, enter this:</p>
<p class="calibre1">$ <b class="calibre3">sudo ufw deny 9876/tcp</b></p>
<p class="calibre1">Rule updated</p>
<p class="calibre1">Rule updated (v6)</p>
<p class="calibre1">See the SO wiki for more information about configuring the firewall </p>
<p class="calibre1">( <i class="calibre4">https://code.google.com/p/security-onion/wiki/Firewall</i>). </p>
<p class="calibre1"><b class="calibre3">Managing So data Storage</b></p>
<p class="calibre1">As soon as you install and configure SO and cable its sniffing interface to a </p>
<p class="calibre1">live network, the NSM software begins collecting and interpreting traffic. </p>
<p class="calibre1">The SO sensors store a variety of NSM datatypes, but two directories are of </p>
<p class="calibre1">particular interest:</p>
<p class="calibre1">•  The  <i class="calibre4">/nsm</i> directory stores logs and full content data. </p>
<p class="calibre1">•  The  <i class="calibre4">/var/lib/mysql</i> directory holds SO’s databases. </p>
<p class="calibre1">The  <i class="calibre4">/nsm</i> directory typically uses more drive space than  <i class="calibre4">/var/lib/mysql</i>. </p>
<p class="calibre1">SO saves full content data in the  <i class="calibre4">/nsm/sensor_data/&lt;sensorname-interface&gt;/</i></p>
<p class="calibre1"> <i class="calibre4">dailylogs/YYYY-MM-DD</i> directories with filenames in  <i class="calibre4">snort.log.&lt;Unix timestamp&gt;</i> format. Although the filenames have  <i class="calibre4">snort</i> in the title, the content is in the familiar pcap format. Listing 5-3 shows full content data stored on a standalone demo SO platform in two directories. </p>
<p class="calibre1">SO Platform Housekeeping   <b class="calibre3">105</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p140"/>sademo@sademo:/nsm/sensor_data/sademo-eth1/dailylogs$ <b class="calibre3">ls -alR</b></p>
<p class="calibre1">.:</p>
<p class="calibre1">total 16</p>
<p class="calibre1">drwxrwxr-x 4 sguil sguil 4096 Feb 16 12:28 . </p>
<p class="calibre1">drwxrwxr-x 7 sguil sguil 4096 Feb 10 11:12 .. </p>
<p class="calibre1">drwxrwxr-x 2 sguil sguil 4096 Feb 10 13:09 2014-02-10</p>
<p class="calibre1">drwxrwxr-x 2 sguil sguil 4096 Feb 16 20:15 2014-02-16</p>
<p class="calibre1">./2013-02-10:</p>
<p class="calibre1">total 118060</p>
<p class="calibre1">drwxrwxr-x 2 sguil sguil      4096 Feb 10 13:09 . </p>
<p class="calibre1">drwxrwxr-x 4 sguil sguil      4096 Feb 16 12:28 .. </p>
<p class="calibre1">-rw-r--r-- 1 root  root  108390541 Feb 10 11:31 snort.log.1360494635</p>
<p class="calibre1">-rw-r--r-- 1 root  root   12485022 Feb 10 13:17 snort.log.1360501765</p>
<p class="calibre1">./2014-02-16:</p>
<p class="calibre1">total 645312</p>
<p class="calibre1">drwxrwxr-x 2 sguil sguil      4096 Feb 16 20:15 . </p>
<p class="calibre1">drwxrwxr-x 4 sguil sguil      4096 Feb 16 12:28 .. </p>
<p class="calibre1">-rw-r--r-- 1 root  root   10637153 Feb 16 12:41 snort.log.1361017706</p>
<p class="calibre1">-rw-r--r-- 1 root  root  122264262 Feb 16 14:29 snort.log.1361019690</p>
<p class="calibre1"> <i class="calibre4">-- snip --</i></p>
<p class="calibre1"> <i class="calibre4">Listing 5-3: Directory contents for </i>/nsm/sensor_data/sademo-eth1/dailylogs</p>
<p class="calibre1">The date on the directory listing is the time the file was last modified. </p>
<p class="calibre1">The date in the  <i class="calibre4">snort.log&lt;Unix timestamp&gt; </i> filename is the time the file was created, in Unix timestamp format. This format is expressed as the number </p>
<p class="calibre1">of seconds elapsed since January 1, 1970. </p>
<p class="calibre1">You can translate the Unix timestamp into more familiar terms with the </p>
<p class="calibre1">date command. For example, running date against the file  <i class="calibre4">snort.log.1360494635</i>, we learn that the trace was created about 21 minutes before the system stopped </p>
<p class="calibre1">writing to it. We know this because the timestamp on the file is Feb 10 11:31, </p>
<p class="calibre1">and the “translated” date from the filename is Feb 10 11:10:35. We can see </p>
<p class="calibre1">that the file was opened at roughly 11:10, and it was last written to 21 minutes </p>
<p class="calibre1">later, at 11:31. </p>
<p class="calibre1">$ <b class="calibre3">date --date='@1360494635' </b></p>
<p class="calibre1">Sun Feb 10 11:10:35 UTC 2013</p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Managing Sensor Storage</b></i></p>
<p class="calibre1">To manage sensor storage, SO scripts check the amount of available hard </p>
<p class="calibre1">drive space regularly. As the used space hits the 90 percent threshold, the </p>
<p class="calibre1">scripts remove old full content (pcap) files from the  <i class="calibre4">/nsm/ sensor_data/ </i></p>
<p class="calibre1"> <i class="calibre4">&lt;sensorname-interface&gt;/dailylogs</i> directories, old Bro logs from  <i class="calibre4">/nsm/bro/logs</i>, old Argus session data from  <i class="calibre4">/nsm/sensor_data/&lt;sensorname-interface&gt;/ </i></p>
<p class="calibre1"> <i class="calibre4">dailylogs/argus</i>, and old Snort Unified2 alert files from  <i class="calibre4">/nsm/sensor_data/ </i></p>
<p class="calibre1"> <i class="calibre4">&lt;sensorname-interface&gt;/snort-&lt;instancenumber&gt; </i>. Part III of this book covers these and other SO tools. For now, it’s important to know that these logs </p>
<p class="calibre1">exist and how the system manages them. </p>
<p class="calibre1"><b class="calibre3">106</b>   Chapter 5</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p141"/>The system works by having the Linux cron command run the  <i class="calibre4">/usr/</i></p>
<p class="calibre1"> <i class="calibre4">sbin/nsm_sensor_clean</i> script hourly, which calls the sensor_cleandisk() func-</p>
<p class="calibre1">tion found in  <i class="calibre4">/usr/lib/nsmnow/lib-nsm-sensor-utils</i>. The sensor_cleandisk() </p>
<p class="calibre1">function in  <i class="calibre4">lib-nsm-sensor-utils</i> contains the 90 percent value that triggers </p>
<p class="calibre1">deleting old logs. Although this daily check at 90 percent works well for </p>
<p class="calibre1">most users, you can change it to suit your needs if necessary. If you want </p>
<p class="calibre1">to change the 90 percent figure, edit it in the  <i class="calibre4">lib-nsm-sensor-utils</i> file. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Checking Database Drive Usage</b></i></p>
<p class="calibre1">To check the size of SO’s databases in  <i class="calibre4">/var/lib/mysql</i>, use MySQL command </p>
<p class="calibre1">shown in Listing 5-4. (Thanks to RolandoMySQLdba for posting this at </p>
<p class="calibre1"> <i class="calibre4">http://pastebin.com/YFqNaVi3/</i>.)</p>
<p class="calibre1">$ <b class="calibre3">mysql -u root</b></p>
<p class="calibre1">Welcome to the MySQL monitor.  Commands end with ; or \g. </p>
<p class="calibre1">Your MySQL connection id is 386507</p>
<p class="calibre1">Server version: 5.5.29-0ubuntu0.12.04.1 (Ubuntu)</p>
<p class="calibre1">Copyright (c) 2000, 2012, Oracle and/or its affiliates. All rights reserved. </p>
<p class="calibre1">Oracle is a registered trademark of Oracle Corporation and/or its</p>
<p class="calibre1">affiliates. Other names may be trademarks of their respective owners. </p>
<p class="calibre1">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement. </p>
<p class="calibre1">mysql&gt; <b class="calibre3">SELECT DBName,CONCAT(LPAD(FORMAT(SDSize/POWER(1024,pw),3),17,' '),' ', </b></p>
<p class="calibre1"><b class="calibre3">    -&gt; SUBSTR(' KMGTP',pw+1,1),'B') "Data Size",CONCAT(LPAD(</b></p>
<p class="calibre1"><b class="calibre3">    -&gt; FORMAT(SXSize/POWER(1024,pw),3),17,' '),' ',SUBSTR(' KMGTP',pw+1,1),'B') "Index Size", </b></p>
<p class="calibre1"><b class="calibre3">    -&gt; CONCAT(LPAD(FORMAT(STSize/POWER(1024,pw),3),17,' '),' ', </b></p>
<p class="calibre1"><b class="calibre3">    -&gt; SUBSTR(' KMGTP',pw+1,1),'B') "Total Size" FROM</b></p>
<p class="calibre1"><b class="calibre3">    -&gt; (SELECT IFNULL(DB,'All Databases') DBName,SUM(DSize) SDSize,SUM(XSize) SXSize, </b></p>
<p class="calibre1"><b class="calibre3">    -&gt; SUM(TSize) STSize FROM (SELECT table_schema DB,data_length DSize, </b></p>
<p class="calibre1"><b class="calibre3">    -&gt; index_length XSize,data_length+index_length TSize FROM information_schema.tables</b></p>
<p class="calibre1"><b class="calibre3">    -&gt; WHERE table_schema NOT IN ('mysql','information_schema','performance_schema')) AAA</b></p>
<p class="calibre1"><b class="calibre3">    -&gt; GROUP BY DB WITH ROLLUP) AA,(SELECT 3 pw) BB ORDER BY (SDSize+SXSize); </b></p>
<p class="calibre1">+------------------+----------------------+----------------------+----------------------+</p>
<p class="calibre1">| DBName           | Data Size            | Index Size           | Total Size           |</p>
<p class="calibre1">+------------------+----------------------+----------------------+----------------------+</p>
<p class="calibre1">| elsa_web         |             0.000 GB |             0.000 GB |             0.000 GB |</p>
<p class="calibre1">| syslog           |             0.014 GB |             0.007 GB |             0.021 GB |</p>
<p class="calibre1">| snorby           |             0.059 GB |             0.020 GB |             0.079 GB |</p>
<p class="calibre1">| syslog_data      |             1.625 GB |             0.050 GB |             1.675 GB |</p>
<p class="calibre1">| securityonion_db |             3.384 GB |             0.377 GB |             3.761 GB |</p>
<p class="calibre1">| All Databases    |             5.082 GB |             0.454 GB |             5.536 GB |</p>
<p class="calibre1">+------------------+----------------------+----------------------+----------------------+</p>
<p class="calibre1">6 rows in set (2.20 sec)</p>
<p class="calibre1"> <i class="calibre4">Listing 5-4: Displaying storage used by database tables</i></p>
<p class="calibre1">In this example, the databases in use occupy a total of 5.536GB. </p>
<p class="calibre1">The securityonion_db database used by Sguil and its components occupies </p>
<p class="calibre1">3.761GB, and the syslog_data database used by ELSA occupies 1.675GB. </p>
<p class="calibre1">SO Platform Housekeeping   <b class="calibre3">107</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p142"/> <i class="calibre4"><b class="calibre3">Managing the Sguil Database</b></i></p>
<p class="calibre1">SO also ships with a sguil-db-purge script to manage the Sguil database </p>
<p class="calibre1">securityonion_db. The configuration file  <i class="calibre4">/etc/nsm/securityonion.conf</i> contains a DAYSTOKEEP variable, as shown in Listing 5-5. </p>
<p class="calibre1">ENGINE=snort</p>
<p class="calibre1">DAYSTOKEEP=365</p>
<p class="calibre1">ELSA=YES</p>
<p class="calibre1"> <i class="calibre4">Listing 5-5: DAYSTOKEEP variable in </i>/etc/nsm/securityonion .conf</p>
<p class="calibre1">When SO runs sguil-db-purge, it removes data older than the default </p>
<p class="calibre1">365 days from the securityonion_db database. You can edit the DAYSTOKEEP </p>
<p class="calibre1">variable if you begin to run out of hard drive space. </p>
<p class="calibre1">To manage the syslog_data database, ELSA offers a configuration vari-</p>
<p class="calibre1">able that controls how much disk space it will use. The file  <i class="calibre4">/etc/elsa_node.conf</i> </p>
<p class="calibre1">contains the entry shown in Listing 5-6. </p>
<p class="calibre1"># Size limit for logs + index size.  Set this to be 90-95% of your total data disk space. </p>
<p class="calibre1">"log_size_limit" : 200000000000, </p>
<p class="calibre1"> <i class="calibre4">Listing 5-6: Size limit entry in </i>/etc/elsa_node .conf</p>
<p class="calibre1">The log_size_limit variable is set according to a number of bytes, so the </p>
<p class="calibre1">default translates to roughly 187GB. Raise or lower this value to manage </p>
<p class="calibre1">ELSA database storage as necessary. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Tracking Disk Usage</b></i></p>
<p class="calibre1">Although SO offers automatic ways to manage hard disk space, it isn’t a </p>
<p class="calibre1">completely deploy-and-forget appliance. Keep an eye on disk usage using </p>
<p class="calibre1">the df -h command and the more granular du -csh commands shown in </p>
<p class="calibre1">Listing 5-7. </p>
<p class="calibre1">$ <b class="calibre3">sudo df -h</b></p>
<p class="calibre1">Filesystem      Size  Used Avail Use% Mounted on</p>
<p class="calibre1">/dev/sda1       456G   96G  337G  23% /</p>
<p class="calibre1">udev            1.5G  4.0K  1.5G   1% /dev</p>
<p class="calibre1">tmpfs           603M  876K  602M   1% /run</p>
<p class="calibre1">none            5.0M     0  5.0M   0% /run/lock</p>
<p class="calibre1">none            1.5G  216K  1.5G   1% /run/shm</p>
<p class="calibre1">$ <b class="calibre3">sudo du -csh /nsm</b></p>
<p class="calibre1">86G     /nsm</p>
<p class="calibre1">86G     total</p>
<p class="calibre1"> <i class="calibre4">Listing 5-7: Disk usage commands</i></p>
<p class="calibre1"><b class="calibre3">108</b>   Chapter 5</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p143"/>As you can see, this sensor has plenty of space available on the hard disk ( <i class="calibre4">/dev/sda1</i>), with only 23 percent in use. The  <i class="calibre4">/nsm</i> directory occupies 86GB </p>
<p class="calibre1">of the 96GB taken up by the whole partition. The example of a database </p>
<p class="calibre1">size check earlier in this chapter showed that all of the databases occupied </p>
<p class="calibre1">5.536GB. Windows users might be more familiar with graphical representa-</p>
<p class="calibre1">tions of hard disk usage. On Linux, it’s useful to become acquainted with </p>
<p class="calibre1">the sorts of percentages and listings produced by commands like df. </p>
<p class="calibre1"><b class="calibre3">conclusion</b></p>
<p class="calibre1">This chapter explained a few core administrative chores: keeping software </p>
<p class="calibre1">up-to-date, limiting network access to promote security, and managing </p>
<p class="calibre1">system storage. These are by no means the only skills required for system </p>
<p class="calibre1">administration, but thankfully, the SO project has made caring for NSM </p>
<p class="calibre1">platforms easy. With these fundamental skills, you can keep your SO sys-</p>
<p class="calibre1">tems running smartly with a minimum of effort. </p>
<p class="calibre1">In the following chapters, we’ll look at the software and data you can </p>
<p class="calibre1">use to collect and interpret network data. </p>
<p class="calibre1">SO Platform Housekeeping   <b class="calibre3">109</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p144"/><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p145"/><b class="calibre3">Part III</b></p>
<p class="calibre1"><b class="calibre3">T o o l S</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p146"/><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p147"/><b class="calibre3">6</b></p>
<p class="calibre1"><b class="calibre3">c o M M a N D   l i N e   Pa c k e T </b></p>
<p class="calibre1"><b class="calibre3">a N a ly S i S   T o o l S</b></p>
<p class="calibre1">In Chapters 3 and 4 we installed the SO </p>
<p class="calibre1">software in several configurations, and </p>
<p class="calibre1">we discussed housekeeping functions in </p>
<p class="calibre1">Chapter 5. Now that you have this powerful </p>
<p class="calibre1">NSM platform collecting data, in this chapter I’ll </p>
<p class="calibre1">introduce the first set of command line tools used to </p>
<p class="calibre1">present information to analysts. Some of these tools will be running all </p>
<p class="calibre1">the time, while others will be invoked on demand. Each has its particular </p>
<p class="calibre1">strengths and weaknesses. I’ll discuss how I use key features, though I won’t </p>
<p class="calibre1">cover all tools in exhaustive detail here. </p>
<p class="calibre1">Because I’ve written this book for new analysts, my discussion of SO </p>
<p class="calibre1">tools in this part will concentrate on data presentation. In this chapter I </p>
<p class="calibre1">will look at data presentation tools that use a command line interface. In </p>
<p class="calibre1">Chapter 7 I’ll address data presentation tools that use a graphical inter-</p>
<p class="calibre1">face, and in Chapter 8 I’ll examine specialized forms of data presentation </p>
<p class="calibre1">tools—the NSM consoles. For now, let’s step back and understand how all </p>
<p class="calibre1">the NSM tools packaged with SO relate to one another. </p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p148"/><b class="calibre3">So Tool categories</b></p>
<p class="calibre1">SO ships with a variety of tools, as listed on the SO wiki ( <i class="calibre4">http://code.google </i></p>
<p class="calibre1"> <i class="calibre4">.com/p/security-onion/wiki/Tools</i>). Some tools present data to analysts, some </p>
<p class="calibre1">collect data directly from the network or via messages from other comput-</p>
<p class="calibre1">ers, and a third category sits between the others as middleware, delivering </p>
<p class="calibre1">data or providing other essential capabilities. Let’s take a brief look at each </p>
<p class="calibre1">category of tools: data presentation, data collection, and data delivery. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">SO Data Presentation Tools</b></i></p>
<p class="calibre1"> <i class="calibre4">Data presentation tools</i> expose NSM information to analysts. Two sorts of </p>
<p class="calibre1">data presentation tools for packet analysis are available in SO. One relies on </p>
<p class="calibre1">a command line interface, and the other offers analysts a graphical inter-</p>
<p class="calibre1">face. SO also provides NSM consoles for data presentation. </p>
<p class="calibre1"><b class="calibre3">Packet analysis tools</b></p>
<p class="calibre1"> <i class="calibre4">Packet analysis tools</i> read network traffic from a live interface, or from a file containing traffic saved in pcap format. Analysts use packet analysis tools to </p>
<p class="calibre1">better interpret network traffic, but not necessarily to implement an NSM-</p>
<p class="calibre1">specific investigation or workflow. Some of these tools help analysts better </p>
<p class="calibre1">understand individual packets, others group packets into sessions, and still </p>
<p class="calibre1">others examine application data. The authors of these tools generally did </p>
<p class="calibre1">not build them with NSM in mind, but nevertheless, they are key to under-</p>
<p class="calibre1">standing network traffic. </p>
<p class="calibre1">Two sorts of data presentation tools for packet analysis are available with </p>
<p class="calibre1">SO. One relies on a command line interface. These tools include Tcpdump, </p>
<p class="calibre1">Tshark, and the Argus Ra client, all examined in this chapter. Because </p>
<p class="calibre1">certain uses of Tshark depend on a related data collection tool, Dumpcap, </p>
<p class="calibre1">I’ll present it along with Tshark. The second sort of tool for packet analysis </p>
<p class="calibre1">offers analysts a graphical interface. Wireshark, Xplico, and NetworkMiner </p>
<p class="calibre1">are examples of this sort of software, and I discuss them in Chapter 7. </p>
<p class="calibre1"><b class="calibre3">NSM Consoles</b></p>
<p class="calibre1"> <i class="calibre4">NSM consoles</i> were built with NSM-specific investigation and workflows in </p>
<p class="calibre1">mind. The console authors began with the core NSM principles and imple-</p>
<p class="calibre1">mented them in software. These tools also function as data presentation </p>
<p class="calibre1">applications, but they act more as gateways to NSM data. Software in this </p>
<p class="calibre1">category includes Sguil, Squert, Snorby, and ELSA. I’ll explain how to use </p>
<p class="calibre1">these NSM consoles in Chapter 8. </p>
<p class="calibre1"><b class="calibre3">114</b>   Chapter 6</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p149"/> <i class="calibre4"><b class="calibre3">SO Data Col ection Tools</b></i></p>
<p class="calibre1">Once NSM analysts become comfortable with the data presentation tools, </p>
<p class="calibre1">they turn to  <i class="calibre4">data collection tools</i>. Software in this category includes the Argus server, Netsniff-ng, Passive Real-Time Asset Detection System (PRADS), </p>
<p class="calibre1">Snort, Suricata, and Bro. (Dumpcap belongs in this category as well, but SO </p>
<p class="calibre1">does not enable it by default.) These applications collect and generate the </p>
<p class="calibre1">NSM data available to the presentation tools. </p>
<p class="calibre1">The Argus server and PRADS create and store their own forms of session </p>
<p class="calibre1">data. Argus data is stored in a proprietary binary format suited for rapid </p>
<p class="calibre1">command line mining, whereas PRADS data is best read through an NSM </p>
<p class="calibre1">console. Analysts can choose which form of data suits them best. </p>
<p class="calibre1">Netsniff-ng simply writes full content data to disk in <i class="calibre4"> </i> pcap format. Snort </p>
<p class="calibre1">and Suricata are network intrusion detection systems, inspecting traffic and </p>
<p class="calibre1">writing alerts according to the signatures deployed with each tool. Bro </p>
<p class="calibre1">observes and interprets traffic that has been generated and logged as a </p>
<p class="calibre1">variety of NSM datatypes. </p>
<p class="calibre1">In the default configuration enabled by the SO platform, all of these </p>
<p class="calibre1">applications provide a wealth of NSM data to the presentation tools dis-</p>
<p class="calibre1">cussed in this chapter and the next two. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">SO Data Delivery Tools</b></i></p>
<p class="calibre1">Finally, between the data presentation and data collection tools sits a suite </p>
<p class="calibre1">of  <i class="calibre4">data delivery applications</i>. Broadly speaking, this middleware enables the </p>
<p class="calibre1">functionality of the other categories of software on the SO platform. Tools </p>
<p class="calibre1">like PulledPork, Barnyard2, and CapMe manage IDS rules, alert process-</p>
<p class="calibre1">ing, and <i class="calibre4"> </i> pcap access, respectively. </p>
<p class="calibre1">A suite of “agents” associated with Sguil—such as pcap_agent, snort_agent, </p>
<p class="calibre1">and the like—shuttle data from the collection tools to the presentation soft-</p>
<p class="calibre1">ware. This includes the Apache web server, the MySQL database, and the </p>
<p class="calibre1">Sphinx index application, which may already be familiar to you. </p>
<p class="calibre1">Finally, SO includes tools for integrating certain host-centric analysis </p>
<p class="calibre1">features. These include the OSSEC host IDS and Syslog-ng for transport </p>
<p class="calibre1">and aggregation of log messages. Because this book concentrates on </p>
<p class="calibre1">network-centric data, we won’t examine data from OSSEC and Syslog-ng, </p>
<p class="calibre1">but you should know that those components are running on SO platforms. </p>
<p class="calibre1">Figure 6-1 shows the core SO tools in relation to one another. This </p>
<p class="calibre1">chapter covers the tools Tcpdump, Tshark, Dumpcap, and the Argus Ra </p>
<p class="calibre1">client. Chapter 7 covers Wireshark, Xplico, and NetworkMiner. Chapter 8 </p>
<p class="calibre1">discusses the NSM consoles Sguil, Snorby, Squert, and ELSA. We’ll begin </p>
<p class="calibre1">our look at data presentation tools with Tcpdump. </p>
<p class="calibre1">Command Line Packet Analysis Tools   <b class="calibre3">115</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p150"/>NetworkMiner</p>
<p class="calibre1">Wireshark, </p>
<p class="calibre1">Sguil</p>
<p class="calibre1">Snorby or</p>
<p class="calibre1">ELSA</p>
<p class="calibre1">Interface for full</p>
<p class="calibre1">Interface for Bro</p>
<p class="calibre1">and Xplico</p>
<p class="calibre1">Tshark, and</p>
<p class="calibre1">Squert</p>
<p class="calibre1">Data</p>
<p class="calibre1">content data, alert</p>
<p class="calibre1">and alert data</p>
<p class="calibre1">Interface for full</p>
<p class="calibre1">Tcpdump</p>
<p class="calibre1">Interface for</p>
<p class="calibre1">presentation  content data, alert</p>
<p class="calibre1">Protocol analyzers</p>
<p class="calibre1">data, session data, </p>
<p class="calibre1">alert data and</p>
<p class="calibre1">and some metadata</p>
<p class="calibre1">Argus Ra</p>
<p class="calibre1">data, session data, </p>
<p class="calibre1">for full content data</p>
<p class="calibre1">some metadata</p>
<p class="calibre1"/>
<p class="calibre1">and some metadata</p>
<p class="calibre1">Client for</p>
<p class="calibre1">session data</p>
<p class="calibre1">PulledPork</p>
<p class="calibre1">pcap_agent</p>
<p class="calibre1">Apache</p>
<p class="calibre1">OSSEC</p>
<p class="calibre1">Sphinx</p>
<p class="calibre1">Alert data</p>
<p class="calibre1">snort_agent</p>
<p class="calibre1">Web server</p>
<p class="calibre1">Host log alerting</p>
<p class="calibre1">ELSA log search</p>
<p class="calibre1">rule updates</p>
<p class="calibre1">Data</p>
<p class="calibre1">sancp_agent</p>
<p class="calibre1">and analysis</p>
<p class="calibre1">CapMe</p>
<p class="calibre1">MySQL</p>
<p class="calibre1">delivery </p>
<p class="calibre1">Barnyard2</p>
<p class="calibre1">pads_agent</p>
<p class="calibre1">Full content and</p>
<p class="calibre1">Syslog-ng</p>
<p class="calibre1">Database</p>
<p class="calibre1">Alert data spool</p>
<p class="calibre1">http_agent</p>
<p class="calibre1">transcript</p>
<p class="calibre1">Log collection</p>
<p class="calibre1">processing</p>
<p class="calibre1">Sensor to server</p>
<p class="calibre1">delivery</p>
<p class="calibre1">data delivery</p>
<p class="calibre1">Argus server</p>
<p class="calibre1">Dumpcap</p>
<p class="calibre1">PRADS</p>
<p class="calibre1">Snort or</p>
<p class="calibre1">Bro</p>
<p class="calibre1">Session data</p>
<p class="calibre1">Full content data</p>
<p class="calibre1">Session data</p>
<p class="calibre1">Suricata</p>
<p class="calibre1">Extracted content</p>
<p class="calibre1">(not running by</p>
<p class="calibre1">and metadata</p>
<p class="calibre1">Data</p>
<p class="calibre1">Alert data</p>
<p class="calibre1">data, session</p>
<p class="calibre1">collection </p>
<p class="calibre1">default)</p>
<p class="calibre1">data, transaction</p>
<p class="calibre1">data, statistical</p>
<p class="calibre1">Netsniff-ng</p>
<p class="calibre1">data, metadata, </p>
<p class="calibre1">Full content data</p>
<p class="calibre1">and alert data</p>
<p class="calibre1">Monitored interface(s), e.g., eth1</p>
<p class="calibre1"> <i class="calibre4">Figure 6-1: Core SO tools</i></p>
<p class="calibre1"><b class="calibre3">running Tcpdump</b></p>
<p class="calibre1">Tcpdump ( <i class="calibre4">http://www.tcpdump.org/</i>) is a command line network traffic </p>
<p class="calibre1">analyzer. Tcpdump is available on SO, but it is not running by default. </p>
<p class="calibre1">Analysts can invoke it on demand, most often to view data stored in </p>
<p class="calibre1"> <i class="calibre4">/nsm/sensor_data/&lt;sensorname&gt;/dailylogs</i>. </p>
<p class="calibre1"><b class="calibre3">N o T e </b> <i class="calibre4"> </i></p>
<p class="calibre1"> <i class="calibre4">Bill Fenner, David Young, Fulvio Risso, Guy Harris, Hannes Gredler, and Michael </i></p>
<p class="calibre1"> <i class="calibre4">Richardson are the current Tcpdump maintainers, and they code under a three-clause</i> <i class="calibre4">BSD license. (See the Tcpdump </i> CREDITS <i class="calibre4"> file at </i> http://svnweb.freebsd.org/base/</p>
<p class="calibre1">vendor/tcpdump/4.3.0/CREDITS?revision=241212&amp;view=markup <i class="calibre4"> for all </i></p>
<p class="calibre1"> <i class="calibre4">contributors.) They also develop the libpcap traffic capture library under the same</i> <i class="calibre4">license. Van Jacobson, Craig Leres, and Steven McCanne wrote the original version in</i> <i class="calibre4">1987 while working at the Lawrence Berkeley Laboratory Network Research Group. </i></p>
<p class="calibre1">Tcpdump works against a live network interface or a saved trace file. It </p>
<p class="calibre1">can display results in real time or write output to a file. </p>
<p class="calibre1">Tcpdump is a  <i class="calibre4">protocol analyzer</i> because it can depict multiple layers of </p>
<p class="calibre1">detail for any traffic it understands. As a protocol analyzer, its rendition of </p>
<p class="calibre1">network traffic depends on its ability to decode the data it sees. Without </p>
<p class="calibre1">knowledge of the underlying protocols, Tcpdump could produce only a </p>
<p class="calibre1">byte stream that analysts would need to decode manually. </p>
<p class="calibre1"><b class="calibre3">116</b>   Chapter 6</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p151"/> <i class="calibre4"><b class="calibre3">Displaying, Writing, and Reading Traffic with Tcpdump</b></i></p>
<p class="calibre1">Tcpdump runs in a command terminal. To display live traffic in real time, </p>
<p class="calibre1">run it with these options:</p>
<p class="calibre1">$ <b class="calibre3">tcpdump -n -i &lt;interface&gt; -s &lt;snaplen&gt; -c &lt;count&gt; </b></p>
<p class="calibre1">The -n switch tells Tcpdump to not resolve IP addresses to hostnames </p>
<p class="calibre1">via DNS queries. I always run Tcpdump with the -n switch to avoid waiting </p>
<p class="calibre1">while the tool resolves IP addresses to hostnames via DNS. The -i switch </p>
<p class="calibre1">tells it which interface to monitor. The -s switch tells it how many bytes </p>
<p class="calibre1">to capture from each packet. By default Tcpdump captures 68 bytes for </p>
<p class="calibre1">IPv4 packets and 96 bytes for IPv6 packets. (Use -s 0 to capture the entire </p>
<p class="calibre1">packet, or specify a value appropriate for the medium from which you are </p>
<p class="calibre1">capturing.) Finally, -c tells Tcpdump how many packets to capture. (If you </p>
<p class="calibre1">forget this switch, Tcpdump will run until you stop it with ctrl-C.)</p>
<p class="calibre1">Listing 6-1 shows some example output. Tcpdump requires elevated </p>
<p class="calibre1">privileges to sniff traffic in promiscuous mode, so preface the command </p>
<p class="calibre1">with sudo. </p>
<p class="calibre1">$ <b class="calibre3">sudo tcpdump -n -i eth1 -c 5</b></p>
<p class="calibre1">tcpdump: WARNING: eth1: no IPv4 address assigned</p>
<p class="calibre1">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</p>
<p class="calibre1">listening on eth1, link-type EN10MB (Ethernet), capture size 65535 bytes</p>
<p class="calibre1">u19:48:51.723139 IP 192.168.2.120.55060 &gt; 205.233.0.226.443:</p>
<p class="calibre1">UDP, length 461</p>
<p class="calibre1">v19:48:51.886312 IP 69.171.246.17.443 &gt; 192.168.2.104.49608:</p>
<p class="calibre1">Flags [P.], seq 928328861:928329246, ack 1080949825, win 39, length 385</p>
<p class="calibre1">w19:48:51.898576 IP 192.168.2.104.49608 &gt; 69.171.246.17.443:</p>
<p class="calibre1">Flags [P.], seq 1:978, ack 385, win 4220, length 977</p>
<p class="calibre1">x19:48:51.914324 IP 69.171.246.17.443 &gt; 192.168.2.104.49608:</p>
<p class="calibre1">Flags [.], ack 978, win 45, length 0</p>
<p class="calibre1">y19:48:51.915284 IP 69.171.246.17.443 &gt; 192.168.2.104.49608:</p>
<p class="calibre1">Flags [P.], seq 385:823, ack 978, win 45, length 438</p>
<p class="calibre1">5 packets captured</p>
<p class="calibre1">5 packets received by filter</p>
<p class="calibre1">0 packets dropped by kernel</p>
<p class="calibre1"> <i class="calibre4">Listing 6-1: Capturing five packets with Tcpdump</i></p>
<p class="calibre1">This traffic includes one User Datagram Protocol (UDP) packet u, </p>
<p class="calibre1">followed by four Transmission Control Protocol (TCP) packets (v, w, x, </p>
<p class="calibre1">and y). The UDP traffic has the following format:</p>
<p class="calibre1">timestamp / layer 3 protocol / source IP address.source port &gt; destination IP </p>
<p class="calibre1">address.destination port: layer 4 protocol / data length</p>
<p class="calibre1">Command Line Packet Analysis Tools   <b class="calibre3">117</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p152"/>The format for the TCP traffic is similar:</p>
<p class="calibre1">timestamp / layer 3 protocol / source IP address.source port &gt; destination IP </p>
<p class="calibre1">address.destination port: layer 4 protocol / TCP flags, TCP sequence numbers, </p>
<p class="calibre1">TCP acknowledgement numbers, TCP window size, data length</p>
<p class="calibre1"><b class="calibre3">N o T e </b> <i class="calibre4"> </i></p>
<p class="calibre1"> <i class="calibre4">The time in this trace is UTC. When you configure SO, it sets the local clock to use</i> <i class="calibre4">UTC, so expect to see UTC timestamps in network evidence. In files saved in libpcap</i> <i class="calibre4">format, time is stored as the number of seconds and microseconds since the Unix </i></p>
<p class="calibre1"> <i class="calibre4">“epoch time” of January 1, 1970. The local system then translates this value into</i> <i class="calibre4">the time displayed by a network tool. </i></p>
<p class="calibre1">To save traffic to disk while watching a live interface, add the -w switch </p>
<p class="calibre1">followed by the target filename. Listing 6-2 shows how to accomplish this task. </p>
<p class="calibre1">$ <b class="calibre3">sudo tcpdump -n -i eth1 -c 5 -w demo1.pcap</b></p>
<p class="calibre1">tcpdump: WARNING: eth1: no IPv4 address assigned</p>
<p class="calibre1">tcpdump: listening on eth1, link-type EN10MB (Ethernet), capture size 65535 bytes</p>
<p class="calibre1">5 packets captured</p>
<p class="calibre1">5 packets received by filter</p>
<p class="calibre1">0 packets dropped by kernel</p>
<p class="calibre1"> <i class="calibre4">Listing 6-2: Capturing and storing five packets with Tcpdump</i></p>
<p class="calibre1">To read the traffic, use the -r switch. (The sudo command isn’t needed </p>
<p class="calibre1">because you’re reading from a trace, not eth1.) Listing 6-3 shows the results </p>
<p class="calibre1">of reading five captured packets. </p>
<p class="calibre1">$ <b class="calibre3">tcpdump -n -r demo1.pcap</b></p>
<p class="calibre1">reading from file demo1.pcap, link-type EN10MB (Ethernet)</p>
<p class="calibre1">20:23:44.858470 IP 74.125.228.54.443 &gt; 192.168.2.104.49945:</p>
<p class="calibre1">Flags [P.], seq 1145489012:1145489069, ack 1920080636, win 4132, length 57</p>
<p class="calibre1">20:23:44.859134 IP 74.125.228.54.443 &gt; 192.168.2.104.49945:</p>
<p class="calibre1">Flags [P.], seq 57:1407, ack 1, win 4132, length 1350</p>
<p class="calibre1">20:23:44.859154 IP 74.125.228.54.443 &gt; 192.168.2.104.49945:</p>
<p class="calibre1">Flags [P.], seq 1407:2757, ack 1, win 4132, length 1350</p>
<p class="calibre1">20:23:44.859505 IP 74.125.228.54.443 &gt; 192.168.2.104.49945:</p>
<p class="calibre1">Flags [P.], seq 2757:4107, ack 1, win 4132, length 1350</p>
<p class="calibre1">20:23:44.860006 IP 74.125.228.54.443 &gt; 192.168.2.104.49945:</p>
<p class="calibre1">Flags [P.], seq 4107:4261, ack 1, win 4132, length 154</p>
<p class="calibre1"> <i class="calibre4">Listing 6-3: Reading five packets with Tcpdump</i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Using Filters with Tcpdump</b></i></p>
<p class="calibre1">Along with displaying, writing, and reading traffic, the other core usage </p>
<p class="calibre1">for Tcpdump involves applying filters.  <i class="calibre4">Filters</i> are a mechanism to limit the </p>
<p class="calibre1">traffic shown or captured by Tcpdump and other tools. The popular term </p>
<p class="calibre1"><b class="calibre3">118</b>   Chapter 6</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p153"/>for filters is  <i class="calibre4">BPF</i>, a nod to the Berkeley Packet Filter virtual machine, which translates the human-readable filter syntax into a code syntax suitable for </p>
<p class="calibre1">machine consumption. </p>
<p class="calibre1"><b class="calibre3">applying Filters</b></p>
<p class="calibre1">You apply a BPF by appending it to the Tcpdump command line. For </p>
<p class="calibre1">example, to capture only ICMP traffic, add icmp to the syntax, as shown </p>
<p class="calibre1">in Listing 6-4 (u). </p>
<p class="calibre1">$ <b class="calibre3">sudo tcpdump -n -i eth1 -c 10 -w icmp.pcap icmp</b>u</p>
<p class="calibre1">tcpdump: WARNING: eth1: no IPv4 address assigned</p>
<p class="calibre1">tcpdump: listening on eth1, link-type EN10MB (Ethernet), capture size 65535 bytes</p>
<p class="calibre1">10 packets captured</p>
<p class="calibre1">10 packets received by filter</p>
<p class="calibre1">0 packets dropped by kernel</p>
<p class="calibre1"> <i class="calibre4">Listing 6-4: Capturing 10 ICMP packets with Tcpdump</i></p>
<p class="calibre1">To read the trace, use Tcpdump again, as shown in Listing 6-5. </p>
<p class="calibre1">$ <b class="calibre3">tcpdump -n -r icmp.pcap</b></p>
<p class="calibre1">reading from file icmp.pcap, link-type EN10MB (Ethernet)</p>
<p class="calibre1">20:30:28.203723 IP 172.16.2.1 &gt; 172.16.2.2: ICMP echo request, id 20822, seq 44313, length 44</p>
<p class="calibre1">20:30:28.204282 IP 172.16.2.2 &gt; 172.16.2.1: ICMP echo reply, id 20822, seq 44313, length 44</p>
<p class="calibre1">20:30:28.844237 IP 192.168.2.108 &gt; 173.194.75.104: ICMP echo request, id 1, seq 5, length 40</p>
<p class="calibre1">20:30:28.871534 IP 173.194.75.104 &gt; 192.168.2.108: ICMP echo reply, id 1, seq 5, length 40</p>
<p class="calibre1">20:30:29.213917 IP 172.16.2.1 &gt; 172.16.2.2: ICMP echo request, id 20822, seq 44569, length 44</p>
<p class="calibre1">20:30:29.214475 IP 172.16.2.2 &gt; 172.16.2.1: ICMP echo reply, id 20822, seq 44569, length 44</p>
<p class="calibre1">20:30:29.850913 IP 192.168.2.108 &gt; 173.194.75.104: ICMP echo request, id 1, seq 6, length 40</p>
<p class="calibre1">20:30:29.875103 IP 173.194.75.104 &gt; 192.168.2.108: ICMP echo reply, id 1, seq 6, length 40</p>
<p class="calibre1">20:30:29.987013 IP 192.168.2.127 &gt; 173.194.75.99: ICMP echo request, id 47441, seq 1, length 64</p>
<p class="calibre1">20:30:30.013728 IP 173.194.75.99 &gt; 192.168.2.127: ICMP echo reply, id 47441, seq 1, length 64</p>
<p class="calibre1"> <i class="calibre4">Listing 6-5: Reading ICMP packets with Tcpdump</i></p>
<p class="calibre1">Instead of using icmp, you can capture other specific traffic by using </p>
<p class="calibre1">options like tcp, udp, and so on. For example, you can collect traffic for a </p>
<p class="calibre1">specified TCP or UDP port, like port 53, as shown in Listing 6-6. </p>
<p class="calibre1">$ <b class="calibre3">sudo tcpdump -n -i eth1 -s 0 port 53</b> </p>
<p class="calibre1">tcpdump: WARNING: eth1: no IPv4 address assigned</p>
<p class="calibre1">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</p>
<p class="calibre1">listening on eth1, link-type EN10MB (Ethernet), capture size 65535 bytes</p>
<p class="calibre1">20:53:42.685078 IP 192.168.2.106.33348 &gt; 172.16.2.1.53: 55862+ A? daisy.ubuntu.com. (34) 20:53:42.701421 IP 172.16.2.1.53 &gt; 192.168.2.106.33348: 55862 2/0/0 A 91.189.95.54, A 91.189.95.55 (66)</p>
<p class="calibre1"> <i class="calibre4">Listing 6-6: Capturing port 53 packets with Tcpdump</i></p>
<p class="calibre1">Command Line Packet Analysis Tools   <b class="calibre3">119</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p154"/>Listing 6-6 captures UDP or TCP traffic on port 53. To capture port 53 </p>
<p class="calibre1">and TCP traffic only, modify the filter as shown in Listing 6-7. </p>
<p class="calibre1">$ <b class="calibre3">sudo tcpdump -n -i eth1 -s 0 port 53 and tcp</b>                                     </p>
<p class="calibre1">tcpdump: WARNING: eth1: no IPv4 address assigned</p>
<p class="calibre1">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</p>
<p class="calibre1">listening on eth1, link-type EN10MB (Ethernet), capture size 65535 bytes</p>
<p class="calibre1">21:02:06.430169 IP 192.168.2.126.44334 &gt; 8.8.8.8.53: Flags [S], seq 1330246822, win 42340, options [mss 1460,sackOK,TS val 157066547 ecr 0,nop,wscale 11], length 0</p>
<p class="calibre1"> <i class="calibre4">Listing 6-7: Capturing port 53 TCP packets with Tcpdump</i></p>
<p class="calibre1">The manual page for pcap-filter included with SO shows all available </p>
<p class="calibre1">options. View it by entering <b class="calibre3">man pcap-filter</b> at a command terminal. </p>
<p class="calibre1"><b class="calibre3">Some Common Filters</b></p>
<p class="calibre1">Now let’s look at some of the more common filters for showing traffic to or </p>
<p class="calibre1">from particular hosts and even networks. </p>
<p class="calibre1">To show traffic to or from a specific computer, use the host BPF, as shown </p>
<p class="calibre1">in Listing 6-8. </p>
<p class="calibre1">$ <b class="calibre3">tcpdump -n -r icmp.pcap host 192.168.2.127</b></p>
<p class="calibre1">reading from file icmp.pcap, link-type EN10MB (Ethernet)</p>
<p class="calibre1">20:30:29.987013 IP 192.168.2.127 &gt; 173.194.75.99: ICMP echo request, id 47441, seq 1, length 64</p>
<p class="calibre1">20:30:30.013728 IP 173.194.75.99 &gt; 192.168.2.127: ICMP echo reply, id 47441, seq 1, length 64</p>
<p class="calibre1"> <i class="calibre4">Listing 6-8: Capturing traffic involving a host via BPF with Tcpdump</i></p>
<p class="calibre1">To show traffic from a certain source computer, use the src host BPF, as </p>
<p class="calibre1">shown in Listing 6-9. </p>
<p class="calibre1">$ <b class="calibre3">tcpdump -n -r icmp.pcap src host 192.168.2.127</b> </p>
<p class="calibre1">reading from file icmp.pcap, link-type EN10MB (Ethernet)</p>
<p class="calibre1">20:30:29.987013 IP 192.168.2.127 &gt; 173.194.75.99: ICMP echo request, id 47441, seq 1, length 64</p>
<p class="calibre1"> <i class="calibre4">Listing 6-9: Capturing traffic from a host via BPF with Tcpdump</i></p>
<p class="calibre1">The dst host BPF works the same way as the src host version, as shown </p>
<p class="calibre1">in Listing 6-10. </p>
<p class="calibre1">$ <b class="calibre3">tcpdump -n -r icmp.pcap dst host 192.168.2.127</b></p>
<p class="calibre1">reading from file icmp.pcap, link-type EN10MB (Ethernet)</p>
<p class="calibre1">20:30:30.013728 IP 173.194.75.99 &gt; 192.168.2.127: ICMP echo reply, id 47441, seq 1, length 64</p>
<p class="calibre1"> <i class="calibre4">Listing 6-10: Capturing traffic to a host via BPF with Tcpdump</i></p>
<p class="calibre1"><b class="calibre3">120</b>   Chapter 6</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p155"/>You can specify networks instead of hosts with the net BPF, as shown in Listing 6-11. </p>
</body></html>