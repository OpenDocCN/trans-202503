<html><head></head><body>
<h2 class="h2" id="ch03"><span epub:type="pagebreak" id="page_69"/><strong><span class="big">3</span><br/>THE REGULATED POWER SUPPLY</strong></h2>&#13;
<div class="image1"><img alt="image" src="../images/common-01.jpg"/></div>&#13;
<p class="noindent">Whether you use a standard bench power supply or run your Arduino off the USB port of your computer, sooner or later you’re going to need a stand-alone, regulated power supply capable of providing a variable voltage. This project shows you how to make exactly that, using only a handful of inexpensive parts. A variable power supply is one of the most frequently used tools in many workshops. This one is easy and fun to build, and you will find that you end up using it over and over again.</p>&#13;
<p class="indent">When set for 5V or 3.3V, the Regulated Power Supply can power most Arduino projects with ease. You can also use it to power some ancillary piece of equipment, to vary a particular voltage in a system while the main power is fixed, or simply to test a lamp circuit, LED, motor, or other device.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_70"/>The circuit uses the extremely versatile LM317 regulator chip. If you ever find yourself in need of a precision voltage regulator with some unusual demands, look up the LM317 on the web. The JavaScript Electronic Notebook has a particularly good article titled “LM 317 Voltage Regulator Designer” by Martin E. Meserve, which can be found at <em><a href="http://www.k7mem.com/Electronic_Notebook/power_supplies/lm317.html">http://www.k7mem.com/Electronic_Notebook/power_supplies/lm317.html</a></em>.</p>&#13;
<h3 class="h3" id="ch03lev1sec1"><strong>Required Tools</strong></h3>&#13;
<p class="indent">Soldering iron and solder</p>&#13;
<p class="indent">Drill and drill bits (3/8 and 1/4 inches)</p>&#13;
<p class="indent">Hacksaw or keyhole saw (nibbler or other)</p>&#13;
<p class="indent">Phillips head screwdriver</p>&#13;
<p class="indent">(Optional) Tapered reamer set</p>&#13;
<p class="indent">(Optional) Crimping tool</p>&#13;
<h3 class="h3" id="ch03lev1sec2"><strong>Parts List</strong></h3>&#13;
<p class="noindent">The Regulated Power Supply is capable of providing an adjustable voltage from 1.25V to about 12V at up to 1.5 A, depending on the fundamental power you use. It uses the LM317 single-chip voltage regulator to set the voltage. To build this project, you will need the following parts:</p>&#13;
<p class="indentt">One Arduino Pro Mini or clone</p>&#13;
<p class="indent">One LM317 voltage regulator</p>&#13;
<p class="indent">One LM7805 voltage regulator</p>&#13;
<p class="indent">Two 2.2-ohm, 5 W resistors</p>&#13;
<p class="indent">Three 10-kilohm, 1/8 W resistors</p>&#13;
<p class="indent">Three 6.8-kilohm, 1/8 W resistors</p>&#13;
<p class="indent">One 68 μF tantalum capacitor</p>&#13;
<p class="indent">Three 0.1 μF ceramic capacitors</p>&#13;
<p class="indent">One 1 μF tantalum capacitor</p>&#13;
<p class="indent">One 16×2 LCD</p>&#13;
<p class="indent">One I<sup>2</sup>C adapter, if not included with the LCD</p>&#13;
<p class="indent">Four 4-40 screws</p>&#13;
<p class="indent">Eight 4-40 nuts</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_71"/>One 5 mm LED (for power indicator)</p>&#13;
<p class="indent">One SPST switch</p>&#13;
<p class="indent">One 470-ohm, 1/8 W resistor</p>&#13;
<p class="indent">One 10-kilohm, 1/8 W potentiometer</p>&#13;
<p class="indent">One Hammond panel/case (#1456CE3WHBU)</p>&#13;
<p class="indent">Two banana plug jacks</p>&#13;
<p class="indent">One 3.5 mm jack</p>&#13;
<p class="indent">One 12V 2 A AC adapter</p>&#13;
<p class="indent">One power adapter jack</p>&#13;
<p class="indent">One PCB/shield</p>&#13;
<p class="indent">Six 1×4 headers</p>&#13;
<p class="indent">Four 1×4 housings</p>&#13;
<p class="indent">Four 1×2 headers</p>&#13;
<p class="indent">One heavy-duty TO-220 heat sink</p>&#13;
<p class="indent">One medium-duty TO-220 heat sink</p>&#13;
<p class="indent">Four male crimp connectors</p>&#13;
<p class="indent">Four female crimp connectors</p>&#13;
<p class="indent">30-gauge hookup wire</p>&#13;
<p class="indent">One knob to cover the potentiometer shaft</p>&#13;
<p class="indent">Double-sided foam tape</p>&#13;
<p class="indentt">A note on heat-sink selection: there are a wide variety of heat sinks available. The one pictured in <a href="ch03.xhtml#ch03fig2">Figure 3-2</a> is the Futurlec TO220ST, which works okay but runs pretty warm as you approach the 1 A range. A larger one that will still fit in an enclosure may be better. Futurlec TO220SMAL, the heat sink for the LM7805, is sufficient for the job.</p>&#13;
<h3 class="h3" id="ch03lev1sec3"><strong>Downloads</strong></h3>&#13;
<p class="noindent">You will find the following files in this book’s online resources to help you complete this project:</p>&#13;
<p class="indentt"><strong>Templates</strong> <em>PowerSupplyFront.dxf, PowerSupplyFrontBottom.dxf</em></p>&#13;
<p class="indent"><strong>Sketch</strong> <em>PowerSupply.ino</em></p>&#13;
<p class="indent"><strong>Shield file</strong> <em>VoltageRegulator.pcb</em></p>&#13;
<div class="box1">&#13;
<p class="boxtitle"><span epub:type="pagebreak" id="page_72"/><strong>WHAT THE REGULATED POWER SUPPLY IS AND ISN’T</strong></p>&#13;
<p class="noindent">The power supply in this project is not intended to replace a regular bench power supply. It does not provide any current limiting and is rated up to 1.5 A, due to the current capacity of the LM317. However, for a wide variety of applications—including all of the projects in this book—it works very well. If you’re new to Arduino, it will provide a solid power supply and save you a lot of batteries, if that’s how you’ve been powering your projects. If you already have a full-sized bench supply, this project will be indispensable as a second supply. The Regulated Power Supply can be used for several projects in this book that require a secondary power supply.</p>&#13;
<p class="indent">I have used the Regulated Power Supply in other applications, and at the end of this project, I’ll illustrate a more simplified version that can be used as a remote supply. There are times when you just don’t have the proper voltage supply for a project, and this build fits the bill.</p>&#13;
</div>&#13;
<h3 class="h3" id="ch03lev1sec4"><strong>A Flexible Voltage Regulator Circuit</strong></h3>&#13;
<p class="noindent">The basic LM317 regulator circuit in <a href="ch03.xhtml#ch03fig1">Figure 3-1</a> is the heart of this voltage regulator. Though it is relatively rudimentary, the chip’s simplicity belies what a powerful and versatile tool it can be.</p>&#13;
<div class="image"><img alt="image" src="../images/f03-01.jpg"/></div>&#13;
<p class="figcap"><a id="ch03fig1"/><em>Figure 3-1: This is the schematic diagram for the regulator component of the Regulated Power Supply. The complete schematic with the display is shown in <a href="ch03.xhtml#ch03fig4">Figure 3-4</a></em>.</p>&#13;
<p class="indent">I have used some variation of this circuit for many applications, from a stand-alone variable supply to an integrated part of a larger system, always with good results.</p>&#13;
<p class="indent">In the shop, I sometimes use kind of a “hair-wired” version, shown in <a href="ch03.xhtml#ch03fig2">Figure 3-2</a> (left), for testing LEDs and controlling things like motor speed and lamp intensity. I’ve also used a breadboard version, shown in <a href="ch03.xhtml#ch03fig2">Figure 3-2</a> (right), to implement the regulator circuit. In both cases, I used a trimmer potentiometer, which requires an alignment tool or screwdriver to make adjustments.</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_73"/><img alt="image" src="../images/f03-02.jpg"/></div>&#13;
<p class="figcap"><a id="ch03fig2"/><em>Figure 3-2: The “hair-wired” version of the voltage regulator circuit with a heat sink screwed to the LM317 (left) and a breadboard version of the regulator (right). I used this in an application with minimal power requirements and thus did not include the heat sink</em>.</p>&#13;
<p class="indent">While those regulator circuits worked, one reason for using the more refined Regulated Power Supply format in <a href="ch03.xhtml#ch03fig1">Figure 3-1</a> was to eliminate the awkward trimmer potentiometer and instead use a standard 270-degree potentiometer and knob so that I could make adjustments quickly, easily, and repeatedly. But the main reason I built it was to have a secondary variable-voltage power supply with digital readout readily available on the bench.</p>&#13;
<h3 class="h3" id="ch03lev1sec5"><strong>How the Circuit Works</strong></h3>&#13;
<p class="noindent">The circuit for this project is not overly complex. In essence, it measures the voltage at the output of the LM317 regulator using the onboard analog-to-digital converter (ADC) and compares it to an internal reference voltage. The result is sent to the LCD screen. However, the Arduino Pro Mini 5V version can accept a maximum of only 5V at the analog inputs. We therefore use a <em>voltage divider</em> to make sure that the voltage at the analog input pin doesn’t exceed 5V. (Make sure voltage supplied to the LM317 is no greater than 12V.)</p>&#13;
<p class="indent">In this case, a voltage divider comprises two resistors connected in series, straddling the output of the LM317 and the ground rail of the breadboard (see the schematic in <a href="ch03.xhtml#ch03fig4">Figure 3-4</a>). The voltage coming from the LM317 gets divided across the two resistors, R2 and R3. As you will note in the sketch, converting from the divided voltage back to the original levels for the display is simply a matter of reversing the arithmetic.</p>&#13;
<p class="indent">As shown in the schematic in <a href="ch03.xhtml#ch03fig4">Figure 3-4</a>, the output of the LM317 connects to both the R2-R3 voltage divider and to resistor R1. Together, resistor R1 in parallel with R9 and the load, or whatever you want to power with the power supply, can be seen as another voltage divider. The R1-R9 voltage divider has a resistance of only 1.1 ohms, so the voltage drop across it <span epub:type="pagebreak" id="page_74"/>is going to be relatively small. According to Ohm’s law (<em>I</em> = <em>V</em>/<em>R</em>) the voltage across R1 and R9 is going to be 1.65V for a maximum current drain of 1.5 A (the maximum supported by the regulator IC): 1.5 A = 1.65V/1.1 Ω.</p>&#13;
<p class="indent">This means that when the LM317 provides about 12V and the load draws 1.5 A, there will be a 1.65V voltage drop across R1 and R9, leaving 10.45V at the power supply’s output.</p>&#13;
<p class="indent">Looking at the schematic in <a href="ch03.xhtml#ch03fig4">Figure 3-4</a>, we are comparing the voltage at analog inputs A0 and A2 of the Pro Mini. If you use the same values for the voltage divider for A0 and A1, you can eliminate one of the sets of resistors and simply connect A0 to A1.</p>&#13;
<div class="box1">&#13;
<p class="boxtitle"><strong>VOLTAGE DIVIDER RESISTOR VALUES</strong></p>&#13;
<p class="noindent">The values of the resistors needed to achieve a certain voltage are determined using this formula:</p>&#13;
<div class="imageo"><img alt="image" src="../images/e0074-01.jpg"/></div>&#13;
<p class="indent">The schematic of a typical voltage divider circuit is shown in <a href="ch03.xhtml#ch03fig3">Figure 3-3</a>.</p>&#13;
<div class="image"><img alt="image" src="../images/f03-03.jpg"/></div>&#13;
<p class="figcap"><a id="ch03fig3"/><em>Figure 3-3: A typical voltage divider circuit</em></p>&#13;
<p class="indent">You can do the algebra if you’d like, but it’s easiest to use an online calculator, such as the one at <em><a href="http://www.daycounter.com/Calculators/VoltageDivider-Calculator.phtml">http://www.daycounter.com/Calculators/VoltageDivider-Calculator.phtml</a></em>. In this project, the objective is to achieve an output of around 5V. We’ll start with a 12V input and a 10-kilohm resistor, represented by R1 in the formula and marked R2 in the schematic. Fill in the calculator fields with this information, and the formula will give you a resistor value of 7.1-kilohm for R2 in the schematic and R1 in the formula. The closest standard resistor value is 6.8 kilohm, so the project uses that along with the 10-kilohm resistor in its voltage divider.</p>&#13;
<p class="indent">But why start with a 10-kilohm resistor? The first reason is to avoid drawing too much current. Even if the entire 12V dropped across the 10-kilohm resistor, it would result only in a nominal drain of 1.2 mA. Second, I have a lot of 10-kilohm resistors in the parts bin, and I am sure you do, too.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_75"/>I use three sets of voltage dividers in this circuit. The first looks at the voltage at the output of the regulator, which is ultimately displayed on the LCD. The other two divide the voltage in front of and behind the voltage-dropping resistor so that the amperage can be measured according to the formula <em>I</em> = <em>V</em>/<em>R</em>, where <em>V</em> is the voltage drop across resistors R1 and R9, and R is the value of those two resistors combined. Could I have eliminated one set of voltage dividers? Yes, by joining A0 and A1 together. I thought, however, that I might want to change those values at some point to increase the accuracy of the ammeter by bringing the value closer to the Arduino reference voltage, so I did not join them in my version of the project.</p>&#13;
</div>&#13;
<h3 class="h3" id="ch03lev1sec6"><strong>The Schematic</strong></h3>&#13;
<p class="noindent">While I wanted the Regulated Power Supply to be relatively robust, I didn’t want it to be overly complex or hard to build. The hair-wired and breadboard versions did well in temporary or emergency applications when used with a digital multimeter (DMM), but I sought to build something more permanent that would have its own voltage and current readout, and that would stay on the workbench or sit on my desk as a regular addition to the tool set. <a href="ch03.xhtml#ch03fig4">Figure 3-4</a> shows the full schematic for the Regulated Power Supply.</p>&#13;
<div class="image"><img alt="image" src="../images/f03-04.jpg"/></div>&#13;
<p class="figcap"><a id="ch03fig4"/><em>Figure 3-4: Schematic for the Regulated Power Supply</em></p>&#13;
<h3 class="h3" id="ch03lev1sec7"><span epub:type="pagebreak" id="page_76"/><strong>The Breadboard</strong></h3>&#13;
<p class="noindent">As in all of my Arduino projects, I began with the standard breadboard. To make life easy, I used a standard potentiometer with pins that would fit into the 0.100-inch-spaced breadboard holes. With a little effort, a standard 16 mm rotary potentiometer (R7 in the schematic) with printed circuit board connectors will just about fit into every other hole in a breadboard. <a href="ch03.xhtml#ch03fig5">Figure 3-5</a> shows an overhead view of the finished breadboard before you power it.</p>&#13;
<div class="image"><img alt="image" src="../images/f03-05.jpg"/></div>&#13;
<p class="figcap"><a id="ch03fig5"/><em>Figure 3-5: The breadboard for the Regulated Power Supply. The capacitors in the schematic—C1, C2, and C3—are not included in the breadboard but should be included in the completed unit</em>.</p>&#13;
<h4 class="h4" id="ch03lev2sec1"><strong><em>Preparing the Arduino Pro Mini and LCD</em></strong></h4>&#13;
<p class="noindent">The Arduino Pro Mini may or may not come with the male headers attached. If it doesn’t, you’ll have to solder them yourself (see “<a href="ch00.xhtml#ch00lev1sec1">Preparing the Arduino Board</a>” on <a href="ch00.xhtml#page_2">page 2</a>). Make sure the number of header pins in your strip matches the corresponding holes in the Pro Mini; you may have to cut the strip to the proper number of pins if the included strip is too long. Trim two strips of headers to size and place the long ends of the two header strips into a breadboard, spaced so that the Pro Mini board will fit over them. Put the Pro Mini in place, and solder all the header pins. Then, take two header pins <span epub:type="pagebreak" id="page_77"/>(use the surplus from the longer header or purchase these separately), insert them in the A4 and A5 holes in the Pro Mini, and solder. These are the pins used for the LCD.</p>&#13;
<p class="indent">Finally, install five header pins on the edge of the board (at the TX0 and RXI end). Some boards come with straight headers, others with the long pins bent at a 90 degree angle. In most of the applications, I have found it easier to work with straight headers. You can use right-angle headers, but it may be more difficult to plug in the connector for programming the board, so I recommend replacing any right-angle pins with straight ones. You also might want to take a 1/2-inch length of 22-gauge wire and solder it to the short end of the RST pin so it sticks up. A female header connector will connect to this during programming.</p>&#13;
<p class="indent">You will now have to get the LCD/I<sup>2</sup>C assembly ready. If you purchased the display and adapter separately, you will have to assemble them. Go to “<a href="ch00.xhtml#ch00lev1sec2">Affixing the I<sup>2</sup>C Board to the LCD</a>” on <a href="ch00.xhtml#page_3">page 3</a> for instructions. If you purchased the display with the I<sup>2</sup>C adapter, it’s ready for assembly.</p>&#13;
<h4 class="h4" id="ch03lev2sec2"><strong><em>Building the Breadboard</em></strong></h4>&#13;
<p class="noindent">Here’s the step-by-step guide to putting together the breadboard:</p>&#13;
<ol>&#13;
<li><p class="noindent">Insert wires to connect the two positive (red) rails together.</p></li>&#13;
<li><p class="noindent">Insert wires to connect the two negative (blue) rails together.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="bgblack">WARNING</span></strong></p>&#13;
<p class="notep"><em>Be careful not to cross the two and connect the positive rails to negative rails. That could cause a short circuit and damage the hardware</em>.</p>&#13;
</div></li>&#13;
<li><p class="noindent">Insert the 10-kilohm rotary potentiometer into the breadboard.</p></li>&#13;
<li><p class="noindent">Insert the LM317, with or without heat sink attached, near the potentiometer, as shown in <a href="ch03.xhtml#ch03fig5">Figure 3-5</a>. (See <a href="ch03.xhtml#ch03fig6">Figure 3-6</a> for the pinout of the LM317.)</p>&#13;
<div class="image"><img alt="image" src="../images/f03-06.jpg"/></div>&#13;
<p class="figcap"><a id="ch03fig6"/><em>Figure 3-6: Pinout of the LM317 regulator</em></p></li>&#13;
<li><p class="noindent">With the potentiometer shaft facing you, connect the leftmost pin and center pin of the potentiometer together, and then connect both to the adjustment (ADJ) pin of the LM317.</p></li>&#13;
<li><p class="noindent">With the potentiometer in the same orientation, connect the rightmost pin to the blue negative rail (ground).</p></li>&#13;
<li><p class="noindent">Connect a 470-ohm resistor from the output pin to the ADJ pin on the LM317.</p></li>&#13;
<li><p class="noindent"><span epub:type="pagebreak" id="page_78"/>Connect a 1.2-ohm resistor (R1 in <a href="ch03.xhtml#ch03fig4">Figure 3-4</a>—I used two 2.2-ohm resistors in parallel) from the output pin of the LM317 to a load of your choosing. For test purposes, I used a 1/8 W resistor and connected a 5V, 30 mA incandescent indicator lamp for the load. (You may want to use the actual R1 and R9 resistors that you will use in the finished unit, so you can adjust the sketch before completing the unit.)</p></li>&#13;
<li><p class="noindent">Connect the input pin of the LM317 to the 12V system input voltage. This is the wire going from the LM317 to the upper alligator clip in <a href="ch03.xhtml#ch03fig5">Figure 3-5</a>.</p></li>&#13;
<li><p class="noindent">Connect the blue negative rails to the negative side of the input power (probably a wall plug).</p></li>&#13;
<li><p class="noindent">Insert the LM7805 into the breadboard, as shown in <a href="ch03.xhtml#ch03fig5">Figure 3-5</a>. (See <a href="ch03.xhtml#ch03fig7">Figure 3-7</a> for the pinout of the LM7805.)</p>&#13;
<div class="image"><img alt="image" src="../images/f03-07.jpg"/></div>&#13;
<p class="figcap"><a id="ch03fig7"/><em>Figure 3-7: Pinout of the LM7805 regulator</em></p></li>&#13;
<li><p class="noindent">Connect the output pin of the LM7805 to the red positive rail of the breadboard.</p></li>&#13;
<li><p class="noindent">Connect the input pin of the LM317 to the input pin of the LM7805. This is the point at which the input voltage from the power source will be connected.</p></li>&#13;
<li><p class="noindent">Connect the ground pin of the LM7805 to the blue negative rail of the breadboard.</p></li>&#13;
<li><p class="noindent">Insert a 6.8-kilohm resistor, and connect one side to the blue negative rail. This is resistor R3; the other side will connect to resistor R2. See <a href="ch03.xhtml#ch03fig5">Figure 3-5</a> for a top view of the breadboard.</p></li>&#13;
<li><p class="noindent">Insert a 10-kilohm resistor (R2) into the breadboard with one side connected to the LM317 output pin and the other side connected to resistor R3 from step 15.</p></li>&#13;
<li><p class="noindent">Connect resistor R1 from step 8 from the output pin of the LM317 to a blank hole in the breadboard. This row will be the output of the regulator.</p></li>&#13;
<li><p class="noindent">Connect the voltage divider: first, insert a 10-kilohm resistor (R4) into the breadboard. Then, connect one side of resistor R4 to the same row as R1 (you’ll have to use a jumper wire) and the other side to an empty row on the breadboard.</p></li>&#13;
<li><p class="noindent">Insert a 6.8-kilohm resistor (R5) into the board with one side connected to the open side of R4 and the other side of R5 connected to the blue negative rail.</p></li>&#13;
<li><p class="noindent">Insert the Arduino Pro Mini in the breadboard so that it straddles the center break, as shown in <a href="ch03.xhtml#ch03fig4">Figures 3-4</a> and <a href="ch03.xhtml#ch03fig5">3-5</a>.</p></li>&#13;
<li><p class="noindent"><span epub:type="pagebreak" id="page_79"/>Use a jumper to connect the VCC terminal of the Pro Mini to the red positive rail.</p></li>&#13;
<li><p class="noindent">Use a jumper to connect the GND pins of the Arduino Pro Mini to the blue negative rail. (There are at least two to choose from—one is located between RST and D2, and the other is located between RAW and RST on the other side. Take your pick.)</p></li>&#13;
<li><p class="noindent">Use a jumper wire to connect the joining point of R4 and R5 to pins A1 and A0 on the Arduino Pro Mini.</p></li>&#13;
<li><p class="noindent">Find the junction point of R2 and R3, and use a jumper to connect that junction point to the A2 terminal on the Arduino Pro Mini.</p></li>&#13;
<li><p class="noindent">Load the sketch onto the Arduino Pro Mini. (I often remove the Pro Mini from the circuit completely to program it. It’s a little less confusing.)</p></li>&#13;
<li><p class="noindent">Connect the LCD/I<sup>2</sup>C display by connecting VCC and GND to the red positive and blue negative rails on the breadboard, respectively.</p></li>&#13;
<li><p class="noindent">Connect the SDA to analog pin A4 on the Arduino Pro Mini and SCL to analog pin A5.</p></li>&#13;
<li><p class="noindent">Connect the input of the LM7805 voltage regulator to some pin where the +12V will be attached.</p></li>&#13;
<li><p class="noindent">Connect the output of the LM7805 to the red positive rail, and connect the ground to the blue negative rail.</p></li>&#13;
</ol>&#13;
<p class="indentt">Once all of those connections are in place, you’re set to go. Upload the sketch and test the circuit.</p>&#13;
<h3 class="h3" id="ch03lev1sec8"><strong>The Sketch</strong></h3>&#13;
<p class="noindent">The Regulated Power Supply sketch is about as simple as I could make it. The only difficulty is that although I use 1% tolerance resistors throughout, I’ve found some variation in resistance value. So be aware that you may need to make an adjustment to the sketch to accommodate for this.</p>&#13;
<p class="indent">Here is the sketch:</p>&#13;
<pre>// Regulated Power Supply with volt and current read<br/><br/>#include &lt;Wire.h&gt;<br/>#include &lt;LiquidCrystal_I2C.h&gt;<br/><br/>LiquidCrystal_I2C lcd(0x27, 16, 2); //Check your library for specific LCD<br/>                                    //code both here and in setup.<br/><br/>float low_side_res = A0;<br/>float volt_two;<br/>float volt_three;<br/>float volt_disp;<br/>float low_side_res_2 = A1;<br/>float hi_side_res = A2;<br/>float volt_drop_1;<br/>float amp;<br/>float amp_3;<br/>float amp_4;<br/>float amp_disp;<br/><br/><span epub:type="pagebreak" id="page_80"/>void setup() {<br/>    lcd.init();<br/>    lcd.backlight();<br/>}<br/><br/>void loop() {<br/>    volt_two = analogRead(low_side_res);<br/>    volt_three = (volt_two*5)/1024.0;<br/>    volt_disp = volt_three*(10000+6800)/6800;  //Actual voltage reading<br/>    amp_3 = analogRead(low_side_res_2);<br/>    amp_4 = analogRead(hi_side_res);<br/>    amp = amp_3 - amp_4;<br/>    amp_disp = amp *5/1024*(10+6.8)/6.8/1.22*.9; //Calculation of amperage I=V/R<br/>    //*0.9 = adjustment for random error in ref voltage in pro mini<br/><br/>    lcd.setCursor(1,0);<br/>    lcd.print("Volt ");<br/>    lcd.setCursor(12, 0);<br/>    lcd.print(volt_disp);<br/>    lcd.setCursor(1, 1);<br/>    lcd.print("mA ");<br/>    lcd.setCursor(11, 1);<br/>    lcd.print(amp_disp*1000,2);<br/>}</pre>&#13;
<p class="indent">First, this sketch imports some libraries and sets up the LCD (see “<a href="ch01.xhtml#ch01box1">On Writing Code to Set Up LCDs</a>” on <a href="ch01.xhtml#page_36">page 36</a>). It then defines a series of variables, all floats, to use when setting the voltage, reading from the analog pins, calculating values to display on the LCD, and so on. The <code>setup()</code> loop is very short: it has only two lines for initializing the LCD. The main <code>loop()</code> reads the battery voltage and current, and performs the necessary calculations to display on the LCD. The <code>volt_disp</code> value is the voltage to be displayed on the LCD.</p>&#13;
<h3 class="h3" id="ch03lev1sec9"><strong>The Shield</strong></h3>&#13;
<p class="noindent">While the circuitry is not overly complex, using a shield will simplify many of the connections for driving the LCD and constructing the voltage dividers, and it will make the assembly of the Regulated Power Supply easier than point-to-point wiring. <a href="ch03.xhtml#ch03fig8">Figure 3-8</a> shows the shield I designed, though you could also design your own, of course. The PCB file is available at <em><a href="https://www.nostarch.com/arduinoplayground/">https://www.nostarch.com/arduinoplayground/</a></em>.</p>&#13;
<p class="indent">While I used two layers to construct the shield, with a little effort and a slightly larger board, the circuitry could be accommodated on a single layer.</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_81"/><img alt="image" src="../images/f03-08.jpg"/></div>&#13;
<p class="figcap"><a id="ch03fig8"/><em>Figure 3-8: The PCB shield used in the Regulated Power Supply. Black is the top layer, dark gray is the bottom layer, and light gray is the silkscreen layer</em>.</p>&#13;
<p class="indent">The shield doesn’t need to be populated in any particular sequence, but some components will be easier to fit before others. I suggest soldering in this order:</p>&#13;
<ol>&#13;
<li><p class="noindent">First, insert 2.2-ohm, 5 W resistors R1 and R9 into the PCB. These are voltage-dropping resistors that create the voltage for the ammeter (mA), which provide a total resistance (R1 in the schematic) of 1.1 ohms at 10 W. The resistors are a little longer than the configuration on the board, so you’ll have to bend the leads to make them fit. When the Regulated Power Supply is running close to its maximum rating, expect these resistors—and the LM317 itself—to get a little warm.</p></li>&#13;
<li><p class="noindent">Capacitor C1, a 68 μF tantalum capacitor, will be a tight fit for the holes. To make sure it doesn’t interfere with the LM317, install the capacitor first. Then, install the LM317, making sure to leave room for the heat sink. Remember that the heat sink is likely to get pretty warm.</p></li>&#13;
<li><p class="noindent">Make sure to install the LM317 with the pins correctly oriented according to the pinout in <a href="ch03.xhtml#ch03fig6">Figure 3-6</a> and the schematic in <a href="ch03.xhtml#ch03fig4">Figure 3-4</a>. If you use the provided shield files, the thick line on the LM317 silkscreen corresponds to the metal tab on the IC. If you insert the part the wrong way, the system won’t work, and the part could burn out. It would also be a pain to remove.</p></li>&#13;
<li><p class="noindent">Install the LM7805 regulator in the upper-right section of the PCB, and make sure it matches the pinout in <a href="ch03.xhtml#ch03fig7">Figure 3-7</a> and the schematic in <a href="ch03.xhtml#ch03fig4">Figure 3-4</a>. You can use the heavy line in the silkscreen image of the PCB as a guide.</p></li>&#13;
<li><p class="noindent"><span epub:type="pagebreak" id="page_82"/>Try both voltage regulator ICs in the shield with the heat sinks installed (at least temporarily) to make sure they can fit without touching any active components. Remember that the heat sinks are active: the heat sink (tab) of the LM7805 is at ground potential, and the heat sink (tab) of the LM317 is at the output potential.</p></li>&#13;
<li><p class="noindent">Install resistors R2, R3, R4, and R5. It’s easier to place those before installing the female headers for the Arduino Pro Mini.</p></li>&#13;
<li><p class="noindent">Then, solder in C1, C2, and the wires that will connect the Arduino Pro Mini to potentiometer R6, which you will mount on the chassis. You can leave the wires a little long and trim them when you install the shield in the enclosure. Install capacitors C4 and C5 as indicated in the schematic in <a href="ch03.xhtml#ch03fig4">Figure 3-4</a>.</p></li>&#13;
<li><p class="noindent">Next, solder the female headers that comprise the mount for the Pro Mini and the connector for the LCD. The LCD connections are the SDA, SCL, −, and + connections in the bottom right of the PCB. I used male stakes and a female-to-female connector cable to connect from the LCD to the shield. (To learn how to make the custom connector, see “<a href="ch00.xhtml#ch00lev1sec6">Connectors Used in This Book</a>” on <a href="ch00.xhtml#page_18">page 18</a>.)</p></li>&#13;
</ol>&#13;
<p class="indent">For the LCD and Arduino Pro Mini, I usually insert the headers into the board, solder just one pin, and then, with my finger on the top, heat that one pin and push on the connector to make sure it fits flush against the board. For the pins of the Pro Mini, I use only female headers for those that are active—that is, that have copper traces going to them. I also like to place one pin (I usually use a 1×4 pin header) right at the last pin on the Pro Mini to make alignment easy. This would translate to pins RAW, GND, RST, and VCC. In addition, I like to place at least two headers diagonally for mechanical stability. This would correspond to pins D8 and D9 on the Pro Mini. The male headers on the Pro Mini for A4 and A5 are located just above pins A2, A3, and VCC on the main row of connections.</p>&#13;
<h3 class="h3" id="ch03lev1sec10"><strong>Construction</strong></h3>&#13;
<p class="noindent">When the Regulated Power Supply is all soldered together, you will need to prepare an enclosure and mount the circuit inside. I selected a nice-looking, powder-coated metal enclosure, approximately 2 1/4 × 3 1/4 × 4 3/4 inches. <a href="ch03.xhtml#ch03fig9">Figure 3-9</a> shows the completed unit driving a couple of incandescent panel lamps.</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_83"/><img alt="image" src="../images/f03-09.jpg"/></div>&#13;
<p class="figcap"><a id="ch03fig9"/><em>Figure 3-9: The completed Regulated Power Supply</em></p>&#13;
<p class="indent">Bear in mind, though, that while the case is not delicate, the paint is easy to scratch, so be careful. It’s also a little pricey—coming in around $20—but as I will have it on my workbench all the time, I thought it was worth it. Of course, you could also use a different enclosure of your choosing and modify the templates provided with this book accordingly.</p>&#13;
<h4 class="h4" id="ch03lev2sec3"><strong><em>Preparing the Enclosure</em></strong></h4>&#13;
<p class="noindent">If the front panel of the enclosure is sloped, you will need to put a piece of scrap wood behind the areas you need to center punch and drill to help hold it in place. Make sure to measure, center punch, and drill holes carefully.</p>&#13;
<p class="indent">The templates for this project are shown in <a href="ch03.xhtml#ch03fig10">Figures 3-10</a> and <a href="ch03.xhtml#ch03fig11">3-11</a>, and they can be downloaded from <em><a href="https://www.nostarch.com/arduinoplayground/">https://www.nostarch.com/arduinoplayground/</a></em>.</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_84"/><img alt="image" src="../images/f03-10.jpg"/></div>&#13;
<p class="figcap"><a id="ch03fig10"/><em>Figure 3-10: Sloping face of the Regulated Power Supply enclosure</em></p>&#13;
<div class="image"><img alt="image" src="../images/f03-11.jpg"/></div>&#13;
<p class="figcap"><a id="ch03fig11"/><em>Figure 3-11: Front and bottom of the Regulated Power Supply enclosure</em></p>&#13;
<p class="indento1"><span epub:type="pagebreak" id="page_85"/>Here is how I suggest you prepare the enclosure:</p>&#13;
<ol>&#13;
<li><p class="noindent">Center punch and drill holes for the potentiometer, on-off switch (1/4 inches), and power indicator LED. See <a href="ch03.xhtml#ch03fig10">Figure 3-10</a> for the front panel dimensions.</p></li>&#13;
<li><p class="noindent">Center punch and drill the hole for the power input jack in the rear of the panel (see <a href="ch03.xhtml#ch03fig10">Figure 3-10</a>).</p></li>&#13;
<li><p class="noindent">Drill holes for the output binders and 3.5 mm jack on the front of the case, as shown in <a href="ch03.xhtml#ch03fig11">Figure 3-11</a>.</p></li>&#13;
<li><p class="noindent">Carefully measure and mark the cutout for the LCD, as shown in <a href="ch03.xhtml#ch03fig10">Figure 3-10</a>. Center punch and drill 1/2-inch holes in the corners of the LCD screen area to help initiate saw cutting. You can eyeball this based on the diagram in <a href="ch03.xhtml#ch03fig10">Figure 3-10</a> or download a PDF file of the template. Either trace the image onto your enclosure with carbon paper or simply mark the corners with a center punch and connect the punch marks.</p></li>&#13;
<li><p class="noindent">Carefully cut out a hole for the LCD. There are a variety of tools you can use to do this. I first drilled holes A and B and then used a keyhole saw with a fine hacksaw blade (available at local hardware stores) to cut between the holes. Remember that the cutting occurs on the outward thrust, so you needn’t keep pressure on the blade on the return stroke. You can clean up the burrs with a file.</p></li>&#13;
<li><p class="noindent">Carefully fit the display into the window, and file where necessary to get a secure fit. The backlight protrudes on one side of the display, so in order to avoid crushing the backlight, you can use nuts as spacers to keep it separated from the panel.</p></li>&#13;
<li><p class="noindent">Drill holes F, G, H, and I, and fasten the display in place. As you do so, check carefully that the spacer nuts are wide enough (4-40 nuts come in different dimensions), and, if necessary, use two nuts or a nut and a washer to space out for the backlight.</p></li>&#13;
</ol>&#13;
<h4 class="h4" id="ch03lev2sec4"><strong><em>Mounting the Circuit Board</em></strong></h4>&#13;
<p class="noindent">Once you have assembled and tested the shield and mounted the LCD, install the potentiometer, on-off switch, LED, and power jack. Then it’s time to mount the shield in the enclosure. Originally, I drilled four holes in the board so that I could screw it into the enclosure, but I’ve found that 3M double-sided mounting tape also does the trick. I mounted the entire board, heat sinks and all, with a 1 1/4-inch length of the 3/4-inch wide double-sided adhesive. (The manufacturer claims it will hold 2 pounds.)</p>&#13;
<p class="indent">The adhesive is relatively aggressive, so before applying it, make sure you plan carefully where you want to mount the board so it will not be in the way of other components. I mounted the board upside down on the top section of the case so all components and connections were on the same platform (see <a href="ch03.xhtml#ch03fig12">Figure 3-12</a>).</p>&#13;
<div class="image"><span epub:type="pagebreak" id="page_86"/><img alt="image" src="../images/f03-12.jpg"/></div>&#13;
<p class="figcap"><a id="ch03fig12"/><em>Figure 3-12: The completed (upside-down) assembly with the board, LCD, output connectors, potentiometer, on-off switch, LED, and output power jack all mounted on the inside of the top of the enclosure</em>.</p>&#13;
<p class="indent">The final step is to connect the on-off switch, LED pilot lamp, LED current-limiting resistor, potentiometer, power input jack, and output connectors to the PCB according to the project schematic. I used 28-gauge hookup wire to tie everything. The two binding posts/banana plug jacks and the 3.5 mm jacks are wired in parallel. <a href="ch03.xhtml#ch03fig12">Figure 3-12</a> illustrates how I mounted the shield. Note that I used small wire ties, which are optional, to keep the wires neat.</p>&#13;
<p class="indent">Before closing up the enclosure, make sure there are no areas that might result in a short circuit. For example, I placed a small piece of insulating tape between the LCD screen and the shield. They might not be touching at the time of assembly but could touch when you close the enclosure. You can apply insulating tape to prevent this kind of short.</p>&#13;
<p class="indent">After testing for short circuits, all that remains is to put the two halves of the case together. The connections for the output—the binding terminal/banana jack and 3.5 mm jack—are in parallel. The final step is to <span epub:type="pagebreak" id="page_87"/>screw the two pieces together, and you’re off and running. I put a pointer knob on the potentiometer even though there are no markings on the case. You can add a dial if you want, but I find the digital readout sufficient.</p>&#13;
<p class="indent">And, the coup de grâce: remove the protective paper from the adhesive on some rubber feet, and install them on the bottom of the enclosure. Voilà!</p>&#13;
<p class="indent">The full Regulated Power Supply project will take up a decent amount of space on your workbench, but you will find the digital readout and banana jacks invaluable. If you’re feeling adventurous, however, you can build a smaller version of the same circuit, minus the jacks and LCD, shown in <a href="ch03.xhtml#ch03fig13">Figure 3-13</a>.</p>&#13;
<div class="image"><img alt="image" src="../images/f03-13.jpg"/></div>&#13;
<p class="figcap"><a id="ch03fig13"/><em>Figure 3-13: This is the quick-and-dirty power supply with the top off. I made it before biting the bullet and making the full-fledged Regulated Power Supply</em>.</p>&#13;
<p class="indent">You can find instructions on how to build the Mini Regulated Power Supply at <em><a href="https://www.nostarch.com/arduinoplayground/">https://www.nostarch.com/arduinoplayground/</a></em>.<span epub:type="pagebreak" id="page_88"/></p>&#13;
</body></html>