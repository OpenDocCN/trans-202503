<html><head></head><body>
<section><header>
<h1 class="Appendix"><span class="AppendixNumber"><span epub:type="pagebreak" title="919" id="Page_919"/>C</span><br/>
<span class="AppendixTitle">Installing and Using Visual Studio</span></h1>
</header>
<figure class="opener">
<img src="image_fi/book_art/chapterart.png" alt=""/>
</figure>
<p class="ChapterIntro">The Microsoft Macro Assembler (MASM), Microsoft C++ compiler, Microsoft linker, and other tools this book uses are all available in the Microsoft Visual Studio package. At the time of this writing, you can download the Visual Studio Community edition for Windows at <a href="https://visualstudio.microsoft.com/vs/community/" class="LinkURL">https://visualstudio.microsoft.com/vs/community/</a>. Of course, URLs change over time. A web-based search for <em>Microsoft Visual Studio download</em> should lead you to the appropriate spot.</p>
<h2 id="h1-501089b03-0001">	C.1	Installing Visual Studio Community</h2>
<p class="BodyFirst">Once you download the Visual Studio Community edition, run the installer program. This appendix does not provide step-by-step directions as Microsoft is famous for completely changing the user interface of programs even when minor updates occur. Any directions appearing here would probably be <span epub:type="pagebreak" title="920" id="Page_920"/>obsolete when you try to run them. However, the main thing you want to do is ensure that you download and install the Microsoft Visual C++ desktop tools.</p>
<h2 id="h1-501089b03-0002">	C.2	Creating a Command Line Prompt for MASM</h2>
<p class="BodyFirst">To use the Microsoft Visual C++ (MSVC) compiler and MASM, we need to initialize the environment by using a batch file provided by Visual Studio and then leave the command line interpreter (CLI) open so we can build and run programs. We have two options: use an environment created by the Visual Studio installer, or create a custom environment.</p>
<p>At the time of this writing, the Visual Studio 2019 installer creates various CLI environments:</p>
<ul>
<li>Developer Command Prompt for VS 2019</li>
<li>Developer PowerShell for VS 2019</li>
<li>x64 Native Tools Command Prompt for VS 2019</li>
<li>x64_x86 Cross Tools Command Prompt for VS 2019</li>
<li>x86 Native Tools Command Prompt for VS 2019</li>
<li>x86_x64 Cross Tools Command Prompt for VS 2019</li>
</ul>
<p>You can find these by clicking <b>Start</b> (the Windows icon) on the Windows taskbar and then navigating to and clicking the <b>Visual Studio 2019</b> folder. <em>x86</em> refers to 32-bit, and <em>x64</em> refers to 64-bit versions of Windows. </p>
<p>The Developer Command Prompt, Developer PowerShell, x86 Native Tools, and x64_x86 Cross Tools target the 32-bit versions of Windows, so they are outside the scope of this book. x86_x64 Cross Tools targets 64-bit Windows, but the tools available in the environment are themselves 32-bit. Basically, these are the tools for people running a 32-bit version of Windows. x64 Native Tools are for people targeting and running a 64-bit version of Windows. The 32-bit versions of Windows are rare today, so we have not used nor tested this book’s code under x86_x64 Cross Tools. In theory, it should work to assemble and compile 64-bit code, but we would not be able to run it in this 32-bit environment. </p>
<p>x64 Native Tools running under 64-bit Windows is what we have used and tested. If you right-click <b>x64 Native Tools</b>, you can pin it to Start, or if you select <b>More</b>, you can pin it to the taskbar.</p>
<p>Alternatively, you can create your own custom environment, and we will now go through that process. We’ll create a shortcut to a MASM-ready command line prompt by using the following steps:</p>
<ol class="decimal">
<li value="1">Find the batch file named <em>vcvars64.bat</em> (or something similar). If you cannot find <em>vcvars64.bat</em>, try <em>vcvarsall.bat</em> instead. At the time of writing this chapter (using Visual Studio 2019), I found the <em>vcvars64.bat</em> file in the following directory: <em>C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\</em>.<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<span epub:type="pagebreak" title="921" id="Page_921"/><h2><span class="NoteHead">Note</span></h2>
<p>	<em>vcvars.bat</em> or <em>vcvars32.bat</em> will not work (these set up the environment variables for the 32-bit version of the assembler and C++ compiler, which we don’t want to use).</p>
<div class="bottom hr"><hr/></div>
</section>
</aside></li>
<li value="2">Create a shortcut to the file (by right-clicking it in the Windows Explorer and selecting <b>Create Shortcut</b> from the pop-up). Move this shortcut to your Windows desktop and rename it <em>VSCmdLine</em>.</li>
<li value="3">Right-click the shortcut icon on the desktop and click <b>Properties</b><span class="MenuArrow">▶</span><b>Shortcut</b>. Find the Target text box that contains the path to the <em>vcvars64.bat</em> file; for example:
<pre><code>"C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvars64.bat"</code></pre>
<p class="ListBody">Add the prefix <code class="bold">cmd /k</code> in front of this path:</p>
<pre><code><b>cmd /k</b> "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvars64.bat"</code></pre>
<p class="ListBody">The <code>cmd</code> command is the Microsoft <em>cmd.exe</em> command line interpreter. The <code>/k</code> option tells <em>cmd.exe</em> to execute the command that follows (that is, the <em>vcvars64.bat</em> file) and then leave the window open when the command finishes execution. Now, when you double-click the shortcut icon on the desktop, it will initialize all the environment variables and leave the command window open so you can execute the Visual Studio tools (for example, MASM and MSVC) from the command line.</p>
<p class="ListBody">If you can’t find <em>vcvars64.bat</em> but there is a <em>vcvarsall.bat</em>, also add <code class="bold">x64</code> to the end of the command line:</p>
<pre><code>cmd /k "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvarsall.bat" <b>x64</b></code></pre></li>
<li value="4">Before closing the shortcut’s Properties dialog, modify the <b>Start In</b> text box to contain <code class="bold">C:\</code> or another directory where you will normally be working when first starting the Visual Studio command line tools.
<p class="ListBody">Double-click the shortcut icon on the desktop; you should be presented with a command window that has text like the following:</p>
<pre><code>**********************************************************************
** Visual Studio 2019 Developer Command Prompt v16.9.0
** Copyright (c) 2019 Microsoft Corporation
**********************************************************************
[vcvarsall.bat] Environment initialized for: 'x64'</code></pre>
<p class="ListBody">From the command line, type <code class="bold">ml64</code>. This should produce output similar to the following:</p>
<pre><code>C:\&gt;<code class="bold">ml64</code>
Microsoft (R) Macro Assembler (x64) Version 14.28.29910.0
Copyright (C) Microsoft Corporation.  All rights reserved.

<span epub:type="pagebreak" title="922" id="Page_922"/>usage: ML64 [options] filelist [/link linkoptions]
Run "ML64 /help" or "ML64 /?" for more info</code></pre>
<p class="ListBody">Although MASM is complaining that you haven’t supplied a filename to compile, the fact that you’ve gotten this message means that <em>ml64.exe</em> is in the execution path, so the system has properly set up the environment variables so you can run the Microsoft Macro Assembler.</p></li>
<li value="5">As a final test, execute the <code class="bold">cl</code> command to verify that you can run MSVC. You should get output similar to the following:
<pre><code>C:\&gt;<code class="bold">cl</code>
Microsoft (R) C/C++ Optimizing Compiler Version 19.28.29910 for x64
Copyright (C) Microsoft Corporation.  All rights reserved.

usage: cl [option...] filename... [/link linkoption...]</code></pre></li>
<li value="6">Finally, as one last check, locate the Visual Studio application in the Windows Start menu. Click it and verify that this brings up the Visual Studio IDE. If you like, you can make a copy of this shortcut and place it on the desktop so you can bring up Visual Studio by double-clicking the shortcut icon.</li>
</ol>
<h2 id="h1-501089b03-0003">	C.3	Editing, Assembling, and Running a MASM Source File</h2>
<p class="BodyFirst">You will use a text editor of some sort to create and maintain MASM assembly language source files. If you’re not already familiar with Visual Studio and want an environment that’s easier to learn and use, consider downloading the (free) Notepad++ text editor application. Notepad++ provides excellent support for MASM, is fast, and is easy to learn and use. Regardless of which text editor you choose (I use a commercial product called CodeWright), the first step is to create a simple assembly language source file. </p>
<p>MASM requires that all source files have a <em>.asm</em> suffix, so create the file <em>hw64.asm</em> with your editor and enter the following text into that file:</p>
<pre><code>includelib kernel32.lib

        extrn __imp_GetStdHandle:proc
        extrn __imp_WriteFile:proc

        .CODE
hwStr   byte    "Hello World!"
hwLen   =       $-hwStr

main    PROC
        
; On entry, stack is aligned at 8 mod 16. Setting aside 8
; bytes for "bytesWritten" ensures that calls in main have
; their stack aligned to 16 bytes (8 mod 16 inside function).
        
<span epub:type="pagebreak" title="923" id="Page_923"/>        lea     rbx, hwStr
        sub     rsp, 8
        mov     rdi, rsp        ; Hold # of bytes written here

; Note: must set aside 32 bytes (20h) for shadow registers for
; parameters (just do this once for all functions). 
; Also, WriteFile has a 5th argument (which is NULL), 
; so we must set aside 8 bytes to hold that pointer (and
; initialize it to zero). Finally, the stack must always be 
; 16-byte-aligned, so reserve another 8 bytes of storage
; to ensure this.

; Shadow storage for args (always 30h bytes).

        sub     rsp, 030h 
                
; Handle = GetStdHandle(-11);
; Single argument passed in ECX.
; Handle returned in RAX.

        mov     rcx, -11        ; STD_OUTPUT
        call    qword ptr __imp_GetStdHandle 
                
; WriteFile(handle, "Hello World!", 12, &amp;bytesWritten, NULL);
; Zero out (set to NULL) "LPOverlapped" argument:
        
        mov     qword ptr [rsp + 4 * 8], 0  ; 5th argument on stack
        
        mov     r9, rdi         ; Address of "bytesWritten" in R9
        mov     r8d, hwLen      ; Length of string to write in R8D 
        lea     rdx, hwStr      ; Ptr to string data in RDX
        mov     rcx, rax        ; File handle passed in RCX
        call    qword ptr __imp_WriteFile
        add     rsp, 38h
        ret
main    ENDP
        END</code></pre>
<p>This (pure) assembly language program is offered without explanation. Various chapters in this book explain the machine instructions.</p>
<p>Look back at the source code, and you’ll see the first line is as follows:</p>
<pre><code>includelib kernel32.lib</code></pre>
<p>The <em>kernel32.lib</em> is a Windows library that includes, among other things, the <code>GetStdHandle</code> and <code>WriteFile</code> functions this assembly language program uses. The Visual Studio installation includes this file and, presumably, the <em>vcvars64.bat</em> file will put it in an include path so the linker can find it. If you have problems assembling and linking the program (in the next step), simply make a copy of this file (wherever you can find it in the Visual Studio installation) and include that copy in the directory where you are building the <em>hw64.asm</em> file.</p>
<p><span epub:type="pagebreak" title="924" id="Page_924"/>To compile (assemble) this file, open the command window (whose shortcut you created earlier) to get a command prompt. Then enter the following command:</p>
<pre><code>ml64 hw64.asm /link /subsystem:console /entry:main</code></pre>
<p>Assuming you entered the code without error, the command window should have output similar to the following:</p>
<pre><code>C:\MASM64&gt;<b>ml64 hw64.asm /link /subsystem:console /entry:main</b>
Microsoft (R) Macro Assembler (x64) Version 14.28.29910.0
Copyright (C) Microsoft Corporation.  All rights reserved.

 Assembling: hw64.asm
Microsoft (R) Incremental Linker Version 14.28.29910.0
Copyright (C) Microsoft Corporation.  All rights reserved.

/OUT:hw64.exe
hw64.obj
/subsystem:console
/entry:main</code></pre>
<p>You can run the <em>hw64.exe</em> output file that this assembly produces by typing the command <code class="bold">hw64</code> at the command line prompt. The output should be the following:</p>
<pre><code>C:\MASM64&gt;<b>hw64</b>
Hello World!</code></pre>
</section>
</body></html>