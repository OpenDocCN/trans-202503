- en: '11'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Mass Assignment
  prefs: []
  type: TYPE_NORMAL
- en: '![](image_fi/book_art/chapterart.png)'
  prefs: []
  type: TYPE_IMG
- en: An API is vulnerable to mass assignment if the consumer is able to send a request
    that updates or overwrites server-side variables. If an API accepts client input
    without filtering or sanitizing it, an attacker can update objects with which
    they shouldn’t be able to interact. For example, a banking API might allow users
    to update the email address associated with their account, but a mass assignment
    vulnerability might let the user send a request that updates their account balance
    as well.
  prefs: []
  type: TYPE_NORMAL
- en: In this chapter, we’ll discuss strategies for finding mass assignment targets
    and figuring out which variables the API uses to identify sensitive data. Then
    we’ll discuss automating your mass assignment attacks with Arjun and Burp Suite
    Intruder.
  prefs: []
  type: TYPE_NORMAL
- en: Finding Mass Assignment Targets
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: One of the most common places to discover and exploit mass assignment vulnerabilities
    is in API requests that accept and process client input. Account registration,
    profile editing, user management, and client management are all common functions
    that allow clients to submit input using the API.
  prefs: []
  type: TYPE_NORMAL
- en: Account Registration
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Likely the most frequent place you’ll look for mass assignment is in account
    registration processes, as these might allow you to register as an administrative
    user. If the registration process relies on a web application, the end user would
    fill in standard fields with information such as their desired username, email
    address, phone number, and account password. Once the user clicks the submit button,
    an API request like the following would be sent:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 'For most end users, this request takes place in the background, leaving them
    none the wiser. However, since you’re an expert at intercepting web application
    traffic, you can easily capture and manipulate it. Once you’ve intercepted a registration
    request, check whether you can submit additional values in the request. A common
    version of this attack is to upgrade an account to an administrator role by adding
    a variable that the API provider likely uses to identify admins:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: If the API provider uses this variable to update account privileges on the backend
    and accepts additional input from the client, this request will turn the account
    being registered into an admin-level account.
  prefs: []
  type: TYPE_NORMAL
- en: Unauthorized Access to Organizations
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Mass assignment attacks go beyond making attempts to become an administrator.
    You could also use mass assignment to gain unauthorized access to other organizations,
    for instance. If your user objects include an organizational group that allows
    access to company secrets or other sensitive information, you can attempt to gain
    access to that group. In this example, we’ve added an `"org"` variable to our
    request and turned its value into an attack position we could then fuzz in Burp
    Suite:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: If you can assign yourself to other organizations, you will likely be able to
    gain unauthorized access to the other group’s resources. To perform such an attack,
    you’ll need to know the names or IDs used to identify the companies in requests.
    If the `"org"` value was a number, you could brute-force its value, like when
    testing for BOLA, to see how the API responds.
  prefs: []
  type: TYPE_NORMAL
- en: Do not limit your search for mass assignment vulnerabilities to the account
    registration process. Other API functions are capable of being vulnerable. Test
    other endpoints used for resetting passwords; updating account, group, or company
    profiles; and any other plays where you may be able to assign yourself additional
    access.
  prefs: []
  type: TYPE_NORMAL
- en: Finding Mass Assignment Variables
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The challenge with mass assignment attacks is that there is very little consistency
    in the variables used between APIs. That being said, if the API provider has some
    method for, say, designating accounts as administrator, you can be sure that they
    also have some convention for creating or updating variables to make a user an
    administrator. Fuzzing can speed up your search for mass assignment vulnerabilities,
    but unless you understand your target’s variables, this technique can be a shot
    in the dark.
  prefs: []
  type: TYPE_NORMAL
- en: Finding Variables in Documentation
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Begin by looking for sensitive variables in the API documentation, especially
    in sections focused on privileged actions. In particular, the documentation can
    give you a good indication of what parameters are included within JSON objects.
  prefs: []
  type: TYPE_NORMAL
- en: 'For example, you might search for how a low-privileged user is created compared
    to how an administrator account is created. Submitting a request to create a standard
    user account might look something like this:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: 'Creating an admin account might look something like the following:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: 'Notice that the admin request is submitted to an admin endpoint, uses an admin
    token, and includes the parameter `"admin": true`. There are many fields related
    to admin account creation, but if the application doesn’t handle the requests
    properly, we might be able to make an administrator account by simply adding the
    parameter `"admin"=true` to our user account request, as shown here:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: Fuzzing Unknown Variables
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'Another common scenario is that you’ll perform an action in a web application,
    intercept the request, and locate several bonus headers or parameters within it,
    like so:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: Parameters used in one part of an endpoint might be useful for exploiting mass
    assignment using a different endpoint. When you don’t understand the purpose of
    a certain parameter, it’s time to put on your lab coat and experiment. Try fuzzing
    by setting `uam` to zero, `mfa` to false, and `account` to every number between
    0 and 101, and then watch how the provider responds. Better yet, try a variety
    of inputs, such as those discussed in the previous chapter. Build up your wordlist
    with the parameters you collect from an endpoint and then flex your fuzzing skills
    by submitting requests with those parameters included. Account creation is a great
    place to do this, but don’t limit yourself to it.
  prefs: []
  type: TYPE_NORMAL
- en: Blind Mass Assignment Attacks
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: 'If you cannot find variable names in the locations discussed, you could perform
    a blind mass assignment attack. In such an attack, you’ll attempt to brute-force
    possible variable names through fuzzing. Send a single request with many possible
    variables, like the following, and see what sticks:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: If an API is vulnerable, it might ignore the irrelevant variables and accept
    the variable that matches the expected name and format.
  prefs: []
  type: TYPE_NORMAL
- en: Automating Mass Assignment Attacks with Arjun and Burp Suite Intruder
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'As with many other API attacks, you can discover mass assignment by manually
    altering an API request or by using a tool such as Arjun for parameter fuzzing.
    As you can see in the following Arjun request, we’ve included an authorization
    token with the `–headers` option, specified JSON as the format for the request
    body, and identified the exact attack spot that Arjun should test with `$arjun$`:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE8]'
  prefs: []
  type: TYPE_PRE
- en: As a result, Arjun will send a series of requests with various parameters from
    a wordlist to the target host. Arjun will then narrow down likely parameters based
    on deviations of response lengths and response codes and provide you with a list
    of valid parameters.
  prefs: []
  type: TYPE_NORMAL
- en: 'Remember that if you run into issues with rate limiting, you can use the Arjun
    `—stable` option to slow down the scans. This sample scan completed and discovered
    three valid parameters: `user`, `pass`, and `admin`.'
  prefs: []
  type: TYPE_NORMAL
- en: 'Many APIs prevent you from sending too many parameters in a single request.
    As a result, you might receive one of several HTTP status codes in the 400 range,
    such as 400 Bad Request, 401 Unauthorized, or 413 Payload Too Large. In that case,
    instead of sending a single large request, you could cycle through possible mass
    assignment variables over many requests. This can be done by setting up the request
    in Burp Suite’s Intruder with the possible mass assignment values as the payload,
    like so:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE9]'
  prefs: []
  type: TYPE_PRE
- en: Combining BFLA and Mass Assignment
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'If you’ve discovered a BFLA vulnerability that allows you to update other users’
    accounts, try combining this ability with a mass assignment attack. For example,
    let’s say a user named Ash has discovered a BFLA vulnerability, but the vulnerability
    only allows him to edit basic profile information such as usernames, addresses,
    cities, and regions:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE10]'
  prefs: []
  type: TYPE_PRE
- en: At this point, Ash could deface other user accounts, but not much more. However,
    performing a mass assignment attack with this request could make the BFLA finding
    much more significant. Let’s say that Ash analyzes other GET requests in the API
    and notices that other requests include parameters for email and multifactor authentication
    (MFA) settings. Ash knows that there is another user, named Brock, whose account
    he would like to access.
  prefs: []
  type: TYPE_NORMAL
- en: 'Ash could disable Brock’s MFA settings, making it easier to gain access to
    Brock’s account. Moreover, Ash could replace Brock’s email with his own. If Ash
    were to send the following request and get a successful response, he could gain
    access to Brock’s account:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE11]'
  prefs: []
  type: TYPE_PRE
- en: Since Ash does not know Brock’s current password, Ash should leverage the API’s
    process for performing a password reset, which would likely be a PUT or POST request
    sent to */api/v1/account/reset*. The password reset process would then send a
    temporary password to Ash’s email. With MFA disabled, Ash would be able to use
    the temporary password to gain full access to Brock’s account.
  prefs: []
  type: TYPE_NORMAL
- en: Always remember to think as an adversary would and take advantage of every opportunity.
  prefs: []
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: If you encounter a request that accepts client input for sensitive variables
    and allows you to update those variables, you have a serious finding on your hands.
    As with other API attacks, sometimes a vulnerability may seem minor until you’ve
    combined it with other interesting findings. Finding a mass assignment vulnerability
    is often just the tip of the iceberg. If this vulnerability is present, chances
    are that other vulnerabilities are present.
  prefs: []
  type: TYPE_NORMAL
- en: 'Lab #8: Changing the Price of Items in an Online Store'
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Armed with our new mass assignment attack techniques, let’s return to crAPI.
    Consider what requests accept client input and how we could leverage a rogue variable
    to compromise the API. Several of the requests in your crAPI Postman collection
    appear to allow client input:'
  prefs: []
  type: TYPE_NORMAL
- en: '`POST /identity/api/auth/signup`'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '`POST /workshop/api/shop/orders`'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '`POST /workshop/api/merchant/contact_mechanic`'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: It’s worth testing each of these once we’ve decided what variable to add to
    them.
  prefs: []
  type: TYPE_NORMAL
- en: We can locate a sensitive variable in the GET request to the */workshop/api/shop/products*
    endpoint, which is responsible for populating the crAPI storefront with products.
    Using Repeater, notice that the GET request loads a JSON variable called `"credit"`
    (see [Figure 11-1](#figure11-1)). That seems like an interesting variable to manipulate.
  prefs: []
  type: TYPE_NORMAL
- en: '![screenshot of burp suite’s repeater that shows the request to get /workshop/api/shop/products.
    the response loads a json variable “credit”:50.0](image_fi/502444c11/F11001.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11-1: Using Burp Suite Repeater to analyze the */workshop/api/shop/products*
    endpoint'
  prefs: []
  type: TYPE_NORMAL
- en: 'This request already provides us with a potential variable to test (`credit`),
    but we can’t actually change the credit value using a GET request. Let’s run a
    quick Intruder scan to see if we can leverage any other request methods with this
    endpoint. Right-click the request in Repeater and send it to Intruder. Once in
    Intruder, set the attack position to the request method:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE12]'
  prefs: []
  type: TYPE_PRE
- en: 'Let’s update the payloads with the request methods we want to test for: PUT,
    POST, HEAD, DELETE, CONNECT, PATCH, and OPTIONS (see [Figure 11-2](#figure11-2)).'
  prefs: []
  type: TYPE_NORMAL
- en: Start the attack and review the results. You’ll notice that crAPI will respond
    to restricted methods with a 405 Method Not Allowed status code, which means the
    400 Bad Request response we received in response to the POST request is pretty
    interesting (see [Figure 11-3](#figure11-3)). This 400 Bad Request likely indicates
    that crAPI is expecting a different payload to be included in the POST request.
  prefs: []
  type: TYPE_NORMAL
- en: '![screenshot of burp suite’s payloads window that includes the payload options
    put, post, head, delete, connect, patch, and options and has space to enter new
    items](image_fi/502444c11/F11002.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11-2: Burp Suite Intruder request methods with payloads'
  prefs: []
  type: TYPE_NORMAL
- en: '![screenshot of burp suite’s intruder results that shows 200, 405, and 400
    statuses for various payloads](image_fi/502444c11/F11003.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11-3: Burp Suite Intruder results'
  prefs: []
  type: TYPE_NORMAL
- en: 'The response tells us that we’ve omitted certain required fields from the POST
    request. The best part is the API tells us the required parameters. If we think
    it through, we can guess that the request is likely meant for a crAPI administrator
    to use in order to update the crAPI store. However, since this request is not
    restricted to administrators, we have likely stumbled across a combined mass assignment
    and BFLA vulnerability. Perhaps we can create a new item in the store and update
    our credit at the same time:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE13]'
  prefs: []
  type: TYPE_PRE
- en: This request succeeds with an HTTP 200 OK response! If we visit the crAPI store
    in a browser, we’ll notice that we successfully created a new item in the store
    with a new price of 25, but, unfortunately, our credit remains unaffected. If
    we purchase this item, we’ll notice that it automatically subtracts that amount
    from our credit, as any regular store transaction should.
  prefs: []
  type: TYPE_NORMAL
- en: 'Now it’s time to put on our adversarial hat and think through this business
    logic. As the consumer of crAPI, we shouldn’t be able to add products to the store
    or adjust prices . . . but we can. If the developers programmed the API under
    the assumption that only trustworthy users would add products to the crAPI store,
    what could we possibly do to exploit this situation? We could give ourselves an
    extreme discount on a product—maybe a deal so good that the price is actually
    a negative number:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE14]'
  prefs: []
  type: TYPE_PRE
- en: 'The item `MassAssignment SPECIAL` is one of a kind: if you purchase it, the
    store will pay you 5,000 credits. Sure enough, this request receives an HTTP 200
    OK response. As you can see in [Figure 11-4](#figure11-4), we have successfully
    added the item to the crAPI store.'
  prefs: []
  type: TYPE_NORMAL
- en: '![screenshot of crapi’s store that shows an item called massassignment special
    for $-5000.00](image_fi/502444c11/F11004.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11-4: The MassAssignment SPECIAL on crAPI'
  prefs: []
  type: TYPE_NORMAL
- en: By purchasing this special deal, we add an extra $5,000 to our available balance
    (see [Figure 11-5](#figure11-5)).
  prefs: []
  type: TYPE_NORMAL
- en: '![screenshot of crapi’s shop that shows the available balance as $5030](image_fi/502444c11/F11005.png)'
  prefs: []
  type: TYPE_IMG
- en: 'Figure 11-5: Available balance on crAPI'
  prefs: []
  type: TYPE_NORMAL
- en: As you can see, our mass assignment exploit would have severe consequences for
    any business with this vulnerability. I hope your bounty for such a finding greatly
    outweighs the credit you could add to your account! In the next chapter, we’ll
    begin our journey through the wide variety of potential injection attacks we can
    leverage against APIs.
  prefs: []
  type: TYPE_NORMAL
