- en: '**5**'
  id: totrans-0
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: '**5**'
- en: '**TARGETING VIRTUAL MACHINES**'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: '**虚拟机目标**'
- en: '![image](../images/00015.jpeg)'
  id: totrans-2
  prefs: []
  type: TYPE_IMG
  zh: '![image](../images/00015.jpeg)'
- en: Every penetration tester is likely to encounter numerous virtual machines (VMs)
    in Azure. As you’ll learn in this chapter, attackers can leverage Azure Storage
    as a vector to steal secrets from, and take control of, Azure virtual machines.
    With the right level of access to these systems, an attacker could take complete
    control over any service running on the VMs and surreptitiously collect data about
    the users who connect to them.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 每个渗透测试人员可能会遇到大量的 Azure 虚拟机（VM）。正如你将在本章中学习的那样，攻击者可以利用 Azure 存储作为窃取秘密并控制 Azure
    虚拟机的途径。只要获得适当级别的访问权限，攻击者就能完全控制运行在虚拟机上的任何服务，并秘密收集连接到这些虚拟机的用户数据。
- en: To demonstrate this, I begin with a look at how to obtain the *virtual hard
    disk (VHD)* images for virtual machines, without ever gaining Azure portal access.
    Once a copy of the VM’s VHD is obtained, I explain how to extract important data.
    Finally, I show you how to leverage the VM password reset option in the Azure
    portal.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 为了演示这一点，我首先展示如何在不访问 Azure 门户的情况下获取虚拟机的 *虚拟硬盘（VHD）* 镜像。一旦获得虚拟机的 VHD 副本，我将解释如何提取重要数据。最后，我将展示如何在
    Azure 门户中利用虚拟机密码重置选项。
- en: '**Best Practices: VM Security**'
  id: totrans-5
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '**最佳实践：虚拟机安全**'
- en: Virtual machines are one of the most common cloud workloads, because they allow
    businesses to quickly migrate on-premises servers into the cloud. Although VMs
    are a great way to take advantage of the benefits of the cloud with limited engineering
    effort, this approach can lead to security problems if companies don’t fully consider
    the new threats they might encounter as a result of such a move.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 虚拟机是最常见的云工作负载之一，因为它们允许企业快速将本地服务器迁移到云端。尽管虚拟机是利用云的好方式，且工程投入有限，但如果公司没有充分考虑因此类迁移可能遇到的新威胁，这种方式可能会带来安全问题。
- en: Most importantly, administrators of on-premises servers often take for granted
    the firewalls and other security appliances on the border of the corporate network.
    By default, cloud-hosted VMs are internet-facing, so every open port must be carefully
    considered, with only the minimum number of services exposed, as each is a potential
    target for attack. Use network security groups in addition to the VM’s host firewall
    to restrict access to all unneeded ports. Additionally, consider using virtual
    networks that aren’t exposed to the internet for those VMs that host services
    that need to be accessed only from other cloud resources.
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 最重要的是，内部服务器的管理员往往理所当然地认为公司网络边界上的防火墙和其他安全设备已经足够。默认情况下，云托管的虚拟机是面向互联网的，因此每个开放的端口都必须经过仔细考虑，只有最少数量的服务暴露出来，因为每个端口都可能成为攻击目标。除了虚拟机的主机防火墙外，还应使用网络安全组来限制对所有不需要的端口的访问。此外，对于那些只需要从其他云资源访问的虚拟机，考虑使用不面向互联网的虚拟网络。
- en: If you do expose a management service to the internet, such as RDP or SSH, you
    can reduce the risk of successful password spray or brute-force password attacks
    by ensuring that user accounts on the system use unusual account names (avoid
    common privileged account names like *administrator*, *admin*, and *root*) and
    strong passwords or, if possible, certificate-based or multi-factor authentication.
    Encourage the use of a password manager so users don’t balk at remembering strange
    usernames and complex passwords.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你确实将管理服务暴露到互联网上，比如 RDP 或 SSH，可以通过确保系统上的用户账户使用不常见的账户名（避免使用常见的特权账户名，如*administrator*、*admin*和*root*）以及强密码，或者在可能的情况下使用基于证书或多因素身份验证，来降低成功进行密码喷射或暴力破解密码攻击的风险。鼓励使用密码管理器，以便用户不必担心记住奇怪的用户名和复杂的密码。
- en: Next, whenever possible, utilize full disk encryption on your VMs to protect
    any data that resides on them. This prevents offline VHD analysis, as described
    in “[Exploring the VHD with Autopsy](part0014.html#lev119)” on [page 95](part0014.html#page_95).
    Azure Disk Encryption is a convenient way to encrypt VHDs. It utilizes Key Vault
    to store the encryption keys for the disk, so you don’t need to worry about managing
    the keys. It is a free service in Azure and is available for most VM pricing tiers.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，在可能的情况下，利用虚拟机的全盘加密来保护其上的任何数据。这可以防止离线分析 VHD，如在 “[使用 Autopsy 探索 VHD](part0014.html#lev119)”
    [第 95 页](part0014.html#page_95) 中所述。Azure 磁盘加密是一种方便的加密 VHD 的方式。它利用密钥保管库来存储磁盘的加密密钥，因此你不需要担心管理这些密钥。这是
    Azure 中的免费服务，适用于大多数虚拟机定价层。
- en: Finally, make sure that all relevant events for the VM are being monitored.
    Enabling Azure’s VM logs and including them in your blue team’s security log analysis
    tools is a good start. However, even more events can be detected by using Azure
    Security Center (ASC) and Operations Management Suite (OMS). ASC monitors VMs
    for known threats, while OMS provides detailed logs for any system where its agent
    is installed. Both solutions are described in detail in [Chapter 8](part0017.html#ch08).
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，确保正在监控所有与VM相关的事件。启用Azure的VM日志并将其包含在你的蓝队安全日志分析工具中是一个好的开始。然而，使用Azure安全中心（ASC）和运营管理套件（OMS）可以检测更多事件。ASC监控VM的已知威胁，而OMS为安装其代理的任何系统提供详细的日志。两种解决方案在[第8章](part0017.html#ch08)中有详细介绍。
- en: '**Virtual Hard Disk Theft and Analysis**'
  id: totrans-11
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '**虚拟硬盘盗窃与分析**'
- en: Because one can obtain credentials for Azure Storage without full access to
    a subscription (as discussed in [Chapter 4](part0013.html#ch04)), an attacker
    may be able to control a running VM with just a storage account key. To do this,
    the attacker needs to obtain a VHD, retrieve passwords or certificates stored
    on the VHD, and then use those secrets to access the VM. Let’s start by looking
    at how a penetration tester can acquire a copy of a VM’s VHD.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 因为可以在没有完全访问订阅的情况下获取Azure Storage凭证（如[第4章](part0013.html#ch04)中所述），攻击者可能仅凭存储帐户密钥就能控制正在运行的VM。为了做到这一点，攻击者需要获取VHD，检索存储在VHD上的密码或证书，然后使用这些密钥访问VM。让我们首先看看渗透测试人员如何获取VM的VHD副本。
- en: '***Downloading a VHD Snapshot***'
  id: totrans-13
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: '***下载VHD快照***'
- en: In order to download the disk image, you’ll need the key for the storage account
    that contains the desired VM’s VHD. This can be obtained directly from the Azure
    portal or through Azure PowerShell’s cmdlet `Get-AzureRmStorageAccountKey` if
    you have subscription access. Alternatively, you can use any of the storage key
    recovery methods described in [Chapter 4](part0013.html#ch04) if you don’t have
    subscription access. Once you’ve procured storage credentials, launch either Microsoft
    Azure Storage Explorer or ClumsyLeaf CloudXplorer. These are the only two tools
    that can create snapshots of files in Azure Storage. I’ll show how to use Microsoft
    Azure Storage Explorer because it is the free option.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 为了下载磁盘映像，你需要获取存储帐户的密钥，该帐户包含所需VM的VHD。如果你有订阅权限，可以直接从Azure门户获取密钥，或者通过Azure PowerShell的`Get-AzureRmStorageAccountKey`
    cmdlet获取。此外，如果你没有订阅权限，也可以使用[第4章](part0013.html#ch04)中描述的任何存储密钥恢复方法。一旦获得了存储凭证，启动Microsoft
    Azure Storage Explorer或ClumsyLeaf CloudXplorer。这是能够创建Azure Storage中文件快照的唯一两个工具。我将展示如何使用Microsoft
    Azure Storage Explorer，因为它是免费的选项。
- en: '**NOTE**'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: '**注意**'
- en: '*If you attempt to download a file from Azure while it’s in use, such as a
    VHD being used by a running VM, the download will be interrupted and the file
    will be corrupt or incomplete. The snapshot API creates a consistent (meaning
    non-corrupt) point-in-time duplicate of a file that you can copy. Because you
    can’t tell if a VHD is in use, you should always assume that it is and make a
    snapshot.*'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: '*如果你尝试从Azure下载一个正在使用中的文件，比如正在运行的VM使用的VHD，下载将会中断，文件将损坏或不完整。快照API会创建一个一致的（即不损坏的）时间点副本，你可以复制它。因为你无法判断VHD是否正在使用，所以你应该始终假设它正在使用并创建快照。*'
- en: 'Follow these steps to download a snapshot in Microsoft Azure Storage Explorer:'
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 按照以下步骤在Microsoft Azure Storage Explorer中下载快照：
- en: Click the VHD file you want to copy and then click the **Make Snapshot** button
    in the ribbon menu, as shown in [Figure 5-1](part0014.html#ch05fig1).
  id: totrans-18
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击你想复制的VHD文件，然后点击功能区菜单中的**创建快照**按钮，如[图5-1](part0014.html#ch05fig1)所示。
- en: '![image](../images/00035.jpeg)'
  id: totrans-19
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![image](../images/00035.jpeg)'
- en: '*Figure 5-1: Creating a snapshot for a VHD in Microsoft Azure Storage Explorer*'
  id: totrans-20
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '*图5-1：在Microsoft Azure Storage Explorer中为VHD创建快照*'
- en: Click the **Manage Snapshot** button. You should see all of the selected file’s
    snapshots in the file list. Their names should start with the name of the VHD,
    followed by a date and time in parentheses.
  id: totrans-21
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击**管理快照**按钮。你应该能在文件列表中看到所有选定文件的快照。它们的名称应以VHD的名称开始，后面跟着括号中的日期和时间。
- en: To save the snapshot to your PC, select the snapshot and click **Download**
    in the ribbon.
  id: totrans-22
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 要将快照保存到你的PC，选择快照并点击功能区中的**下载**按钮。
- en: Be sure to delete the snapshot from the storage account once you’ve downloaded
    the VHD snapshot. Not only might a user notice the duplicate file, but the duplicate
    also takes up additional space in the storage account, which will lead to additional
    charges on the subscription’s monthly invoice. Although having the snapshot around
    for an hour or two while copying the VHD will likely go unnoticed, a full month’s
    worth of charges for potentially hundreds of gigabytes of blob storage will stand
    out to a good accountant.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 确保在下载完 VHD 快照后，从存储帐户中删除该快照。用户不仅可能注意到重复的文件，而且重复的文件还会占用额外的存储空间，导致订阅的月度账单产生额外费用。尽管在复制
    VHD 时保留快照一两个小时可能不会被注意到，但一个月的费用，如果是数百 GB 的 Blob 存储量，对于一个精明的会计来说是显而易见的。
- en: '**DEFENDER’S TIP**'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: '**DEFENDER’S TIP**'
- en: Azure Storage Analytics logging will record Azure Storage activity for blobs,
    queues, and tables. This includes successful and failed authentication attempts,
    uploads, downloads, deletions, and snapshot operations. Be sure to enable it and
    review this data for unusual activity. For more information see *[https://docs.microsoft.com/en-us/rest/api/storageservices/enabling-storage-logging-and-accessing-log-data/](https://docs.microsoft.com/en-us/rest/api/storageservices/enabling-storage-logging-and-accessing-log-data/)*.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 存储分析日志会记录 Azure 存储活动，包括 Blob、队列和表的操作。这包括成功和失败的身份验证尝试、上传、下载、删除和快照操作。务必启用此功能，并查看这些数据以识别异常活动。有关更多信息，请参见
    *[https://docs.microsoft.com/en-us/rest/api/storageservices/enabling-storage-logging-and-accessing-log-data/](https://docs.microsoft.com/en-us/rest/api/storageservices/enabling-storage-logging-and-accessing-log-data/)*。
- en: Also, billing data can be a surprisingly helpful tool to alert you if someone
    is exploiting your subscription. If you expect a subscription’s usage to be constant
    from month to month, a sudden change in cost warrants an investigation. The cause
    might be something innocuous, like a change in Azure’s rates, but it also might
    be someone running additional services in your subscription for nefarious purposes!
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，账单数据可以是一个意外有用的工具，帮助你发现是否有人正在利用你的订阅。如果你预计订阅的使用情况从月到月保持不变，那么费用的突然变化就值得调查。原因可能是一些无害的因素，比如
    Azure 费率的变化，但也有可能是有人在你的订阅中运行额外的服务，进行不正当的活动！
- en: To delete snapshots in Microsoft Azure Storage Explorer, click the snapshot
    in the list of files to highlight it and then click the **Delete** button on the
    ribbon. If you don’t see any snapshots listed, click **Manage Snapshot** in the
    ribbon menu first.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 要在 Microsoft Azure Storage Explorer 中删除快照，点击文件列表中的快照以选中它，然后点击工具栏上的 **删除** 按钮。如果没有看到列出的快照，首先点击工具栏菜单中的
    **管理快照**。
- en: '***Retrieving a VHD’s Secrets***'
  id: totrans-28
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: '***获取 VHD 的秘密***'
- en: 'Once you have a copy of the VHD on your computer, you can review it for useful
    information. The files to look for will depend on the guest’s operating system,
    but the goal is the same: identify information that is either valuable as a penetration
    test finding in its own right (for example, not-yet-released financials) or information
    that furthers your access to target systems (for example, passwords).'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦你在计算机上有了 VHD 的副本，可以查看其中有用的信息。需要查找的文件取决于客户操作系统，但目标是相同的：找出那些本身具有渗透测试价值的信息（例如，尚未发布的财务数据），或者那些可以帮助你进一步访问目标系统的信息（例如，密码）。
- en: Finding a password for the same VM that uses the stolen VHD is quite desirable.
    Although having that credential might seem moot with the VHD in hand, once you’ve
    found a password, you can perform many useful actions against a running VM that
    would not work against a static VHD copy. For example, with access to a VM, you
    could run Mimikatz to look for credentials you haven’t yet obtained. You could
    also modify a running service on the VM to covertly forward information to you
    as it arrives. You could even use it to send phishing emails, because users are
    typically more trusting of links to a server that they already know. The possibilities
    are limited only by your imagination.
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 找到用于盗取 VHD 的同一虚拟机的密码是非常值得追求的。虽然拥有该凭证在手中有 VHD 后可能看起来没有意义，但一旦你找到了密码，你就可以在运行的虚拟机上执行许多有效的操作，而这些操作在静态的
    VHD 副本上无法进行。例如，通过访问虚拟机，你可以运行 Mimikatz 查找尚未获得的凭证。你还可以修改虚拟机上的运行服务，秘密地将信息转发给你。你甚至可以用它发送钓鱼邮件，因为用户通常会更信任他们已经知道的服务器链接。可能性仅受限于你的想象力。
- en: Reviewing the contents of VHD files can become a lengthy exercise in computer
    forensics, depending on the number of VHDs you obtain. Because you likely won’t
    have time to dig through every file in every disk image, let’s focus on a few
    key areas that are usually the most fruitful.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 审查 VHD 文件的内容可能会成为一项漫长的计算机取证工作，具体取决于你获得的 VHD 数量。由于你可能没有时间逐一检查每个磁盘映像中的所有文件，因此让我们重点关注几个通常最有价值的关键领域。
- en: '**Exploring the VHD with Autopsy**'
  id: totrans-32
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '**使用 Autopsy 探索 VHD**'
- en: 'Before you can review the contents of a VHD, you have to find a way to open
    it. If you are using Windows 10 and your target VM is also running a version of
    Windows, you should be able to right-click the VHD and select **Mount** to mount
    the VHD as a new virtual disk in Windows Explorer. If you’re running Linux and
    you have a VHD library installed, you should be able to use the mount command
    to attach the VHD. However, I prefer to explore the VHD using disk forensic tools
    like Autopsy. Using a disk forensic program has several advantages over native
    mount options:'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 在你可以查看 VHD 内容之前，你必须找到一种方法来打开它。如果你使用的是 Windows 10，且目标虚拟机也运行 Windows 版本，你应该能够右键点击
    VHD 并选择 **Mount**，将 VHD 作为一个新的虚拟磁盘挂载到 Windows 文件资源管理器中。如果你在运行 Linux，并且安装了 VHD
    库，你应该能够使用 mount 命令来挂载 VHD。然而，我更喜欢使用像 Autopsy 这样的磁盘取证工具来探索 VHD。使用磁盘取证程序相对于原生挂载选项有几个优势：
- en: '**Broad disk format support** Whereas Windows can only mount disk images in
    NTFS and FAT formats, forensic tools can open dozens of formats—even when running
    on Windows. And on Linux, forensic tools often do a better job reading from unusual
    formats than Linux itself does.'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: '**广泛的磁盘格式支持** Windows 只能挂载 NTFS 和 FAT 格式的磁盘映像，而取证工具可以打开多种格式——即使是在 Windows 上运行时。而在
    Linux 上，取证工具通常比 Linux 本身更擅长读取不常见的格式。'
- en: '**Better protection from malware** When mounting an untrusted file system directly
    into your system, you run the risk that any malware on the VHD could end up infecting
    your host. By using the forensic tool to extract only a few specific files of
    interest, you greatly reduce that risk.'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: '**更好的恶意软件保护** 当你直接将一个不可信的文件系统挂载到你的系统中时，存在 VHD 上的任何恶意软件可能感染宿主系统的风险。通过使用取证工具只提取几个特定的感兴趣文件，你可以大大降低这个风险。'
- en: '**Protection for the integrity of the VHD** Forensic tools are designed to
    mount disk images in read-only mode, which prevents you from accidentally modifying
    or deleting files in the VHD. This not only prevents mistakes, but can also help
    quell skepticism when you present your findings.'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: '**VHD 完整性保护** 取证工具旨在以只读模式挂载磁盘映像，这样可以防止你意外修改或删除 VHD 中的文件。这不仅可以避免错误，还能帮助你在展示发现时消除怀疑。'
- en: '**Ability to recover deleted files** Forensic tools specialize in re-creating
    files in disk images that users have deleted but that haven’t yet been overwritten
    by new data. You might come across some very interesting files that wouldn’t appear
    with a native mount command.'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: '**恢复删除文件的能力** 取证工具专门用于恢复用户已删除但尚未被新数据覆盖的磁盘映像中的文件。你可能会发现一些非常有趣的文件，这些文件在使用原生挂载命令时是看不到的。'
- en: My go-to forensic tool is the free, open source Autopsy (*[http://www.sleuthkit.org/](http://www.sleuthkit.org/)*).
    You can run it on Windows, Linux, and macOS. Although it lacks some of the advanced
    features and polish of commercial forensic programs, it’s more than sufficient
    for penetration testing, and it avoids the high cost associated with niche commercial
    tools.
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 我常用的取证工具是免费的开源软件 Autopsy (*[http://www.sleuthkit.org/](http://www.sleuthkit.org/)*)。它可以在
    Windows、Linux 和 macOS 上运行。尽管它缺少一些商业取证程序的高级功能和打磨，但它对于渗透测试已经足够，并且避免了与小众商业工具相关的高成本。
- en: '***Importing the VHD***'
  id: totrans-39
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: '***导入 VHD***'
- en: 'Regardless of your computer’s operating system or that of the VHD, the instructions
    for using Autopsy to import the VHD for examination are as follows:'
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: 无论你的计算机操作系统或 VHD 的操作系统是什么，使用 Autopsy 导入 VHD 进行检查的步骤如下：
- en: Start Autopsy and choose **Create New Case** on the Welcome screen.
  id: totrans-41
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启动 Autopsy，并在欢迎界面上选择 **Create New Case**。
- en: Give the case a name (use the name of the VM) and select a directory for Autopsy
    to save its working files. Click **Next**.
  id: totrans-42
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 为案件命名（使用虚拟机的名称），并选择一个目录以便 Autopsy 保存其工作文件。点击 **Next**。
- en: Leave the Case Number and Examiner fields blank and then click **Finish** to
    open the Add Data Source Wizard.
  id: totrans-43
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将 Case Number 和 Examiner 字段留空，然后点击 **Finish** 以打开 "Add Data Source Wizard"。
- en: On the Add Data Source window, browse to the downloaded VHD, select it, and
    click **Next**.
  id: totrans-44
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在 "Add Data Source" 窗口中，浏览到下载的 VHD，选择它，然后点击 **Next**。
- en: The Configure Ingest Modules screen, depicted in [Figure 5-2](part0014.html#ch05fig2),
    allows you to select what post-processing Autopsy will perform on the VHD, such
    as creating a search index and thumbnails of all pictures. Make your choices and
    then click **Next**, followed by **Finish** on the next screen.
  id: totrans-45
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 配置导入模块屏幕，如[图5-2](part0014.html#ch05fig2)所示，允许您选择Autopsy对VHD执行的后处理操作，例如创建搜索索引和所有图片的缩略图。做出选择后，点击**下一步**，然后在下一个屏幕上点击**完成**。
- en: '![image](../images/00036.jpeg)'
  id: totrans-46
  prefs: []
  type: TYPE_IMG
  zh: '![image](../images/00036.jpeg)'
- en: '*Figure 5-2: Selecting ingestion options in Autopsy*'
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: '*图5-2：在Autopsy中选择导入选项*'
- en: '**NOTE**'
  id: totrans-48
  prefs: []
  type: TYPE_NORMAL
  zh: '**注意**'
- en: Ingestion *is the process used by forensics software to automatically scan through
    the contents of the disk being examined and call out items of interest for the
    examiner. Autopsy provides a number of preconfigured ingestion options, such as
    email and credit card number identification and photo retrieval. It also supports
    custom filters so examiners can add their own.*
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 导入*是取证软件用来自动扫描被检查磁盘内容的过程，并为检查员标出感兴趣的项目。Autopsy提供了多种预配置的导入选项，如电子邮件和信用卡号识别以及照片提取。它还支持自定义过滤器，供检查员添加自己的过滤条件。*
- en: At this point, you should be at the main Autopsy interface, as shown in [Figure
    5-3](part0014.html#ch05fig3). Double-click the VHD file in the Directory Listing
    area and you’ll see a list of partitions within the VHD, including unallocated
    partitions that represent unused space in the virtual disk.
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 此时，您应该已经进入了Autopsy的主界面，如[图5-3](part0014.html#ch05fig3)所示。双击目录列表区域中的VHD文件，您将看到VHD内分区的列表，包括代表虚拟磁盘中未使用空间的未分配分区。
- en: '![image](../images/00037.jpeg)'
  id: totrans-51
  prefs: []
  type: TYPE_IMG
  zh: '![image](../images/00037.jpeg)'
- en: '*Figure 5-3: Navigating the disk image using Autopsy*'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: '*图5-3：使用Autopsy导航磁盘映像*'
- en: 'If Autopsy fails to load the VHD, either the VHD is corrupt and should be downloaded
    again, or the VM owner has enabled Azure Disk Encryption, in which case there’s
    nothing else you can do here. To check if encryption is enabled, try mounting
    the VHD on a Windows system using PowerShell:'
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 如果Autopsy无法加载VHD，可能是VHD已损坏，应该重新下载，或者VM所有者启用了Azure磁盘加密，在这种情况下，您无法继续操作。要检查是否启用了加密，可以尝试在Windows系统上使用PowerShell挂载VHD：
- en: '[PRE0]'
  id: totrans-54
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: If the image is corrupt, PowerShell will display the error `The file or directory
    is corrupted and unreadable`. If it is encrypted, a new Windows Explorer window
    will open attempting to display the VHD’s contents, but will report that the drive
    is not accessible.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 如果镜像已损坏，PowerShell会显示错误`文件或目录已损坏，无法读取`。如果它被加密，则会打开一个新的Windows资源管理器窗口，尝试显示VHD的内容，但会报告驱动器无法访问。
- en: '**DEFENDER’S TIP**'
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: '**防御者小贴士**'
- en: Azure Disk Encryption allows you to encrypt the contents of your VHDs in Azure
    Storage. It leverages BitLocker for Windows VMs and DM-Crypt for Linux VMs in
    order to fully encrypt the virtual disk, so if the VHD is removed from Azure,
    you won’t be able to read its contents. The encryption keys for the VHD are stored
    in Azure Key Vault. Note that to use Azure Disk Encryption, you must be using
    Standard or Premium tier VMs and the VMs must be ARM-based. You can learn more
    about Azure Disk Encryption at *[https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption/](https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption/)*.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: Azure磁盘加密允许您加密存储在Azure中的VHD内容。它利用BitLocker为Windows虚拟机和DM-Crypt为Linux虚拟机提供完整的磁盘加密，因此如果VHD从Azure中移除，您将无法读取其内容。VHD的加密密钥存储在Azure密钥保管库中。请注意，要使用Azure磁盘加密，您必须使用标准或高级虚拟机，并且虚拟机必须基于ARM架构。您可以在*[https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption/](https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption/)*了解更多关于Azure磁盘加密的信息。
- en: When the VHD loads, double-click the first partition not labeled *unallocated*.
    You should see a list of the files on the VHD, as shown in [Figure 5-4](part0014.html#ch05fig4).
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 当VHD加载时，双击第一个未标记为*未分配*的分区。您应该看到VHD中的文件列表，如[图5-4](part0014.html#ch05fig4)所示。
- en: '![image](../images/00038.jpeg)'
  id: totrans-59
  prefs: []
  type: TYPE_IMG
  zh: '![image](../images/00038.jpeg)'
- en: '*Figure 5-4: Examining a VHD in Autopsy*'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: '*图5-4：在Autopsy中检查VHD*'
- en: From within this interface, browse through the file system in search of interesting
    files. You can use the built-in hex viewer in the lower portion of the screen
    to preview files. To take a deeper look, select the file, right-click it, and
    then select **Extract File(s)** to save the file to your host system.
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 在此界面中，浏览文件系统以寻找感兴趣的文件。您可以使用屏幕下方的内置十六进制查看器预览文件。要进一步查看文件，选择该文件，右键点击它，然后选择**提取文件**将文件保存到您的主机系统中。
- en: Now let’s look at some of the most interesting files to seek out on Windows
    and Linux VHDs.
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: 现在让我们看看在 Windows 和 Linux VHD 中最有趣的一些文件。
- en: '***Analyzing Windows VHDs***'
  id: totrans-63
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: '***分析 Windows VHD***'
- en: When I’m analyzing a VM’s disk, my first priority is to collect credentials. When
    analyzing a Windows VHD, I start with the *Security Account Manager (SAM)* database
    at *\Windows\System32\config\SAM*. The SAM stores password hashes for all local,
    non-domain users on a system, such as the local administrator account. Windows
    uses an encryption key, called a *Syskey*, to protect the SAM. You can find this
    key in *\Windows\System32\config\SYSTEM*.
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 当我分析虚拟机的磁盘时，我的首要任务是收集凭据。分析 Windows VHD 时，我首先从 *\Windows\System32\config\SAM*
    中的 *Security Account Manager (SAM)* 数据库开始。SAM 存储所有本地非域用户的密码哈希，如本地管理员账户。Windows
    使用一个加密密钥，称为 *Syskey*，来保护 SAM。你可以在 *\Windows\System32\config\SYSTEM* 中找到这个密钥。
- en: 'Here’s how to decrypt the SAM file and obtain the hashes:'
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: 下面是解密 SAM 文件并获取哈希的方法：
- en: Extract the SYSTEM and SAM registry hive files from the VHD to your computer
    using Autopsy.
  id: totrans-66
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用 Autopsy 从 VHD 中提取 SYSTEM 和 SAM 注册表蜂巢文件到你的计算机中。
- en: Launch Cain & Abel (available from *[http://www.oxid.it/cain.html](http://www.oxid.it/cain.html)*).
  id: totrans-67
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启动 Cain & Abel（可从 *[http://www.oxid.it/cain.html](http://www.oxid.it/cain.html)*
    获取）。
- en: Click the **Cracker** tab.
  id: totrans-68
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击 **Cracker** 选项卡。
- en: Click **File** ▸ **Add to list**.
  id: totrans-69
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击 **文件** ▸ **添加到列表**。
- en: Select the **Import Hashes from a SAM database** option.
  id: totrans-70
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择 **从 SAM 数据库导入哈希** 选项。
- en: Click the browse button (**...**) next to SAM Filename and select the extracted
    SAM file.
  id: totrans-71
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击 SAM 文件名旁边的浏览按钮 (**...**)，选择提取的 SAM 文件。
- en: Click the browse button next to Boot Key and select the extracted SAM file.
  id: totrans-72
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击启动键旁边的浏览按钮，选择提取的 SAM 文件。
- en: On the Syskey Decoder box that opens, click the browse button and select the
    SYSTEM file you extracted.
  id: totrans-73
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在打开的 Syskey 解码器框中，点击浏览按钮并选择你提取的 SYSTEM 文件。
- en: Highlight and copy the displayed boot key.
  id: totrans-74
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 高亮并复制显示的启动键。
- en: Close the Syskey Decoder box and then paste the key into the Boot Key field.
  id: totrans-75
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 关闭 Syskey 解码器框，然后将密钥粘贴到启动键字段中。
- en: Click **Next**.
  id: totrans-76
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击 **下一步**。
- en: You should see the hashes for every account on the system, as shown in [Figure
    5-5](part0014.html#ch05fig5). (We’ll look at what to do with these hashes in “[Password
    Hash Attack Tools](part0014.html#lev129)” on [page 103](part0014.html#page_103),
    including how Cain & Abel can use them to obtain cleartext passwords.)
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 你应该能够看到系统中每个账户的哈希，如 [图 5-5](part0014.html#ch05fig5) 所示。（我们将在 “[密码哈希攻击工具](part0014.html#lev129)”
    一节中，讲解如何处理这些哈希，具体包括 Cain & Abel 如何利用它们获取明文密码，详见 [第 103 页](part0014.html#page_103)）
- en: '![image](../images/00039.jpeg)'
  id: totrans-78
  prefs: []
  type: TYPE_IMG
  zh: '![image](../images/00039.jpeg)'
- en: '*Figure 5-5: Hashes in Cain & Abel*'
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: '*图 5-5：Cain & Abel 中的哈希*'
- en: 'Aside from passwords, when examining a VHD I’m also interested in source code,
    configuration files, and documents. What you’ll find depends on how the VM is
    being used and what software is installed on it. Check these locations, if present,
    for a good chance of finding valuable content:'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 除了密码之外，在检查 VHD 时，我还对源代码、配置文件和文档感兴趣。你会找到什么取决于虚拟机的使用方式以及安装的软件。检查这些位置，如果存在的话，可能会找到有价值的内容：
- en: The *\InetPub* directory for website source code and configuration files (usually
    *web.config*). These may contain passwords and other secrets.
  id: totrans-81
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*\InetPub* 目录用于存放网站源代码和配置文件（通常是 *web.config*）。这些文件可能包含密码和其他秘密信息。'
- en: Each user’s home directory within *\Users*—especially their *Documents* folder
    for specifications and deployment documents about the target environment; *Desktop*
    folder for documents, keys, and notes; *Downloads* folder for hints about what
    tools may be used on the VM; and *AppData\Roaming* folder for Internet Explorer,
    Firefox, and Chrome subdirectories that contain web history, cookies, and saved
    passwords.
  id: totrans-82
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 每个用户在 *\Users* 下的主目录——特别是他们的 *Documents* 文件夹，用于存放关于目标环境的规格说明和部署文档；*Desktop*
    文件夹，用于存放文档、密钥和笔记；*Downloads* 文件夹，用于提供关于在虚拟机上可能使用的工具的线索；以及 *AppData\Roaming* 文件夹，用于存放包含网页历史、Cookies
    和保存的密码的 Internet Explorer、Firefox 和 Chrome 子目录。
- en: Directories that SQL uses.
  id: totrans-83
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: SQL 使用的目录。
- en: Any directories that Azure management tools use.
  id: totrans-84
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Azure 管理工具使用的任何目录。
- en: Temp directories for output of scheduled tasks, test scripts, and other random
    gems.
  id: totrans-85
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 用于输出计划任务、测试脚本和其他随机信息的临时目录。
- en: Directories containing backups.
  id: totrans-86
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 包含备份的目录。
- en: Also, perform a full-VHD search for file extensions like **.pfx* for certificate
    private keys; **.doc*, **.docx*, **.xls*, **.xlsx*, **.ppt*, and **.pptx* for
    Microsoft Office files; **.bak* for backups; and **.txt* for notes, which will
    sometimes contain passwords. You might also want to search for files that password
    managers use, like **.kdx* and **.kdbx* for KeePass, **.psafe3* for Password Safe,
    and **.dash* or **.dashlane* for Dashlane. Finally, find copies of any scripts
    not included with the operating system, like **.bat*, **.cmd*, and **.ps1* from
    any directory besides *\Windows*, and see what they are used for.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，还应在VHD中执行完整的扩展名搜索，查找像**.pfx*这样的证书私钥文件；**.doc*、**.docx*、**.xls*、**.xlsx*、**.ppt*和**.pptx*这些Microsoft
    Office文件；**.bak*用于备份；**.txt*用于笔记，这些文件有时包含密码。你可能还想搜索密码管理器使用的文件，如KeePass的**.kdx*和**.kdbx*、Password
    Safe的**.psafe3*，以及Dashlane的**.dash*或**.dashlane*。最后，找到操作系统中没有包含的任何脚本文件，如从除*\Windows*外的任何目录中找到的**.bat*、**.cmd*和**.ps1*，看看它们的用途。
- en: '***Analyzing Linux VHDs***'
  id: totrans-88
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: '***分析Linux VHDs***'
- en: To retrieve password hashes from a Linux VHD, export the */etc/passwd* and */etc/shadow*
    files to get a list of users and their password hashes. It’s also a good idea
    to copy */etc/group* and */etc/gshadow* to determine what group memberships, and
    what rights, user accounts have.
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 要从Linux VHD中提取密码哈希，可以导出*/etc/passwd*和*/etc/shadow*文件，以获取用户及其密码哈希的列表。复制*/etc/group*和*/etc/gshadow*也是个好主意，以确定用户账户的组成员资格和权限。
- en: The */etc/samba*, */etc/ssl*, and */etc/ssh* directories should contain configuration
    files and certificates that the system uses. Additionally, */etc/hostname* will
    contain the name of the VM, */etc/fstab* will list any other mounted disks in
    the VM, and */etc/hosts* may show static name-to-IP mappings of other servers
    that the VM interacts with.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: '*/etc/samba*、*/etc/ssl*和*/etc/ssh*目录应包含系统使用的配置文件和证书。此外，*/etc/hostname*将包含虚拟机的名称，*/etc/fstab*将列出虚拟机中挂载的任何其他磁盘，*/etc/hosts*可能会显示虚拟机与其他服务器交互的静态名称到IP的映射。'
- en: It’s a good idea to try to retrieve source code and configuration files for
    any websites hosted on the VM because they may contain secrets. This is especially
    true of Apache’s *.htpasswd* and *.htaccess* files, which control access to web
    content. Common locations for these files include */var/www*, */usr/share/nginx*,
    and */httpd*.
  id: totrans-91
  prefs: []
  type: TYPE_NORMAL
  zh: 尝试检索虚拟机上托管的任何网站的源代码和配置文件是个好主意，因为它们可能包含秘密。尤其是Apache的*.htpasswd*和*.htaccess*文件，它们控制对网页内容的访问。这些文件的常见位置包括*/var/www*、*/usr/share/nginx*和*/httpd*。
- en: Users’ home directories are another good source of information; these directories
    are typically found in */home* and also */root*. Saved Secure Shell (SSH) key
    files for connecting to remote systems and the history of commands, usually named
    *.bash_history*, are particularly interesting. Command histories will often have
    the names of other servers worth investigating. Look for commands like `ssh`,
    `telnet`, `scp`, and `smbclient`, as well as for a valid username for those systems.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 用户的主目录是另一个很好的信息来源；这些目录通常位于*/home*和*/root*下。保存的用于连接远程系统的安全外壳（SSH）密钥文件以及命令历史记录，通常名为*.bash_history*，尤其值得关注。命令历史记录通常会包含其他值得调查的服务器名称。查找像`ssh`、`telnet`、`scp`和`smbclient`这样的命令，以及这些系统的有效用户名。
- en: Even though Linux doesn’t use file extensions as universally as Windows does,
    you should perform a file extension search on Linux VHDs because many users and
    applications use extensions. Scan for certificate-related files (**.pfx*, **.p12*,
    **.jks*) as well as shell scripts (**.sh*) and text files (**.txt*). You might
    also find something interesting in database files such as **.sql*, **.db*, and
    **.myd*.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然Linux不像Windows那样普遍使用文件扩展名，但你仍然应该在Linux VHD上执行文件扩展名搜索，因为许多用户和应用程序会使用扩展名。扫描与证书相关的文件（**.pfx*、**.p12*、**.jks*），以及
    shell 脚本（**.sh*）和文本文件（**.txt*）。你可能还会在数据库文件中发现一些有趣的内容，如**.sql*、**.db*和**.myd*。
- en: '**Cracking Password Hashes**'
  id: totrans-94
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '**破解密码哈希**'
- en: Once you successfully obtain password hashes from either Linux or Windows VMs,
    you will need to recover their plaintext values in order to use them. Hashes are
    meant to be *one directional*, meaning that you should not be able to determine
    the actual plaintext password from only the hash. But as you’ll see in this section,
    there are a few possible ways to retrieve passwords from hashes, including dictionary
    attacks, brute-force attacks, hybrid attacks, and rainbow table attacks.
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦您成功地从 Linux 或 Windows 虚拟机中获取了密码哈希，您就需要恢复它们的明文值才能使用。哈希是*单向的*，这意味着您不应该仅凭哈希就能够确定实际的明文密码。但正如您在本节中将看到的那样，有几种可能的方式可以从哈希中恢复密码，包括字典攻击、暴力破解攻击、混合攻击和彩虹表攻击。
- en: '***Dictionary Attacks***'
  id: totrans-96
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: '***字典攻击***'
- en: In a dictionary attack, an attacker compiles a list of common words or phrases
    and then hashes each item in the list with the same hashing algorithm the target
    server’s password system uses. Then, the attacker compares the hash of each dictionary
    word to the password hash list and displays the matches.
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 在字典攻击中，攻击者编制一个常见单词或短语的列表，然后使用目标服务器密码系统所使用的相同哈希算法对列表中的每个项进行哈希处理。接着，攻击者将每个字典单词的哈希值与密码哈希列表进行比较，并显示匹配项。
- en: Dictionary attacks are great if you have a list of passwords that the target
    organization commonly uses, if you suspect users have simple one-word passwords
    that would appear in your compiled list of English words, or if you have a large
    password dictionary. You can usually find these large dictionaries online after
    criminals have compromised a popular website and released the stolen passwords.
    A good source is *[https://github.com/danielmiessler/SecLists/](https://github.com/danielmiessler/SecLists/)*.
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您拥有目标组织常用的密码列表，或者您怀疑用户使用的是简单的单词密码，这些密码会出现在您编制的英语单词列表中，或者您拥有一个庞大的密码字典，那么字典攻击非常有效。通常可以在线找到这些庞大的字典，尤其是在犯罪分子入侵了一个流行网站并泄露了被盗的密码后。一个好的来源是*[https://github.com/danielmiessler/SecLists/](https://github.com/danielmiessler/SecLists/)*。
- en: '**WARNING**'
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: '**警告**'
- en: '*Always check with the legal teams at your company and at your target company
    before using leaked password lists. Simply because they are publicly available
    does not mean that you are free to use them. Some organizations might consider
    these files stolen property and deem them off limits. If you intend to use these
    lists, consider mentioning that fact in your rules of engagement.*'
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: '*在使用泄露的密码列表之前，务必与您公司及目标公司中的法律团队进行核实。仅仅因为它们是公开可用的，并不意味着您可以自由使用它们。一些组织可能会认为这些文件是被盗的财产，并且视其为禁用文件。如果您打算使用这些列表，请考虑在您的规则中提到这一点。*'
- en: '***Brute-Force Attacks***'
  id: totrans-101
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: '***暴力破解攻击***'
- en: When brute-forcing passwords, you generate every possible password combination
    of letters, numbers, and special characters and then hash that until a match is
    found. This method is very time consuming and is generally not practical for passwords
    greater than about eight characters in length, but it may find a short password
    that an attacker wouldn’t find in a typical dictionary, such as *f8i!R+*.
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 在暴力破解密码时，您会生成所有可能的字母、数字和特殊字符的密码组合，然后对其进行哈希处理，直到找到匹配项为止。此方法非常耗时，通常不适用于长度超过八个字符的密码，但它可能会找到一个短密码，这个密码是攻击者在典型字典中找不到的，比如*f8i!R+*。
- en: '***Hybrid Attacks***'
  id: totrans-103
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: '***混合攻击***'
- en: Hybrid attacks combine dictionary and brute-force attacks to try to recover
    complex passwords quickly. In this method, an attacker combines a base dictionary
    word with a sequence of characters, tests the result against the hash, and then
    moves on to the next word. For example, a password like *hippopotamus200* would
    likely not show up in any dictionary word list, and brute-forcing a 15-character
    password would take an unreasonable amount of time. However, a hybrid attack that
    uses one English word followed by one to four numbers would likely find this password
    in a matter of hours or days. The biggest drawback to a hybrid attack is that
    you need some idea of what the password’s format looks like. For example, the
    “word plus one to four characters” paradigm would not successfully find *200hippopotamus*.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 混合攻击将字典攻击和暴力破解攻击结合起来，试图快速恢复复杂密码。在这种方法中，攻击者将一个基础字典单词与一系列字符组合，测试结果与哈希值对比，然后继续下一个单词。例如，像*hippopotamus200*这样的密码可能不会出现在任何字典单词列表中，而暴力破解一个
    15 个字符的密码则需要极其长的时间。然而，使用混合攻击的方法，先用一个英语单词，然后加上一个至四个数字，通常会在几小时或几天内找到这个密码。混合攻击的最大缺点是您需要对密码的格式有所了解。例如，“单词加上一到四个字符”的模式将无法成功找到*200hippopotamus*。
- en: '***Rainbow Table Attacks***'
  id: totrans-105
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: '***彩虹表攻击***'
- en: A rainbow table attack is a bit like a brute-force attack, where the attacker
    computes and stores all the hashes ahead of time to match against captured target
    hashes. However, truly storing every possible hash for a password of a given length
    would require a massive amount of space, making it impractical. To avoid this
    problem, the designers of rainbow tables perform a complex cryptographic operation
    (called a reduction function) that chains hashes together and only stores the
    beginning and end of each chain. (To learn how, see the original paper on the
    topic by Philippe Oechslin at *[https://lasec.epfl.ch/pub/lasec/doc/Oech03.pdf](https://lasec.epfl.ch/pub/lasec/doc/Oech03.pdf)*.)
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 彩虹表攻击有点像暴力破解攻击，攻击者提前计算并存储所有的哈希值，以便与捕获的目标哈希值进行匹配。然而，真正存储所有可能的哈希值对于给定长度的密码来说需要巨大的存储空间，因而不切实际。为了避免这个问题，彩虹表的设计者执行一个复杂的加密操作（称为还原函数），将哈希值串联在一起，并且只存储每个链的开始和结束部分。（要了解具体方法，请参见Philippe
    Oechslin在*[https://lasec.epfl.ch/pub/lasec/doc/Oech03.pdf](https://lasec.epfl.ch/pub/lasec/doc/Oech03.pdf)*上发布的原始论文。）
- en: In order for an attacker to use the rainbow table, a program takes in the target
    hash and begins computations against the precomputed table by passing the captured
    hash through the reduction function and seeing if the result matches the end of
    any chain. If so, it takes the value at the beginning of that chain and begins
    hashing and then reducing from the start of that chain until the value that created
    the original hash is found. If the reduced version of the captured hash doesn’t
    match the end of any chain, it is passed through the hash and reduction functions,
    and the cycle is performed again until the correct chain is identified.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 为了让攻击者使用彩虹表，一个程序接收目标哈希，并开始通过还原函数将捕获的哈希值传递到预计算的彩虹表中进行计算，查看结果是否与某个链的结尾匹配。如果匹配，它就取出该链的起始值并开始从链的起点进行哈希计算和还原，直到找到创建原始哈希的值。如果捕获哈希的还原版本与任何链的结尾不匹配，它会通过哈希和还原函数再次循环执行，直到正确的链被识别出来。
- en: 'Attackers optimize rainbow tables for either speed or size: a smaller rainbow
    table will take longer to return the password (though it will still be considerably
    faster than brute-forcing), whereas a larger table will return the result faster
    but consume more disk space.'
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 攻击者优化彩虹表以追求速度或大小：较小的彩虹表将花费更长时间来返回密码（尽管它仍然比暴力破解要快得多），而较大的表则可以更快地返回结果，但会消耗更多的磁盘空间。
- en: Although rainbow tables can be considerably faster than the other attacks discussed
    in this section, they have three major drawbacks. First, you must precompute them,
    so they require more planning and preparation than the other methods. Second,
    a rainbow table is only good for one hash format, such as MD5\. This means that
    you’ll need different rainbow tables for each type of hash you encounter. At a
    minimum, expect to find LM and NTLM hashes on Windows, and MD5 and SHA1 hashes
    on Linux. Third, they are ineffective against salted hash formats.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 尽管彩虹表比本节讨论的其他攻击方式快得多，但它们有三个主要缺点。首先，你必须预先计算它们，因此它们比其他方法需要更多的规划和准备。其次，彩虹表仅适用于一种哈希格式，例如MD5。这意味着你需要为遇到的每种哈希类型准备不同的彩虹表。至少，你可以在Windows上找到LM和NTLM哈希，而在Linux上则可能会遇到MD5和SHA1哈希。第三，它们对盐值哈希格式无效。
- en: '***Weaknesses in Windows Password Hashes***'
  id: totrans-110
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: '***Windows密码哈希的弱点***'
- en: 'For Azure-based Windows VMs, Azure mandates that the username not be *admin*
    or *administrator*, that the password be between 12 and 123 characters in length,
    and that the password include at least three of the four character types: lowercase
    letters, uppercase letters, numbers, and symbols. This would normally make brute-force
    attacks infeasible except that Windows stores passwords in both NTLM and LM hash
    formats for compatibility reasons. Early versions of Windows use the LM hash format
    whereas later ones use the more secure NTLM. LM has a number of weaknesses:'
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 对于基于Azure的Windows虚拟机，Azure要求用户名不能是*admin*或*administrator*，密码长度必须在12到123个字符之间，并且密码必须包含至少四种字符类型中的三种：小写字母、大写字母、数字和符号。这通常会使暴力破解攻击变得不可行，除非Windows为了兼容性原因在NTLM和LM哈希格式中都存储密码。早期版本的Windows使用LM哈希格式，而较新的版本使用更安全的NTLM格式。LM存在一些弱点：
- en: Passwords are padded with null characters as needed to get a total length of
    14 characters, which is then split into two equal parts. Both parts are hashed
    separately and then concatenated to form the final LM hash value, so an attacker
    only needs to attack the hashes for two 7-character strings, which can be done
    in parallel.
  id: totrans-112
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 密码会根据需要用空字符填充，直到总长度为14个字符，然后将其分成两部分。两部分分别进行哈希计算，然后连接起来形成最终的LM哈希值，因此攻击者只需攻击两个7字符字符串的哈希，这可以并行进行。
- en: Passwords are limited to 14 characters.
  id: totrans-113
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 密码限制为14个字符。
- en: Letters in passwords are converted to uppercase before hashing, making them
    case insensitive.
  id: totrans-114
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 密码中的字母在哈希之前会转换为大写字母，使得它们不区分大小写。
- en: If a user has a password that is fewer than 15 characters on Windows, it is
    likely stored in both NTLM and LM formats in the SAM. When a password is seven
    characters or fewer, LM sets the second half of the LM hash to AAD3B435B51404EE
    (the hashed value of 7 null bytes), so an attacker only has to crack the first
    half. For passwords over 14 characters, Windows doesn’t store an LM hash and instead
    stores a default value of AAD3B435B51404EEAAD3B435B51404EE. Windows uses this
    same hash value for accounts with no password at all, so if you come across it,
    try that account with a blank password and you might just get lucky!
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: 如果用户的密码在Windows中少于15个字符，它可能会以NTLM和LM格式同时存储在SAM中。当密码少于或等于七个字符时，LM会将LM哈希的第二部分设置为AAD3B435B51404EE（7个空字节的哈希值），因此攻击者只需破解第一部分。对于超过14个字符的密码，Windows不会存储LM哈希，而是存储默认值AAD3B435B51404EEAAD3B435B51404EE。Windows对于没有密码的账户使用相同的哈希值，因此如果你遇到这个值，尝试用空密码登录该账户，你可能会好运！
- en: Because any password stored with an LM hash is essentially just the hash of
    two seven-character passwords and because neither hash contains lowercase characters,
    the keyspace that must be attacked for an LM hash is rather small. Therefore,
    an attacker can very quickly recover any password stored in LM format. Once an
    attacker cracks an LM hash, the resulting password might not be the account’s
    actual password, due to the case insensitivity of LM. Thus, an attacker will need
    to perform a short brute-force test of each of that password’s case permutations
    against the NTLM hash to find the final correct password. For example, if the
    LM hash is the password *DOG*, the user’s actual password could be *dog*, *Dog*,
    *dOg*, *doG*, *DOg*, *DoG*, *dOG*, or *DOG*.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 因为任何存储为LM哈希的密码本质上只是两个七个字符密码的哈希，并且由于这些哈希不包含小写字符，所以需要攻击的LM哈希的密钥空间相对较小。因此，攻击者可以非常快速地恢复任何存储为LM格式的密码。一旦攻击者破解了LM哈希，得到的密码可能不是账户的实际密码，因为LM哈希是不区分大小写的。因此，攻击者需要对该密码的每种大小写组合执行短时间的暴力破解测试，以便与NTLM哈希进行匹配，从而找出最终正确的密码。例如，如果LM哈希是密码*DOG*，用户的实际密码可能是*dog*、*Dog*、*dOg*、*doG*、*DOg*、*DoG*、*dOG*或*DOG*。
- en: '**DEFENDER’S TIP**'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: '**DEFENDER’S TIP**'
- en: To make your passwords harder to attack, ensure they have at least 15 characters
    so that Windows doesn’t store LM hashes. Additionally, be sure that your passwords
    contain uppercase letters, lowercase letters, symbols, and numbers, and that they
    are not based on dictionary words. Such passwords can be hard to remember, so
    consider using a secure password manager with a very strong master password!
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 为了让你的密码更难被攻击，确保它们至少有15个字符，以便Windows不存储LM哈希。此外，确保你的密码包含大写字母、小写字母、符号和数字，并且不是基于词典中的单词。这类密码可能很难记住，因此可以考虑使用一个具有非常强大主密码的安全密码管理器！
- en: '**Password Hash Attack Tools**'
  id: totrans-119
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '**密码哈希攻击工具**'
- en: 'You will probably use one of two tools to perform password hash attacks: Cain
    & Abel or hashcat. Cain & Abel is a jack-of-all-trades security tool that has
    been an industry standard for years. In addition to having numerous features,
    it also has a GUI that makes it easy to learn. Hashcat is a newer addition to
    the penetration tester’s toolkit. It lacks a GUI and has only one feature: cracking
    hashes. However, what hashcat lacks in ease of use it makes up for in performance
    and support for a huge number of hash types. As a penetration tester, it is useful
    to know how to use each tool.'
  id: totrans-120
  prefs: []
  type: TYPE_NORMAL
  zh: 你可能会使用两个工具之一来进行密码哈希攻击：Cain & Abel或hashcat。Cain & Abel是一款多功能的安全工具，已成为业界标准多年。除了拥有众多功能外，它还具有易于学习的图形用户界面（GUI）。Hashcat是渗透测试人员工具包中的一个新成员。它没有图形用户界面，只有一个功能：破解哈希。然而，hashcat在易用性上有所欠缺，但在性能和对大量哈希类型的支持上弥补了这一点。作为渗透测试人员，了解如何使用这两款工具是很有用的。
- en: '***Attacking Hashes with Cain & Abel***'
  id: totrans-121
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: '***使用Cain & Abel攻击哈希***'
- en: 'Cain & Abel offers hash cracking in the Cracker tab (the same tab you used
    for decrypting a SAM file in “[Analyzing Windows VHDs](part0014.html#lev121)”
    on [page 98](part0014.html#page_98)). Once you load the hashes in the Cracker
    tab, highlight the hashes you want to crack and then right-click any of the selected
    hashes. A context menu should appear with three cracking options at the top: Dictionary
    Attack, Brute-Force Attack, and Cryptanalysis Attack, as shown in [Figure 5-6](part0014.html#ch05fig6).'
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: Cain & Abel 在“Cracker”标签页中提供哈希破解功能（与您在[《分析 Windows VHDs》](part0014.html#lev121)中第[98
    页](part0014.html#page_98)使用的相同标签）。加载哈希到 Cracker 标签页后，选择您要破解的哈希，然后右键点击所选哈希中的任意一个。上下文菜单应会显示三个破解选项：字典攻击、暴力破解攻击和密码分析攻击，如[图
    5-6](part0014.html#ch05fig6)所示。
- en: '![image](../images/00040.jpeg)'
  id: totrans-123
  prefs: []
  type: TYPE_IMG
  zh: '![image](../images/00040.jpeg)'
- en: '*Figure 5-6: The Cain & Abel hash context menu*'
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: '*图 5-6：Cain & Abel 哈希上下文菜单*'
- en: Selecting Dictionary Attack presents a screen where you can select dictionary
    wordlists and perform some limited modifications on dictionary terms, such as
    trying each word in all uppercase and all lowercase, as shown in [Figure 5-7](part0014.html#ch05fig7).
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 选择字典攻击后，将呈现一个屏幕，您可以在其中选择字典单词列表，并对字典词条进行一些有限的修改，例如尝试将每个单词转换为全大写或全小写，如[图 5-7](part0014.html#ch05fig7)所示。
- en: The Brute-Force Attack option opens a different window where you can enter the
    characters to include in the attack, as well as the length of passwords to attempt,
    as shown in [Figure 5-8](part0014.html#ch05fig8).
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 暴力破解攻击选项会打开一个不同的窗口，您可以在其中输入要包含在攻击中的字符，以及尝试的密码长度，如[图 5-8](part0014.html#ch05fig8)所示。
- en: '![image](../images/00041.jpeg)'
  id: totrans-127
  prefs: []
  type: TYPE_IMG
  zh: '![image](../images/00041.jpeg)'
- en: '*Figure 5-7: The Cain & Abel Dictionary Attack window*'
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: '*图 5-7：Cain & Abel 字典攻击窗口*'
- en: '![image](../images/00042.jpeg)'
  id: totrans-129
  prefs: []
  type: TYPE_IMG
  zh: '![image](../images/00042.jpeg)'
- en: '*Figure 5-8: The Cain & Abel Brute-Force Attack window*'
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: '*图 5-8：Cain & Abel 暴力破解攻击窗口*'
- en: Cain & Abel includes logic that automatically adjusts the brute-force options,
    depending on the hash type. When you’re targeting LM hashes, the default keyspace
    doesn’t include lowercase characters and is preset to try passwords between one
    and seven characters in length, because these are known limitations of LM hashes.
    Once the attack is started, Cain & Abel shows test progress, including the rate
    of passwords tried per second and the total time remaining.
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: Cain & Abel 包含自动调整暴力破解选项的逻辑，具体取决于哈希类型。当您攻击 LM 哈希时，默认的密码空间不包括小写字符，并且预设密码长度为 1
    到 7 个字符，这是 LM 哈希的已知限制。一旦攻击开始，Cain & Abel 会显示测试进度，包括每秒尝试的密码数和剩余总时间。
- en: Finally, the Cryptanalysis Attack option will perform a rainbow table attack
    against the hashes. The option screen for this attack is very simple, providing
    only an option to specify paths to the rainbow tables. As with a brute-force attack,
    it also displays the attack’s progress.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，密码分析攻击选项将对哈希进行彩虹表攻击。该攻击的选项窗口非常简单，只提供一个选择路径的选项，用于指定彩虹表的路径。与暴力破解攻击一样，它还会显示攻击的进度。
- en: '***Testing Hashes with hashcat***'
  id: totrans-133
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: '***使用 hashcat 测试哈希***'
- en: Hashcat is a free, open source, cross-platform password hash cracking tool,
    optimized to make full use of the processing power of the GPUs in modern graphics
    cards as well as the CPU. You can download hashcat from *[https://hashcat.net/hashcat/](https://hashcat.net/hashcat/)*.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: Hashcat 是一个免费的开源跨平台密码哈希破解工具，经过优化，能够充分利用现代显卡的 GPU 处理能力以及 CPU 的处理能力。您可以从 *[https://hashcat.net/hashcat/](https://hashcat.net/hashcat/)*
    下载 hashcat。
- en: Much like Cain & Abel, hashcat offers both dictionary and brute-force options,
    but it really shines in hybrid mode. By leveraging the power of the GPU, hashcat
    can test a huge number of password permutations each second—on the order of millions,
    billions, or even trillions, depending on the graphics card and the hash type.
    Hashcat also supports the use of complex rules to control its password generation,
    which can prove very useful if you can determine a target company’s password policy.
    For example, if you know that all passwords must be at least eight characters
    and contain a number and a symbol, you can start your testing by eliminating all
    passwords that do not meet that criteria.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 与 Cain & Abel 类似，hashcat 提供字典攻击和暴力破解选项，但它在混合模式下表现尤为出色。通过利用 GPU 的强大性能，hashcat
    可以每秒测试大量密码组合——可以达到数百万、数十亿甚至数万亿次，具体取决于显卡和哈希类型。hashcat 还支持使用复杂的规则来控制密码生成，这在您能够确定目标公司的密码策略时非常有用。例如，如果您知道所有密码必须至少包含八个字符，并且必须包含数字和符号，您可以通过排除所有不符合这些条件的密码来开始测试。
- en: Hashcat offers extensive support for various hash formats. Whereas Cain & Abel
    supports only about 30 hash formats, hashcat supports over 200\. This extensive
    support will come in really handy should you encounter a VM running some operating
    system or software that keeps its own password list (like PeopleSoft, Lotus Notes,
    or Joomla).
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: Hashcat支持多种哈希格式。与Cain & Abel只支持约30种哈希格式不同，hashcat支持超过200种格式。如果你遇到一个运行某种操作系统或软件的虚拟机，这些系统或软件保存了自己的密码列表（例如PeopleSoft、Lotus
    Notes或Joomla），那么这种广泛的支持将非常有用。
- en: To learn how to use hashcat, I suggest reading the wiki at *[https://hashcat.net/wiki/](https://hashcat.net/wiki/)*.
    Note that a misconfigured hashcat job could take orders of magnitude longer than
    one that is properly configured with a good dictionary and proper rules. Worse,
    a hastily created job might inadvertently exclude legitimate passwords for a target
    system. Few things are more painful during a penetration test than realizing that
    you need to restart a cracking job that has been running for several days because
    of a command line error!
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 要了解如何使用hashcat，我建议阅读wiki，链接为*[https://hashcat.net/wiki/](https://hashcat.net/wiki/)*。请注意，配置错误的hashcat任务可能比正确配置的任务花费更长时间，尤其是当字典不合适或规则不正确时。更糟糕的是，匆忙创建的任务可能会无意中排除目标系统的合法密码。在渗透测试过程中，没有什么比因为命令行错误而意识到需要重新启动已经运行了几天的破解任务更令人痛苦的了！
- en: '**NOTE**'
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: '**注意**'
- en: '*If the GPU in your computer isn’t very powerful, you might want to consider
    running hashcat on specialty Azure VMs that include NVIDIA-based GPUs, which are
    designed for computationally intensive tasks. Unfortunately, the cost of running
    these VMs for an extended period is usually costlier than building and operating
    your own PC with a few high-end video cards. You might prefer using the Azure
    GPUs under two circumstances, though. The first is if you need to crack a very
    important password very quickly. Using Azure, you could create dozens of these
    special VMs and assign each a different subset of the keyspace to test. The other
    is if you find password cracking to be a very rarely used technique in your engagements.
    In this case, it may make more sense to use Azure rather than make the initial
    capital investment in GPU hardware.*'
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: '*如果你电脑中的GPU性能不强，你可能需要考虑在包含NVIDIA GPU的专用Azure虚拟机上运行hashcat，这些虚拟机是为计算密集型任务设计的。不幸的是，长时间运行这些虚拟机的成本通常比构建和运行一台配备几块高端显卡的个人电脑要高。不过，在两种情况下，你可能会更倾向于使用Azure
    GPU。第一种情况是你需要非常迅速地破解一个非常重要的密码。使用Azure，你可以创建数十个这样的专用虚拟机，并为每个虚拟机分配不同的密钥空间子集进行测试。另一种情况是，如果你发现密码破解在你的渗透测试中是一个很少使用的技术。在这种情况下，使用Azure可能比在GPU硬件上进行初始资本投资更有意义。*'
- en: '**Using a VHD’s Secrets Against a VM**'
  id: totrans-140
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '**利用VHD的秘密对付虚拟机**'
- en: Once you’ve recovered a username and password from a VHD, you can begin to assess
    the running VM in Azure—but first you’ll need to know how to connect to the VM.
    To do this, you’ll need its hostname or IP address and you’ll need to know which
    remote administration service is running on the VM and its port. Azure VMs running
    Windows will usually have Remote Desktop Protocol (RDP) available, whereas Linux
    VMs will typically have Secure Shell (SSH) open. Less frequently, Virtual Network
    Computing (VNC) protocol or telnet will be exposed, but these protocols aren’t
    encrypted by default and shouldn’t be used, especially over the internet.
  id: totrans-141
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦你从VHD中恢复了用户名和密码，就可以开始评估Azure中运行的虚拟机了——但首先，你需要知道如何连接到虚拟机。为此，你需要知道虚拟机的主机名或IP地址，并且需要知道虚拟机上运行的远程管理服务及其端口。运行Windows的Azure虚拟机通常会提供远程桌面协议（RDP），而Linux虚拟机通常会开放安全外壳（SSH）。较少情况下，虚拟网络计算（VNC）协议或telnet协议会被暴露，但这些协议默认不加密，尤其是在互联网环境下不应使用。
- en: '***Determining the Hostname***'
  id: totrans-142
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: '***确定主机名***'
- en: Given the choice of hostname or IP, I prefer to use the hostname because IPs
    may be dynamically assigned. By default, Azure names its VHDs after the hostname
    of their associated VM. For example, if a VHD filename is *myazurevm20151231220005.vhd*,
    its hostname would usually be *myazurevm.cloudapp.net*.
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 在主机名和IP地址之间选择时，我更倾向于使用主机名，因为IP地址可能会动态分配。默认情况下，Azure会根据虚拟机的主机名命名其VHD。例如，如果一个VHD文件名是*myazurevm20151231220005.vhd*，其主机名通常是*myazurevm.cloudapp.net*。
- en: Of course, VHDs can be renamed, or their VM could be assigned a different hostname.
    If you find that to be the case, you can try to retrieve the hostname information
    from Azure or from within the VHD. The easiest way to do so is to use Azure PowerShell
    and the `Get-AzureVM` cmdlet to return the hostnames of every VM in the subscription,
    but that assumes you have an account with proper access.
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，VHD 可以被重命名，或者虚拟机（VM）可以被分配一个不同的主机名。如果你发现是这种情况，你可以尝试从 Azure 或 VHD 内部获取主机名信息。最简单的方法是使用
    Azure PowerShell 和 `Get-AzureVM` cmdlet 来返回订阅中每个虚拟机的主机名，但这需要你拥有适当权限的账户。
- en: Alternatively, you can turn to the VHD itself. Windows stores the hostname in
    the SYSTEM registry hive, which we exported earlier in “[Analyzing Windows VHDs](part0014.html#lev121)”
    on [page 98](part0014.html#page_98). To see this value, you’ll need to load this
    file into a registry viewer.
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 或者，你可以直接查看 VHD 本身。Windows 将主机名存储在 SYSTEM 注册表区，我们在 “[分析 Windows VHDs](part0014.html#lev121)”
    的 [第 98 页](part0014.html#page_98) 中已经导出过此信息。要查看此值，你需要将该文件加载到注册表查看器中。
- en: '**Recovering the Hostname from the VHD on Windows**'
  id: totrans-146
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: '**在 Windows 上恢复 VHD 中的主机名**'
- en: Be very careful when using the Windows built-in `regedit` tool to recover the
    hostname from the VHD; it’s just too easy to accidentally overwrite your own PC’s
    registry with values from the VM. A better choice is to use MiTeC’s Windows Registry
    Recovery (*[http://www.mitec.cz/wrr.html](http://www.mitec.cz/wrr.html)*), as
    follows.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 Windows 内置的 `regedit` 工具从 VHD 恢复主机名时需要非常小心；因为很容易不小心将虚拟机的注册表值覆盖到你自己电脑的注册表中。一个更好的选择是使用
    MiTeC 的 Windows 注册表恢复工具 (*[http://www.mitec.cz/wrr.html](http://www.mitec.cz/wrr.html)*)，操作如下。
- en: Install Windows Registry Recovery and then click **File**▸**Open**.
  id: totrans-148
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 安装 Windows 注册表恢复工具后，点击 **文件**▸**打开**。
- en: Select the *SYSTEM* file exported from the VHD and click **OK**.
  id: totrans-149
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 选择从 VHD 导出的 *SYSTEM* 文件并点击 **确定**。
- en: Click the **Raw Data** option in the menu on the left (see [Figure 5-9](part0014.html#ch05fig9)).
  id: totrans-150
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 点击左侧菜单中的 **原始数据** 选项（参见 [图 5-9](part0014.html#ch05fig9)）。
- en: In the middle pane, navigate to *ROOT\ControlSet001\Control\ComputerName\ComputerName*.
  id: totrans-151
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在中间窗格中，导航到 *ROOT\ControlSet001\Control\ComputerName\ComputerName*。
- en: The hostname should be in the ComputerName string in the pane on the right,
    as shown in [Figure 5-9](part0014.html#ch05fig9).
  id: totrans-152
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在右侧窗格中的 ComputerName 字符串应包含主机名，如 [图 5-9](part0014.html#ch05fig9) 所示。
- en: If you see directories named *ControlSet002* or *ControlSet003* under *ROOT*,
    be sure to check those as well because the hostname may have changed.
  id: totrans-153
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果你看到名为 *ControlSet002* 或 *ControlSet003* 的目录位于 *ROOT* 下，一定要检查它们，因为主机名可能已更改。
- en: '![image](../images/00043.jpeg)'
  id: totrans-154
  prefs: []
  type: TYPE_IMG
  zh: '![image](../images/00043.jpeg)'
- en: '*Figure 5-9: Viewing the hostname from the SYSTEM registry hive*'
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: '*图 5-9：从 SYSTEM 注册表区查看主机名*'
- en: There are other files in a Windows VM’s VHD that may contain the hostname, but
    the SYSTEM hive is the most reliable way to obtain it.
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: Windows 虚拟机的 VHD 中还有其他可能包含主机名的文件，但 SYSTEM 注册表区是获取主机名的最可靠方法。
- en: '**Recovering the Hostname from the VHD on Linux**'
  id: totrans-157
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: '**在 Linux 上恢复 VHD 中的主机名**'
- en: It’s quite simple to recover the hostname from the VHD on Linux. To do so, simply
    locate the */etc/hostname* file and display it. It should contain the VM’s hostname.
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Linux 上恢复 VHD 中的主机名非常简单。只需定位到 */etc/hostname* 文件并显示它。文件中应包含虚拟机的主机名。
- en: '***Finding a Remote Administration Service***'
  id: totrans-159
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: '***查找远程管理服务***'
- en: Once you know the hostname, you should determine if the VM has an accessible
    remote administration tool. Although the RDP, SSH, VNC, and telnet services have
    default ports, the target VM may not use those ports, so you’ll need to determine
    which one the remote service is using. This can be done by using information from
    the subscription, checking known ports, or performing a full port scan.
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦你知道了主机名，就应该确定虚拟机是否有可访问的远程管理工具。虽然 RDP、SSH、VNC 和 Telnet 服务有默认端口，但目标虚拟机可能不会使用这些端口，因此你需要确定远程服务使用的是哪个端口。这可以通过使用订阅中的信息、检查已知端口或执行完整端口扫描来完成。
- en: '**Using PowerShell**'
  id: totrans-161
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: '**使用 PowerShell**'
- en: The best way to find any accessible remote ports in a VM, provided you have
    proper credentials, is to use the PowerShell reconnaissance you learned in “[Gathering
    Information on Networking](part0012.html#lev76)” on [page 56](part0012.html#page_56).
    This data will contain the open ports allowed through the firewall for each VM
    from the output of the `Get-AzureEndpoint` and `Get-AzureRmNetworkSecurityGroup`
    cmdlets. Review this output and compare any listed open ports with well-known
    administration ports, as listed in [Table 5-1](part0014.html#ch05tab1).
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 查找虚拟机中任何可访问的远程端口的最佳方法是使用你在“[网络信息收集](part0012.html#lev76)”一节中学习到的PowerShell侦察技术，前提是你拥有适当的凭据。此数据将包含从`Get-AzureEndpoint`和`Get-AzureRmNetworkSecurityGroup`
    cmdlet的输出中获取的允许通过防火墙的每个虚拟机的开放端口。查看此输出并将任何列出的开放端口与[表5-1](part0014.html#ch05tab1)中列出的常见管理端口进行比较。
- en: '**Table 5-1:** Common Administration Ports'
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: '**表 5-1:** 常见管理端口'
- en: '| **Service** | **TCP port(s)** |'
  id: totrans-164
  prefs: []
  type: TYPE_TB
  zh: '| **服务** | **TCP端口** |'
- en: '| --- | --- |'
  id: totrans-165
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- |'
- en: '| RDP | 3389 |'
  id: totrans-166
  prefs: []
  type: TYPE_TB
  zh: '| RDP | 3389 |'
- en: '| SSH | 22 |'
  id: totrans-167
  prefs: []
  type: TYPE_TB
  zh: '| SSH | 22 |'
- en: '| VNC | 5900 |'
  id: totrans-168
  prefs: []
  type: TYPE_TB
  zh: '| VNC | 5900 |'
- en: '| telnet | 21 |'
  id: totrans-169
  prefs: []
  type: TYPE_TB
  zh: '| telnet | 21 |'
- en: '| Windows Remote Management (PowerShell remoting) | 5985, 5986 |'
  id: totrans-170
  prefs: []
  type: TYPE_TB
  zh: '| Windows远程管理（PowerShell远程） | 5985, 5986 |'
- en: If you find any matches, try to connect to the VM using a client for that protocol.
    For example, in Windows, you could use the built-in *mstsc.exe* application to
    connect to RDP endpoints, PuTTY (*[https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html](https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html)*)
    for SSH and telnet, or TightVNC (*[http://tightvnc.net/](http://tightvnc.net/))*
    for VNC servers. If you are running Linux, clients for SSH, VNC, and telnet are
    usually built in. For RDP, freeRDP (*[http://www.freerdp.com/](http://www.freerdp.com/)*)
    is a popular choice.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你发现任何匹配项，尝试使用该协议的客户端连接到虚拟机（VM）。例如，在Windows中，你可以使用内置的*mstsc.exe*应用程序连接到RDP端点，使用PuTTY
    (*[https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html](https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html)*)连接SSH和telnet，或使用TightVNC
    (*[http://tightvnc.net/](http://tightvnc.net/))*连接VNC服务器。如果你在运行Linux，通常内置有SSH、VNC和telnet的客户端。对于RDP，freeRDP
    (*[http://www.freerdp.com/](http://www.freerdp.com/)*) 是一个流行的选择。
- en: 'If Windows Remote Management is available, you can connect using PowerShell.
    To do so, run the following:'
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 如果Windows远程管理可用，你可以通过PowerShell进行连接。为此，运行以下命令：
- en: '[PRE1]'
  id: totrans-173
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: This will instruct PowerShell to bypass SSL certificate validation ➊ (since
    your client doesn’t trust this host), prompt you for credentials for the target
    machine ➋, and then connect ➌. If the connection succeeds, the command prompt
    will change to show that you are connected to the remote host and can now run
    commands on that machine ➍.
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 这将指示PowerShell跳过SSL证书验证➊（因为你的客户端不信任此主机），提示你输入目标机器的凭据➋，然后进行连接➌。如果连接成功，命令提示符将更改为显示你已连接到远程主机，并且现在可以在该机器上运行命令➍。
- en: '**Testing Default Ports**'
  id: totrans-175
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: '**测试默认端口**'
- en: 'If PowerShell access to the subscription isn’t an option, try testing the common
    default ports for each service in [Table 5-1](part0014.html#ch05tab1). This can
    be performed quickly on Windows using the built-in `Test-NetConnection` PowerShell
    cmdlet, with no subscription access needed. Simply run the command for each port
    you need to test:'
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 如果无法访问订阅的PowerShell，可以尝试测试[表5-1](part0014.html#ch05tab1)中列出的每个服务的常见默认端口。这可以在Windows上使用内置的`Test-NetConnection`
    PowerShell cmdlet快速执行，无需订阅访问权限。只需对每个需要测试的端口运行该命令：
- en: '[PRE2]'
  id: totrans-177
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: In this example, a test connection to port 3389 was attempted ➊ and succeeded
    ➋, whereas the connection to port 21 ➌ failed ➍. Because 3389 is the port for
    RDP, I would then attempt to connect to this VM using *mstsc.exe*.
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 在此示例中，尝试连接到端口3389➊并成功连接➋，而连接端口21➌失败➍。因为3389是RDP的端口，我接下来会尝试使用*mstsc.exe*连接到此虚拟机。
- en: '**Port Scanning**'
  id: totrans-179
  prefs:
  - PREF_H5
  type: TYPE_NORMAL
  zh: '**端口扫描**'
- en: If your test of default ports fails and you don’t have proper PowerShell access,
    move on to a full TCP port scan of the VM. This will take several minutes, depending
    on the speed of your internet connection and the VM’s current load, but it will
    reliably determine every available port that is both open on the VM and accessible
    from your PC.
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 如果测试默认端口失败且你没有适当的PowerShell访问权限，则继续进行虚拟机的完整TCP端口扫描。这可能需要几分钟，具体取决于你的网络连接速度和虚拟机的当前负载，但它将可靠地确定每个可用的端口，这些端口既在虚拟机上开放，又能从你的PC访问。
- en: 'The best port-scanning tool for this task is Nmap (*[https://nmap.org/](https://nmap.org/)*).
    It can be installed on Windows or Linux, though I recommend using it on Linux,
    if possible, because it runs faster there. After installing Nmap, open a command
    prompt and run the following:'
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 最适合此任务的端口扫描工具是Nmap（*[https://nmap.org/](https://nmap.org/)*）。它可以安装在Windows或Linux上，但我推荐尽可能在Linux上使用，因为它在Linux上运行更快。安装Nmap后，打开命令提示符并运行以下命令：
- en: '[PRE3]'
  id: totrans-182
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: The `-Pn` switch tells Nmap to continue even if the host doesn’t respond to
    a ping request. The `-p` switch tells Nmap which ports to scan (in this case,
    all possible TCP ports). Finally, `-sV` instructs Nmap to try to determine which
    service is running on any open ports it finds. Based on these results, you should
    learn which remote administration services are available in your target VM and
    on which ports they run.
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: '`-Pn`选项告诉Nmap即使主机没有响应ping请求，也要继续扫描。`-p`选项告诉Nmap要扫描哪些端口（在这种情况下，是所有可能的TCP端口）。最后，`-sV`指示Nmap尝试确定它找到的任何开放端口上运行的服务。根据这些结果，你应该能够了解目标虚拟机上哪些远程管理服务可用以及它们运行的端口。'
- en: 'These techniques can fail for three possible reasons: either the VM is currently
    shut down, all administration services have been disabled (or their ports have
    been restricted by a firewall), or the hostname or IP address isn’t correct. The
    only options in this case are to try again later or to give up and move on to
    other parts of the penetration test.'
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: 这些技术可能会失败，原因有三种可能：虚拟机当前已关闭，所有管理服务已被禁用（或其端口已被防火墙限制），或者主机名或IP地址不正确。在这种情况下，唯一的选择是稍后再试，或者放弃并转向渗透测试的其他部分。
- en: '**Resetting a Virtual Machine’s Credentials**'
  id: totrans-185
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '**重置虚拟机凭据**'
- en: 'Combining VHD forensics with password cracking, as discussed previously, is
    a powerful way to obtain credentials from a VM, but it’s limited to cases where
    Azure Disk Encryption isn’t enabled and when the attacker has time to crack the
    administrator password. If you manage to gain administrative rights to a subscription,
    you can use another, much faster method that doesn’t rely on obtaining information
    from disks: you can reset a VM’s administrator password. Although this method
    is fast and reliable, it also has a high likelihood of being detected, so I save
    it as a last resort.'
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 如前所述，将VHD取证与密码破解相结合，是从虚拟机获取凭据的强大方式，但仅限于在未启用Azure磁盘加密的情况下，并且攻击者有足够时间破解管理员密码。如果你设法获得了订阅的管理员权限，你可以使用另一种更快速的方法，这种方法不依赖于从磁盘中获取信息：你可以重置虚拟机的管理员密码。虽然这种方法既快速又可靠，但它也有较高的被检测到的可能性，因此我将其作为最后的手段。
- en: '***How to Reset a VM’s Credentials***'
  id: totrans-187
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: '***如何重置虚拟机凭据***'
- en: To avoid permanently locking users out of VMs when they’ve forgotten their password,
    the Azure portal offers a reset option for VM passwords, as shown in [Figure 5-10](part0014.html#ch05fig10).
    To access it for your target VM, sign in to the portal, click the **Virtual Machines**
    section, click your target VM, and then select **Reset password**.
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 为了避免当用户忘记密码时永久锁定虚拟机，Azure门户提供了虚拟机密码重置选项，如[图5-10](part0014.html#ch05fig10)所示。要访问目标虚拟机的密码重置选项，请登录到门户，点击**虚拟机**部分，选择目标虚拟机，然后点击**重置密码**。
- en: This form has a few nice features. For one, it shows the VM’s built-in administrator
    or root account name (*azureadmin* in this case), even if it has been changed.
    This can be very helpful even if you aren’t planning to perform a password reset,
    because it allows you to determine a valid account name that can be used for things
    like dictionary attacks. Second, when a password is too weak, a red exclamation
    point appears at the right end of the password box. If you hover over the exclamation
    point, you’ll be able to read a tool tip about password complexity requirements.
    This would be perfect information to use to configure hashcat’s rules.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 这个表单有一些不错的功能。首先，它显示了虚拟机的内置管理员或根账户名（此例中为*azureadmin*），即使它已被更改。即使你不打算执行密码重置，这也非常有用，因为它可以帮助你确定一个有效的账户名，用于字典攻击等操作。其次，当密码过于简单时，密码框右侧会出现一个红色的感叹号。如果你将鼠标悬停在感叹号上，你将能够看到有关密码复杂度要求的提示信息。这将是用来配置hashcat规则的完美信息。
- en: '![image](../images/00044.jpeg)'
  id: totrans-190
  prefs: []
  type: TYPE_IMG
  zh: '![image](../images/00044.jpeg)'
- en: '*Figure 5-10: Reset password screen for an Azure VM*'
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: '*图5-10：Azure虚拟机的重置密码界面*'
- en: To actually complete the password reset and change the administrator password,
    simply enter your desired password in the Password field and click **Update**.
    If you modify the User Name field, the administrator account should also be renamed.
    Additionally, if the built-in administrator account is disabled, the password
    reset option should re-enable it.
  id: totrans-192
  prefs: []
  type: TYPE_NORMAL
  zh: 要实际完成密码重置并更改管理员密码，只需在“密码”字段中输入所需的密码并点击**更新**。如果修改了“用户名”字段，管理员账户的名称也应该被更改。此外，如果内置管理员账户被禁用，密码重置选项应该会重新启用它。
- en: This form also contains an option in the Mode drop-down menu to reset the remote
    access configuration. This option will leave the original password intact but
    will enable RDP (Windows) or SSH (Linux) on the VM to restore the ability to connect
    remotely. This feature is intended to restore an administrator’s ability to connect
    to a VM after a misconfiguration, but for a penetration tester, it can re-open
    a remote access service on a VM that has been hardened.
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 此表单还包含一个在“模式”下拉菜单中的选项，用于重置远程访问配置。该选项将保留原始密码不变，但会启用虚拟机上的 RDP（Windows）或 SSH（Linux），以恢复远程连接能力。此功能旨在恢复管理员在配置错误后重新连接虚拟机的能力，但对于渗透测试人员而言，它可以重新开启在已加固的虚拟机上的远程访问服务。
- en: '***Downsides to Password Resets***'
  id: totrans-194
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: '***密码重置的缺点***'
- en: Even though a password reset is a fairly reliable way to gain access to a VM,
    it has some downsides. Most importantly, when the password is successfully changed
    via the portal, you’ll have no way to determine what the previous password was.
    That means that the password can’t be set back to its original value, and you
    are now the only one with the credentials. Of course, this also means that as
    soon as a legitimate user of the VM’s administrator account tries to connect to
    the VM, they will realize something is wrong. They won’t necessarily be blocked
    from accessing the VM because they can just perform a password reset themselves
    (assuming they have Azure portal access), but even inexperienced users will likely
    realize that a security incident may have occurred and will begin investigating
    or report it to their security monitoring team.
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 即使密码重置是一种相对可靠的方式来访问虚拟机，它也有一些缺点。最重要的是，当通过门户成功更改密码时，你将无法确定之前的密码是什么。这意味着密码不能恢复到原来的值，而你现在是唯一拥有凭据的人。当然，这也意味着，一旦虚拟机管理员账户的合法用户尝试连接虚拟机，他们会意识到出了问题。他们不一定会被阻止访问虚拟机，因为他们可以自己执行密码重置（假设他们有Azure门户访问权限），但即使是没有经验的用户，也很可能会意识到发生了安全事件，并开始进行调查或向安全监控团队报告。
- en: Second, even though you will have the credentials, you will likely have little
    to no idea how the target VM is configured. If the software running in the VM
    is actively using the account you reset, resetting the password may cause unforeseen
    outages in other services, which expect a different password.
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: 其次，尽管你将拥有凭据，但你可能对目标虚拟机的配置了解甚少。如果虚拟机中运行的软件正在使用你重置的账户，重置密码可能会导致其他服务出现意外中断，这些服务可能需要不同的密码。
- en: Finally, this method has some technical limitations. The VM must be in a running
    state for the password reset option to be available. Additionally, the Azure VM
    agent software must be installed on the VM. The default OS images in Azure typically
    have this agent already installed, but some VMs may have had the agent removed
    by an administrator, may be running a less popular or older operating system with
    no agent available, or may have been built from nonstandard images.
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，这种方法有一些技术限制。虚拟机（VM）必须处于运行状态，才能启用密码重置选项。此外，Azure VM 代理软件必须已安装在虚拟机上。Azure中的默认操作系统镜像通常已经安装了该代理，但某些虚拟机可能被管理员移除了该代理，可能正在运行不太常见的旧版操作系统，且没有代理可用，或者可能是从非标准镜像构建的。
- en: '**Summary**'
  id: totrans-198
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '**总结**'
- en: In this chapter, we discussed how an attacker can create and download a snapshot
    for a virtual machine’s disk image from Azure Storage and then recover password
    hashes and other sensitive data from it with forensic recovery tools like Autopsy.
    We then examined how to crack these hashes in either Cain & Abel or hashcat to
    determine the original plaintext passwords. From there, we determined what management
    services were accessible on the VM using PowerShell or port scanning. Then, we
    used the cracked passwords to connect back to the VMs.
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们讨论了攻击者如何从 Azure 存储中创建并下载虚拟机磁盘镜像的快照，然后使用法医恢复工具（如 Autopsy）从中恢复密码哈希和其他敏感数据。接着，我们检查了如何在
    Cain & Abel 或 hashcat 中破解这些哈希，以确定原始的明文密码。之后，我们使用 PowerShell 或端口扫描确定虚拟机上可访问的管理服务。最后，我们利用破解的密码连接回虚拟机。
- en: After that, we looked at Azure’s VM password reset option. You can use this
    option to gain administrator level access to any VM that you can access in the
    portal, with no additional knowledge about the VM’s configuration. Finally, we
    considered some possible limitations to this attack.
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: 在那之后，我们查看了 Azure 的虚拟机密码重置选项。你可以使用此选项在门户中访问的任何虚拟机上获得管理员级别的访问权限，而无需了解虚拟机的配置。最后，我们考虑了此攻击可能存在的一些限制。
- en: In the next chapter, we’ll look at Azure networking to examine how to target
    internet-facing VMs, as well as how systems within a corporate network can interact
    with Azure services.
  id: totrans-201
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，我们将探讨 Azure 网络，以检查如何定位面向互联网的虚拟机，以及企业网络中的系统如何与 Azure 服务进行交互。
