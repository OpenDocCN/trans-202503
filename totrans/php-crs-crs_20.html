<html><head></head><body>
<div id="sbo-rt-content"><section aria-labelledby="ch16" epub:type="chapter" role="doc-chapter">
<span aria-label="301" epub:type="pagebreak" id="pg_301" role="doc-pagebreak"/>
<hgroup>
<h2 class="CHAPTER" id="ch16">
<span class="CN"><span class="SANS_Futura_Std_Bold_Condensed_B_11">16</span></span>
<span class="CT"><span class="SANS_Dogma_OT_Bold_B_11">AUTHENTICATION AND AUTHORIZATION</span></span>
</h2>
</hgroup>
<figure class="opener"><img alt="" class="opener" height="380" src="../images/opener.jpg" width="380"/>
</figure>
<p class="INTRO">Many websites implement security measures to safeguard private content or sensitive data. In this chapter, we’ll use PHP sessions to develop an application with one such measure, a login form. In the process, you’ll learn how to implement two related security concepts: authentication and authorization.</p>
<p class="TX"><i>Authentication</i> determines the identity of the person using the computer system—that is, <i>who</i> is the user? Our application will harness the username- and-password login method of authentication to identify the user. Meanwhile, <i>authorization</i> determines whether the user is permitted to access a particular part of the computer system (<i>what</i> is the user permitted to do?). Our application will use data stored in a PHP session, combined with access control logic, to authorize certain aspects of the web application that a user can access.</p>
<section aria-labelledby="sec1" epub:type="division">
<span aria-label="302" epub:type="pagebreak" id="pg_302" role="doc-pagebreak"/>
<h3 class="H1"><span id="sec1"/><span id="toc-link_221"/><span class="SANS_Futura_Std_Bold_B_11">A Simple Login Form</span></h3>
<p class="TNI1">At its heart, a login page is an HTML form usually consisting of a text field for the unique user identifier (such as a username or email address), a password text field, and a Submit button. That’s it! The difference between a regular text field and a password text field is that for the latter, the browser displays a placeholder symbol like an asterisk (<span class="SANS_TheSansMonoCd_W5Regular_11">*</span>) for each character typed so that the actual password isn’t displayed onscreen for a snooper to read. <a href="#fig16-1">Figure 16-1</a> shows a bare-bones login form.</p>
<figure class="IMG"><a id="fig16-1"/><img alt="" class="img100" height="288" src="../images/figure16-1.jpg" width="1389"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 16-1: A simple login form</span></p></figcaption>
</figure>
<p class="TX">The form has the three elements we’ve described: a Username field, a Password field, and a Submit button. <a href="#lis16-1">Listing 16-1</a> shows the HTML code needed to display this login form.</p>
<span id="lis16-1"/>
<pre><code>&lt;!doctype html&gt;&#13;
&lt;html&gt;&#13;
&lt;head&gt;&#13;
&lt;title&gt;login form&lt;/title&gt;&#13;
&lt;/head&gt;&#13;
&lt;body&gt;&#13;
&#13;
    &lt;form action="/?action=login" <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> method="post"&gt;&#13;
        &lt;label&gt;Username:&lt;input name="username"&gt;&lt;/label&gt;&#13;
        &lt;label&gt;Password:&lt;input name="password" <span aria-label="annotation2" class="Code_CodeAnnotation">❷</span> type="password"&gt;&lt;label&gt;&#13;
        &lt;input type="submit"&gt;&#13;
    &lt;/form&gt;&#13;
&#13;
&lt;/body&gt;&#13;
&lt;/html&gt;</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-1: The code for a basic login form</span></p>
<p class="TX">This code creates our labeled input boxes for a username and password, along with a <span class="SANS_TheSansMonoCd_W5Regular_11">submit</span> input button. We specify <span class="SANS_TheSansMonoCd_W5Regular_11">type="password"</span> for the Password field so that the input will display as placeholder characters <span aria-label="annotation2" class="CodeAnnotation">❷</span>. The login form submits via the <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> HTTP method <span aria-label="annotation1" class="CodeAnnotation">❶</span>. Almost all login forms use the <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> method so that the user’s password won’t be displayed as a query-string variable in the browser address bar, as would happen with the <span class="SANS_TheSansMonoCd_W5Regular_11">GET</span> method. A second reason to use <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> is that we don’t want the login data to be cached. Instead, we want the server to process each username and password at the time the login form is submitted.</p>
<p class="TX"><span aria-label="303" epub:type="pagebreak" id="pg_303" role="doc-pagebreak"/><i>Caching</i> occurs when a computer system or application, such as a web browser, stores copies of files locally (on the desktop, laptop, or phone) in order to retrieve them faster the next time they’re requested. Although this works well for website logos and unchanging page content like home pages, you usually wouldn’t want a web browser to store a local copy of submitted forms, such as login forms.</p>
<p class="TX">Web browser applications often cache web pages requested with the <span class="SANS_TheSansMonoCd_W5Regular_11">GET</span> HTTP method, but they don’t cache the content of web pages received after a <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> HTTP request. Remember, <span class="SANS_TheSansMonoCd_W5Regular_11">GET</span> requests simply retrieve information (without changing content on the server), so there is no problem with caching such requests. However, <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> requests often involve form data submission (including login forms), and such requests can result in changes to the server contents such as deleting or changing database contents, so it would be dangerous, and perhaps insecure, to cache and repeat such <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> requests.</p>
</section>
<section aria-labelledby="sec2" epub:type="division">
<h3 class="H1"><span id="sec2"/><span id="toc-link_222"/><span class="SANS_Futura_Std_Bold_B_11">Creating a Site with a Login Form</span></h3>
<p class="TNI1">Now that you know how to create a basic login form, let’s build a website that includes a functional, professional-looking login page. We’ll secure one of the pages of the website by requiring users to log in to view it. The website will have the following pages:</p>
<ul class="ul">
<li class="ListBullet">A home page</li>
<li class="ListBullet">A Contact Us page</li>
<li class="ListBullet">A login form</li>
<li class="ListBullet">An error message page</li>
<li class="ListBullet">A Secure Banking page (with Swiss bank account details!)</li>
</ul>
<p class="TX">While we’re happy for any user (whether logged in or not) to see the home page, Contact Us page, and login page, we need to authenticate users via the form on the login page in order to allow only authorized users to view the secured Swiss bank account page.</p>
<p class="TX">All the pages of the website will have the same structure and look. For example, <a href="#fig16-2">Figure 16-2</a> shows the home page.</p>
<figure class="IMG"><a id="fig16-2"/><img alt="" class="img100" height="594" src="../images/figure16-2.jpg" width="1689"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 16-2: The home page of our website</span></p></figcaption>
</figure>
<p class="TX"><span aria-label="304" epub:type="pagebreak" id="pg_304" role="doc-pagebreak"/>Every page will have a Bootstrap-styled header featuring a custom logo and a navigation bar. Where appropriate, the navigation link relating to the page currently being displayed will be highlighted in white, while the other links will be gray. Below the navigation bar is a banner with a website tagline on the left and a greeting on the right. The bottom part of each page contains the individual page content (in this case, the heading and text telling users that this is the home page).</p>
<p class="TX">To build the website, we’ll first create the individual pages. Then we’ll create the login form and login-processing logic, and add the code to authorize only successfully logged-in users to view the secured Swiss bank account page.</p>
<section aria-labelledby="sec3" epub:type="division">
<h4 class="H2"><span id="sec3"/><span id="toc-link_223"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Defining the File Structure</span></h4>
<p class="TNI1">Create a folder for the project. Inside, it will have the following structure:</p>
<figure class="IMG-1"><img alt="" class="img100" height="749" src="../images/pg304.jpg" width="1383"/>
</figure>
</section>
<section aria-labelledby="sec4" epub:type="division">
<h4 class="H2"><span id="sec4"/><span id="toc-link_224"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Creating the Shared Page Content</span></h4>
<p class="TNI1">Now we’ll create a <i>_header.php</i> file defining the header content shared by all the page templates. Using a shared header file will give a consistent look and feel to the site and avoid unnecessary code duplication. Additionally, if we ever want to change the site style or navigation bar contents, we’ll need to change only the contents of this one header file.</p>
<p class="TX">Add the <i>_header.php</i> file to the <i>templates</i> subfolder<i>.</i> The file will contain quite a few lines of code (mostly Bootstrap classes and HTML <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;div&gt;</span> elements), so we’ll look at it in three parts, starting with <a href="#lis16-2">Listing 16-2</a>.</p>
<span id="lis16-2"/>
<pre><code>&lt;?php&#13;
$homeLink =  $homeLink ?? '';&#13;
$contactLink =  $contactLink ?? '';&#13;
$loginLink =  $loginLink ?? '';&#13;
&#13;
<span aria-label="305" epub:type="pagebreak" id="pg_305" role="doc-pagebreak"/>$pageTitle =  $pageTitle ?? '';&#13;
?&gt;&#13;
&lt;!doctype HTML&gt;&#13;
&lt;html&gt;&#13;
&lt;head&gt;&#13;
    &lt;meta name="viewport" content="width=device-width"&gt;&#13;
    &lt;title&gt;Secure site: &lt;?= $pageTitle ?&gt;&lt;/title&gt; <span aria-label="annotation1" class="codewide_CodeAnnotation">❶</span>&#13;
    &lt;link rel="stylesheet" href="/css/login.css"&gt;&#13;
    &lt;link rel="stylesheet"&#13;
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"&#13;
    &gt;&#13;
&lt;/head&gt;&#13;
&lt;body class="container"&gt;</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-2: The first part of</span> <span class="SANS_Futura_Std_Book_11">_header.php</span></p>
<p class="TX">We start with a PHP code block declaring three variables to help control the display of the navigation links at the top of the page: <span class="SANS_TheSansMonoCd_W5Regular_11">$homeLink</span>, <span class="SANS_TheSansMonoCd_W5Regular_11">$contactLink</span>, and <span class="SANS_TheSansMonoCd_W5Regular_11">$loginLink</span>, corresponding to the Home, Contact Us, and Login page links. Later, when we write the individual templates for each of these pages, we’ll add code setting that page’s variable to the <span class="SANS_TheSansMonoCd_W5Regular_11">'active'</span> string, which corresponds to a CSS style selector that will make the page’s navigation link appear white. Here in the <i>_header</i> template, we use the null-coalescing operator <span class="SANS_TheSansMonoCd_W5Regular_11">??</span> (see <span class="Xref"><a href="chapter4.xhtml">Chapter 4</a></span>) to set all three variables to empty strings if they don’t already have a value. An empty string will make the navigation link appear gray.</p>
<p class="TX">Thus, when we load the login page, for example, <span class="SANS_TheSansMonoCd_W5Regular_11">$loginLink</span> will be set to <span class="SANS_TheSansMonoCd_W5Regular_11">'active'</span>, and the Login navigation link will appear white, while <span class="SANS_TheSansMonoCd_W5Regular_11">$homeLink</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">$contactLink</span>, not having any prior value, will be set to empty strings and their links will appear gray. This use of PHP variables to fill in CSS style values is an effective way to highlight the current page in a navigation bar and gray out the others.</p>
<blockquote>
<p class="Note"><span class="SANS_Dogma_OT_Bold_B_15">NOTE</span></p>
</blockquote>
<p class="NOTE-TXT"><i>If you aren’t confident using the null-coalescing operator, you can always write an</i> <span class="SANS_TheSansMonoCd_W5Regular_Italic_11">if</span> <i>statement using the</i> <span class="SANS_TheSansMonoCd_W5Regular_Italic_11">isset()</span> <i>function to provide the same functionality, such as</i> <span class="SANS_TheSansMonoCd_W5Regular_Italic_11">if (!isset($homeLink)) $homeLink = ''</span><i>.</i></p>
<p class="TX">We next use another null-coalescing operator to set the <span class="SANS_TheSansMonoCd_W5Regular_11">$pageTitle</span> variable to an empty string in case it hasn’t been set. Then we use the value of <span class="SANS_TheSansMonoCd_W5Regular_11">$pageTitle</span> to form an HTML <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;title&gt;</span> element for the page <span aria-label="annotation1" class="CodeAnnotation">❶</span>. This way, each function that includes our <i>_header.php</i> file can define a value for the PHP variable <span class="SANS_TheSansMonoCd_W5Regular_11">$pageTitle</span>, giving each page a meaningful title that most browsers will use for the bookmark text. We then read in the Bootstrap stylesheet as well as our own CSS stylesheet file from <i>/public/css/login.css</i>. This stylesheet, which we’ll create later, will have a few styles for the login page. The final line in this listing starts a <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;body&gt;</span> element, styled with the Bootstrap <span class="SANS_TheSansMonoCd_W5Regular_11">container</span> class.</p>
<p class="TX">The code for our header template continues in <a href="#lis16-3">Listing 16-3</a>.</p>
<span id="lis16-3"/>
<pre><code><span aria-label="306" epub:type="pagebreak" id="pg_306" role="doc-pagebreak"/><span aria-label="annotation1" class="codeannotated_CodeAnnotation">❶</span> &lt;header class="navbar navbar-expand navbar-dark d-flex mb-3 bg-primary"&gt;&#13;
&#13;
    &lt;img src="/images/logo.png" alt="logo" width="200px"&gt;&#13;
&#13;
    &lt;ul class="navbar-nav p-2"&gt;&#13;
        &lt;li class="nav-item"&gt;&#13;
          <span aria-label="annotation2" class="Code_CodeAnnotation">❷</span> &lt;a class="nav-link &lt;?= $homeLink ?&gt;" href="/"&gt;&#13;
                Home&#13;
            &lt;/a&gt;&#13;
        &lt;/li&gt;&#13;
&#13;
        &lt;li class="nav-item"&gt;&#13;
          <span aria-label="annotation3" class="Code_CodeAnnotation">❸</span> &lt;a class="nav-link &lt;?= $contactLink ?&gt;" href="/?action=contact"&gt;&#13;
                Contact Us&#13;
            &lt;/a&gt;&#13;
         &lt;/li&gt;&#13;
    &lt;/ul&gt;&#13;
&#13;
    &lt;ul class="navbar-nav ms-auto p-2"&gt;&#13;
        &lt;li class="nav-item"&gt;&#13;
          <span aria-label="annotation4" class="Code_CodeAnnotation">❹</span> &lt;a class="nav-link &lt;?= $loginLink ?&gt;" href="/?action=login"&gt;&#13;
                Login&#13;
            &lt;/a&gt;&#13;
        &lt;/li&gt;&#13;
    &lt;/ul&gt;&#13;
&lt;/header&gt;</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-3: The second part of</span> <span class="SANS_Futura_Std_Book_11">_header.php</span></p>
<p class="TX">We declare a <span class="SANS_TheSansMonoCd_W5Regular_11">header</span> element that will contain the logo image and navigation links <span aria-label="annotation1" class="CodeAnnotation">❶</span>. Within it, we declare the navigation bar link for the home page, styling this link with <span class="SANS_TheSansMonoCd_W5Regular_11">class="nav-link &lt;?= $homeLink ?&gt;"</span> <span aria-label="annotation2" class="CodeAnnotation">❷</span>. Here’s where we continue implementing the navigation link styling mechanism we set in motion at the start of <a href="#lis16-2">Listing 16-2</a>. The link will be styled as a Bootstrap navigation link (<span class="SANS_TheSansMonoCd_W5Regular_11">nav-link</span>), but also as <span class="SANS_TheSansMonoCd_W5Regular_11">active</span> (highlighted in white) if we’ve set the <span class="SANS_TheSansMonoCd_W5Regular_11">$homeLink</span> variable to <span class="SANS_TheSansMonoCd_W5Regular_11">'active'</span>. Otherwise, if <span class="SANS_TheSansMonoCd_W5Regular_11">$homeLink</span> is an empty string, the navigation bar link won’t be highlighted in white as the active page link. We style the Contact Us <span aria-label="annotation3" class="CodeAnnotation">❸</span> and Login <span aria-label="annotation4" class="CodeAnnotation">❹</span> links in a similar way, again making them active only if their corresponding link variable (<span class="SANS_TheSansMonoCd_W5Regular_11">$contactLink</span> or <span class="SANS_TheSansMonoCd_W5Regular_11">$loginLink</span>) contains the string <span class="SANS_TheSansMonoCd_W5Regular_11">'active'</span>.</p>
<p class="TX">Listing 16-4 is the final part of our common page-header code.</p>
<span id="lis16-4"/>
<pre><code>&lt;div class="row bg-light p-5"&gt;&#13;
    &lt;div class="col"&gt;&#13;
        &lt;h1&gt;MGW. &lt;br&gt;You know it makes sense!&lt;/h1&gt;&#13;
    &lt;/div&gt;&#13;
&#13;
    &lt;div class="col"&gt;&#13;
        &lt;p&gt;&#13;
            Welcome to My Great Website (MGW).&#13;
            &lt;br&gt;&#13;
            Now with login security!&#13;
<span aria-label="307" epub:type="pagebreak" id="pg_307" role="doc-pagebreak"/>        &lt;/p&gt;&#13;
    &lt;/div&gt;&#13;
&lt;/div&gt;</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_11">Listing 16-4:</span> <span class="SANS_Futura_Std_Book_Oblique_11">The third part of</span> <span class="SANS_Futura_Std_Book_11">_header.php</span></p>
<p class="TX">Here we declare a Bootstrap row <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;div&gt;</span> with the standard content for every page on the website. This <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;div&gt;</span> is styled with a light gray background and some padding. It contains two <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;div&gt;</span> elements styled as columns, one with the website tagline and the other with a greeting touting the site’s login feature.</p>
</section>
<section aria-labelledby="sec5" epub:type="division">
<h4 class="H2"><span id="sec5"/><span id="toc-link_225"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Designing the Page Templates</span></h4>
<p class="TNI1">Next, we’ll create the templates for the home, Contact Us, and Secure Banking pages. With much of the work being done by the common page-header template, the template scripts for these three pages are straightforward. <a href="#lis16-5">Listing 16-5</a> shows our Home page template script. Save this script in the <i>templates</i> subfolder as <i>homepage.php</i>.</p>
<span id="lis16-5"/>
<pre><code>&lt;?php&#13;
$pageTitle = 'Home Page';&#13;
$homeLink = 'active';&#13;
require_once '_header.php';&#13;
?&gt;&#13;
&#13;
<span aria-label="annotation1" class="codeannotated_CodeAnnotation">❶</span> &lt;h1&gt;&lt;?= $pageTitle ?&gt;&lt;/h1&gt;&#13;
&#13;
&lt;p&gt;&#13;
Welcome to the secure website demo.&#13;
&lt;/p&gt;&#13;
&lt;/body&gt;&#13;
&lt;/html&gt;</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-5: The</span> <span class="SANS_Futura_Std_Book_11">homepage.php</span> <span class="SANS_Futura_Std_Book_Oblique_11">template</span></p>
<p class="TX">We first assign the <span class="SANS_TheSansMonoCd_W5Regular_11">$pageTitle</span> variable a value, heading off the null-coalescing operator in <a href="#lis16-2">Listing 16-2</a>. Additionally, since we want the Home link highlighted in the navigation bar, we assign the string <span class="SANS_TheSansMonoCd_W5Regular_11">'active'</span> to the <span class="SANS_TheSansMonoCd_W5Regular_11">$homeLink</span> variable. Then we read in and execute the <i>_header.php</i> template. Next, we display the value in <span class="SANS_TheSansMonoCd_W5Regular_11">$pageTitle</span> as a level 1 heading in the body of the HTML page <span aria-label="annotation1" class="CodeAnnotation">❶</span>. This is followed by a paragraph of page content, then tags to close the <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;body&gt;</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;html&gt;</span> elements of the page.</p>
<p class="TX">Listing 16-6 shows the code for the Contact Us page in <i>templates/ contact.php</i>.</p>
<span id="lis16-6"/>
<pre><code>&lt;?php&#13;
<span aria-label="annotation1" class="codeannotated_CodeAnnotation">❶</span> $pageTitle = 'Contact Us';&#13;
<span aria-label="annotation2" class="codeannotated_CodeAnnotation">❷</span> $contactLink = 'active';&#13;
require_once '_header.php';&#13;
?&gt;&#13;
&#13;
&lt;h1&gt;&lt;?= $pageTitle ?&gt;&lt;/h1&gt;&#13;
&#13;
<span aria-label="308" epub:type="pagebreak" id="pg_308" role="doc-pagebreak"/><span aria-label="annotation3" class="codeannotated_CodeAnnotation">❸</span> &lt;p&gt;&#13;
    Contact us as follows:&#13;
&lt;/p&gt;&#13;
&#13;
&lt;dl&gt;&#13;
    &lt;dt&gt;Email&lt;/dt&gt;&#13;
    &lt;dd&gt;enquiries@securitydemo.com&lt;/dd&gt;&#13;
&#13;
    &lt;dt&gt;Phone&lt;/dt&gt;&#13;
    &lt;dd&gt;+123 22-333-4444&lt;/dd&gt;&#13;
&#13;
    &lt;dt&gt;Address&lt;/dt&gt;&#13;
    &lt;dd&gt;1 Main Street,&lt;br&gt;Newtown,&lt;br&gt;Ireland&lt;/dd&gt;&#13;
&lt;/dl&gt;&#13;
&#13;
&lt;/body&gt;&#13;
&lt;/html&gt;</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-6: The</span> <span class="SANS_Futura_Std_Book_11">contact.php</span> <span class="SANS_Futura_Std_Book_Oblique_11">template</span></p>
<p class="TX">The Contact Us template is similar to the Home page template, differing only in the value of <span class="SANS_TheSansMonoCd_W5Regular_11">$pageTitle</span> <span aria-label="annotation1" class="CodeAnnotation">❶</span>, the variable set to <span class="SANS_TheSansMonoCd_W5Regular_11">'active'</span> to highlight the Contact Us navigation link <span aria-label="annotation2" class="CodeAnnotation">❷</span>, and the page content paragraph and definition list details <span aria-label="annotation3" class="CodeAnnotation">❸</span>.</p>
<p class="TX">Next, we’ll create the Secure Banking page, which is shown in <a href="#fig16-3">Figure 16-3</a>. We’ll add authorization logic later so that only logged-in users can view this page.</p>
<figure class="IMG"><a id="fig16-3"/><img alt="" class="img100" height="628" src="../images/figure16-3.jpg" width="1688"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 16-3: The Secure Banking page of our website</span></p></figcaption>
</figure>
<p class="TX">Listing 16-7 creates the Secure Banking page. Save this code in <i>templates/ secureBanking.php</i>.</p>
<span id="lis16-7"/>
<pre><code>&lt;?php&#13;
<span aria-label="annotation1" class="codeannotated_CodeAnnotation">❶</span> $pageTitle = 'Secure Banking - Swiss bank account details';&#13;
require_once '_header.php';&#13;
?&gt;&#13;
&#13;
<span aria-label="309" epub:type="pagebreak" id="pg_309" role="doc-pagebreak"/>&lt;h1&gt;&lt;?= $pageTitle ?&gt;&lt;/h1&gt;&#13;
&#13;
<span aria-label="annotation2" class="codeannotated_CodeAnnotation">❷</span> &lt;p&gt;&#13;
    Welcome to the secure website demo.&#13;
    &lt;br&gt;&#13;
    Today's bank account number is 12294934503845 with code word "green lawn"&#13;
&lt;/p&gt;&#13;
&lt;/body&gt;&#13;
&lt;/html&gt;</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-7: The</span> <span class="SANS_Futura_Std_Book_11">secureBanking.php</span> <span class="SANS_Futura_Std_Book_Oblique_11">template</span></p>
<p class="TX">Once again, this template is similar to those for the home page and Contact Us page. It differs only in the value of <span class="SANS_TheSansMonoCd_W5Regular_11">$pageTitle</span> <span aria-label="annotation1" class="CodeAnnotation">❶</span> and the page content paragraph <span aria-label="annotation2" class="CodeAnnotation">❷</span>. Since we don’t currently link to this page in the navigation bar, we don’t bother setting a variable to '<span class="SANS_TheSansMonoCd_W5Regular_11">active'</span>.</p>
</section>
<section aria-labelledby="sec6" epub:type="division">
<h4 class="H2"><span id="sec6"/><span id="toc-link_226"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Developing the Login Form</span></h4>
<p class="TNI1">Now we’ll create a login form for our website (<a href="#fig16-4">Figure 16-4</a>). Though we’ll use some extra HTML and CSS to make the form look more professional, at its core it’ll be the same as the basic login form we created at the start of the chapter, with a Username field, a Password field, and a Log In submit button.</p>
<figure class="IMG"><a id="fig16-4"/><img alt="" class="img100" height="885" src="../images/figure16-4.jpg" width="1689"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 16-4: The login page of our website</span></p></figcaption>
</figure>
<p class="TX">Listing 16-8 shows the code used to create the login form, saved in <i>templates/login.php</i>.</p>
<span id="lis16-8"/>
<pre><code>&lt;?php&#13;
$pageTitle = 'Login';&#13;
$loginLink = 'active';&#13;
<span aria-label="310" epub:type="pagebreak" id="pg_310" role="doc-pagebreak"/>require_once '_header.php';&#13;
?&gt;&#13;
&#13;
&lt;div class="formLogin"&gt;&#13;
&#13;
  <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> &lt;form action="/?action=login" method="post"&gt;&#13;
      <span aria-label="annotation2" class="Code_CodeAnnotation">❷</span> &lt;div class="form-group row m-3"&gt;&#13;
            &lt;label for="username" class="col-form-label col-sm-3"&gt;&#13;
                Username:&#13;
            &lt;/label&gt;&#13;
            &lt;div class="col"&gt;&#13;
                &lt;input name="username" id="username"&#13;
                    placeholder="Your username" class="form-control"&#13;
                &gt;&#13;
            &lt;/div&gt;&#13;
        &lt;/div&gt;&#13;
&#13;
      <span aria-label="annotation3" class="Code_CodeAnnotation">❸</span> &lt;div class="form-group row m-3"&gt;&#13;
            &lt;label for="password" class="col-form-label col-sm-3"&gt;&#13;
                Password:&#13;
            &lt;/label&gt;&#13;
            &lt;div class="col"&gt;&#13;
                &lt;input name="password" id="password" type="password"&#13;
                    placeholder="Your password" class="form-control"&#13;
                &gt;&#13;
            &lt;/div&gt;&#13;
        &lt;/div&gt;&#13;
&#13;
      <span aria-label="annotation4" class="Code_CodeAnnotation">❹</span> &lt;div class="form-group"&gt;&#13;
            &lt;input type="submit" class="btn btn-primary w-100"&#13;
                value="Log in" class="form-control"&#13;
            &gt;&#13;
        &lt;/div&gt;&#13;
    &lt;/form&gt;&#13;
&#13;
&lt;/div&gt;&#13;
&lt;/body&gt;&#13;
&lt;/html&gt;</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-8: The</span> <span class="SANS_Futura_Std_Book_11">login.php</span> <span class="SANS_Futura_Std_Book_Oblique_11">template</span></p>
<p class="TX">The script starts much like our other templates: we assign a value to <span class="SANS_TheSansMonoCd_W5Regular_11">$pageTitle</span>, set <span class="SANS_TheSansMonoCd_W5Regular_11">$loginLink</span> to the string <span class="SANS_TheSansMonoCd_W5Regular_11">'active'</span> so the Login link will be highlighted in the navigation bar, and read in and execute the <i>_header.php</i> template. Then we define a <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;div&gt;</span> to encapsulate the login form, styled with a custom <span class="SANS_TheSansMonoCd_W5Regular_11">formLogin</span> CSS class (which we’ll create shortly). The login form itself is declared with the <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> method and the <span class="SANS_TheSansMonoCd_W5Regular_11">/?action=login</span> action <span aria-label="annotation1" class="CodeAnnotation">❶</span>.</p>
<p class="TX">We’ll use this same <span class="SANS_TheSansMonoCd_W5Regular_11">action</span> value (<span class="SANS_TheSansMonoCd_W5Regular_11">login</span>) to both request the display of the login form and process the submitted form data, distinguishing between the requests by their HTTP method: <span class="SANS_TheSansMonoCd_W5Regular_11">GET</span> will request the form be displayed, and <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> will request processing of submitted login form data by the web application. We’ll implement this logic later in the chapter.</p>
<p class="TX">Our form is structured as three Bootstrap rows for the Username <span aria-label="annotation2" class="CodeAnnotation">❷</span>, Password <span aria-label="annotation3" class="CodeAnnotation">❸</span>, and Log In <span aria-label="annotation4" class="CodeAnnotation">❹</span> inputs, each represented with a <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;div&gt;</span> element. <span aria-label="311" epub:type="pagebreak" id="pg_311" role="doc-pagebreak"/>The Username and Password rows contain <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;label&gt;</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;input&gt;</span> elements. Notice that the inputs have a <span class="SANS_TheSansMonoCd_W5Regular_11">placeholder</span> attribute whose value will appear as faint gray filler text, and that we specify <span class="SANS_TheSansMonoCd_W5Regular_11">type="password"</span> as an attribute of the Password input box to obscure the password while it’s being typed in.</p>
<p class="TX">To finish up the login page, we’ll create the CSS stylesheet <i>public/css/ login.css</i>, shown in <a href="#lis16-9">Listing 16-9</a>. It adds custom styling to the login form. Recall that the common <i>_header.php</i> template reads in this stylesheet for every page.</p>
<span id="lis16-9"/>
<pre><code>.formLogin {&#13;
    background-color: lightgray;&#13;
    padding: 4rem;&#13;
    max-width: 30rem;&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-9: The CSS code in</span> <span class="SANS_Futura_Std_Book_11">login.css</span></p>
<p class="TX">The stylesheet defines the <span class="SANS_TheSansMonoCd_W5Regular_11">formLogin</span> class referenced in <a href="#lis16-8">Listing 16-8</a>. This style sets the form background to light gray, adds padding, and sets a maximum width of 30 characters.</p>
</section>
<section aria-labelledby="sec7" epub:type="division">
<h4 class="H2"><span id="sec7"/><span id="toc-link_227"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Writing the Front Controller</span></h4>
<p class="TNI1">As usual, we’ll create a single front controller through which every request to our web application must arrive. Create <i>public/index.php</i> containing the code in <a href="#lis16-10">Listing 16-10</a>.</p>
<span id="lis16-10"/>
<pre><code>&lt;?php&#13;
require_once __DIR__ . '/../src/functions.php';&#13;
&#13;
$action = filter_input(INPUT_GET, 'action');&#13;
&#13;
switch ($action) {&#13;
  <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> case 'contact':&#13;
        contact();&#13;
        break;&#13;
&#13;
  <span aria-label="annotation2" class="Code_CodeAnnotation">❷</span> case 'login':&#13;
        $isSubmitted = ($_SERVER['REQUEST_METHOD'] === 'POST');&#13;
        if ($isSubmitted) {&#13;
            // POST method so process submitted login data&#13;
            processLogin();&#13;
        } else {&#13;
            // GET method to display login form&#13;
            loginForm();&#13;
        }&#13;
        break;&#13;
&#13;
  <span aria-label="annotation3" class="Code_CodeAnnotation">❸</span> default:&#13;
        home();&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-10: The</span> <span class="SANS_Futura_Std_Book_11">index.php</span> <span class="SANS_Futura_Std_Book_Oblique_11">front-controller script</span></p>
<p class="TX"><span aria-label="312" epub:type="pagebreak" id="pg_312" role="doc-pagebreak"/>The script follows the usual pattern of reading in the function-declaration file, extracting the value of the <span class="SANS_TheSansMonoCd_W5Regular_11">action</span> query-string parameter (if found in the request), and passing it to a <span class="SANS_TheSansMonoCd_W5Regular_11">switch</span> statement that decides what to do. If the value is <span class="SANS_TheSansMonoCd_W5Regular_11">contact</span> <span aria-label="annotation1" class="CodeAnnotation">❶</span>, we invoke <span class="SANS_TheSansMonoCd_W5Regular_11">contact()</span>, which reads in the template to display the Contact Us page. If the value is <span class="SANS_TheSansMonoCd_W5Regular_11">'login'</span> <span aria-label="annotation2" class="CodeAnnotation">❷</span>, we test whether the HTTP request used the <span class="SANS_TheSansMonoCd_W5Regular_11">POST</span> method, indicating the user has submitted username and password values through the login form, and invoke the <span class="SANS_TheSansMonoCd_W5Regular_11">processLogin()</span> function if so. Otherwise, we invoke the <span class="SANS_TheSansMonoCd_W5Regular_11">loginForm()</span> function to display the login page. Finally, the <span class="SANS_TheSansMonoCd_W5Regular_11">default</span> case <span aria-label="annotation3" class="CodeAnnotation">❸</span> displays the home page by invoking the <span class="SANS_TheSansMonoCd_W5Regular_11">home()</span> function.</p>
</section>
<section aria-labelledby="sec8" epub:type="division">
<h4 class="H2"><span id="sec8"/><span id="toc-link_228"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Implementing the Logic Functions</span></h4>
<p class="TNI1">Next, we need to create the functions for implementing the logic of the website, saved in <i>src/functions.php</i>. Five of the functions are straightforward: they simply display the four main pages of the site (home page, Contact Us, login page, Secure Banking), plus an error message page. We’ll look at these functions first, shown in <a href="#lis16-11">Listing 16-11</a>.</p>
<span id="lis16-11"/>
<pre><code>&lt;?php&#13;
function home(): void&#13;
{&#13;
    require_once __DIR__ . '/../templates/homepage.php';&#13;
}&#13;
&#13;
function contact(): void&#13;
{&#13;
    require_once __DIR__ . '/../templates/contact.php';&#13;
}&#13;
&#13;
function loginForm(): void&#13;
{&#13;
    require_once __DIR__ . '/../templates/login.php';&#13;
}&#13;
&#13;
function secureBanking(): void&#13;
{&#13;
    require_once __DIR__ . '/../templates/secureBanking.php';&#13;
}&#13;
&#13;
function showError($message): void&#13;
{&#13;
    require_once __DIR__ . '/../templates/error.php';&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-11: The display functions in</span> <span class="SANS_Futura_Std_Book_11">functions.php</span></p>
<p class="TX">The first four functions all perform the same task: they use a <span class="SANS_TheSansMonoCd_W5Regular_11">require_once</span> statement to read in and display one of the template scripts. Next, the <span class="SANS_TheSansMonoCd_W5Regular_11">showError()</span> function expects a <span class="SANS_TheSansMonoCd_W5Regular_11">$message</span> string as a parameter. It too uses a <span class="SANS_TheSansMonoCd_W5Regular_11">require_once</span> statement to read in and display one of the template scripts. In <span aria-label="313" epub:type="pagebreak" id="pg_313" role="doc-pagebreak"/>this case, since <span class="SANS_TheSansMonoCd_W5Regular_11">$message</span> is a parameter, it has scope when the <i>error.php</i> template is read in and executed, so the template can display the contents of the string inside <span class="SANS_TheSansMonoCd_W5Regular_11">$message</span>. (We’ll create the <i>error.php</i> template shortly.)</p>
<p class="TX">The second part of the <i>functions.php</i> script, shown in <a href="#lis16-12">Listing 16-12</a>, declares three functions for processing submitted usernames and passwords from the login form.</p>
<span id="lis16-12"/>
<pre><code><span aria-label="annotation1" class="codeannotated_CodeAnnotation">❶</span> function getUsers(): array&#13;
{&#13;
    $users = [];&#13;
    $users['matt'] = 'smith';&#13;
    $users['james'] = 'bond';&#13;
    $users['jane'] = 'doe';&#13;
&#13;
    return $users;&#13;
}&#13;
&#13;
<span aria-label="annotation2" class="codeannotated_CodeAnnotation">❷</span> function processLogin(): void&#13;
{&#13;
    $username = filter_input(INPUT_POST, 'username');&#13;
    $password = filter_input(INPUT_POST, 'password');&#13;
&#13;
  <span aria-label="annotation3" class="Code_CodeAnnotation">❸</span> if (validLoginCredentials($username, $password)) {&#13;
        secureBanking();&#13;
    } else {&#13;
        showError('invalid login credentials - try again');&#13;
    }&#13;
}&#13;
&#13;
<span aria-label="annotation4" class="codeannotated_CodeAnnotation">❹</span> function validLoginCredentials($username, $password): bool&#13;
{&#13;
    $users = getUsers();&#13;
&#13;
    if (isset($users[$username])) {&#13;
        $storedPassword = $users[$username];&#13;
        if ($password == $storedPassword) {&#13;
            return true;&#13;
        }&#13;
    }&#13;
&#13;
    // If get here, no matching username/password&#13;
  <span aria-label="annotation5" class="Code_CodeAnnotation">❺</span> return false;&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-12: The second part of</span> <span class="SANS_Futura_Std_Book_11">functions.php</span></p>
<p class="TX">In this part of the script, we declare the <span class="SANS_TheSansMonoCd_W5Regular_11">getUsers()</span> function <span aria-label="annotation1" class="CodeAnnotation">❶</span>, which returns an array called <span class="SANS_TheSansMonoCd_W5Regular_11">$users</span> whose keys are usernames and whose values are passwords. This is the list of users who can be authenticated through our website’s login system (by providing a valid username and its corresponding password). Although we’re using an array here, a real-world website would usually get username and password data from a database, and <span aria-label="314" epub:type="pagebreak" id="pg_314" role="doc-pagebreak"/>the passwords would be hashed for security reasons. We’ll look at how to do this in <span class="Xref"><a href="chapter30.xhtml">Chapter 30</a></span>.</p>
<p class="TX">Next, we define the <span class="SANS_TheSansMonoCd_W5Regular_11">processLogin()</span> function <span aria-label="annotation2" class="CodeAnnotation">❷</span>. In it, we use <span class="SANS_TheSansMonoCd_W5Regular_11">filter_input()</span> to attempt to retrieve the username and password submitted via the login form, storing the values in the <span class="SANS_TheSansMonoCd_W5Regular_11">$username</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">$password</span> variables. Then we pass these values to the <span class="SANS_TheSansMonoCd_W5Regular_11">validLoginCredentials()</span> function <span aria-label="annotation3" class="CodeAnnotation">❸</span>. If the function returns <span class="SANS_TheSansMonoCd_W5Regular_11">true</span>, we’ve successfully authenticated the user, since they were able to provide a matching username-password pair. Therefore, we display the secure bank page to the user by invoking the <span class="SANS_TheSansMonoCd_W5Regular_11">secureBanking()</span> function. Otherwise, if <span class="SANS_TheSansMonoCd_W5Regular_11">validLoginCredentials()</span> returns <span class="SANS_TheSansMonoCd_W5Regular_11">false</span>, we invoke the <span class="SANS_TheSansMonoCd_W5Regular_11">showError()</span> function to display the error page, passing an error message stating the login credentials are invalid.</p>
<p class="TX">Notice that the error message doesn’t tell the user whether the problem is with the username or password. This follows the common security practice of <i>minimum information disclosure</i>. We shouldn’t inform the user (or hacker-bot or whatever is trying to log in) when they’ve found a valid username. Armed with that information, an attacker could repeatedly use the valid username with different passwords in an attempt to gain access to the system, which would be easier than needing to guess the username <i>and</i> the password each time.</p>
<p class="TX">The final function is <span class="SANS_TheSansMonoCd_W5Regular_11">validLoginCredentials()</span> <span aria-label="annotation4" class="CodeAnnotation">❹</span>, which expects two parameters, <span class="SANS_TheSansMonoCd_W5Regular_11">$username</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">$password</span>. This is where we perform the all-important task of authenticating the user attempting to log in. We first retrieve the array of passwords indexed by the username from <span class="SANS_TheSansMonoCd_W5Regular_11">getUsers()</span>, storing the array in the <span class="SANS_TheSansMonoCd_W5Regular_11">$users</span> variable.</p>
<p class="TX">Then we test whether an element can be found in <span class="SANS_TheSansMonoCd_W5Regular_11">$users</span> with the key <span class="SANS_TheSansMonoCd_W5Regular_11">$username</span>. If no such key is found (<span class="SANS_TheSansMonoCd_W5Regular_11">isset($users[$username])</span> is <span class="SANS_TheSansMonoCd_W5Regular_11">false</span>), we exit the <span class="SANS_TheSansMonoCd_W5Regular_11">if</span> statement and the function will return <span class="SANS_TheSansMonoCd_W5Regular_11">false</span> <span aria-label="annotation5" class="CodeAnnotation">❺</span>, indicating the submitted username and password aren’t valid. However, if <span class="SANS_TheSansMonoCd_W5Regular_11">$username</span> can be found in <span class="SANS_TheSansMonoCd_W5Regular_11">$users</span>, its corresponding value is stored in the <span class="SANS_TheSansMonoCd_W5Regular_11">$storedPassword</span> variable. Then we test whether the password received from the login form (<span class="SANS_TheSansMonoCd_W5Regular_11">$password</span>) matches the retrieved password from the array (<span class="SANS_TheSansMonoCd_W5Regular_11">$storedPassword</span>). If the two passwords match, we have valid credentials, so we return <span class="SANS_TheSansMonoCd_W5Regular_11">true</span>. Otherwise, the script will drop out of the <span class="SANS_TheSansMonoCd_W5Regular_11">if</span> statement and return <span class="SANS_TheSansMonoCd_W5Regular_11">false</span>.</p>
</section>
<section aria-labelledby="sec9" epub:type="division">
<h4 class="H2"><span id="sec9"/><span id="toc-link_229"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Creating the Error Page Template</span></h4>
<p class="TNI1">Now we’ll create the template for the error page (<a href="#fig16-5">Figure 16-5</a>).</p>
<span aria-label="315" epub:type="pagebreak" id="pg_315" role="doc-pagebreak"/>
<figure class="IMG"><a id="fig16-5"/><img alt="" class="img80" height="559" src="../images/figure16-5.jpg" width="1061"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 16-5: The error message page after invalid login credentials</span></p></figcaption>
</figure>
<p class="TX">This template, saved in <i>templates/error.php</i>, is similar to the other page templates we’ve created, as shown in <a href="#lis16-13">Listing 16-13</a>.</p>
<span id="lis16-13"/>
<pre><code>&lt;?php&#13;
$pageTitle = 'Error page';&#13;
require_once '_header.php';&#13;
?&gt;&#13;
&#13;
&lt;div class="alert alert-danger" role="alert"&gt;&#13;
    Sorry, there was a problem:&#13;
    &lt;p&gt;&#13;
      <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> &lt;?= $message ?&gt;&#13;
    &lt;/p&gt;&#13;
&lt;/div&gt;&#13;
&lt;/body&gt;&#13;
&lt;/html&gt;</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-13: The</span> <span class="SANS_Futura_Std_Book_11">error.php</span> <span class="SANS_Futura_Std_Book_Oblique_11">template</span></p>
<p class="TX">We set the value of <span class="SANS_TheSansMonoCd_W5Regular_11">$pageTitle</span> to <span class="SANS_TheSansMonoCd_W5Regular_11">'Error page'</span>, then read in and execute the common <i>_header.php</i> template. In a pink Bootstrap alert–styled <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;div&gt;</span>, we output the string inside the <span class="SANS_TheSansMonoCd_W5Regular_11">$message</span> variable <span aria-label="annotation1" class="CodeAnnotation">❶</span>. All scripts that include this error page template should have first assigned a string to this variable (as we did, for example, in <a href="#lis16-12">Listing 16-12</a> when we called <span class="SANS_TheSansMonoCd_W5Regular_11">showError()</span> with the string <span class="SANS_TheSansMonoCd_W5Regular_11">'invalid login credentials - try again'</span>).</p>
</section>
</section>
<section aria-labelledby="sec10" epub:type="division">
<span aria-label="316" epub:type="pagebreak" id="pg_316" role="doc-pagebreak"/>
<h3 class="H1"><span id="sec10"/><span id="toc-link_230"/><span class="SANS_Futura_Std_Bold_B_11">Storing Login Data with Sessions</span></h3>
<p class="TNI1">While our website at present allows a user to authenticate through the login form and visit the Secure Banking page, the site doesn’t remember the successful login credentials. Once the user clicks away from the bank details page, they’ll have to return to the login form and resubmit their credentials to view it again. To make the site more user-friendly, we can use PHP sessions to remember successful logins.</p>
<p class="TX">If all logged-in users should have the same level of access, we can simply store the username to the session after a successful login, as we’ll do in this section. If different users have roles that come with different levels of authorization (for example, sales, supervisor, manager, administrator), we could store both the username and the corresponding role in the session. Then we would write logic so logged-in users can access only pages appropriate to their role. We’ll talk through this second approach in Exercise 3 at the end of the chapter.</p>
<p class="TX">Let’s add some code to save login data to the session. We’ll also add a link to the Secure Banking page for the navigation bar, but we’ll let the user visit that page only if they’ve logged in. Otherwise, we’ll display an authentication error message.</p>
<section aria-labelledby="sec11" epub:type="division">
<h4 class="H2"><span id="sec11"/><span id="toc-link_231"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Updating the Front Controller</span></h4>
<p class="TNI1">We first need to edit our <i>index.php</i> front controller to handle navigation to the Secure Banking details page. Since we now plan to use sessions to remember login data, we also need to (re)start a PHP session at the beginning of the front-controller script. <a href="#lis16-14">Listing 16-14</a> shows the updated script, with new code highlighted.</p>
<span id="lis16-14"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
session_start();&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">require_once __DIR__ . '/../src/functions.php';</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$action = filter_input(INPUT_GET, 'action');</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">switch ($action) {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    case 'contact':</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        contact();</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        break;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    case 'login':</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        $isSubmitted = ($_SERVER['REQUEST_METHOD'] === 'POST');</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        if ($isSubmitted) {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            // POST method so process submitted login data</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            processLogin();</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        } else {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            // GET method to display login form</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            loginForm();</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        }</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        break;</span>&#13;
&#13;
&#13;
<span aria-label="317" epub:type="pagebreak" id="pg_317" role="doc-pagebreak"/>  <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> case 'secured':&#13;
        if (isLoggedIn()) {&#13;
            secureBanking();&#13;
        } else {&#13;
            showError('invalid login credentials - try again');&#13;
        }&#13;
        break;&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    default:</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        home();</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-14: The updated</span> <span class="SANS_Futura_Std_Book_11">index.php</span> <span class="SANS_Futura_Std_Book_Oblique_11">front-controller script</span></p>
<p class="TX">At the start of the script, we (re)start a session. Then we add a new case to the <span class="SANS_TheSansMonoCd_W5Regular_11">switch</span> statement for when the value of <span class="SANS_TheSansMonoCd_W5Regular_11">$action</span> is <span class="SANS_TheSansMonoCd_W5Regular_11">'secured'</span> <span aria-label="annotation1" class="CodeAnnotation">❶</span>. In this case, we call the <span class="SANS_TheSansMonoCd_W5Regular_11">isLoggedIn()</span> function, which we’ll write shortly. If it returns <span class="SANS_TheSansMonoCd_W5Regular_11">true</span>, we invoke <span class="SANS_TheSansMonoCd_W5Regular_11">secureBanking()</span> to display the Secure Banking page. Otherwise, we display the error page with the message <span class="SANS_TheSansMonoCd_W5Regular_11">'invalid login credentials - try again'</span>.</p>
</section>
<section aria-labelledby="sec12" epub:type="division">
<h4 class="H2"><span id="sec12"/><span id="toc-link_232"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Writing the Login Function</span></h4>
<p class="TNI1">Now we need to write a new <span class="SANS_TheSansMonoCd_W5Regular_11">isLoggedIn()</span> function to check whether a username is stored in the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array, indicating a user has successfully logged in. We also need to update our <span class="SANS_TheSansMonoCd_W5Regular_11">processLogin()</span> function so that when valid login credentials are processed, we store the username in <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span>. First, add <span class="SANS_TheSansMonoCd_W5Regular_11">isLoggedIn()</span> to the end <i>src/functions.php</i>, as shown in <a href="#lis16-15">Listing 16-15</a>.</p>
<span id="lis16-15"/>
<pre><code>function isLoggedIn(): bool&#13;
{&#13;
    if (isset($_SESSION['username'])) {&#13;
        return true;&#13;
    } else {&#13;
        return false;&#13;
    }&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-15: The</span> <span class="TheSansMonoCd_W5Regular_Italic_11">isLoggedIn()</span> <span class="SANS_Futura_Std_Book_Oblique_11">function</span></p>
<p class="TX">The function uses a simple <span class="SANS_TheSansMonoCd_W5Regular_11">if...else</span> statement based on whether a value can be found in the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array for the string key <span class="SANS_TheSansMonoCd_W5Regular_11">'username'</span>. If so, we return <span class="SANS_TheSansMonoCd_W5Regular_11">true</span>; if not, we return <span class="SANS_TheSansMonoCd_W5Regular_11">false</span>. Notice that we don’t need to test the actual value stored in the session under the <span class="SANS_TheSansMonoCd_W5Regular_11">'username'</span> key. We simply test whether <i>any</i> value is stored for this key. We don’t care what the username is of the user who’s logged in, as long as they’ve successfully logged in.</p>
<p class="TX">Now edit the <span class="SANS_TheSansMonoCd_W5Regular_11">processLogin()</span> function in <i>src/functions.php</i> as shown in <a href="#lis16-16">Listing 16-16</a> to store the username in the session after a successful login.</p>
<span id="lis16-16"/>
<pre><code><span aria-label="318" epub:type="pagebreak" id="pg_318" role="doc-pagebreak"/><span class="TheSansMonoCd_W5Regular_Grey_11">function processLogin(): void</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">{</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    $username = filter_input(INPUT_POST, 'username');</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    $password = filter_input(INPUT_POST, 'password');</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    if (validLoginCredentials($username, $password)) {</span>&#13;
        $_SESSION['username'] = $username;&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        secureBanking();</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    } else {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        showError('invalid login credentials - try again');</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    }</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-16: Updating the</span> <span class="TheSansMonoCd_W5Regular_Italic_11">processLogin()</span> <span class="SANS_Futura_Std_Book_Oblique_11">function</span></p>
<p class="TX">In the <span class="SANS_TheSansMonoCd_W5Regular_11">if</span> branch of the function’s conditional logic, we store the submitted username in the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array under the <span class="SANS_TheSansMonoCd_W5Regular_11">'username'</span> key. This way, the test in <span class="SANS_TheSansMonoCd_W5Regular_11">isLoggedIn()</span> will pass after a successful login.</p>
</section>
<section aria-labelledby="sec13" epub:type="division">
<h4 class="H2"><span id="sec13"/><span id="toc-link_233"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Updating the Header Template</span></h4>
<p class="TNI1">Let’s now edit the common <i>templates/_header.php</i> file to add a navigation bar link to the secured bank page, along with its associated CSS style variable. We’ll use an <span class="SANS_TheSansMonoCd_W5Regular_11">if</span> statement so that this link will appear only while the user is logged in. We need to add this conditional <span class="SANS_TheSansMonoCd_W5Regular_11">nav-item</span> after the navigation bar items for the home and Contact Us pages, as shown in <a href="#lis16-17">Listing 16-17</a>.</p>
<span id="lis16-17"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$homeLink =  $homeLink ?? '';</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$contactLink =  $contactLink ?? '';</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$loginLink =  $loginLink ?? '';</span>&#13;
<span aria-label="annotation1" class="codeannotated_CodeAnnotation">❶</span> $securedLink =  $securedLink ?? '';&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">$pageTitle =  $pageTitle ?? '';</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">?&gt;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;ul class="navbar-nav"&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;li class="nav-item"&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        &lt;a class="nav-link &lt;?= $homeLink ?&gt;" href="/"&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            Home</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        &lt;/a&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;/li&gt;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;li class="nav-item"&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        &lt;a class="nav-link &lt;?= $contactLink ?&gt;" href="/?action=contact"&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            Contact Us</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        &lt;/a&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;/li&gt;</span>&#13;
&#13;
<span aria-label="319" epub:type="pagebreak" id="pg_319" role="doc-pagebreak"/><span aria-label="annotation2" class="codeannotated_CodeAnnotation">❷</span> &lt;?php if (isLoggedIn()): ?&gt;&#13;
    &lt;li class="nav-item"&gt;&#13;
      <span aria-label="annotation3" class="Code_CodeAnnotation">❸</span> &lt;a class="nav-link &lt;?= $securedLink ?&gt;" href="/?action=secured"&gt;&#13;
            Secure banking&#13;
        &lt;/a&gt;&#13;
    &lt;/li&gt;&#13;
&lt;?php endif; ?&gt;&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;/ul&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-17: Adding a conditional navigation link for the Secure Banking page in</span> <span class="SANS_Futura_Std_Book_11">_header.php</span></p>
<p class="TX">We use the null-coalescing operator to set the <span class="SANS_TheSansMonoCd_W5Regular_11">$securedLink</span> variable to an empty string if it has no value already <span aria-label="annotation1" class="CodeAnnotation">❶</span>. Then we add an <span class="SANS_TheSansMonoCd_W5Regular_11">if</span> statement that uses our <span class="SANS_TheSansMonoCd_W5Regular_11">isLoggedIn()</span> function to test whether the user is logged in <span aria-label="annotation2" class="CodeAnnotation">❷</span>. If so, the navigation link in the body of the <span class="SANS_TheSansMonoCd_W5Regular_11">if</span> statement will be displayed. The link adds an <span class="SANS_TheSansMonoCd_W5Regular_11">action=secured</span> variable to the query string <span aria-label="annotation3" class="CodeAnnotation">❸</span>. Notice also that the value of the <span class="SANS_TheSansMonoCd_W5Regular_11">$securedLink</span> variable is part of the CSS class for this link. As with our other navigation links, if this variable contains the string <span class="SANS_TheSansMonoCd_W5Regular_11">'active'</span>, the link will be highlighted.</p>
</section>
<section aria-labelledby="sec14" epub:type="division">
<h4 class="H2"><span id="sec14"/><span id="toc-link_234"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Updating the Banking Page Template</span></h4>
<p class="TNI1">Now that we’ve added a navigation link for the Secure Banking page, we need to update the <i>templates/secureBanking.php</i> script to set the <span class="SANS_TheSansMonoCd_W5Regular_11">$securedLink</span> variable to <span class="SANS_TheSansMonoCd_W5Regular_11">'active'</span>. This will highlight the page’s navigation link when the page is being viewed. Update the template as shown in <a href="#lis16-18">Listing 16-18</a>.</p>
<span id="lis16-18"/>
<pre><code>&lt;?php&#13;
$pageTitle = 'Secure Banking- Swiss bank account details';&#13;
$securedLink = 'active';&#13;
require_once '_header.php';&#13;
?&gt;&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-18: Updating the</span> <span class="SANS_Futura_Std_Book_11">secureBanking.php</span> <span class="SANS_Futura_Std_Book_Oblique_11">template</span></p>
<p class="TX">The only change we need to make here is to add the statement that sets the <span class="SANS_TheSansMonoCd_W5Regular_11">$securedLink</span> variable before we read in the shared header template.</p>
</section>
</section>
<section aria-labelledby="sec15" epub:type="division">
<h3 class="H1"><span id="sec15"/><span id="toc-link_235"/><span class="SANS_Futura_Std_Bold_B_11">Offering a Logout Feature</span></h3>
<p class="TNI1">If we offer the user a way to log in and have their login information remembered, we should also offer a way to log out. Logging out a user means setting the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array to be empty so it no longer contains an element with the string key <span class="SANS_TheSansMonoCd_W5Regular_11">'username'</span>. To put this into practice, we need to add a new function, update the front controller, and create a logout link in the navigation bar.</p>
<section aria-labelledby="sec16" epub:type="division">
<span aria-label="320" epub:type="pagebreak" id="pg_320" role="doc-pagebreak"/>
<h4 class="H2"><span id="sec16"/><span id="toc-link_236"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Adding the Logout Function</span></h4>
<p class="TNI1">First, let’s write a <span class="SANS_TheSansMonoCd_W5Regular_11">logout()</span> function in <i>src/functions.php</i> that clears the user’s data from the session. Add the code shown in <a href="#lis16-19">Listing 16-19</a> to the end of the file.</p>
<span id="lis16-19"/>
<pre><code>function logout(): void&#13;
{&#13;
    $_SESSION = [];&#13;
    home();&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-19: The</span> <span class="TheSansMonoCd_W5Regular_Italic_11">logout()</span> <span class="SANS_Futura_Std_Book_Oblique_11">function</span></p>
<p class="TX">We set <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> to an empty array, erasing the stored username from the session. Then we invoke the <span class="SANS_TheSansMonoCd_W5Regular_11">home()</span> function to display the home page to the user after they’ve logged out.</p>
</section>
<section aria-labelledby="sec17" epub:type="division">
<h4 class="H2"><span id="sec17"/><span id="toc-link_237"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Updating the Front Controller</span></h4>
<p class="TNI1">Now we need to add a new logout case to the <span class="SANS_TheSansMonoCd_W5Regular_11">switch</span> statement in our <i>index.php</i> front controller. Update the file as shown in <a href="#lis16-20">Listing 16-20</a>.</p>
<span id="lis16-20"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    case 'secured':</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        if (isLoggedIn()) {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            secureBanking();</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        } else {</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            showError('invalid login credentials - try again');</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        }</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        break;</span>&#13;
&#13;
  <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> case 'logout':&#13;
        logout();&#13;
        break;&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    default:</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        home();</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">}</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-20: The</span> <span class="TheSansMonoCd_W5Regular_Italic_11">logout</span> <span class="SANS_Futura_Std_Book_Oblique_11">case in</span> <span class="SANS_Futura_Std_Book_11">index.php</span></p>
<p class="TX">We add a case that invokes that <span class="SANS_TheSansMonoCd_W5Regular_11">logout()</span> function when the <span class="SANS_TheSansMonoCd_W5Regular_11">$action</span> variable has the value <span class="SANS_TheSansMonoCd_W5Regular_11">'logout'</span> <span aria-label="annotation1" class="CodeAnnotation">❶</span>.</p>
</section>
<section aria-labelledby="sec18" epub:type="division">
<h4 class="H2"><span id="sec18"/><span id="toc-link_238"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Displaying the Logout Link</span></h4>
<p class="TNI1">Finally, we need to conditionally decide whether to offer the user a Login link or a Logout link, depending on whether the user is currently logged in. We therefore need to add an <span class="SANS_TheSansMonoCd_W5Regular_11">if</span> statement to the common <i>templates/_header.php</i> file, as shown in <a href="#lis16-21">Listing 16-21</a>.</p>
<span id="lis16-21"/>
<pre><code><span aria-label="321" epub:type="pagebreak" id="pg_321" role="doc-pagebreak"/><span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        &lt;?php if (isLoggedIn()):?&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        &lt;li class="nav-item"&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            &lt;a class="nav-link &lt;?= $securedLink ?&gt;" href="/?action=secured"&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">                Secure Banking</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            &lt;/a&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        &lt;/li&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        &lt;?php endif; ?&gt;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;/ul&gt;</span>&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;ul class="navbar-nav ms-auto p-2"&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        &lt;li class="nav-item"&gt;</span>&#13;
&#13;
      <span aria-label="annotation1" class="Code_CodeAnnotation">❶</span> &lt;?php if (isLoggedIn()): ?&gt;&#13;
            &lt;a class="nav-link" href="/?action=logout"&gt;&#13;
                Logout&#13;
            &lt;/a&gt;&#13;
      <span aria-label="annotation2" class="Code_CodeAnnotation">❷</span> &lt;?php else: ?&gt;&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            &lt;a class="nav-link &lt;?= $loginLink ?&gt;" href="/?action=login"&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">                Login</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">            &lt;/a&gt;</span>&#13;
        &lt;?php endif; ?&gt;&#13;
&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        &lt;/li&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;/ul&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;/header&gt;</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-21: The conditional Login/Logout navigation bar link in</span> <span class="SANS_Futura_Std_Book_11">_header.php</span></p>
<p class="TX">Inside the declaration of an HTML list item with the <span class="SANS_TheSansMonoCd_W5Regular_11">nav-item</span> class, we use an <span class="SANS_TheSansMonoCd_W5Regular_11">if...else</span> statement to test the value returned by the <span class="SANS_TheSansMonoCd_W5Regular_11">isLoggedIn()</span> function. If the user is logged in <span aria-label="annotation1" class="CodeAnnotation">❶</span>, we display the <span class="SANS_TheSansMonoCd_W5Regular_11">/?action=logout</span> link. Otherwise, if the user isn’t logged in <span aria-label="annotation2" class="CodeAnnotation">❷</span>, we display the <span class="SANS_TheSansMonoCd_W5Regular_11">/?action=login</span> link as before.</p>
<p class="TX"><a href="#fig16-6">Figure 16-6</a> shows the navigation bar when the user has successfully logged in and is visiting the secured bank details page.</p>
<figure class="IMG"><a id="fig16-6"/><img alt="" class="img100" height="152" src="../images/figure16-6.jpg" width="1689"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 16-6: The navigation bar showing the Secure Banking and Logout links</span></p></figcaption>
</figure>
<p class="TX">Notice that the Logout link appears on the right instead of the Login link. Additionally, the Secure Banking link in the middle is highlighted, since that’s the page the user is currently viewing.</p>
</section>
</section>
<section aria-labelledby="sec19" epub:type="division">
<h3 class="H1"><span id="sec19"/><span id="toc-link_239"/><span class="SANS_Futura_Std_Bold_B_11">Displaying the Logged-in Username</span></h3>
<p class="TNI1">The final feature we’ll add to our website is to display the username of the logged-in user in the navigation bar, above the <span class="SANS_TheSansMonoCd_W5Regular_11">Logout</span> link. To do this, we need a function to return the username stored in the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array. We’ll <span aria-label="322" epub:type="pagebreak" id="pg_322" role="doc-pagebreak"/>also need to update the shared header template and add extra code to our CSS stylesheet.</p>
<section aria-labelledby="sec20" epub:type="division">
<h4 class="H2"><span id="sec20"/><span id="toc-link_240"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Retrieving the Username</span></h4>
<p class="TNI1">To look up the current user’s username, add the function in <a href="#lis16-22">Listing 16-22</a> to the end of the <i>src/functions.php</i> file.</p>
<span id="lis16-22"/>
<pre><code>function usernameFromSession(): string&#13;
{&#13;
    if (isset($_SESSION['username']))&#13;
        return $_SESSION['username'];&#13;
    else&#13;
        return '';&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-22: The</span> <span class="TheSansMonoCd_W5Regular_Italic_11">usernameFromSession()</span> <span class="SANS_Futura_Std_Book_Oblique_11">function</span></p>
<p class="TX">Here we define the <span class="SANS_TheSansMonoCd_W5Regular_11">usernameFromSession()</span> function. Using <span class="SANS_TheSansMonoCd_W5Regular_11">isset()</span>, we check whether a value can be found in the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array under the <span class="SANS_TheSansMonoCd_W5Regular_11">'username'</span> key. If a value exists, it’s returned. Otherwise, the function returns an empty string.</p>
</section>
<section aria-labelledby="sec21" epub:type="division">
<h4 class="H2"><span id="sec21"/><span id="toc-link_241"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Updating the Navigation Bar</span></h4>
<p class="TNI1">Listing 16-23 shows what we need to add to the navigation bar in the common <i>templates/_header.php</i> file to display the current username as well as the Logout link.</p>
<span id="lis16-23"/>
<pre><code><span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php if (isLoggedIn()):?&gt;</span>&#13;
    &lt;span class="username"&gt;&#13;
        You are logged in as:&#13;
        &lt;strong&gt;&lt;?= usernameFromSession() ?&gt;&lt;/strong&gt;&#13;
    &lt;/span&gt;&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;a class="nav-link" href="/?action=logout"&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">        Logout</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">    &lt;/a&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Grey_11">&lt;?php else: ?&gt;</span>&#13;
<span class="TheSansMonoCd_W5Regular_Italic_11">--snip--</span></code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-23: Displaying the username in</span> <span class="SANS_Futura_Std_Book_11">_header.php</span></p>
<p class="TX">We declare an HTML <span class="SANS_TheSansMonoCd_W5Regular_11">&lt;span&gt;</span> element, styled with the CSS <span class="SANS_TheSansMonoCd_W5Regular_11">username</span> class (which we’ll create next). This displays the text <span class="SANS_TheSansMonoCd_W5Regular_11">You are logged in as:</span> followed by the value returned from the <span class="SANS_TheSansMonoCd_W5Regular_11">usernameFromSession()</span> function. Since we should display this text only when the user is logged in, there will always be a stored username, so <span class="SANS_TheSansMonoCd_W5Regular_11">usernameFromSession()</span> should never return an empty string.</p>
</section>
<section aria-labelledby="sec22" epub:type="division">
<h4 class="H2"><span id="sec22"/><span id="toc-link_242"/><span class="SANS_Futura_Std_Bold_Condensed_Oblique_11">Updating the CSS</span></h4>
<p class="TNI1">Finally, we need to add a CSS rule for the <span class="SANS_TheSansMonoCd_W5Regular_11">username</span> class to <i>public/css/login.css</i>, as shown in <a href="#lis16-24">Listing 16-24</a>. This style rule colors the username text yellow (in contrast with the dark background of the navigation <span aria-label="323" epub:type="pagebreak" id="pg_323" role="doc-pagebreak"/>bar)..<span class="SANS_TheSansMonoCd_W5Regular_11">username {</span></p>
<span id="lis16-24"/>
<pre><code>    color: yellow;&#13;
}</code></pre>
<p class="CodeListingCaption"><span class="SANS_Futura_Std_Book_Oblique_11">Listing 16-24: The</span> <span class="TheSansMonoCd_W5Regular_Italic_11">username</span> <span class="SANS_Futura_Std_Book_Oblique_11">CSS class in</span> <span class="SANS_Futura_Std_Book_11">login.css</span></p>
<p class="TX"><a href="#fig16-7">Figure 16-7</a> shows how the username is displayed in the navigation bar as a result of this CSS declaration.</p>
<figure class="IMG"><a id="fig16-7"/><img alt="" class="img80" height="249" src="../images/figure16-7.jpg" width="1051"/>
<figcaption><p class="CAP"><span class="SANS_Futura_Std_Book_Oblique_11">Figure 16-7: The username and Logout link in the navigation bar</span></p></figcaption>
</figure>
<p class="TX">The text showing the username appears above the Logout link. In this example, I’ve logged in with the username <span class="SANS_TheSansMonoCd_W5Regular_11">matt</span>. This username was successfully stored in the <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION</span> array and then retrieved for display.</p>
</section>
</section>
<section aria-labelledby="sec23" epub:type="division">
<h3 class="H1"><span id="sec23"/><span id="toc-link_243"/><span class="SANS_Futura_Std_Bold_B_11">Summary</span></h3>
<p class="TNI1">In this chapter, we created a front controller–driven website that uses the login form method of authenticating a user’s identity. Although this is a small website with only a few pages, its basic architecture and approach to security mirror the way real-world, secure websites operate. We wrote functions to search for a match between submitted username and password credentials and a stored array of username and password pairs.</p>
<p class="TX">We stored details of a successfully authenticated user in a PHP session to remember when a user has logged in. Then we wrote program logic such as the <span class="SANS_TheSansMonoCd_W5Regular_11">isLoggedIn()</span> function to allow our website to decide whether a user is authorized to view bank details. We used the same logic to decide whether to display a Login or a Logout link in the navigation bar.</p>
</section>
<section aria-labelledby="sec24" epub:type="division">
<h3 class="H1"><span id="sec24"/><span id="toc-link_244"/><span class="SANS_Futura_Std_Bold_B_11">Exercises</span></h3>
<p class="ListNumber">1.   Add a second secured page to the website for this chapter that displays the solution to a math question (<span class="SANS_TheSansMonoCd_W5Regular_11">answer = -2!</span>). In the navigation bar, add a link to the secured page that displays only when a user has successfully logged in.</p>
<p class="ListBody">Hint: You’ll need to add a new case to the <i>index.php</i> front controller and a new function to display the page in <i>functions.php</i>.</p>
<p class="ListNumber">2.   Add two additional authorized users to the system, one with a username of <span class="SANS_TheSansMonoCd_W5Regular_11">fred</span> and a password of <span class="SANS_TheSansMonoCd_W5Regular_11">flintstone</span>, and the other with a username of <span class="SANS_TheSansMonoCd_W5Regular_11">teddy</span> and a password of <span class="SANS_TheSansMonoCd_W5Regular_11">cuddly</span>.</p>
<p class="ListNumber"><span aria-label="324" epub:type="pagebreak" id="pg_324" role="doc-pagebreak"/>3.   Try adding another layer of security to the website by having two user-authentication roles: <span class="SANS_TheSansMonoCd_W5Regular_11">'USER'</span> and <span class="SANS_TheSansMonoCd_W5Regular_11">'BANKER'</span>. Any logged-in user can view the math solution page, but only those with the <span class="SANS_TheSansMonoCd_W5Regular_11">'BANKER'</span> role can view the bank details page. Add two more authorized banker user credentials to the system, one with a username of <span class="SANS_TheSansMonoCd_W5Regular_11">banker1</span> and a password of <span class="SANS_TheSansMonoCd_W5Regular_11">rich</span>, and the other with a username of <span class="SANS_TheSansMonoCd_W5Regular_11">banker2</span> and a password of <span class="SANS_TheSansMonoCd_W5Regular_11">veryrich</span>.</p>
<p class="ListBody">Hint: Try the following:</p>
<p class="ListLetterSub">a.   Just as you have a <span class="SANS_TheSansMonoCd_W5Regular_11">getUsers()</span> function, add a <span class="SANS_TheSansMonoCd_W5Regular_11">getBankers()</span> function.</p>
<p class="ListLetterSub">b.   Rename the <span class="SANS_TheSansMonoCd_W5Regular_11">validLoginCredentials()</span> function to <span class="SANS_TheSansMonoCd_W5Regular_11">validUSERLoginCredentials()</span>.</p>
<p class="ListLetterSub">c.   Write a second version of this function as <span class="SANS_TheSansMonoCd_W5Regular_11">validBANKERLoginCredentials()</span>.</p>
<p class="ListLetterSub">d.   Change the logic in the <span class="SANS_TheSansMonoCd_W5Regular_11">processLogin()</span> function to do the following: If a valid user logs in, store their username in the session and display the home page. If a valid banker logs in, store their username in the session, store their role in the session <span class="SANS_TheSansMonoCd_W5Regular_11">($_SESSION['role'] = 'BANKER')</span>, and display the home page.</p>
<p class="ListLetterSub">e.   Add a new <span class="SANS_TheSansMonoCd_W5Regular_11">getRoleFromSession()</span> function that returns the role found in the session. If a value is found for <span class="SANS_TheSansMonoCd_W5Regular_11">$_SESSION['role']</span>, that string is returned; otherwise, an empty string is returned.</p>
<p class="ListLetterSub">f.   Change the logic in the <i>index.php</i> front controller as follows: For the math solution, check whether a user is logged in. For the bank page, check whether the role of the logged-in user is <span class="SANS_TheSansMonoCd_W5Regular_11">'BANKER'</span>. You could write something like <span class="SANS_TheSansMonoCd_W5Regular_11">getRoleFromSession() == 'BANKER'</span>.</p>
</section>
</section>
</div></body></html>