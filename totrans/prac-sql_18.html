<html><head></head><body><div id="sbo-rt-content"><section>&#13;
<header>&#13;
<h1 class="chapter">&#13;
<span class="ChapterNumber"><span epub:type="pagebreak" title="363" id="Page_363"/>18</span><br/>&#13;
<span class="ChapterTitle">Using PostgreSQL from the Command Line</span></h1>&#13;
</header>&#13;
<figure class="opener">&#13;
<img src="Images/chapterart.png" alt="" width="200" height="200"/>&#13;
</figure>&#13;
<p class="ChapterIntro">In this chapter, you’ll learn how to work with PostgreSQL from the <em>command line</em>, a text-based interface where you enter names of programs or other commands to perform tasks, such as editing files or listing the contents of a file directory.</p>&#13;
<p>The command line—also called a <em>command line interface</em>, a <em>console</em>, a <em>shell</em>, or the <em>terminal</em>—existed long before computers had a graphical user interface (GUI) with menus, icons, and buttons you could click for navigation. Back in college, to edit a file, I had to enter commands into a terminal connected to an IBM mainframe computer. Working that way felt mysterious, as though I’d attained new powers—and I had! Today, even in a GUI world, familiarity with the command line is essential for a programmer moving toward expert-level skills. Perhaps that’s why when a movie wants to convey that a character really knows what they’re doing on a computer, they’re shown typing cryptic, text-only commands.</p>&#13;
<p><span epub:type="pagebreak" title="364" id="Page_364"/>As we learn about this text-only world, pay attention to these advantages of mastering working from the command line instead of a GUI, such as pgAdmin:</p>&#13;
<ul>&#13;
<li>You can often work faster by entering short commands instead of clicking through layers of menu items.</li>&#13;
<li>You gain access to functions that only the command line provides.</li>&#13;
<li>If command line access is all you have to work with (for example, when you’ve connected to a remote computer), you can still get work done.</li>&#13;
</ul>&#13;
<p>We’ll use <code>psql</code>, a command-line tool included with PostgreSQL that lets you run queries, manage database objects, and interact with the computer’s operating system via text command. You’ll learn how to set up and access your computer’s command line and then launch <code>psql</code>. Along the way, we’ll cover general command line syntax and additional commands for database tasks. Patience is key: even experienced experts often resort to documentation to recall the available command line options.</p>&#13;
<h2 id="h1-501065c18-0001">Setting Up the Command Line for psql</h2>&#13;
<p class="BodyFirst">To start, we’ll access the command line on our operating system and, if needed, set an environment variable called <code>PATH</code> that tells our system where to find <code>psql</code>. <em>Environment variables</em> hold parameters that specify system or application configurations, such as where to store temporary files; they also allow you to enable or disable options. The <code>PATH</code> environment variable stores the names of one or more directories containing executable programs, and in this instance will tell the command line interface the location of <code>psql</code>, avoiding the hassle of having to enter its full directory path each time you launch it.</p>&#13;
<h3 id="h2-501065c18-0001">Windows psql Setup </h3>&#13;
<p class="BodyFirst">On Windows, you’ll run <code>psql</code> within the <em>Command Prompt</em>, the application that provides that system’s command line interface. Before we do that, we need to tell Command Prompt where to find <em>psql.exe</em>—the full name of the <code>psql</code> application on Windows.</p>&#13;
<h4 id="h3-501065c18-0001">Adding psql and Utilities to the Windows PATH</h4>&#13;
<p class="BodyFirst">The following steps assume that you installed PostgreSQL according to the instructions described in “Windows Installation” in <span class="xref" itemid="xref_target_Chapter 1">Chapter 1</span>. (If you installed PostgreSQL another way, use the Windows File Explorer to search <span epub:type="pagebreak" title="365" id="Page_365"/>your C: drive to find the directory that holds <em>psql.exe</em>, and then replace <em>C:\Program Files\PostgreSQL\</em>x<em>\bin</em> in the following steps with your own path.)</p>&#13;
<ol class="decimal">&#13;
<li value="1">Open the Windows Control Panel by clicking the <b>Search</b> icon on the Windows taskbar, entering <b>Control Panel</b>, and then clicking the <b>Control Panel</b> icon.</li>&#13;
<li value="2">Inside the Control Panel app, enter <b>Environment</b> in the search box. In the list of search results displayed, click <b>Edit the System Environment Variables</b>. A System Properties dialog should appear.</li>&#13;
<li value="3">In the System Properties dialog, on the Advanced tab, click <b>Environment Variables</b>. The dialog that opens should have two sections: User variables and System variables. In the User variables section, if you don’t see a <code>PATH</code> variable, continue to step a to create a new one. If you do see an existing <code>PATH</code> variable, continue to step b to modify it.&#13;
<ol class="lower-alpha">&#13;
<li value="1">If you don’t see <code>PATH</code> in the User variables section, click <b>New</b> to open a New User Variable dialog, shown in <a href="#figure18-1" id="figureanchor18-1">Figure 18-1</a>.&#13;
<figure>&#13;
<img src="Images/f18001.png" alt="f18001" class="keyline" width="457" height="130"/>&#13;
<figcaption><p><a id="figure18-1">Figure 18-1</a>: Creating a new <span class="LiteralInCaption"><code>PATH</code></span> environment variable in Windows 10</p></figcaption>&#13;
</figure>&#13;
<p class="ListBody">	In the Variable name box, enter <b>PATH</b>. In the Variable value box, enter <b>C:\Program Files\PostgreSQL\</b><b><i>x</i></b><b>\bin</b>, where <em>x</em> is the version of PostgreSQL you’re using. (Instead of typing, you can click <b>Browse Directory</b> and navigate to the directory in the Browse For Folder dialog.) When you’ve either entered the path manually or browsed to it, click <b>OK</b> in all dialogs to close them.</p>&#13;
</li>&#13;
<li value="2">If you do see an existing <code>PATH</code> variable in the User variables section, highlight it and click <b>Edit</b>. In the list of variables that displays, click <b>New</b> and enter <b>C:\Program Files\PostgreSQL\</b><b><i>x</i></b><b>\bin</b>, where <em>x</em> is the version of PostgreSQL you’re using. (Instead of typing, you can click <b>Browse Directory</b> and navigate to the directory in the Browse For Folder dialog.) The result should look like the highlighted line in <a href="#figure18-2" id="figureanchor18-2">Figure 18-2</a>. When you’re finished, click <b>OK</b> in all dialogs to close them.</li>&#13;
</ol>&#13;
</li>&#13;
</ol>&#13;
<p>Now when you launch Command Prompt, the <code>PATH</code> should include the directory. Note that any time you make changes to the <code>PATH</code>, you must close and reopen Command Prompt for the changes to take effect. Next, let’s set up Command Prompt.</p>&#13;
<span epub:type="pagebreak" title="366" id="Page_366"/><figure>&#13;
<img src="Images/f18002.png" alt="f18002" class="keyline" width="551" height="606"/>&#13;
<figcaption><p><a id="figure18-2">Figure 18-2</a>: Editing existing <span class="LiteralInCaption"><code>PATH</code></span> environment variables in Windows 10</p></figcaption>&#13;
</figure>&#13;
<h4 id="h3-501065c18-0002">Launching and Configuring Windows Command Prompt</h4>&#13;
<p class="BodyFirst">Command Prompt is an executable file named <em>cmd.exe</em>. To launch it, select <b>Start</b><span class="MenuArrow">▶</span><b>Windows System</b><span class="MenuArrow">▶</span><b>Command Prompt </b>or enter<b> cmd</b> into the search bar. When the application opens, you should see a window with a black background that displays version and copyright information along with a prompt showing your current directory. On my Windows 10 system, Command Prompt opens to my default user directory and displays <code>C:\Users\adeba&gt;</code>, as shown in <a href="#figure18-3" id="figureanchor18-3">Figure 18-3</a>.</p>&#13;
<p>This line is known as the <em>prompt</em>, and it shows the current working directory. For me, this is my C: drive, which is typically the main hard drive on a Windows system, and the <code>\Users\adeba</code> directory on that drive. The greater-than sign <code>&gt;</code> indicates the area where you enter your commands.</p>&#13;
<aside epub:type="sidebar">&#13;
<div class="top hr"><hr/></div>&#13;
<section class="note">&#13;
<h2><span class="NoteHead">Note</span></h2>&#13;
<p>	For fast access to Command Prompt, you can add it to your Windows taskbar. When Command Prompt is running, right-click its icon on the taskbar and then click <b>Pin to taskbar</b>.</p>&#13;
<div class="bottom hr"><hr/></div>&#13;
</section>&#13;
</aside>&#13;
<span epub:type="pagebreak" title="367" id="Page_367"/><figure>&#13;
<img src="Images/f18003.png" alt="f18003" class="keyline" width="469" height="299"/>&#13;
<figcaption><p><a id="figure18-3">Figure 18-3</a>: My Command Prompt in Windows 10</p></figcaption>&#13;
</figure>&#13;
<p>You can customize the font and colors plus access other settings by clicking the Command Prompt icon at the left of its window bar and selecting <b>Properties</b> from the menu. To make Command Prompt more suited for query output, I recommend setting the window size (on the Layout tab) to a width of at least 80 and a height of 25. For the font, the official PostgreSQL documentation recommends using Lucida Console to properly display all the characters.</p>&#13;
<h4 id="h3-501065c18-0003">Entering Instructions on Windows Command Prompt</h4>&#13;
<p class="BodyFirst">Now you’re ready to enter instructions in Command Prompt. Enter <b>help</b> at the prompt, and press <span class="KeyCaps">enter</span> on your keyboard to see a list of available Windows system commands. You can view information about a command by including its name after <code>help</code>. For example, enter <code class="bold">help time</code> to display information about using the <code>time</code> command to set or view the system time.</p>&#13;
<p>Exploring the full workings of Command Prompt is an enormous topic beyond the scope of this book; however, I encourage you to try some of the commands in <a href="#table18-1" id="tableanchor18-1">Table 18-1</a>, which contains useful frequently used commands that aren’t actually necessary for the exercises in this chapter.</p>&#13;
<figure>&#13;
<figcaption class="TableTitle"><p><a id="table18-1">Table 18-1</a>: Useful Windows Commands</p></figcaption>&#13;
<table id="table-501065c18-0001" border="1">&#13;
<thead>&#13;
<tr>&#13;
<td><b>Command</b></td>&#13;
<td><b>Function</b></td>&#13;
<td><b>Example</b></td>&#13;
<td><b>Action</b></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><code>cd</code></td>&#13;
<td>Change directory</td>&#13;
<td><code>cd C:\my-stuff</code></td>&#13;
<td>Changes to the <em>my-stuff</em> directory on the C: drive</td>&#13;
</tr>&#13;
<tr>&#13;
<td><code>copy</code></td>&#13;
<td>Copy a file</td>&#13;
<td><code>copy C:\my-stuff\song.mp3 C:\Music\song_favorite.mp3</code></td>&#13;
<td>Copies the <em>song.mp3</em> file from <em>my-stuff</em> to a new file called <em>song_favorite.mp3</em> in the <em>Music</em> directory</td>&#13;
</tr>&#13;
<tr>&#13;
<td><code>del</code></td>&#13;
<td>Delete</td>&#13;
<td><code>del *.jpg</code></td>&#13;
<td>Deletes all files with a <em>.jpg</em> extension in the current directory (asterisk wildcard)</td>&#13;
</tr>&#13;
<tr>&#13;
<td><code><span epub:type="pagebreak" title="368" id="Page_368"/>dir</code></td>&#13;
<td>List directory contents</td>&#13;
<td><code>dir /p</code></td>&#13;
<td>Shows directory contents one screen at a time (using the <code>/p</code> option)</td>&#13;
</tr>&#13;
<tr>&#13;
<td><code>findstr</code></td>&#13;
<td>Find strings in text files matching a regular expression</td>&#13;
<td><code>findstr "peach" *.txt</code></td>&#13;
<td>Searches for the text <em>peach</em> in all <em>.txt</em> files in the current directory</td>&#13;
</tr>&#13;
<tr>&#13;
<td><code>mkdir</code></td>&#13;
<td>Make a new directory</td>&#13;
<td><code>makedir C:\my-stuff\Salad</code></td>&#13;
<td>Creates a <em>Salad</em> directory inside the <em>my-stuff</em> directory</td>&#13;
</tr>&#13;
<tr>&#13;
<td><code>move</code></td>&#13;
<td>Move a file</td>&#13;
<td><code>move C:\my-stuff\song.mp3 C:\Music\</code></td>&#13;
<td>Moves the file <em>song.mp3</em> to the <em>C:\Music</em> directory</td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
</figure>&#13;
<p>With your Command Prompt open and configured, you’re ready to roll. Skip ahead to the section <span class="xref" itemid="xref_target_“Working with psql.”">“Working with psql.”</span></p>&#13;
<h3 id="h2-501065c18-0002">macOS psql Setup</h3>&#13;
<p class="BodyFirst">On macOS, you’ll run <code>psql</code> within Terminal, the application that provides access to that system’s command line via one of several <em>shell</em> programs such as <code>bash</code> or <code>zsh</code>. Shell programs on Unix- or Linux-based systems, including macOS, provide not only the command prompt where users enter instructions, but also their own programming language for automating tasks. For example, you can use <code>bash</code> commands to write a program to log in to a remote computer, transfer files, and log out.</p>&#13;
<p>If you followed the Postgres.app setup instructions for macOS in <span class="xref" itemid="xref_target_Chapter 1">Chapter 1</span>—including running the commands at your Terminal—you shouldn’t need additional configuration to use <code>psql</code> and associated commands. Instead, we’ll proceed to launching Terminal.</p>&#13;
<h4 id="h3-501065c18-0004">Launching and Configuring the macOS Terminal</h4>&#13;
<p class="BodyFirst">Launch Terminal by navigating to <b>Applications</b><span class="MenuArrow">▶</span><b>Utilities</b><span class="MenuArrow">▶</span><b>Terminal</b>. When it opens, you should see a window that displays the date and time of your last login followed by a prompt that includes your computer name, current working directory, and username. On my Mac, which is set to the <code>bash</code> shell, the prompt displays as <code>ad:~ anthony$</code> and ends with a dollar sign (<code>$</code>), as shown in <a href="#figure18-4" id="figureanchor18-4">Figure 18-4</a>.</p>&#13;
<p>The tilde (<code>~</code>) represents the system’s home directory, which is <code>/Users/anthony</code>. Terminal doesn’t display the full directory path, but you can see that information at any time by entering the <code>pwd</code> command (short for <em>print working directory</em>) and pressing <span class="KeyCaps">ENTER</span> on your keyboard. The area after the dollar sign is where you enter commands.</p>&#13;
<p>If your Mac is set to another shell such as <code>zsh</code>, your prompt may look different. With <code>zsh</code>, for example, the prompt ends with a percent sign. The particular shell you’re using does not make a difference for these exercises.</p>&#13;
<span epub:type="pagebreak" title="369" id="Page_369"/><figure>&#13;
<img src="Images/f18004.png" alt="f18004" class="" width="553" height="383"/>&#13;
<figcaption><p><a id="figure18-4">Figure 18-4</a>: Terminal command line in macOS</p></figcaption>&#13;
</figure>&#13;
<aside epub:type="sidebar">&#13;
<div class="top hr"><hr/></div>&#13;
<section class="note">&#13;
<h2><span class="NoteHead">Note</span></h2>&#13;
<p>	For fast access to Terminal, add it to your macOS Dock. While Terminal is running, right-click its icon and select <b>Options</b><span class="MenuArrow">▶</span><b>Keep in Dock</b>.</p>&#13;
<div class="bottom hr"><hr/></div>&#13;
</section>&#13;
</aside>&#13;
<p>If you’ve never used Terminal, its default black-and-white color scheme might seem boring. You can change fonts, colors, and other settings by selecting <b>Terminal</b><span class="MenuArrow">▶</span><b>Preferences</b>. To make Terminal bigger to better fit the query output display, I recommend setting the window size (on the Window tab under Profiles) to a width of at least 80 columns and a height of 25 rows. My preferred font (on the Text tab) is Monaco 14, but experiment to find one you like.</p>&#13;
<p>Exploring the full workings of Terminal and related commands is an enormous topic beyond the scope of this book, but take some time to try several commands. <a href="#table18-2" id="tableanchor18-2">Table 18-2</a> lists some useful commonly used commands that aren’t actually necessary for the exercises in this chapter. Enter <code class="bold">man</code> (short for <em>manual</em>) followed by a command name to get help on any command. For example, you can use <code class="bold">man ls</code> to find out how to use the <code>ls</code> command to list directory contents.</p>&#13;
<figure>&#13;
<figcaption class="TableTitle"><p><a id="table18-2">Table 18-2</a>: Useful Terminal Commands</p></figcaption>&#13;
<table id="table-501065c18-0002" border="1">&#13;
<thead>&#13;
<tr>&#13;
<td><b>Command</b></td>&#13;
<td><b>Function</b></td>&#13;
<td><b>Example</b></td>&#13;
<td><b>Action</b></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><code>cd</code></td>&#13;
<td>Change directory</td>&#13;
<td><code>cd /Users/pparker/my-stuff/</code><br/>&#13;
</td>&#13;
<td>Changes to the <em>my-stuff</em> directory </td>&#13;
</tr>&#13;
<tr>&#13;
<td><code>cp</code></td>&#13;
<td>Copy files</td>&#13;
<td><code>cp song.mp3 song_backup.mp3</code></td>&#13;
<td>Copies the file <em>song.mp3</em> to <em>song_backup.mp3</em> in the current directory</td>&#13;
</tr>&#13;
<tr>&#13;
<td><code><span epub:type="pagebreak" title="370" id="Page_370"/>grep</code></td>&#13;
<td>Find strings in a text file matching a regular expression</td>&#13;
<td><code>grep 'us_counties_2010' *.sql</code></td>&#13;
<td>Finds all lines in files with a <em>.sql</em> extension that have the text <em>us_counties_2010</em></td>&#13;
</tr>&#13;
<tr>&#13;
<td><code>ls</code></td>&#13;
<td>List directory contents</td>&#13;
<td><code>ls -al</code></td>&#13;
<td>Lists all files and directories (including hidden) in “long” format</td>&#13;
</tr>&#13;
<tr>&#13;
<td><code>mkdir</code></td>&#13;
<td>Make a new directory</td>&#13;
<td><code>mkdir resumes</code></td>&#13;
<td>Makes a directory named <em>resumes</em> under the current working directory</td>&#13;
</tr>&#13;
<tr>&#13;
<td><code>mv</code></td>&#13;
<td>Move a file</td>&#13;
<td><code>mv song.mp3 /Users/pparker/songs</code></td>&#13;
<td>Moves the file <em>song.mp3</em> from the current directory to a <em>/songs</em> directory under a user directory</td>&#13;
</tr>&#13;
<tr>&#13;
<td><code>rm</code></td>&#13;
<td>Remove (delete) files</td>&#13;
<td><code>rm *.jpg</code></td>&#13;
<td>Deletes all files with a <em>.jpg</em> extension in the current directory (asterisk wildcard)</td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
</figure>&#13;
<p>With your Terminal open and configured, you’re ready to roll. Skip ahead to the section “Working with psql.”</p>&#13;
<h3 id="h2-501065c18-0003">Linux psql Setup</h3>&#13;
<p class="BodyFirst">Recall from “Linux Installation” in <span class="xref" itemid="xref_target_Chapter 1">Chapter 1</span> that methods for installing PostgreSQL vary according to your Linux distribution. Nevertheless, <code>psql</code> is part of the standard PostgreSQL install, and you probably already ran <code>psql</code> commands as part of the installation process via your distribution’s command line terminal application. Even if you didn’t, standard Linux installations of PostgreSQL will automatically add <code>psql</code> to your <code>PATH</code>, so you should be able to access it.</p>&#13;
<p>Launch a terminal application and proceed to the next section, “Working with psql.” On some distributions, such as Ubuntu, you can open a terminal by pressing <span class="KeyCaps">ctrl</span>-<span class="KeyCaps">alt</span>-<span class="KeyCaps">T</span>. Also note that the Mac Terminal commands in <a href="#table18-2">Table 18-2</a> apply to Linux as well and may be useful to you.</p>&#13;
<h2 id="h1-501065c18-0002">Working with psql </h2>&#13;
<p class="BodyFirst">Now that you’ve identified your command line interface and set it up to recognize the location of <code>psql</code>, let’s launch <code>psql</code> and connect to a database on your local installation of PostgreSQL. Then we’ll explore executing queries and special commands for retrieving database information.</p>&#13;
<h3 id="h2-501065c18-0004">Launching psql and Connecting to a Database</h3>&#13;
<p class="BodyFirst">Regardless of the operating system you’re using, you start <code>psql</code> in the same way. Open your command line interface (Command Prompt on Windows, <span epub:type="pagebreak" title="371" id="Page_371"/>Terminal on macOS or Linux). To launch <code>psql</code> and connect to a database, we use the following pattern at the command prompt:</p>&#13;
<pre><code>psql -d <var>database_name</var> -U <var>user_name</var></code></pre>&#13;
<p>Following the <code>psql</code> application name, we provide the database name after a <code>-d</code> database argument and a username after the <code>-U</code> username argument.</p>&#13;
<p>For the database name, we’ll use <code>analysis</code>, which is where we created our tables and other objects for the book’s exercises. For username, we’ll use <code>postgres</code>, which is the default user created during installation. So, to connect to the <code>analysis</code> database on your local server, enter this at the command line:</p>&#13;
<pre><code>psql -d analysis -U postgres</code></pre>&#13;
<p>Note that you can connect to a database on a remote server by specifying the <code>–h</code> argument followed by the hostname. For example, you would use the following line if you were connecting to a database named <code>analysis</code> on a server called <code>example.com</code>:</p>&#13;
<pre><code>psql -d analysis -U postgres -h example.com</code></pre>&#13;
<p>Either way, if you set a password during installation, you should receive a password prompt when <code>psql</code> launches. If so, enter your password. After <code>psql</code> connects to the database, you should then see a prompt that looks like this:</p>&#13;
<pre><code>psql (13.3)&#13;
Type "help" for help.&#13;
&#13;
analysis=#</code></pre>&#13;
<p>Here, the first line lists the version number of <code>psql</code> and the server you’re connected to. Your version will vary depending on when you installed PostgreSQL. The prompt where you’ll enter commands is <code>analysis=#</code>, which refers to the name of the database, followed by an equal sign (<code>=</code>) and a hash mark (<code>#</code>). The hash mark indicates that you’re logged in with <em>superuser</em> privileges, which give you unlimited ability to access and create objects and set up accounts and security. If you’re logged in as a user without superuser privileges, the last character of the prompt will be a greater-than sign (<code>&gt;</code>). As you can see, the user account you logged in with here (<code>postgres</code>) is a superuser.</p>&#13;
<aside epub:type="sidebar">&#13;
<div class="top hr"><hr/></div>&#13;
<section class="note">&#13;
<h2><span class="NoteHead">Note</span></h2>&#13;
<p>	PostgreSQL installations create a default superuser account called <code>postgres</code>. If you’re running Postgres.app on macOS, that installation created an additional superuser account that has your system username and no password.</p>&#13;
<div class="bottom hr"><hr/></div>&#13;
</section>&#13;
</aside>&#13;
<p>Finally, on Windows systems, you may see a warning message after launching <code>psql</code> about the console code page differing from the Windows code page. This is related to a mismatch in character sets between Command Prompt and the rest of the Windows system. For the exercises in this book, <span epub:type="pagebreak" title="372" id="Page_372"/>you can safely ignore that warning. If you prefer, you can eliminate it on a per-session basis by entering the command <code class="bold">cmd.exe /c chcp 1252</code> in your Windows Command Prompt before launching <code>psql</code>.</p>&#13;
<h4 id="h3-501065c18-0005">Getting Help or Exiting</h4>&#13;
<p class="BodyFirst">At the <code>psql</code> prompt, you can get help for both <code>psql</code> and general SQL with a set of <em>meta-commands</em>, detailed in <a href="#table18-3" id="tableanchor18-3">Table 18-3</a>. Meta-commands, which begin with a backslash (<code>\</code>), go beyond offering help—we’ll cover several that return information about the database, let you adjust settings, or process data.</p>&#13;
<figure>&#13;
<figcaption class="TableTitle"><p><a id="table18-3">Table 18-3</a>: Help Commands Within <code>psql</code></p></figcaption>&#13;
<table id="table-501065c18-0003" border="1">&#13;
<thead>&#13;
<tr>&#13;
<td><b>Command</b></td>&#13;
<td><b>Displays</b></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><code>\?</code></td>&#13;
<td>Commands available within <code>psql</code>, such as <code>\dt</code> to list tables.</td>&#13;
</tr>&#13;
<tr>&#13;
<td><code>\? options</code></td>&#13;
<td>Options for use with the <code>psql</code> command, such as <code>-U</code> to specify username.</td>&#13;
</tr>&#13;
<tr>&#13;
<td><code>\? variables</code></td>&#13;
<td>Variables for use with <code>psql</code>, such as <code>VERSION</code> for the current <code>psql</code> version.</td>&#13;
</tr>&#13;
<tr>&#13;
<td><code>\h</code></td>&#13;
<td>List of SQL commands. Add a command name to see detailed help for it (for example, <code>\h INSERT</code>).</td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
</figure>&#13;
<p>Even experienced users often need a refresher on commands and options, so having the details in the <code>psql</code> application is handy. To exit <code>psql</code>, use the meta-command <code>\q</code> (for <em>quit</em>).</p>&#13;
<h4 id="h3-501065c18-0006">Changing the Database Connection</h4>&#13;
<p class="BodyFirst">When working with SQL, it’s not unusual to be working with multiple databases, so you need a way to switch between databases. You can do this easily at the <code>psql</code> prompt using the <code>\c</code> meta-command.</p>&#13;
<p>For example, while connected to your <code>analysis</code> database, at the <code>psql</code> prompt enter the following command to create a database named <code>test</code>:</p>&#13;
<pre><code>analysis=# <b>CREATE DATABASE test;</b></code></pre>&#13;
<p>Then, to connect to the new <code>test</code> database you just created, enter <code class="bold">\c</code> followed by the name of the database at the <code>psql</code> prompt (and provide your PostgreSQL password if asked):</p>&#13;
<pre><code>analysis=# <b>\c test</b></code></pre>&#13;
<p>The application should respond with the following message:</p>&#13;
<pre><code>You are now connected to database "test" as user "postgres".&#13;
test=#</code></pre>&#13;
<p>The prompt will show you which database you’re connected to. To log in as a different user—for example, using a username the macOS <span epub:type="pagebreak" title="373" id="Page_373"/>installation created—you could add that username after the database name. On my Mac, the syntax looks like this:</p>&#13;
<pre><code>analysis-# <b>\c test anthony</b></code></pre>&#13;
<p>The response would be as follows:</p>&#13;
<pre><code>You are now connected to database "test" as user "anthony".&#13;
test=#</code></pre>&#13;
<p>To reduce clutter, you can remove the <code>test</code> database you created. First, use <code>\c</code> to disconnect from <code>test</code> and connect to the <code>analysis</code> database (we can remove a database only if no one is connected to it). Once you’ve connected to <code>analysis</code>, enter <code class="bold">DROP DATABASE test;</code> at the <code>psql</code> prompt.</p>&#13;
<h4 id="h3-501065c18-0007">Setting Up a Password File</h4>&#13;
<p class="BodyFirst">If you’d rather not see a password prompt when starting <code>psql</code>, you can set up a file to store database connection information that includes the server name, your username, and password. On startup, <code>psql</code> will read the file and bypass the password prompt if the file contains an entry that matches the database connection and username.</p>&#13;
<p>On Windows 10, the file must be named <em>pgpass.conf</em> and must reside in the following directory: <span class="KeyCaps">C:\Users</span>\YourUsername<em>\AppData\Roaming\postgresql\</em>. You may need to create the <code>postgresql</code> directory. On macOS and Linux, the file must be named <em>.pgpass</em> and must reside in your user home directory. The documentation at <a href="https://www.postgresql.org/docs/current/libpq-pgpass.html" class="LinkURL">https://www.postgresql.org/docs/current/libpq-pgpass.html</a> notes that on macOS and Linux, you may need to set file permissions after creating the file by running <code>chmod 0600 ~/.pgpass</code> at the command line.</p>&#13;
<p>Create the file using a text editor and save it with the correct name and location for your system. Inside, you’ll need to add a line for each database connection in the following format:</p>&#13;
<pre><code><var>hostname</var>:<var>port</var>:<var>database</var>:<var>username</var>:<var>password</var></code></pre>&#13;
<p>For example, to set up a connection for the <code>analysis</code> database and <code>postgres</code> username, enter this line, substituting your password:</p>&#13;
<pre><code>localhost:5432:analysis:postgres:<var>password</var></code></pre>&#13;
<p>You can substitute an asterisk in any of the first four parameters to serve as a wildcard. For example, to supply a password for any local database with the <code>postgres</code> username, substitute an asterisk for the database name:</p>&#13;
<pre><code>localhost:5432:*:postgres:<var>password</var></code></pre>&#13;
<p>Saving your password will save you some typing, but be mindful of best practices regarding security. Always secure your computer with a strong password and/or physical security key, and don’t create a password file on any public or shared system.</p>&#13;
<h3 id="h2-501065c18-0005"><span epub:type="pagebreak" title="374" id="Page_374"/>Running SQL Queries on psql</h3>&#13;
<p class="BodyFirst">We’ve configured <code>psql</code> and connected to a database, so now let’s run some SQL queries. We’ll start with a single-line query and then run a multiple-line query.</p>&#13;
<p>You enter SQL into <code>psql</code> directly at the prompt. For example, to see a few rows from the 2019 census table we’ve used throughout the book, enter a query at the prompt, as shown in <a href="#listing18-1" id="listinganchor18-1">Listing 18-1</a>.</p>&#13;
<pre><code>analysis=# <b>SELECT county_name FROM us_counties_pop_est_2019 ORDER BY county_name LIMIT 3;</b></code></pre>&#13;
<p class="CodeListingCaption"><a id="listing18-1">Listing 18-1</a>: Entering a single-line query in <code>psql</code></p>&#13;
<p>Press <span class="KeyCaps">enter</span> to execute the query, and <code>psql</code> should display the following results in your terminal in text including the number of rows returned:</p>&#13;
<pre><code>   county_name&#13;
------------------&#13;
 Abbeville County&#13;
 Acadia Parish&#13;
 Accomack County&#13;
(3 rows)&#13;
&#13;
analysis=#</code></pre>&#13;
<p>Below the result, you can see the <code>analysis=#</code> prompt again, ready for further input. You can use the up and down arrows on your keyboard to scroll through recent queries and press <span class="KeyCaps">enter</span> to execute them again, avoiding having to retype them.</p>&#13;
<h4 id="h3-501065c18-0008">Entering a Multiline Query</h4>&#13;
<p class="BodyFirst">You’re not limited to single-line queries. If you have a query that spans multiple lines, you can enter lines one at a time, pressing <span class="KeyCaps">enter</span> after each, and <code>psql</code> knows not execute the query until you provide a semicolon. Let’s reenter the query in <a href="#listing18-1">Listing 18-1</a> over multiple lines, shown in <a href="#listing18-2" id="listinganchor18-2">Listing 18-2</a>.</p>&#13;
<pre><code>analysis=# SELECT county_name&#13;
analysis-# FROM us_counties_pop_est_2019&#13;
analysis-# ORDER BY county_name&#13;
analysis-# LIMIT 3;</code></pre>&#13;
<p class="CodeListingCaption"><a id="listing18-2">Listing 18-2</a>: Entering a multiline query in <code>psql</code></p>&#13;
<p>Note that when your query extends past one line, the symbol between the database name and the hash mark changes from an equal sign to a hyphen. This multiline query executes only when you press <span class="KeyCaps">enter</span> after the final line, which ends with a semicolon.</p>&#13;
<h4 id="h3-501065c18-0009">Checking for Open Parentheses in the psql Prompt</h4>&#13;
<p class="BodyFirst">Another helpful feature of <code>psql</code> is that it shows when you haven’t closed a pair of parentheses. <a href="#listing18-3" id="listinganchor18-3">Listing 18-3</a> shows this in action.</p>&#13;
<pre><code><span epub:type="pagebreak" title="375" id="Page_375"/>analysis=# CREATE TABLE wineries (&#13;
analysis(# id bigint,&#13;
analysis(# winery_name text&#13;
analysis(# );&#13;
CREATE TABLE</code></pre>&#13;
<p class="CodeListingCaption"><a id="listing18-3">Listing 18-3</a>: Showing open parentheses in the <code>psql</code> prompt</p>&#13;
<p>Here, you create a simple table called <code>wineries</code> that has two columns. After entering the first line of the <code>CREATE TABLE</code> statement and an open parenthesis (<code>(</code>), the prompt then changes from <code>analysis=#</code> to <code>analysis(#</code> to include an open parenthesis. This reminds you an open parenthesis needs closing. The prompt maintains that configuration until you add the closing parenthesis.</p>&#13;
<aside epub:type="sidebar">&#13;
<div class="top hr"><hr/></div>&#13;
<section class="note">&#13;
<h2><span class="NoteHead">Note</span></h2>&#13;
<p>	If you have a lengthy query saved in a text file, such as one from this book’s resources, you can copy it to your computer clipboard and paste it into <code>psql</code> (<span class="KeyCaps">ctrl</span>-V on Windows, <span class="KeyCaps">command</span>-V on macOS, and <span class="KeyCaps">shift</span>-<span class="KeyCaps">ctrl</span>-V on Linux). That saves you from typing the whole query. After you paste the query text into <code>psql</code>, press <span class="KeyCaps">enter</span> to execute it.</p>&#13;
<div class="bottom hr"><hr/></div>&#13;
</section>&#13;
</aside>&#13;
<h4 id="h3-501065c18-0010">Editing Queries</h4>&#13;
<p class="BodyFirst">To modify the most recent query you’ve executed in <code>psql</code>, you can edit it using the <code>\e</code> or <code>\edit</code> meta-command. Enter <code class="bold">\e</code> to open the last-executed query in a text editor. The editor <code>psql</code> uses by default depends on your operating system.</p>&#13;
<p>On Windows, <code>psql</code> will open Notepad, a simple GUI text editor. Edit your query, save it by choosing <b>File</b><span class="MenuArrow">▶</span><b>Save</b>, and then exit Notepad using <b>File</b><span class="MenuArrow">▶</span><b>Exit</b>. When Notepad closes, <code>psql</code> should execute your revised query.</p>&#13;
<p>On macOS and Linux, <code>psql</code> uses a command line application called <code>vim</code>, which is a favorite among programmers but can seem inscrutable for beginners. Check out a helpful <code>vim</code> cheat sheet at <a href="https://vim.rtorr.com/" class="LinkURL">https://vim.rtorr.com/</a>. For now, you can use the following steps to make simple edits:</p>&#13;
<ol class="decimal">&#13;
<li value="1">When <code>vim</code> opens the query in your terminal, press I to activate insert mode.</li>&#13;
<li value="2">Make your edits to the query.</li>&#13;
<li value="3">Press <span class="KeyCaps">esc</span> and then <span class="KeyCaps">SHIFT-:</span> to display a colon command prompt at the bottom left of the <code>vim</code> screen, which is where you enter commands to control <code>vim</code>.</li>&#13;
<li value="4">Enter <code class="bold">wq</code> (for <em>write</em>, <em>quit</em>) and press <span class="KeyCaps">enter</span> to save your changes.</li>&#13;
</ol>&#13;
<p>Now when <code>vim</code> exits, the <code>psql</code> prompt should execute your revised query. Press the up-arrow key to see the revised text.</p>&#13;
<h3 id="h2-501065c18-0006">Navigating and Formatting Results</h3>&#13;
<p class="BodyFirst">The query you ran in Listings 18-1 and 18-2 returned only one column and a handful of rows, so its output was contained nicely in your command <span epub:type="pagebreak" title="376" id="Page_376"/>line interface. But for queries with more columns or rows, the output can fill more than one screen, making it difficult to navigate. Fortunately, you have several ways to customize the display style of the output using the <code>\pset</code> meta-command.</p>&#13;
<h4 id="h3-501065c18-0011">Setting Paging of Results</h4>&#13;
<p class="BodyFirst">One way to adjust the output format is to specify how <code>psql</code> handles scrolling through lengthy query results, known as <em>paging</em>. By default, if your results return more rows than will fit on one screen, <code>psql</code> will display the first screen’s worth of rows and then let you scroll through the rest. For example, <a href="#listing18-4" id="listinganchor18-4">Listing 18-4</a> shows what happens at the <code>psql</code> prompt when we remove the <code>LIMIT</code> clause from the query in <a href="#listing18-1">Listing 18-1</a>.</p>&#13;
<pre><code>analysis=# <b>SELECT county_name FROM us_counties_pop_est_2019 ORDER BY county_name;</b>&#13;
&#13;
            county_name&#13;
-----------------------------------&#13;
 Abbeville County&#13;
 Acadia Parish&#13;
 Accomack County&#13;
 Ada County&#13;
 Adair County&#13;
 Adair County&#13;
 Adair County&#13;
 Adair County&#13;
 Adams County&#13;
 Adams County&#13;
 Adams County&#13;
 Adams County&#13;
-- More --</code></pre>&#13;
<p class="CodeListingCaption"><a id="listing18-4">Listing 18-4</a>: A query with scrolling results</p>&#13;
<p>Recall that this table has 3,142 rows. <a href="#listing18-4">Listing 18-4</a> shows only the first 12 on the current screen (the number of visible rows depends on your terminal configuration). On Windows, the indicator <code>-- More --</code> tells you that additional results are available, and you can press <span class="KeyCaps">enter</span> to scroll through them. On macOS and Linux, the indicator will be a colon. Scrolling through a few thousand rows will take a while. Press <span class="KeyCaps">q</span> to exit the results and return to the <code>psql</code> prompt.</p>&#13;
<p>To bypass manual scrolling and have all your results immediately display, you can change the <code>pager</code> setting using the <code>\pset pager</code> meta-command. Run that command at your <code>psql</code> prompt, and it should return the message <code>Pager usage is off</code>. Now when you rerun the query in <a href="#listing18-3">Listing 18-3</a> with the <code>pager</code> setting turned off, you should see results like this:</p>&#13;
<pre><code> <var>--snip--</var>&#13;
 York County&#13;
 York County&#13;
 York County&#13;
<span epub:type="pagebreak" title="377" id="Page_377"/> York County&#13;
 Young County&#13;
 Yuba County&#13;
 Yukon-Koyukuk Census Area&#13;
 Yuma County&#13;
 Yuma County&#13;
 Zapata County&#13;
 Zavala County&#13;
 Ziebach County&#13;
(3142 rows)&#13;
&#13;
analysis=#</code></pre>&#13;
<p>You’re immediately taken to the end of the results without having to scroll. To turn paging back on, run <code>\pset pager</code> again.</p>&#13;
<h4 id="h3-501065c18-0012">Formatting the Results Grid</h4>&#13;
<p class="BodyFirst">You also can use <code>\pset</code> with the following options to format the results:</p>&#13;
<p class="ListHead"><b>border int</b></p>&#13;
<ol class="none">&#13;
<li>Use this option to specify whether the results grid has no border (<code>0</code>), internal lines dividing columns (<code>1</code>), or lines around all cells (<code>2</code>). For example, <code>\pset border 2</code> sets lines around all cells.</li>&#13;
</ol>&#13;
<p class="ListHead"><b>format unaligned</b></p>&#13;
<ol class="none">&#13;
<li>Use the option <code>\pset format unaligned</code> to display the results in lines separated by a delimiter rather than in columns, similar to what you would see in a CSV file. The separator defaults to a pipe symbol (<code>|</code>). You can set a different separator using the <code>fieldsep</code> command. For example, to set a comma as the separator, run <code>\pset fieldsep ','</code>. To revert to a column view, run <code>\pset format aligned</code>. You can use the <code>psql</code> meta-command <code>\a</code> to toggle between aligned and unaligned views.</li>&#13;
</ol>&#13;
<p class="ListHead"><b>footer</b></p>&#13;
<ol class="none">&#13;
<li>Use this option to toggle the results footer, which displays the result row count, on or off.</li>&#13;
</ol>&#13;
<p class="ListHead"><b>null</b></p>&#13;
<ol class="none">&#13;
<li>Use this option to set how <code>psql</code> displays <code>NULL</code> values. By default, they show as blanks. You can run <code>\pset null '(null)'</code> to replace blanks with <code>(null)</code> when the column value is <code>NULL</code>.</li>&#13;
</ol>&#13;
<p>You can explore additional options in the PostgreSQL documentation at <a href="https://www.postgresql.org/docs/current/app-psql.html" class="LinkURL">https://www.postgresql.org/docs/current/app-psql.html</a>. In addition, it’s possible to set up a <em>.psqlrc</em> file on macOS or Linux or a <em>psqlrc.conf</em> file on Windows to hold your configuration preferences and load them each time <code>psql</code> starts. A good example is provided at <a href="https://www.citusdata.com/blog/2017/07/16/customizing-my-postgres-shell-using-psqlrc/" class="LinkURL">https://www.citusdata.com/blog/2017/07/16/customizing-my-postgres-shell-using-psqlrc/</a>.</p>&#13;
<h4 id="h3-501065c18-0013"><span epub:type="pagebreak" title="378" id="Page_378"/>Viewing Expanded Results</h4>&#13;
<p class="BodyFirst">Sometimes, it’s helpful to view results arranged not in the typical table style of rows and columns, but instead in a vertical list. This is useful when the number of columns is too big to fit on-screen in the normal horizontal results grid and also for scanning values in columns row by row. In <code>psql</code>, you can switch to a vertical list view using the <code>\x</code> (for <em>expanded</em>) meta-command. The best way to understand the difference between normal and expanded view is by looking at an example. <a href="#listing18-5" id="listinganchor18-5">Listing 18-5</a> shows the normal display you see when querying the <code>grades</code> table in <span class="xref" itemid="xref_target_Chapter 17">Chapter 17</span> using <code>psql</code>.</p>&#13;
<pre><code>analysis=# SELECT * FROM grades ORDER BY student_id, course_id;&#13;
 student_id | course_id |      course       | grade&#13;
------------+-----------+-------------------+-------&#13;
          1 |         1 | Biology 2         | C&#13;
          1 |         2 | English 11B       | D&#13;
          1 |         3 | World History 11B | C&#13;
          1 |         4 | Trig 2            | B&#13;
(4 rows)</code></pre>&#13;
<p class="CodeListingCaption"><a id="listing18-5">Listing 18-5</a>: Normal display of the <code>grades</code> table query</p>&#13;
<p>To change to the expanded view, enter <code class="bold">\x</code> at the <code>psql</code> prompt, which should display the message <code>Expanded display is on</code>. Then, when you run the same query again, you should see the expanded results, as shown in <a href="#listing18-6" id="listinganchor18-6">Listing 18-6</a>.</p>&#13;
<pre><code>analysis=# SELECT * FROM grades ORDER BY student_id, course_id;&#13;
-[ RECORD 1 ]-----------------&#13;
student_id | 1&#13;
course_id  | 1&#13;
course     | Biology 2&#13;
grade      | C&#13;
-[ RECORD 2 ]-----------------&#13;
student_id | 1&#13;
course_id  | 2&#13;
course     | English 11B&#13;
grade      | D&#13;
-[ RECORD 3 ]-----------------&#13;
student_id | 1&#13;
course_id  | 3&#13;
course     | World History 11B&#13;
grade      | C&#13;
-[ RECORD 4 ]-----------------&#13;
student_id | 1&#13;
course_id  | 4&#13;
course     | Trig 2&#13;
grade      | B</code></pre>&#13;
<p class="CodeListingCaption"><a id="listing18-6">Listing 18-6</a>: Expanded display of the <code>grades</code> table query</p>&#13;
<p>The results appear in vertical blocks separated by record numbers. Depending on your needs and the type of data you’re working with, this format might be easier to read. You can revert to column display by <span epub:type="pagebreak" title="379" id="Page_379"/>entering <code class="bold">\x</code> again at the <code>psql</code> prompt. In addition, setting <code>\x auto</code> will make PostgreSQL automatically display the results in a table or expanded view based on the size of the output.</p>&#13;
<p>Next, let’s explore how to use <code>psql</code> to dig into database information.</p>&#13;
<h3 id="h2-501065c18-0007">Meta-Commands for Database Information</h3>&#13;
<p class="BodyFirst">You can have <code>psql</code> display details about databases, tables, and other objects via a particular set of meta-commands. To see how these work, we’ll explore the meta-command that displays the tables in your database, including how to append a plus sign (<code>+</code>) to the command to expand the output and add an optional pattern to filter the output.</p>&#13;
<p>To see a list of tables, you can enter <code class="bold">\dt</code><code/> at the <code>psql</code> prompt. Here’s a snippet of the output on my system:</p>&#13;
<pre><code>                         List of relations&#13;
 Schema |                  Name                  | Type  |   Owner&#13;
--------+----------------------------------------+-------+-----------&#13;
 public | acs_2014_2018_stats                    | table | anthony&#13;
 public | cbp_naics_72_establishments            | table | anthony&#13;
 public | char_data_types                        | table | anthony&#13;
 public | check_constraint_example               | table | anthony&#13;
 public | crime_reports                          | table | anthony&#13;
 <var>--snip--</var></code></pre>&#13;
<p>This result lists all tables in the current database alphabetically.</p>&#13;
<p>You can filter the output by adding a pattern the database object name must match. For example, use <code>\dt us*</code> to show only tables whose names begin with <code>us</code> (the asterisk acts as a wildcard). The results should look like this:</p>&#13;
<pre><code>                   List of relations&#13;
 Schema |           Name           | Type  |   Owner&#13;
--------+--------------------------+-------+-----------&#13;
 public | us_counties_2019_shp     | table | anthony&#13;
 public | us_counties_2019_top10   | table | anthony&#13;
 public | us_counties_pop_est_2010 | table | anthony&#13;
 public | us_counties_pop_est_2019 | table | anthony&#13;
 public | us_exports               | table | anthony</code></pre>&#13;
<p><a href="#table18-4" id="tableanchor18-4">Table 18-4</a> shows several additional commands you might find helpful, including <code>\l</code>, which lists the databases on your server. Adding a plus sign to each command, as in <code>\dt+</code>, adds more information to the output, including object sizes.</p>&#13;
<figure>&#13;
<figcaption class="TableTitle"><p><a id="table18-4">Table 18-4</a>: Example of <code>psql</code> <code>\d</code> Commands</p></figcaption>&#13;
<table id="table-501065c18-0004" border="1">&#13;
<thead>&#13;
<tr>&#13;
<td><b>Command</b></td>&#13;
<td><b>Displays</b></td>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><code>\d [pattern]</code></td>&#13;
<td>Columns, data types, plus other information on objects</td>&#13;
</tr>&#13;
<tr>&#13;
<td><code>\di [pattern]</code></td>&#13;
<td>Indexes and their associated tables</td>&#13;
</tr>&#13;
<tr>&#13;
<td><code><span epub:type="pagebreak" title="380" id="Page_380"/>\dt [pattern]</code></td>&#13;
<td>Tables and the account that owns them</td>&#13;
</tr>&#13;
<tr>&#13;
<td><code>\du [pattern]</code></td>&#13;
<td>User accounts and their attributes</td>&#13;
</tr>&#13;
<tr>&#13;
<td><code>\dv [pattern]</code></td>&#13;
<td>Views and the account that owns them</td>&#13;
</tr>&#13;
<tr>&#13;
<td><code>\dx [pattern]</code></td>&#13;
<td>Installed extensions</td>&#13;
</tr>&#13;
<tr>&#13;
<td><code>\l [pattern]</code></td>&#13;
<td>Databases</td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
</figure>&#13;
<p>The entire list of commands is available in the PostgreSQL documentation at <a href="https://www.postgresql.org/docs/current/app-psql.html" class="LinkURL">https://www.postgresql.org/docs/current/app-psql.html</a>, or you can see details by using the <code>\?</code> command noted earlier.</p>&#13;
<h3 id="h2-501065c18-0008">Importing, Exporting, and Using Files</h3>&#13;
<p class="BodyFirst">In this section, we’ll explore how to use <code>psql</code> to import and export data from the command line, which can be necessary when you’re connected to remote servers, such as Amazon Web Services instances of PostgreSQL. We’ll also use <code>psql</code> to read and execute SQL commands stored in a file and learn the syntax for sending <code>psql</code> output to a file.</p>&#13;
<h4 id="h3-501065c18-0014">Using \copy for Import and Export</h4>&#13;
<p class="BodyFirst">In <span class="xref" itemid="xref_target_Chapter 5">Chapter 5</span>, you learned how to use the PostgreSQL <code>COPY</code> command to import and export data. It’s a straightforward process, but it has one significant limitation: the file you’re importing or exporting must be on the same machine as the PostgreSQL server. That’s fine if you’re working on your local machine, as you’ve been doing with these exercises. But if you’re connecting to a database on a remote computer, you might not have access to its file system. You can get around this restriction by using the <code>\copy</code> meta-command in <code>psql</code>.</p>&#13;
<p>The <code>\copy</code> meta-command works just like the PostgreSQL <code>COPY</code>, except when you execute it at the <code>psql</code> prompt, it will route data from your machine to the server you’re connected to, whether local or remote. We won’t actually connect to a remote server to try this since it’s rare to find a public remote server we could connect to, but you can still learn the syntax by using the commands on our local <code>analysis</code> database.</p>&#13;
<p>In <a href="#listing18-7" id="listinganchor18-7">Listing 18-7</a>, at the <code>psql</code> prompt we use a <code>DELETE</code> statement to remove all the rows from the small <code>state_regions</code> table you created in <span class="xref" itemid="xref_target_Chapter 10">Chapter 10</span> and then import data using <code>\copy</code>. You’ll need to change the file path to match the location of the file on your computer.</p>&#13;
<pre><code>analysis=# DELETE FROM state_regions;&#13;
DELETE 56&#13;
analysis=# \copy state_regions FROM '<var>C:\YourDirectory\</var>state_regions.csv' WITH (FORMAT CSV, HEADER);&#13;
COPY 56</code></pre>&#13;
<p class="CodeListingCaption"><a id="listing18-7">Listing 18-7</a>: Importing data using <code>\copy</code></p>&#13;
<p><span epub:type="pagebreak" title="381" id="Page_381"/>Next, to import the data, we use <code>\copy</code> with the same syntax used with PostgreSQL <code>COPY</code>, including a <code>FROM</code> clause with the file path on your machine, and a <code>WITH</code> clause that specifies the file is a CSV and has a header row. When you execute the statement, the server should respond with <code>COPY 56</code>, letting you know the rows have been successfully imported.</p>&#13;
<p>If you’re connected to a remote server via <code>psql</code>, you would use the same <code>\copy</code> syntax, and the command would route your local file to the remote server for importing. In this example, we used <code>\copy FROM</code> to import a file. We could also use <code>\copy TO</code> for exporting. Let’s look at an alternate way to import or export data (or run other SQL commands) via <code>psql</code>.</p>&#13;
<h4 id="h3-501065c18-0015">Passing SQL Commands to psql</h4>&#13;
<p class="BodyFirst">By placing a command in quotes after the <code>-c</code> argument, we can send it to our connected server, local or remote. The command can be a single SQL statement, multiple SQL statements separated by semicolons, or a meta-command. This can allow us to run <code>psql</code>, connect to a server, and execute a command in a single command line statement—handy if we want to incorporate <code>psql</code> statements into shell scripts to automate tasks.</p>&#13;
<p>For example, we can import data to the <code>state_regions</code> table with the statement in <a href="#listing18-8" id="listinganchor18-8">Listing 18-8</a>, which must be entered on one line at your command prompt (and not inside <code>psql</code>).</p>&#13;
<pre><code>psql -d analysis -U postgres -c<span class="CodeAnnotation" aria-label="annotation1">1</span> 'COPY state_regions FROM STDIN<span class="CodeAnnotation" aria-label="annotation2">2</span> WITH (FORMAT CSV, HEADER);' &lt;<span class="CodeAnnotation" aria-label="annotation3">3</span> <var>C:\YourDirectory\</var>state_regions.csv</code></pre>&#13;
<p class="CodeListingCaption"><a id="listing18-8">Listing 18-8</a>: Importing data using <code>psql</code> with <code>COPY</code></p>&#13;
<p>To try it, you’ll need to first run <code>DELETE FROM state_regions;</code> inside <code>psql</code> to clear the table. Then exit <code>psql</code> by typing the meta-command <code>\q</code>.</p>&#13;
<p>At your command prompt, enter the statement in <a href="#listing18-8">Listing 18-8</a>. We first use <code>psql</code> and the <code>-d</code> and <code>-U</code> commands to connect to your <code>analysis</code> database. Then comes the <code>-c</code> command <span class="CodeAnnotation" aria-label="annotation1">1</span>, which we follow with the PostgreSQL statement for importing the data. The statement is similar to <code>COPY</code> statements we’ve used with one exception: after <code>FROM</code>, we use the keyword <code>STDIN</code> <span class="CodeAnnotation" aria-label="annotation2">2</span> instead of the complete file path and filename. <code>STDIN</code> means “standard input,” which is a stream of input data that can come from a device, a keyboard, or in this case the file <em>state_regions.csv</em>, which we direct <span class="CodeAnnotation" aria-label="annotation3">3</span> to <code>psql</code> using the less-than (<code>&lt;</code>) symbol. You’ll need to supply the full path to the file.</p>&#13;
<p>Running this entire command at your command prompt should import the CSV file and generate the message <code>COPY 56</code>.</p>&#13;
<h4 id="h3-501065c18-0016">Saving Query Output to a File</h4>&#13;
<p class="BodyFirst">It’s sometimes helpful to save the query results and messages generated during a <code>psql</code> session to a file, such as to keep a history of your work or to use the output in a spreadsheet or other application. To send query output to a file, you can use the <code>\o</code> meta-command along with the full path and name of an output file that <code>psql</code> will create.</p>&#13;
<aside epub:type="sidebar">&#13;
<div class="top hr"><hr/></div>&#13;
<section class="note">&#13;
<span epub:type="pagebreak" title="382" id="Page_382"/><h2><span class="NoteHead">Note</span></h2>&#13;
<p>	On Windows, file paths for the <code>\o</code> command must use either Linux-style forward slashes, such as <code>C:/my-stuff/my-file.txt</code>, or double backslashes, such as <code>C:\\my-stuff\\my-file.txt</code>.</p>&#13;
<div class="bottom hr"><hr/></div>&#13;
</section>&#13;
</aside>&#13;
<p>For example, in <a href="#listing18-9" id="listinganchor18-9">Listing 18-9</a> we change the <code>psql</code> format style from a table to CSV and then output query results directly to a file.</p>&#13;
<pre><code><span class="CodeAnnotationHang" aria-label="annotation1">1</span> analysis=# \pset format csv&#13;
Output format is csv.&#13;
&#13;
analysis=# SELECT * FROM grades ORDER BY student_id, course_id;&#13;
<span class="CodeAnnotationHang" aria-label="annotation2">2</span> student_id,course_id,course,grade&#13;
1,1,Biology 2,F&#13;
1,2,English 11B,D&#13;
1,3,World History 11B,C&#13;
1,4,Trig 2,B&#13;
&#13;
<span class="CodeAnnotationHang" aria-label="annotation3">3</span> analysis=# \o '<var>C:/YourDirectory/</var>query_output.csv'&#13;
&#13;
analysis=# SELECT * FROM grades ORDER BY student_id, course_id;&#13;
<span class="CodeAnnotationHang" aria-label="annotation4">4</span> analysis=#</code></pre>&#13;
<p class="CodeListingCaption"><a id="listing18-9">Listing 18-9</a>: Saving query output to a file</p>&#13;
<p>First, we set the output format <span class="CodeAnnotation" aria-label="annotation1">1</span> using the meta-command <code>\pset format csv</code>. When you run a simple <code>SELECT</code> on the <code>grades</code> table, the output <span class="CodeAnnotation" aria-label="annotation2">2</span> should return as values separated by commas. Next, to send that data to a file the next time you run the query, use the <code>\o</code> meta-command and then provide a complete path to a file called <code>query_output.csv</code> <span class="CodeAnnotation" aria-label="annotation3">3</span>. When you run the <code>SELECT</code> query again, there should be no output to the screen <span class="CodeAnnotation" aria-label="annotation4">4</span>. Instead, you’ll find a file with the contents of the query in the directory specified at <span class="CodeAnnotation" aria-label="annotation3">3</span>.</p>&#13;
<p>Note that every time you run a query from this point, the output is appended to the same file specified after the <code>\o</code> (for <em>output</em>) command. To stop saving output to that file, you can either specify a new file or enter <code class="bold">\o</code> with no filename to resume having results output to the screen.</p>&#13;
<h4 id="h3-501065c18-0017">Reading and Executing SQL Stored in a File</h4>&#13;
<p class="BodyFirst">To run SQL stored in a text file, you execute <code>psql</code> on the command line and supply the filename after an <code>-f</code> (for file) argument. This syntax lets you quickly run a query or table update from the command line or in conjunction with a system scheduler to run a job at regular intervals.</p>&#13;
<p>Let’s say you saved the <code>SELECT</code> query from <a href="#listing18-9">Listing 18-9</a> in a file called <em>display-grades.sql</em>. To run the saved query, use the following <code>psql</code> syntax at your command line:</p>&#13;
<pre><code>psql -d analysis -U postgres -f <var>C:\YourDirectory\</var>display-grades.sql</code></pre>&#13;
<p>When you press <span class="KeyCaps">enter</span>, <code>psql</code> should launch, run the stored query in the file, display the results, and exit. For repetitive tasks, this workflow can save considerable time because you avoid launching pgAdmin or rewriting <span epub:type="pagebreak" title="383" id="Page_383"/>a query. You also can stack multiple queries in the file so they run in succession, which, for example, you might do if you want to run several updates on your database.</p>&#13;
<h2 id="h1-501065c18-0003">Additional Command Line Utilities to Expedite Tasks</h2>&#13;
<p class="BodyFirst">PostgreSQL also has its own set of command line utilities that you can enter in your command line interface without launching <code>psql</code>. A listing is available at <a href="https://www.postgresql.org/docs/current/reference-client.html" class="LinkURL">https://www.postgresql.org/docs/current/reference-client.html</a>, and I’ll explain several in <span class="xref" itemid="xref_target_Chapter 19">Chapter 19</span> that are specific to database maintenance. Here I’ll cover two that are particularly useful: creating a database at the command line with the <code>createdb</code> utility and loading shapefiles into a PostGIS database via the <code>shp2pgsql</code> utility.</p>&#13;
<h3 id="h2-501065c18-0009">Adding a Database with createdb</h3>&#13;
<p class="BodyFirst">Earlier in the chapter, you used <code>CREATE DATABASE</code> to add the database <code>test</code> to your PostgreSQL server. We can achieve the same thing using <code>createdb</code> at the command line. For example, to create a new database on your server named <code>box_office</code>, run the following at your command line:</p>&#13;
<pre><code>createdb -U postgres -e box_office</code></pre>&#13;
<p>The <code>-U</code> argument tells the command to connect to the PostgreSQL server using the <code>postgres</code> account. The <code>-e</code> argument (for <em>echo</em>) prints the commands generated by <code>createdb</code> as output. Running this command creates the database and prints output to the screen ending with <code>CREATE DATABASE box_office;</code>. You can then connect to the new database via <code>psql</code> using the following line:</p>&#13;
<pre><code>psql -d box_office -U postgres</code></pre>&#13;
<p>The <code>createdb</code> command accepts arguments to connect to a remote server (just like <code>psql</code> does) and to set options for the new database. A full list of arguments is available at<em> </em><a href="https://www.postgresql.org/docs/current/app-createdb.html" class="LinkURL">https://www.postgresql.org/docs/current/app-createdb.html</a>. Again, the <code>createdb</code> command is a time-saver that comes in handy when you don’t have access to a GUI.</p>&#13;
<h3 id="h2-501065c18-0010">Loading Shapefiles with shp2pgsql</h3>&#13;
<p class="BodyFirst">In <span class="xref" itemid="xref_target_Chapter 15">Chapter 15</span>, you learned about shapefiles, which contain data describing spatial objects. On Windows and some Linux distributions, you can import shapefiles into a PostGIS-enabled database using the Shapefile Import/Export Manager GUI tool (generally) included with PostGIS. However, the Shapefile Import/Export Manager is not always included with PostGIS on macOS or some flavors of Linux. In those cases (or if you’d rather work at the command line), you can import a shapefile using the PostGIS command line tool <code>shp2pgsql</code>.</p>&#13;
<p><span epub:type="pagebreak" title="384" id="Page_384"/>To import a shapefile into a new table from the command line, use the following syntax:</p>&#13;
<pre><code>shp2pgsql -I -s <var>SRID</var> -W <var>encoding shapefile_name</var> <var>table_name</var> | psql -d <var>database</var> -U <var>user</var></code></pre>&#13;
<p>A lot is happening in this single line. Here’s a breakdown of the arguments (if you skipped <span class="xref" itemid="xref_target_Chapter 15">Chapter 15</span>, you might need to review it now):</p>&#13;
<ol class="none">&#13;
<li><span class="RunInHead"><span class="LiteralBold"><code>-I</code></span></span>  Uses GiST to add an index on the new table’s geometry column.</li>&#13;
<li><span class="RunInHead"><span class="LiteralBold"><code>-s</code></span></span>  Lets you specify an SRID for the geometric data.</li>&#13;
<li><span class="RunInHead"><span class="LiteralBold"><code>-W</code></span></span>  Lets you specify encoding. (Recall that we used <code>Latin1</code> for census shapefiles.)</li>&#13;
<li><span class="RunInHead"><span class="LiteralBold"><code>shapefile_name</code></span></span>  The name (including full path) of the file ending with the <em>.shp</em> extension.</li>&#13;
<li><span class="RunInHead"><span class="LiteralBold"><code>table_name</code></span></span>  The name of the table the shapefile is imported to.</li>&#13;
</ol>&#13;
<p>Following these arguments, you place a pipe symbol (<code>|</code>) to direct the output of <code>shp2pgsql</code> to <code>psql</code>, which has the arguments for naming the database and user. For example, to load the <em>tl_2019_us_county.shp</em> shapefile into a <code>us_counties_2019_shp</code> table in the <code>analysis</code> database, you can run the following command. Note that although this command wraps onto two lines here, it should be entered as one line in the command line:</p>&#13;
<pre><code>shp2pgsql -I -s 4269 -W Latin1 tl_2019_us_county.shp us_counties_2019_shp | psql -d analysis -U postgres</code></pre>&#13;
<p>The server should respond with a number of SQL <code>INSERT</code> statements before creating the index and returning you to the command line. It might take some time to construct the entire set of arguments the first time around, but after you’ve done one, subsequent imports should take less time. You can simply substitute file and table names into the syntax you already wrote.</p>&#13;
<h2 id="h1-501065c18-0004">Wrapping Up</h2>&#13;
<p class="BodyFirst">Feeling mysterious and powerful yet? Indeed, when you delve into a command line interface and make the computer do your bidding using text commands, you enter a world of computing that resembles a sci-fi movie sequence. Not only does working from the command line save you time, it also helps you overcome barriers you might hit when working in environments that don’t support graphical tools. In this chapter, you learned the basics of working with the command line plus PostgreSQL specifics. You discovered your operating system’s command line application and set it up to work with <code>psql</code>. Then you connected <code>psql</code> to a database and learned how to run SQL queries via the command line. Many experienced computer users prefer to use the command line for its simplicity and speed once they become familiar with using it. You might, too.</p>&#13;
<p><span epub:type="pagebreak" title="385" id="Page_385"/>In <span class="xref" itemid="xref_target_Chapter 19">Chapter 19</span>, we’ll review common database maintenance tasks including backing up data, changing server settings, and managing the growth of your database. These tasks will give you more control over your working environment and help you better manage your data analysis projects.</p>&#13;
<aside epub:type="sidebar">&#13;
<div class="top hr"><hr/></div>&#13;
<section class="box">&#13;
<h2>Try It Yourself</h2>&#13;
<p class="BoxBodyFirst">To reinforce the techniques in this chapter, choose an example from an earlier chapter and try working through it using only the command line. <span class="xref" itemid="xref_target_Chapter 15">Chapter 15</span>, “Analyzing Spatial Data with PostGIS,” is a good choice because it gives you the opportunity to work with <code>psql</code> and the shapefile loader <code>shp2pgsql</code>. That said, I encourage you to choose any example that you think you would benefit from reviewing.</p>&#13;
<div class="bottom hr"><hr/></div>&#13;
</section>&#13;
</aside>&#13;
</section>&#13;
</div></body></html>