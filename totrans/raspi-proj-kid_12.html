<html><head></head><body>
<h2 class="h2" id="ch12"><span epub:type="pagebreak" id="page_203"/>12<br/>SMART PLUGS FOR SMART HOME HACKS</h2>&#13;
<p class="noindent"><span class="big1">IN THIS CHAPTER, YOU’LL LEARN TO CONTROL YOUR ELECTRONICS REMOTELY THROUGH YOUR PHONE. TO DO THIS, YOU’LL COMBINE YOUR RASPBERRY PI WITH AN ENERGENIE SMART PLUG THAT ALLOWS YOU TO CONTROL THE POWER FLOWING THROUGH THOSE ELECTRONICS VIA A SINGLE TAP ON YOUR MOBILE PHONE.</span></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_204"/>You will be able to use the completed project to turn on a bedroom lamp, a kettle, the TV, some party lights, or anything else that can turned on by simply plugging it in! <a href="ch12.xhtml#ch12fig01">Figure 12-1</a> shows the Energenie smart plug. The plug is controlled by the Pi-mote, a small board that attaches to your Pi and enables you to turn the plug on or off.</p>&#13;
<div class="image"><img alt="Image" src="../images/12fig01.jpg"/></div>&#13;
<p class="figcap" id="ch12fig01"><strong>FIGURE 12-1</strong> The Energenie smart plug and remote board (Pi-mote) attached to a Raspberry Pi</p>&#13;
<div class="note">&#13;
<p class="notet"><strong>NOTE</strong></p>&#13;
<p class="notep"><em>The mobile phone control section of the project works only with Android devices</em>.</p>&#13;
</div>&#13;
<h3 class="h3" id="ch12lev1sec1">WHAT YOU’LL NEED</h3>&#13;
<p class="noindent">Here are the items you’ll need for the project:</p>&#13;
<ul>&#13;
<li class="noindent">Raspberry Pi</li>&#13;
<li class="noindent">Mobile phone or tablet (Android)</li>&#13;
<li class="noindent">Energenie Pi-mote</li>&#13;
<li class="noindent">Energenie smart plug</li>&#13;
<li class="noindent">UK to US adapter plug</li>&#13;
</ul>&#13;
<p class="indent">In the United States, you can find the Pi-mote and plugs at a number of websites by searching “Energenie Pi-mote control with two remotes” or using the product code ENER002-2PI.</p>&#13;
<p class="indent">Energenie supplies directly to 220-Electronics (<em><a href="https://www.220-electronics.com/pi-mote-remote-control-outlet-starter-kit-with-2-sockets.html">https://www.220-electronics.com/pi-mote-remote-control-outlet-starter-kit-with-2-sockets.html</a></em>), which is based in the US and ships worldwide.</p>&#13;
<p class="indent">Plugs are also supplied and sold at the following retailers:</p>&#13;
<ul>&#13;
<li class="noindent"><em><a href="http://www.rapidonline.com/">http://www.rapidonline.com/</a></em></li>&#13;
<li class="noindent"><em><a href="http://www.cpc.farnell.com/">http://www.cpc.farnell.com/</a></em></li>&#13;
<li class="noindent"><em><a href="http://www.newark.com/">http://www.newark.com/</a></em></li>&#13;
</ul>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_205"/>If you can’t find Pi-mote anywhere else, you can try eBay.</p>&#13;
<p class="indent">In the United Kingdom, you can buy the Pi-mote directly from Energenie at <em><a href="https://energenie4u.co.uk/">https://energenie4u.co.uk/</a></em>. Pimoroni (<em><a href="https://shop.pimoroni.com/">https://shop.pimoroni.com/</a></em>) and Amazon also carry it.</p>&#13;
<h3 class="h3" id="ch12lev1sec2">SETTING UP THE ENERGENIE REMOTE PLUG</h3>&#13;
<p class="noindent">As technology advances, you can control more and more electrical devices without leaving your seat via your phone or tablet. For example, you can adjust your central heating from websites, switch on the oven from an app, and open your garage door automatically as your car approaches.</p>&#13;
<p class="indent">Many of these kinds of controls use a <em>relay</em>, a switch that turns circuits on and off. A <em>circuit</em> is a flow of current around a connected set of wires that are attached to pieces of hardware (for example, a motor, lamp, or buzzer). The Energenie company has created a set of safe and easy-to-use relay plugs that you can control directly from your Raspberry Pi. By turning these relays on or off, you turn the appliance or hardware connected to the plug on or off.</p>&#13;
<p class="indent">To use the Energenie plug, you slot a small controller board, the Pi-mote, onto the Raspberry Pi to enable you to toggle the plug to switch on or off. The plug works within a range of up to 30 m and through doors, walls, and ceilings. Does this project sound exciting? Let’s get started. First, you’ll make sure your plug works:</p>&#13;
<ol>&#13;
<li class="noindent"><strong>Test the plug:</strong> Plug your Energenie plug into a power outlet. Switch on the outlet to provide power to the Energenie plug. Plug a lamp into the Energenie plug, and turn on the lamp. Press the green button on the plug to switch it on. You should hear a distinctive <em>click</em>, which is the sound of the relay inside closing the circuit as it turns on. When you press the green button, the relay closes and connects the circuit inside the plug, and electricity flows to the lamp. Because the lamp is switched on, the bulb will light up.</li>&#13;
<li class="noindent"><strong>Attach the Pi-mote:</strong> Ensure that your Raspberry Pi is off and the power supply to your Raspberry Pi is removed. It doesn’t matter whether your smart plug power is on or off. Attach the Pi-mote (the L-shaped board) to the top row of GPIO pins so the L shape of the board faces inward, toward the HDMI port, as shown in <a href="ch12.xhtml#ch12fig02">Figure 12-2</a>. Press the board on firmly so it makes contact with the GPIO pins and fits securely.&#13;
<div class="image"><img alt="Image" src="../images/12fig02.jpg"/></div>&#13;
<p class="figcap" id="ch12fig02"><strong>FIGURE 12-2</strong> <span epub:type="pagebreak" id="page_206"/>Attaching the Pi-mote to your Pi</p></li>&#13;
<li class="noindent"><strong>Install the software:</strong> Before you can create the program to run the plug and Pi, you need to install the required Python libraries that will allow you to interact with the plug. Open the terminal window and enter the following two lines of code, pressing <span class="small">ENTER</span> after each line:&#13;
<pre><span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span> <span class="codestrong1">sudo apt-get install python3-pip</span>&#13;
<span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span> <span class="codestrong1">sudo pip3 install energenie</span></pre>&#13;
<p class="indent">After the installation completes, reboot your Raspberry Pi by entering this command:</p>&#13;
<pre><span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span> <span class="codestrong1">sudo reboot</span></pre>&#13;
</li></ol>&#13;
<h3 class="h3" id="ch12lev1sec3">TESTING THE LAMP</h3>&#13;
<p class="noindent">You’ll create a simple program to test that the Energenie plug and the Raspberry Pi are communicating with each other.</p>&#13;
<h4 class="h4" id="ch12lev2sec1">Controlling the Lamp Remotely</h4>&#13;
<p class="noindent">The simple program you’ll use will turn on the plug, which will then turn on the lamp. Make sure your lamp is still plugged into the Energenie plug that you’ve inserted into the electrical outlet and that the lamp switch is on. Leave the power to the plug switched on, and if the lamp turns on, the relay is closed. Then press the green button on the Energenie plug to turn it off. Open your Python editor and start a new file. Enter the following code and save the file as <em>plug_test.py</em>.</p>&#13;
<pre><span epub:type="pagebreak" id="page_207"/><span class="ent">❶</span> <span class="codeorg">from</span> energenie <span class="codeorg">import</span> switch_on&#13;
<span class="ent">❷</span> switch_on()</pre>&#13;
<p class="indent">The program begins by importing the <code>switch_on</code> class <span class="ent">❶</span>, which, as you can probably work out, is the program function to switch on the plug.</p>&#13;
<p class="indent">On the next line, call the <code>switch_on()</code> function <span class="ent">❷</span>, which triggers the Pi to send a message from the Pi-mote to the plug, switching it on. Press <strong>F5</strong> to execute the code. Your plug will switch on, and the lamp will turn on. That’s pretty cool.</p>&#13;
<p class="indent">To turn off the plug, change the code in your Python program to the following:</p>&#13;
<pre><span class="codeorg">from</span> energenie <span class="codeorg">import</span> switch_off&#13;
switch_off()</pre>&#13;
<p class="indent">Save this program and run it again; the lamp should turn off! This code also imports the <code>switch_off()</code> function and then calls the function to switch off the plug.</p>&#13;
<h4 class="h4" id="ch12lev2sec2">Flashing the Lamp On and Off</h4>&#13;
<p class="noindent">As a final test, you’ll combine the two preceding programs and add a short delay to make the lamp flash on and off. Technically, you’re not flashing the lamp but simply switching the plug on and off every 5 seconds. In a new Python file, add the program code in <a href="ch12.xhtml#ch12ex01">Listing 12-1</a> and save it as <em>plug_flash.py</em>.</p>&#13;
<pre><span class="ent">❶</span> <span class="codeorg">import</span> time&#13;
<span class="ent">❷</span> <span class="codeorg">from</span> energenie <span class="codeorg">import</span> switch_on, switch_off&#13;
&#13;
<span class="ent">❸</span> <span class="codeorg">while True</span>:&#13;
    <span class="ent">❹</span> switch_on()   <span class="codered"># add the socket number between the parentheses</span>&#13;
    <span class="ent">❺</span> time.sleep(5)&#13;
    <span class="ent">❻</span> switch_off()&#13;
    <span class="ent">❼</span> time.sleep(5)</pre>&#13;
<p class="caption"><a id="ch12ex01"/><strong>LISTING 12-1</strong> Switching the plug on and off</p>&#13;
<p class="indent">The program begins by importing the <code>time</code> module <span class="ent">❶</span> so you can add a delay between the plug switching on and off. Then you import the <code>switch_on()</code> and <code>switch_off()</code> functions <span class="ent">❷</span>.</p>&#13;
<p class="indent">Next, use a <code>while True</code> loop to keep the next lines of the program running continuously <span class="ent">❸</span>. Then use the imported functions to switch on the plug <span class="ent">❹</span>, pause for 5 seconds <span class="ent">❺</span>, and then switch off the plug <span class="ent">❻</span>.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_208"/>The last line of code <span class="ent">❼</span> adds another 5-second delay. Otherwise, there would be no delay between the plug switching off and then back on again: the lamp would switch on for 5 seconds, then off, and immediately back on again.</p>&#13;
<p class="indent">Save the code and then run the program. Your lamp should flash on and off every 5 seconds.</p>&#13;
<p class="indent">After testing the program, stop it by pressing <span class="small">CTRL-C</span>.</p>&#13;
<h3 class="h3" id="ch12lev1sec4">USING AN APP TO CONTROL THE PLUG</h3>&#13;
<p class="noindent">Using Python programs to control household appliances is cool. But even better, you can use an app that lets you tap a button to control the smart plug. <em>Blue Dot</em> is a super simple Android app that lets you interact with LEDs, motors, and other components, including the Energenie plugs, via a large blue dot on your mobile phone or tablet device, as shown in <a href="ch12.xhtml#ch12fig03">Figure 12-3</a>. The app uses Bluetooth to enable your device and the Raspberry Pi to communicate, giving you a range of about 10 m. You can think of your device as a handheld remote control for your lamp.</p>&#13;
<div class="image"><img alt="Image" src="../images/12fig03.jpg"/></div>&#13;
<p class="figcap" id="ch12fig03"><strong>FIGURE 12-3</strong> The Blue Dot app</p>&#13;
<ol>&#13;
<li class="noindent"><span epub:type="pagebreak" id="page_209"/><strong>Set up Blue Dot on your Raspberry Pi:</strong> You’ll begin by installing the required Python libraries on your Pi. Open the terminal window and enter the following commands:&#13;
<pre><span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span> <span class="codestrong1">sudo apt install python3-dbus</span>&#13;
<span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span> <span class="codestrong1">sudo pip3 install bluedot</span>&#13;
<span class="codegreen">pi@raspberrypi</span>:- <span class="codeblue">$</span> <span class="codestrong1">sudo pip3 install bluedot --upgrade</span></pre>&#13;
</li>&#13;
<li class="noindent"><strong>Install the app:</strong> While the Python libraries are installing, unlock your mobile phone or tablet device (remember that this works for only Android devices) and head over to the Google Play Store. In the store, search for the Blue Dot App, which should look like <a href="ch12.xhtml#ch12fig04">Figure 12-4</a>. Tap the <strong>Install</strong> button, and the app will download onto your device.&#13;
<div class="image"><img alt="Image" src="../images/12fig04.jpg"/></div>&#13;
<p class="figcap" id="ch12fig04"><strong>FIGURE 12-4</strong> Downloading the Blue Dot App for your device</p></li>&#13;
<li class="noindent"><strong>Pair your device and Raspberry Pi:</strong> Enable Bluetooth on your mobile device, which is usually an option in the settings (<a href="ch12.xhtml#ch12fig05">Figure 12-5</a>). Ensure that it’s set to the <strong>Discoverable</strong> option so your Raspberry Pi can locate your device. Return to your Raspberry Pi and find the Bluetooth symbol at the top right of the desktop. Click the symbol, and from the menu, select <strong>Turn On</strong>▸<strong>Make Discoverable</strong>. After a few minutes, you <span epub:type="pagebreak" id="page_210"/>should see your mobile device listed. Select it to connect to it. You might have to enter a shared PIN, depending on the device you’re using.</li>&#13;
</ol>&#13;
<div class="image"><img alt="Image" src="../images/12fig05.jpg"/></div>&#13;
<p class="figcap" id="ch12fig05"><strong>FIGURE 12-5</strong> Connecting to your Raspberry Pi from your device</p>&#13;
<p class="indent">An alternative method to connect to Bluetooth is to pair via your mobile device. Start by searching for nearby devices, and then select your Raspberry Pi from the list. Follow the onscreen prompts. Pairing is fairly standard, although it might differ slightly depending on the make of your device.</p>&#13;
<h3 class="h3" id="ch12lev1sec5"><span epub:type="pagebreak" id="page_211"/>CODING THE SMART PLUG</h3>&#13;
<p class="noindent">With your Pi and device connected, you’re ready to write the program to control the Energenie plug from your mobile device! Return to your Python editor and enter the program code in <a href="ch12.xhtml#ch12ex02">Listing 12-2</a>, saving it as <em>plug_bluedot.py</em>.</p>&#13;
<pre><span class="ent">❶</span> <span class="codeorg">from</span> energenie <span class="codeorg">import</span> switch_on, switch_off&#13;
<span class="ent">❷</span> <span class="codeorg">from</span> bluedot <span class="codeorg">import</span> BlueDot&#13;
&#13;
<span class="ent">❸</span> bd = BlueDot()&#13;
&#13;
<span class="ent">❹</span> <span class="codeorg">while True</span>:&#13;
    <span class="ent">❺</span> bd.wait_for_press()&#13;
    <span class="ent">❻</span> switch_on()&#13;
    <span class="ent">❼</span> bd.wait_for_release()&#13;
    <span class="ent">❽</span> switch_off()</pre>&#13;
<p class="caption"><a id="ch12ex02"/><strong>LISTING 12-2</strong> Controlling the plug from your mobile device</p>&#13;
<p class="indent">The program begins by importing the <code>switch_on()</code> and <code>switch_</code><code>off()</code> functions <span class="ent">❶</span> and then the <code>BlueDot()</code> class <span class="ent">❷</span>.</p>&#13;
<p class="indent">Set the <code>BlueDot()</code> class to a variable named <code>bd</code> <span class="ent">❸</span> to make it quicker to use, and then create a <code>while</code> loop to make the program code repeat continuously <span class="ent">❹</span>.</p>&#13;
<p class="indent">Then tell the Pi to detect whether the blue dot on your device is being tapped <span class="ent">❺</span>, and if it is, switch on the Energenie plug, which turns on the lamp <span class="ent">❻</span>. When you release the dot <span class="ent">❼</span>, the plug is switched off <span class="ent">❽</span>, turning off the light.</p>&#13;
<h4 class="h4" id="ch12lev2sec3">Running the Program</h4>&#13;
<p class="noindent">Check that the Bluetooth connection between your Raspberry Pi and your device is still active. You might need to reestablish the connection if it was dropped. Run the program. If the Pi is successfully connected to your device, a message will appear in the console window, confirming the connection (<a href="ch12.xhtml#ch12fig06">Figure 12-6</a>).</p>&#13;
<div class="image"><img alt="Image" src="../images/12fig06.jpg"/></div>&#13;
<p class="figcap" id="ch12fig06"><strong>FIGURE 12-6</strong> Connecting your devices to Bluetooth</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_212"/>Return to your device and open the Blue Dot app; you’ll see a large blue dot on your screen, as shown in <a href="ch12.xhtml#ch12fig07">Figure 12-7</a>. Press your finger on the blue dot and hold it there to turn on the lamp; then release it to turn off the lamp.</p>&#13;
<div class="image"><img alt="Image" src="../images/12fig07.jpg"/></div>&#13;
<p class="figcap" id="ch12fig07"><strong>FIGURE 12-7</strong> Connecting to the Raspberry Pi</p>&#13;
<h4 class="h4" id="ch12lev2sec4">Improving the Code to Switch On and Off</h4>&#13;
<p class="noindent">Now you’ll adapt the <em>plug_bluedot.py</em> program so you can switch on the plug by tapping the dot once and then switch off the plug by tapping the dot again. This way, you can switch on the plug and it will stay on until you tap the blue dot again.</p>&#13;
<p class="indent">This program is even more useful, because you can rig up anything to the plug! For example, if you connect an electric kettle to the Energenie plug, you can turn it on with a tap of the dot. If you need to turn off the kettle, press the blue dot again and the switch will turn off.</p>&#13;
<p class="indent">To do this, you’ll use Blue Dot’s D-pad feature, which is similar to the directional pad on game console controllers on which you can press up, down, left, and right buttons to control the player. For this project, you’ll use the up button to turn on the plug and the down button to turn off the plug. Open your <em>plug_bluedot.py</em> file and modify it so it matches the code in <a href="ch12.xhtml#ch12ex03">Listing 12-3</a>.</p>&#13;
<pre><span epub:type="pagebreak" id="page_213"/>   <span class="codeorg">from</span> energenie <span class="codeorg">import</span> switch_on, switch_off&#13;
   <span class="codeorg">from</span> bluedot <span class="codeorg">import</span> BlueDot&#13;
<span class="ent">❶</span> <span class="codeorg">from</span> signal <span class="codeorg">import</span> pause&#13;
  &#13;
   bd = BlueDot()&#13;
&#13;
<span class="ent">❷</span> <span class="codeorg">def</span> <span class="codeblue1">dpad</span>(pos):&#13;
       <span class="codeorg">if</span> pos.top:&#13;
           <span class="codepurple">print</span> (<span class="codegreen1">"up"</span>)&#13;
           switch_on()&#13;
    <span class="ent">❸</span> <span class="codeorg">elif</span> pos.bottom:&#13;
           <span class="codepurple">print</span> (<span class="codegreen1">"down"</span>)&#13;
           switch_off()&#13;
&#13;
<span class="ent">❹</span> bd.when_pressed = dpad&#13;
&#13;
<span class="ent">❺</span> pause()</pre>&#13;
<p class="caption"><a id="ch12ex03"/><strong>LISTING 12-3</strong> Using Blue Dot to turn the plug on and off</p>&#13;
<p class="indent">In the new code, you first import the <code>pause()</code> function from the <code>signal</code> library <span class="ent">❶</span>. You need this function, because when the program is running, it’s always waiting for the D-pad to be tapped, which puts a strain on the processor. Adding the <code>pause()</code> function reduces that overall strain.</p>&#13;
<p class="indent">Next, create a <code>dpad()</code> function to hold the instructions for what should happen when the D-pad is tapped <span class="ent">❷</span>. First, tell the program that if the top of the D-pad has been tapped, it should run the <code>switch_on()</code> function to turn on the plug.</p>&#13;
<p class="indent">Second, add an <code>elif</code> statement <span class="ent">❸</span> to catch when the bottom position of the D-pad is tapped. Tell the program that if the bottom of the D-pad is tapped, it should switch off the plug by using the <code>switch_off()</code> function.</p>&#13;
<p class="indent">Then check for blue dot taps <span class="ent">❹</span>. This line runs the <code>dpad()</code> function you just created when the dot is tapped. Finally, add the <code>pause()</code> function <span class="ent">❺</span> to reduce the strain on the processor.</p>&#13;
<p class="indent">Save and execute the program. Make sure your Raspberry Pi and your device are connected via Bluetooth, and then load the Blue Dot app on your mobile device. With your lamp still plugged into the Energenie plug, tap the upper part of the blue dot, where an up button would be on a D-pad, to turn on the lamp. Tap the lower part of the blue dot, where a down button would be on a D-pad, to turn it off. Remember that you don’t need to press and hold on the dot this time.</p>&#13;
<p class="indent">You now have a working smart plug that lets you control your house remotely! Try it out with a few other appliances.</p>&#13;
<h3 class="h3" id="ch12lev1sec6"><span epub:type="pagebreak" id="page_214"/>WRAPPING UP</h3>&#13;
<p class="noindent">Once you’ve mastered the basics of this project, you can adapt it to meet your needs. You could make a prank project that turns off a lamp each time someone tries to turn it on. Or how about creating something a little more useful, like a system that turns on your television, the radio, or even a dishwasher? You can combine this project with the glue gun night-light in <a href="ch03.xhtml#ch03">Chapter 3</a> to create a lamp that switches itself on when the room gets to a certain level of darkness and then switches off as the room gets brighter.</p>&#13;
</body></html>