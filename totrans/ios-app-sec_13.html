<html><head></head><body>
<h2 class="h2" id="ch10"><a id="page_161"/><strong><span class="big">10</span></strong><br/><strong>DATA LEAKAGE</strong></h2>
<p class="noindent">Data theft is a serious concern in the mobile world, where devices containing critical personal and business data are lost or stolen frequently. The primary threat to consider here is forensic attackers, so use special care to ensure that such data is persisted in a format that can’t be easily extracted by physical attackers or by compromised devices. Unfortunately, there’s a lot of confusion over what APIs actually end up storing sensitive data, which is understandable since much of this behavior is undocumented.</p>
<p class="indent">In this chapter, I’ll examine the many ways in which data can leak from your application to dark corners of the device—and even accidentally be synced to remote services such as iCloud. You’ll learn how to search for leaked data on a device or within your own Simulator application directory structure, as well as how to prevent these kinds of leaks from happening.</p>
<h3 class="h3" id="ch10lev1sec01"><strong>The Truth About NSLog and the Apple System Log</strong></h3>
<p class="noindent">For years developers have used <code>printf</code> to output basic debug information while writing programs. In iOS, <code>NSLog</code> <em>appears</em> to be the equivalent, and it’s frequently used as such. However, <code>NSLog</code> doesn’t merely write output to the <a id="page_162"/>Xcode console, as most people believe. Its purpose is to log an error message to the Apple System Log (ASL) facility. Here’s what Apple has to say:</p>
<div class="blockquote">
<p class="noindent">Messages received by the server are saved in a data store (subject to input filtering constraints). This API permits clients to create queries and search the message data store for matching messages.<sup><a href="footnote.html#fn83" id="fn_83">1</a></sup></p>
</div>
<p class="indent">So perhaps <code>NSLog</code> is best thought of as a hybrid between <code>printf</code> and <code>syslog</code>, which spits out messages in the Xcode console when debugging and sends messages to a global system log when on the device. It follows, then, that data logged by <code>NSLog</code> will be retrievable by anyone in physical possession of the device, similar to other cached application data.</p>
<p class="indent">No special tools are necessary to read the log. Just plug the iOS device in to a Mac, open Xcode, select <strong>Window</strong> → <strong>Devices</strong>, and click your device. The device’s system log may not be initially visible in the console. If it isn’t, click the tiny arrow in the lower left of the panel. <a href="ch10.html#ch10fig1">Figure 10-1</a> shows an example of viewing the console log with the Devices window.</p>
<div class="image"><img alt="image" src="graphics/f10-01.jpg"/></div>
<p class="figcap"><a id="ch10fig1"/><em>Figure 10-1: The Devices window in Xcode</em></p>
<p class="indent">The Apple System Log facility has one quirk that makes it different from the traditional UNIX syslog facility: you can create queries to search existing data in the ASL. In versions of iOS before iOS 7, this function works regardless of which application originally submitted the data, which means that <a id="page_163"/>any information an application logs can be read by any other application on the device. Any application can read the ASL programmatically, too, as Oliver Drobnik describes on the Cocoanetics blog.<sup><a href="footnote.html#fn84" id="fn_84">2</a></sup> In fact, there are several applications that act as system log viewers using this API.</p>
<p class="indent">In iOS 7 and later, the impact of this flaw has lessened significantly because apps can access only their own logs. However, all application logs can still be read with physical access to a device, provided that the device has a trust relationship with another computer (or that the attacker jailbreaks the device).</p>
<p class="indent">Since log information can leak under certain circumstances, you need to be painstakingly careful to ensure that sensitive information doesn’t end up in the system log. For example, I’ve seen applications containing code like the horrible snippet in <a href="ch10.html#ch10ex1">Listing 10-1</a>.</p>
<pre><span class="violet1">NSLog(</span><span class="red">@"Sending username \%@ and password \%@"</span><span class="violet1">,</span> myName, myPass);</pre>
<p class="listcap"><a id="ch10ex1"/><em>Listing 10-1: Please don’t do this.</em></p>
<p class="indent">If you’re sending usernames, passwords, and so on, to <code>NSLog</code>, you’re basically handing over users’ private information, and you should feel bad about that. To redeem yourself, stop abusing <code>NSLog</code>; take it out of the equation before releasing your app to users.</p>
<h4 class="h4" id="ch10lev2sec01"><em><strong>Disabling NSLog in Release Builds</strong></em></h4>
<p class="noindent">The simplest way to get rid of <code>NSLog</code> output is to use a variadic macro (<a href="ch10.html#ch10ex2">Listing 10-2</a>) that makes <code>NSLog</code> a no-op unless the app is built in Debug mode within Xcode.</p>
<pre><span class="brown">#ifdef DEBUG</span><br/><span class="brown">#   define NSLog(...) NSLog(__VA_ARGS__);</span><br/><span class="brown">#else</span><br/><span class="brown">#   define NSLog(...)</span><br/><span class="brown">#endif</span></pre>
<p class="listcap"><a id="ch10ex2"/><em>Listing 10-2: Disabling NSLog in nondebug builds</em></p>
<p class="indent">As bad as <code>NSLog</code> seems, apps with <code>NSLog</code> <em>do</em> make it into the App Store. This may change at some point, but you can’t rely on Apple to detect that your application is logging information that you don’t intend, nor can you rely on Apple to prevent applications from reading that logged data.</p>
<h4 class="h4" id="ch10lev2sec02"><a id="page_164"/><em><strong>Logging with Breakpoint Actions Instead</strong></em></h4>
<p class="noindent">Another option is to use breakpoint actions to do logging, as I touched on in <a href="ch05.html#ch05">Chapter 5</a>. In that case, you’re effectively logging with the debugger, rather than the program itself. This is more convenient in some circumstances and doesn’t result in data being written to the system log when deployed, reducing the risk of releasing code with logging enabled to zero. Knowing how to use these actions will also be useful to you in future debugging.</p>
<p class="indent">Breakpoint actions are stored within a project, rather than in the source itself. They’re also user specific, so you see only the breakpoints and logging actions that you care about, rather than having everyone on your team clutter up the codebase with their logging statements. But when needed, Xcode lets you share your breakpoints with other users, making them part of the main project (see <a href="ch10.html#ch10fig2">Figure 10-2</a>).</p>
<p class="indent">You can also easily enable or disable actions, as well as specify that they shouldn’t output until the breakpoint is hit a certain number of times. You can even specify complex breakpoint conditions, which define when the associated actions will execute.</p>
<p class="indent">If you want to disable all the breakpoints in a project, you can do this a couple of ways in Xcode. Either go the breakpoint navigator and right-click the workspace icon (<a href="ch10.html#ch10fig2">Figure 10-2</a>) or use the shortcut <img alt="image" src="graphics/common-01.jpg"/>-Y.</p>
<div class="image"><img alt="image" src="graphics/f10-02.jpg"/></div>
<p class="figcap"><a id="ch10fig2"/><em>Figure 10-2: Sharing breakpoints with other users and disabling all breakpoints in Xcode</em></p>
<p class="indent">While <code>NSLog</code> leaks information to disk where it can be read by a physical attacker (and malicious apps in some versions of iOS), data can also leak between apps via more transient mechanisms, such as iOS pasteboards. Let’s take a look at them now.</p>
<h3 class="h3" id="ch10lev1sec02"><strong>How Sensitive Data Leaks Through Pasteboards</strong></h3>
<p class="noindent">The iOS pasteboard is a flexible mechanism for sharing arbitrary data within or between applications. Via a pasteboard, you can share textual data or <a id="page_165"/>serialized objects between applications, with the option to persist these pasteboards on disk.</p>
<h4 class="h4" id="ch10lev2sec03"><em><strong>Restriction-Free System Pasteboards</strong></em></h4>
<p class="noindent">There are two default system pasteboards: <code>UIPasteboardNameGeneral</code> and <code>UIPasteboardNameFind</code>. The former is the pasteboard that almost every application will read from and write to by default when using Cut, Copy, or Paste menu items from within the app, and it’s the pasteboard of choice when you want to share data between third-party applications. The latter is a special pasteboard that stores the contents of the last search string entered into a <code>UISearchBar</code>, so applications can automatically determine what users have searched for in other applications.</p>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>Contrary to the official description of</em> <code><em>UIPasteboardNameFind</em></code><em>, this pasteboard is never used in real life. This bug is acknowledged by Apple but hasn’t been fixed, nor has the documentation been updated. As a security consultant, I can only hope that it will be fixed so that I can complain about it being a security flaw.</em></p>
</div>
<p class="indent">It’s important to remember that the system pasteboards have <em>no</em> access controls or restrictions. If your application stores something on the pasteboard, any application has access to read, delete, or tamper with that data. This tampering can come from processes running in the background, polling pasteboard contents periodically to harvest sensitive data (see Osamu Noguchi’s UIPasteBoardSniffer<sup><a href="footnote.html#fn85" id="fn_85">3</a></sup> for a demonstration of this technique). As such, you need to be extremely careful about what ends up on <code>UIPasteboardNameGeneral</code> in particular, as well as pasteboards in general.</p>
<h4 class="h4" id="ch10lev2sec04"><em><strong>The Risks of Custom-Named Pasteboards</strong></em></h4>
<p class="noindent">Custom-named pasteboards are sometimes referred to as <em>private</em> pasteboards, which is an unfortunate misnomer. While applications can create their own pasteboards for internal use or to share among other specific applications, custom pasteboards are <em>public</em> in versions of iOS prior to 7, making them available for any program to use so long as their names are known.</p>
<p class="indent">Custom pasteboards are created with <code>pasteboardWithName</code>, and in iOS 7 and later, both <code>pasteboardWithName</code> and <code>pasteboardWithUniqueName</code> are specific to all applications within an application group. If other applications outside of this group attempt to create a pasteboard with a name already in use, they’ll be assigned a totally separate pasteboard. Note, however, that the two system pasteboards are still accessible by any application. Given that a number of devices can’t be upgraded to iOS 6, much less iOS 7, you should carefully examine how custom pasteboards are used in different versions of iOS.</p>
<p class="indent">One thing that you can do with a custom pasteboard is mark it as persistent across reboots by setting the <code>persistent</code> property to <code>YES</code>. This will cause pasteboard contents to be written to <em>$SIMPATH/Devices/&lt;device ID&gt;/data/Library/Caches/com.apple.UIKit.pboard/pasteboardDB</em>, <a id="page_166"/>along with other application pasteboards. <a href="ch10.html#ch10ex3">Listing 10-3</a> shows some data you might see in the <em>pasteboardDB</em> file.</p>
<pre>&lt;?<span class="rose">xml version</span>=<span class="red">"1.0"</span> encoding=<span class="red">"UTF-8"</span>?&gt;<br/>&lt;!<span class="rose">DOCTYPE</span> plist <span class="rose">PUBLIC</span> <span class="red">"-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/</span><br/>     <span class="red">PropertyList-1.0.dtd"</span>&gt;<br/>&lt;plist <span class="rose">version</span>=<span class="red">"1.0"</span>&gt;<br/>&lt;array&gt;<br/>        &lt;integer&gt;1&lt;/integer&gt;<br/>        &lt;dict&gt;<br/>                &lt;key&gt;bundle&lt;/key&gt;<br/>                &lt;string&gt;com.apple.UIKit.pboard&lt;/string&gt;<br/>                &lt;key&gt;items&lt;/key&gt;<br/>                &lt;array/&gt;<br/>                &lt;key&gt;itemsunderlock&lt;/key&gt;<br/>                &lt;array/&gt;<br/>                &lt;key&gt;name&lt;/key&gt;<br/>                &lt;string&gt;com.apple.UIKit.pboard.find&lt;/string&gt;<br/>                &lt;key&gt;persistent&lt;/key&gt;<br/>                &lt;true/&gt;<br/>        &lt;/dict&gt;<br/><br/><br/>    --<span class="codeitalic">snip</span>--<br/><br/><br/>        &lt;dict&gt;<br/>                &lt;key&gt;bundle&lt;/key&gt;<br/>                &lt;string&gt;com.apple.UIKit.pboard&lt;/string&gt;<br/>                &lt;key&gt;items&lt;/key&gt;<br/>                &lt;array&gt;<br/>                        &lt;dict&gt;<br/>                                &lt;key&gt;Apple Web Archive pasteboard type&lt;/key&gt;<br/>                                &lt;data&gt;<br/>                                <span class="codestrong">bigbase64encodedblob==</span><br/>                                &lt;/data&gt;<br/>                                &lt;key&gt;public.text&lt;/key&gt;<br/>                                &lt;data&gt;<br/>                                <span class="codestrong">aHR0cDovL2J1cnAvY2VydA==</span><br/>                                &lt;/data&gt;<br/>                        &lt;/dict&gt;<br/>                &lt;/array&gt;<br/>                &lt;key&gt;itemsunderlock&lt;/key&gt;<br/>                &lt;array/&gt;<br/>                &lt;key&gt;name&lt;/key&gt;<br/>                &lt;string&gt;com.apple.UIKit.pboard.general&lt;/string&gt;<br/>                &lt;key&gt;persistent&lt;/key&gt;<br/>                &lt;true/&gt;<br/>        &lt;/dict&gt;<br/>&lt;/array&gt;<br/>&lt;/plist&gt;</pre>
<p class="listcap"><a id="ch10ex3"/><em>Listing 10-3: Possible contents of the</em> com.apple.UIKit.pboard/pasteboardDB <em>file</em></p>
<p class="indent"><a id="page_167"/>The base64 blobs <code>bigbase64encodedblob</code> (too big to include in its entirety) and <code>aHR0cDovL2J1cnAvY2VydA</code> hold pasteboard contents, leaving those contents accessible to any application that can read <em>pasteboardDB</em>. Note, too, that pasteboards can be of different types: the Apple Web Archive pasteboard allows an entire web page to be stored, while the <code>public.text</code> pasteboard is the text content of the general pasteboard.<sup><a href="footnote.html#fn86" id="fn_86">4</a></sup></p>
<h4 class="h4" id="ch10lev2sec05"><em><strong>Pasteboard Data Protection Strategies</strong></em></h4>
<p class="noindentb">To minimize the risk of information leakage, it’s a good idea to analyze exactly what behavior you’re trying to facilitate by using pasteboards. Here are some questions to ask yourself:</p>
<p class="bull">• Do I want users to copy information into other applications, or will they simply need to move data within my application?</p>
<p class="bull">• How long should clipboard data live?</p>
<p class="bull">• Is there any place in the application that data should never be copied from?</p>
<p class="bull">• Is there any part of the application that should never receive pasted data?</p>
<p class="indentt">The answers to these questions will inform the way you should handle pasteboard data within your application. You can take a few different approaches to minimize data leakage.</p>
<h5 class="h5" id="ch10lev3sec01"><strong>Wiping the Pasteboard When You Switch Apps</strong></h5>
<p class="noindent">If you want your users to copy and paste only within your own application, you can clear the pasteboard on the appropriate events to ensure that data doesn’t stay on the pasteboard when the user switches applications. To do this, clear the pasteboard by setting <code>pasteBoard.items = nil</code> on the <code>applicationDidEnterBackground</code> and <code>applicationWillTerminate</code> events. This won’t prevent applications running in the background from reading the pasteboard, but it will shorten the lifetime of the data on the pasteboard and will prevent users from pasting data into apps they’re not supposed to.</p>
<p class="indent">Keep in mind that clearing the pasteboard may interfere with data the end user or other applications are using for a different purpose. You may want to create a flag that indicates whether potentially sensitive data has been written to the pasteboard and clear it only conditionally.</p>
<h5 class="h5" id="ch10lev3sec02"><a id="page_168"/><strong>Preventing Copy/Paste Selectively</strong></h5>
<p class="noindent">Even when you do want to let the user copy and paste, sometimes there are specific places you want to disallow the option. For example, you might want to prevent a user from pasting in a PIN or answer to a security question (such data should never be on the pasteboard in the first place) yet allow the ability to paste in an email address from an email.</p>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>That’s not to say you should use security questions, which tend to enable account hijacking by using publicly available information as an authenticator. You’ll take a look at this in “<a href="ch10.html#ch10lev1sec04">Keylogging and the Autocorrection Database</a>” on <a href="ch10.html#page_175">page 175</a>.</em></p>
</div>
<p class="indent">The official way to allow users to paste some information and prevent them from pasting others is with the <code>canPerformAction:withSender</code> responder method.<sup><a href="footnote.html#fn87" id="fn_87">5</a></sup> Create a new class in Xcode, as in <a href="ch10.html#ch10fig3">Figure 10-3</a>.</p>
<div class="image"><img alt="image" src="graphics/f10-03.jpg"/></div>
<p class="figcap"><a id="ch10fig3"/><em>Figure 10-3: Creating the</em> <code>restrictedUITextField</code> <em>subclass</em></p>
<p class="indent">Then, edit <em>restrictedUITextField.m</em> and add the <code>canPerformAction</code> method.</p>
<pre>   <span class="brown">#import "restrictedUITextField.h"</span><br/><br/><br/>   <span class="rose">@implementation</span> restricted<span class="violet1">UITextField</span><br/><br/><br/>   <span class="violet1">-</span> (<span class="rose">id</span><span class="violet1">)</span><span class="violet">initWithFrame</span><span class="violet1">:(CGRect)frame {</span><br/>       <span class="rose">self</span> <span class="violet1">= [</span><span class="rose">super</span> <span class="violet">initWithFrame</span><span class="violet1">:frame];</span><br/>       <span class="rose">if</span> <span class="violet1">(</span><span class="rose">self</span><span class="violet1">) {</span><br/>           <span class="green1"><span class="codeitalic">// Initialization code</span></span><br/>       <span class="violet1">}</span><br/>       <span class="rose">return self</span><span class="violet1">;</span><br/>   <span class="violet1">}</span><br/><br/><span class="ent">➊</span> <span class="violet1">-(</span><span class="rose">BOOL</span><span class="violet1">)</span><span class="violet">canPerformAction</span><span class="violet1">:(SEL)action withSender:(</span><span class="rose">id</span><span class="violet1">)sender {</span><br/><span class="ent">➋</span>     <span class="rose">if</span> (<span class="violet1">action ==</span> <span class="rose">@selector</span><span class="violet1">(cut:) || action ==</span> <span class="rose">@selector</span><span class="violet1">(copy:))</span><br/>           <span class="rose">return</span> <span class="violet1">NO;</span><br/>       <span class="rose">else</span><br/>           <span class="rose">return</span> <span class="violet1">YES;</span><br/>   <span class="violet1">}</span><br/>   <span class="rose">@end</span></pre>
<p class="listcap"><a id="ch10ex4"/><em>Listing 10-4: Adding</em> <code>canPerformAction</code> <em>to</em> restrictedUITextField.m</p>
<p class="indent"><a id="page_169"/>The <code>canPerformAction</code> method at <span class="ent">➊</span> is passed an <code>action</code> selector, which can be inspected to see what type of action is being requested at <span class="ent">➋</span>. You can use any method from those specified in the <code>UIResponderStandardEditActions</code> protocol. If you want to entirely disable the context menu, you can, of course, simply return <code>NO</code> in every circumstance.</p>
<h3 class="h3" id="ch10lev1sec03"><strong>Finding and Plugging HTTP Cache Leaks</strong></h3>
<p class="noindent">You’ll also find cached data from the URL loading system stored, unencrypted, in the <em>&lt;app ID&gt;/Library/Caches/com.mycompany.myapp/Cache.db*</em> files, which are private to each application. HTTP caches can contain images, URLs, and text fetched over HTTP and can therefore expose sensitive data to a third party if examined. An easy way to get an idea of the type of data exposed by your application is to use File Juicer to carve the database into normal, readable individual files. You can download File Juicer at <em><a href="http://echoone.com/filejuicer/">http://echoone.com/filejuicer/</a></em>, and <a href="ch10.html#ch10fig4">Figure 10-4</a> shows the type of output it provides.</p>
<div class="image"><img alt="image" src="graphics/f10-04.jpg"/></div>
<p class="figcap"><a id="ch10fig4"/><em>Figure 10-4: Examining the contents of the cache databases, split into separate files and directories by File Juicer</em></p>
<p class="indent">File Juicer splits data into directories based on particular file types, so you can investigate stored images, plists, SQLite databases, or plaintext conversions of other binary file types.</p>
<p class="indent">Once you know what kind of data your application exposes through cached data, you can consider how best to manage it.</p>
<h4 class="h4" id="ch10lev2sec06"><a id="page_170"/><em><strong>Cache Management</strong></em></h4>
<p class="noindent">Cache management on iOS is somewhat complex. There are many configuration settings and a seemingly endless number of ways to affect cache policy. On top of that, the platform tries to aggressively cache and copy everything it can get its hands on to try to improve the user experience. Developers need to determine which of these methods allows for secure cache management, but it’s easy to lull yourself into a false sense of security. Pentesters have to know when clients who think they are doing the right things are in fact leaking potentially sensitive information onto disk. Let’s talk about all the wrong ways to manage caches.</p>
<p class="indent">As I mentioned in <a href="ch05.html#ch05">Chapter 5</a>, the documented way to remove cached data, <code>[NSURLCache removeAllCachedResponses]</code>, only removes cache entries from memory. This is essentially useless for security purposes because the same information is persisted to disk and is not removed. Perhaps there’s a better approach.</p>
<p class="indent">Ideally, you won’t ever need to delete the cache because removal implies that you were caching responses in the first place. If the response data is so sensitive, then why not just never cache it? Let’s give that a shot.</p>
<p class="indent">The first place to start limiting cached responses is in the <code>NSURLCache</code> configuration, as in <a href="ch10.html#ch10ex5">Listing 10-5</a>. This API lets you control the amount of memory and disk capacity that the platform dedicates to the cache.</p>
<pre><span class="violet1">NSURLCache</span> *urlCache = [[<span class="violet1">NSURLCache</span> <span class="violet">alloc</span>] <span class="violet">init</span>];<br/>[urlCache <span class="violet">setDiskCapacity</span>:0];<br/>[<span class="violet1">NSURLCache</span> <span class="violet">setSharedURLCache</span>:urlCache];</pre>
<p class="listcap"><a id="ch10ex5"/><em>Listing 10-5: Limiting disk cache storage to zero bytes</em></p>
<p class="indent">The problem with this strategy is that the capacity manipulation APIs are not intended to be security mechanisms. Rather, these configurations exist to provide the system with information to be used when memory or disk space runs low. The <code>NSURLCache</code> documentation<sup><a href="footnote.html#fn88" id="fn_88">6</a></sup> specifies that both the on-disk and in-memory caches will be truncated to the configured sizes only if necessary.</p>
<p class="indent">So you can’t trust configuring the cache capacity. What about setting the cache policy to <code>NSURLRequestReloadIgnoringLocalCacheData</code> to force the URL loading system to ignore any cached responses and fetch the data anew? Here’s how that might work:</p>
<pre><span class="violet1">NSURLRequest*</span> req = [<span class="violet1">NSURLRequest</span> <span class="violet">requestWithURL</span>:aURL<br/>              cachePolicy:<span class="violet1">NSURLRequestReloadIgnoringLocalCacheData</span><br/>          timeoutInterval:666.0];<br/>   [myWebView <span class="violet">loadRequest</span>:req];</pre>
<p class="indent"><a id="page_171"/>But this policy is not implicitly preventing responses from being cached; it’s preventing the URL loading system only from <em>retrieving</em> the cached responses on subsequent fetches. Any previously cached responses will persist on disk, which poses problems if your initial app implementations allowed caching. No dice.</p>
<p class="indent">As I’ve tried to demonstrate, if you rely on the system defaults for web view cache management, you might just implement a lot of precautions that don’t really protect users at all. If you want to reliably control the contents of your application caches, you need to do it yourself. Luckily, this isn’t actually that difficult.</p>
<p class="indent">The Cocoa Touch API gives developers the ability to manipulate responses on a per-request basis before they are cached using the <code>[NSURLConnection connection:willCacheResponse:]</code> method. If you don’t want to cache the data, you can implement the delegate method, as shown in <a href="ch10.html#ch10ex6">Listing 10-6</a>.</p>
<pre>-(<span class="violet1">NSCachedURLResponse</span> *)<span class="violet">connection</span>:(<span class="violet1">NSURLConnection</span> *)<span class="violet">connection</span><br/>                   willCacheResponse:(<span class="violet1">NSCachedURLResponse</span> *)cachedResponse {<br/>  <span class="violet1">NSCachedURLResponse</span> *newCachedResponse = cachedResponse;<br/>  <span class="rose">if</span> ([[[[cachedResponse response] URL] scheme] isEqual:<span class="red">@"https"</span>]) {<br/>    newCachedResponse=nil;<br/>  }<br/>  <span class="rose">return</span> newCachedResponse;<br/>}</pre>
<p class="listcap"><a id="ch10ex6"/><em>Listing 10-6: Preventing caching of responses served over secure connections</em></p>
<p class="indent">This implementation of the delegate just returns <code>NULL</code> instead of the <code>NSCachedURLResponse</code> representation of the response data.</p>
<p class="indent">Similarly, for data fetched using the <code>NSURLSession</code> class, you’d implement the <code>[NSURLSessionDataDelegate URLSession:dataTask:willCacheResponse:completion-Handler:]</code> delegate method. Beware of relying entirely on this method, however, because it is called only for data and upload tasks. Caching behavior for download tasks will still be determined by the cache policy only and should be resolved similarly to <a href="ch10.html#ch10ex6">Listing 10-6</a>.<sup><a href="footnote.html#fn89" id="fn_89">7</a></sup></p>
<p class="indent">In summary, caching on iOS is unreliable. Be careful, and double-check your app after extended use to make sure it’s not leaving sensitive information around.</p>
<h4 class="h4" id="ch10lev2sec07"><em><strong>Solutions for Removing Cached Data</strong></em></h4>
<p class="noindent">The documented way to remove locally cached data is to use the <code>removeAllCachedResponses</code> method of the shared URL cache, shown in <a href="ch10.html#ch10ex7">Listing 10-7</a>.</p>
<pre><a id="page_172"/>[[<span class="violet1">NSURLCache</span> <span class="violet">sharedURLCache</span>] removeAllCachedResponses];</pre>
<p class="listcap"><a id="ch10ex7"/><em>Listing 10-7: The documented API for removing cached data</em></p>
<p class="indent">A similar method, <code>removeCachedResponseForRequest</code>, exists to remove cached data for only specific sites. However, as you discovered in <a href="ch04.html#ch04">Chapter 4</a>, this removes only cached data from memory and not from the disk cache that you’re actually concerned with. I would file a bug, if Apple’s bug tracking system were not an infinitely hot and dense dot from which no light or information could escape.<sup><a href="footnote.html#fn90" id="fn_90">8</a></sup> Anyway, there are a few ways you can work around this—the caching issue, I mean; you’re on your own if you’re unfortunate enough to have to report a bug.</p>
<h5 class="h5" id="ch10lev3sec03"><strong>Just Don’t Cache</strong></h5>
<p class="noindent">In most circumstances, it’s better to just prevent caching altogether, rather than clean up piecemeal afterward. You can proactively set the cache capacities for disk and memory to zero (<a href="ch10.html#ch10ex8">Listing 10-8</a>), or you can simply disable caching for the disk, if you’re comfortable with in-RAM caching.</p>
<pre>- (<span class="rose">void</span>)<span class="violet">applicationDidFinishLaunching</span>:(<span class="violet1">UIApplication *</span>)application {<br/>    [[<span class="violet1">NSURLCache</span> <span class="violet">sharedURLCache</span>] <span class="violet">setDiskCapacity</span>:0];<br/>    [[<span class="violet1">NSURLCache</span> <span class="violet">sharedURLCache</span>] <span class="violet">setMemoryCapacity</span>:0];<br/>    <span class="green1"><span class="codeitalic">// other init code</span></span><br/>}</pre>
<p class="listcap"><a id="ch10ex8"/><em>Listing 10-8: Disallowing cache storage by limiting permitted storage space</em></p>
<p class="indent">Alternatively, you can implement a <code>willCacheResponse</code> delegate method of <code>NSURLConnection</code>, returning a value of <code>nil</code>, as in <a href="ch10.html#ch10ex9">Listing 10-9</a>.</p>
<pre>   -(<span class="violet1">NSCachedURLResponse</span> *)<span class="violet">connection</span>:(<span class="violet1">NSURLConnection</span> *)<span class="violet">connection</span><br/>                    willCacheResponse:(<span class="violet1">NSCachedURLResponse</span> *)cachedResponse {<br/>       <span class="violet1">NSCachedURLResponse</span> *newCachedResponse=cachedResponse;<br/><span class="ent">➊</span>     <span class="rose">if</span> ([cachedResponse response]) {<br/><span class="ent">➋</span>         newCachedResponse=nil;<br/>       }<br/>     <span class="rose">return</span> newCachedResponse;<br/>   }</pre>
<p class="listcap"><a id="ch10ex9"/><em>Listing 10-9: Sample cache discarding code</em></p>
<p class="indent"><a id="page_173"/>This just checks whether a cached response has been sent at <span class="ent">➊</span> and, if it finds one, sets it to <code>nil</code> at <span class="ent">➋</span>. You can also conditionally cache data by examining the properties of the response before returning the object to cache, as shown in <a href="ch10.html#ch10ex10">Listing 10-10</a>.</p>
<pre>   -(<span class="violet1">NSCachedURLResponse</span> *)<span class="violet">connection</span>:(<span class="violet1">NSURLConnection</span> *)<span class="violet">connection</span><br/>                    willCacheResponse:(<span class="violet1">NSCachedURLResponse</span> *)cachedResponse {<br/>       <span class="violet1">NSCachedURLResponse</span> *newCachedResponse=cachedResponse;<br/><span class="ent">➊</span>     <span class="rose">if</span> ([[[[cachedResponse response] URL] scheme] isEqual:<span class="red">@"https"</span>]) {<br/>           newCachedResponse=nil;<br/>       }<br/>     <span class="rose">return</span> newCachedResponse;<br/>   }</pre>
<p class="listcap"><a id="ch10ex10"/><em>Listing 10-10: Conditional cache discarding code</em></p>
<p class="indent">This is nearly the same as in <a href="ch10.html#ch10ex9">Listing 10-9</a>, but it additionally examines the response being cached at <span class="ent">➊</span> to determine whether it is being delivered over HTTPS and discards it if that’s the case.</p>
<p class="indent">If you’re using <code>NSURLSession</code>, you can also use ephemeral sessions, which will not store any data to disk; this includes caches, credentials, and so forth. Creating an ephemeral session is easy. Just instantiate a configuration object for your <code>NSURLSession</code>s, like so:</p>
<pre><span class="violet1">NSURLSessionConfiguration</span> *config = [<span class="violet1">NSURLSessionConfiguration</span><br/>     <span class="violet">ephemeralSessionConfiguration</span>];</pre>
<p class="indent">You can find more information and examples of how to use <code>NSURLSession</code> in <a href="ch07.html#ch07">Chapter 7</a>.</p>
<h5 class="h5" id="ch10lev3sec04"><strong>Disable Caching via the Server</strong></h5>
<p class="noindent">Presuming you control the server your application communicates with, you can instruct the client not to cache requests using the <code>Cache-Control</code> HTTP header. This allows you to either disable caching application-wide or apply it only to specific requests. The mechanism for implementing this on the server side is language-dependent, but the header you’ll want to return for requests you don’t want cached is as follows:</p>
<pre>Cache-Control: no-cache, no-store, must-revalidate</pre>
<p class="indent">Sadly, at least some versions of iOS (verified as of 6.1) don’t actually obey these headers. It’s a good idea to set them for sensitive resources regardless, but don’t rely on this method to solve the problem entirely.</p>
<h5 class="h5" id="ch10lev3sec05"><a id="page_174"/><strong>Go Nuclear</strong></h5>
<p class="noindent">The previous approaches will prevent data from being cached, but sometimes you may want to cache data and then clean it up later. This could be for performance reasons or perhaps because you’re correcting a caching problem in a newly released version of your application, which has already cached data locally on disk. Whatever your reason, clearing the cache in the documented manner doesn’t work, so you’re stuck removing the cached data forcibly, as in <a href="ch10.html#ch10ex11">Listing 10-11</a>.</p>
<pre><span class="violet1">NSString</span> *cacheDir=[<span class="violet1">NSSearchPathForDirectoriesInDomains(NSCachesDirectory,</span><br/>    <span class="violet1">NSUserDomainMask,</span> YES) <span class="violet">objectAtIndex</span>:0];<br/><br/>[[<span class="violet1">NSFileManager</span> <span class="violet">defaultManager</span>] <span class="violet">removeItemAtPath</span>:cacheDir<br/>                                           error:nil];</pre>
<p class="listcap"><a id="ch10ex11"/><em>Listing 10-11: Manually removing the cache database</em></p>
<p class="indent">There’s no guarantee that some other part of the system won’t freak out if you clear cached data manually. However, this method is the only reliable way I’ve found to remove cached data after it’s already been written to disk.</p>
<h4 class="h4" id="ch10lev2sec08"><em><strong>Data Leakage from HTTP Local Storage and Databases</strong></em></h4>
<p class="noindentb">The HTML 5 specification allows websites to store and retrieve large amounts of data (larger than what would fit in a cookie) on the client. These mechanisms are sometimes used to cache data locally so that primarily web-based applications can function in an offline mode. You can find these databases in a number of locations on the device or your simulator, including the following:</p>
<p class="bull">• <em>/Library/Caches/*.localstorage</em></p>
<p class="bull">• <em>/Library/Caches/Databases.db</em></p>
<p class="bull">• <em>/Library/Caches/file__0/*.db</em></p>
<p class="indentt">You can feed these locations to File Juicer the same way you do with HTTP caches to get access to the plaintext data. One obvious application for larger local storage and SQL databases is storing structured information about communications such as email so that those communications can be accessed when the user doesn’t have cell phone reception. This can leave traces around the storage databases, as shown in <a href="ch10.html#ch10fig5">Figure 10-5</a>.</p>
<p class="indent">This exposure is probably an acceptable risk for metadata, but storing it in an encrypted SQLite store might be better, especially when storing full message contents. I’ll talk more about how to do this in “<a href="ch13.html#ch13lev1sec02">Data Protection API</a>” on <a href="ch13.html#page_219">page 219</a>.</p>
<div class="image"><a id="page_175"/><img alt="image" src="graphics/f10-05.jpg"/></div>
<p class="figcap"><a id="ch10fig5"/><em>Figure 10-5: Email metadata left in a mail client</em></p>
<h3 class="h3" id="ch10lev1sec04"><strong>Keylogging and the Autocorrection Database</strong></h3>
<p class="noindent">Everyone is familiar with iOS’s word autocompletion mechanism, the source of endless entertainment and amusing typos (and of frustration when trying to use expletives). One aspect of this system that’s gained some attention in the press is that the autocompletion mechanism acts as an accidental keylogger, recording portions of the text that a user types in what is basically a plaintext file to help with future completions. A forensic attacker could then retrieve that completion database.</p>
<p class="indent">This behavior is already disabled for password fields—that is, <code>UITextField</code> objects with <code>setSecureTextEntry:YES</code> set—but many other forms in an application may take sensitive data. As such, developers have to consider the all too common trade-off between user experience and security. For some applications, no amount of unencrypted data stored to disk is acceptable. Other applications handle sensitive data, but they involve so much text entry that disabling autocorrection would be extremely burdensome.</p>
<p class="indent">Fields that take smaller amounts of sensitive data, though, are a no-brainer. Consider answers to security questions, for example. For these fields, you’ll want to disable autocorrection behavior by setting the <code>autocorrectionType</code> property to <code>UITextAutocorrectionTypeNo</code> on <code>UITextField</code> and <code>UITextView</code> objects. This is also applicable (and a good idea) for <code>UISearchBar</code> objects because having search contents leak to disk is usually undesirable. Check out <a href="ch10.html#ch10ex12">Listing 10-12</a> for an example of how you might try to disable this attribute.</p>
<pre><span class="violet1">UITextField *</span><span class="green">sensitiveTextField</span> = [[<span class="violet1">UITextField</span> <span class="violet">alloc</span><span class="violet1">]</span> <span class="violet">initWithFrame</span><span class="violet1">:CGRectMake(0,</span><br/>     <span class="violet1">0, 25, 25)];</span><br/><span class="violet1">[</span><span class="green">sensitiveTextField</span> <span class="violet">setAutocorrectionType</span><span class="violet1">:UITextAutocorrectionTypeNo];</span></pre>
<p class="listcap"><a id="ch10ex12"/><em>Listing 10-12: Disabling autocorrection on a</em> <code>UITextField</code></p>
<p class="indent"><a id="page_176"/>Of course, note that I say, “You’ll want to disable this behavior.” You’ll <em>want</em> to, but you can’t. Around iOS 5.1, a bug crept in that causes the on-disk word cache to be updated even if you disable autocorrection, autocapitalization, spellcheck, and so on. There are currently two ways around this, ranging from very silly to utterly ridiculous.</p>
<p class="indent">The silly approach (shown in <a href="ch10.html#ch10ex13">Listing 10-13</a>) is to use a <code>UITextView</code> (note <code>View</code>, rather than <code>Field</code>) and send it the message <code>setSecureTextEntry:YES</code>. The <code>UITextView</code> class doesn’t actually implement the <code>UITextInputTraits</code> protocol<sup><a href="footnote.html#fn91" id="fn_91">9</a></sup> correctly, so text isn’t obscured by circles like it would be in a <code>UITextField</code> configured for password entry. It <em>does</em>, however, prevent text from getting written to the disk.</p>
<pre>-(<span class="rose">BOOL</span>)twiddleTextView:(<span class="violet1">UITextView *</span>)textView {<br/>    [textView <span class="violet">setSecureTextEntry</span>:YES];<br/>}</pre>
<p class="listcap"><a id="ch10ex13"/><em>Listing 10-13: Setting the</em> <code>SecureTextEntry</code> <em>attribute on a</em> <code>UITextView</code></p>
<p class="indent">The ridiculous method, which works on both <code>UITextView</code> and <code>UITextField</code> objects, is shown in <a href="ch10.html#ch10ex14">Listing 10-14</a>.</p>
<pre>-(<span class="rose">BOOL</span>)twiddleTextField:(<span class="violet1">UITextField *</span>)<span class="green">textField</span> {<br/>[<span class="green">textField</span> <span class="violet">setSecureTextEntry</span>:YES];<br/>[<span class="green">textField</span> <span class="violet">setSecureTextEntry</span>:NO];<br/>}</pre>
<p class="listcap"><a id="ch10ex14"/><em>Listing 10-14: Twiddling</em> <code>setSecureTextEntry</code> <em>on a</em> <code>UITextField</code></p>
<p class="indent">Yes, seriously. Just switch keylogging on and then turn it off.</p>
<p class="indent">The classes are implemented such that they forget to turn keylogging back on if you simply wiggle it on and off again. Unfortunately, <code>UISearchbar</code> <em>also</em> doesn’t implement the protocol correctly, so you can’t pull this trick on one of the search bars. If preventing data leakage from your search bar is critical, you may want to replace the search bar with an appropriately styled text field instead.</p>
<p class="indent">Of course, that bug might be fixed in a future version of the OS, so just be prudent and ensure that the OS your app is running on is a version that you’ve tested the behavior on before you do this yes/no flipping trick. <a href="ch10.html#ch10ex15">Listing 10-15</a> shows how to do this.</p>
<pre><span class="violet1">UITextField *</span><span class="green">sensitiveTextField</span> = [[<span class="violet1">UITextField</span> <span class="violet">alloc</span><span class="violet1">]</span> <span class="violet">initWithFrame</span><span class="violet1">:CGRectMake(0,</span><br/>     <span class="violet1">0, 25, 25)];</span><br/><span class="violet1">[</span><span class="green">sensitiveTextField</span> <span class="violet">setAutocorrectionType</span><span class="violet1">: UITextAutocorrectionTypeNo];</span><br/><br/><span class="rose">if</span> (<span class="violet1">[[[UIDevice currentDevice] systemVersion] isEqual:</span> <span class="red">@"8.1.4"</span><span class="violet1">]) {</span><br/>    <span class="violet1">[</span><span class="green">sensitiveTextField</span> <span class="violet">setSecureTextEntry</span><span class="violet1">:YES];</span><br/>    <span class="violet1">[</span><span class="green">sensitiveTextField</span> <span class="violet">setSecureTextEntry</span><span class="violet1">:NO];</span><br/><span class="violet1">}</span></pre>
<p class="listcap"><a id="ch10ex15"/><em>Listing 10-15: Checking iOS version</em></p>
<p class="indent"><a id="page_177"/>To help verify that your application isn’t leaking anything unexpected, you can also check <em>&lt;device ID&gt;/data/Library/Keyboard/dynamic-text.dat</em> on the simulator or on a jailbroken device. (<a href="ch10.html#ch10fig6">Figure 10-6</a> shows an example <em>dynamic-text.dat</em> file.) This isn’t going to catch every corner case of what might be committed to the database, but the file should give you a reasonable idea. Note that the database may not actually get updated until you hit the Home button.</p>
<div class="image"><img alt="image" src="graphics/f10-06.jpg"/></div>
<p class="figcap"><a id="ch10fig6"/><em>Figure 10-6: Contents of</em> dynamic-text.dat <em>after using the keyboard to enter message contents. Note that the order of words does not reflect the order in which they were entered.</em></p>
<p class="indent">In iOS 8 and later, additional information is stored in the Keyboard cache. This data is used to help with the QuickType word prediction system, but it also leaks more information about conversations and people who have communicated with the device owner. In the <em>&lt;device ID&gt;/data/Library/Keyboard/en-dynamic.lm</em> directory,<sup><a href="footnote.html#fn92" id="fn_92">10</a></sup> you’ll find four additional data files: <em>dynamic.dat</em>, <em>lexicon.dat</em>, <em>meta.dat</em>, and <em>tags.dat</em>. Check all these files for data entered into your application. Because QuickType adapts based on the recipient, the <em>tags.dat</em> file also includes a list of past message recipients so the completion system can use the correct cache for the correct recipient.</p>
<h3 class="h3" id="ch10lev1sec05"><a id="page_178"/><strong>Misusing User Preferences</strong></h3>
<p class="noindent">As I briefly mentioned in <a href="ch03.html#ch03">Chapter 3</a>, user preferences often contain sensitive information. But user defaults are actually intended to define, say, what URL an app’s API should be at or other nonsensitive preference information.</p>
<p class="indent">Preferences are manipulated through the <code>NSUserDefaults</code> API or, less commonly, the <code>CFPreferences</code> API, and many developers clearly must not know what happens to that data on the device. Restrictions on these files are fairly loose, and user preferences can easily be read and manipulated using commonly available tools, such as iExplorer.</p>
<p class="indent"><a href="ch10.html#ch10ex16">Listing 10-16</a> shows an intentionally terrible usage of <code>NSUserDefaults</code> from the iGoat project.<sup><a href="footnote.html#fn93" id="fn_93">11</a></sup></p>
<pre><span class="violet1">NSUserDefaults</span> *credentials = [<span class="violet1">NSUserDefaults</span> standardUserDefaults];<br/><br/>[credentials <span class="violet">setObject</span>:<span class="rose">self</span>.username.text forKey:<span class="red">@"username"</span>];<br/>[credentials <span class="violet">setObject</span>:<span class="rose">self</span>.password.text forKey:<span class="red">@"password"</span>];<br/>[credentials <span class="violet">synchronize</span>];</pre>
<p class="listcap"><a id="ch10ex16"/><em>Listing 10-16: The worst possible way to use</em> <code>NSUserDefaults</code></p>
<p class="indent">This is essentially the worst-case scenario for data leakage: the credentials are stored in plaintext in a plist belonging to the app. Many applications in the wild store user credentials this way, and many have been called out for it.</p>
<p class="indent">One less common problem with <code>NSUserDefaults</code> is that developers may use it to store information that really shouldn’t be under a user’s control. For example, some apps hand over the reins for security controls that dictate whether users can download and store files locally or whether they’re required to enter a PIN before using the app. To protect users, let the server enforce such decisions as often as possible instead.</p>
<p class="indent">When auditing an application, check each use of the <code>NSUserDefaults</code> or <code>CFPreferences</code> APIs to ensure that the data being stored there is appropriate. There should be no secret information or information you don’t want a user to change.</p>
<h3 class="h3" id="ch10lev1sec06"><strong>Dealing with Sensitive Data in Snapshots</strong></h3>
<p class="noindent">As I also discussed in <a href="ch03.html#ch03">Chapter 3</a>, iOS snapshots an app’s current screen state before sending the app to the background so it can generate an animation when the app is opened again. This results in potentially sensitive information littering the disk, sometimes even if the user doesn’t intentionally background the app. For example, if someone happens to answer a call in the middle of entering sensitive information into an application, that screen state will be written to disk and remain there until overwritten with another <a id="page_179"/>snapshot. I’ve seen many applications willing to record people’s SSNs or credit card numbers in this fashion.</p>
<p class="indent">Once these snapshots are written to disk, a physical attacker can easily retrieve them with common forensics tools. You can even observe the file being written using the Simulator, as shown in <a href="ch10.html#ch10fig7">Figure 10-7</a>.</p>
<div class="image"><img alt="image" src="graphics/f10-07.jpg"/></div>
<p class="figcap"><a id="ch10fig7"/><em>Figure 10-7: A snapshot of a user searching for embarrassing material on Wikipedia, saved to local storage</em></p>
<p class="indent">Just suspend your application and open <em>UIApplicationAutomaticSnapshot Default-Portrait.png</em>, which you’ll find under your app’s <em>Library/Caches/Snapshots/com.mycompany.myapp</em> directory. Unfortunately, applications can’t just go and remove snapshots manually. There are, however, a couple of other ways you can prevent this data from leaking.</p>
<h4 class="h4" id="ch10lev2sec09"><em><strong>Screen Sanitization Strategies</strong></em></h4>
<p class="noindent">First, you can alter the screen state before the screenshot actually occurs. You’ll want to implement this in the <code>applicationDidEnterBackground</code> delegate method, which is the message that your program receives when the application is going to be suspended, giving you a few seconds to complete any tasks before this occurs.</p>
<p class="indent"><a id="page_180"/>This delegate is distinct from the <code>applicationWillResignActive</code> or <code>applicationWillTerminate</code> events. The former is invoked when the application temporarily loses focus (for example, when interrupted by an incoming phone call overlay) and the latter when the application is forcibly killed or has opted out of background operation.<sup><a href="footnote.html#fn94" id="fn_94">12</a></sup> For an abbreviated example of the events received over the life cycle of an iOS application, see <a href="ch10.html#ch10fig8">Figure 10-8</a>.</p>
<div class="image"><img alt="image" src="graphics/f10-08.jpg"/></div>
<p class="figcap"><a id="ch10fig8"/><em>Figure 10-8: The simplified iOS application life cycle. Code for handling these events can be defined in the application delegate.</em></p>
<p class="indent">After these tasks are complete, the snapshot should be taken, and the application should disappear with its little “whoosh” animation. But how can you sanitize your user’s screen?</p>
<p class="indent">The simplest and most reliable method of obscuring screen contents, and the one that I primarily recommend, is simply placing a splash screen with some logo art on top of all the current views. You can implement this as shown in <a href="ch10.html#ch10ex17">Listing 10-17</a>.</p>
<pre>- (<span class="rose">void</span>)applicationDidEnterBackground:(<span class="violet1">UIApplication *</span>)application {<br/><br/>    application = [<span class="violet1">UIApplication</span> <span class="violet">sharedApplication</span><span class="violet1">];</span><br/><br/>    <span class="rose">self</span><span class="violet1">.splash = [[UIImageView</span> <span class="violet">alloc</span><span class="violet1">]</span> <span class="violet">initWithFrame</span><span class="violet1">:[[UIScreen</span> <span class="violet">mainScreen</span><span class="violet1">]</span><br/>     <span class="violet1">bounds]];</span><br/>    <span class="violet1">[<span class="rose">self</span>.splash setImage:[UIImage imageNamed</span>:<span class="red">@"myimage.png"</span><span class="violet1">]];</span><br/>    <span class="violet1">[</span><span class="rose">self</span><span class="violet1">.splash</span> <span class="violet">setUserInteractionEnabled</span><span class="violet1">:NO];</span><br/>    <span class="violet1">[[application</span> <span class="violet">keyWindow</span><span class="violet1">]</span> <span class="violet">addSubview</span><span class="violet1">:splash];</span><br/><span class="violet1">}</span></pre>
<p class="listcap"><a id="ch10ex17"/><em>Listing 10-17: Applying a splash screen</em></p>
<p class="indent"><a id="page_181"/>With this code in place, on entering the background, your application should set whatever image you have stored in <em>myimage.png</em> as the splash screen. Alternatively, you could set the <code>hidden</code> attribute of the relevant container objects—for example, <code>UITextField</code>s, whose contents might be sensitive. You can use this same approach to hide the entire <code>UIView</code>. This is less visually appealing but easily does the job in a pinch.</p>
<p class="indent">A slightly fancier option is to perform some of your own animation,<sup><a href="footnote.html#fn95" id="fn_95">13</a></sup> as in <a href="ch10.html#ch10ex18">Listing 10-18</a>. This just does a fade-out before removing the content from the view.</p>
<pre>- (<span class="rose">void</span>)fadeMe {<br/>    [<span class="violet1">UIView</span> <span class="violet">animateWithDuration</span><span class="violet1">:0.2</span><br/>                     <span class="violet1">animations:^{view.alpha = 0.0;}</span><br/>                     <span class="violet1">completion:^(</span><span class="rose">BOOL</span> <span class="violet1">finished){[view</span> <span class="violet">removeFromSuperview</span><span class="violet1">];}</span><br/>                     <span class="violet1">];</span><br/><span class="violet1">}</span></pre>
<p class="listcap"><a id="ch10ex18"/><em>Listing 10-18: Animating a fade to transparency</em></p>
<p class="indent">I even saw one application that took its own screenshot of the current screen state and ran the screenshot through a blur algorithm. It looked pretty, but hitting all the corner cases is tricky, and you’d have to ensure that the blur is destructive enough that an attacker couldn’t reverse it.</p>
<p class="indent">Regardless of your obfuscation approach, you’ll also need to reverse your changes in either the <code>applicationDidBecomeActive</code> or <code>applicationWillEnter Foreground</code> delegate method. For example, to remove the splash image placed over the screen in <a href="ch10.html#ch10ex17">Listing 10-17</a>, you could add something like <a href="ch10.html#ch10ex19">Listing 10-19</a> to the <code>applicationWillEnterForeground</code> method.</p>
<pre>- (<span class="rose">void</span>)<span class="violet">applicationWillEnterForeground</span>:(<span class="violet1">UIApplication *</span>)application {<br/><br/>    [<span class="rose">self</span>.splash <span class="violet">removeFromSuperview</span>];<br/>    <span class="rose">self</span>.splash = nil;<br/>}</pre>
<p class="listcap"><a id="ch10ex19"/><em>Listing 10-19: Removing a splash screen</em></p>
<p class="indent"><a id="page_182"/>Before you’re done, ensure that your sanitization technique is effective by repeatedly suspending your app in different application states while monitoring your application’s <em>Library/Caches/Snapshots/com.mycompany.myapp</em> directory. Check that the PNG images saved there have all parts of the window obscured by the splash image.</p>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>The</em> com.mycompany.myapp <em>directory is re-created on every suspension of the application. If you’re watching for the file to be created in that directory from the Terminal, you’ll have to reenter the directory using</em> <code><em>cd $PWD</em></code> <em>or similar for the file to appear.</em></p>
</div>
<h4 class="h4" id="ch10lev2sec10"><em><strong>Why Do Those Screen Sanitization Strategies Work?</strong></em></h4>
<p class="noindent">People often misunderstand the fixes I just described because they don’t grasp how iOS lays out its views and windows, so I’ve created a flowchart (<a href="ch10.html#ch10fig9">Figure 10-9</a>) that shows everything you need to know.</p>
<div class="image"><img alt="image" src="graphics/f10-09.jpg"/></div>
<p class="figcap"><a id="ch10fig9"/><em>Figure 10-9: The hierarchy of iOS views</em></p>
<p class="indent">Every application that displays contents on the screen is backed by a <em>layer</em>, which is <code>CALayer</code> by default. On top of the layer is an instance of the <code>UIWindow</code> class, which manages one or more <em>views</em>, instances of the <code>UIView</code> class. <code>UIView</code>s are hierarchical, so a view can have multiple subviews along with buttons, text fields, and so forth.</p>
<p class="indent">iOS apps typically have only one <code>UIWindow</code>, but multiple windows are quite possible. By default, windows have a <code>windowLevel</code> property of 0.0, specifying that the window is at the <code>UIWindowLevelNormal</code> level. Other defined levels are <code>UIWindowlevelAlert</code> and <code>UIWindowlevelStatusBar</code>, both of which have level priority over <code>UIWindowLevelNormal</code>, meaning that they’ll appear on top of other <a id="page_183"/>windows. The most obvious scenario is that of an alert, and in that case, <code>UIAlertView</code> creates a new window on top of all others except the status bar by default.</p>
<p class="indent">The window currently receiving user events is referred to as the key window, and it can be referenced via the <code>keyWindow</code> method in <code>UIApplication</code>.</p>
<h4 class="h4" id="ch10lev2sec11"><em><strong>Common Sanitization Mistakes</strong></em></h4>
<p class="noindent">Developers who don’t understand iOS windows and views frequently sanitize screens incorrectly. I’ve seen several applications that have taken a few development iterations to get it right. One flaw I’ve seen is to set only the key window’s <code>rootViewController</code> to <code>hidden</code>, like so:</p>
<pre><span class="violet1">UIApplication *</span>application;<br/>application = [<span class="violet1">UIApplication</span> <span class="violet">sharedApplication</span><span class="violet1">];</span><br/><span class="violet1">[[[[application]</span> <span class="violet">keyWindow</span><span class="violet1">]</span> <span class="violet">rootViewController</span><span class="violet1">] view]</span> <span class="violet">setHidden</span><span class="violet1">:YES];</span></pre>
<p class="indent">This mistake is understandable because most developers are used to working with <code>UIView</code>s when programming GUIs. While the code will <em>look</em> like it works much of the time, it still leaves any subviews of the root visible. An improvement would be to hide the entire key window, like this:</p>
<pre><span class="violet1">UIApplication *</span>application;<br/>application = [<span class="violet1">UIApplication</span> <span class="violet">sharedApplication</span><span class="violet1">];</span><br/><span class="violet1">[[[application]</span> <span class="violet">keyWindow</span><span class="violet1">]</span> <span class="violet">setHidden</span><span class="violet1">:YES];</span></pre>
<p class="indent">But hiding the key window isn’t a failsafe option either because any <code>UIAlertView</code> windows will appear above other content and become the key window; effectively, you’d end up hiding only the alert.</p>
<p class="indent">Because several methods of hiding content are error prone, I almost always recommend that developers use the splash screen approach. There is, however, an even easier, foolproof approach for some use cases: preventing suspension entirely.</p>
<h4 class="h4" id="ch10lev2sec12"><em><strong>Avoiding Snapshots by Preventing Suspension</strong></em></h4>
<p class="noindent">If your application never really needs to be suspended and resumed (that is, if you want a fresh start with every app launch), then use the Xcode plist editor to add “Application does not run in background” to your plist and set the value to <code>YES</code>, as in <a href="ch10.html#ch10fig10">Figure 10-10</a>. You can also set <code>UIApplicationExitsOnSuspend</code> to <code>YES</code> in your <em>Info.plist</em> file from your favored text editor.</p>
<p class="indent">Adding that item will cause the application to jump to the <code>applicationWillTerminate</code> event rather than stopping at the <code>applicationDidEnterBackground</code> event, which normally immediately precedes the taking of the screenshot.</p>
<div class="image"><a id="page_184"/><img alt="image" src="graphics/f10-10.jpg"/></div>
<p class="figcap"><a id="ch10fig10"/><em>Figure 10-10: Adding the “Application does not run in background” item to the plist</em></p>
<h3 class="h3" id="ch10lev1sec07"><strong>Leaks Due to State Preservation</strong></h3>
<p class="noindent">iOS 6 introduced the concept of <em>state preservation</em>, which provides a method for maintaining application state between invocations, even if the application is killed in the meantime. When state preservation is triggered, each preservable object’s <code>encodeRestorableStateWithCoder</code> delegate method, which contains instructions for how to serialize various UI elements to disk, is called. Then, the <code>decodeRestorableStateWithCoder</code> method is called on relaunch of the application. This system presents a possibility for sensitive information to leak from the user interface to storage on disk since the contents of text fields and other interface data will be put on local storage.</p>
<p class="indent">When you are examining a new codebase, you can quickly determine whether any state preservation is happening by grepping the codebase for <code>restorationIdentifier</code>, rather than clicking your way through all the Storyboard UI elements.</p>
<p class="indent">If preservation is in use, you should find results like this one in the <em>*.storyboard</em> files:</p>
<pre>&lt;viewController restorationIdentifier=<span class="red">"viewController2"</span> title=<span class="red">"Second"</span> id=<span class="red">"3"</span><br/>    customClass=<span class="red">"StatePreservatorSecondViewController"</span> sceneMemberID=<br/>    <span class="red">"viewController"</span>&gt;<br/>    &lt;view key=<span class="red">"view"</span> contentMode=<span class="red">"scaleToFill"</span> id=<span class="red">"17"</span>&gt;<br/>      &lt;rect key=<span class="red">"frame"</span> x=<span class="red">"0.0"</span> y=<span class="red">"20"</span> width=<span class="red">"320"</span> height=<span class="red">"499"</span>/&gt;<br/>      &lt;autoresizingMask key=<span class="red">"autoresizingMask"</span> widthSizable=<span class="red">"YES"</span> heightSizable=<br/>      <span class="red">"YES"</span>/&gt;<br/>      &lt;subviews&gt;<br/>         &lt;textView clipsSubviews=<span class="red">"YES"</span> multipleTouchEnabled=<span class="red">"YES"</span> contentMode=<br/>      <span class="red">"scaleToFill"</span> translatesAutoresizingMaskIntoConstraints=<span class="red">"NO"</span> id=<span class="red">"Zl1-tO-jGB"</span>&gt;<br/>           &lt;textInputTraits key=<span class="red">"textInputTraits"</span> autocapitalizationType=<br/>      <span class="red">"sentences"</span>/&gt;<br/>         &lt;/textView&gt;</pre>
<p class="indent"><a id="page_185"/>Note that there is a view controller with a <code>restorationIdentifier</code> attribute, and this controller contains a subview with a <code>textView</code> object. If the application delegate implements the <code>encodeRestorableStateWithCoder</code> method, it can specify an <code>encodeObject</code> method that preserves the <code>.text</code> attribute of the <code>UITextView</code> for later restoration. This method can be used to ensure that text typed into the field isn’t lost if the application is terminated,<sup><a href="footnote.html#fn96" id="fn_96">14</a></sup> as shown in <a href="ch10.html#ch10ex20">Listing 10-20</a>.</p>
<pre>-(<span class="rose">void</span>)<span class="violet">encodeRestorableStateWithCoder</span>:(<span class="violet1">NSCoder</span> *)coder {<br/>    [<span class="rose">super</span> <span class="violet">encodeRestorableStateWithCoder</span>:coder];<br/><br/>    [coder <span class="violet">encodeObject</span>:_messageBox.text forKey:<span class="red">@"messageBoxContents"</span>];<br/>}</pre>
<p class="listcap"><a id="ch10ex20"/><em>Listing 10-20: An example</em> <code>encodeRestorableStateWithCoder</code> <em>method</em></p>
<p class="indent">After performing functional testing, you can also examine the application’s <em>Library/Saved Application State/com.company.appname.savedState</em> directory, where you’ll find the descriptively named <em>data.data</em> file. This file contains the serialized state of the application for objects that have <code>restorationIdentifiers</code> assigned. Examine this file to determine whether any sensitive data from the user interface may have been encoded. You can also do this on the device, if you’re performing black-box testing.</p>
<h3 class="h3" id="ch10lev1sec08"><strong>Secure State Preservation</strong></h3>
<p class="noindent">If a product needs the UX and convenience of state preservation but needs data to be stored securely while on disk, you can encrypt sensitive object contents before passing them to the <code>encodeObject</code> method. I discuss encryption in more detail in <a href="ch13.html#ch13">Chapter 13</a>), but here’s how you’d encrypt this particular sort of data.</p>
<p class="indent"><a id="page_186"/>When the application is installed, generate an encryption key and store it in the Keychain with <code>secItemAdd</code>. Then, in your <code>encodeRestorableStateWithCoder</code> methods, read the key out of the Keychain and use it as the key for an encryption operation.<sup><a href="footnote.html#fn97" id="fn_97">15</a></sup> Take the resulting data and serialize it with the <code>NSCoder</code>’s <code>encodeObject</code> method. Finally, in the <code>decodeRestorableStateWithCoder</code> method, perform the same operations in reverse to restore the application’s state.</p>
<p class="indent">You can use the SecureNSCoder project<sup><a href="footnote.html#fn98" id="fn_98">16</a></sup> to help implement that functionality. SecureNSCoder can automatically generate a key for your application, store it in the Keychain, and use it to encode and decode your program state. For the rest of this section, I’ll walk you through a sample project that demonstrates how to use this tool in your own programs.</p>
<p class="indent">First, include the <em>SecureArchiveDelegate</em> and <em>SimpleKeychainWrapper</em> files in your project. Then, include <em>SecureArchiverDelegate.h</em> in your view controller’s <em>.h</em> file, as shown in <a href="ch10.html#ch10ex21">Listing 10-21</a>.</p>
<pre><span class="brown">#import &lt;UIKit/UIKit.h&gt;</span><br/><span class="brown">#import "SecureArchiverDelegate.h"</span><br/><br/><span class="rose">@interface</span> ViewController : <span class="violet1">UIViewController</span><br/><br/><span class="green1"><span class="codeitalic">// Some simple properties, adding one for the delegate</span></span><br/><span class="rose">@property</span> <span class="violet1">(weak, nonatomic)</span> <span class="green">IBOutlet</span> <span class="violet1">UITextField *</span><span class="green">textField</span><span class="violet1">;</span><br/><span class="rose">@property</span> <span class="violet1">(weak, nonatomic)</span> <span class="green">SecureArchiverDelegate</span> <span class="violet1">*</span>delegate;<br/><br/><span class="rose">@end</span></pre>
<p class="listcap"><a id="ch10ex21"/><em>Listing 10-21: A basic</em> ViewController.h</p>
<p class="indent">Next, implement the <code>initWithCoder</code> method, as in <a href="ch10.html#ch10ex22">Listing 10-22</a>.</p>
<pre>- (<span class="rose">id</span>)<span class="violet">initWithCoder</span>:(<span class="violet1">NSKeyedUnarchiver</span> *)coder {<br/>    <span class="rose">if</span> (<span class="rose">self</span> = [<span class="rose">super</span> <span class="violet">initWithCoder</span>:coder]) {<br/>        <span class="rose">return self</span>;<br/>    }<br/>    <span class="rose">return</span> nil;<br/>}</pre>
<p class="listcap"><a id="ch10ex22"/><em>Listing 10-22:</em> <code>initWithCoder</code> <em>in</em> ViewController.m</p>
<p class="indent"><a id="page_187"/>Then implement the <code>awakeFromNib</code> method shown in <a href="ch10.html#ch10ex23">Listing 10-23</a>.</p>
<pre>- (<span class="rose">void</span>)awakeFromNib {<br/>    <span class="rose">self</span>.restorationIdentifier = <span class="violet1">NSStringFromClass(</span>[<span class="rose">self</span> class]);<br/>    <span class="rose">self</span>.restorationClass = [<span class="violet1">UIViewController class];</span><br/><span class="violet1">}</span></pre>
<p class="listcap"><a id="ch10ex23"/><em>Listing 10-23:</em> <code>awakeFromNib</code> <em>in ViewController.m</em></p>
<p class="indent">Finally, implement the two state preservation methods in <a href="ch10.html#ch10ex24">Listing 10-24</a>.</p>
<pre>- (<span class="rose">void</span>)<span class="violet">encodeRestorableStateWithCoder</span>:(<span class="violet1">NSKeyedArchiver</span> *)coder {<br/>    <span class="green1"><span class="codeitalic">// preserve state</span></span><br/>    <span class="green">SecureArchiverDelegate</span> *saDelegate = [[<span class="green">SecureArchiverDelegate</span> <span class="violet">alloc</span>] <span class="violet">init</span>];<br/>    [<span class="rose">self</span> <span class="violet">setDelegate</span>:saDelegate];<br/>    [coder <span class="violet">setDelegate</span>:[<span class="rose">self</span> delegate]];<br/>    [coder <span class="violet">encodeObject</span>:[[<span class="rose">self</span> <span class="green">textField</span>] text] forKey:<span class="red">@"textFieldText"</span>];<br/>    [<span class="rose">super</span> <span class="violet">encodeRestorableStateWithCoder</span>:coder];<br/>}<br/><br/>- (<span class="rose">void</span>)decodeRestorableStateWithCoder:(<span class="violet1">NSKeyedUnarchiver</span> *)coder {<br/>    <span class="green1"><span class="codeitalic">// restore the preserved state</span></span><br/>    <span class="green">SecureArchiverDelegate</span> *saDelegate = [[<span class="green">SecureArchiverDelegate</span> <span class="violet">alloc</span>] <span class="violet">init</span>];<br/>    [<span class="rose">self</span> <span class="violet">setDelegate</span>:saDelegate];<br/>    [coder <span class="violet">setDelegate</span>:[<span class="rose">self</span> delegate]];<br/>    [[<span class="rose">self</span> <span class="green">textField</span>] setText:[coder <span class="violet">decodeObjectForKey</span>:<span class="red">@"textFieldText"</span>]];<br/>    [<span class="rose">super</span> decodeRestorableStateWithCoder:coder];<br/>}</pre>
<p class="listcap"><a id="ch10ex24"/><em>Listing 10-24: Encode and decode methods in</em> ViewController.m</p>
<p class="indent">You’ve seen how data can leak from applications on a device, but what about data that’s been backed up to iCloud? Well, if you’re dealing with sensitive data, there’s really only one technique I can recommend there: avoid storing it on iCloud entirely.</p>
<h3 class="h3" id="ch10lev1sec09"><strong>Getting Off iCloud to Avoid Leaks</strong></h3>
<p class="noindentb">In recent versions of iOS, much of your application’s data can be synced to a user’s iCloud account, where it can be shared across devices. By default, only three of your application directories are safe from the clutches of iCloud.</p>
<p class="bull">• <em>AppName.app</em></p>
<p class="bull">• <em>Library/Caches</em></p>
<p class="bull">• <em>/tmp</em></p>
<p class="indentt"><a id="page_188"/>If you want any of your other files to remain only on the device, you’ll have to take responsibility for them yourself.<sup><a href="footnote.html#fn99" id="fn_99">17</a></sup> Set the <code>NSURLIsExcludedFromBackupKey</code> attribute on those files, using an <code>NSURL</code> as the path to the file, to prevent the file from backing up to iCloud, as in <a href="ch10.html#ch10ex25">Listing 10-25</a>.</p>
<pre>   - (<span class="rose">BOOL</span>)addSkipBackupAttributeToItemAtURL:(<span class="violet1">NSURL</span> *)URL {<br/>       <span class="violet1">NSError</span> *error = nil;<br/><br/><span class="ent">➊</span>     [URL <span class="violet">setResourceValue</span>:[<span class="violet1">NSNumber</span> <span class="violet">numberWithBool</span>:YES]<br/>                      forKey:<span class="violet1">NSURLIsExcludedFromBackupKey</span><br/>                       error:&amp;error];<br/><br/>       <span class="rose">return</span> error == nil;<br/>   }</pre>
<p class="listcap"><a id="ch10ex25"/><em>Listing 10-25: Setting file attributes to exclude a file from backup</em></p>
<p class="indent">You can set the <code>NSURLIsExcludedFromBackupKey</code> with the <code>setResourceValue NSURL</code> method, shown at <span class="ent">➊</span>.</p>
<h3 class="h3" id="ch10lev1sec10"><strong>Closing Thoughts</strong></h3>
<p class="noindent">Data leakage on mobile devices is a broad and ever-changing area that makes up a large percentage of issues found in mobile applications when subjected to security audits. Ideally, some of the things you’ve examined in this chapter will help you find useful bugs, as well as help you identify changes when newer versions of iOS are released. I’ll now move on to cover some basic C and memory corruption attacks, which are usually rarer on iOS but potentially much more dangerous.</p>
</body></html>