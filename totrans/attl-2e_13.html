<html><head></head><body>
<h2 class="h2" id="ch13"><span epub:type="pagebreak" id="page_353"/><span class="big">13</span><br/>MAXIMUM PORTABILITY WITH GNULIB</h2>&#13;
<p class="quote"><em>Nothing was ever created by two men. There are no good collaborations, whether in art, in music, in poetry, in mathematics, in philosophy. Once the miracle of creation has taken place, the group can build and extend it, but the group never invents anything.</em><br/>—John Steinbeck, East of Eden</p>&#13;
<div class="image1"><img src="../images/common.jpg" alt="Image"/></div>&#13;
<p class="noindent">You know those cool scripting languages you’ve been using for the last 10 years or so—Python, PHP, Perl, JavaScript, Ruby, and so on? One of the coolest features of these languages, and even some compiled languages like Java, is the ability to access community-provided library functionality through the use of tools like pip and maven, from repositories like PEAR, RubyGems, CPAN, and Maven Central.</p>&#13;
<p class="indent">Don’t you wish you could do that sort of thing with C and C++? You can have that experience in C with the <em>GNU Portability Library (Gnulib)</em><sup><a id="ch13fn_1" href="footnote.xhtml#ch13fn1">1</a></sup>, with its companion command line tool <code>gnulib-tool</code>. Gnulib is a library of source code designed to be widely portable, even to platforms like Windows, using <span epub:type="pagebreak" id="page_354"/>both native- and Cygwin-based compilation (though Gnulib is tested on Cygwin a little more than it is with native Windows builds).</p>&#13;
<p class="indent">There are literally hundreds of portable utility functions in Gnulib that are designed with one goal in mind—portability to many different platforms. This chapter is about how to get started with Gnulib and how to use it to your best advantage.</p>&#13;
<h3 class="h3" id="ch13sec1">License Caveat</h3>&#13;
<p class="noindent">Before I continue, I should mention that much of the Gnulib source code is licensed under GPLv3+ or LGPLv3+. Some of the Gnulib source code is, however, licensed under LGPLv2+, which may make that functionality a bit more palatable. The Gnulib functions that can reasonably be used in libraries are licensed under either LGPLv2+ or LGPLv3+; all else is licensed either under GPLv3+ or under a sort of hybrid mix of “LGPLv3+ and GPLv2” (which is ultimately more compatible with GPLv2 than LGPLv2). If this bothers you, then you may want to skip this chapter, but before discarding Gnulib entirely, consider checking the license on the functionality you wish to use to see if your project can accommodate it.</p>&#13;
<p class="indent">Since Gnulib is distributed in source format, and designed to be incorporated into applications and libraries in that format, the use of Gnulib implies the incorporation of GPL and LGPL source code directly into your source base. At the very least, this means you’ll need to license portions of your code using GPL and LGPL licenses. This may explain why Gnulib is not extremely popular, except with maintainers of other GNU packages.</p>&#13;
<p class="indent">If, on the other hand, you’re writing an open source program already licensed under the GPL, or an open source library already using the LGPL, then your project is a perfect fit for Gnulib. Read on.</p>&#13;
<h3 class="h3" id="ch13sec2">Getting Started</h3>&#13;
<p class="noindent">As mentioned, Gnulib is distributed in source format. While you can always go to the Savannah git repository and browse and download individual files online, it’s much simpler to just clone the Gnulib repository to a work area on your local host. The Gnulib repository provides the <code>gnulib-tool</code> utility in the repository’s root directory, which you can use to copy desired source modules, with companion Autoconf macros and build scripts, directly into your projects.</p>&#13;
<p class="indent">The <code>gnulib-tool</code> utility runs as is right from the root of the repository. To make it easy to access, create a soft link somewhere in your <code>PATH</code> to this program; then you can run <code>gnulib-tool</code> from your project directory to add Gnulib modules to your Autotools-based project:</p>&#13;
<pre>$ <span class="codestrong1">git clone https://git.savannah.gnu.org/git/gnulib.git</span>&#13;
<span class="codeitalic1">--snip--</span>&#13;
$ <span class="codestrong1">ln -s $PWD/gnulib/gnulib-tool $HOME/bin/gnulib-tool</span>&#13;
$</pre>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_355"/>That’s all you need to make Gnulib usable in the most effective manner on your system.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>The upstream Gnulib project doesn’t do releases but rather simply incorporates changes and bug fixes directly into the master branch. The programming examples in this chapter were written to use Gnulib source code from commit f876e0946c730fbd7848cf185fc0dcc712e13e69 in the Savannah Gnulib git repository. If you’re having trouble getting the code in this chapter to build correctly, it could be because something has changed in the Gnulib source since this book was written. Try backing off to this commit of Gnulib.</em></p>&#13;
</div>&#13;
<h3 class="h3" id="ch13sec3">Adding Gnulib Modules to a Project</h3>&#13;
<p class="noindent">To help you understand how to use Gnulib, let’s create a project that does something useful. We’ll write a program that converts data to and from base64 strings, which are widely used today, and Gnulib has a portable library of base64 conversion functionality. We’ll start by creating a small program containing only a <code>main</code> function that will act as a driver for the Gnulib base64 conversion functionality we’ll add later.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>The source code for this project is in the NSP-Autotools GitHub repository called</em> b64 <em>at</em> <a href="https://github.com/NSP-Autotools/b64/">https://github.com/NSP-Autotools/b64/</a>.</p>&#13;
</div>&#13;
<p class="margin">Git tag: 13.0</p>&#13;
<pre>$ <span class="codestrong1">mkdir -p b64/src</span>&#13;
$ <span class="codestrong1">cd b64</span>&#13;
$</pre>&#13;
<p class="indent">Edit <em>src/b64.c</em> and add the contents shown in <a href="ch13.xhtml#ch13ex1">Listing 13-1</a>.</p>&#13;
<pre>#include "config.h"&#13;
#include &lt;stdio.h&gt;&#13;
&#13;
int main(void)&#13;
{&#13;
    printf("b64 - convert data to and from base64 strings.\n");&#13;
    return 0;&#13;
}</pre>&#13;
<p class="caption" id="ch13ex1"><em>Listing 13-1</em>: src/b64.c: <em>The initial contents of the driver program main source file</em></p>&#13;
<p class="indent">Now let’s run <code>autoscan</code> to provide a base <em>configure.ac</em> file, rename the new <em>configure.scan</em> file to <em>configure.ac</em>, and then create a <em>Makefile.am</em> file for our project. Note that I’m creating a nonrecursive Automake project here, adding the single source file, <em>src/b64.c</em>, directly to the top-level <em>Makefile.am</em> file.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_356"/>Since we’re not creating a “foreign” project, we also need to add the standard GNU text files (but you may certainly add <code>foreign</code> to the <code>AM_INIT_AUTOMAKE</code> macro argument list in <em>configure.ac</em> to avoid having to do this if you wish):</p>&#13;
<pre>$ <span class="codestrong1">autoscan</span>&#13;
$ <span class="codestrong1">mv configure.scan configure.ac</span>&#13;
$ <span class="codestrong1">echo "bin_PROGRAMS = src/b64</span>&#13;
<span class="codestrong1">src_b64_SOURCES = src/b64.c" &gt;Makefile.am</span>&#13;
$ <span class="codestrong1">touch NEWS README AUTHORS ChangeLog</span>&#13;
$</pre>&#13;
<p class="indent">Edit the new <em>configure.ac</em> file and make the changes shown in <a href="ch13.xhtml#ch13ex2">Listing 13-2</a>.</p>&#13;
<pre><span class="ash">#</span>                                               <span class="ash">-*- Autoconf -*-</span>&#13;
<span class="ash"># Process this file with autoconf to produce a configure script.</span>&#13;
&#13;
<span class="ash">AC_PREREQ([2.69])</span>&#13;
<span class="ash">AC_INIT([</span>b64<span class="ash">], [</span>1.0<span class="ash">], [</span>b 64-bugs@example.org<span class="ash">])</span>&#13;
AM_INIT_AUTOMAKE([subdir-objects])&#13;
<span class="ash">AC_CONFIG_SRCDIR([src/b64.c])</span>&#13;
<span class="ash">AC_CONFIG_HEADERS([config.h])</span>&#13;
AC_CONFIG_MACRO_DIRS([m4])&#13;
<span class="codeitalic1">--snip--</span>&#13;
AC_CONFIG_FILES([Makefile])&#13;
&#13;
<span class="ash">AC_OUTPUT</span></pre>&#13;
<p class="caption" id="ch13ex2"><em>Listing 13-2</em>: configure.ac: <em>Required changes to <code>autoscan</code>-generated</em> configure.ac</p>&#13;
<p class="indent">I’ve added the <code>subdir-objects</code> option to the <code>AM_INIT_AUTOMAKE</code> macro as part of creating a nonrecursive Automake build system. I’ve also added the <code>AC_CONFIG_MACRO_DIRS</code> macro to keep things clean.<sup><a id="ch13fn_2" href="footnote.xhtml#ch13fn2">2</a></sup></p>&#13;
<p class="indent">At this point, we should be able to run <code>autoreconf -i</code>, followed by <code>configure</code> and <code>make</code>, to build the project:</p>&#13;
<pre>$ <span class="codestrong1">autoreconf -i</span>&#13;
aclocal: warning: couldn't open directory 'm4': No such file or directory&#13;
configure.ac:12: installing './compile'&#13;
configure.ac:6: installing './install-sh'&#13;
configure.ac:6: installing './missing'&#13;
Makefile.am: installing './INSTALL'&#13;
Makefile.am: installing './COPYING' using GNU General Public License v3 file&#13;
Makefile.am:     Consider adding the COPYING file to the version control&#13;
system&#13;
Makefile.am:     for your code, to avoid questions about which license your&#13;
project uses&#13;
Makefile.am: installing './depcomp'&#13;
$&#13;
$ <span class="codestrong1">./configure &amp;&amp; make</span>&#13;
checking for a BSD-compatible install... /usr/bin/install -c&#13;
<span epub:type="pagebreak" id="page_357"/>checking whether build environment is sane... yes&#13;
checking for a thread-safe mkdir -p... /bin/mkdir -p&#13;
<span class="codeitalic1">--snip--</span>&#13;
config.status: creating Makefile&#13;
config.status: creating config.h&#13;
config.status: executing depfiles commands&#13;
make  all-am&#13;
make[1]: Entering directory '/.../b64'&#13;
depbase=`echo src/b64.o | sed 's|[^/]*$|.deps/&amp;|;s|\.o$||'`;\&#13;
gcc -DHAVE_CONFIG_H -I.         -g -O2 -MT src/b64.o -MD -MP -MF $depbase.Tpo -c&#13;
-o src/b64.o src/b64.c &amp;&amp;\&#13;
mv -f $depbase.Tpo $depbase.Po&#13;
gcc    -g -O2 -o src/b64 src/b64.o&#13;
make[1]:   Leaving directory '/.../b64'&#13;
$&#13;
$ <span class="codestrong1">src/b64</span>&#13;
$ b64 - convert data to and from base64 strings.&#13;
$</pre>&#13;
<p class="indent">We’re now ready to start adding Gnulib functionality to this project. The first thing we need to do is use <code>gnulib-tool</code> to import the base64 module into our project. Assuming you’ve correctly cloned the Gnulib git project and added a soft link to <code>gnulib-tool</code> to a directory in your <code>PATH</code> (<em>$HOME/bin</em>, perhaps, if that directory is in your <code>PATH</code>), execute the following command from the root of the <em>b64</em> project directory structure:</p>&#13;
<p class="margin">Git tag 13.1</p>&#13;
<pre>$ <span class="codestrong1">gnulib-tool --import base64</span>&#13;
Module list with included dependencies (indented):&#13;
    absolute-header&#13;
  base64&#13;
    extensions&#13;
    extern-inline&#13;
    include_next&#13;
    memchr&#13;
    snippet/arg-nonnull&#13;
    snippet/c++defs&#13;
    snippet/warn-on-use&#13;
    stdbool&#13;
    stddef&#13;
    string&#13;
File list:&#13;
  lib/arg-nonnull.h&#13;
  lib/base64.c&#13;
  lib/base64.h&#13;
  <span class="codeitalic1">--snip--</span>&#13;
  m4/string_h.m4&#13;
  m4/warn-on-use.m4&#13;
  m4/wchar_t.m4&#13;
Creating directory ./lib&#13;
Creating directory ./m4&#13;
Copying file lib/arg-nonnull.h&#13;
Copying file lib/base64.c&#13;
Copying file lib/base64.h&#13;
<span class="codeitalic1">--snip--</span>&#13;
<span epub:type="pagebreak" id="page_358"/>Copying file m4/string_h.m4&#13;
Copying file m4/warn-on-use.m4&#13;
Copying file m4/wchar_t.m4&#13;
Creating lib/Makefile.am&#13;
Creating m4/gnulib-cache.m4&#13;
Creating m4/gnulib-comp.m4&#13;
Creating ./lib/.gitignore&#13;
Creating ./m4/.gitignore&#13;
Finished.&#13;
&#13;
You may need to add #include directives for the following .h files.&#13;
  #include "base64.h"&#13;
&#13;
Don't forget to&#13;
  - add "lib/Makefile" to AC_CONFIG_FILES in ./configure.ac,&#13;
  - mention "lib" in SUBDIRS in Makefile.am,&#13;
  - mention "-I m4" in ACLOCAL_AMFLAGS in Makefile.am,&#13;
  - mention "m4/gnulib-cache.m4" in EXTRA_DIST in Makefile.am,&#13;
  - invoke gl_EARLY in ./configure.ac, right after AC_PROG_CC,&#13;
  - invoke gl_INIT in ./configure.ac.&#13;
$</pre>&#13;
<p class="indent">The lists elided in this console example can get quite long when using a module that has many dependencies on other Gnulib modules. The <em>base64</em> module only directly depends on the <em>stdbool</em> and <em>memchr</em> modules; however, the dependency list shows additional transitive dependencies. You can see the direct dependencies of a module before committing yourself to it by examining its dependency list on the <em>MODULES</em> page at <em><a href="http://gnu.org">gnu.org</a></em><sup><a id="ch13fn_3" href="footnote.xhtml#ch13fn3">3</a></sup> or by reading the <em>modules/base64</em> file in your clone of the Gnulib repository.</p>&#13;
<p class="indent">Some of the transitive dependencies required by the base64 module include modules designed to make base64 much more portable to a wide variety of platforms. The <em>string</em> module, for example, provides a wrapper around your system’s <em>string.h</em> header file that provides additional commonly available string functionality or fixes bugs on some platforms.</p>&#13;
<p class="indent">You can see from the output that a couple of directories were created—<em>m4</em> and <em>lib</em>—and then some supporting M4 macro files were added to the <em>m4</em> directory and some source and build files were added to the <em>lib</em> directory.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>If you’re working in a git repository, <em><code>gnulib-tool</code></em> adds</em> .gitignore <em>files to the</em> m4 <em>and</em> lib <em>directories so files that can be regenerated or recopied don’t get checked in automatically when you run a command like</em> <code>git add -A</code>. <em>Instead, you’ll see that the only files added are</em> lib/.gitignore, m4/.gitignore, <em>and</em> m4/gnulib-cache.m4. <em>All other files can be regenerated (or recopied) after you’ve finished configuring your project with the desired Gnulib modules.</em></p>&#13;
</div>&#13;
<p class="indent">Finally, near the end of the output, <code>gnulib-tool</code> provides you with some concise instructions on how to use the base64 module you added. First, as <span epub:type="pagebreak" id="page_359"/>per these instructions, we need to add <em>lib/Makefile</em> to our <code>AC_CONFIG_FILES</code> list in <em>configure.ac</em>. Later in the same list, we find additional instructions for more general modifications to <em>configure.ac</em>. <a href="ch13.xhtml#ch13ex3">Listing 13-3</a> shows all of the changes we should make to <em>configure.ac</em>, according to these instructions.</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash"># Checks for programs.</span>&#13;
<span class="ash">AC_PROG_CC</span>&#13;
gl_EARLY&#13;
&#13;
<span class="ash"># Checks for libraries.</span>&#13;
&#13;
<span class="ash"># Checks for header files.</span>&#13;
&#13;
# Initialize Gnulib.&#13;
gl_INIT&#13;
&#13;
<span class="ash"># Checks for typedefs, structures, and compiler characteristics.</span>&#13;
&#13;
<span class="ash"># Checks for library functions.</span>&#13;
&#13;
<span class="ash">AC_CONFIG_FILES([Makefile</span> lib/Makefile<span class="ash">])</span>&#13;
&#13;
<span class="ash">AC_OUTPUT</span></pre>&#13;
<p class="caption" id="ch13ex3"><em>Listing 13-3</em>: configure.ac: <em>Changes required by Gnulib</em></p>&#13;
<p class="indent">Some of the instructions also indicate changes required to the top-level <em>Makefile.am</em> file in our project. <a href="ch13.xhtml#ch13ex4">Listing 13-4</a> highlights these changes.</p>&#13;
<pre>ACLOCAL_AMFLAGS = -I m4&#13;
EXTRA_DIST = m4/gnulib-cache.m4&#13;
SUBDIRS = lib&#13;
&#13;
<span class="ash">bin_PROGRAMS = src/b64</span>&#13;
<span class="ash">src_b64_SOURCES = src/b64.c</span></pre>&#13;
<p class="caption" id="ch13ex4"><em>Listing 13-4</em>: Makefile.am: <em>Changes required by Gnulib</em></p>&#13;
<p class="indent">Your project should continue to build after making these changes. We’ll have to run <code>autoreconf -i</code> to include additional files that are now required by the Gnulib macros we added to <em>configure.ac</em>.</p>&#13;
<p class="indent">When we imported the base64 module, the output from <code>gnulib-tool</code> indicated that we may need to add an include directive for <em>base64.h</em>. At the moment, we don’t need such a directive because our code doesn’t actually use any of base64’s functionality. We’re about to change that, but each module has its own set of include directives, so the steps I’m about to show you are related specifically to the base64 module. Other modules will have similar steps, but they’ll be specific to the modules you choose to use. The documentation for each module tells you how to access the public interface for the module—that is, which header files to include.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_360"/>While the documentation is not particularly clear on this point, you don’t actually have to link any module-specific libraries into your project because the <em>lib/Makefile.am</em> file builds all imported modules’ source files and adds the resulting objects to a static library called <em>libgnu.a</em>. This is a customized version of the Gnulib library, containing only the modules you pulled into your project. Since Gnulib is a source code library, there are no binary files (outside of the one built in the <em>lib</em> directory) required by projects consuming Gnulib functionality. Therefore, the procedure for linking to Gnulib functionality is the same for all Gnulib modules.</p>&#13;
<p class="indent">Let’s add some of base64’s functionality to our project to see what’s involved in actually using this module. Make the changes highlighted in <a href="ch13.xhtml#ch13ex5">Listing 13-5</a> to your <em>src/b64.c</em> file.</p>&#13;
<p class="margin">Git tag 13.2</p>&#13;
<pre><span class="ash">#include "config.h"</span>&#13;
<span class="ash">#include &lt;stdio.h&gt;</span>&#13;
#include &lt;stdlib.h&gt;&#13;
#include &lt;string.h&gt;&#13;
#include &lt;stdbool.h&gt;&#13;
#include &lt;errno.h&gt;&#13;
#include &lt;unistd.h&gt;&#13;
&#13;
#include "base64.h"&#13;
&#13;
#define BUF_GROW 1024&#13;
&#13;
static void exit_with_help(int status)&#13;
{&#13;
    printf("b64 – convert data TO and FROM base64 (default: TO).\n");&#13;
    printf("Usage: b64 [options]\n");&#13;
    printf("Options:\n");&#13;
    printf("  -d   base64-decode stdin to stdout.\n");&#13;
    printf("  -h   print this help screen and exit.\n");&#13;
    exit(status);&#13;
}&#13;
&#13;
static char *read_input(FILE *f, size_t *psize)&#13;
{&#13;
    int c;&#13;
    size_t insize, sz = 0;&#13;
    char *bp = NULL, *cp = NULL, *ep = NULL;&#13;
&#13;
    while ((c = fgetc(f)) != EOF)&#13;
    {&#13;
        if (cp &gt;= ep)&#13;
        {&#13;
            size_t nsz = sz == 0 ? BUF_GROW : sz * 2;&#13;
            char *np = realloc(bp, nsz);&#13;
            if (np == NULL)&#13;
            {&#13;
                perror("readin realloc");&#13;
                exit(1);&#13;
            }&#13;
<span epub:type="pagebreak" id="page_361"/>            cp = np + (cp - bp);&#13;
            bp = np;&#13;
            ep = np + nsz;&#13;
            sz = nsz;&#13;
        }&#13;
        *cp++ = (char) c;&#13;
    }&#13;
    *psize = cp - bp;&#13;
    return bp;&#13;
}&#13;
&#13;
static int encode(FILE *f)&#13;
{&#13;
    size_t insize;&#13;
    char *outbuf, *inbuf = read_input(f, &amp;insize);&#13;
    size_t outsize = base64_encode_alloc(inbuf, insize, &amp;outbuf);&#13;
    if (outbuf == NULL)&#13;
    {&#13;
        if (outsize == 0 &amp;&amp; insize != 0)&#13;
        {&#13;
            fprintf(stderr, "encode: input too long\n");&#13;
            return 1;&#13;
        }&#13;
        fprintf(stderr, "encode: allocation failure\n");&#13;
    }&#13;
    fwrite(outbuf, outsize, 1, stdout);&#13;
    free(inbuf);&#13;
    free(outbuf);&#13;
    return 0;&#13;
}&#13;
&#13;
static int decode(FILE *f)&#13;
{&#13;
    size_t outsize, insize;&#13;
    char *outbuf, *inbuf = read_input(f, &amp;insize);&#13;
    bool ok = base64_decode_alloc(inbuf, insize, &amp;outbuf, &amp;outsize);&#13;
    if (!ok)&#13;
    {&#13;
        fprintf(stderr, "decode: input not base64\n");&#13;
        return 1;&#13;
    }&#13;
    if (outbuf == NULL)&#13;
    {&#13;
        fprintf(stderr, "decode: allocation failure\n");&#13;
        return 1;&#13;
    }&#13;
    fwrite(outbuf, outsize, 1, stdout);&#13;
    free(inbuf);&#13;
    free(outbuf);&#13;
    return 0;&#13;
}&#13;
<span class="ash">int main(</span>int argc, char *argv[]<span class="ash">)</span>&#13;
<span class="ash">{</span>&#13;
<span epub:type="pagebreak" id="page_362"/>    int c;&#13;
    bool tob64 = true;&#13;
&#13;
    while ((c = getopt(argc, argv, "dh")) != -1)&#13;
    {&#13;
        switch (c)&#13;
        {&#13;
            case 'd':&#13;
                tob64 = false;&#13;
                break;&#13;
            case 'h':&#13;
            default:                exit_with_help(c == 'h' ? 0 : 1);&#13;
        }&#13;
    }&#13;
    <span class="ash">return</span> tob64 ? encode(stdin) : decode(stdin);&#13;
<span class="ash">}</span></pre>&#13;
<p class="caption" id="ch13ex5"><em>Listing 13-5</em>: src/b64.c: <em>Changes required to incorporate base64 functionality</em></p>&#13;
<p class="indent">I’ve provided the entire file in <a href="ch13.xhtml#ch13ex5">Listing 13-5</a> because there are only a few lines of the original code remaining. This program was designed to act as a Unix filter, reading input data from <code>stdin</code> and writing output data to <code>stdout</code>. To read from and write to files, just use command line redirection.</p>&#13;
<p class="indent">I should mention a few noteworthy points about this program. First, it uses a buffer growth algorithm in the <code>read_input</code> function. Much of this code can be replaced with a call to another Gnulib module function, <code>x2nrealloc</code>. The online documentation is sparse about the use of this method, or even the fact that it exists—perhaps because the xalloc interface has been around in various forms for many years. You can find the <em>xalloc.h</em> header file in the Gnulib source under the <em>lib</em> directory. There are long comments in there containing example usages of many of the functions, including the <code>x2nrealloc</code> function.</p>&#13;
<p class="indent">Another advantage of using xalloc functionality for all your allocation needs is that its allocation functions automatically check for <code>NULL</code> return values and abort your program with an appropriate error message on memory allocation failures. If you desire more control over the abort process, you can add a function to your code called <code>xalloc_die</code> (no arguments, no return value) that will be called by xalloc functions if it exists. You can use this hook to perform any cleanup needed before your program exits. Why not let you decide whether or not to exit? You’re out of memory—what are you really going to do? Such out-of-memory conditions don’t happen often in today’s world of multi-terabyte-sized address spaces, but they still have to be checked for. The xalloc functions make doing so a little less painful.</p>&#13;
<p class="indent">Finally, unlike many filters, this program will likely crash if you feed it a file containing a gigabyte of data because it buffers the entire input in an allocated memory block, which it resizes as it reads data from <code>stdin</code>. The reason for this is that the default use of the base64 module is not designed to handle streaming data. It requires the entire buffer up front. There is, however, a <code>base64_encode_alloc_ctx</code> method that allows you to encode small chunks of your input text in an iterative fashion. I’ll leave it as an exercise <span epub:type="pagebreak" id="page_363"/>for you, the reader, to change this program to make use of this form of the base64 module.</p>&#13;
<p class="indent">To make this code build correctly, you’ll need to change <em>Makefile.am</em> as shown in <a href="ch13.xhtml#ch13ex6">Listing 13-6</a>.</p>&#13;
<pre><span class="ash">ACLOCAL_AMFLAGS = -I m4</span>&#13;
<span class="ash">EXTRA_DIST = m4/gnulib-cache.m4</span>&#13;
<span class="ash">SUBDIRS = lib</span>&#13;
&#13;
<span class="ash">bin_PROGRAMS = src/b64</span>&#13;
<span class="ash">src_b64_SOURCES = src/b64.c</span>&#13;
src_b64_CPPFLAGS = -I$(top_builddir)/lib -I$(top_srcdir)/lib&#13;
src_b64_LDADD = lib/libgnu.a</pre>&#13;
<p class="caption" id="ch13ex6"><em>Listing 13-6</em>: Makefile.am: <em>Changes required to use the base64 module in source</em></p>&#13;
<p class="indent">The <code>src_b64_CPPFLAGS</code> directive adds directories to the compiler’s include search path so it can find any header files added with selected Gnulib modules. The <code>src_b64_LDADD</code> directive appends <em>lib/libgnu.a</em> to the linker command line. Both of these directives should be familiar at this point.</p>&#13;
<p class="indent">Let’s build and run the <code>b64</code> program. As I mentioned previously, you’ll want to run <code>autoreconf -i</code> first, to pick up any changes required by Gnulib additions to the project.</p>&#13;
<pre>$ <span class="codestrong1">autoreconf -i</span>&#13;
<span class="codeitalic1">--snip--</span>&#13;
$ <span class="codestrong1">./configure &amp;&amp; make</span>&#13;
<span class="codeitalic1">--snip--</span>&#13;
$ <span class="codestrong1">echo hi | src/b64</span>&#13;
aGkK$ <span class="codestrong1">echo -n aGkK | src/b64 -d</span>&#13;
hi&#13;
$</pre>&#13;
<p class="indent">I used <code>echo</code> to pipe some text into the <code>b64</code> filter, which outputs the base64 equivalent of that text: “<code>aGkK</code>”. Note there’s no line-feed character at the end of the output. The <code>b64</code> filter outputs only the base64 text version of the input data. I then used <code>echo -n</code> to pipe the base64 text back into the filter, using the <code>-d</code> flag to decode to the original input data. The output is the original text, including a terminating line-feed character. By default, <code>echo</code> appends a line-feed character to the end of any text you hand it; therefore, the original encoded text includes a terminating line-feed character. The <code>-n</code> option tells <code>echo</code> to suppress the line-feed character. If you don’t use <code>-n</code>, the decode will fail with an error indicating the input data is not valid base64 text because <code>echo</code> added a line-feed character to it, which is not part of the base64 text.<sup><a id="ch13fn_4" href="footnote.xhtml#ch13fn4">4</a></sup></p>&#13;
<p class="indent">One thing that’s not clear from the Gnulib documentation is that, in keeping with the general philosophy of never committing files or data that <span epub:type="pagebreak" id="page_364"/>can be easily regenerated, Gnulib’s <em>.gitignore</em> files keep imported module source code from being committed to your repository. There are a couple of reasons for this. First, Gnulib source code already lives in a repository—that of Gnulib itself. There’s no point in proliferating copies of the Gnulib source code around the internet by storing it in every repository that consumes it.</p>&#13;
<p class="indent">Another reason for not storing it in your project repository is that bug fixes are always being supplied by users and maintainers. Each time you update your Gnulib work area and build your project, you could be getting a better version of the modules you’re using.</p>&#13;
<p class="indent">Let’s say you’re finished for the day and you want to leave your work area in a nice clean state. You type <code>git clean -xfd</code> and wipe out everything not staged or already committed. The next day you come back and type <code>autoreconf -i</code>, followed by <code>configure &amp;&amp; make</code>, but you find that your project won’t build; there are files missing from the <em>m4</em> and <em>lib</em> directories that seemed pretty important the day before. In fact, you discover, only the <em>m4/gnulib-cache.m4</em> file remains as a subtle reminder to you that your project ever had anything to do with Gnulib.</p>&#13;
<p class="indent">As it happens, that <em>gnulib-cache.m4</em> file is all you really need. It tells <code>gnulib-tool</code> which modules you’ve imported. To get it all back again, execute <code>gnulib-tool</code> with the <code>--update</code> option. This causes <code>gnulib-tool</code> to recopy current versions of all the relevant Gnulib files back into your project.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>The use of the <em><code>--update</code></em> option with <em><code>gnulib-tool</code></em> will not update your Gnulib work area from its remote repository. Rather, it only updates your project’s use of Gnulib modules with the files that currently exist in your Gnulib work area. If you really want to use a particular past version of a set of Gnulib modules, you can check out a revision of the Gnulib repository from the past and then run <em><code>gnulib-tool --update</code></em> to pull in the current set of files from your Gnulib work area.</em></p>&#13;
</div>&#13;
<p class="indent">The <code>--update</code> option can also be used to copy updated versions of files after you’ve updated your Gnulib work area with git.</p>&#13;
<p class="indent">To help you remember to use <code>gnulib-tool --update</code> in projects that use Gnulib, the Gnulib manual suggests that you create a <code>bootstrap.sh</code> script (and flag it executable) containing at least the lines shown in <a href="ch13.xhtml#ch13ex7">Listing 13-7</a>.</p>&#13;
<p class="margin">Git tag 13.3</p>&#13;
<pre>#!/bin/sh&#13;
gnulib-tool --update&#13;
autoreconf -i</pre>&#13;
<p class="caption" id="ch13ex7"><em>Listing 13-7</em>: <code>bootstrap.sh</code>: <em>A project bootstrap script for</em> b64</p>&#13;
<p class="indent">It would be really nice if <code>autoreconf</code> was smart enough to notice that you’ve used Gnulib modules and just call <code>gnulib-tool --update</code> for you. I suspect that’s on the feature list for a future release of Autoconf. For the present, however, you’ll need to remember to run this command to pull in Gnulib files when you clone your project repository into a new work area or after you’ve asked git to make your current work area pristine.</p>&#13;
<h3 class="h3" id="ch13sec4"><span epub:type="pagebreak" id="page_365"/>Summary</h3>&#13;
<p class="noindent">In this chapter, I discussed how to add Gnulib modules to your Autotools-based projects. I believe I’ve given you enough of a taste of Gnulib to pique your interest in this resource. The Gnulib manual is well written and easy to grasp (though a bit shy of full documentation) once you have a handle on the basics.</p>&#13;
<p class="indent">The next step is for you to go to the Gnulib modules page and browse the functionality available to you. The header files and source code for the modules are also available for viewing from that page and in the <em>modules</em> and <em>lib</em> directories of the repository. Feel free to check them out.</p>&#13;
<p class="indent">The maintainers can always use help with documentation. Once you’ve used a module and become comfortable with it, see if its documentation could use some updating and consider becoming a contributor. You can use the Gnulib mailing list<sup><a id="ch13fn_5" href="footnote.xhtml#ch13fn5">5</a></sup> as a resource, both for questions you may have about the use of Gnulib and for patches for the documentation and source code.<sup><a id="ch13fn_6" href="footnote.xhtml#ch13fn6">6</a></sup><span epub:type="pagebreak" id="page_366"/></p>&#13;
</body></html>