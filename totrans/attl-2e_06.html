<html><head></head><body>
<h2 class="h2" id="ch06"><span epub:type="pagebreak" id="page_145"/><span class="big">6</span><br/>AUTOMATIC MAKEFILES WITH AUTOMAKE</h2>&#13;
<p class="quote"><em>If you understand, things are just as they are; if you do not understand, things are just as they are.<br/>—Zen proverb</em></p>&#13;
<div class="image1"><img src="../images/common.jpg" alt="Image"/></div>&#13;
<p class="noindent">Shortly after Autoconf began its journey to success, David MacKenzie started working on a new tool for automatically generating makefiles for a GNU project: Automake. During early development of the <em>GNU Coding Standards (GCS)</em>, it became apparent to MacKenzie that because the <em>GCS</em> is fairly specific about how and where a project’s products should be built, tested, and installed, much of a GNU project makefile was boilerplate material. Automake takes advantage of this fact to make maintainers’ lives easier and to make the user’s experience more consistent.</p>&#13;
<p class="indent">MacKenzie’s work on Automake lasted almost a year, ending around November 1994. A year later, in November 1995, Tom Tromey (of Red Hat and Cygnus fame) took over the Automake project and played a significant role in its development. Although MacKenzie had written the initial version of Automake in Bourne shell script, Tromey completely rewrote the tool in Perl and continued to maintain and enhance Automake over the next five years.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_146"/>By the end of 2000, Alexandre Duret-Lutz had essentially taken over maintenance of the Automake project. His role as project lead lasted until about mid-2007, at which point Ralf Wildenhues<sup><a id="ch06fn_1" href="footnote.xhtml#ch06fn1">1</a></sup> took the wheel, with occasional input from Akim Demaille and Jim Meyering. From 2012 to early 2017, Automake was maintained by Stefano Lattarini while he worked for Google in Switzerland. The current maintainer is Mathieu Lirzin, a computer science master’s student at the University of Bordeaux in France.</p>&#13;
<p class="indent">Most of the complaints I’ve seen about the Autotools are ultimately associated with Automake. The reasons are simple: Automake provides the highest level of abstraction over the build system and imposes a fairly rigid structure on projects that use it. Automake’s syntax is concise—in fact, it’s terse, almost to a fault. One Automake statement represents a <em>lot</em> of functionality. But once you understand it, you can get a fairly complete, complex, and functionally correct build system up and running in short order—that is, in minutes, not hours or days.</p>&#13;
<p class="indent">In this chapter, I provide you with some insight into the inner workings of Automake. With such insight, you’ll begin to feel comfortable not only with what Automake can do for you but also with extending it in areas where its automation falls short.</p>&#13;
<h3 class="h3" id="ch06sec1">Getting Down to Business</h3>&#13;
<p class="noindent">Let’s face it—getting a makefile right is often difficult. The devil, as they say, is in the details. Consider the following changes to the files in our project directory structure as we continue to improve the project build system for Jupiter. Let’s start by cleaning up our work area. You can do this using <code>make distclean</code>, or if you’re building from a GitHub repository work area, you can use a form of the <code>git clean</code> command:<sup><a id="ch06fn_2" href="footnote.xhtml#ch06fn2">2</a></sup></p>&#13;
<p class="margin">Git tag 6.0</p>&#13;
<pre>   $ <span class="codestrong1">git clean -xfd</span>&#13;
   <span class="codeitalic1">--snip--</span>&#13;
<span class="ent">➊</span> $ <span class="codestrong1">rm bootstrap.sh Makefile.in src/Makefile.in</span>&#13;
<span class="ent">➋</span> $ <span class="codestrong1">echo "SUBDIRS = src" &gt; Makefile.am</span>&#13;
<span class="ent">➌</span> $ <span class="codestrong1">echo "bin_PROGRAMS = jupiter</span>&#13;
   &gt; <span class="codestrong1">jupiter_SOURCES = main.c" &gt; src/Makefile.am</span>&#13;
<span class="ent">➍</span> $ <span class="codestrong1">touch NEWS README AUTHORS ChangeLog</span>&#13;
   $ <span class="codestrong1">ls -1</span>&#13;
   AUTHORS&#13;
   ChangeLog&#13;
   configure.ac&#13;
   Makefile.am&#13;
   NEWS&#13;
   <span epub:type="pagebreak" id="page_147"/>README&#13;
   src&#13;
   $</pre>&#13;
<p class="indent">The <code>rm</code> command at <span class="ent">➊</span> deletes our hand-coded <em>Makefile.in</em> templates and the <code>bootstrap.sh</code> script we wrote to ensure that all the support scripts and files are copied into the root of our project directory. We won’t need this script anymore because we’re upgrading Jupiter to Automake proper. (For the sake of brevity, I used <code>echo</code> statements at <span class="ent">➋</span> and <span class="ent">➌</span> to write the new <em>Makefile.am</em> files; you can use a text editor if you wish.)</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>There is a hard carriage return at the end of the line at <span class="ent">➌</span>. The shell will continue to accept input after the carriage return until the quotation is closed</em>.</p>&#13;
</div>&#13;
<p class="indent">I used the <code>touch</code> command at <span class="ent">➍</span> to create new, empty versions of the <em>NEWS</em>, <em>README</em>, <em>AUTHORS</em>, and <em>ChangeLog</em> files in the project root directory. (The <em>INSTALL</em> and <em>COPYING</em> files are added by <code>autoreconf -i</code>.) These files are required by the <em>GCS</em> for all GNU projects. And although they’re not required for non-GNU projects, they’ve become something of an institution in the OSS world; users have come to expect them.<sup><a id="ch06fn_3" href="footnote.xhtml#ch06fn3">3</a></sup></p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>The</em> GCS <em>covers the format and contents of these files. Sections 6.7 and 6.8 cover the</em> NEWS <em>and</em> ChangeLog <em>files, respectively, and Section 7.3 covers the</em> README, INSTALL, <em>and</em> COPYING <em>files. The</em> AUTHORS <em>file is a list of people (names and optional email addresses) to whom attribution should be given.<sup><a id="ch06fn_4" href="footnote.xhtml#ch06fn4">4</a></sup></em></p>&#13;
</div>&#13;
<p class="indent">It can be a little painful to maintain a <em>ChangeLog</em> file—especially since you’ve already done it once as you added commit messages to your repository commits. To simplify the process, consider using a shell script to scrape your repository log into <em>ChangeLog</em> before you make a new release. There are existing scripts available on the internet; for example, <em>gnulib</em> (see <a href="ch13.xhtml">Chapter 13</a>) provides the <code>gitlog-to-changelog</code> script, which can be used to import a git repository’s log information into <em>ChangeLog</em> prior to release.</p>&#13;
<h4 class="h4" id="ch06sec1-1"><em>Enabling Automake in configure.ac</em></h4>&#13;
<p class="noindent">To enable Automake within the build system, I’ve added a single line to <em>configure.ac</em>: a call to <code>AM_INIT_AUTOMAKE</code> between the calls to <code>AC_INIT</code> and <code>AC_CONFIG_SRCDIR</code>, as shown in <a href="ch06.xhtml#ch06ex1">Listing 6-1</a>.</p>&#13;
<pre><span class="ash">#                                               -*- Autoconf -*-</span>&#13;
<span class="ash"># Process this file with autoconf to produce a configure script.</span>&#13;
<span epub:type="pagebreak" id="page_148"/><span class="ash">AC_PREREQ([2.69])</span>&#13;
<span class="ash">AC_INIT([Jupiter], [1.0], [jupiter-bugs@example.org])</span>&#13;
AM_INIT_AUTOMAKE&#13;
<span class="ash">AC_CONFIG_SRCDIR([src/main.c])</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch06ex1"><em>Listing 6-1: Adding Automake functionality to</em> configure.ac</p>&#13;
<p class="indent">If your project has already been configured with Autoconf, this is the <em>only</em> line that’s required to enable Automake in a working <em>configure.ac</em> file. The <code>AM_INIT_AUTOMAKE</code> macro accepts an optional argument: a whitespace-separated list of option tags, which can be passed into this macro to modify the general behavior of Automake. For a detailed description of each option, see <a href="ch17.xhtml">Chapter 17</a> of the <em>GNU Automake Manual</em>.<sup><a id="ch06fn_5" href="footnote.xhtml#ch06fn5">5</a></sup> I will, however, point out a few of the most useful options here.</p>&#13;
<p class="noindentt"><span class="codestrong1">gnits</span>, <span class="codestrong1">gnu</span>, <span class="codestrong1">foreign</span></p>&#13;
<p class="noindenti">These options set Automake’s strictness checks. The default is <code>gnu</code>. The <code>gnits</code> option makes Automake even more pedantic than it already is, and the <code>foreign</code> option loosens things up a bit—with <code>foreign</code>, you aren’t required to have the obligatory <em>INSTALL</em>, <em>README</em>, and <em>ChangeLog</em> files normally required for GNU projects.</p>&#13;
<p class="noindentt"><span class="codestrong1">check-news</span></p>&#13;
<p class="noindenti">The <code>check-news</code> option causes <code>make dist</code> to fail if the project’s current version (from <em>configure.ac</em>) doesn’t show up in the first few lines of the <em>NEWS</em> file.</p>&#13;
<p class="noindentt"><span class="codestrong1">dist-bzip2</span>, <span class="codestrong1">dist-lzip</span>, <span class="codestrong1">dist-xz</span>, <span class="codestrong1">dist-shar</span>, <span class="codestrong1">dist-zip</span>, <span class="codestrong1">dist-tarZ</span></p>&#13;
<p class="noindenti">You can use the <code>dist-*</code> options to change the default distribution package type. By default, <code>make dist</code> builds a <em>.tar.gz</em> file, but developers often want to distribute, for example, <em>.tar.xz</em> packages instead. These options make the change quite easy. (Even without the <code>dist-xz</code> option, you can override the current default by using <code>make dist-xz</code>, but using the option is simpler if you always want to build <em>.xz</em> packages.)</p>&#13;
<p class="noindentt"><span class="codestrong1">readme-alpha</span></p>&#13;
<p class="noindenti">The <code>readme-alpha</code> option temporarily alters the behavior of the build and distribution processes during alpha releases of a project. Using this option causes a file named <em>README-alpha</em>, found in the project root directory, to be distributed automatically. The use of this option also alters the expected versioning scheme of the project.</p>&#13;
<p class="noindentt"><span epub:type="pagebreak" id="page_149"/><span class="codestrong1">-W</span> <span class="codeitalicB">category</span>, <span class="codestrong1">--warnings=</span><span class="codeitalicB">category</span></p>&#13;
<p class="noindenti">The <code>-W</code> <em><code>category</code></em> and <code>--warnings=</code><em><code>category</code></em> options indicate that the project would like to use Automake with various warning categories enabled. Multiple such options can be used with different category tags. Refer to the <em>GNU Automake Manual</em> to find a list of valid categories.</p>&#13;
<p class="noindentt"><span class="codestrong1">parallel-tests</span></p>&#13;
<p class="noindenti">The <code>parallel-tests</code> feature allows checks to be executed in parallel in order to take advantage of multiprocessor machines during execution of the <code>check</code> target.</p>&#13;
<p class="noindentt"><span class="codestrong1">subdir-objects</span></p>&#13;
<p class="noindenti">The <code>subdir-objects</code> option is required when you intend to reference sources from directories other than the current directory. Using this option causes Automake to generate <code>make</code> commands that cause object and intermediate files to be generated into the same directory as the source file. For more information on this option, see “Nonrecursive Automake” on <a href="ch06.xhtml#page_175">page 175</a>.</p>&#13;
<p class="noindentt"><span class="codestrong1">version</span></p>&#13;
<p class="noindenti">The <em><code>version</code></em> option is actually a placeholder for a version number that represents the lowest version of Automake that is acceptable for this project. For instance, if <code>1.11</code> is passed as an option tag, Automake will fail while processing <em>configure.ac</em> if its version is earlier than 1.11. This can be useful if you’re trying to use features that only exist in later versions of Automake.</p>&#13;
<p class="indentt">With the new <em>Makefile.am</em> files in place and Automake enabled in <em>configure.ac</em>, let’s run <code>autoreconf</code> with the <code>-i</code> option in order to add any new utility files that Automake may require for our project:</p>&#13;
<pre>$ <span class="codestrong1">autoreconf -i</span>&#13;
configure.ac:11: installing './compile'&#13;
configure.ac:6: installing './install-sh'&#13;
configure.ac:6: installing './missing'&#13;
Makefile.am: installing './INSTALL'&#13;
Makefile.am: installing './COPYING' using GNU General Public License v3 file&#13;
Makefile.am:     Consider adding the COPYING file to the version control system&#13;
Makefile.am:     for your code, to avoid questions about which license your&#13;
project uses src/Makefile.am: installing './depcomp'&#13;
$&#13;
$ <span class="codestrong1">ls -1p</span>&#13;
aclocal.m4&#13;
AUTHORS&#13;
autom4te.cache/&#13;
ChangeLog&#13;
compile&#13;
config.h.in&#13;
configure&#13;
<span epub:type="pagebreak" id="page_150"/>configure.ac&#13;
COPYING&#13;
depcomp&#13;
INSTALL&#13;
install-sh&#13;
Makefile.am&#13;
Makefile.in&#13;
missing&#13;
NEWS&#13;
README&#13;
src/&#13;
$</pre>&#13;
<p class="indent">Adding the <code>AM_INIT_AUTOMAKE</code> macro to <em>configure.ac</em> causes <code>autoreconf -i</code> to now execute <code>automake -i</code>, which includes a few additional utility files: <em>aclocal.m4</em>, <em>install-sh</em>, <em>compile</em>, <em>missing</em>, and <em>depcomp</em>. Also, Automake now generates <em>Makefile.in</em> from <em>Makefile.am</em>.</p>&#13;
<p class="indent">I mentioned <em>aclocal.m4</em> in <a href="ch02.xhtml">Chapter 2</a> and <code>install-sh</code> in <a href="ch04.xhtml">Chapter 4</a>. The <code>missing</code> script is a little utility helper script that prints a nicely formatted message when a tool specified on its command line is not available. More detail than this is not really required; if you’re curious, execute <code>./missing --help</code> in your project directory.</p>&#13;
<p class="indent">We’ll talk about the <code>depcomp</code> script shortly, but I’d like to mention the purpose of the <code>compile</code> script here. This script is a wrapper around some older compilers that do not understand the concurrent use of the <code>-c</code> and <code>-o</code> command line options. When you use product-specific flags, which we’ll discuss shortly, Automake has to generate code that may compile source files multiple times with different flags for each file. Thus, it has to name the object files differently for each set of flags it uses. The <code>compile</code> script facilitates this process.</p>&#13;
<p class="indent">Automake also adds default <em>INSTALL</em> and <em>COPYING</em> text files containing boilerplate text that pertains specifically to the GNU project. You can modify these files for your projects as you see fit. I find the default <em>INSTALL</em> file text to be useful for general-purpose instructions related to Autotools-built projects, but I like to prepend some project-specific information to the top of this file before committing it to my repository. Automake’s <code>-i</code> option won’t overwrite these text files in a project that already contains them, so feel free to modify the default files as you see fit, once they’ve been added by <code>autoreconf -i</code>.</p>&#13;
<p class="indent">The <em>COPYING</em> file contains the text of the GPL, which may or may not apply to your project. If your project is released under GPL, just leave the text as is. If you’re releasing under another license, such as the BSD, MIT, or Apache Commons licenses, replace the default text with text appropriate for that license.<sup><a id="ch06fn_6" href="footnote.xhtml#ch06fn6">6</a></sup></p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><span epub:type="pagebreak" id="page_151"/><em>You only need to use the <em><code>-i</code></em> option once in a newly checked-out work area or a newly created project. Once the missing utility files have been added, you can drop the <em><code>-i</code></em> option in future calls to <em><code>autoreconf</code></em> unless you add certain macros to</em> configure.ac, <em>which may then cause the use of the <em><code>-i</code></em> option to add more missing files. We’ll see some of this sort of thing in later chapters.</em></p>&#13;
</div>&#13;
<p class="indent">The preceding commands create an Automake-based build system that contains everything (with the minor exception of <code>check</code> functionality, which we’ll get to shortly) that we wrote into our original <em>Makefile.in</em> templates, except that this system is more correct and functionally complete according to the <em>GCS</em>. A glance at the resulting generated <em>Makefile.in</em> template shows that Automake has done a significant amount of work for us. The resulting top-level <em>Makefile.in</em> template is nearly 24KB, while the original, hand-coded makefiles were only a few hundred bytes long.</p>&#13;
<p class="indent">An Automake build system supports the following important <code>make</code> targets (derived from an Automake-generated <em>Makefile</em>):</p>&#13;
<table class="topbot-d">&#13;
<colgroup>&#13;
<col style="width:25%"/>&#13;
<col style="width:30%"/>&#13;
<col style="width:25%"/>&#13;
<col style="width:20%"/>&#13;
</colgroup>&#13;
<tbody>&#13;
<tr>&#13;
<td style="vertical-align: top;"><p class="para"><code>all</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>check</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>clean</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>ctags</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;"><p class="para"><code>dist</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>dist-bzip2</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>dist-gzip</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>dist-lzip</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;"><p class="para"><code>dist-shar</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>dist-tarZ</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>dist-xz</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>dist-zip</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;"><p class="para"><code>distcheck</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>distclean</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>distdir</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>dvi</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;"><p class="para"><code>html</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>info</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>install</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>install-data</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;"><p class="para"><code>install-dvi</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>install-exec</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>install-html</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>install-info</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;"><p class="para"><code>install-pdf</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>install-ps</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>install-strip</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>installcheck</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;"><p class="para"><code>installdirs</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>maintainer-clean</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>mostlyclean</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>pdf</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top;"><p class="para"><code>ps</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>tags</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><code>ininstall</code></p></td>&#13;
<td style="vertical-align: top;"><p class="para"><span class="literal"/></p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<p class="indent">As you can see, this goes far beyond what we could provide in our hand-coded <em>Makefile.in</em> templates. Automake writes this base functionality into every project that uses it.</p>&#13;
<h4 class="h4" id="ch06sec1-2"><em>A Hidden Benefit: Automatic Dependency Tracking</em></h4>&#13;
<p class="noindent">In “Dependency Rules” on <a href="ch03.xhtml#page_46">page 46</a>, we discussed <code>make</code> dependency rules. These are rules we define in makefiles so that <code>make</code> is aware of the hidden relationships between C-language source files and included header files. Automake goes to a lot of trouble to ensure that you don’t have to write such dependency rules for languages it understands, like C, C++, and Fortran. This is an important feature for projects containing more than a few source files.</p>&#13;
<p class="indent">Writing dependency rules by hand for dozens or hundreds of source files is both tedious and error prone. In fact, it’s such a problem that compiler writers often provide a mechanism that enables the compiler to write these rules automatically based on its internal knowledge of the source files and the language. The GNU compilers, among others, support a family of <code>-M</code> options (<code>-M</code>, <code>-MM</code>, <code>-MF</code>, <code>-MG</code>, and so on) on the command line. These options <span epub:type="pagebreak" id="page_152"/>tell the compiler to generate a <code>make</code> dependency rule for the specified source file. (Some of these options can be used on the normal compiler command line, so the dependency rule can be generated when the source file is being compiled.)</p>&#13;
<p class="indent">The simplest of these options is the basic <code>-M</code> option, which causes the compiler to generate a dependency rule for the specified source file on <code>stdout</code> and then terminate. This rule can be captured in a file, which is then included by the makefile so that the dependency information within this rule is incorporated into the directed graph that <code>make</code> builds.</p>&#13;
<p class="indent">But what happens on systems where the native compilers don’t provide dependency generation options, or where they don’t work together with the compilation process? In such cases, Automake provides a wrapper script called <em>depcomp</em> that executes the compiler twice: once for dependency information and again to compile the source file. When the compiler lacks the options to generate <em>any</em> dependency information, another tool may be used to recursively determine which header files affect a given source file. On systems where none of these options is available, automatic dependency generation fails.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>For a more detailed description of the dependency-generating compiler options, see “Item 10: Using Generated Source Code” on <a href="ch18.xhtml#page_529">page 529</a>. For more on Automake dependency management, see the relevant sections of the</em> GNU Automake Manual.</p>&#13;
</div>&#13;
<p class="indent">It’s time now to bite the bullet and give it a try. As with our build system from the previous chapter, run <code>autoreconf</code> (optional since we ran <code>autoreconf -i</code> earlier, but harmless), followed by <code>./configure</code> and <code>make</code>.</p>&#13;
<pre>$ <span class="codestrong1">autoreconf</span>&#13;
$ <span class="codestrong1">./configure</span>&#13;
<span class="codeitalic1">--snip--</span>&#13;
$ <span class="codestrong1">make</span>&#13;
make  all-recursive&#13;
make[1]: Entering directory '/.../jupiter'&#13;
Making all in src&#13;
make[2]: Entering directory '/.../jupiter/src'&#13;
gcc -DHAVE_CONFIG_H -I. -I..         -g -O2 -MT main.o -MD -MP -MF .deps/main.Tpo -c -o main.o main.c&#13;
mv -f .deps/main.Tpo .deps/main.Po&#13;
gcc  -g -O2   -o jupiter main.o  -lpthread&#13;
make[2]: Leaving directory '/.../jupiter/src'&#13;
make[2]: Entering directory '/.../jupiter'&#13;
make[2]: Leaving directory '/.../jupiter'&#13;
make[1]: Leaving directory '/.../jupiter'&#13;
$</pre>&#13;
<p class="indent">You can’t truly appreciate what Automake has done here without trying a few of the other <code>make</code> targets we’ve become familiar with. Try out the <code>install</code>, <code>dist</code>, and <code>distcheck</code> targets on your own to assure yourself that you still have all the functionality you had before you deleted your handwritten <em>Makefile.in</em> templates.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><span epub:type="pagebreak" id="page_153"/><em>The <em><code>check</code></em> target exists as a do-nothing target at this point, but we need to dive into Automake constructs in a bit more detail before we can add our test back in. When we get to it, you’ll see that it’s even simpler than the code we originally wrote</em>.</p>&#13;
</div>&#13;
<h3 class="h3" id="ch06sec2">What’s Actually in a Makefile.am File?</h3>&#13;
<p class="noindent">In <a href="ch04.xhtml">Chapter 4</a>, we discussed how Autoconf accepts as input a shell script sprinkled with M4 macros and then generates the same shell script with those macros fully expanded. Likewise, Automake accepts as input a makefile sprinkled with Automake commands. Just as Autoconf’s input files are simply enhanced shell scripts, Automake <em>Makefile.am</em> files are nothing more than standard makefiles with additional Automake-specific syntax.</p>&#13;
<p class="indent">One significant difference between Autoconf and Automake is that the only text Autoconf outputs is the existing shell script in the input file and any additional shell script resulting from the expansion of embedded M4 macros. Automake, on the other hand, assumes that all makefiles should contain a minimal infrastructure designed to support the <em>GCS</em>, in addition to any targets and variables that you specify.</p>&#13;
<p class="indent">To illustrate this point, create a <em>temp</em> directory in the root of the Jupiter project and add an empty <em>Makefile.am</em> file to it. Next, add this new <em>Makefile.am</em> to the project’s <em>configure.ac</em> file with a text editor and reference it from the top-level <em>Makefile.am</em> file, like this:</p>&#13;
<pre>   $ <span class="codestrong1">mkdir temp</span>&#13;
   $ <span class="codestrong1">touch temp/Makefile.am</span>&#13;
<span class="ent">➊</span> $ <span class="codestrong1">echo "SUBDIRS = src temp" &gt; Makefile.am</span>&#13;
   $ <span class="codestrong1">vi configure.ac</span>&#13;
   <span class="codeitalic1a">--snip--</span>&#13;
   <span class="ash">AC_CONFIG_FILES([Makefile</span>&#13;
                    <span class="ash">src/Makefile</span>&#13;
                 <span class="ent">➋</span> temp/Makefile<span class="ash">])</span>&#13;
   <span class="codeitalic1a">--snip--</span>&#13;
   $ <span class="codestrong1">autoreconf</span>&#13;
   $ <span class="codestrong1">./configure</span>&#13;
   <span class="codeitalic1">--snip--</span>&#13;
   $ <span class="codestrong1">ls -1sh temp</span>&#13;
   total 24K&#13;
<span class="ent">➌</span> 12K Makefile&#13;
   0 Makefile.am&#13;
<span class="ent">➍</span> 12K Makefile.in&#13;
   $</pre>&#13;
<p class="indent">I used an <code>echo</code> statement at <span class="ent">➊</span> to rewrite a new top-level <em>Makefile.am</em> file that has <code>SUBDIRS</code> reference both <em>src</em> and <em>temp</em>. I used a text editor to add <em>temp/Makefile</em> to the list of makefiles Autoconf will generate from templates (<span class="ent">➋</span>). As you can see, there is a certain amount of support code generated into every <span epub:type="pagebreak" id="page_154"/>makefile that Automake considers indispensable. Even an empty <em>Makefile.am</em> file generates a 12KB <em>Makefile.in</em> template (<span class="ent">➍</span>), from which <code>configure</code> generates a similarly sized <em>Makefile</em> (<span class="ent">➌</span>).<sup><a id="ch06fn_7" href="footnote.xhtml#ch06fn7">7</a></sup></p>&#13;
<p class="indent">Since the <code>make</code> utility uses a fairly rigid set of rules for processing makefiles, Automake takes some license with your additional <code>make</code> code. Here are some specifics:</p>&#13;
<ul>&#13;
<li class="noindent">The <code>make</code> variables defined in <em>Makefile.am</em> files are placed at the top of the resulting <em>Makefile.in</em> template, immediately following any Automake-generated variable definitions.</li>&#13;
<li class="noindent">The <code>make</code> rules specified in <em>Makefile.am</em> files are placed at the end of the resulting <em>Makefile.in</em> template, immediately after any Automake-generated rules.</li>&#13;
<li class="noindent">Most Autoconf variables substituted by <code>config.status</code> are converted to <code>make</code> variables and initialized to those substitution variables.</li>&#13;
</ul>&#13;
<p class="indent">The <code>make</code> utility doesn’t care where rules are in relation to each other, because it reads every rule into an internal database before processing any of them. Variables are treated similarly, as long as they are defined before the rules that use them. In order to avoid any variable-binding issues, Automake places all variables at the top of the output file in the order in which they’re defined in the input file.</p>&#13;
<h3 class="h3" id="ch06sec3">Analyzing Our New Build System</h3>&#13;
<p class="noindent">Now let’s look at what we put into those two simple <em>Makefile.am</em> files, beginning with the top-level <em>Makefile.am</em> file (shown in <a href="ch06.xhtml#ch06ex2">Listing 6-2</a>).</p>&#13;
<pre>SUBDIRS = src</pre>&#13;
<p class="caption" id="ch06ex2"><em>Listing 6-2:</em> Makefile.am: <em>The top-level</em> Makefile.am <em>file contains only a subdirectory reference.</em></p>&#13;
<p class="indentb">This single line of text tells Automake several things about our project:</p>&#13;
<ul>&#13;
<li class="noindent">One or more subdirectories contain makefiles to be processed in addition to this file.<sup><a id="ch06fn_8" href="footnote.xhtml#ch06fn8">8</a></sup></li>&#13;
<li class="noindent">Directories in this space-delimited list should be processed in the order specified.</li>&#13;
<li class="noindent"><span epub:type="pagebreak" id="page_155"/>Directories in this list should be recursively processed for all primary targets.</li>&#13;
<li class="noindent">Directories in this list should be treated as part of the project distribution, unless otherwise specified.</li>&#13;
</ul>&#13;
<p class="indent">As with most Automake constructs, <code>SUBDIRS</code> is simply a <code>make</code> variable that has special meaning for Automake. The <code>SUBDIRS</code> variable may be used to process <em>Makefile.am</em> files within arbitrarily complex directory structures, and the directory list may contain any relative directory references (not just immediate subdirectories). You might say that <code>SUBDIRS</code> is kind of like the glue that holds makefiles together in a project’s directory hierarchy, when using a recursive build system.</p>&#13;
<p class="indent">Automake generates recursive <code>make</code> rules that implicitly process the current directory after those specified in the <code>SUBDIRS</code> list, but it’s often necessary to build the current directory before some or all of the other directories in the list. You may change the default ordering by referencing the current directory with a dot anywhere in the <code>SUBDIRS</code> list. For example, to build the top-level directory before the <em>src</em> directory, you could change the <code>SUBDIRS</code> variable in <a href="ch06.xhtml#ch06ex2">Listing 6-2</a> as follows:</p>&#13;
<pre>SUBDIRS = . src</pre>&#13;
<p class="indent">Now let’s turn to the <em>Makefile.am</em> file in the <em>src</em> directory, shown in <a href="ch06.xhtml#ch06ex3">Listing 6-3</a>.</p>&#13;
<pre>bin_PROGRAMS = jupiter&#13;
jupiter_SOURCES = main.c</pre>&#13;
<p class="caption" id="ch06ex3"><em>Listing 6-3:</em> src/Makefile.am: <em>The initial version of this</em> Makefile.am <em>file contains only two lines</em></p>&#13;
<p class="indent">The first line is a <em>product list variable</em> specification, and the second line is a <em>product source variable</em> specification.</p>&#13;
<h4 class="h4" id="ch06sec3-1"><em>Product List Variables</em></h4>&#13;
<p class="noindent">Products are specified in a <em>Makefile.am</em> file using a <em>product list variable (PLV)</em>, which (like <code>SUBDIRS</code>) is a class of <code>make</code> variables that have special meaning to Automake. The following template shows the general format of a PLV:</p>&#13;
<pre>[<span class="codeitalic1">modifier-list</span>]<span class="codeitalic1">prefix</span>_<span class="codeitalic1">PRIMARY</span> = product1 product2 ... product<span class="codeitalic1">N</span></pre>&#13;
<p class="indent">The PLV name in the first line of <a href="ch06.xhtml#ch06ex3">Listing 6-3</a> consists of two components: the <em>prefix</em> (<em>bin</em>) and the <em>primary</em> (<code>PROGRAMS</code>), separated by an underscore (<code>_</code>). The value of the variable is a whitespace-separated list of products generated by this <em>Makefile.am</em> file.</p>&#13;
<h5 class="h5"><span epub:type="pagebreak" id="page_156"/>Installation Location Prefixes</h5>&#13;
<p class="noindent">The <em>bin</em> portion of the product list variable shown in <a href="ch06.xhtml#ch06ex3">Listing 6-3</a> is an example of an <em>installation location prefix</em>. The <em>GCS</em> defines many common installation locations, and most are listed in <a href="ch03.xhtml#ch03tab1">Table 3-1</a> on <a href="ch03.xhtml#page_65">page 65</a>. However, any <code>make</code> variable ending in <code>dir</code>, whose value is a filesystem location, is a viable installation location variable and may be used as a prefix in an Automake PLV.</p>&#13;
<p class="indent">You reference an installation location variable in a PLV prefix by omitting the <code>dir</code> portion of the variable name. For example, in <a href="ch06.xhtml#ch06ex3">Listing 6-3</a>, the <code>$(bindir)</code> <code>make</code> variable is referred to only as <code>bin</code> when it is used as an installation location prefix.</p>&#13;
<p class="indent">Automake also recognizes four installation location variables starting with the special <code>pkg</code> prefix: <code>pkglibdir</code>, <code>pkgincludedir</code>, <code>pkgdatadir</code>, and <code>pkglibexecdir</code>. These <code>pkg</code> versions of the standard <code>libdir</code>, <code>includedir</code>, <code>datadir</code>, and <code>libexecdir</code> variables indicate that the listed products should be installed in a subdirectory of these locations named after the package. For example, in the Jupiter project, products listed in a PLV prefixed with <code>lib</code> would be installed into <code>$(libdir)</code>, while those listed in a PLV prefixed with <code>pkglib</code> would be installed into <code>$(libdir)</code><em>/jupiter</em>.</p>&#13;
<p class="indent">Since Automake derives the list of valid installation locations and prefixes from all <code>make</code> variables ending in <code>dir</code>, you may provide your own PLV prefixes that refer to custom installation locations. To install a set of XML files into an <em>xml</em> directory within the system data directory, you could use the code in <a href="ch06.xhtml#ch06ex4">Listing 6-4</a> in your <em>Makefile.am</em> file.</p>&#13;
<pre>xmldir = $(datadir)/xml&#13;
xml_DATA = file1.xml file2.xml file3.xml ...</pre>&#13;
<p class="caption" id="ch06ex4"><em>Listing 6-4: Specifying a custom installation directory</em></p>&#13;
<p class="indent">Installation location variables will contain default values defined either by Automake-generated makefiles or by you in your <em>Makefile.am</em> files, but your users can always override these default values on their <code>configure</code> or <code>make</code> command lines. If you don’t want certain products to be installed during a particular build, specify an empty value in an installation location variable on the command line; the Automake-generated rules will ensure that products intended for those directories aren’t installed. For example, to install only documentation and shared data files for a package, you could enter <code>make bindir='' libdir='' install</code>.<sup><a id="ch06fn_9" href="footnote.xhtml#ch06fn9">9</a></sup></p>&#13;
<h5 class="h5">Prefixes Not Associated with Installation</h5>&#13;
<p class="noindent">Certain prefixes are not related to installation locations. For example, <code>noinst</code>, <code>check</code>, and <code>EXTRA</code> are used (respectively) to indicate products that are not installed, are used only for testing, or are optionally built. Here’s a little more information about these three prefixes:</p>&#13;
<p class="noindentt"><span epub:type="pagebreak" id="page_157"/><span class="codestrong1">noinst</span></p>&#13;
<p class="noindenti">Indicates that the listed products should be built but not installed. For example, a static so-called <em>convenience library</em> might be built as an intermediate product and then used in other stages of the build process to build final products. The <code>noinst</code> prefix tells Automake that the product should not be installed and that only a static library should be built. (After all, it makes no sense to build a shared library that won’t be installed.)</p>&#13;
<p class="noindentt"><span class="codestrong1">check</span></p>&#13;
<p class="noindenti">Indicates products that are to be built only for testing purposes and will thus not need to be installed. Products listed in PLVs prefixed with <code>check</code> are built only if the user enters <code>make check</code>.</p>&#13;
<p class="noindentt"><span class="codestrong1">EXTRA</span></p>&#13;
<p class="bqpara">Used to list programs that are conditionally built. Automake requires that all source files be specified statically within a <em>Makefile.am</em> file, as opposed to being calculated or derived during the build process, so that it can generate a <em>Makefile.in</em> template that will work for any possible command line. However, a project maintainer may elect to allow some products to be built conditionally based on configuration options given to the <code>configure</code> script. If products are listed in variables generated by the <code>configure</code> script, they should also be listed in a PLV, prefixed with <code>EXTRA</code>, within a <em>Makefile.am</em> file. This concept is illustrated in <a href="ch06.xhtml#ch06ex5">Listings 6-5</a> and <a href="ch06.xhtml#ch06ex6">6-6</a>.</p>&#13;
<pre>AC_INIT(...)&#13;
<span class="codeitalic1">--snip--</span>&#13;
optional_programs=&#13;
AC_SUBST([optional_programs])&#13;
<span class="codeitalic1">--snip--</span>&#13;
if test "x$(build_opt_prog)" = xyes; then&#13;
<span class="ent">➊</span> optional_programs=$(optional_programs) optprog&#13;
fi&#13;
<span class="codeitalic1">--snip--</span></pre>&#13;
<p class="caption" id="ch06ex5"><em>Listing 6-5: A conditionally built program defined in a shell variable in</em> configure.ac</p>&#13;
<pre><span class="ent">➋</span> EXTRA_PROGRAMS = optprog&#13;
<span class="ent">➌</span> bin_PROGRAMS = myprog $(optional_programs)</pre>&#13;
<p class="caption" id="ch06ex6"><em>Listing 6-6: Using the <code>EXTRA</code> prefix to conditionally define products in</em> Makefile.am</p>&#13;
<p class="indent">At <span class="ent">➊</span> in <a href="ch06.xhtml#ch06ex5">Listing 6-5</a>, <code>optprog</code> is appended to an Autoconf substitution variable called <code>optional_programs</code>. The <code>EXTRA_PROGRAMS</code> variable at <span class="ent">➋</span> in <a href="ch06.xhtml#ch06ex6">Listing 6-6</a> lists <code>optprog</code> as a product that may or may not be built, based on end-user configuration choices that determine whether <code>$(optional_programs)</code> at <span class="ent">➌</span> is empty or contains <code>optprog</code>.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_158"/>While it may appear redundant to specify <code>optprog</code> in both <em>configure.ac</em> and <em>Makefile.am</em>, Automake needs the information in <code>EXTRA_PROGRAMS</code> because it cannot attempt to interpret the possible values of <code>$(optional_programs)</code>, as defined in <em>configure.ac</em>. Hence, adding <code>optprog</code> to <code>EXTRA_PROGRAMS</code> in this example tells Automake to generate rules to build it, even if <code>$(optional_programs)</code> doesn’t contain <code>optprog</code> during a particular build.</p>&#13;
<h5 class="h5">Primaries</h5>&#13;
<p class="noindent"><em>Primaries</em> are like product classes, and they represent types of products that might be generated by a build system. A primary defines the set of steps required to build, test, install, and execute a particular class of products. For example, programs and libraries are built using different compiler and linker commands, Java classes require a virtual machine to execute them, and Python programs require an interpreter. Some product classes, such as scripts, data, and headers, have no build, test, or execution semantics—only installation semantics.</p>&#13;
<p class="indent">The list of supported primaries defines the set of product classes that can be built automatically by an Automake build system. Automake build systems can still build other product classes, but the maintainer must define the <code>make</code> rules explicitly within the project’s <em>Makefile.am</em> files.</p>&#13;
<p class="indent">A thorough understanding the Automake primaries is the key to properly using Automake. The current complete list of supported primaries is as follows.</p>&#13;
<p class="noindentt"><span class="codestrong1">PROGRAMS</span></p>&#13;
<p class="noindenti">When the <code>PROGRAMS</code> primary is used in a PLV, Automake generates <code>make</code> rules that use compilers and linkers to build binary executable programs for the listed products.</p>&#13;
<p class="noindentt"><span class="codestrong1">LIBRARIES</span>/<span class="codestrong1">LTLIBRARIES</span></p>&#13;
<p class="noindenti">The use of the <code>LIBRARIES</code> primary causes Automake to generate rules that build static archives (libraries) using the system compiler and librarian. The <code>LTLIBRARIES</code> primary does the same thing, but the generated rules also build Libtool shared libraries and execute these tools (as well as the linker) through the <code>libtool</code> script. (I’ll discuss the Libtool package in detail in <a href="ch07.xhtml">Chapters 7</a> and <a href="ch08.xhtml">8</a>.) Automake restricts the installation locations for the <code>LIBRARIES</code> and <code>LTLIBRARIES</code> primaries: they can only be installed in <code>$(libdir)</code> and <code>$(pkglibdir)</code>.</p>&#13;
<p class="noindentt"><span class="codestrong1">LISP</span></p>&#13;
<p class="noindenti">The <code>LISP</code> primary was designed mainly to manage the build for Emacs Lisp programs. Hence, it expects to refer to a list of <em>.el</em> files. You can find details on the use of this primary in Section 10.1 of the Automake manual.</p>&#13;
<p class="noindentt"><span class="codestrong1">PYTHON</span></p>&#13;
<p class="noindenti">Python is an interpreted language; the <code>python</code> interpreter converts a Python script, line by line, into Python byte code, executing it as it’s <span epub:type="pagebreak" id="page_159"/>converted, so (like shell scripts) Python source files are executable as written. The use of the <code>PYTHON</code> primary tells Automake to generate rules that precompile Python source files (<em>.py</em>) into standard (<em>.pyc</em>) and optimized (<em>.pyo</em>) byte-compiled versions using the <code>py-compile</code> utility. Because of the normally interpreted nature of Python sources, this compilation occurs at install time rather than at build time.</p>&#13;
<p class="noindentt"><span class="codestrong1">JAVA</span></p>&#13;
<p class="noindenti">Java is a virtual machine platform; the use of the <code>JAVA</code> primary tells Automake to generate rules that convert Java source files (<em>.java</em>) into Java class files (<em>.class</em>) using the <code>javac</code> compiler. While this process is correct, it’s not complete. Java programs (of any consequence) generally contain more than one class file and are usually packaged as <em>.jar</em> or <em>.war</em> files, both of which may also contain several ancillary text files. The <code>JAVA</code> primary is useful, but only just. (I’ll discuss using—and extending—the <code>JAVA</code> primary in “Building Java Sources Using the Autotools” on <a href="ch15.xhtml#page_408">page 408</a>.)</p>&#13;
<p class="noindentt"><span class="codestrong1">SCRIPTS</span></p>&#13;
<p class="noindenti"><em>Script</em>, in this context, refers to any interpreted text file—whether it’s shell, Perl, Python, Tcl/Tk, JavaScript, Ruby, PHP, Icon, Rexx, or some other. Automake allows a restricted set of installation locations for the <code>SCRIPTS</code> primary, including <code>$(bindir)</code>, <code>$(sbindir)</code>, <code>$(libexecdir)</code>, and <code>$(pkgdatadir)</code>. While Automake doesn’t generate rules to build scripts, it also doesn’t assume that a script is a static file in the project. Scripts are often generated by handwritten rules in <em>Makefile.am</em> files, sometimes by processing an input file with the <code>sed</code> or <code>awk</code> utility. For this reason, scripts are not distributed automatically. If you have a static script in your project that you’d like Automake to add to your distribution archive, you should prefix the <code>SCRIPTS</code> primary with the <code>dist</code> modifier as discussed in “PLV and PSV Modifiers” on <a href="ch06.xhtml#page_161">page 161</a>.</p>&#13;
<p class="noindentt"><span class="codestrong1">DATA</span></p>&#13;
<p class="noindenti">Arbitrary data files can be installed using the <code>DATA</code> primary in a PLV. Automake allows a restricted set of installation locations for the <code>DATA</code> primary, including <code>$(datadir)</code>, <code>$(sysconfdir)</code>, <code>$(sharedstatedir)</code>, <code>$(localstatedir</code><code>)</code>, and <code>$(pkgdatadir)</code>. Data files are not automatically distributed, so if your project contains static data files, use the <code>dist</code> modifier on the <code>DATA</code> primary as discussed in “PLV and PSV Modifiers” on <a href="ch06.xhtml#page_161">page 161</a>.</p>&#13;
<p class="noindentt"><span class="codestrong1">HEADERS</span></p>&#13;
<p class="noindenti">Header files are a form of source file. Were it not for the fact that some header files are installed, they could simply be listed with the product sources. Header files containing the public interface for installed library products are installed into either the <code>$(includedir)</code> or a package-specific subdirectory defined by <code>$(pkgincludedir)</code>, so the most common PLVs for such installed headers are the <code>include_HEADERS</code> and <code>pkginclude_HEADERS</code> <span epub:type="pagebreak" id="page_160"/>variables. Like other source files, header files are distributed automatically. If you have a generated header file, use the <code>nodist</code> modifier with the <code>HEADERS</code> primary as discussed in “PLV and PSV Modifiers” on <a href="ch06.xhtml#page_161">page 161</a>.</p>&#13;
<p class="noindentt"><span class="codestrong1">MANS</span></p>&#13;
<p class="noindenti"><em>Man pages</em> are UTF-8 text files containing <code>troff</code> markup, which is rendered by <code>man</code> when viewed by a user. Man pages can be installed using the <code>man_MANS</code> or <code>man</code><em><code>N</code></em><code>_MANS</code> product list variables, where <em><code>N</code></em> represents a single-digit section number between 0 and 9 or the letters <em>l</em> (for math library topics) or <em>n</em> (for Tcl/Tk topics). Files in the <code>man_MANS</code> PLV should have a numeric extension indicating the man section to which they belong and, therefore, their target directory. Files in the <code>man</code><em><code>N</code></em><code>_MANS</code> PLV may be named with either numeric extensions or a <em>.man</em> extension and will be renamed to the associated numeric extensions when they’re installed by <code>make install</code>. Project man pages are not distributed by default because man pages are often generated, so you should use the <code>dist</code> modifier as discussed in “PLV and PSV Modifiers” on <a href="ch06.xhtml#page_161">page 161</a>.</p>&#13;
<p class="noindentt"><span class="codestrong1">TEXINFOS</span></p>&#13;
<p class="noindenti">When it comes to Linux or Unix documentation, Texinfo<sup><a id="ch06fn_10" href="footnote.xhtml#ch06fn10">10</a></sup> is the GNU project format of choice. The <code>makeinfo</code> utility accepts Texinfo source files (<em>.texinfo</em>, <em>.txi</em>, or <em>.texi</em>) and renders info files (<em>.info</em>) containing UTF-8 text annotated with Texinfo markup, which the <code>info</code> utility renders into formatted text for the user. The most common product list variable for use with Texinfo sources is <code>info_TEXINFOS</code>. The use of this PLV causes Automake to generate rules to build <em>.info</em>, <em>.dvi</em>, <em>.ps</em>, and <em>.html</em> documentation files. However, only the <em>.info</em> files are built with <code>make all</code> and installed with <code>make install</code>. In order to build and install the other types of files, you must specify the <code>dvi</code>, <code>ps</code>, <code>pdf</code>, <code>html</code>, <code>install-dvi</code>, <code>install-ps</code><span class="literal"/>, <code>install-pdf</code>, and <code>install-html</code> targets explicitly on the <code>make</code> command line. Since the <code>makeinfo</code> utility is not installed by default in many Linux distributions, the generated <em>.info</em> files are automatically added to distribution archives so your end users won’t have to go looking for <code>makeinfo</code>.</p>&#13;
<h4 class="h4" id="ch06sec3-2"><em>Product Source Variables</em></h4>&#13;
<p class="noindent">The second line in <a href="ch06.xhtml#ch06ex3">Listing 6-3</a> is an example of an Automake <em>product source variable</em> (<em>PSV</em>). PSVs conform to the following template:</p>&#13;
<pre>[<span class="codeitalic1">modifier-list</span>]<span class="codeitalic1">product</span>_SOURCES = file1 file2 ... file<span class="codeitalic1">N</span></pre>&#13;
<p class="indent">Like PLVs, PSVs are composed of multiple parts: the product name (<code>jupiter</code> in this case) and the <code>SOURCES</code> tag. The value of a PSV is a whitespace-separated list of source files from which <em><code>product</code></em> is built. The value of the <span epub:type="pagebreak" id="page_161"/>PSV in the second line of <a href="ch06.xhtml#ch06ex3">Listing 6-3</a> is the list of source files used to build the <code>jupiter</code> program. Ultimately, Automake adds these files to various <code>make</code> rule dependency lists and commands in the generated <em>Makefile.in</em> templates.</p>&#13;
<p class="indent">Only characters that are allowed in <code>make</code> variables (letters, numbers, the at sign, and underscore) are allowed in the <code>product</code> tag of a PSV. As a result, Automake performs a transformation on product names listed in PLVs to render the <em><code>product</code></em> tags used in the associated PSVs. Automake converts illegal characters into underscores, as shown in <a href="ch06.xhtml#ch06ex7">Listing 6-7</a>.</p>&#13;
<pre><span class="ent">➊</span> lib_LIBRARIES = libc++.a&#13;
<span class="ent">➋</span> libc___a_SOURCES = ...</pre>&#13;
<p class="caption" id="ch06ex7"><em>Listing 6-7: Illegal <code>make</code> variable characters are converted to underscores in <code>product</code> tags.</em></p>&#13;
<p class="indent">Here, Automake converts <em>libc++.a</em> in the PLV at <span class="ent">➊</span> into the PSV <code>product</code> tag <code>libc___a</code> (that’s three underscores) to find the associated PSV at <span class="ent">➋</span> in the <em>Makefile.am</em> file. You must know the transformation rules so you can write PSVs that match your products.</p>&#13;
<h4 class="h4" id="ch06sec3-3"><em>PLV and PSV Modifiers</em></h4>&#13;
<p class="noindent">The <code>modifier-list</code> portions of the PLV and PSV templates defined previously contain a set of optional modifiers. The following BNF-like rule defines the format of the <code>modifier-list</code> element of these templates:</p>&#13;
<pre><span class="codeitalic1">modifier-list</span> = <span class="codeitalic1">modifier</span>_[<span class="codeitalic1">modifier-list</span>]</pre>&#13;
<p class="indent">Modifiers change the normal behavior of the variable to which they are prepended. The currently defined set of prefix modifiers includes <code>dist</code>, <code>nodist</code>, <code>nobase</code>, and <code>notrans</code>.</p>&#13;
<p class="indent">The <code>dist</code> modifier indicates a set of files that should be distributed (that is, that should be included in the distribution package that’s built when <code>make dist</code> is executed). For example, assuming that some source files for a product should be distributed and some should not, the variables shown in <a href="ch06.xhtml#ch06ex8">Listing 6-8</a> might be defined in the product’s <em>Makefile.am</em> file.</p>&#13;
<pre>dist_myprog_SOURCES = file1.c file2.c&#13;
nodist_myprog_SOURCES = file3.c file4.c</pre>&#13;
<p class="caption" id="ch06ex8"><em>Listing 6-8: Using the <code>dist</code> and <code>nodist</code> modifiers in a</em> Makefile.am <em>file</em></p>&#13;
<p class="indent">Automake normally strips relative path information from the list of header files in a <code>HEADERS</code> PLV. The <code>nobase</code> modifier is used to suppress the removal of path information from installed header files that are obtained from subdirectories by a <em>Makefile.am</em> file. For example, take a look at the PLV definition in <a href="ch06.xhtml#ch06ex9">Listing 6-9</a>.</p>&#13;
<pre>nobase_pkginclude_HEADERS = mylib.h sys/constants.h</pre>&#13;
<p class="caption" id="ch06ex9"><em>Listing 6-9: Using the <code>nobase</code> PLV modifier in a</em> Makefile.am <em>file</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_162"/>In this line we can see that <em>mylib.h</em> is in the same directory as <em>Makefile.am</em>, but <em>constants.h</em> is located in a subdirectory called <em>sys</em>. Normally, both files would be installed into <code>$(pkgincludedir)</code> by virtue of the <code>pkginclude</code> installation location prefix. However, since we’re using the <code>nobase</code> modifier, Automake will retain the <em>sys/</em> portion of the second file’s path for installation, and <em>constants.h</em> will be installed into <code>$(pkgincludedir)</code><em>/sys</em>. This is useful when you want the installation (destination) directory structure to be the same as the project (source) directory structure as files are copied during installation.</p>&#13;
<p class="indent">The <code>notrans</code> modifier may be used on man page PLVs for man pages whose names should not be transformed during installation. (Normally, Automake will generate rules to rename the extension on man pages from <em>.man</em> to <em>.N</em>—where <em>N</em> is <em>0</em>, <em>1</em>, . . . , <em>9</em>, <em>l</em>, <em>n</em>—as they’re installed.)</p>&#13;
<p class="indent">You can also use the <code>EXTRA</code> prefix as a modifier. When used with a product source variable (such as <code>jupiter_SOURCES</code>), <code>EXTRA</code> specifies extra source files that are directly associated with the <code>jupiter</code> product, as shown in <a href="ch06.xhtml#ch06ex10">Listing 6-10</a>.</p>&#13;
<pre>EXTRA_jupiter_SOURCES = possibly.c</pre>&#13;
<p class="caption" id="ch06ex10"><em>Listing 6-10: Using the <code>EXTRA</code> prefix with a product <code>SOURCES</code> variable</em></p>&#13;
<p class="indent">Here, <em>possibly.c</em> may or may not be compiled, based on some condition defined in <em>configure.ac</em>.</p>&#13;
<h3 class="h3" id="ch06sec4">Unit Tests: Supporting make check</h3>&#13;
<p class="noindent">In <a href="ch03.xhtml">Chapter 3</a>, we added code to <em>src/Makefile</em> that executes the <code>jupiter</code> program and checks for the proper output string when the user makes the <code>check</code> target. We now have enough information to add our <code>check</code> target test back into our new Automake build system. I’ve duplicated the <code>check</code> target code in <a href="ch06.xhtml#ch06ex11">Listing 6-11</a> for reference in the following discussion.</p>&#13;
<pre><span class="codeitalic1">--snip--</span>&#13;
check: all&#13;
        ./jupiter | grep "Hello from .*jupiter!"&#13;
        @echo "*** ALL TESTS PASSED ***"&#13;
<span class="codeitalic1">--snip</span><span class="codeitalic1">--</span></pre>&#13;
<p class="caption" id="ch06ex11"><em>Listing 6-11: The <code>check</code> target from <a href="ch03.xhtml">Chapter 3</a></em></p>&#13;
<p class="indent">Fortunately, Automake has solid support for unit tests. To add our simple <code>grep</code> test back into the new Automake-generated build system, we can add a few lines to the bottom of <em>src/Makefile.am</em>, as shown in <a href="ch06.xhtml#ch06ex12">Listing 6-12</a>.</p>&#13;
<p class="margin">Git tag 6.1</p>&#13;
<pre>   <span class="ash">bin_PROGRAMS = jupiter</span>&#13;
   <span class="ash">jupiter_SOURCES = main.c</span>&#13;
&#13;
<span class="ent">➊</span> check_SCRIPTS = greptest.sh&#13;
<span class="ent">➋</span> TESTS = $(check_SCRIPTS)&#13;
&#13;
   greptest.sh:&#13;
&#13;
<span epub:type="pagebreak" id="page_163"/>         echo './jupiter | grep "Hello from .*jupiter!"' &gt; greptest.sh&#13;
         chmod +x greptest.sh&#13;
&#13;
<span class="ent">➌</span> CLEANFILES = greptest.sh</pre>&#13;
<p class="caption" id="ch06ex12"><em>Listing 6-12:</em> src/Makefile.am: <em>Additional code required to support the <code>check</code> target</em></p>&#13;
<p class="indent">The <code>check_SCRIPTS</code> line at <span class="ent">➊</span> is a PLV that refers to a script generated at build time. Since the prefix is <code>check</code>, we know that scripts listed in this line will only be built when the user enters <code>make check</code>. However, we must supply a <code>make</code> rule for building the script as well as a rule for removing the file later, during execution of the <code>clean</code> target. We use the <code>CLEANFILES</code> variable at <span class="ent">➌</span> to extend the list of files that Automake deletes during <code>make clean</code>.</p>&#13;
<p class="indent">The <code>TESTS</code> line at <span class="ent">➋</span> is the important one in <a href="ch06.xhtml#ch06ex12">Listing 6-12</a> because it indicates which targets are executed when the user makes the <code>check</code> target. (Since the <code>check_SCRIPTS</code> variable contains a complete list of these targets, I simply referenced it here, as the <code>make</code> variable that it actually is.) Note that in this particular case, <code>check_SCRIPTS</code> is redundant, because Automake generates rules to ensure that all the programs listed in <code>TESTS</code> are built before the tests are executed. However, <code>check_*</code> PLVs become important when additional helper scripts or programs must be built before those listed in <code>TESTS</code> are executed.</p>&#13;
<p class="indent">It’s not necessarily obvious here, but since we added our first test, we need to re-execute <code>autoreconf -i</code> before running <code>make check</code> in order to add a new utility script: <em>test-driver</em>. You can find places in the Automake documentation that indicate clearly that you must do this, but it’s simpler to just let the build tell you when something is missing and therefore an execution of <code>autoreconf (-i)</code> is required. To give you a flavor for this process, let’s try it without running <code>autoreconf</code> first:</p>&#13;
<pre>$ <span class="codestrong1">make check</span>&#13;
Making check in src&#13;
make[1]: Entering directory '/.../jupiter/src'&#13;
 cd .. &amp;&amp; /bin/bash /.../jupiter/missing automake-1.15 --gnu src/Makefile&#13;
parallel-tests: error: required file './test-driver' not found&#13;
parallel-tests:   'automake --add-missing' can install 'test-driver'&#13;
Makefile:255: recipe for target 'Makefile.in' failed&#13;
make[1]: *** [Makefile.in] Error 1&#13;
make[1]: Leaving directory '/.../jupiter/src'&#13;
Makefile:352: recipe for target 'check-recursive' failed&#13;
make: *** [check-recursive] Error 1&#13;
$</pre>&#13;
<p class="indent">Now let’s run <code>autoreconf -i</code> first:</p>&#13;
<pre>$ <span class="codestrong1">autoreconf -i</span>&#13;
parallel-tests: installing './test-driver'&#13;
$&#13;
$ <span class="codestrong1">make check</span>&#13;
/bin/bash ./config.status --recheck&#13;
<span epub:type="pagebreak" id="page_164"/>running CONFIG_SHELL=/bin/bash /bin/bash ./configure --no-create --no-recursion&#13;
checking for a BSD-compatible install... /usr/bin/install -c&#13;
checking whether build environment is sane... yes&#13;
checking for a thread-safe mkdir -p... /bin/mkdir -p&#13;
<span class="codeitalic1">--snip--</span>&#13;
Making check in src&#13;
make[1]: Entering directory '/.../jupiter/src'&#13;
make  greptest.sh&#13;
make[2]: Entering directory '/.../jupiter/src'&#13;
echo './jupiter | grep "Hello from .*jupiter!"' &gt; greptest.sh&#13;
chmod +x greptest.sh&#13;
make[2]: Leaving directory '/.../jupiter/src'&#13;
make  check-TESTS&#13;
make[2]: Entering directory '/.../jupiter/src'&#13;
make[3]: Entering directory '/.../jupiter/src'&#13;
PASS: greptest.sh&#13;
============================================================================&#13;
Testsuite summary for Jupiter 1.0&#13;
============================================================================&#13;
# TOTAL: 1&#13;
# PASS:  1&#13;
# SKIP:  0&#13;
# XFAIL: 0&#13;
# FAIL:  0&#13;
# XPASS: 0&#13;
# ERROR: 0&#13;
============================================================================&#13;
make[3]: Leaving directory '/.../jupiter/src'&#13;
make[2]: Leaving directory '/.../jupiter/src'&#13;
make[1]: Leaving directory '/.../jupiter/src'&#13;
make[1]: Entering directory '/.../jupiter'&#13;
make[1]: Leaving directory '/.../jupiter'&#13;
$</pre>&#13;
<p class="indent">After running <code>autoreconf -i</code> (and noting that <code>test-driver</code> was installed into our project), we can see that <code>make check</code> is now successful.</p>&#13;
<p class="indent">Note that I didn’t have to manually invoke <code>configure</code> after running <code>autoreconf -i</code>. The build system is generally smart enough to know when it should re-execute <code>configure</code> for you.</p>&#13;
<h3 class="h3" id="ch06sec5">Reducing Complexity with Convenience Libraries</h3>&#13;
<p class="noindent">Jupiter is fairly trivial as open source software projects go, so in order to highlight some more of Automake’s key features, let’s expand it a little. We’ll first add a convenience library and then modify <code>jupiter</code> to consume this library.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_165"/>A <em>convenience library</em> is a static library that’s only used within the containing project. Such temporary libraries are generally used when multiple binaries in a project need to incorporate the same source code. I’ll move the code in <em>main.c</em> to a library source file and call the function in the library from <code>jupiter</code>’s <code>main</code> routine. Begin by executing the following commands from the top-level project directory:</p>&#13;
<p class="margin">Git tag 6.2</p>&#13;
<pre>$ <span class="codestrong1">mkdir common</span>&#13;
$ <span class="codestrong1">touch common/jupcommon.h</span>&#13;
$ <span class="codestrong1">cp src/main.c common/print.c</span>&#13;
$ <span class="codestrong1">touch common/Makefile.am</span>&#13;
$</pre>&#13;
<p class="indent">Now add the highlighted text from <a href="ch06.xhtml#ch06ex13">Listings 6-13</a> and <a href="ch06.xhtml#ch06ex14">6-14</a> to the <em>.h</em> and <em>.c</em> files, respectively, in the new <em>common</em> directory.</p>&#13;
<pre>int print_routine(const char * name);</pre>&#13;
<p class="caption" id="ch06ex13"><em>Listing 6-13:</em> common/jupcommon.h: <em>The initial version of this file</em></p>&#13;
<pre><span class="ash">#include "config.h"</span>&#13;
&#13;
#include "jupcommon.h"&#13;
&#13;
<span class="ash">#include &lt;stdio.h&gt;</span>&#13;
<span class="ash">#include &lt;stdlib.h&gt;</span>&#13;
&#13;
<span class="ash">#if HAVE_PTHREAD_H</span>&#13;
<span class="ash"># include &lt;pthread.h&gt;</span>&#13;
<span class="ash">#endif</span>&#13;
&#13;
<span class="ash">static void * print_it(void * data)</span>&#13;
<span class="ash">{</span>&#13;
    <span class="ash">printf("Hello from %s!\n", (const char *)data);</span>&#13;
    <span class="ash">return 0;</span>&#13;
<span class="ash">}</span>&#13;
&#13;
int print_routine(const char * name)&#13;
<span class="ash">{</span>&#13;
<span class="ash">#if ASYNC_EXEC</span>&#13;
    <span class="ash">pthread_t tid;</span>&#13;
    <span class="ash">pthread_create(&amp;tid, 0, print_it,</span> (void*)name<span class="ash">);</span>&#13;
    <span class="ash">pthread_join(tid, 0);</span>&#13;
<span class="ash">#else</span>&#13;
    <span class="ash">print_it(</span>name<span class="ash">);</span>&#13;
<span class="ash">#endif</span>&#13;
    <span class="ash">return 0;</span>&#13;
<span class="ash">}</span></pre>&#13;
<p class="caption" id="ch06ex14"><em>Listing 6-14:</em> common/print.c: <em>The initial version of this file</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_166"/>As you can see, <em>print.c</em> is merely a copy of <em>main.c</em>, with a few small modifications (highlighted in <a href="ch06.xhtml#ch06ex14">Listing 6-14</a>). First, I renamed <code>main</code> to <code>print_routine</code>, and then I added the inclusion of the <em>jupcommon.h</em> header file after the inclusion of <em>config.h</em>. The header file provides <code>print_routine</code>’s prototype to <em>src/main.c</em>, where it’s called from <code>main</code>.</p>&#13;
<p class="indent">Next, we modify <em>src/main.c</em>, as shown in <a href="ch06.xhtml#ch06ex15">Listing 6-15</a>, and then add the text in <a href="ch06.xhtml#ch06ex16">Listing 6-16</a> to <em>common/Makefile.am</em>.</p>&#13;
<pre><span class="ash">#include "config.h"</span>&#13;
&#13;
#include "jupcommon.h"&#13;
&#13;
<span class="ash">int main(int argc, char * argv[])</span>&#13;
<span class="ash">{</span>&#13;
    return print_routine(argv[0]);&#13;
<span class="ash">}</span></pre>&#13;
<p class="caption" id="ch06ex15"><em>Listing 6-15:</em> src/main.c: <em>Required modifications to have <code>main</code> call into the new library</em></p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>It may seem odd to include</em> config.h <em>at the top of</em> src/main.c <em>since nothing in that source file appears to use it. The</em> GCS <em>recommends following the standard practice of including</em> config.h <em>at the top of all source files, before any other inclusions, in case something in one of the other included header files makes use of definitions in</em> config.h. <em>I recommend religiously following this practice</em>.</p>&#13;
</div>&#13;
<pre>noinst_LIBRARIES = libjupcommon.a&#13;
libjupcommon_a_SOURCES = jupcommon.h print.c</pre>&#13;
<p class="caption" id="ch06ex16"><em>Listing 6-16:</em> common/Makefile.am: <em>Initial version of this file</em></p>&#13;
<p class="indent">Let’s examine this new <em>Makefile.am</em> file. The first line indicates which products this file should build and install. The <code>noinst</code> prefix indicates that this library is designed solely to make using the source code in the <em>common</em> directory more convenient.</p>&#13;
<p class="indent">We’re creating a static library called <em>libjupcommon.a</em>, also known as an <em>archive</em>. Archives are like <em>.tar</em> files that only contain object files (<em>.o</em>). They can’t be executed or loaded into a process address space like shared libraries, but they can be added to a linker command line like object files. Linkers are smart enough to realize that such archives are merely groups of object files.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Linkers add to the binary product every object file specified explicitly on the command line, but they only extract from archives those object files that are actually referenced in the code being linked. Therefore, if you link to a static library containing 97 object files, but you only call functions in two of them directly or indirectly, only those two object files are added to your program. In contrast, linking to 97 raw object files adds all 97 of those files to your program, regardless of whether you use any of their functionality</em>.</p>&#13;
</div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_167"/>The second line in <a href="ch06.xhtml#ch06ex16">Listing 6-16</a> is a product source variable that contains the list of source files associated with this library.<sup><a id="ch06fn_11" href="footnote.xhtml#ch06fn11">11</a></sup></p>&#13;
<h4 class="h4" id="ch06sec5-1"><em>Product Option Variables</em></h4>&#13;
<p class="noindent">Now we need to add some additional information to <em>src/Makefile.am</em> so that the generated <em>Makefile</em> can find the new library and header file we added to the <em>common</em> directory. Let’s add two more lines to the existing <em>Makefile.am</em> file, as shown in <a href="ch06.xhtml#ch06ex17">Listing 6-17</a>.</p>&#13;
<pre>   <span class="ash">bin_PROGRAMS = jupiter</span>&#13;
   <span class="ash">jupiter_SOURCES = main.c</span>&#13;
<span class="ent">➊</span> jupiter_CPPFLAGS = -I$(top_srcdir)/common&#13;
<span class="ent">➋</span> jupiter_LDADD = ../common/libjupcommon.a&#13;
   <span class="codeitalic1">--snip--</span></pre>&#13;
<p class="caption" id="ch06ex17"><em>Listing 6-17:</em> src/Makefile.am: <em>Adding compiler and linker directives to</em> Makefile.am <em>files</em></p>&#13;
<p class="indent">Like the <code>jupiter_SOURCES</code> variable, these two new variables are derived from the program name. These <em>product option variables (POVs)</em> are used to specify product-specific options to tools that are used to build products from source code.</p>&#13;
<p class="indent">The <code>jupiter_CPPFLAGS</code> variable at <span class="ent">➊</span> adds product-specific C-preprocessor flags to the compiler command line for all source files that are compiled for the <code>jupiter</code> program. The <code>-I$(top_srcdir)/common</code> directive tells the C preprocessor to add <code>$(top_srcdir)</code><em>/common</em> to its list of locations in which to look for header file references.<sup><a id="ch06fn_12" href="footnote.xhtml#ch06fn12">12</a></sup></p>&#13;
<p class="indent">The <code>jupiter_LDADD</code> variable at <span class="ent">➋</span> adds libraries to the <code>jupiter</code> program’s linker command line. The file path <em>../common/libjupcommon.a</em> merely adds an object to the linker command line so that code in this library can become part of the final program.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>You can also use <em><code>$(top_builddir)</code></em>/ in place of ../ to reference the location of the</em> common <em>directory in this path. Using <em><code>$(top_builddir)</code></em> has the added advantage of making it simpler to move this</em> Makefile.am <em>file to another location without having to modify it</em>.</p>&#13;
</div>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_168"/>Adding a library to a <em><code>program</code></em><code>_LDADD</code> or <em><code>library</code></em><code>_LIBADD</code> variable is only necessary for libraries that are built as part of your own package. If you’re linking your program with a library that’s already installed on the user’s system, a call to <code>AC_CHECK_LIB</code> or <code>AC_SEARCH_LIBS</code> in <em>configure.ac</em> will cause the generated <code>configure</code> script to add an appropriate reference to the linker command line via the <code>LIBS</code> variable.</p>&#13;
<p class="indent">The set of POVs supported by Automake are derived mostly from a subset of the standard user variables listed in <a href="ch03.xhtml#ch03tab2">Table 3-2</a> on <a href="ch03.xhtml#page_71">page 71</a>. You’ll find a complete list of program and library option variables in the <em>GNU Autoconf Manual</em>, but here are some of the important ones.</p>&#13;
<p class="noindentt"><span class="codestrong1">product</span><span class="codestrong1">_CPPFLAGS</span></p>&#13;
<p class="noindenti">Use <em><code>product</code></em><code>_CPPFLAGS</code> to pass flags to the C or C++ preprocessor on the compiler command line.</p>&#13;
<p class="noindentt"><span class="codestrong1">product</span><span class="codestrong1">_CFLAGS</span></p>&#13;
<p class="noindenti">Use <em><code>product</code></em><code>_CFLAGS</code> to pass C-compiler flags on the compiler command line.</p>&#13;
<p class="noindentt"><span class="codestrong1">product</span><span class="codestrong1">_CXXFLAGS</span></p>&#13;
<p class="noindenti">Use <em><code>product</code></em><code>_CXXFLAGS</code> to pass C++-compiler flags on the compiler command line.</p>&#13;
<p class="noindentt"><span class="codestrong1">product</span><span class="codestrong1">_LDFLAGS</span></p>&#13;
<p class="noindenti">Use <em><code>product</code></em><code>_LDFLAGS</code> to pass global and order-independent shared library and program linker configuration flags and options to the linker, including <code>-static</code>, <code>-version-info</code>, <code>-release</code>, and so on.</p>&#13;
<p class="noindentt"><span class="codestrong1">program</span><span class="codestrong1">_LDADD</span></p>&#13;
<p class="noindenti">Use <em><code>program</code></em><code>_LDADD</code> to add Libtool objects (<em>.lo</em>) or libraries (<em>.la</em>) or non-Libtool objects (<em>.o</em>) or archives (<em>.a</em>) to the linker command line when linking a program.<sup><a id="ch06fn_13" href="footnote.xhtml#ch06fn13">13</a></sup></p>&#13;
<p class="noindentt"><span class="codestrong1">library</span><span class="codeitalic1"/><span class="codestrong1">_LIBADD</span></p>&#13;
<p class="noindenti">Use <em><code>library</code></em><code>_LIBADD</code> to add non-Libtool linker objects and archives to non-Libtool archives on the <code>ar</code> utility command line. The <code>ar</code> utility will incorporate archives mentioned on the command line into the product archive, so you can use this variable to gather multiple archives together into one.</p>&#13;
<p class="noindentt"><span class="codestrong1">ltlibrary</span><span class="codestrong1">_LIBADD</span></p>&#13;
<p class="noindenti">Use <em><code>ltlibrary</code></em><code>_LIBADD</code> to add Libtool linker objects (<em>.lo</em>) and Libtool static or shared libraries (<em>.la</em>) to a Libtool static or shared library.</p>&#13;
<p class="indent">You can use the last three option variables in this list to pass lists of order-dependent static and shared library references to the linker. You can <span epub:type="pagebreak" id="page_169"/>also use these option variables to pass <code>-L</code> and <code>-l</code> options. The following are acceptable formats: <code>-L</code><em><code>libpath</code></em>, <code>-l</code><em><code>libname</code></em>, <code>[</code><em><code>relpath</code></em><code>/]</code><em><code>archive</code></em><code>.a</code>, <code>[</code><em><code>relpath</code></em><code>/]</code><em><code>objfile</code></em><code>.$(OBJEXT)</code>, <code>[</code><em><code>relpath</code></em><code>/]</code><em><code>ltobject</code></em><code>.lo</code> , and <code>[</code><em><code>relpath</code></em><code>/]</code><em><code>ltarchive</code></em><code>.la</code>. (Note that the term <em><code>relpath</code></em> indicates a relative path within the project, which can be in terms of either relative directory references, using dots, or <code>$(top_builddir)</code>.)</p>&#13;
<h4 class="h4" id="ch06sec5-2"><em>Per-Makefile Option Variables</em></h4>&#13;
<p class="noindent">You’ll often see the Automake variables <code>AM_CPPFLAGS</code> and <code>AM_LDFLAGS</code> used in a <em>Makefile.am</em> file. These per-makefile forms of these flags are used when the maintainer wants to apply the same set of flags to all products specified in the <em>Makefile.am</em> file.<sup><a id="ch06fn_14" href="footnote.xhtml#ch06fn14">14</a></sup> For example, if you need to set a group of preprocessor flags for all products in a <em>Makefile.am</em> file and then add additional flags for a particular product (<code>prog1</code>), you could use the statements shown in <a href="ch06.xhtml#ch06ex18">Listing 6-18</a>.</p>&#13;
<pre>   AM_CFLAGS = ... some flags ...&#13;
   <span class="codeitalic1">--snip--</span>&#13;
<span class="ent">➊</span> prog1_CFLAGS = $(AM_CFLAGS) ... more flags ...&#13;
   <span class="codeitalic1">--snip--</span></pre>&#13;
<p class="caption" id="ch06ex18"><em>Listing 6-18: Using both per-product and per-file flags</em></p>&#13;
<p class="indent">The existence of a per-product variable overrides Automake’s use of the per-makefile variable, so you need to reference the per-makefile variable in the per-product variable in order to have the per-makefile variable affect that product, as shown in <a href="ch06.xhtml#ch06ex18">Listing 6-18</a> at <span class="ent">➊</span>. In order to allow per-product variables to override their per-makefile counterparts, it’s a good idea to reference the per-makefile variable first, before adding any product-specific options.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>User variables, such as <em><code>CFLAGS</code></em>, are reserved for the end user and should never be set by configuration scripts or makefiles. Automake will always append them to the appropriate utility command lines, thus allowing the user to override the options specified in the makefile</em>.</p>&#13;
</div>&#13;
<h3 class="h3" id="ch06sec6">Building the New Library</h3>&#13;
<p class="noindent">Next, we need to edit the <code>SUBDIRS</code> variable in the top-level <em>Makefile.am</em> file in order to include the new <em>common</em> directory we just added. We also need to add the new makefile that was generated in the <em>common</em> directory to the list of files generated from templates in the <code>AC_CONFIG_FILES</code> macro invocation in <em>configure.ac</em>. These changes are shown in <a href="ch06.xhtml#ch06ex19">Listings 6-19</a> and <a href="ch06.xhtml#ch06ex20">6-20</a>.</p>&#13;
<pre><span class="ash">SUBDIRS =</span> common <span class="ash">src</span></pre>&#13;
<p class="caption" id="ch06ex19"><em>Listing 6-19:</em> Makefile.am: <em>Adding the common directory to the <code>SUBDIRS</code> variable</em></p>&#13;
<pre><span epub:type="pagebreak" id="page_170"/><span class="codeitalic1a">--</span><span class="codeitalic1a">snip--</span>&#13;
<span class="ash">AC_CONFIG_FILES([Makefile</span>&#13;
                 common/Makefile&#13;
                 <span class="ash">src/Makefile])</span>&#13;
<span class="codeitalic1a">--snip--</span></pre>&#13;
<p class="caption" id="ch06ex20"><em>Listing 6-20:</em> configure.ac: <em>Adding</em> common/Makefile <em>to the <code>AC_CONFIG_FILES</code> macro</em></p>&#13;
<p class="indent">This is the largest set of changes we’ve made up to this point, but we’re reorganizing the entire application, so it seems reasonable. Let’s give our updated build system a try. Add the <code>-i</code> option to the <code>autoreconf</code> command line so that it will install any additional missing files that might be required after these enhancements. After so many changes, I like to start with a clean slate, so start with <code>make distclean</code>, or some form of the <code>git clean</code> command if you’re running from a git repository work area.</p>&#13;
<pre>   $ <span class="codestrong1">make distclean</span>&#13;
   <span class="codeitalic1">--snip--</span>&#13;
   $ <span class="codestrong1">autoreconf -i</span>&#13;
   configure.ac:11: installing './compile'&#13;
   configure.ac:6: installing './install-sh'&#13;
   configure.ac:6: installing './missing'&#13;
   Makefile.am: installing './INSTALL'&#13;
   Makefile.am: installing './COPYING' using GNU General Public License v3 file&#13;
   Makefile.am:     Consider adding the COPYING file to the version control&#13;
   system&#13;
   Makefile.am:     for your code, to avoid questions about which license your&#13;
   project uses&#13;
<span class="ent">➊</span> common/Makefile.am:1: error: library used but 'RANLIB' is undefined&#13;
   common/Makefile.am:1:  The usual way to define 'RANLIB' is to add 'AC_PROG_&#13;
   RANLIB'&#13;
   common/Makefile.am:1:  to 'configure.ac' and run 'autoconf' again.&#13;
   common/Makefile.am: installing './depcomp'&#13;
   parallel-tests: installing './test-driver'&#13;
   autoreconf: automake failed with exit status: 1&#13;
   $</pre>&#13;
<p class="indent">Well, it looks like we’re not quite done yet. Since we’ve added a new type of entity—static libraries—to our build system, <code>automake</code> (via <code>autoreconf</code>) tells us at <span class="ent">➊</span> that we need to add a new macro, <code>AC_PROG_RANLIB</code>, to the <em>configure.ac</em> file.<sup><a id="ch06fn_15" href="footnote.xhtml#ch06fn15">15</a></sup></p>&#13;
<p class="indent">Add this macro to <em>configure.ac</em>, as shown in <a href="ch06.xhtml#ch06ex21">Listing 6-21</a>.</p>&#13;
<pre><span class="codeitalic1a">--snip--</span>&#13;
<span class="ash"># Checks for programs.</span>&#13;
<span class="ash">AC_PROG_CC</span>&#13;
<span epub:type="pagebreak" id="page_171"/><span class="ash">AC_PROG_INSTALL</span>&#13;
AC_PROG_RANLIB&#13;
<span class="codeitalic1">--snip--</span></pre>&#13;
<p class="caption" id="ch06ex21"><em>Listing 6-21:</em> configure.ac: <em>Adding <code>AC_PROG_RANLIB</code></em></p>&#13;
<p class="indent">Finally, enter <code>autoreconf -i</code> once more. Adding <code>-i</code> ensures that, if the new functionality we added to <em>configure.ac</em> requires any additional files to be installed, <code>autoreconf</code> will do so.</p>&#13;
<pre>$ <span class="codestrong1">autoreconf -i</span>&#13;
$</pre>&#13;
<p class="indent">No more complaints; all is well.</p>&#13;
<h3 class="h3" id="ch06sec7">What Goes into a Distribution?</h3>&#13;
<p class="noindent">Automake usually determines automatically what should go into a distribution created with <code>make dist</code>, because it’s very aware of every file’s role in the build process. To this end, Automake wants to be told about every source file used to build a product and about every file and product installed. This means, of course, that all files must be specified at some point in one or more PLV and PSV variables.<sup><a id="ch06fn_16" href="footnote.xhtml#ch06fn16">16</a></sup></p>&#13;
<p class="indent">The Automake <code>EXTRA_DIST</code> variable contains a space-delimited list of files and directories that should be added to the distribution package when the <code>dist</code> target is made. For example:</p>&#13;
<pre>EXTRA_DIST = windows</pre>&#13;
<p class="indent">You could use the <code>EXTRA_DIST</code> variable to add a source directory to the distribution package that Automake would not automatically add—for example, a Windows-specific directory.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>In this case</em>, windows <em>is a directory, not a file. Automake will automatically recursively add every file in this directory to the distribution package; this may include some files that you really didn’t want there, such as hidden</em> .svn <em>or</em> .CVS <em>status directories. See “Automake -hook and -local Rules” on <a href="ch14.xhtml#page_389">page 389</a> for a way around this problem.</em></p>&#13;
</div>&#13;
<div class="box5">&#13;
<p class="sidebart"><span epub:type="pagebreak" id="page_172"/>A WORD ABOUT THE UTILITY SCRIPTS</p>&#13;
<p class="noindent">The Autotools have added several files to the root of our project directory structure: <code>compile</code>, <code>depcomp</code>, <code>install-sh</code>, and <code>missing</code>. Because <code>configure</code> or the generated <em>Makefile</em>s all execute these scripts at various points during the build process, the end user will need them; however, we can only get them from the Autotools, and we don’t want to require the user to have the Autotools installed. For this reason, these scripts are automatically added to the distribution archive.</p>&#13;
<p class="indent">So, do you check them in to your source code repository or not? The answer is debatable, but generally I recommend that you don’t. Any maintainer who will be creating a distribution archive should have the Autotools installed and should be working from a repository work area. As a result, these maintainers will also be running <code>autoreconf -i</code> (possibly in conjunction with the <code>--force</code> option<a id="ch06sfn_1" href="#ch06sfn1">*</a>) to ensure that they have the most up-to-date Autotools-provided utility scripts. If you check them in, it will only make it more probable that they become out-of-date as time goes by. It will also cause unnecessary churn in your repository revision history as contributors ping-pong back and forth between files generated from the different versions of the Autotools they’re using.</p>&#13;
<p class="indent">I extend this sentiment to the <code>configure</code> script as well. Some people argue that checking the utility and <code>configure</code> scripts into the project repository is beneficial, because it ensures that if someone checked out a work area, they could build the project from the work area without having the Autotools installed. However, my personal philosophy is that developers and maintainers should be expected to have these tools installed. Occasionally, an end user will need to build a project from a work area, but this should be the exception rather than the typical case, and in these exceptional cases, the user should be willing to take on the role and requirements of a maintainer.</p>&#13;
<p class="footnote"><a id="ch06sfn1" href="#ch06sfn_1">*</a> Use the <code>--force</code> option with caution; it will also overwrite text files such as <em>INSTALL</em>, which may have been modified for the project from the default text file that ships with the Autotools.</p>&#13;
</div>&#13;
<h3 class="h3" id="ch06sec8">Maintainer Mode</h3>&#13;
<p class="noindent">Occasionally, timestamps on distribution source files will be newer than the current time setting of a user’s system clock. Regardless of the cause, this inconsistency confuses <code>make</code>, causing it to think that every source file is out-of-date and needs to be rebuilt. As a result, it will re-execute the Autotools in an attempt to bring <code>configure</code> and the <em>Makefile.in</em> templates up-to-date. But as maintainers, we don’t really expect our users to have the Autotools installed—or at least not the latest versions that we’ve installed on our systems.</p>&#13;
<p class="indent">This is where Automake’s <em>maintainer mode</em> comes in. By default, Automake adds rules to makefiles that regenerate template files, configuration scripts, <span epub:type="pagebreak" id="page_173"/>and generated sources from maintainer source files such as <em>Makefile.am</em> and <em>configure.ac</em>, as well as Lex and Yacc input files. However, we can use the Automake <code>AM_MAINTAINER_MODE</code> macro in <em>configure.ac</em> to disable the default generation of these maintainer-level <code>make</code> rules.</p>&#13;
<p class="indent">For maintainers who want these rules in place to keep their build system properly updated after build system changes, the <code>AM_MAINTAINER_MODE</code> macro provides a <code>configure</code> script command line option (<code>--enable-maintainer-mode</code>), which tells <code>configure</code> to generate <em>Makefile.in</em> templates that contain rules and commands to execute the Autotools as necessary.</p>&#13;
<p class="indent">Maintainers must be aware of the use of <code>AM_MAINTAINER_MODE</code> in their projects. They will need to use this command line option when running <code>configure</code> in order to generate full build systems that will properly rebuild Autotools-generated files when their sources are modified.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>I also recommend mentioning the use of maintainer mode in the project</em> INSTALL <em>or</em> README <em>files so that end users are not surprised when they modify Autotools sources without effect.</em></p>&#13;
</div>&#13;
<p class="indent">Although Automake’s maintainer mode has its advantages, you should know that there are various arguments against using it. Most focus on the idea that <code>make</code> rules should never be purposely restricted, because doing so generates a build system that will always fail under certain circumstances. I will, however, state that later versions of the Autotools do a much better job of telling you what’s happening when a required tool is missing. In fact, this is exactly what the <code>missing</code> script is for. Most tool invocations are wrapped in the <code>missing</code> script, which tells you fairly clearly what’s missing and how to install it when it is missing.</p>&#13;
<p class="indent">Another important consideration when using this macro is that you’ve now doubled the rows in your test matrix, as every build option has two modes—one that assumes the Autotools are installed and one that assumes the opposite. If you decide to use the macro to disable maintainer mode by default for your end users, keep these points in mind.</p>&#13;
<h3 class="h3" id="ch06sec9">Cutting Through the Noise</h3>&#13;
<p class="noindent">The amount of noise generated by Autotools-based build systems has been one of the most controversial topics on the Automake mailing list. One camp appreciates quiet builds that just display important information, such as warnings and errors. The other side argues that valuable information is often embedded in this so-called “noise,” so all of it is important and should be displayed. Occasionally, a new Autotools developer will post a question about how to reduce the amount of information displayed by <code>make</code>. This almost always spawns a heated debate that lasts for several days over a few dozen email messages. The old-timers just laugh about it and often joke about how “someone has turned on the switch again.”</p>&#13;
<p class="indent">The truth of the matter is that both sides have valid points. The GNU project is all about options, so the Automake maintainers have added the <span epub:type="pagebreak" id="page_174"/>ability to allow you to optionally make silent rules available to your users. <em>Silent rules</em> in Automake makefiles are not really silent; they’re just somewhat less noisy than traditional Automake-generated rules.</p>&#13;
<p class="indent">Instead of displaying the entire compiler or linker command line, silent rules display a short line indicating the tool and the name of the file being processed by that tool. Output generated by <code>make</code> is still displayed so the user knows which directory and target are currently being processed. Here is Jupiter’s build output, with silent rules enabled (execute <code>make clean</code> first to ensure something actually gets built):</p>&#13;
<pre>$ <span class="codestrong1">make clean</span>&#13;
<span class="codeitalic1">--snip--</span>&#13;
$ <span class="codestrong1">configure --enable-silent-rules</span>&#13;
<span class="codeitalic1">--snip--</span>&#13;
$ <span class="codestrong1">make</span>&#13;
make  all-recursive&#13;
make[1]: Entering directory '/.../jupiter'&#13;
Making all in common&#13;
make[2]: Entering directory '/.../jupiter/common'&#13;
  CC       print.o&#13;
  AR       libjupcommon.a&#13;
ar: `u' modifier ignored since `D' is the default (see `U')&#13;
make[2]: Leaving directory '/.../jupiter/common'&#13;
Making all in src&#13;
make[2]: Entering directory '/.../jupiter/src'&#13;
  CC       jupiter-main.o&#13;
  CCLD     jupiter&#13;
make[2]: Leaving directory '/.../jupiter/src'&#13;
make[2]: Entering directory '/.../jupiter'&#13;
make[2]: Leaving directory '/.../jupiter'&#13;
make[1]: Leaving directory '/.../jupiter'&#13;
$</pre>&#13;
<p class="indent">As you can see, the use of silent rules doesn’t make a lot of difference for Jupiter—Jupiter’s build system spends a lot of time moving between directories and very little time actually building things. But in projects with hundreds of source files, you’d see long lists of <code>CC</code> <em><code>filename</code></em><code>.o</code> lines, with an occasional indication that <code>make</code> is changing directories or the linker is building a product—compiler warnings tend to jump out at you. For instance, the <code>ar</code> warning in the output would have flown by unnoticed without silent rules.<sup><a id="ch06fn_17" href="footnote.xhtml#ch06fn17">17</a></sup></p>&#13;
<p class="indent">Silent rules are disabled by default. To enable silent rules by default in Automake-generated <em>Makefile.am</em> templates, you may call the <code>AM_SILENT_RULES</code> macro in <em>configure.ac</em> with a <code>yes</code> argument.</p>&#13;
<p class="indent">In any case, the user may always set the default verbosity for a build with <code>--enable-silent-rules</code> or <code>--disable-silent-rules</code> on the <code>configure</code> command <span epub:type="pagebreak" id="page_175"/>line. The build will then either be “silent” or normal based on the configured default and on whether the user specifies <code>V=0</code> or <code>V=1</code> on the <code>make</code> command line.</p>&#13;
<div class="note">&#13;
<p class="notet"><strong><span class="notes">NOTE</span></strong></p>&#13;
<p class="notep"><em>Neither <em><code>configure</code></em> option is required—the actual invocation of silent rules is ultimately controlled by the <em><code>V</code></em> variable in the generated makefile. The</em> configure <em>option merely sets the default value of <em><code>V</code></em>.</em></p>&#13;
</div>&#13;
<p class="indent">For smaller projects, I find Automake’s silent rules to be less useful than simply redirecting <code>stdout</code> to <em>/dev/null</em> on the <code>make</code> command line, in this manner:</p>&#13;
<pre>$ <span class="codestrong1">make &gt;/dev/null</span>&#13;
ar: `u' modifier ignored since `D' is the default (see `U')&#13;
$</pre>&#13;
<p class="indent">As this example shows, warnings and errors are still displayed on <code>stderr</code>, usually with enough information for you to determine where the problem is located (though not in this case). Warning-free builds are truly silent in this case. You should use this technique to clean up compiler warnings in your source code every so often. Silent rules can help because warnings stand out in the build output.</p>&#13;
<h3 class="h3" id="ch06sec10">Nonrecursive Automake</h3>&#13;
<p class="noindent">Now that we’ve changed our handwritten <em>Makefile.in</em> templates over to Automake <em>Makefile.am</em> files, let’s take a look at the process of converting this recursive build system to a nonrecursive build system. In previous chapters, we saw that using <code>make</code>’s <code>include</code> directive can be helpful in dividing makefiles into areas of responsibility relegated to the subdirectories in which they reside. With Automake, however, it’s just simpler to put everything in a top-level <em>Makefile.am</em> file because the content is so short that we can easily comprehend the entire build system at a glance. If further division of responsibility is required, a simple comment suffices.</p>&#13;
<p class="indent">The key here, as in our previous incarnations, is to reference the content as if <code>make</code> were running from the top-level directory (which—again—it is).</p>&#13;
<p class="indent"><a href="ch06.xhtml#ch06ex22">Listing 6-22</a> contains the entire contents of the top-level <em>Makefile.am</em> file—the only makefile we’ll use in this conversion.</p>&#13;
<p class="margin">Git tag 6.3</p>&#13;
<pre><span class="ash">noinst_LIBRARIES =</span> common/<span class="ash">libjupcommon.a</span>&#13;
common_<span class="ash">libjupcommon_a_SOURCES =</span> common/<span class="ash">jupcommon.h</span> common/<span class="ash">print.c</span>&#13;
&#13;
<span class="ash">bin_PROGRAMS =</span> src/<span class="ash">jupiter</span>&#13;
src_<span class="ash">jupiter_SOURCES =</span> src/<span class="ash">main.c</span>&#13;
src_<span class="ash">jupiter_CPPFLAGS = -I$(top_srcdir)/common</span>&#13;
src_<span class="ash">jupiter_LDADD =</span> common/<span class="ash">libjupcommon.a</span>&#13;
&#13;
<span class="ash">check_SCRIPTS =</span> src/<span class="ash">greptest.sh</span>&#13;
<span epub:type="pagebreak" id="page_176"/><span class="ash">TESTS = $(check_SCRIPTS)</span>&#13;
&#13;
src/<span class="ash">greptest.sh:</span>&#13;
        <span class="ash">echo './</span>src/<span class="ash">jupiter | grep "Hello from .*jupiter!"' &gt;</span> src/<span class="ash">greptest.sh</span>&#13;
        <span class="ash">chmod +x</span> src/<span class="ash">greptest.sh</span>&#13;
&#13;
<span class="ash">CLEANFILES =</span> src/<span class="ash">greptest.sh</span></pre>&#13;
<p class="caption" id="ch06ex22"><em>Listing 6-22:</em> Makefile.am: <em>A nonrecursive Automake implementation for Jupiter</em></p>&#13;
<p class="indent">As you can see here, I’ve replaced the <code>SUBDIRS</code> variable in the top-level <em>Makefile.am</em> file with the full contents of the <em>Makefile.am</em> files in each of the directories referenced by this variable. I then added appropriate relative path information to each input object and product reference so that source files are accessed from the top-level directory, where they actually reside in their respective subdirectories, and so that products end up where they belong—with their source input files (or at least in their proper counterpart directories when not building in the source tree). I’ve highlighted the changes to each of the subdirectory <em>Makefile.am</em> files that I pasted into the top-level file.</p>&#13;
<p class="indent">Note that <code>common_</code> or <code>src_</code> was prepended to the product source variables because these prefixes are literally part of the product names now. Ultimately, these names are used to create <code>make</code> targets, which are defined as much by their location as their name. Usually, the location is the current directory, so the directory portions are silently omitted. For our nonrecursive builds, products are now generated into locations other than the current directory, so they must be stated explicitly. As with any other special characters in the product name, the directory-separating slashes become underscores in PSVs.</p>&#13;
<p class="indent">We also need to add an Automake option and remove the extra <em>Makefile</em> references from <em>configure.ac</em>, as shown in <a href="ch06.xhtml#ch06ex23">Listing 6-23</a>.</p>&#13;
<pre><span class="ash">#                                               -*- Autoconf -*-</span>&#13;
<span class="ash"># Process this file with autoconf to produce a configure script.</span>&#13;
&#13;
<span class="ash">AC_PREREQ([2.69])</span>&#13;
<span class="ash">AC_INIT([Jupiter], [1.0], [jupiter-bugs@example.org])</span>&#13;
<span class="ash">AM_INIT_AUTOMAKE</span>([subdir-objects])&#13;
<span class="ash">AC_CONFIG_SRCDIR([src/main.c])</span>&#13;
<span class="ash">AC_CONFIG_HEADERS([config.h])</span>&#13;
<span class="codeitalic1a">--snip--</span>&#13;
<span class="ash"># Checks for library functions.</span>&#13;
&#13;
<span class="ash">AC_CONFIG_FILES([</span>Makefile<span class="ash">])</span>&#13;
<span class="ash">AC_OUTPUT</span>&#13;
&#13;
<span class="ash">cat &lt;&lt; EOF</span>&#13;
<span class="codeitalic1a">--snip</span><span class="codeitalic1a">--</span></pre>&#13;
<p class="caption" id="ch06ex23"><em>Listing 6-23:</em> configure.ac: <em>Removing extra makefile references for nonrecursive builds</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_177"/>The Automake <code>subdir-objects</code> option is necessary to tell Automake that you intend to access source files from directories other than those in which they reside. It’s also needed to state that you want the objects and other intermediate products to be generated into the same directory as the source file (or in proper out-of-tree build counterpart directories). This option is not required just for nonrecursive builds but for any situation in which you may need to build one or more source files outside of their own directories. If you omit this option, the build will often still work, but you’ll see two effects: warnings will be generated by <code>autoreconf</code> (or <code>automake</code>) indicating that you should probably use the option, and object files will be left lying in the wrong directories. The latter is only a problem if you happen to have more than one instance of a source file with the same name in different directories, in which case the second object file will overwrite the first, which will most probably result in a linker error when it’s not able to find the symbols from the now-overwritten first object.</p>&#13;
<p class="indent">Finally, we can simply delete the <em>common</em> and <em>src</em> directories’ <em>Makefile.am</em> files:</p>&#13;
<pre>$ <span class="codestrong1">rm common/Makefile.am src/Makefile.am</span>&#13;
$</pre>&#13;
<h3 class="h3" id="ch06sec11">Summary</h3>&#13;
<p class="noindent">In this chapter, we’ve discussed how to instrument a project for Automake using a project that had already been instrumented for Autoconf. (Newer projects are typically instrumented for both Autoconf and Automake at the same time.)</p>&#13;
<p class="indent">We covered the use of the <code>SUBDIRS</code> variable to tie <em>Makefile.am</em> files together, as well as the concepts surrounding product list, product source, and product option variables. Along with product list variables, I discussed Automake primaries—a concept at the very heart of Automake. Finally, I discussed the use of <code>EXTRA_DIST</code> to add additional files to distribution packages, the <code>AM_MAINTAINER_MODE</code> macro to ensure that users don’t need to have the Autotools installed, converting to a nonrecursive Automake build system, and the use of Automake silent rules.</p>&#13;
<p class="indent">Through all of this, we replaced our handwritten <em>Makefile.in</em> templates with short, concise <em>Makefile.am</em> files that provide significantly more functionality. I hope this exercise has begun to open your eyes to the benefits of using Automake rather than handwritten makefiles.</p>&#13;
<p class="indent">In <a href="ch07.xhtml">Chapters 7</a> and <a href="ch08.xhtml">8</a>, we’ll examine adding Libtool to the Jupiter project. In <a href="ch09.xhtml">Chapter 9</a>, we’ll finish up our introduction to the Autotools proper by diving into the Autoconf’s portable testing framework—autotest. Then, in <a href="ch10.xhtml">Chapters 10</a> through <a href="ch13.xhtml">13</a>, we’ll take a short break from the Autotools to tackle some important sideline topics, but we’ll return in <a href="ch14.xhtml">Chapters 14</a> and <a href="ch15.xhtml">15</a>, where we’ll “Autotool-ize” a real-world project as we explore several other important aspects of Automake.</p>&#13;
</body></html>