<html xmlns="http://www.w3.org/1999/xhtml" xmlns:dk="http://www.kirsanov.com" xmlns:epub="http://www.idpf.org/2007/ops" xmlns:svg="http://www.w3.org/2000/svg" epub:prefix="index: http://www.index.com/" lang="en" xml:lang="en">
	<head>
		<meta content="text/html; charset=UTF-8" http-equiv="Content-Type"/>
		<title>Chapter 19: Extensions</title>
		<link href="NSTemplate_v1_inkbook.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:53262340-c02e-40d5-9273-c34656cedc88" name="Adept.expected.resource"/>
	</head>
	<body>
		<section><a id="ch19"/>
		<header>
				<h1 class="chapterTitle"><span class="ChapterNumber"><span epub:type="pagebreak" id="Page_403" title="403"/>19</span><br/><span class="ChapterTitle">Extensions</span></h1>
			</header>
			<p class="ChapterIntro"><a id="403"/>Most long-lived software projects owe a large part of their success to extensibility. If you manage to attract and keep outside developers with their unique needs, perspectives, and approaches, your software product has acquired good insurance against oblivion. Inkscape's ecosystem of extensions is not very large, but it is an important part of the program's impact. Almost 200 extensions ship with Inkscape 1.0, and you can find many more online.</p>
			<p>
				In this chapter, I first look at extensions from the user perspective. I explain the extensions UI (<a href="#section19.1">19.1</a>) and describe, with examples, the notable extensions included with Inkscape (<a href="#section19.2">19.2</a>). After that, I put on my developer's hat; I explain the architecture of Inkscape extensions (<a href="#section19.3">19.3</a>) and guide you through a simple example of an extension created from scratch (<a href="#section19.4">19.4</a>). As Inkscape is an open source application, everyone can (and is encouraged to) contribute to it; writing an extension may be the easiest way not only to solve your unique problem but also make your solution useful to others.</p>
				<a id="section19.1"/>
				<h2>
				19.1 <a id="404"/><span epub:type="pagebreak" id="Page_404" title="404"/>Working with Extensions</h2>
			<p>
				An <em>extension</em> is a piece of code you can run to perform some actions on the
selected objects in an Inkscape document. Within Inkscape, you can access most extensions via commands in the <span class="ui">Extensions</span> submenus. 
Unlike path effects (<a href="c13.xhtml#ch13">Chapter 13</a>) or filters (<a href="c17.xhtml#ch17">Chapter 17</a>), an extension is a
one-off operation; it is typically destructive and changes objects without preserving the originals.
The only way to reverse an extension run is via <span class="ui">Edit<span class="MenuArrow"> ▶ </span>Undo</span>.</p>
			<p>
				A typical extension has a number of parameters that you set in its dialog
before running the extension. The dialog may have more than one tab, and some of the most
developed ones have an <span class="ui">About</span> or <span class="ui">Help</span> tab that describes the extension and how to use it, as shown in <a href="#fig19-1">Figure 19-1</a>.</p>
			<a id="fig19-1"/><figure>
				<img alt="" src="21/ext-els.svg.png"/>
				<figcaption>
					<p>
						Figure 19-1: The <span class="ui">Export Layer Slices</span> extension: the two tabs of the parameters dialog</p>
				</figcaption>
			</figure>
			<p>
				Most extension dialogs have a <span class="ui">Live preview</span>
checkbox; when checked, it shows your document as it would look after
the extension is applied with the current parameters. This way, you can experiment
with parameter values without having to undo and run the extension again.
To apply the parameters as final, click <span class="ui"><strong>Apply</strong></span>; to
cancel without running the extension, click <span class="ui"><strong>Close</strong></span>.</p>
			<p>
				When the <span class="ui">Live preview</span> is off, the extension dialog is not modal, so you can pan
the canvas and select different objects; as soon as you turn <span class="ui">Live preview</span> on,
the dialog locks the rest of Inkscape so you can only change the parameters in the
dialog and see their effect. For some extensions, updating can be slow, especially
when your document is big and complex.</p>
			<p>
				The <span class="ui">Previous Extension</span> command in the <span class="ui">Extensions</span> menu re-runs the last extension command without
showing the parameters dialog. The <span class="ui">Previous Extension Settings</span> command opens last extension's parameters dialog
from which you can run it again.</p>
			<a id="section19.2"/><h2>19.2 A Guide to Inkscape Extensions</h2>
			<p>
				Many extensions have already been mentioned or described throughout this book. In some (but far from all) cases, an extension is an alternative to some other, more
convenient or integrated method to achieve the same result; when <a id="405"/><span epub:type="pagebreak" id="Page_405" title="405"/>an extension duplicates functionality available in the core of the program, it's
usually because the extension was created first. Still, many extensions are unique and indispensable tools in Inkscape's toolbox.
Let's go through the <span class="ui">Extensions</span> menu to review what is available:</p>
			<ul>
				<li>
					The <span class="ui">Arrange</span> submenu has <span class="ui">Restack</span> for z-order manipulations (<a href="c04.xhtml#section4.4">4.4</a>) and <span class="ui">Deep Ungroup</span> for ungrouping multiple levels of grouping (<a href="c04.xhtml#section4.8.1">4.8.1</a>).</li>
				<li><span class="ui">Color</span> extensions change the colors of selected vector objects (but don't work on bitmaps), as detailed in <a href="c08.xhtml#section8.10.1">8.10.1</a>.</li>
				<li><span class="ui">Document</span> has two extensions that convert between the old Inkscape SVG documents that assume 90 dpi resolution and the new ones that are based on 96 dpi (see the note at the end of <a href="c04.xhtml#section4.2">4.2</a> for details).</li>
				<li><span class="ui">Export</span> extensions implement various ways to export a document, such as sending it to a plotter device (<span class="ui">Plot</span>) or exporting multiple slices of a web page mockup (<span class="ui">Export Layer Slices</span>, which is intended as an improvement on the standard batch export functionality in the <span class="ui">Export PNG Image</span> dialog, <a href="c18.xhtml#section18.6.1.4">18.6.1.4</a>).</li>
				<li><span class="ui">Gcodetools</span> is a collection of extensions to prepare and export your document to the G-code language that various computerized machine tools understand, so that you can, for example, cut or engrave a metallic badge out of your Inkscape design.</li>
				<li>
					The <span class="ui">Generate from Path</span>, <span class="ui">Modify Path</span>, and <span class="ui">Visualize Path</span> submenus provide a number of path-processing extensions described in the chapter on path effects (<a href="c13.xhtml#section13.4">13.4</a>).</li>
				<li>
					The <span class="ui">Images</span> submenu contains utilities for embedding and extracting images (<a href="c18.xhtml#section18.2.1">18.2.1</a>) as well as for changing image attributes (<a href="c18.xhtml#section18.2.3">18.2.3</a>).</li>
				<li><span class="ui">JessyInk</span> extensions insert Javascript snippets into a document that turn it into an interactive presentation when viewed in a browser. With these snippets, you will be able to scroll the pages, make objects respond to clicks, use transitions, and even insert videos.</li>
				<li><span class="ui">Raster</span> (bitmap-processing) extensions were reviewed in <a href="c18.xhtml#section18.7">18.7</a>.</li>
				<li><span class="ui">Stylesheet<span class="MenuArrow"> ▶ </span>Merge Styles into CSS</span>  is the tool to use if you have many objects with the same style and want to
store that style in a single place so you can update all those objects at once. Recall that Inkscape supports
selectors that apply a shared style to multiple objects (<a href="c08.xhtml#section8.1">8.1</a>); this extension
creates such a selector from the selected objects and then switches them from their inline style properties to that selector.</li>
				<li><span class="ui">Text</span>  extensions were described in the chapter on text (<a href="c15.xhtml#section15.7">15.7</a>).</li>
				<li><span class="ui">Typography</span> is a collection of extensions that aid in creating SVG fonts (<a href="c15.xhtml#section15.8">15.8</a>).</li>
				<li><span class="ui">Web</span> extensions once again remind you that Inkscape's documents are usable as web pages because modern
web browsers support SVG (see also <span class="ui">JessyInk</span> above). The <span class="ui">Web<span class="MenuArrow"> ▶ </span>JavaScript<span class="MenuArrow"> ▶ </span>Set Attributes</span> extension allows you to
change an object’s style property in response to a given event—typically a click of some other element. 
The <span class="ui">Web<span class="MenuArrow"> ▶ </span>JavaScript<span class="MenuArrow"> ▶ </span>Transmit Attributes</span> is similar but copies the clicked object's property to another object. You need
to select both objects, the click target first and the property-changing object second, before calling these extensions.</li>
			</ul><a id="section19.2.1"/>
			<h3>
				19.2.1 <a id="406"/><span epub:type="pagebreak" id="Page_406" title="406"/>The <span class="ui">Render</span> Submenu</h3>
			<p>
				The <span class="ui">Render</span>  submenu contains extensions that generate entirely new objects—not based on anything in your document. Most of them haven't been mentioned, so here's a list of the notable ones:</p>
			<dl>
				<dt><span class="ui">3D Polyhedron</span></dt>
				<dd>
					<p>Creates a projection of any of a number of three-dimensional shapes, from a cube to a great stellated dodecahedron; you specify the spatial angle
and the styling of the shape's faces.</p>
				</dd>
				<dt><span class="ui">Barcode</span></dt>
				<dd>
					<p>
						Extensions in this subsubmenu create a <span class="ui">Classic</span> linear barcode (supported formats include EAN8, EAN13, Code39, Code128, and others),
a two-dimensional <span class="ui">Datamatrix</span> barcode, or a square <span class="ui">QR Code</span> with the given text.</p>
				</dd>
				<dt><span class="ui">Calendar</span></dt>
				<dd>
					<p>In case you ever need it, this extension fills your page with a fully formatted calendar for a given year, with many layout, styling, and localization options.</p>
				</dd>
				<dt><span class="ui">Draw From Triangle</span>, <span class="ui">Triangle</span></dt>
				<dd>
					<p>
						Similar to the path effects for geometric constructions (<a href="c13.xhtml#section13.3.15">13.3.15</a>), <span class="ui">Draw From Triangle</span> draws any of a number of geometric shapes (such as the circumcircle or orthocenter) based on a triangle defined by the first three nodes of a selected path. The <span class="ui">Triangle</span> extension creates a triangle from any unambiguous combination of sides and angles.</p>
				</dd>
				<dt><span class="ui">Function Plotter</span>, <span class="ui">Parametric Curves</span></dt>
				<dd>
					<p>
						These two extensions draw function graphs. The <span class="ui">Function Plotter</span> creates
a graph of a single function (for example, altitude against time of a moving body), whereas <span class="ui">Parametric Curves</span> draws a curve where both X and Y coordinates vary as functions of an independent<em>parameter</em> variable conventionally called <em>t</em> (for example, X and Y may represent coordinates
of a body as they change with time).</p>
					<p>
						Before calling one of these extensions, draw or select a rectangle that will define the scale of the graph, and use
the numeric parameters to define the ranges of the X and Y coordinates. The <span class="ui">Multiply X
range by 2*pi</span> checkbox is convenient for trigonometric functions; with it, for example, the range of
0 to 2 is treated as 0 to 2 × π. In the <span class="ui">Function Plotter</span>, the <span class="ui">Use polar
coordinates</span> checkbox transforms the graph into a circle whose center is in the center of
the selected rectangle, with the X range mapped to the angle and the Y to the radius.</p>
					<p>
						The <span class="ui">Samples</span> parameter sets the total number of times the function(s) will be
sampled; since each sampling produces a node, this
is also the total number of nodes in the generated path. The higher this number, the
more precise the graph. The optimum number of samples depends on the nature
of your function; for example, a periodic function with <em>n</em> periods
in the X range would need at least several samples per period to reproduce with
any fidelity.</p>
					<p><a id="407"/><span epub:type="pagebreak" id="Page_407" title="407"/>The function or functions are written in the Python programming
language. You can use a number of built-in mathematical functions such as<code>sin(x)</code>, <code>log(x)</code>, or <code>sqrt(x)</code>; refer to the<span class="ui">Functions</span> tab for a full list.</p>
					<p>
						In the <span class="ui">Function Plotter</span> (<a href="#fig19-2">Figure 19-2</a>), you can give the <em>first derivative</em>
of the graphed function; the value of the derivative determines the angle of the Bézier handles
at each node. Either ask the extension to <span class="ui">Calculate first derivative
numerically</span> or uncheck that checkbox and provide the derivative function
analytically, using the same Python syntax and built-in functions—for example,
the first derivative of <code>sin(x)</code> is <code>cos(x)</code>.</p>
			<a id="fig19-2"/><figure>
						<img alt="" src="21/pe-funplot.svg.png"/>
						<figcaption>
							<p>
								Figure 19-2: <span class="ui">Function Plotter</span> examples</p>
						</figcaption>
					</figure>
				</dd>
				<dt><span class="ui">Gear</span></dt>
				<dd>
					<p>These two extensions create a circular gear or rack gear, with a given number of teeth, pitch, and contact angle.</p>
				</dd>
				<dt><span class="ui">Grids</span></dt>
				<dd>
					<p>
						This family of extensions is for creating grids of lines—rectangular (Cartesian, such as the grid in <a href="c13.xhtml#fig13-60">Figure 13-60</a>), isometric, or polar.
The options for the number of lines and their spacing are self-explanatory; major and minor lines use different stroke width. Lines can be spaced
logarithmically. Each line is a separate path object.</p>
				</dd>
				<dt><span class="ui">Guides Creator</span></dt>
				<dd>
					<p>
						This extension divides your page into any number of rows and columns by adding guidelines (<a href="c07.xhtml#section7.1">7.1</a>).</p>
				</dd>
				<dt><span class="ui">L-system</span></dt>
				<dd>
					<p>
						This extension implements <em>Lindenmeyer systems</em>—a simple graphic
language with recursion that can produce complex sequential or tree-like structures (<a href="#fig19-3">Figure 19-3</a>).</p>
					<p>
						Programs in this language are built out of simple commands like "draw one step forward" or
"turn left." You start with an <span class="ui">Axiom</span> and apply the substitution <span class="ui">Rules</span> to it recursively, 
limited by the <span class="ui">Order</span> parameter. The rest of the parameters
determine the length and angles of the lines produced by the primitive commands; you can also randomize these values
to render a <a id="408"/><span epub:type="pagebreak" id="Page_408" title="408"/>more natural result. For a complete list of the commands recognized in
the axiom and rules, refer to the <span class="ui">Help</span> tab.</p>
			<a id="fig19-3"/><figure>
						<img alt="" src="21/pe-lsystem.svg.png"/>
						<figcaption>
							<p>Figure 19-3: L-system examples</p>
						</figcaption>
					</figure>
				</dd>
				<dt><span class="ui">Mathematics<span class="MenuArrow"> ▶ </span>LaTeX</span></dt>
				<dd>
					<p>
						This extension runs <code>pdflatex</code> (which needs to be installed on your computer) to convert a LaTeX string into a vector formula image
inserted into your document.</p>
				</dd>
				<dt><span class="ui">NiceCharts</span></dt>
				<dd>
					<p>This extension can create bar charts, stacked bar charts, or pie charts based on data from a file or a string. Parameters
determine sizes, spacings, and styling of the chart's elements.</p>
				</dd>
				<dt><span class="ui">Random Tree</span></dt>
				<dd>
					<p>
						Similar to the <span class="ui">L-system</span> but more
primitive, this extension draws a random branching tree where the first segment of the
trunk is <span class="ui">Initial size</span> long and each subsequent branch is progressively shorter,
until the <span class="ui">Minimum size</span> is reached and the drawing terminates. The
bigger the difference between the initial and minimum sizes, the more complex the
tree.</p>
				</dd>
				<dt><span class="ui">Spirograph</span></dt>
				<dd>
					<p>A spirograph is a toy where a small circle, holding the pen, rolls along the inner edge of a larger circular hole. This
extension is an implementation of the same idea that you can use to produce a huge variety of smooth
centrally symmetric curves.</p>
				</dd>
				<dt><span class="ui">Wireframe Sphere</span></dt>
				<dd>
					<p>This is the extension to use whenever you need a geometrically correct globe of parallels and meridians.</p>
				</dd>
			</dl><a id="section19.3"/>
			<h2>19.3 Extensions Architecture</h2>
			<p>The rest of this chapter is more technical. Read on if you're interested in learning how Inkscape's extensions are implemented,
why you might want to make one of your own, and how to proceed if you do. Familiarity with the basics of programming in general and
the Python language in particular is a plus.</p>
			<p><a href="#fig19-4">Figure 19-4</a> gives an overview of Inkscape's extension architecture.</p>
			<a id="fig19-4"/>
			<figure>
				<img alt="" src="21/ext-arch.svg.png"/>
				<figcaption>
					<p>Figure 19-4: Inkscape extensions: under the hood</p>
				</figcaption>
			</figure>
			<p><a id="409"/><span epub:type="pagebreak" id="Page_409" title="409"/>Unlike, for example, Adobe products,
Inkscape does not have "first-class" plug-ins that would load into the main program's memory space and have the same level of access
to the document's tree and the program's API as Inkscape itself. Instead, an Inkscape extension is just a script written in Python
that Inkscape runs on a (temporary) saved copy of the current document—and then loads the script's output back, replacing the document with it
and restoring object selection if possible.
Inkscape's extension-running machinery compresses all this saving, processing, and loading back into a single undoable action
that is transparent to the user. What's more, when you turn on the <span class="ui">Live preview</span> checkbox in an extension's dialog, every change of the parameters
causes another save-process-load cycle—which is automatically undone if you change a parameter again or close the dialog without clicking <span class="ui">Apply</span>.</p>
			<p>It is the extension script's responsibility to not touch anything in the document except what it is supposed to touch. Along with the reference
to the saved temporary copy of the document, it is passed the list of currently selected objects as well as, of course, the parameters the user
has set in the extension's dialog. The script must load and parse the SVG file, find the selected objects in it, do its thing, and output the changed
document back as serialized SVG (via the standard output).</p>
			<p>If this whole approach strikes you as clumsy and inefficient, that's because it is. However, such a radical decoupling of extension code from the core
of Inkscape has its advantages, too. The biggest advantage is the low barrier of entry for new developers. You don't need to know much about
Inkscape itself in order to start; all you need is basic familiarity with SVG and an understanding of how to deal with the XML tree of the document in
Python. Existing Inkscape extensions are very easy to study, modify, or fork for the same reason. Another advantage is that any extension is easy
to reuse as a stand-alone script that you can run not only from Inkscape, but also in all kinds of automated processing scenarios.</p>
			<p>
				While you don't have any access to Inkscape's internals when you're in an extension, that doesn't mean you're completely on your own.
Inkscape ships with a Python library called <code>inkex</code> (for INKscape EXtensions) that extension scripts are supposed to use. It has
facilities for a lot of tedious and complex tasks that you don't need to do in your code, such as parsing the path data (the <code>d</code> attribute),
parsing style strings and calculating an object's effective style (taking inheritance and CSS selectors into account), manipulating transform matrices, 
and so on. You can write much more powerful algorithms with <code>inkex</code> taking care of the low-level drudgery for you.</p>
			<p><a id="410"/><span epub:type="pagebreak" id="Page_410" title="410"/>Sometimes, however, even <code>inkex</code> is not enough. You may need something done that only Inkscape itself can do—for example,
create one or more PNG exports from the source document. For this, you need to run Inkscape itself—a <em>second copy</em>
of Inkscape called, possibly repeatedly, via the command line. In older versions, even getting the correct bounding box of an object
required a command line Inkscape call (using the <code>--query</code> parameters, <a href="b03.xhtml#sectionC.5">C.5</a>);
as of this writing, <code>inkex</code> is capable of providing a correct bounding box for a path object, but it still can’t do so for text
(because of the complexity of correctly rendering arbitrary fonts and text layouts).</p>
			<a id="section19.4"/><h2>19.4 Creating an Extension</h2>
			<p>The remainder of this chapter walks you through creating an extremely simple—but still rudimentarily useful—Inkscape extension from scratch. 
Hopefully, seeing how easy and natural that is, you will feel encouraged to automate your own tedious and repeated manual tasks—and perhaps,
eventually, share your solution so that others may benefit from it too.</p>
			<p>
				The example extension, called <em>Make Initial</em>, creates a simple initial in a text object by taking its first character and increasing its font
size. It has a single parameter: the size of the initial letter, given as percent of the font size of the rest of the text.</p>
			<a id="section19.4.1"/><h3>19.4.1 The .inx File</h3>
			<p>Before getting to the Python code, we need to create an .inx file (from INkscape eXtension) for the extension.
This is an XML file that describes, to Inkscape, what this extension is, how to run it, and how to present it to the user. Here is the
makeinitial.inx file for the Make Initial extension:</p>
			<pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;inkscape-extension xmlns="http://www.inkscape.org/namespace/inkscape/extension"&gt; &lt;name&gt;Make Initial&lt;/name&gt; &lt;id&gt;com.kirsanov.text.makeinitial&lt;/id&gt; &lt;label&gt;Enlarge the first character of each selected text object.&lt;/label&gt; &lt;param id="initialsize" type="int" min="0" max="1000" gui-text="Size of initial, percent"&gt;200&lt;/param&gt; &lt;effect&gt; &lt;object-type&gt;text&lt;/object-type&gt; &lt;effects-menu&gt; &lt;submenu id="Text"/&gt; &lt;/effects-menu&gt; &lt;/effect&gt; &lt;script&gt; &lt;command location="inx" interpreter="python"&gt;makeinitial.py&lt;/command&gt; &lt;/script&gt;
&lt;/inkscape-extension&gt;</pre>
			<p>
				The root element, <code>inkscape-extension</code>, is just a container. Note the obligatory <code>xmlns</code>
attribute that sets the file's namespace, without which Inkscape won't recognize it. The <code>name</code> is the name of the extension
as it will appear in the menu; <code>label</code> is the intro text to be displayed in the extension's dialog.
The <code>id</code> can be any string so long as it's unique for your extension.</p>
			<p><a id="411"/><span epub:type="pagebreak" id="Page_411" title="411"/>The single <code>param</code> element (there may be any number of them) describes the extension's parameter. Called <code>initialsize</code>,
it is an integer (as this is a percentage, we don't need floating-point precision) in the range from 0 to 1000. The <code>gui-text</code>
attribute provides the label it will have in the dialog, and the content of the element (200) is the initial value (after the first use, Inkscape
remembers and restores the value you last used for all parameters).</p>
			<p>
				The <code>effect</code> element identifies this one as an <em>effect extension</em>; other extension 
types are <code>input</code>, <code>output</code>, and <code>template</code>
(see <a href="#section19.4.2">19.4.2</a> for details). Inside, the <code>object-type</code> identifies what kind of selected objects this extension
accepts; possible values are <code>all</code>, <code>path</code>, or <code>text</code>. The <code>effects-menu</code> element places this extension
inside the <span class="ui">Text</span> submenu of the <span class="ui">Extensions</span> menu.</p>
			<p>
				Finally, the <code>script</code> element tells Inkscape how to run this extension. In the <code>command</code> element, the <code>location="inx"</code> instructs it to look for the executable files in the same folder as the .inx file, and the <code>interpreter</code> attribute identifies Python as the interpreter to use (the version included with Inkscape 1.1 is Python 3.8.9). The content of that element (makeinitial.py) refers to the extension’s main code file.</p>
				<a id="section19.4.2"/>
				<h3>19.4.2 The inkex Base Classes</h3>
			<p>
				Gone are the days when Python was a quick-and-dirty scripting language with little structure. You now can—and are
encouraged to—write fully object-oriented Python code. Inkscape's <code>inkex</code> library is as good an example as any: the first
thing you do after <code>import inkex</code> is create a class that will hold your extension's code. Your class should extend
one of the <em>base extension classes</em> of <code>inkex</code> so that it inherits all of the utility methods it needs 
for loading the SVG document, parsing the parameters, and outputting the changed document back.</p>
			<p>
				The <code>inkex</code> library includes several base extension classes designed for various kinds of extensions, from general to specialized.
Choose one that best fits your case.</p>
			<ul>
				<li><code>EffectExtension</code> is the most general type of extension that, per <a href="#fig19-4">Figure 19-4</a>, takes the input document and the list of selected objects, does something to them, and returns the changed document back. You need to implement the <code>effect</code> method that does the actual processing. This is the base class we will use for our example.</li>
				<li><code>GenerateExtension</code> is for an extension that doesn't care about the source document or its selection; all it does is generate some new object(s) to be added to it. The base class handles adding the generated objects to the document, placing them by default in the center of view. You need to implement the <code>generate</code> method.</li>
				<li><code>InputExtension</code> is an extension that is not available in the <span class="ui">Extensions</span> menu; instead, it adds a new item to the list of file formats in <span class="ui">Open</span> and <span class="ui">Import</span> dialogs. To support a new file format through an input extension, you need to implement the <code>load</code> method that reads an input file from a stream and, optionally, the <code>effect</code> method that transforms the result. Needless to say, you have to return valid SVG.</li>
				<li><a id="412"/><span epub:type="pagebreak" id="Page_412" title="412"/><code>OutputExtension</code>, similarly, is for output extensions that manifest themselves as file formats in the <span class="ui">Save</span> and <span class="ui">Save As</span> dialogs. You need to implement an optional <code>effect</code> method that transforms the document before saving and the obligatory <code>save</code> that performs the actual output to a stream.</li>
				<li><code>CallExtension</code> is for an extension designed to be a simple interface between Inkscape and some external SVG-processing application. You need to implement the <code>call</code> method that calls your application on an input file and produces an output file. For such tasks, this base class is more efficient than the generic <code>EffectExtension</code> because it does not even parse the SVG in the Python code.</li>
				<li><code>TemplateExtension</code> is an extension that provides a new document template. Like input and output extensions, it's not listed in the <span class="ui">Extensions</span> menu; instead, it adds an item to the list of templates in the <span class="ui">New from Template</span> dialog (<a href="c03.xhtml#fig3-3">Figure 3-3</a>). You can implement the <code>get_template</code> method that returns the template's ready-to-use SVG code (for example, by reading it from a file). Alternatively, you can implement the <code>get_size</code> method (returns the template's size) and/or <code>set_namedview</code> method (creates the <code>sodipodi:namedview</code> element where you set up guides, page borders, zoom, and so on).</li>
				<li><code>ColorExtension</code> is a specialized effect extension for adjusting colors in selected objects. All you need to do is implement the <code>modify_color</code> method that takes an input color and returns the output color; optionally, you can add <code>modify_opacity</code> that does the same for opacity. The base class does all the rest (such as parsing styles, tracking down clones, dealing with gradients, and so on).</li>
				<li><code>TextExtension</code> is a specialized effect extension for editing a document's text content. All you need to do is implement the <code>process_chardata</code> method that takes an input text string and returns its edited version.</li>
			</ul>
			<p>
				In addition to the obligatory methods for each base class (listed above), any extension class may also need to implement the <code>add_arguments</code>
method if your extension has some user-adjustable parameters.</p>
			<a id="section19.4.3"/><h3>19.4.3 The makeinitial.py File</h3>
			<p>
				After these preliminaries, we can finally dive into the actual Python code. Here's the <em>makeinitial.py</em> file in full:</p>
			<pre><code>1  import inkex
2  from lxml import etree
3 
4  class Makeinitial(inkex.EffectExtension):
5 
6      def add_arguments(self, pars):
7          pars.add_argument("--initialsize", type=int)
8 
9      def effect(self):
10         texts = self.svg.get_selected(inkex.TextElement)
11         for text in texts:
12             self.__makeinitial(text)
13 
14     def __makeinitial(self, node):
15         if node.text != None and node.text.strip() != "":
16             char = node.text.strip()[0]
17             charAt = node.text.index(char)
18             newNode = etree.Element("tspan")
19             newNode.attrib["style"] = "font-size:" + str(self.options.initialsize) + "%"
20             newNode.text = char
21             newNode.tail = node.text[charAt + 1:]
22             node.text = ""
23             node.insert(0, newNode)
24         elif len(node) != 0:
25             self.__makeinitial(node[0])
26 
27 if __name__ == '__main__':
28     Makeinitial().run()</code></pre>
			<p><a id="413"/><span epub:type="pagebreak" id="Page_413" title="413"/>Naturally, the first thing we do is <code>import inkex</code>. Since we will be manipulating the document's tree (to create a new <code>tspan</code> node
for the initial), we also need to import the <code>etree</code> component of <code>lxml</code>, which is Python's library for dealing with XML (if you're
unfamiliar with it, read the tutorial at <a href="https://lxml.de/tutorial.html">https://lxml.de/tutorial.html</a>).</p>
			<p>
				We create the class for the extension by extending <code>inkex.EffectExtension</code> (<a href="#section19.4.2">19.4.2</a>). The first obligatory method
to implement in our class is <code>add_arguments</code>. In it, we call <code>pars.add_argument</code>; the first string argument of that method is
the command line parameter (therefore starting with <code>--</code>) that Inkscape passes to our script, and
it must match the name of the extension's parameter (<code>initialsize</code>) as defined in the .inx file. It is also the name by which we will access its
value later on.</p>
			<p>
				The <code>effect</code> method shown in line 9 does the actual work. The call <code>self.svg.get_selected(inkex.TextElement)</code> returns the list of elements that the user
has selected before calling the extension, filtered to contain only text elements. We then go through all these elements and call our own method, <code>__makeinitial</code>
(the double underscore in the name is Python's convention for private methods), on each one in turn.</p>
			<p>
				In <code>__makeinitial</code> (line 14), things get a little more complicated. We need to get the first character of this text element's textual content. However, in SVG, the<code>text</code> element usually does not contain text under it; instead, it contains <code>tspan</code> elements for the lines that, in turn, may contain
further <code>tspan</code>s for styling. We therefore check if this node has any text at all (<code>node.text != None</code>) and if its text is not all whitespace
(<code>node.text.strip() != ""</code>). If that is not so, we call <code>__makeinitial</code> recursively on its first child, if it has one (lines 24-25); in <code>lxml</code>, elements
are lists of children, so the check for presence of any children is <code>len(node) != 0</code>, and then the first child is simply <code>node[0]</code>.</p>
			<p>
				If our current node does have text, we extract its first non-whitespace character via <code>node.text.strip()[0]</code> (line 16). Since it may not be the first one
due to whitespace, we calculate its index (line 17). Then, we create the new <code>tspan</code> node in line 18 (note for XML geeks: don't worry about namespaces here
because the SVG namespace is the default one in Inkscape's SVG documents). We retrieve the extension parameter's value via <code>self.options.initialsize</code>
and, in our new node, construct the <code>style</code> attribute that uses it in the <code>font-size</code> property (line 19). <a id="414"/><span epub:type="pagebreak" id="Page_414" title="414"/>Per CSS rules, the percentage value
in the property refers to the font size of the parent node (that is, the <code>node</code> we're processing now).</p>
			<p>
				We now need to take care of the text. The initial character gets assigned to the new <code>tspan</code> node, as its <code>text</code> property, in line 20. As for the rest
of the text, however, we need to cull it out from the current <code>node</code> (line 22) and assign it to the <code>newNode</code> as its <code>tail</code> (line 21).
That's because in <code>lxml</code>, the <code>text</code> property of a node holds only that part of its textual content that comes before its first child node.
After that, each of the child nodes holds the fragment of text that comes after it, if any, in its <code>tail</code> property.</p>
			<p>
				Finally, the <code>newNode</code> is ready, and we insert it into the current <code>node</code> (line 23).</p>
			<p>
				The last two lines of the script (27-28) are a bit
of black magic required for it to run. We check whether this script is run as a stand-alone program (as opposed to, for example, being imported into some other script)
and, if so, run our class's <code>run</code> method (supplied by its <code>inkex</code> parent class).</p>
			<a id="section19.4.4"/><h3>19.4.4 Deploying and Testing</h3>
			<p>
				Both the .py file with the extension's code and its .inx file are placed into Inkscape's extensions folder.
In <span class="ui">Preferences<span class="MenuArrow"> ▶ </span>System</span>, you can look up the <span class="ui">Inkscape extensions</span> folder—this is where the
extensions that ship with Inkscape live and where you search for inspiration and code to reuse.
Your own extensions, however, should go into the <span class="ui">User extensions</span> folder; 
on my system, it's in C:\Users\dmitry\AppData\Roaming\inkscape\extensions. This way, your code will not be lost
when you upgrade to a newer version of Inkscape.</p>
			<p>
				Copy your files over, restart Inkscape, and voilà! The new extension shows up in <span class="ui">Extensions<span class="MenuArrow"> ▶ </span>Text</span> menu and can be used
on any text object, as shown in <a href="#fig19-5">Figure 19-5</a>.</p>
			<a id="fig19-5"/><figure>
				<img alt="" src="21/ext-makeinitial.svg.png"/>
				<figcaption>
					<p>
						Figure 19-5: The new <span class="ui">Make Initial</span> extension in action</p>
				</figcaption>
			</figure>
		</section>
	</body>
</html>