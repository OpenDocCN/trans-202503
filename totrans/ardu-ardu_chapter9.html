<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" lang="en" xml:lang="en">
<head>
<title>Arduino for Arduinians</title>
<meta content="text/html; charset=utf-8" http-equiv="default-style"/>
<link href="../styles/stylesheet.css" rel="stylesheet" type="text/css"/>
<meta content="urn:uuid:67118b6d-3178-4c1c-99a1-6e412fe74179" name="Adept.expected.resource"/>
</head>
<body epub:type="bodymatter">
<section aria-labelledby="ch9" epub:type="chapter" role="doc-chapter">
<header>
<h1 class="CHAPTER" id="ch9">
<span class="CN"><span aria-label=" Page 133. " epub:type="pagebreak" id="pg_133" role="doc-pagebreak"/><samp class="SANS_Futura_Std_Bold_Condensed_B_11">9</samp></span>
<span class="CT"><samp class="SANS_Dogma_OT_Bold_B_11">BUILDING A DIGITAL MUSIC PLAYER AND SOUND BOARD</samp></span>
</h1>
</header>
<figure class="opener"><img alt="" class="opener" src="../images/opener-img.png"/>
</figure>
<p class="INTRO">Digital audio players became popular during the 2000s but faded away as smartphones began to dominate the market. However, there are still plenty of uses for discrete MP3 players, such as audio playback in toys, as announcement systems, or as simple audio players. Thanks to the low cost of the bare MP3 player modules, you can easily build fun, interesting MP3 player projects.</p>
<p class="TX">In this chapter, you’ll learn to:</p>
<ul class="ul">
<li class="BL">Build a simple MP3 player just for listening to music, with none of the distractions of a smartphone</li>
<li class="BL">Make an MP3 audio sound board for direct playback control</li>
</ul>
<p class="TX">You can use the devices you build in this chapter to play any audio you like and can modify them for the applications mentioned previously in your own future projects.</p>
<section aria-labelledby="sec1" epub:type="division">
<h2 class="H1" id="sec1"><span id="h1-64"/><span aria-label=" Page 134. " epub:type="pagebreak" id="pg_134" role="doc-pagebreak"/><samp class="SANS_Futura_Std_Bold_B_11">The YX6300 MP3 Module</samp></h2>
<p class="TNI">For the MP3 projects in this chapter, you’ll use a YX6300-type compact module, such as PMD Way part 725600, shown in <a href="chapter9.xhtml#fig9-1">Figure 9-1</a>.</p>
<figure class="IMG"><img alt="A PHOTO OF A YX6300 MP3 PLAYER MODULE" class="img7" id="fig9-1" src="../images/fig9-1.png"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 9-1: An MP3 player module (front)</samp></p></figcaption>
</figure>
<p class="TX">On the reverse side of the module is a microSD flash memory card socket, which can be used with cards up to 32GB, as shown in <a href="chapter9.xhtml#fig9-2">Figure 9-2</a>.</p>
<figure class="IMG"><img alt="A PHOTO OF THE BOTTOM OF THE MP3 PLAYER MODULE, SHOWING THE MICROSD CARD SOCKET" class="img7" id="fig9-2" src="../images/fig9-2.png"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 9-2: The back of an MP3 player module</samp></p></figcaption>
</figure>
<p class="TX"><span aria-label=" Page 135. " epub:type="pagebreak" id="pg_135" role="doc-pagebreak"/>When buying a flash memory card to use with the MP3 module, be sure to purchase an adapter as well so you can insert it into normal SD memory card sockets on PCs for file transfer.</p>
<p class="TX">I chose to base this chapter on the YX6300-type MP3 module for a few reasons. First, you can connect headphones, amplifiers, or speakers to the audio output via the module’s 3.5 mm stereo audio jack socket, with no extra circuitry required. Second, commands and information are sent via serial data (a UART) using an Arduino software serial port, so we need to connect only four pins to the Arduino circuit. Finally, the unit is inexpensive and widely available.</p>
<p class="TX">As a test before you start the first project, let’s use the module to play some audio. First, prepare three or four MP3 audio files of your choosing for playback on your PC and copy them to the microSD card. Next, connect the MP3 module to the Arduino, following the schematic in <a href="chapter9.xhtml#fig9-3">Figure 9-3</a>.</p>
<figure class="IMG"><img alt="THE SCHEMATIC FOR THE MP3 PLAYER TEST CIRCUIT" class="img3" id="fig9-3" src="../images/fig9-3.png"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 9-3: The MP3 player test circuit</samp></p></figcaption>
</figure>
<p class="TX">Carefully insert the memory card into the module, with the label facing upward, as shown in <a href="chapter9.xhtml#fig9-4">Figure 9-4</a>. The card will slide in and then bump up against a spring lock—push it in a little farther until the lock clicks. (To remove the card, gently push against the card, which should spring in a little and then pop out.)</p>
<figure class="IMG"><img alt="A PHOTO SHOWING THE INSERTION OF THE MICROSD CARD INTO THE MP3 PLAYER MODULE" class="img7" id="fig9-4" src="../images/fig9-4.png"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 9-4: Inserting the memory card into an MP3 player module</samp></p></figcaption>
</figure>
<p class="TX"><span aria-label=" Page 136. " epub:type="pagebreak" id="pg_136" role="doc-pagebreak"/>Finally, plug some headphones or amplified speakers into the MP3 module and then enter and upload the <a href="#LiT-9-1">Listing 9-1</a> sketch. After a few moments, the module should play the first 10 seconds of the first audio file on the memory card and then repeatedly skip to the next and play it for 10 seconds. The LED on the rear of the module should stay on while the memory card is inserted and should blink when playing audio. If yours doesn’t work, check the wiring, including the TX/RX back to the Arduino.</p>
<p class="TX"><a href="#LiT-9-1">Listing 9-1</a> shows how this works.</p>
<span id="LiT-9-1"/>

<pre><code><span aria-label="annotation1" class="CodeAnnotationHang">❶</span> #define HEADER_START   0x7E
#define HEADER_VERSION 0xFF
#define TAIL_END       0xEF
#define CMD_PLAY_NEXT  0x01
#define CMD_PLAY_PREV  0x02
#define CMD_PLAY_IDX   0x03

int8_t commands[8] = {0, 0, 0, 0, 0, 0, 0, 0};
// Holds command set to send to MP3

#include &lt;SoftwareSerial.h&gt;
SoftwareSerial MP3(2, 3); // Module TX to D2; module RX to D3

void controlMP3(int8_t command, int16_t data)
{
    commands[0] = HEADER_START;        // Header byte 0 (start)
    commands[1] = HEADER_VERSION;      // Header byte 1 (version)
    commands[2] = 0x06;                // Header byte 2 (length cmd + data)
    commands[3] = command;             // Command byte
    commands[4] = 0x00;                // Feedback (0x00 = no, 0x01 = yes)
    commands[5] = (int8_t)(data &gt;&gt; 8); // Data byte 0
    commands[6] = (int8_t)(data);      // Data byte 1
    commands[7] = 0xEF;                // End byte
  <span aria-label="annotation2" class="CodeAnnotationHang1">❷</span> for (int i = 0; i &lt; 8; i++)
    {
        MP3.write(commands[i]);
    }
}

void setup()
{
    MP3.begin(9600);
  <span aria-label="annotation3" class="CodeAnnotationHang1">❸</span> controlMP3(0x09, 0x02); // Select flash card for operation
    delay(500);
  <span aria-label="annotation4" class="CodeAnnotationHang1">❹</span> controlMP3(0x0D, 0); // Resume playback, no feedback
    delay(500);
}

void loop()
{
  <span aria-label="annotation5" class="CodeAnnotationHang1">❺</span> controlMP3(0x01, 0); // Next track, zero data
  <span aria-label="annotation6" class="CodeAnnotationHang1">❻</span> delay(10000);
}
</code></pre>

<p class="CodeListingCaption"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Listing 9-1: Testing a serial MP3 player</samp></p>
<p class="TX"><span aria-label=" Page 137. " epub:type="pagebreak" id="pg_137" role="doc-pagebreak"/>This sketch sends commands and data to the MP3 module via a serial UART connection with the Arduino. Each data packet, containing both the command and the associated data, consists of 8 hexadecimal bytes of data.</p>
<p class="TX">To save time, the sketch defines some useful command values as variables <span aria-label="annotation1" class="CodeAnnotationCode">❶</span>. These commands are assembled into the <samp class="SANS_TheSansMonoCd_W5Regular_11">commands[]</samp> array and then sent out via a software serial port <span aria-label="annotation2" class="CodeAnnotationCode">❷</span>. This uses the first command listed in <a href="chapter9.xhtml#tab9-1">Table 9-1</a> to initialize the MP3 player and select the microSD card socket as the source of audio files <span aria-label="annotation3" class="CodeAnnotationCode">❸</span> and then starts playing the audio files <span aria-label="annotation4" class="CodeAnnotationCode">❹</span>. The sketch plays the next audio file found on the microSD card <span aria-label="annotation5" class="CodeAnnotationCode">❺</span> for 10 seconds <span aria-label="annotation6" class="CodeAnnotationCode">❻</span>, and then the process repeats.</p>
<p class="TX"><a href="chapter9.xhtml#tab9-1">Table 9-1</a> describes the commands you can use with your player.</p>
<figure class="table">
<p class="TableTitle" id="tab9-1"><span class="Heavy"><samp class="SANS_Futura_Std_Heavy_B_11">Table 9-1:</samp></span> <samp class="SANS_Futura_Std_Book_11">MP3 Player Commands</samp></p>
<table class="table">
<thead>
<tr>
<th class="table TCH" scope="col"><p class="TCH"><samp class="SANS_Futura_Std_Heavy_B_11">Command set</samp></p></th>
<th class="table TCH" scope="col"><p class="TCH"><samp class="SANS_Futura_Std_Heavy_B_11">Purpose</samp></p></th>
</tr>
</thead>
<tbody>
<tr>
<td class="table TBF"><p class="TB"><samp class="SANS_TheSansMonoCd_W5Regular_11">7E FF 06</samp> <samp class="SANS_TheSansMonoCd_W7Bold_B_11">09</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">00</samp> <samp class="SANS_TheSansMonoCd_W7Bold_B_11">00 02</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">EF</samp></p></td>
<td class="table TBF"><p class="TB"><samp class="SANS_Futura_Std_Book_11">Initializes MP3 player, uses the microSD card</samp></p></td>
</tr>
<tr>
<td class="table TB"><p class="TB"><samp class="SANS_TheSansMonoCd_W5Regular_11">7E FF 06</samp> <samp class="SANS_TheSansMonoCd_W7Bold_B_11">0D</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">00</samp> <samp class="SANS_TheSansMonoCd_W7Bold_B_11">00 00</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">EF</samp></p></td>
<td class="table TB"><p class="TB"><samp class="SANS_Futura_Std_Book_11">Resumes/starts playback</samp></p></td>
</tr>
<tr>
<td class="table TB"><p class="TB"><samp class="SANS_TheSansMonoCd_W5Regular_11">7E FF 06</samp> <samp class="SANS_TheSansMonoCd_W7Bold_B_11">0E</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">00</samp> <samp class="SANS_TheSansMonoCd_W7Bold_B_11">00 00</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">EF</samp></p></td>
<td class="table TB"><p class="TB"><samp class="SANS_Futura_Std_Book_11">Pauses playback</samp></p></td>
</tr>
<tr>
<td class="table TB"><p class="TB"><samp class="SANS_TheSansMonoCd_W5Regular_11">7E FF 06</samp> <samp class="SANS_TheSansMonoCd_W7Bold_B_11">16</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">00</samp> <samp class="SANS_TheSansMonoCd_W7Bold_B_11">00 00</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">EF</samp></p></td>
<td class="table TB"><p class="TB"><samp class="SANS_Futura_Std_Book_11">Stops playback, resets to first track</samp></p></td>
</tr>
<tr>
<td class="table TB"><p class="TB"><samp class="SANS_TheSansMonoCd_W5Regular_11">7E FF 06</samp> <samp class="SANS_TheSansMonoCd_W7Bold_B_11">02</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">00</samp> <samp class="SANS_TheSansMonoCd_W7Bold_B_11">00 00</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">EF</samp></p></td>
<td class="table TB"><p class="TB"><samp class="SANS_Futura_Std_Book_11">Plays previous track</samp></p></td>
</tr>
<tr>
<td class="table TB"><p class="TB"><samp class="SANS_TheSansMonoCd_W5Regular_11">7E FF 06</samp> <samp class="SANS_TheSansMonoCd_W7Bold_B_11">01</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">00</samp> <samp class="SANS_TheSansMonoCd_W7Bold_B_11">00 00</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">EF</samp></p></td>
<td class="table TB"><p class="TB"><samp class="SANS_Futura_Std_Book_11">Plays next track</samp></p></td>
</tr>
<tr>
<td class="table TB"><p class="TB"><samp class="SANS_TheSansMonoCd_W5Regular_11">7E FF 06</samp> <samp class="SANS_TheSansMonoCd_W7Bold_B_11">05</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">00</samp> <samp class="SANS_TheSansMonoCd_W7Bold_B_11">00 00</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">EF</samp></p></td>
<td class="table TB"><p class="TB"><samp class="SANS_Futura_Std_Book_11">Turns volume down</samp></p></td>
</tr>
<tr>
<td class="table TBL"><p class="TB"><samp class="SANS_TheSansMonoCd_W5Regular_11">7E FF 06</samp> <samp class="SANS_TheSansMonoCd_W7Bold_B_11">04</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">00</samp> <samp class="SANS_TheSansMonoCd_W7Bold_B_11">00 00</samp> <samp class="SANS_TheSansMonoCd_W5Regular_11">EF</samp></p></td>
<td class="table TBL"><p class="TB"><samp class="SANS_Futura_Std_Book_11">Turns volume up</samp></p></td>
</tr>
</tbody>
</table>
</figure>
<p class="TX">Of the two bold bytes in each command group, the first is the command byte, and the second is the data bytes. These are the two parameters used in the sketch’s <samp class="SANS_TheSansMonoCd_W5Regular_11">controlMP3()</samp> function to instruct the MP3 player. For basic playback use, you don’t need to send data bytes.</p>
<p class="TX">In the next project, you’ll test these commands by building your own MP3 player with some control functions.</p>
<p class="HeadProject"><span id="h1-65"/><samp class="SANS_Futura_Std_Heavy_B_21">Project #28: Building a Simple MP3 Player</samp></p>
<p class="TNI">In this project, you’ll create an MP3 player with typical play, pause, volume, and track forward/backward controls. You’ll need the following parts:</p>
<ul class="ul">
<li class="BL">An Arduino Uno or compatible board and USB cable</li>
<li class="BL">An MP3 player module with a microSD card of MP3 audio files</li>
<li class="BL">A solderless breadboard</li>
<li class="BL">Assorted jumper wires</li>
<li class="BL">Headphones or cables to audio amplifier and speakers</li>
<li class="BL">An analog 6- or 12-button keypad circuit from <span class="Xref"><a href="chapter1.xhtml">Chapter 1</a></span></li>
</ul>
<p class="TX"><span aria-label=" Page 138. " epub:type="pagebreak" id="pg_138" role="doc-pagebreak"/>To build this project, you can either reuse the 12-button keypad you built in <span class="Xref">Project #3</span>, using only 6 of the buttons, or <span class="Xref">Project #2.</span> Don’t forget to update the analog values on the analog keypad library if you’re using the 12-button keypad. Assemble the circuit as shown in <a href="chapter9.xhtml#fig9-5">Figure 9-5</a>.</p>
<figure class="IMG"><img alt="THE SCHEMATIC FOR PROJECT #28" class="img4" id="fig9-5" src="../images/fig9-5.png"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 9-5: The schematic for Project #28</samp></p></figcaption>
</figure>
<p class="TX">Enter and upload the Project #28 sketch. After a few moments, press button 7; the music in the MP3 files you arranged on the memory card should start playing. Test the other buttons to ensure their functions work. If some or all do not work, check that the button analog values match the actual keypresses using the process described in <span class="Xref">Project #2</span>, and update the values in the analogkeypad library as described in <span class="Xref">Project #3</span>.</p>
<p class="TX">Let’s see how this works:</p>
<span id="pro-28"/>

<pre><code>// Project #28 - Simple MP3 player

<span aria-label="annotation1" class="CodeAnnotationHang">❶</span> #define HEADER_START   0x7E
#define HEADER_VERSION 0xFF
#define TAIL_END       0xEF
#define CMD_PLAY_NEXT  0x01
#define CMD_PLAY_PREV  0x02
#define CMD_PLAY_IDX   0x03

<span aria-label="annotation2" class="CodeAnnotationHang">❷</span> int8_t commands[8] = {0, 0, 0, 0, 0, 0, 0, 0};
// Holds command set to send to MP3
#include &lt;SoftwareSerial.h&gt;
SoftwareSerial MP3(2, 3); // module TX to D2; module RX to D3
#include &lt;analogkeypad.h&gt;
analogkeypad keypad;

void controlMP3(int8_t command, int16_t data)
{
    commands[0] = HEADER_START;
    commands[1] = HEADER_VERSION;
    commands[2] = 0x06;
  <span aria-label="annotation3" class="CodeAnnotationHang1">❸</span> commands[3] = command;8
    commands[4] = 0x00;
  <span aria-label="annotation4" class="CodeAnnotationHang1">❹</span> commands[5] = (int8_t)(data &gt;&gt; 8);
<span aria-label=" Page 139. " epub:type="pagebreak" id="pg_139" role="doc-pagebreak"/>    commands[6] = (int8_t)(data);
    commands[7] = TAIL_END;
    for (int i = 0; i &lt; 8; i++)
    {
      <span aria-label="annotation5" class="CodeAnnotationHang1">❺</span> MP3.write(commands[i]);
    }
    delay(100);
}

void setup()
{
  <span aria-label="annotation6" class="CodeAnnotationHang1">❻</span> MP3.begin(9600);
    controlMP3(0x09, 0x02); // Select uSD card for operation
    delay(500);
}

void loop()
{
    switch (keypad.readKeypad()) // Read button status
    {
        case 7 : controlMP3(0x0D, 0); break; // Play
        case 8 : controlMP3(0x0E, 0); break; // Pause
        case 9 : controlMP3(0x02, 0); break; // Previous track
        case 10 : controlMP3(0x01, 0); break; // Next track
        case 11 : controlMP3(0x05, 0); break; // Volume down
        case 12 : controlMP3(0x04, 0); break; // Volume up
    }
    delay(250);
}
</code></pre>

<p class="TX">The sketch first declares the array used for storing the commands to control the MP3 module <span aria-label="annotation1" class="CodeAnnotationCode">❶</span> and then initializes the software serial port for Arduino-to-MP3-player control, as well as the library for the analog button keypad <span aria-label="annotation2" class="CodeAnnotationCode">❷</span>. The custom <samp class="SANS_TheSansMonoCd_W5Regular_11">void controlMP3()</samp> function accepts the command and data parameters required to control the MP3 player, inserts them into the array <span aria-label="annotation3" class="CodeAnnotationCode">❸</span> <span aria-label="annotation4" class="CodeAnnotationCode">❹</span>, and sends the command to the MP3 player via the software serial port <span aria-label="annotation5" class="CodeAnnotationCode">❺</span>. The sketch then starts the software serial port and sends the initialize command to instruct the MP3 player to use the microSD card <span aria-label="annotation6" class="CodeAnnotationCode">❻</span>.</p>
<p class="TX">Once operation has begun, the sketch loops, awaiting a response from the analog button circuit in <samp class="SANS_TheSansMonoCd_W5Regular_11">void loop()</samp>, where each button is assigned a <samp class="SANS_TheSansMonoCd_W5Regular_11">controlMP3()</samp> function along with the appropriate command data from <a href="chapter9.xhtml#tab9-1">Table 9-1</a>.</p>
<p class="TX">You now have a working MP3 audio player that you can embed, modify, or make portable for your own distraction-free source of audio (as opposed to smartphones, whose games, messages, and other content can be distracting). The USB cable connected to the Arduino is powering the project, but you could instead use a power bank or AC-to-USB adapter and place everything inside an enclosure of your own design. You might also draw a small map to explain which buttons have which effects, as shown in <a href="chapter9.xhtml#fig9-6">Figure 9-6</a>, if you’re demonstrating the project to your friends or family.<span aria-label=" Page 140. " epub:type="pagebreak" id="pg_140" role="doc-pagebreak"/></p>
<figure class="IMG"><img alt="A PHOTO OF THE COMPLETED PROJECT #28, WITH THE 12-BUTTON KEYPAD AND A USER REFERENCE FOR THE PLAYBACK CONTROLS" class="img4" id="fig9-6" src="../images/fig9-6.png"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 9-6: Example of Project #28 with the 12-button keypad and a user reference for the playback controls</samp></p></figcaption>
</figure>
<p class="TX">In the next project, you’ll use the MP3 player module you’ve just built to create a sound board.</p>
<p class="HeadProject"><span id="h1-66"/><samp class="SANS_Futura_Std_Heavy_B_21">Project #29: Building an MP3 Player Sound Board</samp></p>
<p class="TNI">In this project, you’ll use the hardware from Project #28 with the 12-button board to create a <i>sound board</i>, a device that plays preset audio tracks at the press of a button. Sound boards are often used in broadcasting, in toys, or as part of exhibits in museums to offer information for the visually impaired. This project uses buttons to initiate audio playback, but you can use it as a framework for a device that plays audio upon other actions the Arduino detects, such as triggers in your code or outputs from sensors, switches, and so on.</p>
<p class="TX">Before uploading the Project #29 sketch, rename the MP3 audio files on your microSD card, using the numbering convention shown in <a href="chapter9.xhtml#fig9-7">Figure 9-7</a>, so the MP3 player can search for the exact audio file to play at the press of a button. For example, when the player searches for audio file 1, the MP3 will play the <i>001001.mp3</i> file. Accordingly, you should name file 4 <i>004004.mp3</i>, file 12 <i>012012.mp3</i>, and so on. Store these files in a folder named <i>01</i>.</p>
<figure class="IMG"><img alt="A SCREENSHOT OF THE LIST OF MP3 FILES, ORGANIZED WITH APPROPRIATE FILENAMES" class="img7" id="fig9-7" src="../images/fig9-7.png"/>
<figcaption><p class="CAP"><samp class="SANS_Futura_Std_Book_Oblique_I_11">Figure 9-7: An example of MP3 files in the</samp> <samp class="SANS_Futura_Std_Book_11">01</samp> <samp class="SANS_Futura_Std_Book_Oblique_I_11">folder, with filenames structured for sound board use</samp></p></figcaption>
</figure>
<p class="TX"><span aria-label=" Page 141. " epub:type="pagebreak" id="pg_141" role="doc-pagebreak"/>These MP3 files can contain any audio you like. Just for fun, you might try downloading some sound effects such as animal sounds or ambient daily noise from websites such as <a href="https://www.zapsplat.com"><i>https://<wbr/>www<wbr/>.zapsplat<wbr/>.com</i></a>. I’ve included a folder of sounds from Zapsplat with the book download files at <a href="https://nostarch.com/arduino-arduinians"><i>https://<wbr/>nostarch<wbr/>.com<wbr/>/arduino<wbr/>-arduinians</i></a>. Alternately, you could load the MP3 with your 12 favorite songs.</p>
<p class="TX">Once you’ve gathered and organized your MP3 files and inserted the microSD card into the player, enter and upload the following sketch:</p>
<span id="pro-29"/>

<pre><code>// Project #29 - MP3 player sound board

#define HEADER_START   0x7E
#define HEADER_VERSION 0xFF
#define TAIL_END       0xEF
#define CMD_PLAY_NEXT  0x01
#define CMD_PLAY_PREV  0x02
#define CMD_PLAY_IDX   0x03

int8_t commands[8] = {0, 0, 0, 0, 0, 0, 0, 0};
// Holds command set to send to MP3
#include &lt;SoftwareSerial.h&gt;
SoftwareSerial MP3(2, 3); // Module TX to D2; module RX to D3
#include &lt;analogkeypad.h&gt;
analogkeypad keypad;

void controlMP3(int8_t command, int16_t data)
{
    commands[0] = 0x7E;
    commands[1] = 0xFF;
    commands[2] = 0x06;
    commands[3] = command;
    commands[4] = 0x00;
    commands[5] = 0x01;
    commands[6] = (int8_t)(data);
    commands[7] = 0xEF;
    for (int i = 0; i &lt; 8; i++)
    {
        MP3.write(commands[i]);
    }
    delay(100);
}

void setup()
{
    MP3.begin(9600);
    controlMP3(0x09, 0x02); // Select uSD card for operation
    delay(500);
}

void loop()
{
    switch (keypad.readKeypad()) // Read button status
    {
<span aria-label=" Page 142. " epub:type="pagebreak" id="pg_142" role="doc-pagebreak"/>      <span aria-label="annotation1" class="CodeAnnotationHang1">❶</span> case 1 : controlMP3(0x0F, 1); break; // Play 01/001001.mp3
        case 2 : controlMP3(0x0F, 2); break; // Play 01/002002.mp3
        case 3 : controlMP3(0x0F, 3); break; // Play 01/003003.mp3
        case 4 : controlMP3(0x0F, 4); break; // And so on…
        case 5 : controlMP3(0x0F, 5); break;
        case 6 : controlMP3(0x0F, 6); break;
        case 7 : controlMP3(0x0F, 7); break;
        case 8 : controlMP3(0x0F, 8); break;
        case 9 : controlMP3(0x0F, 9); break;
        case 10 : controlMP3(0x0F, 10); break;
        case 11 : controlMP3(0x0F, 11); break;
        case 12 : controlMP3(0x0F, 12); break;
    }
    delay(250);
}
</code></pre>

<p class="TX">This sketch operates in the same manner as that of the previous project, except that different types of commands and data are sent to the player when you press the buttons. These new commands play whatever track number matches the value of the data sent in the command. For example, to play file <i>001001.mp3</i>, the sketch sends</p>

<pre><code>7E FF 06 0F 00 01 01 EF
</code></pre>

<p class="BodyContinued">using <samp class="SANS_TheSansMonoCd_W5Regular_11">controlMP3(0x0F, 1)</samp> <span aria-label="annotation1" class="CodeAnnotationCode">❶</span>. The command for direct track playback is <samp class="SANS_TheSansMonoCd_W5Regular_11">0x0F</samp>, and the data value (1) is the number of the track’s filename (<i>001001.mp3</i>). The rest of the buttons follow the same command format, with data values that match the other MP3 filenames.</p>
</section>
<section aria-labelledby="sec2" epub:type="division">
<h2 class="H1" id="sec2"><span id="h1-67"/><samp class="SANS_Futura_Std_Bold_B_11">Moving On</samp></h2>
<p class="TNI">In this chapter, you learned how to build your own MP3 player and use it to listen to music and play sound effects. There are plenty of other fun ways to use your MP3 module, such as creating audible outputs for projects instead of LEDs or displays. For a final challenge, you might write your own MP3 player Arduino library.</p>
<p class="TX">In the next chapter, you’ll learn how to use a new type of temperature sensor, OLED displays, and multiple I<sup>2</sup>C buses with your Arduino.</p>
</section>
</section>
</body>
</html>