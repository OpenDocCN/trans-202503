<html><head></head><body>
<section><header>
<h1 class="Appendix"><span class="AppendixNumber"><span epub:type="pagebreak" title="425" id="Page_425"/>A</span><br/>
<span class="AppendixTitle">Maxing Out Your Credit Card: Setting Up a Test Lab</span></h1>
</header>
<figure class="opener">
<img src="image_fi/book_art/chapterart.png" alt=""/>
</figure>
<p class="ChapterIntro">This appendix describes the equipment we used for the work covered in this book. If you’re setting up a hardware hacking lab, this appendix can also serve as a “shopping list” of useful equipment. We explore a range of options—everything for those with budgets ranging from millions to tens of dollars. We also provide many do-it-yourself options to help with lower-cost setups.</p>
<p>We introduce equipment based on specific outcomes you want to achieve, and we discuss this equipment roughly in the order we followed in the book itself. We also cover the basic equipment (multimeters and soldering irons) that you’ll spend a lot of time working with to prepare targets for more advanced analysis work. Our goal in this appendix is to provide a complete overview of what is involved in a lab to help with overall budgeting (and so we can more easily update this when we release the second edition).</p>
<p>We should make you aware of a clear conflict of interest with some of our recommendations. Colin cofounded NewAE Technology, Inc., and <span epub:type="pagebreak" title="426" id="Page_426"/>Jasper has (at the time of writing) been with Riscure for more than a decade; both companies manufacture and sell side-channel analysis and fault-injection equipment. Despite this, we’ve tried to keep our recommendations as clear as possible on technical reasons. We have included approximate pricing in US dollars, which is accurate as of early 2021. Due to supply chain issues, prices will fluctuate, but we also want you to understand the difference between $50 and $50,000 budgets. Where well-documented low-cost DIY solutions are available, we’ve included them on the lower end of the cost scale.</p>
<p>With such a huge selection of tools, where should you start? It’s hard to make specific recommendations, as everything depends on your overall goal and budget. If you just want to follow along with the examples in this book, you could get away with a ChipWhisperer-Nano or ChipWhisperer-Lite. If you want to perform black-box testing of a recent cryptographic device, you’ll likely need EM probes and a very fast digitizing solution. And unless you want to reimplement many attack algorithms, you’ll probably want a more complete software solution, such as the Riscure Inspector.</p>
<h2 id="h1-278748b01-0001">Checking Connectivity and Voltages: $50 to $500</h2>
<p class="BodyFirst">Although the montage of hardware hacking that will be featured on <em>CSI: Cyber</em> will include reballing BGAs, carefully modifying circuit boards, and decapping chips with acid, most of your time in real life will be spent checking electrical connectivity. This testing includes looking for shorts on assembled boards, measuring what type of pullups might be on a line, tracing lines on a circuit board, and figuring out what pinout a cable you are using has.</p>
<p>Add on to checking connectivity some other common tasks you can accomplish with a multimeter, such as measuring voltages and current draw, and you soon realize one of the most valuable tools as a hardware hacker is going to be your trusty <em>(digital) multimeter</em>.</p>
<p>We specifically mention the electrical connectivity check, as most multimeters include a “beeper function” that beeps when a short (or low resistance) is measured. The quality of this feature can vary a lot; check out Dave Jones’s <em>EEVBlog</em> YouTube channel for some great product reviews and comparisons.</p>
<p>On the higher end, Fluke meters are likely the most well-known brand. Our number-one recommendation in this line is the Fluke 179/EDA2 kit. This kit in particular includes the TP910 test leads, which have a very fine point to easily probe QFN packages. The probe tips include both spring-loaded pogo pins (great for keeping the tip on a pin) and sharp stainless-steel tips (great for probing past solder mask or conformal coating). <a href="#figureA-1" id="figureanchorA-1">Figure A-1</a> shows an example of them in action. You can buy these probes separately and use them with other brands of meters as well, but check the jack specifications, as different meters do have slightly different-sized jacks. The TP910 test leads have the disadvantage that the thin and flexible cable is likely to be bent on smaller radii and eventually develops internal openings, especially near the end where flexing is most pronounced.</p>
<span epub:type="pagebreak" title="427" id="Page_427"/><figure>
<img src="image_fi/278748b01/faa001.png" alt="faa001"/>
<figcaption><p><a id="figureA-1">Figure A-1</a>: Fluke TP910 test leads with pogo pin (left) on QFN IC pad and sharp probe to pierce solder mask (right)</p></figcaption>
</figure>
<p>On the medium-to-lower end, the field opens up quite a bit. One recommendation is to stay away from low-cost Fluke (or other big brand) options, as they often seem to be limited in capability to avoid cannibalizing the higher-end options they also offer. An easy choice is often the <em>EEVBlog</em>-branded meters, which have generally been well tested and represent good value. Depending on your country, you may find many different options available locally, which makes it hard to specify specific models, but checking ratings on your local Amazon site is a good place to start.</p>
<p>If you go for a budget meter, it may still be worth splurging on a nicer lead set. While the meter electronics of a budget meter may be up to the task, the leads often feel cheap or have too large a point to be useful. Finding good leads with silicone insulation cable will be money well spent, as the leads are the part with which you’ll be spending a lot of hands-on time. Don’t be put off by the idea of spending more on the test leads than you did on the meter itself.</p>
<h2 id="h1-278748b01-0002">Fine-Pitch Soldering: $50 to $1,500</h2>
<p class="BodyFirst">Soldering is another task you’ll find yourself doing frequently. We’re calling this <em>fine-pitch soldering </em>because beyond standard through-hole work, you’ll also be tacking wires onto test points and doing other tasks that require a soldering iron with a fine point. You’ll want a variety of options and not just the stock fine-point tip, as you’ll find the fine-point tip gets ruined fairly quickly. Soldering tips are generally made up of some internal copper slug that has rapid heat transfer and a thin layer of a metal that won’t react with the solder or oxidize (see <a href="#figureA-2" id="figureanchorA-2">Figure A-2</a>).</p>
<span epub:type="pagebreak" title="428" id="Page_428"/><figure>
<img src="image_fi/278748b01/faa002.png" alt="faa002"/>
<figcaption><p><a id="figureA-2">Figure A-2</a>: Soldering tip construction involves a copper core with a more robust plating, which is selected to survive interacting with the solder in use.</p></figcaption>
</figure>
<p>As soon as the plating has a hole in it, the tip is generally trashed because it no longer offers good thermal connectivity. A smaller (finer) tip will typically develop holes quickly, especially if used to solder larger items that might cause you to push or rub the tip.</p>
<p>One of the most popular soldering options is the Hakko FX-951, which features a number of very fine tips that are great for working with small surface-mount parts and tacking wire onto tiny parts. The unit itself is around $400, and the tip cartridges are relatively inexpensive (starting at $10). The tip cartridges have the heater and thermocouple integrated into them, meaning you get heat fairly close to the tip itself.</p>
<p>Another higher-end soldering tool that we love is the Metcal system, which uses something called “SmartHeat” (see <a href="#figureA-3" id="figureanchorA-3">Figure A-3</a>).</p>
<figure>
<img src="image_fi/278748b01/faa003.png" alt="faa003"/>
<figcaption><p><a id="figureA-3">Figure A-3</a>: Metcal uses a heater that’s almost integrated with the tip (SmartHeat) to regulate tip temperature. In this system, the tip temperature is fixed, but it responds much faster than a tip with a separate thermometer.</p></figcaption>
</figure>
<p>The heater is actually a special material with a Curie point (the temperature at which it changes its magnetic properties) selected to be the desired tip temperature. It’s integrated into the tip itself and driven with a high-power RF signal source, so the tip can go from soldering a small surface-mount resistor to desoldering a huge connector and respond almost instantly.</p>
<p>A common starting point is a Metcal MX-5210 base station ($800), which then requires you to select appropriate tips (it doesn’t even come with tips). For tips, part numbers STTC-125 and STTC-145 are good choices (around $30), and both work with lead-free solder. The base station and tips are all expensive, and the tips are more fragile than classic heater-based solutions.</p>
<p><span epub:type="pagebreak" title="429" id="Page_429"/>If you want the same sort of results at a lower cost, Thermaltronics offers lower-cost solutions using this same technology. The Thermaltronics TMT-9000S ($400) actually uses the same tip connection as the Metcal system, and thus it’s also a source of lower-cost tips for the Metcal base station.</p>
<p>JBC also has started offering good-value stations. In particular, the CDB and CDS lines are lower cost than Metcal stations, but with excellent performance. Depending on your country, you may find certain brands easier to source than others, and often the import or shipping costs may substantially shift the value of one station compared to another.</p>
<p>The Hakko FX-951, Metcal, Thermaltronics, and JBC are all still fairly high-end stations. You can get away with a much cheaper iron as well, but at the lower end, your specific market tends to determine the best value. One good option is the TS100 soldering iron (see <a href="#figureA-4" id="figureanchorA-4">Figure A-4</a>).</p>
<figure>
<img src="image_fi/278748b01/faa004.png" alt="faa004"/>
<figcaption><p><a id="figureA-4">Figure A-4</a>: The TS100 is a low-cost iron that performs well relative to higher-priced irons.</p></figcaption>
</figure>
<p>This soldering iron is unique because it runs on a DC input, which means it’s small and portable. You can easily run it off a car battery or AC-DC power adapter (such as your laptop power adapter). In practice, it works very well and has fast thermal recovery, but be sure to use a sufficiently strong power supply, ideally in the 19 to 24 V range, to provide the most power to the iron. The TS100 is available in kits with various-sized tips, or you can get the TS100 with a provided tip for less than the cost of some of the more expensive Metcal replacement tips (we told you the Metcal stuff was expensive).</p>
<aside epub:type="sidebar">
<div class="top hr"><hr/></div>
<section class="note">
<h2><span class="NoteHead">Note</span></h2>
<p>	With fine-pitch soldering, be sure to use lots of flux. If you started soldering with through-hole parts and always relied on the flux present in your flux-core solder, you might not realize how much you are missing out on. Flux helps solder adhere where it should (on pads and leads) and not where it shouldn’t (on solder mask or PCB in between). A simple no-clean flux, such as Chip Quik SMD291 or SMD291NL (NL for lead-free) doesn’t need to be fully cleaned up afterward, which makes rework easy.</p>
<div class="bottom hr"><hr/></div>
</section>
</aside>
<h2 id="h1-278748b01-0003">Desoldering Through-Hole: $30 to $500</h2>
<p class="BodyFirst">With any luck, you won’t ever need to remove a through-hole connector or similar from a printed circuit board (PCB). But sometimes it’s necessary, and it’s tricky to do when even a small amount of solder is left. Some of the <span epub:type="pagebreak" title="430" id="Page_430"/>basic tools, such as <em>solder</em> <em>wick</em> and a <em>solder sucker</em>, become difficult to use with more intense tasks.</p>
<p>Instead, having something like a <em>solder removal “gun”</em> can be worthwhile. These have an active vacuum alongside a heater element, to heat up the solder at the same time as removing it from the component lead. <a href="#figureA-5" id="figureanchorA-5">Figure A-5</a> shows one stand-alone example, the Hakko FR-300, but you can find them as add-ons to various soldering workstations as well.</p>
<figure>
<img src="image_fi/278748b01/faa005.png" alt="faa005"/>
<figcaption><p><a id="figureA-5">Figure A-5</a>: Hakko FR-301 is a popular through-hole removal tool, and the direct replacement for the FR-300 shown here.</p></figcaption>
</figure>
<p>No matter what you use to remove the solder from a board, adding a lower melting point solder onto the board first can help. If you are desoldering a lead-free process, for example, the solder will remain molten only for a short period of time before it cools too much. If you first add some leaded solder to the connection, it will remain molten for longer (warning: this means the board is no longer ROHS-compliant if you are trying to return it to service). You can extend this further by using products like the Chip Quik removal alloy SMD1NL (lead-free) or SMD1L (leaded), which are specifically designed to be added into a solder joint and result in a much lower melting temperature. Once the joint is cleaned up, it could be soldered again with “regular” solder to behave as normal.</p>
<h2 id="h1-278748b01-0004"><span epub:type="pagebreak" title="431" id="Page_431"/>Soldering and Desoldering Surface Mount Devices: $100 to $500</h2>
<p class="BodyFirst">Surface-mount soldering has a wide range of requirements. We’ll focus on the most common tasks required for hardware hacking rather than all possible surface-mount jobs.</p>
<p>The single most important element for surface-mount soldering is the <em>hot air gun</em>. This device provides a flow of hot air that helps solder joints underneath parts. You can find various popular hot air tools at all sorts of ranges. As of this writing, a popular mid-range option is the Quick 861DW (<a href="#figureA-6" id="figureanchorA-6">Figure A-6</a>), which provides a reliable source of hot air with a good range of settings. Along with the hot air, you might need <em>nozzles</em>. Don’t worry about getting nozzles to fit every package you need, as you can move the smaller nozzles around the package surface for larger packages.</p>
<figure>
<img src="image_fi/278748b01/faa006.png" alt="faa006"/>
<figcaption><p><a id="figureA-6">Figure A-6</a>: The Quick 861DW is a good mid-range hot air gun.</p></figcaption>
</figure>
<p>If you’re not sure about settings for the hot air gun, a good starting point is to adjust the temperature and flow rate such that a piece of paper becomes light brown from the heat as you move the gun around on the paper. You don’t want too fast a flow rate or you’ll blow parts around too. Before you start using one on important boards, get an old laptop or computer motherboard and see how many parts you can easily remove. If you get really good, start putting them back together.</p>
<p>If you plan on working with larger packages (such as BGAs), a <em>board pre-heater</em> can be useful. This tool makes hot air go onto the other side of the board, which means the hot air gun is used only to “peak” the temperature to the final value that will melt the solder.</p>
<p><span epub:type="pagebreak" title="432" id="Page_432"/>Many YouTube channels show this rework technique in more detail. Louis Rossmann’s channel shows repairs on laptops (especially MacBooks) and cell phones. These consumer devices often have extremely fine-pitch parts, and you can get a feel for what is possible with enough experience.</p>
<p>If you have limited surface-mount requirements, you might also consider the Chip Quik <em>removal</em><em> alloy</em> SMD1L or SMD1NL mentioned earlier. This solder alloy has a very low melting point. It can be used with a regular soldering iron, and it stays molten long enough that you can bring your iron around an entire SMD chip—even some large packages like a TQFP-144! It works only with visible pads, of course, but it doesn’t require any additional tools beyond what you might already have, and the alloy itself is cheap (less than $20). Even with hot air equipment, it can be useful in situations where you have more heat-sensitive parts nearby that are difficult to mask off.</p>
<p>You’ll also likely run into <em>ball grid array (BGA)</em> packages that have solder balls on the bottom side, which may require you to “reball” them after removal. You can get fancy reballing jigs, but if you are working with them only occasionally, you might instead get away with a low-cost BGA stencil set. Since it can be hard to find useful instructions for the low-cost tools, we’ll re-create a technique that works for us in this book. We’ll use a cheap pack of stencils costing only about $20 (see <a href="#figureA-7" id="figureanchorA-7">Figure A-7</a>). We can smear solder paste onto the stencil, which will form nice balls when reheated. If you haven’t used solder paste before, it takes a bit of time to get the technique “just right.” Most of it has a limited shelf life and should be stored in a fridge. For this reason, we’ll give a quick rundown of a more reliable technique with those stencils.</p>
<figure>
<img src="image_fi/278748b01/faa007.png" alt="faa007"/>
<figcaption><p><a id="figureA-7">Figure A-7</a>: Example of a cheap set of stencils for BGA reballing</p></figcaption>
</figure>
<p>With this type of cheap stencil, the most reliable reballing process is as follows:</p>
<ol class="decimal">
<li value="1">Remove the old solder balls and solder with solder wick.</li>
<li value="2">Clean the area well with isopropyl alcohol (IPA) and/or flux remover.</li>
<li value="3"><span epub:type="pagebreak" title="433" id="Page_433"/>Tape the deballed chip to the bottom of the stencil.</li>
<li value="4">Smear paste-type flux (such as MG Chemicals 8341-10ML) onto the stencil (with the chip underneath it) with a squeegee such as credit card edge. Be careful not to cause any misalignment of the stencil.</li>
<li value="5">Using appropriately sized solder spheres, carefully push balls into each stencil hole. Ensure no spare balls are left on surface of the stencil. <a href="#figureA-8" id="figureanchorA-8">Figure A-8</a> shows the start of this process.</li>
<li value="6">Heat the chip until balls reflow onto chip surface (see <a href="#figureA-9" id="figureanchorA-9">Figure A-9</a>), which will require the solder spheres to match the correct size for your device (marked on the stencil in this example). You may be able to find kits with multiple solder ball (sphere) sizes.</li>
</ol>
<figure>
<img src="image_fi/278748b01/faa008.png" alt="faa008"/>
<figcaption><p><a id="figureA-8">Figure A-8</a>: Fluxed IC taped onto stencil. Note BGA does not exactly match stencil, leaving some dark-looking holes with missing pads.</p></figcaption>
</figure>
<p>Since many of these kits come from unknown sources (if you’re purchasing on Amazon), you may wish to use a more reputable source. Chip Quik makes several solder sphere kits; for example, if you’re using 0.4mm solder spheres, Chip Quik part number SMD2032-25000 is available from Digi-Key and provides 25,000 0.4mm solder spheres for less than $30.</p>
<p>As a final note on BGAs, investigate the availability of low-cost jigs and stencils for your part of interest. You can find several low-cost <em>BGA</em> <em>reballing jigs</em> for the more popular parts, and they simplify the task of holding the BGA and stencil together correctly aligned.</p>
<span epub:type="pagebreak" title="434" id="Page_434"/><figure>
<img src="image_fi/278748b01/faa009.png" alt="faa009"/>
<figcaption><p><a id="figureA-9">Figure A-9</a>: Using hot air to melt solder balls to complete the task. The missing pads from <a href="#figureA-8">Figure A-8</a> shouldn’t have balls in them—the extra balls, which cannot adhere to a pad, are at risk of coming out of the stencil holes and causing shorts.</p></figcaption>
</figure>
<h2 id="h1-278748b01-0005">Modifying PCBs: $5 to $700</h2>
<p class="BodyFirst">Modifying PCBs, which includes cutting traces to insert resistors for shunts, rerouting traces, or tapping onto data lines, is another common task. While you can get away with a simple X-Acto knife for a lot of this work, a rotary tool may be useful.</p>
<p>The <em>rotary tool</em><em>s</em> you can purchase at the hardware store will typically have accessories that are too physically large to be useful on PCBs. Instead, look for one like the Foredom K.1070 High Speed Rotary Micromotor Kit (see <a href="#figureA-10" id="figureanchorA-10">Figure A-10</a>). This device can run up to 38,000 RPM, and you’ll realize the difference when holding it in your hand. This is due to the high-quality bearings that blow away the normal name-brand rotary tools you can buy from your local hardware store.</p>
<p>If you’re purchasing this specific tool, be sure to get with the 3/32-inch collet option. You can then get some tiny rotary tips for it, such as the Foredom AK211 kit, which make it possible to drill up a single BGA ball from the rear side of a device or even to attach to a ball on a BGA that isn’t routed to the PCB.</p>
<p>You’ll also find a light <em>grinding tip</em> such as the Foredom A-71 useful. This tip makes it easy to remove the solder mask from the PCB without damaging the underlying trace, which is perfect when you are trying to tap into a number of traces, such as a data bus.</p>
<span epub:type="pagebreak" title="435" id="Page_435"/><figure>
<img src="image_fi/278748b01/faa010.png" alt="faa010"/>
<figcaption><p><a id="figureA-10">Figure A-10</a>: Foredom High Speed Rotary Micromotor Kit</p></figcaption>
</figure>
<h2 id="h1-278748b01-0006">Optical Microscopes: $200 to $2,000</h2>
<p class="BodyFirst">In line with requirements for modifying the PCB, you’ll likely need to observe such modifications. The normal standard for doing so is a <em>stereo vision microscope</em> (see <a href="#figureA-11" id="figureanchorA-11">Figure A-11</a>). These microscopes provide a stereo view that retains your depth perception, making it easier to see when your soldering iron or rotary tool is touching the PCB.</p>
<figure>
<img src="image_fi/278748b01/faa011.png" alt="faa011"/>
<figcaption><p><a id="figureA-11">Figure A-11</a>: A low-cost AmScope single-boom optical microscope, with a total magnification of 10× or 20× (switchable)</p></figcaption>
</figure>
<p><span epub:type="pagebreak" title="436" id="Page_436"/>You may be able to find a surplus one locally, but if you are purchasing new, a low-cost option is the AmScope brand typically available on Amazon. When evaluating different options, consider that a double-arm boom makes it less likely the head will rotate on its own, which is a problem with some low-cost single-arm boom microscopes.</p>
<p>The <em>total magnification</em> is a combination of the eyepiece magnification and the objective magnification. For circuit board soldering, a total magnification of 10× to 30× is useful, which could mean an objective magnification of 1× and eyepiece of 20×, for example. With some microscopes, you may find that you need to add a <em>Barlow lens</em> onto the objective stage. The Barlow lens provides a reduction in magnification (typical is 0.5×), but it increases the microscope’s focal range, so you have more space underneath the microscope to fit your circuit board and the tools you’re using on your board.</p>
<h2 id="h1-278748b01-0007">Photographing Boards: $50 to $2,000</h2>
<p class="BodyFirst">If you’re documenting your work, you’ll also want to take photographs of board-level items, which requires using a microscope with some form of video camera. On the cheaper end are a variety of low-cost USB or Wi-Fi microscopes available on Amazon and similar. They provide great value for $20 to $40 (<a href="#figureA-12" id="figureanchorA-12">Figure A-12</a> shows an example).</p>
<figure>
<img src="image_fi/278748b01/faa012.png" alt="faa012"/>
<figcaption><p><a id="figureA-12">Figure A-12</a>: A low-cost USB microscope</p></figcaption>
</figure>
<p>If you are trying to use these USB microscopes for real-time soldering (as a replacement for the visual microscope), be aware they sometimes have lag due to the USB connection that can make real-time use difficult.</p>
<p><span epub:type="pagebreak" title="437" id="Page_437"/>If you purchase a <em>trinocular microscope</em> (instead of just a stereo microscope), you can add a camera to photograph exactly what you are seeing, and you can also broadcast the camera image to a screen for using in training or educational environments. You can find reasonable-cost trinocular microscopes for $500 to $1,000 from the low-cost AmScope manufacturer mentioned previously.</p>
<p>You can also find <em>monocular digital microscopes</em> that have only the camera portion, typically with HDMI and USB outputs. The lag through the HDMI/VGA outputs is usually much less than through USB, meaning that with an external monitor, they also can provide a good method of photographing or inspecting boards without eyestrain of looking through a microscope eyepiece. If you are planning on using the camera output for real-time feedback (such as soldering or probing), finding an HDMI or VGA output camera will save you the potential grief of discovering that the USB lag makes you feel slightly crazy.</p>
<h2 id="h1-278748b01-0008">Powering Targets: $10 to $1,000</h2>
<p class="BodyFirst">Another frequent task will be powering targets, which is most easily done with a <em>bench-top power supply</em>. These allow you to configure voltage and (maximum) current to be supplied. A variety of them are available from normal test equipment suppliers, but a good value option is the DP832 from Rigol Technologies.</p>
<p>A more complicated (in a good way) target power option is the EEZ Bench Box 3, which is open source hardware and allows for a variety of computer control options.</p>
<p>On the lower end, many additional choices are available for a bench-top supply. Your local store may stock a lower-cost bench-top supply. It’s hard to recommend a specific model, as the heavy transformer in many of the power supplies combined with different local-market certification requirements means a variety of vendors and solutions are available worldwide.</p>
<p>Targets that require only a simple power supply may allow you to use AC-DC “wall wart” power bricks, which can be found for free with discarded electronics. They can also be combined with low-cost no-name adjustable regulators that you can find on Amazon (or similar) to provide an adjustable power supply at very little cost. These inexpensive options come at a price: they have a relatively high noise output, which can negatively affect any side-channel analysis you want to perform later.</p>
<h2 id="h1-278748b01-0009">Viewing Analog Waveforms (Oscilloscopes): $300 to $25,000</h2>
<p class="BodyFirst">While <em>oscilloscopes</em> have several uses, normally you need to view analog waveforms as part of many tasks, such as seeing what I/O patterns are present between two devices, checking voltage levels, watching reset pin activity, or anything else. We also use them as part of our side-channel power analysis measurement, but we cover that use case separately from the more general investigation use case.</p>
<p><span epub:type="pagebreak" title="438" id="Page_438"/>Many options exist for general investigation. The most popular lower-cost oscilloscope brand is the Rigol, specifically the Rigol DS1054Z. Rigol oscilloscopes still have good-quality probes and reasonable performance, so despite being lower in cost, they don’t feel cheap like you might expect. More recently, Rigol also offers higher-performance devices that are still a much better value than the more well-known brands.</p>
<p>The more common brands, such as Keysight (previously Agilent &amp; HP), Tektronix, and Teledyne LeCroy, offer a fairly wide variety of oscilloscopes as well. The companies often run promotions that bundle together various accessories, so even if you are on a budget, don’t discount the name-brand oscilloscopes. Watch for models that have only the name part of “name brand”—that is, those that are very low-cost “versions” but still have the name of the brand. These low-end devices are often rebranded versions of other manufactures scopes, which means they were not designed in-house and not actually using any of the long experience that goes into the high-end models. Also, because vendors don’t want to cannibalize the higher-end scope market, they often are limited in important ways that will make them less useful for “real” work (but fine for running labs in a university, for example). We’ll show you an example of that with the Keysight EDUX1002A scope in the next section, “Memory Depth,” where the EDUX1002A is limited in memory depth so is not very useful for power analysis work.</p>
<p>If you have a larger budget, finding a name-brand device may make future expansion easier as you can tap into a large number of probes and accessories. While there is some cross-platform compatibility, many of the probes and accessories tend to work best with the original manufactured brand. Thus, you may wish to purchase a specific oscilloscope or brand due to planned future usage requiring a probe that Rigol (or similar) doesn’t offer. If you have the chance, it’s also worth test-driving a few different devices (often you can do this at a trade show). The interface does vary for different devices, so you might find you have a personal preference. Some companies even will let you rent high-end oscilloscopes by the day/week/month. If you’re outfitting a lab, spending some rental time ensuring that the scope will work in practice could save you from an expensive mistake.</p>
<p>As a final note on oscilloscope usage: another option is to use a computer-based scope, of which PicoScope is the most popular. We highly recommend these devices because you can get a lot of equipment in a small package. It’s also easy to script these devices, as an API is available in various languages. Some people prefer having physical knobs to twiddle, however, so using PC-based oscilloscopes is somewhat of a personal preference.</p>
<p>When it comes time to choosing an oscilloscope for general usage, the important considerations are the <em>sample rate</em> (typically in MS/s or GS/s), <em>analog bandwidth</em>, and <em>memory depth</em>. We’ll briefly cover what to look for with an eye on general usage (again, we’ll cover side-channel measurements in another section).</p>
<h3 id="h2-278748b01-0001"><span epub:type="pagebreak" title="439" id="Page_439"/>Memory Depth</h3>
<p class="BodyFirst">A large memory depth allows you to capture long waveforms of, for example, a device’s entire boot process. Lower-end oscilloscopes and low-cost name-brand scopes often have limited memory depths, even though the bandwidth and sample rate look good. For example, Keysight’s 1000-X series is designed to compete with the Rigol offerings. The DSOX1102A (at approximately $700) offers a memory depth of only 1 Mpts (Mega-Points, or million sample points). Its education version, the EDUX1002A (at approximately $500), offers a memory depth of an even smaller 100 kpts. By comparison, the Rigol DS1054Z offers a memory depth of 24 Mpts. But what does that mean in practice?</p>
<p>Assume you were sampling at 1 GS/s, meaning 1,000,000,000 samples are written to memory per second. While the EDUX1002A would store only 0.1ms of the waveform after the trigger (calculated by 100,000 sample memory/1,000,000,000 samples/s = 0.0001 second). The Rigol at the same sample rate would provide 24ms of recorded trace. If you need a longer trace, you could reduce the sample rate. If we could get away with a 100 MS/s recording rate, the Rigol would store 240ms of data, while the EDUX1002A would still store only 1ms of waveform. The Tektronix low-cost model (TBS1000) is even worse with a memory depth of a mere 2.5 kpts! Stepping up a little bit toward a mid-range Tektronix like the MDO3000 series gives a more reasonable 10 Mpts, so be aware when comparing the devices.</p>
<p>One area where PC-based oscilloscopes shine is the memory depth. The low-end PicoScope 2204A series starts out at only 8 kpts, but stepping up a little bit to the 2206B (approximately $350) gives us 32 Mpts—that’s a larger buffer than some of the $10k or $20k scopes from the big brands.</p>
<p>For general exploration, the memory depth matters, as we often don’t know what we are looking for right away. When it comes time for an actual attack, we rarely need such a large memory depth, since we are measuring a very specific moment in time. But if we need to record information about an entire boot process, we may have no idea which part of the 100ms boot actually matters. While we can trade off sample rate with memory depth to record more time, we would set a 1 Mpts buffer as the minimum we recommend. Buying a scope with too small a buffer is going to frustrate you when trying to observe more complex sequences of actions, and it will make some of the tasks we describe in this book difficult as well.</p>
<h3 id="h2-278748b01-0002">Sample Rate</h3>
<p class="BodyFirst"><em>Sample rate</em> is the speed at which the internal analog-to-digital converter (ADC) is running. You’ll typically see something like 1 GS/s or 100 MS/s, which means 1 billion conversions and 100 million conversions per second, respectively. For general exploration, a good rule of thumb is to have a sample rate of 5× to 10× faster than the digital signal you want to observe. If you are planning <span epub:type="pagebreak" title="440" id="Page_440"/>on probing SPI traffic at 50 MHz, this suggests you would need a 500 to 1,000 MS/s oscilloscope. This 5× to 10× rate means you can actually get a “feel” for the shape of the waveform, which is useful to see the actual speeds at which it’s changing, if there are any glitches in the waveform.</p>
<p>If you sampled too slow, you’ll actually get an incorrect waveform due to an effect called <em>aliasing</em>. You can find theoretical diagrams of that, but what does it look like in real life? We generated a 60 MHz waveform and fed it into a scope, with the resulting scope screen shown in <a href="#figureA-13" id="figureanchorA-13">Figure A-13</a>.</p>
<figure>
<img src="image_fi/278748b01/faa013.png" alt="faa013"/>
<figcaption><p><a id="figureA-13">Figure A-13</a>: A 60 MHz square wave from a signal generator, sampled at 2500 MS/s</p></figcaption>
</figure>
<p>We then changed the scope sampling rate to 100 MS/s (see <a href="#figureA-14" id="figureanchorA-14">Figure A-14</a>). You’ll notice the frequency captured by the scope is not 60 MHz at all; you can see at the bottom of the figure that the scope recognizes a 33.59 MHz signal. If you didn’t know this was actually a 60 MHz signal, nothing would be obviously wrong! An oscilloscope normally will have an anti-aliasing filter to kill any frequencies above the scope’s maximum sample rate, but if you choose to sample too slowly (as we did here), you can still get into trouble.</p>
<p><a href="#figureA-15" id="figureanchorA-15">Figure A-15</a> shows what happens if the sampling frequency goes down to 5 MS/s. Now the measured signal is reported at 19.88 Hz!</p>
<p>Though in principle 60 MHz is an integer multiple of 5 MHz, we would expect aliasing to show a 0 MHz signal: a flat line. However, in practice, both the signal generator and the oscilloscope frequency will oscillate slightly from the base frequency, which shows up as a (low) frequency due to aliasing.</p>
<span epub:type="pagebreak" title="441" id="Page_441"/><figure>
<img src="image_fi/278748b01/faa014.png" alt="faa014"/>
<figcaption><p><a id="figureA-14">Figure A-14</a>: A 60 MHz square wave from a signal generator, sampled at 100 MS/s; due to aliasing, the measured frequency is incorrect</p></figcaption>
</figure>
<figure>
<img src="image_fi/278748b01/faa015.png" alt="faa015"/>
<figcaption><p><a id="figureA-15">Figure A-15</a>: A 60 MHz square wave from a signal generator sampled at 5.00 MS/s; the measured frequency is the “beat frequency” between the signal generator clock and scope time base, which is an aliasing problem</p></figcaption>
</figure>
<h3 id="h2-278748b01-0003">Bandwidth</h3>
<p class="BodyFirst">Related to sample rate is the <em>analog bandwidth</em>. The oscilloscope’s front end will have a filter to prevent too high a frequency from coming through to the sample circuit, and the bandwidth represents where that frequency starts to “roll off.” Some amount of higher frequency still does get through, <span epub:type="pagebreak" title="442" id="Page_442"/>as the filter is not perfect. The accepted method to characterize a filter is called the “3 dB” point, which translates to an <em>attenuation</em> of the filtered signal to 70.7 percent of the actual amplitude.</p>
<p>When a scope has a 100 MHz bandwidth, this means that if you put a 10 MHz 1 V sine wave into the oscilloscope, you’d see a 10 MHz sine wave with an amplitude of 1 V (as expected). But if you put a 100 MHz sine wave into the oscilloscope, you’d see only a 0.707 V amplitude signal. As you increase the frequency of the sine wave, the amplitude of the sine wave is reduced.</p>
<p>If you are talking digital sampling, things look slightly different. A digital square wave actually has “infinite” frequencies present. In practice you don’t need such infinite bandwidth, but a 2.5× to 5× higher bandwidth than the digital wave will keep edges reasonably crisp. As an example, <a href="#figureA-16" id="figureanchorA-16">Figure A-16</a> shows an 18 MHz square wave being sampled at 2.5 GS/s with a 250 MHz analog bandwidth.</p>
<figure>
<img src="image_fi/278748b01/faa016.png" alt="faa016"/>
<figcaption><p><a id="figureA-16">Figure A-16</a>: An 18 MHz square wave comes through as clean with a 250 MHz bandwidth.</p></figcaption>
</figure>
<p>Compare <a href="#figureA-16">Figure A-16</a> with the same square wave with 20 MHz analog bandwidth in <a href="#figureA-17" id="figureanchorA-17">Figure A-17</a> (the oscilloscope we’re using has the ability to switch the bandwidth).</p>
<p>Many scopes now have the bandwidth (and sometimes the sample rate) as an “in-field upgradable” solution, which means the oscilloscope hardware has a higher bandwidth present, but you need to pay to unlock that feature. The probes themselves may be matched to the model, so if you order the 100 MHz bandwidth scope, it ships only with probes that have a 100 MHz bandwidth as well. On many models you can find information about how that upgrade process works online, and you might find it works with your budget to purchase a lower-end scope that allows you to unlock higher sample rates and bandwidths later.</p>
<span epub:type="pagebreak" title="443" id="Page_443"/><figure>
<img src="image_fi/278748b01/faa017.png" alt="faa017"/>
<figcaption><p><a id="figureA-17">Figure A-17</a>: An 18 MHz square wave comes through as a sine wave with 20 MHz bandwidth since no higher frequency components are present.</p></figcaption>
</figure>
<h3 id="h2-278748b01-0004">Other Features</h3>
<p class="BodyFirst">This book isn’t an “introduction to electronics” book, so we won’t dwell too much on other features. One thing you’ll often see is an ability to <em>decode</em> certain signals such as RS232 and I2C. It can be a useful feature, but in practice it’s often easier to use a logic analyzer for this (discussed next).</p>
<p>The one feature that <em>is</em> useful is when that decoding can also generate a trigger signal—that is, you can trigger the analog oscilloscope measurement on a digital I/O data byte. Many oscilloscopes that support decoding also support this real-time trigger functionality. You can also often send this trigger to a “Trigger Out” connector, which can trigger fault injection equipment.</p>
<h2 id="h1-278748b01-0010">Viewing Logic Waveforms: $300 to $8,000</h2>
<p class="BodyFirst">Compared to viewing analog waveforms, viewing digital waveforms normally means just being able to see zeros and ones on a data bus. A typical data capture looks something like <a href="#figureA-18" id="figureanchorA-18">Figure A-18</a>, which is an example of monitoring an SPI data transaction along with a serial interface.</p>
<p>There are a few main vendors of <em>logic analyzer</em> tools, but we’ll mostly concentrate on PC-based instruments because when using the logic analyzers, you are more often setting up digital decoding features and exporting data. It’s much easier to perform that on a PC, so logic analyzers generally lend themselves very well to being based on a PC platform.</p>
<span epub:type="pagebreak" title="444" id="Page_444"/><figure>
<img src="image_fi/278748b01/faa018.png" alt="faa018"/>
<figcaption><p><a id="figureA-18">Figure A-18</a>: Example of a logic analyzer capture</p></figcaption>
</figure>
<p>For PC-based platforms, the most well-known vendor is Saleae. That company’s products have been so successful that earlier versions remain widely counterfeited and available on various markets, sold as ultra-cheap (less than $10) logic analyzers. The most recent versions of Saleae analyzers feature both analog and digital measurements possible on each pin, which allows you to view what’s happening in “real life” (the analog domain), while also trying to translate to simple ones and zeros. That is also useful during an investigation, as sometimes you aren’t sure of the actual logic level in use (is it 1.8 V, 3.3 V, and so on?). The Saleae software makes it easy to decode various protocols and observe what is happening across the entire system. The software supports almost any protocol you are likely to run across, making it an easy recommendation as a critical part of your toolkit.</p>
<p>The Saleae Logic hardware works by streaming data back to your computer, which means there is no real limit on capture length. You can capture hours of data if your computer can keep up. Because digital data can be easily compressed (you don’t need to store constant states), the digital files are much more reasonable compared to analog measurement sampling.</p>
<p>The only downside of the Saleae Logic is the number of pins. The largest model with 16 inputs may not be enough. And while the Saleae Logic Pro 16 has 16 inputs, it can keep up the 500 MS/s sample rate only across six channels; enabling all 16 channels drops the digital sample rate to 125 MS/s. If you plan on sniffing a large bus, the Saleae may not be the best choice.</p>
<p>If you need more signals, the Intronix LA1034 LogicPort is a relatively old instrument that remains highly competitive. It has 34 channels of inputs and samples at 500 MS/s across all 34 channels, giving it one of the best value propositions available on the market.</p>
<p>We haven’t covered several vendors of other tools, but instead want to provide a few tips. If you want to go with a high-end tool, NCI Logic Analyzers makes the GoLogicXL series, which offers 4 GS/s across 36 or 72 channels. The GoLogicXL also offers hardware triggering, something we’ll cover next.</p>
<h2 id="h1-278748b01-0011"><span epub:type="pagebreak" title="445" id="Page_445"/>Triggering on Serial Buses: $300 to $8,000</h2>
<p class="BodyFirst">The Saleae logic analyzer works by downloading “raw” bits to the computer. The logic analyzer doesn’t understand whether it’s I2C, UART, or SPI traffic, which is fine for analysis, but what if you need to trigger on specific bytes?</p>
<p><em>Triggering</em> on specific data is a common task. Many logic analyzers that advertise “hardware trigger” support triggering only on certain digital patterns presented to the logic analyzer inputs. For example, an 8-input logic analyzer can be configured to trigger on the pattern “10010111” or maybe even on a sequence of such patterns. It’s generally designed to support triggering on a memory access on a parallel bus, for example. But if we are trying to trigger on a serial protocol, this simple pattern-based trigger won’t be remotely flexible enough for us.</p>
<p>In that case, we’ll need a smarter logic analyzer, since the hardware capture device must understand enough about the protocol to actually trigger on specific data bytes. That is, the logic analyzer itself needs to decode the serial data in real time to create a trigger signal.</p>
<p>Many logic analyzers don’t support this feature, as they rely on the flexibility of a computer to perform the protocol analysis. Some oscilloscopes with serial bus decoding do support triggering on decoded serial data, but it’s important to check that the feature can be used to generate a trigger on a specific data sequence before investing in any given oscilloscope.</p>
<p>Many of the professional (expensive) logic analyzers will support such features. For example, the NCI GoLogicXL does support this feature, allowing you to match specific packets from various protocols, including SPI, CAN, I2C, and so on. This trigger output can then be routed to other devices—normally it’s shown triggering an oscilloscope, but we can use it for fault injection or other tasks as we please.</p>
<p>On the lower-cost side, you’ll find some oscilloscopes offer a “trigger on serial data” feature, which may be a paid upgrade or available as part of various options you can enable on the oscilloscope in the field.</p>
<h2 id="h1-278748b01-0012">Decoding Serial Protocols: $50 to $8,000</h2>
<p class="BodyFirst">For UART serial I/O, you often need only a PC and serial cable. You can buy <em>USB-to-serial cables</em> that don’t include any level converters and directly interface to the TTL UART pins found in many embedded systems. Examples include cables based on the FTDI FT232R chip. You can use <em>GNU Screen</em> on Linux or <em>PuTTY</em> on Windows, or any number of other software applications to interface with the interconnection as if it were a terminal.</p>
<p>While the previous logic analysis section assumed you wanted to capture “raw” logic levels, that might not be needed. You might care only about the SPI data going across a bus, for example, which is an easier task to accomplish. This means you can use a device that implements the protocol you wish to sniff, and it will present only the “higher-level” data rather than specific bus transitions.</p>
<p><span epub:type="pagebreak" title="446" id="Page_446"/>One frequent method is actually to implement the protocol yourself on a microcontroller and then forward that data to a computer over a serial interface. Arduinos often are used for this exact task. One advantage is that you can also build trigger logic; rather than purchasing an expensive logic analyzer, you may be able to build the trigger logic off a low-cost Arduino or similar.</p>
<p>An open source tool designed to make this easier is the <em>GreatFET</em> by Great Scott Gadgets (see <a href="#figureA-19" id="figureanchorA-19">Figure A-19</a>). This tool has a microcontroller that exposes many of the usual interfaces you might need, such as SPI, I2C, and UART. In addition, it can run as a simple logic analyzer to capture the actual line-level transitions.</p>
<figure>
<img src="image_fi/278748b01/faa019.png" alt="faa019"/>
<figcaption><p><a id="figureA-19">Figure A-19</a>: A GreatFET One interface device, available from Great Scott Gadgets (image source: Great Scott Gadgets)</p></figcaption>
</figure>
<p>Whereas GreatFET relies on the microcontroller for the majority of decoding work, another open source tool called the <em>Glasgow Interface Explorer</em> (<a href="https://github.com/GlasgowEmbedded/" class="LinkURL">https://github.com/GlasgowEmbedded/</a>) has a small FPGA that is reconfigured to allow even more complex decoding actions. At the time of writing, Glasgow was just being released, but in theory, it allows almost perfectly timed trigger generation, so it could replace an expensive logic analyzer for the task of triggering based on protocol-level data. We wouldn’t normally mention tools without having used them, but this one has a unique feature set that will be an important addition to your toolset and is well worth exploring.</p>
<p><span epub:type="pagebreak" title="447" id="Page_447"/>Commercial tools offer protocol sniffers as well. Total Phase offers a simple I2C/SPI sniffer called the Beagle I2C/SPI sniffer. It comes with a GUI that simplifies monitoring of large I2C or SPI transactions, which can be useful when reverse-engineering a complex bus.</p>
<h2 id="h1-278748b01-0013">CAN Bus Sniffing and Triggering: $50 to $5,000</h2>
<p class="BodyFirst">The <em>Controller Area Network (CAN)</em> bus is used in a lot of automotive applications, and a number of low-cost and professional-grade solutions are available. Several tools can speak CAN, like the CANtact and CANbadger as well as Riscure’s Huracan. The latter was designed to be able to trigger external fault injection based on specific CAN traffic. Like many serial protocols, you might find basic triggering support available in a hardware logic analyzer or oscilloscope serial triggering module.</p>
<p>Linux also has CAN support. Via SocketCAN, you can use your favorite packet sniffer in Linux to look at CAN. But if you’d like more on CAN, check out Craig Smith’s <em>Car Hackers Handbook</em> (2016), published by No Starch Press and the OpenGarages website, for more CAN-related tools.</p>
<h2 id="h1-278748b01-0014">Ethernet Sniffing: $50</h2>
<p class="BodyFirst">You may consider <em>Ethernet sniffing </em>“not a hardware topic,” but it’s definitely relevant for embedded system analysis: that box may just be revealing all kinds of interesting information about itself over the wire.</p>
<p>Ethernet is probably the easiest high-speed interface to interact with, and no hardware hack is generally needed. Many small embedded devices have Ethernet ports, such as the Arduino controller with its Ethernet Shield, the Raspberry Pi, and many other sub-$10 devices. It’s just a matter of installing the right software, such as WireShark for sniffing, and then plugging in the Ethernet cable. If you’re trying to passively monitor Ethernet, it helps to use the <em>Throwing Star LAN Tap</em> from Great Scott Gadgets or an old-school network hub instead of a switch.</p>
<h2 id="h1-278748b01-0015">Interacting Through JTAG: $20 to $10,000</h2>
<p class="BodyFirst">JTAG can be nice for debugging and inspecting a device. As we discussed in Chapter 2, JTAG has two main uses: <em>boundary scan</em> and <em>debugging</em>. The tools for each use case vary slightly. Some tools can be used for both, but the software is normally different.</p>
<h3 id="h2-278748b01-0005">General JTAG and Boundary Scan</h3>
<p class="BodyFirst">Using JTAG requires you to “find” the JTAG port on a board. You may luck out if the target uses a standard pinout, but if not, the <em>JTAGulator</em> by Joe Grand can auto-detect JTAG pinouts. The JTAGulator is self-contained (it doesn’t rely on host computer software), so it tends to be very reliable and can also perform various boundary scan and debug tasks. It’s a slightly more <span epub:type="pagebreak" title="448" id="Page_448"/>niche tool than the general-purpose JTAG interface hardware, but the feature set is well designed for the more black-box work you end up doing when it comes to hardware hacking. It also supports various low-level boundary scan options, and even can work as a debug interface in some cases.</p>
<p>For pure boundary scan tooling (toggling pins or checking states), the <em>TopJTAG</em> software is one of the best options, and it has a reasonable license fee cost. Many other commercial software for boundary scan are thousands of dollars and don’t work as well as TopJTAG.</p>
<p>For open source boundary scan, the <em>Viveris JTAG Boundary Scanner</em> (<a href="https://github.com/viveris/jtag-boundary-scanner/" class="LinkURL">https://github.com/viveris/jtag-boundary-scanner/</a>) provides similar functionality, and open source Python bindings (<a href="https://github.com/colinoflynn/pyjtagbs/" class="LinkURL">https://github.com/colinoflynn/pyjtagbs/</a>), called <em>pyjtagbs</em> (where <em>bs</em> obviously stands for boundary scan), allow usage of the library from Python code.</p>
<p>These libraries require a hardware probe to interface to the device. The most commonly supported option (including both TopJTAG and others) is either a SEGGER J-Link or an FTDI FT2232H–based interface cable. The FTDI-based cables are not specific to any vendor, but one of the best options is Joe FitzPatrick’s <em>Tigard</em> board, which provides voltage translation with included voltage selection and breakout cables to make it easy to adapt to your target board.</p>
<h3 id="h2-278748b01-0006">JTAG Debug</h3>
<p class="BodyFirst"><em>Debugging</em> means interacting with the debug core on the device, which allows you to read out or reprogram the device, at minimum, but it also means you can view and modify internal memory and registers. This again requires software and hardware solutions. The software typically involves two parts: the software that interfaces to the hardware and the higher-level debug software you (the human) interact with.</p>
<p>For open source software, the <em>OpenOCD</em> project is the best-known option for the hardware interface portion, which supports a large number of hardware interfaces and target chips. Many of them use the FTDI FT2232H chip (for example, the Olimex ARM-USB-OCD-H, which you can purchase via Digi-Key/Mouser, and the Tigard board mentioned earlier).</p>
<p>Another good low-cost option is the <em>Black Magic Probe</em> by 1BitSquared. It’s an open source tool that supports many types of Arm Cortex-A or Cortex-M devices. Be sure to check the support list for your specific device. The Black Magic Probe doesn’t rely on OpenOCD but instead exposes the required interface for the higher-level debug tool.</p>
<p>Again, looking at open source options, the<em> GNU Debugger (GDB)</em> is the most likely higher-level interface software you will use, and it has a variety of GUIs built on top of it. The GDB software will interface to either OpenOCD or the Black Magic Probe.</p>
<p>Be aware the previous open-source tooling is mostly relevant to popular cores such as Arm devices (and RISC-V into the future). If you are looking at less popular devices, which are often found in automotive or industrial processors, you may have very limited (or no) open-source and low-cost options.</p>
<p><span epub:type="pagebreak" title="449" id="Page_449"/>On the commercial (higher cost) end of the spectrum, several choices are available that involve both hardware and software solutions, and in our experience, they are often well worth the money. Most of the time these will support new devices before they are even released for general use, and if you are using tools in a professional environment, this can easily save you money compared to the cost (in time) of finding that your target device doesn’t work with OpenOCD and you need to add support for it.</p>
<p>SEGGER makes the popular <em>J-Link</em> tool, which supports a huge number of Arm devices and is especially popular on Cortex-M series devices (some of the models support Cortex-A too). The SEGGER J-Link is available in several models. If you are a student, the SEGGER J-Link EDU is available at a much lower cost ($20) than any other professional tool. The different J-Link models also typically offer evaluation modes to allow you to sample certain features (such as the handy Ozone debugger offered with the company’s tools) that you wouldn’t otherwise be able to use. High-end SEGGER tools (such as J-Trace Pro) support very high-speed debug and trace interfaces.</p>
<p>Lauterbach also has a number of JTAG products that support high-speed tracing and debugging. The Lauterbach tools, such as the PowerDebug Pro and PowerDebug USB 3, support several device architectures, including Arm, PowerPC, Intel, AVR, ARC, and so on. While the Lauterbach tools may be more expensive than other offerings, the potential device support list is huge and means the single tool may be more cost-effective than multiple separate tools. The ability to work with different architectures and device types will be useful if you plan on straying from the more common Arm devices.</p>
<p>Other vendors provide tools that may be more suited to specific architectures as well. If you are using PowerPC devices that are common on some automotive ECUs, you may find that the PEmicro Multilink is a reasonable-cost offering ($200). In that case, the hardware interface tool also needs a separate software license for the debug, although you can freely use the GDB with an included GDB server interface for this debug tool.</p>
<h2 id="h1-278748b01-0016">PCIe Communication: $100 to $1,000</h2>
<p class="BodyFirst"><em>PCI Express (PCIe)</em> is seen in high-end embedded systems or PCs. PCIe FPGA boards are available from every vendor. With some HDL coding skills, these devices can be configured to log memory contents, poke at other hardware devices, or monitor and modify data in memory. They have a steep learning curve and generally are pricey, but Lattice periodically offers one of its PCIe-based ECP3 boards on sale.</p>
<p><em>PicoEVB</em> is a small FPGA-based platform that fits in a laptop using the M.2 standard (see <a href="#figureA-20" id="figureanchorA-20">Figure A-20</a>). It’s a relatively low-cost solution that works with modern laptops, and it has several examples for getting PCIe transactions working.</p>
<span epub:type="pagebreak" title="450" id="Page_450"/><figure>
<img src="image_fi/278748b01/faa020.png" alt="faa020"/>
<figcaption><p><a id="figureA-20">Figure A-20</a>: PicoEVB, an FPGA that fits in a laptop’s M.2 slot, can be used to explore PCIe.</p></figcaption>
</figure>
<p>Broadcom has a “USB 3.0 to PCIe” bridge chip, the USB3380. It can operate as a PCIe device connected to a system, but it’s configurable to pass traffic on to a USB host or initiate PCIe transactions on command from the USB host. The USB3880 reference boards are used for <em>SLOTSCREAMER</em>, an inexpensive, open source PCIe DMA attack board for dumping and modifying system memory via PCIe.</p>
<h2 id="h1-278748b01-0017">USB Sniffing: $100 to $6,000</h2>
<p class="BodyFirst">One common task for working with computer peripherals is to <em>sniff USB traffic</em>. Several commercial solutions are available, but one of our favorites is the Total Phase Beagle 480 (see <a href="#figureA-21" id="figureanchorA-21">Figure A-21</a>). This device sniffs USB 2.0 traffic (a more expensive version does USB 3.0 as well). While relatively expensive, the tool makes it easy to deal with the resulting USB data. As the USB protocol can be relatively complicated, you are paying more for the analysis software than for the physical hardware. Every USB device functions at least to some degree at USB 1.1 speeds; therefore, one trick is to insert an old USB 1.1 hub in between to make the device fall back to lower speeds.</p>
<p>When it comes to open source, several options are also available. If you need to manipulate USB traffic, the <em>FaceDancer</em> is a derivative of the GoodFET that allows you to emulate any arbitrary USB device in Python on a secondary system as well as perform USB man-in-the-middle attacks.</p>
<span epub:type="pagebreak" title="451" id="Page_451"/><figure>
<img src="image_fi/278748b01/faa021.png" alt="faa021"/>
<figcaption><p><a id="figureA-21">Figure A-21</a>: Total Phase Beagle USB sniffers have an easy-to-use GUI to make decoding protocols simple.</p></figcaption>
</figure>
<p>Colin has developed the <em>PhyWhisperer-USB</em>, which sniffs USB 2.0 traffic. The PhyWhisperer-USB lacks the nice GUI software and buffer to deal with bursty traffic that the Total Phase Beagle 480 has, as the PhyWhisperer-USB is designed first for triggering on USB data.</p>
<p>The latest in USB sniffing and hacking can be found in the <em>LUNA</em> project by Kate Temkin and is also available from Great Scott Gadgets. As of this book’s writing, the tool was in a late beta state, but it uses a unique architecture that allows it to be used for sniffing, interposing, and all sorts of USB tasks, like the triggering tasks described next. We mention this tool despite not having used it ourselves, because the architecture is unique and it deserves a serious mention. Colin has often said that if LUNA was available when he started developing the PhyWhisperer-USB, he would have rather just bought a LUNA board himself! The LUNA board offers the ability to perform a wide variety of USB tasks well beyond just sniffing.</p>
<h2 id="h1-278748b01-0018">USB Triggering: $250 to $6,000</h2>
<p class="BodyFirst">Besides just sniffing the USB data, you may also need to <em>trigger</em> on USB data. Triggering means that relative to the actual USB packet “going over the wire,” you need to generate a trigger signal. Several of the high-end USB sniffers can perform this task; for example, the Total Phase Beagle 480 has the capability to perform triggering based on USB packet data.</p>
<p>A lower-cost option is the PhyWhisperer-USB, which is open source hardware and is sold by NewAE Technology, Inc. (see <a href="#figureA-22" id="figureanchorA-22">Figure A-22</a>).</p>
<span epub:type="pagebreak" title="452" id="Page_452"/><figure>
<img src="image_fi/278748b01/faa022.png" alt="faa022"/>
<figcaption><p><a id="figureA-22">Figure A-22</a>: PhyWhisperer-USB is an open source hardware tool for USB triggering and analysis.</p></figcaption>
</figure>
<p>This tool is designed specifically for triggering on USB data packets, so it supports additional features, such as an ability to power-cycle the target and a Python 3 API to allow you to script the triggering mechanism. As previously mentioned, you may be able to perform some of these tasks with the LUNA project, so check the latest documentation for that project too.</p>
<h2 id="h1-278748b01-0019">USB Emulation: $100</h2>
<p class="BodyFirst">The previous tools concentrate on analyzing USB traffic but not modifying it. For modifications, the de facto tool is the open source <em>FaceDancer</em> project. While various hardware options are available, the GreatFET One (refer to <a href="#figureA-19">Figure A-19</a>) is widely available commercially and supports the majority of features. The LUNA can also be used for interposing and emulating USB devices, and the use of an FPGA allows more complex operations than can be done in a microcontroller.</p>
<h2 id="h1-278748b01-0020">SPI Flash Connections: $25 to $1,000</h2>
<p class="BodyFirst">Another common task is reading an <em>SPI flash memory chip</em>. Several options are available depending on what you need to accomplish. One commercial option is the SEGGER J-Link Plus (or any higher-end model in that series), which primarily serves as a robust debug adapter for Arm-based microcontrollers. If you are purchasing (or have) a J-Link for debug tasks, it serves as an excellent SPI Flash Programmer using the “J-Flash SPI” software.</p>
<p>You’ll also likely want an <em>SOIC clip adapter</em> to attach to the SPI flash memory. These are commonly available from the manufacturer Pomona as part number 5250 (lower-cost options are also available from no-name manufactures).</p>
<p>Several options exist for interfacing with SPI devices. The FTDI FT232H chip is a beefed-up version of the FTDI USB-serial adapter that supports SPI as well. DediProg makes the StarProg-A line of devices designed primarily <span epub:type="pagebreak" title="453" id="Page_453"/>for programming EEPROMs in circuit, and the Minipro TL866II universal programmer can also flash some SPI devices in place. The <em>Flashrom</em> tool supports programming via a built-in SPI, for instance, in a Raspberry Pi or BeagleBone Black<em>,</em> as well as external programmers that include the FT232H chip, such as the Tigard mentioned earlier. For a price-conscious but still fairly easy-to-use alternative, look at the FlashcatUSB.</p>
<p>To interface with SPI devices other than storage devices, your best bet is to use a <em>Bus Pirate</em> to communicate with the device interactively or a microcontroller that supports an SPI controller in hardware or software. In order to connect a reader and device physically, we recommend looking at <em>mini-grabber</em><em>s</em> and <em>SOIC clips</em>. The former are great for connecting to individual pins, whereas the clips allow you to connect to all pins of an SOIC package. More recently, you can find that Raspberry Pis make useful interface tools. They have the advantage of much faster speeds than the trusty Bus Pirate, which can take several minutes to dump a large SPI flash chip.</p>
<h2 id="h1-278748b01-0021">Power Analysis Measurements: $300 to $50,000</h2>
<p class="BodyFirst">We are finally getting to equipment specific to this book. But, didn’t we already cover oscilloscopes? Isn’t that sufficient for power analysis measurements? The reality is you might find different requirements for power analysis measurements compared to more general exploration of a circuit. In fact, you might even end up using one piece of equipment for general exploration and another for performing the power analysis work.</p>
<p>For performing power analysis of a device, we are typically concerned about very small changes or very small measurements. You may be measuring waveforms that have a few mV peak-to-peak waveforms, for example, which differs from your normal task of probing a 3.3 V logic level signal. Understanding this requires you to check your oscilloscope’s <em>input sensitivity</em> specification. It is typically referenced <em>per division</em>, which is a call back to a time when oscilloscopes had fixed grid sizes (divisions) on the display. Even though the division is now drawn on digitally, that specification is still used.</p>
<p>You’ll have to figure out how many divisions make a full input range; normally you’d find eight divisions vertically. Therefore, a scope with a 1 mV/div on the most sensitive range means 8 mV peak to peak. You would typically expect to find in the range of 10 to 100 mV peak-to-peak full scale at the most sensitive end (or ±5 to ±50 mV). Of course, you could be using an <em>amplifier</em> (or <em>active probe</em>) that provides a larger signal to the input of the oscilloscope.</p>
<p>Another critical feature for power analysis measurements is how the waveform is downloaded to a computer. While just exploring a device, you won’t care as much about that, but during power analysis, you’ll be performing statistical analysis across thousands to millions (or even billions) of power traces. Here, the PC-attached devices can be useful, as something like a PicoScope 6000 (see <a href="#figureA-23" id="figureanchorA-23">Figure A-23</a>) has a USB 3.0 interface for rapid download of huge traces. You can even get internal PCIe-based capture cards, such as Cobra Express CompuScope or AlazerTech products that can stream directly to internal computer memory.</p>
<span epub:type="pagebreak" title="454" id="Page_454"/><figure>
<img src="image_fi/278748b01/faa023.png" alt="faa023"/>
<figcaption><p><a id="figureA-23">Figure A-23</a>: PicoScope 6000 USB scope being used for power analysis. This model has four channels, 350 MHz bandwidth, 5 GS/s max sampling rate, and a 2 GS (giga sample) memory buffer.</p></figcaption>
</figure>
<p>If you are using a stand-alone scope, you’ll likely be using the network (Ethernet) interface. The majority of scopes support using this interface to download waveform data using a system called <em>VISA</em>. Unfortunately, it can be hard to know what the actual effective capture rate is using this method by studying only the datasheets. The higher-end models do tend to work well and allow rapid triggering and downloading, but lower-end devices may not always optimize this because the majority of scope users aren’t downloading data to a computer, so it’s not a highly optimized use case.</p>
<p>The final option to discuss for power analysis measurements is the <em>ChipWhisperer</em> capture hardware, which started as an open source project by Colin. The ChipWhisperer is slightly different from an oscilloscope because it <em>only</em> supports capturing small signals, as it contains a low-noise amplifier (LNA) in the frontend. The input sensitivity ranges from approximately 10 mV to 1 V, full scale, compared to a normal scope, which is somewhere in the range of 50 mV to 100 V. The ChipWhisperer capture hardware is also always <em>AC coupled</em>, which is to say it cannot measure a constant DC voltage. The work we’ll do with power analysis rarely needs this constant DC voltage, so by removing it at the front end, we can help simplify the capture hardware.</p>
<p>The ChipWhisperer hardware is available in several variants: the major ones are ChipWhisperer-Nano ($50), ChipWhisperer-Lite (starting at $250), and ChipWhisperer-Pro ($3,800) hardware. Additional feature updates include an architecture update starting with the ChipWhisperer-Husky, which adds more features to the ChipWhisperer-Lite. The ChipWhisperer-Lite was the original board released as part of a Kickstarter, and it included <span epub:type="pagebreak" title="455" id="Page_455"/>the target built onto the same board (see <a href="#figureA-24" id="figureanchorA-24">Figure A-24</a>). The idea of this board is you can cut away the target to add your own later, but the board is now available with connectors and external targets to make it easier to work with external targets, typically as part of a starter kit, such as the NAE-SCAPACK-L1 or NAE-SCAPACK-L2.</p>
<figure>
<img src="image_fi/278748b01/faa024.png" alt="faa024"/>
<figcaption><p><a id="figureA-24">Figure A-24</a>: The original ChipWhisperer-Lite includes capture hardware (left two-thirds of the board) and the target (right one-third of the board).</p></figcaption>
</figure>
<p>The other major difference with regular oscilloscopes is that the ChipWhisperer capture hardware uses a synchronous sampling method. <a href="#figureA-25" id="figureanchorA-25">Figure A-25</a> shows a regular oscilloscope setup, with an internal timebase that is used to decide when to sample. The time delay is effectively random between the clock edge of the device you are measuring and the oscilloscope sampling point, and it changes on every power trace. We can typically avoid this issue by sampling at a very fast rate; it’s not unusual with side-channel power analysis to capture at somewhere between 100 MS/s to 5 GS/s. The ChipWhisperer avoids this by instead synchronizing the sample points with the target device clock, which allows you to sample much more slowly but still achieve a highly successful attack. It <em>does</em> require access to a device clock to succeed, but in some cases, that’s something we do have access to. More secure devices (such as smart cards) will use internal oscillators that require clock extraction circuitry, but more basic microcontrollers will often use an external crystal we can latch onto.</p>
<p>This raises the question of how fast a sample rate we need for our attack to succeed. If we’re using synchronous sampling like the ChipWhisperer capture board does, the sample rate can be as low as 1× the device clock rate (that is, sampled at the device clock rate). If we’re using a regular oscilloscope, a typical rule of thumb would be to sample at 5× to 10× the device clock rate. Also make sure the bandwidths of the scope and the probes are at least as high as the sampling rate.</p>
<span epub:type="pagebreak" title="456" id="Page_456"/><figure>
<img src="image_fi/278748b01/faa025.png" alt="faa025"/>
<figcaption><p><a id="figureA-25">Figure A-25</a>: An asynchronous sample clock (as in a regular oscilloscope) causes some time jitter between the rising edge of the device sample clock (A, B, and C) and the next rising edge of the sample clock defining when the samples are taken.</p></figcaption>
</figure>
<p>We should add the disclaimer that the sample rate required will vary drastically with the algorithm attacked. For example, we can attack some slow algorithms even when sampling at 0.0001× the rate of the target device, as the algorithm itself is so slow that the leaked data does not require information on every clock cycle. Likewise, a hardware cryptographic implementation may leak information only at a small fraction of the clock cycle due to an unintended glitch, which means the 5× to 10× faster rate may be insufficient, and even the synchronous sampling would still need substantial oversampling to catch the glitch.</p>
<h2 id="h1-278748b01-0022">Triggering on Analog Waveforms: $3,800+</h2>
<p class="BodyFirst">Returning to the topic of <em>triggering</em>, triggering on an analog waveform is also useful. This means not just triggering on a rising or falling edge, but matching an exact pattern in the analog waveform. It’s often used inside channel analysis or fault injection to trigger right before some sensitive operation.</p>
<p>Some oscilloscopes offer this feature, although it’s relatively rare and is usually only available in higher-end scopes, so you may need to use external hardware to accomplish this goal. The Riscure icWaves has a variety of features and is designed specifically to perform this triggering function.</p>
<p>A simplified version of the pattern match is also built in to the ChipWhisperer-Pro, which allows for matching fewer sample points than the icWaves solutions. The ChipWhisperer-Pro can also serve as the power measurement platform, however, so it can be useful for performing multiple duties.</p>
<p>Both the Riscure icWaves and ChipWhisperer-Pro use a sum of absolute difference (SAD) to perform the matching logic. They store a copy of <span epub:type="pagebreak" title="457" id="Page_457"/>the last <em>N</em> points of the waveform in a buffer and compare the last <em>N</em> points to some desired match pattern. If those points are close enough (small enough difference), a trigger signal is generated.</p>
<h2 id="h1-278748b01-0023">Measuring Magnetic Fields: $25 to $10,000</h2>
<p class="BodyFirst">Another task you’ll find useful is measuring the strength of a <em>magnetic field</em> emitted from a device, which basically means that an <em>H-Field (magnetic field) probe</em> is required. The actual design of the probes is very basic—a simple loop antenna will pick up the magnetic field. The antenna is typically shielded to block the <em>E-field</em> (<em>electrical field</em>) as much as possible. <a href="#figureA-26" id="figureanchorA-26">Figure A-26</a> shows an example of several H-Field probes.</p>
<figure>
<img src="image_fi/278748b01/faa026.png" alt="faa026"/>
<figcaption><p><a id="figureA-26">Figure A-26</a>: H-Field probes from various manufacturers</p></figcaption>
</figure>
<p>When purchasing a probe, you have several options to consider:</p>
<p class="ListHead"><b>Package-size probes</b></p>
<p class="ListBody">Here we refer to <em>package-size probes</em> as those that are roughly capable of probing a single device, such as an IC or component. These larger magnetic field probes can be purchased as a <em>planar design</em>, which uses a PCB to reduce the cost. Examples of these include Beehive Electronics 101A probe set, TekBox TBPS01, and the ChipWhisperer NAE-HPROBE-15. The ChipWhisperer NAE-HPROBE-15 also has design information published, which requires having a four-layer PCB fabricated but lets you tweak the design if required for your specific application.</p>
<p class="ListBody">The downside of the planar design is the probe must be placed flat onto the chip, which may not be physically possible. Various other <span epub:type="pagebreak" title="458" id="Page_458"/>orientations have been made of these designs as well; the most well known is the Langer EMV RF1 kit, which includes several probes that are sensitive to various magnetic field directions.</p>
<p class="ListBody">Due to the Langer EMV RF1 kit’s popularity, several lower-cost clones are now available. The Rigol NFP-3 kit contains similar probes to the Langer EMV kit. An even lower-cost option is the EM5030 probe set made by Cybertek. The Cybertek probes have a slightly thicker insulation, which will negatively affect sensitivity since you cannot physically get the actual probe itself as close to the magnetic field source.</p>
<p class="ListBody">Some slightly smaller probes are also available, from Langer EMV and elsewhere. An example is the Morita Tech MT-545, which has a 1.6 mm diameter coil.</p>
<p class="ListHead"><b>Preamplifier</b></p>
<ol class="none">
<li>For all these sets (including the Langer EMV kit), you will need a <em>preamplifier</em> to provide reasonable signal level for your oscilloscope input. The vendors provide matching amplifiers for their sets, although little is vendor-specific to the amplifier itself. The various amplifier designs may have better or worse noise performance, but the design of a low noise amplifier is not a particularly difficult task. Besides the gain (typically 20 to 30 dB should be expected), the <em>noise figure (NF)</em> should be considered. The NF measures the degradation of the signal-to-noise ratio (SNR) between input to output, so a higher NF means the amplifier itself adds additional noise to the output. As an example, the Langer EMV PA 203 SMA amplifier specifies a gain of 20 dB and a noise figure of 4.5 dB.</li>
</ol>
<p class="ListBody">If you are connecting the output of the amplifier to your oscilloscope, you may wish to select an amplifier with a matching bandwidth. For example, the Langer EMV PA 203 SMA amplifier specifies a usable frequency range of 100 kHz to 3 GHz. If you are connecting this to a 200 MHz bandwidth oscilloscope, the 3 GHz amplifier will typically have worse noise performance than a smaller bandwidth amplifier.</p>
<p class="ListBody">One of the go-to companies for RF products is Mini-Circuits, which sells complete LNA devices such as the Mini-Circuits ZFL-1000LN+ (100 kHz to 1 GHz bandwidth, 20 dB gain, 2.9 dB NF) for about $100. You can reduce the bandwidth a bit with the ZFL-500LN+ (100 kHz to 500 MHz bandwidth, 24 dB gain, 2.9 dB NF), which has slightly higher gain. For the ultimate in a low-cost LNA, the BGA2801 can be used as a basis for a cheap LNA (100 kHz to 2.2 GHz, 22 dB gain, 4.3 dB NF). A sample design for an LNA based on the BGA2801 is available in the ChipWhisperer project (the NF of the complete amplifier will be worse than the NF of only the raw IC).</p>
<p class="ListHead"><b><span epub:type="pagebreak" title="459" id="Page_459"/>Chip-scale and smaller probes</b></p>
<ol class="none">
<li>While the previous probe tips were mostly for measuring an entire device, we are calling a chip-scale probe one that can be used to probe smaller portions of the IC surface. Some of these can be built using similar techniques, but just with smaller coils. This can be used to create coils in the 300µm (0.3mm) size, such as the Langer EMV RF3 mini kit.</li>
</ol>
<p class="ListBody">Even smaller tips are possible, such as the Langer EMV MFA 01 set that contains tips down to 100µm. A warning with such small tips: the tips must be very close to the measurement source, which in this case is the IC die. You will almost certainly need to decap or partially decap the IC being measured once you get to these very small probes.</p>
<p class="ListHead"><b>All in one</b></p>
<ol class="none">
<li>The smaller probe sizes also make it useful to consider integrating the amplifier even closer to the probe tip. The previously mentioned Langer EMV sets in the 100µm to 250µm range contain an integrated amplifier, but complete solutions that contain both the probe and the amplifier are also available in slightly larger sizes. Riscure sells the EM Probe, which is closely integrated with the amplifier for a bandwidth of 1 GHz. It is designed specifically for XY scanning over the chip surface.</li>
</ol>
<h2 id="h1-278748b01-0024">Clock Fault Injection: $100 to $30,000</h2>
<p class="BodyFirst"><em>Clock fault injection</em> requires generating complex clock waveforms. <a href="#figureA-27" id="figureanchorA-27">Figure A-27</a> shows a sample clock fault injection waveform. The most straightforward way of doing this at reasonable cost is using the clock fault injection built in to any of the FPGA-based ChipWhisperer platforms, such as the ChipWhisperer-Lite or ChipWhisperer-Pro (the ChipWhisperer-Nano does not have an FPGA, so it cannot do clock fault injection).</p>
<figure>
<img src="image_fi/278748b01/faa027.png" alt="faa027"/>
<figcaption><p><a id="figureA-27">Figure A-27</a>: Example of a clock glitch waveform, a 7.37 MHz clock with a narrow pulse inserted</p></figcaption>
</figure>
<p><span epub:type="pagebreak" title="460" id="Page_460"/>The Riscure VC Glitcher and Riscure Spider can also perform clock fault injection and have more complex circuitry to generate glitch waveforms at a resolution of 2ns. For lower-cost or DIY options, you will mostly be limited to implementing something in an FPGA board yourself. The implementation is out of scope for this book, but a low-cost FPGA board (such as the Digilent Arty) would be a good starting point. While you might consider using an arbitrary waveform generator (AWG), it can be difficult to generate the very fast digital waveform needed with an AWG. </p>
<h2 id="h1-278748b01-0025">Voltage Fault Injection: $25 to $30,000</h2>
<p class="BodyFirst"><em>Voltage fault injection</em> typically requires switching between two or more voltage sources in quick succession. Compared to clock fault injection, it is easier to build your own voltage fault injection system. The typical DIY solution is to use a multiplexor IC, such as the MAX4619, with two different voltages on each input. You can switch between the regular to glitch voltage to insert faults. See Chapter 6, or check out Chris Gerlinsky’s presentation “Breaking Code Read Protection on the NXP LPC-Family Microcontrollers” (REcon Brussels, 2017).</p>
<p>The ChipWhisperer hardware platforms currently use a simple crowbar mechanism to generate voltage glitch waveforms (see <a href="#figureA-28" id="figureanchorA-28">Figure A-28</a>). The ChipWhisperer-Lite/Pro best support this mechanism, but it also works with the ChipWhisperer-Nano in a more limited fashion.</p>
<figure>
<img src="image_fi/278748b01/faa028.png" alt="faa028"/>
<figcaption><p><a id="figureA-28">Figure A-28</a>: Example of a VCC glitch waveform</p></figcaption>
</figure>
<p>For a more complete solution, the Riscure VC Glitcher and Riscure Spider can perform the voltage glitch generation (as well as clock glitch generation), and each has a more complex triggering circuitry compared to the ChipWhisperer platform. These devices allows for generation of a flexible analog waveform, compared to the more limited ChipWhisperer crowbar method.</p>
<p>Voltage fault injection can also be done with a fast function generator. These generators are available at a reasonable cost, such as the Siglent SDG6022X ($1,500). You will need an amplifier to drive anything with it, which is available as a DIY solution using a high-current op-amp, or from <span epub:type="pagebreak" title="461" id="Page_461"/>Riscure (Glitch Amplifier or Glitch Amplifier 2), or NewAE Technology (ChipJabber). See “Shaping the Glitch: Optimizing Voltage Fault Injection Attacks” by Claudio Bozzato, Riccardo Focardi, and Francesco Palmarini for an example of the DIY solution being used on real devices. As you might already have a function generator available to you, building a DIY amplifier may be a relatively low-cost solution for your existing lab.</p>
<h2 id="h1-278748b01-0026">Electromagnetic Fault Injection: $100 to $50,000</h2>
<p class="BodyFirst"><em>Electromagnetic fault injection (EMFI)</em><em> </em>is a powerful method of performing fault injection. EMFI roughly requires switching a high voltage onto a small inductor to generate a powerful magnetic field. Several purpose-built solutions currently are on the market in addition to DIY open source solutions.</p>
<p>For purpose-built equipment, Riscure’s EM-FI Transient Probe tool is the original and most widely used tool for performing EMFI. The device comes with injection tips of various sizes and polarities. NewAE Technology introduced the ChipSHOUTER EMFI tool, which also comes with various tips, along with several sample target boards. The Riscure EMFI tool and ChipSHOUTER are both designed for relatively fast repetition, as might be required for inserting multiple glitches into a system.</p>
<p>Another purpose-built tool is the SGZ 21 burst generator (available in the E1 set) with the S2 set H-Field injector tips from Langer EMV. This tool is designed for immunity testing instead of security analysis, so fewer details about its usage for fault injection testing are currently available.</p>
<p>Morita Tech also makes both E-Field and H-Field injection probes (part number MT-676, with versions MT-676E and MT-676H, respectively, giving E- and H-Field injections). These products are made in Japan and appear to be easier to order domestically in Japan.</p>
<p>Besides solutions offered specifically for EMFI, Avtech Electrosystems, Ltd., offers a variety of pulse generators that can be used for EMFI. They require you to adapt the output to the specific EMFI coil, which requires validation that the pulse generator can drive an inductive load without any modifications.</p>
<p>Low-cost and DIY solutions are also available. A project called <em>BadFET</em> by Red Balloon Security is available, but it has the substantial downside of using a relatively dangerous (but easier to build) method of switching the high voltage onto the exposed injection coil. See Chapter 5 for a discussion of architectures related to EMFI tooling.</p>
<h2 id="h1-278748b01-0027">Optical Fault Injection: $1,000 to $250,000</h2>
<p class="BodyFirst"><em>Optical fault injection</em> typically means the use of a laser to position a specific spot onto the IC die. A lower-cost option is using a flash tube along with a lens, as described in “Low-Cost Setup for Localized Semi-invasive Optical Fault Injection Attacks,” by Oscar M. Guillen, Michael Gruber, and Fabrizio De Santis.</p>
<p><span epub:type="pagebreak" title="462" id="Page_462"/>For precise optical fault injection, a light (laser) <em>source</em>, an <em>XY positioning stage</em>, and a laser-optimized <em>microscope</em> setup are needed. For the light sources, a <em>backside attack</em> requires an IR (1064nm) laser, and <em>frontside attacks</em> require shorter wavelengths (880nm, 532nm, or shorter).</p>
<p>Several additions will make your life easier. An <em>additional Z stage</em> can help with automated focusing of the laser beam, and an <em>IR-sensitive camera</em> can allow you to position the beam from a PC. Similarly, an <em>IR light source</em> will allow you to see metal layers even through silicon, which helps positioning for backside attacks. Finally, some certifications require having a <em>dual-laser system</em> capable of delivering a laser pulse on two different areas of the die in one fault injection run. Riscure offers the Laser Station 2, which includes that feature and the aforementioned additions. Alphanov laser solutions also provide laser fault injection hardware, which can be integrated in Riscure laser systems or driven by eShard’s fault injection scripts in esDynamic.</p>
<h2 id="h1-278748b01-0028">Positioning Probes: $100 to $50,000</h2>
<p class="BodyFirst">For H-Field probes, EMFI, and laser systems, precise <em>positioning</em> may be required over the target. That is typically done using an XY or XYZ table, which is sold for microscope purposes. A variety of XY(Z) tables can be found from suppliers such as Thorlabs, including both manual and electronic tables. Riscure offers the EM Probe Station and Laser Station, which both include stages. Other XY(Z) table suppliers can easily be found by searching for “microscope positioning stages.”</p>
<p>To match with the ChipSHOUTER, NewAE offers the ChipShover XYZ table and controller. It’s based on open source firmware and can be used for positioning EM probes or other tools in addition to the ChipSHOUTER.</p>
<p>Low-cost versions of manual positioning stages are also available, such as those sold by AmScope (GT200 table) or an overseas supply company (AliExpress).</p>
<p>A low-cost option for an XYZ table is to use a 3D printer stage. A 3D printer typically has sufficient accuracy for most of the work you will need to do with both H-Field probes (electromagnetic analysis) and EMFI (injection). Many 3D printers have 1 to 20µm step resolution, for example, which allows a relatively large amount of steps over the chip surface or target. For example, stepping over a 4×4mm chip die with 10µm step resolution means the 3D printer would have 400 steps in each X and Y direction. The ChipShover tool mentioned earlier is based on 3D printer firmware and provides an open source API you can use with most standard printers that simply process <em>G-code</em>, for example. G-code is a language specific for 3D printers.</p>
<p>The important specifications to look for are the <em>step size</em> or <em>resolution</em> of the table, as well as the <em>repetition error</em>, usually expressed in µm. The former terms refer to the smallest step size the table can make, and the latter refers to the maximum expected error if you move from any point A to any point B. You can imagine this error is important for repeatability of faults.</p>
<h2 id="h1-278748b01-0029"><span epub:type="pagebreak" title="463" id="Page_463"/>Target Devices: $10 to $10,000</h2>
<p class="BodyFirst">During your research and development phase, you will need <em>target devices</em>. While you may have a specific target in mind to attack, starting with something you fully control is more reasonable. The most obvious target would be a development board for the device of interest. For example, if you are interested in an automotive device, such as a PowerPC MPC5777C (found in some ECUs), you could attempt to perform exploration on the actual ECU, but that will be difficult since you may not know anything about the schematic, program running, and so on. Instead, finding a development board for this part and working out your attack on it first would be better. Once you’ve explored the device itself, you can better understand how it works on the specific board. This advice applies even if you’re evaluating your own product, since your product may still make the evaluation more complicated than it would be on a stand-alone board.</p>
<p>On the lower-end, you can use something like an Arduino to run code and then modify it to perform power analysis and fault injection. Targets specifically designed for this analysis work do exist. One of the earliest commercially available targets was the <em>SASEBO Project</em> started by Akashi Satoh, which has now turned into the <em>SAKURA Project</em>. When looking up the SAKURA boards, don’t confuse them with the Renesas Electronics Sakura boards, which were released much later and use the same name.</p>
<p>Due to various licensing changes, the SAKURA boards can occasionally be difficult to find; see the SAKURA home page for information. They are currently available from TROCHE. <a href="#figureA-29" id="figureanchorA-29">Figure A-29</a> shows a SAKURA-G board. Most SAKURA boards target FPGAs, which allow you to implement algorithms in programmable hardware. The SAKURA boards have a range of FPGA sizes, including some very large FPGAs for complex algorithms.</p>
<figure>
<img src="image_fi/278748b01/faa029.png" alt="faa029"/>
<figcaption><p><a id="figureA-29">Figure A-29</a>: SAKURA-G is part of a range of useful FPGA-based target systems.</p></figcaption>
</figure>
<p><span epub:type="pagebreak" title="464" id="Page_464"/>The most widely available target boards are part of the ChipWhisperer project. Most of these targets are made available in the CW308 UFO Board,a base board onto which many targets can be fit. <a href="#figureA-30" id="figureanchorA-30">Figure A-30</a> shows a sample baseboard with target.</p>
<figure>
<img src="image_fi/278748b01/faa030.png" alt="faa030"/>
<figcaption><p><a id="figureA-30">Figure A-30</a>: The ChipWhisperer UFO (CW308) has a variety of open source top modules you can use for testing various devices and algorithms.</p></figcaption>
</figure>
<p>This target system allows swapping of various test processors. Test devices for 8-bit XMEGA, 32-bit Arm, FPGA, PowerPC, and more are readily available. In addition, the schematic and full design files for the target portions are available at <a href="https://github.com/newaetech/chipwhisperer-target-cw308t/" class="LinkURL">https://github.com/newaetech/chipwhisperer-target-cw308t/</a> if you need to modify the designs or want to build your own target boards. </p>
<p>Besides the SAKURA boards for FPGA targets, the ChipWhisperer project also has the CW305 FPGA target, which has an Artix 7A100 FPGA target on which to implement your cryptographic algorithms (see <a href="#figureA-31" id="figureanchorA-31">Figure A-31</a>).</p>
<p>Riscure offers various smart cards as well as an embedded target called <em>Piñata</em> with its tools. These targets allow running more advanced algorithms and tests suited to the Riscure toolchain, including multiple faults and laser fault injection. </p>
<span epub:type="pagebreak" title="465" id="Page_465"/><figure>
<img src="image_fi/278748b01/faa031.png" alt="faa031"/>
<figcaption><p><a id="figureA-31">Figure A-31</a>: The ChipWhisperer CW305 has an Artix A35/A100 FPGA target and allows you to implement algorithms in hardware.</p></figcaption>
</figure>
</section>
</body></html>