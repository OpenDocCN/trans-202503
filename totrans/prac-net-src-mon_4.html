<html><head></head><body>
<p class="calibre1">Now we visit the PuTTY download website, shown in Figure 12-3, and </p>
<p class="calibre1">download  <i class="calibre4">putty.exe</i> via HTTP and then FTP. </p>
<p class="calibre1"> <i class="calibre4">Figure 12-3: PuTTY website download</i></p>
<p class="calibre1">Once the download is finished, stop each Tcpdump instance by press-</p>
<p class="calibre1">ing ctrl-C, and then use Capinfos to look at the metadata for each trace, </p>
<p class="calibre1">as shown in Listing 12-6. </p>
<p class="calibre1">$ <b class="calibre3">capinfos putty-http.pcap putty-ftp.pcap</b></p>
<p class="calibre1">File name:           putty-http.pcap</p>
<p class="calibre1">File type:           Wireshark/tcpdump/... - libpcap</p>
<p class="calibre1">File encapsulation:  Ethernet</p>
<p class="calibre1">Packet size limit:   file hdr: 65535 bytes</p>
<p class="calibre1">Number of packets:   509</p>
<p class="calibre1">File size:           521880 bytes</p>
<p class="calibre1">Data size:           513712 bytes</p>
<p class="calibre1"> <i class="calibre4">-- snip --</i></p>
<p class="calibre1"><b class="calibre3">268</b>   Chapter 12</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p303"/>File name:           putty-ftp.pcap</p>
<p class="calibre1">File type:           Wireshark/tcpdump/... - libpcap</p>
<p class="calibre1">File encapsulation:  Ethernet</p>
<p class="calibre1">Packet size limit:   file hdr: 65535 bytes</p>
<p class="calibre1">Number of packets:   558</p>
<p class="calibre1">File size:           525649 bytes</p>
<p class="calibre1">Data size:           516697 bytes</p>
<p class="calibre1"> <i class="calibre4">-- snip --</i></p>
<p class="calibre1"> <i class="calibre4">Listing 12-6: Capinfos output for the HTTP and FTP traces</i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Testing Bro to Extract Binaries from HTTP Traffic</b></i></p>
<p class="calibre1">With the test traffic data ready, let’s run Bro against each trace to see what </p>
<p class="calibre1">logs it creates. Listing 12-7 runs Bro against the  <i class="calibre4">putty-http.pcap</i> file u and tells Bro to reference our modified  <i class="calibre4">local.bro</i> file v. (Notice that I run these commands in a directory called  <i class="calibre4">bro-http</i> to separate the output from the second test for FTP.)</p>
<p class="calibre1">$ sudo bro -r putty-http.pcapu /opt/bro/share/bro/site/local.brov</p>
<p class="calibre1">WARNING: No Site::local_nets have been defined.  It's usually a good idea to </p>
<p class="calibre1">define your local networks. </p>
<p class="calibre1">WARNING: Template value remaining in BPFConf filename: /etc/nsm/{{hostname}}-</p>
<p class="calibre1">{{interface}}/bpf-bro.conf (/opt/bro/share/bro/securityonion/./bpfconf.bro, </p>
<p class="calibre1">line 99)</p>
<p class="calibre1"> <i class="calibre4">Listing 12-7: Running Bro against the saved HTTP traffic</i></p>
<p class="calibre1">We can now see which logs Bro generated. First, we’ll look at the contents </p>
<p class="calibre1">of the current working directory, as shown in Listing 12-8. </p>
<p class="calibre1">$ <b class="calibre3">ls -al</b></p>
<p class="calibre1">total 560</p>
<p class="calibre1">drwxrwxr-x  3 sov  sov    4096 Apr 17 19:33 . </p>
<p class="calibre1">drwxr-xr-x 29 sov  sov    4096 Apr 17 19:32 .. </p>
<p class="calibre1">-rw-r--r--  1 root root    280 Apr 17 19:33 capture_loss.log</p>
<p class="calibre1">-rw-r--r--  1 root root    763 Apr 17 19:33 conn.log</p>
<p class="calibre1">-rw-r--r--  1 root root   1376 Apr 17 19:33 http.logu</p>
<p class="calibre1">-rw-r--r--  1 root root   7888 Apr 17 19:33 loaded_scripts.log</p>
<p class="calibre1">-rw-r--r--  1 root root    938 Apr 17 19:33 notice.log</p>
<p class="calibre1">-rw-r--r--  1 root root   1128 Apr 17 19:33 notice_policy.log</p>
<p class="calibre1">-rw-r--r--  1 root root    251 Apr 17 19:33 packet_filter.log</p>
<p class="calibre1">-rw-r--r--  1 root root 521880 Apr 17 17:53 putty-http.pcap</p>
<p class="calibre1">-rw-r--r--  1 root root    951 Apr 17 19:33 reporter.log</p>
<p class="calibre1">drwx------  3 root root   4096 Apr 17 19:33 .state</p>
<p class="calibre1"> <i class="calibre4">Listing 12-8: Logs created by running Bro against the saved HTTP traffic</i></p>
<p class="calibre1">Now let’s examine the  <i class="calibre4">http.log</i> file u in more detail with the cat and </p>
<p class="calibre1">bro-cut commands in tandem, as shown in Listing 12-9. The -d flags </p>
<p class="calibre1">tells bro-cut to display a human-readable timestamp, and -C tells it to pre-</p>
<p class="calibre1">serve the file headers to show the fields that are present. </p>
<p class="calibre1">Extending SO   <b class="calibre3">269</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p304"/>$ <b class="calibre3">cat http.log | bro-cut -d -C</b></p>
<p class="calibre1">#separator \x09</p>
<p class="calibre1">#set_separator  , </p>
<p class="calibre1">#empty_field    (empty)</p>
<p class="calibre1">#unset_field    -</p>
<p class="calibre1">#path   http</p>
<p class="calibre1">#open   2013-04-17-19-33-23</p>
<p class="calibre1">#fields ts      uid     id.orig_h       id.orig_p       id.resp_h       id.resp_p       trans_</p>
<p class="calibre1">depth     method  host    uri     referrer        user_agent      request_body_len        </p>
<p class="calibre1">response_body_len       status_code     status_msg  info_code        info_msg        filename tags    username        password        proxied mime_type       md5     extraction_file</p>
<p class="calibre1">#types  string  string  addr    port    addr    port    count   string  string  string  string string  count   count   count   string  count   string  string  table[enum]     string  string table[string]   string  string  file</p>
<p class="calibre1">2013-04-17T17:53:28+0000u         cSb1GfCIIL9w     192.168.2.108   53999   46.43.34.31     </p>
<p class="calibre1">80      1       GET     the.earth.li    /~sgtatham/putty/latest/x86/putty.exez   http://</p>
<p class="calibre1">www.chiark.greenend.org.uk/~sgtatham/putty/download.html Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.31 (KHTML, like Gecko) Chrome/26.0.1410.64 Safari/537.31 0       300     302y Found   -       -       -       (empty) -       -       -       text/html       -       -</p>
<p class="calibre1">2013-04-17T17:53:28+0000v         cSb1GfCIIL9x    192.168.2.108   53999   46.43.34.31     </p>
<p class="calibre1">80      2       GET     the.earth.li    /~sgtatham/putty/0.62/x86/putty.exe{     http://</p>
<p class="calibre1">www.chiark.greenend.org.uk/~sgtatham/putty/download.html Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.31 (KHTML, like Gecko) Chrome/26.0.1410.64 Safari/537.31 0       483328  </p>
<p class="calibre1">200|     OK      -       -       -       (empty) -       -       -       application/</p>
<p class="calibre1">x-dosexec   a3ccfd0aa0b17fd23aa9fd0d84b86c05~     /nsm/bro/extracted/http/http-</p>
<p class="calibre1">item_192.168.2.108:53999-46.43.34.31:80_resp_2.dat}</p>
<p class="calibre1">#close  2013-04-17-19-33-23</p>
<p class="calibre1"> <i class="calibre4">Listing 12-9: Bro ht p.log for HTTP transfer</i></p>
<p class="calibre1">The two log entries u and v show traffic over a single web connec-</p>
<p class="calibre1">tion, because Bro assigned the same tracking ID w and x to both records. </p>
<p class="calibre1">In the first record u, the web server replies with a 302 code y that directed </p>
<p class="calibre1">the download from  <i class="calibre4">/~sgtatham/putty/latest/x86/putty.exe</i> z to  <i class="calibre4">/~sgtatham/</i></p>
<p class="calibre1"> <i class="calibre4">putty/0.62/x86/putty.exe</i> {. In the second record v, the web server replies with a 200 code | showing that it has the requested file. Finally, the second record </p>
<p class="calibre1">shows that Bro extracted  <i class="calibre4">putty.exe</i> to a specific directory and file,  <i class="calibre4">/nsm/bro/</i></p>
<p class="calibre1"> <i class="calibre4">extracted/http/http-item_192.168.2.108:53999-46.43.34.31:80_resp_2.dat</i> }. We </p>
<p class="calibre1">also have an MD5 hash for the file, a3ccfd0aa0b17fd23aa9fd0d84b86c05 ~. </p>
<p class="calibre1">Bro is processing this HTTP traffic as we expected. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Examining the Binary Extracted from HTTP</b></i></p>
<p class="calibre1">Now that we have indicators that Bro extracted a file from the HTTP traffic, </p>
<p class="calibre1">we can examine it on disk. Listing 12-10 shows the results of that analysis. </p>
<p class="calibre1"><b class="calibre3">270</b>   Chapter 12</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p305"/><img src="index-305_1.png" alt="Image 149" class="calibre2"/></p>
<p class="calibre1">$ <b class="calibre3">ls -al /nsm/bro/extracted/http/http-item_192.168.2.108:53999-46.43.34.31:80_</b></p>
<p class="calibre1"><b class="calibre3">resp_2.dat</b></p>
<p class="calibre1">-rw-r--r-- 1 root root 483328u Apr 17 19:33 /nsm/bro/extracted/http/http-</p>
<p class="calibre1">item_192.168.2.108:53999-46.43.34.31:80_resp_2.dat</p>
<p class="calibre1">$ <b class="calibre3">file /nsm/bro/extracted/http/http-item_192.168.2.108:53999-46.43.34.31:80_</b></p>
<p class="calibre1"><b class="calibre3">resp_2.dat</b></p>
<p class="calibre1">/nsm/bro/extracted/http/http-item_192.168.2.108:53999-46.43.34.31:80_resp_2. </p>
<p class="calibre1">dat: PE32 executable (GUI) Intel 80386, for MS Windowsv</p>
<p class="calibre1">$ <b class="calibre3">md5sum /nsm/bro/extracted/http/http-item_192.168.2.108:53999-46.43.34.31:80_</b></p>
<p class="calibre1"><b class="calibre3">resp_2.dat</b></p>
<p class="calibre1">a3ccfd0aa0b17fd23aa9fd0d84b86c05w  /nsm/bro/extracted/http/http-</p>
<p class="calibre1">item_192.168.2.108:53999-46.43.34.31:80_resp_2.dat</p>
<p class="calibre1"> <i class="calibre4">Listing 12-10: Examining the binary extracted from HTTP traffic</i></p>
<p class="calibre1">Here, we see that the extracted file is 483,328 bytes u, with file </p>
<p class="calibre1">type PE32 executable (GUI) Intel 80386, for MS Windows v and a hash </p>
<p class="calibre1">(a3ccfd0aa0b17fd23aa9fd0d84b86c05 w) that matches the values Bro </p>
<p class="calibre1">reported in Listing 12-9. </p>
<p class="calibre1">To confirm that the hash matches the values of the binary downloaded </p>
<p class="calibre1">to the Windows system, we look at the file properties, as shown in Figure 12-4. </p>
<p class="calibre1">I used HashTab by Implbits ( <i class="calibre4">http://www.implbits.com/hashtab.aspx</i>) to gener-</p>
<p class="calibre1">ate these hashes in the File Hashes tab of the Properties dialog. </p>
<p class="calibre1"> <i class="calibre4">Figure 12-4: File properties of </i> putty .exe <i class="calibre4"> showing the  </i></p>
<p class="calibre1"> <i class="calibre4">same MD5 hash</i></p>
<p class="calibre1">Extending SO   <b class="calibre3">271</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p306"/> <i class="calibre4"><b class="calibre3">Testing Bro to Extract Binaries from FTP Traffic</b></i></p>
<p class="calibre1">As with our HTTP test, we can run Bro against the FTP example to see the </p>
<p class="calibre1">logs it creates. Listing 12-11 demonstrates running Bro against  <i class="calibre4">putty-ftp.pcap</i> u and telling Bro to again reference our modified  <i class="calibre4">local.bro</i> v file. (Notice that I run these commands in a directory called  <i class="calibre4">bro-ftp</i> to keep the output separate from the HTTP test results.)</p>
<p class="calibre1">$ sudo bro -r putty-ftp.pcapu /opt/bro/share/bro/site/local.brov</p>
<p class="calibre1">WARNING: No Site::local_nets have been defined.  It's usually a good idea to </p>
<p class="calibre1">define your local networks. </p>
<p class="calibre1">WARNING: Template value remaining in BPFConf filename: /etc/nsm/{{hostname}}-</p>
<p class="calibre1">{{interface}}/bpf-bro.conf (/opt/bro/share/bro/securityonion/./bpfconf.bro, </p>
<p class="calibre1">line 99)</p>
<p class="calibre1"> <i class="calibre4">Listing 12-11: Running Bro against the saved HTTP traffic</i></p>
<p class="calibre1">We can now see which logs Bro generated. First, we examine the con-</p>
<p class="calibre1">tents of the current working directory, as shown in Listing 12-12. </p>
<p class="calibre1">$ <b class="calibre3">ls -al</b></p>
<p class="calibre1">total 560</p>
<p class="calibre1">drwxrwxr-x  3 sov  sov    4096 Apr 17 20:30 . </p>
<p class="calibre1">drwxr-xr-x 29 sov  sov    4096 Apr 17 20:30 .. </p>
<p class="calibre1">-rw-r--r--  1 root root    281 Apr 17 20:30 capture_loss.log</p>
<p class="calibre1">-rw-r--r--  1 root root   1531 Apr 17 20:30 conn.log</p>
<p class="calibre1">-rw-r--r--  1 root root    731 Apr 17 20:30 ftp.logu</p>
<p class="calibre1">-rw-r--r--  1 root root   7888 Apr 17 20:30 loaded_scripts.log</p>
<p class="calibre1">-rw-r--r--  1 root root   1128 Apr 17 20:30 notice_policy.log</p>
<p class="calibre1">-rw-r--r--  1 root root    251 Apr 17 20:30 packet_filter.log</p>
<p class="calibre1">-rw-r--r--  1 root root 525649 Apr 17 18:07 putty-ftp.pcap</p>
<p class="calibre1">-rw-r--r--  1 root root    951 Apr 17 20:30 reporter.log</p>
<p class="calibre1">drwx------  3 root root   4096 Apr 17 20:30 .state</p>
<p class="calibre1"> <i class="calibre4">Listing 12-12: Logs created by running Bro against the saved FTP traffic</i></p>
<p class="calibre1">Let’s look at the  <i class="calibre4">ftp.log</i> u. Listing 12-13 shows the results of using the cat and bro-cut commands in tandem. </p>
<p class="calibre1">$ <b class="calibre3">cat ftp.log | bro-cut -d -C</b></p>
<p class="calibre1">#separator \x09</p>
<p class="calibre1">#set_separator  , </p>
<p class="calibre1">#empty_field    (empty)</p>
<p class="calibre1">#unset_field    -</p>
<p class="calibre1">#path   ftp</p>
<p class="calibre1">#open   2013-04-17-20-30-56</p>
<p class="calibre1">#fields ts      uid     id.orig_h       id.orig_p       id.resp_h       id.resp_p       user password        command arg     mime_type       mime_desc       file_size       reply_code reply_msg       tags    extraction_file</p>
<p class="calibre1"><b class="calibre3">272</b>   Chapter 12</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p307"/>#types  string  string  addr    port    addr    port    string  string  string  string  string string  count   count   string  table[string]   file</p>
<p class="calibre1">2013-04-17T18:06:59+0000u        3JGazzdNGmev     192.168.2.108   54104   212.13.197.229  </p>
<p class="calibre1">21      anonymousw       chrome@example.comx      RETR    ftp://212.13.197.229/users/</p>
<p class="calibre1">sgtatham/putty-latest/x86/putty.exey  application/x-dosexec   MS-DOS executable, MZ for MS-DOSz     86      226     Transfer complete{      -       /nsm/bro/extracted/ftp/ftp-file_192.168.2.108:54106-212.13.197.229:38177_1.dat|</p>
<p class="calibre1">#close  2013-04-17-20-30-56</p>
<p class="calibre1"> <i class="calibre4">Listing 12-13: Bro </i> ftp .log <i class="calibre4"> for FTP transfer</i></p>
<p class="calibre1">This one log entry at u tracks a single FTP session, because Bro </p>
<p class="calibre1">assigns one tracking ID v to the session. Here, we see the artifacts of </p>
<p class="calibre1">downloading a binary via Google Chrome. The username supplied is </p>
<p class="calibre1">anonymous w, and the password is chrome@example.com x. We see that the </p>
<p class="calibre1">file retrieved,  <i class="calibre4">putty-latest/x86/putty.exe</i> y, is of type MS-DOS executable, MZ </p>
<p class="calibre1">for MS-DOS z. We also see that the transfer completed successfully { and </p>
<p class="calibre1">that Bro extracted the binary that it observed:  <i class="calibre4">/nsm/bro/extracted/ftp/ </i></p>
<p class="calibre1"> <i class="calibre4">ftp-file_192.168.2.108:54106-212.13.197.229:38177_1.dat</i> |. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Examining the Binary Extracted from FTP</b></i></p>
<p class="calibre1">Now that we have indicators that Bro extracted a file from the FTP traffic, </p>
<p class="calibre1">we can examine it on disk. Listing 12-14 shows the results of that analysis. </p>
<p class="calibre1">In this example, we’ll only confirm that the MD5 hash matches what we </p>
<p class="calibre1">saw earlier. </p>
<p class="calibre1">$ <b class="calibre3">md5sum /nsm/bro/extracted/ftp/ftp-file_192.168.2.108:54106-212.13.197.229:38177_1.dat</b> a3ccfd0aa0b17fd23aa9fd0d84b86c05u  /nsm/bro/extracted/ftp/ftp-file_192.168.2.108:54106-212.13.197.229:38177_1.dat</p>
<p class="calibre1"> <i class="calibre4">Listing 12-14: Examining the binary extracted from FTP traffic</i></p>
<p class="calibre1">Notice that the MD5 hash u matches the values listed in the HTTP </p>
<p class="calibre1">examples, Listing 12-10 and Figure 12-4. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Submitting a Hash and Binary to VirusTotal</b></i></p>
<p class="calibre1">Now that we have both the hash of a binary and the binary itself (recov-</p>
<p class="calibre1">ered from network traffic), we can submit them to VirusTotal for analysis. </p>
<p class="calibre1">Whereas in Figure 12-1 we submitted only a hash of a binary for analysis, in </p>
<p class="calibre1">this section, we’ll submit the hash and then the binary in order to compare </p>
<p class="calibre1">the results. In Figure 12-5, we submit the hash. </p>
<p class="calibre1">Figure 12-6 shows what VirusTotal knows about this hash. </p>
<p class="calibre1">The results of this analysis are a little mixed, with two antivirus engines </p>
<p class="calibre1">(in the Detection Ratio field) reporting the file associated with this hash as </p>
<p class="calibre1">malicious! We know this file is legitimate, however, because we downloaded </p>
<p class="calibre1">it from the publisher’s website. If we’re still suspicious, we could use the </p>
<p class="calibre1">cryptographic signatures published on the PuTTY download page to verify </p>
<p class="calibre1">Extending SO   <b class="calibre3">273</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p308"/><img src="index-308_1.png" alt="Image 150" class="calibre2"/></p>
<p class="calibre1"><img src="index-308_2.png" alt="Image 151" class="calibre2"/></p>
<p class="calibre1">that the file we downloaded is the file posted on the website, but that would </p>
<p class="calibre1">only confirm that someone with access to the private key posted a binary </p>
<p class="calibre1">signed by that key. (Trust only goes so far in the digital world.)</p>
<p class="calibre1"> <i class="calibre4">Figure 12-5: Submitting the </i> putty .exe <i class="calibre4"> hash to VirusTotal</i></p>
<p class="calibre1"> <i class="calibre4">Figure 12-6: VirusTotal results for the submit ed MD5 hash</i></p>
<p class="calibre1">VirusTotal publishes other information along with antivirus results, </p>
<p class="calibre1">such as the output of running Mark Russinovich’s Sigcheck ( <i class="calibre4">http://technet </i></p>
<p class="calibre1"> <i class="calibre4">.microsoft.com/en-us/sysinternals/bb897441.aspx</i>), which checks to confirm </p>
<p class="calibre1">that a file is digitally signed, as shown in Listing 12-15. </p>
<p class="calibre1">Sigcheck</p>
<p class="calibre1">publisher................: Simon Tatham</p>
<p class="calibre1">product..................: PuTTY suite</p>
<p class="calibre1">internal name............: PuTTY</p>
<p class="calibre1">copyright................: Copyright (c) 1997-2011 Simon Tatham. </p>
<p class="calibre1">original name............: PuTTY</p>
<p class="calibre1">file version.............: Release 0.62</p>
<p class="calibre1">description..............: SSH, Telnet and Rlogin client</p>
<p class="calibre1"> <i class="calibre4">Listing 12-15: VirusTotal reports Sigcheck results. </i></p>
<p class="calibre1">Sigcheck’s results appear to confirm that the hash we submitted matches </p>
<p class="calibre1">a PuTTY binary uploaded by previous VirusTotal users. </p>
<p class="calibre1">We can also upload the binary Bro extracted for us, as shown in </p>
<p class="calibre1">Figure 12-7. </p>
<p class="calibre1"><b class="calibre3">274</b>   Chapter 12</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p309"/><img src="index-309_1.png" alt="Image 152" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 12-7: Submit ing the binary extracted from HTTP traffic</i></p>
<p class="calibre1">VirusTotal knows about this binary, and it should: it’s the binary Bro </p>
<p class="calibre1">extracted, and we just saw that the hash for it was already known to VirusTotal. </p>
<p class="calibre1">This general approach shows a powerful way to extend Bro to extract </p>
<p class="calibre1">Windows binaries from HTTP and FTP traffic. However, the current instance </p>
<p class="calibre1">of Bro is running with the previous configuration files in memory. Unless </p>
<p class="calibre1">we restart Bro, it won’t know to apply the new  <i class="calibre4">local.bro</i> configuration file to the running configuration. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Restarting Bro</b></i></p>
<p class="calibre1">Until you restart Bro, or reboot the SO system, Bro will continue running </p>
<p class="calibre1">with the original  <i class="calibre4">local.bro</i> script loaded. In order to benefit from Bro’s ability to extract Windows executables from network traffic, we need to have </p>
<p class="calibre1">Bro reread its  <i class="calibre4">local.bro</i> script. To tell Bro to process the script, use the broctl interface, as shown in Listing 12-16. </p>
<p class="calibre1">$ <b class="calibre3">sudo broctl</b>u</p>
<p class="calibre1">Welcome to BroControl 1.1</p>
<p class="calibre1">Type "help" for help. </p>
<p class="calibre1">[BroControl] &gt; <b class="calibre3">check</b>v</p>
<p class="calibre1">manager is ok. </p>
<p class="calibre1">proxy is ok. </p>
<p class="calibre1">sov-eth0-1 is ok. </p>
<p class="calibre1">[BroControl] &gt; <b class="calibre3">install</b>w</p>
<p class="calibre1">removing old policies in /nsm/bro/spool/installed-scripts-do-not-touch/site ... done. </p>
<p class="calibre1">removing old policies in /nsm/bro/spool/installed-scripts-do-not-touch/auto ... done. </p>
<p class="calibre1">creating policy directories ... done. </p>
<p class="calibre1">installing site policies ... done. </p>
<p class="calibre1">generating cluster-layout.bro ... done. </p>
<p class="calibre1">generating local-networks.bro ... done. </p>
<p class="calibre1">Extending SO   <b class="calibre3">275</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p310"/>generating broctl-config.bro ... done. </p>
<p class="calibre1">updating nodes ... done. </p>
<p class="calibre1">[BroControl] &gt; <b class="calibre3">restart</b>x</p>
<p class="calibre1">stopping ... </p>
<p class="calibre1">stopping sov-eth0-1 ... </p>
<p class="calibre1">stopping proxy ... </p>
<p class="calibre1">stopping manager ... </p>
<p class="calibre1">starting ... </p>
<p class="calibre1">starting manager ... </p>
<p class="calibre1">starting proxy ... </p>
<p class="calibre1">starting sov-eth0-1 ... </p>
<p class="calibre1">. </p>
<p class="calibre1">[BroControl] &gt; <b class="calibre3">exit</b>y</p>
<p class="calibre1"> <i class="calibre4">Listing 12-16: Reconfiguring Bro using broctl</i></p>
<p class="calibre1">In Listing 12-16, broctl is started u from a terminal that launches the </p>
<p class="calibre1">broctl interface and accepts commands. Next, we run the check command v </p>
<p class="calibre1">to determine if the configuration files Bro reads are formatted properly. If so, </p>
<p class="calibre1">Bro reports the status as ok, and we install them w. Next, we restart Bro x, </p>
<p class="calibre1">and after seeing the components restart, we exit the broctl interface y. </p>
<p class="calibre1">The last step is to confirm Bro’s status using the NSM scripts shipped </p>
<p class="calibre1">with SO, as shown in Listing 12-17. (You could do the same thing with the </p>
<p class="calibre1">sudo broctl status command.)</p>
<p class="calibre1">$ <b class="calibre3">sudo nsm_sensor_ps-status --only-bro</b></p>
<p class="calibre1">Status: Bro</p>
<p class="calibre1">Name       Type       Host       Status        Pid    Peers  Started            </p>
<p class="calibre1">manager    manager    192.168.2.102 running       19555  2      18 Apr 00:29:37 </p>
<p class="calibre1">proxy      proxy      192.168.2.102 running       19603  2      18 Apr 00:29:40 </p>
<p class="calibre1">sov-eth0-1 worker     192.168.2.102 running       19647  2      18 Apr 00:29:42 </p>
<p class="calibre1">Status: sov-eth0</p>
<p class="calibre1"> <i class="calibre4">Listing 12-17: Confirming Bro status using NSM scripts</i></p>
<p class="calibre1">According to the output of the nsm_sensor_ps-status --only-bro command, </p>
<p class="calibre1">Bro is running properly with the new configuration. </p>
<p class="calibre1">To test the live configuration, we’ll download another executable and </p>
<p class="calibre1">watch for entries in the Bro logs. Listing 12-18 shows commands to test </p>
<p class="calibre1">the new functionality on a production SO sensor configured to extract </p>
<p class="calibre1">Windows executables. </p>
<p class="calibre1">$ <b class="calibre3">wget http://www.etree.org/cgi-bin/counter.cgi/software/md5sum.exe</b>u</p>
<p class="calibre1">--2013-04-18 00:44:06--  http://www.etree.org/cgi-bin/counter.cgi/software/md5sum.exe Resolving www.etree.org (www.etree.org)... 152.19.134.46</p>
<p class="calibre1">Connecting to www.etree.org (www.etree.org)|152.19.134.46|:80... connected. </p>
<p class="calibre1">HTTP request sent, awaiting response... 200 OK</p>
<p class="calibre1">Length: 49152 (48K) [application/octet-stream]</p>
<p class="calibre1">Saving to: `md5sum.exe' </p>
<p class="calibre1"><b class="calibre3">276</b>   Chapter 12</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p311"/>100%[======================================&gt;] 49,152      --.-K/s   in 0.1s 2013-04-18 00:44:07 (398 KB/s) - `md5sum.exe' saved [49152/49152]</p>
<p class="calibre1">$ <b class="calibre3">grep md5sum.exe /nsm/bro/logs/current/*</b>v</p>
<p class="calibre1">/nsm/bro/logs/current/http_eth0.log:1366245846.879854   8AwBGe9EpX      192.168.2.102   55409   </p>
<p class="calibre1">152.19.134.46   80      1       GET     www.etree.org   /cgi-bin/counter.cgi/software/md5sum. </p>
<p class="calibre1">exew        -       Wget/1.13.4 (linux-gnu) 0      49152    200     OK      -       -       -   </p>
<p class="calibre1">(empty) -       -       -      application/x-dosexecx    eb574b236133e60c989c6f472f07827by        </p>
<p class="calibre1">/nsm/bro/extracted/http/http-item_192.168.2.102:55409-152.19.134.46:80_resp_1.datz</p>
<p class="calibre1">/nsm/bro/logs/current/notice.log:1366245847.087877      8AwBGe9EpX      192.168.2.102   </p>
<p class="calibre1">55409   152.19.134.46   80      tcp     HTTP::MD5       192.168.2.102 </p>
<p class="calibre1">eb574b236133e60c989c6f472f07827b{ http://www.etree.org/cgi-bin/counter.cgi/software/md5sum. </p>
<p class="calibre1">exe|     eb574b236133e60c989c6f472f07827b        192.168.2.102   152.19.134.46   80      -       </p>
<p class="calibre1">sov-eth0-1      Notice::ACTION_LOG      6       3600.000000     F       -       -       -       </p>
<p class="calibre1">-       -       -       -       -</p>
<p class="calibre1"> <i class="calibre4">Listing 12-18: Testing the new file extraction capability</i></p>
<p class="calibre1">Listing 12-18 shows two commands to validate Windows executable </p>
<p class="calibre1">extraction on a production sensor. First, we download a Windows executable </p>
<p class="calibre1">called  <i class="calibre4">md5sum.exe</i> using the wget tool u. Once the download is complete, we </p>
<p class="calibre1">use grep to look for instances of the string md5sum in the current Bro logs v. </p>
<p class="calibre1">There are two results:</p>
<p class="calibre1">•  The first, from  <i class="calibre4">http.log</i>, shows the download of the file w, file type x, </p>
<p class="calibre1">MD5 hash y, and path to the extracted binary z. </p>
<p class="calibre1">•  The second, from  <i class="calibre4">notice.log</i>, reproduces many of the same elements from </p>
<p class="calibre1">earlier examples, like the MD5 hash { and URL for the binary |. </p>
<p class="calibre1">The presence of these logs indicates that Bro is extracting Windows </p>
<p class="calibre1">executables from HTTP traffic, thanks to our configuration changes and </p>
<p class="calibre1">application restart. </p>
<p class="calibre1"><b class="calibre3">using aPT1 intelligence</b></p>
<p class="calibre1">In February 2013, Mandiant released a report on a Chinese military unit </p>
<p class="calibre1">known as Advanced Persistent Threat 1 (APT1). Within China, APT1 is the </p>
<p class="calibre1">Second Bureau of the Third Department of the General Staff Directorate </p>
<p class="calibre1">of the People’s Liberation Army. Also known by its Military Unit Cover </p>
<p class="calibre1">Designator, 61398, this Army team targets English-speaking companies and </p>
<p class="calibre1">steals trade secrets, intellectual property, and other sensitive information. </p>
<p class="calibre1">In its report, Mandiant released 3000 IOCs (discussed in Chapter 9), </p>
<p class="calibre1">including domain names, IP addresses, X.509 encryption certificates, and </p>
<p class="calibre1">MD5 hashes of malware used by APT1. Mandiant also published video of </p>
<p class="calibre1">Extending SO   <b class="calibre3">277</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p312"/>the intruders interacting with victim Western computers to send phishing email, establish command-and-control channels, and exfiltrate data. </p>
<p class="calibre1">Although Mandiant published intelligence in OpenIOC ( <i class="calibre4">http://www </i></p>
<p class="calibre1"> <i class="calibre4">.openioc.org/</i>) format, it was not immediately clear how network defenders </p>
<p class="calibre1">and NSM analysts could apply those indicators to their network. Within two </p>
<p class="calibre1">days of the report’s arrival, Seth Hall from the Bro project published one </p>
<p class="calibre1">answer: a new Bro module called APT1, incorporating Mandiant’s APT1 </p>
<p class="calibre1">intelligence ( <i class="calibre4">https://github.com/sethhall/bro-apt1/</i>). Network defenders running NSM shops using SO now had an easy way to search for APT1 indicators on </p>
<p class="calibre1">the network. </p>
<p class="calibre1"><b class="calibre3">Proof-of-coNcePT vS. ProDucTioN</b></p>
<p class="calibre1">Seth Hall wrote the APT1 Bro module as a proof-of-concept in the interest of </p>
<p class="calibre1">publishing something quickly for the benefit of the community . However, SO </p>
<p class="calibre1">users should be aware of several aspects of this module when using it in pro-</p>
<p class="calibre1">duction . (Seth would be the first to warn you of all these issues, but I include </p>
<p class="calibre1">them here for clarity!)</p>
<p class="calibre1">As writ en, the module identifies the use of APT1 domains in DNS traffic, but </p>
<p class="calibre1">it does not detect APT1 domains in the Host element of HTTP headers (such as </p>
<p class="calibre1">Host: advanbusiness.com) or proxy-style URIs (such as  <i class="calibre4">GET ht p://advanbusiness </i></p>
<p class="calibre1"> <i class="calibre4">.com/some/file</i>) . Also, the module doesn’t look for activity involving subdomains (such as  <i class="calibre4">subdomain.advanbusiness.com</i>) . </p>
<p class="calibre1">In addition to using the features in the APT1 Bro module, you could also </p>
<p class="calibre1">look for interesting domains in other traffic, such as SMTP, or other content . As </p>
<p class="calibre1">of this writing, the module doesn’t include those functions, but you can use the </p>
<p class="calibre1">Bro network programming language to write scripts to meet those needs . Seth </p>
<p class="calibre1">reminds users that Bro is constantly evolving, and his module will likely change </p>
<p class="calibre1">as Bro incorporates new features . </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Using the APT1 Module</b></i></p>
<p class="calibre1">So far, we’ve explored how Bro works with SO to create a variety of use-</p>
<p class="calibre1">ful logs, and we’ve modified  <i class="calibre4">local.bro</i> to enable the extraction of Windows </p>
<p class="calibre1">executables from HTTP and FTP traffic. Now we will extend Bro by adding </p>
<p class="calibre1">a new module to its configuration. </p>
<p class="calibre1">Seth’s APT1 module consists of three policy scripts:</p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">data.bro</b></i>  This script contains a list of the domain names, MD5 hashes, and elements of the X.509 certificates Mandiant provided, formatted </p>
<p class="calibre1">for consumption by Bro. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">main.bro</b></i>  This script tells Bro’s notice framework to watch for matches against elements in  <i class="calibre4">data.bro</i>. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">load__.bro</b></i>  This script tells Bro to load  <i class="calibre4">data.bro</i> and  <i class="calibre4">main.bro</i>. </p>
<p class="calibre1"><b class="calibre3">278</b>   Chapter 12</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p313"/>The module also includes a file called  <i class="calibre4">README.rst</i>, which contains instructions on how to install the script, discusses new notices generated </p>
<p class="calibre1">by Bro, and offers related information. </p>
<p class="calibre1">The IOCs in  <i class="calibre4">data.bro</i> are formatted as shown in Listing 12-19. </p>
<p class="calibre1">umodule APT1; </p>
<p class="calibre1">vconst x509_serials_and_subjects: set[string, string] = {</p>
<p class="calibre1">["01", "C=US, ST=Some-State, O=www.virtuallythere.com, OU=new, CN=new"], </p>
<p class="calibre1">["0122", "C=US, ST=Some-State, O=Internet Widgits Pty Ltd, CN=IBM"], </p>
<p class="calibre1"> <i class="calibre4">-- snip --</i></p>
<p class="calibre1">}; </p>
<p class="calibre1">wconst domains: set[string] = {</p>
<p class="calibre1">"advanbusiness.com", </p>
<p class="calibre1">"aoldaily.com", </p>
<p class="calibre1">"aolon1ine.com", </p>
<p class="calibre1">"applesoftupdate.com", </p>
<p class="calibre1"> <i class="calibre4">-- snip --</i></p>
<p class="calibre1">}; </p>
<p class="calibre1">xconst file_md5s: set[string] = {</p>
<p class="calibre1">"001dd76872d80801692ff942308c64e6", </p>
<p class="calibre1">"002325a0a67fded0381b5648d7fe9b8e", </p>
<p class="calibre1">"00dbb9e1c09dbdafb360f3163ba5a3de", </p>
<p class="calibre1"> <i class="calibre4">-- snip --</i></p>
<p class="calibre1">}; </p>
<p class="calibre1"> <i class="calibre4">Listing 12-19: Excerpt from APT1 </i> data .bro</p>
<p class="calibre1">The  <i class="calibre4">data.bro</i> file contains four main parts:</p>
<p class="calibre1">•  Part u declares that this is the APT1 module. </p>
<p class="calibre1">•  Part v includes X509 encryption certificate details recognized by Bro </p>
<p class="calibre1">and used by APT1. </p>
<p class="calibre1">•  Part w contains a list of malicious domains associated with APT1 activity. </p>
<p class="calibre1">•  Part x features a list of MD5 hashes of malware used by APT1. </p>
<p class="calibre1">As you can see, it’s very easy to add IOCs to this file or a copy, in order </p>
<p class="calibre1">to detect different activities. The  <i class="calibre4">main.bro</i> file generates alert data in the Bro  <i class="calibre4">notice.log</i> file, as shown in Listing 12-20. </p>
<p class="calibre1">APT1::Domain_Hit</p>
<p class="calibre1">APT1::Certificate_Hit</p>
<p class="calibre1">APT1::File_MD5_Hit</p>
<p class="calibre1"> <i class="calibre4">Listing 12-20: Alert data generated by the APT1 module</i></p>
<p class="calibre1">We’ll see one of these alerts in a live example when we test the APT1 </p>
<p class="calibre1">module, but first we need to get that module and install it. </p>
<p class="calibre1">Extending SO   <b class="calibre3">279</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p314"/> <i class="calibre4"><b class="calibre3">Instal ing the APT1 Module</b></i></p>
<p class="calibre1">We can test the APT1 module using techniques like the ones we tried when </p>
<p class="calibre1">enabling binary extraction from HTTP and FTP traffic. Listing 12-21 shows </p>
<p class="calibre1">this process in action. </p>
<p class="calibre1">$ <b class="calibre3">sudo apt-get install git</b>u</p>
<p class="calibre1">--  <i class="calibre4">snip </i>--</p>
<p class="calibre1">$ <b class="calibre3">cd /opt/bro/share/bro/site/</b></p>
<p class="calibre1">$ <b class="calibre3">sudo git clone git://github.com/sethhall/bro-apt1.git apt1</b>v</p>
<p class="calibre1">Cloning into 'apt1'... </p>
<p class="calibre1">remote: Counting objects: 12, done. </p>
<p class="calibre1">remote: Compressing objects: 100% (10/10), done. </p>
<p class="calibre1">remote: Total 12 (delta 2), reused 11 (delta 1)</p>
<p class="calibre1">Receiving objects: 100% (12/12), 32.82 KiB, done. </p>
<p class="calibre1">Resolving deltas: 100% (2/2), done. </p>
<p class="calibre1">$ <b class="calibre3">ls</b></p>
<p class="calibre1">apt1       local.bro.orig     local-proxy.bro</p>
<p class="calibre1">local.bro  local-manager.bro  local-worker.bro</p>
<p class="calibre1">$ <b class="calibre3">cd apt1</b></p>
<p class="calibre1">$ <b class="calibre3">ls</b></p>
<p class="calibre1">data.bro  __load__.bro  main.bro  README.rst</p>
<p class="calibre1"> <i class="calibre4">Listing 12-21: Instal ing Git and obtaining the APT1 module</i></p>
<p class="calibre1">To acquire the APT1 module, first install the Git version control soft-</p>
<p class="calibre1">ware u, and then clone the Git repository of Seth Hall’s APT module v. </p>
<p class="calibre1">Once the APT1 module has been downloaded into the  <i class="calibre4">/opt/bro/share/</i></p>
<p class="calibre1"> <i class="calibre4">bro/site/</i> directory, tell Bro about it by adding the following line to the bottom of  <i class="calibre4">local.bro</i>:</p>
<p class="calibre1">@load apt1</p>
<p class="calibre1">With  <i class="calibre4">local.bro</i> modified, we’re almost ready to test the APT1 module, but </p>
<p class="calibre1">we still need to take one more step. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Generating Traffic to Test the APT1 Module</b></i></p>
<p class="calibre1">To test the APT1 module, we launch a terminal on our sensor and tell </p>
<p class="calibre1">Tcpdump to capture traffic. We apply a BPF to focus on traffic to and from </p>
<p class="calibre1">port 53 that involves our test system 192.168.2.102. Tcpdump will save what </p>
<p class="calibre1">it sees to a trace file called  <i class="calibre4">port53.pcap</i>. </p>
<p class="calibre1">$ <b class="calibre3">sudo tcpdump -n -i eth0 -s 0 -w port53.pcap port 53 and host 192.168.2.102</b></p>
<p class="calibre1"><b class="calibre3">280</b>   Chapter 12</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p315"/>In a second terminal, query for one of the domains listed in the APT1 </p>
<p class="calibre1"> <i class="calibre4">data.bro</i> policy script  <i class="calibre4">advanbusiness.com</i>, as shown in Listing 12-22. </p>
<p class="calibre1">$ <b class="calibre3">host advanbusiness.com</b>u</p>
<p class="calibre1">advanbusiness.com has address 50.63.202.91v</p>
<p class="calibre1">advanbusiness.com mail is handled by 0 smtp.secureserver.net. </p>
<p class="calibre1">advanbusiness.com mail is handled by 10 mailstore1.secureserver.net. </p>
<p class="calibre1"> <i class="calibre4">Listing 12-22: Performing a DNS query for </i> advanbusiness .com</p>
<p class="calibre1">Next, we use the Linux utility host to query for  <i class="calibre4">advanbusiness.com</i> u, and </p>
<p class="calibre1">see that the result is the IP address 50.63.202.91 v. </p>
<p class="calibre1">Returning to Tcpdump, we stop the capture with ctrl-C and review the </p>
<p class="calibre1">results, as shown in Listing 12-23. </p>
<p class="calibre1">$ <b class="calibre3">tcpdump -n -r port53.pcap</b> </p>
<p class="calibre1">reading from file port53.pcap, link-type EN10MB (Ethernet)</p>
<p class="calibre1">14:30:15.622379 IP 192.168.2.102.57097 &gt; 172.16.2.1.53: 57373+ A? advanbusiness.com.u (35) 14:30:15.762833 IP 172.16.2.1.53 &gt; 192.168.2.102.57097: 57373 1/0/0 A 50.63.202.91v (51) 14:30:15.765342 IP 192.168.2.102.58378 &gt; 172.16.2.1.53: 42025+ AAAA? advanbusiness.com. (35) 14:30:15.870230 IP 172.16.2.1.53 &gt; 192.168.2.102.58378: 42025 0/1/0 (103)</p>
<p class="calibre1">14:30:15.872373 IP 192.168.2.102.42336 &gt; 172.16.2.1.53: 29779+ MX? advanbusiness.com. (35) 14:30:15.989506 IP 172.16.2.1.53 &gt; 192.168.2.102.42336: 29779 2/0/2 MX smtp.secureserver.net. </p>
<p class="calibre1">0, MX mailstore1.secureserver.net. 10 (131)</p>
<p class="calibre1"> <i class="calibre4">Listing 12-23: DNS query for </i> advanbusiness .com</p>
<p class="calibre1">Listing 12-23 shows the query for  <i class="calibre4">advanbusiness.com</i> u, followed by the </p>
<p class="calibre1">result: IP address 50.63.202.91 v. With this traffic, we can now test the </p>
<p class="calibre1">APT1 module. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Testing the APT1 Module</b></i></p>
<p class="calibre1">To test the APT1 module, we run Bro against the trace file we just captured. </p>
<p class="calibre1">Listing 12-24 shows the result. </p>
<p class="calibre1">$ sudo bro -r port53.pcapu /opt/bro/share/bro/site/local.brov</p>
<p class="calibre1">WARNING: No Site::local_nets have been defined. It's usually a good idea to </p>
<p class="calibre1">define your local networks. </p>
<p class="calibre1">WARNING: Template value remaining in BPFConf filename: /etc/nsm/{{hostname}}-</p>
<p class="calibre1">{{interface}}/bpf-bro.conf (/opt/bro/share/bro/securityonion/./bpfconf.bro, </p>
<p class="calibre1">line 99)</p>
<p class="calibre1"> <i class="calibre4">Listing 12-24: Running Bro against the saved DNS traffic</i></p>
<p class="calibre1">Listing 12-24 shows Bro reading a network trace u, while the pres-</p>
<p class="calibre1">ence of the  <i class="calibre4">local.bro</i> v file in the command line tells Bro to read that file </p>
<p class="calibre1">for additional configuration information. We can now see which logs Bro </p>
<p class="calibre1">generated. </p>
<p class="calibre1">Extending SO   <b class="calibre3">281</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p316"/>First, we examine the contents of the current working directory, as </p>
<p class="calibre1">shown in Listing 12-25. </p>
<p class="calibre1">$ <b class="calibre3">ls -al</b></p>
<p class="calibre1">total 52</p>
<p class="calibre1">drwxrwxr-x  3 soe  soe  4096 Apr 18 14:52 . </p>
<p class="calibre1">drwxr-xr-x 33 soe  soe  4096 Apr 18 14:52 .. </p>
<p class="calibre1">-rw-r--r--  1 root root  278 Apr 18 14:52 capture_loss.log</p>
<p class="calibre1">-rw-r--r--  1 root root  865 Apr 18 14:52 conn.log</p>
<p class="calibre1">-rw-r--r--  1 root root  932 Apr 18 14:52 dns.log</p>
<p class="calibre1">-rw-r--r--  1 root root 8020 Apr 18 14:52 loaded_scripts.log</p>
<p class="calibre1">-rw-r--r--  1 root root  864 Apr 18 14:52 notice.logu</p>
<p class="calibre1">-rw-r--r--  1 root root 1128 Apr 18 14:52 notice_policy.log</p>
<p class="calibre1">-rw-r--r--  1 root root  251 Apr 18 14:52 packet_filter.log</p>
<p class="calibre1">-rw-rw-r--  1 soe  soe   762 Apr 18 14:52 port53.pcap</p>
<p class="calibre1">-rw-r--r--  1 root root  951 Apr 18 14:52 reporter.log</p>
<p class="calibre1">drwx------  3 root root 4096 Apr 18 14:52 .state</p>
<p class="calibre1"> <i class="calibre4">Listing 12-25: Logs created by running Bro against the saved HTTP traffic</i></p>
<p class="calibre1">Listing 12-25 shows a variety of files created when Bro processed the net-</p>
<p class="calibre1">work trace. Let’s look at the  <i class="calibre4">notice.log</i> u to see if the APT1 module detected the DNS query we made for the reportedly malicious  <i class="calibre4">advanbusiness .com</i> </p>
<p class="calibre1">domain. Listing 12-26 shows the output. </p>
<p class="calibre1">$ <b class="calibre3">cat notice.log | bro-cut -C -d</b></p>
<p class="calibre1">#separator \x09</p>
<p class="calibre1">#set_separator  , </p>
<p class="calibre1">#empty_field    (empty)</p>
<p class="calibre1">#unset_field    -</p>
<p class="calibre1">#path   notice</p>
<p class="calibre1">#open   2013-04-18-14-52-57</p>
<p class="calibre1">#fields ts      uid     id.orig_h       id.orig_p       id.resp_h       id.resp_p       proto note      msg     sub     src     dst     p       n       peer_descr      actions policy_items suppress_for      dropped remote_location.country_code    remote_location.region  remote_</p>
<p class="calibre1">location.city      remote_location.latitude        remote_location.longitude       metric_</p>
<p class="calibre1">index.host       metric_index.str  metric_index.network</p>
<p class="calibre1">#types  string  string  addr    port    addr    port    enum    enum    string  string addr    addr      port    count   string  table[enum]     table[count]    interval        bool string  string    string  double  double  addr    string  subnet</p>
<p class="calibre1">2013-04-18T14:30:15+0000        IVCYGEfpRya     192.168.2.102   57097   172.16.2.1      53      </p>
<p class="calibre1">udp       APT1::Domain_Hitu       A domain from the APT1 report seen: advanbusiness.comv   </p>
<p class="calibre1">-       192.168.2.102     172.16.2.1      53      -       bro     Notice::ACTION_LOG      6       </p>
<p class="calibre1">3600.000000       F       -       -       -       -       -       -       -       -</p>
<p class="calibre1">#close  2013-04-18-14-52-57</p>
<p class="calibre1"> <i class="calibre4">Listing 12-26: Contents of the Bro </i> notice .log <i class="calibre4"> file</i></p>
<p class="calibre1"><b class="calibre3">282</b>   Chapter 12</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p317"/>Listing 12-26 shows Bro reporting an APT::Domain_hit alert u, followed by information about the domain seen,  <i class="calibre4">advanbusiness.com</i> v. Our test was </p>
<p class="calibre1">successful, but this was only a test. To make Bro run the new configuration, </p>
<p class="calibre1">we need to restart Bro, as shown in Listing 12-27. </p>
<p class="calibre1">$ <b class="calibre3">sudo broctl install &amp;&amp; sudo broctl restart</b></p>
<p class="calibre1">removing old policies in /nsm/bro/spool/installed-scripts-do-not-touch/site ... done. </p>
<p class="calibre1">removing old policies in /nsm/bro/spool/installed-scripts-do-not-touch/auto ... done. </p>
<p class="calibre1">creating policy directories ... done. </p>
<p class="calibre1">installing site policies ... done. </p>
<p class="calibre1">generating cluster-layout.bro ... done. </p>
<p class="calibre1">generating local-networks.bro ... done. </p>
<p class="calibre1">generating broctl-config.bro ... done. </p>
<p class="calibre1">updating nodes ... done. </p>
<p class="calibre1">stopping ... </p>
<p class="calibre1">stopping soe-eth0-1 ... </p>
<p class="calibre1">stopping proxy ... </p>
<p class="calibre1">stopping manager ... </p>
<p class="calibre1">starting ... </p>
<p class="calibre1">starting manager ... </p>
<p class="calibre1">starting proxy ... </p>
<p class="calibre1">starting soe-eth0-1 ... </p>
<p class="calibre1"> <i class="calibre4">Listing 12-27: Restarting Bro from the command line</i></p>
<p class="calibre1">Remember to check Bro’s status using the <b class="calibre3">sudo nsm_sensor_ps-status </b></p>
<p class="calibre1"><b class="calibre3">--only-bro</b> command as well. </p>
<p class="calibre1"><b class="calibre3">reporting downloads of Malicious binaries</b></p>
<p class="calibre1">As you learned earlier, Bro can calculate MD5 hashes of Windows executa-</p>
<p class="calibre1">bles downloaded over HTTP. In this section, we’ll examine how SO and Bro </p>
<p class="calibre1">integrate with a third-party malware hash registry to warn analysts when </p>
<p class="calibre1">users download malicious software using a database offered by the Team </p>
<p class="calibre1">Cymru organization. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Using the Team Cymru Malware Hash Registry</b></i></p>
<p class="calibre1">Team Cymru, formally known as  <i class="calibre4">Team Cymru Research NFP</i>, describes itself </p>
<p class="calibre1">as “a specialized Internet security research firm and 501(c)3 non-profit </p>
<p class="calibre1">dedicated to making the Internet more secure” ( <i class="calibre4">http://www.team-cymru. </i></p>
<p class="calibre1"> <i class="calibre4">org/About/</i>). We can use their free Malware Hash Registry (MHR, at  <i class="calibre4">http://</i></p>
<p class="calibre1"> <i class="calibre4">www.team-cymru.org/Services/MHR/</i>) to match MD5 hashes against known </p>
<p class="calibre1">malware. </p>
<p class="calibre1">Most analysts query the MHR via DNS. Listing 12-28 shows how to use </p>
<p class="calibre1">the Linux dig command to run DNS TXT record queries for a malware hash </p>
<p class="calibre1">against MHR. </p>
<p class="calibre1">Extending SO   <b class="calibre3">283</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p318"/>$ <b class="calibre3">dig +short 733a48a9cb49651d72fe824ca91e8d00.malware.hash.cymru.com TXT</b>u</p>
<p class="calibre1">"1277221946v 79w" </p>
<p class="calibre1">$ <b class="calibre3">date -d @1277221946</b>x</p>
<p class="calibre1">Tue Jun 22 15:52:26 UTC 2010y</p>
<p class="calibre1">$ <b class="calibre3">dig +short 1e39efe30b02fd96b10785b49e23913b.malware.hash.cymru.com TXT</b>z</p>
<p class="calibre1">$ <b class="calibre3">whois -h hash.cymru.com 1e39efe30b02fd96b10785b49e23913b</b>{</p>
<p class="calibre1">1e39efe30b02fd96b10785b49e23913b 1366297928 NO_DATA|</p>
<p class="calibre1"> <i class="calibre4">Listing 12-28: Querying the MHR via TXT and whois records</i></p>
<p class="calibre1">The first example shows a DNS TXT records query for malware with hash </p>
<p class="calibre1">733a48a9cb49651d72fe824ca91e8d00 u. (Search VirusTotal to see what it is!) The </p>
<p class="calibre1">first part of the response shows the date when the MHR last saw the sample v. </p>
<p class="calibre1">The second part of the response is a rough antivirus detection metric, as </p>
<p class="calibre1">a percentage w. We convert the timestamp from Unix epoch time to </p>
<p class="calibre1">human-readable format with the date command x, and see that it was </p>
<p class="calibre1">June 22, 2010 y. </p>
<p class="calibre1">The second example shows what happens when you query the MHR </p>
<p class="calibre1">and it sends no response z. The hash supplied is the value for the Firefox </p>
<p class="calibre1">binary. Because the MHR has no data on this hash, we switch to the MHR </p>
<p class="calibre1">WHOIS query functionality {. The NO_DATA | response proves the MHR </p>
<p class="calibre1">doesn’t know the supplied hash. </p>
<p class="calibre1">The example in Listing 12-29 shows another query using dig, but not </p>
<p class="calibre1">requesting a TXT record. </p>
<p class="calibre1">$ <b class="calibre3">dig +short 733a48a9cb49651d72fe824ca91e8d00.malware.hash.cymru.com</b></p>
<p class="calibre1">127.0.0.2</p>
<p class="calibre1"> <i class="calibre4">Listing 12-29: Querying the MHR via the default A record</i></p>
<p class="calibre1">We query for the same first hash from Listing 12-28, but we let the </p>
<p class="calibre1">default be an A record. </p>
<p class="calibre1">A query for an A record asks a DNS server to return an IP address for </p>
<p class="calibre1">the requested fully qualified domain name. In contrast, a query for a PTR </p>
<p class="calibre1">record asks a DNS server to return a fully qualified domain name for the </p>
<p class="calibre1">requested IP address. A query for a TXT record asks a DNS server to reply </p>
<p class="calibre1">with any text records associated with a domain name. </p>
<p class="calibre1">Our only result is the IP address 127.0.0.2. This is the MHR’s way of </p>
<p class="calibre1">responding to A record queries that have a match. If we want more informa-</p>
<p class="calibre1">tion about a match, we need to run a DNS query for a TXT record, as shown </p>
<p class="calibre1">earlier in Listing 12-28. </p>
<p class="calibre1"><b class="calibre3">284</b>   Chapter 12</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p319"/><img src="index-319_1.jpg" alt="Image 153" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">The MHR and SO: Active by Default</b></i></p>
<p class="calibre1">By default, Bro on SO is configured to work with the MHR to help detect </p>
<p class="calibre1">malicious downloads. SO relies on Bro to calculate MD5 hashes of Windows </p>
<p class="calibre1">executables downloaded over HTTP, and that Bro automatically submits </p>
<p class="calibre1">those hashes to the MHR. We can see this activity in action if we query Bro </p>
<p class="calibre1">logs via ELSA, as shown in Figure 12-8. </p>
<p class="calibre1"> <i class="calibre4">Figure 12-8: Querying ELSA for MHR lookup</i></p>
<p class="calibre1">In Figure 12-8, we query ELSA for 1e39efe30b02fd96b10785b49e23913b </p>
<p class="calibre1">.malware.hash.cymru.com—the MD5 hash of the Firefox binary from an earlier </p>
<p class="calibre1">example (1e39efe30b02fd196b10785b49e23913b), plus the domain  <i class="calibre4">malware.hash </i></p>
<p class="calibre1"> <i class="calibre4">.cymru.com</i>. Figure 12-8 shows eight results, all of which are pairs. The first entry in the pair is a lookup for an A record for IPv4, and the second entry is </p>
<p class="calibre1">a lookup for an AAAA record for IPv6. Thus, we have four unique queries for </p>
<p class="calibre1">this particular MD5 hash. </p>
<p class="calibre1">We can use one of two approaches to determine if any of the lookups </p>
<p class="calibre1">returned results:</p>
<p class="calibre1">•  Inspect the results returned by ELSA directly. For example, a result </p>
<p class="calibre1">with no indication of malicious entries in the MHR looks like |1 </p>
<p class="calibre1">|C_INTERNET|1|A|-|-|F|F|T|F|0|-|- for IPv4 and |1|C_INTERNET|28|AAAA|- </p>
<p class="calibre1">|-|F|F|T|F|0|-|- for IPv6. We see these results for each of the entries </p>
<p class="calibre1">in Figure 12-8, indicating that there are no matches in the MHR. This </p>
<p class="calibre1">tells us that the MHR doesn’t think the download of a binary with MD5 </p>
<p class="calibre1">1e39efe30b02fd96b10785b49e23913b is malicious. </p>
<p class="calibre1">•  Query ELSA for Malware_Hash_Registry_Match. This is part of the event </p>
<p class="calibre1">returned by Bro when it queries the MHR and gets a positive response. </p>
<p class="calibre1">In this case, the query finds no records in ELSA for a binary with hash </p>
<p class="calibre1">1e39efe30b02fd96b10785b49e23913b. </p>
<p class="calibre1">Extending SO   <b class="calibre3">285</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p320"/><img src="index-320_1.png" alt="Image 154" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">The MHR and SO vs. a Malicious Download</b></i></p>
<p class="calibre1">Because SO and Bro query the MHR by default, in production, any match </p>
<p class="calibre1">for a malicious download will appear in ELSA and the underlying Bro logs. </p>
<p class="calibre1">For example, suppose that one day you’re working with SO and your </p>
<p class="calibre1">NSM data, and you run a query for Malware_Hash_Registry_Match. You get the </p>
<p class="calibre1">result shown in Figure 12-9. </p>
<p class="calibre1"> <i class="calibre4">Figure 12-9: Query result for Malware_Hash_Registry_Match</i></p>
<p class="calibre1">I’ve reproduced the same log entry as text only in Listing 12-30 for easy </p>
<p class="calibre1">reference. </p>
<p class="calibre1">1366293016.555895       -       192.168.2.108u   62585   205.186.148.46v    80      tcp HTTP::Malware_Hash_Registry_Matchw       192.168.2.108 b4f990cad1d20efab410e98fc7a6c81bx http://www.taosecurity.com/helpdesk.exey    -       192.168.2.108   205.186.148.46  </p>
<p class="calibre1">80-       soe-eth0-1      Notice::ACTION_LOG      6       3600.000000     F       </p>
<p class="calibre1">-       -       ---       -       -       -</p>
<p class="calibre1"> <i class="calibre4">Listing 12-30: Log entry for Malware_Hash_Registry_Match</i></p>
<p class="calibre1">This log result from the Bro  <i class="calibre4">notice.log</i> file indicates that a com-</p>
<p class="calibre1">puter with IP address 192.168.2.108 u visited 205.186.148.46 v and </p>
<p class="calibre1">triggered an HTTP::Malware_Hash_Registry_Match w alert for MD5 hash </p>
<p class="calibre1">b4f990cad1d20efab410e98fc7a6c81b x from  <i class="calibre4">www.taosecurity.com</i> and the </p>
<p class="calibre1"> <i class="calibre4">helpdesk.exe</i> file y. We can learn more about this connection if we </p>
<p class="calibre1">query ELSA for the filename  <i class="calibre4">helpdesk.exe</i>, as shown in Figure 12-10. </p>
<p class="calibre1">The results show three records:</p>
<p class="calibre1">•  The first record in Figure 12-10 is Bro’s way of telling us that it com-</p>
<p class="calibre1">puted an MD5 hash of the  <i class="calibre4">helpdesk.exe</i> binary. </p>
<p class="calibre1">•  The second record is the same as what we saw in the MD5 lookup. </p>
<p class="calibre1">•  The third record shows that Bro extracted the binary from the HTTP </p>
<p class="calibre1">traffic and saved it as  <i class="calibre4">/nsm/bro/extracted/http/http-item_192.168.2.108: </i></p>
<p class="calibre1"> <i class="calibre4">62585-205.186.148.46:80_resp_1.dat</i>. </p>
<p class="calibre1"><b class="calibre3">286</b>   Chapter 12</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p321"/><img src="index-321_1.png" alt="Image 155" class="calibre2"/></p>
<p class="calibre1"><img src="index-321_2.jpg" alt="Image 156" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4">Figure 12-10: Querying ELSA for </i> helpdesk .exe</p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Identifying the Binary</b></i></p>
<p class="calibre1">We know that Bro and SO performed a lookup for the binary based on an </p>
<p class="calibre1">MD5 hash, and we know that a match was found because Bro reported a </p>
<p class="calibre1">Malware_Hash_Registry_Match event. We can take a different look at this result </p>
<p class="calibre1">by querying ELSA using the hash and domain method demonstrated ear-</p>
<p class="calibre1">lier in Figure 12-8. </p>
<p class="calibre1">We’ll modify the query slightly by adding a +127.0.0.2 after the hash </p>
<p class="calibre1">and domain. The plus sign (+) tells ELSA to query for the term after it—</p>
<p class="calibre1">specifically 127.0.0.2, which is the IP address that the MHR returns when </p>
<p class="calibre1">Bro queries it for malware hashes. (We saw this difference in Listing 12-28.) </p>
<p class="calibre1">Figure 12-11 shows the result of looking for MHR matches for the hash and </p>
<p class="calibre1">domain b4f990cad1d20efab410e98fc7a6c81b.malware.hash.cymru.com. </p>
<p class="calibre1"> <i class="calibre4">Figure 12-11: Querying ELSA for b4f990cad1d20efab410e98fc7a6c81b.malware.hash.cymru .com  +127.0.0.2</i></p>
<p class="calibre1">Extending SO   <b class="calibre3">287</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p322"/><img src="index-322_1.png" alt="Image 157" class="calibre2"/></p>
<p class="calibre1">We get one result. The presence of the 127.0.0.2 reply tells us that the </p>
<p class="calibre1">MHR recognized the hash. </p>
<p class="calibre1">At this point, we could take a few different paths to identify the binary:</p>
<p class="calibre1">•  Because the binary is stored in  <i class="calibre4">/nsm/bro/extracted/http/http-item_ </i></p>
<p class="calibre1"> <i class="calibre4">192.168.2.108:62585-205.186.148.46:80_resp_1.dat</i>, we could perform </p>
<p class="calibre1">manual analysis. </p>
<p class="calibre1">•  We could submit the extracted binary to a third-party engine like VirusTotal. </p>
<p class="calibre1">•  We could submit the hash to VirusTotal, which returns the results </p>
<p class="calibre1">shown in Figure 12-12. </p>
<p class="calibre1"> <i class="calibre4">Figure 12-12: VirusTotal results for submit ing hash b4f990cad1d20efab410e98fc7a6c81b</i> VirusTotal identifies the malware as a Poison Ivy variant—a popular </p>
<p class="calibre1">remote-access Trojan (RAT) available from several websites. We hope the </p>
<p class="calibre1">user identified through this case downloaded the tool only for testing pur-</p>
<p class="calibre1">poses. If not, it’s time to begin looking for signs of outbound command-</p>
<p class="calibre1">and-control traffic, as described in Chapters 10 and 11. Good hunting! </p>
<p class="calibre1"><b class="calibre3">conclusion</b></p>
<p class="calibre1">This chapter has introduced you to four ways to extend and make better </p>
<p class="calibre1">use of functions packaged with SO. We covered how Bro creates MD5 </p>
<p class="calibre1">hashes for executables, and showed how to use them with VirusTotal. We </p>
<p class="calibre1">configured Bro to extract executable binaries from network traffic, and </p>
<p class="calibre1">demonstrated how to integrate external intelligence from Mandiant’s APT1 </p>
<p class="calibre1">report. We also generated alerts in Bro to simulate suspicious DNS lookups </p>
<p class="calibre1">for an APT1 domain. We finished the chapter by showing how SO reports </p>
<p class="calibre1">and extracts the download of a malicious binary in production, which we </p>
<p class="calibre1">learned was the Poison Ivy RAT. </p>
<p class="calibre1">In the next chapter, we’ll take a look at two challenges to conducting </p>
<p class="calibre1">NSM: proxies and checksums. </p>
<p class="calibre1"><b class="calibre3">288</b>   Chapter 12</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p323"/><b class="calibre3">13</b></p>
<p class="calibre1"><b class="calibre3">P r o x i e S   a N D   c h e c k S u M S</b></p>
<p class="calibre1">This chapter, aptly number 13, examines </p>
<p class="calibre1">two unlucky features of conducting NSM </p>
<p class="calibre1">on real networks: proxies and checksums. </p>
<p class="calibre1">The term  <i class="calibre4">proxy</i> refers to a piece of network infra-</p>
<p class="calibre1">structure that some companies use to observe, control, </p>
<p class="calibre1">and accelerate Internet usage. The term  <i class="calibre4">checksum</i>, </p>
<p class="calibre1">in the context of this chapter, refers to an error detection mechanism </p>
<p class="calibre1">offered by the Internet Protocol (IP). This chapter describes some ways </p>
<p class="calibre1">to cope with the problems caused by each of these features in operational </p>
<p class="calibre1">environments. </p>
<p class="calibre1"><b class="calibre3">Proxies</b></p>
<p class="calibre1">Web proxies are especially popular in corporate environments. One type </p>
<p class="calibre1">of web proxy is tuned to handle traffic from web clients destined for web </p>
<p class="calibre1">servers. </p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p324"/>Some network and security administrators like proxies because they </p>
<p class="calibre1">provide performance and security benefits. With proxies, users sometimes </p>
<p class="calibre1">enjoy better access to content because that content is cached the first time </p>
<p class="calibre1">any user views it, with subsequent users enjoying fast access to the cached </p>
<p class="calibre1">copy. When users must send traffic through a proxy, administrators can try </p>
<p class="calibre1">to protect the network by limiting their access to malicious sites. </p>
<p class="calibre1">Figure 13-1 shows how a web proxy might work in a corporate environ-</p>
<p class="calibre1">ment. Here, a web client with IP address 192.168.2.108 visits a web server </p>
<p class="calibre1">at 205.186.148.46. The web client first establishes a session with the proxy, </p>
<p class="calibre1">labeled CONNECTION 1. The proxy then connects to the web server on </p>
<p class="calibre1">behalf of the client. That session is labeled CONNECTION 2. All traffic </p>
<p class="calibre1">between the client and server occurs over independent connections like </p>
<p class="calibre1">these. </p>
<p class="calibre1">CONNECTION 1</p>
<p class="calibre1">CONNECTION 2</p>
<p class="calibre1">Location X</p>
<p class="calibre1">Location Y</p>
<p class="calibre1">Internet</p>
<p class="calibre1">Web Client</p>
<p class="calibre1">Proxy</p>
<p class="calibre1">Web Server</p>
<p class="calibre1">192.168.2.108</p>
<p class="calibre1">Internal: 192.168.2.1</p>
<p class="calibre1">205.186.148.46</p>
<p class="calibre1">External: 172.16.2.1</p>
<p class="calibre1"> <i class="calibre4">Figure 13-1: Sample web proxy setup</i></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Proxies and Visibility</b></i></p>
<p class="calibre1">As you can see in Figure 13-1, some elements of visibility are lost when </p>
<p class="calibre1">administrators deploy proxies. Instead of seeing only a true source IP </p>
<p class="calibre1">address for the web client and a true destination IP address for the web </p>
<p class="calibre1">server, we also see internal and external IP addresses for the proxy. The </p>
<p class="calibre1">web client speaks to the proxy, which then speaks to the web server. When </p>
<p class="calibre1">the web server replies, the direction is reversed. </p>
<p class="calibre1">For example, an NSM platform watching traffic at location X in </p>
<p class="calibre1">Figure 13-1 sees traffic with source IP address 192.168.2.108 and destina-</p>
<p class="calibre1">tion IP address 192.168.2.1. An NSM platform at location Y sees traffic with </p>
<p class="calibre1">source IP address 172.16.2.1 and destination IP address 205.186.148.46. </p>
<p class="calibre1">There doesn’t seem to be a single location where one sensor can see both </p>
<p class="calibre1">the true source IP address (192.168.2.108) and true destination IP address </p>
<p class="calibre1">(205.186.148.46) at once. This is a problem for analysts who rely on this </p>
<p class="calibre1">information to detect and respond to intruders. </p>
<p class="calibre1">Without access to sufficient logs, NSM analysts may actually see  <i class="calibre4">less</i> </p>
<p class="calibre1">when proxies are deployed. Sometimes they can access proxy logs, but those </p>
<p class="calibre1">may not be easy to read. Sometimes analysts can capture network traffic </p>
<p class="calibre1">directly on the proxy itself. For example, the proxy in Figure 13-1 is run-</p>
<p class="calibre1">ning the pfSense ( <i class="calibre4">http://www.pfsense.org/</i>) firewall with the Squid ( <i class="calibre4">http://</i></p>
<p class="calibre1"> <i class="calibre4">www.squid-cache.org/</i>) web proxy. Because the specific platform is a FreeBSD </p>
<p class="calibre1">system in this example, we can collect traffic directly on the server. That is </p>
<p class="calibre1">not usually the case in production, but we will leverage this situation in this </p>
<p class="calibre1">chapter to gather network traffic and better understand the situation. </p>
<p class="calibre1"><b class="calibre3">290</b>   Chapter 13</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p325"/>Suppose you want to troubleshoot a perceived problem with the proxy </p>
<p class="calibre1">in Figure 13-1. You decide to log full content traffic in pcap format using </p>
<p class="calibre1">Tcpdump. You collect traffic from the internal interface in one trace file </p>
<p class="calibre1">called  <i class="calibre4">bej-int.pcap</i>. You then collect traffic in a separate session from the </p>
<p class="calibre1">external interface in  <i class="calibre4">bej-ext.pcap</i>. While sniffing each interface, you use a </p>
<p class="calibre1">web client on 192.168.2.108 to visit the  <i class="calibre4">www.bejtlich.net</i> web server. </p>
<p class="calibre1">In order to look at the contents of the trace file, you manually generate </p>
<p class="calibre1">a transcript using Tcpflow ( <i class="calibre4">https://github.com/simsong/tcpflow/</i>), as shown in Listing 13-1. </p>
<p class="calibre1">$ <b class="calibre3">tcpflow -r bej-int.pcap</b></p>
<p class="calibre1">$ <b class="calibre3">ls -al</b></p>
<p class="calibre1">total 56</p>
<p class="calibre1">drwxrwxr-x 3 ds61so ds61so 4096 Apr 23 20:14 . </p>
<p class="calibre1">drwxrwxr-x 4 ds61so ds61so 4096 Apr 23 20:05 .. </p>
<p class="calibre1">-rw-rw-r-- 1 ds61so ds61so 3605 Apr 21 20:53 172.016.002.001.03128-192.168.002.108.50949u</p>
<p class="calibre1">-rw-rw-r-- 1 ds61so ds61so  376 Apr 21 20:53 192.168.002.108.50949-172.016.002.001.03128v <i class="calibre4">Listing 13-1: Using Tcpflow to generate transcripts manual y on the </i> bej-int .pcap <i class="calibre4"> trace file</i> When run in this manner, Tcpflow generates two files. The first is traffic from the proxy to the client u. The second is traffic from the client to </p>
<p class="calibre1">the proxy v. </p>
<p class="calibre1"><b class="calibre3">traffic from the Client to the Proxy</b></p>
<p class="calibre1">Listing 13-2 shows the traffic from the client to the proxy in this example. </p>
<p class="calibre1">$ <b class="calibre3">cat 192.168.002.108.50949-172.016.002.001.03128</b></p>
<p class="calibre1">GET http://www.bejtlich.net/u HTTP/1.1</p>
<p class="calibre1">Host: www.bejtlich.net</p>
<p class="calibre1">User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:20.0) Gecko/20100101 Firefox/20.0</p>
<p class="calibre1">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</p>
<p class="calibre1">Accept-Language: en-US,en;q=0.5</p>
<p class="calibre1">Accept-Encoding: gzip, deflate</p>
<p class="calibre1">DNT: 1</p>
<p class="calibre1">Referer: http://www.taosecurity.com/training.html</p>
<p class="calibre1">Connection: keep-alive</p>
<p class="calibre1"> <i class="calibre4">Listing 13-2: Traffic from the client to the proxy</i></p>
<p class="calibre1">At location X, notice that the GET request for  <i class="calibre4">http://www.bejtlich.net/</i> u is a bit different from normal GET requests. Unproxied web traffic would make a </p>
<p class="calibre1">GET request to the / directory, not the entire URL, with something like GET /. </p>
<p class="calibre1">Listing 13-3 shows the response from the proxy. </p>
<p class="calibre1">Proxies and Checksums   <b class="calibre3">291</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p326"/>$ <b class="calibre3">cat 172.016.002.001.03128-192.168.002.108.50949</b>  </p>
<p class="calibre1">HTTP/1.0 200 OK</p>
<p class="calibre1">Date: Sun, 21 Apr 2013 20:53:38 GMT</p>
<p class="calibre1">Server: Apache/2</p>
<p class="calibre1">Last-Modified: Wed, 02 Jan 2013 15:49:44 GMT</p>
<p class="calibre1">ETag: "2e800ed-c713-4d25031f1f600" </p>
<p class="calibre1">Accept-Ranges: bytes</p>
<p class="calibre1">Content-Length: 3195</p>
<p class="calibre1">Content-Type: text/html; charset=UTF-8</p>
<p class="calibre1">X-Cache: MISS from localhostu</p>
<p class="calibre1">X-Cache-Lookup: MISS from localhost:3128v</p>
<p class="calibre1">Via: 1.1 localhost:3128 (squid/2.7.STABLE9)w</p>
<p class="calibre1">Connection: keep-alive</p>
<p class="calibre1">Proxy-Connection: keep-alivex</p>
<p class="calibre1">y&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/</p>
<p class="calibre1">xhtml1-strict.dtd"&gt; </p>
<p class="calibre1">&lt;html  xml:lang="en"&gt; </p>
<p class="calibre1">&lt;head&gt; </p>
<p class="calibre1">&lt;meta http-equiv="content-type" content="text/html; charset=iso-8859-1" /&gt; </p>
<p class="calibre1">&lt;meta name="Richard Bejtlich" content="Home page of TaoSecurity founder Richard Bejtlich" /&gt; </p>
<p class="calibre1">&lt;meta name="keywords" content="bejtlich,taosecurity,network,security" /&gt; </p>
<p class="calibre1"> <i class="calibre4">-- snip --</i></p>
<p class="calibre1"> <i class="calibre4">Listing 13-3: Traffic from proxy to client as seen at location X</i></p>
<p class="calibre1">Listing 13-3 includes four headers indicating that a proxy is involved. </p>
<p class="calibre1">The headers at u and v show that the proxy didn’t have a locally cached </p>
<p class="calibre1">copy of the requested content. The headers at w and x report the nature </p>
<p class="calibre1">of the proxy connection. The last part, at y, shows the beginning of the </p>
<p class="calibre1">web page hosted at 205.186.148.46. </p>
<p class="calibre1"><b class="calibre3">traffic from the Proxy to the Web Server</b></p>
<p class="calibre1">Now let’s use Tcpflow to see what traffic looks like when it goes from the </p>
<p class="calibre1">proxy to a web server, as seen at location Y. Listing 13-4 shows how to gener-</p>
<p class="calibre1">ate the transcripts against trace file  <i class="calibre4">bej-ext.pcap</i>, which was captured on the proxy interface facing the web server. </p>
<p class="calibre1">$ <b class="calibre3">tcpflow -r bej-ext.pcap</b></p>
<p class="calibre1">$ <b class="calibre3">ls -al</b></p>
<p class="calibre1">total 20</p>
<p class="calibre1">drwxrwxr-x 2 ds61so ds61so 4096 Apr 23 20:33 . </p>
<p class="calibre1">drwxrwxr-x 3 ds61so ds61so 4096 Apr 23 20:32 .. </p>
<p class="calibre1">-rw-rw-r-- 1 ds61so ds61so  461 Apr 21 20:53 192.168.001.002.02770-205.186.148.046.00080u</p>
<p class="calibre1">-rw-rw-r-- 1 ds61so ds61so 3453 Apr 21 20:53 205.186.148.046.00080-192.168.001.002.02770v <i class="calibre4">Listing 13-4: Using Tcpflow to generate transcripts manual y on the </i> bej-ext .pcap <i class="calibre4"> trace file</i> <b class="calibre3">292</b>   Chapter 13</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p327"/>Again, Tcpflow generates two files: traffic from the proxy to the </p>
<p class="calibre1">server u and traffic from the server to the proxy v. Let’s look at traffic </p>
<p class="calibre1">from the proxy to the server first, as shown in Listing 13-5. </p>
<p class="calibre1">$ <b class="calibre3">cat 192.168.001.002.02770-205.186.148.046.00080</b></p>
<p class="calibre1">GET /u HTTP/1.0</p>
<p class="calibre1">Host: www.bejtlich.net</p>
<p class="calibre1">User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:20.0) Gecko/20100101 Firefox/20.0</p>
<p class="calibre1">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</p>
<p class="calibre1">Accept-Language: en-US,en;q=0.5</p>
<p class="calibre1">Accept-Encoding: gzip, deflate</p>
<p class="calibre1">DNT: 1</p>
<p class="calibre1">Referer: http://www.taosecurity.com/training.html</p>
<p class="calibre1">Via: 1.1 localhost:3128 (squid/2.7.STABLE9)v</p>
<p class="calibre1">X-Forwarded-For: 192.168.2.108w</p>
<p class="calibre1">Cache-Control: max-age=259200</p>
<p class="calibre1">Connection: keep-alive</p>
<p class="calibre1"> <i class="calibre4">Listing 13-5: Traffic from the proxy to the server as seen at location Y</i></p>
<p class="calibre1">Listing 13-5 includes several interesting features: </p>
<p class="calibre1">•  The resource visited by the proxy via the GET / request u resembles nor-</p>
<p class="calibre1">mal web traffic seen elsewhere in the book. However, it differs from the </p>
<p class="calibre1">proxied request shown in Listing 13-2. </p>
<p class="calibre1">•  The proxy includes a Via statement v indicating the involvement of a </p>
<p class="calibre1">Squid proxy. </p>
<p class="calibre1">•  The proxy reveals the true source IP address of the client making the </p>
<p class="calibre1">web request in the X-Forwarded-For statement w. </p>
<p class="calibre1"><b class="calibre3">N o T e </b> <i class="calibre4"> </i></p>
<p class="calibre1"> <i class="calibre4">Some security analysts worry that these “features,” especially the X-Forwarded-For</i> <i class="calibre4">statement, will allow intruders operating malicious websites to see these headers and</i> <i class="calibre4">learn how a company’s internal network is configured. Security teams must balance</i> <i class="calibre4">the added visibility they gain against a perceived leakage of potentially sensitive information to outsiders. </i></p>
<p class="calibre1">Listing 13-6 shows the response from the server. </p>
<p class="calibre1">$ <b class="calibre3">cat 205.186.148.046.00080-192.168.001.002.02770</b></p>
<p class="calibre1">HTTP/1.1 200 OK</p>
<p class="calibre1">Date: Sun, 21 Apr 2013 20:53:38 GMT</p>
<p class="calibre1">Server: Apache/2</p>
<p class="calibre1">Last-Modified: Wed, 02 Jan 2013 15:49:44 GMT</p>
<p class="calibre1">ETag: "2e800ed-c713-4d25031f1f600" </p>
<p class="calibre1">Accept-Ranges: bytes</p>
<p class="calibre1">Content-Length: 3195</p>
<p class="calibre1">Connection: close</p>
<p class="calibre1">Content-Type: text/html; charset=UTF-8</p>
<p class="calibre1">Proxies and Checksums   <b class="calibre3">293</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p328"/>&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/</p>
<p class="calibre1">xhtml1-strict.dtd"&gt; </p>
<p class="calibre1">&lt;html  xml:lang="en"&gt; </p>
<p class="calibre1">&lt;head&gt; </p>
<p class="calibre1">&lt;meta http-equiv="content-type" content="text/html; charset=iso-8859-1" /&gt; </p>
<p class="calibre1">&lt;meta name="Richard Bejtlich" content="Home page of TaoSecurity founder Richard Bejtlich" /&gt; </p>
<p class="calibre1">&lt;meta name="keywords" content="bejtlich,taosecurity,network,security" /&gt; </p>
<p class="calibre1"> <i class="calibre4">-- snip --</i></p>
<p class="calibre1"> <i class="calibre4">Listing 13-6: Traffic from the server to the proxy as seen at location Y</i></p>
<p class="calibre1">As far as the web server in Listing 13-6 is concerned, the proxy is the sys-</p>
<p class="calibre1">tem making the request. There is nothing special about what it sends back. </p>
<p class="calibre1">(Notice in Listing 13-3 how the two differ, paying particular attention to </p>
<p class="calibre1">the headers added by the proxy.)</p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Dealing with Proxies in Production Networks</b></i></p>
<p class="calibre1">CIRTs have four options when dealing with proxies in production networks: </p>
<p class="calibre1">1.  Try to gain access to the logs generated by a proxy in order to see traf-</p>
<p class="calibre1">fic from the proxy’s perspective. </p>
<p class="calibre1">2.  Use the techniques described in Chapter 2 to deploy multiple sensors </p>
<p class="calibre1">with appropriate visibility. In this respect, a proxy is like a NAT issue—</p>
<p class="calibre1">put sensors where you need them in order to see true source and desti-</p>
<p class="calibre1">nation IP addresses. </p>
<p class="calibre1">3.  Make more extensive use of the information kept inside logs generated </p>
<p class="calibre1">by proxy-aware NSM software. As shown in the transcripts in Listings 13-2, </p>
<p class="calibre1">13-3, and 13-5, information about proxy use is available for review. </p>
<p class="calibre1">4.  Use software that can enable special features to track X-Forwarded-For </p>
<p class="calibre1">headers and extract the client IP address when reporting alert data. </p>
<p class="calibre1">(See the enable_xff configuration option in Snort, for example.)</p>
<p class="calibre1">The next part of this chapter will take the third approach. We’ll use </p>
<p class="calibre1">Bro to examine the traffic in these sample traces to see whether it can gen-</p>
<p class="calibre1">erate information that helps us deal with proxies. Before dealing with our </p>
<p class="calibre1">proxy problem, however, we need to take a slight detour into the world of </p>
<p class="calibre1">IP checksums. </p>
<p class="calibre1"><b class="calibre3">checksums</b></p>
<p class="calibre1">IP headers contain a checksum as an error detection mechanism. Network </p>
<p class="calibre1">devices calculate and insert checksums when they process packets. When </p>
<p class="calibre1">a downstream device receives an IP packet, it calculates a checksum for </p>
<p class="calibre1">that packet based on the contents of the IP header. For the purposes of the </p>
<p class="calibre1">calculation, the equation sets the IP checksum field itself to zero. If the cal-</p>
<p class="calibre1">culated checksum fails to match the checksum in the IP packet, the device </p>
<p class="calibre1">may discard the packet. The device senses an error and deals with it by </p>
<p class="calibre1">dropping the IP packet. </p>
<p class="calibre1"><b class="calibre3">294</b>   Chapter 13</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p329"/><img src="index-329_1.png" alt="Image 158" class="calibre2"/></p>
<p class="calibre1"><img src="index-329_2.png" alt="Image 159" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">A Good Checksum</b></i></p>
<p class="calibre1">Figure 13-2 shows a checksum that is correct for the contents of a packet. </p>
<p class="calibre1"> <i class="calibre4">Figure 13-2: Correct IP checksum of 0x81a4 in a TCP packet</i></p>
<p class="calibre1">The IP checksum is 0x81a4 (0x means the value is represented in hexa-</p>
<p class="calibre1">decimal). Wireshark appends the word [correct] after the checksum value </p>
<p class="calibre1">to show that it calculated a checksum and found that it matched the value </p>
<p class="calibre1">reported in the packet. (Note this is a TCP segment, but we are concerned </p>
<p class="calibre1">only with the IP checksum here.)</p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">A Bad Checksum</b></i></p>
<p class="calibre1">Figure 13-3 shows a checksum that is not correct for the contents of a packet. </p>
<p class="calibre1"> <i class="calibre4">Figure 13-3: Incorrect IP checksum of 0x0000 in a TCP packet</i></p>
<p class="calibre1">Here, we see that the IP checksum is 0x0000. Wireshark doesn’t like </p>
<p class="calibre1">this value. It reports concern via a red bar over the IP header entry and the </p>
<p class="calibre1">words [incorrect, should be 0x1529 (may be caused by “IP checksum offload”?)]. </p>
<p class="calibre1">Wireshark shows that it calculated a checksum that didn’t match the value </p>
<p class="calibre1">reported in the packet. (This is also a TCP segment.)</p>
<p class="calibre1">Proxies and Checksums   <b class="calibre3">295</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p330"/> <i class="calibre4"><b class="calibre3">Identifying Bad and Good Checksums with Tshark</b></i></p>
<p class="calibre1">Tshark offers a few helpful ways to quickly review checksums. We’ll use </p>
<p class="calibre1">the traffic we collected i<a href="#p323">n “Proxies” on page 289 a</a>s our sample data. We’re supposed to be troubleshooting performance, and we expect to rely on </p>
<p class="calibre1">those traces to answer our questions. First, look at the trace file recorded </p>
<p class="calibre1">at location X, as shown in Listing 13-7. </p>
<p class="calibre1">$ <b class="calibre3">tshark -n -r bej-int.pcap -T fields -E separator=/t -e ip.src -e tcp.srcport </b></p>
<p class="calibre1"><b class="calibre3">-e ip.dst -e tcp.dstport -e ip.checksum</b></p>
<p class="calibre1">Source IP       SrcPort Destination IP  DstPort IP Checksum</p>
<p class="calibre1">192.168.2.108   50949   172.16.2.1      3128    0x81a4</p>
<p class="calibre1">172.16.2.1      3128    192.168.2.108   50949   0x0000</p>
<p class="calibre1">192.168.2.108   50949   172.16.2.1      3128    0x81af</p>
<p class="calibre1">192.168.2.108   50949   172.16.2.1      3128    0x8036</p>
<p class="calibre1">172.16.2.1      3128    192.168.2.108   50949   0x0000</p>
<p class="calibre1">172.16.2.1      3128    192.168.2.108   50949   0x0000</p>
<p class="calibre1">192.168.2.108   50949   172.16.2.1      3128    0x81ad</p>
<p class="calibre1">172.16.2.1      3128    192.168.2.108   50949   0x0000</p>
<p class="calibre1">192.168.2.108   50949   172.16.2.1      3128    0x81a5</p>
<p class="calibre1">172.16.2.1      3128    192.168.2.108   50949   0x0000</p>
<p class="calibre1">172.16.2.1      3128    192.168.2.108   50949   0x0000</p>
<p class="calibre1">192.168.2.108   50949   172.16.2.1      3128    0x81a4</p>
<p class="calibre1"> <i class="calibre4">Listing 13-7: Custom Tshark output for the </i> bej-int .pcap <i class="calibre4"> trace file</i></p>
<p class="calibre1">Listing 13-7 invokes a few new switches to display only the  information </p>
<p class="calibre1">that concerns us. We used the -T fields and -E separator=/t switches to tell </p>
<p class="calibre1">Tshark we wanted specific parts of the packets to be displayed and we wanted </p>
<p class="calibre1">those fields printed with tabs between them. Using the -e switches, we told </p>
<p class="calibre1">Tshark just which parts of the packets we wanted. (I added the headers after </p>
<p class="calibre1">the command line to make it easier for you to recognize the fields.)</p>
<p class="calibre1">Looking at the last column, it seems odd that every packet from </p>
<p class="calibre1">172.16.2.1 has a checksum of 0x0000. When we saw that same occurrence </p>
<p class="calibre1">in Wireshark, the tool reported a checksum error. </p>
<p class="calibre1">We can invoke Tshark again to tell us which packets have miscalculated </p>
<p class="calibre1">checksums, as shown in Listing 13-8. </p>
<p class="calibre1">$ <b class="calibre3">tshark -n -r bej-int.pcap -T fields -E separator=/t -e ip.src -e tcp.srcport </b></p>
<p class="calibre1"><b class="calibre3">-e ip.dst -e tcp.dstport -e ip.proto -e ip.checksum -R "ip.checksum_bad==1" </b></p>
<p class="calibre1">172.16.2.1      3128    192.168.2.108   50949   6       0x0000</p>
<p class="calibre1">172.16.2.1      3128    192.168.2.108   50949   6       0x0000</p>
<p class="calibre1">172.16.2.1      3128    192.168.2.108   50949   6       0x0000</p>
<p class="calibre1">172.16.2.1      3128    192.168.2.108   50949   6       0x0000</p>
<p class="calibre1">172.16.2.1      3128    192.168.2.108   50949   6       0x0000</p>
<p class="calibre1">172.16.2.1      3128    192.168.2.108   50949   6       0x0000</p>
<p class="calibre1"> <i class="calibre4">Listing 13-8: Tshark output for sample trace file showing only bad checksums</i></p>
<p class="calibre1"><b class="calibre3">296</b>   Chapter 13</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p331"/>In Listing 13-8, we add the display filter <b class="calibre3">-R "ip.checksum_bad==1" </b>. This tells Tshark to show only packets whose checksums do not match the values </p>
<p class="calibre1">Tshark thinks they should have. If you want to see only packets with good </p>
<p class="calibre1">checksums, try the command shown in Listing 13-9. </p>
<p class="calibre1">$ <b class="calibre3">tshark -n -r bej-int.pcap -T fields -E separator=/t -e ip.src -e tcp.srcport </b></p>
<p class="calibre1"><b class="calibre3">-e ip.dst -e tcp.dstport -e ip.proto -e ip.checksum -R "ip.checksum_good==1" </b></p>
<p class="calibre1">192.168.2.108   50949   172.16.2.1      3128    6       0x81a4</p>
<p class="calibre1">192.168.2.108   50949   172.16.2.1      3128    6       0x81af</p>
<p class="calibre1">192.168.2.108   50949   172.16.2.1      3128    6       0x8036</p>
<p class="calibre1">192.168.2.108   50949   172.16.2.1      3128    6       0x81ad</p>
<p class="calibre1">192.168.2.108   50949   172.16.2.1      3128    6       0x81a5</p>
<p class="calibre1">192.168.2.108   50949   172.16.2.1      3128    6       0x81a4</p>
<p class="calibre1"> <i class="calibre4">Listing 13-9: Tshark output for sample trace file showing only good checksums</i></p>
<p class="calibre1">In Listing 13-9, we add the display filter -R "ip.checksum_good==1". This </p>
<p class="calibre1">tells Tshark to show only packets whose checksums match the values Tshark </p>
<p class="calibre1">thinks they should have. You could get the same results for Listing 13-8 </p>
<p class="calibre1">using the display filter -R "ip.checksum_good==0" and the same results for </p>
<p class="calibre1">Listing 13-9 using the display filter -R "ip.checksum_bad==0". </p>
<p class="calibre1">Before investigating why we’re getting these bad checksums, let’s see </p>
<p class="calibre1">whether they also appear in  <i class="calibre4">bej-ext.pcap</i>. As we did with Listing 13-7, we can show the key elements of a trace file using Tshark. Listing 13-10 provides </p>
<p class="calibre1">the syntax and output. </p>
<p class="calibre1">$ <b class="calibre3">tshark -n -r ../bej-ext.pcap -T fields -E separator=/t -e ip.src -e tcp. </b></p>
<p class="calibre1"><b class="calibre3">srcport -e ip.dst -e tcp.dstport -e ip.checksum</b></p>
<p class="calibre1">192.168.1.2     2770    205.186.148.46  80      0x0000</p>
<p class="calibre1">205.186.148.46  80      192.168.1.2     2770    0x5b28</p>
<p class="calibre1">192.168.1.2     2770    205.186.148.46  80      0x0000</p>
<p class="calibre1">192.168.1.2     2770    205.186.148.46  80      0x0000</p>
<p class="calibre1">205.186.148.46  80      192.168.1.2     2770    0x9597</p>
<p class="calibre1">205.186.148.46  80      192.168.1.2     2770    0x8fee</p>
<p class="calibre1">192.168.1.2     2770    205.186.148.46  80      0x0000</p>
<p class="calibre1">205.186.148.46  80      192.168.1.2     2770    0x8fed</p>
<p class="calibre1">192.168.1.2     2770    205.186.148.46  80      0x0000</p>
<p class="calibre1">205.186.148.46  80      192.168.1.2     2770    0x9367</p>
<p class="calibre1">192.168.1.2     2770    205.186.148.46  80      0x0000</p>
<p class="calibre1">192.168.1.2     2770    205.186.148.46  80      0x0000</p>
<p class="calibre1">192.168.1.2     2770    205.186.148.46  80      0x0000</p>
<p class="calibre1">205.186.148.46  80      192.168.1.2     2770    0x9593</p>
<p class="calibre1"> <i class="calibre4">Listing 13-10: Custom Tshark output for the </i> bej-ext .pcap  <i class="calibre4">trace file</i></p>
<p class="calibre1">In Listing 13-10, the proxy is 192.168.1.2, and the server is 205.186.148.46, </p>
<p class="calibre1">offering web services on port 80 TCP. Again, we see suspicious IP checksums </p>
<p class="calibre1">(0x0000) on all packets from the proxy to the web server. As with  <i class="calibre4">bej-int.pcap</i>, the system generating IP traffic with bad checksums is the proxy. Why? </p>
<p class="calibre1">Proxies and Checksums   <b class="calibre3">297</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p332"/> <i class="calibre4"><b class="calibre3">How Bad Checksums Happen</b></i></p>
<p class="calibre1">IP checksums occasionally fail to match the intended values due to errors </p>
<p class="calibre1">introduced over the Internet. These errors are exceptionally rare, however, </p>
<p class="calibre1">unless a real network problem is involved. How did so many checksums </p>
<p class="calibre1">fail in Listings 13-7 and 13-10, and why are those failures so consistent? </p>
<p class="calibre1">The error reported by Wireshark in Figure 13-3, [incorrect, should be </p>
<p class="calibre1">0x1529 (may be caused by "IP checksum offload"?)], can help us answer those questions. </p>
<p class="calibre1">Traditionally, the operating system and network stack were responsible </p>
<p class="calibre1">for calculating IP checksums, but modern network drivers and some NICs </p>
<p class="calibre1">assume that burden. This process, called  <i class="calibre4">offloading</i>, allows the network stack to send traffic quickly. Calculating checksums can be done quickly in the </p>
<p class="calibre1">driver or, better yet, by dedicated hardware. </p>
<p class="calibre1">Frequent IP checksum errors like those in Listings 13-7 and 13-10 will </p>
<p class="calibre1">interfere with your ability to conduct NSM. Traces with bad checksums are </p>
<p class="calibre1">often the result of capturing network traffic on a platform that offloads the </p>
<p class="calibre1">checksum process to a driver or hardware. The packet seen by the network </p>
<p class="calibre1">security tool has a 0x0000, or empty, checksum, but the “real” packet sent </p>
<p class="calibre1">on the wire has a true checksum calculated and added to the packet by the </p>
<p class="calibre1">driver or hardware. (When SO configures network interfaces, the setup </p>
<p class="calibre1">script disables driver and hardware checksum offloading in an effort to </p>
<p class="calibre1">avoid these issues.)</p>
<p class="calibre1">In our scenario, the proxy relies on checksum offloading to speed up </p>
<p class="calibre1">the transmission of network traffic. Unfortunately, the software on the </p>
<p class="calibre1">proxy sets a 0x0000 IP checksum on all outgoing packets. Before the packet </p>
<p class="calibre1">hits the wire, though, the driver or NIC hardware calculates and inserts </p>
<p class="calibre1">a proper checksum. Packets received from other devices have the correct </p>
<p class="calibre1">checksums. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Bro and Bad Checksums</b></i></p>
<p class="calibre1">Now that we’ve looked at good and bad IP checksums, let’s examine why </p>
<p class="calibre1">they matter. Some network security tools assume that packets with a bad IP </p>
<p class="calibre1">checksum will never be processed by the receiving network endpoint. The </p>
<p class="calibre1">network security tool drops the packet. Unfortunately, these bad checksums </p>
<p class="calibre1">might simply be caused by offloading. </p>
<p class="calibre1">Bro ignores traffic with bad IP checksums. For example, notice how it </p>
<p class="calibre1">processes the  <i class="calibre4">bej-int.pcap</i> trace file, as shown in Listing 13-11. </p>
<p class="calibre1">$ <b class="calibre3">sudo bro -r bej-int.pcap /opt/bro/share/bro/site/local.bro</b></p>
<p class="calibre1">WARNING: No Site::local_nets have been defined.  It's usually a good idea to define your local networks. </p>
<p class="calibre1">WARNING: Template value remaining in BPFConf filename: /etc/nsm/{{hostname}}-{{interface}}/bpf-bro.conf (/opt/bro/share/bro/securityonion/./bpfconf.bro, line 99)</p>
<p class="calibre1">WARNING: Template value remaining in BPFConf filename: /etc/nsm/ds61so-{{interface}}/bpf-bro. </p>
<p class="calibre1">conf (/opt/bro/share/bro/securityonion/./bpfconf.bro, line 99)</p>
<p class="calibre1"> <i class="calibre4">Listing 13-11: Bro reads the </i> bej-int .pcap <i class="calibre4"> trace file. </i></p>
<p class="calibre1"><b class="calibre3">298</b>   Chapter 13</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p333"/>Nothing odd appears by default, but take a look at  <i class="calibre4">weird.log</i>, shown in Listing 13-12. </p>
<p class="calibre1">$ <b class="calibre3">cat weird.log</b></p>
<p class="calibre1">#separator \x09</p>
<p class="calibre1">#set_separator  , </p>
<p class="calibre1">#empty_field    (empty)</p>
<p class="calibre1">#unset_field    -</p>
<p class="calibre1">#path   weird</p>
<p class="calibre1">#open   2013-04-23-19-40-10</p>
<p class="calibre1">#fields ts      uid     id.orig_h       id.orig_p       id.resp_h       id.resp_p       name addl    notice  peer</p>
<p class="calibre1">#types  time    string  addr    port    addr    port    string  string  bool    string 1366577618.249515       -       -       -       -       -       bad_IP_checksum -       F       </p>
<p class="calibre1">bro</p>
<p class="calibre1">1366577618.251250       rhdNNjfMGkc     192.168.2.108   50949   172.16.2.1      3128    </p>
<p class="calibre1">upossible_split_routing  -       F       bro</p>
<p class="calibre1">1366577618.251867       rhdNNjfMGkc     192.168.2.108   50949   172.16.2.1      3128     </p>
<p class="calibre1">vdata_before_established -       F       bro</p>
<p class="calibre1">#close  2013-04-23-19-40-10</p>
<p class="calibre1"> <i class="calibre4">Listing 13-12: Bro </i> weird .log <i class="calibre4"> file</i></p>
<p class="calibre1">The first entry reports possible_split_routing u because Bro is seeing only </p>
<p class="calibre1">half the traffic, namely packets from 192.168.2.108 to 172.16.2.1. These were </p>
<p class="calibre1">the packets in Listing 13-9 with good IP checksums. The second entry reports </p>
<p class="calibre1">data_before_established v because Bro didn’t see a complete TCP three-way </p>
<p class="calibre1">handshake. When Bro misses the three-way handshake, it’s confused when it </p>
<p class="calibre1">sees data transmitted before the session was properly established. </p>
<p class="calibre1">The Bro  <i class="calibre4">http.log</i> file is also odd, as shown in Listing 13-13. </p>
<p class="calibre1">$ <b class="calibre3">cat http.log</b></p>
<p class="calibre1">#separator \x09</p>
<p class="calibre1">#set_separator  , </p>
<p class="calibre1">#empty_field    (empty)</p>
<p class="calibre1">#unset_field    -</p>
<p class="calibre1">#path   http</p>
<p class="calibre1">#open   2013-04-23-19-40-10</p>
<p class="calibre1">#fields ts      uid     id.orig_h       id.orig_p       id.resp_h       id.resp_p       trans_</p>
<p class="calibre1">depth     method  host    uri     referrer        user_agent      request_body_len        </p>
<p class="calibre1">response_body_len       status_code     status_msg  info_code        info_msg        filename tags    username        password        proxied mime_type       md5     extraction_file</p>
<p class="calibre1">#types  time    string  addr    port    addr    port    count   string  string  string  string string  count   count   count   string  count   string  string  table[enum]     string  string table[string]   string  string  file</p>
<p class="calibre1">Proxies and Checksums   <b class="calibre3">299</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p334"/>1366577618.251867       rhdNNjfMGkc     192.168.2.108   50949   172.16.2.1      3128    1       </p>
<p class="calibre1">GETu     www.bejtlich.net        http://www.bejtlich.net/        http://www.taosecurity. </p>
<p class="calibre1">com/training.html        Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:20.0) Gecko/20100101 </p>
<p class="calibre1">Firefox/20.0 0       0       -       -       -       -       -       (empty) -       -       -   </p>
<p class="calibre1">-       -       -</p>
<p class="calibre1">#close  2013-04-23-19-40-10</p>
<p class="calibre1"> <i class="calibre4">Listing 13-13: Bro </i> http .log <i class="calibre4"> file</i></p>
<p class="calibre1">We see a GET request here u, but no indication of a reply. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Setting Bro to Ignore Bad Checksums</b></i></p>
<p class="calibre1">We can tell Bro to shut off its checksum verification and process all traffic </p>
<p class="calibre1">using the -C switch, as shown in Listing 13-14. </p>
<p class="calibre1">$ <b class="calibre3">sudo bro -r bej-int.pcap -C /opt/bro/share/bro/site/local.bro</b></p>
<p class="calibre1">WARNING: No Site::local_nets have been defined.  It's usually a good idea to define your local networks. </p>
<p class="calibre1">WARNING: Template value remaining in BPFConf filename: /etc/nsm/{{hostname}}-{{interface}}/bpf-bro.conf (/opt/bro/share/bro/securityonion/./bpfconf.bro, line 99)</p>
<p class="calibre1">WARNING: 1366577618.694909 Template value remaining in BPFConf filename: /etc/nsm/ds61so-</p>
<p class="calibre1">{{interface}}/bpf-bro.conf (/opt/bro/share/bro/securityonion/./bpfconf.bro, line 99)</p>
<p class="calibre1"> <i class="calibre4">Listing 13-14: Bro reads the trace file and ignores checksums. </i></p>
<p class="calibre1">Now there is no  <i class="calibre4">weird.log</i>. If we look at  <i class="calibre4">http.log</i>, we’ll see that it’s what we’ve come to expect. Listing 13-15 shows the results. </p>
<p class="calibre1">$ <b class="calibre3">cat http.log</b></p>
<p class="calibre1">#separator \x09</p>
<p class="calibre1">#set_separator  , </p>
<p class="calibre1">#empty_field    (empty)</p>
<p class="calibre1">#unset_field    -</p>
<p class="calibre1">#path   http</p>
<p class="calibre1">#open   2013-04-23-20-06-19</p>
<p class="calibre1">#fields ts      uid     id.orig_h       id.orig_p       id.resp_h       id.resp_p       trans_</p>
<p class="calibre1">depth     method  host    uri     referrer        user_agent      request_body_len        </p>
<p class="calibre1">response_body_len       status_code     status_msg  info_code        info_msg        filename tags    username        password        proxied mime_type       md5     extraction_file</p>
<p class="calibre1">#types  time    string  addr    port    addr    port    count   string  string  string  string string  count   count   count   string  count   string  string  table[enum]     string  string table[string]   string  string  file</p>
<p class="calibre1"><b class="calibre3">300</b>   Chapter 13</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p335"/>1366577618.251867       aqjpeHaXm7f     192.168.2.108   50949   172.16.2.1      3128    1       </p>
<p class="calibre1">GETu    www.bejtlich.net        http://www.bejtlich.net/v        http://www.taosecurity. </p>
<p class="calibre1">com/training.html        Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:20.0) Gecko/20100101 </p>
<p class="calibre1">Firefox/20.0 0       3195    200     OKw      -       -       -       (empty) -       -       </p>
<p class="calibre1">-       text/htmlx       -       -</p>
<p class="calibre1">#close  2013-04-23-20-06-19</p>
<p class="calibre1"> <i class="calibre4">Listing 13-15: Bro </i> http .log <i class="calibre4"> file for </i> bej-int .pcap <i class="calibre4"> with checksum validation disabled</i> Now we see not only the GET request u for  <i class="calibre4">http://www.bejtlich.net/</i> v but </p>
<p class="calibre1">also a record of the server’s 200 OK reply w and indication that the page </p>
<p class="calibre1">returned was  <i class="calibre4">text/html</i> x. You could perform similar analysis concerning </p>
<p class="calibre1">Bro’s handling of  <i class="calibre4">bej-ext.pcap</i> to see how it works when processing and ignor-</p>
<p class="calibre1">ing checksums. Listing 13-16 shows the results of the  <i class="calibre4">http.log</i> file when Bro </p>
<p class="calibre1">reads the  <i class="calibre4">bej-ext.pcap</i> trace file with checksum processing disabled. </p>
<p class="calibre1">$ <b class="calibre3">cat http.log</b></p>
<p class="calibre1">#separator \x09</p>
<p class="calibre1">#set_separator  , </p>
<p class="calibre1">#empty_field    (empty)</p>
<p class="calibre1">#unset_field    -</p>
<p class="calibre1">#path   http</p>
<p class="calibre1">#open   2013-04-24-00-36-03</p>
<p class="calibre1">#fields ts      uid     id.orig_h       id.orig_p       id.resp_h       id.resp_p       trans_</p>
<p class="calibre1">depth     method  host    uri     referrer        user_agent      request_body_len        </p>
<p class="calibre1">response_body_len       status_code     status_msg  info_code        info_msg        filename tags    username        password        proxied mime_type       md5     extraction_file</p>
<p class="calibre1">#types  time    string  addr    port    addr    port    count   string  string  string  string string  count   count   count   string  count   string  string  table[enum]     string  string table[string]   string  string  file</p>
<p class="calibre1">1366577618.269074       ua3JI6YJIxh     192.168.1.2     2770    205.186.148.46  80      </p>
<p class="calibre1">1       GET     www.bejtlich.net        /u              http://www.taosecurity.com/training.html Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:20.0) Gecko/20100101 Firefox/20.0 0       3195    </p>
<p class="calibre1">200     OKv      -       -       -       (empty) -       -       wVIA -&gt; 1.1 localhost:3128 </p>
<p class="calibre1">(squid/2.7.STABLE9),X-FORWARDED-FOR -&gt; 192.168.2.108x  text/html       -       -</p>
<p class="calibre1">#close  2013-04-24-00-36-04</p>
<p class="calibre1"> <i class="calibre4">Listing 13-16: Bro </i> http .log <i class="calibre4"> file for </i> bej-ext .pcap <i class="calibre4"> with checksum validation disabled</i> In Listing 13-16, the interesting fields are the GET request for / u, the </p>
<p class="calibre1">200 OK reply v from the server, the Via statement w revealing the presence </p>
<p class="calibre1">of the Squid proxy, and the X-Forwarded-For field x showing the true source </p>
<p class="calibre1">IP address of the web client. With access only to logs of this nature, you </p>
<p class="calibre1">could use the X-Forwarded-For field to identify the true source IP address </p>
<p class="calibre1">of a client if you saw activity only at location Y and needed to know which </p>
<p class="calibre1">browser was surfing to the web server in question. </p>
<p class="calibre1">Proxies and Checksums   <b class="calibre3">301</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p336"/>The moral of the checksum story is this: If you must collect traffic from a system that transmits traffic with checksum offloading, be sure your tools </p>
<p class="calibre1">know how to handle the situation. Remember that you can tell Bro to ignore </p>
<p class="calibre1">bad checksums with the -C switch. See the SO mailing list and wiki or the </p>
<p class="calibre1">manual pages for details on equivalent features in other tools. Snort, for </p>
<p class="calibre1">example, offers the following options to handle checksum processing:</p>
<p class="calibre1">-k &lt;mode&gt;  Checksum mode (all,noip,notcp,noudp,noicmp,none)</p>
<p class="calibre1">Now that you know how to handle the checksum offloading character-</p>
<p class="calibre1">istics of collecting traffic on this pfSense box running a Squid proxy, you </p>
<p class="calibre1">can use the data collected here for troubleshooting. Without taking into </p>
<p class="calibre1">account the checksum issue, you may have interpreted the traffic incor-</p>
<p class="calibre1">rectly and arrived at odd conclusions about network performance. </p>
<p class="calibre1"><b class="calibre3">conclusion</b></p>
<p class="calibre1">This chapter introduced two features of networks that might trouble ana-</p>
<p class="calibre1">lysts: proxies and checksums. Proxies are problematic because they intro-</p>
<p class="calibre1">duce another middlebox, adding complexity to the network. </p>
<p class="calibre1">Like NAT, proxies obscure true source and destination IP addresses. </p>
<p class="calibre1">Although this chapter showed only one proxy at work, some organizations </p>
<p class="calibre1">chain multiple proxies! Such a multiproxy scenario makes the supposed </p>
<p class="calibre1">Holy Grail of NSM and proxies—proxy logs—unattainable. When multiple </p>
<p class="calibre1">proxies are involved, no single log shows all the activity analysts need to see. </p>
<p class="calibre1">If proxy logs were available, however, they would make a useful addition to </p>
<p class="calibre1">the data collected by an application like ELSA. </p>
<p class="calibre1">We also discussed checksums and odd results caused by offloading. </p>
<p class="calibre1">This feature, designed to speed up networking, reveals a downside: zeroed </p>
<p class="calibre1">checksums when reported by a traffic capture tool. Although it’s easier to </p>
<p class="calibre1">engineer around this challenge, don’t be surprised if an eager analyst pro-</p>
<p class="calibre1">vides a trace file with one or both sides of a conversation containing 0x0000 </p>
<p class="calibre1">for the IP checksums. With the help of this chapter, you should understand </p>
<p class="calibre1">why that occurs and how to handle the issue. </p>
<p class="calibre1"><b class="calibre3">302</b>   Chapter 13</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p337"/><b class="calibre3">c o N c l u S i o N</b></p>
<p class="calibre1">I wrote this book to help readers start a net-</p>
<p class="calibre1">work security monitoring operation within </p>
<p class="calibre1">their organization. I used the open source </p>
<p class="calibre1">SO suite to show how to put NSM to work in a </p>
<p class="calibre1">rapid and cost-effective manner. This final section </p>
<p class="calibre1">of the book shows several other options for NSM and </p>
<p class="calibre1">related operations. My goal is to show how NSM applies to other areas of </p>
<p class="calibre1">digital defense and how I think NSM will adapt to increasingly complex </p>
<p class="calibre1">information processing requirements. </p>
<p class="calibre1">First, I discuss how cloud computing affects NSM. The cloud presents </p>
<p class="calibre1">challenges and opportunities, and awareness of both will help security man-</p>
<p class="calibre1">agers better defend their data. Second, I talk about the importance of work-</p>
<p class="calibre1">flow and why an operational, metrics-driven model is a key to CIRT success. </p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p338"/><b class="calibre3">cloud computing</b></p>
<p class="calibre1">The National Institute of Standards and Technology (NIST) defines cloud </p>
<p class="calibre1">computing as </p>
<p class="calibre1">a model for enabling ubiquitous, convenient, on-demand net-</p>
<p class="calibre1">work access to a shared pool of configurable computing resources </p>
<p class="calibre1">(e.g., networks, servers, storage, applications, and services) that </p>
<p class="calibre1">can be rapidly provisioned and released with minimal manage-</p>
<p class="calibre1">ment effort or service provider interaction.1</p>
<p class="calibre1">NIST describes three service models:</p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Software as a Service (SaaS)</b></i>  Allows the consumer to use the provider’s applications running on a cloud infrastructure. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Platform as a Service (PaaS)</b></i>  Allows the consumer to deploy consumer-</p>
<p class="calibre1">created applications or acquired applications created using program-</p>
<p class="calibre1">ming languages, libraries, services, and tools supported by the provider </p>
<p class="calibre1">onto the cloud infrastructure. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Infrastructure as a Service (IaaS)</b></i>  Gives the consumer access to processing, storage, networks, and other fundamental computing resources </p>
<p class="calibre1">where the consumer is able to deploy and run arbitrary software, which </p>
<p class="calibre1">can include operating systems and applications. </p>
<p class="calibre1">A SaaS offering, like Salesforce.com ( <i class="calibre4">http://www.salesforce.com/</i>), gives </p>
<p class="calibre1">customers an application that provides certain capabilities, such as cus-</p>
<p class="calibre1">tomer relationship management. A PaaS offering, like Heroku ( <i class="calibre4">http://</i></p>
<p class="calibre1"> <i class="calibre4">www.heroku.com/</i>), gives customers a set of programming languages and </p>
<p class="calibre1">related capabilities to build their own applications. An IaaS offering, like </p>
<p class="calibre1">Amazon Elastic Compute Cloud (EC2,  <i class="calibre4">https://aws.amazon.com/ec2</i>), gives </p>
<p class="calibre1">customers a virtual machine and related supporting infrastructure upon </p>
<p class="calibre1">which they can install their own software. </p>
<p class="calibre1">From an NSM perspective, a key feature of cloud computing is the fact </p>
<p class="calibre1">that information processing is being done “somewhere else.” One excep-</p>
<p class="calibre1">tion may be a “private” cloud, operated by an organization for internal use, </p>
<p class="calibre1">or a “community” cloud, operated by an organization cooperating with </p>
<p class="calibre1">partners. When a cloud is “public” or “hybrid,” though, it means an orga-</p>
<p class="calibre1">nization’s data is stored, manipulated, and transmitted beyond the normal </p>
<p class="calibre1">enterprise boundaries. While many security professionals have debated </p>
<p class="calibre1">cloud security and related topics, this section examines visibility challenges </p>
<p class="calibre1">posed by cloud computing. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Cloud Computing Challenges</b></i></p>
<p class="calibre1">With data processing occurring outside an organization, a CIRT cannot </p>
<p class="calibre1">rely on the network instrumentation models introduced in Chapter 2. </p>
<p class="calibre1">1. Peter Mell and Timothy Grance, “The NIST Definition of Cloud Computing,” NIST Special Publication 800-145, National Institute of Standards and Technology, U.S. Department of Commerce, September 2011,  <i class="calibre4">http://csrc.nist.gov/publications/nistpubs/800-145/SP800-145.pdf</i>. </p>
<p class="calibre1"><b class="calibre3">304</b>    Conclusion</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p339"/><img src="index-339_1.jpg" alt="Image 160" class="calibre2"/></p>
<p class="calibre1">Cloud users are not normally able to deploy taps or configure SPAN ports </p>
<p class="calibre1">to see traffic to or from a cloud provider’s infrastructure. By its very nature, </p>
<p class="calibre1">cloud infrastructures tend to be multitenant environments catering to hun-</p>
<p class="calibre1">dreds or thousands of customers on shared platforms. Even though you may </p>
<p class="calibre1">want to see network traffic to and from the platforms processing your data, </p>
<p class="calibre1">your cloud neighbors may not want you to see their traffic! </p>
<p class="calibre1">NSM is generally not an option for SaaS offerings because customers </p>
<p class="calibre1">interact with an application provided by a cloud company. Customers are </p>
<p class="calibre1">limited to relying upon whatever logs the cloud provider makes available. </p>
<p class="calibre1">NSM is also rarely possible for PaaS offerings, although customers can choose </p>
<p class="calibre1">to build application-level logging capabilities into the software they build </p>
<p class="calibre1">on the PaaS platform. NSM may be possible on IaaS offerings, but the visi-</p>
<p class="calibre1">bility is generally limited to specific virtual machines. NSM on IaaS requires </p>
<p class="calibre1">lightweight approaches where agents on the specific VM collect and analyze </p>
<p class="calibre1">network-centric data. </p>
<p class="calibre1">Threat Stack ( <i class="calibre4">http://www.threatstack.com/</i>) is an example of a  commercial </p>
<p class="calibre1">offering to meet the need for NSM on IaaS cloud platforms. Dustin Webber, </p>
<p class="calibre1">author of the Snorby tool, founded Threat Stackwith  Jen Andre to extend </p>
<p class="calibre1">Snorby beyond the enterprise. Threat Stack provides a lightweight agent that </p>
<p class="calibre1">collects and generates NSM information on individual endpoints, whether </p>
<p class="calibre1">in the enterprise or on IaaS cloud platforms. The Threat Stack agent reports </p>
<p class="calibre1">its findings to a cloud-based controller operated by the Threat Stack team. </p>
<p class="calibre1">When analysts want to investigate NSM data from the agents, they log into </p>
<p class="calibre1">a cloud application published by Threat Stack. Figure 1 depicts the Threat </p>
<p class="calibre1">Stack dashboard, showing data from an agent deployed on a virtual private </p>
<p class="calibre1">server. </p>
<p class="calibre1"> <i class="calibre4">Figure 1: Threat Stack dashboard</i></p>
<p class="calibre1">Conclusion   <b class="calibre3">305</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p340"/><img src="index-340_1.jpg" alt="Image 161" class="calibre2"/></p>
<p class="calibre1">Threat Stack demonstrates how a cloud-based challenge, like monitor-</p>
<p class="calibre1">ing IaaS platforms, can be met by using the cloud to collect and present </p>
<p class="calibre1">NSM data from agents. This hints at some of the benefits cloud computing </p>
<p class="calibre1">brings to NSM operators. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Cloud Computing Benefits</b></i></p>
<p class="calibre1">Cloud environments give analysts powerful and expandable environments </p>
<p class="calibre1">to process and mine NSM data. By putting NSM data in the cloud, storage </p>
<p class="calibre1">and analytical power become less of an issue. Analysts must be comfort-</p>
<p class="calibre1">able with the security controls applied by the cloud provider before putting </p>
<p class="calibre1">sensitive information in the hands of another company. If the provider can </p>
<p class="calibre1">meet those concerns, the cloud offers exciting possibilities. </p>
<p class="calibre1">Packetloop ( <i class="calibre4">http://www.packetloop.com/</i>) is an example of another com-</p>
<p class="calibre1">mercial offering built on the cloud, but with a different focus. Michael Baker </p>
<p class="calibre1">and his team in Australia built Packetloop as a cloud-based application to </p>
<p class="calibre1">analyze network traffic uploaded by users. Analysts can send network traffic </p>
<p class="calibre1">in bulk to Packetloop, which then processes and displays that traffic in various </p>
<p class="calibre1">ways. Figure 2 shows a Packetloop dashboard for the network traffic asso-</p>
<p class="calibre1">ciated with a Digital Corpora sample case ( <i class="calibre4">http://digitalcorpora.org/corpora/</i></p>
<p class="calibre1"> <i class="calibre4">scenarios/m57-patents-scenario/</i>). </p>
<p class="calibre1"> <i class="calibre4">Figure 2: Packetloop dashboard for sample network traffic</i></p>
<p class="calibre1">Threat Stack and Packetloop are options for enterprise users comfort-</p>
<p class="calibre1">able with sending local data to cloud providers. Perhaps more importantly, </p>
<p class="calibre1">these two offerings are suitable for customers who already do computing </p>
<p class="calibre1">in the cloud. In other words, customers doing work in the cloud are likely </p>
<p class="calibre1"><b class="calibre3">306</b>    Conclusion</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p341"/><img src="index-341_1.png" alt="Image 162" class="calibre2"/></p>
<p class="calibre1">to be comfortable sending logs or network traffic or both to another cloud </p>
<p class="calibre1">offering, such as a security vendor. As more computing work shifts from the </p>
<p class="calibre1">enterprise to the cloud, I expect this sort of “cloud-to-cloud” relationship to </p>
<p class="calibre1">become more important for security and monitoring needs. </p>
<p class="calibre1"><b class="calibre3">workflow, Metrics, and collaboration</b></p>
<p class="calibre1">NSM isn’t just about tools. NSM is an operation, and that concept implies </p>
<p class="calibre1">workflow, metrics, and collaboration. A  <i class="calibre4">workflow</i> establishes a series of steps that an analyst follows to perform the detection and response mission. </p>
<p class="calibre1"> <i class="calibre4">Metrics</i>, like the classification and count of incidents and the time elapsed </p>
<p class="calibre1">from incident detection to containment, measure the effectiveness of the </p>
<p class="calibre1">workflow.  <i class="calibre4">Collaboration</i> enables analysts to work smarter and faster. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Workflow and Metrics</b></i></p>
<p class="calibre1">The next generation of NSM tools will incorporate these key features. </p>
<p class="calibre1">Mandiant provides these capabilities in several of its commercial offerings. </p>
<p class="calibre1">The goal is to help customers more rapidly scope an intrusion, manage </p>
<p class="calibre1">the escalation and resolution process, and highlight areas of improvement. </p>
<p class="calibre1">Figure 3 shows a graph of two key incident response measurements. </p>
<p class="calibre1"> <i class="calibre4">Figure 3: Tracking open incidents versus the average time to close an incident</i></p>
<p class="calibre1">In Figure 3, we see a series of dots connected into a line, showing the </p>
<p class="calibre1">average time, in hours, required to close an incident. In this case, “closing” </p>
<p class="calibre1">means conducting short-term incident containment (STIC) to mitigate the </p>
<p class="calibre1">risk posed by an intruder who has compromised a computer. The bars show </p>
<p class="calibre1">the number of open incidents on a daily basis. The spike in open incidents </p>
<p class="calibre1">on April 23 caused the average closure time to spike as well. This indicates </p>
<p class="calibre1">that the CIRT was overwhelmed by the number of incidents it had to man-</p>
<p class="calibre1">age. If the organization’s goal for average closure time is 10 hours or less, </p>
<p class="calibre1">this spike demonstrates that the CIRT cannot meet such a goal when the </p>
<p class="calibre1">number of open incidents exceeds 10 daily cases. CIRT managers can use </p>
<p class="calibre1">these metrics to justify additional headcount or to adjust processes or tools </p>
<p class="calibre1">to keep the CIRT on track. </p>
<p class="calibre1">Conclusion   <b class="calibre3">307</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p342"/><img src="index-342_1.jpg" alt="Image 163" class="calibre2"/></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Collaboration</b></i></p>
<p class="calibre1">CIRTs that can manage many simultaneous intrusions often benefit from </p>
<p class="calibre1">powerful collaboration tools. Many analysts are familiar with wikis, chat </p>
<p class="calibre1">channels and clients, and other tools for exchanging incident data. A new </p>
<p class="calibre1">sort of collaboration tool combines processing NSM data with shared ana-</p>
<p class="calibre1">lytical capabilities. Just as online word processing applications like Google </p>
<p class="calibre1">Docs allow multiple users to collaborate simultaneously, some tools are </p>
<p class="calibre1">emerging to provide similar features to NSM operators. </p>
<p class="calibre1">CloudShark ( <i class="calibre4">http://www.cloudshark.org/</i>) is an example of a collabora-</p>
<p class="calibre1">tive packet analysis tool. The team at QA Cafe ( <i class="calibre4">http://www.qacafe.com/</i>) </p>
<p class="calibre1">built CloudShark as a platform that customers could deploy on-premise </p>
<p class="calibre1">and share among multiple team members. (Despite its name, CloudShark </p>
<p class="calibre1">doesn’t reside in the cloud; customers buy the software and deploy it within </p>
<p class="calibre1">their enterprise.2) Analysts upload packet captures to the local appliance </p>
<p class="calibre1">and then manipulate packet captures via a web browser. Figure 4 shows </p>
<p class="calibre1">an example of CloudShark rendering DNS and Online Certificate Status </p>
<p class="calibre1">Protocol (OCSP) traffic. </p>
<p class="calibre1"> <i class="calibre4">Figure 4: CloudShark displaying DNS and OCSP traffic</i></p>
<p class="calibre1">CloudShark appears very similar to Wireshark, so analysts will feel at </p>
<p class="calibre1">home in the interface. A CIRT could maintain a local CloudShark appli-</p>
<p class="calibre1">ance as a repository of key network traces derived from various intrusions. </p>
<p class="calibre1">2. The example in this section appears courtesy of CloudShark and Jeremy Stretch, who publish sample traces online at  <i class="calibre4">http://packetlife.net/captures/protocol/dns/</i> and  <i class="calibre4">http://www.cloudshark </i></p>
<p class="calibre1"> <i class="calibre4">.org/captures/46b2c8403863/</i> to demonstrate CloudShark’s capabilities. </p>
<p class="calibre1"><b class="calibre3">308</b>    Conclusion</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p343"/>For example, when Sguil retrieves traffic from a sensor to build a transcript, the server retains a local archive of the traffic. A CIRT could upload all of </p>
<p class="calibre1">those captures to CloudShark, making them easily available and browsable </p>
<p class="calibre1">by analysts. These analysts could also add comments to the trace via the </p>
<p class="calibre1">Info and Comments features and tag the trace with key names for later </p>
<p class="calibre1">reference. Being a local appliance, CloudShark may address some of the </p>
<p class="calibre1">concerns presented by pure cloud-based offerings as well. </p>
<p class="calibre1"><b class="calibre3">conclusion</b></p>
<p class="calibre1">This final part of the book showed examples of some of the NSM capabil-</p>
<p class="calibre1">ities found outside the SO suite. As CIRTs realize that the power of NSM </p>
<p class="calibre1">must be applied to cloud environments and can be augmented by cloud </p>
<p class="calibre1">and collaborative platforms, I expect to see more offerings leveraging </p>
<p class="calibre1">those capabilities. Threat Stack, Packetloop, Mandiant, and CloudShark </p>
<p class="calibre1">are a few examples of companies integrating NSM-related services into </p>
<p class="calibre1">their core offerings. With luck, these and other solution providers will </p>
<p class="calibre1">continue to put tools and processes into the hands of CIRTs worldwide. </p>
<p class="calibre1">It is possible to defeat adversaries if we stop them before they accomplish </p>
<p class="calibre1">their mission. As it has been since the early 1990s, NSM will continue to </p>
<p class="calibre1">be a powerful, cost-effective way to counter intruders. Take heart, CIRTs; </p>
<p class="calibre1">the future remains bright! </p>
<p class="calibre1">Conclusion   <b class="calibre3">309</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p344"/><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p345"/><b class="calibre3">S o  S c r i P T S   </b></p>
<p class="calibre1"><b class="calibre3">a N D   c o N f i g u r aT i o N</b></p>
<p class="calibre1"> <i class="calibre4">by Doug Burks, creator of Security Onion</i></p>
<p class="calibre1">This appendix provides a quick reference </p>
<p class="calibre1">to the Security Onion (SO) control scripts </p>
<p class="calibre1">and configuration files. This material will </p>
<p class="calibre1">help SO users better administer and optimize </p>
<p class="calibre1">their sensor deployments. </p>
<p class="calibre1"><b class="calibre3">So control Scripts</b></p>
<p class="calibre1">The NSM control scripts are one of the core components of SO. These </p>
<p class="calibre1">scripts were originally a part of the NSMnow package developed by the </p>
<p class="calibre1">SecurixLive team ( <i class="calibre4">http://www.securixlive.com/nsmnow/docs/index.php</i>), but </p>
<p class="calibre1">they have been heavily modified for use in SO. </p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p346"/>The NSM scripts were first developed to control a Sguil server (sguild), its agents (snort_agent, pads_agent, sancp_agent, and pcap_agent), and its sensor </p>
<p class="calibre1">components (snort, pads, sancp, and daemonlogger). The following are some of </p>
<p class="calibre1">the changes we’ve made to SO:</p>
<p class="calibre1">•  Added the ability to use Suricata instead of Snort</p>
<p class="calibre1">•  Added the ability to spin up multiple instances of Snort via PF_RING (and </p>
<p class="calibre1">an equal number of instances of barnyard2 and snort_agent)</p>
<p class="calibre1">•  Added control of Argus</p>
<p class="calibre1">•  Added control of Bro</p>
<p class="calibre1">•  Added control of Sguil’s OSSEC agent</p>
<p class="calibre1">•  Added control of Sguil’s HTTP agent</p>
<p class="calibre1">•  Replaced pads and sancp with prads</p>
<p class="calibre1">•  Replaced daemonlogger with netsniff-ng</p>
<p class="calibre1">The NSM scripts are installed at  <i class="calibre4">/usr/sbin/nsm*</i> and require root privi-</p>
<p class="calibre1">leges, so they should be run using sudo. The directory  <i class="calibre4">/usr/sbin/</i> should be </p>
<p class="calibre1">in your PATH variable, so you shouldn’t need to include the full path when </p>
<p class="calibre1">executing the commands. The full path is included in the examples here </p>
<p class="calibre1">for completeness. </p>
<p class="calibre1">We won’t cover every option for every script, but you can explore each </p>
<p class="calibre1">of these scripts using --help to learn more about them. For example, to see </p>
<p class="calibre1">more information about /usr/sbin/nsm, enter this command:</p>
<p class="calibre1">$ <b class="calibre3">sudo /usr/sbin/nsm --help</b></p>
<p class="calibre1">The NSMnow Administration scripts are designed to easily configure and manage</p>
<p class="calibre1">your NSM installation. Bugs, comments and flames can be directed to the</p>
<p class="calibre1">SXL team at dev@securixlive.com</p>
<p class="calibre1">The NSMnow Administration scripts come with ABSOLUTELY NO WARRANTY. </p>
<p class="calibre1">Usage: /usr/sbin/nsm [options]</p>
<p class="calibre1">Options:</p>
<p class="calibre1">-U         Check and apply any available upgrades</p>
<p class="calibre1">-V         Show version information</p>
<p class="calibre1">-?         Show usage information</p>
<p class="calibre1">Long Options:</p>
<p class="calibre1">--sensor          See nsm_sensor</p>
<p class="calibre1">--server          See nsm_server</p>
<p class="calibre1">--all             Performs actions on both sensor and server</p>
<p class="calibre1">--upgrade         Same as -U</p>
<p class="calibre1">--version         Same as -V</p>
<p class="calibre1">--help            Same as -? </p>
<p class="calibre1"><b class="calibre3">312</b>   Appendix</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p347"/> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm</b></i></p>
<p class="calibre1">The high-level /usr/sbin/nsm script can pass options to some of the under-</p>
<p class="calibre1">lying scripts such as nsm_server and nsm_sensor. To check the status of all </p>
<p class="calibre1">server and sensor processes, enter the following:</p>
<p class="calibre1">$ <b class="calibre3">sudo /usr/sbin/nsm --all --status</b></p>
<p class="calibre1">Status: securityonion</p>
<p class="calibre1">* sguil server                                                      [  OK  ]</p>
<p class="calibre1">Status: HIDS</p>
<p class="calibre1">* ossec_agent (sguil)                                               [  OK  ]</p>
<p class="calibre1">Status: Bro</p>
<p class="calibre1">Name       Type       Host       Status        Pid    Peers  Started              </p>
<p class="calibre1">bro        standalone localhost  running       13015  0      18 Feb 16:35:40  </p>
<p class="calibre1">Status: securityonion-eth1</p>
<p class="calibre1">* netsniff-ng (full packet data)                                    [  OK  ]</p>
<p class="calibre1">* pcap_agent (sguil)                                                [  OK  ]</p>
<p class="calibre1">* snort_agent-1 (sguil)                                             [  OK  ]</p>
<p class="calibre1">* snort-1 (alert data)                                              [  OK  ]</p>
<p class="calibre1">* barnyard2-1 (spooler, unified2 format)                            [  OK  ]</p>
<p class="calibre1">* prads (sessions/assets)                                           [  OK  ]</p>
<p class="calibre1">* sancp_agent (sguil)                                               [  OK  ]</p>
<p class="calibre1">* pads_agent (sguil)                                                [  OK  ]</p>
<p class="calibre1">* argus                                                             [  OK  ]</p>
<p class="calibre1">* http_agent (sguil)                                                [  OK  ]</p>
<p class="calibre1">/etc/init.d/nsm is a wrapper for “/usr/sbin/nsm –all”, so you can also do:</p>
<p class="calibre1">sudo service nsm status</p>
<p class="calibre1">In addition to status, you can use other process control keywords, such </p>
<p class="calibre1">as start, stop, and restart. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_al _del</b></i></p>
<p class="calibre1">The high-level /usr/sbin/nsm_all_del script will prompt for user confirmation, </p>
<p class="calibre1">and then call nsm_all_del_quick to delete all NSM data and configuration. </p>
<p class="calibre1">$ <b class="calibre3">sudo /usr/sbin/nsm_all_del</b></p>
<p class="calibre1">WARNING! </p>
<p class="calibre1">Continuing will permanently delete all NSM configuration and data! </p>
<p class="calibre1">Press Ctrl-C to cancel. </p>
<p class="calibre1">OR</p>
<p class="calibre1">Press Enter to continue. </p>
<p class="calibre1">Stopping: securityonion</p>
<p class="calibre1">* stopping: sguil server                                            [  OK  ]</p>
<p class="calibre1">Stopping: HIDS</p>
<p class="calibre1">* stopping: ossec_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">Stopping: Bro</p>
<p class="calibre1">stopping bro ... </p>
<p class="calibre1">SO Scripts and Configuration    <b class="calibre3">313</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p348"/>Stopping: securityonion-eth1</p>
<p class="calibre1">* stopping: netsniff-ng (full packet data)                          [  OK  ]</p>
<p class="calibre1">* stopping: pcap_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* stopping: snort_agent-1 (sguil)                                   [  OK  ]</p>
<p class="calibre1">* stopping: snort-1 (alert data)                                    [  OK  ]</p>
<p class="calibre1">* stopping: barnyard2-1 (spooler, unified2 format)                  [  OK  ]</p>
<p class="calibre1">* stopping: prads (sessions/assets)                                 [  OK  ]</p>
<p class="calibre1">* stopping: sancp_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">* stopping: pads_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* stopping: argus                                                   [  OK  ]</p>
<p class="calibre1">* stopping: http_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">Delete Sensor</p>
<p class="calibre1">All configurations and collected data for sensor "securityonion-eth1" will be deleted. </p>
<p class="calibre1">Deleting sensor: securityonion-eth1 </p>
<p class="calibre1">* removing configuration files                                      [  OK  ]</p>
<p class="calibre1">* removing collected data files                                     [  OK  ]</p>
<p class="calibre1">* updating the sensor table                                         [  OK  ]</p>
<p class="calibre1">Delete Server</p>
<p class="calibre1">All configurations and collected data for server "securityonion" will be </p>
<p class="calibre1">deleted. </p>
<p class="calibre1">Deleting server:ontinue? (Y/N) [N]: </p>
<p class="calibre1">* removing configuration files                                      [  OK  ]</p>
<p class="calibre1">* removing collected data files                                     [  OK  ]</p>
<p class="calibre1">* removing database                                                 [  OK  ]</p>
<p class="calibre1">* updating the server table                                         [  OK  ]</p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_al _del_quick</b></i></p>
<p class="calibre1">The high-level /usr/sbin/nsm_all_del_quick script will call nsm_sensor_del and </p>
<p class="calibre1">nsm_server_del to delete all NSM data and configuration, but will  <i class="calibre4">not</i> prompt </p>
<p class="calibre1">for user confirmation. Be careful with this one! </p>
<p class="calibre1">$ <b class="calibre3">sudo nsm_all_del_quick</b></p>
<p class="calibre1">Stopping: securityonion</p>
<p class="calibre1">* stopping: sguil server                                            [  OK  ]</p>
<p class="calibre1">Stopping: HIDS</p>
<p class="calibre1">* stopping: ossec_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">Stopping: Bro</p>
<p class="calibre1">stopping bro ... </p>
<p class="calibre1">Stopping: securityonion-eth1</p>
<p class="calibre1">* stopping: netsniff-ng (full packet data)                          [  OK  ]</p>
<p class="calibre1">* stopping: pcap_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* stopping: snort_agent-1 (sguil)                                   [  OK  ]</p>
<p class="calibre1">* stopping: snort-1 (alert data)                                    [  OK  ]</p>
<p class="calibre1"><b class="calibre3">314</b>   Appendix</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p349"/>  * stopping: barnyard2-1 (spooler, unified2 format)                  [  OK  ]</p>
<p class="calibre1">* stopping: prads (sessions/assets)                                 [  OK  ]</p>
<p class="calibre1">* stopping: sancp_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">* stopping: pads_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* stopping: argus                                                   [  OK  ]</p>
<p class="calibre1">* stopping: http_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">Delete Sensor</p>
<p class="calibre1">All configurations and collected data for sensor "securityonion-eth1" will be deleted. </p>
<p class="calibre1">Deleting sensor: securityonion-eth1 </p>
<p class="calibre1">* removing configuration files                                      [  OK  ]</p>
<p class="calibre1">* removing collected data files                                     [  OK  ]</p>
<p class="calibre1">* updating the sensor table                                         [  OK  ]</p>
<p class="calibre1">Delete Server</p>
<p class="calibre1">All configurations and collected data for server "securityonion" will be </p>
<p class="calibre1">deleted. </p>
<p class="calibre1">Deleting server:ontinue? (Y/N) [N]: </p>
<p class="calibre1">* removing configuration files                                      [  OK  ]</p>
<p class="calibre1">* removing collected data files                                     [  OK  ]</p>
<p class="calibre1">* removing database                                                 [  OK  ]</p>
<p class="calibre1">* updating the server table                                         [  OK  ]</p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_sensor</b></i></p>
<p class="calibre1">The high-level /usr/sbin/nsm_sensor script can pass options to some of the </p>
<p class="calibre1">underlying nsm_sensor_* scripts. </p>
<p class="calibre1">$ <b class="calibre3">sudo /usr/sbin/nsm_sensor --status</b></p>
<p class="calibre1">Status: HIDS</p>
<p class="calibre1">* ossec_agent (sguil)                                               [  OK  ]</p>
<p class="calibre1">Status: Bro</p>
<p class="calibre1">Name       Type       Host       Status        Pid    Peers  Started              </p>
<p class="calibre1">bro        standalone localhost  running       13015  0      18 Feb 16:35:40  </p>
<p class="calibre1">Status: securityonion-eth1</p>
<p class="calibre1">* netsniff-ng (full packet data)                                    [  OK  ]</p>
<p class="calibre1">* pcap_agent (sguil)                                                [  OK  ]</p>
<p class="calibre1">* snort_agent-1 (sguil)                                             [  OK  ]</p>
<p class="calibre1">* snort-1 (alert data)                                              [  OK  ]</p>
<p class="calibre1">* barnyard2-1 (spooler, unified2 format)                            [  OK  ]</p>
<p class="calibre1">* prads (sessions/assets)                                           [  OK  ]</p>
<p class="calibre1">* sancp_agent (sguil)                                               [  OK  ]</p>
<p class="calibre1">* pads_agent (sguil)                                                [  OK  ]</p>
<p class="calibre1">* argus                                                             [  OK  ]</p>
<p class="calibre1">* http_agent (sguil)                                                [  OK  ]</p>
<p class="calibre1">SO Scripts and Configuration    <b class="calibre3">315</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p350"/> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_sensor_add</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_sensor_add script is called by the setup wizard to add a new </p>
<p class="calibre1">sensor. You shouldn’t need to run this script manually. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_sensor_backup-config</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_sensor_backup-config script will back up sensor configura-</p>
<p class="calibre1">tion files to a user-specified tarball. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_sensor_backup-data</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_sensor_backup-data script will back up sensor datafiles to a </p>
<p class="calibre1">user-specified tarball. Keep in mind that datafiles consist of full packet cap-</p>
<p class="calibre1">ture and could be many gigabytes or terabytes. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_sensor_clean</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_sensor_clean script is called by an hourly cronjob. If disk </p>
<p class="calibre1">usage is at 90 percent or higher, the oldest day’s worth of NSM data (pcaps, </p>
<p class="calibre1">Bro logs, and so on) will be deleted until disk usage is below 90 percent. The </p>
<p class="calibre1">process is repeated until disk usage falls below 90 percent. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_sensor_clear</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_sensor_clear script clears all data from a sensor. </p>
<p class="calibre1">$ <b class="calibre3">sudo /usr/sbin/nsm_sensor_clear --sensor-name=securityonion-eth1</b></p>
<p class="calibre1">Clear Sensor</p>
<p class="calibre1">All collected data for sensor "securityonion-eth1" will be cleared. </p>
<p class="calibre1">Do you want to continue? (Y/N) [N]: <b class="calibre3">y</b></p>
<p class="calibre1">Clearing sensor: securityonion-eth1</p>
<p class="calibre1">* removing bookmarks                                                [  OK  ]</p>
<p class="calibre1">* removing collected data files                                     [  OK  ]</p>
<p class="calibre1">* removing collected log directories                                [  OK  ]</p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_sensor_del</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_sensor_del script removes all data and configuration for a </p>
<p class="calibre1">user-specified sensor, permanently disabling it. </p>
<p class="calibre1">$ <b class="calibre3">sudo /usr/sbin/nsm_sensor_del --sensor-name=securityonion-eth1</b></p>
<p class="calibre1">Delete Sensor</p>
<p class="calibre1">All configurations and collected data for sensor "securityonion-eth1" will be deleted. </p>
<p class="calibre1">Do you want to continue? (Y/N) [N]: <b class="calibre3">y</b></p>
<p class="calibre1"><b class="calibre3">316</b>   Appendix</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p351"/>Deleting sensor: securityonion-eth1</p>
<p class="calibre1">* removing configuration files                                      [  OK  ]</p>
<p class="calibre1">* removing collected data files                                     [  OK  ]</p>
<p class="calibre1">* updating the sensor table                                         [  OK  ]</p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_sensor_edit</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_sensor_edit script allows you to edit certain details of a </p>
<p class="calibre1">sensor’s configuration. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_sensor_ps-daily-restart</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_sensor_ps-daily-restart script is called by a daily cronjob at </p>
<p class="calibre1">midnight to restart any services that may be dealing with date-based output </p>
<p class="calibre1">and need to roll to a new date stamp. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_sensor_ps-restart</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_sensor_ps-restart script is used to restart sensor processes. </p>
<p class="calibre1">$ <b class="calibre3">sudo /usr/sbin/nsm_sensor_ps-restart</b></p>
<p class="calibre1">Restarting: HIDS</p>
<p class="calibre1">* stopping: ossec_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">* starting: ossec_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">Restarting: Bro</p>
<p class="calibre1">stopping bro ... </p>
<p class="calibre1">starting bro ... </p>
<p class="calibre1">Restarting: securityonion-eth1</p>
<p class="calibre1">* restarting with overlap: netsniff-ng (full packet data)</p>
<p class="calibre1">* starting: netsniff-ng (full packet data)                          [  OK  ]</p>
<p class="calibre1">- stopping old process: netsniff-ng (full packet data)            [  OK  ]</p>
<p class="calibre1">* stopping: pcap_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* starting: pcap_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* stopping: snort_agent-1 (sguil)                                   [  OK  ]</p>
<p class="calibre1">* starting: snort_agent-1 (sguil)                                   [  OK  ]</p>
<p class="calibre1">* stopping: snort-1 (alert data)                                    [  OK  ]</p>
<p class="calibre1">* starting: snort-1 (alert data)                                    [  OK  ]</p>
<p class="calibre1">* stopping: barnyard2-1 (spooler, unified2 format)                  [  OK  ]</p>
<p class="calibre1">* starting: barnyard2-1 (spooler, unified2 format)                  [  OK  ]</p>
<p class="calibre1">* stopping: prads (sessions/assets)                                 [  OK  ]</p>
<p class="calibre1">* starting: prads (sessions/assets)                                 [  OK  ]</p>
<p class="calibre1">* stopping: pads_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* starting: pads_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* stopping: sancp_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">* starting: sancp_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">* stopping: argus                                                   [  OK  ]</p>
<p class="calibre1">* starting: argus                                                   [  OK  ]</p>
<p class="calibre1">* stopping: http_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* starting: http_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">SO Scripts and Configuration    <b class="calibre3">317</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p352"/>Note that this and the remaining nsm_sensor_ps-* scripts allow you to be very granular in what sensors or processes you control. For example, notice </p>
<p class="calibre1">the --only-, --skip-, and --sensor-name= options in the following --help listing:</p>
<p class="calibre1">$ <b class="calibre3">sudo /usr/sbin/nsm_sensor_ps-restart --help</b></p>
<p class="calibre1">The NSMnow Administration scripts come with ABSOLUTELY NO WARRANTY. </p>
<p class="calibre1">Usage: /usr/sbin/nsm_sensor_ps-restart [options]</p>
<p class="calibre1">Options:</p>
<p class="calibre1">-d         Use dialog mode</p>
<p class="calibre1">-y         Force yes</p>
<p class="calibre1">-V         Show version information</p>
<p class="calibre1">-?         Show usage information</p>
<p class="calibre1">Long Options: </p>
<p class="calibre1">--sensor-name=&lt;name&gt;             Define specific sensor &lt;name&gt; to process</p>
<p class="calibre1">--only-barnyard2                 Only process barnyard2</p>
<p class="calibre1">--only-snort-alert               Only process snort alert</p>
<p class="calibre1">--only-pcap                      Only process packet logger</p>
<p class="calibre1">--only-argus                     Only process argus</p>
<p class="calibre1">--only-prads                     Only process prads</p>
<p class="calibre1">--only-bro                       Only process bro</p>
<p class="calibre1">--only-pcap-agent                Only process pcap_agent</p>
<p class="calibre1">--only-sancp-agent               Only process sancp_agent</p>
<p class="calibre1">--only-snort-agent               Only process snort_agent</p>
<p class="calibre1">--only-http-agent                Only process http_agent</p>
<p class="calibre1">--only-pads-agent                Only process pads_agent</p>
<p class="calibre1">--only-ossec-agent               Only process ossec_agent</p>
<p class="calibre1">--skip-barnyard2                 Skip processing of barnyard2</p>
<p class="calibre1">--skip-snort-alert               Skip processing of snort alert</p>
<p class="calibre1">--skip-pcap                      Skip processing of packet logger</p>
<p class="calibre1">--skip-argus                     Skip processing of argus</p>
<p class="calibre1">--skip-prads                     Skip processing of prads</p>
<p class="calibre1">--skip-bro                       Skip processing of bro</p>
<p class="calibre1">--skip-pcap-agent                Skip processing of pcap_agent</p>
<p class="calibre1">--skip-sancp-agent               Skip processing of sancp_agent</p>
<p class="calibre1">--skip-snort-agent               Skip processing of snort_agent</p>
<p class="calibre1">--skip-http-agent                Skip processing of http_agent</p>
<p class="calibre1">--skip-pads-agent                Skip processing of pads_agent</p>
<p class="calibre1">--skip-ossec-agent               Skip processing of ossec_agent</p>
<p class="calibre1">--if-stale                       Only restart processes that have crashed</p>
<p class="calibre1">--dialog                         Same as -d</p>
<p class="calibre1">--force-yes                      Same as -y</p>
<p class="calibre1">--version                        Same as -V</p>
<p class="calibre1">--help                           Same as -? </p>
<p class="calibre1"><b class="calibre3">318</b>   Appendix</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p353"/>For example, suppose you’ve just made changes to  <i class="calibre4">snort.conf</i>, and you want to restart Snort to make those changes take effect. Instead of restarting the entire stack, you could restart just the Snort process, as follows:</p>
<p class="calibre1">$ <b class="calibre3">sudo /usr/sbin/nsm_sensor_ps-restart --only-snort-alert</b></p>
<p class="calibre1">Restarting: securityonion-eth1</p>
<p class="calibre1">* stopping: snort-1 (alert data)                                    [  OK  ]</p>
<p class="calibre1">* starting: snort-1 (alert data)                                    [  OK  ]</p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_sensor_ps-start</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_sensor_ps-start script is used to start sensor processes. </p>
<p class="calibre1">$ <b class="calibre3">sudo /usr/sbin/nsm_sensor_ps-start</b></p>
<p class="calibre1">Starting: HIDS</p>
<p class="calibre1">* starting: ossec_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">Starting: Bro</p>
<p class="calibre1">starting bro ... </p>
<p class="calibre1">Starting: securityonion-eth1</p>
<p class="calibre1">* starting: netsniff-ng (full packet data)                          [  OK  ]</p>
<p class="calibre1">* starting: pcap_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* starting: snort_agent-1 (sguil)                                   [  OK  ]</p>
<p class="calibre1">* starting: snort-1 (alert data)                                    [  OK  ]</p>
<p class="calibre1">* starting: barnyard2-1 (spooler, unified2 format)                  [  OK  ]</p>
<p class="calibre1">* starting: prads (sessions/assets)                                 [  OK  ]</p>
<p class="calibre1">* starting: pads_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* starting: sancp_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">* starting: argus                                                   [  OK  ]</p>
<p class="calibre1">* starting: http_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* disk space currently at 26%</p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_sensor_ps-status</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_sensor_ps-status script is used to check the status of sensor </p>
<p class="calibre1">processes. </p>
<p class="calibre1">$ <b class="calibre3">sudo /usr/sbin/nsm_sensor_ps-status</b></p>
<p class="calibre1">Status: HIDS</p>
<p class="calibre1">* ossec_agent (sguil)                                               [  OK  ]</p>
<p class="calibre1">Status: Bro</p>
<p class="calibre1">Name       Type       Host       Status        Pid    Peers  Started              </p>
<p class="calibre1">bro        standalone localhost  running       15426  0      18 Feb 16:40:23  </p>
<p class="calibre1">Status: securityonion-eth1</p>
<p class="calibre1">* netsniff-ng (full packet data)                                    [  OK  ]</p>
<p class="calibre1">* pcap_agent (sguil)                                                [  OK  ]</p>
<p class="calibre1">* snort_agent-1 (sguil)                                             [  OK  ]</p>
<p class="calibre1">* snort-1 (alert data)                                              [  OK  ]</p>
<p class="calibre1">* barnyard2-1 (spooler, unified2 format)                            [  OK  ]</p>
<p class="calibre1">SO Scripts and Configuration    <b class="calibre3">319</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p354"/>  * prads (sessions/assets)                                           [  OK  ]</p>
<p class="calibre1">* sancp_agent (sguil)                                               [  OK  ]</p>
<p class="calibre1">* pads_agent (sguil)                                                [  OK  ]</p>
<p class="calibre1">* argus                                                             [  OK  ]</p>
<p class="calibre1">* http_agent (sguil)                                                [  OK  ]</p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_sensor_ps-stop</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_sensor_ps-stop script is used to stop sensor processes. </p>
<p class="calibre1">$ <b class="calibre3">sudo /usr/sbin/nsm_sensor_ps-stop</b></p>
<p class="calibre1">Stopping: HIDS</p>
<p class="calibre1">* stopping: ossec_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">Stopping: Bro</p>
<p class="calibre1">stopping bro ... </p>
<p class="calibre1">Stopping: securityonion-eth1</p>
<p class="calibre1">* stopping: netsniff-ng (full packet data)                          [  OK  ]</p>
<p class="calibre1">* stopping: pcap_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* stopping: snort_agent-1 (sguil)                                   [  OK  ]</p>
<p class="calibre1">* stopping: snort-1 (alert data)                                    [  OK  ]</p>
<p class="calibre1">* stopping: barnyard2-1 (spooler, unified2 format)                  [  OK  ]</p>
<p class="calibre1">* stopping: prads (sessions/assets)                                 [  OK  ]</p>
<p class="calibre1">* stopping: sancp_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">* stopping: pads_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* stopping: argus                                                   [  OK  ]</p>
<p class="calibre1">* stopping: http_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_server</b></i></p>
<p class="calibre1">The high-level /usr/sbin/nsm_server script can pass options to some of the </p>
<p class="calibre1">underlying nsm_server_* scripts. </p>
<p class="calibre1">$ <b class="calibre3">sudo /usr/sbin/nsm_server --status</b></p>
<p class="calibre1">Status: securityonion</p>
<p class="calibre1">* sguil server                                                      [  OK  ]</p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_server_add</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_server_add script is used by the setup wizard to create a </p>
<p class="calibre1">new Sguil server (sguild). You shouldn’t need to run this script manually. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_server_backup-config</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_server_backup-config script backs up the sguild configura-</p>
<p class="calibre1">tion files to a user-specified tarball. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_server_backup-data</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_server_backup-data script backs up the sguild data to a </p>
<p class="calibre1">user-specified tarball. </p>
<p class="calibre1"><b class="calibre3">320</b>   Appendix</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p355"/> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_server_clear</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_server_clear script clears all sguild data. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_server_del</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_server_del script permanently deletes the Sguil server </p>
<p class="calibre1">(sguild). </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_server_edit</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_server_edit script can be used to edit certain details of the </p>
<p class="calibre1">sguild configuration. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_server_ps-restart</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_server_ps-restart script can be used to restart sguild. </p>
<p class="calibre1">$ <b class="calibre3">sudo /usr/sbin/nsm_server_ps-restart</b></p>
<p class="calibre1">Restarting: securityonion</p>
<p class="calibre1">* stopping: sguil server                                            [  OK  ]</p>
<p class="calibre1">* starting: sguil server                                            [  OK  ]</p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_server_ps-start</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_server_ps-start script can be used to start sguild. </p>
<p class="calibre1">$ <b class="calibre3">sudo /usr/sbin/nsm_server_ps-start</b></p>
<p class="calibre1">Starting: securityonion</p>
<p class="calibre1">* starting: sguil server                                            [  OK  ]</p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_server_ps-status</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_server_ps-status script can be used to check the status of </p>
<p class="calibre1">sguild. </p>
<p class="calibre1">$ <b class="calibre3">sudo /usr/sbin/nsm_server_ps-status</b></p>
<p class="calibre1">Status: securityonion</p>
<p class="calibre1">* sguil server                                                      [  OK  ]</p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_server_ps-stop</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_server_ps-stop script can be used to stop sguild. </p>
<p class="calibre1">$ <b class="calibre3">sudo /usr/sbin/nsm_server_ps-stop</b></p>
<p class="calibre1">Stopping: securityonion</p>
<p class="calibre1">* stopping: sguil server                                            [  OK  ]</p>
<p class="calibre1">SO Scripts and Configuration    <b class="calibre3">321</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p356"/> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_server_sensor-add</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_server_sensor-add script is used to add a sensor to the </p>
<p class="calibre1">sguild configuration. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_server_sensor-del</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_server_sensor-del script is used to delete a sensor from the </p>
<p class="calibre1">sguild configuration. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/usr/sbin/nsm_server_user-add</b></i></p>
<p class="calibre1">The /usr/sbin/nsm_server_user-add script is used to add a new sguild user. </p>
<p class="calibre1">$ <b class="calibre3">sudo /usr/sbin/nsm_server_user-add</b></p>
<p class="calibre1">User Name</p>
<p class="calibre1">Enter the name of the new user that will be granted privilege to connect to </p>
<p class="calibre1">this server.: <b class="calibre3">richard</b></p>
<p class="calibre1">User Pass</p>
<p class="calibre1">Enter the password for the new user that will be granted privilege to connect </p>
<p class="calibre1">to this server.: </p>
<p class="calibre1">Verify: </p>
<p class="calibre1">Add User to Server</p>
<p class="calibre1">The following information has been collected:</p>
<p class="calibre1">server:      securityonion</p>
<p class="calibre1">user:        richard</p>
<p class="calibre1">Do you want to create? (Y/N) [Y]: <b class="calibre3">y</b></p>
<p class="calibre1">Adding user to server: richard =&gt; securityonion</p>
<p class="calibre1"><b class="calibre3">So configuration files</b></p>
<p class="calibre1">Configuration files control how SO applications operate. Administrators </p>
<p class="calibre1">can change the contents of some of these files to tailor how SO collects and </p>
<p class="calibre1">interprets NSM data. </p>
<p class="calibre1">The SO team configures SO with sensible defaults, but in some cases, </p>
<p class="calibre1">changes may be appropriate. This section describes SO’s configuration files, </p>
<p class="calibre1">including whether the SO team believes that administrators may sometimes </p>
<p class="calibre1">need to make changes to them. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/etc/nsm/</b></i></p>
<p class="calibre1"> <i class="calibre4">/etc/nsm/</i> is the main configuration directory. It contains the following:</p>
<p class="calibre1">administration.conf  </p>
<p class="calibre1">ossec/  </p>
<p class="calibre1">pulledpork/  </p>
<p class="calibre1">rules/  </p>
<p class="calibre1"><b class="calibre3">322</b>   Appendix</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p357"/>securityonion/</p>
<p class="calibre1">securityonion.conf  </p>
<p class="calibre1">sensortab  </p>
<p class="calibre1">servertab  </p>
<p class="calibre1">templates/</p>
<p class="calibre1">$HOSTNAME-$INTERFACE</p>
<p class="calibre1">The final entry in this list will vary based on your hostname and the </p>
<p class="calibre1">interfaces you choose to monitor. For example, the following is output from </p>
<p class="calibre1">my sensor named securityonion with a single monitored interface (eth1):</p>
<p class="calibre1">-rw-r--r--   1 root  root   247 Jul 24  2012 administration.conf</p>
<p class="calibre1">drwxr-xr-x   2 root  root  4.0K Feb 18 16:16 ossec</p>
<p class="calibre1">drwxr-xr-x   2 root  root  4.0K Dec 18 11:15 pulledpork</p>
<p class="calibre1">drwxr-xr-x   3 root  root  4.0K Feb 18 16:16 rules</p>
<p class="calibre1">drwxrwxr-x   3 sguil sguil 4.0K Feb 18 16:16 securityonion</p>
<p class="calibre1">-rw-r--r--   1 root  root    37 Feb 18 16:16 securityonion.conf</p>
<p class="calibre1">drwxrwxr-x   2 sguil sguil 4.0K Feb 18 16:17 securityonion-eth1</p>
<p class="calibre1">-rw-r--r--   1 root  root    31 Feb 18 16:16 sensortab</p>
<p class="calibre1">-rw-r--r--   1 root  root   349 Feb 18 16:16 servertab</p>
<p class="calibre1">drwxr-xr-x   8 root  root  4.0K Dec 18 11:14 templates</p>
<p class="calibre1">Let’s look at each of these files and directories in turn. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/etc/nsm/administration.conf</b></i></p>
<p class="calibre1">The  <i class="calibre4">/etc/nsm/administration.conf</i> file defines some filesystem locations for the NSM scripts. You should never need to change anything in this file. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/etc/nsm/ossec/</b></i></p>
<p class="calibre1">The  <i class="calibre4">/etc/nsm/ossec/</i> directory contains the OSSEC agent for Sguil (ossec_</p>
<p class="calibre1">agent.tcl) and its configuration file ( <i class="calibre4">ossec_agent.conf </i>). You probably won’t need to modify these files. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/etc/nsm/pul edpork/</b></i></p>
<p class="calibre1">The  <i class="calibre4">/etc/nsm/pulledpork/</i> directory contains the configuration files for </p>
<p class="calibre1">PulledPork, which is responsible for downloading IDS rulesets from the </p>
<p class="calibre1">Internet. The main configuration file for PulledPork is  <i class="calibre4">pulledpork.conf</i>, but </p>
<p class="calibre1">you’ll probably spend most of your time modifying  <i class="calibre4">disablesid.conf</i>,  <i class="calibre4">enablesid </i></p>
<p class="calibre1"> <i class="calibre4">.conf</i>, and  <i class="calibre4">modifysid.conf</i> to tune your ruleset. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/etc/nsm/rules/</b></i></p>
<p class="calibre1">The  <i class="calibre4">/etc/nsm/rules/</i> directory contains the IDS ruleset(s) downloaded </p>
<p class="calibre1">by PulledPork and associated files that control the sensor processes. When </p>
<p class="calibre1">PulledPork runs, it stores the rules in  <i class="calibre4">downloaded.rules</i>. Don’t modify this file manually because PulledPork will overwrite it automatically the next time it </p>
<p class="calibre1">runs. Instead, tune your ruleset using the files in  <i class="calibre4">/etc/nsm/pulledpork/</i>. </p>
<p class="calibre1">You can write your own rules and store them in  <i class="calibre4">local.rules</i>. To tune a </p>
<p class="calibre1">particular rule without totally disabling it, use  <i class="calibre4">threshold.conf</i>. To specify a SO Scripts and Configuration    <b class="calibre3">323</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p358"/>Berkeley Packet Filter (BPF) so that the sniffing processes will selectively ignore traffic from certain IP addresses, use  <i class="calibre4">bpf.conf</i>. Bro automatically </p>
<p class="calibre1">monitors this file for changes and will update it as needed. Other services </p>
<p class="calibre1">(such as Snort and Suricata, PRADS, and Netsniff-ng) will need to be </p>
<p class="calibre1">restarted for the change to take effect. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/etc/nsm/securityonion/</b></i></p>
<p class="calibre1">The  <i class="calibre4">/etc/nsm/securityonion/</i> directory contains the following Sguil server </p>
<p class="calibre1">(sguild) configuration files:</p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">autocat.conf</b></i>  Used to configure Sguil to automatically categorize </p>
<p class="calibre1">certain events. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">certs</b></i>  Contains the files used to secure communications between the </p>
<p class="calibre1">Sguil server (sguild) and its agents and clients. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">server.conf</b></i>  Contains some general settings used to start sguild and </p>
<p class="calibre1">should not need to be modified. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">sguild.access</b></i>  Used to control access to sguild. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">sguild.conf</b></i>  Contains general settings for sguild and probably doesn’t need to be changed. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">sguild.email</b></i>  Allows you to configure Sguil to automatically send email when certain events occur. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">sguild.queries</b></i>  Contains queries that can be accessed from the Sguil </p>
<p class="calibre1">client by selecting <b class="calibre3">Query</b>4<b class="calibre3">Standard Queries</b>. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">sguild.users</b></i>  This file should not be modified. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/etc/nsm/securityonion.conf</b></i></p>
<p class="calibre1">The  <i class="calibre4">/etc/nsm/securityonion.conf</i> file contains the IDS_ENGINE, DAYSTOKEEP, and ELSA settings, which let you change the intrusion detection system (IDS) </p>
<p class="calibre1">engine, the amount of time data is kept in the Sguil database, and whether </p>
<p class="calibre1">ELSA is enabled, respectively. </p>
<p class="calibre1">If you run the setup wizard and select Quick Setup, SO will default to </p>
<p class="calibre1">using Snort as the IDS engine. If you choose Advanced Setup, SO will ask if </p>
<p class="calibre1">you want to run Snort or Suricata. In either case, the setup wizard will set </p>
<p class="calibre1">the IDS_ENGINE variable. If you later decide to change your IDS engine, you </p>
<p class="calibre1">can stop all sensor processes, change the IDS_ENGINE setting, execute rule-</p>
<p class="calibre1">update, and then restart all sensor processes. </p>
<p class="calibre1">For example, suppose you ran the Quick Setup, giving you the default </p>
<p class="calibre1">of Snort. If you want to try Suricata, do the following:</p>
<p class="calibre1">$ <b class="calibre3">sudo nsm_sensor_ps-stop</b></p>
<p class="calibre1">Stopping: HIDS</p>
<p class="calibre1">* stopping: ossec_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">Stopping: Bro</p>
<p class="calibre1">waiting for lock ........ ok</p>
<p class="calibre1">stopping bro ... </p>
<p class="calibre1"><b class="calibre3">324</b>   Appendix</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p359"/>Stopping: securityonion-eth1</p>
<p class="calibre1">* stopping: netsniff-ng (full packet data)                          [  OK  ]</p>
<p class="calibre1">* stopping: pcap_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* stopping: snort_agent-1 (sguil)                                   [  OK  ]</p>
<p class="calibre1">* stopping: snort-1 (alert data)                                    [  OK  ]</p>
<p class="calibre1">* stopping: barnyard2-1 (spooler, unified2 format)                  [  OK  ]</p>
<p class="calibre1">* stopping: prads (sessions/assets)                                 [  OK  ]</p>
<p class="calibre1">* stopping: sancp_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">* stopping: pads_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* stopping: argus                                                   [  OK  ]</p>
<p class="calibre1">* stopping: http_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">$ <b class="calibre3">sudo sed -i 's|ENGINE=snort|ENGINE=suricata|g' /etc/nsm/securityonion.conf</b></p>
<p class="calibre1">$ <b class="calibre3">sudo rule-update &gt; /dev/null</b></p>
<p class="calibre1">$ <b class="calibre3">sudo nsm_sensor_ps-start</b></p>
<p class="calibre1">Starting: HIDS</p>
<p class="calibre1">* starting: ossec_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">Starting: Bro</p>
<p class="calibre1">starting bro ... </p>
<p class="calibre1">Starting: securityonion-eth1</p>
<p class="calibre1">* starting: netsniff-ng (full packet data)                          [  OK  ]</p>
<p class="calibre1">* starting: pcap_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* starting: snort_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">* starting: suricata (alert data)                                   [  OK  ]</p>
<p class="calibre1">* starting: barnyard2 (spooler, unified2 format)                    [  OK  ]</p>
<p class="calibre1">* starting: prads (sessions/assets)                                 [  OK  ]</p>
<p class="calibre1">* starting: pads_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* starting: sancp_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">* starting: argus                                                   [  OK  ]</p>
<p class="calibre1">* starting: http_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* disk space currently at 26%</p>
<p class="calibre1">The DAYSTOKEEP variable allows you to define the retention policy for the </p>
<p class="calibre1">Sguil database. A daily cronjob deletes any data in securityonion_db older than </p>
<p class="calibre1">$DAYSTOKEEP. The default is 365. </p>
<p class="calibre1">The ELSA variable is set when the setup wizard asks if you want to </p>
<p class="calibre1">enable ELSA. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/etc/nsm/sensortab</b></i></p>
<p class="calibre1">If the box is configured to monitor interfaces, this file contains the list of </p>
<p class="calibre1">interfaces to be monitored. To disable the sniffing processes on an interface, </p>
<p class="calibre1">you can temporarily stop interfaces as follows (replacing  <i class="calibre4">HOSTNAME-INTERFACE</i> </p>
<p class="calibre1">with your actual hostname and interface name):</p>
<p class="calibre1"><b class="calibre3">sudo nsm_sensor_ps-stop --sensor-name= <i class="calibre4">HOSTNAME-INTERFACE</i></b></p>
<p class="calibre1">SO Scripts and Configuration    <b class="calibre3">325</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p360"/>To disable an interface permanently, comment out the relevant line in </p>
<p class="calibre1"> <i class="calibre4">/etc/nsm/sensortab</i>. For example, suppose you ran the Quick Setup and were </p>
<p class="calibre1">monitoring eth1, but then decided to move the sensor components off to a </p>
<p class="calibre1">separate box, making this just a server and not a sensor. </p>
<p class="calibre1">$ <b class="calibre3">sudo nsm_sensor_ps-stop --sensor-name=securityonion-eth1</b></p>
<p class="calibre1">Stopping: HIDS</p>
<p class="calibre1">* stopping: ossec_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">Stopping: Bro</p>
<p class="calibre1">stopping bro ... </p>
<p class="calibre1">Stopping: securityonion-eth1</p>
<p class="calibre1">* stopping: netsniff-ng (full packet data)                          [  OK  ]</p>
<p class="calibre1">* stopping: pcap_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* stopping: snort_agent-1 (sguil)                                   [  OK  ]</p>
<p class="calibre1">* stopping: snort-1 (alert data)                                    [  OK  ]</p>
<p class="calibre1">* stopping: barnyard2-1 (spooler, unified2 format)                  [  OK  ]</p>
<p class="calibre1">* stopping: prads (sessions/assets)                                 [  OK  ]</p>
<p class="calibre1">* stopping: sancp_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">* stopping: pads_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* stopping: argus                                                   [  OK  ]</p>
<p class="calibre1">* stopping: http_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">$ <b class="calibre3">sudo sed -i 's|securityonion-eth1|#securityonion-eth1|g' /etc/nsm/sensortab</b> </p>
<p class="calibre1">$ <b class="calibre3">sudo service nsm status</b></p>
<p class="calibre1">Status: securityonion</p>
<p class="calibre1">* sguil server                                                      [  OK  ]</p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/etc/nsm/servertab</b></i></p>
<p class="calibre1">If the box is configured as a server, the  <i class="calibre4">/etc/nsm/servertab</i> file contains the internal name of the server (securityonion). </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/etc/nsm/templates/</b></i></p>
<p class="calibre1">The  <i class="calibre4">/etc/nsm/templates/</i> directory contains template files for barnyard2, </p>
<p class="calibre1">http_agent, prads, pulledpork, snort, and suricata. The setup wizard copies the </p>
<p class="calibre1">template files from these directories into the target directories and custom-</p>
<p class="calibre1">izes them using the choices you made during setup. You shouldn’t modify </p>
<p class="calibre1">these files. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/etc/nsm/$HOSTNAME-$INTERFACE/</b></i></p>
<p class="calibre1">You’ll have an /etc/nsm/$ <i class="calibre4">HOSTNAME</i>-$ <i class="calibre4">INTERFACE</i>/ directory for each interface that you choose to monitor. For example, suppose your hostname is securityonion </p>
<p class="calibre1">and you have a quad-port network interface card (eth0, eth1, eth2, and eth3), </p>
<p class="calibre1">but you choose to monitor only eth1 and eth2. You will have the following </p>
<p class="calibre1">sensor configuration directories:</p>
<p class="calibre1"><b class="calibre3">326</b>   Appendix</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p361"/>/etc/nsm/securityonion-eth1/</p>
<p class="calibre1">/etc/nsm/securityonion-eth2/</p>
<p class="calibre1">Let’s look at the files in each of these directories. </p>
<p class="calibre1"><b class="calibre3">barnyard2.conf</b></p>
<p class="calibre1">The  <i class="calibre4">barnyard2.conf</i> file configures barnyard2, the process used to pick up </p>
<p class="calibre1">unified2 output from Snort or Suricata and insert the alerts into Sguil, </p>
<p class="calibre1">Snorby, or ELSA. There may be multiple  <i class="calibre4">barnyard2.conf</i> files to handle </p>
<p class="calibre1">multiple instances of Snort. </p>
<p class="calibre1">You generally don’t need to modify this file unless you decide to add or </p>
<p class="calibre1">remove some of the outputs. For example, you might decide to stop sending </p>
<p class="calibre1">IDS alerts to ELSA, and forward them to a corporate security information </p>
<p class="calibre1">event management platform instead. </p>
<p class="calibre1"><b class="calibre3">bpf.conf files</b></p>
<p class="calibre1">A global configuration file called  <i class="calibre4">bpf.conf</i> at  <i class="calibre4">/etc/nsm/rules/bpf.conf</i> applies to all processes on all interfaces by default. Each process on each interface </p>
<p class="calibre1">has its own  <i class="calibre4">.bpf</i> file, but by default, the per-process  <i class="calibre4">.bpf</i> files are symlinked to the interface bpf, and the interface bpf is symlinked to the global  <i class="calibre4">bpf.conf</i>, as shown here:</p>
<p class="calibre1">lrwxrwxrwx 1 root root  8 Feb 18 16:16 bpf-bro.conf -&gt; bpf.conf</p>
<p class="calibre1">lrwxrwxrwx 1 root root 23 Feb 18 16:16 bpf.conf -&gt; /etc/nsm/rules/bpf.conf</p>
<p class="calibre1">lrwxrwxrwx 1 root root  8 Feb 18 16:16 bpf-ids.conf -&gt; bpf.conf</p>
<p class="calibre1">lrwxrwxrwx 1 root root  8 Feb 18 16:16 bpf-pcap.conf -&gt; bpf.conf</p>
<p class="calibre1">lrwxrwxrwx 1 root root  8 Feb 18 16:16 bpf-prads.conf -&gt; bpf.conf</p>
<p class="calibre1">To specify a bpf per-interface or per-process, simply replace the default </p>
<p class="calibre1">symlinks with the desired bpf files and restart services as necessary. </p>
<p class="calibre1"><b class="calibre3">http_agent.conf</b></p>
<p class="calibre1"> <i class="calibre4">http_agent</i> sends Bro HTTP logs into the Sguil database, and  <i class="calibre4">http_agent.conf</i> allows you to configure which HTTP logs are included. For example, you </p>
<p class="calibre1">may want to exclude high-traffic sites that your users normally visit in order </p>
<p class="calibre1">to avoid bloating the Sguil database. </p>
<p class="calibre1">If you’re running ELSA, you may want to disable http_agent altogether to </p>
<p class="calibre1">prevent duplication of effort, since all Bro HTTP logs can be found in ELSA. </p>
<p class="calibre1"><b class="calibre3">pads_agent.conf</b></p>
<p class="calibre1">The  <i class="calibre4">pads_agent.conf</i> file configures pads_agent, which takes asset data from </p>
<p class="calibre1">PRADS and inserts it into Sguil. You generally don’t need to change any-</p>
<p class="calibre1">thing here. </p>
<p class="calibre1">SO Scripts and Configuration    <b class="calibre3">327</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p362"/><b class="calibre3">pcap_agent.conf</b></p>
<p class="calibre1">The  <i class="calibre4">pcap_agent.conf</i> file configures the pcap_agent, which allows the Sguil </p>
<p class="calibre1">server to request a pcap from the sensor’s pcap store. You probably won’t </p>
<p class="calibre1">need to change anything here. </p>
<p class="calibre1"><b class="calibre3">prads.conf</b></p>
<p class="calibre1">The  <i class="calibre4">prads.conf</i> file configures PRADS, a replacement for PADS and SANCP. </p>
<p class="calibre1">PRADS creates both asset data and session data. If you’re monitoring </p>
<p class="calibre1">anything other than RFC 1918 address ranges, update the home_nets variable </p>
<p class="calibre1">in this file. </p>
<p class="calibre1"><b class="calibre3">sancp_agent.conf</b></p>
<p class="calibre1">The  <i class="calibre4">sancp_agent.conf</i> file configures the sancp_agent, which takes session data from PRADS and inserts it into Sguil. You probably won’t need to change </p>
<p class="calibre1">anything here. </p>
<p class="calibre1"><b class="calibre3">sensor.conf</b></p>
<p class="calibre1">The  <i class="calibre4">sensor.conf</i> file contains a few different variables referenced by the NSM </p>
<p class="calibre1">scripts when starting processes. Most settings should remain at their default, </p>
<p class="calibre1">but you may need to tune IDS_LB_PROCS, which controls how many PF_RING </p>
<p class="calibre1">load-balanced processes are instantiated for Snort and Suricata. The setup </p>
<p class="calibre1">wizard will automatically ask you how many PF_RING instances you would like </p>
<p class="calibre1">for Snort or Suricata and Bro (assuming you choose Advanced Setup and </p>
<p class="calibre1">you have multiple cores). </p>
<p class="calibre1">If you need to adjust this setting after setup, stop the NSM processes, </p>
<p class="calibre1">modify the IDS_LB_PROCS variable in  <i class="calibre4">sensor.conf</i>, and then restart the NSM processes. If you’re running Snort, the script automatically spawns $IDS_LB_PROCS </p>
<p class="calibre1">instances of Snort (using PF_RING), barnyard2, and snort_agent. If you’re run-</p>
<p class="calibre1">ning Suricata, the script automatically copies $IDS_LB_PROCS into  <i class="calibre4">suricata </i></p>
<p class="calibre1"> <i class="calibre4">.yaml</i>, and then Suricata spins up the PF_RING instances itself. Since Suricata is managing the PF_RING instances, it creates only one unified2 output, and </p>
<p class="calibre1">therefore only one instance of barnyard2 and snort_agent are needed. </p>
<p class="calibre1">In the following example, we start with the default of IDS_LB_PROCS=1, </p>
<p class="calibre1">increase the setting to 2, and then restart the NSM processes. Notice that we </p>
<p class="calibre1">end up with two snort processes, two snort_agent processes, and two barnyard2 </p>
<p class="calibre1">processes. </p>
<p class="calibre1">$ <b class="calibre3">sudo nsm_sensor_ps-stop</b></p>
<p class="calibre1">Stopping: HIDS</p>
<p class="calibre1">* stopping: ossec_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">Stopping: Bro</p>
<p class="calibre1">stopping bro ... </p>
<p class="calibre1">Stopping: securityonion-eth1</p>
<p class="calibre1">* stopping: netsniff-ng (full packet data)                          [  OK  ]</p>
<p class="calibre1">* stopping: pcap_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* stopping: snort_agent-1 (sguil)                                   [  OK  ]</p>
<p class="calibre1"><b class="calibre3">328</b>   Appendix</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p363"/>  * stopping: snort-1 (alert data)                                    [  OK  ]</p>
<p class="calibre1">* stopping: barnyard2-1 (spooler, unified2 format)                  [  OK  ]</p>
<p class="calibre1">* stopping: prads (sessions/assets)                                 [  OK  ]</p>
<p class="calibre1">* stopping: sancp_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">* stopping: pads_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* stopping: argus                                                   [  OK  ]</p>
<p class="calibre1">* stopping: http_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">$ <b class="calibre3">sudo sed -i 's|IDS_LB_PROCS=1|IDS_LB_PROCS=2|g' /etc/nsm/securityonion-eth1/</b></p>
<p class="calibre1"><b class="calibre3">sensor.conf </b></p>
<p class="calibre1">$ <b class="calibre3">sudo nsm_sensor_ps-start</b></p>
<p class="calibre1">Starting: HIDS</p>
<p class="calibre1">* starting: ossec_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">Starting: Bro</p>
<p class="calibre1">starting bro ... </p>
<p class="calibre1">Starting: securityonion-eth1</p>
<p class="calibre1">* starting: netsniff-ng (full packet data)                          [  OK  ]</p>
<p class="calibre1">* starting: pcap_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* starting: snort_agent-1 (sguil)                                   [  OK  ]</p>
<p class="calibre1">* starting: snort_agent-2 (sguil)                                   [  OK  ]</p>
<p class="calibre1">* starting: snort-1 (alert data)                                    [  OK  ]</p>
<p class="calibre1">* starting: snort-2 (alert data)                                    [  OK  ]</p>
<p class="calibre1">* starting: barnyard2-1 (spooler, unified2 format)                  [  OK  ]</p>
<p class="calibre1">* starting: barnyard2-2 (spooler, unified2 format)                  [  OK  ]</p>
<p class="calibre1">* starting: prads (sessions/assets)                                 [  OK  ]</p>
<p class="calibre1">* starting: pads_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* starting: sancp_agent (sguil)                                     [  OK  ]</p>
<p class="calibre1">* starting: argus                                                   [  OK  ]</p>
<p class="calibre1">* starting: http_agent (sguil)                                      [  OK  ]</p>
<p class="calibre1">* disk space currently at 26%</p>
<p class="calibre1">As a sidenote, if you want to change the number of load-balanced pro-</p>
<p class="calibre1">cesses for Bro, edit  <i class="calibre4">/opt/bro/etc/node.cfg</i> and change the lb_procs variable, </p>
<p class="calibre1">and then issue the following commands:</p>
<p class="calibre1"><b class="calibre3">sudo broctl install</b></p>
<p class="calibre1"><b class="calibre3">sudo broctl restart</b></p>
<p class="calibre1"><b class="calibre3">snort_agent.conf</b></p>
<p class="calibre1">The  <i class="calibre4">snort_agent.conf</i> file configures the snort_agent, which takes alerts from barnyard2 and inserts them into the Sguil database. You probably don’t need </p>
<p class="calibre1">to change anything here. </p>
<p class="calibre1">There may be multiple  <i class="calibre4">snort_agent.conf</i> files to handle multiple instances </p>
<p class="calibre1">of Snort. </p>
<p class="calibre1"><b class="calibre3">snort.conf</b></p>
<p class="calibre1">The  <i class="calibre4">snort.conf</i> file configures Snort. Even if you’ve set IDS_LB_PROCS greater than 1, there will be only one  <i class="calibre4">snort.conf</i> file, to ensure that Snort instances on the same interface are configured identically. </p>
<p class="calibre1">SO Scripts and Configuration    <b class="calibre3">329</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p364"/><b class="calibre3">suricata.yaml</b></p>
<p class="calibre1">The  <i class="calibre4">suricata.yaml</i> file configures Suricata. The NSM scripts copy $IDS_LB_PROCS </p>
<p class="calibre1">from  <i class="calibre4">sensor.conf</i> into  <i class="calibre4">suricata.yaml</i>, and then Suricata spins up the PF_RING </p>
<p class="calibre1">instances itself. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/etc/cron.d/</b></i></p>
<p class="calibre1">The  <i class="calibre4">/etc/cron.d/</i> directory contains some important cronjobs, so let’s look at each of these. </p>
<p class="calibre1"><b class="calibre3">bro  </b>This cronjob runs the recommended broctl cron every five minutes </p>
<p class="calibre1">to ensure that Bro is running properly. </p>
<p class="calibre1"><b class="calibre3">elsa  </b>This cronjob runs the default ELSA cronjob every minute. </p>
<p class="calibre1"><b class="calibre3">nsm-watchdog  </b>This cronjob checks the NSM sensor processes every five </p>
<p class="calibre1">minutes, and restarts them if they have failed. </p>
<p class="calibre1"><b class="calibre3">rule-update  </b>This cronjob runs rule-update at 7:01 am Universal Coordinated </p>
<p class="calibre1">Time (UTC). If the NSM box is a stand-alone or server, rule-update will </p>
<p class="calibre1">use PulledPork to download a new IDS ruleset from the Internet. If the </p>
<p class="calibre1">box is a sensor, it will wait a few minutes for the server download to com-</p>
<p class="calibre1">plete, and then use scp to copy the new IDS ruleset from the server to the </p>
<p class="calibre1">local sensor. This script also copies tuning files such as  <i class="calibre4">threshold.conf</i> and <i class="calibre4">bpf.conf</i>, allowing you to make changes in one place (your central server) </p>
<p class="calibre1">that will apply to all of your distributed sensors automatically. </p>
<p class="calibre1"><b class="calibre3">sensor-clean  </b>This is an hourly cronjob that prevents full packet capture </p>
<p class="calibre1">and other logfiles from filling your disk. If disk usage is above 90 per-</p>
<p class="calibre1">cent, the oldest day’s worth of NSM data (pcaps, Bro logs, and so on) </p>
<p class="calibre1">are deleted. This is repeated until the disk usage is below 90 percent. </p>
<p class="calibre1"><b class="calibre3">sensor-newday  </b>This daily cronjob runs at midnight to restart any services </p>
<p class="calibre1">that may be dealing with date-based output and need to roll to a new </p>
<p class="calibre1">date stamp. </p>
<p class="calibre1"><b class="calibre3">sguil-db-purge  </b>This daily cronjob runs at 5:01 am UTC and performs </p>
<p class="calibre1">database maintenance, including deleting any data older than $DAYSTOKEEP </p>
<p class="calibre1">(as defined in  <i class="calibre4">/etc/nsm/securityonion.conf</i>) and repairing any corrupted </p>
<p class="calibre1">MySQL tables. </p>
<p class="calibre1"><b class="calibre3">squert-ip2c  </b>This cronjob updates Squert’s IP-to-country (GeoIP) </p>
<p class="calibre1">mappings. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Bro</b></i></p>
<p class="calibre1">Bro is installed in  <i class="calibre4">/opt/bro/</i> and its configuration files can be found in </p>
<p class="calibre1"> <i class="calibre4">/opt/bro/etc/</i>. </p>
<p class="calibre1"><b class="calibre3">330</b>   Appendix</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p365"/> <i class="calibre4"><b class="calibre3">CapMe</b></i></p>
<p class="calibre1">CapMe is a PHP-based web interface used to pull ASCII transcripts of TCP </p>
<p class="calibre1">sessions. Its PHP scripts and other resource files can be found in  <i class="calibre4">/var/www/</i></p>
<p class="calibre1"> <i class="calibre4">capme/</i>. Generally, these files do not need to be modified. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">ELSA</b></i></p>
<p class="calibre1">ELSA’s core files can be found in  <i class="calibre4">/opt/elsa/</i>. Generally, you may need to </p>
<p class="calibre1">modify settings in its two main configuration files:</p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/etc/elsa_web.conf</b></i>  This file configures the Apache web frontend of </p>
<p class="calibre1">ELSA. It will be present if you chose a stand-alone or server installation </p>
<p class="calibre1">and chose to enable ELSA. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/etc/elsa_node.conf</b></i>  This file configures the log node backend of ELSA. </p>
<p class="calibre1">It will be present if you chose a stand-alone or sensor installation and </p>
<p class="calibre1">enabled ELSA. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Squert</b></i></p>
<p class="calibre1">Squert is a web interface for the Sguil database written in PHP. The PHP </p>
<p class="calibre1">scripts and other resource files can be found in  <i class="calibre4">/var/www/squert/</i>. You gen-</p>
<p class="calibre1">erally don’t need to modify anything in this directory. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Snorby</b></i></p>
<p class="calibre1">Snorby is a web interface for IDS alerts written using Ruby on Rails. Its </p>
<p class="calibre1">scripts and other resource files can be found in  <i class="calibre4">/opt/snorby/</i>. Configuration </p>
<p class="calibre1">files can be found in  <i class="calibre4">/opt/snorby/config/</i>. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Syslog-ng</b></i></p>
<p class="calibre1">Syslog-ng is used by ELSA, and its configuration files can be found in </p>
<p class="calibre1"> <i class="calibre4">/etc/syslog-ng/</i>. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">/etc/network/interfaces</b></i></p>
<p class="calibre1">The  <i class="calibre4">/etc/network/interfaces</i> file configures your network interfaces. The </p>
<p class="calibre1">setup wizard will automatically configure this file for you if you choose </p>
<p class="calibre1"><b class="calibre3">Yes, configure /etc/network/interfaces</b>. </p>
<p class="calibre1">You’ll want a management interface (preferably connected to a dedi-</p>
<p class="calibre1">cated management network) using either DHCP or preferably static IP. If </p>
<p class="calibre1">your management interface uses DHCP and you have Bro in cluster mode, </p>
<p class="calibre1">it will complain whenever your DHCP address changes, and you’ll need </p>
<p class="calibre1">to update your IP address in Bro’s  <i class="calibre4">node.cfg</i> file. A static IP is highly recommended to prevent this problem. </p>
<p class="calibre1">SO Scripts and Configuration    <b class="calibre3">331</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p366"/>You’ll want one or more interfaces dedicated to sniffing, with no </p>
<p class="calibre1">IP addresses. Network interface card offloading functions such as tso, </p>
<p class="calibre1">gso, and gro should be disabled to ensure that Snort and Suricata get an </p>
<p class="calibre1">accurate view of the traffic (see  <i class="calibre4">http://securityonion.blogspot.com/2011/10/</i></p>
<p class="calibre1"> <i class="calibre4">when-is-full-packet-capture-not-full.html</i>). </p>
<p class="calibre1">The following are some sample  <i class="calibre4">network/interfaces</i> entries. </p>
<p class="calibre1">auto lo</p>
<p class="calibre1">iface lo inet loopback</p>
<p class="calibre1"># Management interface using DHCP (not recommended due to Bro issue described above)</p>
<p class="calibre1">auto eth0</p>
<p class="calibre1">iface eth0 inet dhcp</p>
<p class="calibre1"># OR </p>
<p class="calibre1"># Management interface using STATIC IP (instead of DHCP)</p>
<p class="calibre1">auto eth0</p>
<p class="calibre1">iface eth0 inet static</p>
<p class="calibre1">address 192.168.1.14</p>
<p class="calibre1">gateway 192.168.1.1</p>
<p class="calibre1">netmask 255.255.255.0</p>
<p class="calibre1">network 192.168.1.0</p>
<p class="calibre1">broadcast 192.168.1.255</p>
<p class="calibre1">dns-nameservers 192.168.1.1 192.168.1.2</p>
<p class="calibre1"># AND one or more of the following</p>
<p class="calibre1"># Connected to TAP or SPAN port for traffic monitoring</p>
<p class="calibre1">auto eth1</p>
<p class="calibre1">iface eth1 inet manual</p>
<p class="calibre1">up ifconfig $IFACE -arp up</p>
<p class="calibre1">up ip link set $IFACE promisc on</p>
<p class="calibre1">down ip link set $IFACE promisc off</p>
<p class="calibre1">down ifconfig $IFACE down</p>
<p class="calibre1">post-up for i in rx tx sg tso ufo gso gro lro; do ethtool -K $IFACE $i off; done</p>
<p class="calibre1">post-up echo 1 &gt; /proc/sys/net/ipv6/conf/$IFACE/disable_ipv6</p>
<p class="calibre1"><b class="calibre3">updating So </b></p>
<p class="calibre1">Two aspects of updating SO deserve mention: keeping the platform up-to-</p>
<p class="calibre1">date and keeping MySQL up-to-date. </p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">Updating the SO Distribution</b></i></p>
<p class="calibre1">Since all SO packages are in a standard Ubuntu Launchpad Personal Package </p>
<p class="calibre1">Archive (PPA), you can use standard Ubuntu package management tools to </p>
<p class="calibre1">update all packages. You can use the graphical Update Manager, or update </p>
<p class="calibre1">from the command line like this:</p>
<p class="calibre1"><b class="calibre3">sudo apt-get update &amp;&amp; sudo apt-get dist-upgrade</b></p>
<p class="calibre1"><b class="calibre3">332</b>   Appendix</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p367"/> <i class="calibre4"><b class="calibre3">Updating MySQL</b></i></p>
<p class="calibre1">Updating the Ubuntu MySQL packages can be problematic due to autossh </p>
<p class="calibre1">port forwarding and other issues. Here’s the recommended procedure to </p>
<p class="calibre1">ensure a smooth MySQL update. </p>
<p class="calibre1">1.  Stop all services:</p>
<p class="calibre1"><b class="calibre3">sudo service nsm stop</b></p>
<p class="calibre1"><b class="calibre3">sudo service syslog-ng stop</b></p>
<p class="calibre1"><b class="calibre3">sudo service apache2 stop</b></p>
<p class="calibre1"><b class="calibre3">sudo pkill autossh</b></p>
<p class="calibre1"><b class="calibre3">sudo pkill perl</b></p>
<p class="calibre1">2.  Check the process listing and verify that all  <i class="calibre4">nsm/syslog-ng/apache/autossh/</i></p>
<p class="calibre1"> <i class="calibre4">perl</i> processes have stopped:</p>
<p class="calibre1"><b class="calibre3">ps aux</b></p>
<p class="calibre1">3.  Install the MySQL updates. Other updates (such as  <i class="calibre4">securityonion-snorby</i>) </p>
<p class="calibre1">may require MySQL to be running, so update MySQL by itself:</p>
<p class="calibre1"><b class="calibre3">sudo apt-get update &amp;&amp; sudo apt-get install mysql-server mysql-server-core-5.5 mysql-server-5.5</b></p>
<p class="calibre1">4.  Reboot the system:</p>
<p class="calibre1"><b class="calibre3">sudo reboot</b></p>
<p class="calibre1">SO Scripts and Configuration    <b class="calibre3">333</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p368"/><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p369"/><b class="calibre3">i N D e x</b></p>
<p class="calibre1"><b class="calibre3">a</b></p>
<p class="calibre1">Argus</p>
<p class="calibre1">as alternative to NetFlow, 202</p>
<p class="calibre1">Address Resolution Protocol (ARP), </p>
<p class="calibre1">counting bytes in session data </p>
<p class="calibre1">16, 140–142</p>
<p class="calibre1">using, 169</p>
<p class="calibre1">address translation, 42–45</p>
<p class="calibre1">as data collection tool, 115</p>
<p class="calibre1"> <i class="calibre4">administration.conf</i>, 322–323</p>
<p class="calibre1">log storage location, 106</p>
<p class="calibre1">administrators, as within IDC, 203–204</p>
<p class="calibre1">and Ra client, 128–133</p>
<p class="calibre1">Advanced Package Tool (APT), 65</p>
<p class="calibre1">and Racluster client, 130–132, 248</p>
<p class="calibre1">Advanced Persistent Threat (APT), 193</p>
<p class="calibre1">as source of session data, 22, 248</p>
<p class="calibre1">APT1, 193, 202, 277–278.  <i class="calibre4">See also</i> </p>
<p class="calibre1">ARIN (American Registry for Internet </p>
<p class="calibre1">APT1 module</p>
<p class="calibre1">Numbers), 40</p>
<p class="calibre1">resources, 190</p>
<p class="calibre1">ARP (Address Resolution Protocol), </p>
<p class="calibre1">adversary simulation, 187</p>
<p class="calibre1">16, 140–142</p>
<p class="calibre1">Air Force Computer Emergency </p>
<p class="calibre1">AS (autonomous system), 28</p>
<p class="calibre1">Response Team </p>
<p class="calibre1">ASIM (Automated Security Incident </p>
<p class="calibre1">(AFCERT), 3</p>
<p class="calibre1">Measurement), 3</p>
<p class="calibre1">alert data, 28–30</p>
<p class="calibre1">asset-centric security, 199</p>
<p class="calibre1">American Registry for Internet </p>
<p class="calibre1">associate analyst, in ATI, 203–204</p>
<p class="calibre1">Numbers (ARIN), 40</p>
<p class="calibre1">ATI (Applied Threat Intelligence) </p>
<p class="calibre1">Amin, Rohan, 190</p>
<p class="calibre1">Center, 203–204</p>
<p class="calibre1">analysis, as element of detection phase, </p>
<p class="calibre1"> <i class="calibre4">autocat.conf</i>, 324</p>
<p class="calibre1">188, 193–195</p>
<p class="calibre1">autonomous system (AS), 28</p>
<p class="calibre1">“anatomy of a hack,” 190–191</p>
<p class="calibre1">autossh, as tunnel for SO data, 84, </p>
<p class="calibre1">Andre, Jen, 305</p>
<p class="calibre1">97, 333</p>
<p class="calibre1">Applied Threat Intelligence (ATI) </p>
<p class="calibre1">Automated Security Incident </p>
<p class="calibre1">Center, 203–204</p>
<p class="calibre1">Measurement (ASIM), 3</p>
<p class="calibre1">APT (Advanced Package Tool), 65</p>
<p class="calibre1">APT (Advanced Persistent Threat), 193</p>
<p class="calibre1">APT1, 193, 202, 277–278.  <i class="calibre4">See also</i> </p>
<p class="calibre1"><b class="calibre3">B</b></p>
<p class="calibre1">APT1 module</p>
<p class="calibre1">Baker, Michael, 306</p>
<p class="calibre1">resources, 190</p>
<p class="calibre1"> <i class="calibre4">barnyard2.conf</i>, 327</p>
<p class="calibre1">APT1 module, 278</p>
<p class="calibre1">Berkeley Packet Filter (BPF), 118–123, </p>
<p class="calibre1">installing, 280</p>
<p class="calibre1">130, 230, 280</p>
<p class="calibre1">testing, 280–283</p>
<p class="calibre1">Bianco, David, 32, 193</p>
<p class="calibre1">using, 278–279</p>
<p class="calibre1">BPF (Berkeley Packet Filter), 118–123, </p>
<p class="calibre1">apt-get</p>
<p class="calibre1">130, 230, 280</p>
<p class="calibre1">and configuring SO sensor, 94</p>
<p class="calibre1"> <i class="calibre4">bpf-bro.conf</i>, 327</p>
<p class="calibre1">installing APT1 module, 280</p>
<p class="calibre1"> <i class="calibre4">bpf.conf</i>, 324, 327</p>
<p class="calibre1">and setting up an SO server, 89–90</p>
<p class="calibre1">breaches</p>
<p class="calibre1">for updating packages, 64, 77, 80, </p>
<p class="calibre1">classification of, 194, 208, 219, </p>
<p class="calibre1">88–90, 94, 101</p>
<p class="calibre1">232, 237</p>
<p class="calibre1">upgrade vs. dist-upgrade, 65–66</p>
<p class="calibre1">inevitability of, 5</p>
<p class="calibre1">architects, as within IDC, 203–204</p>
<p class="calibre1">and notifications, 196–197</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p370"/>Bro</p>
<p class="calibre1">cloud computing, 304–307</p>
<p class="calibre1">as alternative to NetFlow, 202</p>
<p class="calibre1">CloudShark, 308</p>
<p class="calibre1">APT1 module, 278</p>
<p class="calibre1">collection, as element of detection </p>
<p class="calibre1">installing, 280</p>
<p class="calibre1">phase, 188–191</p>
<p class="calibre1">testing, 280–283</p>
<p class="calibre1">Combs, Gerald, 122</p>
<p class="calibre1">using, 278–279</p>
<p class="calibre1">command-and-control (C2) channel, </p>
<p class="calibre1"> <i class="calibre4">capture_loss.log</i>, 243–244</p>
<p class="calibre1">190–194, 208, 237, 250–251</p>
<p class="calibre1">checksum validation with, 298–302</p>
<p class="calibre1">compromises</p>
<p class="calibre1">creating hashes of executables </p>
<p class="calibre1">client-side, 235–237</p>
<p class="calibre1">with, 264</p>
<p class="calibre1">phases of, 190</p>
<p class="calibre1">counting bytes in session data, 169</p>
<p class="calibre1">server-side, 207–208</p>
<p class="calibre1">as data collection tool, 115</p>
<p class="calibre1">computer incident response team </p>
<p class="calibre1">DNS logs generated by, 225–226, </p>
<p class="calibre1">(CIRT), 4, 203–205</p>
<p class="calibre1">244–246</p>
<p class="calibre1"> <i class="calibre4">conn.log</i>, as generated by Bro, 21, </p>
<p class="calibre1">extracting binaries with, 266–273</p>
<p class="calibre1">242–243</p>
<p class="calibre1">FTP logs generated by, 228–229</p>
<p class="calibre1">Constituent Relations Team, 203, 205</p>
<p class="calibre1">integration with Malware Hash </p>
<p class="calibre1">containment</p>
<p class="calibre1">Registry, 285–288</p>
<p class="calibre1">speed of, 199–200</p>
<p class="calibre1">log storage location for, 106</p>
<p class="calibre1">techniques for, 198</p>
<p class="calibre1">restarting with broctl, 275–277, 283, </p>
<p class="calibre1">continuous monitoring, 8–9</p>
<p class="calibre1">329–330</p>
<p class="calibre1">Costa, Gianluca, 147</p>
<p class="calibre1">as source of HTTP transaction data </p>
<p class="calibre1">cron, for periodic execution of </p>
<p class="calibre1">in Sguil, 165, 167</p>
<p class="calibre1">commands, 107, 330</p>
<p class="calibre1">as source of logs in ELSA, 178–180, </p>
<p class="calibre1">cronjobs, to execute commands, </p>
<p class="calibre1">240, 242</p>
<p class="calibre1">316–317, 325, 330</p>
<p class="calibre1">as source of session data, 21</p>
<p class="calibre1">as source of transaction data, 22–23</p>
<p class="calibre1"><b class="calibre3">D</b></p>
<p class="calibre1">SSH logs generated by, 226–227</p>
<p class="calibre1">Bullard, Carter, 128</p>
<p class="calibre1">datatypes, 16, 160</p>
<p class="calibre1">Burks, Doug, 55, 167</p>
<p class="calibre1">alert data, 28–30</p>
<p class="calibre1">extracted content data, 19–20</p>
<p class="calibre1"><b class="calibre3">C</b></p>
<p class="calibre1">full content data, 16–18</p>
<p class="calibre1">metadata, 26–28</p>
<p class="calibre1">campaigns, for tracking adversary </p>
<p class="calibre1">session data, 21–22</p>
<p class="calibre1">activity, 199–201</p>
<p class="calibre1">statistical data, 24–26</p>
<p class="calibre1">CapMe</p>
<p class="calibre1">transaction data, 22–23</p>
<p class="calibre1">as accessed from ELSA, 180, </p>
<p class="calibre1">date command, translating Unix </p>
<p class="calibre1">250–251</p>
<p class="calibre1">epoch to human readable </p>
<p class="calibre1">as accessed from Snorby, 174–177</p>
<p class="calibre1">format, 106</p>
<p class="calibre1">as data delivery tool, 115</p>
<p class="calibre1">DAYSTOKEEP variable, 108</p>
<p class="calibre1">CIRT (computer incident response </p>
<p class="calibre1">De Francheschi, Andrea, 147</p>
<p class="calibre1">team), 4, 203–205</p>
<p class="calibre1">defensible network architecture, 196</p>
<p class="calibre1">checksums</p>
<p class="calibre1">demilitarized zone (DMZ), 11, 37–46</p>
<p class="calibre1">bad checksums, 298</p>
<p class="calibre1">df, to check partition utilization, 108</p>
<p class="calibre1">telling Bro to ignore, 298–301</p>
<p class="calibre1">Digital Corpora, 147, 151, 154</p>
<p class="calibre1">telling Snort to ignore, 302</p>
<p class="calibre1">Director of Incident Response, 203–204</p>
<p class="calibre1">for error detection in IP </p>
<p class="calibre1"> <i class="calibre4">disablesid.conf</i>, 323</p>
<p class="calibre1">packets, 304</p>
<p class="calibre1">display filters, as used in Wireshark and </p>
<p class="calibre1">using Tshark to identify, 297–298</p>
<p class="calibre1">Tshark, 125–128</p>
<p class="calibre1">Cisco, as switch vendor, 12, 48</p>
<p class="calibre1">DMZ (demilitarized zone), 11, 37–46</p>
<p class="calibre1">client-side compromises, 235–237</p>
<p class="calibre1"> <i class="calibre4">dns.log</i>, as generated by Bro, 23, </p>
<p class="calibre1">Cloppert, Michael, 190</p>
<p class="calibre1">243–246, 282</p>
<p class="calibre1"><b class="calibre3">336</b>   Index</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p371"/>du, to check directory utilization, 108</p>
<p class="calibre1">and transaction data, 22–23</p>
<p class="calibre1">Dumpcap, usage of, 123–124</p>
<p class="calibre1">and URL events, 167</p>
<p class="calibre1">hunting (IOC-free analysis), 193</p>
<p class="calibre1"><b class="calibre3">E</b></p>
<p class="calibre1">Hutchins, Eric, 190</p>
<p class="calibre1">ELSA (Enterprise Log Search and </p>
<p class="calibre1">Archive), usage of, 178–182</p>
<p class="calibre1"><b class="calibre3">I</b></p>
<p class="calibre1"> <i class="calibre4">elsa_node.conf</i>, 108, 323, 331</p>
<p class="calibre1">ICMP (Internet Control Message </p>
<p class="calibre1"> <i class="calibre4">elsa_web.conf</i>, 331</p>
<p class="calibre1">Protocol)</p>
<p class="calibre1"> <i class="calibre4">enablesid.conf</i>, 323</p>
<p class="calibre1">example intrusion, 212, 214</p>
<p class="calibre1">engineers, as within IDC, 203–204</p>
<p class="calibre1">searching Bro SSH logs, 226</p>
<p class="calibre1">Enterprise Log Search and Archive </p>
<p class="calibre1">and Tcpdump, 119–128</p>
<p class="calibre1">(ELSA), usage of, 178–182</p>
<p class="calibre1">and Wireshark, 142</p>
<p class="calibre1">enterprise security cycle, 5, 186</p>
<p class="calibre1">incident analyst role, 203–204</p>
<p class="calibre1">phases of, 187</p>
<p class="calibre1">Incident Detection and Response </p>
<p class="calibre1">escalation, as element of response </p>
<p class="calibre1">Center, 203–204</p>
<p class="calibre1">phase, 188, 193–197</p>
<p class="calibre1">incident handler role, 203–204</p>
<p class="calibre1"> <i class="calibre4">/etc/network/interfaces</i>, 87–88</p>
<p class="calibre1">indicator of compromise (IOC)</p>
<p class="calibre1">event analyst role, 203–204</p>
<p class="calibre1">as intelligence format, 188–189, </p>
<p class="calibre1">event classification, 195</p>
<p class="calibre1">193, 202, 277, 279</p>
<p class="calibre1">extracted content data, 19–20</p>
<p class="calibre1">OpenIOC, as schema for IOC, 278</p>
<p class="calibre1">Infrastructure and Development </p>
<p class="calibre1"><b class="calibre3">F</b></p>
<p class="calibre1">Center, 203–204</p>
<p class="calibre1">Internet Control Message Protocol. </p>
<p class="calibre1">Fenner, Bill, 116</p>
<p class="calibre1"> <i class="calibre4">See</i> ICMP (Internet Control </p>
<p class="calibre1">find command, to process traffic, </p>
<p class="calibre1">Message Protocol)</p>
<p class="calibre1">122, 128</p>
<p class="calibre1">intrusion categories, 194</p>
<p class="calibre1">for command, to process traffic, </p>
<p class="calibre1">intrusion kill chain, 190–192</p>
<p class="calibre1">122, 128</p>
<p class="calibre1">intrusion prevention, 5</p>
<p class="calibre1">F-Response, 189</p>
<p class="calibre1">IOC (indicator of compromise)</p>
<p class="calibre1"> <i class="calibre4">ftp.log</i>, as generated by Bro, 228–229, </p>
<p class="calibre1">as intelligence format, 188–189, </p>
<p class="calibre1">272–273</p>
<p class="calibre1">193, 202, 277, 279</p>
<p class="calibre1">full content data, 16–18</p>
<p class="calibre1">OpenIOC, as schema for IOC, 278</p>
<p class="calibre1">IOC-centric analysis (matching), </p>
<p class="calibre1"><b class="calibre3">G</b></p>
<p class="calibre1">193, 202</p>
<p class="calibre1">IOC-free analysis (hunting), 193</p>
<p class="calibre1">Garfinkel, Simson, 147, 229, 291</p>
<p class="calibre1">Iodine covert tunnel tool, 255–259</p>
<p class="calibre1">Gredler, Hannes, 116</p>
<p class="calibre1">IP addresses, 39–41</p>
<p class="calibre1"><b class="calibre3">H</b></p>
<p class="calibre1"><b class="calibre3">M</b></p>
<p class="calibre1">Halliday, Paul, 173, 174</p>
<p class="calibre1">Malware Hash Registry (MHR), </p>
<p class="calibre1">Harris, Guy, 116</p>
<p class="calibre1">283–288</p>
<p class="calibre1">Heberlein, Todd, 3</p>
<p class="calibre1">Mandia, Kevin, 193</p>
<p class="calibre1">Hjelmvik, Erik, 153</p>
<p class="calibre1">Mandiant</p>
<p class="calibre1">Holste, Martin, 178, 245</p>
<p class="calibre1">APT1 report, 190, 193, 202, </p>
<p class="calibre1"> <i class="calibre4">http_agent.conf</i>, 327</p>
<p class="calibre1">277–278</p>
<p class="calibre1"> <i class="calibre4">http.log</i>, as generated by Bro</p>
<p class="calibre1">involvement with South Carolina </p>
<p class="calibre1">and bad checksums, 299, 300–301</p>
<p class="calibre1">DoR, 6–8</p>
<p class="calibre1">extracting binaries from HTTP </p>
<p class="calibre1">M-Trends Report, 190</p>
<p class="calibre1">traffic, 269–270, 277</p>
<p class="calibre1">as platform for tracking key </p>
<p class="calibre1">querying, 243</p>
<p class="calibre1">incident measurements, 307</p>
<p class="calibre1">tracking executables, 264</p>
<p class="calibre1">Index   <b class="calibre3">337</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p372"/>Mandiant for Intelligent Response </p>
<p class="calibre1">network visibility</p>
<p class="calibre1">(MIR), 189</p>
<p class="calibre1">capturing traffic on a client or </p>
<p class="calibre1">matching (IOC-centric analysis), </p>
<p class="calibre1">server, 49</p>
<p class="calibre1">193, 202</p>
<p class="calibre1">locations for, 45–46</p>
<p class="calibre1">metadata, 26–28</p>
<p class="calibre1">network taps for, 48</p>
<p class="calibre1">Metasploit, 239–241, 248, 251</p>
<p class="calibre1">switching SPAN ports for, 47–48</p>
<p class="calibre1">Metasploitable, 221</p>
<p class="calibre1">vs. network taps, 50</p>
<p class="calibre1">Meterpreter, as Metasploit component, </p>
<p class="calibre1">NIST (National Institute of Standards </p>
<p class="calibre1">240–241, 248, 251–255</p>
<p class="calibre1">and Technology), 304</p>
<p class="calibre1">MHR (Malware Hash Registry), </p>
<p class="calibre1"> <i class="calibre4">notice.log</i>, as generated by Bro</p>
<p class="calibre1">283–288</p>
<p class="calibre1">analyzing with ELSA, 242–243</p>
<p class="calibre1"> <i class="calibre4">modifysid.conf</i>, 323</p>
<p class="calibre1">with APT1 module, 279, 282</p>
<p class="calibre1">MySQL</p>
<p class="calibre1">extracting binaries from HTTP </p>
<p class="calibre1">database storage location, 105</p>
<p class="calibre1">traffic, 277</p>
<p class="calibre1">keeping software up-to-date, 333</p>
<p class="calibre1">hashing downloaded executables </p>
<p class="calibre1">query to determine storage </p>
<p class="calibre1">with Bro, 264</p>
<p class="calibre1">usage, 107</p>
<p class="calibre1">and malicious downloads, 286</p>
<p class="calibre1">setting up on SO using PPA, 89, 94</p>
<p class="calibre1">NPAT (network port address </p>
<p class="calibre1">as SO database, 76, 115, 167–169, </p>
<p class="calibre1">translation), 43–46</p>
<p class="calibre1">178, 180</p>
<p class="calibre1">NSM (network security monitoring)</p>
<p class="calibre1">as target of data theft, 228–232</p>
<p class="calibre1">benefit to CIRTs, 4</p>
<p class="calibre1">as continuous business process, 4</p>
<p class="calibre1"><b class="calibre3">N</b></p>
<p class="calibre1">datatypes, 16, 160</p>
<p class="calibre1">definition of, 3</p>
<p class="calibre1">NAT (network address translation), </p>
<p class="calibre1">efficacy of, 12–13, 31</p>
<p class="calibre1">42–43</p>
<p class="calibre1">how to win with, 10</p>
<p class="calibre1">drawback with NSM, 31</p>
<p class="calibre1">legality of, 13–14</p>
<p class="calibre1">network visibility, 45–46</p>
<p class="calibre1">protecting user privacy when </p>
<p class="calibre1">vs. proxy, 294</p>
<p class="calibre1">conducting, 14</p>
<p class="calibre1">National Institute of Standards and </p>
<p class="calibre1">purchasing, 31–32</p>
<p class="calibre1">Technology (NIST), 304</p>
<p class="calibre1">relationship to other approaches, </p>
<p class="calibre1">net blocks, 39–41</p>
<p class="calibre1">9–10</p>
<p class="calibre1">Net Optics, as tap vendor, 12, 48</p>
<p class="calibre1">resources, 32</p>
<p class="calibre1">Netsniff-ng, as data collection tool, 115, </p>
<p class="calibre1">simple setup, 10–11</p>
<p class="calibre1">170, 172, 244</p>
<p class="calibre1">NSMNow, 311</p>
<p class="calibre1">network address translation (NAT), </p>
<p class="calibre1"> <i class="calibre4">/nsm/sensor_data/&lt;sensorname&gt;/dailylogs</i> </p>
<p class="calibre1">42–43</p>
<p class="calibre1">directory, 105–106, 116, </p>
<p class="calibre1">drawback with NSM, 31</p>
<p class="calibre1">122, 128–129, 136–137</p>
<p class="calibre1">network visibility, 45–46</p>
<p class="calibre1">vs. proxy, 294</p>
<p class="calibre1">NetworkMiner</p>
<p class="calibre1"><b class="calibre3">O</b></p>
<p class="calibre1">counting bytes in session data </p>
<p class="calibre1">OpenIOC format, 278</p>
<p class="calibre1">using, 169</p>
<p class="calibre1">OpenSSH</p>
<p class="calibre1">usage of, 153–157</p>
<p class="calibre1">for communications among </p>
<p class="calibre1">network port address translation </p>
<p class="calibre1">distributed SO platforms, </p>
<p class="calibre1">(NPAT), 43–46</p>
<p class="calibre1">82–83</p>
<p class="calibre1">network security monitoring.  <i class="calibre4">See</i> </p>
<p class="calibre1">for connecting via SOCKS </p>
<p class="calibre1">NSM (network security </p>
<p class="calibre1">proxy, 103</p>
<p class="calibre1">monitoring)</p>
<p class="calibre1">as logged by Bro, 277</p>
<p class="calibre1">network taps, 48, 49</p>
<p class="calibre1">for sensor administration, 51, 88, </p>
<p class="calibre1">94, 124</p>
<p class="calibre1"><b class="calibre3">338</b>   Index</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p373"/>for X forwarding, 95–97</p>
<p class="calibre1">retrospective security analysis, 30</p>
<p class="calibre1">as used by an intruder, 232–233</p>
<p class="calibre1">Richardson, Michael, 116</p>
<p class="calibre1">OSSEC, 115, 165, 182, 227</p>
<p class="calibre1">RIR (Regional Internet Registry), 40</p>
<p class="calibre1"> <i class="calibre4">ossec_agent.conf</i>, 323</p>
<p class="calibre1">Risso, Fulvio, 116</p>
<p class="calibre1">RobTex, 28, 132</p>
<p class="calibre1"><b class="calibre3">P</b></p>
<p class="calibre1">routing, 28, 34, 49, 198, 299</p>
<p class="calibre1">Packetloop, 306</p>
<p class="calibre1"> <i class="calibre4">pads_agent.conf</i>, 327</p>
<p class="calibre1"><b class="calibre3">S</b></p>
<p class="calibre1">Passive Real-Time Asset Detection </p>
<p class="calibre1">SANCP (Security Analyst Network </p>
<p class="calibre1">System.  <i class="calibre4">See</i> PRADS (Passive </p>
<p class="calibre1">Connection Profiler)</p>
<p class="calibre1">Real-Time Asset Detection </p>
<p class="calibre1">database table, 167</p>
<p class="calibre1">System)</p>
<p class="calibre1">querying via Sguil, 167–169, </p>
<p class="calibre1"> <i class="calibre4">pcap_agent.conf</i>, 328</p>
<p class="calibre1">211–212, 223</p>
<p class="calibre1">pcap file format, 50, 76, 114, 115</p>
<p class="calibre1">as source of session data, 22, 167</p>
<p class="calibre1">pcap-filter man page, 120</p>
<p class="calibre1"> <i class="calibre4">sancp_agent.conf</i>, 328</p>
<p class="calibre1">penetration testing, 187</p>
<p class="calibre1">SANS Internet Storm Center (ISC) </p>
<p class="calibre1">People’s Liberation Army.  <i class="calibre4">See</i> APT </p>
<p class="calibre1">Port Report, 132</p>
<p class="calibre1">(Advanced Persistent </p>
<p class="calibre1">Security Analyst Network Connection </p>
<p class="calibre1">Threat)</p>
<p class="calibre1">Profiler.  <i class="calibre4">See</i> SANCP </p>
<p class="calibre1">Poison Ivy, 288</p>
<p class="calibre1">(Security Analyst Network </p>
<p class="calibre1">PPA (Personal Package Archive), 59. </p>
<p class="calibre1">Connection Profiler)</p>
<p class="calibre1"> <i class="calibre4">See also</i> SO (Security </p>
<p class="calibre1">Security Onion.  <i class="calibre4">See</i> SO (Security </p>
<p class="calibre1">Onion): installation of</p>
<p class="calibre1">Onion)</p>
<p class="calibre1">PRADS (Passive Real-Time Asset </p>
<p class="calibre1"> <i class="calibre4">securityonion.conf</i>, 108, 324–325</p>
<p class="calibre1">Detection System)</p>
<p class="calibre1">SecurixLive, 311</p>
<p class="calibre1">counting bytes in session data </p>
<p class="calibre1">senior analyst, in ATI, 203–204</p>
<p class="calibre1">using, 169</p>
<p class="calibre1">sensor hardware</p>
<p class="calibre1">as source of NSM data, 115</p>
<p class="calibre1">estimating hard drive space for, 51</p>
<p class="calibre1">with Sguil, 165, 167–169, </p>
<p class="calibre1">requirements for, 49–50</p>
<p class="calibre1">210–211</p>
<p class="calibre1"> <i class="calibre4">sensor.conf</i>, 328</p>
<p class="calibre1">similarity to Bro’s connection </p>
<p class="calibre1">sensor_cleandisk() function, 107</p>
<p class="calibre1">logs, 180</p>
<p class="calibre1">sensor management, recommendations </p>
<p class="calibre1"> <i class="calibre4">prads.conf</i>, 328</p>
<p class="calibre1">for, 51–52</p>
<p class="calibre1">principal analyst, in ATI, 203–204</p>
<p class="calibre1"> <i class="calibre4">server.conf</i>, 324</p>
<p class="calibre1">Prosise, Chris, 193</p>
<p class="calibre1">server-side compromises, 207–208</p>
<p class="calibre1">protecting user privacy, 14</p>
<p class="calibre1">session data, 21–22</p>
<p class="calibre1">protocol analyzer, 116</p>
<p class="calibre1">Sguil</p>
<p class="calibre1">proxies, 289–294</p>
<p class="calibre1">agents, 115, 312</p>
<p class="calibre1"> <i class="calibre4">pulledpork.conf</i>, 323</p>
<p class="calibre1">for analyzing a client-side intrusion, </p>
<p class="calibre1">PuTTY, for SOCKS proxy access, </p>
<p class="calibre1">210–224</p>
<p class="calibre1">103–105</p>
<p class="calibre1">databases used by, 107–108</p>
<p class="calibre1">incident category definitions in, 172</p>
<p class="calibre1"><b class="calibre3">r</b></p>
<p class="calibre1">key functions, 164</p>
<p class="calibre1">managing the Sguil database, 108</p>
<p class="calibre1"> <i class="calibre4">ra.conf</i>. See  <i class="calibre4">/tmp/ra.conf</i></p>
<p class="calibre1">transcript data storage, 172</p>
<p class="calibre1">RAT (remote access trojan), 288</p>
<p class="calibre1">usage of</p>
<p class="calibre1">red teaming, 187</p>
<p class="calibre1">categorizing alert data, 172–173</p>
<p class="calibre1">Regional Internet Registry (RIR), 40</p>
<p class="calibre1">metadata and related data, </p>
<p class="calibre1">remote access trojan (RAT), 288</p>
<p class="calibre1">164–165</p>
<p class="calibre1">resolution, as element of response </p>
<p class="calibre1">pivoting to full content data, </p>
<p class="calibre1">phase, 188, 198–201</p>
<p class="calibre1">169–171</p>
<p class="calibre1">Index   <b class="calibre3">339</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p374"/>Sguil, usage of  <i class="calibre4">(continued)</i></p>
<p class="calibre1">limiting access to, 102–103</p>
<p class="calibre1">querying alert data, 165–167</p>
<p class="calibre1">managing Sguil database </p>
<p class="calibre1">querying session data, 167–169</p>
<p class="calibre1">configuration of, 108</p>
<p class="calibre1">running, 161–163</p>
<p class="calibre1">requirements for server </p>
<p class="calibre1">simple aggregation, 164</p>
<p class="calibre1">hardware, 76</p>
<p class="calibre1">username and password during </p>
<p class="calibre1">selecting method to deploy code, 59</p>
<p class="calibre1">SO setup, 68–69, 79</p>
<p class="calibre1">as server-plus-sensors system, </p>
<p class="calibre1">sguil-db-purge script, 108</p>
<p class="calibre1">56–58, 76</p>
<p class="calibre1"> <i class="calibre4">sguild.conf</i>, 324</p>
<p class="calibre1">as stand-alone system, 56–57</p>
<p class="calibre1">Snorby</p>
<p class="calibre1">storage, estimating full content </p>
<p class="calibre1">as console to view alert data, 29, </p>
<p class="calibre1">data requirements, 51</p>
<p class="calibre1">71–73</p>
<p class="calibre1">updating</p>
<p class="calibre1">email address requirement during </p>
<p class="calibre1">via command line, 101</p>
<p class="calibre1">SO setup, 69, 79</p>
<p class="calibre1">via graphical user interface, </p>
<p class="calibre1">usage of, 174–178</p>
<p class="calibre1">100–101</p>
<p class="calibre1">Snort</p>
<p class="calibre1">SOCKS proxy, 103–104</p>
<p class="calibre1">alerts within ELSA generated by, </p>
<p class="calibre1"> <i class="calibre4">sosetup.log</i>, 70</p>
<p class="calibre1">180, 240–243, 248</p>
<p class="calibre1">South Carolina, intrusion example, </p>
<p class="calibre1">alerts within Sguil generated by, </p>
<p class="calibre1">6–8</p>
<p class="calibre1">210, 215–216</p>
<p class="calibre1">SPAN ports, 49, 50</p>
<p class="calibre1">configuring checksum mode in, 302</p>
<p class="calibre1">Sphinx, 115–116, 178</p>
<p class="calibre1">configuring X-Forwarded-For in, 294</p>
<p class="calibre1">Squert, usage of, 173–174</p>
<p class="calibre1">as console to view alert data, 29–30, </p>
<p class="calibre1"> <i class="calibre4">ssh.log</i>, as generated by Bro, 226–227</p>
<p class="calibre1">210–11, 214–216</p>
<p class="calibre1">statistical data, 24–26</p>
<p class="calibre1">as console to view session data, 22, </p>
<p class="calibre1">Suricata</p>
<p class="calibre1">211–214</p>
<p class="calibre1">alerts generated by, 169, 174, </p>
<p class="calibre1">as element in pcap log file name, </p>
<p class="calibre1">325–325, 328</p>
<p class="calibre1">105–106</p>
<p class="calibre1">as SO configuration choice, 79</p>
<p class="calibre1">as source of alert data, 28, 30, 115, </p>
<p class="calibre1">as source of alert data, 28, 115, </p>
<p class="calibre1">164–165</p>
<p class="calibre1">164–165</p>
<p class="calibre1"> <i class="calibre4">snort_agent.conf</i>, 329</p>
<p class="calibre1"> <i class="calibre4">suricata.yaml</i>, 328, 330</p>
<p class="calibre1"> <i class="calibre4">snort.conf</i>, 319, 329</p>
<p class="calibre1">Sysinternals PsExec, 189</p>
<p class="calibre1"> <i class="calibre4">snort.log.&lt;Unix timestamp&gt; </i>, as full </p>
<p class="calibre1">Syslog-ng, as data delivery tool, 115, </p>
<p class="calibre1">content data generated </p>
<p class="calibre1">178, 189, 331</p>
<p class="calibre1">by Netsniff-ng, 105</p>
<p class="calibre1">SO (Security Onion)</p>
<p class="calibre1"><b class="calibre3">t</b></p>
<p class="calibre1">core tools, 116</p>
<p class="calibre1">data collection tool category of, 115</p>
<p class="calibre1">Tcpdump</p>
<p class="calibre1">data delivery tool category of, 115</p>
<p class="calibre1">for collecting sample traffic, 268, </p>
<p class="calibre1">data presentation tool  </p>
<p class="calibre1">280–281, 291</p>
<p class="calibre1">category of, 114</p>
<p class="calibre1">as packet analysis tool, 114</p>
<p class="calibre1">data storage with, 105–106</p>
<p class="calibre1">as source of full content data, 16–18</p>
<p class="calibre1">estimating database storage of, </p>
<p class="calibre1">usage of, 116–122</p>
<p class="calibre1">107–108</p>
<p class="calibre1">Tcpflow, 229–230, 291–293</p>
<p class="calibre1">estimating filesystem  </p>
<p class="calibre1">Team Cymru, 283</p>
<p class="calibre1">storage of, 108</p>
<p class="calibre1">threat-centric security, 199</p>
<p class="calibre1">installation of, </p>
<p class="calibre1">Threat Stack, 305</p>
<p class="calibre1">sensor system via  <i class="calibre4">.iso</i>, 80–84</p>
<p class="calibre1"> <i class="calibre4">threshold.conf</i>, 323, 330</p>
<p class="calibre1">sensor system via PPA, 92–96</p>
<p class="calibre1">time</p>
<p class="calibre1">server system via  <i class="calibre4">.iso</i>, 77–80</p>
<p class="calibre1">events to record, 201</p>
<p class="calibre1">server system via PPA, 85–91</p>
<p class="calibre1">importance of, 5</p>
<p class="calibre1">stand-alone system, 59–73</p>
<p class="calibre1"> <i class="calibre4">/tmp/ra.conf</i>, 131–132</p>
<p class="calibre1"><b class="calibre3">340</b>   Index</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p375"/> <i class="calibre4">/tmp/.xkey.log</i>, as logged keystrokes, </p>
<p class="calibre1">Webber, Dustin, 174, 177, 305</p>
<p class="calibre1">253–255 </p>
<p class="calibre1"> <i class="calibre4">weird.log</i>, as generated by Bro, 299</p>
<p class="calibre1">traffic</p>
<p class="calibre1">WHOIS</p>
<p class="calibre1">capturing on a client or server, 49</p>
<p class="calibre1">as form of metadata, 26–27</p>
<p class="calibre1">processing, 122, 128</p>
<p class="calibre1">as used in Sguil, 164–165</p>
<p class="calibre1">and Tcpdump, 268, 280-281, 291</p>
<p class="calibre1">whois, as tool to query Malware Hash </p>
<p class="calibre1">understanding flow, 35–38</p>
<p class="calibre1">Registry, 284</p>
<p class="calibre1">transaction data, 22–23</p>
<p class="calibre1">Windows Management Instrumen-</p>
<p class="calibre1">Tshark, </p>
<p class="calibre1">tation Command-line </p>
<p class="calibre1">reviewing checksums with, 296–297</p>
<p class="calibre1">(WMIC), 189</p>
<p class="calibre1">reviewing full content data with, </p>
<p class="calibre1">wireless local area network (WLAN), </p>
<p class="calibre1">216–218, 249</p>
<p class="calibre1">12–13, 34–35, 38–46, </p>
<p class="calibre1">usage of, 122–128</p>
<p class="calibre1">238, 246</p>
<p class="calibre1">Twitter, as compromise vector, 238–239 </p>
<p class="calibre1">Wireshark</p>
<p class="calibre1">256, 261–262</p>
<p class="calibre1">counting bytes in session data </p>
<p class="calibre1">using, 169</p>
<p class="calibre1"><b class="calibre3">U</b></p>
<p class="calibre1">decoding protocols in, 144–145</p>
<p class="calibre1">following streams in, 143–144</p>
<p class="calibre1">Ubuntu, as NSM platform operating </p>
<p class="calibre1">modifying default column </p>
<p class="calibre1">system, 59, 64–65, 85–94</p>
<p class="calibre1">layout of, 137–140</p>
<p class="calibre1">UFW (Uncomplicated Firewall), </p>
<p class="calibre1">as packet analysis tool, 18–19</p>
<p class="calibre1">102–103, 105</p>
<p class="calibre1">problems when sniffing traffic </p>
<p class="calibre1">Unit 61398.  <i class="calibre4">See</i> APT (Advanced </p>
<p class="calibre1">as root with, 123–124</p>
<p class="calibre1">Persistent Threat)</p>
<p class="calibre1">as source of extracted content data, </p>
<p class="calibre1">Universal Coordinated Time (UTC), </p>
<p class="calibre1">19–20</p>
<p class="calibre1">62, 70, 118</p>
<p class="calibre1">as source of statistical data, 24–26</p>
<p class="calibre1">Unix epoch time, 118</p>
<p class="calibre1">usage of, 136–147</p>
<p class="calibre1">understanding traffic flow, 35–38</p>
<p class="calibre1">Wiretap Act, 13</p>
<p class="calibre1">UTC (Universal Coordinated Time), </p>
<p class="calibre1">WLAN (wireless local area network), </p>
<p class="calibre1">62, 70, 118</p>
<p class="calibre1">12–13, 34–35, 38–46, </p>
<p class="calibre1">238, 246</p>
<p class="calibre1"><b class="calibre3">V</b></p>
<p class="calibre1">WMIC (Windows Management </p>
<p class="calibre1">VERIS (Vocabulary for Event </p>
<p class="calibre1">Instrumentation </p>
<p class="calibre1">Recording and Incident </p>
<p class="calibre1">Command-line), 189</p>
<p class="calibre1">Sharing), 196</p>
<p class="calibre1"> <i class="calibre4">www.testmyids.com</i>, 15–16, 20–23, 28–29, </p>
<p class="calibre1">virtual private network (VPN), 31, 58, </p>
<p class="calibre1">71, 84, 179</p>
<p class="calibre1">258</p>
<p class="calibre1">VirusTotal</p>
<p class="calibre1"><b class="calibre3">X</b></p>
<p class="calibre1">submitting a binary to, 273–275</p>
<p class="calibre1">X forwarding via Secure Shell, 95</p>
<p class="calibre1">submitting a hash to, 264–266, </p>
<p class="calibre1">Xplico, usage of, 147–153</p>
<p class="calibre1">273–274, 288</p>
<p class="calibre1">Xubuntu, as NSM platform operating </p>
<p class="calibre1">Visscher, Bamm, 3</p>
<p class="calibre1">system, 59–60, 63–65</p>
<p class="calibre1">Vocabulary for Event Recording </p>
<p class="calibre1">and Incident Sharing </p>
<p class="calibre1"><b class="calibre3">Y</b></p>
<p class="calibre1">(VERIS), 196</p>
<p class="calibre1">VPN (virtual private network), 31, </p>
<p class="calibre1">Young, David, 116</p>
<p class="calibre1">58, 258</p>
<p class="calibre1"> <i class="calibre4">YYYY-MM-DD.log</i>, as session data </p>
<p class="calibre1">generated by Argus, 129</p>
<p class="calibre1"><b class="calibre3">W</b></p>
<p class="calibre1">Wade, Aaron, 193</p>
<p class="calibre1">waves, for tracking CIRT activity, </p>
<p class="calibre1">200–201</p>
<p class="calibre1">Index   <b class="calibre3">341</b></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p376"/><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p377"/> <i class="calibre4">The Practice of Network Security Monitoring</i> is set in New Baskerville, TheSansMono Condensed, Futura, and Dogma. </p>
<p class="calibre1">This book was printed and bound at Edwards Brothers Malloy in </p>
<p class="calibre1">Ann Arbor, Michigan. The paper is 70# Williamsburg Smooth, which is </p>
<p class="calibre1">certified by the Sustainable Forestry Initiative (SFI). </p>
<p class="calibre1">The book uses a RepKover binding, in which the pages are bound </p>
<p class="calibre1">together with a cold-set, flexible glue and the first and last pages of the </p>
<p class="calibre1">resulting book block are attached to the cover with tape. The cover is </p>
<p class="calibre1">not actually glued to the book’s spine, and when open, the book lies flat </p>
<p class="calibre1">and the spine doesn’t crack. </p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p378"/><img src="index-378_1.jpg" alt="Image 164" class="calibre2"/></p>
<p class="calibre1"><img src="index-378_2.jpg" alt="Image 165" class="calibre2"/></p>
<p class="calibre1"><img src="index-378_3.png" alt="Image 166" class="calibre2"/></p>
<p class="calibre1"><img src="index-378_4.jpg" alt="Image 167" class="calibre2"/></p>
<p class="calibre1"><img src="index-378_5.jpg" alt="Image 168" class="calibre2"/></p>
<p class="calibre1"><img src="index-378_6.png" alt="Image 169" class="calibre2"/></p>
<p class="calibre1">Updates</p>
<p class="calibre1">Visit  <i class="calibre4">http://nostarch.com/nsm/</i> for updates, errata, and other information. </p>
<p class="calibre1"> <i class="calibre4">More no-nonsense books from</i> </p>
<p class="calibre1">nO starcH press</p>
<p class="calibre1">practical Malware analysis</p>
<p class="calibre1">MetasplOit</p>
<p class="calibre1">practical packet analysis, </p>
<p class="calibre1">the Hands-On Guide to  </p>
<p class="calibre1">the penetration tester’s Guide</p>
<p class="calibre1">2nd editiOn</p>
<p class="calibre1">dissecting Malicious software</p>
<p class="calibre1"> <i class="calibre4">by </i> david kennedy, jim o’gorman, </p>
<p class="calibre1">Using wireshark to solve real-world  </p>
<p class="calibre1"> <i class="calibre4">by </i> michael sikorski  <i class="calibre4">and</i>  </p>
<p class="calibre1">devon kearns,  <i class="calibre4">and</i> mati aharoni</p>
<p class="calibre1">network problems</p>
<p class="calibre1">andrew honig</p>
<p class="calibre1">july 2011, 328 pp., $49.95</p>
<p class="calibre1"> <i class="calibre4">by </i> chris sanders</p>
<p class="calibre1">february 2012, 800 pp., $59.95</p>
<p class="calibre1">isbn 978-1-59327-288-3</p>
<p class="calibre1">july 2011, 280 pp., $49.95</p>
<p class="calibre1">isbn 978-1-59327-290-6</p>
<p class="calibre1">isbn 978-1-59327-266-1</p>
<p class="calibre1">HackinG, 2nd editiOn</p>
<p class="calibre1">tHe tanGled web</p>
<p class="calibre1">absOlUte Openbsd, </p>
<p class="calibre1">the art of exploitation</p>
<p class="calibre1">a Guide to securing Modern  </p>
<p class="calibre1">2nd editiOn</p>
<p class="calibre1"> <i class="calibre4">by </i> jon erickson</p>
<p class="calibre1">web applications</p>
<p class="calibre1">Unix for the practical paranoid</p>
<p class="calibre1">february 2008, 488 pp. w/cd, $49.95</p>
<p class="calibre1"> <i class="calibre4">by </i> michal zalewski </p>
<p class="calibre1"> <i class="calibre4">by </i> michael w. lucas</p>
<p class="calibre1">isbn 978-1-59327-144-2</p>
<p class="calibre1">november 2011, 320 pp., $49.95</p>
<p class="calibre1">april 2013, 536 pp., $59.95</p>
<p class="calibre1">isbn 978-1-59327-388-0</p>
<p class="calibre1">isbn 978-1-59327-476-4</p>
<p class="calibre1">phone:</p>
<p class="calibre1">email:</p>
<p class="calibre1">800.420.7240 or</p>
<p class="calibre1">sales@nostarch.com</p>
<p class="calibre1">415.863.9900</p>
<p class="calibre1">web:</p>
<p class="calibre1">www.nostarch.com</p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p379"/><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="p380"/><img src="index-380_1.png" alt="Image 170" class="calibre2"/></p>
<p class="calibre1"><b class="calibre3">C O L L E C T</b></p>
<p class="calibre1"><b class="calibre3">Foreword by Todd Heberlein, </b></p>
<p class="calibre1"><b class="calibre3">A N A L Y Z E</b></p>
<p class="calibre1"><b class="calibre3">Developer of the Network</b></p>
<p class="calibre1"><b class="calibre3">E S C A L A T E</b></p>
<p class="calibre1"><b class="calibre3">Security Monitor System</b></p>
<p class="calibre1"><b class="calibre3">N</b></p>
<p class="calibre1"><b class="calibre3">T H E   P R A C T I C E   O F  </b></p>
<p class="calibre1"><b class="calibre3">ETW</b></p>
<p class="calibre1"><b class="calibre3">N E T W O R K   S E C U R I T Y  </b></p>
<p class="calibre1"><b class="calibre3">OR</b></p>
<p class="calibre1">Network security is not simply about building impene- </p>
<p class="calibre1">• Interpret network evidence from server-side and</p>
<p class="calibre1"><b class="calibre3">M O N I T O R I N G</b></p>
<p class="calibre1">trable walls—determined attackers  <i class="calibre4">will</i> eventually over-</p>
<p class="calibre1">client-side intrusions</p>
<p class="calibre1"/>
<p class="calibre1"/>
<p class="calibre1"><b class="calibre3">K T</b></p>
<p class="calibre1">come traditional defenses. The most effective computer </p>
<p class="calibre1">• Integrate threat intelligence into NSM software to</p>
<p class="calibre1"><b class="calibre3">H</b></p>
<p class="calibre1">security strategies integrate network security monitoring </p>
<p class="calibre1"><b class="calibre3"> SEC</b></p>
<p class="calibre1"><b class="calibre3">U N D E R S T A N D I N G   I N C I D E N T   D E T E C T I O N</b></p>
<p class="calibre1"><b class="calibre3"> SEC</b></p>
<p class="calibre1">identify sophisticated adversaries</p>
<p class="calibre1"><b class="calibre3">E P</b></p>
<p class="calibre1">(NSM): the collection and analysis of data to help you </p>
<p class="calibre1"><b class="calibre3">A N D   R E S P O N S E</b></p>
<p class="calibre1">detect and respond to intrusions. </p>
<p class="calibre1">There’s no foolproof way to keep attackers out of </p>
<p class="calibre1">your network. But when they get in, you’ll be prepared. </p>
<p class="calibre1">In  <i class="calibre4">The Practice of Network Security Monitoring</i>, </p>
<p class="calibre1"><b class="calibre3">R</b></p>
<p class="calibre1"> <i class="calibre4">The Practice of Network Security Monitoring</i> will show </p>
<p class="calibre1"><b class="calibre3">U</b></p>
<p class="calibre1">Mandiant CSO Richard Bejtlich shows you how to </p>
<p class="calibre1">you how to build a security net to detect, contain, and </p>
<p class="calibre1"><b class="calibre3">R A</b></p>
<p class="calibre1"><b class="calibre3">R I C H A R D   B E J T L I C H</b></p>
<p class="calibre1">use NSM to add a robust layer of protection around </p>
<p class="calibre1"><b class="calibre3">R</b></p>
<p class="calibre1">control them. Attacks are inevitable, but losing sensitive </p>
<p class="calibre1"><b class="calibre3">C</b></p>
<p class="calibre1">your networks—no prior experience required. To help</p>
<p class="calibre1"><b class="calibre3">I</b></p>
<p class="calibre1"/>
<p class="calibre1"/>
<p class="calibre1">data shouldn’t be. </p>
<p class="calibre1">you avoid costly and inflexible solutions, he teaches you</p>
<p class="calibre1"><b class="calibre3">T T</b></p>
<p class="calibre1">how to deploy, build, and run an NSM operation using</p>
<p class="calibre1"><b class="calibre3">Y I</b></p>
<p class="calibre1">open source software and vendor-neutral tools. </p>
<p class="calibre1"><b class="calibre3">A B O U T   T H E   A U T H O R</b></p>
<p class="calibre1"><b class="calibre3"> MONI CE O</b></p>
<p class="calibre1">You’ll learn how to:</p>
<p class="calibre1">Richard Bejtlich is Chief Security Officer at Mandiant </p>
<p class="calibre1">and was previously Director of Incident Response for</p>
<p class="calibre1">• Determine where to deploy NSM platforms, and </p>
<p class="calibre1">General Electric. He is a graduate of Harvard University</p>
<p class="calibre1">size them for the monitored networks</p>
<p class="calibre1">and the United States Air Force Academy. His previous</p>
<p class="calibre1"><b class="calibre3">F</b></p>
<p class="calibre1">• Deploy stand-alone or distributed NSM installations</p>
<p class="calibre1">works include  <i class="calibre4">The Tao of Network Security Monitoring</i>, </p>
<p class="calibre1"><b class="calibre3">T</b></p>
<p class="calibre1"> <i class="calibre4">Extrusion Detection</i>, and  <i class="calibre4">Real Digital Forensics</i>. He writes</p>
<p class="calibre1">• Use command line and graphical packet analysis</p>
<p class="calibre1"><b class="calibre3">OR</b></p>
<p class="calibre1">on his blog ( <i class="calibre4">http://taosecurity.blogspot.com</i>) and on</p>
<p class="calibre1">tools and NSM consoles</p>
<p class="calibre1">Twitter as @taosecurity. </p>
<p class="calibre1"><b class="calibre3">ING</b></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">TH E FI N EST  I N  G E E K E NTE RTAI N M E NT™</b></i></p>
<p class="calibre1"><b class="calibre3">B</b></p>
<p class="calibre1">www.nostarch.com</p>
<p class="calibre1"><b class="calibre3">EJTL</b></p>
<p class="calibre1"><b class="calibre3">$49.95  <i class="calibre4">($52.95 CDN)</i></b></p>
<p class="calibre1"><b class="calibre3">IC</b></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">“I  LIE FLAT.” </b></i></p>
<p class="calibre1"><b class="calibre3">C S</b></p>
<p class="calibre1"><b class="calibre3">O H</b></p>
<p class="calibre1"><b class="calibre3">H</b></p>
<p class="calibre1"><b class="calibre3">M ELV</b></p>
<p class="calibre1"> <i class="calibre4">This book uses RepKover —a durable binding that won’t snap shut. </i></p>
<p class="calibre1"><b class="calibre3">PU E</b></p>
<p class="calibre1"><b class="calibre3">T  I</b></p>
<p class="calibre1"><b class="calibre3">E N</b></p>
<p class="calibre1"><b class="calibre3">R :</b></p>
<p class="calibre1"> <i class="calibre4">“An invaluable resource for anyone detecting </i></p>
<p class="calibre1"><b class="calibre3">S/SEC</b></p>
<p class="calibre1"><b class="calibre3">U</b></p>
<p class="calibre1"> <i class="calibre4">and responding to security breaches.” </i></p>
<p class="calibre1"><b class="calibre3">RITY</b></p>
<p class="calibre1"> <i class="calibre4"><b class="calibre3">—Kevin Mandia, Mandiant CEO</b></i></p>
<p class="calibre1"><a href="http://www.it-ebooks.info/">www.it-ebooks.info</a></p>
<p class="calibre1"><a id="outline"/></p>


<p class="calibre1">
<h1 class="calibre5" id="calibre_pb_0">Document Outline</h1>
<ul class="calibre6">
<li class="calibre7"><a href="index_split_000.html#p19">About the Author</a></li>
<li class="calibre7"><a href="index_split_000.html#p21">Foreword</a></li>
<li class="calibre7"><a href="index_split_000.html#p27">Preface</a>
<ul class="calibre8">
<li class="calibre7"><a href="index_split_000.html#p28">Audience</a></li>
<li class="calibre7"><a href="index_split_000.html#p29">Prerequisites</a></li>
<li class="calibre7"><a href="index_split_000.html#p29">A Note on Software and Protocols</a></li>
<li class="calibre7"><a href="index_split_000.html#p30">Scope</a></li>
<li class="calibre7"><a href="index_split_000.html#p31">Acknowledgements</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_000.html#p35">Part I: Getting Started</a>
<ul class="calibre8">
<li class="calibre7"><a href="index_split_000.html#p37">Chapter 1: Network Security Monitoring Rationale</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_000.html#p38">An Introduction to NSM</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_000.html#p39">Does NSM Prevent Intrusions? </a></li>
<li class="calibre7"><a href="index_split_000.html#p42">What Is the Difference Between NSM and Continuous Monitoring? </a></li>
<li class="calibre7"><a href="index_split_000.html#p43">How Does NSM Compare with Other Approaches? </a></li>
<li class="calibre7"><a href="index_split_000.html#p44">Why Does NSM Work? </a></li>
<li class="calibre7"><a href="index_split_000.html#p45">How NSM Is Set Up</a></li>
<li class="calibre7"><a href="index_split_000.html#p46">When NSM Won’t Work</a></li>
<li class="calibre7"><a href="index_split_000.html#p47">Is NSM Legal? </a></li>
<li class="calibre7"><a href="index_split_000.html#p48">How Can You Protect User Privacy During NSM Operations? </a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_000.html#p49">A Sample NSM Test </a></li>
<li class="calibre7"><a href="index_split_000.html#p50">The Range of NSM Data</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_000.html#p50">Full Content Data</a></li>
<li class="calibre7"><a href="index_split_001.html#p53">Extracted Content Data</a></li>
<li class="calibre7"><a href="index_split_001.html#p55">Session Data</a></li>
<li class="calibre7"><a href="index_split_001.html#p56">Transaction Data</a></li>
<li class="calibre7"><a href="index_split_001.html#p58">Statistical Data</a></li>
<li class="calibre7"><a href="index_split_001.html#p60">Metadata</a></li>
<li class="calibre7"><a href="index_split_001.html#p62">Alert Data</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_001.html#p64">What’s the Point of All This Data? </a></li>
<li class="calibre7"><a href="index_split_001.html#p65">NSM Drawbacks</a></li>
<li class="calibre7"><a href="index_split_001.html#p65">Where Can I Buy NSM? </a></li>
<li class="calibre7"><a href="index_split_001.html#p66">Where Can I Go for Support or More Information? </a></li>
<li class="calibre7"><a href="index_split_001.html#p66">Conclusion</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_001.html#p67">Chapter 2: Collecting Network Traffic: Access, Storage, and Management</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_001.html#p67">A Sample Network for a Pilot NSM System</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_001.html#p69">Traffic Flow in a Simple Network</a></li>
<li class="calibre7"><a href="index_split_001.html#p72">Possible Locations for NSM</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_001.html#p73">IP Addresses and Network Address Translation</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_001.html#p73">Net Blocks</a></li>
<li class="calibre7"><a href="index_split_001.html#p75">IP Address Assignments</a></li>
<li class="calibre7"><a href="index_split_001.html#p76">Address Translation</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_001.html#p79">Choosing the Best Place to Obtain Network Visibility</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_001.html#p79">Location for DMZ Network Traffic</a></li>
<li class="calibre7"><a href="index_split_001.html#p79">Locations for Viewing the Wireless and Internal Network Traffic</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_001.html#p81">Getting Physical Access to the Traffic</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_001.html#p81">Using Switches for Traffic Monitoring</a></li>
<li class="calibre7"><a href="index_split_001.html#p82">Using a Network Tap</a></li>
<li class="calibre7"><a href="index_split_001.html#p83">Capturing Traffic Directly on a Client or Server</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_001.html#p83">Choosing an NSM Platform</a></li>
<li class="calibre7"><a href="index_split_001.html#p85">Ten NSM Platform Management Recommendations</a></li>
<li class="calibre7"><a href="index_split_001.html#p86">Conclusion</a></li>
</ul>
</li>
</ul>
</li>
<li class="calibre7"><a href="index_split_001.html#p87">Part II: Security Onion Deployment</a>
<ul class="calibre8">
<li class="calibre7"><a href="index_split_001.html#p89">Chapter 3: Stand-alone NSM Deployment and Installation</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_001.html#p90">Stand-alone or Server Plus Sensors? </a></li>
<li class="calibre7"><a href="index_split_001.html#p93">Choosing How to Get SO Code onto Hardware</a></li>
<li class="calibre7"><a href="index_split_001.html#p93">Installing a Stand-alone System</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_001.html#p94">Installing SO to a Hard Drive</a></li>
<li class="calibre7"><a href="index_split_001.html#p98">Configuring SO Software</a></li>
<li class="calibre7"><a href="index_split_001.html#p100">Choosing the Management Interface</a></li>
<li class="calibre7"><a href="index_split_001.html#p102">Installing the NSM Software Components</a></li>
<li class="calibre7"><a href="index_split_002.html#p104">Checking Your Installation</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_002.html#p108">Conclusion</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_002.html#p109">Chapter 4: Distributed Deployment</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_002.html#p110">Installing an SO Server Using the SO .iso File</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_002.html#p110">SO Server Considerations</a></li>
<li class="calibre7"><a href="index_split_002.html#p111">Building Your SO Server</a></li>
<li class="calibre7"><a href="index_split_002.html#p112">Configuring Your SO Server</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_002.html#p114">Installing an SO Sensor Using the SO .iso Image</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_002.html#p115">Configuring the SO Sensor</a></li>
<li class="calibre7"><a href="index_split_002.html#p117">Completing Setup</a></li>
<li class="calibre7"><a href="index_split_002.html#p118">Verifying that the Sensors Are Working</a></li>
<li class="calibre7"><a href="index_split_002.html#p118">Verifying that the Autossh Tunnel Is Working</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_002.html#p119">Building an SO Server Using PPAs</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_002.html#p119">Installing Ubuntu Server as the SO Server Operating System</a></li>
<li class="calibre7"><a href="index_split_002.html#p121">Choosing a Static IP Address</a></li>
<li class="calibre7"><a href="index_split_002.html#p122">Updating the Software</a></li>
<li class="calibre7"><a href="index_split_002.html#p123">Beginning MySQL and PPA Setup on the SO Server</a></li>
<li class="calibre7"><a href="index_split_002.html#p124">Configuring Your SO Server via PPA</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_002.html#p126">Building an SO Sensor Using PPAs</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_002.html#p126">Installing Ubuntu Server as the SO Sensor Operating System</a></li>
<li class="calibre7"><a href="index_split_002.html#p128">Configuring the System as a Sensor</a></li>
<li class="calibre7"><a href="index_split_002.html#p129">Running the Setup Wizard</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_002.html#p132">Conclusion</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_002.html#p133">Chapter 5: SO Platform Housekeeping</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_002.html#p133">Keeping SO Up-to-Date</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_002.html#p134">Updating via the GUI</a></li>
<li class="calibre7"><a href="index_split_002.html#p135">Updating via the Command Line</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_002.html#p136">Limiting Access to SO</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_002.html#p137">Connecting via a SOCKS Proxy </a></li>
<li class="calibre7"><a href="index_split_002.html#p139">Changing the Firewall Policy </a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_002.html#p139">Managing SO Data Storage</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_002.html#p140">Managing Sensor Storage</a></li>
<li class="calibre7"><a href="index_split_002.html#p141">Checking Database Drive Usage</a></li>
<li class="calibre7"><a href="index_split_002.html#p142">Managing the Sguil Database</a></li>
<li class="calibre7"><a href="index_split_002.html#p142">Tracking Disk Usage</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_002.html#p143">Conclusion</a></li>
</ul>
</li>
</ul>
</li>
<li class="calibre7"><a href="index_split_002.html#p145">Part III: Tools</a>
<ul class="calibre8">
<li class="calibre7"><a href="index_split_002.html#p147">Chapter 6: Command Line Packet Analysis Tools</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_002.html#p148">SO Tool Categories</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_002.html#p148">Data Presentation </a></li>
<li class="calibre7"><a href="index_split_002.html#p149">SO Data Collection Tools</a></li>
<li class="calibre7"><a href="index_split_002.html#p149">SO Data Delivery Tools</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_002.html#p150">Running Tcpdump</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_002.html#p151">Displaying, Writing, and Reading Traffic with Tcpdump</a></li>
<li class="calibre7"><a href="index_split_002.html#p152">Using Filters with Tcpdump</a></li>
<li class="calibre7"><a href="index_split_002.html#p155">Extracting Details from Tcpdump Output</a></li>
<li class="calibre7"><a href="index_split_003.html#p156">Examining Full Content Data with Tcpdump</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_003.html#p156">Using Dumpcap and Tshark</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_003.html#p157">Running Tshark</a></li>
<li class="calibre7"><a href="index_split_003.html#p157">Running Dumpcap</a></li>
<li class="calibre7"><a href="index_split_003.html#p159">Running Tshark on Dumpcap’s Traffic</a></li>
<li class="calibre7"><a href="index_split_003.html#p159">Using Display Filters with Tshark</a></li>
<li class="calibre7"><a href="index_split_003.html#p161">Tshark Display Filters in Action</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_003.html#p162">Running Argus and the Ra Client</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_003.html#p163">Stopping and Starting Argus</a></li>
<li class="calibre7"><a href="index_split_003.html#p163">The Argus File Format</a></li>
<li class="calibre7"><a href="index_split_003.html#p164">Examining Argus Data</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_003.html#p167">Conclusion</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_003.html#p169">Chapter 7: Graphical Packet Analysis Tools</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_003.html#p170">Using Wireshark</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_003.html#p170">Running Wireshark</a></li>
<li class="calibre7"><a href="index_split_003.html#p171">Viewing a Packet Capture in Wireshark</a></li>
<li class="calibre7"><a href="index_split_003.html#p171">Modifying the Default Wireshark Layout</a></li>
<li class="calibre7"><a href="index_split_003.html#p174">Some Useful Wireshark Features</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_003.html#p181">Using Xplico</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_003.html#p181">Running Xplico</a></li>
<li class="calibre7"><a href="index_split_003.html#p182">Creating Xplico Cases and Sessions</a></li>
<li class="calibre7"><a href="index_split_003.html#p183">Processing Network Traffic</a></li>
<li class="calibre7"><a href="index_split_003.html#p184">Understanding the Decoded Traffic</a></li>
<li class="calibre7"><a href="index_split_003.html#p187">Getting Metadata and Summarizing Traffic</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_003.html#p187">Examining Content with NetworkMiner</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_003.html#p188">Running NetworkMiner</a></li>
<li class="calibre7"><a href="index_split_003.html#p189">Collecting and Organizing Traffic Details</a></li>
<li class="calibre7"><a href="index_split_003.html#p190">Rendering Content</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_003.html#p191">Conclusion</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_003.html#p193">Chapter 8: NSM Consoles</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_003.html#p194">An NSM-centric Look at Network Traffic</a></li>
<li class="calibre7"><a href="index_split_003.html#p195">Using Sguil</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_003.html#p195">Running Sguil</a></li>
<li class="calibre7"><a href="index_split_003.html#p198">Sguil’s Six Key Functions</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_003.html#p207">Using Squert</a></li>
<li class="calibre7"><a href="index_split_003.html#p208">Snorby</a></li>
<li class="calibre7"><a href="index_split_003.html#p212">ELSA</a></li>
<li class="calibre7"><a href="index_split_004.html#p215">Conclusion</a></li>
</ul>
</li>
</ul>
</li>
<li class="calibre7"><a href="index_split_004.html#p217">Part IV: NSM in Action</a>
<ul class="calibre8">
<li class="calibre7"><a href="index_split_004.html#p219">Chapter 9: NSM Operations</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_004.html#p220">The Enterprise Security Cycle</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_004.html#p221">The Planning Phase</a></li>
<li class="calibre7"><a href="index_split_004.html#p221">The Resistance Phase</a></li>
<li class="calibre7"><a href="index_split_004.html#p221">The Detection and Response Phases</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_004.html#p222">Collection, Analysis, Escalation, and Resolution</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_004.html#p223">Collection</a></li>
<li class="calibre7"><a href="index_split_004.html#p227">Analysis</a></li>
<li class="calibre7"><a href="index_split_004.html#p229">Escalation</a></li>
<li class="calibre7"><a href="index_split_004.html#p232">Resolution</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_004.html#p235">Remediation</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_004.html#p236">Using NSM to Improve Security</a></li>
<li class="calibre7"><a href="index_split_004.html#p237">Building a CIRT</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_004.html#p239">Conclusion</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_004.html#p241">Chapter 10: Server-side Compromise</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_004.html#p242">Server-side Compromise Defined</a></li>
<li class="calibre7"><a href="index_split_004.html#p243">Server-side Compromise in Action</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_004.html#p244">Starting with Sguil</a></li>
<li class="calibre7"><a href="index_split_004.html#p245">Querying Sguil for Session Data</a></li>
<li class="calibre7"><a href="index_split_004.html#p248">Returning to Alert Data</a></li>
<li class="calibre7"><a href="index_split_004.html#p250">Reviewing Full Content Data with Tshark</a></li>
<li class="calibre7"><a href="index_split_004.html#p252">Understanding the Backdoor</a></li>
<li class="calibre7"><a href="index_split_004.html#p253">What Did the Intruder Do? </a></li>
<li class="calibre7"><a href="index_split_004.html#p256">What Else Did the Intruder Do? </a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_005.html#p258">Exploring the Session Data</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_005.html#p259">Searching Bro DNS Logs</a></li>
<li class="calibre7"><a href="index_split_005.html#p260">Searching Bro SSH Logs</a></li>
<li class="calibre7"><a href="index_split_005.html#p262">Searching Bro FTP Logs</a></li>
<li class="calibre7"><a href="index_split_005.html#p263">Decoding the Theft of Sensitive Data</a></li>
<li class="calibre7"><a href="index_split_005.html#p264">Extracting the Stolen Archive</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_005.html#p265">Stepping Back</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_005.html#p265">Summarizing Stage 1</a></li>
<li class="calibre7"><a href="index_split_005.html#p266">Summarizing Stage 2</a></li>
<li class="calibre7"><a href="index_split_005.html#p266">Next Steps</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_005.html#p267">Conclusion</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_005.html#p269">Chapter 11: Client-side Compromise</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_005.html#p270">Client-side Compromise Defined</a></li>
<li class="calibre7"><a href="index_split_005.html#p271">Client-side Compromise in Action</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_005.html#p272">Getting the Incident Report from a User</a></li>
<li class="calibre7"><a href="index_split_005.html#p273">Starting Analysis with ELSA</a></li>
<li class="calibre7"><a href="index_split_005.html#p277">Looking for Missing Traffic</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_005.html#p279">Analyzing the Bro dns.log File</a></li>
<li class="calibre7"><a href="index_split_005.html#p280">Checking Destination Ports</a></li>
<li class="calibre7"><a href="index_split_005.html#p284">Examining the Command-and-Control Channel</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_005.html#p285">Initial Access</a></li>
<li class="calibre7"><a href="index_split_005.html#p289">Improving the Shell</a></li>
<li class="calibre7"><a href="index_split_005.html#p290">Summarizing Stage 1</a></li>
<li class="calibre7"><a href="index_split_005.html#p291">Pivoting to a Second Victim</a></li>
<li class="calibre7"><a href="index_split_005.html#p291">Installing a Covert Tunnel</a></li>
<li class="calibre7"><a href="index_split_005.html#p293">Enumerating the Victim</a></li>
<li class="calibre7"><a href="index_split_005.html#p294">Summarizing Stage 2</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_005.html#p295">Conclusion</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_005.html#p297">Chapter 12: Extending Security Onion</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_005.html#p298">Using Bro to Track Executables</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_005.html#p298">Hashing Downloaded Executables with Bro</a></li>
<li class="calibre7"><a href="index_split_005.html#p298">Submitting a Hash to VirusTotal</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_005.html#p300">Using Bro to Extract Binaries from Traffic</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_005.html#p300">Configuring Bro to Extract Binaries from Traffic</a></li>
<li class="calibre7"><a href="index_split_005.html#p301">Collecting Traffic to Test Bro</a></li>
<li class="calibre7"><a href="index_split_006.html#p303">Testing Bro to Extract Binaries from HTTP Traffic</a></li>
<li class="calibre7"><a href="index_split_006.html#p304">Examining the Binary Extracted from HTTP</a></li>
<li class="calibre7"><a href="index_split_006.html#p306">Testing Bro to Extract Binaries from FTP Traffic</a></li>
<li class="calibre7"><a href="index_split_006.html#p307">Examining the Binary Extracted from FTP</a></li>
<li class="calibre7"><a href="index_split_006.html#p307">Submitting a Hash and Binary to VirusTotal</a></li>
<li class="calibre7"><a href="index_split_006.html#p309">Restarting Bro</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_006.html#p311">Using APT1 Intelligence</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_006.html#p312">Using the APT1 Module</a></li>
<li class="calibre7"><a href="index_split_006.html#p314">Installing the APT1 Module</a></li>
<li class="calibre7"><a href="index_split_006.html#p314">Generating Traffic to Test the APT1 Module</a></li>
<li class="calibre7"><a href="index_split_006.html#p315">Testing the APT1 Module</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_006.html#p317">Reporting Downloads of Malicious Binaries</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_006.html#p317">Using the Team Cymru Malware Hash Registry</a></li>
<li class="calibre7"><a href="index_split_006.html#p319">The MHR and SO: Active by Default</a></li>
<li class="calibre7"><a href="index_split_006.html#p320">The MHR and SO vs. a Malicious Download</a></li>
<li class="calibre7"><a href="index_split_006.html#p321">Identifying the Binary</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_006.html#p322">Conclusion</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_006.html#p323">Chapter 13: Proxies and Checksums</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_006.html#p323">Proxies</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_006.html#p324">Proxies and Visibility</a></li>
<li class="calibre7"><a href="index_split_006.html#p328">Dealing with Proxies in Production Networks</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_006.html#p328">Checksums</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_006.html#p329">A Good Checksum</a></li>
<li class="calibre7"><a href="index_split_006.html#p329">A Bad Checksum</a></li>
<li class="calibre7"><a href="index_split_006.html#p330">Identifying Bad and Good Checksums with Tshark</a></li>
<li class="calibre7"><a href="index_split_006.html#p332">How Bad Checksums Happen</a></li>
<li class="calibre7"><a href="index_split_006.html#p332">Bro and Bad Checksums</a></li>
<li class="calibre7"><a href="index_split_006.html#p334">Setting Bro to Ignore Bad Checksums</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_006.html#p336">Conclusion</a></li>
</ul>
</li>
</ul>
</li>
<li class="calibre7"><a href="index_split_006.html#p337">Conclusion</a>
<ul class="calibre8">
<li class="calibre7"><a href="index_split_006.html#p338">Cloud Computing</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_006.html#p338">Cloud Computing Challenges</a></li>
<li class="calibre7"><a href="index_split_006.html#p340">Cloud Computing Benefits</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_006.html#p341">Workflow, Metrics, and Collaboration</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_006.html#p341">Workflow and Metrics</a></li>
<li class="calibre7"><a href="index_split_006.html#p342">Collaboration</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_006.html#p343">Conclusion</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_006.html#p345">Security Onion Scripts and Configuration</a>
<ul class="calibre8">
<li class="calibre7"><a href="index_split_006.html#p345">Security Onion Control Scripts</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_006.html#p347">/usr/sbin/nsm</a></li>
<li class="calibre7"><a href="index_split_006.html#p347">/usr/sbin/nsm_all_del</a></li>
<li class="calibre7"><a href="index_split_006.html#p348">/usr/sbin/nsm_all_del_quick</a></li>
<li class="calibre7"><a href="index_split_006.html#p349">/usr/sbin/nsm_sensor</a></li>
<li class="calibre7"><a href="index_split_006.html#p350">/usr/sbin/nsm_sensor_add</a></li>
<li class="calibre7"><a href="index_split_006.html#p350">/usr/sbin/nsm_sensor_backup-config</a></li>
<li class="calibre7"><a href="index_split_006.html#p350">/usr/sbin/nsm_sensor_backup-data</a></li>
<li class="calibre7"><a href="index_split_006.html#p350">/usr/sbin/nsm_sensor_clean</a></li>
<li class="calibre7"><a href="index_split_006.html#p350">/usr/sbin/nsm_sensor_clear</a></li>
<li class="calibre7"><a href="index_split_006.html#p350">/usr/sbin/nsm_sensor_del</a></li>
<li class="calibre7"><a href="index_split_006.html#p351">/usr/sbin/nsm_sensor_edit</a></li>
<li class="calibre7"><a href="index_split_006.html#p351">/usr/sbin/nsm_sensor_ps-daily-restart</a></li>
<li class="calibre7"><a href="index_split_006.html#p351">/usr/sbin/nsm_sensor_ps-restart</a></li>
<li class="calibre7"><a href="index_split_006.html#p353">/usr/sbin/nsm_sensor_ps-start</a></li>
<li class="calibre7"><a href="index_split_006.html#p353">/usr/sbin/nsm_sensor_ps-status</a></li>
<li class="calibre7"><a href="index_split_006.html#p354">/usr/sbin/nsm_sensor_ps-stop</a></li>
<li class="calibre7"><a href="index_split_006.html#p354">/usr/sbin/nsm_server</a></li>
<li class="calibre7"><a href="index_split_006.html#p354">/usr/sbin/nsm_server_add</a></li>
<li class="calibre7"><a href="index_split_006.html#p354">/usr/sbin/nsm_server_backup-config</a></li>
<li class="calibre7"><a href="index_split_006.html#p354">/usr/sbin/nsm_server_backup-data</a></li>
<li class="calibre7"><a href="index_split_006.html#p355">/usr/sbin/nsm_server_clear</a></li>
<li class="calibre7"><a href="index_split_006.html#p355">/usr/sbin/nsm_server_del</a></li>
<li class="calibre7"><a href="index_split_006.html#p355">/usr/sbin/nsm_server_edit</a></li>
<li class="calibre7"><a href="index_split_006.html#p355">/usr/sbin/nsm_server_ps-restart</a></li>
<li class="calibre7"><a href="index_split_006.html#p355">/usr/sbin/nsm_server_ps-start</a></li>
<li class="calibre7"><a href="index_split_006.html#p355">/usr/sbin/nsm_server_ps-status</a></li>
<li class="calibre7"><a href="index_split_006.html#p355">/usr/sbin/nsm_server_ps-stop</a></li>
<li class="calibre7"><a href="index_split_006.html#p356">/usr/sbin/nsm_server_sensor-add</a></li>
<li class="calibre7"><a href="index_split_006.html#p356">/usr/sbin/nsm_server_sensor-del</a></li>
<li class="calibre7"><a href="index_split_006.html#p356">/usr/sbin/nsm_server_user-add</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_006.html#p356">Security Onion Configuration Files</a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_006.html#p356">/etc/nsm/</a></li>
<li class="calibre7"><a href="index_split_006.html#p357">/etc/nsm/administration.conf</a></li>
<li class="calibre7"><a href="index_split_006.html#p357">/etc/nsm/ossec/</a></li>
<li class="calibre7"><a href="index_split_006.html#p357">/etc/nsm/pulledpork/</a></li>
<li class="calibre7"><a href="index_split_006.html#p357">/etc/nsm/rules/</a></li>
<li class="calibre7"><a href="index_split_006.html#p358">/etc/nsm/securityonion/</a></li>
<li class="calibre7"><a href="index_split_006.html#p358">/etc/nsm/securityonion.conf</a></li>
<li class="calibre7"><a href="index_split_006.html#p359">/etc/nsm/sensortab</a></li>
<li class="calibre7"><a href="index_split_006.html#p360">/etc/nsm/servertab</a></li>
<li class="calibre7"><a href="index_split_006.html#p360">/etc/nsm/templates/</a></li>
<li class="calibre7"><a href="index_split_006.html#p360">/etc/nsm/$HOSTNAME-$INTERFACE/</a></li>
<li class="calibre7"><a href="index_split_006.html#p364">/etc/cron.d/</a></li>
<li class="calibre7"><a href="index_split_006.html#p364">Bro</a></li>
<li class="calibre7"><a href="index_split_006.html#p365">CapMe</a></li>
<li class="calibre7"><a href="index_split_006.html#p365">ELSA</a></li>
<li class="calibre7"><a href="index_split_006.html#p365">Squert</a></li>
<li class="calibre7"><a href="index_split_006.html#p365">Snorby</a></li>
<li class="calibre7"><a href="index_split_006.html#p365">Syslog-ng</a></li>
<li class="calibre7"><a href="index_split_006.html#p365">/etc/network/interfaces</a></li>
</ul>
</li>
<li class="calibre7"><a href="index_split_006.html#p366">Updating Security Onion </a>
<ul class="calibre9">
<li class="calibre7"><a href="index_split_006.html#p366">Updating the Security Onion Distribution</a></li>
<li class="calibre7"><a href="index_split_006.html#p367">Updating MySQL</a></li>
</ul>
</li>
</ul>
</li>
</ul></p>
</body></html>