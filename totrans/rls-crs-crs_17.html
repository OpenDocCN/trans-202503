<html><head></head><body><div class="chapter" title="Chapter&#xA0;15.&#xA0;Custom Deployment"><div class="titlepage"><div><div><h1 class="title"><a id="custom_deployment"/>Chapter 15. Custom Deployment</h1></div></div></div><p><a class="indexterm" id="iddle1483"/>Moving your finished application into production and making it available to
        users requires you to make many choices. You can choose from a variety of web hosting
        providers, Rails application servers, databases, and automated deployment systems. In <a class="xref" href="ch06.html" title="Chapter 6. Deployment">Chapter 6</a>, you learned about Heroku, a hosting service that uses Git for
        deployment.</p><p>Most large companies have an operations team to configure servers and deploy
        applications. But as a beginning Rails programmer, you may not have the luxury of a
        dedicated operations team to deploy your application.</p><p>In this chapter, you’ll set up a server to host your application, configure your
        application’s production environment, push your application to GitHub, and finally
        deploy to your server using Capistrano.</p><div class="sect1" title="Virtual Private Servers"><div class="titlepage"><div><div><h1 class="title"><a id="virtual_private_servers"/>Virtual Private Servers</h1></div></div></div><p><a class="indexterm" id="iddle1052"/><a class="indexterm" id="iddle1053"/><a class="indexterm" id="iddle1217"/><a class="indexterm" id="iddle1485"/><a class="indexterm" id="iddle1745"/><a class="indexterm" id="iddle2147"/><a class="indexterm" id="iddle2269"/><a class="indexterm" id="iddle2325"/><a class="indexterm" id="iddle2326"/>A <span class="emphasis"><em>virtual private server (VPS)</em></span> is a type of virtual
          machine sold by web hosting providers. A single physical server can run many virtual
          private servers. An individual VPS is often referred to as an
            <span class="emphasis"><em>instance</em></span>.</p><p>When you buy a VPS, you get part of the processing power, memory, and disk space of a
          larger physical server. You get you full access to your part of the server, including the
          ability to choose your operating system. So you are free to install the software you need
          and configure the server however you like. Unfortunately, you are also responsible for any
          installation and configuration errors on the server.</p><p>Many different hosting providers offer VPS services. A quick Google search leads to
          hundreds of competing providers. A popular choice among both startups and established
          companies is Amazon Web Services (AWS).</p><div class="note" title="Note"><h3 class="title"><a id="ch15note01"/>Note</h3><p><span class="emphasis"><em>The rest of this chapter uses AWS to set up a server and deploy your
              application, but the instructions are not AWS specific. If you would rather use a
              different service, create an instance running Ubuntu Linux 14.04 LTS, and you should
              be able to follow along with no problem. Ubuntu Linux 14.04 LTS is a long-term support
              release with guaranteed support until April 2019.</em></span></p></div><div class="sect2" title="Amazon AWS Setup"><div class="titlepage"><div><div><h2 class="title"><a id="amazon_aws_setup"/>Amazon AWS Setup</h2></div></div></div><p>In addition to being a popular choice, Amazon also provides an AWS free usage tier
            for new users. You can read more about the free usage tier at <span class="emphasis"><em><a class="ulink" href="http://aws.amazon.com/free/">http://aws.amazon.com/free/</a></em></span> to see if you qualify. Even if you
            don’t qualify for the free usage tier, you can still get an AWS Micro instance for
            a few cents an hour.</p><p>Amazon calls their VPS service <span class="emphasis"><em>Amazon Elastic Compute Cloud (Amazon
              EC2)</em></span>. Rather than cover the details of setting up your Amazon account here,
            please refer to the Amazon EC2 documentation at <span class="emphasis"><em><a class="ulink" href="http://aws.amazon.com/documentation/ec2/">http://aws.amazon.com/documentation/ec2/</a></em></span>.</p><p>Click the <span class="strong"><strong>User Guide</strong></span> link, and follow the
            instructions, starting with Setting Up. This section walks you through the process of
            signing up for AWS, creating a user account in the AWS Identity and Access Management
            (IAM) system, creating a key pair, and creating a security group. Be sure you store your
            IAM credentials and private key—you’ll need them for this chapter.</p><p>Then move on to Getting Started. In this section, you should launch an EC2 instance,
            connect to your instance, add a storage volume, and finally clean up your instance and
            volume. The EC2 user guide uses an Amazon Linux machine image that we won’t be
            using again, so be sure to follow the clean-up instructions in the User Guide when
            you’re done with this section.</p><p>Once you’re up to speed on Amazon EC2, you can set up your production server
            as described in this section. I recommend Ubuntu Linux, so the instructions that follow
            are Ubuntu specific. From the EC2 Management Console, click the <span class="strong"><strong>Launch Instance</strong></span> button to create a new server instance, and choose the
            Ubuntu Server 14.04 LTS (PV) Amazon Machine Image <a class="indexterm" id="iddle1163"/><a class="indexterm" id="iddle1263"/><a class="indexterm" id="iddle1744"/><a class="indexterm" id="iddle1951"/><a class="indexterm" id="iddle1991"/><a class="indexterm" id="iddle2121"/><a class="indexterm" id="iddle2180"/><a class="indexterm" id="iddle2270"/><a class="indexterm" id="iddle2327"/>in the Quick Start section. Because this is a web server, you need to
            configure the security group to allow HTTP traffic. Click the <span class="strong"><strong>Next</strong></span> button in the Launch Instance wizard until you reach Step 6:
            Configure Security Group. Now click the <span class="strong"><strong>Add Rule</strong></span>
            button, select <span class="strong"><strong>HTTP</strong></span> from the Type drop-down menu, and
            click the <span class="strong"><strong>Review and Launch</strong></span> button. Finally, click
            the <span class="strong"><strong>Launch</strong></span> button.</p><p>Once the instance is running, make note of the public DNS name displayed in the EC2
            Management Console, and then connect to the instance with SSH in a terminal window.
            Using the following command, replace <span class="bolditalic"><code class="literal">your_key_file</code></span> with the full path to the private key
            file you created in the Setting Up section of the EC2 User Guide and <span class="bolditalic"><code class="literal">your_instance_name</code></span> with the public DNS
            name of your instance:</p><a id="pro_id00464"/><pre class="programlisting">$ <span class="strong"><strong>ssh -i</strong></span> <span class="bolditalic">your_key_file</span> <span class="strong"><strong>ubuntu@</strong></span><span class="bolditalic">your_instance_name</span>
Welcome to Ubuntu 14.04 LTS...
<span class="emphasis"><em>--snip--</em></span></pre><p>The default user account on the Ubuntu AMI is named <span class="emphasis"><em>ubuntu</em></span>. So
            this command connects to the user named ubuntu at your instance.</p></div><div class="sect2" title="Ubuntu Linux Setup"><div class="titlepage"><div><div><h2 class="title"><a id="ubuntu_linux_setup"/>Ubuntu Linux Setup</h2></div></div></div><p>Once you’re connected, you can configure the instance for hosting Ruby on
            Rails applications. Enter all of the commands in this section on your instance over the
            SSH connection.</p><p>Ubuntu uses a system called <code class="literal">apt-get</code> for installing software from
            online repositories. The first thing you need is Ruby. Unfortunately, the default
            repositories often contain an older version of Ruby, but you have a way around
            that.</p><div class="sect3" title="Installing Ruby"><div class="titlepage"><div><div><h3 class="title"><a id="installing_ruby-id00034"/>Installing Ruby</h3></div></div></div><p>The developers at a hosting company called Brightbox have set up their own Ubuntu
              repository with the latest version of Ruby and made it available to the public. This
              repository is known as a <span class="emphasis"><em>Personal Package Archive (PPA)</em></span>. You can
              add this repository to your instance and get the latest version of Ruby using these
              commands:</p><a id="pro_id00465"/><pre class="programlisting">$ <span class="strong"><strong>sudo apt-get install python-software-properties</strong></span>
Reading package lists... Done
<span class="emphasis"><em>--snip--</em></span>
Setting up python-software-properties (0.92.36) ...
$ <span class="strong"><strong>sudo apt-add-repository ppa:brightbox/ruby-ng</strong></span>
Next generation Ubuntu packages for Ruby ...
<span class="emphasis"><em>--snip--</em></span>

http://brightbox.com
More info: https://launchpad.net/~brightbox/+archive/ruby-ng
Press [ENTER] to continue or ctrl-c to cancel adding it</pre><p><a class="indexterm" id="iddle1059"/><a class="indexterm" id="iddle1112"/><a class="indexterm" id="iddle1735"/><a class="indexterm" id="iddle1954"/><a class="indexterm" id="iddle2126"/><a class="indexterm" id="iddle2334"/>Press <span class="smaller">ENTER</span> when prompted, and then
              wait for the word <code class="literal">OK</code> to appear. After you add the Brightbox
              repository, update the <code class="literal">apt-get</code> package lists so it can find the
              newer versions of the Ruby packages.</p><a id="pro_id00466"/><pre class="programlisting">$ <span class="strong"><strong>sudo apt-get update</strong></span>
Ign http://us-east-1.ec2.archive.ubuntu.com trusty ...
<span class="emphasis"><em>--snip--</em></span>
Fetched 13.7 MB in 9s (1,471 kB/s)
Reading package lists... Done</pre><p>Now install Ruby version 2.1. The following command installs both the Ruby
              interpreter and the development headers needed to compile additional gems:</p><a id="pro_id00467"/><pre class="programlisting">$ <span class="strong"><strong>sudo apt-get install ruby2.1 ruby2.1-dev</strong></span>
Reading package lists... Done
--<span class="emphasis"><em>snip</em></span>-
Do you want to continue? [Y/n]</pre><p>Press <span class="smaller">ENTER</span> to continue. Once the installation
              completes, check the Ruby version.</p><a id="pro_id00468"/><pre class="programlisting">$ <span class="strong"><strong>ruby -v</strong></span>
ruby 2.1.1p76 (2014-02-24 revision 45161) [x86_64-linux-gnu]</pre><p>Since Ruby is frequently updated, you’ll probably see a newer version number
              than the one shown here. Now that Ruby’s installed, you need a web server for
              Ruby on Rails applications.</p></div><div class="sect3" title="Installing Apache and Passenger"><div class="titlepage"><div><div><h3 class="title"><a id="installing_apache_and_passenger"/>Installing Apache and Passenger</h3></div></div></div><p>A variety of web servers are available today. The most popular web server is
              Apache, and that’s what we’ll use. Install the Apache HTTP Server version
              2 with this command:</p><a id="pro_id00469"/><pre class="programlisting">$ <span class="strong"><strong>sudo apt-get install apache2</strong></span>
Reading package lists... Done
<span class="emphasis"><em>--snip--</em></span>
Do you want to continue? [Y/n]</pre><p>Press <span class="smaller">ENTER</span> to continue.</p><p>Once you’ve completed this, open your web browser and go to the public DNS
              name of your instance to see the default Ubuntu website. Although you can’t see
              your application yet, you’re making progress.</p><p>Apache is great for serving web pages, but you need an application server to run
              your Ruby on Rails application. A popular application server that integrates with
              Apache is Phusion Passenger.</p><p>Phusion provides the Passenger application server through its own
                <code class="literal">apt-get</code> repository. It’s not a PPA like the Brightbox
              repository you used earlier, however, so the setup has a few more steps.</p><p><a class="indexterm" id="iddle1500"/><a class="indexterm" id="iddle2127"/>First, enter the <code class="literal">apt-key</code> command to import
              Phusion’s RSA key for the Ubuntu key server:</p><a id="pro_id00470"/><pre class="programlisting">$ <span class="strong"><strong>sudo apt-key adv --keyserver keyserver.ubuntu.com \</strong></span>
                   <span class="strong"><strong>--recv-keys 561F9B9CAC40B2F7</strong></span>
Executing: gpg --ignore-time-conflict ...
<span class="emphasis"><em>--snip--</em></span>
gpg:               imported: 1 (RSA: 1)</pre><p>The <code class="literal">apt-get</code> program uses this key to ensure that packages you
              install are really coming from Phusion. Phusion’s repository uses an encrypted
              HTTP connection (HTTPS) to communicate with your instance.</p><p>First, you need to add the Phusion Passenger repository to your instance. Enter
              the following command to open a new file in the <code class="literal">nano</code> editor on your
              instance. (Or, if you’re more comfortable with another command-line editor, use
              that instead.)</p><a id="pro_id00471"/><pre class="programlisting">$ <span class="strong"><strong>sudo nano /etc/apt/sources.list.d/passenger.list</strong></span></pre><p>Enter <span class="strong"><strong><code class="literal">deb
                  https://oss-binaries.phusionpassenger.com/apt/passenger trusty
                main</code></strong></span> on the first line to add the address of the Phusion
              Passenger repository to your instance. Then, if you’re using
                <code class="literal">nano</code>, press <span class="smaller">CTRL</span>-O followed
              by <span class="smaller">ENTER</span> to save the file and <span class="smaller">CTRL</span>-X to exit the editor.</p><p>Now update the <code class="literal">apt-get</code> package lists again:</p><a id="pro_id00472"/><pre class="programlisting">$ <span class="strong"><strong>sudo apt-get update</strong></span>
Ign http://us-east-1.ec2.archive.ubuntu.com trusty InRelease
<span class="emphasis"><em>--snip--</em></span>
Reading package lists... Done</pre><p>Then install the Apache 2 Phusion Passenger module:</p><a id="pro_id00473"/><pre class="programlisting">$ <span class="strong"><strong>sudo apt-get install libapache2-mod-passenger</strong></span>
Reading package lists... Done
<span class="emphasis"><em>--snip--</em></span>
Do you want to continue? [Y/n]</pre><p>Press <span class="smaller">ENTER</span> to continue. Once the installation
              completes, your instance should be set up to serve both standard web pages and Ruby on
              Rails applications.</p><p>With your web server installed, create a directory for your application. The
              default directory for regular HTML web pages is <span class="emphasis"><em>/var/www/html</em></span>.
              Because you’re deploying a Ruby on Rails application, create a separate
              directory with these commands.</p><a id="pro_id00474"/><pre class="programlisting">$ <span class="strong"><strong>sudo mkdir /var/www/social</strong></span>
$ <span class="strong"><strong>sudo chown ubuntu /var/www/social</strong></span>
$ <span class="strong"><strong>sudo chgrp ubuntu /var/www/social</strong></span></pre><p><a class="indexterm" id="iddle1401"/><a class="indexterm" id="iddle1740"/><a class="indexterm" id="iddle1861"/><a class="indexterm" id="iddle1965"/>The first command creates a directory named
                <span class="emphasis"><em>/var/www/social</em></span>. The next two commands assign ownership of that
              directory to your ubuntu user and group, allowing you to write files to that directory
              as needed.</p><p>Now you need to install and set up a database for your application.</p></div><div class="sect3" title="Installing PostgreSQL"><div class="titlepage"><div><div><h3 class="title"><a id="installing_postgresql"/>Installing PostgreSQL</h3></div></div></div><p>This chapter uses the PostgreSQL database, but which database software you choose
              is mostly up to you. MySQL is another popular, open source option you might
              consider.</p><p>Install PostgreSQL with this command:</p><a id="pro_id00475"/><pre class="programlisting">$ <span class="strong"><strong>sudo apt-get install postgresql postgresql-contrib</strong></span>
Reading package lists... Done
--<span class="emphasis"><em>snip</em></span>-
Do you want to continue? [Y/n]</pre><p>Press <span class="smaller">ENTER</span> to continue. Now that the database
              software is installed, let’s add a user account and create a few databases. The
              default user account for PostgreSQL is named <span class="emphasis"><em>postgres</em></span>, so you
              need to issue the <code class="literal">createuser</code> command as the
                <code class="literal">postgres</code> user with the <code class="literal">sudo -u postgres</code>
              command:</p><a id="pro_id00476"/><pre class="programlisting">$ <span class="strong"><strong>sudo -u postgres createuser --superuser ubuntu</strong></span></pre><p>This command creates a new user named <span class="emphasis"><em>ubuntu</em></span> with superuser
              access to the database. This user has full access to all database commands. PostgreSQL
              is configured with an authentication system known as <span class="emphasis"><em>ident
                sameuser,</em></span> by default, in Ubuntu. This means if your Ubuntu username
              matches your PostgreSQL username, you can connect without a password.</p><p>Now that you’ve created a PostgreSQL account for yourself, add a database
              and then see if you can connect to it:</p><a id="pro_id00477"/><pre class="programlisting">$ <span class="strong"><strong>createdb ubuntu</strong></span>
$ <span class="strong"><strong>psql</strong></span>
psql (9.3.4)
Type "help" for help.

ubuntu=# help
You are using psql, the command-line interface to PostgreSQL.
Type: \copyright for distribution terms
      \h for help with SQL commands
      \? for help with psql commands
      \g or terminate with semicolon to execute query
      \q to quit
ubuntu=#</pre><p><a class="indexterm" id="iddle1264"/><a class="indexterm" id="iddle1265"/><a class="indexterm" id="iddle1268"/><a class="indexterm" id="iddle1508"/><a class="indexterm" id="iddle1602"/><a class="indexterm" id="iddle1612"/><a class="indexterm" id="iddle1613"/><a class="indexterm" id="iddle1736"/><a class="indexterm" id="iddle1737"/><a class="indexterm" id="iddle1799"/>Your account can now log in to PostgreSQL and run commands. Enter
                <span class="strong"><strong><code class="literal">\q</code></strong></span> to quit. Now add a
              production database for your social application by entering this command:</p><a id="pro_id00478"/><pre class="programlisting">$ <span class="strong"><strong>createdb social_production</strong></span></pre><p>You won’t need to enter any other PostgreSQL commands on your instance. Now
              that you’ve created the production database, the migrations in your application
              create the tables needed by your application. You’ll configure the application
              to use this database before you deploy to your instance.</p></div><div class="sect3" title="Installing Build Tools"><div class="titlepage"><div><div><h3 class="title"><a id="installing_build_tools"/>Installing Build Tools</h3></div></div></div><p>Your instance is almost ready to go! Before you can deploy your application,
              however, you need to install a few more tools. Some of the gems your application uses
              need to be compiled, and to do so, you need build tools such as a C compiler. You also
              need Git for retrieving code from repositories and header files for PostgreSQL to
              compile the PostgreSQL database gem.</p><p>Fortunately, this single command should install all of the build tools you
              need:</p><a id="pro_id00479"/><pre class="programlisting">$ <span class="strong"><strong>sudo apt-get install build-essential git libpq-dev</strong></span>
Reading package lists... Done
<span class="emphasis"><em>--snip--</em></span>
Do you want to continue? [Y/n]</pre><p>The <code class="literal">build-essential</code> package is a collection of common build
              tools needed to compile many different types of software. You’re already
              familiar with Git from <a class="xref" href="ch06.html" title="Chapter 6. Deployment">Chapter 6</a>. The <code class="literal">libpq-dev</code>
              package is needed to compile PostgreSQL client applications such as the pg gem.</p></div><div class="sect3" title="Installing Gems"><div class="titlepage"><div><div><h3 class="title"><a id="installing_gems"/>Installing Gems</h3></div></div></div><p>The last setup step is to install the gems your application needs. As you’ll
              learn in the next section, the <code class="literal">bundle</code> command runs automatically
              when you deploy, but installing gems while you’re connected to the server helps
              to verify everything is working.</p><p>Gems normally generate documentation during installation. On the server, this
              documentation just takes up space and slows down the installation. You can tell the
                <code class="literal">gem</code> command to not generate documentation by adding <code class="literal">gem:
                --no-document</code> to your <span class="emphasis"><em>.gemrc</em></span> file:</p><a id="pro_id00480"/><pre class="programlisting">$ <span class="strong"><strong>echo "gem: --no-document" &gt;&gt; ~/.gemrc</strong></span></pre><p><a class="indexterm" id="iddle1294"/><a class="indexterm" id="iddle1484"/><a class="indexterm" id="iddle1742"/><a class="indexterm" id="iddle1953"/><a class="indexterm" id="iddle2032"/><a class="indexterm" id="iddle2190"/><a class="indexterm" id="iddle2254"/>Now that you’ve turned off gem documentation, install Rails:</p><a id="pro_id00481"/><pre class="programlisting">$ <span class="strong"><strong>sudo gem install rails</strong></span>
Fetching: thread_safe-0.3.3.gem (100%)
Successfully installed thread_safe-0.3.3
Fetching: minitest-5.3.3.gem (100%)
Successfully installed minitest-5.3.3
<span class="emphasis"><em>--snip--</em></span></pre><p>Because you’re using the PostgreSQL database, also install the pg gem. Parts
              of this gem are written in C, and they’ll be compiled automatically during the
              installation.</p><a id="pro_id00482"/><pre class="programlisting">$ <span class="strong"><strong>sudo gem install pg</strong></span>
Building native extensions. This could take a while...
Successfully installed pg-0.17.1
1 gem installed</pre><p>Finally, you need a gem called therubyracer. This gem embeds Google’s V8
              JavaScript interpreter into Ruby. Rails uses this gem to compile assets on the server.
              Parts of this gem must also be compiled.</p><a id="pro_id00483"/><pre class="programlisting">$ <span class="strong"><strong>sudo gem install therubyracer</strong></span>
Building native extensions. This could take a while...
Successfully installed therubyracer-0.12.1
1 gem installed</pre><p>With these gems in place, your instance is ready to run Rails applications. Now
              that the VPS setup is complete, let’s learn about Capistrano and the changes you
              need to make to your application to deploy and run it in production.</p></div></div></div><div class="sect1" title="Capistrano"><div class="titlepage"><div><div><h1 class="title"><a id="capistrano"/>Capistrano</h1></div></div></div><p>Capistrano is an open source tool for automating the process of running scripts and
          deploying applications on remote servers over an SSH connection. Capistrano extends the
            <code class="literal">rake</code> tool that you’ve used already. Just like
            <code class="literal">rake</code>, Capistrano uses a simple DSL to define
            <span class="emphasis"><em>tasks</em></span>, which are applied to different servers based on their
            <span class="emphasis"><em>role</em></span>.</p><p>Tasks include things such as pulling code from a Git repository, running
            <code class="literal">bundle install</code>, or running database migrations with
            <code class="literal">rake</code>. Roles are different types of servers such as web, application,
          or database. Currently, these are all on the same server, but when your application gets
          too big for a single server, Capistrano makes splitting the work among multiple servers
          easy.</p><p>Capistrano also supports deploying an application to different
            <span class="emphasis"><em>stages</em></span>. Capistrano stages are sets of servers, such as staging
          servers and production servers. Both of these servers run your Rails application in the
          production environment, but the staging server is probably used only for testing, whereas
          the production server is accessible by your users.</p><div class="sect2" title="Getting Started"><div class="titlepage"><div><div><h2 class="title"><a id="getting_started-id00035"/>Getting Started</h2></div></div></div><p><a class="indexterm" id="iddle1251"/><a class="indexterm" id="iddle1299"/><a class="indexterm" id="iddle1301"/><a class="indexterm" id="iddle1610"/><a class="indexterm" id="iddle2338"/>Exit the SSH session on your VPS or open another terminal window on your
            local computer to set up Capistrano. Because Capistrano is a gem, you first need to
            update your application’s <span class="emphasis"><em>Gemfile</em></span>. Capistrano is already in
            the file, but it’s commented out. Remove the pound sign from the beginning of the
            line for the capistrano-rails gem to install both Capistrano and the Rails-specific
            tasks you need.</p><p>While you’re editing the <span class="emphasis"><em>Gemfile</em></span>, also make the changes
            needed for running in production:</p><a id="pro_id00484"/><pre class="programlisting">  <span class="emphasis"><em>--snip--</em></span>

  # Use sqlite3 as the database for Active Record
1 gem 'sqlite3'<span class="strong"><strong>, group: [:development, :test]</strong></span>

  <span class="emphasis"><em>--snip--</em></span>

  # See https://github.com/sstephenson/execjs#readme...
2 <span class="strong"><strong>gem 'therubyracer', platforms: :ruby, group: :production</strong></span>

  <span class="emphasis"><em>--snip--</em></span>

  # Use Capistrano for deployment
3 <span class="strong"><strong>gem 'capistrano-rails', group: :development</strong></span>

4 <span class="strong"><strong># Use PostgreSQL in production</strong></span>
  <span class="strong"><strong>gem 'pg', group: :production</strong></span>

  # Use debugger
  gem 'byebug', group: [:development, :test]</pre><p>These changes first specify that the SQLite gem is only needed in the
              <code class="literal">development</code> and test environments ➊. Next, therubyracer gem
            is needed to compile assets in production ➋ as mentioned in the last section. The
            capistrano-rails gem is only needed in development ➌. Finally, you also need the
            PostgreSQL gem in production ➍.</p><p>Now update the installed gems on your computer:</p><a id="pro_id00485"/><pre class="programlisting">$ <span class="strong"><strong>bin/bundle install --binstubs --without production</strong></span>
Fetching gem metadata from https://rubygems.org/........
Fetching additional metadata from https://rubygems.org/..
Resolving dependencies...
--<span class="emphasis"><em>snip</em></span>--</pre><p>The --binstubs option tells bundler to also install the executable files in the
              <span class="emphasis"><em>bin/</em></span> directory. For example, Capistrano includes the cap command
            that you’ll use to deploy your application, and you’ll run that from
              <span class="emphasis"><em>bin/</em></span>. The --without production option tells bundler to install
            only gems for the development and test environments.</p><p><a class="indexterm" id="iddle1292"/><a class="indexterm" id="iddle1295"/><a class="indexterm" id="iddle1361"/>Next, you need to install Capistrano in your application:</p><a id="pro_id00486"/><pre class="programlisting">$ <span class="strong"><strong>bin/cap install</strong></span>
mkdir -p config/deploy
create config/deploy.rb
create config/deploy/staging.rb
create config/deploy/production.rb
mkdir -p lib/capistrano/tasks
Capified</pre><p>This process generates the files you need to configure Capistrano to deploy your
            application. Let’s dig into those next.</p></div><div class="sect2" title="Configuration"><div class="titlepage"><div><div><h2 class="title"><a id="configuration"/>Configuration</h2></div></div></div><p>Now that your application has been Capified, you may notice some new files. The
            first of these is named <span class="emphasis"><em>Capfile</em></span> and is located in the root of the
            application. You need to make one small change to that file:</p><a id="pro_id00487"/><pre class="programlisting">  # Load DSL and Setup Up Stages
  require 'capistrano/setup'

  # Includes default deployment tasks
  require 'capistrano/deploy'

➊ <span class="strong"><strong># Include all Rails tasks</strong></span>
  <span class="strong"><strong>require 'capistrano/rails'</strong></span>

<span class="emphasis"><em>--snip--</em></span></pre><p>As the comment says, the new <code class="literal">require</code> line includes
            Capistrano’s Rails-specific tasks in your application ➊. After you save
            this file, you can see a list of Capistrano tasks by entering the <code class="literal">bin/cap
              -T</code> command in your terminal.</p><p>Next, you need to edit the file <span class="emphasis"><em>config/deploy.rb</em></span>. This file
            contains configuration that is shared by all deployment stages, such as the name of your
            application and the address of your Git repository.</p><a id="pro_id00488"/><pre class="programlisting">  # config valid only for Capistrano 3.1
  lock '3.2.1'

➊ <span class="strong"><strong>set :application, 'social'</strong></span>
  <span class="strong"><strong>set :repo_url, 'https://github.com/</strong></span><span class="bolditalic">yourname</span><span class="strong"><strong>/social.git'</strong></span>

  # Default branch is :master
  # ask :branch, proc { `git rev-parse --abbrev-ref HEAD`.chomp }.call

  # Default deploy_to directory is /var/www/my_app
➋ <span class="strong"><strong>set :deploy_to, '/var/www/social'</strong></span>

  <span class="emphasis"><em>--snip--</em></span>

  namespace :deploy do
  desc 'Restart application'
  task :restart do
    on roles(:app), in: :sequence, wait: 5 do
      # Your restart mechanism here, for example:
➌     <span class="strong"><strong>execute :touch, release_path.join('tmp/restart.txt')</strong></span>
    end
  end

  after :publishing, :restart

  <span class="emphasis"><em>--snip--</em></span>

end</pre><p><a class="indexterm" id="iddle1296"/><a class="indexterm" id="iddle1360"/><a class="indexterm" id="iddle2265"/>First, set the name of your application to <code class="literal">social</code> and
            specify the URL of your Git repository ➊. Replace <span class="bolditalic"><code class="literal">yourname</code></span> with your GitHub username. Next, set the
              <span class="emphasis"><em>deploy</em></span> directory to the <span class="emphasis"><em>/var/www/social</em></span>
            directory that you created on your instance ➋. Finally, uncomment the
              <code class="literal">execute</code> line ➌ in the <code class="literal">restart</code> task. This
            line executes the <code class="literal">touch tmp/restart.txt</code> command. This command is
            needed to restart the Passenger application server after deployment.</p><p>Now that the shared settings are updated, edit the <span class="emphasis"><em>config/deploy/
              production.rb</em></span> file. This file contains settings specific to the Capistrano
              <code class="literal">production</code> stage. Replace the existing code in this file with the
            following code:</p><a id="pro_id00489"/><pre class="programlisting">   <span class="strong"><strong>server '</strong></span><span class="bolditalic">your_instance_name</span><span class="strong"><strong>',</strong></span>
➊            <span class="strong"><strong>user: 'ubuntu', roles: %w{web app db}</strong></span>
➋  <span class="strong"><strong>set :ssh_options, {</strong></span>
        <span class="strong"><strong>keys: '</strong></span><span class="bolditalic">your_key_file</span>
   <span class="strong"><strong>' }</strong></span></pre><p>First, Capistrano needs the address of your servers, along with the username and
            roles of each server ➊. Your instance is fulfilling all three roles, and the
            username is <code class="literal">ubuntu</code>. Replace <span class="bolditalic"><code class="literal">your_instance_name</code></span> with your server’s public
            DNS name. Next, specify the SSH options needed to connect to your instance ➋.
            Capistrano needs the path to your private key to connect. Replace <span class="bolditalic"><code class="literal">your_key_file</code></span> with the full path to
            your private key file.</p></div><div class="sect2" title="Database Setup"><div class="titlepage"><div><div><h2 class="title"><a id="database_setup"/>Database Setup</h2></div></div></div><p>Next, configure your application to use the PostgreSQL database you created earlier.
            Database configuration is in the file <span class="emphasis"><em>config/database.yml</em></span>. Update
            the <code class="literal">production</code> section, as shown here:</p><a id="pro_id00490"/><pre class="programlisting">  <span class="emphasis"><em>--snip--</em></span>

  production:
    <span class="strong"><strong>adapter: postgresql</strong></span>
    <span class="strong"><strong>encoding: unicode</strong></span>
➊   <span class="strong"><strong>database: social_production</strong></span>
    <span class="strong"><strong>pool: 5</strong></span>
➋   <span class="strong"><strong>username: ubuntu</strong></span>
➌   <span class="strong"><strong>password:</strong></span></pre><p><a class="indexterm" id="iddle1298"/><a class="indexterm" id="iddle1370"/><a class="indexterm" id="iddle1387"/><a class="indexterm" id="iddle1638"/><a class="indexterm" id="iddle1655"/><a class="indexterm" id="iddle2136"/>This code tells Rails to use the PostgreSQL database named
              <code class="literal">social_production</code> ➊ in the <code class="literal">production</code>
            environment. Rails will connect to the database with the username
              <code class="literal">ubuntu</code> ➋ and no password ➌, thanks to the
            Ubuntu’s ident sameuser authentication setup mentioned earlier.</p></div><div class="sect2" title="Secrets Setup"><div class="titlepage"><div><div><h2 class="title"><a id="secrets_setup"/>Secrets Setup</h2></div></div></div><p>The last thing you need to set up is the secret key used to sign your
            application’s cookies. This value is stored in the file
              <span class="emphasis"><em>config/secrets.yml</em></span>. This file can also be used to store other
            secret information such as passwords or API keys needed by your application.</p><a id="pro_id00491"/><pre class="programlisting">  <span class="emphasis"><em>--snip--</em></span>
  development:
    secret_key_base: 242ba1d...

  test:
    secret_key_base: 92d581d...

➊ # Do not keep production secrets in the repository,
  # instead read values from the environment.
  production:
➋   secret_key_base: &lt;%= ENV["SECRET_KEY_BASE"] %&gt;</pre><p>As mentioned in the comment, you shouldn’t keep production secrets in this
            file ➊. If the code for your application is stored in a public Git repository,
            these secrets would then be publicly available. Instead, this file uses an ERB tag to
            read the value of the <code class="literal">SECRET_KEY_BASE</code> environment variable
            ➋.</p><p>Before you can set this environment variable on your server, generate a value using
            the following command:</p><a id="pro_id00492"/><pre class="programlisting">$ <span class="strong"><strong>bin/rake secret</strong></span>
a3467dbd655679241a41d44b8245...</pre><p>Copy the value output by this command and save it in a safe place. You’ll need
            it again when you set up the virtual host for your application later in this
            chapter.</p></div><div class="sect2" title="Add to Git"><div class="titlepage"><div><div><h2 class="title"><a id="add_to_git"/>Add to Git</h2></div></div></div><p>With Capistrano configured and the database configured, you’re ready to create
            a Git repository for your application and push your code to GitHub. Capistrano runs
              <code class="literal">git</code> commands on your instance to pull changes to your application
            from GitHub during deployment.</p><p>First create a Git repository on your local computer with the following commands.
            (Refer back to <a class="xref" href="ch06.html" title="Chapter 6. Deployment">Chapter 6</a> if you need a refresher on Git.)</p><a id="pro_id00493"/><pre class="programlisting">$ <span class="strong"><strong>git init</strong></span>
Initialized empty Git repository in ...
$ <span class="strong"><strong>git add .</strong></span>
$ <span class="strong"><strong>git commit -m "Initial commit"</strong></span>
[master (root-commit) 1928798] Initial commit
123 files changed, 1826 insertions(+)
<span class="emphasis"><em>--snip--</em></span></pre><p><a class="indexterm" id="iddle1270"/><a class="indexterm" id="iddle1297"/><a class="indexterm" id="iddle1481"/>Now log in to your GitHub account and create a new public repository named
              <span class="emphasis"><em>social</em></span>. Once the repository is created, add a remote to the local
            repository you just created and push the code up to GitHub.</p><a id="pro_id00494"/><pre class="programlisting">$ <span class="strong"><strong>git remote add origin https://github.com/</strong></span><span class="bolditalic">yourname</span><span class="strong"><strong>/social.git</strong></span>
$ <span class="strong"><strong>git push -u origin master</strong></span>
Counting objects: 141, done.
--<span class="emphasis"><em>snip</em></span>--
Branch master set up to track remote branch master from origin.</pre><p>Once Capistrano is configured and your application is on GitHub, you’re ready
            to deploy.</p></div><div class="sect2" title="Deployment"><div class="titlepage"><div><div><h2 class="title"><a id="deployment-id00036"/>Deployment</h2></div></div></div><p>First, test the connection to your instance and check if the instance is ready to
            receive a deployment from Capistrano. The <code class="literal">deploy:check</code> task ensures
            everything on the instance is set up correctly:</p><a id="pro_id00495"/><pre class="programlisting">$ <span class="strong"><strong>bin/cap production deploy:check</strong></span>
 INFO [722a06ac] Running /usr/bin/env ...
<span class="emphasis"><em>--snip--</em></span>
 INFO [5d3c6d3e] Finished ... exit status 0 (successful).</pre><p>Note that I specified the <code class="literal">production</code> stage in the command. You
            must include the stage with every Capistrano command.</p><p>If the <code class="literal">deploy:check</code> task finishes successfully, you’re
            ready to deploy your application for the first time:</p><a id="pro_id00496"/><pre class="programlisting">$ <span class="strong"><strong>bin/cap production deploy</strong></span>
 INFO [e6d54911] Running /usr/bin/env ...
<span class="emphasis"><em>--snip--</em></span>
 INFO [3cb59e26] Finished ... exit status 0 (successful).</pre><p>The deploy task not only checks out the latest code from GitHub but also runs
              <code class="literal">bundle install</code> to update installed gems, compiles your
            application’s assets, and migrates the database. Even once your application is
            installed on your instance and running, however, you still need to make one more
            configuration change to see your application on the Internet.</p></div><div class="sect2" title="Adding a Virtual Host"><div class="titlepage"><div><div><h2 class="title"><a id="adding_a_virtual_host"/>Adding a Virtual Host</h2></div></div></div><p><a class="indexterm" id="iddle1300"/><a class="indexterm" id="iddle1509"/><a class="indexterm" id="iddle1552"/><a class="indexterm" id="iddle1869"/><a class="indexterm" id="iddle2137"/><a class="indexterm" id="iddle2324"/>A <span class="emphasis"><em>Virtual Host</em></span> is a way to host multiple sites on the
            same server or instance. The Apache web server allows you to set up many different sites
            on the same physical server. It then uses the DNS name of each site to serve the correct
            site for each incoming request. You currently have only a single site running on your
            instance, but you still need to set it up as a Virtual Host.</p><p>You perform this step one time. You won’t need to do this again unless you
            decide to add another site to the same server. You needed to wait until after your
            application was deployed since the directory names you’re going to specify
            didn’t exist before.</p><p>First, connect to your instance with SSH, and then create a configuration file for
            the social application in the <span class="emphasis"><em>/etc/apache2/sites-available</em></span>
            directory:</p><a id="pro_id00497"/><pre class="programlisting">$ <span class="strong"><strong>sudo nano /etc/apache2/sites-available/social.conf</strong></span></pre><p>The previous command opens the new file in the <code class="literal">nano</code> editor. Enter
            the following Apache configuration code in the new file:</p><a id="pro_id00498"/><pre class="programlisting">➊ <span class="strong"><strong>&lt;VirtualHost *:80&gt;</strong></span>
➋   <span class="strong"><strong>ServerName</strong></span> <span class="strong"><strong><span class="emphasis"><em>your_instance_name</em></span></strong></span>
➌   <span class="strong"><strong>DocumentRoot /var/www/social/current/public</strong></span>
➍   <span class="strong"><strong>SetEnv SECRET_KEY_BASE</strong></span> <span class="strong"><strong><span class="emphasis"><em>a3467dbd65...</em></span></strong></span>
➎   <span class="strong"><strong>&lt;Directory /var/www/social/current/public&gt;</strong></span>
      <span class="strong"><strong>Allow from all</strong></span>
      <span class="strong"><strong>Options -MultiViews</strong></span>
    <span class="strong"><strong>&lt;/Directory&gt;</strong></span>
  <span class="strong"><strong>&lt;/VirtualHost&gt;</strong></span></pre><p>The first line means this Virtual Host responds to all requests (indicated by the
            star) on port 80 ➊. Next, specify the server name of this Virtual Host ➋.
            Replace <span class="emphasis"><em><span class="strong"><strong><code class="literal">your_instance_name</code></strong></span></em></span> with the public DNS
            name of your instance.</p><p>Then set the document root for this Virtual Host ➌. The document root is
            normally the location of the site’s HTML files, but here, you set it to your
            application’s public directory. This configuration is specific to the Passenger
            application server.</p><p>The next line sets the <code class="literal">SECRET_KEY_BASE</code> environment variable
            ➍. Replace the partial key shown here with the complete 128-digit key generated
            by the <code class="literal">bin/rake secret</code> command you entered earlier.</p><p>Finally, set options for the document root directory ➎. The <code class="literal">Allow
              from all</code> line means that all hosts and IP addresses are allowed access to
            the files in this directory. The <code class="literal">Options -MultiViews</code> line turns off
            the MultiViews feature in Apache. This feature uses automatic content negotiation, which
            can cause Apache to serve files to a client even if the file extension is not specified,
            which you don’t want.</p><p>Press <span class="smaller">CTRL</span>-O followed by <span class="smaller">ENTER</span> to save the file, and then press <span class="smaller">CTRL</span>-X to exit the editor.</p><p><a class="indexterm" id="iddle1058"/>Now that the new site is configured in Apache, you need to disable the
            default site that comes with Apache and enable the social site:</p><a id="pro_id00499"/><pre class="programlisting">$ <span class="strong"><strong>sudo a2dissite 000-default</strong></span>
Site 000-default disabled.
To activate the new configuration, you need to run:
  service apache2 reload
$ <span class="strong"><strong>sudo a2ensite social</strong></span>
Enabling site social.
To activate the new configuration, you need to run:
  service apache2 reload</pre><p>Once this is done, reload Apache to activate the changes:</p><a id="pro_id00500"/><pre class="programlisting">$ <span class="strong"><strong>sudo service apache2 reload</strong></span>
 * Reloading web server apache2
 *</pre><p>Now open your web browser and go to the public DNS name of your instance. Your
            application should be available to the world, running in production on your own virtual
            private server.</p></div></div><div class="sect1" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="summary-id00037"/>Summary</h1></div></div></div><p>In this chapter, you learned how to set up a Linux server for hosting Rails
          applications. You installed and configured the Apache web server, the Phusion Passenger
          application server, and the PostgreSQL database server.</p><p>You also learned how to integrate the remote server automation tool Capistrano in your
          Rails application. You configured your Rails application for production and used
          Capistrano to deploy it to your instance.</p><p>With this done, you are well on your way to becoming a professional Rails
          developer!</p></div><div class="sect1" title="Exercises"><div class="titlepage"><div><div><h1 class="title"><a id="exercises-id00038"/>Exercises</h1></div></div></div><div class="qandaset" title="Frequently Asked Questions"><a id="ch15qa1"/><table border="0" summary="Q and A Set" width="100%"><col align="left" width="1%"/><col/><tbody><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch15qa1qe1"/><a id="ch15qa1q1"/><p>Q:</p></td><td align="left" valign="top"><p>1. Make a small change to your application, such as updating the title of each
                page. Commit the change to your local Git repository, push the changes to GitHub,
                and then deploy the change to your instance.</p></td></tr><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch15qa1qe2"/><a id="ch15qa1q2"/><p>Q:</p></td><td align="left" valign="top"><p>2. Learn about other gems you can use to add features to your Rails applications
                easily. For example, you might want to allow users to upload images to your site
                instead of using a third-party image-hosting service. Hundreds of open source
                projects are available for adding this and other features to your application. Find
                one you like and try it out. If you find a bug, fix it and send the developer a pull
                request on GitHub.</p></td></tr><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch15qa1qe3"/><a id="ch15qa1q3"/><p>Q:</p></td><td align="left" valign="top"><p>3. Get to know the Ruby on Rails community and get involved. Follow Rails
                development on GitHub. Check out the official Ruby on Rails website and blog. Find
                out about Ruby and Rails conferences and try to attend; make yourself known at your
                local Ruby or Rails User Group.</p></td></tr></tbody></table></div></div></div></body></html>