<?xml version='1.0' encoding='utf-8'?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" epub:prefix="z3998: http://www.daisy.org/z3998/2012/vocab/structure/#" lang="en" xml:lang="en">
  <head>
    <title>Project 7: Mini Weather Forecaster</title>
    <link href="../styles/9781593278717.css" rel="stylesheet" type="text/css"/>
    <link href="../68851547a55f.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <div id="sbo-rt-content"><h2 class="h2" id="ch07"><span epub:type="pagebreak" id="page_96"/><strong>7<br/>Mini Weather Forecaster</strong></h2>
<p class="noindent"><span class="green2">In this project, you’re going to build a weather forecaster that displays the day’s weather for your location on an OLED display. You’ll learn how to make API requests, which are really useful for projects that rely on frequently updated data, and how to use an OLED display.</span></p>
<div class="image"><span epub:type="pagebreak" id="page_97"/><img src="../images/f0097-01.jpg" alt="image"/></div>
<p class="cap"><span class="green2"><strong>PARTS REQUIRED</strong></span></p>
<p class="cap1">Raspberry Pi</p>
<p class="cap1">Breadboard</p>
<p class="cap1">0.96-inch OLED display</p>
<p class="cap1">Jumper wires</p>
<p class="cap"><span class="green2"><strong>SOFTWARE REQUIRED</strong></span></p>
<p class="cap1">Adafruit_SSD1306 library</p>
<h3 class="h3" id="lev75"><span epub:type="pagebreak" id="page_98"/><span class="green2"><strong>INTRODUCING THE OLED DISPLAY</strong></span></h3>
<p class="noindent">The <em>organic light-emitting diode (OLED)</em> display this project uses is the SSD1306 model: a monocolor, 0.96-inch display with 128×64 pixels, shown in <a href="ch07.xhtml#ch07fig1">Figure 7-1</a>. Compared to the LCD, which has a reserved space of 5×8 pixels for each character, the OLED display is much more versatile. It allows you to choose which pixels are on and off, enabling you to produce custom text and images anywhere in the display. The OLED display also doesn’t require backlight, which results in a very nice contrast in dark environments. Additionally, its pixels consume energy only when they are on, so the OLED display consumes less power than an LCD.</p>
<div class="image"><a id="ch07fig1"/><img src="../images/f0098-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 7-1:</strong> The SSD1306 0.96-inch monocolor OLED display</p>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>Some OLED displays use SPI communication instead of I<sup>2</sup>C—these will come with a different set of pins. Make sure you check the pin layout before purchasing your OLED display.</em></p>
</div>
<p class="indent">This OLED display generally has four pins, GND, VCC, SCL, and SDA (see <a href="ch07.xhtml#ch07fig1">Figure 7-1</a>), though you may find that some models come with an extra reset pin. Some displays may come with the pins in a different order as well—VCC, GND, SCL, SDA—so just pay attention to the labels as you follow this project’s instructions.</p>
<p class="indent">The OLED display in <a href="ch07.xhtml#ch07fig1">Figure 7-1</a> uses the Inter-Integrated Circuit (I<sup>2</sup>C) communication protocol to communicate with the Raspberry Pi, for which you need the SDA and SCL pins (GPIO 2 and GPIO 3, respectively).</p>
<h3 class="h3" id="lev76"><span class="green2"><strong>USING THE OPENWEATHERMAP API</strong></span></h3>
<p class="noindent">An application programming interface (API) is a set of functions written by software developers to enable anyone to use their data or services. For example, the OpenWeatherMap project (<em><a href="https://openweathermap.org/">https://openweathermap.org/</a></em>) has an API that enables users to request <span epub:type="pagebreak" id="page_99"/>weather data using many different programming languages. In this project you’ll use that API to request the day’s weather forecast for your chosen location. Learning to use APIs with your Pi is a great skill because it allows you access to a wide variety of constantly changing information, such as current stock prices, currency exchange rates, the latest news, traffic updates, tweets, and much more.</p>
<p class="indent">OpenWeatherMap’s free plan provides everything you need to complete this project. To use the API you need an API key, known as the <em>APIID</em>. To get an APIID:</p>
<ol>
<li class="noindent"><p class="list">Open a browser and go to <em><a href="https://openweathermap.org/appid/">https://openweathermap.org/appid/</a></em>.</p></li>
<li class="noindent"><p class="list">Press the <strong>Sign up</strong> button and create a free account.</p></li>
<li class="noindent"><p class="list">You’ll be presented with a dashboard that contains several tabs. Select the <strong>API keys</strong> tab, as shown in <a href="ch07.xhtml#ch07fig2">Figure 7-2</a>.</p>
<div class="image"><a id="ch07fig2"/><img src="../images/f0099-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 7-2:</strong> API keys on OpenWeatherMap</p></li>
<li class="noindent"><p class="list">On the API keys tab, you’ll see a default key (shown in <a href="ch07.xhtml#ch07fig2">Figure 7-2</a>); this is a unique key you’ll need to pull information from the site. Copy and paste this key somewhere; you’ll need it in a moment. You can create a new key for each separate project if you like, but if you aren’t familiar with using APIs, we’d recommend just using the default key provided.</p></li>
<li class="noindent"><p class="list">To pull information on weather in your chosen location, enter the following URL:</p>
<div class="box">
<p class="programs">http://api.openweathermap.org/data/2.5/weather?q=<em>your_city</em>,<br/><em>your_country_code</em>&amp;APPID=<em>your_unique_API_key</em></p>
</div>
<div class="note">
<p class="notet"><span class="red"><strong>WARNING</strong></span></p>
<p class="notep"><em>APIs are unique to the user and shouldn’t be shared with anyone. In this case, whoever has your API key can only request the weather, but if you were using social media APIs, for example, you could run into security issues—like strangers getting access to your personal information. Don’t share your API keys with anyone.</em></p>
</div>
<p class="indentv">Replace <span class="codeitalic">your_city</span> with the city you want data for, <span class="codeitalic">your_country_code</span> with the country code for that city, and <span epub:type="pagebreak" id="page_100"/><span class="codeitalic">your_unique_API_key</span> with the unique API key from step 4. For example, the updated API URL for the town of Porto, Portugal, would be:</p>
<div class="box">
<p class="programs">http://api.openweathermap.org/data/2.5/weather?q=Porto,<br/>PT&amp;APPID=801d2603e9f2e1c70e042e4f5f6e0---</p>
</div></li>
<li class="noindent"><p class="list">Copy your URL into your browser, and the API will return a bunch of information corresponding to your local weather. <a href="ch07.xhtml#ch07list1">Listing 7-1</a> shows the weather in Porto, Portugal, on the day we wrote this project.</p>
<p class="listing" id="ch07list1"><strong>LISTING 7-1:</strong> The API response</p>
<div class="box">
<p class="programs">{"coord":{"lon":8.61,"lat":41.15},"weather":[{"id":802,<br/>"main":"Clouds","description":"scattered clouds","icon":"03d"}],<br/>"base":"stations","main":{"temp":280.704,"pressure":1010.06,<br/>"humidity":96,"temp_min":280.704,"temp_max":280.704,<br/>"sea_level":1041.03,"grnd_level":1010.06},"wind":{"speed":1.01,<br/>"deg":74.0017},"clouds":{"all":36},"dt":1487153693,<br/>"sys":{"message":0.0042,"country":"PT","sunrise":1487143701,<br/>"sunset":1487182157},"id":2735943,"name":"Porto","cod":200}</p>
</div></li>
</ol>
<div class="note">
<p class="notet"><strong>NOTE</strong></p>
<p class="notep"><em>More information on using the API to get weather information is available at</em> <a href="https://openweathermap.org/current">https://openweathermap.org/current</a>.</p>
</div>
<p class="indent">This may not look like much now, but next you’ll see how to organize this data with tabs and paragraphs to make it more readable.</p>
<h4 class="h4" id="lev77"><span class="green2"><strong>Understanding JSON Syntax</strong></span></h4>
<p class="noindent">As you can see, the weather data for your chosen location is stored in a specific way, with symbols like <span class="literal">{}[] : ""</span> and <span class="literal">,</span>. This syntax is <em>JavaScript Object Notation (JSON)</em>, a standard for exchanging data in a way that’s convenient for computers. In JSON syntax:</p>
<ul>
<li class="noindent">Data is represented in name/value pairs.</li>
<li class="noindent">Each name is followed by a colon ( <span class="literal">:</span>).</li>
<li class="noindent">Name/value pairs are separated with commas.</li>
<li class="noindent">Curly brackets hold objects.</li>
<li class="noindent">Square brackets hold arrays.</li>
</ul>
<p class="indent"><a href="ch07.xhtml#ch07list2">Listing 7-2</a> shows how you can organize the API information so it’s easier to understand.</p>
<p class="listing" id="ch07list2"><strong>LISTING 7-2:</strong> The API JSON information rearranged for a clearer structure</p>
<div class="box">
<p class="programs">{<br/>   <span class="green">"coord"</span>:{<br/>      <span class="green">"lon"</span>:-8.61,<br/>      <span class="green">"lat"</span>:41.15<br/>   },<br/><span epub:type="pagebreak" id="page_101"/>   <span class="green">"weather"</span>:[{<br/>         <span class="green">"id"</span>:803,<br/>         <span class="green">"main"</span>:<span class="green">"Clouds"</span>,<br/>         <span class="green">"description"</span>:<span class="green">"broken clouds"</span>,<br/>         <span class="green">"icon"</span>:<span class="green">"04d"</span><br/>      }<br/>   ],<br/>   <span class="green">"base"</span>:<span class="green">"stations"</span>,<br/>   <span class="green">"main"</span>:{<br/>      <span class="green">"temp"</span>:288.15,<br/>      <span class="green">"pressure"</span>:1020,<br/>      <span class="green">"humidity"</span>:93,<br/>      <span class="green">"temp_min"</span>:288.15,<br/>      <span class="green">"temp_max"</span>:288.15<br/>   },<br/>   <span class="green">"visibility"</span>:10000,<br/>   <span class="green">"wind"</span>:{<br/>      <span class="green">"speed"</span>:3.6,<br/>      <span class="green">"deg"</span>:230<br/>   },<br/>   <span class="green">"clouds"</span>:{<br/>      <span class="green">"all"</span>:75<br/>   },<br/>   <span class="green">"dt"</span>:1488726000,<br/>   <span class="green">"sys"</span>:{<br/>      <span class="green">"type"</span>:1,<br/>      <span class="green">"id"</span>:5959,<br/>      <span class="green">"message"</span>:0.002,<br/>      <span class="green">"country"</span>:<span class="green">"PT"</span>,<br/>      <span class="green">"sunrise"</span>:1488697277,<br/>      <span class="green">"sunset"</span>:1488738646<br/>   },<br/>   <span class="green">"id"</span>:2735943,<br/>   <span class="green">"name"</span>:<span class="green">"Porto"</span>,<br/>   <span class="green">"cod"</span>:200<br/>}</p>
</div>
<p class="indent">Now you can more easily see all the different kinds of information the API provides.</p>
<h4 class="h4" id="lev78"><span class="green2"><strong>Making an API Request</strong></span></h4>
<p class="noindent">Now you have a URL that returns your local weather data. To show you how to access the information using Python, we’ll give you an example.</p>
<p class="indent">The simple code snippet in <a href="ch07.xhtml#ch07list3">Listing 7-3</a> requests the current maximum temperature in Kelvin for Porto, Portugal, and prints it in the Python shell. Replace our URL with your own, and you’ll get the same information for your chosen location.</p>
<p class="listing" id="ch07list3"><span epub:type="pagebreak" id="page_102"/><strong>LISTING 7-3:</strong> Requesting maximum temperature</p>
<div class="box">
<p class="programs"><span class="ent">➊</span> <span class="orange">import</span> requests<br/><span class="ent">➋</span> weather_data = requests.get(<span class="green">'http://api.openweathermap.org/data/2.5/</span><br/>  <span class="green">weather?q=Porto,PT&amp;APPID=801d2603e9f2e1c70e042e4f5f6e0---'</span>)<br/><span class="ent">➌</span> temp_max = weather_data.json().get(<span class="green">'main'</span>).get(<span class="green">'temp_max'</span>)<br/>  <span class="purple">print</span>(temp_max)</p>
</div>
<p class="indent">At <span class="ent">➊</span>, you import the requests library, which is essential for making API requests.</p>
<p class="indent">At <span class="ent">➋</span>, you create a variable called <span class="literal">weather_data</span> in which you store the data returned after the API request. To make an API request for information, you use the command <span class="literal">requests.get('</span><span class="codeitalic">your_url</span><span class="literal">')</span>, with your URL as the argument inside single quotes.</p>
<p class="indent">At <span class="ent">➌</span>, you create the <span class="literal">temp_max</span> variable to hold the particular data you’re requesting. In this case, you want the maximum temperature.</p>
<p class="indent">To get that value, you first convert the <span class="literal">weather_data</span> variable to JSON with the <span class="literal">.json()</span> method. Then, using the <span class="literal">.get()</span> method, you access the <span class="literal">temp_max</span> variable, which contains the maximum temperature value. You can see in <a href="ch07.xhtml#ch07list2">Listing 7-2</a> that <span class="literal">main</span> is the top-level parent of the data you want to access, <span class="literal">temp_max</span>, so you need to get through <span class="literal">main</span> first.</p>
<p class="indent">In the same way, to access the wind speed you enter:</p>
<div class="box">
<p class="programs">weather_data.json().get(<span class="green">'wind'</span>).get(<span class="green">'speed'</span>)</p>
</div>
<p class="indent">You need to go through the parent of <span class="literal">speed</span>, which is <span class="literal">wind</span>, to request the information about wind speed.</p>
<p class="indent">If you just want to get the city name, you enter:</p>
<div class="box">
<p class="programs">weather_data.json().get(<span class="green">'name'</span>)</p>
</div>
<p class="indent">After learning how to make API requests in Python, you’re ready to start this project!</p>
<div class="box3">
<p class="box-title"><span class="green2"><strong>THE REQUESTS LIBRARY</strong></span></p>
<p class="box-p">The requests library, also called “HTTP for Humans,” is an Apache2- licensed Python library used to send <em>hypertext transfer protocol (HTTP)</em> requests. This powerful library makes it simple to connect to web servers via HTTP. This capability allows you to easily request information from any web page, as you’ve been doing here.</p>
</div>
<h3 class="h3" id="lev79"><span epub:type="pagebreak" id="page_103"/><span class="green2"><strong>WIRING THE CIRCUIT</strong></span></h3>
<p class="noindent">Simply wire the OLED display to the Pi according to the pinout shown in the table. Remember that the pin order may be different on some models, so follow the pin labels.</p>
<table class="topbot-d">
<thead>
<tr>
<td style="vertical-align: top;" class="border_thc"><p class="tab_th"><strong>OLED DISPLAY</strong></p></td>
<td style="vertical-align: top;" class="border_tha"><p class="tab_th"><strong>RASPBERRY PI</strong></p></td>
</tr>
</thead>
<tbody>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">VCC</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">3.3 V</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">GND</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">GND</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">SDA</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">GPIO 2 (SDA)</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">SCL</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">GPIO 3 (SCL)</span></p></td>
</tr>
<tr>
<td style="vertical-align: top;" class="table-ch"><p class="tabc"><span class="green2">RST (if existent)</span></p></td>
<td style="vertical-align: top;" class="table-a"><p class="tabc"><span class="green2">GPIO 24</span></p></td>
</tr>
</tbody>
</table>
<p class="indent">Check your circuit against <a href="ch07.xhtml#ch07fig3">Figure 7-3</a> and then move on to the software.</p>
<div class="image"><a id="ch07fig3"/><img src="../images/f0103-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 7-3:</strong> Wiring the OLED display to the Raspberry Pi</p>
<h3 class="h3" id="lev80"><span class="green2"><strong>WRITING THE SCRIPT</strong></span></h3>
<p class="noindent">Before you enter the script, you need to install the Adafruit_SSD1306 library to use the OLED with the Raspberry Pi. This library makes it simple to write text and draw images on the display. You’ll also need to enable I<sup>2</sup>C communication so the OLED and Pi can communicate.</p>
<h4 class="h4" id="lev81"><span epub:type="pagebreak" id="page_104"/><span class="green2"><strong>Installing the Library for the OLED Display</strong></span></h4>
<p class="noindent">If you haven’t done so already, create a folder called <em>Libraries</em> on your Desktop. Then, open the terminal and navigate to the <em>Libraries</em> folder on your Pi:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~ $ <span class="codestrong">cd Desktop/Libraries</span></p>
</div>
<p class="indent">Clone the OLED library:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~/Desktop/Libraries $ <span class="codestrong">git clone https://github.com/</span><br/><span class="codestrong">adafruit/Adafruit_Python_SSD1306.git</span></p>
</div>
<p class="indent">Install the Adafruit_Python_SSD1306 library:</p>
<div class="box">
<p class="programs">pi@raspberrypi:~/Desktop/Libraries $ <span class="codestrong">cd adafruit/</span><br/><span class="codestrong">Adafruit_Python_SSD1306</span><br/>pi@raspberrypi:~/Desktop/Libraries/adafruit/Adafruit_Python_SSD1306<br/>$ <span class="codestrong">sudo python3 setup.py install</span></p>
</div>
<h4 class="h4" id="lev82"><span class="green2"><strong>Enabling I<sup>2</sup>C Communication</strong></span></h4>
<p class="noindent">The OLED communicates with the Pi using the I<sup>2</sup>C communication protocol, so you need to enable I<sup>2</sup>C communication on your Pi. Go to the Desktop main menu and select <strong>Preferences</strong> <span class="ent">▸</span> <strong>Raspberry Pi Configuration</strong>. In the Interfaces tab, enable I<sup>2</sup>C, as shown in <a href="ch07.xhtml#ch07fig4">Figure 7-4</a>, and press <strong>OK</strong>.</p>
<div class="image"><a id="ch07fig4"/><img src="../images/f0104-01.jpg" alt="image"/></div>
<p class="figcap"><strong>FIGURE 7-4:</strong> Enabling I<sup>2</sup>C communication</p>
<div class="box3">
<p class="box-title"><span epub:type="pagebreak" id="page_105"/><span class="green2"><strong>I<sup>2</sup>C COMMUNICATION PROTOCOL</strong></span></p>
<p class="box-p"><em>I<sup>2</sup>C</em>, or <em>Inter-Integrated Circuit</em>, is a communication protocol that allows communication between multiple <em>slave</em> integrated circuits and one master chip. The slaves are the devices that respond to the master. The master chip can communicate with all slaves, but a slave can only communicate with the master. Both the slave and master can transfer data, but that transfer is always controlled by the master. In this case, the Raspberry Pi is the master chip and the OLED integrated circuit is the slave. The Raspberry Pi supports I<sup>2</sup>C communication in its GPIO pins through the SDA and SCL pins. The biggest advantage of using this communication protocol is that you can connect more than one device via I<sup>2</sup>C using just the SDA and SCL pins—no need to use additional pins on the header.</p>
</div>
<h4 class="h4" id="lev83"><span class="green2"><strong>Entering the Script</strong></span></h4>
<p class="noindent">Open <strong>Python 3 (IDLE)</strong> and go to <strong>File</strong> <span class="ent">▸</span> <strong>New File</strong> to create a new script. Copy the code shown in <a href="ch07.xhtml#ch07list4">Listing 7-4</a> to the Python Editor and save the script as <em>weather_forecast.py</em> inside the <em>Displays</em> folder (remember that you can download all the scripts at <em><a href="https://www.nostarch.com/RaspberryPiProject/">https://www.nostarch.com/RaspberryPiProject/</a></em>):</p>
<p class="listing" id="ch07list4"><strong>LISTING 7-4:</strong> The <em>weather_forecast.py</em> script</p>
<div class="box">
<p class="programs"><span class="ent">➊</span> <span class="orange">import</span> time<br/>  <span class="orange">import</span> Adafruit_SSD1306<br/>  <span class="orange">import</span> requests<br/><br/>  <span class="orange">from</span> PIL <span class="orange">import</span> Image<br/>  <span class="orange">from</span> PIL <span class="orange">import</span> ImageDraw<br/>  <span class="orange">from</span> PIL <span class="orange">import</span> ImageFont<br/><br/>  <span class="red1">#Raspberry Pi pin configuration</span><br/><span class="ent">➋</span> RST = 24<br/><br/><span class="ent">➌</span> <span class="red1">#128x32 display with hardware I2C</span><br/>  <span class="red1">#disp = Adafruit_SSD1306.SSD1306_128_32(rst=RST)</span><br/><br/>  <span class="red1">#128x64 display with hardware I2C</span><br/>  disp = Adafruit_SSD1306.SSD1306_128_64(rst=RST)<br/><br/><span epub:type="pagebreak" id="page_106"/>  <span class="red1">#set your unique OpenWeatherMap.org URL</span><br/><span class="ent">➍</span> open_weather_map_url = <span class="green">'http://api.openweathermap.org/data/2.5/</span><br/>  <span class="green">weather?q=Porto,PT&amp;APPID=801d2603e9f2e1c70e042e4f5f6e0---'</span><br/><br/>  <span class="red1">#initialize display</span><br/><span class="ent">➎</span> disp.begin()<br/><br/>  <span class="orange">while True</span>:<br/>      <span class="red1">#clear display</span><br/>      disp.clear()<br/>      disp.display()<br/><br/>      <span class="red1">#create blank image for drawing</span><br/>      <span class="red1">#make sure to create image with mode '1' for 1-bit color</span><br/>      width = disp.width<br/>      height = disp.height<br/>      image = Image.new(<span class="green">'1'</span>, (width, height))<br/><br/>      <span class="red1">#get drawing object to draw on image</span><br/>      draw = ImageDraw.Draw(image)<br/><br/>      <span class="red1">#draw a black filled box to clear the image</span><br/>      draw.rectangle((0,0,width,height), outline=0, fill=0)<br/><br/>      <span class="red1">#define constants to define drawing area</span><br/>      padding = 2<br/>      top = padding<br/><br/>      <span class="red1">#move left to right, keeping track of the current x position</span><br/>      <span class="red1">#for drawing text</span><br/>      x = padding<br/><br/>      <span class="red1">#load default font</span><br/>      font = ImageFont.load_default()<br/><br/>      <span class="red1">#openWeatherMap.org weather data request</span><br/><span class="ent">➏</span>     weather_data = requests.get(open_weather_map_url)<br/><br/>      <span class="red1">#display location</span><br/><span class="ent">➐</span>     location = weather_data.json().get(<span class="green">'name'</span>) + <span class="green">' - '</span><br/>  + weather_data.json().get(<span class="green">'sys'</span>).get(<span class="green">'country'</span>)<br/>      draw.text((x, top), location, font=font, fill=255)<br/><br/>      <span class="red1">#display description</span><br/>      description = <span class="green">'</span><span class="green">Desc '</span> + weather_data.json().get(<span class="green">'weather'</span>)[0]<br/>  .get(<span class="green">'main'</span>)<br/>      draw.text((x, top+10), description,  font=font, fill=255)<br/><br/>      raw_temperature = weather_data.json().get(<span class="green">'main'</span>)<br/>  .get(<span class="green">'temp'</span>)-273.15<br/><br/><span epub:type="pagebreak" id="page_107"/>      <span class="red1">#temperature in Celsius</span><br/>      temperature = <span class="green">'Temp '</span> + str(raw_temperature) + <span class="green">'*C'</span><br/><br/>      <span class="red1">#uncomment for temperature in Fahrenheit</span><br/>      <span class="red1">#temperature = 'Temp ' + str(raw_temperature*(9/5.0)+32) + '*F'</span><br/>      <span class="red1">#display temperature</span><br/>      draw.text((x, top+20), temperature, font=font, fill=255)<br/><br/>      <span class="red1">#display pressure</span><br/>      pressure = <span class="green">'Pres '</span> + str(weather_data.json().get(<span class="green">'main'</span>)<br/>  .get(<span class="green">'pressure'</span>)) + <span class="green">'hPa'</span><br/>      draw.text((x, top+30), pressure, font=font, fill=255)<br/><br/>      <span class="red1">#display humidity</span><br/>      humidity = <span class="green">'Humi '</span> + str(weather_data.json().get(<span class="green">'main'</span>)<br/>  .get(<span class="green">'humidity'</span>)) + <span class="green">'%'</span><br/>      draw.text((x, top+40), humidity, font=font, fill=255)<br/><br/>      <span class="red1">#display wind</span><br/>      wind = <span class="green">'Wind '</span> + str(weather_data.json().get(<span class="green">'wind'</span>)<br/>  .get(<span class="green">'speed'</span>)) + <span class="green">'mps '</span> + str(weather_data.json().get(<span class="green">'wind'</span>)<br/>  .get(<span class="green">'deg'</span>)) + <span class="green">'*'</span><br/>      draw.text((x, top+50), wind, font=font, fill=255)<br/><br/>      <span class="red1">#display image</span><br/><span class="ent">➑</span>     disp.image(image)<br/>      disp.display()<br/>      time.sleep(10)</p>
</div>
<p class="indent">As usual, your code starts by importing the required libraries <span class="ent">➊</span>. The Adafruit_SSD1306 library contains the OLED display driver classes. From the Python Imaging Library (PIL) you import three modules—<span class="literal">Image</span>, <span class="literal">ImageDraw</span>, and <span class="literal">ImageFont</span>—to create an image with the text that you’re going to display on the OLED.</p>
<div class="box3">
<p class="box-title"><span class="green2"><strong>THE OLED LIBRARIES</strong></span></p>
<p class="box-p">The Adafruit_SSD1306 library refers to everything shown on the OLED display as an “image”—even text. The three modules you’re using here have the following roles:</p>
<ul>
<li class="noindent">Image creates a new image.</li>
<li class="noindent">ImageDraw draws the text or icons inside the image and shows what you’ll see on the actual OLED display.</li>
<li class="noindent">ImageFont sets the text font.</li>
</ul>
</div>
<h5 class="h5"><span epub:type="pagebreak" id="page_108"/><strong>Initializing the OLED Display</strong></h5>
<p class="noindent">Even if your display doesn’t have a reset pin, you need to set the <span class="literal">RST</span> pin in your code. If your display does have a reset pin, it should be connected to GPIO 24. So, in either case, you set <span class="literal">RST</span> to <span class="literal">24</span> here <span class="ent">➋</span>.</p>
<p class="indent">At <span class="ent">➌</span>, you create a class for your display. For a 128×32 display, create the class <span class="literal">SSD1306_128_32</span>; for a 128×64 display, create the class <span class="literal">SSD1306_128_64</span>. We’ve given both options in the code so you can just uncomment the line that matches your display size and comment out the other.</p>
<p class="indent">At <span class="ent">➎</span>, you initialize the display library and prepare the display so that you can draw text on it. We’ve commented the code heavily to help you understand the purpose of each line.</p>
<h5 class="h5"><strong>Making the API Request</strong></h5>
<p class="noindent">At <span class="ent">➍</span>, you create a variable called <span class="literal">open_weather_map_url</span> to hold the API URL. Make sure to update this line with your own API URL.</p>
<p class="indent">At <span class="ent">➏</span>, you make the API request, after which there are several blocks of code that work similarly. We’ll explain the one at <span class="ent">➐</span>, and then you’ll be able to follow what the rest are doing. You create a variable, <span class="literal">location</span>, to get the location. This variable is a concatenation of several strings. First, you get the location using <span class="literal">weather_data.json().get('name')</span>, which in this example returns <span class="literal">Porto</span>. You add a hyphen by using <span class="literal">+ ' - '</span> and then the country code using <span class="literal">weather_data.json().get('sys').get('country')</span>; in this example, it returns <span class="literal">PT</span>. So, the <span class="literal">location</span> variable returns <span class="literal">Porto – PT</span>.</p>
<h5 class="h5"><strong>Drawing Text on the OLED Display</strong></h5>
<p class="noindent">To draw text on the display, you use the <span class="literal">draw.text()</span> function, which takes the following parameters:</p>
<p class="noindent"><span class="green2"><span class="codestrong">x and y coordinates</span></span>  Where the text starts being drawn</p>
<p class="noindent"><span class="green2"><span class="codestrong">text</span></span>  The text to display</p>
<p class="noindent"><span class="green2"><span class="codestrong">font</span></span>  The font the text will appear in</p>
<p class="noindent"><span class="green2"><span class="codestrong">fill</span></span>  The pixel brightness—255 is the maximum</p>
<p class="indent">For example, to display the location on the top line of the OLED forecaster, use the following:</p>
<div class="box">
<p class="programs">draw.text((x, top), location, font=font, fill=255)</p>
</div>
<p class="indent">The <span class="literal">x</span> and <span class="literal">top</span> coordinates were defined at <span class="ent">➎</span>. This example uses the default library font, though you should feel free to explore other fonts by downloading the font files and modifying the code.</p>
<p class="indent"><span epub:type="pagebreak" id="page_109"/>The blocks of code to display the weather description, temperature, pressure, humidity, and wind are all similar. Note that you need to increment the <span class="literal">to</span>p variable to draw text on the next line of the display.</p>
<p class="indent">Finally, the lines of code at <span class="ent">➑</span> display the image on the OLED. The delay time at the end determines how fast the loop updates the weather information—in this case, every 10 seconds.</p>
<h4 class="h4" id="lev84"><span class="green2"><strong>Running the Script</strong></span></h4>
<p class="noindent">Press <strong>F5</strong> or go to <strong>Run</strong> <span class="ent">▸</span> <strong>Run Module</strong> to run the script. Congratulations, now you have a tiny weather forecaster that will give you constantly updated data on the weather in your chosen location!</p>
<h3 class="h3" id="lev85"><span class="green2"><strong>TAKING IT FURTHER</strong></span></h3>
<p class="noindent">You can use APIs to get way more information than just the weather. With your favorite search engine, enter a query like <em>free API for &lt;thing&gt;</em> to find an API you can access. Here are some ideas to get you started:</p>
<ul>
<li class="noindent">Traffic</li>
<li class="noindent">Tweets</li>
<li class="noindent">Latest news</li>
<li class="noindent">Stock prices</li>
<li class="noindent">Current Bitcoin exchange rate</li>
</ul>
</div>
  </body>
</html>
